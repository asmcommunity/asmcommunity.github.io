<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>I can't use registers in place of variables?? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=1060" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=1060">I can't use registers in place of variables??</a></p>
   <div class="post" id="post-6936">
    <div class="subject"><a href="#post-6936">I can't use registers in place of variables??</a></div>
    <div class="body">Hi Everyone,<br /><br />The following code creates a region for a window based on a<br />bitmap's mask. I'm currently using CALL to execute this proc...<br /><br />Can some one tell me why I can't use:<br /><br />ecx in place of &quot;begin&quot;,<br />ebx in place of dwCurrentLine, and<br />edx in place of dwCurrentPixel ??????<br /><br />If I do, I get a lot of garbage in the registers....<br /><br /><br /><pre><code><br />CreateWinRgnFromBitmap proc hWin&#58;HWND, hMaskBitmap&#58;HBITMAP<br /><br />    LOCAL   WindowRgn       &#58;HRGN<br />    LOCAL   hTempRgn        &#58;HRGN<br />    LOCAL   sInfo           &#58;BITMAP		<br />    LOCAL   mdc             &#58;HDC<br />    LOCAL   hOldBmp         &#58;HBITMAP<br /><br />    LOCAL   dwCurrentPixel  &#58;DWORD<br />    LOCAL   dwCurrentLine   &#58;DWORD<br />    LOCAL   begin           &#58;DWORD<br /><br /><br /><br />    push    0<br />    push    0<br />    push    0<br />    push    0<br />    call    CreateRectRgn<br />    mov     WindowRgn, eax<br /><br /><br />    invoke  GetObject, hMaskBitmap, sizeof BITMAP, ADDR sInfo<br /><br /><br />    push    0<br />    call    CreateCompatibleDC<br />    mov     mdc, eax<br /><br /><br />    push    hMaskBitmap<br />    push    mdc<br />    call    SelectObject<br />    mov     hOldBmp, eax<br /><br /><br />    mov     dwCurrentLine, 0<br />    .WHILE  1<br /><br />        mov eax, dwCurrentLine<br />        .BREAK .IF &#40;eax == sInfo.bmHeight&#41;<br /><br />        inc     dwCurrentLine<br />        mov     begin, 0<br />        mov     dwCurrentPixel, 0<br /><br />        .WHILE 1<br /><br />            mov eax, dwCurrentPixel<br />            .BREAK .IF &#40;eax == sInfo.bmWidth&#41;<br /><br />            inc     dwCurrentPixel<br />            invoke  GetPixel, mdc, dwCurrentPixel, dwCurrentLine<br /><br />            .IF eax == 0<br />                .IF begin == 0<br />                    push dwCurrentPixel<br />                    pop begin<br />                .ENDIF<br />            .ELSEIF begin &gt; 0<br />                mov     eax, dwCurrentLine<br />                inc     eax<br /><br />                push    eax<br />                push    dwCurrentPixel<br />                push    dwCurrentLine<br />                push    begin<br />                call    CreateRectRgn<br />                mov     hTempRgn, eax<br /><br />                push    RGN_OR<br />                push    WindowRgn<br />                push    hTempRgn<br />                push    WindowRgn<br />                call    CombineRgn<br /><br />                push    hTempRgn<br />                call    DeleteObject<br /><br />                mov     begin, 0<br />            .ENDIF<br /><br />        .ENDW<br /><br />    .ENDW<br /><br /><br />    invoke  SetWindowRgn, hWin,WindowRgn,1<br /><br />    push hOldBmp<br />    push mdc<br />    call SelectObject<br />    push hTempRgn<br />    call DeleteObject<br />    push mdc<br />    call DeleteDC		<br /><br />    mov eax, WindowRgn<br />    ret<br />CreateWinRgnFromBitmap endp<br /></code></pre></div>
    <div class="meta">Posted on 2001-09-12 09:49:43 by Xtreme</div>
   </div>
   <div class="post" id="post-6937">
    <div class="subject"><a href="#post-6937">I can't use registers in place of variables??</a></div>
    <div class="body">It is because of register preservation in function calls.<br /><br />After a function call, the values of <strong>eax</strong>, <strong>ecx</strong> and <strong>edx</strong> can be different to their value before the function was called.<br />They may be the same, but this is purely coincidence, and a further revision of the function will not guarantee that the same registers will hold the same predictable values.<br /><br />I'm not entirely sure what <strong>ebx</strong>, <strong>esi</strong>, and <strong>edi</strong> are used for within the operating system, and whether or not certain API calls rely on the data contained within them, but at the end of any given function call they must be the same as when they were called.<br /><br />If you want to use the reserved registers, there is the USES directive that will push &amp; pop them automatically where appropriate (ie the ret command will be expanded to include the poping of these variables off the stack).<br /><br />It is not a good idea to rely on the value contained in any register (other than <strong>eax</strong>!) after a function call, unless you wrote the function specifically (even then if you &quot;improve&quot; the function it may screw up your code)!<br /><br />Mirno</div>
    <div class="meta">Posted on 2001-09-12 10:39:50 by Mirno</div>
   </div>
   <div class="post" id="post-6942">
    <div class="subject"><a href="#post-6942">I can't use registers in place of variables??</a></div>
    <div class="body">Thanks Mirno,<br /><br />What method should I use to optimize this code then? Should<br />I focus on what API calls are used? ....what about the WHILE<br />macro, is it slower than LOOP<em>xxx</em>?<br /><br />I want to be able to use this code &quot;on-the-fly&quot; as I need to<br />change a window's region in an animation about once every<br />0.1 to 0.5 seconds.<br /><br />Heres a cleaned-up version (using invoke):<br /><br /><pre><code><br />CreateWinRgnFromBitmap proc hWin&#58;HWND, hMaskBitmap&#58;HBITMAP<br /><br />    LOCAL   WindowRgn       &#58;HRGN<br />    LOCAL   hTempRgn        &#58;HRGN<br />    LOCAL   sInfo           &#58;BITMAP		<br />    LOCAL   mdc             &#58;HDC<br />    LOCAL   hOldBmp         &#58;HBITMAP<br />    LOCAL   dwCurrentPixel  &#58;DWORD<br />    LOCAL   dwCurrentLine   &#58;DWORD<br />    LOCAL   begin           &#58;DWORD<br /><br /><br />    invoke  CreateRectRgn,0,0,0,0<br />    mov     WindowRgn, eax<br /><br />    invoke  GetObject, hMaskBitmap, sizeof BITMAP, ADDR sInfo<br /><br />    invoke  CreateCompatibleDC,0<br />    mov     mdc, eax<br /><br />    invoke  SelectObject,mdc,hMaskBitmap<br />    mov     hOldBmp, eax<br /><br />    mov     dwCurrentLine, 0<br />    .WHILE  1<br /><br />        mov eax, dwCurrentLine<br />        .BREAK .IF eax == sInfo.bmHeight<br /><br />        inc     dwCurrentLine<br />        mov     begin, 0<br />        mov     dwCurrentPixel, 0<br /><br />        .WHILE 1<br /><br />            mov eax, dwCurrentPixel<br />            .BREAK .IF eax == sInfo.bmWidth<br /><br />            inc     dwCurrentPixel<br />            invoke  GetPixel, mdc, dwCurrentPixel, dwCurrentLine<br /><br />            .IF eax == 0<br /><br />                .IF begin == 0<br />                    push dwCurrentPixel<br />                    pop begin<br />                .ENDIF<br /><br />            .ELSEIF begin &gt; 0<br /><br />                mov     eax, dwCurrentLine<br />                inc     eax<br />                invoke  CreateRectRgn,begin,dwCurrentLine,dwCurrentPixel,eax<br />                mov     hTempRgn, eax<br />                invoke  CombineRgn,WindowRgn,hTempRgn,WindowRgn,RGN_OR<br />                invoke  DeleteObject, hTempRgn<br />                mov     begin, 0<br /><br />            .ENDIF<br /><br />        .ENDW<br /><br />    .ENDW<br /><br />    invoke  SetWindowRgn, hWin,WindowRgn,1<br />    invoke  SelectObject, mdc, hOldBmp<br />    invoke  DeleteObject, hTempRgn<br />    invoke  DeleteDC, mdc		<br /><br />    mov eax, WindowRgn<br />    ret<br />CreateWinRgnFromBitmap endp<br /></code></pre></div>
    <div class="meta">Posted on 2001-09-12 13:10:51 by Xtreme</div>
   </div>
   <div class="post" id="post-7004">
    <div class="subject"><a href="#post-7004">I can't use registers in place of variables??</a></div>
    <div class="body">Your main problem is the API. API calls are going to drown your code, so optimisations will show little benefit.<br />If you can remove any function calls that will help most. Also check your API manual, see if there are alternatives, and test with those instead (some APIs are better suited to certain situations).<br /><br />Probably the easiest way to get a bit more speed out of your code will be to write the whole branching system yourself. MASM uses macros to build up its loops, so each one is self contained. When you end your ifs, you jump to the end of them, then the end of the while performs a second jump, this is an unnecessary cost.<br />Don't use <strong>loop</strong>, its an old instruction and not optimised in the silicon for most modern processors. Stick to <strong>cmp</strong> &amp; <strong>jmp</strong> combinations.<br /><br />The final thing you can do is to use the return value of previous function calls in subsequent ones:<br /><pre><code><br />;for example replace<br />invoke CreateRectRgn,begin,dwCurrentLine,dwCurrentPixel,eax<br />mov hTempRgn, eax<br />invoke CombineRgn,WindowRgn,hTempRgn,WindowRgn,RGN_OR<br /><br />;with&#58;<br />invoke CreateRectRgn,begin,dwCurrentLine,dwCurrentPixel,eax<br />mov hTempRgn, eax       ;Still save it for later!<br />invoke CombineRgn,WindowRgn,eax,WindowRgn,RGN_OR<br /></code></pre><br /><br />Pushing memory can take longer on a PPro / PII / PIII, and <strong>WILL</strong> take longer on the old Pentium architecture (plus it cannot pair).<br /><br />As I said at the start though, this is all really more of an exercise in code optimisation, unless you are only just short of the desired performance!<br />When optimising code, it is better to pick your battles carefully. You can waste hours squeezing cycles out of every function and algorithm, but in the end it doesn't really matter if your main cost are external functions beyond your control....<br /><br />Mirno</div>
    <div class="meta">Posted on 2001-09-13 04:10:41 by Mirno</div>
   </div>
  </div>
 </body>
</html>