<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>ObjAsm32's DbgFPU working properly? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=25763" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=25763">ObjAsm32's DbgFPU working properly?</a></p>
   <div class="post" id="post-187945">
    <div class="subject"><a href="#post-187945">ObjAsm32's DbgFPU working properly?</a></div>
    <div class="body">Hi Biterider,<br /><br />I have my doubts about the correctness of the output of ObjAsm&#39;s DbgFPU macro. For example:<br /><br /><pre><code>finit<br />fld1<br />fldz<br />fdiv st(0), st(1)<br />DbgFPU<br />fdiv st(1), st(0)<br />DbgFPU</code></pre><br /><br />I expected to see:<br />- a different Level than 0.<br />- the contents of the stack.<br />- exception information.<br /><br />However, the level is 0, and there is no stack or exception information.<br />Is the macro working properly?<br /><br />Friendly regards,<br />mdevries.</div>
    <div class="meta">Posted on 2007-02-03 04:41:38 by mdevries</div>
   </div>
   <div class="post" id="post-187953">
    <div class="subject"><a href="#post-187953">Re: ObjAsm32's DbgFPU working properly?</a></div>
    <div class="body">Hi mdevries<br />Thanks for the bug report. You are right, in one of the last changes in the debug system when I introduced the FPU state saving, I forgot to set the DBG_SAVE_FPU_CONTEXT switch for this macro.<br />A quick fix looks like:<br /><br /><pre><code>DbgFPU macro InfoText, Dest<br />&nbsp; &nbsp; if DEBUGGING<br />&nbsp; &nbsp; &nbsp; ??LastFpuSwitch = DBG_SAVE_FPU_CONTEXT<br />&nbsp; &nbsp; &nbsp; DBG_SAVE_FPU_CONTEXT = FALSE<br />&nbsp; &nbsp; &nbsp; DbgSaveContext<br />&nbsp; &nbsp; &nbsp; invoke EnterCriticalSection, addr DbgCritSect<br />&nbsp; &nbsp; &nbsp; ifb &lt;Dest&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; ??DbgDstWnd textequ &lt;offset szDbgSrc&gt;<br />&nbsp; &nbsp; &nbsp; else<br />&nbsp; &nbsp; &nbsp; &nbsp; ??DbgDstWnd textequ &lt;Dest&gt;<br />&nbsp; &nbsp; &nbsp; endif<br />&nbsp; &nbsp; &nbsp; @invoke DbgOutText, &quot;FPU DUMP&quot;, $RGB(0,0,0), DBG_EFFECT_NORMAL, %??DbgDstWnd<br />&nbsp; &nbsp; &nbsp; DbgShowTxtInfo InfoText, %??DbgDstWnd<br />&nbsp; &nbsp; &nbsp; DbgShowSrcInfo %??DbgDstWnd<br />&nbsp; &nbsp; &nbsp; @invoke DbgOutFpu, %??DbgDstWnd<br />&nbsp; &nbsp; &nbsp; invoke LeaveCriticalSection, addr DbgCritSect<br />&nbsp; &nbsp; &nbsp; DbgLoadContext<br />&nbsp; &nbsp; &nbsp; DBG_SAVE_FPU_CONTEXT = ??LastFpuSwitch<br />&nbsp; &nbsp; endif<br />endm</code></pre><br /><br />but I will try to check the code again since it is outputting &quot;FAIL&quot; in some cases without apparent reason.<br /><br />Regards,<br /><br />Biterider<br /></div>
    <div class="meta">Posted on 2007-02-03 16:13:09 by Biterider</div>
   </div>
   <div class="post" id="post-187955">
    <div class="subject"><a href="#post-187955">Re: ObjAsm32's DbgFPU working properly?</a></div>
    <div class="body">Hi<br />OK, I found the problem. The issue is that when I left the FPU in an exception state like when I perform a division by zero, St0ToStr will fail since it uses the FPU to represent the floating point number. This is the case when &quot;Failed&quot; was written in the FPU stack output.<br />This behavior was not considered when the macro/proc was written. <br />I will write to correct it into my todo list&nbsp; ;)<br /><br />Regards,<br /><br />Biterider</div>
    <div class="meta">Posted on 2007-02-03 16:30:06 by Biterider</div>
   </div>
   <div class="post" id="post-187966">
    <div class="subject"><a href="#post-187966">Re: ObjAsm32's DbgFPU working properly?</a></div>
    <div class="body">Hi Biterider,<br /><br />I will do the partial quickfix in the meantime.<br />Thanks, for your useful and ever increasing product.<br /><br />Friendly regards,<br />mdevries.</div>
    <div class="meta">Posted on 2007-02-03 23:47:01 by mdevries</div>
   </div>
   <div class="post" id="post-187999">
    <div class="subject"><a href="#post-187999">Re: ObjAsm32's DbgFPU working properly?</a></div>
    <div class="body">Hi mdevries<br />I think I have found a definitive fix for that issue. Please, can you test it? It requires to recompile the ObjMem library.<br /><br />Regards,<br /><br />Biterider</div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=2253" target="_blank">DbgFPU.zip</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2007-02-05 08:53:00 by Biterider</div>
   </div>
   <div class="post" id="post-188003">
    <div class="subject"><a href="#post-188003">Re: ObjAsm32's DbgFPU working properly?</a></div>
    <div class="body">Hi Biterider,<br /><br />As far as I can see the exceptions flags are shown correctly now.<br /><br />There is a small problem in showing the contents of the stack:<br />When there is only one stack register left, the level = 7.<br />No problem at that point: st(0) thru st(6) are shown correctly.<br />But after loading the last stack register, the level resets to 0.<br />And as a consequence, the contents of NO register is shown.<br />The level should be 8 instead, and ALL of the registers should be shown. <br /><br />The conditinal line needs some reconsideration too.<br />It continuously says:<br /><br /><pre><code>Conditional: St &gt; Source</code></pre><br /><br />I think you didn&#39;t intend this behavior.<br /><br />Friendly regards,<br />mdevries.</div>
    <div class="meta">Posted on 2007-02-05 16:22:16 by mdevries</div>
   </div>
   <div class="post" id="post-188011">
    <div class="subject"><a href="#post-188011">Re: ObjAsm32's DbgFPU working properly?</a></div>
    <div class="body">Hi<br />Unfortunately I can not reproduce what you describe. I use the following code to test the macro<br /><br /><pre><code>%include @Environ(OA32_PATH)\\Code\\Macros\\Model.inc<br />SysSetup OOP_WINDOWS, DEBUG(WND, INFO, TRACE, STKGUARD, &quot;DC_Test Project&quot;)<br /><br />.const<br />r4_0&nbsp;  real4&nbsp;  0.0<br />r4_1&nbsp;  real4&nbsp;  1.0<br />r4_2&nbsp;  real4&nbsp;  2.0<br />r4_3&nbsp;  real4&nbsp;  3.0<br />r4_4&nbsp;  real4&nbsp;  4.0<br />r4_5&nbsp;  real4&nbsp;  5.0<br />r4_6&nbsp;  real4&nbsp;  6.0<br />r4_7&nbsp;  real4&nbsp;  7.0<br /><br />r4_10&nbsp; real4&nbsp;  10.0<br />r4_m10 real4&nbsp; -10.0<br /><br />.code<br />start:<br />&nbsp; &nbsp; SysInit<br />&nbsp; &nbsp; DbgClear&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Clears output window<br />&nbsp; &nbsp; finit<br />&nbsp; &nbsp; fld r4_7<br />&nbsp; &nbsp; fld r4_6<br />&nbsp; &nbsp; fld r4_5<br />&nbsp; &nbsp; fld r4_4<br />&nbsp; &nbsp; fld r4_3<br />&nbsp; &nbsp; fld r4_2<br />&nbsp; &nbsp; fld r4_1<br />&nbsp; &nbsp; fld r4_0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Levels = 8<br />&nbsp; &nbsp; DbgFPU<br />&nbsp; &nbsp; fdiv st(0), st(1)<br />&nbsp; &nbsp; DbgFPU<br />&nbsp; &nbsp; fdiv st(1), st(0)<br />&nbsp; &nbsp; DbgFPU&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;st(1) = +inf<br />&nbsp; &nbsp; DbgLine<br />&nbsp; &nbsp; fcom r4_10<br />&nbsp; &nbsp; DbgFPU&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;ST &lt; Source<br />&nbsp; &nbsp; fcom r4_m10<br />&nbsp; &nbsp; DbgFPU&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;ST &gt; Source<br />&nbsp; &nbsp; fcom r4_0<br />&nbsp; &nbsp; DbgFPU&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;ST = Source<br />&nbsp; &nbsp; fstp st(0)<br />&nbsp; &nbsp; fstp st(0)<br />&nbsp; &nbsp; DbgFPU&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Levels = 6<br />&nbsp; &nbsp; SysDone<br />&nbsp; &nbsp; invoke ExitProcess, 0<br />end start</code></pre><br /><br />and get the following output<br /><br /><div class="quote">FPU DUMP <br />FPU Levels : 8 <br />Conditional: ST &gt; Source<br />Exceptions : e s p u o z d i<br />&nbsp; st(0) =&nbsp; 0.0000E+0000<br />&nbsp; st(1) =&nbsp; 1.0000E+0000<br />&nbsp; st(2) =&nbsp; 2.0000E+0000<br />&nbsp; st(3) =&nbsp; 3.0000E+0000<br />&nbsp; st(4) =&nbsp; 4.0000E+0000<br />&nbsp; st(5) =&nbsp; 5.0000E+0000<br />&nbsp; st(6) =&nbsp; 6.0000E+0000<br />&nbsp; st(7) =&nbsp; 7.0000E+0000<br />FPU DUMP <br />FPU Levels : 8 <br />Conditional: ST &gt; Source<br />Exceptions : e s p u o z d i<br />&nbsp; st(0) =&nbsp; 0.0000E+0000<br />&nbsp; st(1) =&nbsp; 1.0000E+0000<br />&nbsp; st(2) =&nbsp; 2.0000E+0000<br />&nbsp; st(3) =&nbsp; 3.0000E+0000<br />&nbsp; st(4) =&nbsp; 4.0000E+0000<br />&nbsp; st(5) =&nbsp; 5.0000E+0000<br />&nbsp; st(6) =&nbsp; 6.0000E+0000<br />&nbsp; st(7) =&nbsp; 7.0000E+0000<br />FPU DUMP <br />FPU Levels : 8 <br />Conditional: ST &gt; Source<br />Exceptions : e s p u o Z d i<br />&nbsp; st(0) =&nbsp; 0.0000E+0000<br />&nbsp; st(1) = +Inf<br />&nbsp; st(2) =&nbsp; 2.0000E+0000<br />&nbsp; st(3) =&nbsp; 3.0000E+0000<br />&nbsp; st(4) =&nbsp; 4.0000E+0000<br />&nbsp; st(5) =&nbsp; 5.0000E+0000<br />&nbsp; st(6) =&nbsp; 6.0000E+0000<br />&nbsp; st(7) =&nbsp; 7.0000E+0000<br />????????????????????????????????????????????????????????????<br />FPU DUMP <br />FPU Levels : 8 <br />Conditional: ST &lt; Source<br />Exceptions : e s p u o Z d i<br />&nbsp; st(0) =&nbsp; 0.0000E+0000<br />&nbsp; st(1) = +Inf<br />&nbsp; st(2) =&nbsp; 2.0000E+0000<br />&nbsp; st(3) =&nbsp; 3.0000E+0000<br />&nbsp; st(4) =&nbsp; 4.0000E+0000<br />&nbsp; st(5) =&nbsp; 5.0000E+0000<br />&nbsp; st(6) =&nbsp; 6.0000E+0000<br />&nbsp; st(7) =&nbsp; 7.0000E+0000<br />FPU DUMP <br />FPU Levels : 8 <br />Conditional: ST &gt; Source<br />Exceptions : e s p u o Z d i<br />&nbsp; st(0) =&nbsp; 0.0000E+0000<br />&nbsp; st(1) = +Inf<br />&nbsp; st(2) =&nbsp; 2.0000E+0000<br />&nbsp; st(3) =&nbsp; 3.0000E+0000<br />&nbsp; st(4) =&nbsp; 4.0000E+0000<br />&nbsp; st(5) =&nbsp; 5.0000E+0000<br />&nbsp; st(6) =&nbsp; 6.0000E+0000<br />&nbsp; st(7) =&nbsp; 7.0000E+0000<br />FPU DUMP <br />FPU Levels : 8 <br />Conditional: ST = Source<br />Exceptions : e s p u o Z d i<br />&nbsp; st(0) =&nbsp; 0.0000E+0000<br />&nbsp; st(1) = +Inf<br />&nbsp; st(2) =&nbsp; 2.0000E+0000<br />&nbsp; st(3) =&nbsp; 3.0000E+0000<br />&nbsp; st(4) =&nbsp; 4.0000E+0000<br />&nbsp; st(5) =&nbsp; 5.0000E+0000<br />&nbsp; st(6) =&nbsp; 6.0000E+0000<br />&nbsp; st(7) =&nbsp; 7.0000E+0000<br />FPU DUMP <br />FPU Levels : 6 <br />Conditional: ST = Source<br />Exceptions : e s p u o Z d i<br />&nbsp; st(0) =&nbsp; 2.0000E+0000<br />&nbsp; st(1) =&nbsp; 3.0000E+0000<br />&nbsp; st(2) =&nbsp; 4.0000E+0000<br />&nbsp; st(3) =&nbsp; 5.0000E+0000<br />&nbsp; st(4) =&nbsp; 6.0000E+0000<br />&nbsp; st(5) =&nbsp; 7.0000E+0000</div><br /><br />Perhaps if you can post your code I can try to find out the problem.<br /><br />Best regards,<br /><br />Biterider</div>
    <div class="meta">Posted on 2007-02-06 01:32:52 by Biterider</div>
   </div>
   <div class="post" id="post-188013">
    <div class="subject"><a href="#post-188013">Re: ObjAsm32's DbgFPU working properly?</a></div>
    <div class="body">Hi Biterider,<br /><br />With the help of your own output, I tested a little further.<br />The bottleneck seems to be when having used an empty register<br />as a source operand.<br /><br /><pre><code>%include @Environ(OA32_PATH)\\Code\\Macros\\Model.inc<br />SysSetup OOP_BASE, DEBUG(WND)<br /><br />.data<br /><br />f4 real4 1.5<br />f8 real8 2.0<br />f10 real10 0.5<br />f0 real4 -0.0<br />fn real4 3.0E-38<br /><br />.code<br />start:<br />	SysInit<br />	<br />	DbgText &quot; &quot;<br />	finit<br />	DbgFPU &quot;finit&quot;<br />	<br />	DbgText &quot; &quot;<br />	fwait<br />	DbgFPU &quot;fwait&quot;<br />	<br />	DbgText &quot; &quot;<br />	fldpi<br />	DbgFPU &quot;fldpi&quot;<br />	<br />	DbgText &quot; &quot;<br />	fld f4<br />	DbgFPU &quot;fld f4&quot;<br /><br />	DbgText &quot; &quot;<br />	fld f8<br />	DbgFPU &quot;fld f8&quot;<br /><br />	;Divide by -0.0<br />	DbgText &quot; &quot;<br />	fdiv f0<br />	DbgFPU &quot;fdiv f0&quot;<br /><br />	;Divide by -0.0 again<br />	DbgText &quot; &quot;<br />	fdiv f0<br />	DbgFPU &quot;fdiv f0&quot;<br /><br />	;Use infinity in a computation<br />	DbgText &quot; &quot;<br />	fsub f4<br />	DbgFPU &quot;fsub f4&quot;<br /><br />	DbgText &quot; &quot;<br />	fst f8<br />	DbgFPU &quot;fst f8&quot;<br /><br />	DbgText &quot; &quot;<br />	fstp f10<br />	DbgFPU &quot;fstp f10&quot;<br /><br />	DbgText &quot; &quot;<br />	fld fn<br />	DbgFPU &quot;fld fn&quot;<br /><br />	;Divide by an empty register.<br />	;<br />	;&nbsp; This must be the bottleneck.<br />	;&nbsp; If you comment the following 3 lines out,<br />	;&nbsp; you will be able to see the contents of<br />	;&nbsp; all the 8 registers in the end.<br />	; <br />	DbgText &quot; &quot;<br />	fdiv st(0), st(7)<br />	DbgFPU &quot;fdiv st(0), st(7)&quot;<br /><br />	DbgText &quot; &quot;<br />	fld fn<br />	DbgFPU &quot;fld fn&quot;<br /><br />	DbgText &quot; &quot;<br />	fld fn<br />	DbgFPU &quot;fld fn&quot;<br /><br />	DbgText &quot; &quot;<br />	fld fn<br />	DbgFPU &quot;fld fn&quot;<br /><br />	DbgText &quot; &quot;<br />	fld fn<br />	DbgFPU &quot;fld fn&quot;<br /><br />	DbgText &quot; &quot;<br />	fld f4<br />	DbgFPU &quot;fld f4&quot;<br /><br />	<br />	SysDone<br />	<br />	invoke ExitProcess, 0<br /><br />end start</code></pre><br /><br />Hope this helps finding the bug on the level, and the contents part.<br /><br />I think I misunderstood the meaning of the conditional line.<br />It doesn&#39;t always have a meaning in relation to the last instruction.<br />It just reflects the state of the conditional flags at that given time.<br />Am I right?<br /><br />Friendly regards,<br />mdevries.</div>
    <div class="meta">Posted on 2007-02-06 03:37:42 by mdevries</div>
   </div>
   <div class="post" id="post-188016">
    <div class="subject"><a href="#post-188016">Re: ObjAsm32's DbgFPU working properly?</a></div>
    <div class="body">Hi<br />Second try&nbsp; :)<br /><br /><pre><code>FPU_BUFFER struct<br />&nbsp; wControlWord&nbsp; word&nbsp; &nbsp; ?<br />&nbsp; wUnused0&nbsp; &nbsp; &nbsp; word&nbsp; &nbsp; ?<br />&nbsp; wStatusWord&nbsp;  word&nbsp; &nbsp; ?<br />&nbsp; wUnused1&nbsp; &nbsp; &nbsp; word&nbsp; &nbsp; ?<br />&nbsp; wTagWord&nbsp; &nbsp; &nbsp; word&nbsp; &nbsp; ?<br />&nbsp; wUnused2&nbsp; &nbsp; &nbsp; word&nbsp; &nbsp; ?<br />&nbsp; pInstruction&nbsp; dword&nbsp;  ?<br />&nbsp; wCodeSegment&nbsp; word&nbsp; &nbsp; ?<br />&nbsp; wUnused3&nbsp; &nbsp; &nbsp; word&nbsp; &nbsp; ?<br />&nbsp; pOperand&nbsp; &nbsp; &nbsp; dword&nbsp;  ?<br />&nbsp; wDataSegment&nbsp; word&nbsp; &nbsp; ?<br />&nbsp; wUnused4&nbsp; &nbsp; &nbsp; word&nbsp; &nbsp; ?<br />&nbsp; tSt0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tbyte&nbsp;  ?<br />&nbsp; tSt1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tbyte&nbsp;  ?<br />&nbsp; tSt2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tbyte&nbsp;  ?<br />&nbsp; tSt3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tbyte&nbsp;  ?<br />&nbsp; tSt4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tbyte&nbsp;  ?<br />&nbsp; tSt5&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tbyte&nbsp;  ?<br />&nbsp; tSt6&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tbyte&nbsp;  ?<br />&nbsp; tSt7&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tbyte&nbsp;  ?<br />FPU_BUFFER ends<br /><br />DbgOutFpu proc pDest:Pointer<br />&nbsp; &nbsp; local FPU_Buffer:FPU_BUFFER, dLevels:dword<br />&nbsp; &nbsp; local szBuffer[128]:byte<br />&nbsp; &nbsp; local szFloat[32]:byte<br />&nbsp; &nbsp; local szFPExept[30]:byte<br /><br />&nbsp; &nbsp; fsave FPU_Buffer<br />&nbsp; &nbsp; invoke StrCopy, addr szFPExept, offset szDbgFPU6&nbsp; ;Exceptions<br />&nbsp; &nbsp; mov ax, word ptr FPU_Buffer.wTagWord<br />&nbsp; &nbsp; xor ecx, ecx<br />&nbsp; &nbsp; .while ecx &lt; 8<br />&nbsp; &nbsp; &nbsp; rol ax, 2<br />&nbsp; &nbsp; &nbsp; mov dx, ax<br />&nbsp; &nbsp; &nbsp; and dx, 0000000000000011b<br />&nbsp; &nbsp; &nbsp; .break .if dx == 0000000000000011b<br />&nbsp; &nbsp; &nbsp; inc ecx<br />&nbsp; &nbsp; .endw<br />&nbsp; &nbsp; mov dLevels, ecx<br /><br />&nbsp; &nbsp; invoke wsprintf, addr szBuffer, offset szDbgFPU5, dLevels ;Display Levels found<br />&nbsp; &nbsp; invoke DbgOutText, addr szBuffer, $RGB(50,150,50), DBG_EFFECT_NEWLINE, pDest<br /><br />&nbsp; &nbsp; movzx eax, word ptr FPU_Buffer.wStatusWord<br />&nbsp; &nbsp; shr eax, 6&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;ax&nbsp; = 000000X* XXY*Y*ZZ<br />&nbsp; &nbsp; shl al, 3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;ax&nbsp; = 000000X* *Y*ZZ---<br />&nbsp; &nbsp; shl ax, 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;ax&nbsp; = 00000X** Y*ZZ----<br />&nbsp; &nbsp; shl al, 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;ax&nbsp; = 00000X** *ZZ-----<br />&nbsp; &nbsp; shr eax, 7&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;ax&nbsp; = -------0 0000X***<br />&nbsp; &nbsp; and eax, 7&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;ax&nbsp; = 00000000 00000***<br />&nbsp; &nbsp; .if( eax == 0 )&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;If ST &gt; Source<br />&nbsp; &nbsp; &nbsp; mov ecx, offset szDbgFPU1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;&nbsp; then say so<br />&nbsp; &nbsp; .elseif( eax == 1 )&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;If ST &lt; Source<br />&nbsp; &nbsp; &nbsp; mov ecx, offset szDbgFPU2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;&nbsp; then say so<br />&nbsp; &nbsp; .elseif( eax == 4 )&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;IF ST = Source<br />&nbsp; &nbsp; &nbsp; mov ecx, offset szDbgFPU3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;&nbsp; then say so<br />&nbsp; &nbsp; .else&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Anything else<br />&nbsp; &nbsp; &nbsp; mov ecx, offset szDbgFPU4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;&nbsp; Say as Undefined<br />&nbsp; &nbsp; .endif<br />&nbsp; &nbsp; invoke DbgOutText, ecx, $RGB(50,150,50), DBG_EFFECT_NEWLINE, pDest<br /><br />&nbsp; &nbsp; movzx eax, word ptr FPU_Buffer.wStatusWord;eax = Status first found<br />&nbsp; &nbsp; xor ecx, ecx&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;ecx = 0<br />&nbsp; &nbsp; lea edx, szFPExept&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;edx = Exception String Address<br />&nbsp; &nbsp; add edx, 13&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;edx = First Exception Bit<br />&nbsp; &nbsp; .while ecx &lt; 8&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Go thru 8 exception bits<br />&nbsp; &nbsp; &nbsp; rol al, 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Rol the exception bits left 1<br />&nbsp; &nbsp; &nbsp; jc @F&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;See if a &#39;1&#39; Passed out<br />&nbsp; &nbsp; &nbsp; or byte ptr , 20h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;No, then force lower case (not set)<br />&nbsp; &nbsp; &nbsp; jmp @next&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;&nbsp; &nbsp; and onto next section<br />@@:<br />&nbsp; &nbsp; &nbsp; and byte ptr ,0DFh&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Yes, then Force Upper case (Exception set)<br />@next:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;and onto next section<br />&nbsp; &nbsp; &nbsp; add edx, 2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Since Spaces, inc 2 in string<br />&nbsp; &nbsp; &nbsp; inc ecx&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Next bit!<br />&nbsp; &nbsp; .endw<br />&nbsp; &nbsp; invoke DbgOutText, addr szFPExept, $RGB(50,150,50), DBG_EFFECT_NEWLINE, pDest<br /><br />&nbsp; &nbsp; xor esi, esi&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;esi = Counter = 0<br />&nbsp; &nbsp; lea edi, FPU_Buffer.tSt0<br />&nbsp; &nbsp; .while esi &lt; dLevels&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Go thru all known stack entries<br />&nbsp; &nbsp; &nbsp; finit<br />&nbsp; &nbsp; &nbsp; fld tbyte ptr <br />&nbsp; &nbsp; &nbsp; invoke St0ToStr, addr szFloat, 0, 4, f_SCI&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Create Text Strings from them<br />&nbsp; &nbsp; &nbsp; invoke wsprintf, addr szBuffer, offset szDbgFPU7, \&nbsp; ;And display their contents<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  esi, addr szFloat<br />&nbsp; &nbsp; &nbsp; invoke DbgOutText, addr szBuffer, $RGB(50,150,50), DBG_EFFECT_NEWLINE, pDest<br />&nbsp; &nbsp; &nbsp; add edi, sizeof tbyte&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Next entry<br />&nbsp; &nbsp; &nbsp; inc esi<br />&nbsp; &nbsp; .endw<br /><br />&nbsp; &nbsp; ret<br />DbgOutFpu endp</code></pre><br /><br />I hope that it works now&nbsp; ;)<br /><br />Regards,<br /><br />Biterider<br /></div>
    <div class="meta">Posted on 2007-02-06 10:59:19 by Biterider</div>
   </div>
   <div class="post" id="post-188019">
    <div class="subject"><a href="#post-188019">Re: ObjAsm32's DbgFPU working properly?</a></div>
    <div class="body">Hi Biterider,<br /><br />It&#39;s working now. Thanks again!<br /><br />Friendly regards,<br />mdevries.</div>
    <div class="meta">Posted on 2007-02-06 13:02:32 by mdevries</div>
   </div>
  </div>
 </body>
</html>