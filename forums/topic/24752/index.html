<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Problem with SetWorldTransform - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=24752" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=24752">Problem with SetWorldTransform</a></p>
   <div class="post" id="post-180796">
    <div class="subject"><a href="#post-180796">Problem with SetWorldTransform</a></div>
    <div class="body">I wanted to rotate a bitmap by 90 degrees, so I used the SetWorldTransform function but it doesn&#39;t work at all...&nbsp; :sad: The image I see after calling this function is a normal image without any rotation...<br /><br />My code<br /><br /><pre><code><br />WndProc proc hWnd:HWND, uMsg:UINT, wParam:WPARAM, lParam:LPARAM<br />	<br />	LOCAL ps:PAINTSTRUCT<br />	LOCAL hdc:HDC<br />	LOCAL hMemDC:HDC<br />	LOCAL rect:RECT<br />	LOCAL xform:XFORM<br />	<br />	.IF uMsg==WM_DESTROY<br />		invoke DeleteObject,hFile0<br />		invoke PostQuitMessage,NULL<br />	.ELSEIF uMsg==WM_CREATE<br />		invoke CreateWindowEx,NULL,ADDR EditClass,NULL,\<br />			WS_VISIBLE or WS_CHILD or ES_LEFT or ES_MULTILINE or\<br />			ES_AUTOHSCROLL or ES_AUTOVSCROLL,0,\<br />			0,0,0,hWnd,EditID,\<br />			hInstance,NULL<br />		mov hwndEdit,eax<br />		<br />		mov ofn1.lStructSize,SIZEOF ofn1<br />		push hWnd<br />		pop&nbsp; ofn1.hWndOwner<br />		push hInstance<br />		pop&nbsp; ofn1.hInstance<br />		mov&nbsp; ofn1.lpstrFilter, OFFSET FilterString<br />		mov&nbsp; ofn1.lpstrFile, OFFSET buffer<br />		mov&nbsp; ofn1.nMaxFile,MAXSIZE&nbsp;  <br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />		invoke GetMenu,hWnd<br />		 mov&nbsp; hMenu,eax<br />		<br />	.ELSEIF uMsg==WM_COMMAND<br />		mov eax,wParam<br />		.IF lParam==0<br />			.IF ax==IDM_OTWORZ<br />				mov&nbsp; ofn1.Flags, OFN_FILEMUSTEXIST or \<br />					OFN_PATHMUSTEXIST or OFN_LONGNAMES or\<br />					OFN_EXPLORER or OFN_HIDEREADONLY<br />				invoke GetOpenFileName, ADDR ofn1<br />				.IF eax==TRUE<br />					mov eax, LR_CREATEDIBSECTION or&nbsp; LR_LOADFROMFILE<br />					invoke LoadImage,NULL, ofn1.lpstrFile, IMAGE_BITMAP,0,0,eax<br />					mov hFile0,eax<br />					invoke InvalidateRect,hWnd,NULL,TRUE<br />					<br />				.ENDIF<br />			.ELSEIF ax==IDM_KONIEC<br />				invoke PostQuitMessage,0<br />			.ENDIF<br />		.ENDIF<br />	.ELSEIF uMsg==WM_PAINT<br />		invoke BeginPaint, hWnd, ADDR ps<br />		invoke GetDC, hWnd	;?<br />		mov hdc, eax<br />		invoke CreateCompatibleDC, hdc<br />		mov hMemDC, eax<br />		<br />		invoke GetClientRect, hWnd, ADDR rect<br />		invoke SelectObject, hMemDC, hFile0<br />		<br />		invoke SetGraphicsMode, hdc, GM_ADVANCED<br />		<br />		mov xform.eM11, 0<br />		mov xform.eM12, 1<br />		mov xform.eM21, -1<br />		mov xform.eM22, 0<br />		mov xform.ex, 0<br />		mov xform.ey, 0<br />		<br />		;invoke SetMapMode, hdc, MM_LOENGLISH<br />		;invoke SetViewportOrgEx, hdc, 0, 0, NULL<br />		<br />		invoke SetWorldTransform, hdc, ADDR xform<br />		<br />		invoke BitBlt, hdc, 0, 0, rect.right, rect.bottom, hMemDC, 0, 0, SRCCOPY<br />		invoke DeleteDC, hMemDC<br />		invoke ReleaseDC, hWnd, hdc<br />		invoke EndPaint, hWnd, ADDR ps<br />	.ELSE<br />		invoke DefWindowProc, hWnd, uMsg, wParam, lParam		<br />		ret<br />	.ENDIF<br />	<br />	xor eax, eax<br />	ret<br />WndProc endp<br /></code></pre><br /><br />Can anyone help me? please</div>
    <div class="meta">Posted on 2006-05-21 04:40:25 by carlos_84</div>
   </div>
   <div class="post" id="post-180798">
    <div class="subject"><a href="#post-180798">Re: Problem with SetWorldTransform</a></div>
    <div class="body">Ok... the only thing i can immediately see that might cause it not to work is that you&#39;re not running a new enough windows version: windows 95 (and i think 98) don&#39;t support GM_ADVANCED, so world transforms don&#39;t work on that.<br /><br />Nope... just noticed another possibility - I seem to remember that you must set the transform back at the end of painting: add these lines<br /><br /><pre><code>	invoke ModifyWorldTransform, hdc, NULL, MWT_IDENTITY<br />	invoke SetGraphicsMode, hdc, GM_COMPATIBLE<br /></code></pre><br /><br />Hope that helps,<br />Ossa<br /><br />(by the way, there is no need to use GetDC to get the window DC - BeginPaint returns it anyway and will also set the element of the PAINTSTRUCT with it (ps.hdc))</div>
    <div class="meta">Posted on 2006-05-21 05:18:09 by Ossa</div>
   </div>
   <div class="post" id="post-180802">
    <div class="subject"><a href="#post-180802">Re: Problem with SetWorldTransform</a></div>
    <div class="body">I&#39;m using WinXP<br /><br />I&#39;ve changed the code to:<br /><br /><pre><code><br />invoke SetWorldTransform, hdc, ADDR xform<br />		<br />invoke BitBlt, hdc, 0, 0, rect.right, rect.bottom, hMemDC, 0, 0, SRCCOPY<br /><br />invoke ModifyWorldTransform, hdc, NULL, MWT_IDENTITY<br />invoke SetGraphicsMode, hdc, GM_COMPATIBLE<br /></code></pre><br /><br />but it didn&#39;t help</div>
    <div class="meta">Posted on 2006-05-21 06:11:34 by carlos_84</div>
   </div>
   <div class="post" id="post-180808">
    <div class="subject"><a href="#post-180808">Re: Problem with SetWorldTransform</a></div>
    <div class="body">I have not used SetWorldTransform but to rotate a bitmap I use the following from my graphics library. It works well and is fairly quick though not &quot;lightning fast&quot;. Note that it will only work with 32 bit DIB sections...<br /><br /><pre><code>GetRotatedBitmap FRAME hDIB,radians,clrBack<br />	uses edi,esi,ebx<br />	; From a C routine by Zafir Anjum<br />	; This routine has been radically altered to support DIB sections<br />	; instead of straight DDBs, that way the results can be used immediately<br />	; and the pointers are easier to get.<br />	LOCAL bminfo			:DIBSECTION<br />	LOCAL bmInfoResult		:DIBSECTION<br />	LOCAL cosine,sine		:D ; REAL4<br />	LOCAL tfloat,tfloat1		:D ; REAL4<br />	LOCAL nHeight,nWidth		:D<br />	LOCAL negHeight			:D<br />	LOCAL nRowBytes			:D<br />	LOCAL lpDIBBits			:D<br />	LOCAL x1,x2,x3,maxx,minx,w	:D<br />	LOCAL y1,y2,y3,maxy,miny,h	:D<br />	LOCAL nResultRowBytes		:D<br />	LOCAL hDIBResult		:D<br />	LOCAL lpDIBBitsResult		:D<br />	LOCAL sourcex,sourcey		:D<br />	LOCAL bmi			:BITMAPINFO<br />	LOCAL ppvBits			:D<br /><br />	mov eax,<br />	bswap eax<br />	shr eax,8<br />	mov ,eax<br /><br />	invoke GetObjectA,,SIZEOF DIBSECTION,offset bminfo<br /><br />	mov eax, <br />	mov ,eax<br />	or eax,eax<br />	jns &gt;<br />		; must be bottom up origin<br />		xor eax,eax<br />		ret<br />	:<br />	neg eax<br />	mov ,eax<br /><br />	mov eax, <br />	mov ,eax<br /><br />	mov eax,<br />	shl eax,5 ; mul x 32 bpp<br />	add eax,31<br />	and eax,-31<br />	shr eax,3<br />	mov ,eax<br /><br />	mov eax,<br />	cmp eax,BI_RGB<br />	je &gt;<br />		; must be uncompressed<br />		xor eax,eax<br />		ret<br />	:<br /><br />	mov eax,<br />	mov ,eax<br /><br />	; I suck at FPU stuff<br /><br />	fld D<br />	fcos<br />	fstp D<br /><br />	fld D<br />	fsin<br />	fstp D<br /><br />	fild D<br />	fmul D<br />	fistp D<br /><br />	fild D<br />	fmul D<br />	fistp D<br /><br />	fild D<br />	fmul D<br />	fstp D<br /><br />	fild D<br />	fmul D<br />	fsub D<br />	fistp D<br /><br />	fild D<br />	fmul D<br />	fstp D<br /><br />	fild D<br />	fmul D<br />	fadd D<br />	fistp D<br /><br /><br />	fild D<br />	fmul D<br />	fistp D<br /><br />	fild D<br />	fmul D<br />	fistp D<br /><br />	; Find the minimum x quantity<br />	mov eax,<br />	cmp eax,<br />	jl &gt;<br />		mov eax,<br />		:<br />		cmp eax,<br />		jl &gt;<br />		mov eax,<br />	:<br />	cmp eax,0<br />	jl &gt;<br />	mov eax,0<br />	:<br />	mov ,eax<br /><br />	; Find the minimum y quantity<br />	mov eax,<br />	cmp eax,<br />	jl &gt;<br />		mov eax,<br />		:<br />		cmp eax,<br />		jl &gt;<br />		mov eax,<br />	:<br />	cmp eax,0<br />	jl &gt;<br />	mov eax,0<br />	:<br />	mov ,eax<br /><br />	mov eax,<br />	cmp eax,<br />	jg &gt;<br />		mov eax,<br />		:<br />		cmp eax,<br />		jg &gt;<br />		mov eax,<br />	:<br />	cmp eax,0<br />	jge &gt;<br />	xor eax,eax<br />	:<br />	mov ,eax<br /><br />	sub eax,<br />	mov ,eax<br /><br />	mov eax,<br />	cmp eax,<br />	jg &gt;<br />		mov eax,<br />		:<br />		cmp eax,<br />		jg &gt;<br />		mov eax,<br />	:<br />	cmp eax,0<br />	jge &gt;<br />	xor eax,eax<br />	:<br />	mov ,eax<br />	sub eax,<br />	mov ,eax<br /><br />	mov eax,<br />	shl eax,5 ; mul x 32 bpp<br />	add eax,31<br />	and eax,-31<br />	shr eax,3<br />	mov ,eax<br /><br />	invoke GetDC,0<br />	push eax<br />;	invoke CreateIndependantBitmap,eax,,<br />	<br />	mov D,SIZEOF BITMAPINFOHEADER<br />	mov ecx,<br />	mov ,ecx<br />	mov ecx,<br />	mov D,ecx<br />	mov W,1<br />	mov W,32<br />	mov D,BI_RGB<br />	invoke CreateDIBSection,eax,ADDR bmi,DIB_RGB_COLORS,ADDR ppvBits,NULL,NULL<br />	mov ,eax<br />	pop eax<br />	invoke ReleaseDC,0,eax<br /><br />	invoke GetObjectA,,SIZEOF DIBSECTION,offset bmInfoResult<br />	mov eax,<br />	mov ,eax<br /><br />	xor edi,edi<br />	L1:<br />		xor esi,esi<br />		L2:	<br />			mov eax,esi<br />			add eax,<br />			mov ,eax<br />			fild D<br />			fmul D<br />			fstp D<br /><br />			mov eax,edi<br />			add eax,<br />			mov ,eax<br />			fild D<br />			fmul D<br />			fadd D<br />			fistp D<br /><br />			mov eax,esi<br />			add eax,<br />			mov ,eax<br />			fild D<br />			fmul D<br />			fstp D<br /><br />			mov eax,edi<br />			add eax,<br />			mov ,eax<br />			fild D<br />			fmul D<br />			fsub D<br />			fistp D<br /><br />			cmp D,0<br />			jl &gt;&gt;L3<br />			mov eax,<br />			cmp D,eax<br />			jge &gt;&gt;L3<br />			cmp D,0<br />			jl &gt;&gt;L3<br />			mov eax,<br />			cmp D,eax<br />			jge &gt;&gt;L3<br /><br />				mov ecx,<br />				mov eax,<br />				mul D<br />				add ecx,eax<br />				mov eax,<br />				shl eax,2<br />				add ecx,eax<br />				mov ebx,<br /><br />				mov ecx,<br />				mov eax,<br /><br />				mul edi<br />				add ecx,eax<br />				mov eax, esi<br />				shl eax,2<br />				add ecx,eax<br />				mov ,ebx<br />				jmp &gt;&gt;L4<br />			L3:<br />				mov ecx,<br />				mov eax,<br />				mul edi<br />				add ecx,eax<br />				mov eax,esi<br />				shl eax,2<br />				add ecx,eax<br />				mov eax,<br />				mov ,eax<br />			L4:<br />		inc esi<br />		cmp esi,<br />		jl &lt;&lt;L2<br /><br />	inc edi<br />	cmp edi,<br />	jl &lt;&lt;L1<br /><br />	mov eax,<br /><br />	RET<br />ENDF</code></pre></div>
    <div class="meta">Posted on 2006-05-21 09:41:49 by donkey</div>
   </div>
   <div class="post" id="post-180810">
    <div class="subject"><a href="#post-180810">Re: Problem with SetWorldTransform</a></div>
    <div class="body">Maybe <a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/gdi/cordspac_0inn.asp">this</a> can help?<br /><br /><div class="quote">I seem to remember that you must set the transform back at the end of painting</div><br />Accrorgind to PSDK, you have to do this ONLY if you want to go back to GM_COMPATIBLE mode.<br /><div class="quote">The SetWorldTransform function will fail unless the graphics mode for the given device context has been set to GM_ADVANCED by previously calling the SetGraphicsMode function. Likewise, it will not be possible to reset the graphics mode for the device context to the default GM_COMPATIBLE mode, unless the world transformation has first been reset to the default identity transformation by calling SetWorldTransform or ModifyWorldTransform. </div></div>
    <div class="meta">Posted on 2006-05-21 09:52:48 by ti_mo_n</div>
   </div>
   <div class="post" id="post-180811">
    <div class="subject"><a href="#post-180811">Re: Problem with SetWorldTransform</a></div>
    <div class="body"><div class="quote"><br /><div class="quote">I seem to remember that you must set the transform back at the end of painting</div><br />Accrorgind to PSDK, you have to do this ONLY if you want to go back to GM_COMPATIBLE mode.<br /></div><br /><br />I&#39;m aware of that, but IIRC from when I fiddled about with it (nearly two years ago now, so I&#39;m a bit rusty), I seemed to get very odd behavior if I finished the paint without returning to GM_COMPATIBLE.<br /><br />I could well have remembered wrong though.<br /><br />Ossa</div>
    <div class="meta">Posted on 2006-05-21 10:24:17 by Ossa</div>
   </div>
   <div class="post" id="post-180818">
    <div class="subject"><a href="#post-180818">Re: Problem with SetWorldTransform</a></div>
    <div class="body">XFORM works with floating point values, not integers.<br />Also you must call SetViewportOrgEx before SetWorldTransform. <br /><br /><br /><pre><code>		invoke SetGraphicsMode, hdc, GM_ADVANCED<br />		invoke SetViewportOrgEx, hdc, 20, 20, NULL<br />	<br />		mov xform.eM11, 0 <br />		mov xform.eM12, 3F800000h&nbsp; ; 1.0<br />		mov xform.eM21, 0BF800000h ; -1.0<br />		mov xform.eM22, 0<br />		mov xform.ex, 0<br />		mov xform.ey, 0<br />		invoke SetWorldTransform, hdc, ADDR xform</code></pre><br /><br /><br />(I don&#39;t know about the height/width and required placement of the bitmap you are using, so the above SetViewportOrgEx mapping coordinates were chosen randomly. Obviously you&#39;ll need to adjust that to fit your needs.)</div>
    <div class="meta">Posted on 2006-05-21 11:55:48 by arafel</div>
   </div>
   <div class="post" id="post-180825">
    <div class="subject"><a href="#post-180825">Re: Problem with SetWorldTransform</a></div>
    <div class="body">thank&#39;s, now it&#39;s working (after changing to floating point values) <br /><br />P.S. silly mistake ...&nbsp; :oops:</div>
    <div class="meta">Posted on 2006-05-21 15:29:27 by carlos_84</div>
   </div>
   <div class="post" id="post-180826">
    <div class="subject"><a href="#post-180826">Re: Problem with SetWorldTransform</a></div>
    <div class="body"><div class="quote"><br />thank&#39;s, now it&#39;s working (after changing to floating point values) <br /><br />P.S. silly mistake ...&nbsp; :oops:<br /></div><br />It&#39;s an easy enough mistake to do when assuming everything is a DWORD :)<br /><br />A bit weird that the XFORM struct in the masm32 header files is defined as DWORDs when it should be REAL4s, considering that there&#39;s a few other structs in there that does use REAL4s.<br /><br />Not that it would make a difference error-message wise anyway, and appearantly masm doesn&#39;t support floating-point immediate values: <strong>lala.asm(37) : error A2050: real or BCD number not allowed</strong> (that&#39;s for a struct defined using REAL4).<br /></div>
    <div class="meta">Posted on 2006-05-21 15:37:06 by f0dder</div>
   </div>
  </div>
 </body>
</html>