<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Final Fixes Animated Icons and Cursors - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=14182" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=14182">Final Fixes Animated Icons and Cursors</a></p>
   <div class="post" id="post-109615">
    <div class="subject"><a href="#post-109615">Final Fixes Animated Icons and Cursors</a></div>
    <div class="body">Hi:<br /><br />There was one last thing to resolve with the 2 earlier code posts.<br /><br />The Animated Icon WAS NOT transparent.<br /><br />After searching Microsoft I found that WS_EX_TRANSPARENT does not function for<br />re-drawing the window and apparently was never intended for this purpose.  It<br />is considered a short lived modification to Windows GUI.<br /><br />To fix this problem I modified the WM_PAINT section to pick up the background<br />pixel color under the icon before the first draw.  This is stored in cvBackPix in the<br />ANIICON_INFO structure.<br /><br />To achieve this the value is check for NULL which is a most unlikely window <br />background (BLACK).<br /><br />Before drawing the icon the procedure now sets all pixels to the cvBackPix value<br />using a loop (faster and simpler than BitBlt).<br /><br />In addition I found than the FrameChange .IF was redundant so all lines referencing<br />it have been removed.<br /><br />I have tested all conbinations of DialogBox and Icon/Cursor Resource or File<br />and windows under the same conditions and am working on a complete sample.<br /><br />But for those many who seem interested in the code I include the final ANNIICON_INFO structure and the complete AniWndProc.<br /><pre><code>ANIICON_INFO   Struct<br />               pResInfo       DWORD ?<br />               hWndIcon       DWORD ?<br />               hImage         DWORD ?<br />               TimerID        DWORD ?<br />               cFrames        DWORD ?<br />               cFrameRate     DWORD ?<br />               FrameNumber    DWORD ?<br />               RateCount      DWORD ?<br />               cvBackPix      DWORD ?<br />ANIICON_INFO   Ends<br /><br /><br />AniIconWndProc Proc hWnd&#58;HWND, uMsg&#58;UINT, wParam&#58;WPARAM, lParam&#58;LPARAM<br />               LOCAL pResInfo&#58;DWORD, pIconInfo&#58;DWORD<br />               LOCAL wWidth&#58;DWORD, wHeight&#58;DWORD, vBaseUnits&#58;DWORD<br />               LOCAL IRect&#58;RECT, IPoint&#58;POINT, hWndParent&#58;DWORD<br />               LOCAL ps&#58;PAINTSTRUCT, hDC&#58;HDC, hpDC&#58;HDC<br />               LOCAL vWidthCount&#58;DWORD, vHeightCount&#58;DWORD<br />               LOCAL vPixelColRef&#58;DWORD<br />               <br />               push  edi<br />               push  esi<br /><br />               .IF   uMsg == WM_NCCREATE<br />                     mov   esi, lParam<br />                     ASSUME esi&#58;PTR CREATESTRUCT<br />               ;<br />               ; Get the Resource ID or Name from the Title field<br />               ; Save it to a global variable and replace it with NULL<br />               ;<br />                     mov   ebx, &#91;esi&#93;.lpszName<br />                     .IF   ebx == NULL<br />                           invoke GetWindowLong, hWnd, GWL_ID<br />                           mov AniWndProcResID, eax<br />                     .ELSE<br />                           mov   eax, &#91;esi&#93;.lpszName<br />                           mov   bl, &#91;eax&#93;<br />                           .IF   bl == NULL<br />                                 invoke GetWindowLong, hWnd, GWL_ID<br />                                 mov AniWndProcResID, eax<br />                           .ELSE<br />                                 mov   ebx, &#91;esi&#93;.lpszName<br />                                 mov AniWndProcResID, ebx<br />                                 mov   &#91;esi&#93;.lpszName, NULL<br />                           .ENDIF<br />                     .ENDIF<br />                     invoke SetWindowLong, hWnd, GWL_STYLE, WS_CHILD <br />                     ASSUME esi&#58;NOTHING<br />                     mov   eax, TRUE<br />                     ret<br /><br />               .ELSEIF  uMsg == WM_CLOSE<br />                              invoke DestroyWindow, hWnd<br />                              <br />               .ELSEIF  uMsg == WM_DESTROY<br />                        invoke GetWindowLong, hWnd, GWL_USERDATA<br />                        .IF   eax != NULL<br />                              mov   esi, eax<br />                              ASSUME esi&#58;PTR ANIICON_INFO<br />                              .IF   &#91;esi&#93;.hImage != NULL<br />                                    invoke DestroyCursor, &#91;esi&#93;.hImage<br />                              .ENDIF<br />                              .IF   &#91;esi&#93;.pResInfo != NULL<br />                                    invoke GlobalFree, &#91;esi&#93;.pResInfo<br />                              .ENDIF<br />                              .IF   &#91;esi&#93;.TimerID != NULL<br />                                    invoke KillTimer, &#91;esi&#93;.hWndIcon, &#91;esi&#93;.TimerID<br />                              .ENDIF<br />                              invoke GlobalFree, esi<br />                        .ENDIF<br />                        <br />               .ELSEIF  uMsg == WM_CREATE<br />                        invoke SetWindowLong, hWnd, GWL_USERDATA, NULL<br />                        invoke GlobalAlloc, GPTR, SIZEOF ANIICON_INFO<br />                        mov   pIconInfo, eax<br />                        .IF   eax == NULL<br />                              invoke SendMessage, hWnd, WM_CLOSE, NULL, NULL<br />                              jmp   AniIconWndProc_Exit<br />                        .ENDIF<br />                        invoke SetWindowLong, hWnd, GWL_USERDATA, pIconInfo<br />                        mov   esi, pIconInfo<br />                        ASSUME esi&#58;PTR ANIICON_INFO<br />                        invoke GlobalAlloc, GPTR, SIZEOF ANIRESOURCE_INFO<br />                        mov   pResInfo, eax<br />                        .IF   eax == NULL<br />                              invoke SendMessage, hWnd, WM_CLOSE, NULL, NULL<br />                              jmp   AniIconWndProc_Exit<br />                        .ENDIF<br />                        mov   &#91;esi&#93;.pResInfo, eax<br />                        mov   eax, hWnd<br />                        mov   &#91;esi&#93;.hWndIcon, eax<br />                  ;<br />                  ; Load as Cursor first and then Icon to allow for varied use<br />                  ;<br />                        mov   edi, pResInfo<br />                        ASSUME edi&#58;PTR ANIRESOURCE_INFO<br />                        invoke LoadAnimatedResource, hInstance, pResInfo, AniWndProcResID<br />                        .IF   eax == TRUE<br />                              mov   eax, &#91;edi&#93;.hRAnimated<br />                              mov   &#91;esi&#93;.hImage, eax<br />                              mov   eax, &#91;edi&#93;.cFrames<br />                              mov   &#91;esi&#93;.cFrames, eax<br />                              mov   eax, &#91;edi&#93;.cFrameRate<br />                              mov   &#91;esi&#93;.cFrameRate, eax<br />                              mov   &#91;esi&#93;.RateCount, eax<br />                              and   &#91;esi&#93;.FrameNumber, NULL<br />                              and   &#91;esi&#93;.cvBackPix, NULL<br />                        .ELSE<br />                              and   &#91;esi&#93;.hImage, NULL<br />                              invoke SendMessage, hWnd, WM_CLOSE, NULL, NULL<br />                              jmp   AniIconWndProc_Exit<br />                        .ENDIF<br />                  ;<br />                  ; Now Create the Timer<br />                  ;<br />                        inc   AniTimerCount<br />                        invoke SetTimer, hWnd, AniTimerCount, 11h, NULL<br />                        mov   eax, AniTimerCount<br />                        mov   &#91;esi&#93;.TimerID, eax<br />                  ;<br />                  ; Mow resize the window to 20 dialog units square<br />                  ;<br />                        invoke GetWindowRect, hWnd, ADDR IRect<br />                        invoke GetDialogBaseUnits<br />                        mov   vBaseUnits, eax<br />                        and   eax, 0000FFFFh<br />                        push  edx<br />                        xor   edx, edx<br />                        push  ecx<br />                        mov   ecx, 16<br />                        mul   ecx<br />                        mov   ecx, 4<br />                        div   ecx<br />                        mov   wWidth, eax<br />                        xor   edx, edx<br />                        mov   eax, vBaseUnits<br />                        shr   eax, 10h<br />                        mov   ecx, 16<br />                        mul   ecx<br />                        mov   ecx, 8<br />                        div   ecx<br />                        mov   wHeight, eax<br />                        pop   ecx<br />                        pop   edx<br />                        mov   eax, IRect.left<br />                        mov   IPoint.x, eax<br />                        mov   eax, IRect.top<br />                        mov   IPoint.y, eax<br />                        invoke GetWindowLong, hWnd, GWL_HWNDPARENT<br />                        mov   hWndParent, eax<br />                        invoke ScreenToClient, hWndParent, ADDR IPoint<br />                        invoke MoveWindow, hWnd, IPoint.x, IPoint.y, wWidth, wHeight, TRUE<br /><br />               .ELSEIF  uMsg == WM_PAINT<br />                        invoke GetWindowLong, hWnd, GWL_USERDATA<br />                        mov   esi, eax<br />                        ASSUME esi&#58;PTR ANIICON_INFO<br />                        .IF   &#91;esi&#93;.cvBackPix == NULL<br />                              invoke GetWindowRect, hWnd, ADDR IRect<br />                              mov   eax, IRect.left<br />                              mov   IPoint.x, eax<br />                              mov   eax, IRect.right<br />                              mov   IPoint.y, eax<br />                              invoke GetWindowLong, hWnd, GWL_HWNDPARENT<br />                              mov   hWndParent, eax<br />                              invoke ScreenToClient, hWndParent, ADDR IPoint<br />               ;<br />               ; Move down 1 and right 1 only if not zero<br />               ;<br />                              inc   IPoint.x<br />                              inc   IPoint.y<br />               ;<br />               ; Get a device context<br />               ;<br />                              invoke GetDC, hWndParent<br />                              mov   hpDC, eax<br />                              invoke GetPixel, hpDC, IPoint.x, IPoint.y<br />                              mov   &#91;esi&#93;.cvBackPix, eax<br />                              invoke ReleaseDC, hWndParent, hpDC<br />                        .ENDIF<br />                              invoke BeginPaint, hWnd, ADDR ps<br />                              mov   hDC, eax<br />                              invoke GetClientRect, hWnd, ADDR IRect<br />                              mov   eax, &#91;esi&#93;.cvBackPix<br />                              mov   vPixelColRef, eax<br />                              push  esi<br />                              and   vHeightCount, NULL<br />                              mov   ebx, vHeightCount<br />                              .WHILE   ebx &lt; IRect.bottom<br />                                       and   vWidthCount, NULL<br />                                       mov   eax, vWidthCount<br />                                       .WHILE   eax &lt; IRect.right<br />                                                invoke SetPixel, hDC, vWidthCount, vHeightCount, vPixelColRef<br />                                                inc vWidthCount<br />                                                mov   eax, vWidthCount<br />                                       .ENDW<br />                                       inc   vHeightCount<br />                                       mov   ebx, vHeightCount<br />                              .ENDW<br />                              pop   esi<br /><br />                              invoke DrawIconEx, hDC, 0, 0, &#91;esi&#93;.hImage, NULL, NULL, &#91;esi&#93;.FrameNumber, NULL, DI_NORMAL<br />                              invoke EndPaint, hWnd, ADDR ps<br />                        <br />               .ELSEIF  uMsg == WM_TIMER<br />                        invoke GetWindowLong, hWnd, GWL_USERDATA<br />                        mov   esi, eax<br />                        ASSUME esi&#58;PTR ANIICON_INFO<br />                        mov   eax, wParam<br />                        .IF   eax == &#91;esi&#93;.TimerID<br />                              dec   &#91;esi&#93;.RateCount<br />                              .IF   &#91;esi&#93;.RateCount == 0<br />                                    inc   &#91;esi&#93;.FrameNumber<br />                                    mov   eax, &#91;esi&#93;.FrameNumber<br />                                    .IF   eax == &#91;esi&#93;.cFrames<br />                                          mov   &#91;esi&#93;.FrameNumber, NULL<br />                                    .ENDIF<br />                                    mov   eax, &#91;esi&#93;.cFrameRate<br />                                    mov   &#91;esi&#93;.RateCount, eax<br />                                    invoke InvalidateRect, hWnd, NULL, TRUE<br />                              .ENDIF<br />                        .ENDIF                                       <br />               .ELSE<br />                     invoke DefWindowProc,hWnd,uMsg,wParam,lParam		<br />                     ret<br />               .ENDIF<br />AniIconWndProc_Exit&#58;<br />               ASSUME esi&#58;NOTHING<br />               ASSUME edi&#58;NOTHING<br />               pop   esi<br />               pop   edi<br />               xor eax,eax<br />               ret<br />AniIconWndProc Endp</code></pre><br /><br />Enjoy,<br />Norm<br /><br /><strong><span style="font-size:9px>Code Blocks added by NaN</span></strong></div>
    <div class="meta">Posted on 2003-07-07 18:10:59 by ngc2501ca</div>
   </div>
   <div class="post" id="post-111767">
    <div class="subject"><a href="#post-111767">Final Fixes Animated Icons and Cursors</a></div>
    <div class="body">Looks interesting.. i look forward to your example.<br /><br />:NaN:</div>
    <div class="meta">Posted on 2003-07-24 18:13:08 by NaN</div>
   </div>
   <div class="post" id="post-111989">
    <div class="subject"><a href="#post-111989">Example has been posted</a></div>
    <div class="body">Hi NaN:<br /><br />The thread with my link for the example is no longer on the board??<br /><br />So here it is:<br /><br /><a target="_blank" href="http://www.geocities.com/ngc2501ca/">http://www.geocities.com/ngc2501ca/</a><br /><br />Norm :)</div>
    <div class="meta">Posted on 2003-07-26 17:15:50 by ngc2501ca</div>
   </div>
  </div>
 </body>
</html>