<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Help me with ping!!! - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=1791" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=8">Networking</a> &raquo; <a href="../?id=1791">Help me with ping!!!</a></p>
   <div class="post" id="post-11424">
    <div class="subject"><a href="#post-11424">Help me with ping!!!</a></div>
    <div class="body">maybe i'am so stupid? <br />there are no errors but it didn't works <br />here is the source: <br />.data <br /><br />IPINFO struct <br />Ttl BYTE ? <br />Tos BYTE ? <br />IPFlags BYTE ? <br />OptSize BYTE ? <br />Options BYTE ? <br />IPINFO ends <br /><br />ICMPECHO struct <br />Source DWORD ? <br />Status DWORD ? <br />RTTime DWORD ? <br />DataSize BYTE ? <br />Reserved BYTE ? <br />pData DWORD ? <br />ipInfo IPINFO &lt;&gt; <br />ICMPECHO ends <br /><br />icmpEcho ICMPECHO &lt;&gt; <br />ipInfo IPINFO &lt;&gt; <br /><br />HostIP db &quot;192.168.11.20&quot;,0 <br />hFile HANDLE ? <br />iaDest in_addr &lt;&gt; <br />pHost hostent &lt;&gt; <br />dwAddress DWORD ? <br />messcapt db &quot;Message&quot;,0 <br />mess db &quot;Host is up and running&quot;,0 <br />.code <br />Ping proc <br /><br />invoke inet_addr,addr HostIP <br />mov iaDest.S_un.S_addr,eax <br /><br />invoke gethostbyaddr,addr iaDest,sizeof in_addr,AF_INET <br /><br />mov edx, (hostent ptr ).h_list <br />mov edx, dword ptr  <br />mov eax, dword ptr  <br /><br />mov dwAddress,eax <br /><br />invoke IcmpCreateFile <br /><br />mov hFile,eax <br />mov ipInfo.Ttl, 255 <br />mov ipInfo.Tos, 0 <br />mov ipInfo.IPFlags,0 <br />mov ipInfo.OptSize,0 <br />mov ipInfo.Options,0 <br />mov icmpEcho.Status,0 <br /><br />invoke IcmpSendEcho,hFile,addr dwAddress,0,0,addr ipInfo,addr icmpEcho,sizeof ICMPECHO,1000 <br />mov iaDest.S_un.S_addr,offset icmpEcho.Source <br />.if icmpEcho.Status==TRUE <br />invoke MessageBox,NULL,addr mess ,addr messcapt,MB_OK <br />.endif <br />invoke IcmpCloseHandle,hFile <br />xor eax,eax <br />ret <br />Ping endp <br />please find here errors!</div>
    <div class="meta">Posted on 2001-11-08 08:27:29 by Anorak</div>
   </div>
   <div class="post" id="post-11429">
    <div class="subject"><a href="#post-11429">Help me with ping!!!</a></div>
    <div class="body">Do you own a debugger?<br /><br />What are the return values of all the invokes? Are they what you would expect? If not how are they different.... WHERE IS <strong>YOUR</strong> CODE GOING WRONG?<br />If you want to pay me to debug a program for you, I'm more likely to respond, but to simply dump a whole load of code (repeatedly) on a message board and ask us to fix it is simply bad manners. If your code doesn't work, at least put the time and effort in yourself to find where it stops working. The fact it compiles means very little, I can write a whole lot of code that'll compile, whether or not it does what its supposed to is exactly what debugging is all about.<br />I myself am currently at work, and have better things to do with my time than to find all the coding mistakes you have made. I am however more than happy to suggest fixes for the problems <strong>you</strong> have found.<br /><br />According to the documentation, you need to have made a successful call to WSAStartup before calling gethostbyaddr, have you done this? Is this even the function which fails?<br /><br />Mirno</div>
    <div class="meta">Posted on 2001-11-08 09:12:30 by Mirno</div>
   </div>
   <div class="post" id="post-11438">
    <div class="subject"><a href="#post-11438">Help me with ping!!!</a></div>
    <div class="body">Any one can give me link for ping source on asm?<br />i'am already suffering one month!!!!<br />PLEASE HELP ME!!!!!</div>
    <div class="meta">Posted on 2001-11-08 12:01:13 by Anorak</div>
   </div>
   <div class="post" id="post-166801">
    <div class="subject"><a href="#post-166801">Re: Help me with ping!!!</a></div>
    <div class="body">ICMPECHO struct <br />	Source 	DWORD ? <br />	Status 	DWORD ? <br />	RTTime 	DWORD ? <br />	DataSize BYTE ? <br />	Reserved BYTE ? <br />	pData 	DWORD ? <br />	ipInfo IPINFO &lt;&gt; <br />	<strong>data	db 256 dup (?)</strong><br />ICMPECHO ends</div>
    <div class="meta">Posted on 2005-10-09 14:39:12 by Gary Miller</div>
   </div>
   <div class="post" id="post-166822">
    <div class="subject"><a href="#post-166822">Re: Help me with ping!!!</a></div>
    <div class="body">@Anorak<br />I think people <strong>are</strong> trying to help you m8 - if you will listen to the response above from Mirno , he is trying to help you too.<br /><br />I&#39;m new here I know, and please correct me if I&#39;m wrong, but you should <strong>check</strong> for error responses from <strong>all</strong> invokes like gethostbyname (and even WSAStartup which you must succesfully call before using gethostbyname) and if these fail then you should deal with them in your code - or at least cause it to display some error message so you know things went wrong - you can&#39;t just trust the invoke to work and expect the returned value to be a good one.<br /><br />Now I don&#39;t see <strong>any</strong> such error checking in the above code, it just blindly exects a windows API call to work - why is that?<br /><br />I&#39;m sure if you had programmed to expect Windows API&#39;s to fail at some time, then you would have sorted this problem some time ago.&nbsp; <br /><br />dicky</div>
    <div class="meta">Posted on 2005-10-10 03:25:31 by dicky96</div>
   </div>
   <div class="post" id="post-166855">
    <div class="subject"><a href="#post-166855">Re: Help me with ping!!!</a></div>
    <div class="body"><div class="quote"><br />;@echo off<br />;goto make<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.586				<br />.model flat,stdcall		<br />option casemap:none		<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />include \masm32\include\windows.inc<br />include \masm32\include\user32.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\masm32.inc<br />include \masm32\include\ws2_32.inc<br />include \masm32\include\icmp.inc<br /><br />includelib \masm32\lib\user32.lib<br />includelib \masm32\lib\kernel32.lib<br />includelib \masm32\lib\masm32.lib<br />includelib \masm32\lib\ws2_32.lib<br />includelib \masm32\lib\icmp.lib<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />ICMP_ECHO_REPLYTA STRUCT<br />	Address&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD&nbsp; &nbsp; &nbsp; ?<br />	Status&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  DWORD&nbsp; &nbsp; &nbsp; ?<br />	RoundTripTime&nbsp; &nbsp; DWORD&nbsp; &nbsp; &nbsp; ?<br />	DataSize&nbsp; &nbsp; &nbsp; &nbsp;  WORD&nbsp; &nbsp; &nbsp;  ?<br />	Reserved&nbsp; &nbsp; &nbsp; &nbsp;  WORD&nbsp; &nbsp; &nbsp;  ?<br />	DataPointer&nbsp; &nbsp; &nbsp; DWORD&nbsp; &nbsp; &nbsp; ?<br />	Options&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ICMP_OPTIONS&nbsp; &lt;?&gt;<br />	zData&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BYTE 250 dup (?)<br />ICMP_ECHO_REPLYTA ENDS<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.data<br />	AppName		db	&quot;Ping Test With ICMP&quot;,13,10,0<br />	Usage		db	&quot;Usage: Ping &lt;hostname/Ip&gt;&quot;,13,10,13,10<br />	CRLF		db	13,10,0<br /><br />	Msg_Ping	db	13,10,&quot;Pinging %s With ICMP ......&quot;,0<br />	Msg_Reply	db	13,10,&quot;Reply from %s Time: %d ms TTL: %d, Hops: %d&quot;,0<br />	Msg_Timeout	db	13,10,&quot;Request Timed out&quot;,0<br />	Err_Winsock	db	&quot;Error loading winsock dll : %d&quot;,13,10,0<br />	Err_NoHost	db	&quot;Cannot find host: %s&quot;,13,10,0<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.data?<br />	hIcmp		HANDLE		?		<br />	hLib		HANDLE		?		<br />	dwAddress	DWORD		?		<br />	nHops		DWORD		?<br /><br />	HostBuffer	db	256 dup(?)		<br />	OutBuffer	db	256 dup(?)		<br /><br />	wsadata		WSADATA		&lt;?&gt;		<br />	icmpOptions	ICMP_OPTIONS	&lt;?&gt;		<br />	icmpReply	ICMP_ECHO_REPLYTA &lt;?&gt;		<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.code<br />Start:			<br />	invoke WSAStartup,202h,ADDR wsadata	<br />	.if eax!=0				<br />		invoke wsprintf,ADDR OutBuffer,ADDR Err_Winsock,eax<br />		invoke StdOut,ADDR OutBuffer<br />		jmp @Exit<br />	.endif<br />	invoke GetCL,1,ADDR HostBuffer		<br />	.if (eax!=1)				<br />		invoke StdOut,ADDR Usage	<br />		jmp @Exit				<br />	.endif<br />	invoke inet_addr,ADDR HostBuffer	<br />	.if eax==INADDR_NONE			<br />		invoke gethostbyname,ADDR HostBuffer		<br />		.if eax==0					<br />			invoke wsprintf,ADDR OutBuffer,ADDR Err_NoHost,ADDR HostBuffer <br />			invoke StdOut,ADDR OutBuffer<br />			jmp @Exit<br />		.endif<br />		mov eax,	<br />		mov eax,		<br />		mov eax,		<br />	.endif<br />	mov dwAddress,eax		<br />	invoke IcmpCreateFile		<br />	mov hIcmp,eax			<br />	<br />	invoke wsprintf,ADDR OutBuffer,ADDR Msg_Ping,ADDR HostBuffer<br />	invoke StdOut,ADDR CRLF	<br />	invoke StdOut,ADDR OutBuffer	<br />	invoke StdOut,ADDR CRLF	<br />	<br />	xor ebx,ebx			<br />	.WHILE ebx &lt; 4			<br />		push ebx		<br />		mov icmpOptions.Ttl,255	<br />		mov icmpOptions.Tos,0	<br />		mov icmpOptions.Flags,0	<br />		mov icmpOptions.OptionsSize,0	<br />		mov icmpOptions.OptionsData,0	<br />		<br />		invoke IcmpSendEcho,hIcmp,dwAddress,0,0,ADDR icmpOptions,ADDR icmpReply,SIZEOF ICMP_ECHO_REPLYTA+SIZEOF ICMP_OPTIONS,5000	<br />		.if eax !=0<br />			invoke inet_ntoa,icmpReply.Address	<br />			movzx ecx,icmpReply.Options.Ttl		<br />			mov nHops,256				<br />			sub nHops,ecx				<br />			mov edx,nHops<br />			.if edx==192				<br />				mov nHops,1			<br />			.elseif edx==128			<br />				mov nHops,0			<br />			.endif<br />			invoke wsprintf,ADDR OutBuffer,ADDR Msg_Reply,eax,icmpReply.RoundTripTime,ecx,nHops<br />			invoke StdOut,ADDR OutBuffer			<br />		.else<br />			invoke StdOut,ADDR Msg_Timeout<br />		.endif<br />		pop ebx							<br />		inc ebx							<br />	.ENDW<br />	invoke StdOut,ADDR CRLF		<br />	invoke IcmpCloseHandle,hIcmp	<br />	<br />@Exit:	<br />	invoke WSACleanup		<br />	invoke ExitProcess,0		<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br /><br />end Start<br /><br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />:make<br />set name=ping_2<br /><br />&nbsp; &nbsp; \masm32\bin\ml /c /coff %name%.bat<br />&nbsp; &nbsp; \masm32\bin\Link /subsystem:CONSOLE %name%.obj <br />&nbsp; &nbsp; <br />&nbsp; &nbsp; if exist *.bak del *.bak<br />&nbsp; &nbsp; if exist *.obj del *.obj<br />echo.<br /></div></div>
    <div class="meta">Posted on 2005-10-12 09:50:05 by dcskm4200</div>
   </div>
   <div class="post" id="post-181646">
    <div class="subject"><a href="#post-181646">Re: Help me with ping!!!</a></div>
    <div class="body">you forgot this<br />.386<br />INCLUDE FILE LIST HERE AND INCLUDE COMMANDS<br /></div>
    <div class="meta">Posted on 2006-06-12 20:02:28 by tjweb</div>
   </div>
   <div class="post" id="post-181675">
    <div class="subject"><a href="#post-181675">Re: Help me with ping!!!</a></div>
    <div class="body">I always wonder why nobody reads the dates of the posts for these things... this is a classic example -it&#39;s happened twice... 2001 was the first post and October 2005 was the most recent... do people do searches and then answer or something else?<br /><br />Ossa</div>
    <div class="meta">Posted on 2006-06-13 05:33:29 by Ossa</div>
   </div>
  </div>
 </body>
</html>