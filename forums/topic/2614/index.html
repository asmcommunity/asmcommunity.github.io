<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Source - Video player - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=2614" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=2614">Source - Video player</a></p>
   <div class="post" id="post-16633">
    <div class="subject"><a href="#post-16633">Source - Video player</a></div>
    <div class="body">I already worked on Version 0.30 of my zPlayer... but now I'm gonna develop a complete new Version, wich supports mp3 and video files.<br />Because this new Version will use a complete different way for playing Video &amp; Audio files, I post the source for the &quot;old&quot; on here. <br />Please post comments, how you like this Player / coding style :grin: <br /><br />Have fun with it!<br /><br />regards,<br />bAZiK<br /><br /><br />P.S.: You can ALWAYS ask me for the source of my apps via email!<br /><br /><pre><code><br />; ######################################<br /><br />        .486<br />        .model flat, stdcall<br />        option casemap &#58;none<br /><br />; ######################################<br /><br />        include \masm32\include\windows.inc<br /><br />        include \masm32\include\user32.inc<br />        include \masm32\include\kernel32.inc<br />        include \masm32\include\comctl32.inc<br />        include \masm32\include\comdlg32.inc<br /><br />        includelib \masm32\lib\user32.lib<br />        includelib \masm32\lib\kernel32.lib<br />        includelib \masm32\lib\comctl32.lib<br />        includelib \masm32\lib\comdlg32.lib<br /><br />; ######################################<br /><br />        MCIWNDF_NOMENU     equ 8h<br />;        MCIWNDF_NOPLAYBAR  equ 2h<br />        MCIWNDF_NOTIFYPOS  equ 200h<br /><br />        MCIWNDM_NOTIFYPOS  equ WM_USER + 201<br />        MCIWNDM_SENDSTRING equ WM_USER + 101<br />        MCIWNDM_GETLENGTH  equ WM_USER + 104<br /><br />        CMD_OPEN           equ 100<br />        CMD_ABOUT          equ 101<br /><br />; ######################################<br /><br />    .data<br />        szClassName     db &quot;zPlayer_Class&quot;, 0<br /><br />        wc              WNDCLASSEX &lt;sizeof wc, CS_HREDRAW \<br />                        or CS_VREDRAW or CS_BYTEALIGNWINDOW, \<br />                        offset WndProc, 0, 0, 400000h, \<br />                        0, 0, COLOR_BTNFACE + 1, 0, \<br />                        offset szClassName, 0&gt;<br /><br />        szAppName       db &quot;zPlayer v0.30&quot;, 0<br /><br />        szPosition      db &quot;%s - %lu / %lu - %s&quot;, 0<br /><br />        szOpen          db &quot;&amp;Open&quot;, 0<br />        szAbout         db &quot;&amp;About&quot;, 0<br /><br />        szAboutMsg      db &quot;zPlayer - smallest Video Player of the world!&quot;, 13, 10, \<br />                           &quot;                ? 2001 by bAZiK              &quot;, 13, 10, \<br />                           &quot; programmed in 100% Assembly language &#40;MASM&#41; &quot;, 0<br /><br />        szMCIdll        db &quot;msvfw32.dll&quot;, 0<br />        szMCIWndCreate  db &quot;MCIWndCreate&quot;, 0<br /><br />        szFilter        db &quot;Movies &#40;*.avi, *.mpeg, *.mpg&#41;&quot;, 0, &quot;*.avi;*.mpeg;*.mpg&quot;, 0, &quot;All files &#40;*.*&#41;&quot;, 0, &quot;*.*&quot;, 0<br /><br />;        szTestMovie     db &quot;D&#58;\DEVELOPMENT\test.mpg&quot;, 0<br />;        szTestMovie     db &quot;F&#58;\DivX\Passwort Swordfish.avi&quot;, 0<br />;        szTestMovie     db &quot;D&#58;\DEVELOPMENT\test.avi&quot;, 0<br /><br />; ######################################<br /><br />    .data?<br />        hWnd            dd ?<br />        hMCIWnd         dd ?<br />        hMenu           dd ?<br /><br />        nLength         dd ?<br /><br />        szOFNBuffer     db 512 dup &#40;?&#41;<br />        szMovieFile     db 512 dup &#40;?&#41;<br />        szNewCaption    db 128 dup &#40;?&#41;<br /><br />        msg             MSG &lt;?&gt;<br />        rect            RECT &lt;?&gt;<br />        item            MENUITEMINFO &lt;?&gt;<br />        ofn             OPENFILENAME &lt;?&gt;<br /><br />; ######################################<br /><br />    .code<br /><br />zPlayer&#58;<br />      call WinMain<br />      call InitCommonControls<br />      invoke ExitProcess, eax<br /><br />; ######################################<br /><br />  WinMain proc<br />      invoke LoadIcon, 400000h, 100<br />      mov wc.hIcon, eax<br />      invoke LoadCursor, 0, IDC_ARROW<br />      mov wc.hCursor, eax<br />      invoke RegisterClassEx, addr wc<br />      invoke GetSystemMetrics, SM_CXSCREEN<br />      mov esi,eax<br />      invoke GetSystemMetrics, SM_CYSCREEN<br />      shr esi, 1<br />      shr eax, 1<br />      sub eax, 200/2<br />      sub esi, 300/2<br /><br />      invoke CreateWindowEx, WS_EX_TOPMOST,<br />                             addr szClassName,<br />                             addr szAppName,<br />                             WS_CAPTION or WS_MINIMIZEBOX or WS_SYSMENU or WS_VISIBLE,<br />                             esi, eax, 300, 200, 0, 0, 400000h, 0<br />      mov hWnd, eax<br />      invoke ShowWindow, hWnd, SW_SHOWNORMAL<br />      invoke UpdateWindow, hWnd<br />      mov esi, offset msg<br />   @@&#58;<br />      invoke GetMessage, esi, 0, 0, 0<br />      or eax, eax<br />      je @F<br />      invoke TranslateMessage, esi<br />      invoke DispatchMessage, esi<br />      jmp @B<br />   @@&#58;<br />      mov eax, msg.wParam<br />      ret<br />  WinMain endp<br /><br />; ######################################<br /><br />  WndProc proc hWin &#58;DWORD,uMsg &#58;DWORD, wParam &#58;DWORD, lParam &#58;DWORD<br /><br />     .if uMsg == WM_CREATE<br /><br />        call CreateMenu<br />        mov hMenu, eax<br /><br />        mov item.cbSize, sizeof MENUITEMINFO<br />        mov item.fMask, MIIM_ID or MIIM_TYPE or MIIM_STATE<br />        mov item.fType,  MFT_STRING<br /><br />        mov item.wID, CMD_OPEN<br />        mov item.fState, MFS_ENABLED<br />        mov item.dwTypeData, offset szOpen<br />        mov item.cch, sizeof szOpen<br />        invoke InsertMenuItem, hMenu, 0, 0, addr item<br /><br />        mov item.wID, CMD_ABOUT<br />        mov item.fState, MFS_ENABLED<br />        mov item.dwTypeData, offset szAbout<br />        mov item.cch, sizeof szAbout<br />        invoke InsertMenuItem, hMenu, 1, 0, addr item<br /><br />        invoke SetMenu, hWin, hMenu<br /><br />     .elseif uMsg == WM_COMMAND<br /><br />        .if wParam == CMD_OPEN<br /><br />            mov ofn.lStructSize, sizeof OPENFILENAME<br />            push hWin<br />            pop ofn.hwndOwner<br />            mov ofn.hInstance, 40000h<br />            mov ofn.lpstrFilter, offset szFilter<br />            mov ofn.lpstrFile, offset szOFNBuffer<br />            mov ofn.nMaxFile, 512<br />            mov ofn.lpstrTitle, offset szAppName<br />            mov ofn.Flags, OFN_EXPLORER or OFN_FILEMUSTEXIST or OFN_HIDEREADONLY<br /><br />            invoke GetOpenFileName, addr ofn<br /><br />            mov al, byte ptr &#91;szOFNBuffer&#93;<br />            or al, al<br />            jz @F<br />                invoke lstrcpy, addr szMovieFile, addr szOFNBuffer<br />                invoke RtlZeroMemory, addr szOFNBuffer, 512<br /><br />                invoke SendMessage, hWin, WM_SETTEXT, 0, addr szAppName<br />                invoke SendMessage, hMCIWnd, WM_CLOSE, 0, 0<br /><br />                invoke LoadLibrary, addr szMCIdll<br />                push eax<br />                invoke GetProcAddress, eax, addr szMCIWndCreate<br /><br />                push offset szMovieFile<br />                push MCIWNDF_NOTIFYPOS or MCIWNDF_NOMENU ; MCIWNDF_NOPLAYBAR or<br />                push 400000h<br />                push hWin<br />                call eax<br />                mov hMCIWnd, eax<br />                call FreeLibrary<br /><br />                invoke GetWindowRect, hMCIWnd, addr rect<br />                mov eax, rect.top<br />                mov ebx, rect.bottom<br />                sub ebx, eax ; ebx enth?lt h?he<br />                push ebx<br /><br />                mov ecx, rect.left<br />                mov edx, rect.right<br />                sub edx, ecx ; edx enth?lt breite<br />                push edx<br /><br />                invoke MoveWindow, hMCIWnd, 0, 0, edx, ebx, 1<br />                invoke GetWindowRect, hWin, addr rect<br /><br />                pop edx<br />                pop ebx<br /><br />                add ebx, 50<br />                add edx, 5<br /><br />                invoke MoveWindow, hWin, rect.left, rect.top, edx, ebx, 1<br /><br />                mov item.cbSize, sizeof MENUITEMINFO<br />                mov item.fMask, MIIM_STATE<br />                mov item.fState, MFS_ENABLED<br />                invoke SetMenuItemInfo, hMenu, 1, 1, addr item<br />                invoke DrawMenuBar, hWin<br /><br />                invoke SendMessage, hMCIWnd, MCIWNDM_GETLENGTH, 0, 0<br />                mov nLength, eax<br /><br />            @@&#58;<br /><br />        .elseif wParam == CMD_ABOUT<br />                invoke MessageBox, hWin, addr szAboutMsg, addr szAppName, 0<br /><br />        .endif<br /><br /><br /><br />    .elseif uMsg == MCIWNDM_NOTIFYPOS<br /><br />        invoke wsprintf, addr szNewCaption, addr szPosition, addr szAppName, lParam, nLength, addr szMovieFile<br />        invoke SendMessage, hWin, WM_SETTEXT, 0, addr szNewCaption<br /><br />    .elseif uMsg == WM_DESTROY<br /><br />        invoke PostQuitMessage, 0<br />        xor eax, eax<br />        ret<br /><br />    .endif<br /><br />    invoke DefWindowProc, hWin, uMsg, wParam, lParam<br /><br />    ret<br /><br />WndProc endp<br /><br />; ######################################<br /><br />end zPlayer<br /><br />; ######################################<br /><br /></code></pre></div>
    <div class="meta">Posted on 2001-12-29 13:45:11 by bazik</div>
   </div>
   <div class="post" id="post-35620">
    <div class="subject"><a href="#post-35620">Source - Video player</a></div>
    <div class="body">Hi baZiK, I thought I'd bring this thread to the top again because there's a bug in the source (better late then never :)). I don't know if you're still working on this little player but here's it anyway, so you won't have problems with this later.<br /><br />According to vfw.h, some functions (MCIWndCreate) are using the C calling convention instead of stdcall. Your code calls MCIWndCreate with a couple of pushes and a call, but it needs to cleanup the stack afterwards as well (add esp, 4*4).<br /><br />I came accross this bug as I was using the MCI control in a C project and dynamically loaded the function as I do not need it all the time. However I declared the function pointer as a stdcall function. Somehow this gave no problems in the debug build (even with visual C's stack checks off) but the release build crashed. I traced the code and found out MCIWndCreate did not change esp so it couldn't be a stdcall function.<br /><br />Thomas</div>
    <div class="meta">Posted on 2002-04-29 14:47:29 by Thomas</div>
   </div>
  </div>
 </body>
</html>