<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Question on Silly Window Syndrome and transferring large fil - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=1473" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=8">Networking</a> &raquo; <a href="../?id=1473">Question on Silly Window Syndrome and transferring large fil</a></p>
   <div class="post" id="post-9522">
    <div class="subject"><a href="#post-9522">Question on Silly Window Syndrome and transferring large fil</a></div>
    <div class="body">Hi All,<br /><br />I've got a question that has been bugging me for some time now.<br />I'm writing a small app that allows file transfers between PCs on a intranet / LAN (a bit like LapLink or PCAnywhere, but just on TCP/IP)<br /><br />The app works fine when the 2 PCs have similar speeds. The problem arises when one of the 2 is considerably slower. What happen is the infamous Silly Window Syndrome, where one PC is sending data faster than the receiver can read, therefore filling the receiver buffer too quickly (or something like that). And when this happens the program on the slow receiving machine freezes until the whole file is transferred (not very professional is it?)<br /><br />I've been using async sockets on both the server and the client. <br />I've been playing around a lot with various combinations (like file mapping, multiple recv vs single recv, single/multi-threads, different recv/sending buffer sizes, etc) and the following is for the moment the best I've got<br /><br />Here is part of the code for the server / sending routine (placed on a dedicated thread):<br /><br />;*********************************************<br />when receive FD_WRITE and file transfer is in progress then call:<br />....<br />invoke  SetFilePointer,,,0,FILE_BEGIN<br />;//start sending loop<br />xor     eax,eax<br />.WHILE  !=0 &amp;&amp; eax!=SOCKET_ERROR<br />        mov     eax,8192           ;//8kb sending buffer<br />        .IF     eax&gt;<br />                mov     eax, ;//transfer final chunk<br />        .ENDIF<br />        mov     ecx,eax<br />        invoke  ReadFile,,,ecx,ADDR num,0<br />        invoke  send, , , , NULL<br />        .IF     eax!=SOCKET_ERROR<br />                sub     ,eax<br />                add     ,eax<br />                .IF     ==0    ;//transferred the whole file<br />                        ...<br />                        ...//closes handles, etc....<br />                        ...<br />                .ELSEIF eax!=       ;//if couldn't send all data<br />                        invoke  SetFilePointer,,,0,FILE_BEGIN<br />                .ENDIF<br />        .ELSE   ;&lt;An error occured&gt;<br />                ...<br />                ...//handle the error<br />                ...<br />        .ENDIF<br />.ENDW<br /><br />...if the file transfer is not over, will wait for FD_WRITE<br />;*********************************************<br /><br /><br /><br />On the client side / receving routine I have:<br /><br />;*********************************************<br />when receive FD_READ and file transfer is in progress then call:<br />....<br /><br />;//disable FD_READ message because<br />;//multiple recvs will prompt multiple FD_READ<br />invoke  WSAAsyncSelect, , , WM_SOCKET_CLIENT, FD_CLOSE+FD_WRITE<br />;//start receiving loop<br />xor     eax,eax<br />.WHILE  !=0 &amp;&amp; eax!=SOCKET_ERROR<br />	invoke  ioctlsocket,,FIONREAD,ADDR <br />        mov     eax,<br />        .IF     eax&gt;<br />                mov     eax, ;//transfer final chunk<br />        .ENDIF<br />        .IF     eax&gt;8192               ;//8kb receiving buffer<br />                mov     eax,8192<br />        .ENDIF<br />        invoke  recv, ,, eax, NULL<br />        .IF     eax!=SOCKET_ERROR<br />                sub     ,eax<br />                add     ,eax<br />                mov     ecx,eax<br />                invoke  WriteFile,,,ecx,ADDR ,0<br />                .IF     ==0    ;//reached EOF<br />                        ...<br />                        ...//closes handles, etc....<br />                        ...<br />		.ENDIF<br />        .ELSE   ;&lt;An error occured&gt;<br />                ...<br />                ...//handle the error<br />                ...<br />        .ENDIF<br />.ENDW<br />;//re-enable FD_READ message<br />invoke  WSAAsyncSelect, , , WM_SOCKET_CLIENT, FD_READ+FD_CLOSE+FD_WRITE<br /><br />...if the file transfer is not over, will wait for FD_READ<br />;*********************************************<br /><br /><br />I've tried using a single recv and wait for subsequent FD_READ, but it's worse<br />Looping the recv seems the fastest receiving way (as long as you disable FD_READ during the loop to avoid windows posting many useless FD_READ)<br />File mapping is good but when transferring various huge files at the same time the memory requirements are huge as well<br />Bigger buffers will deteriorate the performance of the transfer FROM the slow TO the fast machine<br /><br />If the client/receiver is on the slow machine the program will not give me control until the file is transferred. <br />On small files it's no big deal, but when transferring 1GB files then it's a big issue<br /><br />On P2P applications where you can transfer many files, very fast without the system loosing in performance and CPU loads around 2% ... how do they do that? say EDonkey or DirectConnect<br /><br />Any help would be greatly appreciated<br /><br />Cheers<br />Random</div>
    <div class="meta">Posted on 2001-10-16 04:27:51 by random</div>
   </div>
   <div class="post" id="post-10568">
    <div class="subject"><a href="#post-10568">Question on Silly Window Syndrome and transferring large fil</a></div>
    <div class="body">You should try to work your recv portion<br />of your program into a thread, there by<br />letting your main window free to take<br />care of other chores, such as, updating<br />your main window, and other functions.<br />but remember to keep messages going<br />to and from your thread, so you keep<br />control at all times.<br /><br /><br />Zcoder.....</div>
    <div class="meta">Posted on 2001-10-29 05:43:43 by Zcoder</div>
   </div>
   <div class="post" id="post-10668">
    <div class="subject"><a href="#post-10668">Question on Silly Window Syndrome and transferring large fil</a></div>
    <div class="body">Zcoder,<br /><br />thank you<br />since this post I actually did exactly what you are suggesting.<br /><br />I now have a pool of 4 working threads:<br /><br />The main window thread, which receives all messages and forwards all winsock messages (FD_READ/WRITE etc) to a &quot;Winsock&quot; thread. This thread handles the winsock messages and in particular sends FD_READ requests to a READ thread and FD_WRITE req to a WRITE thread, while it deals with everything else. Performance and CPU load have improved considerably, and of course the UI doesn't freeze anymore :)<br /><br />cheers<br />Random</div>
    <div class="meta">Posted on 2001-10-30 04:29:58 by random</div>
   </div>
  </div>
 </body>
</html>