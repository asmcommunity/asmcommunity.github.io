<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>FFT Algo - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=13218" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=13218">FFT Algo</a></p>
   <div class="post" id="post-102548">
    <div class="subject"><a href="#post-102548">FFT Algo</a></div>
    <div class="body">After searching this board as well as google in general, i didnt find anything for doing FFT and IFFT with MASM.  So i decided to transcribe a source i had from Numerical Recipies in C.  Here is the transcription, with a test program.<br /><br />There is a bug in it tho, and its driving me crazy trying to find it.  I hoping someone can give it a 'fresh eye' and hopefully spot my mistake.  Its well commented, and i have the origional source above in the file (commented).  I transcribed it in-file with a split views on (made it quite easy to do).<br /><br />I have also provided a test program.  It uses a series of data points (found in fpdata.inc) as its input.  It doesnt crash (so its a nasty bug) and it produces normal numbers, only they are wrong. <br /><br />I have also appended in fpdata.inc the correct answers as per MatLab's FFT.<br /><br />Thanks for your help!<br />As well I plan to post this for optomization by all you guru's who ache for something new... if you do get it figured out, feel free to optomize it if you like.  My goal is to hopefully make it another addition to the MASM32 LIB.<br /><br />Here is a plot of the correct output responce (real values only):</div>
    <div class="meta">Posted on 2003-05-11 23:37:21 by NaN</div>
   </div>
   <div class="post" id="post-102550">
    <div class="subject"><a href="#post-102550">FFT Algo</a></div>
    <div class="body">And here is the file and source...  <br /><br />If you do figure it out, tack on you name at the top so credit can be given in the final release.<br /><br />Thanks again!<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-05-11 23:40:22 by NaN</div>
   </div>
   <div class="post" id="post-102724">
    <div class="subject"><a href="#post-102724">FFT Algo</a></div>
    <div class="body">If anyone knows what im doing wrong here.. i would love to hear your thoughts... I plotted its output, and its similar in layout, but values are not correct.  As well there is 'ringing' developing in the math (numbers are oscillating) and become more unstable as it gets further down the data array.  I believe its this ringing that is faultering the output.  However i can't see where it would be comming from.  My only guess is its round off errors in the fpu math?  (Im not an expert at such things, but it thought it did it correctly)..<br /><br />:confused: NaN :confused:</div>
    <div class="meta">Posted on 2003-05-12 23:46:06 by NaN</div>
   </div>
   <div class="post" id="post-102726">
    <div class="subject"><a href="#post-102726">FFT Algo</a></div>
    <div class="body"><div class="quote"><br />If anyone knows what im doing wrong here.. i would love to hear your thoughts...</div><br />Hmm-- FFT as in &quot;Fast Fouries Transform&quot;? Something with wave forms (audio), right? I'll see if I can take a look at it, but have little (almost nonexistant) knowledge of Fourier Transforms.<br />(well, that's about it (my thoughts before rushign to school))</div>
    <div class="meta">Posted on 2003-05-12 23:55:30 by scientica</div>
   </div>
   <div class="post" id="post-102745">
    <div class="subject"><a href="#post-102745">FFT Algo</a></div>
    <div class="body">NaN, post a graphed example of your incorrect results, too?<br />I don't have any experience with FFT, but the graph might give an idea what's wrong.<br /><br />Are you remembering to finit? Are you setting up the FPU rounding mode?</div>
    <div class="meta">Posted on 2003-05-13 02:05:35 by f0dder</div>
   </div>
   <div class="post" id="post-102767">
    <div class="subject"><a href="#post-102767">FFT Algo</a></div>
    <div class="body">NAN - I only just scanned your code , but I notice in the SWAP routine you seem to be duplicating the 1-base array assumption of the original code, yet your data is zero-based. <br /><br />Thus, when &quot;i&quot; = 1 (for example), you're really referencing the second array element when the original source wants to reference the first element.<br /><br />Suggest adjusting the index or basepointer</div>
    <div class="meta">Posted on 2003-05-13 05:51:08 by TheoMcCloskey</div>
   </div>
   <div class="post" id="post-102898">
    <div class="subject"><a href="#post-102898">FFT Algo</a></div>
    <div class="body">Thanx i will look at this indexing your talking about.  However, i thought C is 0 based indexing?  Only when you define the length do you make it 1 based in size...<br /><br />f0dder, here is the plot you asked for:</div>
    <div class="meta">Posted on 2003-05-13 17:46:55 by NaN</div>
   </div>
   <div class="post" id="post-102899">
    <div class="subject"><a href="#post-102899">FFT Algo</a></div>
    <div class="body">Actually it is working, well kinda.  I was miss-reading the data.  The ringing is because i was taking in the phase as well as the amplitude as an amplitude data set...<br /><br />Below is a plot of the same data with every other point taken (even points).  However, its not aligned correctly and has different peak amplitudes, so maybe there is an index problem of some sort?? Or maybe its the algorithm from Numberical Recipies in C.  Still open to suggestions/comments!</div>
    <div class="meta">Posted on 2003-05-13 18:07:01 by NaN</div>
   </div>
   <div class="post" id="post-102950">
    <div class="subject"><a href="#post-102950">FFT Algo</a></div>
    <div class="body"><div class="quote"><br />However, i thought C is 0 based indexing?  Only when you define the length do you make it 1 based in size...<br /></div><br /><br />You fell into the nasty trap of Numerical Recipes in C.  I posted a similar msg before, but I'll repeat.  <br /><br />Do _NOT_ take the code in that book as a good example or a bug-free implementation.  The code there is a quick translation of its older and better half, the original &quot;Numerical Recipes&quot; (in Fortran77).  Anyone who is serious about numerical methods should not consider the book as a ready-to-use C library, but read it as a general (introductory) algorithm book.<br /><br />As for a better example of FFT in C, google for &quot;FFTW&quot; or &quot;djbfft&quot;.<br /><br /><br />djbfft has its own assembly code in AT&amp;T syntax.  That would be a better starting point than translating C code.<br /><br /><br /><br />I forgot to explain why NRiC array is not a (generic or proper) C array.  The authors don't seem to understand C very well, but they do understand Fortran.  They seem to make the indexing consistent between their Fortran code and the new quick-and-dirty translation into C.  So, they actually waste sizeof(float) or sizeof(double) bytes for each vector.<br /></div>
    <div class="meta">Posted on 2003-05-13 22:51:10 by Starless</div>
   </div>
   <div class="post" id="post-102954">
    <div class="subject"><a href="#post-102954">FFT Algo</a></div>
    <div class="body">Thanks for the confirmation.  I have it VERY close to working.  (it *is* an indexing issue).  However, when i get the magnitudes to line up perfectly, the phase is 180 out! (but alligned properly over its freq bins)..<br /><br />Tweeking indexes pulls one in, and another out!  Soooo frustrating....  <br />However, thanks for the sugestion!  Kinda upset with the book at this point (for all the time spent in debugging this crap).<br /><br />:NaN:</div>
    <div class="meta">Posted on 2003-05-13 23:28:57 by NaN</div>
   </div>
   <div class="post" id="post-102971">
    <div class="subject"><a href="#post-102971">FFT Algo</a></div>
    <div class="body">Sorry to go off-topic here - but finit?<br />Do you have to finit?<br /><br />I NEVER bother, and it's always there when debugging - I assumed that MASM put it in for me or something..</div>
    <div class="meta">Posted on 2003-05-14 01:26:39 by Homer</div>
   </div>
   <div class="post" id="post-102979">
    <div class="subject"><a href="#post-102979">FFT Algo</a></div>
    <div class="body">Homer, you say the finit instruction is there even though you haven't issued it? That's creepy if you're only doing assembly programming.<br /><br />Windows might or might not have set up stuff for you, but there's generally no guarantees on register state when your process starts, so I tend to use finit (and set up rounding modes etc) when I do float stuff from assembly programs (which isn't very often :)). It's a few instructions at the start of my programs, and it lets me sleep at night ^_^</div>
    <div class="meta">Posted on 2003-05-14 01:52:06 by f0dder</div>
   </div>
   <div class="post" id="post-102990">
    <div class="subject"><a href="#post-102990">FFT Algo</a></div>
    <div class="body">Hmm, getting OT...  I avoided posting OT msg when I first saw someone mentioned finit, but it is hard to resist second time.  :)<br /><br />Actually, <strong>finit</strong> is the responsibility of OS.  (Let's not argue that in DOS days, we had to do that.  After all, it is a Win32 programming forum.)  Otherwise, you won't have a reliable task switching when several processes use FPU.  Modern x86 OS issues <strong>finit</strong> at the start up time, FPU registers are managed by the OS.  To see how to do that, see, for example, Intel manual vol. 3.  <br /><br />I have never traced into Windows itself to verify that it actually manages FPU registers.  But, I can infer, from my experience, that it does.  Otherwise, my computation program and my small clock would have never worked at the same time.</div>
    <div class="meta">Posted on 2003-05-14 02:43:48 by Starless</div>
   </div>
   <div class="post" id="post-103047">
    <div class="subject"><a href="#post-103047">FFT Algo</a></div>
    <div class="body">I gatter no-one has really looked over the source.  Its the second finit comment, and its the first instruction in the proceedure...   <br /><br />So to answer you questions, yes I had consided this requirement in its initial design.  The problem is 100% in the indexing of the for loops, since i have already gotten preciecely accurate numbers under certain situaltions (tweeking =, &gt;, &lt;, signs to work with a zero based index).<br /><br />Im quite frustrated tho, and considering starting over with another source if i cant figure out the proper looping index start and stop values.<br /><br />:NaN:</div>
    <div class="meta">Posted on 2003-05-14 12:50:07 by NaN</div>
   </div>
   <div class="post" id="post-103097">
    <div class="subject"><a href="#post-103097">FFT Algo</a></div>
    <div class="body">Sooooooooooooooo BITTER!<br /><br /><br />Took all week of tracing code and funky indexing with this FFT algo.  And finaly discovered the what the bug was!!<br /><br />There was a minor index problem.  But when corrected, everything was mathematically aligned except the phase of the transform would always be inverse of what it should be (opposite sign, right value in the right freq bin).<br /><br />I traced and traced and traced through the code and always came up short.<br /><br />Then when reviewing another algo version (with is identical to this) i noticed that their value for TwoPie was -6.28318530717959.  <br /><br />MINE WAS: 6.28318530717959.   (180 degrees out of phase! ArGh!)<br /><br />It wasnt the code, it was the constant. The ONLY constant!<br /><br />This is a pretty nasty typo from the book!  I double checked the Numberical Recipies in C and it has the positive value listed....  grrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr!<br /><br />Anywho.. on the bright side, the FFT and IFFT algo runs fine now!<br /><br />:NaN:</div>
    <div class="meta">Posted on 2003-05-14 20:37:20 by NaN</div>
   </div>
   <div class="post" id="post-103166">
    <div class="subject"><a href="#post-103166">FFT Algo</a></div>
    <div class="body">Good job NaN! - It is quite a shame (or is it 'sham') that such an insidious error in the source prevails through publication. I'm sure I don't speek alone when I say 'I feel your pain'...<br /><br />Anyhow, I did get a chance to further review your original post and, as you say, other than the data array offset/indexing (minor: adjust basepoint EDX), your code is a technically correct conversion.  But I was wondering if your still interested in developing this further as I have some suggestions for optimization.</div>
    <div class="meta">Posted on 2003-05-15 05:29:22 by TheoMcCloskey</div>
   </div>
   <div class="post" id="post-103192">
    <div class="subject"><a href="#post-103192">FFT Algo</a></div>
    <div class="body">Thanx.<br /><br />I have no clue when it comes to rhym or reason for optomizations.  This is why i come here ;) .   But if you can and know how then i urge you to give it your mark (and suitable credit to yourself!).<br /><br />The working version is in <a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=13298">This Thread</a><br /><br />There may be a way of normailizing the data as its being written back to the array data<em> and data<em> points.  Saving the overhead of one more full pass, scaling the data back.<br /><br />A test algorigthm is simple:<pre><code>.386<br />.model flat,stdcall<br />option casemap&#58;none<br /><br />include \masm32\include\windows.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\user32.inc<br />include \masm32\include\masm32.inc<br />include \masm32\include\debug.inc<br /><br />includelib \masm32\lib\kernel32.lib<br />includelib \masm32\lib\user32.lib<br />includelib \masm32\lib\masm32.lib<br />includelib \masm32\lib\debug.lib<br /><br />include fpdata.inc   <br />   <br />DBGWIN_DEBUG_ON = 1 <br />DBGWIN_EXT_INFO = 0<br />   <br />start&#58;<br />   push ebx<br />   push esi<br /><br /><br />   ; Data set selection made easy, just cut and past into<br />   ; the equate the data you want to process.<br />   atext TEXTEQU &lt;IMPULSE&gt;  ;  IMPULSE  FP_DATA FDATA2<br /><br />   ; Do forward FFT of data<br />   invoke FFT, addr atext, 64, 1, 1    ; 64 Complex points<br />   <br />   PrintText &quot;===&#91; Forward FFT - Magnitude &#93;===&quot;<br />   lea edx, atext<br />   xor ebx, ebx<br />   .while &#40;ebx &lt; 128&#41;                  ; Total array = 128 data<br />      PrintDouble QWORD PTR &#91;edx+ebx*8&#93;            <br />      add ebx, 2<br />   .endw<br />   PrintText &quot;===&#91; Forward FFT - Phase &#93;===&quot;<br />   lea edx, atext<br />   xor ebx, ebx<br />   inc ebx<br />   .while &#40;ebx &lt; 128&#41;<br />      PrintDouble QWORD PTR &#91;edx+ebx*8&#93;            <br />      add ebx, 2<br />   .endw<br /><br /><br />   ; Do reverse FFT of the data<br />   invoke FFT, addr atext, 64, -1,0    ; 64 Complex points<br /><br />   PrintText &quot; &quot;<br />   PrintText &quot;===&#91; Reverse FFT - Magnitude &#93;===&quot;<br />   lea edx, atext<br />   xor ebx, ebx<br />   .while &#40;ebx &lt; 128&#41;<br />      PrintDouble QWORD PTR &#91;edx+ebx*8&#93;            <br />      add ebx, 2<br />   .endw<br />   PrintText &quot;===&#91; Reverse FFT - Phase &#93;===&quot;<br />   lea edx, atext<br />   xor ebx, ebx<br />   inc ebx<br />   .while &#40;ebx &lt; 128&#41;<br />      PrintDouble QWORD PTR &#91;edx+ebx*8&#93;            <br />      add ebx, 2<br />   .endw<br /><br /><br />   pop esi<br />   pop ebx<br />   invoke ExitProcess, NULL<br />end start   <br />end   </code></pre><br /><br /><strong>When in your &quot;fpdata.inc&quot; file the data is stored as will be labelled by the &quot;atext&quot; equate contents.  Here is two sample sets of data.  FP_DATA is the above 64 point data set with 5 full oscillations withing it.  IMPULSE is an impulse at time = 0, which in the frequency domain (FFT) will produce 0 phase shift anywhere, and a constant amount of energy in all frequencies (After all an impulse is the sum of all frequencies).  Here is the data sets:</strong><pre><code>&#91;size=9&#93;FP_DATA LABEL BYTE  ; 5 full cycles real in 64 data points &#40;complex&#41;<br />dq       0.0, 0.0<br />dq    0.4783, 0.0<br />dq    0.8400, 0.0<br />dq    0.9972, 0.0<br />dq    0.9115, 0.0<br />dq    0.6038, 0.0<br />dq    0.1490, 0.0<br />dq   -0.3420, 0.0<br />dq   -0.7498, 0.0<br />dq   -0.9749, 0.0<br />dq   -0.9626, 0.0<br />dq   -0.7159, 0.0<br />dq   -0.2948, 0.0<br />dq    0.1981, 0.0<br />dq    0.6428, 0.0<br />dq    0.9309, 0.0<br />dq    0.9922, 0.0<br />dq    0.8119, 0.0<br />dq    0.4339, 0.0<br />dq   -0.0498, 0.0<br />dq   -0.5214, 0.0<br />dq   -0.8660, 0.0<br />dq   -0.9997, 0.0<br />dq   -0.8899, 0.0<br />dq   -0.5633, 0.0<br />dq   -0.0996, 0.0<br />dq    0.3884, 0.0<br />dq    0.7818, 0.0<br />dq    0.9848, 0.0<br />dq    0.9479, 0.0<br />dq    0.6802, 0.0<br />dq    0.2468, 0.0<br />dq   -0.2468, 0.0<br />dq   -0.6802, 0.0<br />dq   -0.9479, 0.0<br />dq   -0.9848, 0.0<br />dq   -0.7818, 0.0<br />dq   -0.3884, 0.0<br />dq    0.0996, 0.0<br />dq    0.5633, 0.0<br />dq    0.8899, 0.0<br />dq    0.9997, 0.0<br />dq    0.8660, 0.0<br />dq    0.5214, 0.0<br />dq    0.0498, 0.0<br />dq   -0.4339, 0.0<br />dq   -0.8119, 0.0<br />dq   -0.9922, 0.0<br />dq   -0.9309, 0.0<br />dq   -0.6428, 0.0<br />dq   -0.1981, 0.0<br />dq    0.2948, 0.0<br />dq    0.7159, 0.0<br />dq    0.9626, 0.0<br />dq    0.9749, 0.0<br />dq    0.7498, 0.0<br />dq    0.3420, 0.0<br />dq   -0.1490, 0.0<br />dq   -0.6038, 0.0<br />dq   -0.9115, 0.0<br />dq   -0.9972, 0.0<br />dq   -0.8400, 0.0<br />dq   -0.4783, 0.0<br />dq   -0.0000, 0.0<br /><br /><br />IMPULSE LABEL BYTE<br />dq       1.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0<br />dq       0.0, 0.0&#91;/size&#93;</code></pre><br /><br />Enjoy!  Hope you can speed up the algorithm.  The faster it is, the more DSP work you can do in real time!  Thanks for you interest on this project!  To keep you informed, i plan on posting more DSP work and tools, such us MASM coders can start to do really *cool* stuff ;)<br /><br />Side Note:  An impulse is like a Lightning strike.. Very fast and then finished.  Its no wonder that your radio will crackle from lightning activity, no matter what frequency your on.  This is because an impulse floods Every frequency with energy (as shown in the FFT ;) )<br /><br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-05-15 09:02:52 by NaN</div>
   </div>
  </div>
 </body>
</html>