<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Nasm Preprocessor  - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=29678" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=29678">Nasm Preprocessor </a></p>
   <div class="post" id="post-209529">
    <div class="subject"><a href="#post-209529">Nasm Preprocessor </a></div>
    <div class="body">Hi all<br />I have tried to things with macros that rely on forward referencing. I have been playing around for a few weeks, on and off and have been biting my teeth out over this. I started with the docs:<br />When the expansion of a single-line macro contains tokens which invoke another macro, the expansion is performed at invocation time, not at definition time. Thus the code <br />%define a(x)&nbsp; &nbsp; 1+b(x) <br />%define b(x)&nbsp; &nbsp; 2*x <br /><br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ax,a(8)<br />will evaluate in the expected way to mov ax,1+2*8, even though the macro b wasn&#039;t defined at the time of definition of a. <br />In a similar fashion:<br />To have a reference to an embedded single-line macro resolved at the time that the embedding macro is defined, as opposed to when the embedding macro is expanded, you need a different mechanism to the one offered by %define. The solution is to use %xdefine.<br />So far all pretty straight forward. As soon as I started to code, it became obvious that I lack some fundamental knowledge of the Nasm preprocessor. Example from the doc&#039;s:<br />%macro&nbsp; writefile 2+ <br /><br />&nbsp; &nbsp; &nbsp; &nbsp; jmp&nbsp; &nbsp;  %%endstr <br />&nbsp; %%str:&nbsp; &nbsp; &nbsp; &nbsp; db&nbsp; &nbsp; &nbsp; %2 <br />&nbsp; %%endstr: <br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  dx,%%str <br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  cx,%%endstr-%%str <br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  bx,%1 <br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ah,0x40 <br />&nbsp; &nbsp; &nbsp; &nbsp; int&nbsp; &nbsp;  0x21 <br /><br />%endmacro<br />With an unconditional jump at the beginning of the macro, %%str: db %2 should never execute??<br />I&nbsp; found it next to impossible to track intermediate results of the preprocessor stage. Also there seems to be no difference between the number of passes selected with -O option (1-x)<br /><br />The code example is a stripped down version of&nbsp; a proc and invoke macro pair (to reduce the length of&nbsp; the post). The intention was to create a proc (OutMessage) and define it as %define %{1} PROC_ %+ %{1} %+ _Local. In the invk macro I try to check for %ifdef PROC_%{1}_Local. If true make a local call and if it isn&#039;t, declare it as EXTERN %{1}.<br /><br /><pre><code>%define DefLocal(x)&nbsp; &nbsp; ProcDef (x) %+ _Local <br /><br />%imacro PROC 1-*<br />%warning inside Proc ,Name of proc: %{1}<br />		%push _PROC<br />	GLOBAL&nbsp; %1<br />	%1:<br />	%ifndef PROC_%{1}_Local<br />			;%xdefine %{1} PROC_ %+ %{1} %+ _Local&nbsp; ;seems to produce same results as DefLocal(%{1})<br />			DefLocal(%{1})<br />			%warning inside Proc&nbsp; ifndef loop %{1}<br />	%endif<br />%endmacro<br /><br />%macro ENDP 0-1<br />	.@End_of_Proc:<br />	ret<br />	%pop<br />%endmacro<br /><br /><br />%MACRO invk 1-*<br />%warning in invoke %1<br />%ifdef PROC_%{1}_Local<br />;%ifid&nbsp; %{1}		<br />		%warning In invk proc:&nbsp;  %{1} defined as label<br />		<br />%elifndef %1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;PROC_%{1}_Local<br />	%warning In invk proc:&nbsp;  %{1} is defiend Extern<br />	;EXTERN %{1}	<br />%endif<br />	call %1<br /><br />%endmacro<br /><br />%define ProcDef(x)&nbsp; &nbsp; PROC_ %+ x <br /><br />SECTION .data<br /><br />message&nbsp;  DB&nbsp;  &#039;Trying Nasm Preprocessr&#039;,13,10,\<br />				&#039;An atempt on forward referencing&#039;,0<br /><br />buffer&nbsp; &nbsp; TIMES 1024 db 0<br />caption db &#039;Testing&#039;,0<br />SECTION .text<br /><br /><br />Global&nbsp;  start<br />start:&nbsp;  <br />&nbsp; &nbsp; &nbsp; invk OutMessage<br />&nbsp; &nbsp; &nbsp; invk OutMessage<br />&nbsp; &nbsp; &nbsp; push 0<br />&nbsp; &nbsp; &nbsp; invk ExitProcess<br />&nbsp; <br /> PROC OutMessage<br />	&nbsp; push 0<br />&nbsp; &nbsp; &nbsp; push caption<br />&nbsp; &nbsp; &nbsp; push message<br />&nbsp; &nbsp; &nbsp; push 0<br />&nbsp; &nbsp; &nbsp; invk MessageBoxA<br />ENDP&nbsp; <br /><br />;Radasm IDE 3,O,$B\NASM -Ox -fwin32 ,2<br />;5,O,$B\GOLINK @$B\GFL.txt,3</code></pre><br /><br />As far as I can see the problem seems to be that invoke is expanded before proc. Therefore Outmessage will be (invk:7) In invk proc: OutMessage is defined Extern. For the same reason %elifid %1 does not seem to work. <br />I have also tried :%define %${1} PROC_ %+ %{1} %+ _Local<br />This seems to work for local calls but fails when an api call is made. <br />Is there a way to make this work (Nasm being a multipass assembler?) Second, what help tools are there available to make Nasm more verbose in its preprocessor out put?<br /><br />Thanks Klod</div>
    <div class="meta">Posted on 2009-11-08 17:15:24 by Klod</div>
   </div>
   <div class="post" id="post-209531">
    <div class="subject"><a href="#post-209531">Re: Nasm Preprocessor </a></div>
    <div class="body"><div class="quote"><br />I&nbsp; found it next to impossible to track intermediate results of the preprocessor stage. Also there seems to be no difference between the number of passes selected with -O option (1-x)<br />...<br />Is there a way to make this work (Nasm being a multipass assembler?) <br /></div><br /><br />NASM is a multi-pass assembler, but you can ultimately think of the preprocessor as a single stage. Optimization only affects code generation.<br /><br />A solution to your problem is to do what other languages do, declaration and definition. An advantage of said solution is the reduction of code ambiguity.<br /><br /><div class="quote"><br />Second, what help tools are there available to make Nasm more verbose in its preprocessor out put?<br /></div><br /><br />Have you tried NASM with the listfile (<strong>-l</strong>) option?</div>
    <div class="meta">Posted on 2009-11-09 01:48:27 by SpooK</div>
   </div>
   <div class="post" id="post-209593">
    <div class="subject"><a href="#post-209593">Re: Nasm Preprocessor </a></div>
    <div class="body">Thanks for your reply SpooK<br /><br />Yes and now. no on larger projects, I find it very difficult to sift through several thousand declared symbols. Yes for small tests like this one. <br />Nasm terminates if it encounters an error leaving very few clues.<br /><br />English is not my first language. There is always a chance for misinterpreting something. &nbsp;If I read a statement and its meaning comes out the same in my original language then I conclude that I understand the text. However this is <u>not</u> synonymous with full comprehension of the subject described. If I can transform the information conveyed into a working code snippet, then I conclude that I understand and comprehend.<br /><br />%define a(x) &nbsp; &nbsp;1+b(x)<br />%define b(x) &nbsp; &nbsp;2*x &nbsp;<br /><br />This suggests that some limited forward referencing is possible, also <br /><br />%define and %xdefine. expansion performed at invocation time vs. definition time suggests there is a mechanism to influence &quot;when&quot; a given macro is expanded. Hierarchy?<br /><br />looking forward to your reply<br />Klod<br /><br /></div>
    <div class="meta">Posted on 2009-11-12 22:15:25 by Klod</div>
   </div>
   <div class="post" id="post-209605">
    <div class="subject"><a href="#post-209605">Re: Nasm Preprocessor </a></div>
    <div class="body"><div class="quote"><br />Thanks for your reply SpooK<br /><br />Yes and now. no on larger projects, I find it very difficult to sift through several thousand declared symbols. Yes for small tests like this one. <br />Nasm terminates if it encounters an error leaving very few clues.<br /><br />English is not my first language. There is always a chance for misinterpreting something. &nbsp;If I read a statement and its meaning comes out the same in my original language then I conclude that I understand the text. However this is <u>not</u> synonymous with full comprehension of the subject described. If I can transform the information conveyed into a working code snippet, then I conclude that I understand and comprehend.<br /><br />%define a(x) &nbsp; &nbsp;1+b(x)<br />%define b(x) &nbsp; &nbsp;2*x &nbsp;<br /><br />This suggests that some limited forward referencing is possible, also <br /></div><br /><br />In that order, <strong>a(x)</strong> and <strong>b(x)</strong> are both defined before they are ever referenced/expanded.<br /><br /><div class="quote"><br />%define and %xdefine. expansion performed at invocation time vs. definition time suggests there is a mechanism to influence &quot;when&quot; a given macro is expanded. Hierarchy?<br /><br />looking forward to your reply<br />Klod<br /></div><br /><br />Akin to the above statement, a %define is only processed/expanded when it is referenced. %xdefine is processed/expanded immediately, instead of waiting for an initial reference.<br /><br />However, the %define and %xdefine directives are the means to influence the macro expansion, in this context. The source code portions that process these directives do the rest behind the scenes.</div>
    <div class="meta">Posted on 2009-11-13 10:54:04 by SpooK</div>
   </div>
  </div>
 </body>
</html>