<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Win NT Kernel Mode Driver Help - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=17327" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=12">The Heap</a> &raquo; <a href="../?id=17327">Win NT Kernel Mode Driver Help</a></p>
   <div class="post" id="post-134233">
    <div class="subject"><a href="#post-134233">Win NT Kernel Mode Driver Help</a></div>
    <div class="body">You guys are such good teachers, I wanted to do something a little more difficult.<br /><br />I would like to make this workable for Win 98. <br /><br /><br />;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br /> ;<br /> ;  beeper.asm - Kernel Mode Driver for Windows NT<br /> ;               Makes beep thorough computer speaker<br /> ;<br /> ;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br /><br /> .386<br /> .model flat, stdcall<br /> option casemap:none<br /><br /> ;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br /> ;                                  I N C L U D E   F I L E S                                        <br /> ;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br /><br /> include \masm32\include\w2k\ntstatus.inc<br /> include \masm32\include\w2k\ntddk.inc<br /><br /> include \masm32\include\w2k\hal.inc<br /><br /> includelib \masm32\lib\w2k\hal.lib<br /><br /> ;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br /> ;                                          E Q U A T E S                                 <br /> ;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br /><br /> TIMER_FREQUENCY        equ 1193167                   ; 1,193,167 ??<br /> OCTAVE                 equ 2                         ; octave multiplier<br /><br /> PITCH_C                equ 523                       ; c    -  523,25 ??<br /> PITCH_Cs               equ 554                       ; c#   -  554,37 ??<br /> PITCH_D                equ 587                       ; d    -  587,33 ??<br /> PITCH_Ds               equ 622                       ; d#   -  622,25 ??<br /> PITCH_E                equ 659                       ; e    -  659,25 ??<br /> PITCH_F                equ 698                       ; f    -  698,46 ??<br /> PITCH_Fs               equ 740                       ; f#   -  739,99 ??<br /> PITCH_G                equ 784                       ; g    -  783,99 ??<br /> PITCH_Gs               equ 831                       ; g#   -  830,61 ??<br /> PITCH_A                equ 880                       ; a    -  880,00 ??<br /> PITCH_As               equ 988                       ; a#   -  987,77 ??<br /> PITCH_H                equ 1047                      ; h    - 1046,50 ??<br /><br /><br /> ; We are going to play c-major chord<br /><br /> TONE_1                 equ TIMER_FREQUENCY/(PITCH_C*OCTAVE)<br /> TONE_2                 equ TIMER_FREQUENCY/(PITCH_E*OCTAVE)<br /> TONE_3                 equ (PITCH_G*OCTAVE)           ; for HalMakeBeep<br /><br /> DELAY                  equ 1800000h                   ; for my ~800mHz machine<br /><br /> ;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br /> ;                                            M A C R O S                                   <br /> ;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br /><br /> DO_DELAY MACRO<br />     mov eax, DELAY<br />     .while eax<br />         dec eax<br />     .endw<br /> ENDM<br /><br /> ;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br /> ;                                          C O D E                                                  <br /> ;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br /><br /> .code<br /><br /> ;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br /> ;                                            MakeBeep1                                              <br /> ;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br /><br /> MakeBeep1 proc dwPitch:DWORD<br /><br />     ; Direct hardware access<br /><br />     cli<br /><br />     mov al, 10110110y<br />     out 43h, al<br /><br />     mov eax, dwPitch<br />     out 42h, al<br /><br />     mov al, ah<br />     out 42h, al<br /><br />     ; Turn speaker ON<br /><br />     in al, 61h<br />     or  al, 11y<br />     out 61h, al<br /><br />     sti<br /><br />     DO_DELAY<br /><br />     cli<br /><br />     ; Turn speaker OFF<br /><br />     in al, 61h<br />     and al, 11111100y<br />     out 61h, al<br /><br />     sti<br /><br />     ret<br /><br /> MakeBeep1 endp<br /><br /> ;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br /> ;                                            MakeBeep2                                              <br /> ;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br /><br /> MakeBeep2 proc dwPitch:DWORD<br /><br />     ; Hardware access using WRITE_PORT_UCHAR ? READ_PORT_UCHAR<br />     ; functions from hal.dll<br /><br />     cli<br /><br />     invoke WRITE_PORT_UCHAR, 43h, 10110110y<br /><br />     mov eax, dwPitch<br />     invoke WRITE_PORT_UCHAR, 42h, al<br />     mov eax, dwPitch<br />     invoke WRITE_PORT_UCHAR, 42h, ah<br /><br />     ; Turn speaker ON<br /><br />     invoke READ_PORT_UCHAR, 61h<br />     or  al, 11y<br />     invoke WRITE_PORT_UCHAR, 61h, al<br /><br />     sti<br /><br />     DO_DELAY	<br /><br />     cli<br /><br />     ; Turn speaker OFF<br /><br />     invoke READ_PORT_UCHAR, 61h<br />     and al, 11111100y<br />     invoke WRITE_PORT_UCHAR, 61h, al<br /><br />     sti<br /><br />     ret<br /><br /> MakeBeep2 endp<br /><br /> ;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br /> ;                                       DriverEntry                                                 <br /> ;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br /><br /> DriverEntry proc pDriverObject:PDRIVER_OBJECT, pusRegistryPath:PUNICODE_STRING<br /><br />     invoke MakeBeep1, TONE_1<br />     invoke MakeBeep2, TONE_2<br /><br />     ; Hardware access using hal.dll HalMakeBeep function <br /><br />     invoke HalMakeBeep, TONE_3<br />     DO_DELAY<br />     invoke HalMakeBeep, 0<br /><br />     mov eax, STATUS_DEVICE_CONFIGURATION_ERROR<br />     ret<br /><br /> DriverEntry endp<br /><br /> ;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br /> ;                                                                                                   <br /> ;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br /><br /> end DriverEntry<br /><br /> :make<br /><br /> set drv=beeper<br /><br /> \masm32\bin\ml /nologo /c /coff %drv%.bat<br /> \masm32\bin\link /nologo /driver /base:0x10000 /align:32 /out:%drv%.sys /subsystem:native %drv%.obj<br /><br /> del %drv%.obj<br /><br /> echo.<br /> pause</div>
    <div class="meta">Posted on 2004-02-19 18:39:10 by skywalker</div>
   </div>
   <div class="post" id="post-134234">
    <div class="subject"><a href="#post-134234">Win NT Kernel Mode Driver Help</a></div>
    <div class="body">Well, you can lookup Yates' tutorials. What you are looking for is VXD coding... and Yates' has some really nice examples. I think beep is one of them.</div>
    <div class="meta">Posted on 2004-02-19 18:50:54 by Milos</div>
   </div>
   <div class="post" id="post-134240">
    <div class="subject"><a href="#post-134240">Win NT Kernel Mode Driver Help</a></div>
    <div class="body">you can beep the pc speaker on a nt based system using the Beep api call, but you might still want to write the KDM just for the experience.</div>
    <div class="meta">Posted on 2004-02-19 20:04:43 by ENF</div>
   </div>
   <div class="post" id="post-134242">
    <div class="subject"><a href="#post-134242">Win NT Kernel Mode Driver Help</a></div>
    <div class="body"><div class="quote"><br />Well, you can lookup Yates' tutorials. What you are looking for is VXD coding... and Yates' has some really nice examples. I think beep is one of them. </div><br /><br />Thanks,<br />Found the tuturials, it'l' be a while till I can use it.</div>
    <div class="meta">Posted on 2004-02-19 20:37:22 by skywalker</div>
   </div>
  </div>
 </body>
</html>