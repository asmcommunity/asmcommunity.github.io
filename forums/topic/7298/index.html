<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>PROFILE: Is there a way to get stable results? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=7298" />
    <link rel="next" href="../?id=7298&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=7298">PROFILE: Is there a way to get stable results?</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=7298&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=7298&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="7298" /><input type="number" name="page" min="1" max="3" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=7298&amp;page=2">&gt;</a><a href="../?id=7298&amp;page=3">&raquo;</a></form>   <div class="post" id="post-52855">
    <div class="subject"><a href="#post-52855">PROFILE: Is there a way to get stable results?</a></div>
    <div class="body">Hi all<br /><br />I was trying to create a tool for optmizing ascii to floating point, but running the same code located at different places does not produce same results. Does anyone have a solution? Here is my test project.<br /><br />KetilO</div>
    <div class="meta">Posted on 2002-08-12 05:10:20 by KetilO</div>
   </div>
   <div class="post" id="post-52878">
    <div class="subject"><a href="#post-52878">RTM?</a></div>
    <div class="body">Again, read what I wrote in the PROFILE source I released yesterday. All your questions are answered there. All docs are written with a certain purpose in mind.<br /><br />I don't use MASM but if you really want so (??!), write an ALIGN MACRO exploiting $-START (to know how many bytes to fill with NOP's or DB 0's) where you're sure that START is 4096 or 65536 bytes aligned (HISTANCE anyone?).<br /><br />You'll find WHY you need to do the above in the comments of the PROFILE source I released also yesterday. The comments are there with a reason, believe me, not just to waste bandwidth and development time.</div>
    <div class="meta">Posted on 2002-08-12 07:34:40 by Maverick</div>
   </div>
   <div class="post" id="post-52883">
    <div class="subject"><a href="#post-52883">PROFILE: Is there a way to get stable results?</a></div>
    <div class="body">Well, Nexo invented a way to copy the code to the same adress and executing it there. Thougt that should take care of it.<br /><br />KetilO</div>
    <div class="meta">Posted on 2002-08-12 07:49:28 by KetilO</div>
   </div>
   <div class="post" id="post-52903">
    <div class="subject"><a href="#post-52903">PROFILE: Is there a way to get stable results?</a></div>
    <div class="body">To work as expected, PROFILE's requirement must be followed 100.0%, because it's a tricky routine (for a tricky/difficult task).<br /><br />I don't know the details of Nexo's technique, so I cannot say anything about that, besides what I just wrote above.<br /><br />I just know that PROFILE never gave me any single problem, and I'm used to stress the hell out of my tools.<br /><br />But (expecially for such tricky routines/techniques) the docs have to be read and applied very carefully. I'm used to not document what's obvious.</div>
    <div class="meta">Posted on 2002-08-12 09:02:08 by Maverick</div>
   </div>
   <div class="post" id="post-52907">
    <div class="subject"><a href="#post-52907">PROFILE: Is there a way to get stable results?</a></div>
    <div class="body">Well, too bad that I cannot make it stable with masm. But I am not going to switch to another assembler because of it.<br /><br />KetilO</div>
    <div class="meta">Posted on 2002-08-12 09:17:28 by KetilO</div>
   </div>
   <div class="post" id="post-52922">
    <div class="subject"><a href="#post-52922">PROFILE: Is there a way to get stable results?</a></div>
    <div class="body"><div class="quote"> but running the same code located at different places does not produce same results</div> <br /><br />in your test project you posted above .<br />it produces the same on my computer<br /><br />bye<br /><br />eko</div>
    <div class="meta">Posted on 2002-08-12 09:58:25 by eko</div>
   </div>
   <div class="post" id="post-52971">
    <div class="subject"><a href="#post-52971">PROFILE: Is there a way to get stable results?</a></div>
    <div class="body"><div class="quote"><br />Well, too bad that I cannot make it stable with masm. But I am not going to switch to another assembler because of it.<br /><br />KetilO </div><br />I fully respect your choice, of course.<br /><br />Please, only don't put a bad name to PROFILE because of MASM's limitations. That would be unfair.</div>
    <div class="meta">Posted on 2002-08-12 13:20:39 by Maverick</div>
   </div>
   <div class="post" id="post-52985">
    <div class="subject"><a href="#post-52985">PROFILE: Is there a way to get stable results?</a></div>
    <div class="body">Hi Maverick<br /><br />On my home computer (P III Win98 SE) it works as it should. On my computer at work (processor unknown Win XP) it gives unstable results. I don't think masm is the reason.<br /><br />KetilO</div>
    <div class="meta">Posted on 2002-08-12 14:53:34 by KetilO</div>
   </div>
   <div class="post" id="post-52986">
    <div class="subject"><a href="#post-52986">Re: PROFILE: Is there a way to get stable results?</a></div>
    <div class="body"><div class="quote"><br />I was trying to create a tool for optmizing ascii to floating point, but running the same code located at different places does not produce same results. Does anyone have a solution? Here is my test project.<br /></div><br />If perform test, then different code replace in same location. It is allow create <em>equal conditions</em> for execution. Then you modifing one of test code, other test code shift in address space. Optimize one test code and clocks change for other. It is wrong. It is a good apparently on testa2dw. In one case my algo been very slow and other very fast. The results of this test may look as fake :) Different was only in code location. The PROFILE no resolve this problem.<br />Therefore sometimes I replace some code in special location for best perfomance. It is adjust of location in specified place for cache lines and branchs. The result of this trick we can observe. Also very important value of pointers in arguments of proc.<br />The test code is one thing. The woker code is other thing. Nonsense :grin:<br />It is very intresing area of code optimization.</div>
    <div class="meta">Posted on 2002-08-12 14:56:01 by Nexo</div>
   </div>
   <div class="post" id="post-53066">
    <div class="subject"><a href="#post-53066">How many times is enough???</a></div>
    <div class="body"><div class="quote"><br />Hi Maverick<br /><br />On my home computer (P III Win98 SE) it works as it should. On my computer at work (processor unknown Win XP) it gives unstable results. I don't think masm is the reason.<br /><br />KetilO </div><br /><br />Again <strong>KetilO</strong>,<br /><br />Perhaps <strong>if you first followed all the rules and requirements</strong> you could <strong>then</strong> say it for real, also for that specific CPU.<br /><br />The &quot;fscking manual&quot; that you refuse to read states that all routines to be tested, <strong>including</strong> the empty RET, must be at offset 0 of a 64 bytes alignment. If you don't think there's any reason for it and don't know how tricky cacheline issues are, <strong>just fscking apply the requested rule anyway</strong>. Thank you, perhaps now it's finally clear.<br /><br />Please stop (ab)using my tools if you can't even read the docs after 5 times I kindly asked you to do so.<br /><br />I'll stop this nonsense now though, I'm annoyed, and I don't have time to waste repeating once more what's clearly written in the docs. Computer Science is an <strong>exact</strong> science, it's not a &quot;<em>what's that ALIGN word? whatever.. who cares???</em>&quot;. Hope you finally get it, or stop using PROFILE, even better.<br /><br />From now on I state that PROFILE works only in FASM and NASM. Do not use with any other assembler, or if you modify any single byte or do not provide <strong>all (none excluded)</strong> the required alignments. I don't think I'm being more clear than before, but anyway..<br /><br />Then, if you followed <strong>ALL</strong> (why do I have to make it bold???) the required rules and it still doesn't perform as it should, report and I will see what's wrong. But I cannot fix what doesn't neither follow the specified, required rules (even if you don't understand how tricky and important they are).. because I know what's already broken.. a wrong implementation. No need to bother more, then.<br /><br />Clear?</div>
    <div class="meta">Posted on 2002-08-13 02:17:28 by Maverick</div>
   </div>
   <div class="post" id="post-53110">
    <div class="subject"><a href="#post-53110">PROFILE: Is there a way to get stable results?</a></div>
    <div class="body">Guys, peace pease :tongue:<br /><br />After PROFILE release, and the MASM following port it was clearly stated that MASM had problems with align... some fixes has been found I think, but doesn't seem to be enough to make PROFILE work as it should and as it was designed with MASM...<br />I used the tool a bit with MASM and always had stable results (maybe one time or two a bit more or less than the others values but...). I didn't had the opportunity to test it since I use FASM but as it was designed for NASM/FASM it should work better...<br /><br />Now, I'm wondering if it would be possible to assemble PROFILE code in a obj and link it with MASM or VC code, for example...<br />Ketil has a bunch of MASM code and for him the full switch to another assembler is not possible...<br />FASM is light enough to be always on the disk. If you need to test a procedure, a copy paste of the code and assembly using FASM with the profile code seems an handy solution, even if the final code will be assembled with MASM...<br /><br />Would you bother to assemble the piece of code you want to test in FASM and test at your PC from work to see if the results are still unstable ? Then we would able to see if MASM is really not the problem (which I don't think).<br />As Maverick said, computer science is an exact science, and for this reason, I think the only thing he will accept and believe as facts is output given by the tool assembled with the propers assemblers...</div>
    <div class="meta">Posted on 2002-08-13 07:11:28 by JCP</div>
   </div>
   <div class="post" id="post-53112">
    <div class="subject"><a href="#post-53112">Re: How many times is enough???</a></div>
    <div class="body"><div class="quote"><br /><br /><br />&quot;fscking manual&quot; </div><br /><br /><br />You use too much Linux :)</div>
    <div class="meta">Posted on 2002-08-13 07:21:17 by bazik</div>
   </div>
   <div class="post" id="post-53141">
    <div class="subject"><a href="#post-53141">PROFILE: Is there a way to get stable results?</a></div>
    <div class="body">Hi <strong>Readiosys</strong>, you wrote: <em>Now, I'm wondering if it would be possible to assemble PROFILE code in a obj and link it with MASM or VC code, for example...</em><br /><br />Not if the linker doesn't provide the required alignment.<br /><br />As an alternative, VirtualAlloc one page and copy the PROFILEr code there (respecting the 64 bytes alignment of .empty, and ALL the rest, exactly as provided), and just to be sure VirtualAlloc another page and place the data (PROFILEr's variables) there. Then VirtualAlloc a page for each routine to test. VirtualAlloc ensures 4 KB alignment, which fullfills at least the alignment requirements.<br /><br />MASM though sometimes doesn't even assemble 1:1 the opcodes.. why bother with Bill's tools? The very little free time I have for the board, I'd rather spend it to support FASM than MASM.<br /><br /><em>Ketil has a bunch of MASM code and for him the full switch to another assembler is not possible...</em><br /><br />I never blamed him, he's free to do what he wants.. as long as he doesn't ignore what I repeated 5+ times, documented, etc.. not without a reason.<br /><br />I gave you all my PROFILEr because I noticed it was a commonly requested tool. I could have made various specific-CPU versions, or only provided the one that works with my own CPU, but I thought it was a better support to design an as much as possible CPU-independent routine, so that it could work on everybody's development system, and not give you any problem.<br />If PROFILE is broken for somebody or for some particular CPU I'm glad to fix it and give all of my support. <em>I just ask that little respect that is to really read the docs and applying them</em> before complaining. Otherwise it's only a waste of time for me and for you all, precious time that could be dedicated to something else. Hope I'm not asking too much.. I want to help but one has to read and apply the docs before. Writing docs is not a hobby for me, exactly like it is not a hobby for any of you.<br /><br /><em>Would you bother to assemble the piece of code you want to test in FASM and test at your PC from work to see if the results are still unstable ?</em><br /><br />He has to provide an ALIGN MACRO. If he doesn't have a working one, PROFILE won't run ideally.<br /><br />Here's my FASM ALIGN MACRO:<br /><br /><pre><code><br />; Offset must be &gt; -Alignment and &lt; Alignment. You can omit the Offset parameter &#40;i.e. = 0&#41;.<br />MACRO                           ALIGN           Alignment,Offset &#123;<br />   IF &lt;Offset&gt; EQ &lt;&gt;<br />   REPEAT &#40;Alignment-1&#41;-&#40;&#40;$+Alignment-1&#41; mod Alignment&#41;<br />                                NOP            ; DB 0 if you prefer<br />   END REPEAT<br />   ELSE<br />   REPEAT &#40;Alignment-1&#41;-&#40;&#40;$+Alignment-Offset-1&#41; mod Alignment&#41;<br />                                NOP            ; DB 0 if you prefer<br />   END REPEAT<br />   END IF<br />&#125;<br /></code></pre><br /><br /><span style="font-size:24px><strong>NOTE THAT IT WORKS ONLY IF YOUR ENTRYPOINT IS ALREADY ALIGNED, AND THE MAXIMUM ALIGNMENT THIS MACRO CAN PROVIDE IS THE ENTRYPOINT ALIGNMENT ITSELF</strong></span> :tongue:<br /><br />Once applied <strong>ALL OF THE REQUIREMENTS</strong>, please report me eventual malfunctions, specifing the CPU brand/model possibly with a bit more precision than &quot;unknown CPU running under WinXP. It's not MASM's fault if your PROFILE doesn't work, even if I use ALIGN 4 only, instead of the 64 you require&quot;. This is not ok for obvious reasons that there's no need to stress more.<br /><br />I'll then examine what may be the problem, and offer my support.. to KetilO or anybody else so kind to give me a minimum help to help him.<br /><br />Thank You.</div>
    <div class="meta">Posted on 2002-08-13 10:09:39 by Maverick</div>
   </div>
   <div class="post" id="post-53145">
    <div class="subject"><a href="#post-53145">PROFILE: Is there a way to get stable results?</a></div>
    <div class="body"><div class="quote"><em>Originally posted by Maverick </em><br />As an alternative, VirtualAlloc one page and copy the PROFILEr code there (respecting the 64 bytes alignment of .empty, and ALL the rest, exactly as provided), and just to be sure VirtualAlloc another page and place the data (PROFILEr's variables) there. Then VirtualAlloc a page for each routine to test. VirtualAlloc ensures 4 KB alignment, which fullfills at least the alignment requirements.<br /></div><br />May be easy every test routine (and PROFILE?) replace in own segment? Every segment start with 4Kb aligment.</div>
    <div class="meta">Posted on 2002-08-13 10:22:40 by Nexo</div>
   </div>
   <div class="post" id="post-53151">
    <div class="subject"><a href="#post-53151">PROFILE: Is there a way to get stable results?</a></div>
    <div class="body"><div class="quote"><em>Originally posted by Maverick </em><br /><span style="font-size:24px><strong>NOTE THAT IT WORKS ONLY IF YOUR ENTRYPOINT IS ALREADY ALIGNED, AND THE MAXIMUM ALIGNMENT THIS MACRO CAN PROVIDE IS THE ENTRYPOINT ALIGNMENT ITSELF</strong></span> :tongue:<br /></div><br /><br />OMG, Maverick got the Steve-Gibson-Virus!</div>
    <div class="meta">Posted on 2002-08-13 10:36:32 by bazik</div>
   </div>
   <div class="post" id="post-53191">
    <div class="subject"><a href="#post-53191">PROFILE: Is there a way to get stable results?</a></div>
    <div class="body"><strong>bazik</strong> :grin:<br /><br /><strong>Nexo</strong>: I thought about it.. and I decided that I'll spend the next free time slice I get to make a version of PROFILE that should make everybody happy. Should be here in a couple of days max.</div>
    <div class="meta">Posted on 2002-08-13 14:51:21 by Maverick</div>
   </div>
   <div class="post" id="post-53235">
    <div class="subject"><a href="#post-53235">PROFILE: Is there a way to get stable results?</a></div>
    <div class="body">To use larger numbers in the MASM ALIGN directive, SEGMENT directives must be used - use of short-cut segment directives (.code/.data/.data?) cannot be used.  The support is in MASM, but very few people use it and it doesn't appear to be the <em>standard</em> method around here.  I don't use .MODEL either.<br /><br />Begin programming with this:<pre><code>	.586<br />	.MMX<br />	.K3D<br />	.XMM<br /><br />	OPTION	CASEMAP&#58;NONE		; case sensitivity<br />	OPTION	LANGUAGE&#58;STDCALL	; needed for all the API PROTOs<br />	OPTION	DOTNAME			; allow names to start with '.'<br /><br /><br />; Set Default Segment order and options&#58;<br /><br />	_TEXT SEGMENT READONLY PAGE PUBLIC USE32 'CODE'<br />	_TEXT ENDS<br /><br />	CONST SEGMENT READONLY PUBLIC USE32 'CONST'<br />	CONST ENDS<br /><br />	_DATA SEGMENT PAGE PUBLIC USE32 'DATA'<br />	_DATA ENDS<br /><br />	_BSS SEGMENT PAGE PUBLIC USE32 'BSS'<br />	_BSS ENDS<br /><br />	ASSUME CS&#58;FLAT, DS&#58;FLAT, SS&#58;FLAT, ES&#58;FLAT</code></pre>...then your can do:<pre><code>_TEXT SEGMENT<br />	ALIGN 128<br />_TEXT ENDS</code></pre>:grin:<br /><br />Do not use: .DATA .CODE .DATA? .CONST</div>
    <div class="meta">Posted on 2002-08-13 23:58:03 by bitRAKE</div>
   </div>
   <div class="post" id="post-53244">
    <div class="subject"><a href="#post-53244">PROFILE: Is there a way to get stable results?</a></div>
    <div class="body">BitRAKE, could you explain USE32 real quick?<br /><br />I've tried using it, but only get errors. Flat work fine however.<br /><br />Thanks.</div>
    <div class="meta">Posted on 2002-08-14 02:06:30 by ThoughtCriminal</div>
   </div>
   <div class="post" id="post-53268">
    <div class="subject"><a href="#post-53268">PROFILE: Is there a way to get stable results?</a></div>
    <div class="body">Hi bitRAKE<br /><br />Finally some mature response.<br />I tried what you suggested but it made no difference (P IV).<br />It shows ~1400 / ~200. No way I am going to believe that some simple adjustmens of the code can produce such results. On P III it also shows different. Maybe I am doing something wrong, so please anyone, have a look at the code.<br /><br />To all:<br />I started this thread hoping for a mature discussion leading to a result, but as often happends on this board someone has to show off and use 'war types' to heat up the discusssion and thereby destroying the possibility of a result. It's a pity. I am here to learn and share my ideas.<br /><br />KetilO</div>
    <div class="meta">Posted on 2002-08-14 04:09:04 by KetilO</div>
   </div>
   <div class="post" id="post-53272">
    <div class="subject"><a href="#post-53272">PROFILE: Is there a way to get stable results?</a></div>
    <div class="body"><div class="quote"><br />BitRAKE, could you explain USE32 real quick?<br /><br />I've tried using it, but only get errors. Flat work fine however.<br /><br />Thanks. </div>USE32 has to do with the code generation by the assembler.  Instructions can be assembled in two ways for the x86 due to legacy support for 16-bit code.  As far as we are concerned, in Windows we use 32-bit code.  USE32 tells the assembler that 32-bit registers are the default given mode of the processor.  Please post your code that did not work.<br /><br /><br /><strong>KetilO</strong>, I do not get the results that you see.  Does the example posted produce the problem?  I do know that the P4 can be a little tricky (by design), but results should be consistent on the P3.  What are the results you are getting?</div>
    <div class="meta">Posted on 2002-08-14 05:44:52 by bitRAKE</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=7298&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=7298&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="7298" /><input type="number" name="page" min="1" max="3" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=7298&amp;page=2">&gt;</a><a href="../?id=7298&amp;page=3">&raquo;</a></form>  </div>
 </body>
</html>