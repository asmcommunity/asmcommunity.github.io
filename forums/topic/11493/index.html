<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>SendMessage COPY_DATA Question - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=11493" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=11493">SendMessage COPY_DATA Question</a></p>
   <div class="post" id="post-86958">
    <div class="subject"><a href="#post-86958">SendMessage COPY_DATA Question</a></div>
    <div class="body">I have one application with a Dialogbox as main and with 3 editcontrols.<br /><br />I have a second application which reads data from the serial port. This app also have data occasionally painted in a childwindow depending on the mousepointer position.<br /><br />Both apps loads the same dll in order to retrieve data from the second app and send it to the first app. This is the dll in principle.<br /><pre><code>DllEntry proc hInst&#58;HINSTANCE, reason&#58;DWORD, reserved1&#58;DWORD<br /><br />DllEntry ENDP<br /><br />Capture proc <br />	.<br />	.<br />	call ReadFile ;Call kernel32.dll function<br />	invoke GetFileType,hFile<br />	.if eax==FILE_TYPE_CHAR		;serial port<br />		invoke SendMessage,hWin,WM_COPYDATA,0,lpBuffer<br />	.endif<br />	.<br />	.<br />	ret<br />Capture endp<br /><br />Capture2 proc <br />	.<br />	.<br />	call DrawTextA ;Call user32.dll function<br />	.<br />	invoke SendMessage,hWin,WM_COPYDATA,0,lpBuffer2<br />	.<br />	.<br />	ret<br />Capture2 endp<br /><br />End DllEntry</code></pre><br />The Capture proc retrieves the serial data and SendMessage COPY_DATA to the DlgProc, more exactly to the editcontrol hEdt3. <br /><br />The Capture2 proc retrieves two data strings which should be destinated to editcontrols hEdt1 and hEdt2.<br /><pre><code>DlgProc proc hWin&#58;HWND,uMsg&#58;UINT,wParam&#58;WPARAM,lParam&#58;LPARAM<br />	.<br />	.elseif eax==WM_COPYDATA<br />		.<br />		invoke SendMessage,hEdt1,WM_SETTEXT,FALSE,lParam<br />		invoke SendMessage,hEdt2,WM_SETTEXT,FALSE,lParam<br />		invoke SendMessage,hEdt3,EM_REPLACESEL,FALSE,lParam<br />	.endif<br />    mov  eax,TRUE <br />    ret <br />DlgProc endp</code></pre><br />How do I do to link the 3 data strings to their predestinated editcontrols? Is it possible to use the wParam to separate the data strings? Or should I subclass the editcontrols? Any bright suggestions?<br /><br />Regards</div>
    <div class="meta">Posted on 2003-03-13 15:33:23 by minor28</div>
   </div>
   <div class="post" id="post-87011">
    <div class="subject"><a href="#post-87011">SendMessage COPY_DATA Question</a></div>
    <div class="body">You don't seem to use the wParam for anything else. You can certainly use it to specify which edit control the string should go to.<br /><br />Raymond</div>
    <div class="meta">Posted on 2003-03-14 00:23:38 by Raymond</div>
   </div>
   <div class="post" id="post-87237">
    <div class="subject"><a href="#post-87237">SendMessage COPY_DATA Question</a></div>
    <div class="body">Still not working as I want.<br /><br />This is what I have done.<br /><pre><code>Capture2 proc &#91;color=green&#93;;dll function&#91;/color&#93;<br />	.<br />	mov ecx,&#91;esp+&#40;3*4&#41;&#93; &#91;color=green&#93;;address of structure with formatting dimensions&#91;/color&#93;<br />	.if ecx==12f9e0h<br />		invoke RtlZeroMemory,addr lpBuffer2,100h<br />		mov ecx,&#91;esp+&#40;2*4&#41;&#93;	&#91;color=green&#93;;string length, in characters&#91;/color&#93;<br />		mov esi,&#91;esp+&#40;1*4&#41;&#93;	&#91;color=green&#93;;address of string to draw&#91;/color&#93;<br />		lea edi,lpBuffer2<br />		rep movsb<br />		mov ecx,&#91;esp+&#40;2*4&#41;&#93; &#91;color=green&#93;;string length, in characters&#91;/color&#93;<br />		.if ecx==4<br />			invoke SendMessage,hWin,WM_COPYDATA,1020,addr lpBuffer2<br />		.elseif ecx==7<br />			invoke SendMessage,hWin,WM_COPYDATA,1021,addr lpBuffer2<br />		.elseif ecx==11<br />			invoke SendMessage,hWin,WM_COPYDATA,1009,addr lpBuffer2<br />		.elseif ecx==12<br />			invoke SendMessage,hWin,WM_COPYDATA,1010,addr lpBuffer2<br />		.endif<br />	.endif<br />	call DrawTextA &#91;color=green&#93;;Call user32.dll function&#91;/color&#93;<br />	.<br />Capture2 endp<br /><br />DlgProc proc hWin&#58;HWND,uMsg&#58;UINT,wParam&#58;WPARAM,lParam&#58;LPARAM	<br />	.<br />	.elseif eax==WM_COPYDATA<br />	.if wParam==IDC_EDT6 &#91;color=green&#93;;=1020&#91;/color&#93;<br />		invoke SendMessage,hEdt6,WM_SETTEXT,FALSE,lParam<br />	.elseif wParam==IDC_EDT7 &#91;color=green&#93;;=1021&#91;/color&#93;<br />		invoke SendMessage,hEdt7,WM_SETTEXT,FALSE,lParam<br />	.elseif wParam==IDC_EDT3 &#91;color=green&#93;;=1009&#91;/color&#93;<br />		invoke SendMessage,hEdt4,WM_SETTEXT,FALSE,lParam<br />	.elseif wParam==IDC_EDT4 &#91;color=green&#93;;=1010&#91;/color&#93;<br />		invoke SendMessage,hEdt3,WM_SETTEXT,FALSE,lParam<br />	.<br />DlgProc endp</code></pre><br />I don't understand why the two latter SendMessages in the Capture2 proc not are sent to the DlgProc. First DrawText is the 12 characters string, the second is the 11 char, the third is the 4 char and last the 7 char.<br /><br />When debugging I can follow the whole procedure. For each of the four messages I can see that hWin, VM_COPYDATA, constant and string at addr lpBuffer2 are correct.<br /><br />But in the DlgProc the two first messages, i.e. messages to IDC_EDT3 and IDC_EDT4 are not recieved at all. Only the two later messages are received and shown correctly.<br /><br />Any idea what could be wrong.<br /><br />Regards</div>
    <div class="meta">Posted on 2003-03-15 14:27:06 by minor28</div>
   </div>
   <div class="post" id="post-87308">
    <div class="subject"><a href="#post-87308">SendMessage COPY_DATA Question</a></div>
    <div class="body">I notice in your DlgProc that when wParam==IDC_EDT3, you send the message to hEdt4.<br /><br />And when wParam==IDC_EDT4, you send the message to hEdt3.  Is that by design? (Your two other IDC_ constants have the suffix related to the Edit handle.)<br /><br />Have you checked the validity of your equates?<br /><br />And lastly, why don't you use the the same reference for the wParam (either numbers or equates) in both the dll and the DlgProc??<br /><br />Raymond</div>
    <div class="meta">Posted on 2003-03-15 22:51:35 by Raymond</div>
   </div>
   <div class="post" id="post-87388">
    <div class="subject"><a href="#post-87388">SendMessage COPY_DATA Question</a></div>
    <div class="body">Raymond, thank you for your helpfulness.<br /><br /><div class="quote">I notice in your DlgProc that when wParam==IDC_EDT3, you send the message to hEdt4.<br /><br />And when wParam==IDC_EDT4, you send the message to hEdt3. Is that by design? (Your two other IDC_ constants have the suffix related to the Edit handle.)</div><br />You are right, they should be switched. However this should only cause the text to land up in wrong editcontrol.<br /><br /><div class="quote">Have you checked the validity of your equates?<br /><br />And lastly, why don't you use the the same reference for the wParam (either numbers or equates) in both the dll and the DlgProc??</div><br />Yes they are valid in the Dlgproc. The reason why I don't use equates in the dll function is just because I haven't declared them. As I understand, this could not be the reson to failure. Two of the four are correct.<br /><br />The first two strings (for example &quot;145?&quot; and &quot;0.245nm&quot;) are correctly sent and recieved. These are the two blue lines. The two latter strings (for example 46?25.245 N&quot; and &quot;018?33.245 E&quot;) are sent but not recieved. If I insert a breakpoint on the red line, only the two first arrives to the breakpoint but never the two latter.<br /><pre><code>.elseif eax==WM_COPYDATA<br />	&#91;color=red&#93;.if wParam==IDC_EDT6&#91;/color&#93;<br />		&#91;color=blue&#93;invoke SendMessage,hEdt6,WM_SETTEXT,FALSE,lParam&#91;/color&#93;<br />	.elseif wParam==IDC_EDT7<br />		&#91;color=blue&#93;invoke SendMessage,hEdt7,WM_SETTEXT,FALSE,lParam&#91;/color&#93;<br />	.elseif wParam==IDC_EDT3<br />		invoke SendMessage,hEdt4,WM_SETTEXT,FALSE,lParam<br />	.elseif wParam==IDC_EDT4<br />		invoke SendMessage,hEdt3,WM_SETTEXT,FALSE,lParam</code></pre><br />I have followed each step in the dll function and I have establish the fact that every argument of the four SendMessages are correct. So I can't understand why just these two strings not reaches the DlgProc.<br /><br />Regards</div>
    <div class="meta">Posted on 2003-03-16 11:11:32 by minor28</div>
   </div>
   <div class="post" id="post-87389">
    <div class="subject"><a href="#post-87389">SendMessage COPY_DATA Question</a></div>
    <div class="body">Is lpbuffer2 a global var?</div>
    <div class="meta">Posted on 2003-03-16 11:22:30 by roticv</div>
   </div>
   <div class="post" id="post-87398">
    <div class="subject"><a href="#post-87398">SendMessage COPY_DATA Question</a></div>
    <div class="body"><div class="quote">Is lpbuffer2 a global var?</div><br /><br /><pre><code>.data?<br />lpBuffer2		dd 100h dup &#40;?&#41;</code></pre></div>
    <div class="meta">Posted on 2003-03-16 11:50:38 by minor28</div>
   </div>
   <div class="post" id="post-87449">
    <div class="subject"><a href="#post-87449">SendMessage COPY_DATA Question</a></div>
    <div class="body">I came to think of that only strings less than 8 characters were sent. WM_COPYDATA structure declare lParam as a pointer to a COPYDATASTRUCT. in light of this fact I Changed the code (red lines).<br /><pre><code>Capture2 proc &#91;color=green&#93;;dll function&#91;/color&#93;<br />	.<br />	mov ecx,&#91;esp+&#40;3*4&#41;&#93; &#91;color=green&#93;;address of structure with formatting dimensions&#91;/color&#93;<br />	.if ecx==12f9e0h<br />		&#91;color=red&#93;mov eax,&#91;esp+&#40;1*4&#41;&#93;&#91;/color&#93; &#91;color=green&#93;;address of string to draw&#91;/color&#93;<br />		&#91;color=red&#93;mov eax,&#91;eax&#93;&#91;/color&#93;<br />		&#91;color=red&#93;mov cds.dwData,eax&#91;/color&#93; &#91;color=green&#93;;cds = COPYDATASTRUCT&#91;/COLOR&#93;<br />		mov ecx,&#91;esp+&#40;2*4&#41;&#93; &#91;color=green&#93;;string length, in characters&#91;/color&#93;<br />		.if ecx==4<br />			invoke SendMessage,hWin,WM_COPYDATA,1020,addr cds<br />		.elseif ecx==7<br />			invoke SendMessage,hWin,WM_COPYDATA,1021,addr cds<br />		.elseif ecx==11<br />			invoke SendMessage,hWin,WM_COPYDATA,1009,addr cds<br />		.elseif ecx==12<br />			invoke SendMessage,hWin,WM_COPYDATA,1010,addr cds<br />		.endif<br />	.endif<br />	call DrawTextA &#91;color=green&#93;;Call user32.dll function&#91;/color&#93;<br />	.<br />Capture2 endp<br /><br />DlgProc proc hWin&#58;HWND,uMsg&#58;UINT,wParam&#58;WPARAM,lParam&#58;LPARAM	<br />	.<br />	.elseif eax==WM_COPYDATA<br />	&#91;color=red&#93;mov eax,lParam<br />	assume eax&#58;ptr COPYDATASTRUCT&#91;/color&#93;<br />	.if wParam==IDC_EDT6 &#91;color=green&#93;;=1020&#91;/color&#93;<br />		invoke SendMessage,hEdt6,WM_SETTEXT,FALSE,&#91;color=red&#93;addr &#91;eax&#93;.dwData&#91;/color&#93;<br />	.elseif wParam==IDC_EDT7 &#91;color=green&#93;;=1021&#91;/color&#93;<br />		invoke SendMessage,hEdt7,WM_SETTEXT,FALSE,&#91;color=red&#93;addr &#91;eax&#93;.dwData&#91;/color&#93;<br />	.elseif wParam==IDC_EDT3 &#91;color=green&#93;;=1009&#91;/color&#93;<br />		invoke SendMessage,hEdt4,WM_SETTEXT,FALSE,&#91;color=red&#93;addr &#91;eax&#93;.dwData&#91;/color&#93;<br />	.elseif wParam==IDC_EDT4 &#91;color=green&#93;;=1010&#91;/color&#93;<br />		invoke SendMessage,hEdt3,WM_SETTEXT,FALSE,&#91;color=red&#93;addr &#91;eax&#93;.dwData&#91;/color&#93;<br />	.<br />DlgProc endp</code></pre><br />As the code now are, the four editboxes show &quot;145?&quot;, &quot;0.24&quot;, &quot;46?2&quot; respective &quot;&quot;018?&quot; i.e. only 4 characters. I have tried both lpData and dwData with different points of application, but the code above is the nearast I came. Perhaps line &quot;mov eax, is the reason but I don't know how to solve it. Any suggestens?<br /><br />Regards</div>
    <div class="meta">Posted on 2003-03-16 15:38:25 by minor28</div>
   </div>
   <div class="post" id="post-87498">
    <div class="subject"><a href="#post-87498">SendMessage COPY_DATA Question</a></div>
    <div class="body"><div class="quote">		mov eax, ;address of string to draw<br />		mov eax,<br />		mov cds.dwData,eax ;cds = COPYDATASTRUCT<br /></div><br />What you are doing with the mov eax, instruction is moving the first 4 characters of the string into eax. You are then storing those 4 characters in the variable &quot;dwData&quot; in the cds structure.<br /><br />You are then using the address of the dwData variable to set the text in your edit boxes. The byte following that dwData variable in the structure (or in the memory following that structure if dwData is the last item) is most probably a zero since you are displaying only the 4 characters.<br /><br />Try this:<br />1) remove the mov eax, instruction so that you will store the string address in the dwData variable.<br />2) remove the &quot;addr&quot; from the addr  .dwData when you send the WM_SETTEXT message to send whatever you stored as the actual buffer address.<br /><br />Raymond</div>
    <div class="meta">Posted on 2003-03-16 22:54:29 by Raymond</div>
   </div>
   <div class="post" id="post-87515">
    <div class="subject"><a href="#post-87515">SendMessage COPY_DATA Question</a></div>
    <div class="body">My mistake. I thought it was a local var as invoke RtlZeroMemory,addr lpBuffer2,100h was used. I would normally use invoke RtlZeroMemory,OFFSET lpBuffer2,100h. Furthermore working on your previous code, I think that line is not needed. You could do<br /><br /><pre><code><br />.<br />	.if ecx==12f9e0h<br />;		invoke RtlZeroMemory,addr lpBuffer2,100h<br />		mov ecx,&#91;esp+&#40;2*4&#41;&#93;	;string length, in characters<br />		mov esi,&#91;esp+&#40;1*4&#41;&#93;	;address of string to draw<br />		lea edi,lpBuffer2<br />		rep movsb<br />		mov ecx,&#91;esp+&#40;2*4&#41;&#93; ;string length, in characters<br />mov BYTE PTR&#91;ecx+edi+1&#93;, '0' ; terminate the string<br />.<br />.<br />.<br /></code></pre></div>
    <div class="meta">Posted on 2003-03-17 01:46:32 by roticv</div>
   </div>
   <div class="post" id="post-87518">
    <div class="subject"><a href="#post-87518">SendMessage COPY_DATA Question</a></div>
    <div class="body">What you suggest isn't it only another way to set the memory to zero with the difference that the whole space not is set to zero but only one byte after the string.<br /><br />BTW shouldn't it be <br />mov BYTE PTR, 0h<br /><br />Regards</div>
    <div class="meta">Posted on 2003-03-17 02:17:46 by minor28</div>
   </div>
   <div class="post" id="post-87535">
    <div class="subject"><a href="#post-87535">SendMessage COPY_DATA Question</a></div>
    <div class="body">yesyes... just that i should not be using the '</div>
    <div class="meta">Posted on 2003-03-17 04:57:45 by roticv</div>
   </div>
   <div class="post" id="post-87605">
    <div class="subject"><a href="#post-87605">SendMessage COPY_DATA Question</a></div>
    <div class="body">Hi Raymond,<br /><br />I tried what you suggested, but it didn't work. The next thing to do was to closly scrutinize the COPYDATASTRUCT.<br /><br /><br />As you can see dwData passes up to 32 bits to the receiving app, i.e. 4 characters. What to do is to specify the sise in bytes in cbData and to store the address to the lpBuffer2 in lpData. Now it works. The code is as follows.<br /><pre><code>typedef struct tagCOPYDATASTRUCT &#123;  // cds <br />    DWORD dwData; <br />    DWORD cbData; <br />    PVOID lpData; <br />&#125; COPYDATASTRUCT; <br /><br />&#91;b&#93;dwData&#91;/b&#93;=Specifies up to 32 bits of data to be passed to the receiving application. <br />&#91;b&#93;cbData&#91;/b&#93;=Specifies the size, in bytes, of the data pointed to by the lpData member. <br />&#91;b&#93;lpData&#91;/b&#93;=Points to data to be passed to the receiving application. This member can be NULL</code></pre><br /><pre><code>Capture2 proc &#91;color=green&#93;;dll function&#91;/color&#93;<br />.<br />mov ecx,&#91;esp+&#40;3*4&#41;&#93; &#91;color=green&#93;;address of structure with formatting dimensions&#91;/color&#93;	<br />.if ecx==12f9e0h<br />	invoke RtlZeroMemory,addr lpBuffer2,100h<br />	mov ecx,&#91;esp+&#40;2*4&#41;&#93; &#91;color=green&#93;;string length, in characters&#91;/color&#93;<br />	add ecx,1 &#91;color=green&#93;;add 1 byte to get the zero termination&#91;/color&#93;<br />	mov cds.cbData,ecx<br />	mov esi,&#91;esp+&#40;1*4&#41;&#93; &#91;color=green&#93;;address of string to draw&#91;/color&#93;<br />	lea edi,lpBuffer2 &#91;color=green&#93;;address of buffer&#91;/color&#93;<br />	mov cds.lpData,edi<br />	rep movsb<br />	mov ecx,&#91;esp+&#40;2*4&#41;&#93; &#91;color=green&#93;;string length, in characters&#91;/color&#93;<br />	.if ecx==4<br />		&#91;color=green&#93;;Course&#91;/color&#93;<br />		invoke SendMessage,hWin,WM_COPYDATA,1020,addr cds<br />	.elseif ecx&gt;4 &amp;&amp; ecx&lt;=7<br />		&#91;color=green&#93;;Distance&#91;/color&#93;<br />		invoke SendMessage,hWin,WM_COPYDATA,1021,addr cds<br />	.elseif ecx==11<br />		&#91;color=green&#93;;Latitude&#91;/color&#93;<br />		invoke SendMessage,hWin,WM_COPYDATA,1009,addr cds<br />	.elseif ecx==12<br />		&#91;color=green&#93;;Longitude&#91;/color&#93;<br />		invoke SendMessage,hWin,WM_COPYDATA,1010,addr cds<br />	.endif<br />.endif<br />.<br />Capture2 endp<br /><br />DlgProc proc<br />.<br />.elseif eax==WM_COPYDATA<br />	mov eax,lParam<br />	assume eax&#58;ptr COPYDATASTRUCT<br />	.if wParam==IDC_EDT6<br />		invoke SendMessage,hEdt6,WM_SETTEXT,FALSE,&#91;eax&#93;.lpData<br />	.elseif wParam==IDC_EDT7<br />		invoke SendMessage,hEdt7,WM_SETTEXT,FALSE,&#91;eax&#93;.lpData<br />	.elseif wParam==IDC_EDT3<br />		invoke SendMessage,hEdt3,WM_SETTEXT,FALSE,&#91;eax&#93;.lpData<br />	.elseif wParam==IDC_EDT4<br />		invoke SendMessage,hEdt4,WM_SETTEXT,FALSE,&#91;eax&#93;.lpData<br />.<br />DlgProc endp</code></pre><br />Thank you Raymond and roticv for your help. Problems are much easier to solve when one have access to mutual exchange of experience and knowledge.<br />Best regards</div>
    <div class="meta">Posted on 2003-03-17 10:53:06 by minor28</div>
   </div>
   <div class="post" id="post-87614">
    <div class="subject"><a href="#post-87614">SendMessage COPY_DATA Question</a></div>
    <div class="body">You're welcome. <br /><br />Trying to find and correct errors in one's own text can be frustrating, whether it's only a plain letter or source code. Some of these errors just seem to jump out like a red marker for someone else when sufficient information is available.<br /><br />I have learned to rely early on my debugger before I get too frustrated trying to find why results are not as expected.<br /><br />Raymond</div>
    <div class="meta">Posted on 2003-03-17 12:30:36 by Raymond</div>
   </div>
  </div>
 </body>
</html>