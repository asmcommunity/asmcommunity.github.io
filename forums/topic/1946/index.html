<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>How to enumerate LAN resources? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=1946" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=8">Networking</a> &raquo; <a href="../?id=1946">How to enumerate LAN resources?</a></p>
   <div class="post" id="post-12515">
    <div class="subject"><a href="#post-12515">How to enumerate LAN resources?</a></div>
    <div class="body">Every day I enter the local network; there are 2 workgroups with more than 20 computers in each. Server works under NT 4.0 and most comuters use Win9x. How can I determine (from Win98, not NT/2k/XP!):<br />1. What workgroups (or domains) are accesible in current moment?<br />2. What computers(and other resources) are active in each workgroup?<br /><br />I have been write a small program based on WNetOpenEnum/ WNetEnumResource but it works NOT properly: results consists zeros and blank strings, see it below:<br /><br />*************************************************<br />.386<br />.model flat, stdcall<br />option casemap:none<br /><br />include \masm32\include\windows.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\user32.inc<br />include \masm32\include\masm32.inc<br />include \masm32\include\mpr.inc<br /><br />includelib \masm32\lib\kernel32.lib<br />includelib \masm32\lib\user32.lib<br />includelib \masm32\lib\masm32.lib<br />includelib \masm32\lib\mpr.lib<br /><br />.data<br />MsgCaption	db &quot;Error code&quot;,0<br />MsgCaption1	db &quot;Net resource&quot;,0<br />MsgCaption2	db &quot;Bytes&quot;,0<br />Msg1		db &quot;All ??&quot;, 0<br />retCode	db 16 dup (?)<br />hEnum		dd ?<br />hMem		dd ?<br />memAvail	                dd ?<br />nPoints	                dd -1<br />container	                NETRESOURCE &lt;&gt;<br />rname		db &quot;INFORMATIKA&quot;, 0<br /><br />.code<br />start:<br />	mov container.dwScope, RESOURCE_CONNECTED<br />	mov container.dwType, RESOURCETYPE_ANY<br />	mov container.dwDisplayType, RESOURCEDISPLAYTYPE_DOMAIN<br />	mov container.dwUsage, RESOURCEUSAGE_CONTAINER<br />	mov container.lpRemoteName, offset rname<br /><br />	invoke GlobalAlloc, GMEM_FIXED OR GMEM_ZEROINIT, 10<br />	mov hMem, eax<br />	invoke WNetOpenEnum,<br />		RESOURCE_CONNECTED,	; scope of enumeration <br />		RESOURCETYPE_ANY,		; resource types to list <br />		RESOURCEUSAGE_CONTAINER,; resource usage to list (0 = ??? ???????)<br />		offset container,		; pointer to resource structure <br />		addr hEnum	 		; pointer to enumeration handle buffer<br />	invoke WNetEnumResource,<br />		hEnum,			; handle of enumeration <br />		addr nPoints,		; 		hMem,				; address of buffer for results <br />		addr memAvail 		; address of buffer size variable<br />	invoke GlobalFree, hMem<br />	invoke WNetCloseEnum, hEnum<br /><br />	; The second call<br />	invoke GlobalAlloc, GMEM_FIXED OR GMEM_ZEROINIT, memAvail	; ??????? ???? ??????<br />	mov hMem, eax<br />	invoke WNetOpenEnum,<br />		RESOURCE_CONNECTED,	; scope of enumeration <br />		RESOURCETYPE_ANY,		; resource types to list <br />		RESOURCEUSAGE_CONTAINER,; resource usage to list (0 = ??? ???????)<br />		offset container,		; pointer to resource structure <br />		addr hEnum	 		; pointer to enumeration handle buffer<br />	invoke WNetEnumResource,<br />		hEnum,			; handle of enumeration <br />		addr nPoints,<br />		hMem,				; address of buffer for results <br />		addr memAvail 		; address of buffer size variable<br />	.if eax != 0<br />		invoke dwtoa, eax, addr retCode<br />		invoke MessageBox, NULL,addr retCode, addr MsgCaption, MB_OK<br /><br />	.else<br />		invoke dwtoa, memAvail, addr retCode<br />		invoke MessageBox, NULL,addr retCode, addr MsgCaption2, MB_OK<br />		; Size of NETRESOURCE = 32, ???????? lpLocalName=16, lpRemoteName=20<br />		mov esi, hMem<br />		mov ebx, esi<br />		add esi, 20<br />		add ebx, memAvail<br />		.while esi&lt;ebx<br />			invoke MessageBox, NULL, eax, addr MsgCaption1, MB_OK<br />			add esi, 32<br />		.endw<br />	.endif<br /><br />	invoke GlobalFree, hMem<br />	invoke WNetCloseEnum, hEnum<br /><br />	invoke ExitProcess,NULL<br />end start<br /><br />*************************************************<br /><br />Thanks, Mike</div>
    <div class="meta">Posted on 2001-11-19 05:08:23 by Mike</div>
   </div>
   <div class="post" id="post-12794">
    <div class="subject"><a href="#post-12794">How to enumerate LAN resources?</a></div>
    <div class="body">I haven't tested your code,<br />but just looking at the first lines, one thing appears to be wrong<br /><br />When you call WNetOpenEnum you should use RESOURCE_GLOBALNET (instead of RESOURCE_CONNECTED) if you want to use RESOURCEUSAGE_CONTAINER. The dwUsage is ignored if you use any other argument<br /><br />Random</div>
    <div class="meta">Posted on 2001-11-22 07:55:18 by random</div>
   </div>
  </div>
 </body>
</html>