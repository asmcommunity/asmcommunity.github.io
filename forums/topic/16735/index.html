<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>compile to binary - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=16735" />
    <link rel="next" href="../?id=16735&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=34">OS Development</a> &raquo; <a href="../?id=16735">compile to binary</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=16735&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=16735&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="16735" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=16735&amp;page=2">&gt;</a><a href="../?id=16735&amp;page=2">&raquo;</a></form>   <div class="post" id="post-129993">
    <div class="subject"><a href="#post-129993">compile to binary</a></div>
    <div class="body">i've now decided that coding the whole os in assembler is not the solution, so i settle up for c++.<br />well, its quite difficult, since i need a compiler which can work with a different base (since i'm using paging, at some point the code's base is 0xF0000000, before it was 0x7C00 while booting and 0x00000000 while initializing). but the most important thing is, that the linker can output in a raw-binary format without any os-specific header-thingy.<br /><br />things i've tried:<br />- the visual c++-compiler:<br />  well, it's quite good, but the linker won't output without header - well, is it possible anyhow?. i could even generate the code with different bases.<br />  i thought even of writing a program which just grabs that piece of code and puts it in a seperate file, when it is linked correctly.<br />- the gcc-compiler + the linker ld.exe<br />  didn't try long with it, but i still don't get a raw output (if i give it the option <strong>--oformat binary</strong> it sould do, but the program generates an exception.... - i took a look at another os, where that option is used) and i think the compiler can't handle different base-adresses.<br /><br />its just too much work coding in assembler... c++ would make things so much easier :)<br /><br />thanks anyway</div>
    <div class="meta">Posted on 2004-01-07 13:42:49 by hartyl</div>
   </div>
   <div class="post" id="post-129994">
    <div class="subject"><a href="#post-129994">compile to binary</a></div>
    <div class="body">Try and use John Fine's JLOC ...</div>
    <div class="meta">Posted on 2004-01-07 14:01:12 by BogdanOntanu</div>
   </div>
   <div class="post" id="post-130049">
    <div class="subject"><a href="#post-130049">compile to binary</a></div>
    <div class="body">I'd recoment using fasm, you'll be able to get raw output directly, and you'll be able to specify any origin.<br /><br />Just one side note (worth pointing out just incase someone missed it), you <strong>cannot</strong> use masm (and mostlikey not any other M$ product - I think VC++ follows the same EULA as masm) to make any kind of OS, since it's illegal. (search the board if you want more info).<br /><br />But for writing mid-level OS code I'd say pure C is the best (no need to bring C++ objects into the picture). Besides what says doing things in C++ makes it easier, I often find myself doing things faster in asm than I C++ (I guess it's all damn typecasts that slows me down :/ )<br /><br />Maybe you must make each 'address section' in it's own file (compile it to raw and then cat the files together).</div>
    <div class="meta">Posted on 2004-01-08 10:09:53 by scientica</div>
   </div>
   <div class="post" id="post-130050">
    <div class="subject"><a href="#post-130050">compile to binary</a></div>
    <div class="body">I would have also suggested FASM (or waiting for SOL_ASM) but he wanted a c/c++ solution.<br /><br />I also thing anything else but ASM is an overkill and in most cases no way easyer ...  just a mind ideea that is easyer ... but it is his choice and i respect it.<br /><br />I course C++ typecasting every little day i work :D <br /><br />Instead of helping me find mistakes it is mostly slowing me down and making me search for axes nearby <br /><br />I do not see any use for C++ and clases other than fancy IDE and the fact that they want to hide that there are structures with function pointers inside...and that is not nice structured programming isnt it  :rolleyes:<br /><br />Somehow the humman race considers that hideing and lieing is a very nice and good thing...</div>
    <div class="meta">Posted on 2004-01-08 10:25:09 by BogdanOntanu</div>
   </div>
   <div class="post" id="post-130055">
    <div class="subject"><a href="#post-130055">compile to binary</a></div>
    <div class="body"><div class="quote"><br />you cannot use masm (and mostlikey not any other M$ product - I think VC++ follows the same EULA as masm) to make any kind of OS, since it's illegal. <br /></div><br />You cannot use the most recent masm from DDKs to do anything but drivers, if you follow their EULA - if you *bought* masm, you should be able to use it for whatever you want. Same goes for VC++ I bet.<br /><br /><div class="quote"><br />I often find myself doing things faster in asm than I C++ (I guess it's all damn typecasts that slows me down :/ <br /></div><br />That's because you're working with the WIN32 API that was designed for C...<br /><br />hartyl, the GNU ld is pretty powerful once you start messing with linker scripts. You can do a lot of nice stuff, and binary output isn't a problem.<br /><br />But why not go for a PE-based kernel? Keep basic initialization in assembly, then jump to your PE kernel once it's loaded and basic paging etc is set up. You can always add support for relocations later on if you want to, but of course choosing an arbitrary imagebase isn't a problem either.<br /><br />I'd suggest you to keep the core kernel pretty small, and split off as much as you can into modules. Makes it easier to update components on-the-fly and can give better error isolation. Besides, it makes it easier to discard an entire unused module from memory, instead of just unused pages.</div>
    <div class="meta">Posted on 2004-01-08 11:08:08 by f0dder</div>
   </div>
   <div class="post" id="post-130065">
    <div class="subject"><a href="#post-130065">compile to binary</a></div>
    <div class="body">hartyl,<br /><br />If you are looking for a free C/C++ compiler, you can try Pelle's C, Digital Mars, Blodshed and Open Watcom.</div>
    <div class="meta">Posted on 2004-01-08 12:28:20 by Vortex</div>
   </div>
   <div class="post" id="post-130066">
    <div class="subject"><a href="#post-130066">compile to binary</a></div>
    <div class="body">It sounds more like he's looking for a linker that can produce binary output than he's looking for a free C/C++ compiler ^_^<br /><br />OpenWatcom, while not really that hot anymore, might be a choice though... from what I remember, watcom had a lot of output options.</div>
    <div class="meta">Posted on 2004-01-08 12:33:06 by f0dder</div>
   </div>
   <div class="post" id="post-130079">
    <div class="subject"><a href="#post-130079">still messing around...</a></div>
    <div class="body">good information you're giving me. i've tried to make it with the gcc compiler and the ld linker the easiest way (a minimal code to see it working).<br />i have 2 files and want to link the together while one file uses functions of the other. it looks like this:<br /><br /><pre><code><br />//boot.cpp<br />extern &quot;C&quot;<br />&#123; void core&#40;&#41;;<br />&#125;<br /><br />int foo_bar&#40;unsigned long foo&#41;;<br /><br />void main&#40;&#41;<br />&#123; int x=foo_bar&#40;1&#41;;<br />  core&#40;&#41;;<br />&#125;<br /><br />int foo_bar&#40;unsigned long foo&#41;<br />&#123; return &#40;int&#41;&#40;foo-1&#41;;<br />&#125;<br /><br />------------------------------------<br /><br />//core.cpp<br />extern &quot;C&quot;<br />&#123; int foo_bar&#40;unsigned long&#41;;<br />&#125;<br /><br /><br />void core&#40;&#41;<br />&#123; foo_bar&#40;1&#41;;<br />&#125;<br /></code></pre><br />i compile to object-files like this:<br /><pre><code><br />gcc boot.cpp -c<br />gcc core.cpp -c<br /></code></pre><br />but when linking i get the error:<br /><pre><code><br />&gt;ld boot.o core.o -e _main<br /><br />boot.o&#40;.text+0x7&#41;&#58;boot.cpp&#58; undefined reference to `__main'<br />boot.o&#40;.text+0x1e&#41;&#58;boot.cpp&#58; undefined reference to `core'<br />core.o&#40;.text+0xc&#41;&#58;core.cpp&#58; undefined reference to `foo_bar'<br /></code></pre><br />why doesn't it work? why can't the linker find my references between the object-files?<br />(addition: i have never done self-linking before...)<br />(another addition: ld just crashes when i use &quot;--oformat binary&quot;... - another &quot;why?!&quot;)</div>
    <div class="meta">Posted on 2004-01-08 14:31:18 by hartyl</div>
   </div>
   <div class="post" id="post-130080">
    <div class="subject"><a href="#post-130080">compile to binary</a></div>
    <div class="body">when specifying entrypoint, you should probably just use &quot;main&quot; and not &quot;_main&quot;.<br /><br />You're doing .cpp files - thus, you'll have name decoration on your stuff. You're trying to import symbols without name decoration (&quot;extern C&quot; block), but you're exporting them as decorated names - you need a &quot;extern C&quot; block with prototype for the symbols in the source file exporting them, too - I suggest doing this via header files, since you can use same header files for both the exporting and importing files. This helps making sure you have the same defitions everywhere, too!<br /><br />Also, remember to put &quot;static&quot; (or unnamed namespaces, if you want to take advantage of new C++ features) on all symbols you do not wish to export, so you avoid name clashes and weird errors.<br /><br />ld crashes on binary output? Weird. Yay for wonderful bugfree open software ;)<br /><br />Hm, either I accidentally wiped out my old toy kernel :(, or I have RARed it up and moved it to a backup CD... I'll have to look around a bit :-s - I was going to attach the ld linker script I used for my kernel. Damn.</div>
    <div class="meta">Posted on 2004-01-08 14:50:33 by f0dder</div>
   </div>
   <div class="post" id="post-130082">
    <div class="subject"><a href="#post-130082">compile to binary</a></div>
    <div class="body">omg! deleting a kernel? :D<br /><br />you're brilliant; didn't know that the exported functions have to appear also in the &quot;extern C&quot;-block - learnt something :D<br /><br />it works even more than before; i got dev-cpp, the newest version with the &quot;ld&quot;-linker. that version doesnt crash when i use the &quot;--oformat binary&quot;, but it doesnt work either giving me this error:<br />&quot;PE operations on non PE file.&quot;<br />cruel, isn't it?</div>
    <div class="meta">Posted on 2004-01-08 15:20:47 by hartyl</div>
   </div>
   <div class="post" id="post-130085">
    <div class="subject"><a href="#post-130085">compile to binary</a></div>
    <div class="body">it does seem like I have a backup from 20020711 - phew. Probably haven't messed with it since then. Wonder why it's gone from my harddrive and I don't have other backups of it :-s. The linker script looks like this:<br /><br /><pre><code><br />OUTPUT_FORMAT&#40;&quot;binary&quot;&#41;<br />ENTRY&#40;__KERNEL_ENTRY__&#41;<br />SECTIONS<br />&#123;<br />  .text  0x100000 &#58;<br />  &#123;<br />    __KERNEL_START = . ;<br />    __TEXT_START = . ;<br />    *&#40;.text&#41;<br />    *&#40;.const*&#41;<br />    *&#40;.ro*&#41;<br />    __TEXT_END = . ;<br />  &#125;<br /><br />  .data  ALIGN&#40;32&#41; &#58;		/* we don't need 4k alignment for data */<br />  &#123;<br />    __DATA_START = . ;<br />    *&#40;.data&#41;<br />    __DATA_END = . ;<br />  &#125;<br /><br />  .bss	ALIGN&#40;4096&#41; &#58;<br />  &#123; 					<br />    __BSS_START = . ;<br />    *&#40;.bss&#41;<br />    *&#40;COMMON&#41;<br />    *&#40;.stack&#41;<br />     . = ALIGN&#40;4096&#41;;<br />    __BSS_END = . ;<br />    __KERNEL_END = . ;<br />  &#125;<br /><br />  .init	ALIGN&#40;4096&#41;&#58;<br />  &#123;<br />    *&#40;.icode&#41;<br />    *&#40;.idata&#41;<br />    __REAL_KERNEL_END = . ;<br />  &#125;<br />&#125;<br /></code></pre><br /><br />- it's clear that ld is more powerful than the MS linker, I sometimes miss being able to define symbols and control section order... too bad it's such a big piece of dirty GNU code, it would be nice adding ms-coff support (only difference from gnu-coff should be relative relocations) and ms library support...</div>
    <div class="meta">Posted on 2004-01-08 15:29:28 by f0dder</div>
   </div>
   <div class="post" id="post-130132">
    <div class="subject"><a href="#post-130132">compile to binary</a></div>
    <div class="body">you might already know my answer:<br />i have no idea how the script works, what the syntax is like, where the obj-files are specified.<br />the code looks nice, but where is the __KERNEL_ENTRY__ defined? is it a symbol? if you output in binary, where do the section-names appear (actually the aren't used, are they?)? maybe a complete reference of the script and its syntax?<br /><br />how does the ld-linker react on ms-coff obj-files?<br /><br />i'll play around with this script, maybe i get a good result.<br /><br />thanks at all; i'll tell you what i got then :)</div>
    <div class="meta">Posted on 2004-01-09 02:48:10 by hartyl</div>
   </div>
   <div class="post" id="post-130136">
    <div class="subject"><a href="#post-130136">compile to binary</a></div>
    <div class="body">You can find examples here: <a target="_blank" href="http://www.osdever.net/downloads/kernels/kernel1.zip">kernel1</a>  <a target="_blank" href="http://www.osdever.net/downloads/kernels/kernel2.zip">kernel2</a>  <a target="_blank" href="http://www.osdever.net/downloads/kernels/kernel3.zip">kernel3</a> <br /><br />Also you know that a procedure, function, method is only a entry point for the whole file, eg:<br /><br />mov eax, eax<br />ret<br />rol ax,1<br />ret<br /><br />You can mark in any place the start, including point to ret, what I whant to say is that the functions of C are address, then you can do some like #define entry funct, and that will give you the correct, or more, code void __KERNEL_ENTRY__(void), also I am thinking in some fun... you know that you can make a prototype for pointer functions, I dont remember the correct sintaxis, but search for function pointers, and you can have diferent entry points, only mark what you whant.... (I not think I explain this ok.. :S)<br /><br />===================<br />Also If i am not wrong, dev-cpp use <a target="_blank" href="http://mingw.org/">http://mingw.org/</a> then you can search for <a target="_blank" href="http://sources.redhat.com/binutils/docs-2.12/ld.info/Scripts.html#Scripts">http://sources.redhat.com/binutils/docs-2.12/ld.info/Scripts.html#Scripts</a> ok... is a source from red had, but is from the docs of mingw (<a target="_blank" href="http://mingw.org/docs.shtml">http://mingw.org/docs.shtml</a>)<br /><br />================<br /><div class="quote">it's clear that ld is more powerful than the MS linker</div> What about the assembler? :D<br /><br /><br />Have a nice dy or night.</div>
    <div class="meta">Posted on 2004-01-09 04:26:22 by rea</div>
   </div>
   <div class="post" id="post-130146">
    <div class="subject"><a href="#post-130146">compile to binary</a></div>
    <div class="body">The input files aren't specified in the linker script (they can be, though) - I use the linker script to control the order of sections, plus add some symbols. Specify .obj and .lib on commandline.<br /><br />__KERNEL_ENTRY__ is defined in one of my .c files (or perhaps a .asm one, can't remember). It may seem a bit pointless including it, but iirc ld bitches if you don't have an entrypoint - even for binary output.<br /><br />The section-names appear nowhere, but it's nice being able to control the order they appear in the binary output.<br /><br />For a reference of the script, your best bet is probably unix &quot;info ld&quot; or go to <a target="_blank" href="http://www.delorie.com/djgpp/">http://www.delorie.com/djgpp/</a> and get the 32bit dos extended djgpp, as it has the texinfo program + docs on ld.<br /><br /><div class="quote"><br />how does the ld-linker react on ms-coff obj-files?<br /></div><br />Good question. DJGPP uses the gnu-coff or dj-coff or whatever... dunno if perhaps mingw32 supports ms-coff? The only difference I encountered between the two formats were with regards to relocations. In the MS format, the code has a dword 0 and the linker does the entire relocation, in the other format it has a value where the relocation delta will be applied.<br /><br />I'd still advise you to use PE or ELF for your kernel, but getting binary kernel loading to work first is probably a good idea :)<br /><br />Hgb,<br /><div class="quote"><br />What about the assembler? :D<br /></div><br />I'd much rather use masm than gas - or well, perhaps gas is okay after they added intel syntax. I don't do &quot;high-level&quot; coding in assembly anyway, so I tend to prefer nasm or fasm, since they do what I want them to.</div>
    <div class="meta">Posted on 2004-01-09 06:12:57 by f0dder</div>
   </div>
   <div class="post" id="post-130147">
    <div class="subject"><a href="#post-130147">compile to binary</a></div>
    <div class="body">Addendum: there isn't really any way to distinguish ms-coff from the other coff format - apart from runtime crashes if you use an incompatible linker and object format (have a look at generated code with a disassembler).</div>
    <div class="meta">Posted on 2004-01-09 06:13:49 by f0dder</div>
   </div>
   <div class="post" id="post-130172">
    <div class="subject"><a href="#post-130172">compile to binary</a></div>
    <div class="body">Hi f0dder,<br /><br />Do you know if there is any specification/reference for the MS COFF obj file and lib format?</div>
    <div class="meta">Posted on 2004-01-09 12:23:19 by Vortex</div>
   </div>
   <div class="post" id="post-130180">
    <div class="subject"><a href="#post-130180">compile to binary</a></div>
    <div class="body">look in MSDN, it's there along with the PE format. mscoff is identical to the gnu coff anyway, except for those relocs and prolly extended debug info.</div>
    <div class="meta">Posted on 2004-01-09 13:46:25 by f0dder</div>
   </div>
   <div class="post" id="post-130259">
    <div class="subject"><a href="#post-130259">compile to binary</a></div>
    <div class="body">man, i start hating it; so much good information, and i still keep failing.<br />i went to level 0, i got kernel1.zip (posted by <strong>hgb</strong>) and used <strong>exactly</strong> the tools used for that example. the gcc-compiler and ld-linker are from the dev-cpp-binaries (newest i think) and i got the newest nasmw as well. then i exectued the kernelbuild.bat, where the compiler does its work, the assembler as well, but the linker just outputs a message complaining about the object file from nasmw:<br /><pre><code><br />C&#58;\Dev-Cpp\bin&gt;kernelbuild<br /><br />C&#58;\Dev-Cpp\bin&gt;nasmw -f aout kernel.asm -o kernel.o<br /><br />C&#58;\Dev-Cpp\bin&gt;ld -T kernel.ld kernel.o<br />kernel.o&#58; file not recognized&#58; File format not recognized<br /></code></pre><br />if i use another file-format (coff,obj,win32) i get &quot;PE operation on non PE file.&quot;<br /><br />this can't be true?! or am i predicted to failing using windows for developing my system (do the linux-assembler/compiler/linker-versions behave differently?)</div>
    <div class="meta">Posted on 2004-01-10 05:29:56 by hartyl</div>
   </div>
   <div class="post" id="post-130286">
    <div class="subject"><a href="#post-130286">mmm</a></div>
    <div class="body">The only 'error' that I obtain when I compile (by hand or in the command line.. naa use the bat ;) ) is:<br /><pre><code><br />$ nasm -faout kernel.asm<br />$ ld -T kernel.ld kernel.o<br />ld&#58; warning&#58; cannot find entry symbol start; defaulting to ff800000<br />$ ls<br />a.out*  kernel.asm  kernelbuild.bat  kernel.ld  kernel.o<br /></code></pre><br /><br />That is because the linker dont know where is the entry point in the files that you pass to it (specially the .o or other object files, the reference is not specified where is it), the simbol start, this is because in the nasm source is not specified that start is 'exported', you can do that with: <em>global start</em> then let all the codes there like there are..., the asm file is:<br /><pre><code> &#91;bits 32&#93;<br /><br />global start<br />start&#58;<br />  jmp $</code></pre><br /><br />And the output now is:<br /><pre><code><br />$ nasm -faout kernel.asm<br />$ ld -T kernel.ld kernel.o<br />$ ls<br />a.out*  kernel.asm  kernelbuild.bat  kernel.ld  kernel.o<br /></code></pre><br /><br />At less no errors<br /><br />the ld that I use is: $ ld --version<br />GNU ld version 2.12.90.0.15 20020717<br /><br />I not hink that there exist a problem in the port of ld to win, try first with the correction to the asm file.<br /><br /><br /><br />Also other option that some persons like  a lot is bin nasm -fbin<br /><br /><br /><br />Have a nice day or night.</div>
    <div class="meta">Posted on 2004-01-10 10:33:31 by rea</div>
   </div>
   <div class="post" id="post-130291">
    <div class="subject"><a href="#post-130291">Re: mmm</a></div>
    <div class="body"><div class="quote"><em>Originally posted by hgb </em><br />I not hink that there exist a problem in the port of ld to win, try first with the correction to the asm file.<br /></div><br />hmm, somehow i don't thrust the output of nasm<br /><br /><div class="quote"><em>Originally posted by hgb </em><br />Also other option that some persons like  a lot is bin nasm -fbin<br /></div><br />nah, that's the reason why i want to do it the obj-file-way; i can't make any references to the c-files when i just make a binary assembler-code.<br /><br />the linker gives the same error if i try the obj-files from fasm (MS COFF, COFF or ELF)...<br /><br />either i give the whole thing up, or i have the do it a dirty way, i think</div>
    <div class="meta">Posted on 2004-01-10 13:39:22 by hartyl</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=16735&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=16735&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="16735" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=16735&amp;page=2">&gt;</a><a href="../?id=16735&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>