<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>VESA doubt - .com files - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=8228" />
    <link rel="next" href="../?id=8228&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=8228">VESA doubt - .com files</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=8228&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=8228&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="8228" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=8228&amp;page=2">&gt;</a><a href="../?id=8228&amp;page=2">&raquo;</a></form>   <div class="post" id="post-60183">
    <div class="subject"><a href="#post-60183">VESA doubt - .com files</a></div>
    <div class="body">Hello!<br />I'm writting a VESA code, it works when I use debug to run it, but it doesn't work when I run it directly.<br />Can anyone help me?<br /><br />the code and include file:<pre><code>;-- -------------------------------------begin&#58;VESA.ASM----------------------<br />org 100h<br />include 'vesa.inc'<br /><br /><br />jmp start<br /><br /><br /><br /><br /><br />start&#58;<br />        call getVesaInfo<br />        call getModeInfo<br />        call getMode<br />        mov &#91;omode&#93;,bx<br />        call setMode<br />        call line<br /><br />        mov ax,0<br />        int 16h<br /><br />        call restoreOMode<br />        int 20h<br /><br />pixelw&#58;<br />        mov ax,&#91;mode.BytesPerScanLine&#93;<br />        mul &#91;y&#93;<br />        mov bx,&#91;x&#93;<br />        shl bx,1<br />        add ax,bx<br />        jnc noc<br />        inc dx<br />    noc&#58;<br />        mov &#91;ofs&#93;,ax<br />        cmp dx,&#91;bank&#93;<br />        jz same<br />        mov &#91;bank&#93;,dx<br />        mov cx,&#91;bankshift&#93;<br />        shl dx,cl<br />        xor bx,bx<br />        call far &#91;mode.WinFuncPtr&#93;<br /><br />same&#58;<br />        push di<br />        mov ax,0a000h<br />        mov es,ax<br />        mov di,&#91;ofs&#93;<br />        mov ax,&#91;color&#93;<br />        mov &#91;es&#58;di&#93;,ax<br />        pop di<br />        ret<br /><br />line&#58;<br />        mov &#91;color&#93;,1111100000011111b<br />        mov &#91;x&#93;,100<br />        mov &#91;y&#93;,100<br />        call pixelw<br />        ret<br /><br />getVesaInfo&#58;<br />        mov di,vesa<br />        mov ax,4f00h    ;VBE get vesa info function<br />        int 10h<br />        ret<br /><br /><br />getModeInfo&#58;<br />        mov di,mode<br />        mov ax,4f01h    ;VBE get mode info function<br />        mov cx,&#91;vmode&#93;  ;The video mode to get the information<br />        int 10h<br />        ret<br /><br />setMode&#58;<br />        mov ax,4f02h    ;VBE set video mode function<br />        mov bx,&#91;vmode&#93;  ;One of the supported vesa modes<br />        int 10h<br />        mov ax,&#91;mode.WinSize&#93;<br />        mov bx, &#91;mode.WinGranularity&#93;<br />        div bx<br />   g0&#58;  cmp ax,1<br />        jne g1<br />        mov &#91;bankshift&#93;,0<br />        ret<br />   g1&#58;  cmp ax,2<br />        jne g2<br />        mov &#91;bankshift&#93;,1<br />        ret<br />   g2&#58;  cmp ax,4<br />        jne g3<br />        mov &#91;bankshift&#93;,2<br />        ret<br />   g3&#58;  cmp ax,8<br />        jne g4<br />        mov &#91;bankshift&#93;,3<br />        ret<br />   g4&#58;  cmp ax,16<br />        jne g5<br />        mov &#91;bankshift&#93;,4<br />        ret<br />   g5&#58;  cmp ax,32<br />        jne g6<br />        mov &#91;bankshift&#93;,5<br />        ret<br />   g6&#58;  cmp ax,1<br />        jne gd<br />        mov &#91;bankshift&#93;,6<br /><br />   gd&#58;  ret<br /><br />getMode&#58;<br />        mov ax,4f03h    ;VBE return the current video mode funtion<br />        int 10h         ;Value will be returned in BX<br />        ;mov &#91;vmode&#93;,bx ;Put current mode in vmode<br />        ret<br /><br />restoreOMode&#58;<br />        mov ax,4f02h<br />        mov bx,&#91;omode&#93;<br />        int 10h<br />        ret<br /><br />vmode   dw 114h<br />bds     dw ?<br />vesa vesaInfo<br />mode vesaModeInfo<br /><br />y       dw ?<br />x       dw ?<br />color   dw ?<br />omode   dw ?            ;older mode<br /><br />bank    dw ?<br />ofs     dw ?<br />bankshift dw ?<br /><br />;---------------------------------------end&#58;VESA.ASM----------------------<br /><br />;---------------------------------------begin&#58;VESA.INC----------------------<br /><br />struc vesaInfo<br />    &#123;<br />    .VbeSignature        dd ?      ; VBE Signature<br />    .VbeVersion          dw ?      ; VBE Version<br />    .OemStringPtr        dd ?      ; VbeFarPtr to OEM String<br />    .Capabilities        dd ?      ; Capabilities of graphics controller<br />    .VideoModePtr        dd ?       ; VbeFarPtr to VideoModeList<br />    .TotalMemory         dw ?      ; Number of 64kb memory blocks<br />                                  ; Added for VBE 2.0+<br />    .OemSoftwareRev      dw ?      ; VBE implementation Software revision<br />    .OemVendorNamePtr    dd ?      ; VbeFarPtr to Vendor Name String<br />    .OemProductNamePtr   dd ?      ; VbeFarPtr to Product Name String<br />    .OemProductRevPtr    dd ?      ; VbeFarPtr to Product Revision String<br />    .Reserved            rb 222    ; Reserved for VBE implementation scratch area<br />    .OemData             rb 256    ; Data Area for OEM Strings<br />    &#125;<br /><br /><br />struc vesaModeInfo<br />    &#123;<br />    .ModeAttributes      dw ? ; mode attributes<br />    .WinAAttributes      db ? ; window A attributes<br />    .WinBAttributes      db ? ; window B attributes<br />    .WinGranularity      dw ? ; window granularity<br />    .WinSize             dw ? ; window size<br />    .WinASegment         dw ? ; window A start segment<br />    .WinBSegment         dw ? ; window B start segment<br />    .WinFuncPtr          dd ? ; real mode pointer to window function<br />    .BytesPerScanLine    dw ? ; bytes per scan line<br /><br />; Mandatory information for VBE 1.2 and above<br />    .XResolution         dw ? ; horizontal resolution in pixels or characters3<br />    .YResolution         dw ? ; vertical resolution in pixels or characters<br />    .XCharSize           db ? ; character cell width in pixels<br />    .YCharSize           db ? ; character cell height in pixels<br />    .NumberOfPlanes      db ? ; number of memory planes<br />    .BitsPerPixel        db ? ; bits per pixel<br />    .NumberOfBanks       db ? ; number of banks<br />    .MemoryModel         db ? ; memory model type<br />    .BankSize            db ? ; bank size in KB<br />    .NumberOfImagePages  db ? ; number of images<br />    .Reserved1           db ? ; reserved for page function<br /><br />; Direct Color fields &#40;required for direct/6 and YUV/7 memory models&#41;<br />    .RedMaskSize         db ? ; size of direct color red mask in bits<br />    .RedFieldPosition    db ? ; bit position of lsb of red mask<br />    .GreenMaskSize       db ? ; size of direct color green mask in bits<br />    .GreenFieldPosition  db ? ; bit position of lsb of green mask<br />    .BlueMaskSize        db ? ; size of direct color blue mask in bits<br />    .BlueFieldPosition   db ? ; bit position of lsb of blue mask<br />    .RsvdMaskSize        db ? ; size of direct color reserved mask in bits<br />    .RsvdFieldPosition   db ? ; bit position of lsb of reserved mask<br />    .DirectColorModeInfo db ? ; direct color mode attributes<br /><br />; Mandatory information for VBE 2.0 and above<br />    .PhysBasePtr         dd ? ; physical address for flat memory frame buffer<br />    .Reserved2           dd ? ; Reserved - always set to 0<br />    .Reserved3           dw ? ; Reserved - always set to 0<br /><br />; Mandatory information for VBE 3.0 and above<br />    .LinBytesPerScanLine     dw ? ; bytes per scan line for linear modes<br />    .BnkNumberOfImagePages   db ? ; number of images for banked modes<br />    .LinNumberOfImagePages   db ? ; number of images for linear modes<br />    .LinRedMaskSize          db ? ; size of direct color red mask &#40;linear modes&#41;<br />    .LinRedFieldPosition     db ? ; bit position of lsb of red mask &#40;linear modes&#41;<br />    .LinGreenMaskSize        db ? ; size of direct color green mask &#40;linear modes&#41;<br />    .LinGreenFieldPosition   db ? ; bit position of lsb of green mask &#40;linear modes&#41;<br />    .LinBlueMaskSize         db ? ; size of direct color blue mask &#40;linear modes&#41;<br />    .LinBlueFieldPosition    db ? ; bit position of lsb of blue mask &#40;linear modes&#41;<br />    .LinRsvdMaskSize         db ? ; size of direct color reserved mask &#40;linear modes&#41;<br />    .LinRsvdFieldPosition    db ? ; bit position of lsb of reserved mask &#40;linear modes&#41;<br />    .MaxPixelClock           dd ? ; maximum pixel clock &#40;in Hz&#41; for graphics mode<br />    .Reserved4               rb 189 ; remainder of ModeInfoBlock<br /><br />    &#125; <br />;---------------------------------------end&#58;VESA.INC----------------------</code></pre>Thank You!!!</div>
    <div class="meta">Posted on 2002-09-30 15:50:19 by Despero</div>
   </div>
   <div class="post" id="post-60387">
    <div class="subject"><a href="#post-60387">VESA doubt - .com files</a></div>
    <div class="body">Hi Despero,<br />can you tell us what system are you running it from and what OS?<br />Maybe you have conflicts because of that.</div>
    <div class="meta">Posted on 2002-10-02 09:59:24 by slop</div>
   </div>
   <div class="post" id="post-60399">
    <div class="subject"><a href="#post-60399">VESA doubt - .com files</a></div>
    <div class="body">I'm testing it  in a <br />486 DX2 66Mhz<br />4Mb RAM<br />VESA 1.2 compatible<br /><br />In DOS 7.0 version</div>
    <div class="meta">Posted on 2002-10-02 13:59:28 by Despero</div>
   </div>
   <div class="post" id="post-60539">
    <div class="subject"><a href="#post-60539">VESA doubt - .com files</a></div>
    <div class="body">Hi again Despero,<br /><br />I think the problem can be solved with this:<pre><code><br />virtual at 0<br />        vesa vesaInfo<br />        mode vesaModeInfo<br />end virtual</code></pre><br /><br />This is required to acces the struct as an offset. <br /><br />Tell us if it works.</div>
    <div class="meta">Posted on 2002-10-04 09:55:25 by slop</div>
   </div>
   <div class="post" id="post-60561">
    <div class="subject"><a href="#post-60561">Solution to Vesa Problem!!!</a></div>
    <div class="body">Hi Sloppy!<br />I discover what's the problem, it was at SETMODE:<br />there was a &quot;DIV BX&quot; to discover then bankshift.<br /><br />I was blind and I see the light!<br />When I put &quot;virtual at 0&quot; where you said I received an error &quot;Divided by 0&quot;,<br />so I remembered:<br />DIV BL --&gt; AX divided by BL<br />DIV BX --&gt; DX:AX divided by BX<br />DIV EBX --&gt; EDX:EAX divided by EBX<br /><br />I think the problem occur because DX isn't 0, the result doens't fit in AX and quotient in DX, so I use XOR DX,DX before the DIV BX and program worked!<br /><br />I bilieve that in debug the program work becaus DX is set to 0 when then debug starts.<br /><br />THANK YOU!!!<br /><br /><br />Everbody is a little sleepwalker!!!</div>
    <div class="meta">Posted on 2002-10-04 14:18:01 by Despero</div>
   </div>
   <div class="post" id="post-64481">
    <div class="subject"><a href="#post-64481">VESA doubt - .com files</a></div>
    <div class="body">Hello Despero<br /><br />You are right.The problem is in DIV BX .<br />You must use XOR DX,DX before the DIV BX .<br />I program with MASM.<br />A few days ago,I begun programming with FASM.<br />I think that is better.I work at programming  with VESA.<br />But i have a problem.VESA has by default refresh ratio 60 Hz.<br />With this refresh the screen flicker.I attempt to change the refresh<br />but i can not accomplish this.<br />If you or any other know about this,tell me.<br /><br />In your code i have insert a part of code to see this.<br />Build this as '.COM'.<br />;-------------------------------start: VESA.asm-------------------------------------<br />org 100h<br />include 'vesa.inc'<br /><br />jmp start<br /><br />start:<br />        call getVesaInfo<br />        call getModeInfo<br />        call getMode<br />        mov ,bx<br />        call setMode<br /><br />        mov ,1111100000011111b<br />        mov ,0<br />        loopY:<br />        mov ,0<br />        loopX:<br />           call   pixelw<br />           inc <br />           cmp ,800<br />           jne    loopX<br />        inc <br />        cmp ,600<br />        jne  loopY<br /><br />        mov ax,0<br />        int 16h<br /><br />        call restoreOMode<br />        int 20h<br /><br />pixelw:<br />        mov ax,<br />        mul <br />        mov bx,<br />        shl bx,1<br />        add ax,bx<br />        jnc noc<br />        inc dx<br />    noc:<br />        mov ,ax<br />        cmp dx,<br />        jz same<br />        mov ,dx<br />        mov cx,<br />        shl dx,cl<br />        xor bx,bx<br />        call far <br /><br />same:<br />        push di<br />        mov ax,0a000h<br />        mov es,ax<br />        mov di,<br />        mov ax,<br />        mov ,ax<br />        pop di<br />        ret<br /><br />line:<br />        mov ,1111100000011111b<br />        mov ,100<br />        mov ,100<br />        call pixelw<br />        ret<br /><br />getVesaInfo:<br />        mov di,vesa<br />        mov ax,4f00h    ;VBE get vesa info function<br />        int 10h<br />        ret<br /><br /><br />getModeInfo:<br />        mov di,mode<br />        mov ax,4f01h    ;VBE get mode info function<br />        mov cx,  ;The video mode to get the information<br />        int 10h<br />        ret<br /><br />setMode:<br />        mov ax,4f02h    ;VBE set video mode function<br />        mov bx,  ;One of the supported vesa modes<br />        int 10h<br />        mov ax,<br />        mov bx, <br />        xor dx,dx<br />        div bx<br />   g0:  cmp ax,1<br />        jne g1<br />        mov ,0<br />        ret<br />   g1:  cmp ax,2<br />        jne g2<br />        mov ,1<br />        ret<br />   g2:  cmp ax,4<br />        jne g3<br />        mov ,2<br />        ret<br />   g3:  cmp ax,8<br />        jne g4<br />        mov ,3<br />        ret<br />   g4:  cmp ax,16<br />        jne g5<br />        mov ,4<br />        ret<br />   g5:  cmp ax,32<br />        jne g6<br />        mov ,5<br />        ret<br />   g6:  cmp ax,1<br />        jne gd<br />        mov ,6<br /><br />   gd:  ret<br /><br />getMode:<br />        mov ax,4f03h    ;VBE return the current video mode funtion<br />        int 10h         ;Value will be returned in BX<br />        ;mov ,bx ;Put current mode in vmode<br />        ret<br /><br />restoreOMode:<br />        mov ax,4f02h<br />        mov bx,<br />        int 10h<br />        ret<br /><br />vmode   dw 114h<br />bds     dw ?<br />vesa vesaInfo<br />mode vesaModeInfo<br /><br />y       dw ?<br />x       dw ?<br />color   dw ?<br />omode   dw ?            ;older mode<br /><br />bank    dw ?<br />ofs     dw ?<br />bankshift dw ?<br /><br />;---------------------------------------end:VESA.ASM----------------------  <br />Regards,Manos.</div>
    <div class="meta">Posted on 2002-11-03 09:05:22 by Anonymous</div>
   </div>
   <div class="post" id="post-64586">
    <div class="subject"><a href="#post-64586">VESA doubt - .com files</a></div>
    <div class="body">Add this to vesa.inc, you'll need this to set refresh rate. You'll need to compute this values. I didn't test this yet. So, please, read about vesa programming before and try to find any problem in the code first.<br />If I not wrong, you can find more info on <a target="_blank" href="www.vesa.org">www.vesa.org</a> (or .com, I don't remember now) there you can find the file vbe3.pdf what I think you must read while you are programming vesa.<br />Take care when using this to prevent any Hardware Damage.<br /><br />struc CRTCInfoBlock<br />    {<br />    .HorizontalTotal         dw ? ; Horizontal total in pixels<br />    .HorizontalSyncStart     dw ? ; Horizontal sync start in pixels<br />    .HorizontalSyncEnd       dw ? ; Horizontal sync end in pixels<br />    .VerticalTotal           dw ? ; Vertical total in lines<br />    .VerticalSyncStart       dw ? ; Vertical sync start in lines<br />    .VerticalSyncEnd         dw ? ; Vertical sync end in lines<br />    .Flags                   db ? ; Flags (Interlaced, Double Scan etc)<br />    .PixelClock              dd ? ; Pixel clock in units of Hz<br />    .RefreshRate             dw ? ; Refresh rate in units of 0.01 Hz<br /><br />    .Reserved                rb 40 ; remainder of ModeInfoBlock<br />    }  <br /><br />Now you put this when set video mode in vesa.asm:<br /><br />setMode:<br />	mov ax,4f02h   ;VBE set video mode function<br />	mov bx, ;One of the supported vesa modes<br />	or bx,0800h    ; 100000000000b set bit D11 to use CRTC info, if not set.<br />	push ds        ; <br />	pop es         ; load es with the segment of CRTC<br />	mov di,CRTC    ; load di with the offset of CRTC	<br />	int 10h<br /><br /><br />    ; setting the granularity<br />	mov ax,<br />	mov bx, <br />	xor dx,dx<br />	div bx<br />    g0: cmp ax,1<br />	jne g1<br />	mov ,0<br />	ret<br />    g1: cmp ax,2<br />	jne g2<br />	mov ,1<br />	ret<br />    g2: cmp ax,4<br />	jne g3<br />	mov ,2<br />	ret<br />    g3: cmp ax,8<br />	jne g4<br />	mov ,3<br />	ret<br />    g4: cmp ax,16<br />	jne g5<br />	mov ,4<br />	ret<br />    g5: cmp ax,32<br />	jne g6<br />	mov ,5<br />	ret<br />    g6: cmp ax,1<br />	jne gd<br />	mov ,6<br /><br />    gd: ret  <br /><br />in data you must put this:<br /><br />CRTC CRTCInfoBlock<br /><br />You need to put the right data in CRTCInfoBlock before you use it.<br />to compute the refresh rate:<br /><br />refreshRate = PixelClock / (HorizontalTotal * VerticalTotal)<br /><br />you can use the MaxPixelClock from vesaModeInfo<br /><br />or use the current PixelClock, to get or set you use vesa function 0Bh.<br />	mov ax,4f0bh 	;get / set pixel clock<br />	mov bl,00h	;to get<br />	mov ecx,  ; you compute before in Hz unit.<br />	mov dx,  ; the video mode you want to change the pixel clock.<br />	int 10h<br /><br />	; output:<br />	; ax shows the status <br />	; ecx shows the closest pixel clock (using bl = 0)<br /><br />I think I didn't forget anything.<br />Good Bye.</div>
    <div class="meta">Posted on 2002-11-04 09:31:32 by Despero</div>
   </div>
   <div class="post" id="post-64596">
    <div class="subject"><a href="#post-64596">VESA doubt - .com files</a></div>
    <div class="body">Hello Despero.<br /><br />I had use something like your code with MASM but it had fails.<br />Now,it is fine.<br /><br />Note:The refresh rate calculate in 0.01 units.<br />For examble,a number 8500=85 Hz.<br /><br />Look the following and build it as '.COM'.<br /><br />org 100h<br />include 'vesa.inc'<br /><br />jmp start<br /><br />start:<br /><br />        mov ,114h<br />        call getVesaInfo<br />        call getModeInfo<br />        call getMode<br />        mov ,bx<br /><br />        mov ,1072<br />        mov ,848<br />        mov ,936<br />        mov ,636<br />        mov ,601<br />        mov ,604<br />        mov ,0<br />        mov ,57952320<br />        mov ,8500    ;85 Hz<br />        call setMode<br /><br />        mov ,1111100000011111b<br />        mov ,0<br />        loopY:<br />        mov ,0<br />        loopX:<br />           call   pixelw<br />           inc <br />           cmp ,800<br />           jne    loopX<br />        inc <br />        cmp ,600<br />        jne  loopY<br /><br />        mov ax,0<br />        int 16h<br /><br />        call restoreOMode<br />        int 20h<br /><br />pixelw:<br />        mov ax,<br />        mul <br />        mov bx,<br />        shl bx,1<br />        add ax,bx<br />        jnc noc<br />        inc dx<br />    noc:<br />        mov ,ax<br />        cmp dx,<br />        jz same<br />        mov ,dx<br />        mov cx,<br />        shl dx,cl<br />        xor bx,bx<br />        call far <br /><br />same:<br />        push di<br />        mov ax,0a000h<br />        mov es,ax<br />        mov di,<br />        mov ax,<br />        mov ,ax<br />        pop di<br />        ret<br /><br />line:<br />        mov ,1111100000011111b<br />        mov ,100<br />        mov ,100<br />        call pixelw<br />        ret<br /><br />getVesaInfo:<br />        mov di,vesa<br />        mov ax,4f00h    ;VBE get vesa info function<br />        int 10h<br />        ret<br /><br /><br />getModeInfo:<br />        mov di,mode<br />        mov ax,4f01h    ;VBE get mode info function<br />        mov cx,  ;The video mode to get the information<br />        int 10h<br />        ret<br /><br />setMode:<br />        mov ax,4f02h    ;VBE set video mode function<br />        mov bx,  ;One of the supported vesa modes<br />        or bx,0800h ; 100000000000b set bit D11 to use CRTC info, if not set.<br />        push ds ;<br />        pop es ; load es with the segment of CRTC<br />        mov di,CRTC ; load di with the offset of CRTC<br />        int 10h<br />        mov ax,<br />        mov bx, <br />        xor dx,dx<br />        div bx<br />   g0:  cmp ax,1<br />        jne g1<br />        mov ,0<br />        ret<br />   g1:  cmp ax,2<br />        jne g2<br />        mov ,1<br />        ret<br />   g2:  cmp ax,4<br />        jne g3<br />        mov ,2<br />        ret<br />   g3:  cmp ax,8<br />        jne g4<br />        mov ,3<br />        ret<br />   g4:  cmp ax,16<br />        jne g5<br />        mov ,4<br />        ret<br />   g5:  cmp ax,32<br />        jne g6<br />        mov ,5<br />        ret<br />   g6:  cmp ax,1<br />        jne gd<br />        mov ,6<br /><br />   gd:  ret<br /><br />getMode:<br />        mov ax,4f03h    ;VBE return the current video mode funtion<br />        int 10h         ;Value will be returned in BX<br />        mov ,bx ;Put current mode in vmode<br />        ret<br /><br />restoreOMode:<br />        mov ax,4f02h<br />        mov bx,<br />        int 10h<br />        ret<br /><br />vmode   dw ?<br />bds     dw ?<br />vesa vesaInfo<br />mode vesaModeInfo<br />CRTC CRTCInfoBlock<br /><br />y       dw ?<br />x       dw ?<br />color   dw ?<br />omode   dw ?            ;older mode<br /><br />bank    dw ?<br />ofs     dw ?<br />bankshift dw ?<br /><br />;---------------------------------------end:VESA.ASM----------------------                      <br />Note:<br />   If you want,tell me how can i calculate a color value.<br /><br />Thanks very much.Manos.</div>
    <div class="meta">Posted on 2002-11-04 11:47:29 by Anonymous</div>
   </div>
   <div class="post" id="post-64681">
    <div class="subject"><a href="#post-64681">calculating colors in 16 bits mode</a></div>
    <div class="body">the mode 114h has 16 bits.<br />bits 0 to 4 - to blue<br />bits 5 to 10 - to green<br />and 11 to 15 - to red<br /><br />the order of bits:<br />RRRRRGGGGGGBBBBB  ; (5:6:5) Note green has 6 bits in mode 114h and all 16 bits mode.<br /><br />in mode 113h for example (15 bits) you have the order:<br />URRRRRGGGGGBBBBB    ; (1:5:5:5) Five bits per color<br /><br />24 bits (8:8:8) and 32 bits are esier to use, you can the value directly in memory without any calculation.<br /><br />Let me remember, I used a function to convert a (8:8:8) 24bits value to convert to 16 bits or 15 bits.<br /><br />pixelw function put a 15 or 16 bit pixel.<br />you'll need other to 24 and 32 bit, other to 8 bit (DAC colors), or 4 bits (16 colors).   <br /><br /><br />assuming you have in data:<br />red db ? <br />blue db ?<br />green db ?<br />color dw ? ;it can be used by 15 and 16 bits. I won't use this in this example.<br /><br />;converting red, green, blue(8:8:8-24bits) to (5:6:5-16bits)<br />m16bits:<br />xor ax,ax    <br />shr ,2  <br />mov ah,<br />shr ax,3<br />and , 11111000b <br />or ah,<br />shr ,3 <br />or al,<br />mov ,ax<br />ret<br /><br />;you must put the values in red, green and blue before calling m16bits.</div>
    <div class="meta">Posted on 2002-11-05 05:56:54 by Despero</div>
   </div>
   <div class="post" id="post-64728">
    <div class="subject"><a href="#post-64728">VESA doubt - .com files</a></div>
    <div class="body">Hello Despero.<br /><br />It works fine.<br /><br />But there is a problem.<br />When i build the above program in MASM,it fails.<br />Also,because i have make a mini OS,when i use the above program as a Kernel,<br />the refresh ratio is OK,but the shape is bad and the CPU not responding <br />in Ctrl+Alt+Del.<br />I don't know why.<br />If you have any idea,tell me.<br /><br />Regards,Manos.</div>
    <div class="meta">Posted on 2002-11-05 12:58:22 by Anonymous</div>
   </div>
   <div class="post" id="post-64787">
    <div class="subject"><a href="#post-64787">VESA doubt - .com files</a></div>
    <div class="body">Did you already try to change 'org 100h' to 'org 7C00h' or 'org 0h'<br /><br />Try putting the same value to cs, ds, es when testing the program as kernel.<br /><br /><br />Ctrl+alt+del: I'm not sure but I used 'int 20h' at the end of my file to exit program. But as you tested the program like a kernel I don't know what happen when 'int 20h' is executed. you can try to use 'hlt' to halt de cpu.<br /><br />I'll look this source in masm to see why it failed.<br /><br />Tell me what happened.<br /><br />Bye.</div>
    <div class="meta">Posted on 2002-11-06 04:30:23 by Despero</div>
   </div>
   <div class="post" id="post-64831">
    <div class="subject"><a href="#post-64831">VESA doubt - .com files</a></div>
    <div class="body">Hello Despero.<br /><br />You are right.<br />If i set 'org 7c00h',is OK,although i take from Linker a warning.<br />Instead of your code, i change the banks in PutPixel procedure.<br />I don't know  whether is faster.Check it if you have the time.<br />Following is my code in MASM.I don't take information of VESA,for simplicity.<br />If press the left button of mouse,paint a rectangle.To exit press 'Esc'.<br />You must press the left button of mouse,otherwise you can not exit.<br />I use mode 103h (800x600x256 colors).<br />-------------My code in MASM:--------------------------<br /><br />.MODEL    TINY<br />.386<br /><br />;-----------------------------<br />CRT struct<br />    HorzTotal  dw ?<br />    HorzStart  dw ?<br />    HorzEnd    dw ?<br />    VertTotal   dw ?<br />    VertStart   dw ?<br />    VertEnd     dw ?<br />    Flags         db ?<br />    PxClock     dd ?<br />    RfrRate     dw ?<br />    Reserv      db 40 dup(?)<br />CRT ends<br />;-----------------------------<br />.DATA?<br />   CrtInf       CRT {}<br />   oldMode      dw ?<br /><br />.DATA<br />   CurrentBank  dd 0<br /><br />.STACK    <br /><br />.CODE<br /><br />org 7c00h<br />;----------------------------------------<br />MAIN     PROC<br /><br />      call GetMode              ;store old mode<br />     <br />      mov CrtInf.HorzTotal,1072<br />      mov CrtInf.HorzStart,848<br />      mov CrtInf.HorzEnd,936<br />      mov CrtInf.VertTotal,636<br />      mov CrtInf.VertStart,601<br />      mov CrtInf.VertEnd,604<br />      mov CrtInf.Flags,0<br />      mov CrtInf.PxClock,57952320<br />      mov CrtInf.RfrRate,8500<br />      call SetMode<br /><br />;------------Fill screen---------------------------<br />      mov bl,3        ;--green color--<br />      xor edx,edx<br />      LoopY:<br />         xor ecx,ecx<br />         LoopX:<br />            call PutPixel<br />            inc ecx<br />            cmp ecx,800<br />            jne LoopX<br />         inc edx<br />         cmp edx,600<br />         jne LoopY<br />;------Paint a rectangle when press the left button of mouse---- <br />;------Note:The mouse does not appear,simply press left button.-    <br />   LOOP2:             <br />      mov ax,3<br />      int 33h         ;Wait for mouse<br />      mov ax,bx<br />      cmp ax,1      ;Left button down<br />      jne LOOP2 <br />;------Paint a rectangle 200x160 pixels-------<br />      mov bl,5      ; another color<br />      xor edx,edx<br />      LoopY1:<br />         xor ecx,ecx<br />         LoopX1:<br />            call PutPixel<br />            inc ecx<br />            cmp ecx,200<br />            jne LoopX1<br />         inc edx<br />         cmp edx,160<br />         jne LoopY1<br />        <br />;-----------------Press Esc to exit-----------------------------<br />  LOOP1:<br /><br />   MOV   AH,8     ;Wait for KeyPress 27 (Esc)<br />   INT   21h<br />   CMP   AL,27<br />   JNE   LOOP1<br /><br />   call RestoreOldMode <br /><br />   MOV   AX,4C00h<br />   INT   21h<br />;-------------------<br />MAIN     ENDP<br />;----------------------------------------<br />PutPixel proc               ;ecx=X ,edx=Y, bl=Color<br />  push eax<br />  push es<br />  push ecx<br />  push edx<br />  push ebx<br />  lea eax,       ;multiply by 5<br />  lea eax,       ;multiply by 5<br />  xor edx,edx               ;prepare for division<br />  mov ebx,dword ptr 65536   ;in VESA each bank have 64Kb<br />  shl eax,5                 ;multiply by 32<br />  add eax,ecx               ;eax=Y+X<br />  div ebx<br />  mov ecx,edx<br />  cmp eax,CurrentBank       ;eax=quotient,edx=remainder<br />  je Lbl<br />  mov CurrentBank,eax       ;new bank<br />  mov dx,ax<br />  mov ax,4f05h                   ;SetBank<br />  xor ebx,ebx<br />  int 10h<br />  Lbl:<br />     pop ebx<br />     mov ax,0A000h<br />     mov es,ax<br />     mov es:,bl <br />     pop edx <br />     pop ecx<br />     pop es<br />     pop eax<br />  ret<br />PutPixel  endp<br />;----------------------------<br />SetMode proc <br />   push ebx<br />   push edi<br />   push es<br />   push ds<br />   mov ax,4f02h<br />   mov bx,103h      ;800x600x256<br />   or bx,0800h<br />   push ds<br />   pop es<br />   mov di,offset CrtInf <br />   int 10h<br />   pop ds<br />   pop es<br />   pop edi<br />   pop ebx<br /><br />   ret<br />SetMode endp<br />;---------------------------<br />GetMode proc<br />        push eax<br />        push ebx<br />        mov ax,4f03h    <br />        int 10h         <br />        mov oldMode,bx <br />        pop ebx<br />        pop eax<br />        ret<br /><br />GetMode endp<br />;---------------------------<br />RestoreOldMode proc<br />        push eax<br />        push ebx<br />        mov ax,4f02h<br />        mov bx,oldMode<br />        int 10h<br />        pop ebx<br />        pop eax<br />        ret            <br /><br />RestoreOldMode endp<br />;---------------------------<br /><br />END      MAIN <br />;------------------------------------------End of code---------------------------------<br />Note:I don't know how calculate the colors in 256 colors.<br />If you know,tell me about pallete.<br /><br />Regards,Manos.</div>
    <div class="meta">Posted on 2002-11-06 12:17:05 by Anonymous</div>
   </div>
   <div class="post" id="post-65056">
    <div class="subject"><a href="#post-65056">VESA doubt - .com files</a></div>
    <div class="body">tip: You can put values in CRT struct, then you won't need to use 'mov' to set the data.<br /><br />like this:<br />struc CRTCInfoBlock<br />    {<br />    .HorizontalTotal             dw 1072   ; Horizontal total in pixels<br />    .HorizontalSyncStart      dw 848     ; Horizontal sync start in pixels<br />    .HorizontalSyncEnd        dw 936     ; Horizontal sync end in pixels<br />    .VerticalTotal                  dw 636     ; Vertical total in lines<br />    .VerticalSyncStart           dw 601     ; Vertical sync start in lines<br />    .VerticalSyncEnd             dw 604    ; Vertical sync end in lines<br />    .Flags                              db 0        ; Flags (Interlaced, Double Scan etc)<br />    .PixelClock                       dd 57952320     ; Pixel clock in units of Hz<br />    .RefreshRate                   dw 8500            ; Refresh rate in units of 0.01 Hz<br /><br />    .Reserved                rb 40 ; remainder of ModeInfoBlock<br />    }  <br />I think this is faster, put it before uninitialized data to not increase the program size.<br /><br /><br />You can use vesa function to set DAC palette:<br /><br />Input: 	AX = 4F08h VBE Set/Get Palette Format<br />	BL = 00h Set DAC Palette Format<br />	   = 01h Get DAC Palette Format<br />	BH = Desired bits of color per primary<br />	     (Set DAC Palette Format only)<br />	     (Default is 6bits(0-63 per color) you can change to 8bits(0-255 p/ color) <br /><br />Output:	AX = VBE Return Status<br />	BH = Current number of bits of color per primary<br /><br />Input: 	AX = 4F09h VBE Load/Unload Palette Data<br />	BL = 00h Set Palette Data<br />	   = 01h Get Palette Data<br />	   = 02h Set Secondary Palette Data<br />	   = 03h Get Secondary Palette Data<br />	   = 80h Set Palette Data during Vertical Retrace<br />	         with Blank Bit on<br />	CX = Number of palette registers to update<br />	DX = First palette register to update<br />	ES:DI = Table of palette values (see below for format)<br /><br />Output:	AX = VBE Return Status<br /><br />Format of Palette Values: Alignment byte, Red byte, Green byte, Blue byte<br /><br />palette structure to use with vesa:<br /><br />;begin<br />struc color<br />    {<br />    .red        db ?<br />    .green      db ?<br />    .blue       db ?<br />    }<br /><br />struc palette<br />    {<br />    .c0        color<br />    .c1        color<br />    .c2        color<br />    .c3        color<br />    .c4        color<br />    .c5        color<br />    .c6        color<br />    .c7        color<br />    .c8        color<br />    .c9        color<br />    .c10       color<br />    .c11       color<br />    .c12       color<br />    .c13       color<br />    .c14       color<br />    .c15       color<br />    .c16       color<br />    .c17       color<br />    .c18       color<br />    .c19       color<br />    .c20       color<br />    .c21       color<br />    .c22       color<br />    .c23       color<br />    .c24       color<br />    .c25       color<br />    .c26       color<br />    .c27       color<br />    .c28       color<br />    .c29       color<br />    .c30       color<br />    .c31       color<br />    .c32       color<br />    .c33       color<br />    .c34       color<br />    .c35       color<br />    .c36       color<br />    .c37       color<br />    .c38       color<br />    .c39       color<br />    .c40       color<br />    .c41       color<br />    .c42       color<br />    .c43       color<br />    .c44       color<br />    .c45       color<br />    .c46       color<br />    .c47       color<br />    .c48       color<br />    .c49       color<br />    .c50       color<br />    .c51       color<br />    .c52       color<br />    .c53       color<br />    .c54       color<br />    .c55       color<br />    .c56       color<br />    .c57       color<br />    .c58       color<br />    .c59       color<br />    .c60       color<br />    .c61       color<br />    .c62       color<br />    .c63       color<br />    .c64       color<br />    .c65       color<br />    .c66       color<br />    .c67       color<br />    .c68       color<br />    .c69       color<br />    .c70       color<br />    .c71       color<br />    .c72       color<br />    .c73       color<br />    .c74       color<br />    .c75       color<br />    .c76       color<br />    .c77       color<br />    .c78       color<br />    .c79       color<br />    .c80       color<br />    .c81       color<br />    .c82       color<br />    .c83       color<br />    .c84       color<br />    .c85       color<br />    .c86       color<br />    .c87       color<br />    .c88       color<br />    .c89       color<br />    .c90       color<br />    .c91       color<br />    .c92       color<br />    .c93       color<br />    .c94       color<br />    .c95       color<br />    .c96       color<br />    .c97       color<br />    .c98       color<br />    .c99       color<br />    .c100      color<br />    .c101      color<br />    .c102      color<br />    .c103      color<br />    .c104      color<br />    .c105      color<br />    .c106      color<br />    .c107      color<br />    .c108      color<br />    .c109      color<br />    .c110      color<br />    .c111      color<br />    .c112      color<br />    .c113      color<br />    .c114      color<br />    .c115      color<br />    .c116      color<br />    .c117      color<br />    .c118      color<br />    .c119      color<br />    .c120      color<br />    .c121      color<br />    .c122      color<br />    .c123      color<br />    .c124      color<br />    .c125      color<br />    .c126      color<br />    .c127      color<br />    .c128      color<br />    .c129      color<br />    .c130      color<br />    .c131      color<br />    .c132      color<br />    .c133      color<br />    .c134      color<br />    .c135      color<br />    .c136      color<br />    .c137      color<br />    .c138      color<br />    .c139      color<br />    .c140      color<br />    .c141      color<br />    .c142      color<br />    .c143      color<br />    .c144      color<br />    .c145      color<br />    .c146      color<br />    .c147      color<br />    .c148      color<br />    .c149      color<br />    .c150      color<br />    .c151      color<br />    .c152      color<br />    .c153      color<br />    .c154      color<br />    .c155      color<br />    .c156      color<br />    .c157      color<br />    .c158      color<br />    .c159      color<br />    .c160      color<br />    .c161      color<br />    .c162      color<br />    .c163      color<br />    .c164      color<br />    .c165      color<br />    .c166      color<br />    .c167      color<br />    .c168      color<br />    .c169      color<br />    .c170      color<br />    .c171      color<br />    .c172      color<br />    .c173      color<br />    .c174      color<br />    .c175      color<br />    .c176      color<br />    .c177      color<br />    .c178      color<br />    .c179      color<br />    .c180      color<br />    .c181      color<br />    .c182      color<br />    .c183      color<br />    .c184      color<br />    .c185      color<br />    .c186      color<br />    .c187      color<br />    .c188      color<br />    .c189      color<br />    .c190      color<br />    .c191      color<br />    .c192      color<br />    .c193      color<br />    .c194      color<br />    .c195      color<br />    .c196      color<br />    .c197      color<br />    .c198      color<br />    .c199      color<br />    .c200      color<br />    .c201      color<br />    .c202      color<br />    .c203      color<br />    .c204      color<br />    .c205      color<br />    .c206      color<br />    .c207      color<br />    .c208      color<br />    .c209      color<br />    .c210      color<br />    .c211      color<br />    .c212      color<br />    .c213      color<br />    .c214      color<br />    .c215      color<br />    .c216      color<br />    .c217      color<br />    .c218      color<br />    .c219      color<br />    .c220      color<br />    .c221      color<br />    .c222      color<br />    .c223      color<br />    .c224      color<br />    .c225      color<br />    .c226      color<br />    .c227      color<br />    .c228      color<br />    .c229      color<br />    .c230      color<br />    .c231      color<br />    .c232      color<br />    .c233      color<br />    .c234      color<br />    .c235      color<br />    .c236      color<br />    .c237      color<br />    .c238      color<br />    .c239      color<br />    .c240      color<br />    .c241      color<br />    .c242      color<br />    .c243      color<br />    .c244      color<br />    .c245      color<br />    .c246      color<br />    .c247      color<br />    .c248      color<br />    .c249      color<br />    .c250      color<br />    .c251      color<br />    .c252      color<br />    .c253      color<br />    .c254      color<br />    .c255      color<br />    }<br />;end palett structure<br /><br /><br />or:<br /><br />You can write to the palette, first you send a byte to port 3c8h telling it which color you want to change. Then, it takes the next 3 values at port 3c9h. So you just INCed dx. The 3 values you give it are the amounts of red, green, and blue your new color will contain. Each one has a value from 0 to 63. Giving it 3 0's would result in black, and at the opposite extreme, 3 63's results in pure white. <br /><br />code:<br />mov dx,03c8h ;putting the port value in dx<br />mov al,0     ;putting the color you want to change<br />out dx,ax    ;sending to port the color<br />inc dx	     ;changing the port to 3c9h yo send RGB values<br />mov al,63    ;red value<br />out dx,ax    <br />mov al,0     ;green value<br />out dx,al<br />mov al,0     ;blue value<br />out dx,al	<br /><br />;This will change the black, color 0, to red.<br />;Color index increments automatically, so if you send more values to port 3c9h you'll change the<br />;next color.</div>
    <div class="meta">Posted on 2002-11-08 08:58:21 by Despero</div>
   </div>
   <div class="post" id="post-65073">
    <div class="subject"><a href="#post-65073">VESA doubt - .com files</a></div>
    <div class="body">Hello Despero.<br /><br />I'll try your exambles.<br /><br />Thanks,Manos.</div>
    <div class="meta">Posted on 2002-11-08 12:01:11 by Anonymous</div>
   </div>
   <div class="post" id="post-65254">
    <div class="subject"><a href="#post-65254">VESA doubt - .com files</a></div>
    <div class="body">Hello Despero.<br /><br />I have understand you code.<br />I don't want put values in CRT struct,because i use the CRT struct<br />in more than one modes and each member of this struct have different value<br />in differends modes.<br />Now,i try to handler the mouse,without DOS.But,without DOS the INT 33h does not works.<br />I need the Video Cursor Interface (VCI) of VESA,but i can't find this.<br />If you have an idea,tell me.<br /><br />Regards,Manos.</div>
    <div class="meta">Posted on 2002-11-10 07:07:38 by Anonymous</div>
   </div>
   <div class="post" id="post-65302">
    <div class="subject"><a href="#post-65302">VESA doubt - .com files</a></div>
    <div class="body">Hello Manos,<br />I don't know about VCI of VESA.<br /><br />about mouse, I think you can read about 'INT 0Ch'<br />text from 'Ralf Brow Interrupt list' about 'INT 0Ch':<br /><br />Inp.:<br />Desc:	automatically asserted by the UART when COM1 needs attention, if the<br />                UART has been programmed to generate interrupts<br />BUG:	this vector is modified but not restored by Direct Access v4.0, and<br />	may be left dangling by other programs written with the same version<br />	of compiled BASIC<br />Notes:	on many PC's, COM3 shares this interrupt<br />	may be masked by setting bit 4 on I/O port 21h<br /><br />Copied from Ralf Brown's Interrupt List<br /><br />and you can read about port 3f8 too:<br /><br />you can find some helpfull documents in this site: 'http://www.autistici.org/itassembly/' <br />see 'documenti vari' in main menu.<br /><br />regards.</div>
    <div class="meta">Posted on 2002-11-10 19:08:13 by Despero</div>
   </div>
   <div class="post" id="post-65909">
    <div class="subject"><a href="#post-65909">VESA doubt - .com files</a></div>
    <div class="body">Hi Despero.<br /><br />I have copied Interrupt List from Ralf Brown's.<br />I interest for INT 15,function 0C2h.<br />But i can not do anything.<br />If you know about this,tell me.<br /><br />Thanks,Manos.</div>
    <div class="meta">Posted on 2002-11-15 09:31:52 by Anonymous</div>
   </div>
   <div class="post" id="post-65954">
    <div class="subject"><a href="#post-65954">VESA doubt - .com files</a></div>
    <div class="body">hello, Manos!<br /><br />I don't know about mouse!<br />Maybe you could to start a new thead!<br /><br />Did you try to initialize with 'int 15h' and with  function '0c205h'<br />and try to intall a handler with '0c207h' <br />before to use '0c200h'?</div>
    <div class="meta">Posted on 2002-11-15 19:25:38 by Despero</div>
   </div>
   <div class="post" id="post-76314">
    <div class="subject"><a href="#post-76314">VESA doubt - .com files</a></div>
    <div class="body">Hello Despero.<br /><br />Can you tell me,if you know,how can i write characters on screen <br />using graphics mode,i.e mode 103h ,with fasm ?<br /><br />Regards,Manos.</div>
    <div class="meta">Posted on 2003-01-14 14:40:13 by Anonymous</div>
   </div>
   <div class="post" id="post-76349">
    <div class="subject"><a href="#post-76349">VESA doubt - .com files</a></div>
    <div class="body">Hello Manos!<br /><br />You can use video interrupt to write characters at screen,<br />but you need to test if the video mode you choose support this function.<br />Regarding the code I used in this thread I used this to test:<br /><br />; begin - write 'A' 5 times at screen<br /> <br />        mov ax, ;the bit D2 tell if it's possible to use some video interrupt functions<br /><br />        and ax,100b ;test bit D0<br /><br />	jz withoutext ; if bit is not set the video mode doesn't support 'int 10h'<br /><br />        mov ah,09h ; video function to write chars at cursor position<br />        mov al,65  ; 65 = A	<br />        mov bh,0   ; page 0<br />        mov bl,2   ; green color<br />        mov cx,5   ; repeat 5 times<br />        int 10h    <br />    withoutext:<br /><br />;end<br /><br />I tested this code in some video modes, all 256 color mode support to write using 'int 10h', but the 15bits and 16bits video mode doesn't support.<br />I didn't test in 24bits or 32bits video mode.<br /><br />I think if you want to use some true type font you'll need to create a procedure to do it!<br /><br />Regards, Despero</div>
    <div class="meta">Posted on 2003-01-14 17:24:14 by Despero</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=8228&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=8228&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="8228" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=8228&amp;page=2">&gt;</a><a href="../?id=8228&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>