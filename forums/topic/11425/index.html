<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Using LOCAL without stack frames..... - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=11425" />
    <link rel="next" href="../?id=11425&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=11425">Using LOCAL without stack frames.....</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=11425&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=11425&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="11425" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=11425&amp;page=2">&gt;</a><a href="../?id=11425&amp;page=2">&raquo;</a></form>   <div class="post" id="post-86381">
    <div class="subject"><a href="#post-86381">Using LOCAL without stack frames.....</a></div>
    <div class="body">I found this thread which says it can't be done:<br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=6356&amp;highlight=local">http://www.asmcommunity.net/board/index.php?topic=6356&amp;highlight=local</a> <br /><br />Perhaps it is &quot;should not be done&quot;.  If so why?<br /><pre><code><br />	OPTION PROLOGUE&#58;NONE<br />	OPTION EPILOGUE&#58;NONE<br /><br />_TEXT SEGMENT<br />FramelessProc PROC PUBLIC parm1&#58;PTR DWORD,parm2&#58;PTR DWORD<br />local foo&#58;dword<br />local bar&#58;dword<br />align 4	<br />	mov eax,&#91;foo&#93;<br />	mov &#91;bar&#93;,edi<br />		<br />	ret 8<br />FramelessProc endp<br />_TEXT ENDS<br />	<br />	OPTION PROLOGUE&#58;PROLOGUEDEF<br />	OPTION EPILOGUE&#58;EPILOGUEDEF<br /></code></pre><br />This works:<br /><pre><code><br />	mov eax,&#91;foo&#93;<br />0040100B 8B 45 90         mov         eax,dword ptr &#91;foo&#93; <br />	mov &#91;bar&#93;,edi<br />0040100E 89 7D 8C         mov         dword ptr &#91;bar&#93;,edi <br /></code></pre><br />The address of both foo and bar are in stack space.   I also check against proc with stack frames and the code looks the same.<br /><br />So whats the deal?<br /><br />Thanks.</div>
    <div class="meta">Posted on 2003-03-10 21:43:05 by ThoughtCriminal</div>
   </div>
   <div class="post" id="post-86389">
    <div class="subject"><a href="#post-86389">Using LOCAL without stack frames.....</a></div>
    <div class="body">iirc LOCALs are addressed as negative offsets from ebp, which after a stack frame entry has been set up for you like so:<br /><br /><pre><code>&#91;size=12&#93;  push ebp<br />  mov  ebp, esp<br />  sub  esp, 8&#91;/size&#93;</code></pre><br /><br />bar and foo are  and  but without a stack frame ebp could be anything.</div>
    <div class="meta">Posted on 2003-03-10 22:44:27 by iblis</div>
   </div>
   <div class="post" id="post-86395">
    <div class="subject"><a href="#post-86395">Using LOCAL without stack frames.....</a></div>
    <div class="body">i think i understand good this, but if the vars.. local and the other are not (maybe not) have a good direction or address from ebp, how you can deal with a local var??, you say manually, but how??, is more fast or what against ebp-4 .. etc with the respective stack frame??<br /><br />and what is more fast:<br />enter o,o i think this is only one opcode<br /><br />or <br /><br />push ebp<br />  mov  ebp, esp ;two opcodes and some thiks. of micro?? or what<br /><br /><br /><br />manually i think with normal pushes and pops?? or substracting manually to the esp???? and then you call like ebp-some ??<br /><br />sorry, but i need know :)</div>
    <div class="meta">Posted on 2003-03-10 23:59:49 by rea</div>
   </div>
   <div class="post" id="post-86397">
    <div class="subject"><a href="#post-86397">Using LOCAL without stack frames.....</a></div>
    <div class="body"><strong>hgb</strong>, on new processors it is faster to adjust the stack and then use MOV instruction:<br /><br />sub esp, 16<br />nop<br />mov , eax<br />mov , ebx<br />mov , ecx<br />mov , edx</div>
    <div class="meta">Posted on 2003-03-11 00:07:28 by bitRAKE</div>
   </div>
   <div class="post" id="post-86399">
    <div class="subject"><a href="#post-86399">thx</a></div>
    <div class="body">then i need to work carefully by this way, if i add a push for example after i setup &quot;the locals vars&quot;, then this push is gonna make me refer uncorrectly to the locals if i try refer to they..<br /><br />i supose like this<br /><br />mov , eax<br />mov , ebx<br />mov , ecx<br />mov , edx<br />push esi<br />;some operations, but add 4 more to the others varsnow the bar  need be esp+4.. etc<br />pop esi<br /><br /><br />and now a new questions, then is a good exchange &quot;kill&quot; the use of push?? and pop?? instead use mov (if you know how to add and how many to substract to the stack??<br /><br />if is yes, in what caes is best push pop against mov.. also, i have another thing, i know for load the efective addres of for example a variable in ebp-4 also i use (this is with a stack frame):<br /><br />lea eax, <br /><br />but if i know the size i can code to (to avoid the use of lea)<br /><br />mov eax, ebp<br />sub eax, some ;in this case some is 4<br />what is more fast the lea, or the mov eax, ebp and th sub??<br /><br />and &quot;translated to without stack frame&quot; i think is some near equal instead lea:<br /><br />mov eax, esp<br />add esp, some ;4 or other<br /><br />*added :D<br /><br /><strong>only a thing, some or the variable i refer like some is definied by a macro, then is a direct number i know, no is a var in data or some, then<br />add eax, some is translated to add eax, 4 (in this case) and equal for sub eax, some</strong><br /><br />in advance thanks<br /><br />have a nice day.</div>
    <div class="meta">Posted on 2003-03-11 00:32:53 by rea</div>
   </div>
   <div class="post" id="post-86407">
    <div class="subject"><a href="#post-86407">Using LOCAL without stack frames.....</a></div>
    <div class="body">It can work with ebp, but you have to be careful.<br /><br /><pre><code><br />WinMainCRTStartup label dword<br />align 4<br />COLOR=red&#93;esp = 12FFC4&#91;/COLOR&#93;<br />        <br />invoke GetModuleHandle, NULL &#91;004011C2 6A 00            push        0    <br />004011C4 FF 15 18 30 40 00 call        dword ptr &#91;__imp__GetModuleHandleA@4 &#40;403018h&#41;&#93; <br />	mov    hInstance,eax<br />004011CA A3 19 60 40 00   mov         dword ptr &#91;hInstance &#40;406019h&#41;&#93;,eax <br />	invoke main,eax,NULL,SW_SHOWDEFAULT &#91;COLOR=red&#93;call our main&#91;/COLOR&#93;<br />004011CF 6A 0A            push        0Ah  <br />004011D1 6A 00            push        0    <br />004011D3 50               push        eax  <br />004011D4 E8 07 00 00 00   call        main &#40;4011E0h&#41; <br />	invoke ExitProcess,eax<br />004011D9 50               push        eax  <br />004011DA FF 15 1C 30 40 00 call        dword ptr &#91;__imp__ExitProcess@4 &#40;40301Ch&#41;&#93; <br /><br />main proc hInst&#58;HINSTANCE,hPrevInst&#58;HINSTANCE,CmdShow&#58;DWORD<br />004011E0 55               push        ebp  &#91;COLOR=red&#93;esp = 12FFB4&#91;/COLOR&#93;<br />004011E1 8B EC            mov         ebp,esp &#91;COLOR=red&#93;esp = 12FFB0&#91;/COLOR&#93;<br />004011E3 83 C4 A0         add         esp,0FFFFFFA0h &#91;COLOR=blue&#93;get locals from value of ebp&#91;/COLOR&#93;<br />	LOCAL msg&#58;MSG<br />	LOCAL rect&#58;RECT<br />	LOCAL hwnd&#58;HWND<br />	LOCAL wc&#58;WNDCLASSEX<br /><br />	mov   wc.cbSize,SIZEOF WNDCLASSEX<br /></code></pre><br />ebp need ot be preseverd and the stack needs to be balanced.<br /><br />Now in our frameless proc:<br /><pre><code><br />	invoke FramelessProc, parm1,parm2 &#91;COLOR=red&#93;esp = 12FF50,ebp = 12FFB0&#91;/COLOR&#93;<br />&#91;COLOR=red&#93;esp != 12FFC4 because this was called from the main proc, so the local defined in main still exist on the stack&#91;/COLOR&#93;<br /><br />FramelessProc PROC PUBLIC parm1&#58;PTR DWORD,parm2&#58;PTR DWORD<br />local dummy&#91;27&#93;&#58;dword&#91;COLOR=red&#93; adjust ebp local offset to esp-4&#91;/COLOR&#93;<br />local foo&#58;DWORD&#91;COLOR=red&#93; allocare a dword on the stack&#91;/COLOR&#93;<br />local bar&#58;CHR&#91;COLOR=red&#93; allocate a structure on the stack&#91;/COLOR&#93;<br />align 4	<br /><br />	mov eax,&#91;foo&#93;&#91;COLOR=red&#93; DWORDs always use mov, even with a stack frame&#91;/COLOR&#93;<br />0040100B 8B 45 90         mov         eax,dword ptr &#91;foo&#93; <br />	mov dword ptr&#91;bar.Char&#93;,edi&#91;COLOR=red&#93; but STRUCTs always use an offset from ebp&#91;/COLOR&#93;<br />0040100E 89 7D 84         mov         dword ptr &#91;ebp-7Ch&#93;,edi &#91;COLOR=red&#93;ebp = 12FFB0&#91;/COLOR&#93;<br />		<br />	ret 8<br />FramelessProc  endp<br /></code></pre><br />This is a little more complicated than if my main was also frameless.<br />ebp should be preserved.<br />No code is genertated, unlike with a stack frame.  The fixups are all done at assemble or link time.<br />If you want DWORD local to work off of ebp, make a dword STRUCT.<br />local dummy[-1] will work.  The local macro only seems to set up offsets from ebp.<br />I'm not really sure why you would want to do this when  work fine.<br /><br />Thanks.</div>
    <div class="meta">Posted on 2003-03-11 02:00:27 by ThoughtCriminal</div>
   </div>
   <div class="post" id="post-86537">
    <div class="subject"><a href="#post-86537">Using LOCAL without stack frames.....</a></div>
    <div class="body"><div class="quote">sub esp, 16<br />nop<br />mov , eax<br />mov , ebx<br />mov , ecx<br />mov , edx</div><br /><br />bitRAKE - that 'nop' has been bothering me since I saw it hours ago<br /><br />I've read enough of your posts to doubt that you put it there for fun:) <br /><br />I'm pretty sure I've run similar code without the 'nop' on P2 &amp; P3 without problems but I'd appreciate clarification<br /><br />Regards<br />eGo</div>
    <div class="meta">Posted on 2003-03-11 13:22:39 by eGo</div>
   </div>
   <div class="post" id="post-86540">
    <div class="subject"><a href="#post-86540">Using LOCAL without stack frames.....</a></div>
    <div class="body"><strong>eGo</strong>, I only mean that another instruction should be placed where the NOP is to remove forward dependancies.  It is only a NOP in so far as it does not use ESP.</div>
    <div class="meta">Posted on 2003-03-11 13:48:43 by bitRAKE</div>
   </div>
   <div class="post" id="post-86541">
    <div class="subject"><a href="#post-86541">Using LOCAL without stack frames.....</a></div>
    <div class="body">MASM can't automatically use esp for locals as esp can change throughout the routine, while ebp will stay the same.<br />It's possible to automate some things with macros but there are some things you need to watch out for, not everything can be automated..<br /><br />Thomas<br /><br /><span style="font-size:9px>Psstt.. actually I'm writing an article about creating your own stackframe to free ebp for other uses (an extra register is great when optimizing a proc), it's partly done already but I'm still thinking about the best ways to create the macros for it.</span></div>
    <div class="meta">Posted on 2003-03-11 13:48:48 by Thomas</div>
   </div>
   <div class="post" id="post-86546">
    <div class="subject"><a href="#post-86546">Using LOCAL without stack frames.....</a></div>
    <div class="body">One way to not use EBP is to have a global variable for each PROC that defines the stack depth within the PROC:<pre><code>	OPTION PROLOGUE&#58;NONE<br />	OPTION EPILOGUE&#58;NONE<br /><br /><br />_push MACRO var&#58;REQ, nam&#58;=&lt;&gt;<br />	push	var<br /><br />	Test123_DEPTH = Test123_DEPTH + 4<br /><br />	IFNB &lt;nam&gt;<br />		&amp;nam CATSTR &lt;&#91;esp&#93;&#91;Test123_DEPTH&#93;&#91;&gt;, %&#40;-Test123_DEPTH&#41;, &lt;&#93;&gt;<br />	ENDIF<br />ENDM<br /><br />Test123_DEPTH = 0<br /><br />Test123 PROC A_&#58;DWORD, B_&#58;DWORD, C_&#58;DWORD<br />	_A	EQU &lt;&#91;esp + 4*1 + Test123_DEPTH&#93;&gt;<br />	_B	EQU &lt;&#91;esp + 4*2 + Test123_DEPTH&#93;&gt;<br />	_C	EQU &lt;&#91;esp + 4*3 + Test123_DEPTH&#93;&gt;<br /><br /><br />	mov	eax, _A<br />	_push	eax, _D ; give it a name, too &#58;&#41;<br />	_push	eax, _E<br />	_push	eax, _F<br />	_push	eax, _G<br />	_push	eax, _H<br /><br />	mov	eax, _A<br /><br />	mov	ecx, _D<br />	mov	ecx, _E<br />	mov	ecx, _F<br />	mov	ecx, _G<br />	mov	ecx, _H<br /><br />	add	esp, Test123_DEPTH<br />	ret	12<br />Test123 ENDP</code></pre>If you create a custom EPILOGUE/PROLOUE then the _push/_pop/etc... macros can be adjusted automatically and the %PROC%_DEPTH variable can be created automatically.  Look at this in a debugger and you'll see that the expected code is generated!</div>
    <div class="meta">Posted on 2003-03-11 14:26:32 by bitRAKE</div>
   </div>
   <div class="post" id="post-86551">
    <div class="subject"><a href="#post-86551">Using LOCAL without stack frames.....</a></div>
    <div class="body">bitRAKE: <br />These are the kind of macros I'm working on. I've looked into custom pro/epilogue macros but I don't think they are very useful for esp-based frames since you still can't use locals or parameters declared in masm directly, so you end up doing everything twice, once for masm (which feeds the right parameters to the pro/epilogue macros so you can calculate the Test123_DEPTH) and again to automatically declare constants like you did manually (_A, _B, _C etc.). You can't deduce _A, _B etc. from the parameter names since they are not passed to the macros.<br />So my macros will not use an pro/epilogue macro (just 'none' like you used), I'm thinking about a wrapper around the proc statement so you won't have to declare the parameters twice (once for masm and once for the macros).<br /><br />Besides, there's more to it than replacing push and pop with the right macros, although it depends on the complexity of the function. For example, conditional pushes will be counted wrong, since the assembler always evaluates the macro statements, but at execution time, the push might not execute. It also assumes the flow of execution is the same as the flow of the source code (top to bottom). You can't use invoke either since every parameter push modifies the stack. But a _push macro is always handy, just use it with care. <br /><br />Esp-stack frames aren't hard but you have to know what you're doing, I will explain this all in my article.<br /><br />Thomas</div>
    <div class="meta">Posted on 2003-03-11 15:04:04 by Thomas</div>
   </div>
   <div class="post" id="post-86552">
    <div class="subject"><a href="#post-86552">Using LOCAL without stack frames.....</a></div>
    <div class="body">The parameters can be passed to the PROLOGUE macro, but like you said, must do everything twice:<pre><code><br />Test123 PROC &lt;_A, _B, _C&gt;, A_&#58;DWORD, B_&#58;DWORD, C_&#58;DWORD<br />Test123 ENDP</code></pre></div>
    <div class="meta">Posted on 2003-03-11 15:11:18 by bitRAKE</div>
   </div>
   <div class="post" id="post-86555">
    <div class="subject"><a href="#post-86555">Using LOCAL without stack frames.....</a></div>
    <div class="body">That doesn't look very pretty :) But a wrapper is easily made. I also find out MASM aligns locals to its own size (up to dwords of course since quadword alignment of the stack is not guaranteed). The macros I'm creating should be able to do this too, maybe even take custom alignment values, sometimes alignment of quadwords or data on cache lines can be useful. Of course for alignment &gt; 4 bytes a dynamic adjustment is needed, depending on the value of esp on function entry.<br /><br />Thomas</div>
    <div class="meta">Posted on 2003-03-11 15:23:11 by Thomas</div>
   </div>
   <div class="post" id="post-86568">
    <div class="subject"><a href="#post-86568">Using LOCAL without stack frames.....</a></div>
    <div class="body"><div class="quote"><br />That doesn't look very pretty</div>True, but it reduces the above code to:<pre><code>Test123 PROC &lt;_A, _B, _C&gt;, A_&#58;DWORD, B_&#58;DWORD, C_&#58;DWORD<br /><br />	mov	eax, _A<br />	_push	eax, _D ; give it a name, too <br />	_push	eax, _E<br />	_push	eax, _F<br />	_push	eax, _G<br />	_push	eax, _H<br /><br />	mov	eax, _A<br /><br />	mov	ecx, _D<br />	mov	ecx, _E<br />	mov	ecx, _F<br />	mov	ecx, _G<br />	mov	ecx, _H<br /><br />	ret<br />Test123 ENDP</code></pre></div>
    <div class="meta">Posted on 2003-03-11 15:53:25 by bitRAKE</div>
   </div>
   <div class="post" id="post-86640">
    <div class="subject"><a href="#post-86640">Using LOCAL without stack frames.....</a></div>
    <div class="body"><div class="quote"><br />MASM can't automatically use esp for locals as esp can change throughout the routine, while ebp will stay the same.<br />It's possible to automate some things with macros but there are some things you need to watch out for, not everything can be automated..<br /><br />Thomas<br /></div></strong><br /><br />I agree totally with what you said.<br /><br />If you want to use LOCAL with frameless proc, it would be best if ALL procs used were frameless.  Then ebp should remian a constant.  It is easier than doing the fixup (LOCAL dummy[27]), because a stack frame was used in another proc.  Using LOCALS in a frameless proc can be done, but I regard it as a curiosity.  Using esp is easier IMHO.<br /><br /><div class="quote"><strong><br /><span style="font-size:9px>Psstt.. actually I'm writing an article about creating your own stackframe to free ebp for other uses (an extra register is great when optimizing a proc), it's partly done already but I'm still thinking about the best ways to create the macros for it.</span> </div><br /><br />I'm interrested to see what you write.  I use esp as a stack frame all the time.  I'm curious why you would need a macro for it.  I don't use macros at all.   Here is how I do it:(Got this idea from looking at asm dumps from C++ code)<br /><pre><code><br />.686p<br />.model flat,stdcall<br />option casemap&#58;none<br />option dotname<br /><br />	LclHeapAlloc proto &#58;PTR DWORD,&#58;PTR DWORD<br />	fix$ = 8<br />	<br />	OPTION PROLOGUE&#58;NONE<br />	OPTION EPILOGUE&#58;NONE<br />	<br />;-------------------------------------------------------------------------------<br />;Allocates space on the heap<br />;-------------------------------------------------------------------------------<br /><br />_heapstruc$ = 4				;//Address of the heap description stucture<br />	.HeapBase = 0<br />	.HeapTop = 4		<br />	.HeapPtrPre = 8<br />	.HeapPtrCur = 12<br />	.HeapPtrNxt = 16<br /><br />_allocsize$ = 8				;//Size of allocation to make<br /><br />_TEXT SEGMENT<br />LclHeapAlloc PROC PUBLIC heapstruc$&#58;PTR DWORD,allocsize$&#58;PTR DWORD<br />align 4	<br />	nop<br />	mov eax,_heapstruc$&#91;esp&#93;<br />	mov edx,&#91;eax+.HeapPtrCur&#93;<br />	mov &#91;eax+.HeapPtrPre&#93;,edx<br />	mov edi,_allocsize$&#91;esp&#93;<br />	<br />	lea edx,&#91;edx+edi+4&#93;<br />	mov &#91;eax+.HeapPtrCur&#93;,edx<br />		<br />	ret fix$<br />LclHeapAlloc endp<br />_TEXT ENDS<br />	<br />	OPTION PROLOGUE&#58;PROLOGUEDEF<br />	OPTION EPILOGUE&#58;EPILOGUEDEF<br />	<br />end	<br /></code></pre><br />I just use a bunch of numeric equates with $ at the end of a stack variable and . before a structure member.</div>
    <div class="meta">Posted on 2003-03-12 01:05:25 by ThoughtCriminal</div>
   </div>
   <div class="post" id="post-86646">
    <div class="subject"><a href="#post-86646">Using LOCAL without stack frames.....</a></div>
    <div class="body"><div class="quote"><em>Originally posted by ThoughtCriminal </em><br />If you want to use LOCAL with frameless proc, it would be best if ALL procs used were frameless.  Then ebp should remian a constant.  It is easier than doing the fixup (LOCAL dummy[27]), because a stack frame was used in another proc.  Using LOCALS in a frameless proc can be done, but I regard it as a curiosity.  Using esp is easier IMHO.</div><br />I don' t really get what your saying here.. Why should ebp remain constant? Locals are not a curiosity for me. For example, my PNGlib has one very big function to decode the image data. I used an esp-stack frame (with some fixup constants like bitRAKE used too) so I could use the ebp register (I was very short on registers) but I still needed quite some data for lookup tables and other values that were less often used, but required nonetheless. Those data were put in locals.<br /><br /><div class="quote">I'm interrested to see what you write.  I use esp as a stack frame all the time.  I'm curious why you would need a macro for it.  I don't use macros at all.   Here is how I do it:(Got this idea from looking at asm dumps from C++ code)<br /><pre><code><br />.686p<br />.model flat,stdcall<br />option casemap&#58;none<br />option dotname<br /><br />	LclHeapAlloc proto &#58;PTR DWORD,&#58;PTR DWORD<br />	fix$ = 8<br />	<br />	OPTION PROLOGUE&#58;NONE<br />	OPTION EPILOGUE&#58;NONE<br />	<br />;-------------------------------------------------------------------------------<br />;Allocates space on the heap<br />;-------------------------------------------------------------------------------<br /><br />_heapstruc$ = 4				;//Address of the heap description stucture<br />	.HeapBase = 0<br />	.HeapTop = 4		<br />	.HeapPtrPre = 8<br />	.HeapPtrCur = 12<br />	.HeapPtrNxt = 16<br /><br />_allocsize$ = 8				;//Size of allocation to make<br /><br />_TEXT SEGMENT<br />LclHeapAlloc PROC PUBLIC heapstruc$&#58;PTR DWORD,allocsize$&#58;PTR DWORD<br />align 4	<br />	nop<br />	mov eax,_heapstruc$&#91;esp&#93;<br />	mov edx,&#91;eax+.HeapPtrCur&#93;<br />	mov &#91;eax+.HeapPtrPre&#93;,edx<br />	mov edi,_allocsize$&#91;esp&#93;<br />	<br />	lea edx,&#91;edx+edi+4&#93;<br />	mov &#91;eax+.HeapPtrCur&#93;,edx<br />		<br />	ret fix$<br />LclHeapAlloc endp<br />_TEXT ENDS<br />	<br />	OPTION PROLOGUE&#58;PROLOGUEDEF<br />	OPTION EPILOGUE&#58;EPILOGUEDEF<br />	<br />end	<br /></code></pre><br />I just use a bunch of numeric equates with $ at the end of a stack variable and . before a structure member. </div><br />Well for such a simple proc you don't need macros, but what happens if you push something onto the stack? You will need to adjust all following references to parameters by +4. If you don't use macros for this you'll have to do it manually, and each time you change the stack somewhere you need to adjust all the references after it again. This doesn't matter in a 10 line proc (although it easily causes errors) but it surely does in a 300 line one. <br /><br />Thomas</div>
    <div class="meta">Posted on 2003-03-12 01:40:09 by Thomas</div>
   </div>
   <div class="post" id="post-86652">
    <div class="subject"><a href="#post-86652">Using LOCAL without stack frames.....</a></div>
    <div class="body"><div class="quote"><br /><br />I don' t really get what your saying here.. Why should ebp remain constant? Locals are not a curiosity for me. For example, my PNGlib has one very big function to decode the image data. I used an esp-stack frame (with some fixup constants like bitRAKE used too) so I could use the ebp register (I was very short on registers) but I still needed quite some data for lookup tables and other values that were less often used, but required nonetheless. Those data were put in locals.<br /></div><br />Only if you want to use the LOCAL marco with a proc that have no stack frame.  I had to use LOCAL dummy[27] to move the ebp offset to the right place on the stack, because I still had the locals from my main proc in scope(	LOCAL wc:WNDCLASSEX...etc.).  If you have stack a stack frame the code is generated to adjust ebp to the right place.  It just a suggestion really, that if one wants to use LOCAL with no stack frame proc, it would be cleaner to use no procs with a stack frame.  Then you dont have to do hacky stuff like LOCAL dummy[27] to adjust thing.  It neat to know that this can be done, but I think I will stay with using .<br /><br /><div class="quote"><br /><strong><br />Well for such a simple proc you don't need macros, but what happens if you push something onto the stack? You will need to adjust all following references to parameters by +4. If you don't use macros for this you'll have to do it manually, and each time you change the stack somewhere you need to adjust all the references after it again. This doesn't matter in a 10 line proc (although it easily causes errors) but it surely does in a 300 line one. <br /><br />Thomas </div><br />Good point.  I try to keep thing small and simple so that I dont have to push and pop in the middle of a proc to often.  I'm not sure of any non-hacky way to do that just yet without macros.  Looking forward to your article.  I've stayed away from macros, but this does interest me.<br /><br />Thanks.</div>
    <div class="meta">Posted on 2003-03-12 02:47:44 by ThoughtCriminal</div>
   </div>
   <div class="post" id="post-86660">
    <div class="subject"><a href="#post-86660">Using LOCAL without stack frames.....</a></div>
    <div class="body"><strong></strong><br />In the past there was some discussion about stacks and all here:<br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=5214">http://www.asmcommunity.net/board/index.php?topic=5214</a></div>
    <div class="meta">Posted on 2003-03-12 04:03:27 by Maverick</div>
   </div>
   <div class="post" id="post-86676">
    <div class="subject"><a href="#post-86676">hi</a></div>
    <div class="body">in this moment i am reading the other post, but with the little idea that in the first day i get, in that day i modificate my macro (in nasm) and yea, it looks very similar to the macro that put privalov, also i only check if are in the context of the funct or not, if not, i dont need add deed in stack, also, with calls (that use push) i sub the total params to the variable, i dont wanna a mistake.. for the pop that dont are placed there, for example a call hola, uno, dos, tres, cuatro it will be 4 push and the variable tjhat old the deep will be added 4 more, but i in the macro of call i take the carefully to see that that the value of the &quot;deep&quot; variable dont get alterations<br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=11316">macro i coded</a> <br /><div class="quote"><br />stdp = 0 ; stack depth variable<br /><br />macro push arg<br /> { push arg<br />    stdp = stdp+1 }<br /><br />macro pop arg<br /> { pop arg<br />    stdp = stdp-1 }<br /><br /></div> <br />looks similar, but nowt are equals, the start idea is the same, also the macro that have nguga in his package is not the same i have in my own, later when i can code correcltiy (and test) done i will update for nguga ;)<br /><br /><br /><br />also i think it can work best, i am adding some things, and yea it can be done automatically, also i need requestion, what is more fast refering to the lea.. and the stack<br /><br />in nasm dont need the use of addr or offset for know dirs or easy directions, but also, i cant push a ebp-4 this is not a really efective address, if i know how many is the size, then what is more fast??<br /><br /><br />with stack frame<br /><br />lea eax, <br /><br />or<br /><br />mov eax, ebp<br />sub eax, 8<br /><br />using the esp<br /><br />lea eax, <br /><br />or<br /><br />mov eax, esp<br />add eax, 8<br /><br />at the end if you understand eax will have the same value with the lea and with the combination of the mov (betwen two registers) and a sub (to a register with a inmediate value)<br /><br />also i think, the macro i code, now have more adventage, also i recoded the macro called CONST in the nagoa package, and i get 1  instructions less (one jump), but the size of the exe are nearly equals :D<br /><br />also i need requestion, is right use less pops and pushes??, instead i will use mov???<br /><br />for example, i can make a macro for calls that dont use push, also i know how i think :D and use only movs instead, this will be more fast???<br /><br />call hola, uno, dos, tres, cautro<br /><br />will be i think<br />mov dword, cuatro<br />mov dword, tres<br />mov dword, dos<br />mov dword, uno<br />mov dword, eip ;lol, you understand what i am saying :D (how is the best way for obtain the eip???<br />jmp hola ;call :D jua jua<br /><br />and in the funct you can get for example<br />funct hola, uno, dos, tres, cautro ;start with esp+20<br />local some,4 ;a handle in ebp+24 and can use sizef :D<br />endfunct<br /><br /><br />also a end thing, the use of the stack frames is not only for locals, also ahve the adventaje for the trace of functions calls, with the use of esp i think you can't get the same use and lost this capacity..</div>
    <div class="meta">Posted on 2003-03-12 07:20:51 by rea</div>
   </div>
   <div class="post" id="post-86680">
    <div class="subject"><a href="#post-86680">Using LOCAL without stack frames.....</a></div>
    <div class="body"><strong>hgb</strong>, the best way to get EIP is with CALL. LOL :)</div>
    <div class="meta">Posted on 2003-03-12 07:34:02 by bitRAKE</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=11425&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=11425&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="11425" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=11425&amp;page=2">&gt;</a><a href="../?id=11425&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>