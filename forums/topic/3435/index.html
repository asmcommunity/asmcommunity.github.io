<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Consensus using SSE/SSE2 in assembler? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=3435" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=3435">Consensus using SSE/SSE2 in assembler?</a></p>
   <div class="post" id="post-22761">
    <div class="subject"><a href="#post-22761">Consensus using SSE/SSE2 in assembler?</a></div>
    <div class="body">My assembler, GoAsm, is currently at beta stage but I want to add SSE and SSE2 instructions soon.  Also to my debugger GoBug.  I wondered if a consensus has yet been reached amongst assembler programmers as to the best syntax to use with these instructions?  <br />In particular, when declaring data in a 128bit hex chunk, is it better to declare DO (meaning &quot;OctoWord&quot;, which I believe is favoured by Microsoft and Rene's Spasm) or DX (which I believe is favoured by the authors of NASM) or DQWORD (in FASM) or maybe DS (sixteen bytes)?<br />Also what is the best syntax for writing the branch hint in SSE2?  This adds a prefix byte 2Eh or 3Eh to the jxx opcodes to direct the processor whether or not to cache the destination of the conditional jump.  Possibilities are pnt (prediction not taken) or ptk (prediction taken) or bnt or btk (branch taken or not taken) or maybe hintnt or hinttk.  Or maybe a modern assembler for the Pentium 4 should automatically add a 2Eh (branch not taken) for all forward jumps and a 3Eh (branch taken) for all backwards jumps (usually the most likely result), which could be overriden using the hint codes.<br />Grateful for your views.</div>
    <div class="meta">Posted on 2002-02-04 05:59:20 by jorgon</div>
   </div>
   <div class="post" id="post-22764">
    <div class="subject"><a href="#post-22764">Consensus using SSE/SSE2 in assembler?</a></div>
    <div class="body">I use m128 to define data.<br />And I'm very glad to see you here, Jeremy.</div>
    <div class="meta">Posted on 2002-02-04 06:58:07 by The Svin</div>
   </div>
   <div class="post" id="post-22769">
    <div class="subject"><a href="#post-22769">Consensus using SSE/SSE2 in assembler?</a></div>
    <div class="body">I must have miss-explained, Jeremy. I provided 'O' (OctoWord) for compatibility, but, like NASM developpers, i implented too, and i prefer and also recommand 'X' (Much more readable, and sounds better fitting with XMM, MMX, ... and like 'AnyThing', because the real sizes of targetted Data are not real OctoWords).<br /><br />Would be great if we could agrea on the 'Colon Dilemna'... but Wayne and i have been unable to agrea on this point. Difficult. I just saw that, in NASM syntax,  this point is far from clear and simple too.<br /><br />Also, to me, the leading point for Local-talking-Labels shoud be better (of course bound to the colon problem).<br /><br /><br />Betov.</div>
    <div class="meta">Posted on 2002-02-04 07:54:36 by Betov</div>
   </div>
   <div class="post" id="post-22777">
    <div class="subject"><a href="#post-22777">Consensus using SSE/SSE2 in assembler?</a></div>
    <div class="body"><div class="quote"><br />Or maybe a modern assembler for the Pentium 4 should automatically add a 2Eh.<br /></div><br />Better make this an option. And have manual prefixes anyway.<br />I prefer bnt/btk, they have the best ring to them.</div>
    <div class="meta">Posted on 2002-02-04 08:55:44 by f0dder</div>
   </div>
   <div class="post" id="post-22784">
    <div class="subject"><a href="#post-22784">Consensus using SSE/SSE2 in assembler?</a></div>
    <div class="body">... And what do these Prefixes look like with MASM ?<br /><br />Jeremy, did you ask Frank Kotler for these? (I think they must be implemented in NASM, but i have not seen it).<br /><br /><br />Betov</div>
    <div class="meta">Posted on 2002-02-04 09:40:49 by Betov</div>
   </div>
   <div class="post" id="post-22788">
    <div class="subject"><a href="#post-22788">Consensus using SSE/SSE2 in assembler?</a></div>
    <div class="body">I would say DO, because it follows the convension: db, dw, dd, dq. I wouldn't make it DX. Everyone seems to have a unexplainable fetish for the letter X. It doesn't make sense to use X considering that it doesn't relate to 128 bits or octoword.</div>
    <div class="meta">Posted on 2002-02-04 10:28:32 by Hel</div>
   </div>
   <div class="post" id="post-22790">
    <div class="subject"><a href="#post-22790">Consensus using SSE/SSE2 in assembler?</a></div>
    <div class="body"><div class="quote"><br />I would say DO, because it follows the convension: db, dw, dd, dq. I wouldn't make it DX. Everyone seems to have a unexplainable fetish for the letter X. It doesn't make sense to use X considering that it doesn't relate to 128 bits or octoword. </div>I agree.  We should leave X for the next data type.  :tongue:</div>
    <div class="meta">Posted on 2002-02-04 10:37:41 by bitRAKE</div>
   </div>
   <div class="post" id="post-22868">
    <div class="subject"><a href="#post-22868">Consensus using SSE/SSE2 in assembler?</a></div>
    <div class="body">Jeremy,<br /><br />I would be inclined to stick with the Microsoft/Intel notation for 128 bit data, the DO makes sense in compatibility terms.<br /><br />The prefixes should be able to be added by programmer choice so you have the form,<br /><br />prefix instruction<br /><br />or<br /><br />instruction.<br /><br />Makes it programmer adjustable without any problems.<br /><br />Glad you could make it here.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-02-05 06:08:49 by hutch--</div>
   </div>
   <div class="post" id="post-22882">
    <div class="subject"><a href="#post-22882">Consensus using SSE/SSE2 in assembler?</a></div>
    <div class="body">Hutch, and others, again, what is the form of these Prefixes + Instructions (or PrefixInstructions) with MASM?<br /><br />Or, as no one answers, have i to understand that they are not implemented in MASM?<br /><br />Or as no one ever used them, nobody knows?<br /><br /><br />Betov.</div>
    <div class="meta">Posted on 2002-02-05 08:21:20 by Betov</div>
   </div>
   <div class="post" id="post-23124">
    <div class="subject"><a href="#post-23124">Consensus using SSE/SSE2 in assembler?</a></div>
    <div class="body">Well thanks for all your answers which I read with interest.<br />And thanks for the welcome too - it's very nice to see all these friendly faces here!</div>
    <div class="meta">Posted on 2002-02-06 16:28:05 by jorgon</div>
   </div>
   <div class="post" id="post-117133">
    <div class="subject"><a href="#post-117133">Consensus using SSE/SSE2 in assembler?</a></div>
    <div class="body">In a few days from now I'll be publishing GoAsm with support for the SSE/SSE2 instructions.  <br />This will be a beta version for testing for a short time available from the <a target="_blank" href="http://masmforum.com/viewforum.php?f=23">GoAsm forum</a> <br />followed by a full version available free from <a target="_blank" href="http://www.GoDevTool.com">the Go Tools website</a>.<br /><br />The question of what assembler syntax would be best to generate the branch hint bytes 2Eh and 3Eh generated some debate here and elsewhere when this thread was opened.  I also had some e-mail correspondence about it with assembler authors and users.<br /><br />The Intel documentation states that these branch hint bytes &quot;can be used only at the machine code level (that is, there are no mnemonics for the branch hints)&quot;.  In reality this means that to add these bytes to assembler code you would need to use, for example<pre><code>DB 2Eh  ;or<br />DB 3Eh</code></pre> or alternatively use a macro to achieve the same result.<br /><br />The Intel IA-64 documentation however, suggests that the assembler instruction (for the more complex branch instructions for that processor) might be<pre><code>brp.ipwh.ih</code></pre> where brp stands for &quot;branch predict instruction&quot;, and ipwh and ih vary according to the instruction required.  <br /><br />There is also a &quot;C&quot; code example:- <pre><code>branch_predict&#40;instruction&#41;</code></pre>So I am convinced that we will be using branch hinters in the future, and that it would be useful to have an easy way to use the limited branch hinters available on the P4.<br />No consensus was actually reached in our debate on this last year and I now need to make a decision for GoAsm.<br /><br />The P4 uses the branch hint bytes to vary the usual prediction made by the processor as to whether or not a conditional jump will take place.  The processor uses this prediction so that instruction can continue from the destination of the jump without delay.  <br /><br />The default prediction is that:-<br />All forward conditional jumps will not take place, and<br />All backwards conditional jumps (loops back) will take place.<br /><br />It is documented that in normal code, backward conditional jumps tend to take place 80% of the time, whereas forward conditional jumps will be likely not to take place.  It is said that overall, the default prediction is correct 65% of the time.  <br />So predicting whether or not the conditional jump will take place can speed up the code particularly on a series of loops back.<br /><br />As an assembler programmer, you can produce fast code knowing the default action since you are in complete control over how you code your loops.  But suppose (unusually) you want to create a loop where the conditional jump is at the beginning of a code fragment and the destination of the jump is forward in the code.  This loop will run more slowly because of the default predictions.  In this case, however, you can add the branch hint byte 3Eh as a prefix to the conditional jump instruction to tell the processor to assume that the jump will occur most of the time.<br /><br />Using the branch hint byte 2Eh will be useful where you want to use a <em>backwards</em> conditional jump for example in case of an error exit from a procedure.  Using 2Eh as a prefix to the conditional jump will stop the processor from assuming that the backwards jump will occur most of the time.<br /><br />Note that 2Eh and 3Eh used to be used as CS and DS segment override bytes in 16 bit programming, but in 32-bit programming they have this new meaning on later processors.<br /><br />Since Intel does not recommend any particular mnemonic to insert the branch hint bytes, it is up to assembler and compiler writers to decide what syntax to use.  <br /><br />Various ideas have been put forward by my correspondents.  For the sake of <br />completeness I list them here with my comments:-<br /><br />LTJ - &quot;likely taken jump&quot;<br />UTJ - &quot;unlikely taken jump&quot;<br />or<br />OFT - &quot;often taken&quot;<br />NOFT - &quot;not often taken&quot;<br />or <br />BTK - &quot;branch taken&quot;<br />BNT - &quot;branch not taken&quot;<br />or<br />PRED_T - &quot;predict taken&quot;<br />PRED_NT - &quot;predict not taken&quot;<br />or <br />HINT_T - &quot;hint taken&quot;<br />HINT_NT - &quot;hint not taken&quot;<br />or <br />HINT<br />NOHINT<br /><br />I think the problem with these is that they may conflict with future mnemonics which may be introduced, or existing labels.  <br />Also they are meaningless.  Someone reading your code would need to look in the assembler manual to see what the instruction means.<br /><br />predict.likely<br />predict.unlikely<br />or<br />likely<br />unlikely<br />or <br />predict(unlikely)<br />predict(likely)<br /><br />To my mind these are better because they are more descriptive but I still think they do not actually describe the instruction properly.  <br /><br />After several sleepness nights over this matter I have come up with:-<br /><br />assume.branch<br />assume.nobranch<br /><br />I believe this is clear because it can be seen that the instruction is to the processor to assume that the conditional jump will branch or will not branch.  Also, in anything but 16-bit programming, assume has (hopefully) been abolished and available now for re-use.  Even in code which does use assume, the above instruction is unique and meaningful. And the instruction is clearly not a code label (not in GoAsm anyway) since it has no trailing colon.  There is some extra typing involved, but in <br />practice this instruction will be rarely used, so this is not too onerous.  If desired the instruction could be replaced by a shorter macro.<br /><br />It's not too late to persuade me to change my mind about this syntax until the final version of GoAsm supporting SSE and SSE2 is published.</div>
    <div class="meta">Posted on 2003-09-05 17:09:52 by jorgon</div>
   </div>
   <div class="post" id="post-117136">
    <div class="subject"><a href="#post-117136">Consensus using SSE/SSE2 in assembler?</a></div>
    <div class="body">Right... but the meaning of 2Eh and 3Eh have nothing to do with whether it's running 32-bit or 16-bit code. It depends on whether the following instruction is a conditional jump instruction or not. They still work as expected with memory referencing instructions.</div>
    <div class="meta">Posted on 2003-09-05 17:37:00 by Sephiroth3</div>
   </div>
   <div class="post" id="post-117179">
    <div class="subject"><a href="#post-117179">Consensus using SSE/SSE2 in assembler?</a></div>
    <div class="body">LTJ - &quot;likely taken jump&quot;<br />UTJ - &quot;unlikely taken jump&quot;<br /><br />Sounds like it best represents the programmers thinking process to me.  Since Intel has left the name undefined, how about using a short from and future proofing with a long form?</div>
    <div class="meta">Posted on 2003-09-06 00:52:51 by ThoughtCriminal</div>
   </div>
   <div class="post" id="post-117204">
    <div class="subject"><a href="#post-117204">Consensus using SSE/SSE2 in assembler?</a></div>
    <div class="body">I think the following sounds the most technically appropriate.<br /><br />HINT_T - &quot;hint taken&quot;<br />HINT_NT - &quot;hint not taken&quot;</div>
    <div class="meta">Posted on 2003-09-06 05:33:29 by roticv</div>
   </div>
   <div class="post" id="post-117226">
    <div class="subject"><a href="#post-117226">Consensus using SSE/SSE2 in assembler?</a></div>
    <div class="body">I like a hybrid of jorgons &amp; roticvs:<br /><br />hint.branch<br />hint.nobranch</div>
    <div class="meta">Posted on 2003-09-06 07:40:23 by EÃ³in</div>
   </div>
   <div class="post" id="post-117231">
    <div class="subject"><a href="#post-117231">Consensus using SSE/SSE2 in assembler?</a></div>
    <div class="body">Are these &quot;hint&quot; mechanisms present on Athlon cpu's?</div>
    <div class="meta">Posted on 2003-09-06 08:47:38 by gfalen</div>
   </div>
   <div class="post" id="post-117638">
    <div class="subject"><a href="#post-117638">Consensus using SSE/SSE2 in assembler?</a></div>
    <div class="body">Thanks all, for your comments.  <br />I may well take up your proposed syntax, E?in: I'll see how it looks today.</div>
    <div class="meta">Posted on 2003-09-10 02:25:10 by jorgon</div>
   </div>
   <div class="post" id="post-117796">
    <div class="subject"><a href="#post-117796">Consensus using SSE/SSE2 in assembler?</a></div>
    <div class="body">The GoAsm beta with SSE/SSE2 support is now available directly from <a target="_blank" href="http://www.GoDevTool.com/goasmtest">here</a> <br />(217K download including the latest help file).  Or visit <a target="_blank" href="http://www.GoDevTool.com">the Go tool website</a></div>
    <div class="meta">Posted on 2003-09-11 17:30:40 by jorgon</div>
   </div>
  </div>
 </body>
</html>