<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Memory Layout in Protected Mode - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=25709" />
  <link rel="prev" href="../?id=25709&amp;page=1" />  <link rel="next" href="../?id=25709&amp;page=3" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=25709">Memory Layout in Protected Mode</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=25709&amp;page=1" style="">&laquo;</a><a href="../?id=25709&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="25709" /><input type="number" name="page" min="1" max="3" step="1" value="2" onchange="this.form.submit();" /><a href="../?id=25709&amp;page=3">&gt;</a><a href="../?id=25709&amp;page=3">&raquo;</a></form>   <div class="post" id="post-187700">
    <div class="subject"><a href="#post-187700">Re: Memory Layout in Protected Mode</a></div>
    <div class="body">Hehe at the linuxbios site, &quot;Written in C, contains virtually no assembly code&quot; is listed as a benefit.&nbsp; ;)</div>
    <div class="meta">Posted on 2007-01-21 18:47:11 by roticv</div>
   </div>
   <div class="post" id="post-187701">
    <div class="subject"><a href="#post-187701">Re: Memory Layout in Protected Mode</a></div>
    <div class="body"><div class="quote"><br />Hehe at the linuxbios site, &quot;Written in C, contains virtually no assembly code&quot; is listed as a benefit.&nbsp; ;)<br /></div><br />I can see why that&#39;s a plus for the linux kernel et cetera, but just how much of a BIOS is going to be portable across architectures?<br /></div>
    <div class="meta">Posted on 2007-01-21 18:52:17 by f0dder</div>
   </div>
   <div class="post" id="post-187704">
    <div class="subject"><a href="#post-187704">Re: Memory Layout in Protected Mode</a></div>
    <div class="body">Lots of people/groups/projects don&#39;t think why they do things, they just do them because they&#39;re stuck in the mindset of &quot;it&#39;s the right way to do things and anyone who thinks otherwise is stupid&quot;.&nbsp; <br /><br />One major example of this is the misconception that open source makes everything perfect.&nbsp; It&#39;s amazing how many people seem to think that Java becoming open source means that it will instantly (magically) become more secure.&nbsp; The ironic problem is that now people don&#39;t have to disassemble and reverse-engineer it to find the security flaws, so although it won&#39;t technically be any <strong>less</strong> secure, it&#39;ll be a whole lot easier to attack.<br /><br />Another one is that no implementation should be done until everything is designed and that no testing should be done until everything is implemented, and lastly, that testing is the last phase of the development cycle.&nbsp; Hmmm.... what if there&#39;s a design problem that is dependent on the implementation, and then isn&#39;t discovered until the test phase because nothing was tested before then?&nbsp; Well, testing is the last phase, so the design flaw will just have to stay there throughout the lifetime of the product, because doing all testing last is &quot;the right way to do things&quot;. ;)&nbsp; If you&#39;re not prototyping your designs and trying them out during the &quot;design phase&quot;, it&#39;s a sure one-way ticket to pain.<br /><br />Perhaps the most general and problematic one these days is the &quot;my boss told me to do it this way, so I&#39;m doing it this way no matter what&quot;.&nbsp; If you know of a better way to do something, or if you forsee a fatal problem, your boss wants to hear it.&nbsp; They often get paid based on the project&#39;s productivity, so if you can save a week of work by making a simple change, let them know.&nbsp; They&#39;ll often just tell you how to do something so that you won&#39;t sit there wondering how to do it.&nbsp; An example of this was that a friend of mine was asked to manually remove duplicates from a huge list of names.&nbsp; He wrote a simple program to do in a few seconds what would have taken him a few days. :)&nbsp; His boss simply hadn&#39;t thought of writing a program for it.</div>
    <div class="meta">Posted on 2007-01-21 19:47:51 by hackulous</div>
   </div>
   <div class="post" id="post-187706">
    <div class="subject"><a href="#post-187706">Re: Memory Layout in Protected Mode</a></div>
    <div class="body"><div class="quote"><br />Lots of people/groups/projects don&#39;t think why they do things, they just do them because they&#39;re stuck in the mindset of &quot;it&#39;s the right way to do things and anyone who thinks otherwise is stupid&quot;.&nbsp; <br /></div><br /><br />Agreed. Specifically for Linux/LinuxBIOS... they are too damned concerned about making *every single system* run their kernel instead of specialized kernel development that hosts a generic OS layer.<br /><br /><div class="quote"><br />One major example of this is the misconception that open source makes everything perfect.&nbsp; It&#39;s amazing how many people seem to think that Java becoming open source means that it will instantly (magically) become more secure.&nbsp; The ironic problem is that now people don&#39;t have to disassemble and reverse-engineer it to find the security flaws, so although it won&#39;t technically be any <strong>less</strong> secure, it&#39;ll be a whole lot easier to attack.<br /></div><br /><br />Open-source has the attribute that holes tend to get closed as fast as they are opened. This only accelerates the on-going battle between malicious types and software developers.<br /><br /><div class="quote"><br />Another one is that no implementation should be done until everything is designed and that no testing should be done until everything is implemented, and lastly, that testing is the last phase of the development cycle.&nbsp; Hmmm.... what if there&#39;s a design problem that is dependent on the implementation, and then isn&#39;t discovered until the test phase because nothing was tested before then?&nbsp; Well, testing is the last phase, so the design flaw will just have to stay there throughout the lifetime of the product, because doing all testing last is &quot;the right way to do things&quot;. ;)&nbsp; If you&#39;re not prototyping your designs and trying them out during the &quot;design phase&quot;, it&#39;s a sure one-way ticket to pain.<br /></div><br /><br />I am overly fanatic about testing code. For my OS Development, I don&#39;t get away with more than a few blocks/procedures of code without throughly testing that it works. This is where Bochs comes in handy. After I get done implementing entire ideas/designs, I test on a real PC and work things out from there.<br /><br /><div class="quote"><br />Perhaps the most general and problematic one these days is the &quot;my boss told me to do it this way, so I&#39;m doing it this way no matter what&quot;.&nbsp; If you know of a better way to do something, or if you forsee a fatal problem, your boss wants to hear it.&nbsp; They often get paid based on the project&#39;s productivity, so if you can save a week of work by making a simple change, let them know.&nbsp; They&#39;ll often just tell you how to do something so that you won&#39;t sit there wondering how to do it.&nbsp; An example of this was that a friend of mine was asked to manually remove duplicates from a huge list of names.&nbsp; He wrote a simple program to do in a few seconds what would have taken him a few days. :)&nbsp; His boss simply hadn&#39;t thought of writing a program for it.<br /></div><br /><br />It&#39;s easy... just make the boss think it was their idea :P</div>
    <div class="meta">Posted on 2007-01-21 20:45:25 by SpooK</div>
   </div>
   <div class="post" id="post-187713">
    <div class="subject"><a href="#post-187713">Re: Memory Layout in Protected Mode</a></div>
    <div class="body"><div class="quote"><br />no testing should be done until everything is implemented<br /></div><br />I don&#39;t agree with this one - it&#39;s beneficial to test at least each &quot;module&quot; when you can, and (while I&#39;ve not gotten into this myself yet) for things where it&#39;s possible, it seems like a pretty decent idea to have an automated regression suite to test with, and do that relatively often (though not after each compile, as some people advocate).<br /><br />There&#39;s a reason why filesystems are often implemented in ring3 before integrated to kernelmode ;)<br /></div>
    <div class="meta">Posted on 2007-01-22 04:38:12 by f0dder</div>
   </div>
   <div class="post" id="post-187717">
    <div class="subject"><a href="#post-187717">Re: Memory Layout in Protected Mode</a></div>
    <div class="body"><div class="quote"><br /><div class="quote"><br />no testing should be done until everything is implemented<br /></div><br />I don&#39;t agree with this one.<br /></div><br />Sorry, that was my point (i.e. that testing <strong>shouldn&#39;t</strong> be left until the end).&nbsp; I guess it&#39;s hard to identify sarcasm in text-only.&nbsp; ;)</div>
    <div class="meta">Posted on 2007-01-22 10:49:56 by hackulous</div>
   </div>
   <div class="post" id="post-187721">
    <div class="subject"><a href="#post-187721">Re: Memory Layout in Protected Mode</a></div>
    <div class="body"><div class="quote"><br /><div class="quote"><br /><div class="quote"><br />no testing should be done until everything is implemented<br /></div><br />I don&#39;t agree with this one.<br /></div><br />Sorry, that was my point (i.e. that testing <strong>shouldn&#39;t</strong> be left until the end).&nbsp; I guess it&#39;s hard to identify sarcasm in text-only.&nbsp; ;)<br /></div><br /><br />That&#39;s why we usually use smilies, no? ^_^<br /></div>
    <div class="meta">Posted on 2007-01-22 17:12:16 by f0dder</div>
   </div>
   <div class="post" id="post-187740">
    <div class="subject"><a href="#post-187740">Re: Memory Layout in Protected Mode</a></div>
    <div class="body">Alright, since we are still on this subject I thought maybe I could ask another question! When I am copying my Global Descriptor Table at the physical address of 0x0500 after the BDA and then switch to Protected Mode with the Flat Memory Model, would I be overwriting my GDT if my code or data grows in the memory? Do I even have to be worried about that or would it stay in GDTR?<br /><br />P.S: Wouldn?t it be a good idea to let me ask all of my questions in this post and then make this post sticky or put it in the FAQ section? Seriously because I know there are other people who have the same questions but can?t possibly be as annoying as I am!<br /><br /></div>
    <div class="meta">Posted on 2007-01-24 00:26:38 by XCHG</div>
   </div>
   <div class="post" id="post-187742">
    <div class="subject"><a href="#post-187742">Re: Memory Layout in Protected Mode</a></div>
    <div class="body">We&#39;re in the process of rewriting the FAQ and wikifying the current content in there, so the FAQ can actually become a FAQ :). But some of the stuff from this thread could go into wiki entries, sure!<br /><br />Personaly I don&#39;t copy the GDT, I use a temp one for initial loading, then set up a new GDT when in pmode.<br /></div>
    <div class="meta">Posted on 2007-01-24 00:40:15 by f0dder</div>
   </div>
   <div class="post" id="post-187744">
    <div class="subject"><a href="#post-187744">Re: Memory Layout in Protected Mode</a></div>
    <div class="body">You&#39;d only be overwriting your GDT if you chose to write to memory in a location occupied by your GDT.&nbsp; I&#39;ve got my GDT at physical and virtual address 0, specifically because I want to generate an error on trying to &quot;dereference a null pointer&quot; anyway (an access violation, because I have that page at supervisor access level).<br /><br />One weird and possibly counter-intuitive thing is that the address in the GDTR is a <strong>virtual</strong> address, (or maybe I&#39;m confusing it with something else).&nbsp; To avoid the confusion, I have the physical address of it and virtual address of it equal.&nbsp; ;)</div>
    <div class="meta">Posted on 2007-01-24 01:10:19 by hackulous</div>
   </div>
   <div class="post" id="post-187746">
    <div class="subject"><a href="#post-187746">Re: Memory Layout in Protected Mode</a></div>
    <div class="body">All addresses except Page Directory (including CR3/PDBR) and Page Table entries are considered &quot;Virtual Addresses&quot; while the Paging-bit in CR0 is enabled. This makes more sense as you get deeper and deeper into virtual memory and multitasking.<br /><br />The best explanation I can provide comes from my init routine.<br /><br />The GDT/GDTR are data structures included in the kernel, they are not copied to any location. Instead, the relocation address fix-ups take care of the GDT/GDTR addresses due to their inclusion in the kernel file format (e.g. PE/ELF/etc...)<br /><br />Please note that in 16-bit Real Mode, only 24-bits of the 32-bit GDT address within the GDTR are utilized. This allows me to easily use &quot;LGDT&quot; only once and never look back. How I utilize paging within 32-bit Protected Mode also reflects/supports this method.<br /><br />This is a rather incomplete explanation of what is really coded, but I hope you generally understand what I mean.<br /><br />I will probably release my init code, which is in (N)ASM, sometime within the next week for people to use and learn from.</div>
    <div class="meta">Posted on 2007-01-24 01:49:17 by SpooK</div>
   </div>
   <div class="post" id="post-187747">
    <div class="subject"><a href="#post-187747">Re: Memory Layout in Protected Mode</a></div>
    <div class="body">I wouldn&#39;t place my GDT at phys0 - if you want to do v86 later on, it&#39;s nice having the original IDT to copy from.<br /></div>
    <div class="meta">Posted on 2007-01-24 03:44:20 by f0dder</div>
   </div>
   <div class="post" id="post-187752">
    <div class="subject"><a href="#post-187752">Re: Memory Layout in Protected Mode</a></div>
    <div class="body"><div class="quote"><br />I wouldn&#39;t place my GDT at phys0 - if you want to do v86 later on, it&#39;s nice having the original IDT to copy from.</div><br />Good point.&nbsp; I don&#39;t plan on doing any v86 later on, but I should save the int 10h vector, because I&#39;d like to emulate the changing of screen modes eventually.&nbsp; I&#39;ve also got conditional assembly in my code so that if I change the GDT&#39;s physical or virtual address from 0, it&#39;ll automatically adjust.&nbsp; (It&#39;s also really handy for forcing errors when a constant changes or a structure&#39;s size changes, so that I can update anything dependent on it.)</div>
    <div class="meta">Posted on 2007-01-24 11:25:42 by hackulous</div>
   </div>
   <div class="post" id="post-187753">
    <div class="subject"><a href="#post-187753">Re: Memory Layout in Protected Mode</a></div>
    <div class="body">Just saving a single vector might not be enough - what if the interrupt code decides on calling interrupts itself? - the realmode ivt is 1kb, right? Not a big loss of memory :)<br /></div>
    <div class="meta">Posted on 2007-01-24 12:02:26 by f0dder</div>
   </div>
   <div class="post" id="post-187759">
    <div class="subject"><a href="#post-187759">Re: Memory Layout in Protected Mode</a></div>
    <div class="body">This is great, thank you guys for being so helpful and tolerant. I appreciate it.</div>
    <div class="meta">Posted on 2007-01-25 02:01:52 by XCHG</div>
   </div>
   <div class="post" id="post-187780">
    <div class="subject"><a href="#post-187780">Re: Memory Layout in Protected Mode</a></div>
    <div class="body">Can you guys give an advise on whether I?ve gotten this whole memory layout right by telling me whether or not my definitions for the below terms are correct?<br /><br />Physical memory: is the actual RAM addressable directly when paging is not enabled.<br /><br />Global Descriptor Table: is a table created in the memory which holds the base addresses, segment limits and access rights of different segments in the memory.<br /><br />Logical Address: is the far pointer created by adding a segment selector inside the GDT and a 32-bit offset which would then be translated into the linear address.<br /><br />Linear address: depending whether paging is enabled or not, in the former case would be mapped into the physical memory through the paging directory and tables and in the latter would be mapped directly to the physical memory. <br /><br /><br />I don?t know whether these descriptions are correct or not but there is one thing I barely understand about the linear address. The Intel manuals state that the linear address is made of *adding* the segment selector and the offset of a byte. So suppose my code segment descriptor in the GDT has the offset of 8 (right after the null-descriptor) and I would like to address the 10th byte inside this segment. Would the linear address of this byte be equal to 0x08 + 0x0A = 0x00000012? <br /></div>
    <div class="meta">Posted on 2007-01-26 03:49:42 by XCHG</div>
   </div>
   <div class="post" id="post-187782">
    <div class="subject"><a href="#post-187782">Re: Memory Layout in Protected Mode</a></div>
    <div class="body">No, you don&#39;t add the selector - you add the base-address from the L/GDT descriptor entry the selector selects :)<br /><br />Oversimplified code that doesn&#39;t take LDT/GDT into account etc:<br /><strong>linear = logical + gdtArray.base</strong><br /><br /></div>
    <div class="meta">Posted on 2007-01-26 03:55:22 by f0dder</div>
   </div>
   <div class="post" id="post-187785">
    <div class="subject"><a href="#post-187785">Re: Memory Layout in Protected Mode</a></div>
    <div class="body">So if a sgment has its base address set to 0, then any operation using this segment has its logical address equal to linear. That&#39;s exactly the essence of the &#39;Flat Memory Model&#39;. In other words: The segmentation is being &#39;disabled&#39; this way (of course there are some exceptions).</div>
    <div class="meta">Posted on 2007-01-26 08:43:21 by ti_mo_n</div>
   </div>
   <div class="post" id="post-187797">
    <div class="subject"><a href="#post-187797">Re: Memory Layout in Protected Mode</a></div>
    <div class="body"> :shock:&nbsp; I remember reading the stuff about linear vs. logical and never actually needing it.<br /><br />I just keep it simple, having the base segment addresses at 0 (except on TSSs of course), and then I can call everything virtual or physical.&nbsp; A virtual address is one that you can actually use as a normal address after booting (i.e. with paging enabled), and a physical address only matters to the page-level memory functions and possibly device management functions later.&nbsp; I think that they&#39;re trying to or have already phased out segmentation with the 64-bit mode (though I don&#39;t have such a processor, so I haven&#39;t looked into it much), so it&#39;s best not to rely on segmentation much anyway.&nbsp; ;)</div>
    <div class="meta">Posted on 2007-01-27 00:55:27 by hackulous</div>
   </div>
   <div class="post" id="post-187799">
    <div class="subject"><a href="#post-187799">Re: Memory Layout in Protected Mode</a></div>
    <div class="body">Okay got it. Thank you everyone. Although it?s really sad to hear that they are going to get rid of segmentation (are they?) just when I am starting to learn it. It?d be so sad.</div>
    <div class="meta">Posted on 2007-01-27 01:17:27 by XCHG</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=25709&amp;page=1" style="">&laquo;</a><a href="../?id=25709&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="25709" /><input type="number" name="page" min="1" max="3" step="1" value="2" onchange="this.form.submit();" /><a href="../?id=25709&amp;page=3">&gt;</a><a href="../?id=25709&amp;page=3">&raquo;</a></form>  </div>
 </body>
</html>