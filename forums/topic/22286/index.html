<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Question about pattern matching... - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=22286" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=22286">Question about pattern matching...</a></p>
   <div class="post" id="post-167455">
    <div class="subject"><a href="#post-167455">Question about pattern matching...</a></div>
    <div class="body">Hi,Randall!<br />1)<br />In patterns.hhf in endOneOrMorePat macro i saw this line:<br />&nbsp; mov( pat.ar( prevOpEBP ), pat.onePatEBP )<br />i think this must be<br />&nbsp; mov(pat.ar(prevOpEBP), pat.oneOrMorePatEBP); ?<br />2)<br />When using pat.oneOrMorePat and matched string has several matching for this sub pattern<br />endmatch macro doesn&#39;t restore original ebp.<br /><br />Example:<br />static<br />&nbsp; test_str: string := &quot;#include(&quot;&quot;w.hhf&quot;&quot;) #include(&quot;&quot;inc.hhf&quot;&quot;)&quot;;<br />endstatic;<br /><br />begin patterns;<br /> pat.match(test_str);<br />	pat.oneOrMorePat;<br />		pat.matchToiStr(&quot;#include&quot;);<br />		pat.upToChar(&#39;(&#39;);<br />		pat.oneChar(&#39;(&#39;);<br />		pat.upToChar(&#39;&quot;&#39;);<br />		pat.oneChar(&#39;&quot;&#39;);<br />		pat.upToChar(&#39;&quot;&#39;);<br />	pat.endOneOrMorePat;<br />&nbsp; pat.if_failure <br />&nbsp; pat.endmatch;<br />and here ebp points to activation record of some pattern matching function not main program.<br /><br />3)<br />Macros like pat.oneOrMorePat havily use ebp register.<br />How it is supposed to access local variables inside <br />oneOrMorePat -- endOneOrMorePat block?</div>
    <div class="meta">Posted on 2005-11-02 15:08:27 by Elohim Meth</div>
   </div>
   <div class="post" id="post-167495">
    <div class="subject"><a href="#post-167495">Re: Question about pattern matching...</a></div>
    <div class="body"><div class="quote"><br />Hi,Randall!<br />1)<br />In patterns.hhf in endOneOrMorePat macro i saw this line:<br />  mov( pat.ar( prevOpEBP ), pat.onePatEBP )<br />i think this must be<br />  mov(pat.ar(prevOpEBP), pat.oneOrMorePatEBP); ?<br /></div><br /><br />Yep. Cut and paste (from onePat) strikes again! Just missed this when I cut and pasted onePat to create oneOrMorePat.<br /><br /><div class="quote"><br />2)<br />When using pat.oneOrMorePat and matched string has several matching for this sub pattern<br />endmatch macro doesn&#39;t restore original ebp.<br /><br />Example:<br />static<br />  test_str: string := &quot;#include(&quot;&quot;w.hhf&quot;&quot;) #include(&quot;&quot;inc.hhf&quot;&quot;)&quot;;<br />endstatic;<br /><br />begin patterns;<br /> pat.match(test_str);<br />	pat.oneOrMorePat;<br />		pat.matchToiStr(&quot;#include&quot;);<br />		pat.upToChar(&#39;(&#39;);<br />		pat.oneChar(&#39;(&#39;);<br />		pat.upToChar(&#39;&quot;&#39;);<br />		pat.oneChar(&#39;&quot;&#39;);<br />		pat.upToChar(&#39;&quot;&#39;);<br />	pat.endOneOrMorePat;<br />  pat.if_failure <br />  pat.endmatch;<br />and here ebp points to activation record of some pattern matching function not main program.<br /></div><br />Yes, I can see how the problem in (1) can cause this.<br /><br /><br /><div class="quote"><br />3)<br />Macros like pat.oneOrMorePat havily use ebp register.<br />How it is supposed to access local variables inside <br />oneOrMorePat -- endOneOrMorePat block?<br /></div><br />The pattern matching code *really* messes with the stack. Whenever one of the pattern matching functions returns, it does not clean up the activation record created on the stack for that function. This is done to support backtracking between the match/endmatch macro invocations. Basically, whenever backtracking occurs, the code unwinds the stack back to the last function that needs to do backtracking. When a match succeeds (or completely fails) and you hit the endmatch macro, *then* the code unwinds all the stuff left on the stack by all the pattern matching code. Playing games with EBP is exactly how this is achieved. For this reason, you do *not* want to bail out of the middle of a match/endmatch sequence via a JMP or other mechanism (well, exceptions are okay, as they unwind the stack too).<br />Cheers,<br />Randy Hyde<br /></div>
    <div class="meta">Posted on 2005-11-03 16:17:15 by rhyde</div>
   </div>
   <div class="post" id="post-167517">
    <div class="subject"><a href="#post-167517">Re: Question about pattern matching...</a></div>
    <div class="body">Thanks for reply, Randall! <br /><br /><div class="quote">Yes, I can see how the problem in (1) can cause this.</div><br /><br />Yes it can cause this, when pattern fails matching the string, but in my example pattern matching succeeded<br />and doesn&#39;t even execute this line. I corrected this line in patterns.hhf and problem still exists.<br />As far as i can understand algorithm the cause of this problem is several match occurences in string.<br />oneOrMorePat macro creates activation record for each matching occurence and<br />endOneOrMorePat macro on successful matching restores ebp from FailToSave.ebpSave and its<br />correct for backtracking, but endmatch macro didn&#39;t know about this activation records and didn&#39;t<br />even touch ebp register. As a result after endmatch ebp points to activation record of last<br />pattern matching function inside oneOrMorePat - endOneOrMorePat block that supports backtracking.<br /><br /><div class="quote">The pattern matching code *really* messes with the stack. Whenever one of the pattern matching functions returns, it does not clean up the activation record created on the stack for that function. This is done to support backtracking between the match/endmatch macro invocations. Basically, whenever backtracking occurs, the code unwinds the stack back to the last function that needs to do backtracking. When a match succeeds (or completely fails) and you hit the endmatch macro, *then* the code unwinds all the stuff left on the stack by all the pattern matching code. Playing games with EBP is exactly how this is achieved. For this reason, you do *not* want to bail out of the middle of a match/endmatch sequence via a JMP or other mechanism (well, exceptions are okay, as they unwind the stack too).</div><br /><br />Yes, i understand that pattern matching functions messes with the stack. But...they not mess ebp (well ... only inside themselves).<br />As far as i can see in between calls to pattern matching ebp is preserved. But using one of pat.pattern macros messes ebp.<br />One of main purposes of pattern matching is to extract matches, but where to store the result of pat.extract?<br />Ebx, esi and edi are internally used in matching functions, ebp is messed so local variables are not available.<br />And also when using pattern matching inside some procedure how to pass parameters of this procedure to matching function if ebp is messed?</div>
    <div class="meta">Posted on 2005-11-04 05:17:37 by Elohim Meth</div>
   </div>
  </div>
 </body>
</html>