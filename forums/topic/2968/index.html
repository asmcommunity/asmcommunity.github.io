<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>WH_JOURNALRECORD and the invisible mouse cursor - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=2968" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=2968">WH_JOURNALRECORD and the invisible mouse cursor</a></p>
   <div class="post" id="post-19346">
    <div class="subject"><a href="#post-19346">WH_JOURNALRECORD and the invisible mouse cursor</a></div>
    <div class="body">With mob's help I figured out how to get WH_JOURNALRECORD to work. However, I have a new problem: the mouse cursor is gone.<br />My program loads a DLL. The DLL debugs a game. The game has a mouse cursor, but when I ALT-TAB to Windows, the mouse cursor is gone, although windows still changes various things as the invisible mouse goes over them, so it is still responding.<br /><br />I would do this with WH_KEYBOARD, but that would load the dll with the hookproc in the game's process, which would complicate things.<br /><br />Do you guys know how to make that mouse cursor reappear??<br /><br /><br /><pre><code><br />;vb hook procedure code in my app<br /><br />Public Function HookProc&#40;ByVal nCode As Long, ByVal wParam As Long, ByRef lParam As EVENTMSG&#41; As Long<br />If nCode = HC_ACTION Then<br />    If RecordFlag = True Then<br />        rc = HookProcedure&#40;lParam&#41;<br />    End If<br />ElseIf nCode = HC_SYSMODALOFF Then<br />    RecordFlag = True<br />ElseIf nCode = HC_SYSMODALON Then<br />    RecordFlag = False<br />End If<br />If nCode &lt; 0 Then<br />    HookProc = CallNextHookEx&#40;hHandle, nCode, wParam, lParam&#41;<br />Else<br />    HookProc = 0<br />End If<br />End Function<br /><br />----------------------------------------------------<br />;asm code in my dll<br /><br />HookProcedure	PROC	USES edi	lParam&#58;DWORD<br />	mov	edi, lParam<br />	ASSUME	edi&#58;ptr EVENTMSG<br />	.IF	&#91;edi&#93;.message == WM_KEYDOWN<br />		mov	eax, &#91;edi&#93;.paramL<br />		and	eax, 0FFh<br />		.IF eax == VK_SHIFT<br />			invoke	MyProcedure, ADDR NewValue<br />		.ENDIF<br />	.ENDIF<br />	ASSUME	edi&#58;nothing<br />	ret<br />HookProcedure	ENDP<br /></code></pre><br /><br />There's a second problem that I observed.<br />I check for WM_KEYDOWN. The API reference says that the high parameter (wParam) hold the virtual key code. If i'm not mistaken, those are the VK_ constants. Also, the low parameter holds &quot;key data&quot;.<br />Here are the various results I get with a few keys:<br /><br />VK_SHIFT = 10h<br />EVENTMSG.paramH = 2Ah<br />EVENTMSG.paramL = 2A10h<br /><br />VK_TAB = 09h<br />EVENTMSG.paramH = {something}h<br />EVENTMSG.paramL = {the same something}09h<br /><br />It seems that the VK_ code goes in the low byte of the low parameter, while the second byte of the low parameter and the high parameter apparently hold the scan code.<br /><br />I also tried some of the letters and numbers, and the VK_ code (same as ascii code in this case) is in the same spot.<br /><br />I looked at the structures to make sure all the parameters are in the correct places and to make sure they are the proper sizes, and everything is fine.<br /><br />Does anyone know what's up with these VK_ codes?</div>
    <div class="meta">Posted on 2002-01-15 13:36:26 by Hel</div>
   </div>
   <div class="post" id="post-19432">
    <div class="subject"><a href="#post-19432">WH_JOURNALRECORD and the invisible mouse cursor</a></div>
    <div class="body">hi hel... hm i don't see a &quot;CallNextHookEx&quot; in your code...<br />and btw according to the api-ref a recordhook-callback must <br />look like this:<br /><br /><pre><code><br />LRESULT CALLBACK JournalRecordProc&#40;<br /><br />    int code,	// hook code<br />    WPARAM wParam,	// undefined<br />    LPARAM lParam 	// address of message being processed<br /></code></pre><br /><br />that means in asm it should be like<br /><br /><pre><code><br />RecordProc              PROC    nCode&#58;DWORD, wParam&#58;DWORD, lParam&#58;DWORD<br /><br />                        OR      nCode, HC_ACTION<br />                        JNZ     _NO_HC_A<br />                        OR      stopflag,0<br />                        JNZ     _NO_HC_A<br /><br />                        ;//     RESPOND...<br />                        ;//     lParam Points to an EVENTMSG struc<br /><br />_NO_HC_A&#58;               CMP     nCode, HC_SYSMODALOFF<br />                        JNZ     _NO_MODAL_OFF<br /><br />                        MOV     stopflag,0<br /><br />_NO_MODAL_OFF&#58;          CMP     nCode, HC_SYSMODALON<br />                        JNZ     _NOPE<br /><br />                        MOV     stopflag,1<br /><br />_NOPE&#58;                  OR      _nCode,0<br />                        JL      _EXIT<br /><br />                        INVOKE  CallNextHookEx,hhandle,nCode,wParam,lParam<br />                        RET<br /><br />_EXIT&#58;                  XOR     EAX, EAX<br />                        RET<br /><br />RecordProc              ENDP<br /></code></pre><br /><br />hm i had always problems with keyboard input... i stopped<br />playing with hooks... so i never found a suitable solution...<br />a few weeks ago i coded a little keylogger that used<br />TranslateMessage but you can't use this since TMSG only<br />works for non-virtual-keycodes... There are a couple of<br />functions for that purpose... try MapVirtualKey or look around<br />in your api ref...</div>
    <div class="meta">Posted on 2002-01-16 03:33:32 by mob</div>
   </div>
   <div class="post" id="post-19477">
    <div class="subject"><a href="#post-19477">WH_JOURNALRECORD and the invisible mouse cursor</a></div>
    <div class="body">I do have a CallNexHookEx; it's in the VB code. I looked at your code and translated into VB word for word and the mouse cursor is gone.<br />Then, I realized that CallNextHookEx gets called only if Code &lt; 0, which means that most of the time the other WH_JOURNALRECORD hooks wouldn't get called.<br /><br />API Reference:<div class="quote"><br />Calling the CallNextHookEx function to chain to the next hook procedure is optional, but it is highly recommended; otherwise, other applications that have installed hooks will not receive hook notifications and may behave incorrectly as a result. You should call CallNextHookEx unless you absolutely need to prevent the notification from being seen by other applications. </div><br />Therefore, i changed the code a bit. In asm it would be<br /><pre><code><br />.IF Code == HC_ACTION<br /><br />.ELSEIF Code == HC_SYSMODALOFF<br /><br />.ELSEIF Code == HC_SYSMODALON<br /><br />.ENDIF<br />invoke CallNexHookEx<br />.IF Code &lt; 0<br />xor eax, eax<br />.ENDIF<br />ret<br /></code></pre></div>
    <div class="meta">Posted on 2002-01-16 07:33:22 by Hel</div>
   </div>
   <div class="post" id="post-19483">
    <div class="subject"><a href="#post-19483">WH_JOURNALRECORD and the invisible mouse cursor</a></div>
    <div class="body">hm api-ref sais...<br /><br /><div class="quote"><br />If code is less than zero, the hook procedure must pass the message to the CallNextHookEx function without further processing and should return the value returned by CallNextHookEx. <br /><br />If not, the return value is ignored. <br /></div></div>
    <div class="meta">Posted on 2002-01-16 08:32:59 by mob</div>
   </div>
  </div>
 </body>
</html>