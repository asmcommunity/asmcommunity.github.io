<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Crash on Win2K - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=20841" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=20841">Crash on Win2K</a></p>
   <div class="post" id="post-158455">
    <div class="subject"><a href="#post-158455">Crash on Win2K</a></div>
    <div class="body">Hi. I wrote this ownerdraw button app and it works fine on Win98, but it crashes on Win2000(Server). I have no idea why this occurs.. can anyone help? Sorry but I couldn&#39;t attach the files. Thanks<br /><br /><pre><code><br /><pre><br />.386<br />.MODEL FLAT, STDCALL<br />LOCALS @@<br /><br />EXTRN GetModuleHandleA		:PROC<br />EXTRN LoadIconA			:PROC<br />EXTRN LoadCursorA		:PROC<br />EXTRN RegisterClassExA		:PROC<br />EXTRN CreateDialogParamA	:PROC<br />EXTRN ShowWindow		:PROC<br />EXTRN GetMessageA		:PROC<br />EXTRN TranslateMessage		:PROC<br />EXTRN DispatchMessageA		:PROC<br />EXTRN ExitProcess		:PROC<br />EXTRN PostQuitMessage		:PROC<br />EXTRN DefWindowProcA		:PROC<br /><br />EXTRN GetDlgItem		:PROC<br />EXTRN SetWindowLongA		:PROC<br />EXTRN GetClientRect		:PROC<br />EXTRN CreateCompatibleDC	:PROC<br />EXTRN CreateCompatibleBitmap	:PROC<br />EXTRN DrawFrameControl		:PROC<br />EXTRN FillRect			:PROC<br />EXTRN GetWindowLongA		:PROC<br />EXTRN CreateSolidBrush		:PROC<br />EXTRN SelectObject		:PROC<br />EXTRN SendMessageA		:PROC<br />EXTRN GetTextExtentPoint32A	:PROC<br />EXTRN GetSysColor		:PROC<br />EXTRN SetTextColor		:PROC<br />EXTRN SetBkMode			:PROC<br />EXTRN TextOutA			:PROC<br />EXTRN BitBlt			:PROC<br />EXTRN DeleteObject		:PROC<br />EXTRN DeleteDC			:PROC<br /><br />INCLUDE TOOLS\W32.INC<br /><br />.DATA<br /><br />NOME_CLASSE		DB	&quot;JANELA_1&quot;, 0<br />BUFFER			DB	256 DUP(0)<br />bLENGTH			DB	0, 0<br />hMemDC			DD	0, 0<br /><br />ALIGN 4<br />WNDCLASSEX		STRUC<br />cbSize			DD	?<br />style			DD	?<br />lpfnWndProc		DD	?<br />cbClsExtra		? ? ? ? ? ? ? ? DD	?<br />cbWndExtra		DD	?<br />hInstance		? ? ? ? ? ? ? ? DD	?<br />hIcon			DD	?<br />hCursor			DD	?<br />hbrBackground		DD	?<br />lpszMenuName		DD	?<br />lpszClassName		DD	?<br />hIconSm			DD	?<br />WNDCLASSEX		ENDS<br />WCX			WNDCLASSEX &lt;48,0,OFFSET WNDPROC,0,DLGWINDOWEXTRA,?,?,?,COLOR_MENU + 1,0,OFFSET NOME_CLASSE,?&gt;<br /><br />ALIGN 4<br />MESSAGE			STRUC<br />hWnd			DD	?<br />uMsg			DD	?<br />wParam 			DD	?<br />lParam			DD	?<br />time			DD	?<br />xPT			DD	?<br />yPT			DD	?<br />MESSAGE			ENDS<br />MSG			MESSAGE &lt;&gt;<br /><br />DRAWITEMSTRUCT		STRUC<br />ctlType			DD	?<br />ctlID			DD	?<br />itemID			DD	?<br />itemAction		? ? ? ? ? ? ? ? DD	?<br />itemState		? ? ? ? ? ? ? ? DD	?<br />hwndItem		? ? ? ? ? ? ? ? DD	?<br />hdc			DD	?<br />rcItemLeft		? ? ? ? ? ? ? ? DD	?<br />rcItemTop		? ? ? ? ? ? ? ? DD	?<br />rcItemRight		DD	?<br />rcItemBottom		DD	?<br />itemData		? ? ? ? ? ? ? ? DD	?<br />DRAWITEMSTRUCT		ENDS<br /><br />ALIGN 4<br />RECTANGLE		STRUC<br />left			DD	?<br />top			DD	?<br />right			DD	?<br />bottom			DD	?<br />RECTANGLE		ENDS<br />RECT			RECTANGLE &lt;&gt;<br /><br />ALIGN 4<br />SIZEL STRUC<br />x			DD	?<br />y			DD	?<br />SIZEL ENDS<br />SZ			SIZEL &lt;&gt;<br /><br />.CODE<br /><br />MAIN		PROC<br />		LOCAL	hDlg:DWORD<br /><br />		PUSH	0<br />		CALL	GetModuleHandleA<br />		MOV	, EAX<br /><br />		PUSH	IDC_CROSS<br />		PUSH	0<br />		CALL	LoadIconA<br />		MOV	, EAX<br />		MOV	, EAX<br /><br />		PUSH	IDI_APPLICATION<br />		PUSH	0<br />		CALL	LoadCursorA<br />		MOV	, EAX<br /><br />		PUSH	OFFSET WCX<br />		CALL	RegisterClassExA<br /><br />		PUSH	0<br />		PUSH	0<br />		PUSH	0<br />		PUSH	10<br />		PUSH	<br />		CALL	CreateDialogParamA<br />		MOV	, EAX<br /><br />		PUSH	SW_SHOWNORMAL<br />		PUSH	<br />		CALL	ShowWindow<br /><br />RECEBE_MSG:	PUSH	0<br />		PUSH	0<br />		PUSH	0<br />		PUSH	OFFSET MSG<br />		CALL	GetMessageA<br />		TEST	EAX, EAX<br />		JZ	SAIR<br /><br />		PUSH	OFFSET MSG<br />		CALL	TranslateMessage<br /><br />		PUSH	OFFSET MSG<br />		CALL	DispatchMessageA<br />		JMP	RECEBE_MSG<br /><br />SAIR:		PUSH	<br />		CALL	ExitProcess<br />MAIN		ENDP<br />;---------------------------------------------------------------------------------------IN?CIO---<br />WNDPROC		PROC<br />		ARG	WND_hWnd:DWORD, WND_uMsg:DWORD, WND_wParam:DWORD, WND_lParam:DWORD<br />		USES	EBX, ESI, EDI, EBP<br /><br />;---WM_DRAWITEM-----------------------<br /><br />@@MSG_2:	CMP	DWORD PTR , 2Bh<br />		JNE	@@MSG_3<br /><br />		MOV	EDI, <br />		CMP	DWORD PTR , ODT_BUTTON<br />		JNE	@@RESTO<br /><br />		PUSH	OFFSET RECT<br />		PUSH	<br />		CALL	GetClientRect<br /><br />		PUSH	<br />		CALL	CreateCompatibleDC<br />		MOV	, EAX<br /><br />		PUSH	<br />		PUSH	<br />		PUSH	<br />		CALL	CreateCompatibleBitmap<br /><br />		PUSH	EAX<br />		PUSH	<br />		CALL	SelectObject<br />		MOV	ESI, EAX<br /><br />		PUSH	0<br />		PUSH	0<br />		PUSH	BM_GETSTATE<br />		PUSH	<br />		CALL	SendMessageA<br />		TEST	EAX, 4<br />		JZ	@@L1<br /><br />		PUSH	DFCS_BUTTONPUSH OR DFCS_PUSHED OR DFCS_ADJUSTRECT<br />		PUSH	DFC_BUTTON<br />		PUSH	OFFSET RECT<br />		PUSH	<br />		CALL	DrawFrameControl<br />		JMP	@@L2<br /><br />@@L1:		PUSH	DFCS_BUTTONPUSH OR DFCS_ADJUSTRECT<br />		PUSH	DFC_BUTTON<br />		PUSH	OFFSET RECT<br />		PUSH	<br />		CALL	DrawFrameControl<br /><br />@@L2:		PUSH	0040FF00h<br />		CALL	CreateSolidBrush<br /><br />		PUSH	EAX<br /><br />		PUSH	EAX<br />		PUSH	OFFSET RECT<br />		PUSH	<br />		CALL	FillRect<br /><br />		CALL	DeleteObject<br /><br />		PUSH	0<br />		PUSH	0<br />		PUSH	WM_GETFONT<br />		PUSH	<br />		CALL	SendMessageA<br /><br />		PUSH	EAX<br />		PUSH	<br />		CALL	SelectObject<br /><br />		PUSH	OFFSET BUFFER<br />		PUSH	256<br />		PUSH	WM_GETTEXT<br />		PUSH	<br />		CALL	SendMessageA<br />? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? MOV? ? ? ? ?, AL<br /><br />		PUSH	OFFSET SZ<br />		PUSH	EAX<br />		PUSH	OFFSET BUFFER<br />		PUSH	<br />		CALL	GetTextExtentPoint32A<br /><br />		MOV	EAX, <br />		SUB	EAX, <br />		SHR	EAX, 1<br />		MOV	, EAX<br />		SUB	, EAX<br /><br />		MOV	EAX, <br />		SUB	EAX, <br />		SHR	EAX, 1<br />		MOV	, EAX<br />		SUB	, EAX<br /><br />		MOV	EAX, <br />		TEST	EAX, ODS_SELECTED<br />		JZ	@@L3<br /><br />		SUB	, 2<br />		SUB	, 2<br /><br />@@L3:		PUSH	COLOR_BTNTEXT<br />		CALL	GetSysColor<br /><br />		PUSH	EAX<br />		PUSH	<br />		CALL	SetTextColor<br /><br />		PUSH	TRANSPARENT<br />		PUSH	<br />		CALL	SetBkMode<br /><br />? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? PUSH? ? ? ? ?DWORD PTR <br />		PUSH	OFFSET BUFFER<br />		PUSH	<br />		PUSH	<br />		PUSH	<br />		CALL	TextOutA<br /><br />		MOV	EBX, EDI<br />? ? ? ? ? ? ? ? ADD? ? ?EBX, DRAWITEMSTRUCT.rcItemLeft<br /><br />		PUSH	SRCCOPY<br />		PUSH	<br />		PUSH	<br />		PUSH	<br />		PUSH	<br />		PUSH	<br />		PUSH	<br />		PUSH	<br />		PUSH	<br />		CALL	BitBlt<br /><br />		PUSH	ESI<br />		PUSH	<br />		CALL	SelectObject<br /><br />		PUSH	EAX<br />		CALL	DeleteObject<br /><br />		PUSH	<br />		CALL	DeleteDC<br /><br />		XOR	EAX, EAX<br />		INC	EAX<br />		RET<br /><br />;---WM_DESTROY------------------------<br /><br />@@MSG_3:	CMP	DWORD PTR , 2<br />		JNE	@@RESTO<br /><br />		PUSH	0<br />		CALL	PostQuitMessage<br />		RET<br /><br />;---PROCESSAMENTO PADR?O--------------<br /><br />@@RESTO:	PUSH	<br />		PUSH	<br />		PUSH	<br />		PUSH	<br />		CALL	DefWindowProcA<br />		RET<br />WNDPROC		ENDP<br />;------------------------------------------------------------------------------------------FIM---<br /><br />END		MAIN<br /></pre><br /></code></pre><br /><br /><pre><code><br />#define DLGPRINC 10<br />#define IDC_BTN1 100<br />DLGPRINC DIALOGEX 6,5,206,67<br />CAPTION &quot;Color&quot;<br />FONT 8,&quot;MS Sans Serif&quot;<br />CLASS &quot;JANELA_1&quot;<br />STYLE 0x10C80800<br />EXSTYLE 0x00000000<br />BEGIN<br />? CONTROL &quot;IDC_BTN&quot;,IDC_BTN1,&quot;Button&quot;,0x5001000B,8,12,188,39,0x00000000<br />END<br /></code></pre></div>
    <div class="meta">Posted on 2005-03-26 16:13:01 by Marginais</div>
   </div>
   <div class="post" id="post-158456">
    <div class="subject"><a href="#post-158456">Re: Crash on Win2K</a></div>
    <div class="body">You can always upload a zipped archive of all the files including source code on www.rapidshare.de. :)</div>
    <div class="meta">Posted on 2005-03-26 17:12:04 by JimmyClif</div>
   </div>
   <div class="post" id="post-158463">
    <div class="subject"><a href="#post-158463">Re: Crash on Win2K</a></div>
    <div class="body">The <strong>USES</strong> directive <strong>HAS TO BE</strong> before the <strong>ARG</strong> directive !<br /><br />That is why it is crashing, and that is old TASM style code :P<br />You could easy use extended CALL syntax instead of all that pushing and Calling ...<br /><br />And you should use @@ in front of arguments and LOCAL variables also not only for the labels<br /><br />Question: Why are you using TASM if you do not know what you are doing?<br /><br /><br /></div>
    <div class="meta">Posted on 2005-03-27 00:19:50 by BogdanOntanu</div>
   </div>
   <div class="post" id="post-158476">
    <div class="subject"><a href="#post-158476">Re: Crash on Win2K</a></div>
    <div class="body">My other applications work fine with TASM. The problem is the ownerdraw thing.</div>
    <div class="meta">Posted on 2005-03-27 12:04:59 by Marginais</div>
   </div>
   <div class="post" id="post-158479">
    <div class="subject"><a href="#post-158479">Re: Crash on Win2K</a></div>
    <div class="body">Well, i did not say that you can not write applications using TASM -- after all I also useing TASM! ;)<br />I was just warning you that there are tips/tricks/bugs in TASM that require you to have more knowledge to overcome them... compared with MASM that is. So if you already know this then TASM is just fine, otherwise you are asking for trouble...<br /><br /></div>
    <div class="meta">Posted on 2005-03-27 21:39:29 by BogdanOntanu</div>
   </div>
  </div>
 </body>
</html>