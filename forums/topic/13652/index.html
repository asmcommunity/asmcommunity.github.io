<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Optimization of a knight tours program - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=13652" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=13652">Optimization of a knight tours program</a></p>
   <div class="post" id="post-105775">
    <div class="subject"><a href="#post-105775">Optimization of a knight tours program</a></div>
    <div class="body">I wrote a C code generator to explore knight tours exhaustively, and I need some help to optimize it in ASM.<br /><br />For the moment, my program generates a C program for the 6*6 board.<br />The final goal of this program is to explore semi-magic knight tours (a special case of knight tours) on the chessboard.<br />Computing such tours will take <strong>several years</strong>, so every saved cycle is important !<br /><br />My program generates one routine for every square of the board.<br />Here is an extract of the code:<br /><br /><pre><code><br />Init&#58;<br />static int mobility&#91;36&#93;=&#123;1,2,3,3,2,1,2,3,5,5,3,2,3,5,7,7,5,3,3,5,7,7,5,3,2,3,5,5,3,2,1,2,3,3,2,1&#125;;<br /><br />d4 square&#58;<br />static void d4&#40;int num&#41;<br />&#123;<br />	int count=0;<br />	if &#40;!--mobility&#91;34&#93;&#41; ++count;<br />	if &#40;!--mobility&#91;32&#93;&#41; ++count;<br />	if &#40;!--mobility&#91;10&#93;&#41; ++count;<br />	if &#40;!--mobility&#91;8&#93;&#41; ++count;<br />	if &#40;!--mobility&#91;29&#93;&#41; ++count;<br />	if &#40;!--mobility&#91;17&#93;&#41; ++count;<br />	if &#40;!--mobility&#91;25&#93;&#41; ++count;<br />	if &#40;!--mobility&#91;13&#93;&#41; ++count;<br />	if &#40;count&lt;2&#41;<br />	&#123;<br />		mobility&#91;21&#93;-=8;<br />		++num;<br />		if &#40;mobility&#91;34&#93;&gt;=0&#41; if &#40;!mobility&#91;34&#93; || !count&#41; &#123;e6&#40;num&#41;;&#125;<br />		if &#40;mobility&#91;32&#93;&gt;=0&#41; if &#40;!mobility&#91;32&#93; || !count&#41; &#123;c6&#40;num&#41;;&#125;<br />		if &#40;mobility&#91;10&#93;&gt;=0&#41; if &#40;!mobility&#91;10&#93; || !count&#41; &#123;e2&#40;num&#41;;&#125;<br />		if &#40;mobility&#91;8&#93;&gt;=0&#41; if &#40;!mobility&#91;8&#93; || !count&#41; &#123;c2&#40;num&#41;;&#125;<br />		if &#40;mobility&#91;29&#93;&gt;=0&#41; if &#40;!mobility&#91;29&#93; || !count&#41; &#123;f5&#40;num&#41;;&#125;<br />		if &#40;mobility&#91;17&#93;&gt;=0&#41; if &#40;!mobility&#91;17&#93; || !count&#41; &#123;f3&#40;num&#41;;&#125;<br />		if &#40;mobility&#91;25&#93;&gt;=0&#41; if &#40;!mobility&#91;25&#93; || !count&#41; &#123;b5&#40;num&#41;;&#125;<br />		if &#40;mobility&#91;13&#93;&gt;=0&#41; if &#40;!mobility&#91;13&#93; || !count&#41; &#123;b3&#40;num&#41;;&#125;<br />		--num;<br />		mobility&#91;21&#93;+=8;<br />	&#125;<br />	++mobility&#91;13&#93;;<br />	++mobility&#91;25&#93;;<br />	++mobility&#91;17&#93;;<br />	++mobility&#91;29&#93;;<br />	++mobility&#91;8&#93;;<br />	++mobility&#91;10&#93;;<br />	++mobility&#91;32&#93;;<br />	++mobility&#91;34&#93;;<br />&#125;<br /></code></pre><br /><br />The code seems very simple, but it was hard to generate !<br /><br />Can you help me especially on this part:<br /><pre><code><br />	int count=0;<br />	if &#40;!--mobility&#91;34&#93;&#41; ++count;<br />	if &#40;!--mobility&#91;32&#93;&#41; ++count;<br /></code></pre><br /><br />This can be done as follows:<br /><br /><pre><code><br />	xor eax,eax ;eax=count<br />	dec dword ptr &#91;mobility+34*4&#93;<br />	jne skip1<br />	inc eax<br />skip1&#58;<br />	dec dword ptr &#91;mobility+32*4&#93;<br />	jne skip2<br />	inc eax<br />skip2&#58;<br /></code></pre><br /><br />You can assume that mobility[] contains values between -16 and 8.<br /><br />Any idea ?<br /><br />JC</div>
    <div class="meta">Posted on 2003-06-02 12:31:34 by MCoder</div>
   </div>
   <div class="post" id="post-105792">
    <div class="subject"><a href="#post-105792">Optimization of a knight tours program</a></div>
    <div class="body">Here's my first attempt (not tried it or anything), but it should be faster at least with the if(...) ++count section (see the macro for details).<br /><br />At least it should give you some ideas ;) <br /><br /><pre><code><br />decNinc MACRO num&#58;REQ<br />  dec mob&#91;num * 4&#93;<br />  setnz al<br />  add ah, al<br />ENDM<br /><br /><br />d4 PROC	num&#58;DWORD<br />  LOCAL count&#58;BYTE<br />  LOCAL pads&#58;BYTE dup 3 ; Not the right syntax, can't remember it<br /><br />  ;Put in numerical order for cacheing reasons<br />  dec mob&#91;8*4&#93;<br />  setnz ah<br /><br />  decNinc 10<br />  decNinc 13<br />  decNinc 17<br />  decNinc 25<br />  decNinc 29<br />  decNinc 32<br />  decNinc 34<br /><br />  cmp ah, 2<br />  jge end<br /><br />  mov count, ah<br />  sub mob&#91;21*4&#93;, 8<br />  inc num<br /><br />  cmp mob&#91;34*4&#93;, 0<br />  jl next1          ; Less than zero, no go<br />  je @F             ; Is zero don't worry about count<br />  or ah, ah         ; Count must be zero<br />  jnz next1<br />@@&#58;<br />  invoke e6, num<br /><br />next1&#58;<br />  cmp mob&#91;32*4&#93;, 0<br />  jl next2<br />  je @F<br />  cmp count, 0<br />  jne next2<br />@@&#58;<br />  invoke c6, num<br /><br />next2&#58;<br />  cmp mob&#91;10*4&#93;, 0<br />  jl next3<br />  je @F<br />  cmp count, 0<br />  jne next3<br />@@&#58;<br />  invoke e2, num<br /><br />next3&#58;<br />  cmp mob&#91;8*4&#93;, 0<br />  jl next4<br />  je @F<br />  cmp count, 0<br />  jne next4<br />@@&#58;<br />  invoke c2, num<br /><br />next4&#58;<br />  cmp mob&#91;29*4&#93;, 0<br />  jl next5<br />  je @F<br />  cmp count, 0<br />  jne next5<br />@@&#58;<br />  invoke f5, num<br /><br />next5&#58;<br />  cmp mob&#91;17*4&#93;, 0<br />  jl next6<br />  je @F<br />  cmp count, 0<br />  jne next6<br />@@&#58;<br />  invoke f3, num<br /><br />next6&#58;<br />  cmp mob&#91;25*4&#93;, 0<br />  jl next7<br />  je @F<br />  cmp count, 0<br />  jne next7<br />@@&#58;<br />  invoke b5, num<br /><br />next7&#58;<br />  cmp mob&#91;13*4&#93;, 0<br />  jl next8<br />  je @F<br />  cmp count, 0<br />  jne next8<br />@@&#58;<br />  invoke b3, num<br /><br />next8&#58;<br />  inc num     ; Not really needed because its incrementing a local that's never used again...<br />  add mob&#91;21*4&#93;, 8<br /><br />end&#58;<br />  inc mob&#91; 8*4&#93;<br />  inc mob&#91;10*4&#93;<br />  inc mob&#91;13*4&#93;<br />  inc mob&#91;17*4&#93;<br />  inc mob&#91;25*4&#93;<br />  inc mob&#91;29*4&#93;<br />  inc mob&#91;32*4&#93;<br />  inc mob&#91;34*4&#93;<br /><br />  ret<br />d4 ENDP<br /></code></pre><br /><br />Mirno</div>
    <div class="meta">Posted on 2003-06-02 16:54:17 by Mirno</div>
   </div>
   <div class="post" id="post-105794">
    <div class="subject"><a href="#post-105794">Optimization of a knight tours program</a></div>
    <div class="body">If you bias the mobility list down by 1 (subtract 1 from each of the original values), you can use the following instead (same number of uOps on a P2/3 but should be faster on older PPlains).<br />Check for code density as well, if this is smaller I'd go with it.<br /><br /><pre><code><br />LOCAL count&#58;DWORD<br />xor eax, eax<br /><br />sub mob&#91;blah * 4&#93;, 1 ; Can't use dec it doesn't set the carry flag<br />adc eax, 0<br /></code></pre><br /><br />Just replace the &quot;cmp mob, 0&quot; with &quot;cmp mob, -1&quot; and that should all work as expected too.<br /><br />Mirno</div>
    <div class="meta">Posted on 2003-06-02 17:21:41 by Mirno</div>
   </div>
   <div class="post" id="post-105795">
    <div class="subject"><a href="#post-105795">Optimization of a knight tours program</a></div>
    <div class="body">Mirno: good ideas !<br /><br />I was thinking about the following code:<br /><br /><pre><code><br /><br />table&#58; dd 16 dup &#40;0&#41;<br /> dd 1<br /> dd 15 dup&#40;0&#41;<br /><br />xor eax,eax<br />mov ebx,&#91;mob+a*4&#93;  ;u<br />mov ecx,&#91;mob+b*4&#93;  ;v<br />dec ebx                     ;u<br />dec ecx                      ;v<br />add eax, &#91;table+16*4+ebx*4&#93; ;u<br />mov &#91;mob+a*4&#93;,ebx  ;v<br />add eax,&#91;table+16*4+ecx*4&#93; ;u<br />mov &#91;mob+b*4&#93;,ecx ;v<br /></code></pre><br /><br />but checking for 0 with a table seems pretty expensive.<br /><br />JC</div>
    <div class="meta">Posted on 2003-06-02 17:29:58 by MCoder</div>
   </div>
   <div class="post" id="post-105797">
    <div class="subject"><a href="#post-105797">Optimization of a knight tours program</a></div>
    <div class="body">I managed to generate full (unoptimized) ASM code.<br />Here is the a1 routine:<br /><pre><code><br />a1&#58;<br />	mov &#91;Knight+edi*4&#93;,0<br />	inc ebp<br />	push eax<br />	xor eax,eax<br />	dec &#91;mobility+8*4&#93;<br />	jne skip1<br />	inc eax<br />skip1&#58;<br />	dec &#91;mobility+13*4&#93;<br />	jne skip2<br />	inc eax<br />skip2&#58;<br />	cmp eax,2<br />	jae skipa1<br />	mov ebx, &#91;mobility+0*4&#93;<br />	sub ebx,8<br />	mov &#91;mobility+0*4&#93;,ebx<br />	inc edi<br />	mov ebx,&#91;mobility+8*4&#93;<br />	test ebx,ebx<br />	jl skip3<br />	je ok3<br />	test eax,eax<br />	jne skip3<br />ok3&#58;<br />	call c2<br />skip3&#58;<br />	mov ebx,&#91;mobility+13*4&#93;<br />	test ebx,ebx<br />	jl skip4<br />	je ok4<br />	test eax,eax<br />	jne skip4<br />ok4&#58;<br />	call b3<br />skip4&#58;<br />	dec edi<br />	mov ebx, &#91;mobility+0*4&#93;<br />	add ebx,8<br />	mov &#91;mobility+0*4&#93;,ebx<br />skipa1&#58;<br />	inc &#91;mobility+8*4&#93;<br />	inc &#91;mobility+13*4&#93;<br />	pop eax<br />	ret<br /></code></pre><br /><br />I get the same speed as my C version with the above routine.<br />ebp is the Nodes counter, and edi is num.<br /><br />JC</div>
    <div class="meta">Posted on 2003-06-02 18:26:46 by MCoder</div>
   </div>
   <div class="post" id="post-105798">
    <div class="subject"><a href="#post-105798">Optimization of a knight tours program</a></div>
    <div class="body">What's knight tours?</div>
    <div class="meta">Posted on 2003-06-02 18:36:45 by comrade</div>
   </div>
   <div class="post" id="post-105800">
    <div class="subject"><a href="#post-105800">Optimization of a knight tours program</a></div>
    <div class="body">Check this site for complete references:<br /><a target="_blank" href="http://www.ktn.freeuk.com/">http://www.ktn.freeuk.com/</a><br /><br />I don't need Warnsdorf's heuristic.<br /><br />JC</div>
    <div class="meta">Posted on 2003-06-02 18:57:22 by MCoder</div>
   </div>
  </div>
 </body>
</html>