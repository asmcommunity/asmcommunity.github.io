<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>String Length - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=12347" />
  <link rel="prev" href="../?id=12347&amp;page=1" />   </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=12347">String Length</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=12347&amp;page=1" style="">&laquo;</a><a href="../?id=12347&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="12347" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>   <div class="post" id="post-96282">
    <div class="subject"><a href="#post-96282">String Length</a></div>
    <div class="body">krish,<br />I know Paul Hsieh's site very well but: <br /><br />&quot;The most notable content on earlier versions of <strong>this page has gone out of date</strong> and has now<br />been superceded by the original author, Agner Fog. I am no longer motivated to keep it up to<br />date, so the old content has been removed. I would recommend that you visit Agner's own page<br />on How to optimize for the Pentium? microprocessors for the most up to date information on<br />Pentium Optimization.&quot; from <a target="_blank" href="http://www.azillionmonkeys.com/qed/p5opt.html">http://www.azillionmonkeys.com/qed/p5opt.html</a><br /><br />It is old (and slow) stuff:<br />&quot;A fast implementation of strlen()<br /><br />Recently, someone wrote to me with the comment that strlen() is a very commonly called function,<br />and as such was interested in possible performance improvements for it. At first, without thinking<br />too hard about it, I didn't see how there was any opportunity to fundamentally improve the algorithm.<br />I was right, but as far as low level algorithmic scrutiny is concerned, there is plenty of opportunity.<br />Basically, the algorithm is byte scan based, and as such the typical thing that the C version will do<br />wrong is miss the opportunity to reduce load redundancy.<br />; compiler <pre><code><br />    mov     edx,ebx<br />    cmp     byte ptr &#91;ebx&#93;,0<br />    je      l2<br />l1&#58; mov     ah,&#91;ebx+1&#93;       ; U<br />    inc     ebx              ;   V<br />    test    ah,ah            ; U<br />    jne     l1               ;   V +1brt<br />l2&#58; sub     ebx,edx<br />; by Paul Hsieh<br /><br />    lea     ecx,&#91;ebx-1&#93;<br />l1&#58; inc     ecx<br />    test    ecx,3<br />    jz      l2<br />    cmp     byte ptr &#91;ecx&#93;,0<br />    jne     l1<br />    jmp     l6<br />l2&#58; mov     eax,&#91;ecx&#93;        ; U<br />    add     ecx,4            ;   V<br />    test    al,al            ; U<br />    jz      l5               ;   V<br />    test    ah,ah            ; U<br />    jz      l4               ;   V<br />    test    eax,0ff0000h     ; U<br />    jz      l3               ;   V<br />    test    eax,0ff000000h   ; U<br />    jnz     l2               ;   V +1brt<br />    inc     ecx<br />l3&#58; inc     ecx<br />l4&#58; inc     ecx<br />l5&#58; sub     ecx,4<br />l6&#58; sub     ecx,ebx </code></pre><br />Here, I've sacrificed size for performance, by essentially unrolling the loop 4 times. If the input strings are fairly long (which is when performance will matter) on a Pentium, the asm code will execute at a rate of 1.5 clocks per byte, while the C compiler takes 3 clocks per byte. If the strings are not long enough, branch mispredictions may make this solution worse than the straight forward one.<br /><br />Update!<br />While discussing sprite data copying (see next example) I realized that there is a significant improvement for 32-bit x86's that have slow branching (P-IIs and Athlon.)<br />; by Paul Hsieh <pre><code><br />    lea     ecx,&#91;ebx-1&#93;<br />l1&#58; inc     ecx<br />    test    ecx,3<br />    jnz     l3<br />l2&#58; mov     edx,&#91;ecx&#93;        ; U<br />    mov     eax,07F7F7F7Fh   ;   V<br />    and     eax,edx          ; U<br />    add     ecx,4            ;   V<br />    add     eax,07F7F7F7Fh   ; U<br />    or      eax,edx          ; U<br />    and     eax,080808080h   ; U<br />    cmp     eax,080808080h   ; U<br />    je      l2               ;   V +1brt<br />    sub     ecx,4<br />l3&#58; cmp     byte ptr &#91;ecx&#93;,0<br />    jne     l1<br />    sub     ecx,ebx</code></pre><br /><br />I think this code will perform better in general for all 32 bit x86s due to less branching. <br />16 bit x86's obviously can use a similar idea, but it should be pretty clear that it would<br />be at least twice as slow. (I'm really starting to like this bit mask trick! &quot; <br />from <a target="_blank" href="http://www.azillionmonkeys.com/qed/asmexample.html">http://www.azillionmonkeys.com/qed/asmexample.html</a> as you suggested<br /><br />Old (and slow), so search the board !!!<br /><br /><br /><br />Dear arkadash Vortex,<br /><br />&quot;a)To get a short code:use C run-time DLLa &quot;<br />Are you sure? Please, post the code to see it...<br /><br />&quot;b)To get a speedy code:use optimized algos.&quot;<br />Please, post the code too...<br /><br /><br />Regards,<br />Lingo</div>
    <div class="meta">Posted on 2003-04-13 14:08:01 by lingo12</div>
   </div>
   <div class="post" id="post-96358">
    <div class="subject"><a href="#post-96358">String Length</a></div>
    <div class="body">Vortex,<br />   It might just be me ,but programming in assembly and then use a C library isn't high on my list. Even tho' it might be easier.<br /><br />Lingo,<br />   The first version of the library is going to be really simple, for people to learn assembly.</div>
    <div class="meta">Posted on 2003-04-13 18:43:16 by jInuQ</div>
   </div>
   <div class="post" id="post-96454">
    <div class="subject"><a href="#post-96454">String Length</a></div>
    <div class="body">the best and fastest strlen is to not use strlen at all...</div>
    <div class="meta">Posted on 2003-04-14 02:16:42 by f0dder</div>
   </div>
   <div class="post" id="post-96458">
    <div class="subject"><a href="#post-96458">String Length</a></div>
    <div class="body">Dear arkadash Lingo12,<br /><br />You want to see some examples of using C run-time DLLs?<br /><br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=10168">http://www.asmcommunity.net/board/index.php?topic=10168</a><br /><br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=9510">http://www.asmcommunity.net/board/index.php?topic=9510</a><br /><br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=9520">http://www.asmcommunity.net/board/index.php?topic=9520</a><br /><br />About optimised codes,you can read this post:<br /><br /><a target="_blank" href="http://www.asmcommunity.net/board/showthread.php?s=&amp;postid=96315.msg96315">http://www.asmcommunity.net/board/showthread.php?s=&amp;postid=96315.msg96315</a><br /><br />Don't forget amigo,think twice. :)</div>
    <div class="meta">Posted on 2003-04-14 02:44:26 by Vortex</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=12347&amp;page=1" style="">&laquo;</a><a href="../?id=12347&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="12347" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>  </div>
 </body>
</html>