<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Frustration takes a new kinda low... - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=9833" />
  <link rel="prev" href="../?id=9833&amp;page=1" />   </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=116">Windows</a> &raquo; <a href="../?id=9833">Frustration takes a new kinda low...</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=9833&amp;page=1" style="">&laquo;</a><a href="../?id=9833&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="9833" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>   <div class="post" id="post-73689">
    <div class="subject"><a href="#post-73689">Frustration takes a new kinda low...</a></div>
    <div class="body">Hi NaN,<br /><br />checked your code (and rewrite it :grin: ). One possible error is the return code handling. Your code copies at least 4 bytes. But that may possibly too much, if user wants a VARIANT_BOOL, thats only 2 bytes.<br /><br /><br />Anyway, I did some work to let COMView create such stubs. My current concept for that is:<br /><br />1. code changes should be kept quite simple, to call a method with IDispatch::Invoke I would code:<br /><br /><pre><code><br />          invoke dm&#40;pRange, Range, get_Item&#41;, var1, var2, addr var3<br /></code></pre><br /><br />that is, just replace &quot;invoke vf&quot; by &quot;invoke dm&quot;. That is all to be changed in the source code.<br /><br /><br />The rest is done by COMView: in excel.inc, changes are (example get_Item &amp; put_Item):<br /><br /><pre><code><br />;--- dispinterface only<br />ifndef RangeVtbl<br />BEGIN_INTERFACE Range, IDispatch<br />;	STDMETHOD	QueryInterface	, &#58;ptr GUID,&#58;ptr ptr <br />;	STDMETHOD	AddRef	<br />...<br />;	STDMETHOD	Insert	, &#58;VARIANT<br />;	STDMETHOD	get_Interior	<br />	DISPMETHOD	get_Item	, &#58;VARIANT,&#58;VARIANT,&#58;ptr VARIANT<br />	DISPMETHOD	put_Item	, &#58;VARIANT,&#58;VARIANT,&#58;VARIANT<br />;	STDMETHOD	Justify	<br />;	STDMETHOD	get_Left	<br /></code></pre><br /><br />this is quite simple so far (the DISPMEHTOD macro defines just a prototype). But another file will have to be generated, here its excelc.asm (c stands for &quot;client&quot; code, possibly ther is a excels.asm for server code later. excelc.asm will look like:<br /><br /><pre><code><br />    .386<br />    .model FLAT, STDCALL<br />    option casemap&#58;none<br />    option proc&#58;private<br /><br />    .nolist<br />    .nocref<br />    include \masm32\include\windows.inc<br />    include unknwn.inc<br />    include oaidl.inc<br />    include disphlp.inc<br />    .list<br />    .cref<br /><br />    .code<br /><br />    DEFINE_INVOKEHELPER<br /><br />    DEFINE_DISPMETHOD Range, get_Item, 0AAh, PROPERTYGET, VT_VARIANT, VT_VARIANT, VT_VARIANT<br />    DEFINE_DISPMETHOD Range, put_Item, 0AAh, PROPERTYPUT, , VT_VARIANT, VT_VARIANT, VT_VARIANT<br /><br />    end<br /><br /></code></pre><br /><br />that shouldnt be too hard. All lines with &quot;DEFINE_DISPMETHOD&quot; will be commented out first and have to be activated by hand.<br /><br /><br />The rest is done by some new macros (which hide all the Invokehelper code).<br />As far as by now the new macros are working. Just COMView has to be modified yet.<br /><br /><br />japheth</div>
    <div class="meta">Posted on 2002-12-31 09:26:47 by japheth</div>
   </div>
   <div class="post" id="post-73703">
    <div class="subject"><a href="#post-73703">Frustration takes a new kinda low...</a></div>
    <div class="body">Im a little lost here :confused: <br /><br />I guess i need to see the DM() and DISPMETHOD() macros to fully understand..<br /><br />Is the 'disphlp.inc' new as well?<br /><br />Thanx ;)<br /><br />NaN</div>
    <div class="meta">Posted on 2002-12-31 11:34:56 by NaN</div>
   </div>
   <div class="post" id="post-73819">
    <div class="subject"><a href="#post-73819">Frustration takes a new kinda low...</a></div>
    <div class="body">Yes, disphlp.inc is new, but the macro defined in there are only used by the generated source.<br /><br />Anyway, COMView is updated now, it will create the stubs. Of course it is still a preliminary version (1.5 now).<br /><br />Please download it and give this feature a try. Documentation is in disphlp.inc (not really needed to use this feature) and macros dm() and DISPMETHOD are in objbase.inc<br /><br />B.T.W.: I'm a bit uncertain about how to deal with VT_USERDEFINED as parameters. These mostly are<br />simple ENUMS or IDispatch pointers, but as far as I understood VT_USERDEFINED is not allowed as a VARIANTARG type in DISPPARAMS.<br /><br />Simplifying IDispatch::Invoke for ASM is a very exciting project in my opinion. Once it works smoothly handling of event sinks with this connection point stuff should be quite simple. Such interfaces are almost always dispatchonly.<br /><br />Japheth<br /><br /><a target="_blank" href="http://www.japheth.de/Download/COMView">Heres the new 1.5 version</a></div>
    <div class="meta">Posted on 2003-01-01 05:02:13 by japheth</div>
   </div>
   <div class="post" id="post-73903">
    <div class="subject"><a href="#post-73903">Frustration takes a new kinda low...</a></div>
    <div class="body">Nice,<br /><br />It looks good to me..  your using alot of macro's which is something i was straying away from (due to lengthy compile times).  As well, i see your making your variant type string arrays directly in the data segment.  Even tho is ez to implement,  I decided not to go this way so i would not make the data segment overpopulated with array stings if i had alot of methods to 'DISP:Invoke'.  This is why i liked your stack suggestion.<br /><br />Your design for the comView is good!  If i feel the need to tweek it can still be versitle... ( ;) )<br /><br />My only constructive feedback at this point is this:<br /><br />In the DEFINE_INVOKEHELPER macro, you should also put:<br /><pre><code>DEFINE_INVOKEHELPER macro<br />&#91;b&#93;ifndef _InvokeHelper_<br />_InvokeHelper_  equ 1&#91;/b&#93;<br /><br />...<br />..<br /><br /><br />&#91;b&#93;endif&#91;/b&#93;<br />ENDM</code></pre><br />This is so that i can have multiple files.. say Autocadc.asm and Excelc.asm in a project.<br /><br />As well, should there not be a proto statement inside the Macro?  Didnt compile a test, but as it appears, i would expect the invoke InvokeHelper ... to complain?<br /><br />Thanx again Japheth..<br />NaN</div>
    <div class="meta">Posted on 2003-01-01 16:10:17 by NaN</div>
   </div>
   <div class="post" id="post-73904">
    <div class="subject"><a href="#post-73904">Oh ya, about VT_USERDEFINED...</a></div>
    <div class="body"><pre><code>/*<br /> * VARENUM usage key,<br /> *<br /> * * &#91;V&#93; - may appear in a VARIANT<br /> * * &#91;T&#93; - may appear in a TYPEDESC<br /> * * &#91;P&#93; - may appear in an OLE property set<br /> * * &#91;S&#93; - may appear in a Safe Array<br /> *<br /> *<br /> *  VT_EMPTY            &#91;V&#93;   &#91;P&#93;     nothing<br /> *  VT_NULL             &#91;V&#93;   &#91;P&#93;     SQL style Null<br /> *  VT_I2               &#91;V&#93;&#91;T&#93;&#91;P&#93;&#91;S&#93;  2 byte signed int<br /> *  VT_I4               &#91;V&#93;&#91;T&#93;&#91;P&#93;&#91;S&#93;  4 byte signed int<br /> *  VT_R4               &#91;V&#93;&#91;T&#93;&#91;P&#93;&#91;S&#93;  4 byte real<br /> *  VT_R8               &#91;V&#93;&#91;T&#93;&#91;P&#93;&#91;S&#93;  8 byte real<br /> *  VT_CY               &#91;V&#93;&#91;T&#93;&#91;P&#93;&#91;S&#93;  currency<br /> *  VT_DATE             &#91;V&#93;&#91;T&#93;&#91;P&#93;&#91;S&#93;  date<br /> *  VT_BSTR             &#91;V&#93;&#91;T&#93;&#91;P&#93;&#91;S&#93;  OLE Automation string<br /> *  VT_DISPATCH         &#91;V&#93;&#91;T&#93;   &#91;S&#93;  IDispatch *<br /> *  VT_ERROR            &#91;V&#93;&#91;T&#93;&#91;P&#93;&#91;S&#93;  SCODE<br /> *  VT_BOOL             &#91;V&#93;&#91;T&#93;&#91;P&#93;&#91;S&#93;  True=-1, False=0<br /> *  VT_VARIANT          &#91;V&#93;&#91;T&#93;&#91;P&#93;&#91;S&#93;  VARIANT *<br /> *  VT_UNKNOWN          &#91;V&#93;&#91;T&#93;   &#91;S&#93;  IUnknown *<br /> *  VT_DECIMAL          &#91;V&#93;&#91;T&#93;   &#91;S&#93;  16 byte fixed point<br /> *  VT_RECORD           &#91;V&#93;   &#91;P&#93;&#91;S&#93;  user defined type<br /> *  VT_I1               &#91;V&#93;&#91;T&#93;&#91;P&#93;&#91;s&#93;  signed char<br /> *  VT_UI1              &#91;V&#93;&#91;T&#93;&#91;P&#93;&#91;S&#93;  unsigned char<br /> *  VT_UI2              &#91;V&#93;&#91;T&#93;&#91;P&#93;&#91;S&#93;  unsigned short<br /> *  VT_UI4              &#91;V&#93;&#91;T&#93;&#91;P&#93;&#91;S&#93;  unsigned long<br /> *  VT_I8                  &#91;T&#93;&#91;P&#93;     signed 64-bit int<br /> *  VT_UI8                 &#91;T&#93;&#91;P&#93;     unsigned 64-bit int<br /> *  VT_INT              &#91;V&#93;&#91;T&#93;&#91;P&#93;&#91;S&#93;  signed machine int<br /> *  VT_UINT             &#91;V&#93;&#91;T&#93;   &#91;S&#93;  unsigned machine int<br /> *  VT_INT_PTR             &#91;T&#93;        signed machine register size width<br /> *  VT_UINT_PTR            &#91;T&#93;        unsigned machine register size width<br /> *  VT_VOID                &#91;T&#93;        C style void<br /> *  VT_HRESULT             &#91;T&#93;        Standard return type<br /> *  VT_PTR                 &#91;T&#93;        pointer type<br /> *  VT_SAFEARRAY           &#91;T&#93;        &#40;use VT_ARRAY in VARIANT&#41;<br /> *  VT_CARRAY              &#91;T&#93;        C style array<br /> *  VT_USERDEFINED         &#91;T&#93;        user defined type<br /> *  VT_LPSTR               &#91;T&#93;&#91;P&#93;     null terminated string<br /> *  VT_LPWSTR              &#91;T&#93;&#91;P&#93;     wide null terminated string<br /> *  VT_FILETIME               &#91;P&#93;     FILETIME<br /> *  VT_BLOB                   &#91;P&#93;     Length prefixed bytes<br /> *  VT_STREAM                 &#91;P&#93;     Name of the stream follows<br /> *  VT_STORAGE                &#91;P&#93;     Name of the storage follows<br /> *  VT_STREAMED_OBJECT        &#91;P&#93;     Stream contains an object<br /> *  VT_STORED_OBJECT          &#91;P&#93;     Storage contains an object<br /> *  VT_VERSIONED_STREAM       &#91;P&#93;     Stream with a GUID version<br /> *  VT_BLOB_OBJECT            &#91;P&#93;     Blob contains an object <br /> *  VT_CF                     &#91;P&#93;     Clipboard format<br /> *  VT_CLSID                  &#91;P&#93;     A Class ID<br /> *  VT_VECTOR                 &#91;P&#93;     simple counted array<br /> *  VT_ARRAY            &#91;V&#93;           SAFEARRAY*<br /> *  VT_BYREF            &#91;V&#93;           void* for local use<br /> *  VT_BSTR_BLOB                      Reserved for system use<br /> */</code></pre><br /><br />From the VTypes.h in the core sdk...  it appears its not a concern ;)<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-01-01 16:20:33 by NaN</div>
   </div>
   <div class="post" id="post-73930">
    <div class="subject"><a href="#post-73930">Frustration takes a new kinda low...</a></div>
    <div class="body">Hello Japheth,<br /><br />I did a full study of your macro's etc.  You have some good ideas in there that i have picked up on.  Especially your decision to output the typelib data into macro statements &quot;DEFINE_DISPMETHOD&quot;... This is a very good idea!<br /><br />Mainly because, i think we are standing on two different viewpoints on how to proceed from here ;)<br /><br />Your macros like to declair .const data strings for each dispatched invoke type.  Were my view is to have it dynamic (and on the stack as you suggested).  As well, your method forces me to manually set up required VARIANTS for each param in the argument (to me this is an irratating overhead, and i try to avoid it if i can).  With the dynamic approach, you can define what it will be each time.  Ie, one time i might be 'putting' an integer, the next a real8 pointer.. etc etc. etc.  If i were to follow your method, i would have to manually decair / init a Vairant, set the type, set the pointer/number, and pass it as an argument (this is the overhead i refered to):<br /><br /><strong>Your model:</strong><pre><code><br />LOCAL Var1 &#58;VARIANT<br />LOCAL Var2 &#58;VARIANT<br />LOCAL Var3 &#58;VARIANT<br /><br />invoke InitVairiant, addr Var1<br />invoke InitVairiant, addr Var2<br />invoke InitVairiant, addr Var3<br /><br />mov Var1.vt, VT_I4<br />mov Var2.vt, VT_I4<br />mov Var3.vt, VT_I4<br /><br />mov Var1.lVal, 1   ; Row 1<br />mov Var2.lVal, 3   ; Col 3<br />mov Var3.lVal, 20 ; Data to place at &#40;row,col&#41;<br /><br />invoke dm&#40;pRange, Range, put_Item&#41;, Var1, Var2, Var3<br /></code></pre><br /><br /><strong>My model:</strong><pre><code><br />invoke MakeInvokeString, 3, VT_I4, VT_I4, VT_I4<br />invoke dm&#40;pRange, Range, put_Item&#41;, 1,3,20<br /></code></pre><br />My model uses less macros as well, only two:<pre><code>DEFINE_DISPMETHOD macro interface, method&#58;req, dispid&#58;req, functype&#58;req, rettype, args&#58;VARARG<br /><br />&#91;b&#93;   &amp;interface&amp;_&amp;method&amp; TEXTEQU &lt;InvokeHelp, &amp;dispid&amp;, DISPATCH_&amp;functype&amp;&gt;&#91;/b&#93;<br />   <br />ENDM<br /><br />dm macro this&#58;req, interface, func&#58;req<br />	exitm &lt;&amp;interface&amp;_&amp;func&amp;, &#91;b&#93;this, eax&#91;/b&#93;&gt;<br />	endm</code></pre><br /><br />Im still using my two above posted 'C' style funcitons, however, i re-arranged the arguments to fit the macros (an idea you spured me on to with your model).<br /><br />Attached is my most recient equivalent 'disphlp.inc' file.  It works perfectly with your generated output XXXc.asm file.  Again, im not trying to insult your work, i just think we have two different ideas in mind.  Myself, im aiming on minimizing MACRO and DATA segment functions, while making it still easy to use.  Yours is alot easier to 'invoke' but, causes more overhead by forcing the user to either edit the output XXXc.asm to change arument types, or manually set and get VARIANTS for each argument...<br /><br />I hope you see my point here!  Again, not trying to be an Arse ;)  I too find this work fun...<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-01-01 20:58:39 by NaN</div>
   </div>
   <div class="post" id="post-73952">
    <div class="subject"><a href="#post-73952">Frustration takes a new kinda low...</a></div>
    <div class="body">I just have to say again..<br /><br /><span style="font-size:120>Thank you so much!</span> <br /><br />I have now been progressing very fast with the generated output of the ComVIEW 1.5!  Im now light-years beyond where i was sitting yesterday.  And on top of it all, i got the Excel include streamlined into a fast and efficient file. (dont even need the Office10.inc file).<br /><br />I made a hybrid of the two outputs. Copied only the vf interfaces for _Application and Workbook (and equates).  From here everything is by Dispatch interfaces.  Compile time is now down to a second.  And everything meshes ;)<br /><br /><strong>I even figured out how to do this crazy string:</strong><br /><br />ApExcel.Range(&quot;A1:Z1&quot;).BORDERS.Color = RGB(0, 0, 0)<br /><br /><strong>With:</strong><pre><code><br />       invoke vf&#40;pIExcelApp, _Application ,get_Cells&#41;, addr RNG<br /><br />       ; Get a RANGE of Cells <br />       ;---------------------+<br />       invoke MakeInvokeString, 2, VT_I4, VT_I4<br />       invoke dm&#40;RNG, Range, get_Item&#41;, VT_DISPATCH, addr CELL1, 1, 1<br /><br />       invoke MakeInvokeString, 2, VT_I4, VT_I4<br />       invoke dm&#40;RNG, Range, get_Item&#41;, VT_DISPATCH, addr CELL2, 26,1<br /><br />       invoke MakeInvokeString, 2, VT_DISPATCH, VT_DISPATCH<br />       invoke dm&#40;RNG, Range, get_Range&#41;, VT_DISPATCH, addr RNG2, CELL1, CELL2<br /><br />       ; Set the Borders<br />       ;----------------+<br />       invoke MakeInvokeString, 0<br />       invoke dm&#40;RNG2, Range, get_Borders&#41;, VT_DISPATCH, addr BDRS<br />       <br />       invoke MakeInvokeString, 1, VT_I4<br />       invoke dm&#40;BDRS, Borders, put_Color&#41;, NULL, NULL, 0000FF00h<br /></code></pre><br /><br />Again,<br />Thanks alot Japheth!<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-01-02 01:08:03 by NaN</div>
   </div>
   <div class="post" id="post-73975">
    <div class="subject"><a href="#post-73975">Frustration takes a new kinda low...</a></div>
    <div class="body">NaN,<br /><br />thanks for your replys. Im about to study your disphlp.inc.<br /><br />Im really excited by myself about this code generation feature. The fact thats all the code is in macros makes it so easy to test several versions of generated code just be changing disphlp.inc<br /><br />I agree now with you not to put data in .const<br />So actually, I've changed disphlp.inc and my stubs now look like:<br /><br /><pre><code><br />_Range_get_Item proc public ....<br /><br />    mov eax, offset metadata<br />    call invokehelper<br />    ret<br />metadata&#58; <br />    dw ....<br /><br />_Range_get_Item endp<br /></code></pre><br /><br />So now only 13 bytes of real code for each stub (yes I used option prologue/epilogue to avoid building stack frames here).<br /><br />Minimal (?) size would be:<br /><br /><pre><code><br />_Range_get_Item proc public ....<br /><br />    call invokehelper<br />metadata&#58; <br />    dw ....<br /><br />_Range_get_Item endp<br /></code></pre><br /> <br />In this version InvokeHelper would have to do a bit extra work, for example do the stack cleanup. But with that version only 5 bytes code overhead! But code looks a bit ugly now :) , so Im still using the version above.<br /><br />Another point:<br /><br />Currently I'm thinking to avoid manually activating the stubs (here in excelc.asm). That would mean compile the source to a static lib and support &quot;function level linking&quot;. But I dont know how to do that with MASM, in VC its easy and supported by compiler switches. Obviously one have to deal with COMDAT stuff, as I was able to read in MSDN. Do you have any clues there?<br /><br />BTW: To compile excelc.asm with all lines activated takes a couple of minutes to compile with my machine (about 6800 lines only).<br /><br />Japheth</div>
    <div class="meta">Posted on 2003-01-02 05:07:45 by japheth</div>
   </div>
   <div class="post" id="post-73986">
    <div class="subject"><a href="#post-73986">Frustration takes a new kinda low...</a></div>
    <div class="body">NaN,<br /><br />thanks for the tip with manipulating a true range with ApExcel.Range(&quot;A1:Z1&quot;).BORDERS.Color = RGB(0, 0, 0). Missed that at first glance.<br /><br />One word about your approach:<br />No argueing about its flexibility and easy to use. Especially in excel where almost all parameters are of type VARIANT it is great and avoids fiddling around with this data type (it is almost like in VB itself :grin: ).  I just want to mention that for the comview code generator I had to follow an approach more rigid. As a consequence, if type info tells a method wants an argument of type VARIANT, you must supply one. Point. If you like you can always code some additional support functionality. And since only macros are used, you may always being able to adapt them to your needs.<br /><br />Japheth</div>
    <div class="meta">Posted on 2003-01-02 07:09:48 by japheth</div>
   </div>
   <div class="post" id="post-74021">
    <div class="subject"><a href="#post-74021">Frustration takes a new kinda low...</a></div>
    <div class="body"><div class="quote"><br />NaN,<br />...<br />Another point:<br /><br />Currently I'm thinking to avoid manually activating the stubs (here in excelc.asm). That would mean compile the source to a static lib and support &quot;function level linking&quot;. But I dont know how to do that with MASM, in VC its easy and supported by compiler switches. Obviously one have to deal with COMDAT stuff, as I was able to read in MSDN. Do you have any clues there?<br /><br />BTW: To compile excelc.asm with all lines activated takes a couple of minutes to compile with my machine (about 6800 lines only).<br /><br />Japheth </div><br /><br />Function level linking is great, but i dont think you really need the functions to begin with...<br /><br />As for the compile time, im amazed.. I didnt turn on every method, but my above generation only makes textequates.. Im not makeing proc's for each, which will save alot of time.<br /><br />I realize my InvokeHelp is kinda ugly to look at, for the moment.  I didnt want to optomize it or anything untill i feel its 1) robust enough, 2) will work consistantly, and 3) simply the best plan of attack ;)<br /><br />You have some good coding tricks that will certainly optimize it alot (when i get around to it).  As well, i didnt follow what you were getting at with the prolog/epilog business (not familiar with these directrives???)<br /><br />I look forward to seeing what you come up with...<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-01-02 11:46:26 by NaN</div>
   </div>
   <div class="post" id="post-74072">
    <div class="subject"><a href="#post-74072">Frustration takes a new kinda low...</a></div>
    <div class="body">I uncommented every DEFINE_DISPMETHOD using my version of the macro (textequ's), and it compiled in maybe 1 second longer.  <br /><br />I've been thinking about the two methods.. they are essentially the same.  However your approach has faster code, but requiers long compile times, and mine has about twice as much code, but very fast compile times.<br /><br />You approach defines a unique funciton to call for each mehtod/property type (making larger EXE's if you have more than say 4 different calls ~ assuming a lib is generated).  Mine has only two generic functions to call, which in total, the code  would add up to about 4 of your property functions.  <br /><br />Both methods eventually call sub-functions to call the DISP_Invoke method.  However your method is strict to the VARIANT rule for params, and mine is more flexible...<br /><br />Im sorry, Im still not convinced that the procs/lib method is the best choice for DISP_Invoke calling... what are your thoughts?<br /><br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-01-02 17:42:02 by NaN</div>
   </div>
   <div class="post" id="post-74090">
    <div class="subject"><a href="#post-74090">Frustration takes a new kinda low...</a></div>
    <div class="body">NaN,<br /><br />I finally did it. Threw away the stub functions I loved so much.<br /><br />Now COMView generates 2 sort of includes only, one for the vtbles, one for disponlys (okay, one may put them together but you wont gain too much). Nothing is &quot;deactivated&quot; any more and has to be manually activated.<br /><br />As a consequence, macro DISPMETHOD has become a dummy.<br />Macro DEFINE_DISPMETHOD defines text equates only (and a dummy proc)<br />And register EDX is now used in macro dm() (holds this &quot;metadata&quot; stuff pointer). Since edx<br />ist used in macro vf() as well, this seems no real disadvantage.<br />The strict parameter checking for disponly calls remained, the calls still going throu MASM's invoke.<br />So COMView version 1.5.0 was very short-lived, version 1.5.1 is now the right one.<br /><br />This was hard work<br /><br />Japheth</div>
    <div class="meta">Posted on 2003-01-02 19:36:38 by japheth</div>
   </div>
   <div class="post" id="post-74102">
    <div class="subject"><a href="#post-74102">Frustration takes a new kinda low...</a></div>
    <div class="body"><div class="quote">error 404: Datei nicht gefunden!<br /><br /> <br />Das angegebene Dokument konnte auf diesem Server leider nicht gefunden werden.</div><br /><br />I hope you will post your V1.5.1??<br /><br />Does this version generate the same DEFINE_DISPMETHOD's as before? I.e, you changed the macro, not the generated lines?<br /><br />Also,<br /><div class="quote">Now COMView generates 2 sort of includes only, one for the vtbles, one for disponlys (okay, one may put them together but you wont gain too much). Nothing is &quot;deactivated&quot; any more and has to be manually activated.</div><br />Sounds good, but to be honest there *is* alot to be gained.  I choped out all almost all the vtble's except _Application, Workbooks, and the Enumerated Equates.  No point having MASM build hash-table entries on stuff that wont work via. vtble calls.  However, as im sure your aware of, vtble calls are far faster, so its good to have a hybrid if you can.<br /><br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-01-02 21:30:34 by NaN</div>
   </div>
   <div class="post" id="post-74117">
    <div class="subject"><a href="#post-74117">Frustration takes a new kinda low...</a></div>
    <div class="body">Hi NaN,<br /><br />cannot reproduce your error 404. Did U use that link below?<br /><br /><a target="_blank" href="http://www.japheth.de/Download/COMView.ZIP">Heres the link</a> <br /><br />And the other points:<br /><br />- the generated DEFINE_DISPMETHOD lines havent changed<br />- the DISPMETHOD macro calls are still located in the other include (although superflous now) <br />- putting the two includes together: will think about it again<br /><br />What I want to do is implement support for a more flexible dispatch call like your MakeInvokeString. <br />But not without some changes :grin: . &quot;MakeInvokeString&quot; I would rename to &quot;PrepareInvoke&quot;, and since macro dm() is already used I would implement macro dmx(). The stack allocation you have implemented works and should be save (possibly except for some poorly written spy progs :) ), but I would prefer a solution without having data &quot;below&quot; esp across function calls.<br /><br />Japheth</div>
    <div class="meta">Posted on 2003-01-03 03:10:02 by japheth</div>
   </div>
   <div class="post" id="post-74123">
    <div class="subject"><a href="#post-74123">Frustration takes a new kinda low...</a></div>
    <div class="body">So, finally I have my more dynamic functions working. For excel automation it is really a relief. Its almost like your procs:<br /><br /><pre><code><br />dmx macro this&#58;req, interface, func&#58;req<br />	exitm &lt;ExecuteInvoke, this, &amp;interface&amp;_&amp;func&amp;DispId, &amp;interface&amp;_&amp;func&amp;Type&gt;<br />	endm<br /><br />sample&#58;<br />    invoke PrepareInvoke, addr tmpVariantArray, 2, VT_I4, 1, VT_I4, 1<br />    invoke dmx&#40;pCells, Range, get_Item&#41;, VT_BSTR, addr bstr, eax<br /></code></pre><br /><br />I have named the procs PrepareInvoke &amp; ExecuteInvoke. They are slightly modified to avoid this stack allocation stuff. <br /><br />Japheth</div>
    <div class="meta">Posted on 2003-01-03 06:26:10 by japheth</div>
   </div>
   <div class="post" id="post-74155">
    <div class="subject"><a href="#post-74155">Frustration takes a new kinda low...</a></div>
    <div class="body"><div class="quote"><br />Hi NaN,<br />...<br />What I want to do is implement support for a more flexible dispatch call like your MakeInvokeString. <br />But not without some changes :grin: . &quot;MakeInvokeString&quot; I would rename to &quot;PrepareInvoke&quot;, and since macro dm() is already used I would implement macro dmx(). The stack allocation you have implemented works and should be save (possibly except for some poorly written spy progs :) ), but I would prefer a solution without having data &quot;below&quot; esp across function calls.<br /><br />Japheth </div><br /><br />This is a valid concern.  I too thought about this.  1) would it be a problem on NT os's, 2) would it get overwritten by unknown functions... <br /><br />Turns out, both are no problem!  Especially #2.  The way i wrote it is that it fills the stack space at -1000h and returns the pointer to it.  When the InvokeHelp function is called, the first thing it does (with about 10 dword stack pushes at this point ~ well ahead of the data) is make stack space, and copies it up into the scope of the function.  This way it will be save to call as many functions as the stack will allow and not corrupt the VT string.<br /><br />I see your making variant arrays instead.  This works. But its more overhead than just using the stack you know ;) .  And its 100% safe.  Here is a what Im talking about (excuse the Acad image, its big, but to the point ;) ):<br /><br /><strong> Ooops, all those EBX's are to be EBP's ;) </strong></div>
    <div class="meta">Posted on 2003-01-03 12:43:40 by NaN</div>
   </div>
   <div class="post" id="post-74162">
    <div class="subject"><a href="#post-74162">Frustration takes a new kinda low...</a></div>
    <div class="body">NaN,<br />I fully understand that and I agree that its save. Even a Spy which - lets assume - hooks in all Win32 calls has no chance to crash your code because you dont make any win32 call the way from MakeInvoke... to InvokeHelp.<br />My concerns are exclusive aesthetical.<br /><br />I have another question about excel. I have got some problems with interface _Worksheet. My code crashes if I call some methods throu vtable (I used _Worksheet::get_Name). Using IDispatch::invoke worked. Thats a bit similar to the Range interface, but this time _Worksheet is clearly defined as &quot;dual&quot;, so COMview doesnt create the DISPMETHOD lines at all. Did you have this problem as well or do I have an outdatet office version (use office 2000 from summer 1999).<br /><br />Possibly I will need to expand comview with an option meaning: &quot;create as many interfaces as possible as dispatchonly, the rest as vtable&quot;. Currently its exactly the opposite<br /><br />Japheth</div>
    <div class="meta">Posted on 2003-01-03 13:17:05 by japheth</div>
   </div>
   <div class="post" id="post-74167">
    <div class="subject"><a href="#post-74167">Frustration takes a new kinda low...</a></div>
    <div class="body">To give you some idea what i have been doing, here is the working Excel class (still using my stack calling method):<br /><br />Check out how tight i got the code working :) .  I've wrapped 'major actions' into class methods, with a few extra bells and wistles :grin:<br /><br />The Excel.asm class is far from finished, but its also well underway..  As well the disphlp.inc is all dispatch stuff.  Ojbects.inc  is the OOP model Thomas and I developed.  Excelc.inc is your generated DISP output, with some vtbl (early binding) copied and pasted into it (as well as the inc's).<br /><br />You need to have VKim's debug installed and working to two outputs (prooving two functions).<br /><br />Enjoy ;)<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-01-03 13:38:42 by NaN</div>
   </div>
   <div class="post" id="post-74293">
    <div class="subject"><a href="#post-74293">Frustration takes a new kinda low...</a></div>
    <div class="body">Hi NaN,<br /><br />I studied your code and executed your sample. I see you currently are playing around and haven't had the need to deal with the _Worksheet interface, so you possibly couldn't say something about it.<br /><br />Please excuse my curiosity, but I have 2 questions about your oops model/generator?<br /><br />Do you have feedback from people using your generator and are above the &quot;playing with it&quot; state (say, having made a project with 10000 lines or more?<br /><br />What are these parameter names A,B,C,D standing for? Is that a restriction? Or do you prefer such variable names :grin: ?<br /><br /><div class="quote"><br />To give you some idea what i have been doing, here is the working Excel class (still using my stack calling method):<br /></div><br /><br />Please feel free to code how you like it. I am absolutely aware of that 10 persons have at least 10 different favorite coding styles.<br /><br />Japheth</div>
    <div class="meta">Posted on 2003-01-04 09:49:00 by japheth</div>
   </div>
   <div class="post" id="post-74311">
    <div class="subject"><a href="#post-74311">Frustration takes a new kinda low...</a></div>
    <div class="body">Yes i have had feedback.. the size of their projects i didnt ask, but they said they are happy using it.  (Im currious why you ask, i get the feeling you dont like the model at all).<br /><br />I have made large projects with it, and works well for me.  As had Thomas.<br /><br />As for the parameters, A,B,D,E,F,G etc... this is just me.  The generator makes them quickly since it doesnt ask for param lables. Only the method names and # of params... (is a first draft version that i have yet to update).   The param is not a limitation, only my lazyness for not renaming them to something meaningful ;)  As wrapper methods, i didnt feel wasting my time... <br /><br />As for the _Worksheets interface, no i have not used it directly yet... <br /><br />NaN</div>
    <div class="meta">Posted on 2003-01-04 12:07:25 by NaN</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=9833&amp;page=1" style="">&laquo;</a><a href="../?id=9833&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="9833" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>  </div>
 </body>
</html>