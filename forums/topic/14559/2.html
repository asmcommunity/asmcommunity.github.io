<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>memcpy - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=14559" />
  <link rel="prev" href="../?id=14559&amp;page=1" />   </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=14559">memcpy</a></p>
   <div class="post" id="post-152612">
    <div class="subject"><a href="#post-152612">fast memcopy</a></div>
    <div class="body">oh come on, windos is a big buggy dll,<br />some can do better than that<br /><br />copying memory? someone grade my code :)<br /><pre><code><br />move32&#58;shr cx,1  ; ds&#58;si = source, es&#58;di = destination, cx = size<br />       jnc .nb   ; les di,dest lds si,source<br />       movsb<br />.nb&#58;   shr cx,1<br />       jnc    .nw<br />       movsw<br />.nw&#58;   rep movsd<br />ret<br /><br />move64F&#58;shr    cx,1  ; ds&#58;si = source, es&#58;di = destination, cx = size<br />        jnc    .nb   ; les di,dest lds si,source<br />        movsb<br />.nb&#58;    shr    cx,1<br />        jnc    .nw<br />        movsw<br />.nw&#58;    shr    cx,1<br />        jnc    .nd<br />        movsd<br />.nd&#58;    jcxz   .done<br />.loop&#58;  fild   qword &#91;ds&#58;si&#93;<br />        fistp  qword &#91;es&#58;di&#93;<br />        add    si,8<br />        add    di,8<br />        dec    ecx<br />        jnz    .loop&#58;<br />.done&#58;  ret<br /><br />move128FC&#58;shr    cx,1  ; ds&#58;si = source, es&#58;di = destination, cx = size<br />         jnc    .nb   ; les di,dest lds si,source<br />         movsb<br />.nb&#58;     shr    cx,1<br />         jnc    .nw<br />         movsw<br />.nw&#58;     shr    cx,1<br />         jnc    .nd<br />         movsd<br />.nd&#58;     shr    cx,1<br />         jnc    .nq<br />         fild   qword &#91;ds&#58;si&#93;<br />         fistp  qword &#91;es&#58;di&#93;<br />         add    si,8<br />         add    di,8<br />.nq&#58;     jcxz   .done<br />.loop&#58;   fild   qword &#91;ds&#58;si&#93;<br />         fild   qword &#91;ds&#58;si+8&#93;<br />         fxch<br />         fistp  qword &#91;es&#58;di&#93;<br />         fistp  qword &#91;es&#58;di+8&#93;<br />         add    si,16<br />         add    di,16<br />         dec    cx<br />         jnz    .loop&#58;<br />.done&#58;   ret<br /><br />move128F&#58;shr    cx,1  ; ds&#58;si = source, es&#58;di = destination, cx = size<br />         jnc    .nb   ; les di,dest lds si,source<br />         movsb<br />.nb&#58;     shr    cx,1<br />         jnc    .nw<br />         movsw<br />.nw&#58;     shr    cx,1<br />         jnc    .nd<br />         movsd<br />.nd&#58;     shr    cx,1<br />         jnc    .nq<br />         fild   qword &#91;ds&#58;si&#93;<br />         fistp  qword &#91;es&#58;di&#93;<br />         add    si,8<br />         add    di,8<br />.nq&#58;     jcxz   .done<br />.loop&#58;   fild   qword &#91;ds&#58;si&#93;<br />         fild   qword &#91;ds&#58;si+8&#93;<br />         fistp  qword &#91;es&#58;di+8&#93;<br />         fistp  qword &#91;es&#58;di&#93;<br />         add    si,16<br />         add    di,16<br />         dec    cx<br />         jnz    .loop&#58;<br />.done&#58;   ret<br /><br />move256F&#58;shr    cx,1  ; ds&#58;si = source, es&#58;di = destination, cx = size<br />         jnc    .nb   ; les di,dest lds si,source<br />         movsb<br />.nb&#58;     shr    cx,1<br />         jnc    .nw<br />         movsw<br />.nw&#58;     shr    cx,1<br />         jnc    .nd<br />         movsd<br />.nd&#58;     shr    cx,1<br />         jnc    .nq<br />         fild   qword &#91;ds&#58;si&#93;<br />         fistp  qword &#91;es&#58;di&#93;<br />         add    si,8<br />         add    di,8<br />.nq&#58;     shr    cx,1<br />         jnc    .ndq<br />         fild   qword &#91;ds&#58;si&#93;<br />         fild   qword &#91;ds&#58;si+8&#93;<br />         fistp  qword &#91;es&#58;di+8&#93;<br />         fistp  qword &#91;es&#58;di&#93;<br />         add    si,16<br />         add    di,16<br />.ndq&#58;    jcxz   .done<br />.loop&#58;   fild   qword &#91;ds&#58;si&#93;<br />         fild   qword &#91;ds&#58;si+8&#93;<br />         fild   qword &#91;ds&#58;si+16&#93;<br />         fild   qword &#91;ds&#58;si+24&#93;<br />         fistp  qword &#91;es&#58;di+24&#93;<br />         fistp  qword &#91;es&#58;di+16&#93;<br />         fistp  qword &#91;es&#58;di+8&#93;<br />         fistp  qword &#91;es&#58;di&#93;<br />         add    si,32<br />         add    di,32<br />         dec    cx<br />         jnz    .loop&#58;<br />.done&#58;   ret<br /><br />move512F&#58;shr    cx,1  ; ds&#58;si = source, es&#58;di = destination, cx = size<br />         jnc    .nb   ; les di,dest lds si,source<br />         movsb<br />.nb&#58;     shr    cx,1<br />         jnc    .nw<br />         movsw<br />.nw&#58;     shr    cx,1<br />         jnc    .nd<br />         movsd<br />.nd&#58;     shr    cx,1<br />         jnc    .nq<br />         fild   qword &#91;ds&#58;si&#93;<br />         fistp  qword &#91;es&#58;di&#93;<br />         add    si,8<br />         add    di,8<br />.nq&#58;     shr    cx,1<br />         jnc    .ndq<br />         fild   qword &#91;ds&#58;si&#93;<br />         fild   qword &#91;ds&#58;si+8&#93;<br />         fistp  qword &#91;es&#58;di+8&#93;<br />         fistp  qword &#91;es&#58;di&#93;<br />         add    si,16<br />         add    di,16<br />.ndq&#58;    shr    cx,1<br />         jnc    .nqq<br />         fild   qword &#91;ds&#58;si&#93;<br />         fild   qword &#91;ds&#58;si+8&#93;<br />         fild   qword &#91;ds&#58;si+16&#93;<br />         fild   qword &#91;ds&#58;si+24&#93;<br />         fistp  qword &#91;es&#58;di+24&#93;<br />         fistp  qword &#91;es&#58;di+16&#93;<br />         fistp  qword &#91;es&#58;di+8&#93;<br />         fistp  qword &#91;es&#58;di&#93;<br />         add    si,32<br />         add    di,32<br />.nqq&#58;    jcxz   .done<br />.loop&#58;   fild   qword &#91;ds&#58;si&#93;<br />         fild   qword &#91;ds&#58;si+8&#93;<br />         fild   qword &#91;ds&#58;si+16&#93;<br />         fild   qword &#91;ds&#58;si+24&#93;<br />         fild   qword &#91;ds&#58;si+32&#93;<br />         fild   qword &#91;ds&#58;si+40&#93;<br />         fild   qword &#91;ds&#58;si+48&#93;<br />         fild   qword &#91;ds&#58;si+56&#93;<br />         fistp  qword &#91;es&#58;di+56&#93;<br />         fistp  qword &#91;es&#58;di+48&#93;<br />         fistp  qword &#91;es&#58;di+40&#93;<br />         fistp  qword &#91;es&#58;di+32&#93;<br />         fistp  qword &#91;es&#58;di+24&#93;<br />         fistp  qword &#91;es&#58;di+16&#93;<br />         fistp  qword &#91;es&#58;di+8&#93;<br />         fistp  qword &#91;es&#58;di&#93;<br />         add    si,64<br />         add    di,64<br />         dec    cx<br />         jnz    .loop&#58;<br />.done&#58;   ret<br /><br />move512FD&#58;shr    cx,1  ; ds&#58;si = source, es&#58;di = destination, cx = size<br />         jnc    .nb   ; les di,dest lds si,source<br />         movsb<br />.nb&#58;     shr    cx,1<br />         jnc    .nw<br />         movsw<br />.nw&#58;     shr    cx,1<br />         jnc    .nd<br />         movsd<br />.nd&#58;     shr    cx,1<br />         jnc    .nq<br />         fild   qword &#91;ds&#58;si&#93;<br />         fistp  qword &#91;es&#58;di&#93;<br />         add    si,8<br />         add    di,8<br />.nq&#58;     shr    cx,1<br />         jnc    .ndq<br />         fild   qword &#91;ds&#58;si&#93;<br />         fild   qword &#91;ds&#58;si+8&#93;<br />         fxch<br />         fistp  qword &#91;es&#58;di&#93;<br />         fistp  qword &#91;es&#58;di+8&#93;<br />         add    si,16<br />         add    di,16<br />.ndq&#58;    shr    cx,1<br />         jnc    .nqq<br />         fild   qword &#91;ds&#58;si&#93;<br />         fild   qword &#91;ds&#58;si+8&#93;<br />         fild   qword &#91;ds&#58;si+16&#93;<br />         fild   qword &#91;ds&#58;si+24&#93;<br />         fxch   st1 ; fxch   st3<br />         fxch   st2 ; fxch   st1<br />         fxch   st1 ; fxch   st2<br />         fxch   st3 ; fxch   st1<br />         fistp  qword &#91;es&#58;di&#93;<br />         fistp  qword &#91;es&#58;di+8&#93;<br />         fistp  qword &#91;es&#58;di+16&#93;<br />         fistp  qword &#91;es&#58;di+24&#93;<br />         add    si,32<br />         add    di,32<br />.nqq&#58;    jcxz   .done<br />.loop&#58;   fild   qword &#91;ds&#58;si&#93;<br />         fild   qword &#91;ds&#58;si+8&#93;<br />         fild   qword &#91;ds&#58;si+16&#93;<br />         fild   qword &#91;ds&#58;si+24&#93;<br />         fild   qword &#91;ds&#58;si+32&#93;<br />         fild   qword &#91;ds&#58;si+40&#93;<br />         fild   qword &#91;ds&#58;si+48&#93;<br />         fild   qword &#91;ds&#58;si+56&#93;<br />         fxch   st7<br />         fxch   st1<br />         fxch   st6<br />         fxch   st2<br />         fxch   st5<br />         fxch   st3<br />         fxch   st4<br />         fxch   st3<br />         fxch   st2<br />         fxch   st1<br />         fistp  qword &#91;es&#58;di&#93;<br />         fistp  qword &#91;es&#58;di+8&#93;<br />         fistp  qword &#91;es&#58;di+16&#93;<br />         fistp  qword &#91;es&#58;di+24&#93;<br />         fistp  qword &#91;es&#58;di+32&#93;<br />         fistp  qword &#91;es&#58;di+40&#93;<br />         fistp  qword &#91;es&#58;di+48&#93;<br />         fistp  qword &#91;es&#58;di+56&#93;<br />         add    si,64<br />         add    di,64<br />         dec    cx<br />         jnz    .loop&#58;<br />.done&#58;   ret<br /></code></pre><br /><br />my latest FPU move routine:<br /><pre><code><br /><br />move512FZ&#58;shr    cx,1  ; ds&#58;si = source, es&#58;di = destination, cx = size<br />         jnc    .nb   ; les di,dest lds si,source<br />         movsb<br />.nb&#58;     shr    cx,1<br />         jnc    .nw<br />         movsw<br />.nw&#58;     shr    cx,1<br />         jnc    .nd<br />         movsd<br />.nd&#58;     shr    cx,1<br />         jnc    .nq<br />         fild   qword &#91;ds&#58;si&#93;<br />         fistp  qword &#91;es&#58;di&#93;<br />         add    si,8<br />         add    di,8<br />.nq&#58;     shr    cx,1<br />         jnc    .ndq<br />         fild   qword &#91;ds&#58;si&#93;<br />         fild   qword &#91;ds&#58;si+8&#93;<br />         fxch<br />         fistp  qword &#91;es&#58;di&#93;<br />         fistp  qword &#91;es&#58;di+8&#93;<br />         add    si,16<br />         add    di,16<br />.ndq&#58;    shr    cx,1<br />         jnc    .nqq<br />         fild   qword &#91;ds&#58;si&#93;<br />         fild   qword &#91;ds&#58;si+8&#93;<br />         fild   qword &#91;ds&#58;si+16&#93;<br />         fild   qword &#91;ds&#58;si+24&#93;<br />         fxch   st3<br />         fistp  qword &#91;es&#58;di&#93;<br />         fxch   st1<br />         fistp  qword &#91;es&#58;di+8&#93;<br />         fistp  qword &#91;es&#58;di+16&#93;<br />         fistp  qword &#91;es&#58;di+24&#93;<br />         add    si,32<br />         add    di,32<br />.nqq&#58;    jcxz   .done<br />.loop&#58;   fild   qword &#91;ds&#58;si&#93;<br />         fild   qword &#91;ds&#58;si+8&#93;<br />         fild   qword &#91;ds&#58;si+16&#93;<br />         fild   qword &#91;ds&#58;si+24&#93;<br />         fild   qword &#91;ds&#58;si+32&#93;<br />         fild   qword &#91;ds&#58;si+40&#93;<br />         fild   qword &#91;ds&#58;si+48&#93;<br />         fild   qword &#91;ds&#58;si+56&#93;<br />         fxch   st7<br />         fistp  qword &#91;es&#58;di&#93;<br />         fxch   st5<br />         fistp  qword &#91;es&#58;di+8&#93;<br />         fxch   st3<br />         fistp  qword &#91;es&#58;di+16&#93;<br />         fxch   st1<br />         fistp  qword &#91;es&#58;di+24&#93;<br />         fistp  qword &#91;es&#58;di+32&#93;<br />         fistp  qword &#91;es&#58;di+40&#93;<br />         fistp  qword &#91;es&#58;di+48&#93;<br />         fistp  qword &#91;es&#58;di+56&#93;<br />         add    si,64<br />         add    di,64<br />         dec    cx<br />         jnz    .loop<br />.done&#58;   ret                          <br /><br /></code></pre><br />you can also do this with MMX, SSE</div>
    <div class="meta">Posted on 2004-11-09 13:33:18 by &gt;Matrix&lt;</div>
   </div>
  </div>
 </body>
</html>