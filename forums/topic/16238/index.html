<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>instring parsing - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=16238" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=16238">instring parsing</a></p>
   <div class="post" id="post-126078">
    <div class="subject"><a href="#post-126078">instring parsing</a></div>
    <div class="body">this is real sloppy so far i got it to return 192.168.0.1&lt;   so i still need it to strip off the remaining &lt;   if anyone could help clean it up and chop off the remaining &lt;<br /><br /><pre><code><br />; basically what i want to do is connect to &#91;url&#93;http&#58;//checkip.dyndns.org/&#91;/url&#93; and get the html soucre of the page<br />; into a string buffer which would look like<br />; &lt;html&gt;&lt;head&gt;&lt;title&gt;Current IP Check&lt;/title&gt;&lt;/head&gt;&lt;body&gt;Current IP Address&#58; 192.168.0.1&lt;/body&gt;&lt;/html&gt;<br />; i want to parse off the beginning junk up to the &#58;  in the string so it will look like <br />;  192.168.0.1&lt;/body&gt;&lt;/html&gt;<br />; then i want to parse the &lt;/body&gt;&lt;/html&gt; so i have the remaining ip address in the string<br /><br />.386<br />.model flat, stdcall<br />option casemap&#58;none<br />include C&#58;\masm32\include\kernel32.inc<br />include C&#58;\masm32\include\user32.inc<br />include C&#58;\masm32\include\windows.inc<br />include C&#58;\masm32\include\shell32.inc<br />includelib C&#58;\masm32\lib\kernel32.lib<br />includelib C&#58;\masm32\lib\user32.lib<br />includelib C&#58;\masm32\lib\shell32.lib<br /><br />Stripper PROTO &#58;DWORD, &#58;DWORD<br />.data<br />   szURL     db &quot;http&#58;//checkip.dyndns.org/&quot;,0<br />   szIP      db &quot;Current IP Address&#58; 192.168.0.1&lt;/body&gt;&lt;/html&gt;&quot;,0<br />.data?<br />   buffer    db 256 dup&#40;?&#41;<br />   szBuffer  db 256 dup&#40;?&#41;<br />   ipaddr    db 64 dup &#40;?&#41;<br />.code<br />Start&#58;<br />;first we have to connect to the url and get the html in a buffer<br />; since im dumb and dont know how to do that yet ill make a false buffer szIP<br /><br />invoke Stripper, ADDR szIP, ADDR buffer ; stripper ,the string to strip,the finished string <br />invoke MessageBox,0,addr szBuffer,0,0<br />invoke ExitProcess,0<br /><br />Stripper PROC theString&#58;DWORD, stripped&#58;DWORD<br />   push esi<br />   push edi<br />   push ebx<br />   push eax<br />   <br />   mov esi, theString<br />   mov ebx, esi<br />  <br />@@&#58;<br />   lodsb             ;Get character<br />   cmp al, 0         ;check if its zero<br />   je EOF            ;jump to EOF if 0 is found<br />   cmp al, '&#58;'       ;check for last &#58;<br />   jne @b            ; if not found jump back up to @@<br />   mov ebx, esi      ; save pointer to last found colon<br />   jmp @b            ; if not found jump back up to @@<br />   <br />EOF&#58;<br />   mov edi, stripped<br />   mov esi, ebx<br />@@&#58;<br />   lodsb<br />   stosb            ; Store String Byte  <br />   cmp al, 0        ;check for last zero<br />   jne @b<br />mov edi,offset szBuffer<br />mov esi,stripped     ;esi = pointer<br />@@&#58;                  ; now its time to strip of the end fat<br />    lodsb            ;load byte al<br />    stosb            ;store al esi<br />    cmp al,'&lt;'       ;is al '&lt;'?<br />    je @F            ;yeah, we're done<br />    jmp @B           ;nope, repeat<br />@@&#58;<br />   pop eax         ; time for a clean exit  &#58;D<br />   pop ebx<br />   pop edi<br />   pop esi<br />   ret<br />Stripper ENDP<br /><br />end Start<br /></code></pre> <br /> i wanted the stripper proc to have it be like invoke stripper,addr source,addr dest,addr frontstring,addr rearstring<br /> frontstring would be like the db &quot;:&quot;,0<br /> rearstring would be like db &quot; &lt; &quot;,0<br />that way it can be used with different webpages with different strings to parse<br /><br />:stupid:</div>
    <div class="meta">Posted on 2003-12-01 00:25:19 by illwill</div>
   </div>
   <div class="post" id="post-126083">
    <div class="subject"><a href="#post-126083">instring parsing</a></div>
    <div class="body"><pre><code><br />Stripper PROC uses esi edi ebx theString&#58;DWORD, stripped&#58;DWORD<br />   <br />   mov esi, theString<br />  <br />@@&#58;<br />   cmp BYTE PTR &#91;esi&#93;, 0<br />   je _ERROR            ;end of string and no &#58;<br />   cmp BYTE PTR &#91;esi&#93;, '&#58;'<br />   je @f<br />   inc esi      <br />   jmp @b            ; if not found jump back up to @@<br />@@&#58;<br />   inc esi<br />   inc esi	;one space before IP now esi should point to IP.<br /><br />   mov edi, stripped<br />@@&#58;<br />   lodsb<br />   cmp al, 0<br />   je NoMore<br />   cmp al, '&lt;'<br />   je NoMore<br />   stosb            ; Store String Byte  <br />   jmp @b<br />_ERROR&#58;<br />   mov eax, -1 ;function returns -1 if no IP found<br />   ret<br />NoMore&#58;<br />    &#91;B&#93;inc edi<br />    mov BYTE PTR &#91;edi&#93;, 0&#91;/B&#93;;bug fix<br />    mov eax, 0<br />    ret<br />Stripper ENDP<br /></code></pre></div>
    <div class="meta">Posted on 2003-12-01 02:16:58 by ENF</div>
   </div>
   <div class="post" id="post-126085">
    <div class="subject"><a href="#post-126085">instring parsing</a></div>
    <div class="body"><pre><code><br />stripper&#58;<br />;first para address to frontstrip<br />;second para address to rear strip<br />;third para address to string to scan<br />;fourth para address to string to store<br />mov ecx, &#91;esp+4&#93;<br />mov al, &#91;ecx&#93;<br />mov ecx, &#91;esp+8&#93;<br />mov ah, &#91;ecx&#93;<br />mov ecx, &#91;esp+12&#93;<br />_findstart&#58;<br />cmp byte ptr&#91;ecx&#93;, al<br />jz _found<br />cmp byte ptr&#91;ecx&#93;,0<br />jz _out<br />inc ecx<br />jmp _findstart<br />_found&#58;<br />inc ecx<br />push ebx<br />mov ebx, &#91;esp+16&#93;<br />_copy&#58;<br />mov dl, &#91;ecx&#93;<br />inc ecx<br />test dl, ah<br />jz _done<br />test dl, dl<br />jz _done<br />mov &#91;ebx&#93;, dl<br />inc ebx<br />jmp _copy<br />_done&#58;<br />mov byte ptr&#91;ebx+1&#93;, 0<br />pop ebx<br />clc<br />retn<br />_out&#58;<br />stc ; oops error<br />retn<br />;carry flag set on error<br />;destroys ecx, edx and eax<br /></code></pre><br />Untested</div>
    <div class="meta">Posted on 2003-12-01 02:19:40 by roticv</div>
   </div>
   <div class="post" id="post-126224">
    <div class="subject"><a href="#post-126224">instring parsing</a></div>
    <div class="body">sloppy but it works... it'll connect to <br /><a target="_blank" href="http://checkip.dyndns.org/">http://checkip.dyndns.org/</a> and pull grab the html and parse it til it finds the IP<br />good for people to get the ip of themselves outside their router <br /><pre><code><br />.386                    <br />.model flat,stdcall <br />option casemap&#58;none <br /><br />include \masm32\include\windows.inc <br />include \masm32\include\user32.inc <br />include \masm32\include\kernel32.inc <br />includelib \masm32\lib\user32.lib <br />includelib \masm32\lib\kernel32.lib <br /><br />include \masm32\include\wsock32.inc<br />includelib \masm32\lib\wsock32.lib<br />includelib \masm32\lib\wininet.lib<br />include \masm32\include\wininet.inc<br /><br />Download  PROTO &#58;DWORD<br />Stripper PROTO &#58;DWORD, &#58;DWORD<br />.data<br />   url1     db &quot;http&#58;//checkip.dyndns.org/&quot;,0<br />   szIP      db &quot;Your WAN IP&quot;,0<br />.data?<br />   buffer       db 256 dup&#40;?&#41;<br />   htmlBuffer   db 256 dup&#40;?&#41;<br />.code<br />Start&#58;<br /><br />invoke Download,addr url1<br />invoke Stripper, ADDR htmlBuffer, ADDR buffer ; stripper ,the string to strip,the finished string <br />invoke MessageBox,0,addr buffer,addr szIP,0<br />invoke ExitProcess,0<br /><br />Download PROC lpszURL&#58;DWORD<br />    local hInternet&#58;DWORD<br />    local hURL&#58;DWORD<br />    local hFile&#58;DWORD<br />    ;local htmlBuffer&#91;1024&#93;&#58;BYTE<br />    local BufferLen&#58;DWORD<br />    local BytesWrite&#58;DWORD<br />    jmp @F<br />    lpszAgent DB &quot;Mozilla&quot;,0<br />    @@&#58;<br />    invoke InternetOpen, addr lpszAgent, INTERNET_OPEN_TYPE_PRECONFIG, 0, 0, 0<br />    mov hInternet, eax<br />    invoke InternetOpenUrl, hInternet, lpszURL, 0, 0, 0, 0<br />    mov hURL, eax<br />        invoke InternetReadFile, hURL, addr htmlBuffer, sizeof htmlBuffer, addr BufferLen<br /><br />    invoke CloseHandle, hFile<br />    invoke InternetCloseHandle, hURL<br />    cmp eax, 0<br />    jz done<br />    invoke InternetCloseHandle, hInternet<br />    xor eax, eax<br />    inc eax<br />    ret    <br />    done&#58;<br />    xor eax, eax<br />    ret<br />    Download ENDP<br /><br />Stripper PROC uses esi edi ebx theString&#58;DWORD, stripped&#58;DWORD<br />   <br />   mov esi, theString<br />  <br />@@&#58;<br />   cmp BYTE PTR &#91;esi&#93;, 0<br />   je _ERROR            ;end of string and no &#58;<br />   cmp BYTE PTR &#91;esi&#93;, '&#58;'<br />   je @f<br />   inc esi      <br />   jmp @b            ; if not found jump back up to @@<br />@@&#58;<br />   inc esi<br />   inc esi	;one space before IP now esi should point to IP.<br /><br />   mov edi, stripped<br />@@&#58;<br />   lodsb<br />   cmp al, 0<br />   je NoMore<br />   cmp al, '&lt;'<br />   je NoMore<br />   stosb            ; Store String Byte  <br />   jmp @b<br />_ERROR&#58;<br />   mov eax, -1 ;function returns -1 if no IP found<br />   ret<br />NoMore&#58;<br />    inc edi<br />    mov BYTE PTR &#91;edi&#93;, 0;bug fix<br />    mov eax, 0<br />    ret<br />Stripper ENDP<br /><br />end Start<br /></code></pre> :grin: :grin:</div>
    <div class="meta">Posted on 2003-12-01 23:04:55 by illwill</div>
   </div>
  </div>
 </body>
</html>