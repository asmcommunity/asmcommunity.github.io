<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>posting to .asp/cgi - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=6222" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=8">Networking</a> &raquo; <a href="../?id=6222">posting to .asp/cgi</a></p>
   <div class="post" id="post-44732">
    <div class="subject"><a href="#post-44732">posting to .asp/cgi</a></div>
    <div class="body">having trouble with this code.... it seems like its posting right but it doesnt show up on the .asp page  and for some reason it loops when its not supposed to  im using winsock cuz i cant figure out how to use wininet<br /><br />WebPost PROTO :DWORD<br /><br />.data<br />    lpszAddy db &quot;www30.brinkster.com&quot;,0<br />    lpszString db &quot;GET <a target="_blank" href="http://%s/xillwillx/new.asp?%s,%s">http://%s/xillwillx/new.asp?%s,%s</a> HTTP/1.1&quot;,13,10<br />               db &quot;Connection: keep-alive&quot;,13,10<br />               db &quot;Host: %s&quot;,13,10<br />               db &quot;Referer: <a target="_blank" href="http://www30.brinkster.com/xillwillx/">http://www30.brinkster.com/xillwillx/</a>&quot;,13,10,13,10,13,10,0<br />    posttest   db 'hi im posted',0<br />     dwWEBStr dd 0<br />     hWEBSock dd 0<br />    lpszBuffer db 256 dup(?)<br />    lpWSAData WSADATA&lt;&gt;<br />    lpWEBSIN sockaddr_in&lt;&gt;<br />.code <br />    start: <br />      invoke WebPost,0<br />    invoke ExitProcess,NULL<br /><br />       <br />WebPost PROC dwError:DWORD<br />startnotify:<br />	INVOKE WSAStartup, 101h, ADDR lpWSAData<br />       ; INVOKE socket, 2, 1, 0<br />        INVOKE socket, AF_INET, SOCK_STREAM, 0	<br />        cmp eax, INVALID_SOCKET<br />        je error<br /><br />	MOV hWEBSock, EAX<br />	MOV lpWEBSIN.sin_family, 2<br />	INVOKE htons, 80<br />	MOV lpWEBSIN.sin_port, ax<br />	INVOKE gethostbyname, ADDR lpszAddy<br />	MOV EAX, <br />	MOV EAX, <br />	MOV EAX, <br />	MOV lpWEBSIN.sin_addr, EAX<br />	INVOKE connect, hWEBSock, ADDR lpWEBSIN, SIZEOF lpWEBSIN<br />	cmp EAX, SOCKET_ERROR<br />	je error<br /><br />          <br />	INVOKE wsprintf, ADDR dwWEBStr, ADDR lpszString, addr lpszAddy,addr posttest,addr posttest, addr lpszAddy<br />invoke MessageBox,0,addr dwWEBStr,addr dwWEBStr,MB_OK<br /><br />	INVOKE send, hWEBSock, ADDR dwWEBStr, EAX, 0<br />	cmp EAX, SOCKET_ERROR<br />	je error<br />        INVOKE closesocket, hWEBSock<br />	    INVOKE WSACleanup<br />        ret<br />error:<br />	INVOKE closesocket, hWEBSock<br />	INVOKE WSACleanup<br />	INVOKE Sleep, 3000<br />	JMP startnotify<br />WebPost ENDP<br />end start</div>
    <div class="meta">Posted on 2002-06-22 17:15:38 by illwill</div>
   </div>
   <div class="post" id="post-44734">
    <div class="subject"><a href="#post-44734">posting to .asp/cgi</a></div>
    <div class="body">the first parameter of wsprintf is a *buffer* that receives the formatted string. In your code, you don't supply a buffer but a pointer to a dword.<br />The dword will be filled with the first 4 bytes of the wsprintf output and will then overflow and corrupt all other data variables behind it. Add a new buffer (buffer db 256 dup (?) or something) to use, or use the existing one.<br />A few other things:<br />- 'hi im posted'. The spaces in that sentence will corrupt the request, they should be %20 (the whole URI after GET should be www/url-encoded). Btw, with 'posted', most of the time, the POST method is meant, not GET.<br />- Not really a problem, but it's better to use the right prefixes for variable names. lpszAddy for example, 'lpsz' means (long) pointer to a null terminated string. But it isn't that, it's a null terminated string, not a pointer to it. So szAddy would be a more appropriate name (lpszAddy should be a dword actually). It doesn't matter to the assembler but it avoids confusion.<br /><br />Thomas</div>
    <div class="meta">Posted on 2002-06-22 17:30:51 by Thomas</div>
   </div>
   <div class="post" id="post-44737">
    <div class="subject"><a href="#post-44737">thank you, u da man</a></div>
    <div class="body">WebPost PROTO :DWORD<br /><br />.data<br />    szAddy db &quot;www30.brinkster.com&quot;,0<br />    lpszString db &quot;POST <a target="_blank" href="http://%s/xillwillx/new.asp?%s,%s">http://%s/xillwillx/new.asp?%s,%s</a> HTTP/1.1&quot;,13,10<br />               db &quot;Connection: keep-alive&quot;,13,10<br />               db &quot;Host: %s&quot;,13,10<br />               db &quot;Referer: <a target="_blank" href="http://www30.brinkster.com/xillwillx/">http://www30.brinkster.com/xillwillx/</a>&quot;,13,10,13,10,13,10,0<br />    posttest   db 'Thomas%20Rules',0<br />     dwWEBStr dd 0<br />     hWEBSock dd 0<br />    lpszBuffer db 256 dup(?)<br />    lpWSAData WSADATA&lt;&gt;<br />    lpWEBSIN sockaddr_in&lt;&gt;<br />.data?<br />    buffer db 256 dup (?)<br />.code <br />    start: <br />      invoke WebPost,0<br />    invoke ExitProcess,NULL<br /><br />       <br />WebPost PROC dwError:DWORD<br />startnotify:<br />	INVOKE WSAStartup, 101h, ADDR lpWSAData<br />       ; INVOKE socket, 2, 1, 0<br />        INVOKE socket, AF_INET, SOCK_STREAM, 0	<br />        cmp eax, INVALID_SOCKET<br />        je error<br /><br />	MOV hWEBSock, EAX<br />	MOV lpWEBSIN.sin_family, 2<br />	INVOKE htons, 80<br />	MOV lpWEBSIN.sin_port, ax<br />	INVOKE gethostbyname, ADDR szAddy<br />	MOV EAX, <br />	MOV EAX, <br />	MOV EAX, <br />	MOV lpWEBSIN.sin_addr, EAX<br />	INVOKE connect, hWEBSock, ADDR lpWEBSIN, SIZEOF lpWEBSIN<br />	cmp EAX, SOCKET_ERROR<br />	je error<br /><br />          <br />	INVOKE wsprintf, ADDR buffer, ADDR lpszString, addr szAddy,addr posttest,addr posttest, addr szAddy<br />;invoke MessageBox,0,addr buffer,addr buffer,MB_OK<br /><br />	INVOKE send, hWEBSock, ADDR buffer, EAX, 0<br />	cmp EAX, SOCKET_ERROR<br />	je error<br />        INVOKE closesocket, hWEBSock<br />	    INVOKE WSACleanup<br />        ret<br />error:<br />	INVOKE closesocket, hWEBSock<br />	INVOKE WSACleanup<br />	INVOKE Sleep, 3000<br />	JMP startnotify<br />WebPost ENDP<br /><br />well this worked thank you .. btw i was talking with dawai on irc and he suggested using wininet.. he said it makes for cleaner coding... plus i gotta be able to use GET to read the posted text off the page... any other suggestions would be appreciated<br />:alright:</div>
    <div class="meta">Posted on 2002-06-22 17:55:07 by illwill</div>
   </div>
  </div>
 </body>
</html>