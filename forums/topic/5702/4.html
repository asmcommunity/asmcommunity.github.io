<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Shell for invoke - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=5702" />
  <link rel="prev" href="../?id=5702&amp;page=3" />  <link rel="next" href="../?id=5702&amp;page=5" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=5702">Shell for invoke</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=5702&amp;page=1" style="">&laquo;</a><a href="../?id=5702&amp;page=3" style="">&lt;</a><input type="hidden" name="id" value="5702" /><input type="number" name="page" min="1" max="5" step="1" value="4" onchange="this.form.submit();" /><a href="../?id=5702&amp;page=5">&gt;</a><a href="../?id=5702&amp;page=5">&raquo;</a></form>   <div class="post" id="post-42073">
    <div class="subject"><a href="#post-42073">Shell for invoke</a></div>
    <div class="body">Hi Satrukaan,<br /><br />1) You seem to call dispatchMessage once without a GetMessage. This seems like a felony to me, how do you get away with it. <br /><br />Its simple, the function call fails the first time its called but works on every other time its called. I used this technique to get a shorter message loop in terms of instruction count.<br /><br />2) In your first example the pointer you send to RegisterClassEx was in the stack,  and you restored the part it was in right after. Does this mean that RegisterClassEx makes a copy of the WNDCLASSEX structure. If so then couldn't you have one copy of the structure and modify it for each call to RegisterClassEx you need to make?<br /><br />Using the seperate function in the first example is not a problem, all the components of the WNDCLASSEX structure are parameters for the RegisterClassEx function so they only have to be passed once. The operating system already stores the starting address so the class gets registered without any problems at all.<br /><br />I agree with Maverick's view on C, its just a language that has no particular divine right, even if some see it that way, I see it as too old and too inflexible by modern standards.<br /><br />BuliaNaza is right on the original subject being discussed here, &quot;TO PRESERVE REGISTERS OR NOT&quot;.<br /><br />I have argued by example that the authodox method of constructing a program has size speed and reliability going for it and this includes preserving registers by the authodox published method.<br /><br />Its not that I deny anyone the capacity to use original ideas or do things differently but I differ as to prescribing it as a method that other people should use over proven documented technology.<br /><br />I am of the view that there must be some advantage in using a different technique from authodox and unless there is, you risk unreliable code for no purpose.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-06-08 23:25:09 by hutch--</div>
   </div>
   <div class="post" id="post-42081">
    <div class="subject"><a href="#post-42081">Shell for invoke</a></div>
    <div class="body">lol, thanks for the answers, I think that clears up a lot.<br /><br />But as regards to C and what not, I didn't mean to imply that C was the best.  I just ment that if it didn't matter whether you right fast assembly code around ExitProcess or slow assembly code, then it shouldn't matter if you write it in assembly or C.<br /><br />buliaNaza, I agree with you in the fact that all this is a is a matter of style, but you also seem to imply that optimizing code that a lot of people are saying doesn't need optimizing is intrical to your line of work.  I'm just curious as to what you do that requires such tuned assembly programs?</div>
    <div class="meta">Posted on 2002-06-09 00:45:10 by Satrukaan</div>
   </div>
   <div class="post" id="post-42105">
    <div class="subject"><a href="#post-42105">Wannabe 37337 EGO sucks.</a></div>
    <div class="body"><strong>buliaNaza:</strong> you've <em>serious</em> attitude-problems:<div class="quote"><strong>You just don't know what you are talking about..</div>I don't have time to mess with kids, so I'll stop here. Also, other than respect for my precious time, I have respect for your precious time.. otherwise how will you optimize the code around ExitProcess? :grin:<br /><br />And since you think you're a God but you're just 1.0/God, take this easy advice and improve on your long source posted on the 1st of June on this same thread (no, not the one for newbees, but the one for 37337 wannabes like you), and optimize for example your code:<br /><br /><pre><code><br />;Register the Main window class ; <br />               ...<br />               mov     dword ptr &#91;esp-&#40;5+0&#41;*4&#93;, 0      ;<br />               ...<br />               mov     dword ptr &#91;esp-&#40;8+0&#41;*4&#93;, 0      ;<br />               ...<br />;Create the main window	;<br />               mov     dword ptr &#91;esp-&#40;1+0&#41;*4&#93;, 0      ;<br />               mov     &#91;esp-&#40;2+0&#41;*4&#93;, esi              ; esi-&gt;hInstance<br />               mov     dword ptr &#91;esp-&#40;3+0&#41;*4&#93;, 0      ;<br />               mov     dword ptr &#91;esp-&#40;4+0&#41;*4&#93;, 0      ;<br />               ...<br />               mov     dword ptr &#91;esp-&#40;12+0&#41;*4&#93;, 0     ;<br />               ...<br />WinMainWait&#58;                                           ;<br />               lea     ecx, &#91;esp- &#40;4+0&#41;*4&#93;             ; loading auto stack<br />               mov     &#91;esp-&#40;5+0&#41;*4&#93;, offset WndProc   ; last return -&gt; WndProc<br />               mov     dword ptr &#91;esp-&#40;6+0&#41;*4&#93;, 0      ; 3 zeros are parameters <br />               mov     dword ptr &#91;esp-&#40;7+0&#41;*4&#93;, 0      ;    of GetMessage<br />               mov     dword ptr &#91;esp-&#40;8+0&#41;*4&#93;, 0      ; <br /></code></pre>to:<pre><code><br />               xor     edx,edx  ; HORROR!!! what?????? a k00l 37337 c0der like you doesn't know this?????<br />               ...              ; what happened??? you didn't feel like Registering the Main window class<br />               ...              ; required that much of optimization effort? Or you just weren't capable? ;D<br />               mov     dword ptr &#91;esp-&#40;5+0&#41;*4&#93;, edx    ;<br />               ...<br />               mov     dword ptr &#91;esp-&#40;8+0&#41;*4&#93;, edx    ;<br />               ...<br />;Create the main window	;<br />               mov     dword ptr &#91;esp-&#40;1+0&#41;*4&#93;, edx    ;<br />               mov     &#91;esp-&#40;2+0&#41;*4&#93;, esi              ; esi-&gt;hInstance<br />               mov     dword ptr &#91;esp-&#40;3+0&#41;*4&#93;, edx    ;<br />               mov     dword ptr &#91;esp-&#40;4+0&#41;*4&#93;, edx    ;<br />               ...<br />               mov     dword ptr &#91;esp-&#40;12+0&#41;*4&#93;, edx   ;<br />               ...<br />WinMainWait&#58;                                           ;<br />               lea     ecx, &#91;esp- &#40;4+0&#41;*4&#93;             ; loading auto stack<br />               mov     &#91;esp-&#40;5+0&#41;*4&#93;, offset WndProc   ; last return -&gt; WndProc<br />               mov     dword ptr &#91;esp-&#40;6+0&#41;*4&#93;, edx    ; 3 zeros are parameters <br />               mov     dword ptr &#91;esp-&#40;7+0&#41;*4&#93;, edx    ;    of GetMessage<br />               mov     dword ptr &#91;esp-&#40;8+0&#41;*4&#93;, edx    ; <br /></code></pre>that would fit your wannabe-37337 &quot;coding <strong>style</strong>&quot;..<br />So much for your not wanting to preserve one register (but if you were smart, and you aren't, you would avoid also that xor edx,edx and track down a register with 0 value.. I even saw a xor edx,edx after your WinMain label!), make the code faster for a number of reasons, and will also save a lot of bytes.. hey, I hope you don't use a linker, but have your own PE generator, otherwise code will be anyway FILEALIGNED, and all will be useless.. don't you know?<br /><br />But the real size problem here is that you got a big <span style="font-size:54><strong><u>EGO</u></strong></span>. Just that. And that's what 3 years old kids have, but then lose.. when they become really skilled (relative to you and your big mouth).<br /><br />F*ck, you must be really a pityful lamer with a big and ineducated mouth if you don't even know that your:<br /><pre><code><br />OnSysCommand&#58;                                          ;<br />               mov     eax, &#91;esp+&#40;3+0&#41;*4&#93;              ; 3-&gt;wParam<br />               and     eax, 0FFF0h                     ;<br />               cmp     eax, SC_CLOSE                   ; Alt+F4 or menu item Close<br />               je      OnDestroy                       ;<br />               jmp     DefWindowProc                   ;<br />;..................................<br />OnSize&#58;                                                ;<br />               jmp     DefWindowProc                   ;<br /></code></pre>can be replaced with a better:<pre><code><br />OnSysCommand&#58;                                          ;<br />               mov     eax, &#91;esp+&#40;3+0&#41;*4&#93;              ; 3-&gt;wParam<br />               and     eax, 0FFF0h                     ;<br />               cmp     eax, SC_CLOSE                   ; Alt+F4 or menu item Close<br />               je      OnDestroy                       ;<br />OnSize&#58;                                                ;<br />               jmp     DefWindowProc                   ;<br /></code></pre><br />So, if you wanna do an intelligent thing, from now on stop insulting other people in this forum, and start to be friendly and humble as you (and anybody else, me first) have to be, and leave the 37337ism to the lamers, it's to them that it really belongs.</div>
    <div class="meta">Posted on 2002-06-09 04:58:34 by Maverick</div>
   </div>
   <div class="post" id="post-42110">
    <div class="subject"><a href="#post-42110">Shell for invoke</a></div>
    <div class="body">Sorry Maverick that i brought your name up but it's always good to hear you speak and no one can do it better...Your are not known to be a very nice guy when you get piss either. <br /><br />buliaNaza, you are great but us little people want to learn too.  My only friends are Dead Presidents and i don't have enought of them.<br /><br />I am out of here, i will never stand between true Code Warrior as you guys are.<br /><br /><span style="font-size:9px>Keep up the great work.  There always room for improvement within a large block of code.</span></div>
    <div class="meta">Posted on 2002-06-09 05:50:26 by cmax</div>
   </div>
   <div class="post" id="post-42118">
    <div class="subject"><a href="#post-42118">Shell for invoke</a></div>
    <div class="body"><div class="quote"><br />Sorry Maverick that i brought your name up but it's always good to hear you speak and no one can do it better...Your are not known to be a very nice guy when you get piss either.</div>hehe.. yep, I'm hot blooded.. but I learnt that one has to give respect to the others.. so I do, unless I see that somebody doesn't do it, and I like to pay the same coin back in that case.<br />Perhaps I could have avoided my post to buliaNaza, but I hope he understands that his attitude is very wrong, and that he should be more friendly to others, instead of looking like that 37337 crap.<br />At the end he will be a better person if he is constructive instead of being destructive, given that nobody had treated him bad before.</div>
    <div class="meta">Posted on 2002-06-09 06:46:58 by Maverick</div>
   </div>
   <div class="post" id="post-42132">
    <div class="subject"><a href="#post-42132">Shell for invoke</a></div>
    <div class="body">Cmax,<br />Do you remember:;)<br />&quot;Hello buliaNaza ,<br />Can you post a small example with some comments please?&quot;<br /><br />&quot; Hi, cmax<br />Of course, I can post an example but the question is WHY?&quot;<br /><br />Now you can see what happens...I'm guilty for my answer...<br /><br /><br /><br /><br />Satrukaan,<br />&quot;..I'm just curious as to what you do that requires such tuned <br />assembly programs?&quot;<br />you can take a look here: h**p://ati.com/<br /><br /><br /><br /><br />Hutch,<br />&quot;Its not that I deny anyone the capacity to use original ideas or <br />do things differently but I differ as to prescribing it as a method<br />that other people should use over proven documented <br />technology.&quot;<br /><br />&quot;..method that other people should use...&quot;<br />Why do you think so? I never wrote such things and don't care<br />about other's programming styles, languages and methods,<br />because it is not my business...<br />I am not a teacher or &quot;guru&quot;...<br /><br />&quot;... proven documented technology...&quot;<br />Ha, ha.. just read Matt Pietrek's book and articles.<br /><br /><br /><br />Maverik,<br />this is a FAST and UNOPTIMIZED example and its goal was<br />just to prove the original subject being discussed here,<br />&quot;TO PRESERVE REGISTERS OR NOT&quot;.<br />I created it using copy and paste of different parts of <br />UNOPTIMIZED code because it is just an example NOT a <br />program...<br />I want to thank you for your impressive answer of my question<br />&quot;...how you appreciate unknown people from different cultures...&quot;<br />because I learned a bit more who is who here...<br /><br />;)</div>
    <div class="meta">Posted on 2002-06-09 09:27:48 by buliaNaza</div>
   </div>
   <div class="post" id="post-42202">
    <div class="subject"><a href="#post-42202">Shell for invoke</a></div>
    <div class="body"><strong>buliaNaza</strong> again:<div class="quote">this is a FAST and UNOPTIMIZED example</div>Do not make even more a fool of yourself.. such trivial optimizations do not need to be made on a second phase.. you just didn't make them, period, but you bothered those that push/pop a couple of registers they use around a call to a slow Win32 API function, using your 37337 attitude against them. Those are the simple facts. Otherwise I would have never bothered to write that reply.<br /><br />I do respect other peoples and other cultures, I just can't respect who doesn't know the meaning of this word.<br /><br />Goodbye.</div>
    <div class="meta">Posted on 2002-06-09 15:45:18 by Maverick</div>
   </div>
   <div class="post" id="post-42208">
    <div class="subject"><a href="#post-42208">Shell for invoke</a></div>
    <div class="body">&quot;I do respect other peoples and other cultures, I just can't respect who doesn't know the meaning of this word.&quot;<br /><br /><br />bitRAKE to Maverick:<br />&quot;I am just curious of how you reach your conclusions?&quot;<br /><br /><br /><br />The_Svin to Maverik:<br /><br />&quot;You have a talant man to turn any sientific discussion into personal things Meveric, when somebody tries to analyze(or <br />critisize) my method (or thoughts) or beat my code I take it as<br />sign of respect, 'cause it is ferm fact that he wasted his time <br />(found worthy to waste it) to follow and study my things.<br />Why almost any negative comments about your things you take <br />as a personal insults?&quot;<br /><br /><br />Maverik to The_Svin:<br /><br />Are you blind or what? That's what I did.. I compared all methods <br />on 64 iterations, not 256. So what are you trying to say now? &quot;<br /><br /><br />bitRAKE to Maverick:<br /><br />&quot;No, I'm speaking of the method that buliaNaza has posted <br />BT/JNC. It is the only two instruction method posted above - I <br />could call you 'blind' here, but it would only serve to admit my <br />extreme dis-like for your words to Svin - he can take care of <br />himself.&quot; <br /><br /><br /><br />Maverik to The_Svin:<br /><br />&quot;Dammit, you must be stupid.. 64 iterations test for all 64 <br />possible bits in the bitmap.<br />Hello? Is anybody home? &quot;<br /><br /><br /><br />bitRAKE to Maverik:<br />&quot;Solve this problem for me: How can both of my comments be <br />correct? I am not in the habit of contradicting myself. You make <br />broad assumptions of Svin and myself. Not that I am not guilty of <br />the same. I would hope that we can learn to communicate well, <br />for there is much that we should learn from each other. There is <br />nothing more important for me!&quot;<br /><br /><br />will be continued...;)</div>
    <div class="meta">Posted on 2002-06-09 17:11:37 by buliaNaza</div>
   </div>
   <div class="post" id="post-42209">
    <div class="subject"><a href="#post-42209">Shell for invoke</a></div>
    <div class="body">Putting phrases out of their context to prove that you're even more a lamer is what fills my today's daily laugh. :grin:</div>
    <div class="meta">Posted on 2002-06-09 17:16:32 by Maverick</div>
   </div>
   <div class="post" id="post-42213">
    <div class="subject"><a href="#post-42213">Shell for invoke</a></div>
    <div class="body">&quot;wannabe elitish stupidity&quot;<br /><br />&quot;Also, often that kind of coders are also lame at the end,&quot;<br /><br />&quot;Wannabe 37337 EGO sucks.&quot;<br /><br />&quot;buliaNaza: you've serious attitude-problems:&quot;<br /><br />&quot;I don't have time to mess with kids, so I'll stop here.<br /> Also, other than respect for my precious time, I have<br /> respect for your precious time.. otherwise how will you optimize <br />the code around ExitProcess? &quot;<br /><br />&quot;And since you think you're a God but you're just 1.0/God&quot;<br /><br />&quot;the one for newbees, but the one for 37337 wannabes like you&quot;<br /><br />&quot;that would fit your wannabe-37337 &quot;coding style&quot;..&quot;<br /><br />&quot;but if you were smart, and you aren't,&quot;<br /><br />&quot;here is that you got a big EGO. &quot;<br /><br />&quot;F*ck, you must be really a pityful lamer with a big and ineducated mouth&quot;<br /><br />&quot;and leave the 37337ism to the lamers,&quot;<br /><br />&quot;hehe.. yep, I'm hot blooded..&quot;<br /><br />&quot;but I hope he understands that his attitude is very wrong, and that he should be more friendly to others, instead of looking like that 37337 crap.&quot;<br /><br />&quot;Do not make even more a fool of yourself&quot;<br /><br />&quot;using your 37337 attitude against them.&quot;<br /><br />&quot;to prove that you're even more a lamer&quot;</div>
    <div class="meta">Posted on 2002-06-09 17:39:25 by buliaNaza</div>
   </div>
   <div class="post" id="post-42218">
    <div class="subject"><a href="#post-42218">Shell for invoke</a></div>
    <div class="body">Yes, and you deserved all of them, because you started it.<br /><br />Now please go code something, and don't forget the basic optimization rules. :grin:</div>
    <div class="meta">Posted on 2002-06-09 18:21:31 by Maverick</div>
   </div>
   <div class="post" id="post-42222">
    <div class="subject"><a href="#post-42222">Shell for invoke</a></div>
    <div class="body">Yes, sir!:grin: :grin: :grin: <br />(don't bother him because he is seriously sick)</div>
    <div class="meta">Posted on 2002-06-09 19:00:10 by buliaNaza</div>
   </div>
   <div class="post" id="post-42233">
    <div class="subject"><a href="#post-42233">Shell for invoke</a></div>
    <div class="body">You are right buliaNaza,  but i am glad that you replied.  It is of great interest as it is.  A whole lots of people used to be big headed with there source samples and you are not the only one that had said things that may hurt other people feeling.... But people did also come in saying things that may hurt your feeling also.   You guys are too HEAVY for this to continue.  i wish ya would stop and get back to the business of optimization. It would be like WoW if two minds of you guys  caluber were to work together they have to re-write the art of programming for the betterment of ALL... No one man is always right. But no more match making for me.<br /><br />I am out of here and thanks again buliaNaza.</div>
    <div class="meta">Posted on 2002-06-09 20:42:48 by cmax</div>
   </div>
   <div class="post" id="post-42234">
    <div class="subject"><a href="#post-42234">Shell for invoke</a></div>
    <div class="body">Thanks cmax,<br />You are welcome...;)</div>
    <div class="meta">Posted on 2002-06-09 20:59:56 by buliaNaza</div>
   </div>
   <div class="post" id="post-42243">
    <div class="subject"><a href="#post-42243">Shell for invoke</a></div>
    <div class="body"><strong>buliaNaza</strong>, I value the example you have posted and it has given me much to think about.  Do you design with these severe optimizations in mind at the start, or does the code evolve into this state, or both?  I would need many notes on what is going on to make changes easier, but maybe with this being your style, you have become accustom to the level of convolution.<br /><br /><strong>buliaNaza</strong>, you can see when I say, &quot;In the world all the matters is what gets the job done&quot;, this applies to your code - because you believe your job does require this level of optimization.  I still have not found why your first example loads so slow.</div>
    <div class="meta">Posted on 2002-06-09 21:42:22 by bitRAKE</div>
   </div>
   <div class="post" id="post-42249">
    <div class="subject"><a href="#post-42249">Shell for invoke</a></div>
    <div class="body">Hi bitRAKE,;) <br /><br />&quot;Do you design with these severe optimizations in mind at the start, or does the code evolve into this state, or both?&quot;<br /><br />The original subject being discussed here is <br />&quot;TO PRESERVE REGISTERS OR NOT&quot;.<br />So, I expected questions like this:<br />&quot;Why you can write<br />            mov    edi, 12345678h<br />            mov    esi, 12345678h<br />            mov    ebx, 12345678h<br />            mov    ebp, 12345678h<br />and Hutch can't?&quot;	<br />For me that is the main question here rather optimization, styles, bla, bla, etc. <br /><br />Please allow me to answer you with question:<br />Did anyone understand why?;)</div>
    <div class="meta">Posted on 2002-06-09 22:22:44 by buliaNaza</div>
   </div>
   <div class="post" id="post-42250">
    <div class="subject"><a href="#post-42250">Shell for invoke</a></div>
    <div class="body"><strong>buliaNaza</strong>, I sorry, but I don't understand to which question you are referring.  I did not ask the question in your reply!?  &quot;TO PRESERVE REGISTERS OR NOT&quot; - I think you have answered. :)</div>
    <div class="meta">Posted on 2002-06-09 22:35:32 by bitRAKE</div>
   </div>
   <div class="post" id="post-42256">
    <div class="subject"><a href="#post-42256">Shell for invoke</a></div>
    <div class="body">What a hot discussion!.. :)<br />The first question was not &quot;TO PRESERVE REGISTERS OR NOT&quot;. Nobody can deny the necessity to preserve registers before calling api functions. Look at this code:<br /><pre><code><br />.data<br />dwValue dword 10<br /><br />.code<br />main&#58;<br />    mov edx, offset dwValue<br />    invoke MessageBox, NULL, CTEXT&#40;&quot;Message&quot;&#41;, CTEXT&#40;&quot;Caption&quot;&#41;, MB_OK<br />    mov eax, dword ptr &#91;edx&#93;<br />    ret<br />end main<br /></code></pre><br />Is eax 10 after calling MessageBox? No! MessageBox corrupts edx register. So you have to preserve edx before this function. Sometimes you don't know which registers will be corrupted by function. So you have to disasm the function to get this information or preserve all registers with pushad/popad.</div>
    <div class="meta">Posted on 2002-06-09 23:04:02 by vkim</div>
   </div>
   <div class="post" id="post-42257">
    <div class="subject"><a href="#post-42257">Shell for invoke</a></div>
    <div class="body">Just change edx with edi or esi or ebx or ebp  <br />and you are in the game..;)</div>
    <div class="meta">Posted on 2002-06-09 23:10:01 by buliaNaza</div>
   </div>
   <div class="post" id="post-42259">
    <div class="subject"><a href="#post-42259">Shell for invoke</a></div>
    <div class="body">Grin,<br /><br />Thats because the API call observes the convention of preserving EBX ESI &amp; EDI.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-06-09 23:16:03 by hutch--</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=5702&amp;page=1" style="">&laquo;</a><a href="../?id=5702&amp;page=3" style="">&lt;</a><input type="hidden" name="id" value="5702" /><input type="number" name="page" min="1" max="5" step="1" value="4" onchange="this.form.submit();" /><a href="../?id=5702&amp;page=5">&gt;</a><a href="../?id=5702&amp;page=5">&raquo;</a></form>  </div>
 </body>
</html>