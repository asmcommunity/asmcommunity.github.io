<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Shell for invoke - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=5702" />
  <link rel="prev" href="../?id=5702&amp;page=2" />  <link rel="next" href="../?id=5702&amp;page=4" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=5702">Shell for invoke</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=5702&amp;page=1" style="">&laquo;</a><a href="../?id=5702&amp;page=2" style="">&lt;</a><input type="hidden" name="id" value="5702" /><input type="number" name="page" min="1" max="5" step="1" value="3" onchange="this.form.submit();" /><a href="../?id=5702&amp;page=4">&gt;</a><a href="../?id=5702&amp;page=5">&raquo;</a></form>   <div class="post" id="post-41931">
    <div class="subject"><a href="#post-41931">Shell for invoke</a></div>
    <div class="body">&quot;....Can be replaced by: bla bla &quot;<br /><br />No, it can't because this is a NEWBIE version!!!<br />If you are an optimization &quot;guru&quot; please optimize<br />my original example...ha..ha;)</div>
    <div class="meta">Posted on 2002-06-07 16:46:59 by buliaNaza</div>
   </div>
   <div class="post" id="post-41932">
    <div class="subject"><a href="#post-41932">Shell for invoke</a></div>
    <div class="body"><strong>buliaNaza</strong>, I'm a windows NEWBIE, else I'd give it a go. ;)<br />Is there a way to speed the load time?  It is <u>really</u> bad.</div>
    <div class="meta">Posted on 2002-06-07 16:53:22 by bitRAKE</div>
   </div>
   <div class="post" id="post-41935">
    <div class="subject"><a href="#post-41935">Shell for invoke</a></div>
    <div class="body">Where is the true?<br />here:<br />&quot;...I'm a windows NEWBIE, else I'd give it a go..&quot;<br /><br />or here:<br />&quot;...I'm just trying to help buliaNaza understand the interface - which he is already aware of....&quot;<br /><br />&quot;Is there a way to speed the load time? It is really bad.&quot;<br />I tested it with WinXP,Win2k Data Center and WinME<br />and all work fine for me..<br />My advice is: just check additional software as<br />firewalls, antivirus programs, some &quot;useless&quot; services on XP, etc.<br /><br />From other point of view it is just an example not the program to be optimized...;)</div>
    <div class="meta">Posted on 2002-06-07 17:12:57 by buliaNaza</div>
   </div>
   <div class="post" id="post-41937">
    <div class="subject"><a href="#post-41937">Shell for invoke</a></div>
    <div class="body"><strong>buliaNaza</strong>, that is strange.  The only program<br />that loads slower is VS.Net and maybe M$ Word. ;)<br />Truth is where you look for it. ;)</div>
    <div class="meta">Posted on 2002-06-07 17:22:55 by bitRAKE</div>
   </div>
   <div class="post" id="post-41954">
    <div class="subject"><a href="#post-41954">Shell for invoke</a></div>
    <div class="body">There is only one problem with this masterpiece, it builds at 3k but does not display at startup and sits dead in memory until you use Ctrl+Alt+Del to close it down.<br /><br />Built in win95b, PIII 600, 768 meg ram.<br /><br />At least it did not GP fault. :grin: <br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-06-07 21:01:30 by hutch--</div>
   </div>
   <div class="post" id="post-41955">
    <div class="subject"><a href="#post-41955">Shell for invoke</a></div>
    <div class="body">Can you post your exe file here?</div>
    <div class="meta">Posted on 2002-06-07 21:35:02 by buliaNaza</div>
   </div>
   <div class="post" id="post-41961">
    <div class="subject"><a href="#post-41961">Shell for invoke</a></div>
    <div class="body">It wouldn't run for me either. At least, not until I changed the line<br /><br />xor esi,0FFFF0000h<br /><br />to<br /><br />and esi,0FFFF0000h<br /><br />and it ran fine.<br /><br />Overall, bulianaza, I like the programming style. Very slick.<br /><br />Of course, the whole dword  etc is a little difficult to read. I imagine for common things like wParam, etc you could just use some type of EQU. Not sure if this is too HLL in your books ;)<br /><br /><br />--Chorus</div>
    <div class="meta">Posted on 2002-06-07 22:17:29 by chorus</div>
   </div>
   <div class="post" id="post-41965">
    <div class="subject"><a href="#post-41965">Shell for invoke</a></div>
    <div class="body">Thanks chorus,<br />Of course you are right.<br />The error is mine. :)</div>
    <div class="meta">Posted on 2002-06-07 22:36:10 by buliaNaza</div>
   </div>
   <div class="post" id="post-41968">
    <div class="subject"><a href="#post-41968">Shell for invoke</a></div>
    <div class="body">Here is a 2k replacement that does the stack preservations correctly. :grin:<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a><br /><br />PS : Build in the standard MASM32 environment.</div>
    <div class="meta">Posted on 2002-06-07 23:01:53 by hutch--</div>
   </div>
   <div class="post" id="post-41969">
    <div class="subject"><a href="#post-41969">Shell for invoke</a></div>
    <div class="body">BuliaNaza,<br />  I do have a couple questions for you:<br />  Why call DefWindowProc for stuff like WM_PAINT when you're handling it? Is it just to balance the stack? couldn't this be replaced by a ret 16?<br />  And why use mov ,r/m instead of push? Doesn't push code smaller?<br /><br />  Finally, I'm surprised by two things (although I understand this is a &quot;newbie&quot; example). One is that you process WM_CREATE to save hWnd when you could handle it on return from CreateWindowEx. And the other is this bit of code from WM_DESTROY:<br /><br /><pre><code><br />        .if eax == IDNO				;<br />		jmp WinMainExit			; loop again<br />	.endif					;<br />		jmp ExitProcess			; Exit<br /></code></pre><br /><br />  just because I thought .if and other directives were &quot;bad&quot; ;)<br /><br />Take it easy<br /><br />--Chorus</div>
    <div class="meta">Posted on 2002-06-07 23:04:15 by chorus</div>
   </div>
   <div class="post" id="post-41974">
    <div class="subject"><a href="#post-41974">Shell for invoke</a></div>
    <div class="body">Sorry about the bloated excess of the last demo, it was done in a hurry, here is the 1.5k version that does its stack preservations correctly. :)<br /><br />I question the wisdom of using difficult techniques that do not build smaller, are no faster, are far more difficult to read, are very difficult to develop into a large size app and are so slow to work on that they would be ready for the release of win3k.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a><br /><br />PS : Interesting that this post has the same number as the byte size of the posted example. :tongue:</div>
    <div class="meta">Posted on 2002-06-07 23:46:05 by hutch--</div>
   </div>
   <div class="post" id="post-41983">
    <div class="subject"><a href="#post-41983">Shell for invoke</a></div>
    <div class="body">Chorus, the subject here is &quot;TO PRESERVE REGISTERS OR NOT&quot;<br />rather my programming style...<br />All your questions are related to my own programming style. Well...;) <br /><br />&quot;..One is that you process WM_CREATE to save hWnd when you <br />could  handle it on return from CreateWindowEx...&quot;<br />Of course you can save hWnd after CreateWindowEx but<br />you can't use it in OnCreate proc; you need to get the right <br />window handle from the stack again in OnCreate proc, if you<br />need to create child  windows. So you have one operation more.. <br /><br />&quot;...just because I thought .if and other directives were &quot;bad&quot;...&quot;<br />You are right but this is &quot;an easy reading&quot; for people which<br />understand INVOKE and other HLA stuff ONLY...More Info: in<br />smalwin.zip and smalwin2.zip(If you are lazy to download them<br />just read Generic.asm from your \MASM32\EXAMPLES\GENERIC<br />directory. Very usefull reading!!! )<br /><br />&quot;Why call DefWindowProc for stuff like WM_PAINT when you're<br />handling  it? Is it just to balance the stack? couldn't this be<br />replaced by a ret 16?&quot;<br />This question is a bit more complicated...<br /><br />We may have or haven't a calling system procedure to return 0.<br /><br />We have a calling system procedure when the system fills the<br />stack with parameters and directly call WinProc (in our program<br />when cmp esp, dStack  is NOT zero; because we have parameters) <br /><br />We haven't a calling system procedure when<br />cmp esp, dStack  is ZER0; we haven't parameters and we must <br />use GetMessage to get the next message from the queue.<br /><br />So, I use safety DefWindowProc because:<br />from MSDN -&gt; &quot;Your application can call the DefWindowProc <br />function as  part of the processing of a message. In such a case,<br />the application can  modify the message parameters before <br />passing the message to  DefWindowProc, OR IT CAN CONTINUE<br />WITH THE DEFAULT PROCESSING AFTER PERFORMING ITS OWN <br />OPERATIONS. &quot;<br /><br />&quot;And why use mov ,r/m instead of push? Doesn't push<br />code  smaller?&quot; This question was from your homework...<br />Well, if you use push to call GetMessage what happen:<pre><code><br />	push 0<br />        push 0<br />        push 0<br />	push offset msg	;msg  MSG &lt;&gt;<br />	call GetMessage<br />Label_1&#58;<br />or<br />	push 0<br />        push 0<br />        push 0<br />	push offset msg	;msg  MSG &lt;&gt;<br />	push offset Label_1 ; return address 	<br />        jmp  GetMessage<br />Label_1&#58;</code></pre><br /><br />Now you have four &quot;important&quot; parameters for WinProc in msg.<br />But you need these four parameters in the stack rather in msg!!!<br />Here is the stupidity because you must get these parameters <br />from msg and push them into the stack. Return addresses too...<br /> A lot of code and  one useless structure - msg...In the MS<br />programs that is a job for DispatchMessage API...Again a lot of<br />code...So, I know where the next proc (WinProc) will looking for<br />parameters in the stack and now I'm just loading  the stack with<br />the right numbers...Easy!<br />From other point of view Intel and particularly Agner Fog prefer<br />the usage of the mov directly to/from stack rather  push/pop for<br />the new processors!?<br />;)</div>
    <div class="meta">Posted on 2002-06-08 03:27:16 by buliaNaza</div>
   </div>
   <div class="post" id="post-41989">
    <div class="subject"><a href="#post-41989">Shell for invoke</a></div>
    <div class="body"><strong>buliaNaza, </strong> I don't know what to say.... This is beyond my imagination of ASM (back to the hard way but even BETTER ) This prove that many things that was thought impossible was always possible.... I knew it all the time but i did not have a clue until now.... <br /><br />I know enough about ASM to take the plunge into this new pit of ASM HELL.... It's not going to be easy but i want to know how to do a few things based on your  code...<br /><br />Boss Style <strong>buliaNaza, </strong> , it's hard to believe that you BACK UP nearly everything you did.<br /><br />I would like to see what  <strong>Maverick </strong> have to say about this...In my option he's your match.<br /><br />Thanks for cluing some of us up...</div>
    <div class="meta">Posted on 2002-06-08 06:48:53 by cmax</div>
   </div>
   <div class="post" id="post-42011">
    <div class="subject"><a href="#post-42011">Shell for invoke</a></div>
    <div class="body">There is one api i would like to put a lock down on B Style and that is SendMessage.  Would i use your GetMessage setup to do the same... I think SendMessage eats up a lot of Windows memory when our programs use it extensively as i do in my app. But it could be something else wrong with-in my hook but i would like to tackle SendMessage first for the record.<br /><br />PS: I forgot to mension <strong>acnev</strong>  to be included in that match of super programmers....I will not included Hutch because he is of <strong>SANE</strong>  mind and we need that to Survive  :)<br /><br />Well amyway, It is very new to me.</div>
    <div class="meta">Posted on 2002-06-08 11:56:46 by cmax</div>
   </div>
   <div class="post" id="post-42030">
    <div class="subject"><a href="#post-42030">Props, Hutch</a></div>
    <div class="body">Hutch, I commend you on your short, sweet, and elegant code.<br />But there are two things that kind of bother me a little:<br /><br />1) You seem to call dispatchMessage once without a GetMessage.  This seems like a felony to me, how do you get away with it.<br /><br />2) In your first example the pointer you send to RegisterClassEx was in the stack, and you restored the part it was in right after.  Does this mean that RegisterClassEx makes a copy of the WNDCLASSEX structure.  If so then couldn't you have one copy of the structure and modify it for each call to RegisterClassEx you need to make?</div>
    <div class="meta">Posted on 2002-06-08 15:27:04 by Satrukaan</div>
   </div>
   <div class="post" id="post-42034">
    <div class="subject"><a href="#post-42034">Shell for invoke</a></div>
    <div class="body"><div class="quote"><br />I would like to see what  <strong>Maverick </strong> have to say about this</div>Hi cmax, sorry.. I came into this thread by &quot;accident&quot;, and didn't read most of it. I should say something about which matter? I'll be glad to help.</div>
    <div class="meta">Posted on 2002-06-08 16:10:40 by Maverick</div>
   </div>
   <div class="post" id="post-42037">
    <div class="subject"><a href="#post-42037">Shell for invoke</a></div>
    <div class="body">Hi again.. I quickly checked some of the tons of posts above. If I'm not mistaken, the matter here is &quot;real men optimize also the code around a ExitProcess call&quot;.. or something like that.<br /><br />My (<em>personal</em>) views on this is that assembly <strong>is</strong> there to be used for a reason, i.e. speed, efficiency, and so on.. but we've to be practical as well, and this means also preserving the registers modified by a Win32 function, if that is more comfortable and less bug-prone, <strong>and if</strong> that maybe takes millions of cycles to complete anyway (making the advantages much more important of the practically non-existant disadvantage, there).<br />This is not ideal, but saves you development time for <strong>much more serious and important things</strong>, so at the end it pays more than you spent on it. Looking for a bug when you're on a deadline, and then discovering it was your super optimization around the call to ReadFile, is really quite stupid.<br /><br />But e.g. in a important innerloop I'd never want to see performance sacrified for source readability or such. That would be against the sense of assembly programming in this HLL age.<br /><br />Some coders just can't write full, giant programs, so they tend to concentrate on state of the art useless stuff.. like optimizing where it doesn't matter, but then running out of time for the real things. I'm very perfectionist myself, and I've tons of uselessly optimized stuff, but real life has forced me into being productive as well.. so now I know when it's time to stop with a perfectionism that may not prove useful, and steal too much very-precious time.<br /><br />I mean, I've no problems to call &quot;wannabe elitish stupidity&quot; if one has to write suboptimal code and not exploit all of the registers where it matters, just to keep some free for a Win32 API call that wastes anyway millions of cycles to complete. Also, often that kind of coders are also lame at the end, and very full of themselves and mean to the nice guys out there, which are here just for friendship and to learn and to share what they can offer to the other dudes.</div>
    <div class="meta">Posted on 2002-06-08 16:44:20 by Maverick</div>
   </div>
   <div class="post" id="post-42040">
    <div class="subject"><a href="#post-42040">Shell for invoke</a></div>
    <div class="body">If there is no point in optimizing everything then what is the point in coding entirely in assembly?<br />Would it not be better to just code in C and use assembly in critical sections of code that don't rely on calls to window's api.</div>
    <div class="meta">Posted on 2002-06-08 17:16:11 by Satrukaan</div>
   </div>
   <div class="post" id="post-42042">
    <div class="subject"><a href="#post-42042">Shell for invoke</a></div>
    <div class="body">Only if you consider C like God's solution.<br /><br />Personally, when I've been asked to write something and I was given a C function to be included (and write the rest), I've just compiled the C function to assembly and included that to my assembly program.<br /><br />So, inline assembly in a C program can be as well replaced to inline C into an assembly program.<br /><br />Still, even in C it doesn't make sense to waste time optimizing e.g. the code around a call to ReadFile that has to read a 10 MB file.<br /><br />Time is too precious to be wasted like that, considering all the more important parts that need optimizations.<br /><br />No, this doesn't translate to it's better to code in C and add some inline asm, that's a whole other matter.</div>
    <div class="meta">Posted on 2002-06-08 17:40:30 by Maverick</div>
   </div>
   <div class="post" id="post-42049">
    <div class="subject"><a href="#post-42049">Shell for invoke</a></div>
    <div class="body">Hi Maverick,;) <br /><br />&quot;Hi again.. I quickly checked some of the tons of posts above. If I'm not mistaken, the matter here is &quot;real men optimize also the code around a ExitProcess call&quot;.. or something like that.&quot;<br /><br />I'm sorry but you are out of class again...<br />You just don't know what you are talking about..<br /><br />I'll repeat: the subject here is &quot;TO PRESERVE REGISTERS OR NOT&quot;<br />rather my programming style...<br />All your soft nothings are related to my OWN programming style!!!..<br /><br />I'm wondering now why you hate me for my programming style?  It is mine not your!<br /><br />I saw your style:<br />&quot;I've just compiled the C function to assembly and included that to my assembly program.&quot;<br />and don't hate you for that because it is YOUR business not mine...<br /><br />My team and I receive our salaries and shares to write, test and implement fast and as small as possible assembly code, because we have  strong competitors in our market, so if my style offends you just forget about it...<br /><br />I appreciate the people here by their code rather their soft nothings, because often they are very emotional. <br />I'm just curios how you appreciate unknown people from different cultures...<br />.;)</div>
    <div class="meta">Posted on 2002-06-08 19:57:54 by buliaNaza</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=5702&amp;page=1" style="">&laquo;</a><a href="../?id=5702&amp;page=2" style="">&lt;</a><input type="hidden" name="id" value="5702" /><input type="number" name="page" min="1" max="5" step="1" value="3" onchange="this.form.submit();" /><a href="../?id=5702&amp;page=4">&gt;</a><a href="../?id=5702&amp;page=5">&raquo;</a></form>  </div>
 </body>
</html>