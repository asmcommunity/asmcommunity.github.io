<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Shell for invoke - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=5702" />
    <link rel="next" href="../?id=5702&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=5702">Shell for invoke</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=5702&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=5702&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="5702" /><input type="number" name="page" min="1" max="5" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=5702&amp;page=2">&gt;</a><a href="../?id=5702&amp;page=5">&raquo;</a></form>   <div class="post" id="post-40766">
    <div class="subject"><a href="#post-40766">Shell for invoke</a></div>
    <div class="body">Hi all!<br />I don?t like API functions corrupting registers (of course, except of eax and eip). So I have just written a macro that preserves all registers before calling a function and then restores them. <br /><br /><pre><code><br />run macro func&#58; VARARG<br />    local i<br />    i = 0<br />    for arg, &lt;func&gt;<br />        i = i + 1<br />        exitm<br />    endm<br />    if i eq 0<br />        .err &lt;run macro cannot be called without parameters&gt;<br />    else<br />        sub esp, 4<br />        pushad<br />        invoke func<br />        mov dword ptr &#91;esp+32&#93;, eax<br />        popad<br />        mov eax, dword ptr &#91;esp&#93;<br />        add esp, 4<br />    endif<br />endm<br /></code></pre><br /><br />So you can write:<br />run MessageBox, NULL, addr szMessage, addr szCaption, MB_OK<br /><br />The cost of this macro is 15 extra bytes added into your program. What can you say about it? ;)</div>
    <div class="meta">Posted on 2002-05-31 05:30:06 by vkim</div>
   </div>
   <div class="post" id="post-40771">
    <div class="subject"><a href="#post-40771">Shell for invoke</a></div>
    <div class="body">vkim,<br /><br />your macro works, but why not coding:<br /><br /><pre><code><br />run macro func&#58; VARARG<br />    local i<br />    i = 0<br />    for arg, &lt;func&gt;<br />        i = i + 1<br />        exitm<br />    endm<br />    if i eq 0<br />        .err &lt;run macro cannot be called without parameters&gt;<br />    else<br />        pushad<br />        invoke func<br />        mov dword ptr &#91;esp+28&#93;, eax<br />        popad<br />    endif<br />endm<br /></code></pre><br /><br />since the position of EAX in the PUSHAD &quot;struct&quot; is documented?</div>
    <div class="meta">Posted on 2002-05-31 05:55:53 by japheth</div>
   </div>
   <div class="post" id="post-40772">
    <div class="subject"><a href="#post-40772">Shell for invoke</a></div>
    <div class="body"><strong>vkim</strong>, if <em>i</em>=0 then <em>func</em> will be blank:<pre><code>run macro func&#58; VARARG<br />    ifb &lt;&amp;func&gt;<br />        .err &lt;run macro cannot be called without parameters&gt;<br />    else<br />        pushad<br />        invoke func<br />        mov dword ptr &#91;esp+28&#93;, eax<br />        popad<br />    endif<br />endm</code></pre></div>
    <div class="meta">Posted on 2002-05-31 06:04:53 by bitRAKE</div>
   </div>
   <div class="post" id="post-40777">
    <div class="subject"><a href="#post-40777">Shell for invoke</a></div>
    <div class="body">Oh, thank you, bitRAKE and japheth!!! The code became so small!</div>
    <div class="meta">Posted on 2002-05-31 06:32:10 by vkim</div>
   </div>
   <div class="post" id="post-40808">
    <div class="subject"><a href="#post-40808">Shell for invoke</a></div>
    <div class="body">While on the subject of preserving registers, how expensive are push/popad. Would we be better off using them instead of &quot;uses edi esi ebx&quot;?</div>
    <div class="meta">Posted on 2002-05-31 10:17:47 by EÃ³in</div>
   </div>
   <div class="post" id="post-40838">
    <div class="subject"><a href="#post-40838">Shell for invoke</a></div>
    <div class="body">It is a slowdown garbage...<br />If you know how to write pure assembly code<br />you don't need to preserve registers when callng API ....</div>
    <div class="meta">Posted on 2002-05-31 14:02:07 by buliaNaza</div>
   </div>
   <div class="post" id="post-40840">
    <div class="subject"><a href="#post-40840">Shell for invoke</a></div>
    <div class="body"><strong>buliaNaza</strong>, these are for debug macros - speed is of little concern as the code will not be present in released code.  Sometimes I wish the APIs were C calling convention so we could really optimize calling them. :)</div>
    <div class="meta">Posted on 2002-05-31 15:12:25 by bitRAKE</div>
   </div>
   <div class="post" id="post-40841">
    <div class="subject"><a href="#post-40841">Shell for invoke</a></div>
    <div class="body"><strong>Hello buliaNaza</strong> ,<br /><br />Can you post an small example with some comments please.</div>
    <div class="meta">Posted on 2002-05-31 15:29:03 by cmax</div>
   </div>
   <div class="post" id="post-40848">
    <div class="subject"><a href="#post-40848">Shell for invoke</a></div>
    <div class="body">:) :) Hi, cmax<br />Of course, I can post an example but the question is WHY?<br />I mean the way of thinking here...plz take a look:<br /><br />Q: &quot;does anyone have a clue how to find the exact address of the PE-Header of an EXE-File.<br />My problem is, that the size of the DOS-Stub isn't defined exactly.&quot;<br />...............<br />...............<br /><br />A1:  I use<br /><br />;Start:<br />	;invoke	GetModuleHandle, 0  ; slow<br />	;mov	hInstance, eax <br />	;........<br />	;........<br />;End Start<br /><br />Start:<br />	mov	esi, offset Start   ; faster<br />	and	esi, 0FFFF0000h<br />	.....<br />	.....<br /><br />A2:<br /> .DATA <br />	hInstance dd offset Start <br />.CODE <br /><br />Start: <br />	and hInstance, 0FFFF0000h<br /><br /><br />Reply:<br />&quot;What's the problem with GetModuleHandle(NULL) ? You call it once, <br />at program startup... what's the use of these funky methods apart <br />from looking smart?&quot;<br /><br />Or<br /><br />A:<br /> 	pxor mm7,mm7<br />@@:	movq mm0,<br />	pminub mm0,<br />	pminub mm0,<br />	pminub mm0,<br />	pminub mm0,<br />	pminub mm0,<br />	pminub mm0,<br />	pminub mm0,<br />	pcmpeqb mm0,mm7<br />	add eax,64<br />	pmovmskb ecx,mm0<br />	jecxz @B <br /><br />Replay:<br />	&quot;... and doesn't work on older machines like the Pentium, Pentium MMX, Pentium Pro, Pentium 2  <br />(does it work on the P3 ? ), K6/K6-2 (does the Athlon support these instructions ?) and so on. <br />I think it's a nice idea, but the use is currently not that high, since some (or the most ?) people still use these  <br />&quot;old&quot; processors, which does not support these instructions. &quot;<br /><br />Or<br /><br />&quot;This is my first post here, and I'm wondering why you use MMX and other weird instructions to write these  routines. <br />They are basic routines which don't need tremendous optimisation. <br />Personally, if I had to put the code into a real program, I'll put tower's code to avoid crash on weird systems.&quot;<br />...............<br />...............<br />Or<br />...............<br />..............<br />..............<br />will become too long.........<br /><br />So, I agree with The_Svin:<br /><br />&quot;It is sign of corrage that you submit the code. <br />When you don't have already examples of how to deal some algo, <br />it's 99 % chance that you do code that slower then somewere existing. Most of so to called gurus didn't create  any ideas - they just pick them from others. <br />So coward in the case would pretend that he knows something but don't have time to show it.&quot;<br /><br /><br /><br />:(</div>
    <div class="meta">Posted on 2002-05-31 16:09:49 by buliaNaza</div>
   </div>
   <div class="post" id="post-40852">
    <div class="subject"><a href="#post-40852">Shell for invoke</a></div>
    <div class="body"><strong>WHYyyyy ?</strong>  <span style="font-size:9px>because </span>    <strong> buliaNaza </strong>   <span style="font-size:9px>has spoken</span>  :)<br /><br />The fact is i was the biggest Dump A** out here and i am just getting hip to the true heavy ways of this game.  And i don't ever want to dream again... i want to make sure no mather what.<br /><br />PS: I got few more miles to travel but when i get there they will have to say D*MMMME,  WHERE DID HE COME FROM.<br /><br />Thanks a Million buliaNaza<br /><br /><span style="font-size:9px>Perfect Example... Now i remember</span></div>
    <div class="meta">Posted on 2002-05-31 16:33:36 by cmax</div>
   </div>
   <div class="post" id="post-40856">
    <div class="subject"><a href="#post-40856">Shell for invoke</a></div>
    <div class="body"><strong>buliaNaza</strong>, hope the variety of coders here doesn't discourage you.  Of course, everyone has an opinion. :)  Don't forget that not everybody programs in asm for speed/size optimization.  It is obvious that you work to create some optimal code, and you have a good understanding of the instruction set and basic programming structures.  Unfortunately, that is not the case for everyone here.  I have studied the Intel manuals, MASM documentation, and much other material -- it take some time to learn ASM.  Not everyone has that time.  I try to have much respect for people - where ever they may be in their life or in their programming -- it is not aways an easy thing. ;)</div>
    <div class="meta">Posted on 2002-05-31 16:51:10 by bitRAKE</div>
   </div>
   <div class="post" id="post-40871">
    <div class="subject"><a href="#post-40871">Shell for invoke</a></div>
    <div class="body">cmax,<br />ok...ok.. Just copy and paste code and<br />link with -&gt;  /SUBSYSTEM:WINDOWS /RELEASE<br />/MERGE:.rdata=.text /SECTION:.text&quot; , &quot;CEWR&quot;  test.obj <pre><code><br /><br />.586			<br />.mmx<br />.model	flat, stdcall	<br />option	casemap &#58;none	<br /><br />      include c&#58;\masm32\include\windows.inc<br />      include c&#58;\masm32\include\gdi32.inc<br />      include c&#58;\masm32\include\user32.inc<br />      include c&#58;\masm32\include\kernel32.inc<br /><br />      includelib c&#58;\masm32\lib\gdi32.lib<br />      includelib c&#58;\masm32\lib\user32.lib<br />      includelib c&#58;\masm32\lib\kernel32.lib<br /><br />.code			;<br /><br />Start&#58;			;<br />		jmp	Start1	;<br />hWnd	dd	0<br />dStack	dd	0	;<br />cObjects 	dd	17<br />lphObjects         dd       17 Dup&#40;0&#41;<br />LL1	dd        6   Dup&#40;0&#41;	; number of dll +1 <br />LLoffset	dd        offset  LL1	;<br />szTest	db &quot;I don't want to feel guilty if my programs&quot;<br />	      db &quot; don't start with &#58;&quot;,13,10<br />		db &quot; Start&#58;&quot;,13,10<br />    		db &quot;            invoke  GetModuleHandle,NULL&quot;,10,13<br />		db &quot;            mov     hInstance, eax&quot;,10,13<br />		db &quot;            invoke  WinMain,eax,0,0,0&quot;,10,13<br />		db &quot;            invoke  ExitProcess,eax&quot;,10,13<br />		db &quot; END Start&quot;,0<br />;....................... API ..................................................	;<br />aLoadLibrary		DD	64616F4Ch<br />aGlobalUnlock		DD	7262694Ch<br />aGlobalLock		DD	41797261h<br />aGetModuleHandle	DD	6F6C4700h<br />aFreeLibrary		DD	556C6162h<br />aExitProcess		DD	636F6C6Eh<br />aSetBkColor		DD	6C47006Bh<br />aSelectObject		DD	6C61626Fh<br />aGetDeviceCaps	DD	6B636F4Ch<br />aDeleteObject		DD	74654700h<br />aCreateFontIndirect	DD	75646F4Dh<br />aTranslateMessage	DD	6148656Ch<br />aShowWindow		DD	656C646Eh<br />aSetWindowLong	DD	72460041h<br />aSetForegroundWindow DD	694C6565h<br />aSetFocus		DD	72617262h<br />aSendMessage		DD	78450079h<br />aReleaseDC		DD	72507469h<br />aRegisterClassEx	DD	7365636Fh<br />aPostQuitMessage	DD	00000073h<br />aOpenClipboard	DD	44470000h<br />aLoadIcon		DD	2E323349h<br />aLoadCursor		DD	006C6C64h<br />aIsClipboardFormatAvailable DD	42746553h<br />aGetSystemMetrics 	DD	6C6F436Bh<br />aGetSysColor		DD	5300726Fh<br />aGetMessage		DD	63656C65h<br />aGetDC		DD	6A624F74h<br />aGetClipboardData	DD	00746365h<br />aFindWindow		DD	44746547h<br />aEndPaint		DD	63697665h<br />aDrawText		DD	70614365h<br />aDispatchMessage	DD	65440073h<br />aDestroyWindow	DD	6574656Ch<br />aDefWindowProc	DD	656A624Fh<br />aCreateWindowEx	DD	43007463h<br />aCloseClipboard	DD	74616572h<br />aCallWindowProc	DD	6E6F4665h<br />aBeginPaint		DD	646E4974h<br />			DD	63657269h<br />			DD	00004174h<br />			DD	55000000h<br />			DD	33524553h<br />			DD	6C642E32h<br />			DD	7254006Ch<br />			DD	6C736E61h<br />			DD	4D657461h<br />			DD	61737365h<br />			DD	53006567h<br />			DD	57776F68h<br />			DD	6F646E69h<br />			DD	65530077h<br />;My Internal Buffer_Start Here<br />			DD	6E695774h<br />			DD	4C776F64h<br />	 		DD	41676E6Fh<br />			DD	74655300h<br />			DD	65726F46h<br />			DD	756F7267h<br />			DD	6957646Eh<br />			DD	776F646Eh<br />			DD	74655300h<br />			DD	75636F46h<br />			DD	65530073h<br />			DD	654D646Eh<br />			DD	67617373h<br />		     	DD	52004165h<br />			DD	61656C65h<br />			DD	43446573h<br />			DD	67655200h<br />			DD	65747369h<br />			DD	616C4372h<br />			DD	78457373h<br />			DD	6F500041h<br />			DD	75517473h<br />			DD	654D7469h<br />			DD	67617373h<br />			DD	704F0065h<br />			DD	6C436E65h<br />			DD	6F627069h<br />			DD	00647261h<br />			DD	64616F4Ch<br />			DD	6E6F6349h<br />			DD	6F4C0041h<br />			DD	75436461h<br />			DD	726F7372h<br />			DD	73490041h<br />			DD	70696C43h<br />			DD	72616F62h<br />			DD	726F4664h<br />			DD	4174616Dh<br />			DD	6C696176h<br />			DD	656C6261h<br />			DD	74654700h<br />			DD	74737953h<br />			DD	654D6D65h<br />			DD	63697274h<br />			DD	65470073h<br />			DD	73795374h<br />			DD	6F6C6F43h<br />			DD	65470072h<br />			DD	73654D74h<br />			DD	65676173h<br />		 	DD	65470041h<br />			DD	00434474h<br />			DD	43746547h<br />			DD	6270696Ch<br />			DD	6472616Fh<br />			DD	61746144h<br />			DD	6E694600h<br />			DD	6E695764h<br />			DD	41776F64h<br />			DD	646E4500h<br />			DD	6E696150h<br />			DD	72440074h<br />			DD	65547761h<br />			DD	00417478h<br />			DD	70736944h<br />			DD	68637461h<br />			DD	7373654Dh<br />			DD	41656761h<br />			DD	73654400h<br />			DD	796F7274h<br />			DD	646E6957h<br />			DD	4400776Fh<br />			DD	69576665h<br />			DD	776F646Eh<br />			DD	636F7250h<br />			DD	72430041h<br />			DD	65746165h<br />			DD	646E6957h<br />			DD	7845776Fh<br />			DD	6C430041h<br />			DD	4365736Fh<br />			DD	6270696Ch<br />			DD	6472616Fh<br />			DD	6C614300h<br />			DD	6E69576Ch<br />			DD	50776F64h<br />			DD	41636F72h<br />			DD	67654200h<br />			DD	61506E69h<br />			DD	00746E69h<br />			DD	00000000h<br />			DD	00000000h<br />;.................................................................................	;	<br />ClassName		db	&quot;test_class&quot;, 0<br />ProgName 		db    &quot;bnTest&quot;,0<br />MainW  		dd 	642<br />MainH  		dd 	442 wccbSize		dd	sizeof  WNDCLASSEX<br />wcstyle		dd	CS_HREDRAW or CS_VREDRAW<br />wclpfnWndProc	dd	offset WndProc<br />wccbClsExtra	dd	0<br />wccbWndExtra	dd	0<br />wchInstance		dd	0<br />wchIcon		dd	0<br />wchCursor		dd	0<br />wchbrBackground	dd	COLOR_APPWORKSPACE+1<br />wclpszMenuName	dd	0<br />wclpszClassName	dd	offset ClassName<br />wchIconSm		dd	0<br />OnCreate&#58;			;<br />		mov	ecx, &#91;esp+&#40;1+0&#41;*4&#93;	; hWnd<br />		mov	hWnd, ecx	;<br />		jmp	DefWindowProc	; <br />;.................................................................................	;<br />Start1&#58;			;<br />;Get Kernel32 module base address	;<br />	  	mov	edi, offset aLoadLibrary 	; <br />		mov	ebx, &#91;esp&#93;	; Return address of call to CreateProcess<br />		mov	ecx, 0FFFFF800h	;<br />	 	mov	&#91;esp-&#40;1+0&#41;*4&#93;, edi	; edi-&gt; offset aLoadLibrary<br />		and	ebx, 0FFFF1000h	; the last three are zeros <br />		sub	esp,&#40;1+0&#41;*4	; simulate  push edi<br />KrnlLoop&#58;			;Get Kernel32 module base address<br />  		mov	edx, &#91;ebx-1000h+3Ch&#93; 	; Take beginning of PE header<br />	  	sub	ebx, 1000h	; Scan backward<br />  		test	edx, ecx	; Is it a PE header?<br />	  	jnz	KrnlLoop	; No, search again<br />  		cmp	ebx, &#91;ebx+edx+34h&#93;	; compare current address with the<br /> 	 	  	  	;   addr that PE should be loaded at<br />	  	jnz	KrnlLoop	; if different search again<br />;My GetProcAddress by Name	;<br />FindAPI&#58;			;  GetProcAddress<br />		mov	&#91;esp-&#40;4+0&#41;*4&#93;, edi	; edi-&gt; pNameAPI<br />		mov	&#91;esp-&#40;6+0&#41;*4&#93;, ebx	; ebx-&gt; current dll base address	<br />  		mov	eax, &#91;ebx+edx+120&#93;	; eax-&gt; RVA of Export Table<br />	  	xor	edx, edx	; edx=nMin  <br />  		mov	ebp, &#91;ebx+eax+32&#93;	; ebp-&gt; Address Name Table<br />		mov	&#91;esp-&#40;8+0&#41;*4&#93;, eax	; eax-&gt;RVA of Export Table<br />  		add	ebp, ebx	; ebp-&gt; Addr Name Table Offset<br />	  	mov	eax, &#91;ebx+eax+24&#93;	; eax = num of API Names-&gt; nMax<br />To_Min&#58;			;  Find Index<br />  		mov	esi, eax	; esi-&gt; new nMax<br />	  	add	eax, edx	; edx-&gt; nMin  ;eax-&gt;new current index<br />NewSrch&#58;			;<br />  		shr	eax, 1	; eax-&gt; current index / 2<br />		mov	ebx, &#91;esp-&#40;6+0&#41;*4&#93; 	; ebx-&gt; current dll base address	<br />		mov	edi, &#91;esp-&#40;4+0&#41;*4&#93;	; edi-&gt; pNameAPI<br />  		add	ebx, &#91;eax*4+ebp&#93;	; ebp-&gt; Addr Name Table Offset<br />;Compare strings		;<br />		test	edi, 3	; edi-&gt; pNameAPI<br />		jz	Aligned	;<br />		test	edi, 1	;<br />		jz	Not_Aligned	;<br />		movzx	ecx, byte ptr &#91;edi&#93;	; edi-&gt; pNameAPI<br />		inc	edi	;<br />		cmp	cl, &#91;ebx&#93;	; ebx-&gt; API Names Table<br />		jnz	Not_equal	;<br />		;test	cl, cl	; No API with 1 character<br />		;jz	Found	;<br />		inc	ebx	;<br />		test	edi, 2	;<br />		jz	Aligned	;<br />Not_Aligned&#58;			;<br />		movzx	ecx, word ptr &#91;edi&#93;	;<br />		add	edi, 2	;<br />		cmp	cl, &#91;ebx&#93;	;<br />		jnz	Not_equal	;<br />		;test	cl, cl	; No API with 2 characters<br />		;jz	Found_1	;<br />		cmp	ch, &#91;ebx+1&#93;	;<br />		lea	ebx, &#91;ebx+2&#93;	;<br />		jnz	Not_equal	;<br />		;test	ch, ch	;  No API with 3 characters<br />		;jz	Found_2	;<br />Aligned&#58;			;<br />		mov	ecx, &#91;edi&#93;	;<br />		add	ebx, 4 	;<br />		cmp	cl, &#91;ebx-4&#93;	;<br />		jnz	Not_equal	;<br />		test	cl, cl	;<br />		jz	Found_1	;<br />		cmp	ch, &#91;ebx-3&#93;	;<br />		jnz	Not_equal	;<br />		test	ch, ch	;<br />		jz	Found_2	;<br />		shr	ecx,16	;<br />		add	edi, 4	;<br />		cmp	cl, &#91;ebx-2&#93;	;<br />		jnz	Not_equal	;<br />		test	cl, cl	;<br />		jz	Found_3	;<br />		cmp	ch, &#91;ebx-1&#93;	;<br />		jz	Found_4	;<br />Not_equal&#58;			; move the index &#40;eax&#41; to nMin or to nMax<br />		dec	eax	; eax-&gt; new  current index = eax-1<br />		jc	To_Min	;<br />		lea	edx, &#91;eax+2&#93;	; edx-&gt; new nMax  = eax+1<br />	  	lea	eax, &#91;eax+esi+2&#93;	; edx-&gt; nMin  ebx-&gt; nMax<br />  		jmp	NewSrch	; eax-&gt; new  current index<br />Found_3&#58;			;<br />		dec	edi	;<br />		jmp	Found	;<br />Found_2&#58;			;<br />		inc	edi	;<br />Found_1&#58;			;<br />		inc	edi	;<br />		jmp	Found	;<br />Found_4&#58;			;<br />		test	ch, ch	;<br />		jnz	Aligned	;<br />Found&#58;			; API Index is in eax	<br />		mov	ebx, &#91;esp-&#40;6+0&#41;*4&#93;	; ebx-&gt; current dll base address<br />		mov	esi, &#91;esp-&#40;8+0&#41;*4&#93;	; esi-&gt; RVA of Export Table<br />  		mov	edx, &#91;esi+ebx+36&#93;	; edx-&gt;RVA of Ordinal Table <br />	  	lea	ecx, &#91;ebx+eax*2&#93;	; index-&gt; eax*2 for word table<br />		mov	&#91;esp-&#40;10+0&#41;*4&#93;, eax	; save eax-&gt; current index<br />	  	movzx	eax,word ptr &#91;ecx+edx&#93;	; ecx = Ordinal number<br />	  	mov	ecx, &#91;esi+ebx+28&#93;	; eax-&gt; RVA of Address table<br />  		lea	eax, &#91;ecx+eax*4&#93;	; ecx = ordinal # <br />	  	mov	edx, ebx	;<br />  		add	edx, &#91;eax+ebx&#93;	; eax-&gt; RVA of API<br />		mov	eax, &#91;esp-&#40;0+0&#41;*4&#93;	; current offset for API address<br />	  	mov	ecx, &#91;edi&#93;	; last API ?<br />		mov	&#91;eax&#93;, edx	; save API  address<br />		add	eax, 4	; room for next  API  address<br />		mov	&#91;esp-&#40;0+0&#41;*4&#93;, eax 	; save it<br />	  	jecxz	NextDll	;<br />		mov	eax, &#91;esp-&#40;10+0&#41;*4&#93;	; eax-&gt; current index<br />	  	xor	edx, edx	; edx=nMin=0<br />		mov	&#91;esp-&#40;8+0&#41;*4&#93;, esi	; esi-&gt; RVA of Export Table<br />  		mov	esi, eax	; esi-&gt; nMax = eax-&gt; current index<br />		mov	&#91;esp-&#40;4+0&#41;*4&#93;, edi	;<br />	  	jmp	NewSrch	; next API<br />NextDll&#58;			; <br />  		mov	ecx, &#91;edi+4&#93; 	; last DLL ?<br />  		add	edi, 4	; Next DLL<br />	  	jecxz	EndGetProc	; Exit<br />	  	push	edi	;<br />		call	aGetModuleHandle	;<br />	  	test	eax, eax	;<br />  		jnz	SkipZeros	;<br />	  	lea	ebx, &#91;LLoffset+4&#93;	;<br />		push	edi	;<br />	  	mov	LLoffset, ebx	;<br />  		call	aLoadLibrary	;<br />	  	mov	&#91;ebx-4&#93;, eax	; Save it. We'll need later for FreeLibrary<br />SkipZeros&#58;			;<br /> 		add	edi, 10	;<br />		mov	ebx, eax	; ebx=eax=next library handle<br />  		mov	edx, &#91;eax+3Ch&#93; 	; Get  start of the PE header in edx<br />SZLoop&#58;			;                    <br />  		cmp	byte ptr &#91;edi-5&#93;, &quot;.&quot;	; Ex&#58; GDI32.dll,0,Set....<br />	  	jz	FindAPI	; jmp if edi -&gt; the offset of 1st API name<br />  		inc	edi	;<br />	  	jmp	SZLoop	; loop again<br />EndGetProc&#58;			;<br />		;add	esp,&#40;0+1&#41;*4	; restore stack<br />;.............................................................................................................;<br />;Register the Main window class	;<br />		mov	dword ptr &#91;esp&#93;, SM_CYSCREEN	; <br />		mov	&#91;esp-&#40;1+0&#41;*4&#93;, offset L_CW	;<br />		mov	dword ptr &#91;esp-&#40;2+0&#41;*4&#93;, SM_CXSCREEN 	;<br />		mov	&#91;esp-&#40;3+0&#41;*4&#93;, offset L_CY	;<br />		mov	dword ptr &#91;esp-&#40;4+0&#41;*4&#93;, IDI_APPLICATION ;<br />		mov	dword ptr &#91;esp-&#40;5+0&#41;*4&#93;, 0	;<br />		mov	&#91;esp-&#40;6+0&#41;*4&#93;, offset L_CX	;<br />		mov	dword ptr &#91;esp-&#40;7+0&#41;*4&#93;, IDC_ARROW	;<br />		mov	dword ptr &#91;esp-&#40;8+0&#41;*4&#93;, 0	;<br />		mov	&#91;esp-&#40;9+0&#41;*4&#93;, offset L_Icon	;<br />		sub	esp, &#91;&#40;9+0&#41;*4&#93;	;<br />		jmp	aLoadCursor	;<br />L_CW&#58;			;<br />		mov	esi, offset Start	;<br />		mov	dStack, esp	; save the stack<br />		mov	edx, MainW	;<br />		mov	ecx, MainH	;<br />		sub	edi, edx	;<br />		mov	&#91;esp-&#40;6+0&#41;*4&#93;, edx	; edx-&gt;RECT.right<br />		shr	edi, 1	;<br />		and	esi, 0FFFF0000h	;<br />		sub	eax, ecx	;<br />		mov	wchInstance, esi	;<br />		shr	eax, 1	;<br />		mov	&#91;esp-&#40;5+0&#41;*4&#93;, ecx	; ecx-&gt;RECT.bottom<br />		mov	&#91;esp-&#40;8+0&#41;*4&#93;, edi	; edi-&gt;RECT.left<br />		mov	&#91;esp-&#40;7+0&#41;*4&#93;, eax	; eax-&gt;RECT.top<br />;Create the main window	;<br />		mov	dword ptr &#91;esp-&#40;1+0&#41;*4&#93;, 0	;<br />		mov	&#91;esp-&#40;2+0&#41;*4&#93;, esi	; esi-&gt;hInstance<br />		mov	dword ptr &#91;esp-&#40;3+0&#41;*4&#93;, 0	;<br />		mov	dword ptr &#91;esp-&#40;4+0&#41;*4&#93;, 0	;<br />		mov	dword ptr &#91;esp-&#40;9+0&#41;*4&#93;, \	;<br />			WS_OVERLAPPEDWINDOW or \ 	;<br />			WS_VISIBLE	;<br />		mov	&#91;esp-&#40;10+0&#41;*4&#93;, offset ProgName 	;<br />		mov	&#91;esp-&#40;11+0&#41;*4&#93;, offset ClassName 	;<br />		mov	dword ptr &#91;esp-&#40;12+0&#41;*4&#93;, 0	;<br />		mov	&#91;esp-&#40;13+0&#41;*4&#93;, offset WndProc	; return address<br />;RegisterClassEx		;<br />		mov	&#91;esp-&#40;14+0&#41;*4&#93;, offset wccbSize 	;<br />		mov	&#91;esp-&#40;15+0&#41;*4&#93;, offset CreateWindowEx	; return adddress<br />		sub	esp, &#40;15+0&#41;*4	;<br />		jmp	aRegisterClassEx 	; call API<br />L_Icon&#58;			;<br />		mov	wchCursor, eax	;<br />		jmp	aLoadIcon	;<br />L_CX&#58;			;<br />		mov	wchIcon, eax	;<br />		mov	wchIconSm,eax	;<br />		jmp	aGetSystemMetrics	; call API<br />L_CY&#58;			;<br />		mov	edi, eax	; <br />		jmp	aGetSystemMetrics	; call API<br />;....................................................................................................................	;<br />;End of My Internal Buffer		;<br /><br />WndProc&#58;<br />	cmp	esp, dStack 	;<br />	jz	WinMainWait	; <br />WinMain&#58;			;  msgs are in ASCENDED order <br />	mov	edi, &#91;esp+&#40;2+0&#41;*4&#93;	; edi=uMsg-&gt;2<br />	mov	eax, nMessages	; eax=number of messages<br />	xor	edx, edx	; edx=0<br />WinMainMin&#58;			;<br />	mov	ebx, eax	;<br />	add	eax, edx	;<br />	shr	eax, 1	;<br />	cmp	edi, &#91;MainMessages+eax*8&#93;	;<br />	jz	WinMainExec	;<br />WinMainLoop&#58;			;<br />	dec	eax	;<br />	jc	WinMainMin	;<br />;To_max&#58;			;<br />	lea	edx, &#91;eax+2&#93;	;<br />	lea	eax, &#91;eax+ebx+2&#93;	;<br />	shr	eax,1	;<br />	mov	esi, &#91;MainMessages+eax*8&#93; 	;<br />	cmp	ecx, esi	;<br />	jz	DefWindowProc	;  call API<br />	mov	ecx, esi	;<br />	cmp	edi, esi	;<br />	jnz	WinMainLoop	; <br />WinMainExec&#58;			;<br />; &#91;esp&#93;=last ret address-&gt;WndProc	;<br />; &#91;esp+4&#93;=hwnd,  &#91;esp+8&#93;=umsg,  &#91;esp+12&#93;=wParam, &#91;esp+16&#93;=lParam;<br />			;<br />	jmp	dword ptr &#91;MainMessages+eax*8+4&#93;	;<br />WinMainExit&#58;			;<br />	add	esp, &#40;4+1&#41;*4	; clear the stack<br />WinMainWait&#58;			;<br />	lea	ecx, &#91;esp- &#40;4+0&#41;*4&#93;	; loading auto stack<br />	mov	&#91;esp-&#40;5+0&#41;*4&#93;, offset WndProc                       ; last return -&gt; WndProc<br />	mov	dword ptr &#91;esp-&#40;6+0&#41;*4&#93;, 0	; 3 zeros are parameters <br />	mov	dword ptr &#91;esp-&#40;7+0&#41;*4&#93;, 0	;    of GetMessage<br />	mov	dword ptr &#91;esp-&#40;8+0&#41;*4&#93;, 0	; <br />	mov	&#91;esp-&#40;9+0&#41;*4&#93;, ecx	; ecx-&gt; offset MSG struc<br />	mov	&#91;esp-&#40;10+0&#41;*4&#93;, offset WinMain	; return-&gt; WinMain<br />			;<br />	mov	esi, cObjects 	;<br />	mov	dword ptr &#91;esp-&#40;11+0&#41;*4&#93;,  MWMO_ALERTABLE ; <br />	mov	dword ptr &#91;esp-&#40;12+0&#41;*4&#93;, QS_ALLINPUT	;<br />	mov	dword ptr &#91;esp-&#40;13+0&#41;*4&#93;, INFINITE	;<br />	mov	&#91;esp-&#40;14+0&#41;*4&#93;, offset lphObjects	;<br />	mov	&#91;esp-&#40;15+0&#41;*4&#93;, esi	;<br />	mov	&#91;esp-&#40;16+0&#41;*4&#93;, offset WinObj	; return address<br />	sub     esp, &#40;16+0&#41;*4	;<br />	jnz	MsgWaitForMultipleObjectsEx	;<br />WinObj&#58;			;<br />	sub	eax, WAIT_OBJECT_0 	; <br />	cmp	eax, esi	; esi-&gt;cObjects<br />	jz	GetMessage	;<br />DoObjects&#58;			;<br />	add	esp,&#40;10+0&#41;*4	;<br />	mov 	eax, eax	;<br />	;<br />	;<br />	jmp	WinMainWait	;<br />;....................................................................................................................	;<br />OnCommand&#58;			;<br />	mov	eax, nComMessagesID  	; eax-&gt;number of identificators<br />	movzx edx, word ptr &#91;esp+12+4&#93;	; edx-&gt; LOWORD wParam <br />OnComm_1&#58;			;    item, control, or accelerator <br />	dec	eax	;    identificator<br />	jl	OnComm_2	; l=not found  and exit<br />	cmp	&#91;CommandMessages +eax*8&#93;, edx 	; see if is the correct ident.<br />	jnz	OnComm_1	;<br />	jmp	dword ptr &#91;CommandMessages+eax*8+4&#93;	; call correct procedure<br />OnComm_2&#58;			; <br />	add	esp, 4	; clear return address <br />	jmp	DefWindowProc    	; call API<br />;....................................................................................................................	;<br />OnSysCommand&#58;			;<br />	mov	eax, &#91;esp+&#40;3+0&#41;*4&#93;	; 3-&gt;wParam<br />	and	eax, 0FFF0h	;<br />	cmp	eax, SC_CLOSE	; Alt+F4 or menu item Close<br />	je	OnDestroy	;<br />	jmp	DefWindowProc	;<br />;....................................................................................................................	;<br />OnSize&#58;			;<br />	jmp	DefWindowProc	;<br />;....................................................................................................................;	<br />;&#91;esp&#93; 	-&gt;	return address	;<br />;&#91;esp+4&#93;	-&gt;	hWnd	;<br />;&#91;esp+8&#93; 	-&gt;	Msg	;<br />;&#91;esp+12&#93;	-&gt;	wParam	;<br />;&#91;esp+16&#93;	-&gt;	lParam 	;<br />;....................................................................................................................	;<br />ALIGN 8				;		<br />MainMessages	DD	WM_CREATE, OnCreate		; WM_CREATE=01h <br />		DD	WM_DESTROY, OnDestroy	; WM_DESTROY=02h<br /><br />	;	DD	WM_SIZE, OnSize		; WM_SIZE=05h<br />		DD	WM_PAINT, OnPaint		; WM_PAINT=0Fh<br />		DD	WM_CLOSE, OnDestroy		; WM_CLOSE=10h<br />		DD	WM_QUIT, OnDestroy		; WM_QUIT=12h<br /><br />	;	DD	WM_GETMINMAXINFO, OnGetminmaxinfo  	; 24h<br /><br /><br />	;	DD	WM_DRAWITEM, OnDrawitem	; WM_ DRAWITEM =2Bh<br />	;	DD	WM_MEASUREITEM, OnMEASUREITEM	; WM_MEASUREITEM=2Ch<br />	;	DD	WM_NOTIFY, OnNotify		; WM_NOTIFY =4Eh<br />;		DD	WM_CONTEXTMENU, OnInitMenu	; 7Bh <br />	;	DD	WM_DISPLAYCHANGE,OnDisplayChange	; 7Eh<br />	;	DD	WM_NCLBUTTONDOWN, OnNclbuttondown	; 0A1h <br />	;	DD	WM_COMMAND, OnCommand	; WM_COMMAND=111h<br />		DD	WM_SYSCOMMAND, OnSysCommand 	; WM_SYSCOMMAND =1112h<br /><br />	;	DD	WM_TIMER, OnTimer		;WM_TIMER = 113h<br />	;	DD	WM_INITMENU,OnInitMenu	;116h<br />	;	DD	WM_INITMENUPOPUP, OnInitMenuPop	;117h<br />	;	DD	WM_MENUSELECT, OnMenuSelect	;11Fh<br />	;	DD	WM_ENTERIDLE, OnMenuIdle	; 121h<br />	;	DD	WM_MOUSEMOVE, OnMouseMove	; WM_MOUSEMOVE=200h <br />	;	DD	WM_LBUTTONDOWN, OnMouseMove_1	; WM_LBUTTONDOWN=201h<br />	;	DD	WM_RBUTTONDOWN, OnRbuttonDown	; WM_RBUTTONDOWN=204h<br />	;	DD	WM_EXITMENULOOP, OnExitMenu	;212h<br />nMessages	DD	&#40;$-MainMessages&#41;/8		;<br />;.....................................................................................................................;	<br />CommandMessages	DD	670, OnDestroy		; button Cancel<br />;			DD	671, OnBrowse		; button Browse<br />;			DD	672, OnServer		; button Server<br />;			DD	673, OnMinimize		; button Minimize<br />;			DD	674, OnDestroy		; button Close<br />nComMessagesID	DD	&#40;$- CommandMessages&#41;/8	;<br />;.....................................................................................................................;<br />OnDestroy&#58;			;<br />	mov	edi, offset LL1+4	; lp to LoadLibrary handles table<br />	mov	ebp, &#91;edi-4&#93;	; get LoadLibrary handle<br />DesLoop&#58;			;<br />	push	ebp	; free libraries		<br />	call	FreeLibrary	;<br />	mov	ebp, &#91;edi&#93;	; get LoadLibrary handle<br />	add	edi, 4	;<br />	test	ebp, ebp	;<br />	jnz	DesLoop	;<br />	jmp	ExitProcess	; Exit<br />;......................................................................................................	;<br />OnMinimize&#58;			;<br />	mov	eax, hWnd	;<br />                                  push	0	;<br />	push	SC_MINIMIZE	;<br />	push	WM_SYSCOMMAND	; <br />	push	eax	;<br />	call	PostMessage	; call API<br />	jmp	WinMainExit<br />;......................................................................................................	;<br />OnPaint&#58;			;<br />	sub    esp, sizeof PAINTSTRUCT + sizeof RECT<br />	mov	ebx,esp<br />	push	ebx	;<br />	push	hWnd	;<br />	push	ebx	;<br />	push	hWnd	;<br />	call	aBeginPaint	;<br />	mov	esi, eax	; esi-&gt;hDC<br /><br />	push	COLOR_BTNHIGHLIGHT 	; light grey color<br />	call	aGetSysColor	; call proc<br />	push	eax<br />	push	esi<br />        	call	SetTextColor<br />			<br />	push	TRANSPARENT<br />	push	esi<br />	call	SetBkMode<br />	lea	ebx, &#91;esp+36&#93;<br />	push	ebx<br />	push	hWnd<br />	call	GetClientRect<br /><br />	push	DT_VCENTER  ;   <br />	push	ebx	; ebx-&gt; rect<br />	push	-1	;  len of string<br />	push	offset szTest	;  offset String<br />	push	esi 	; esi-&gt; DC<br />	call	aDrawText	; call proc<br />	<br />	call	aEndPaint	;<br />	add	esp, sizeof PAINTSTRUCT + sizeof RECT ;<br />	xor	eax, eax<br />	jmp	DefWindowProc<br />			<br />End	Start</code></pre></div>
    <div class="meta">Posted on 2002-05-31 19:29:28 by buliaNaza</div>
   </div>
   <div class="post" id="post-40882">
    <div class="subject"><a href="#post-40882">Shell for invoke</a></div>
    <div class="body">Some of the assumptions here fascinate me, without decompiling every windows API function, you have no way of knowing which registers they do or do not use so the ONLY choice is to observe the arbitrary convention for Windows coding which is to preserve EBX ESI &amp; EDI and ESP and EBP if you handle the stack manually.<br /><br />The reference to Mavericks question is an interesting one,<br /><br />=====================<br />Q: &quot;does anyone have a clue how to find the exact address of the PE-Header of an EXE-File.<br />=====================<br /><br />If loading the structure IMAGE_DOS_HEADER for the MZ header is too much work by reading its member e_lfanew, whats wrong with searching for the PE signature ?<br /><br />Some of this stuff in here has the assumptions of elitism yet there has long been argument for not doing more than you need to do when the bulk of most programs sit there idling and only a small portion actually do any speed critical work.<br /><br />We all know that REAL MEN PROGRAM IN HEX but there are very few of US left. :)<br /><br />i wonder what the point is in producing code that is so hard to read when there is so little to gain ? Is there some point to producing the worlds fastest loading common dialog box that is at least a gigasecond faster than the standard system version ? Such technology deserves all the fanfare of a gnats fart.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-05-31 21:50:26 by hutch--</div>
   </div>
   <div class="post" id="post-40884">
    <div class="subject"><a href="#post-40884">Shell for invoke</a></div>
    <div class="body">I'd have to agree <strong>hutch--</strong>.  In the world all the matters is what gets the job done, and everything else is artistic expression.  I like expressing myself with ASM. :)</div>
    <div class="meta">Posted on 2002-05-31 22:01:14 by bitRAKE</div>
   </div>
   <div class="post" id="post-40886">
    <div class="subject"><a href="#post-40886">Shell for invoke</a></div>
    <div class="body">;) ;) Hey cmax,<br />here is another proof WHY...</div>
    <div class="meta">Posted on 2002-05-31 22:12:53 by buliaNaza</div>
   </div>
   <div class="post" id="post-40889">
    <div class="subject"><a href="#post-40889">Shell for invoke</a></div>
    <div class="body"><div class="quote">i wonder what the point is in producing code that is so hard to read when there is so little to gain ? Is there some point to producing the worlds fastest loading common dialog box that is at least a gigasecond faster than the standard system version ? Such technology deserves all the fanfare of a gnats fart. </div> <br /><br />Depends on whos doing it:<br /><br />&quot;Because I can&quot;<br /><br />&quot;I want to see if it can be done&quot;<br /><br />&quot;I want to see if I can do it&quot;<br /><br />&quot;I want to learn something by trying to do it the hard way&quot;<br /><br />Personally I think there is some learning value to doing things the hard way.  Usually the best lesson you get, is why most people do it the easy way:grin: <br /><br />Unlike C++, there is no language standard for assembly for the language nazis to harp on.  The freedom of assembly.</div>
    <div class="meta">Posted on 2002-05-31 22:34:32 by ThoughtCriminal</div>
   </div>
   <div class="post" id="post-40891">
    <div class="subject"><a href="#post-40891">Shell for invoke</a></div>
    <div class="body">ThoughtCriminal,<br /><br />I think you have made some very good points here in relation to the motivation that people have for writing many different things but when someone does something AND expects others to do it their way, it becomes a different matter.<br /><br />I am all for original idea and doing things in different ways but I also allow other to be original with their ideas and do things a different way, not inflict on them the idea that they should be doing things by someone elses way.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-05-31 23:23:47 by hutch--</div>
   </div>
   <div class="post" id="post-40896">
    <div class="subject"><a href="#post-40896">Shell for invoke</a></div>
    <div class="body">I too agree here..<br /><br />When my com-sci friends ask my why i prefer ASM over any other language, i tell them its because &quot;i have my own personal bag of tricks&quot;. :)<br /><br />Unlike any other language, i define my own tools, macros, equates, templates, etc., witch allows me to make what i want, the way i want. period.<br /><br />Its like the game &quot;Magic&quot; if anyone is familiar with it.  Your suppose to dual with another 'wizard' and each randomly pulls a magic spell from their sache to attack/deffend against the other.  With asm, i dont need to take handout &quot;tricks&quot; from the standard C++ guild, i can simply make my own, and become as strong as i choose when &quot;attacking&quot; a coding project.  This freedom is what i truely LOVE about MASM over any HLL.<br /><br />More so, i reciently transcribed a fairly length C++ source to masm, and i was AMAZED at how much redundancey on over delaration of variables that was needed to get the job done.  It was soo bad it slowed me down, having to trace thu the code and see if a SCOPED varialbe is nothing more than some other variable somewhere else.  Im mean it, it was BAD!...  This kinda crap I have no patience for.<br /><br />I truely appreciate OOP programing, and its Ideals, but i think its long since been corrupted by the 'insta-programmer' training schools and their bosses who trade the size of the progams on the clients HD, to save a buck and let the C++ grinder take care of it... :rolleyes:<br /><br />/end: rant.<br />:nan:</div>
    <div class="meta">Posted on 2002-06-01 00:26:09 by NaN</div>
   </div>
   <div class="post" id="post-40903">
    <div class="subject"><a href="#post-40903">Shell for invoke</a></div>
    <div class="body"><div class="quote"><br />I'd have to agree <strong>hutch--</strong>.  In the world all the matters is what gets the job done, and everything else is artistic expression.  I like expressing myself with ASM. :) </div><strong>buliaNaza</strong>, 'the job' is different for different people. :)  What is your job?  Why do you like programming the way you do?  It's good to hear your motivations - they are not as obvious as they are to you. ;)  Good example, btw.<br /><br /><br /><strong>buliaNaza</strong>, on WinXP your example takes a long time<br />to start (10+ seconds!) and uses much memory (1656K)?</div>
    <div class="meta">Posted on 2002-06-01 01:49:37 by bitRAKE</div>
   </div>
   <div class="post" id="post-40914">
    <div class="subject"><a href="#post-40914">Shell for invoke</a></div>
    <div class="body"><div class="quote"><em>Originally posted by hutch-- </em>The reference to Mavericks question is an interesting one,<br /><br />=====================<br />Q: &quot;does anyone have a clue how to find the exact address of the PE-Header of an EXE-File.<br />=====================</div>Really, I never ever asked that.. but it's ok++ anyway. ;)</div>
    <div class="meta">Posted on 2002-06-01 05:37:41 by Maverick</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=5702&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=5702&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="5702" /><input type="number" name="page" min="1" max="5" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=5702&amp;page=2">&gt;</a><a href="../?id=5702&amp;page=5">&raquo;</a></form>  </div>
 </body>
</html>