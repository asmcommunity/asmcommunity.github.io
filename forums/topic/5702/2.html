<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Shell for invoke - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=5702" />
  <link rel="prev" href="../?id=5702&amp;page=1" />  <link rel="next" href="../?id=5702&amp;page=3" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=5702">Shell for invoke</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=5702&amp;page=1" style="">&laquo;</a><a href="../?id=5702&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="5702" /><input type="number" name="page" min="1" max="5" step="1" value="2" onchange="this.form.submit();" /><a href="../?id=5702&amp;page=3">&gt;</a><a href="../?id=5702&amp;page=5">&raquo;</a></form>   <div class="post" id="post-40921">
    <div class="subject"><a href="#post-40921">Shell for invoke</a></div>
    <div class="body"><div class="quote">...but when someone does something AND expects others to do it their way...</div><br /><br />I totally agree, thats why I mentioned the C++ language nazis.   I have not seen much, 'everyone should do it my way' here.  I think for an HLL like C++ it is easier for those people to be made.  The complier is like a dull child, you explain slowly and explicitly to the child how to do something.  So if someone gets good at explaining how to do things to the child, they sometimes get over zellous and think that they know the BEST way to talk to the child.  Unfortunatly HLLs kind of encourage this kind of behavior, because there is only so much latitude in how you can tell a dull child what to do:grin: <br /><br />Nan, did you try making a release build of that program?  I've found that optomized builds will sometimes condense the variables.   VC7 does a good job of optomizing, with some help from me:cool:, it does a better job.</div>
    <div class="meta">Posted on 2002-06-01 06:32:24 by ThoughtCriminal</div>
   </div>
   <div class="post" id="post-41014">
    <div class="subject"><a href="#post-41014">Shell for invoke</a></div>
    <div class="body"><strong>buliaNaza,</strong> <br /><br />Thanks alot.  I just needed to see... I am using an hook and now it is giving me problems because i see stuff left over from  whatever in my ECX and EDX even when i XOR all over the place....i mean ALL OVER the PLACE...<br /><br />There will surly be a lot i will learn from your Example and this Post.<br /><br />Thanks again<br /><br /><br /><span style="font-size:9px>&quot;&quot;&quot;&quot;buliaNaza, on WinXP your example takes a long time &quot;&quot;&quot;&quot; <br /><br />Do anyone know Why.....<br /><br />It seem to  me That this prove that XP is full of it....</span></div>
    <div class="meta">Posted on 2002-06-01 22:41:57 by cmax</div>
   </div>
   <div class="post" id="post-41823">
    <div class="subject"><a href="#post-41823">Shell for invoke</a></div>
    <div class="body">Hi,<br /> <br />&quot;Some of the assumptions here fascinate me,&quot;<br /><br />and  here is the top of stupidity::grin:<br /><br />&quot;...without decompiling every windows API function, you have no way of knowing which registers they do or do not use so the ONLY choice is to observe the arbitrary convention for Windows coding which is to preserve EBX ESI &amp; EDI and ESP and EBP if you handle the stack manually.&quot;:) :) :)</div>
    <div class="meta">Posted on 2002-06-06 22:26:49 by buliaNaza</div>
   </div>
   <div class="post" id="post-41844">
    <div class="subject"><a href="#post-41844">Shell for invoke</a></div>
    <div class="body">What an interesting view, it appears that BuliaNaza is the only person on the planet who does not have to protect the registers that are used by API calls.<br /><br />Who cares if Microsoft publish their convention for what registers need to be preserved if you write a procedure that interacts with API calls ?<br /><br />Perhaps you could share this piece of genius with us where the vendor of the operating system does not know what they are talking about. :)<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-06-07 02:39:52 by hutch--</div>
   </div>
   <div class="post" id="post-41851">
    <div class="subject"><a href="#post-41851">Shell for invoke</a></div>
    <div class="body"><div class="quote"><br /><br />A1:  I use<br /><br />;Start:<br />	;invoke	GetModuleHandle, 0  ; slow<br />	;mov	hInstance, eax <br />	;........<br />	;........<br />;End Start<br /><br />Start:<br />	mov	esi, offset Start   ; faster<br />	and	esi, 0FFFF0000h<br />	.....<br />	.....<br /><br />A2:<br /> .DATA <br />	hInstance dd offset Start <br />.CODE <br /><br />Start: <br />	and hInstance, 0FFFF0000h<br /><br /><br /></div><br /><br /><br />I won't use this bloat code. :grin:<br /><br /><pre><code><br />.data<br />          hInstance    dd 400000h<br /></code></pre><br /><br />That's it. If I need to modify it for future Windows Version's, I can earn a lot of &quot;technical support&quot; money from my customers :)</div>
    <div class="meta">Posted on 2002-06-07 04:38:38 by bazik</div>
   </div>
   <div class="post" id="post-41855">
    <div class="subject"><a href="#post-41855">Shell for invoke</a></div>
    <div class="body"><strong>Hutch--</strong>, does not the API preserve all register <strong>except</strong> EAX, EDX and ECX?  It certainly depends on your view.  <strong>buliaNaza</strong> is looking from one side of the interface and your looking from the other.  :grin:</div>
    <div class="meta">Posted on 2002-06-07 05:28:52 by bitRAKE</div>
   </div>
   <div class="post" id="post-41865">
    <div class="subject"><a href="#post-41865">Shell for invoke</a></div>
    <div class="body">Hi, bitRAKE<br />:grin: <br />&quot;It certainly depends on your view&quot;<br />It is wrong... &quot;It certainly DOES NOT depends on his view&quot;<br />;)I'm not a moderator ergo I am free of obligation to tolerate stupidity and incompetence in any form...regardless of author's age and hierarchic position...<br /><br />bAZiK, <br />of course you can use what you want...;)</div>
    <div class="meta">Posted on 2002-06-07 08:15:41 by buliaNaza</div>
   </div>
   <div class="post" id="post-41869">
    <div class="subject"><a href="#post-41869">Shell for invoke</a></div>
    <div class="body"><strong>buliaNaza</strong>, maybe you will write all your programs without interfacing the messaging system of windows, but I seriously doubt it and that is part of the API.  I am an ox and will bear the burdon of tolerance - even of you. ;)</div>
    <div class="meta">Posted on 2002-06-07 08:32:22 by bitRAKE</div>
   </div>
   <div class="post" id="post-41873">
    <div class="subject"><a href="#post-41873">Shell for invoke</a></div>
    <div class="body">What is this?<br />&quot;...without interfacing the messaging system of windows, ...&quot;<br /><br />I use GetMessage API and I can include DispatchMessage and other API too... without preserving of registers...;)</div>
    <div class="meta">Posted on 2002-06-07 08:51:08 by buliaNaza</div>
   </div>
   <div class="post" id="post-41874">
    <div class="subject"><a href="#post-41874">Shell for invoke</a></div>
    <div class="body"><strong>buliaNaza</strong>, do you have ANY procedure called by windows?</div>
    <div class="meta">Posted on 2002-06-07 08:55:57 by bitRAKE</div>
   </div>
   <div class="post" id="post-41875">
    <div class="subject"><a href="#post-41875">Shell for invoke</a></div>
    <div class="body">Of course..;)</div>
    <div class="meta">Posted on 2002-06-07 09:12:49 by buliaNaza</div>
   </div>
   <div class="post" id="post-41876">
    <div class="subject"><a href="#post-41876">Shell for invoke</a></div>
    <div class="body"><strong>buliaNaza</strong>, ...and what registers must you preserve in those procedures?  You know timer/window procs and such...</div>
    <div class="meta">Posted on 2002-06-07 09:21:28 by bitRAKE</div>
   </div>
   <div class="post" id="post-41877">
    <div class="subject"><a href="#post-41877">Shell for invoke</a></div>
    <div class="body">am i missing something? this is normal win32 code.<br />you only have to save those regs in callbacks if you<br />use them right? so bulinaza decided to NOT use them.<br />btw this code is more than messy, what in the hell<br />are you doing there, whats up with the X+0+0+2-2<br />style-calculations? you could do this in a clean way<br />(but still without pe-imported api's) with 70% lines less.</div>
    <div class="meta">Posted on 2002-06-07 09:36:19 by mob</div>
   </div>
   <div class="post" id="post-41878">
    <div class="subject"><a href="#post-41878">Register preservation</a></div>
    <div class="body">Put these in the WndProc procedure directly after the entry address to the procedure and see what happens.<br /><pre><code><br />    ; instant crash<br />      mov esi, 12345678<br />      mov edi, 12345678<br />      mov ebx, 12345678<br /><br /> ;       ; nothing happens<br /> ;         mov eax, 12345678<br /> ;         mov ecx, 12345678<br /> ;         mov edx, 12345678<br /></code></pre><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-06-07 09:51:22 by hutch--</div>
   </div>
   <div class="post" id="post-41880">
    <div class="subject"><a href="#post-41880">Shell for invoke</a></div>
    <div class="body"><strong>mob</strong>, you are correct.  I'm just trying to help <strong>buliaNaza</strong> understand the interface - which he is already aware of. :)</div>
    <div class="meta">Posted on 2002-06-07 09:53:13 by bitRAKE</div>
   </div>
   <div class="post" id="post-41881">
    <div class="subject"><a href="#post-41881">Shell for invoke</a></div>
    <div class="body"><div class="quote"><br />Put these in the WndProc procedure directly after the entry address to the procedure and see what happens. <br /></div><br /><br />and your point? even one week asm newbies know that.<br />and i expect that bulinaza knows that too... *confused*</div>
    <div class="meta">Posted on 2002-06-07 09:54:35 by mob</div>
   </div>
   <div class="post" id="post-41888">
    <div class="subject"><a href="#post-41888">Shell for invoke</a></div>
    <div class="body">&quot;Put these in the WndProc procedure directly after the entry address to the procedure and see what happens.&quot;<br /><br />Put these in my example where you want and see what happens...<pre><code><br />      mov esi, 12345678<br />      mov edi, 12345678<br />      mov ebx, 12345678</code></pre>;)</div>
    <div class="meta">Posted on 2002-06-07 10:53:40 by buliaNaza</div>
   </div>
   <div class="post" id="post-41891">
    <div class="subject"><a href="#post-41891">Shell for invoke</a></div>
    <div class="body">it didn't showed any text now and it wasn't able to terminate.<br />strange thing that it doesn't crashed completly... Must be win2k.<br />(i tried it out with icz's windows example and it don't crashed too)<br />i bet on hutchs win95b box it'll raise the whole system down in<br />the deep dark hole known as the 'blue screen' or even more<br />worse the 'black screen' :)</div>
    <div class="meta">Posted on 2002-06-07 11:28:44 by mob</div>
   </div>
   <div class="post" id="post-41928">
    <div class="subject"><a href="#post-41928">Shell for invoke</a></div>
    <div class="body">mob,<br />for you and for other people here it is the newbie version<br />of the example(&quot;for easy reading&quot;)...but I hate this style of assembly! <br /><pre><code>      .386                   ; minimum processor needed for 32 bit<br />      .model flat, stdcall   ; FLAT memory model &amp; STDCALL calling<br />      option casemap &#58;none   ; set code to case sensitive<br /><br />      include c&#58;\masm32\include\windows.inc<br />      include c&#58;\masm32\include\user32.inc<br />      include c&#58;\masm32\include\gdi32.inc<br />      include c&#58;\masm32\include\kernel32.inc<br />      includelib c&#58;\masm32\lib\user32.lib<br />      includelib c&#58;\masm32\lib\gdi32.lib<br />      includelib c&#58;\masm32\lib\kernel32.lib<br /><br />.data<br />	szDisplayName	db &quot;Test&quot;,0<br />	szClassName	db &quot;Test_Class&quot;,0<br />	szTest		db &quot;I don't want to feel guilty if my programs&quot;<br />	                db &quot; don't start with &#58;&quot;,13,10<br />		        db &quot; Start&#58;&quot;,13,10<br />    		        db &quot;            invoke  GetModuleHandle,NULL&quot;,10,13<br />		        db &quot;            mov     hInstance, eax&quot;,10,13<br />		        db &quot;            invoke  WinMain,eax,0,0,0&quot;,10,13<br />		        db &quot;            invoke  ExitProcess,eax&quot;,10,13<br />		        db &quot; END Start&quot;,0<br />	szConfirm 	db &quot;Please Confirm Exit&quot;,0<br />	hWnd		dd ?<br />	dStack		dd ?   	<br />	wc		WNDCLASSEX	&lt;&gt;<br />	msg		MSG	   	&lt;&gt;<br />	ps		PAINTSTRUCT 	&lt;&gt;<br />	rect		RECT		&lt;&gt;<br /><br />.code<br />start&#58;<br />    	mov	esi, offset start		; instance handle<br />	mov	dStack, esp 			; save the stack<br />	and	esi, 0FFFF0000h			; esi-&gt;instance handle<br />	mov	wc.cbSize, sizeof WNDCLASSEX<br />	mov	wc.style, CS_HREDRAW or CS_VREDRAW \<br />		or CS_BYTEALIGNWINDOW<br />	mov	wc.lpfnWndProc, offset WndProc<br />	mov	wc.cbClsExtra, NULL<br />	mov	wc.cbWndExtra, NULL<br />	mov	wc.hInstance, esi		; esi-&gt;instance handle<br />	mov	wc.hbrBackground, COLOR_BTNFACE+1<br />	mov	wc.lpszMenuName, NULL<br />	mov	wc.lpszClassName, offset szClassName<br />	invoke	LoadIcon, NULL, IDI_APPLICATION<br />	mov	wc.hIcon, eax<br />	invoke	LoadCursor, NULL,IDC_ARROW<br />	mov	wc.hCursor, eax<br />	mov	wc.hIconSm, 0<br />	invoke	RegisterClassEx, ADDR wc<br />	invoke	CreateWindowEx, WS_EX_OVERLAPPEDWINDOW,<br />		ADDR szClassName,<br />		ADDR szDisplayName,<br />		WS_OVERLAPPEDWINDOW or WS_VISIBLE,<br />		100,100,500,350,<br />		NULL,NULL,<br />		esi, NULL			; esi-&gt;instance handle<br />;...............................................;<br />WndProc&#58;					;	  <br />	cmp	esp, dStack 			;<br />	jz	WinGetMessage			; <br />						;<br />	mov	esi, 12345678h			; for Hutch<br />	mov	edi, 12345678h			; for Hutch<br />	mov	ebx, 12345678h			; for Hutch<br />	mov	ebp, 12345678h			; for Hutch<br />WinMain&#58;					;  <br />	mov	eax, &#91;esp+8&#93;			; eax-&gt;uMsg<br />	cmp	eax, WM_CLOSE			;<br />	je	OnDestroy			;<br />	cmp	eax, WM_PAINT			;<br />	je	OnPaint				;<br />	cmp	eax, WM_CREATE			;<br />	je	OnCreate			;<br />	jmp	DefWindowProc			;  call API<br />WinMainExit&#58;					;<br />	mov	esp, dStack 			; clear the stack<br />WinGetMessage&#58;					; <br />	mov	esi, 12345678h			; for Hutch<br />	mov	edi, 12345678h			; for Hutch<br />	mov	ebx, 12345678h			; for Hutch<br />	mov	ebp, 12345678h			; for Hutch<br />						; homework for you<br />	lea	eax, &#91;esp-&#40;4+0&#41;*4&#93;		; loading auto stack<br />	mov	&#91;esp-&#40;5+0&#41;*4&#93;, offset WndProc 	; return -&gt; WndProc<br />	mov	dword ptr &#91;esp-&#40;6+0&#41;*4&#93;, 0	; zeros are parameters <br />	mov	dword ptr &#91;esp-&#40;7+0&#41;*4&#93;, 0	; of GetMessage<br />	mov	dword ptr &#91;esp-&#40;8+0&#41;*4&#93;, 0	; <br />	mov	&#91;esp-&#40;9+0&#41;*4&#93;, eax              ; eax-&gt; offset MSG struct<br />	mov	&#91;esp-&#40;10+0&#41;*4&#93;, offset WinMain	; return-&gt; WinMain<br />	sub     esp, &#40;10+0&#41;*4			;<br />	jmp	GetMessage			; call API<br />;...............................................;<br />OnCreate&#58;					;<br />	mov	eax,  &#91;esp+4&#93;			; hwnd<br />	mov	hWnd, eax			; <br />	jmp	DefWindowProc			;	 <br />OnDestroy&#58;					;<br />	invoke	MessageBox,hWnd, \		;<br />			ADDR szConfirm, \	;	<br />			ADDR szDisplayName,\	;<br />			MB_YESNO		;	<br />        .if eax == IDNO				;<br />		jmp WinMainExit			; loop again<br />	.endif					;<br />		jmp ExitProcess			; Exit<br />OnPaint&#58;					;<br />	invoke	BeginPaint, hWnd, ADDR ps	;<br />	mov	esi,eax				; esi-&gt;hDC<br />	invoke	GetClientRect,hWnd, ADDR rect	;<br />	invoke	DrawText, esi, ADDR szTest,-1,\	; esi-&gt;hDC<br />		ADDR rect, DT_VCENTER		;<br />	invoke	EndPaint, hWnd, ADDR ps		;<br />	jmp	DefWindowProc			;<br />;...............................................;<br />end start</code></pre><br />;)</div>
    <div class="meta">Posted on 2002-06-07 16:13:19 by buliaNaza</div>
   </div>
   <div class="post" id="post-41930">
    <div class="subject"><a href="#post-41930">Shell for invoke</a></div>
    <div class="body">This code:<pre><code>.data<br />	wc		WNDCLASSEX	&lt;&gt;<br />.code<br />	mov	wc.cbSize, sizeof WNDCLASSEX<br />	mov	wc.style, CS_HREDRAW or CS_VREDRAW \<br />		or CS_BYTEALIGNWINDOW<br />	mov	wc.lpfnWndProc, offset WndProc<br />	mov	wc.cbClsExtra, NULL<br />	mov	wc.cbWndExtra, NULL<br />	mov	wc.hInstance, esi		; esi-&gt;instance handle<br />	mov	wc.hbrBackground, COLOR_BTNFACE+1<br />	mov	wc.lpszMenuName, NULL<br />	mov	wc.lpszClassName, offset szClassName<br />	invoke	LoadIcon, NULL, IDI_APPLICATION<br />	mov	wc.hIcon, eax<br />	invoke	LoadCursor, NULL,IDC_ARROW<br />	mov	wc.hCursor, eax<br />	mov	wc.hIconSm, 0</code></pre>Can be replaced by:<pre><code>.data<br />	wc WNDCLASSEX &lt;SIZEOF WNDCLASSEX, CS_HREDRAW or CS_VREDRAW or CS_BYTEALIGNWINDOW, OFFSET WndProc, 0,0,0,0,0,COLOR_BTNFACE+1,0, offset szClassName, 0&gt;<br />.code<br />	mov	wc.hInstance, esi	; esi-&gt;instance handle<br />	invoke	LoadIcon, NULL, IDI_APPLICATION<br />	mov	wc.hIcon, eax<br />	invoke	LoadCursor, NULL,IDC_ARROW<br />	mov	wc.hCursor, eax</code></pre></div>
    <div class="meta">Posted on 2002-06-07 16:31:00 by bitRAKE</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=5702&amp;page=1" style="">&laquo;</a><a href="../?id=5702&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="5702" /><input type="number" name="page" min="1" max="5" step="1" value="2" onchange="this.form.submit();" /><a href="../?id=5702&amp;page=3">&gt;</a><a href="../?id=5702&amp;page=5">&raquo;</a></form>  </div>
 </body>
</html>