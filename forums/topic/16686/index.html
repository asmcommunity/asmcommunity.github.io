<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>struct reference/pointer - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=16686" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=16686">struct reference/pointer</a></p>
   <div class="post" id="post-129661">
    <div class="subject"><a href="#post-129661">struct reference/pointer</a></div>
    <div class="body"><pre><code><br /><br />.data?<br /><br />   fVertexPtr DWORD ?<br /><br />;for structures, need to have the following&#58;<br />; texture &#91;file0&#93;... &#91;file&#40;n&#41;&#93;<br />; type=GL_TRIANGLES Or GL_QUADS, or GL_WIREFRAME&#40;?&#41;<br />; v1,v2,v3,v4  &#40;v4 is used if type says it's QUADS&#41;<br />; n1,n2     normals<br />; f1,f2,f3,f4 &#40;f4 if is quad&#41;<br />; u,v       mapping coords<br /><br />FVERTEX struct<br />	glV1    REAL4 0.0<br />	glV2	REAL4 0.0<br />	glV3	REAL4 0.0<br />	glV4	REAL4 0.0<br />FVERTEX ends<br /><br />FNORMAL struct<br />	glN1	REAL4 0.0<br />	glN2	REAL4 0.0<br />FNORMAL ends<br /><br />FUV struct<br />	glU		REAL4 0.0<br />	glV		REAL4 0.0<br />FUV ends<br /><br />FFACE struct<br />	glF1	dd 0<br />	glF2	dd 0<br />	glF3	dd 0<br />	glF4	dd 0<br />FFACE ends<br /><br />FOBJ struct<br />	glType dd 0<br />	glVX   FVERTEX 4096 DUP &#40;&lt;?&gt;&#41;                ;up to 4096 vertices<br />	glVN   FNORMAL 4096 DUP &#40;&lt;?&gt;&#41;              ;will change later<br />	glFU   FUV     4096 DUP &#40;&lt;?&gt;&#41;                   ;will change later<br />	glFACE FFACE   4096 DUP &#40;&lt;?&gt;&#41;               ;will change later<br />FOBJ ends<br /><br />tObj FOBJ 255 DUP &#40;&lt;?&gt;&#41;    ;&lt;====  error A2177&#58; nested structure improperly initialized<br />;&lt;======= hoping to have up to 255 'objects'<br /><br /></code></pre><br /><br /><br />     My ultimate goal is to have this struct(s) set up to go through each tObj as needed and initialize the memory for it.  Probably will use heapalloc.   My problem is in initializing the thing.   Any help would be appreciated, thanks.<br /><br />I'm not really initializing it as more I am trying to create a sort of typedef? or reference to the structure? There went another braincell, ouch.</div>
    <div class="meta">Posted on 2004-01-03 11:36:22 by drarem</div>
   </div>
   <div class="post" id="post-129666">
    <div class="subject"><a href="#post-129666">struct reference/pointer</a></div>
    <div class="body">thanks Donkey but I get the same error.<br /><br />I am probably trying to think in C when it should be asm..</div>
    <div class="meta">Posted on 2004-01-03 12:23:12 by drarem</div>
   </div>
   <div class="post" id="post-129667">
    <div class="subject"><a href="#post-129667">struct reference/pointer</a></div>
    <div class="body">You can't use DUP for nested structures. Just allocate enough bytes then use other addessing methods. Good luck with the compile time :) MASM has a bug with large structures like this one.<br /><br /><pre><code>FOBJ struct<br />	glType dd 0<br />	glVX   db &#40;SIZEOF FVERTEX *4096&#41; DUP &#40;?&#41;<br />	glVN   db &#40;SIZEOF FNORMAL *4096&#41; DUP &#40;?&#41;<br />	glFU   db &#40;SIZEOF FUV *4096&#41; DUP &#40;?&#41;<br />	glFACE db &#40;SIZEOF FFACE *4096&#41; DUP &#40;?&#41;<br />FOBJ ends</code></pre></div>
    <div class="meta">Posted on 2004-01-03 12:30:33 by donkey</div>
   </div>
   <div class="post" id="post-129672">
    <div class="subject"><a href="#post-129672">struct reference/pointer</a></div>
    <div class="body">Well,<br /><br />It's been a little over an hour, MASM should have just finished compiling that structure :grin:</div>
    <div class="meta">Posted on 2004-01-03 13:45:49 by donkey</div>
   </div>
   <div class="post" id="post-129676">
    <div class="subject"><a href="#post-129676">struct reference/pointer</a></div>
    <div class="body">Really? I tried ML 6.14.8444 and it compiles the structures above in a twinkle... even though it has in other cases the same problem... Or am I doing something wrong?</div>
    <div class="meta">Posted on 2004-01-03 15:26:10 by MazeGen</div>
   </div>
   <div class="post" id="post-129679">
    <div class="subject"><a href="#post-129679">struct reference/pointer</a></div>
    <div class="body">Don't know I gave up trying after about 3 minutes on 7.10, I'm not sure how the bug progressed, whether it got worse in newer versions of ml.exe. Anyway, a structure of that size is not a good idea, better to just use runtime memory allocation than add about a meg of empty data to the executable.</div>
    <div class="meta">Posted on 2004-01-03 16:04:04 by donkey</div>
   </div>
   <div class="post" id="post-129680">
    <div class="subject"><a href="#post-129680">struct reference/pointer</a></div>
    <div class="body">I don't too.<br />As I use large arrays in my project, I have had the same problem using DUP. After replacing it with method using <strong>$</strong> - location counter, compiling time is about half. I know it's not much clean method, but compiling time is for me more important.<br /><pre><code><br />MyArray	DWORD MyConst DUP &#40;?&#41;<br /><br />may be replaced with<br /><br />MyArray	LABEL DWORD<br />	ORG $+4*MyConst<br /></code></pre><br />It's only small sugestion, I know LABEL can't be used inside a struct.</div>
    <div class="meta">Posted on 2004-01-03 17:24:54 by MazeGen</div>
   </div>
   <div class="post" id="post-129690">
    <div class="subject"><a href="#post-129690">struct reference/pointer</a></div>
    <div class="body">C'mon you guys,<br />C'mon darem,<br />     The error from MASM directly tells you exactly what is wrong.  darem, you are trying to assemble initialized code in a unitialized segment.  MASM does not like that. No assembler worth its salt should.  Now look at what we get when I change from <u>.DATA?</u> TO <u>.DATA</u>. I have never run into a problem with large nested STRUC's-- as long as I followed the rules.  You probably won't either if you do the same.  Don't put initialized data into a unitialized segment.  Ratch<pre><code>  00000000			.data<br /><br /> 00000000 00000000		   fVertexPtr DWORD ?<br /><br />				;for structures, need to have the following&#58;<br />				; texture &#91;file0&#93;... &#91;file&#40;n&#41;&#93;<br />				; type=GL_TRIANGLES Or GL_QUADS, or GL_WIREFRAME&#40;?&#41;<br />				; v1,v2,v3,v4  &#40;v4 is used if type says it's QUADS&#41;<br />				; n1,n2     normals<br />				; f1,f2,f3,f4 &#40;f4 if is quad&#41;<br />				; u,v       mapping coords<br /><br /> 00000010			FVERTEX struct<br /> 00000000  00000000			glV1    REAL4 0.0<br /> 00000004  00000000			glV2	REAL4 0.0<br /> 00000008  00000000			glV3	REAL4 0.0<br /> 0000000C  00000000			glV4	REAL4 0.0<br />				FVERTEX ends<br /><br /> 00000008			FNORMAL struct<br /> 00000000  00000000			glN1	REAL4 0.0<br /> 00000004  00000000			glN2	REAL4 0.0<br />				FNORMAL ends<br /><br /> 00000008			FUV struct<br /> 00000000  00000000			glU		REAL4 0.0<br /> 00000004  00000000			glV		REAL4 0.0<br />				FUV ends<br /><br /> 00000010			FFACE struct<br /> 00000000  00000000			glF1	dd 0<br /> 00000004  00000000			glF2	dd 0<br /> 00000008  00000000			glF3	dd 0<br /> 0000000C  00000000			glF4	dd 0<br />				FFACE ends<br /><br /> 00030004			FOBJ struct<br /> 00000000  00000000			glType dd 0<br /> 00000004  00001000 &#91;			glVX   FVERTEX 4096 DUP &#40;&lt;?&gt; &#41;                ;up to 4096 vertices<br />	    00000000<br />	    00000000<br />	    00000000<br />	    00000000<br />	   &#93;<br /> 00010004  00001000 &#91;			glVN   FNORMAL 4096 DUP &#40;&lt;?&gt; &#41;              ;will change later<br />	    00000000<br />	    00000000<br />	   &#93;<br /> 00018004  00001000 &#91;			glFU   FUV     4096 DUP &#40;&lt;?&gt; &#41;                   ;will change later<br />	    00000000<br />	    00000000<br />	   &#93;<br /> 00020004  00001000 &#91;			glFACE FFACE   4096 DUP &#40;&lt;?&gt; &#41;               ;will change later<br />	    00000000<br />	    00000000<br />	    00000000<br />	    00000000<br />	   &#93;<br />				FOBJ ends</code></pre></div>
    <div class="meta">Posted on 2004-01-03 21:58:00 by Ratch</div>
   </div>
   <div class="post" id="post-129704">
    <div class="subject"><a href="#post-129704">struct reference/pointer</a></div>
    <div class="body">Hi Ratch,<br /><br />I saw that but it is not the cause of the problem here, how would you do this:<br /><br /><pre><code>.data?<br />blah STRUCT<br />	tester RECT 256 DUP &#40;&lt;?&gt;&#41;<br />blah ends<br /><br />junk blah  256 DUP &#40;&lt;?&gt;&#41;</code></pre><br /><br />I have always had problems with large uninitialized structures in MASM, I just don't use them any more.</div>
    <div class="meta">Posted on 2004-01-04 00:47:22 by donkey</div>
   </div>
   <div class="post" id="post-129707">
    <div class="subject"><a href="#post-129707">struct reference/pointer</a></div>
    <div class="body">I'm trying to avoid adding 70k+ size to my exe when we all got 256Mb at least nowadays to play with along with virtual storage. I should change the 0.0 to ? for the above stuff. For the small stuff I never sweat it.<br /><br />The error states 'nested structure improperly initialized' - thought it was the nesting causing the error. Initialized?<br /><br />And I haven't gotten back to it yet, it was a saturday night y'know.  Will continue in a few.</div>
    <div class="meta">Posted on 2004-01-04 03:36:00 by drarem</div>
   </div>
   <div class="post" id="post-129708">
    <div class="subject"><a href="#post-129708">struct reference/pointer</a></div>
    <div class="body">Donkey,<br />     MASM structures appear to define and reference OK, it's the initializing parser that seems to be hosed up.  Fortunately there are other ways to initialize data.  Ratch<pre><code><br /><br /> 00001000			blah STRUCT<br /> 00000000  00000100 &#91;			tester RECT 256 DUP &#40;&#123;&#125;&#41;<br />	    00000000<br />	    00000000<br />	    00000000<br />	    00000000<br />	   &#93;<br />				blah ends<br /><br />				; ------------------------------------------------------------------------------<br /><br /> 00000000			.DATA<br /> 00000000			junk LABEL DWORD<br /> 00000000  00000100 &#91;		 RECT 256 DUP &#40;&#123;1,2,3,4&#125;&#41;<br />	    00000001<br />	    00000002<br />	    00000003<br />	    00000004<br />	   &#93;<br /><br />				; ------------------------------------------------------------------------------<br /> 00000000			.CODE<br /> 00000000			MAIN&#58;<br /> 00000000  A1 0000011C R	 MOV EAX,&#91;junk.blah.tester&#91;17*RECT&#93;.RECT.bottom&#93; ; &quot;bottom&quot; field of 17th RECT element of &quot;tester&quot; of <br />				                                                 ; structure &quot;blah&quot; at label junk</code></pre></div>
    <div class="meta">Posted on 2004-01-04 03:43:57 by Ratch</div>
   </div>
   <div class="post" id="post-129738">
    <div class="subject"><a href="#post-129738">struct reference/pointer</a></div>
    <div class="body">ok I think I might have a workaround - I guess working with nested structures (like REAL4/8/etc) is difficult..<br /><br /><pre><code><br />&#58;&#58;  &#58;&#58;   &#58;&#58;      &#58;&#58;<br />&#58;&#58;  &#58;&#58;   &#58;&#58;      &#58;&#58;<br />FOBJ struct<br />	glType dd 0<br />	glVX   FVERTEX 4096 DUP &#40;&lt;?&gt; &#41;                ;up to 4096 vertices<br />	glVN   FNORMAL 4096 DUP &#40;&lt;?&gt; &#41;              ;will change later<br />	glFU   FUV     4096 DUP &#40;&lt;?&gt; &#41;                   ;will change later<br />	glFACE FFACE   4096 DUP &#40;&lt;?&gt; &#41;               ;will change later<br />FOBJ ends<br /><br /><br />vOBJ DWORD 256 DUP  &#40;?&#41;    ;when running program, allocate 256*4096 each of blah and set<br />                                         ;  vOBJ&#91;n&#93;=&amp;glVX&#91;n*4096&#93;;<br />fOBJ DWORD 256 DUP  &#40;?&#41;    ;when running program, allocate 256*4096 each of blah and set<br />                                         ;  fOBJ&#91;n&#93;=&amp;glVN&#91;n*4096&#93;;<br />nOBJ DWORD 256 DUP  &#40;?&#41;    ;when running program, allocate 256*4096 each of blah and set<br />                                         ;  nOBJ&#91;n&#93;=&amp;vlFU&#91;n*4096&#93;;<br /><br /><br /></code></pre><br /><br />256*4096*4 (from my original structure) is roughly 4Mb file, which is what I am trying to avoid on the .exe file. When program run, heapallocate 4096 for each glVX,glVN, etc.. then allocate 256 for each vOBJ,fOBJ,.. and then set each 0thru256 address of vOBJ,fOBJ equal to value of address in glVX,glVN, etc.. which could be used thruout the program.<br /><br />So instead of typing:<br />  tObj[5].glFU[213]<br />it would be:<br />   fOBJ[213]<br /><br />in the .code section of the program. How does that sound?<br /><br />I will try it later on tonight and post here my results, which may take a bit.</div>
    <div class="meta">Posted on 2004-01-04 10:02:38 by drarem</div>
   </div>
   <div class="post" id="post-129752">
    <div class="subject"><a href="#post-129752">struct reference/pointer</a></div>
    <div class="body">drarem,<br /><div class="quote">ok I think I might have a workaround - I guess working with nested structures (like REAL4/8/etc) is difficult..</div><br />Look at the code below.  Easy to do, no tricks, work arounds, and straight forward.  Just allocate the space when you need it and free it when finished.  Ratch<br /><pre><code><br />				;for structures, need to have the following&#58;<br />				; texture &#91;file0&#93;... &#91;file&#40;n&#41;&#93;<br />				; type=GL_TRIANGLES Or GL_QUADS, or GL_WIREFRAME&#40;?&#41;<br />				; v1,v2,v3,v4  &#40;v4 is used if type says it's QUADS&#41;<br />				; n1,n2     normals<br />				; f1,f2,f3,f4 &#40;f4 if is quad&#41;<br />				; u,v       mapping coords<br /><br /> 00000010			FVERTEX struct           ;Define these STRUCTs outside of any segment definitions.<br />				                         ;It just works better that way.<br /> 00000000  00000000			glV1    REAL4 ?<br /> 00000004  00000000			glV2	REAL4 ?<br /> 00000008  00000000			glV3	REAL4 ?<br /> 0000000C  00000000			glV4	REAL4 ?<br />				FVERTEX ends<br /><br /> 00000008			FNORMAL struct<br /> 00000000  00000000			glN1	REAL4 ?<br /> 00000004  00000000			glN2	REAL4 ?<br />				FNORMAL ends<br /><br /> 00000008			FUV struct<br /> 00000000  00000000			glU		REAL4 ?<br /> 00000004  00000000			glV		REAL4 ?<br />				FUV ends<br /><br /> 00000010			FFACE struct<br /> 00000000  00000000			glF1	dd ?<br /> 00000004  00000000			glF2	dd ?<br /> 00000008  00000000			glF3	dd ?<br /> 0000000C  00000000			glF4	dd ?<br />				FFACE ends<br /><br /> 00030004			FOBJ struct    ;big elaborate structure containing arrays of other structures<br /> 00000000  00000000			glType dd ?<br /> 00000004  00001000 &#91;			glVX   FVERTEX 4096 DUP &#40;&lt;?&gt; &#41;   ;up to 4096 vertices<br />	    00000000<br />	    00000000<br />	    00000000<br />	    00000000<br />	   &#93;<br /> 00010004  00001000 &#91;			glVN   FNORMAL 4096 DUP &#40;&lt;?&gt; &#41;   ;will change later<br />	    00000000<br />	    00000000<br />	   &#93;<br /> 00018004  00001000 &#91;			glFU   FUV     4096 DUP &#40;&lt;?&gt; &#41;   ;will change later<br />	    00000000<br />	    00000000<br />	   &#93;<br /> 00020004  00001000 &#91;			glFACE FFACE   4096 DUP &#40;&lt;?&gt; &#41;   ;will change later<br />	    00000000<br />	    00000000<br />	    00000000<br />	    00000000<br />	   &#93;<br />				FOBJ ends<br /><br />				; ------------------------------------------------------------------------------<br /><br /> 00000000			.DATA<br /><br /> 00000000			.DATA?<br /> 00000000 00000000		   fVertexPtr DWORD ?                  ;storage for dynamic pointer<br /><br />				; ------------------------------------------------------------------------------<br /> 00000000			.CODE<br /> 00000000			MAIN&#58;<br />				 INVOKIT LocalAlloc,LMEM_MOVEABLE,FOBJ ;dynamically allocate some bytes<br /> 00000000  68 00030004	     4	   PUSH FOBJ<br /> 00000005  6A 02	     4	   PUSH LMEM_MOVEABLE<br /> 00000007  E8 00000000 E     1	 CALL LocalAlloc<br />				                                       ;EAX=address of those bytes<br />				                                       ;Let MASM figure out how many bytes you need<br /> 0000000C  A3 00000000 R	 MOV &#91;fVertexPtr&#93;,EAX<br /> 00000011  8D B8 00018004	 LEA EDI,&#91;FOBJ.glFU+EAX&#93;               ;Use FOBJ STRUCT as template to reference<br />				                                       ;FUV structure array position within.<br />				                                       ;Let MASM figure where that address is.<br /> 00000017  B8 00000001		 MOV EAX,1<br /> 0000001C  B9 00002000		 MOV ECX,4096*FUV/DWORD<br /> 00000021  F3/ AB		 REP STOSD                             ;Initialize FUV structure array with ones.<br />				                                       ;More elaborate initializations can be done<br />				                                       ;with multiple and complex loops.<br />				                                       ;Let MASM figure how many times to loop<br />				 ;-------------------------<br />				 ;USE AND ABUSE ALL THOSE BYTES HERE<br />				 ;-------------------------<br /><br />				 INVOKE LocalFree,&#91;fVertexPtr&#93;         ;Then free all those bytes.<br />				END MAIN</code></pre></div>
    <div class="meta">Posted on 2004-01-04 11:55:20 by Ratch</div>
   </div>
  </div>
 </body>
</html>