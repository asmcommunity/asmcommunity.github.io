<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Redirecting imports in DLLs - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=22641" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=22641">Redirecting imports in DLLs</a></p>
   <div class="post" id="post-169821">
    <div class="subject"><a href="#post-169821">Redirecting imports in DLLs</a></div>
    <div class="body">hello,<br />playing around with imports/exports i found this site: http://www.osix.net/modules/article/index.php?id=728<br />it says:<br /><div class="quote">We must build a new .DEF file which will redirect all the exports, like this:<br /><br />LIBRARY<br />EXPORTS<br />&nbsp; &nbsp; GetCommandLineA=kernel32.GetCommandLineA<br />&nbsp; &nbsp; GetVersion=kernel32.GetVersion <br /></div><br /><div class="quote">At this point we have two files that have been called VERNEL32.C (empty) and<br />VERNEL32.DEF. We can now build our simpe DLL with the command line<br /><br />&nbsp; &nbsp; cl -W3 -LD vernel32.c vernel32.def </div><br /><br />so you can build &quot;own&quot; kernel32 to have &quot;easy&quot; Hooks in Usermode (i want to use them on my other PC (Win 98)- so i have some additional &quot;security module&quot; for the Browser (K-Meleon) or for testing my other Applications). <br />It seems to be linkable with C<br /><br />but when i try to assembly/link it with MASM it says:<br /><div class="quote"><br />YERNEL32.dll.def : error LNK2001: unresolved external symbol GetCommandLineA<br />YERNEL32.dll.def : error LNK2001: unresolved external symbol GetCommandLineW<br /></div><br />why?&nbsp; ;). Is there an easy way to link this DLL?<br /><br />My Code:<br /><pre><code>LibMain proc hInstDLL:DWORD, arg:DWORD, reserviert:DWORD<br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; .if arg == DLL_PROCESS_ATTACH<br />&nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov eax,1<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ret <br />&nbsp; &nbsp; &nbsp;  .elseif arg==DLL_PROCESS_DETACH<br />&nbsp; &nbsp; &nbsp;  	mov eax,1<br />&nbsp; &nbsp; &nbsp; &nbsp; ret<br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; .endif<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; ret<br /><br />LibMain Endp<br /><br /><br /><br />End LibMain</code></pre><br />def:<pre><code><br />LIBRARY YERNEL32.DLL<br /><br />EXPORTS<br />CreateFileW=kernel32.CreateFileW<br />GetProcAddress=kernel32.GetProcAddress<br />GetModuleHandleW=kernel32.GetModuleHandleW<br />CreateMutexW=kernel32.CreateMutexW<br />CreateFileA=kernel32.CreateFileA<br /><br />and so on.<br /></code></pre><br />I assembly and link whit RadASM and with:<br /><pre><code><br />\masm32\bin\ml /w3 /c /coff yernel32.dll.asm<br />\masm32\bin\Link /SUBSYSTEM:WINDOWS /DLL&nbsp; /DEF:yernel32.dll.def yernel32.dll.obj<br /></code></pre><br /><br />PS: i can not post in MASM32 Child-Forum (there is no &quot;New-Topic&quot; button)</div>
    <div class="meta">Posted on 2006-02-07 13:37:55 by CDW</div>
   </div>
   <div class="post" id="post-169822">
    <div class="subject"><a href="#post-169822">Re: Redirecting imports in DLLs</a></div>
    <div class="body"><div class="quote"><br />PS: i can not post in MASM32 Child-Forum (there is no &quot;New-Topic&quot; button)<br /></div><br /><br />Becaus all questions related to MASM32 should be redirected to Hutch&#39;s forums as it clearly states in the child-forum description :)</div>
    <div class="meta">Posted on 2006-02-07 15:28:22 by SpooK</div>
   </div>
   <div class="post" id="post-169833">
    <div class="subject"><a href="#post-169833">Re: Redirecting imports in DLLs</a></div>
    <div class="body">Just guessing here, did you try <strong>includelib kernel32.lib</strong>?</div>
    <div class="meta">Posted on 2006-02-08 09:40:20 by QvasiModo</div>
   </div>
   <div class="post" id="post-169841">
    <div class="subject"><a href="#post-169841">Re: Redirecting imports in DLLs</a></div>
    <div class="body"><div class="quote">Just guessing here, did you try includelib kernel32.lib?</div><br />yes (at first).<br />the &quot;full&quot; code:<br /><pre><code><br /><br />&nbsp; &nbsp; .386<br />&nbsp; &nbsp; .model flat, stdcall<br />&nbsp; &nbsp; option casemap :none&nbsp;  <br />; #########################################################################<br /><br />&nbsp; &nbsp; include \masm32\include\windows.inc<br />&nbsp; &nbsp; include \masm32\include\user32.inc<br />&nbsp; &nbsp; include \masm32\include\kernel32.inc<br />&nbsp; &nbsp; include \masm32\include\masm32.inc<br />&nbsp; &nbsp; includelib \masm32\lib\masm32.lib<br />&nbsp; &nbsp; includelib \masm32\lib\user32.lib<br />&nbsp; &nbsp; includelib \masm32\lib\kernel.lib<br /><br />; #########################################################################<br /><br /><br />.data?<br /><br />.code<br /><br />; ##########################################################################<br /><br /><br />LibMain proc hInstDLL:DWORD, arg:DWORD, reserviert:DWORD<br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; .if arg == DLL_PROCESS_ATTACH<br />&nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov eax,1<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ret <br />&nbsp; &nbsp; &nbsp;  .elseif arg==DLL_PROCESS_DETACH<br />&nbsp; &nbsp; &nbsp;  	mov eax,1<br />&nbsp; &nbsp; &nbsp; &nbsp; ret<br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; .endif<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; ret<br /><br />LibMain Endp<br /><br /><br /><br />End LibMain<br /></code></pre></div>
    <div class="meta">Posted on 2006-02-08 15:28:52 by CDW</div>
   </div>
   <div class="post" id="post-170086">
    <div class="subject"><a href="#post-170086">Re: Redirecting imports in DLLs</a></div>
    <div class="body">CDW,<br /><br />Why not try something like this as to not interfere with the naming conventions...<br /><pre><code><br />.386<br />.model flat,stdcall<br />option casemap:none<br /><br />include windows.inc<br />includelib kernel32.lib<br /><br />; we don&#39;t want to import any other stuff from kernel32.dll than we need just yet.<br />LoadLibraryA proto :DWORD<br />FreeLibrary proto :DWORD<br />GetProcAddress proto :DWORD, :DWORD<br /><br />.data<br />&nbsp; &nbsp; szKernel32DLL db &quot;Kernel32.DLL&quot;, 0<br />&nbsp; &nbsp; Kernel32Instance dd 0<br />&nbsp; &nbsp; szCreateFileW db &quot;CreateFileW&quot;, 0<br />&nbsp; &nbsp; myCreateFileW dd 0<br />&nbsp; &nbsp; szGetModuleHandleW db &quot;GetModuleHandleW&quot;, 0<br />&nbsp; &nbsp; myGetModuleHandleW dd 0<br />&nbsp; &nbsp; szCreateMutexW db &quot;CreateMutexW&quot;, 0<br />&nbsp; &nbsp; myCreateMutexW dd 0<br />&nbsp; &nbsp; szCreateFileA db &quot;CreateFileA&quot;, 0<br />&nbsp; &nbsp; myCreateFileA dd 0<br /><br />.code<br />LibMain proc hInstDLL:DWORD, arg:DWORD, reserviert:DWORD<br />&nbsp; &nbsp; .if arg == DLL_PROCESS_ATTACH<br />&nbsp; &nbsp; &nbsp; &nbsp; ; now we can import the true routines that we need with the name we want<br />&nbsp; &nbsp; &nbsp; &nbsp; ; so they don&#39;t interfere with our calls (say if we want to call one of our own routines)<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke LoadLibraryA, addr szKernel32DLL<br />&nbsp; &nbsp; &nbsp; &nbsp; mov Kernel32Instance, eax<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke GetProcAddress, Kernel32Instance, addr szCreateFileW<br />&nbsp; &nbsp; &nbsp; &nbsp; mov myCreateFileW, eax<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke GetProcAddress, Kernel32Instance, addr szGetModuleHandleW<br />&nbsp; &nbsp; &nbsp; &nbsp; mov myGetModuleHandleW, eax<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke GetProcAddress, Kernel32Instance, addr szCreateMutexW<br />&nbsp; &nbsp; &nbsp; &nbsp; mov myCreateMutexW, eax<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke GetProcAddress, Kernel32Instance, addr szCreateFileA<br />&nbsp; &nbsp; &nbsp; &nbsp; mov myCreateFileA, eax<br />&nbsp; &nbsp; &nbsp; &nbsp; mov eax,1<br />&nbsp; &nbsp; &nbsp; &nbsp; ret <br />&nbsp; &nbsp; .elseif arg==DLL_PROCESS_DETACH<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke FreeLibrary, Kernel32Instance<br />&nbsp; &nbsp; &nbsp; &nbsp; mov eax,1<br />&nbsp; &nbsp; &nbsp; &nbsp; ret<br />&nbsp; &nbsp; .endif<br />&nbsp; &nbsp; ret<br />LibMain Endp<br /><br />; Now just define each function that you will use.<br />CreateFileW PROC a:DWORD,b:DWORD,c:DWORD,d:DWORD,e:DWORD,f:DWORD,g:DWORD<br />&nbsp; &nbsp; invoke myCreateFileW, a, b, c, d, e, f, g<br />&nbsp; &nbsp; ret<br />CreateFileW ENDP<br />GetModuleHandleW PROC a:DWORD<br />&nbsp; &nbsp; invoke myGetModuleHandleW, a<br />&nbsp; &nbsp; ret<br />GetModuleHandleW ENDP<br />CreateMutexW PROC a:DWORD,b:DWORD,c:DWORD<br />&nbsp; &nbsp; invoke myCreateMutexW, a, b, c<br />&nbsp; &nbsp; ret<br />CreateMutexW ENDP<br />CreateFileA PROC a:DWORD,b:DWORD,c:DWORD,d:DWORD,e:DWORD,f:DWORD,g:DWORD<br />&nbsp; &nbsp; invoke myCreateFileA, a, b, c, d, e, f, g<br />&nbsp; &nbsp; ret<br />CreateFileA ENDP<br /></code></pre><br /><br />I&#39;m not exactly sure if this is what the article was discussing exactly, from what I can see you trying to do I guess that it is. To build this create a definition file which exports each of your procedures, don&#39;t worry about trying to alias procedures to API&#39;s cause we handled that internally. The things you need to look out for though when doing this is that when you create your DLL, you MUST make sure you have an export for every API the program calls, otherwise the thing will crash. Generally I don&#39;t think this is really the best method (I would personally op for in-memory patching of the IAT) but I hope this helps you out.<br /><br />Regards,<br />Bryant Keller</div>
    <div class="meta">Posted on 2006-02-28 12:50:47 by Synfire</div>
   </div>
  </div>
 </body>
</html>