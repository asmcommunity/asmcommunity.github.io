<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>A failed spy - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=11500" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=116">Windows</a> &raquo; <a href="../?id=11500">A failed spy</a></p>
   <div class="post" id="post-86995">
    <div class="subject"><a href="#post-86995">A failed spy</a></div>
    <div class="body">I've spent some time now trying to use my COM spy build to mimic an object (picstart.dll) so I can watch how it works.<br /><br />So, I have my server registered, try a simple program to open it, everything works fine. <br /><br />But when I try using the 'real' program to open my spy, it hangs up. I'm dumping test message data to a file even on DLL_ATTATCH, but see nothing comming out.<br /><br />Any one have a guess what I could have missed so the program can't find my spy? If I rename it and place the real dll in the same folder, everything works normally.</div>
    <div class="meta">Posted on 2003-03-13 20:32:20 by Ernie</div>
   </div>
   <div class="post" id="post-87017">
    <div class="subject"><a href="#post-87017">A failed spy</a></div>
    <div class="body">Err.. this is rapidly starting to sound like reverse engineering....???</div>
    <div class="meta">Posted on 2003-03-14 01:10:32 by NaN</div>
   </div>
   <div class="post" id="post-87046">
    <div class="subject"><a href="#post-87046">A failed spy</a></div>
    <div class="body">Exactly. It IS reverse engineering. There's nothing illegal per say in that.<br /><br />I'm reversing a dll thats part of a free download. Its purpose is to run a piece of hardware I own. The goal is to provide a more user friendly interface to using the hardware, to make the programming process of a PIC microcontroller a &quot;one click&quot; brainless task for others to use.  <br /><br />It will result in the sale of more microcontrollers for Microchip, which is why they provide the free download in the first place.<br /><br />Sorry, perhaps I should have explained this, but I didn't want to confuse the topic with info that best belongs more in &quot;The Heap.&quot;</div>
    <div class="meta">Posted on 2003-03-14 06:10:21 by Ernie</div>
   </div>
   <div class="post" id="post-87097">
    <div class="subject"><a href="#post-87097">A failed spy</a></div>
    <div class="body">You've said enough,  I just thought i ought to bring it up.  I would give any Joe user some trouble if this were to continue publicly, and I try not to be exclusive.<br /><br />As for your DLL.  I would be glad to help, but I *dont* have your DLL.  And i dont really want to re-download a new package.  Just for a shot in the dark.<br /><br />:NaN:</div>
    <div class="meta">Posted on 2003-03-14 13:30:32 by NaN</div>
   </div>
   <div class="post" id="post-87118">
    <div class="subject"><a href="#post-87118">A failed spy</a></div>
    <div class="body">Nan,<br /><br />  The dll is about 600K. If you would message me your email I'll send it.</div>
    <div class="meta">Posted on 2003-03-14 18:07:14 by Ernie</div>
   </div>
   <div class="post" id="post-88621">
    <div class="subject"><a href="#post-88621">Hmm took me 2 seconds with Exe scope to find...</a></div>
    <div class="body">Im sure this will be some help ;)<br /><br /><pre><code>PICSTARTLib; // Picstart 1.0 Type Library<br /><br />Class Picstart; // Picstart Class<br />GUID=&#123;0F312197-CB40-453B-9775-AEA058CCA34D&#125;;<br />  function Program&#58; HResult;<br />  function Verify&#58; HResult;<br />  function ReadDevice&#58; HResult;<br />  function BlankCheck&#58; HResult;<br />  function Erase&#58; HResult;<br />  function Connect&#58; HResult;<br /><br />Interface IProgrammer; // IProgrammer Interface<br />GUID=&#123;1DA7DC2D-1435-4CA5-9ED1-B5A190810F27&#125;;<br />  function Program&#58; HResult;<br />  function Verify&#58; HResult;<br />  function ReadDevice&#58; HResult;<br />  function BlankCheck&#58; HResult;<br />  function Erase&#58; HResult;<br />  function Connect&#58; HResult;<br /><br />Interface IHardwareTool; // IHardwareTool Interface<br />GUID=&#123;439CBC36-22D4-431C-8E42-389E667D1C30&#125;;<br />  function GetDevice&#40;out pDevice&#58;^^IDevice&#41;&#58; HResult;<br />  function IsDeviceSupported&#40;pDevice&#58;^IDevice; ulParam&#58;UI4&#41;&#58; HResult;<br /><br />Interface IDevice; // IDevice Interface<br />GUID=&#123;EF44DA63-EEB3-11D3-9D8F-006008368E4D&#125;;<br />  function Initialize&#40;pszPart&#58;LPWSTR&#41;&#58; HResult;<br />  function Name&#40;out pszPart&#58;^LPWSTR&#41;&#58; HResult;<br />  function Family&#40;out pszFamily&#58;^LPWSTR&#41;&#58; HResult;<br />  function GetValue&#40;ulKey&#58;UI4; out pValue&#58;^UI4&#41;&#58; HResult;<br />  function GetVariantValues&#40;ulKey&#58;UI4; out pEnumData&#58;^^IEnumVARIANT&#41;&#58; HResult;<br />  function GetStringValues&#40;ulKey&#58;UI4; out pEnumStrings&#58;^^IEnumString&#41;&#58; HResult;<br />  function GetObjectValues&#40;ulKey&#58;UI4; out pEnumObjects&#58;^^IEnumUnknown&#41;&#58; HResult;<br />  function EnumerateDevices&#40;out pEnumDevices&#58;^^IEnumDevices&#41;&#58; HResult;<br />  function GetListInfo&#40;ListType&#58;UI4; out pNumElements&#58;^INT; out pElementSize&#58;^INT&#41;&#58; HResult;<br />  function GetList&#40;ListType&#58;UI4; out pData&#58;^variant&#41;&#58; HResult;<br />  function GetPCMInfo&#40;pcmid&#58;UI4; out pPCMInfo&#58;^variant&#41;&#58; HResult;<br />  function GetPCMGUID&#40;pcmid&#58;UI4; out pPCMGUID&#58;^variant&#41;&#58; HResult;<br />  function GetVariant&#40;ulKey&#58;UI4; pInData&#58;^^variant; out pOutData&#58;^^variant&#41;&#58; HResult;<br /><br />Interface IEnumString;<br />GUID=&#123;00000101-0000-0000-C000-000000000046&#125;;<br />  function RemoteNext&#40;celt&#58;UI4; out rgelt&#58;^LPWSTR; out pceltFetched&#58;^UI4&#41;&#58; HResult;<br />  function Skip&#40;celt&#58;UI4&#41;&#58; HResult;<br />  function Reset&#58; HResult;<br />  function Clone&#40;out ppenum&#58;^^IEnumString&#41;&#58; HResult;<br /><br />Interface IEnumUnknown;<br />GUID=&#123;00000100-0000-0000-C000-000000000046&#125;;<br />  function RemoteNext&#40;celt&#58;UI4; out rgelt&#58;^IUnknown; out pceltFetched&#58;^UI4&#41;&#58; HResult;<br />  function Skip&#40;celt&#58;UI4&#41;&#58; HResult;<br />  function Reset&#58; HResult;<br />  function Clone&#40;out ppenum&#58;^^IEnumUnknown&#41;&#58; HResult;<br /><br />Interface IEnumDevices; // IEnumDevices Interface<br />GUID=&#123;6F3D7845-630C-4426-A960-58883AA3BB58&#125;;<br />  function Next&#40;celt&#58;UI4; out rgelt&#58;^^IDeviceTraits; out pceltFetched&#58;^UI4&#41;&#58; HResult;<br />  function Skip&#40;celt&#58;UI4&#41;&#58; HResult;<br />  function Reset&#58; HResult;<br />  function Clone&#40;out ppenum&#58;^^IEnumDevices&#41;&#58; HResult;<br /><br />Interface IDeviceTraits; // IDeviceTraits Interface<br />GUID=&#123;F6F494A9-8FEA-4498-8C65-9ABD7DCCA654&#125;;<br />  function Name&#40;out pszName&#58;^LPWSTR&#41;&#58; HResult;<br />  function Limitations&#40;out pEnumLimits&#58;^^IEnumString&#41;&#58; HResult;<br />  function PartTypeMask&#40;out pPartTypeMask&#58;^UI4&#41;&#58; HResult;<br />  function SupportMask&#40;out pSupportMask&#58;^UI4&#41;&#58; HResult;<br />  function BetaSupportMask&#40;out pBetaSupportMask&#58;^UI4&#41;&#58; HResult;<br />  function AlphaSupportMask&#40;out pAlphaSupportMask&#58;^UI4&#41;&#58; HResult;<br />  function I2kPCMS&#40;out psz&#58;^LPWSTR&#41;&#58; HResult;<br />  function I4kPCMS&#40;out psz&#58;^LPWSTR&#41;&#58; HResult;<br />  function Family&#40;out psz&#58;^LPWSTR&#41;&#58; HResult;<br />  function ProcID&#40;out pProcID&#58;^UI4&#41;&#58; HResult;<br />  function I2kBetaPCMS&#40;out psz&#58;^LPWSTR&#41;&#58; HResult;<br />  function I4kBetaPCMS&#40;out psz&#58;^LPWSTR&#41;&#58; HResult;</code></pre><br /><br />This DLL also imports routines from another MPLab dll <strong>&quot;MPLBCOMM.DLL&quot;</strong><pre><code>Import, MPLBCOMM.dll<br />Ordinal&#40;Hint&#41;	Name<br />00000004	MPLABCommOpen<br />0000000B	MPLABCommSetConfig<br />00000002	MPLABCommGetConfig<br />0000000C	MPLABCommWriteCommand<br />0000000D	MPLABCommWriteData<br />00000001	MPLABCommClose<br />00000005	MPLABCommReadData<br /></code></pre><br /><br />There is a wack load of registry stings under a resource called &quot;REGISTRY&quot;... This may be a concern to ensure certain criteria is met as well:<br /><pre><code>HKCR<br />&#123;<br />	Picstart.Programmer.1 = s 'Programmer Class'<br />	&#123;<br />		CLSID = s '&#123;0F312197-CB40-453B-9775-AEA058CCA34D&#125;'<br />	&#125;<br />	Picstart.Programmer = s 'Programmer Class'<br />	&#123;<br />		CLSID = s '&#123;0F312197-CB40-453B-9775-AEA058CCA34D&#125;'<br />		CurVer = s 'Picstart.Programmer.1'<br />	&#125;<br />	NoRemove CLSID<br />	&#123;<br />		ForceRemove &#123;0F312197-CB40-453B-9775-AEA058CCA34D&#125; = s 'Programmer Class'<br />		&#123;<br />			ProgID = s 'Picstart.Programmer.1'<br />			VersionIndependentProgID = s 'Picstart.Programmer'<br />			InprocServer32 = s '%MODULE%'<br />			&#123;<br />				val ThreadingModel = s 'Apartment'<br />			&#125;<br />			'TypeLib' = s '&#123;27702258-A140-4999-9B99-23BD790F4165&#125;'<br />		&#125;<br />	&#125;<br />&#125;<br /><br />HKLM<br />&#123;<br />	'SOFTWARE'<br />	&#123;<br />		'Microchip'<br />		&#123;<br />			'MPLAB IDE'<br />			&#123;<br />				'ProcAbout'<br />				&#123;<br />					'Picstart'<br />					&#123;<br />						val 'ModulePath' = s '%Module%'<br />						val 'ProductVersion' = s '%Version%'<br />					&#125;<br />				&#125;<br />			&#125;<br />		&#125;<br />	&#125;<br />&#125;</code></pre><br /><br />I've exported the TypeLib for you as well, its attached as a .zip but rename to a .tlb (i didnt compress it).  You can use your favourite tlb converterer to take it from here (I like Japheth's work, but you may have your own preferences).<br /><br />Let me know if you get anything working from this ;)<br /><br />Enjoy!<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-03-20 23:24:57 by NaN</div>
   </div>
   <div class="post" id="post-88626">
    <div class="subject"><a href="#post-88626">A failed spy</a></div>
    <div class="body">Thanks Nan. I've already hit the dll with OleView to extract the typelib. And Maurice's Tlb2Inc.exe got me an include file no muss no fuss.<br /><br />My clone copy seems to work OK when I use my own loading test program, I get a valid interface pointer from CoGetClassObject. But get nothing when I use the MPLAB program to use my dll.<br /><br />Curiously, if I use my test program to load the real dll, I get back NULL as the interface pointer, but no error is flagged; CoGetClassObject does not return a FAIL hresult.<br /><br />I don't understand how that could be, but deserves another close look (which I may get time for next week).</div>
    <div class="meta">Posted on 2003-03-20 23:49:14 by Ernie</div>
   </div>
  </div>
 </body>
</html>