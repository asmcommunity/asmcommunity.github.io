<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Am I using mmx wrongly here? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=2595" />
  <link rel="prev" href="../?id=2595&amp;page=1" />   </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=2595">Am I using mmx wrongly here?</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=2595&amp;page=1" style="">&laquo;</a><a href="../?id=2595&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="2595" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>   <div class="post" id="post-17012">
    <div class="subject"><a href="#post-17012">Am I using mmx wrongly here?</a></div>
    <div class="body">Thanks, and I hope I haven't spoiled your new year. <br /><br />I've thought of something else which would make the algo more useful, if the alpha values of each pixel could also be blended then you have two forms of control, whole image and per pixel. Of course you wouldn't always want this so it should be written as a seperate algo.<br /><br />I've a pretty good idea on how to implement this so I'll give it a try, its just a pity there are no register left, why do you always run out so quickly?</div>
    <div class="meta">Posted on 2001-12-31 14:38:00 by Eóin</div>
   </div>
   <div class="post" id="post-17029">
    <div class="subject"><a href="#post-17029">Am I using mmx wrongly here?</a></div>
    <div class="body">I got some very interesting errors while coding this.  I will be playng with this stuff on/off for some time.  Maybe, make up a little test program that just assembles MMX instructions.  So, we can edit-test-edit-test real quickly.<br /><br />Did you move the memory accesses to the end of your loop before or after you had seen my algo.  :)  Don't all those ()()()()()() bother you when your playing with the register usage within the algo.<br /><br />It's hard to spoil a New Year.  :alright:<br /><br />p.s. Also, don't forget that your dividing by 256 and the alpha only has a range of 0-255 (ie 255/256 doesn't equal one, but it's close enough.)<br /><br />p.s. <a target="_blank" href="http://www.stereopsis.com/index.html">Stereopsis</a> is another good place to read from.</div>
    <div class="meta">Posted on 2001-12-31 16:57:46 by bitRAKE</div>
   </div>
   <div class="post" id="post-17037">
    <div class="subject"><a href="#post-17037">Am I using mmx wrongly here?</a></div>
    <div class="body">You got me, I moved them after seeing your algo :grin:. I was actually just comparing my code and yours when I noticed that, I made the same change and it speeded things up a bit. <br /><br />Unfortunatly I had to remove them then from the working algo as on the final pass through the loop it would read the quad before the first source pixel and crash.<br /><br />I too ran into a lot of strange errors, almost all to do with negative numbers. I'd then copy what I had into a small test app which could display intermediate results so I could see what was happening.<br /><br />As for brackets, yeah they do bother me, but it never occured to me to try and change them. Now I'm considering naming the registers mma, mmb, mmc, ... and including them in the syntax hilighting. But that then means I'd really need to chage any source code back to the standard form if I'm going to post it. All in all its probably more hassle than its worth.<br /><br />Anyway Happy New Year and thanks for the link. :)</div>
    <div class="meta">Posted on 2001-12-31 18:49:42 by Eóin</div>
   </div>
   <div class="post" id="post-17041">
    <div class="subject"><a href="#post-17041">Am I using mmx wrongly here?</a></div>
    <div class="body">Anyone want to see what prompted me to go to all this effort. I was writing a small version of Pong Hau K'l and I wanted nice smooth edges on the pieces, not pixelated ones.<br /><br />So here's the game for anyone who wants it. Theres no AI so you'll need to have two players, in fact theres no built in rules other than it only allows legal moves so you'll have to take turns yourself and judge when someone wins.<br /><br />For those that don't know the rules, they're very simple. One player takes red, the other is yellow and you take it in turns to move one of your pieces into the free spot. Someone wins when the other player can't make a move because both they're pieces are blocked. Its very simple, and was more or less a waste of time I suppose, except for the huge amount I learned thanks to bitRAKE. And that in itself justifes the effort.<br /><br />But still once you see it you'll have to agree, those pieces are perfectly round. And bitRAKE, don't worry, I have greater uses for a blending algo than just this silly game.</div>
    <div class="meta">Posted on 2001-12-31 19:49:29 by Eóin</div>
   </div>
   <div class="post" id="post-17042">
    <div class="subject"><a href="#post-17042">Am I using mmx wrongly here?</a></div>
    <div class="body">Cool interface.<br /><br />How do you pronounce <strong>E?in</strong>?<br /><br />I wonder if your blending algo is the<br />fastest freely availible on the web?<br /><strong>15552 ticks for 1000 quads</strong> on Athlon.<br /><br />This is part of my common macro file:<pre><code>mm0 EQU &lt;MM0&gt;<br />mm1 EQU &lt;MM1&gt;<br />mm2 EQU &lt;MM2&gt;<br />mm3 EQU &lt;MM3&gt;<br />mm4 EQU &lt;MM4&gt;<br />mm5 EQU &lt;MM5&gt;<br />mm6 EQU &lt;MM6&gt;<br />mm7 EQU &lt;MM7&gt;<br /><br />st0 EQU &lt;st&#40;0&#41;&gt;<br />st1 EQU &lt;st&#40;1&#41;&gt;<br />st2 EQU &lt;st&#40;2&#41;&gt;<br />st3 EQU &lt;st&#40;3&#41;&gt;<br />st4 EQU &lt;st&#40;4&#41;&gt;<br />st5 EQU &lt;st&#40;5&#41;&gt;<br />st6 EQU &lt;st&#40;6&#41;&gt;<br />st7 EQU &lt;st&#40;7&#41;&gt;</code></pre>Most any modern editor could be programmed to search and replace either way.</div>
    <div class="meta">Posted on 2001-12-31 20:47:48 by bitRAKE</div>
   </div>
   <div class="post" id="post-17076">
    <div class="subject"><a href="#post-17076">Am I using mmx wrongly here?</a></div>
    <div class="body">Eoin is pronounced exactly the same as &quot;own&quot;. In fact the English spelling of the name is Owen.<br /><br />Thanks for the compliments, they are very much appreciated. As for It being the fastest alpha blend, well I don't know. It went back up to 20000 when I added in the second overall blend. However I was forced to add it in as a pmullw and psrlw. I was hopeing I could implement it without the shifts by taking the highword of the multiplication, but then I discovered that pmulhw only takes signed words. <br /><br />Signed values seem to be an endless problem :grin: .</div>
    <div class="meta">Posted on 2002-01-01 06:25:32 by Eóin</div>
   </div>
   <div class="post" id="post-17094">
    <div class="subject"><a href="#post-17094">Am I using mmx wrongly here?</a></div>
    <div class="body">In that case you might find this faster, signed version interesting?<br />Oh, look a free register too.  ;)<pre><code>TimeThis&#58; ; &#91;b&#93;13056&#91;/b&#93; ticks for 1000 quads on Athlon.<br />	mov eax,Source<br />	mov edx,Destination<br />	mov ecx,Count ; number of pixels/2<br />	dec ecx<br />	pxor mm7,mm7<br />	movq mm0,&#91;eax+ecx*8&#93;<br />	movq mm1,&#91;edx+ecx*8&#93;<br />@@&#58;	movq mm4,mm0<br />	movq mm2,mm0<br />	psrlw mm4,1<br />	movq mm3,mm1<br />	movq mm5,mm4<br />	punpcklbw mm0,mm7<br />	punpcklbw mm1,mm7<br />	punpckhbw mm2,mm7<br />	punpckhbw mm3,mm7<br />	psubsw mm0,mm1<br />	psubsw mm2,mm3<br />	punpcklwd mm4,mm4<br />	punpckhwd mm5,mm5<br />	punpckhdq mm4,mm4<br />	punpckhdq mm5,mm5<br />	psllw mm0,1<br />	psllw mm2,1<br />	pmulhw mm0,mm4<br />	pmulhw mm2,mm5<br />	paddsw mm0,mm1<br />	paddsw mm2,mm3<br />	packuswb mm0,mm2<br />	movq &#91;edx+ecx*8&#93;,mm0<br />	dec ecx<br />	movq mm0,&#91;eax+ecx*8&#93;<br />	movq mm1,&#91;edx+ecx*8&#93;<br />	jns @B<br />	ret 12</code></pre></div>
    <div class="meta">Posted on 2002-01-01 11:10:45 by bitRAKE</div>
   </div>
   <div class="post" id="post-17180">
    <div class="subject"><a href="#post-17180">Am I using mmx wrongly here?</a></div>
    <div class="body">If I've said it once, I've said it a thousand times, where do you come up with this stuff, it's genius. :) <br /><br />Below is the slight modification I made to allow the additional overall alpha control, mm6 need only be setup with the alpha value outside of the loop and your off. <br /><br />This allows for some lovely animated effects such as smoke and fire. It times at 18 ticks (was at 15 before I added this bit), surely you must now have written one of the fastest alpha blend algos out there, great work bitRAKE :alright: .<br /><br /><span style="font-size:9px><pre><code>	pxor mm7,mm7<br />	&#91;COLOR=darkred&#93;movq mm6,&#91;I&#93;Overall Alpha value. Properly formatted&#58; 00AA00AA00AA00AA&#41;&#91;/I&#93;&#91;/COLOR&#93;<br />	movq mm0,&#91;eax+ecx*8&#93;<br />	movq mm1,&#91;edx+ecx*8&#93;<br />@@&#58;	movq mm4,mm0<br />	movq mm2,mm0<br />	psrlw mm4,1<br />	movq mm3,mm1<br />	movq mm5,mm4<br />	punpcklbw mm0,mm7<br />	punpcklbw mm1,mm7<br />	punpckhbw mm2,mm7<br />	punpckhbw mm3,mm7<br />	psubsw mm0,mm1<br />	psubsw mm2,mm3<br />	punpcklwd mm4,mm4<br />	punpckhwd mm5,mm5<br />	punpckhdq mm4,mm4<br />	punpckhdq mm5,mm5	<br />	psllw mm0,1<br />&#91;COLOR=darkred&#93;	<br />	psraw mm4,8<br />	psraw mm5,8<br />&#91;/COLOR&#93;	<br />	psllw mm2,1<br />&#91;COLOR=darkred&#93;<br />	pmullw mm4,mm6<br />	pmullw mm5,mm6<br />&#91;/COLOR&#93;	<br />	pmulhw mm0,mm4<br />	pmulhw mm2,mm5<br />	paddsw mm0,mm1<br />	paddsw mm2,mm3<br />	packuswb mm0,mm2<br />	movq &#91;edx+ecx*8&#93;,mm0<br />	dec ecx<br />	movq mm0,&#91;eax+ecx*8&#93;<br />	movq mm1,&#91;edx+ecx*8&#93;<br />	jns @B</code></pre></span></div>
    <div class="meta">Posted on 2002-01-01 20:16:00 by Eóin</div>
   </div>
   <div class="post" id="post-17185">
    <div class="subject"><a href="#post-17185">Am I using mmx wrongly here?</a></div>
    <div class="body">Thanks, I just hope everyone will use it - I hate slow software.  :grin:<br />Nice addition - can't wait to see what you have planned for this!</div>
    <div class="meta">Posted on 2002-01-01 22:40:24 by bitRAKE</div>
   </div>
   <div class="post" id="post-17201">
    <div class="subject"><a href="#post-17201">Am I using mmx wrongly here?</a></div>
    <div class="body"><pre><code>	pxor mm7,mm7<br />	movq mm6,GlobalAlpha<br />; top bit clear to ensure positive number<br />	psllw mm6,7<br />	movq mm0,&#91;eax+ecx*8&#93;<br />	movq mm1,&#91;edx+ecx*8&#93;<br />@@&#58;	movq mm4,mm0<br />	movq mm2,mm0<br />; top bit clear to ensure positive number<br />	psrlw mm4,1<br />	movq mm3,mm1<br />	movq mm5,mm4<br />	punpcklbw mm0,mm7<br />	punpcklbw mm1,mm7<br />	punpckhbw mm2,mm7<br />	punpckhbw mm3,mm7<br />	psubsw mm0,mm1<br />	psubsw mm2,mm3<br />	punpcklwd mm4,mm4<br />	punpckhwd mm5,mm5<br />	punpckhdq mm4,mm4<br />	punpckhdq mm5,mm5	<br />	psllw mm0,2<br />	psllw mm2,2<br /><br />	pmulhw mm4,mm6 ; top two bits are clear<br />	pmulhw mm5,mm6 ; ie 7F... * 7F... = 3FF...<br /><br />	pmulhw mm0,mm4<br />	pmulhw mm2,mm5<br />; total scaling gives signed-words to below<br />	paddsw mm0,mm1<br />	paddsw mm2,mm3<br /><br />	packuswb mm0,mm2<br />	movq &#91;edx+ecx*8&#93;,mm0<br />	dec ecx<br />	movq mm0,&#91;eax+ecx*8&#93;<br />	movq mm1,&#91;edx+ecx*8&#93;<br />	jns @B</code></pre>Please, let me know if this works?<br />It seems logical that the shifts aren't needed.  ;)<br />Better accuracy, too.</div>
    <div class="meta">Posted on 2002-01-02 03:47:56 by bitRAKE</div>
   </div>
   <div class="post" id="post-17216">
    <div class="subject"><a href="#post-17216">Am I using mmx wrongly here?</a></div>
    <div class="body">Yes, it worked perfectly once I reformatted the the way GlobalAlpha was represented in mm6. And it clocks at 15.5 on my laptop, its really really fast code.<br /><br />Its things like this that show why assembly is still needed, could any compiler even come close to this? I doubt it very much.<br /><br />I think I should knock together a nice tech demo to show off what can be achieved with this.</div>
    <div class="meta">Posted on 2002-01-02 06:21:13 by Eóin</div>
   </div>
   <div class="post" id="post-17217">
    <div class="subject"><a href="#post-17217">Am I using mmx wrongly here?</a></div>
    <div class="body">it's nice to see people optimize where there's actually something<br />to gain ;). Good work you two..</div>
    <div class="meta">Posted on 2002-01-02 06:28:58 by f0dder</div>
   </div>
   <div class="post" id="post-41495">
    <div class="subject"><a href="#post-41495">Am I using mmx wrongly here?</a></div>
    <div class="body">Use PSHUFW to expand alpha values and save another cycle+. :)<br /><span style="font-size:9px>...of course, you limit the audience to 3DNow! and SSE folks.</span></div>
    <div class="meta">Posted on 2002-06-05 00:28:06 by bitRAKE</div>
   </div>
   <div class="post" id="post-54444">
    <div class="subject"><a href="#post-54444">Am I using mmx wrongly here?</a></div>
    <div class="body">Is anything happening with this code anymore?<br /><br />Anyone working on a demo?</div>
    <div class="meta">Posted on 2002-08-22 04:41:58 by Qweerdy</div>
   </div>
   <div class="post" id="post-54462">
    <div class="subject"><a href="#post-54462">Am I using mmx wrongly here?</a></div>
    <div class="body">I ultimatly used it in this <a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=6844">library</a> which most recently I used for a simple internet chess program.</div>
    <div class="meta">Posted on 2002-08-22 07:41:25 by Eóin</div>
   </div>
   <div class="post" id="post-54497">
    <div class="subject"><a href="#post-54497">Am I using mmx wrongly here?</a></div>
    <div class="body">Thanks... looking at the date you posted that, I guess I must have missed it while I was on vacation :( <br /><br />This lib looks very good :alright:</div>
    <div class="meta">Posted on 2002-08-22 13:00:51 by Qweerdy</div>
   </div>
   <div class="post" id="post-54515">
    <div class="subject"><a href="#post-54515">Am I using mmx wrongly here?</a></div>
    <div class="body">Thanks, one thing I'd like to add is DX support.<br /><br />I came across a Life program, <a target="_blank" href="http://psoup.math.wisc.edu/Life32.html">Life32</a>. I'd love to implement the way it uses DX, as it allows for windowed mode. <br /><br />It's not a perfect implementation but if high frame rates in windowed mode were necessary I'd say its good enough.<br /><br />Overlays could be another solution, but my lack of DX experience blocks me on both these avenues.</div>
    <div class="meta">Posted on 2002-08-22 16:50:51 by Eóin</div>
   </div>
   <div class="post" id="post-54688">
    <div class="subject"><a href="#post-54688">Am I using mmx wrongly here?</a></div>
    <div class="body"><div class="quote"><br />AMD Athalon XP 1.53GHz<br />---------------------------<br />Minimum Time:<br />---------------------------<br />10912 ticks for 1000 quads. <br />---------------------------<br />OK   <br />---------------------------<br /></div><br /><br />On my athalon 1.4Ghz I got exactly the same result???</div>
    <div class="meta">Posted on 2002-08-23 19:25:57 by huh</div>
   </div>
   <div class="post" id="post-54727">
    <div class="subject"><a href="#post-54727">Am I using mmx wrongly here?</a></div>
    <div class="body">That's not so strange, on your pc there's just less ticks per second :)</div>
    <div class="meta">Posted on 2002-08-24 06:23:02 by Qweerdy</div>
   </div>
   <div class="post" id="post-54787">
    <div class="subject"><a href="#post-54787">Am I using mmx wrongly here?</a></div>
    <div class="body"><div class="quote">That's not so strange, on your pc there's just less ticks per second</div> <br /><br />True:stupid:</div>
    <div class="meta">Posted on 2002-08-25 01:21:49 by huh</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=2595&amp;page=1" style="">&laquo;</a><a href="../?id=2595&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="2595" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>  </div>
 </body>
</html>