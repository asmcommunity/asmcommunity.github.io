<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>GetFilesize - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=16886" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=16886">GetFilesize</a></p>
   <div class="post" id="post-130976">
    <div class="subject"><a href="#post-130976">GetFilesize</a></div>
    <div class="body">how can i get the filesize of my 'running' exe ?<br /><br />i get commandline at startup = path/exename<br />now i try openfile 'path/exename' and get error, i thing because file is running since it works on a file what not runs :(<br /><br />i want to get the filesize of my tool on startup, then look if filesize is like the filesize in .data<br />if not exit...<br /><br />any ideas ?</div>
    <div class="meta">Posted on 2004-01-18 12:21:53 by xanthos</div>
   </div>
   <div class="post" id="post-130981">
    <div class="subject"><a href="#post-130981">GetFilesize</a></div>
    <div class="body">When using CreateFile on a running process you can't use GENERIC_WRITE and u have to use FILE_SHARE_READ</div>
    <div class="meta">Posted on 2004-01-18 12:45:42 by ENF</div>
   </div>
   <div class="post" id="post-131023">
    <div class="subject"><a href="#post-131023">GetFilesize</a></div>
    <div class="body">You may also use FindFirstFile to get this information:<br /><pre><code><br />  .386<br />  .model flat,stdcall<br />  option casemap&#58;none<br /><br />  include windows.inc<br />  include kernel32.inc<br />  include user32.inc<br />  includelib kernel32.lib<br />  includelib user32.lib<br /><br />.data?<br />  w32fd           WIN32_FIND_DATA &lt;&gt;<br />  szBuf           db 512 dup&#40;?&#41;<br />  _st             SYSTEMTIME &lt;&gt;<br />  _ft             FILETIME &lt;&gt;<br />  szDateBuf       db 11 dup&#40;?&#41;<br />  szTimeBuf       db 9 dup&#40;?&#41;<br />  szMessage       db 1024 dup&#40;?&#41;<br /><br />.code<br />  szFileName      db &quot;FileName&#58; &quot;,9,&quot;%s&quot;,13,10,0<br />  szAlternate     db &quot;Alternate name&#58; &quot;,9,&quot;%s&quot;,13,10,0<br />  szAttr          db &quot;Attributes&#58; &quot;,9,&quot;%#08x&quot;,13,10,0<br />  szDate_         db &quot;dd-MM-yyyy&quot;,0<br />  szTime_         db &quot;hh&#58;mm&#58;ss&quot;,0<br />  szCreateTime    db &quot;Created&#58; &quot;,9,9,&quot;%s %s&quot;,13,10,0<br />  szAccessTime    db &quot;Last accessed&#58; &quot;,9,&quot;%s %s&quot;,13,10,0<br />  szModifyTime    db &quot;Modified&#58; &quot;,9,9,&quot;%s %s&quot;,13,10,0<br />  szFileSize      db &quot;Size&#58; &quot;,9,9,&quot;%d&quot;,0<br /><br />  szTitle db &quot;Self file information&quot;,0<br /><br />start&#58;<br />  invoke GetModuleFileName,NULL,addr szBuf,MAX_PATH<br />  invoke FindFirstFile,addr szBuf,addr w32fd<br />  .if eax!=INVALID_HANDLE_VALUE<br />    invoke FindClose,eax<br />    <br />    invoke wsprintf,addr szBuf,addr szFileName,addr w32fd.cFileName<br />    invoke lstrcpy,addr szMessage,addr szBuf<br /><br />    invoke wsprintf,addr szBuf,addr szAlternate,addr w32fd.cAlternate<br />    invoke lstrcat,addr szMessage,addr szBuf<br /><br />    invoke wsprintf,addr szBuf,addr szAttr,w32fd.dwFileAttributes<br />    invoke lstrcat,addr szMessage,addr szBuf<br /><br />    invoke FileTimeToLocalFileTime,addr w32fd.ftCreationTime,addr _ft<br />    invoke FileTimeToSystemTime,addr _ft,addr _st<br />    invoke GetDateFormat,LOCALE_USER_DEFAULT,0,addr _st,addr szDate_,addr szDateBuf,11<br />    invoke GetTimeFormat,LOCALE_USER_DEFAULT,0,addr _st,addr szTime_,addr szTimeBuf,9<br />    invoke wsprintf,addr szBuf,addr szCreateTime,addr szDateBuf,addr szTimeBuf<br />    invoke lstrcat,addr szMessage,addr szBuf<br /><br />    invoke FileTimeToLocalFileTime,addr w32fd.ftLastAccessTime,addr _ft<br />    invoke FileTimeToSystemTime,addr _ft,addr _st<br />    invoke GetDateFormat,LOCALE_USER_DEFAULT,0,addr _st,addr szDate_,addr szDateBuf,11<br />    invoke GetTimeFormat,LOCALE_USER_DEFAULT,0,addr _st,addr szTime_,addr szTimeBuf,9<br />    invoke wsprintf,addr szBuf,addr szAccessTime,addr szDateBuf,addr szTimeBuf<br />    invoke lstrcat,addr szMessage,addr szBuf<br /><br />    invoke FileTimeToLocalFileTime,addr w32fd.ftLastWriteTime,addr _ft<br />    invoke FileTimeToSystemTime,addr _ft,addr _st<br />    invoke GetDateFormat,LOCALE_USER_DEFAULT,0,addr _st,addr szDate_,addr szDateBuf,11<br />    invoke GetTimeFormat,LOCALE_USER_DEFAULT,0,addr _st,addr szTime_,addr szTimeBuf,9<br />    invoke wsprintf,addr szBuf,addr szModifyTime,addr szDateBuf,addr szTimeBuf<br />    invoke lstrcat,addr szMessage,addr szBuf<br /><br />    invoke wsprintf,addr szBuf,addr szFileSize,w32fd.nFileSizeLow<br />    invoke lstrcat,addr szMessage,addr szBuf<br /><br />    invoke MessageBox,0,addr szMessage,addr szTitle,MB_ICONINFORMATION<br />  .endif<br />  invoke ExitProcess,0<br />end start<br /></code></pre></div>
    <div class="meta">Posted on 2004-01-19 02:37:36 by Morris</div>
   </div>
   <div class="post" id="post-131041">
    <div class="subject"><a href="#post-131041">GetFilesize</a></div>
    <div class="body">;FASM version<br /><pre><code><br />include '%fasminc%/win32ax.inc'<br />MAX_PATH = 260<br />LOCALE_USER_DEFAULT = 0<br />struc WIN32_FIND_DATA<br />&#123; .dwFileAttributes      dd      ?<br />  .ftCreationTime        FILETIME<br />  .ftLastAccessTime      FILETIME<br />  .ftLastWriteTime       FILETIME<br />  .nFileSizeHigh         dd      ?<br />  .nFileSizeLow          dd      ?<br />  .dwReserved0           dd      ?<br />  .dwReserved1           dd      ?<br />  .cFileName             rb MAX_PATH<br />  .cAlternate            rb 14 &#125;<br /><br />.data<br />  w32fd           WIN32_FIND_DATA<br />  szBuf           rb 512<br />  _st             SYSTEMTIME<br />  _ft             FILETIME<br />  szDateBuf       rb 11<br />  szTimeBuf       rb 9<br />  szMessage       rb 1024<br /><br />.code<br />  szFileName      db &quot;FileName&#58; &quot;,9,&quot;%s&quot;,13,10,0<br />  szAlternate     db &quot;Alternate name&#58; &quot;,9,&quot;%s&quot;,13,10,0<br />  szAttr          db &quot;Attributes&#58; &quot;,9,&quot;%#08x&quot;,13,10,0<br />  szDate_         db &quot;dd-MM-yyyy&quot;,0<br />  szTime_         db &quot;hh&#58;mm&#58;ss&quot;,0<br />  szCreateTime    db &quot;Created&#58; &quot;,9,9,&quot;%s %s&quot;,13,10,0<br />  szAccessTime    db &quot;Last accessed&#58; &quot;,9,&quot;%s %s&quot;,13,10,0<br />  szModifyTime    db &quot;Modified&#58; &quot;,9,9,&quot;%s %s&quot;,13,10,0<br />  szFileSize      db &quot;Size&#58; &quot;,9,9,&quot;%d&quot;,0<br /><br />  szTitle db &quot;Self file information&quot;,0<br /><br />start&#58;<br />  invoke GetModuleFileName,NULL,addr szBuf,MAX_PATH<br />  invoke FindFirstFile,szBuf,w32fd<br />  cmp eax,INVALID_HANDLE_VALUE<br />  je end_if<br />    invoke FindClose,eax<br /><br />    invoke wsprintf,addr szBuf,addr szFileName,addr w32fd.cFileName<br />    invoke lstrcpy,addr szMessage,addr szBuf<br /><br />    invoke wsprintf,addr szBuf,addr szAlternate,addr w32fd.cAlternate<br />    invoke lstrcat,addr szMessage,addr szBuf<br /><br />    invoke wsprintf,addr szBuf,addr szAttr,w32fd.dwFileAttributes<br />    invoke lstrcat,addr szMessage,addr szBuf<br /><br />    invoke FileTimeToLocalFileTime,addr w32fd.ftCreationTime,addr _ft<br />    invoke FileTimeToSystemTime,addr _ft,addr _st<br />    invoke GetDateFormat,LOCALE_USER_DEFAULT,0,addr _st,addr szDate_,addr szDateBuf,11<br />    invoke GetTimeFormat,LOCALE_USER_DEFAULT,0,addr _st,addr szTime_,addr szTimeBuf,9<br />    invoke wsprintf,addr szBuf,addr szCreateTime,addr szDateBuf,addr szTimeBuf<br />    invoke lstrcat,addr szMessage,addr szBuf<br /><br />    invoke FileTimeToLocalFileTime,addr w32fd.ftLastAccessTime,addr _ft<br />    invoke FileTimeToSystemTime,addr _ft,addr _st<br />    invoke GetDateFormat,LOCALE_USER_DEFAULT,0,addr _st,addr szDate_,addr szDateBuf,11<br />    invoke GetTimeFormat,LOCALE_USER_DEFAULT,0,addr _st,addr szTime_,addr szTimeBuf,9<br />    invoke wsprintf,addr szBuf,addr szAccessTime,addr szDateBuf,addr szTimeBuf<br />    invoke lstrcat,addr szMessage,addr szBuf<br /><br />    invoke FileTimeToLocalFileTime,addr w32fd.ftLastWriteTime,addr _ft<br />    invoke FileTimeToSystemTime,addr _ft,addr _st<br />    invoke GetDateFormat,LOCALE_USER_DEFAULT,0,addr _st,addr szDate_,addr szDateBuf,11<br />    invoke GetTimeFormat,LOCALE_USER_DEFAULT,0,addr _st,addr szTime_,addr szTimeBuf,9<br />    invoke wsprintf,addr szBuf,addr szModifyTime,addr szDateBuf,addr szTimeBuf<br />    invoke lstrcat,addr szMessage,addr szBuf<br /><br />    invoke wsprintf,addr szBuf,addr szFileSize,w32fd.nFileSizeLow<br />    invoke lstrcat,addr szMessage,addr szBuf<br /><br />    invoke MessageBox,0,addr szMessage,addr szTitle,MB_ICONINFORMATION<br />  end_if&#58;<br />  invoke ExitProcess,0<br />.end start <br /></code></pre></div>
    <div class="meta">Posted on 2004-01-19 08:26:06 by HarryTuttle</div>
   </div>
   <div class="post" id="post-131060">
    <div class="subject"><a href="#post-131060">THANKS !</a></div>
    <div class="body">many thanks !<br />so much help, dont know what to say :)<br /><br />T H A N K S !<br /><br />hopefull i can now end my tool to check for ie hijacker.<br />since someone ad the trojan.spooner.c to my spooner removel tool id better ad some protection against filejoiner to my file.<br /><br />hope some cryptet filesize inside the .data section and a filesizecheck will help against this.<br />this way only warn a user that my tool is infected.<br /><br />im not familiar with pe file header and methodes of joining files.<br />so im asking mybe a stupid question : is there a way to check a infection on startup ?<br /><br />i read something about adding a file at the end of another file and changing the pe header.<br />some way to check this at startup, so the file wont start the added file ?<br /><br />anyone know a free program to protect a file ?<br /><br />greets Xanthos</div>
    <div class="meta">Posted on 2004-01-19 14:16:28 by xanthos</div>
   </div>
   <div class="post" id="post-131090">
    <div class="subject"><a href="#post-131090">GetFilesize</a></div>
    <div class="body">Do you mean you want your file to do a self check?<br />There are several ways to do this. If your file has been infected with a virus then it could have its entry point changed to point to the added code so at startup you could look up the entry point in PE header and check the bytes to see if they match what they should be. could also do a crc32 or other crypto of the file.</div>
    <div class="meta">Posted on 2004-01-19 18:34:17 by ENF</div>
   </div>
   <div class="post" id="post-131324">
    <div class="subject"><a href="#post-131324">GetFilesize</a></div>
    <div class="body">Yes thats what i mean :)<br />i try a lookup in google for pe header.<br /><br />thanks :)</div>
    <div class="meta">Posted on 2004-01-22 00:45:24 by xanthos</div>
   </div>
  </div>
 </body>
</html>