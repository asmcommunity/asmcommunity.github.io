<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Feel like Optomizing somthing ?? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=5508" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=5508">Feel like Optomizing somthing ??</a></p>
   <div class="post" id="post-39129">
    <div class="subject"><a href="#post-39129">Feel like Optomizing somthing ??</a></div>
    <div class="body">I was wondering if anyone could perscribe a faster method of number crunhing, as outlined below:<br /><br />Im thinking mmx would probably be best, but im too novice at it to &quot;design&quot; it right (as im learing) :rolleyes:<pre><code><br />&#91;b&#93;.data&#91;/b&#93;<br />      Base  dd &#40;1 SHL 15&#41;      <br />      <br />      Pout1 dq 0<br />      Pin1  dq 0<br />      Pout2 dq 0<br />      Pin2  dq 0<br />      <br />            ; 200hz          ; 100hz           10 hz               1000 hz  Corner selection values<br />      A  dq 0.02769840546830 ;0.01404650652530 ;0.00142273056281 ;0.12397764071599<br />      B  dq 0.94460318906340 ;0.97190698694940 ;0.99715453887439 ;0.75204471856802     <br /><br />&#91;b&#93;.code&#91;/b&#93;<br />LPFilter PROC uses ebx esi edi lpHdr&#58;DWORD<br />   mov ebx, lpHdr<br />   mov esi, &#91;ebx&#93;.WAVEHDR.lpData                      ; Get the start address of data<br />   mov ecx, &#91;ebx&#93;.WAVEHDR.dwBufferLength              ; Get # of bytes to process<br />   shr ecx, 2                                         ; div by 2 chanels and 2 byts/chanel<br /><br />   .while &#40; ecx &gt; 0&#41;<br />   fild SWORD PTR &#91;esi&#93;                               ; Left Channel Data 16 bits<br />   fild DWORD PTR Base                                ; Normalize it<br />   fdiv <br />   fld  st&#40;0&#41;                                         ; Copy for Pin &#40;prev input&#41; update l8r on<br />   fmul QWORD PTR A                                   ; 1&#41; In * A<br />   fld  QWORD PTR Pin1                                ; 2&#41; PrevIn * A<br />   fmul QWORD PTR A                                   ;<br />   fld  QWORD PTR Pout1                               ; 3&#41; PrevOut * B<br />   fmul QWORD PTR B                                   ;<br />   fadd<br />   fadd                                               ; St0 = In*A + PrevIn*A + PrevOut*B<br />   fxch                                               ; <br />   fstp QWORD PTR Pin1                                ; Update the Prev In, pop<br />   fst  QWORD PTR Pout1                               ; Update PrevOut with output<br />   fild DWORD PTR Base                                ; Load base again<br />   fmul                                               ; Denormalize<br />   fistp SWORD PTR &#91;esi&#93;                              ; pop 16 bit sword == Output<br /><br />   add esi,2                                          ; Goto Right Channel<br />   fild SWORD PTR &#91;esi&#93;<br />   fild DWORD PTR Base<br />   fdiv <br />   fld  st&#40;0&#41;<br />   fmul QWORD PTR A<br />   fld  QWORD PTR Pin2                                ; RIght PRev In<br />   fmul QWORD PTR A<br />   fld  QWORD PTR Pout2                               ; Right Prev Out<br />   fmul QWORD PTR B<br />   fadd<br />   fadd<br />   fxch<br />   fstp QWORD PTR Pin2<br />   fst  QWORD PTR Pout2<br />   fild DWORD PTR Base<br />   fmul<br />   fistp SWORD PTR &#91;esi&#93;<br />   add esi,2<br />   dec ecx<br />   .endw<br />@@&#58;   <br />   ret<br />LPFilter ENDP   </code></pre><br /><br />ESI has the CURRENT WORD from the buffer (In), and the data members Pin1, Pin2, Pout1, Pout2 are previous Input/Ouput values from previous &quot;crunches&quot; of this algorithm:<br /><br />  Out =  A*In + A*Pin + B*Pout<br />  Pin= In<br />  Pout = Out<br /><br />Where it is copied in parallel for left and right (Pin1, Pin2) and (Pout1, Pout2). Out is written back where the input was found, but Previous values are still noted separately. This is because the buffer is not continous, and will be broken! <br /><br /><br />For backgournd:<br />--------------------<br />The entire algorithm above is a Low Pass filter with a corner set to 200hz.    It will filter properly any 16bit, dual channel wave file, and play it.  Its currently hard coded to &quot;beatles.wav&quot; as im testing in on a ripped mp3-&gt;wav.<br /><br />I plan to write *alot* of simular code, which will get more complex, so im hoping someone can help be see the most optomized solutions, on the basic building block shown above.  Then i can learn and &quot;multiply&quot; the basic knowledge onto the bigger alorithms.<br /><br />Thanx alot in advanced.  All i can give in return is my source for you play with ;)<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-05-21 04:04:21 by NaN</div>
   </div>
   <div class="post" id="post-39143">
    <div class="subject"><a href="#post-39143">some links</a></div>
    <div class="body"><a target="_blank" href="http://www.musicdsp.org">http://www.musicdsp.org</a><br /> - nice searchable collection of articles and code<br /><br /><a target="_blank" href="http://www.digitalfishphones.com/main.php?item=3&amp;subItem=2">http://www.digitalfishphones.com/main.php?item=3&amp;subItem=2</a><br /> - link collection<br /><br />hope it helps somehow<br />TBD</div>
    <div class="meta">Posted on 2002-05-21 06:14:30 by TBD</div>
   </div>
   <div class="post" id="post-39196">
    <div class="subject"><a href="#post-39196">Feel like Optimizing something ??</a></div>
    <div class="body"><strong>NaN</strong>, here is the basics outline:<br /><br /><u>Two channels are done in parallel</u><ul>[*]load qword (In1,In2,In1,In2)<br />[*]unpack 2x (In1,0,In2,0)<br />[*]add previous 2x (Pin1,Pout1,Pin2,Pout2)<br />[*]multiply add 2x (A,B,A,B) constant<br />[*]pack 2x (In1',In2',In1',In2')<br />[*]update previous 2x (shift/or)?<br />[*]store qwordThe equation can be reduced to: Out = A*(In + Pin) + B*Pout<br /><br />The middle part of the outline is doubled over to ease reading, but you must wait for the results of the first part of the middle to update the previous for the second part of the middle - am I confusing you yet?  I'd code it up, but I'm at work and also still in the process of moving.</div>
    <div class="meta">Posted on 2002-05-21 10:18:16 by bitRAKE</div>
   </div>
   <div class="post" id="post-39237">
    <div class="subject"><a href="#post-39237">Feel like Optimizing something ??</a></div>
    <div class="body"><pre><code>	mov ecx,samples<br />	mov esi,source<br />	mov edi,dest<br />	shr ecx,1	; two samples per loop<br />	lea esi,&#91;esi+ecx*8&#93;<br />	lea edi,&#91;edi+ecx*8&#93;<br />	neg ecx<br /><br />	xor mm7,mm7	; zero<br />	movq mm6,previous	; zero?<br />	movq mm5,ABAB<br /><br />_0&#58;	mov mm0,&#91;esi + ecx*8&#93;<br />	mov mm1,mm0<br /><br />	punpckldw mm0,mm7<br />	punpckhdw mm1,mm7<br /><br />;sample one<br />	addsw mm0,mm6<br />	pmaddwd mm0,mm5<br />	packsdw mm0,mm7<br /><br />	pslrd mm6,16<br />	por mm6,mm0<br /><br />;sample two<br />	addsw mm1,mm6<br />	pmaddwd mm1,mm5<br />	packsdw mm1,mm7<br /><br />	pslrd mm6,16<br />	por mm6,mm1<br /><br /><br />	packswd mm0,mm1<br />	movq &#91;edi+ecx*8&#93;,mm0<br /><br />	inc ecx<br />	jne _0</code></pre>...maybe something like this?  Atleast you should get the gist of what I mean?  Forgive me I'm programming without a computer again, but I'll debug this tomorrow when I have power at my new home.</div>
    <div class="meta">Posted on 2002-05-21 13:27:29 by bitRAKE</div>
   </div>
   <div class="post" id="post-39253">
    <div class="subject"><a href="#post-39253">Feel like Optimizing something ??</a></div>
    <div class="body">Thanks for your help.. I will try to carry forth from here ;)  Much appreciated!<br /><br />I have times from FPU example, im currious to see the saving if any here...<br /><br /><strong>TBD</strong>:  Thanx for the links! They look great!<br /><br />Thanx again<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-05-21 14:23:46 by NaN</div>
   </div>
  </div>
 </body>
</html>