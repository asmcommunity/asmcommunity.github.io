<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>interfacing with c/c++: finally solved - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=460" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=460">interfacing with c/c++: finally solved</a></p>
   <div class="post" id="post-2681">
    <div class="subject"><a href="#post-2681">interfacing with c/c++: finally solved</a></div>
    <div class="body">interfacing with c/c++: problem solved<br />----------------------------------------------<br /><br />karim, i finally solved my problem. (after 2 months that is...) this is something for the curious before i leave. first of all, i won't tell you the data type, such as return values (what registers it should be in ect...) but i will tell you the layout and then you're on your own (f0dder told me that you should do the research yourself. don't be lazy - that's where learning comes). (this is my note. it's not a tutorial. )<br /><br />first of all, TurboC++ was my target, everything i know about Visual C++ doesn't work with Turbo C++. therefore, to really interface with Turbo C++, you have to use TASM (it's  possible with MASM, which i'm still trying to figure it out right now) but even if masm works with turboc++, i don't think it's a good idea that you combine MS and Borland together. Borland understood Turbo C++ more than Microsoft, whereas Microsoft understood VC++ much more than Borland (i'm talking about the inner and how it was created). therefore, if you're interfacing with turbo c++ or turbo pascal, use TASM. and use MASM if you're interfacing with Microsoft C/C++ or Visual C++, don't try to mix them. (guess what? it works perfectly fine if you use MASM and interface it with Turbo Pascal)<br /><br />(repnz stosb &lt;--- compiled fine with tasm, but not with masm. tasm is playing smart. that's not what most people want...)<br /><br />ok. i'll explain Turbo C++ first (cause it's kind of confusing):<br /><br />take a look at c:\tc\lib and you'll see alot of *.obj file. the following are important:<br /><br /><pre><code><br />Object File    Library File  TCC Option<br />COT.OBJ        CS.LIB        -mt   ;tiny<br />COS.OBJ        CS.LIB        -ms   ;small<br />COM.OBJ        CM.LIB        -mm   ;medium<br />COC.OBJ        CC.LIB        -mc   ;compact<br />COL.OBJ        CL.LIB        -ml   ;large<br />COH.OBJ        CH.LIB        -mh   ;huge<br /><br /></code></pre><br />note: the character after the C is a number zero. c0t.obj &lt;-- c, zero, t and then .obj and you must know what you're doing with those  object file when you link them together. there's two ways by the way, one is to link those object together or you can do it with TCC option which i believe is easier (save typing).<br /><br /><br />here's an example:<br /><br /><pre><code><br />module.sam-----<br /><br />IDEAL ;tasm mode<br />MODEL SMALL   ;you'll be using -ms &#40;know the memory module you're using&#41;<br />CODESEG<br /><br />public  _winamp<br /><br />proc    _winamp     near<br />        arg   yourArg1&#58;dword, yourArg2&#58;dword<br /><br />        push   bp<br />        mov    bp, sp<br /><br />      ;;;;;code<br /><br />        pop bp<br />        ret<br />endp   _winamp<br /><br />end<br /></code></pre><br /><br /><br /><pre><code><br />caller.c------------<br /><br />#include &lt;stdio.h&gt;<br /><br />extern void winamp&#40;unsigned char *somearg, .....&#41;;<br /><br />void main&#40;&#41;<br />&#123;<br /> ///do something about it<br />&#125;<br /></code></pre><br /><br /><br />now, here's what you do: create an obj file of module with tasm:<br /><br />tasm /ml module.asm     ; and you'll get module.obj next is caller.c<br />tcc -c caller.c         ; -c compile only<br />tcc -ms caller.obj module.obj   ;this will combine caller.obj and module.obj with Model Small (-ms) together and it will produce an exe automatically.<br /><br /><br /><br />and now, on to Microsoft C/C++ and Visual C++<br /><br /><br />Microsoft Visual C++ is a 32bit compiler, therefore, you have to play by the rule (rule that you've been playing all these years...)<br /><br /><br /><pre><code><br />  parameters     struc<br />                  dw      ?  ; pushed BP<br />                  dw      ?  ; return address<br />     ;place argument here<br />  parameters     ends<br /><br /> .model small<br /> .data<br />  ;place data here<br /> .code<br /><br />    public       _procname<br /><br />   _procname      proc near<br /><br />                  PUSH    BP<br />                  mov     bp, sp<br /><br /><br />  ;<br /><br /><br />                  POP     BP<br />                  ret<br /><br />   _procname      endp<br /><br />  end<br /></code></pre><br /><br />the layout above is for Microsoft C/C++ (i didn't test it. but i believe that's how it goes). a note on struct: parameters struct doesn't create exe size. only if you use it. for example:<br /><br /><pre><code><br />parameters struc<br />           dw  ?<br />           dw  ?<br />  arg1     dw  ?<br />parameters ends<br /><br /><br />..somewhere in proc<br /><br /> mov ax, &#91;bp+arg1&#93;   ;much more readable than&#58; &#91;bp+somevalue&#93;<br /></code></pre><br /><br /><br />to make it works with Visual C++, just change the model to: .model flat, stdcall and you're done! (don't forget to create an obj file with masm: masm /c /Cp myasmfile.asm) and use it in VC++ without linking (the Turbo C++ way)<br /><br /><br />that's it. i know i missed alot of details here, but hope you understand... (i'm out of energy now)<br /><br /><br />correction:<br /><br />parms struc<br />           dw ?<br />           dw ?<br />  arg1  dw ?<br />parms ends<br /><br />and use it as this:  mov reg,  &lt;-- correct way<br /><br />my result to masm with turbo c++: failed. there's a big problem with *.obj file. therefore, masm won't work if you interface it with turbo c++ 3.0 (that's the version i'm using) cause Turbo C++ report that your asm *.obj is a bad object file. what i did was compile my asm with ml and then  link it with tcc. it has a big conflict, so i try link16 (of masm) and link both together, but this time, there's  a problem with turbo c++ library, therefore, it halt my system to dealth .<br /><br />anyway, that's it. that's my conclusion based on my observation. (i guess you have to use tasm for turboc++...)</div>
    <div class="meta">Posted on 2001-08-01 12:48:57 by disease_2000</div>
   </div>
   <div class="post" id="post-2690">
    <div class="subject"><a href="#post-2690">interfacing with c/c++: finally solved</a></div>
    <div class="body">Hi Disease, I don't understand the role of the parameters structure. Is it used to access the argument passed by the 32-bit function ? If yes, there is a problem because the argument list starts at , and you can't access with BP because it's 16 bit. <br />If you want my opinion, do it either 16-bit or 32-bit, but don't mix both of them. Good luck !</div>
    <div class="meta">Posted on 2001-08-01 15:13:46 by Dr. Manhattan</div>
   </div>
   <div class="post" id="post-2692">
    <div class="subject"><a href="#post-2692">interfacing with c/c++: finally solved</a></div>
    <div class="body">at the time of writting that, i didn't have enough energy. and about the parms, don't try to use that with TASM. (my research on masm and turboc++ is messed up now. (i forgot to protect the c library (make it readonly) when my system halt, it destroy that file. )<br /><br />thank for  the reply. i'll look forward for that. (i have no problem using struct in this form:<br /><br />parms struc<br /> dw ?<br /> dw ?<br />arg1  ?<br />parms end<br /><br />and then use it this way:<br /><br />mov reg, </div>
    <div class="meta">Posted on 2001-08-01 15:27:16 by disease_2000</div>
   </div>
   <div class="post" id="post-2821">
    <div class="subject"><a href="#post-2821">interfacing with c/c++: finally solved</a></div>
    <div class="body">There's a few things to be aware of if you mix compilers/linkers/assemblers.<br />First of all, never ever mix 16 and 32bit code. Will end up pretty wrong :).<br />Next, there's the name decoration schemes. Figure out what your<br />assembler and compiler wants... remember that almost any flavor <br />of C requires you to an underscore as the first char in the name of<br />the asm proc ... but not in the C proc.<br /><br />Ie,<br />extern &quot;C&quot; int myFunc(void)<br /><br />will be<br /><br />_myFunc PROC<br />_myFunc ENDP<br /><br />in masm.<br />Also, you will need to make sure masm doesn't fux0r up the names.<br />It has a habit of adding @stacksize to all your names. I can't really<br />remember how to turn this off, but it's trivial to find in the masm32<br />docs. I'm convinced it has to do with .model  .</div>
    <div class="meta">Posted on 2001-08-02 21:19:26 by f0dder</div>
   </div>
   <div class="post" id="post-2832">
    <div class="subject"><a href="#post-2832">interfacing with c/c++: finally solved</a></div>
    <div class="body"><div class="quote"><br />unsigned int add(unsigned int input);  // no EXTERN is need<br /></div><br /><br />That's right, but I would add it anyway, just to show that this is<br />not a forward-prototype to code that will appear later in the c file.<br />Also, you will probably *have* to do the extern when compiling .cpp<br />files, since a lot of name mangling is added otherwise.<br /><br />Also, why are you using structs to reference locals? Doesn't tasm<br />have automatic support like masm? It's a while since I used tasm<br />last, but I seem to remember automatic variable support...<br /><br />masm can do 16bit code as well as tasm... masm has the advantage<br />of not being stuck with the OMF format in 32bit mode, but sporting<br />the wonderful coff format... which isn't a m$ invention.<br /><br />the &quot;masm mode&quot; in tasm doesn't mean we have a masm hiding<br />inside tasm. It's only part of the syntax that changes -- not assembler-<br />dependant stuff like model and so on.<br /><br /><br /><div class="quote"><br />TASM doesn't understand the OPTION directive (even when you're in MASM mode - perhaps, future version of TASM will), <br /></div><br /><br />TASM is a discontinued project.<br /><br /><div class="quote"><br />therefore, don't bother. cause every INCLUDE/INCLUDELIB file will be a disaster without the OPTION CASEMAP on. so, for 32bit app - following iczelion's tutorial - you have to use masm compiler. <br /></div><br /><br />Not really. But you need a set of header/library files written for tasm. As fro &quot;option casemap&quot;, have you ever looked at what parameters<br />tasm.exe takes? Perhaps you should investigate the /ml switch...<br /><br /><div class="quote"><br />however, if TASM is your choice and you want to develop your app in 100% TASM, sure you can! just play by the rule (TASM) in an area that needed and get back into MASM mode and do your thing the MASM way and then switch back to IDEAL whenever needed. <br /></div><br /><br />If you want to, why not just code everything in IDEAL mode???<br /><br /><div class="quote"><br />masm obj file doesn't get along with turbo c++'s obj file<br /></div><br /><br />can't see why this is so. Unless of course you're trying to link 16bit<br />OMF with 32bit coff... :). If you get both assemblers to produce OMF,<br />and use 16bit in both, there shouldn't really be any problems. Ok,<br />the OMF format allows for vendor-specific sh!t in the OMF files, but<br />use a decent linker and you will have no problems.<br /><br />Ah well. If you want to use tasm, go ahead. Can't really see why you<br />would want to, though. It's old and unsupported, has a bunch of<br />(crash) bugs, and doesn't support the new instruction sets (and<br />don't tell me about the macros, I know about them).</div>
    <div class="meta">Posted on 2001-08-02 22:16:36 by f0dder</div>
   </div>
   <div class="post" id="post-2833">
    <div class="subject"><a href="#post-2833">interfacing with c/c++: finally solved</a></div>
    <div class="body">Ummm, where did the &quot;guest&quot; post made by disease_2k just go?</div>
    <div class="meta">Posted on 2001-08-02 22:17:27 by f0dder</div>
   </div>
   <div class="post" id="post-2840">
    <div class="subject"><a href="#post-2840">interfacing with c/c++: finally solved</a></div>
    <div class="body"><div class="quote"><br />Ummm, where did the &quot;guest&quot; post made by disease_2k just go? </div><br /><br />he choose to ban himself from the forums and so it shall be</div>
    <div class="meta">Posted on 2001-08-02 22:50:12 by Hiroshimator</div>
   </div>
   <div class="post" id="post-2846">
    <div class="subject"><a href="#post-2846">interfacing with c/c++: finally solved</a></div>
    <div class="body">:/. He had some information in there... though a bit flawed and not<br />all that useful :).</div>
    <div class="meta">Posted on 2001-08-02 23:59:06 by f0dder</div>
   </div>
   <div class="post" id="post-2857">
    <div class="subject"><a href="#post-2857">interfacing with c/c++: finally solved</a></div>
    <div class="body">just to show you what i usually do when i want to use asm code in c :<br /><br />i create a regular masm code :<br /><br />.386<br />.model flat,stdcall<br /><br />.data<br /><br />....<br /><br />.code<br /><br />proc1   proc   uses what i want, param1:dword, param2:dword,....<br /><br />....<br /><br />proc1 endp<br /><br />then i compile with /c /Coff /Gd to put in c call format (no decoration to the name) for example in myproc.obj<br /><br />then in msvc++, i go in the project properties and i add myproc.obj to the link edit box (where there are all the .lib). then at the beginning of the code i put :<br /><br />extern proc1(param1:long,param2:long,....);<br /><br />and it' s all done, you just have to do :<br /><br />proc1(myparam1,myparam2,....);</div>
    <div class="meta">Posted on 2001-08-03 02:56:22 by roy</div>
   </div>
   <div class="post" id="post-2860">
    <div class="subject"><a href="#post-2860">interfacing with c/c++: finally solved</a></div>
    <div class="body">I dont have time to read everything posted in this thread, but i just spent the night learning to write external code for pascal. This tut has a section on how to do it for c and pascal. <a target="_blank" href="http://www.eccentrica.org/Mammon/Text/adam.txt">http://www.eccentrica.org/Mammon/Text/adam.txt</a></div>
    <div class="meta">Posted on 2001-08-03 03:34:27 by ChimpFace9000</div>
   </div>
  </div>
 </body>
</html>