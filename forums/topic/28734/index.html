<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>invoke FindFirstFile and standard output... - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=28734" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=116">Windows</a> &raquo; <a href="../?id=28734">invoke FindFirstFile and standard output...</a></p>
   <div class="post" id="post-203029">
    <div class="subject"><a href="#post-203029">invoke FindFirstFile and standard output...</a></div>
    <div class="body">Hi!, I&#039;m trying to learn win32 assembler with FASM and I have a small problem. <br /><br />This is my small app:<br /><pre><code><br />format PE console 4.0<br />entry start<br /><br />include &#039;%flatpath%\Include\win32w.inc&#039;<br /><br />section &#039;.data&#039; data readable writeable<br />&nbsp; written&nbsp; &nbsp; dd ?<br />&nbsp; search&nbsp; &nbsp;  db &#039;c:\documents and settings\*.*&#039;,0<br />&nbsp; findData&nbsp;  WIN32_FIND_DATA<br />&nbsp; result&nbsp; &nbsp;  db 255 dup(0)<br /><br />section &#039;.code&#039; code readable executable<br />&nbsp; start:<br />&nbsp; &nbsp; &nbsp; &nbsp;  invoke&nbsp; &nbsp; FindFirstFile,search,findData<br />&nbsp; &nbsp; &nbsp; &nbsp;  mov&nbsp; &nbsp; &nbsp;  cl,&#039;a&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp;  mov&nbsp; &nbsp; &nbsp;  ,cl<br />&nbsp; ; -=-=-= OUTPUT --=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=<br />&nbsp; &nbsp; &nbsp; &nbsp;  invoke&nbsp; &nbsp; lstrlen,result<br />&nbsp; &nbsp; &nbsp; &nbsp;  mov&nbsp; &nbsp; &nbsp;  ebx,eax<br />&nbsp; &nbsp; &nbsp; &nbsp;  invoke&nbsp; &nbsp; GetStdHandle,STD_OUTPUT_HANDLE<br />&nbsp; &nbsp; &nbsp; &nbsp;  mov&nbsp; &nbsp; &nbsp;  ecx,eax<br />&nbsp; &nbsp; &nbsp; &nbsp;  invoke&nbsp; &nbsp; WriteFile,ecx,result,ebx,written,0<br />&nbsp; ; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-<br />&nbsp; exit:<br />&nbsp; &nbsp; &nbsp; &nbsp;  invoke ExitProcess,0<br /><br />section &#039;.idata&#039; import data readable writeable<br />&nbsp; library kernel,&#039;KERNEL32.DLL&#039;<br />&nbsp; import&nbsp; kernel,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FindFirstFile,&#039;FindFirstFile&#039;,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GetStdHandle,&#039;GetStdHandle&#039;,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WriteFile,&#039;WriteFile&#039;,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ExitProcess,&#039;ExitProcess&#039;,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lstrlen,&#039;lstrlen&#039;<br /><br /></code></pre><br /><br />The part:<br /><pre><code><br />&nbsp; &nbsp; &nbsp; &nbsp;  mov&nbsp; &nbsp; &nbsp;  cl,&#039;a&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp;  mov&nbsp; &nbsp; &nbsp;  ,cl<br /></code></pre><br />it&#039;s only for tests.<br /><br />When I execute this application in the console the result is an empty line - nothing, but when I remove <br /><pre><code><br />&nbsp;  invoke&nbsp; &nbsp; FindFirstFile,search,findData<br /></code></pre><br />the result is &quot;a&quot;<br /><br />What I need to change to make this work properly? <br />What I&#039;m doing wrong?<br /><br />Maybe it&#039;s another way to write the result to standard output?<br /><br />Thanks...</div>
    <div class="meta">Posted on 2007-09-23 09:17:47 by Kr!z</div>
   </div>
   <div class="post" id="post-203030">
    <div class="subject"><a href="#post-203030">Re: invoke FindFirstFile and standard output...</a></div>
    <div class="body">Problem solved&nbsp;  :lol:<br />Should be &quot;FindFirstFileA&quot; instead of &quot;FindFirstFile&quot;<br /><br />This is simple dir/ls like console application, maybe someone find it usefull. Any suggestion are welcome :) <br /><br /><pre><code><br />format PE console 4.0<br />entry start<br /><br />include &#039;%flatpath%\Include\win32ax.inc&#039;<br /><br />section &#039;.data&#039; data readable writeable<br />&nbsp; search&nbsp; &nbsp;  db &quot;c:\Documents and Settings\*.*&quot;,0<br />&nbsp; CRLF&nbsp; &nbsp; &nbsp;  db 0Dh,0Ah,00h<br />&nbsp; fD&nbsp; &nbsp; &nbsp; &nbsp;  WIN32_FIND_DATA<br />&nbsp; sHandle&nbsp; &nbsp; dd ?<br /><br />section &#039;.code&#039; code readable executable<br />&nbsp; start:<br />&nbsp; &nbsp; &nbsp; &nbsp;  invoke&nbsp;  FindFirstFile,search,fD<br />&nbsp; &nbsp; &nbsp; &nbsp;  cmp&nbsp; &nbsp; &nbsp; eax,INVALID_HANDLE_VALUE<br />&nbsp; &nbsp; &nbsp; &nbsp;  je&nbsp; &nbsp; &nbsp;  exit<br />&nbsp; &nbsp; &nbsp; &nbsp;  mov&nbsp; &nbsp; &nbsp; ,eax<br />&nbsp; &nbsp; &nbsp; @@:<br />&nbsp; &nbsp; &nbsp; &nbsp;  push&nbsp; &nbsp;  fD.cFileName<br />&nbsp; &nbsp; &nbsp; &nbsp;  call&nbsp; &nbsp;  WriteText<br />&nbsp; &nbsp; &nbsp; &nbsp;  push&nbsp; &nbsp;  CRLF<br />&nbsp; &nbsp; &nbsp; &nbsp;  call&nbsp; &nbsp;  WriteText<br />&nbsp; &nbsp; &nbsp; &nbsp;  invoke&nbsp;  FindNextFile,,fD<br />&nbsp; &nbsp; &nbsp; &nbsp;  cmp&nbsp; &nbsp; &nbsp; eax,0<br />&nbsp; &nbsp; &nbsp; &nbsp;  jne&nbsp; &nbsp; &nbsp; @b<br />&nbsp; &nbsp; &nbsp; &nbsp;  invoke&nbsp;  FindClose,<br />&nbsp; exit:<br />&nbsp; &nbsp; &nbsp; &nbsp;  invoke ExitProcess,0<br /><br />;-=-=-=- Write to sdtout -=-=-=-=-=-=-=-=-=-=-=-=-=-=<br />proc WriteText text<br />&nbsp; &nbsp;  local wr dd ?<br />&nbsp; &nbsp; &nbsp; &nbsp;  invoke&nbsp; &nbsp; lstrlen,<br />&nbsp; &nbsp; &nbsp; &nbsp;  mov&nbsp; &nbsp; &nbsp;  ebx,eax<br />&nbsp; &nbsp; &nbsp; &nbsp;  invoke&nbsp;  GetStdHandle,STD_OUTPUT_HANDLE<br />&nbsp; &nbsp; &nbsp; &nbsp;  mov&nbsp; &nbsp; &nbsp;  ecx,eax<br />&nbsp; &nbsp; &nbsp; &nbsp;  invoke&nbsp; &nbsp; WriteFile,ecx,,ebx,addr wr,0<br />&nbsp; &nbsp; &nbsp; &nbsp;  ret<br />endp ; end of WriteText<br /><br />section &#039;.idata&#039; import data readable writeable<br />&nbsp; library kernel,&#039;KERNEL32.DLL&#039;<br /><br />&nbsp; import&nbsp; kernel,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GetStdHandle,&#039;GetStdHandle&#039;,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WriteFile,&#039;WriteFile&#039;,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ExitProcess,&#039;ExitProcess&#039;,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lstrlen,&#039;lstrlen&#039;,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FindFirstFile,&#039;FindFirstFileA&#039;,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FindNextFile,&#039;FindNextFileA&#039;,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FindClose,&#039;FindClose&#039;&nbsp;  <br /></code></pre></div>
    <div class="meta">Posted on 2007-09-23 11:53:36 by Kr!z</div>
   </div>
  </div>
 </body>
</html>