<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>IDirectPlay8Client::Connect crashes - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=16295" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=10">Graphics &amp; Game Development</a> &raquo; <a href="../?id=16295">IDirectPlay8Client::Connect crashes</a></p>
   <div class="post" id="post-126575">
    <div class="subject"><a href="#post-126575">IDirectPlay8Client::Connect crashes</a></div>
    <div class="body">;--------------- Initialized data segment follows -------------------<br />dataseg<br />align 4<br /><br />CLSID_DirectPlay8Client  GUID &lt;0743F1DC6h, 05ABAh, 0429Fh, 08Bh, 0DFh, 0C5h, 04Dh, 003h, 025h, 03Dh, 0C2h&gt;<br />IID_IDirectPlay8Client   GUID &lt;05102DACDh, 0241Bh, 011D3h, 0AEh, 0A7h, 000h, 060h, 097h, 0B0h, 014h, 011h&gt;<br />CLSID_DirectPlay8Address GUID &lt;0934A9523h, 0A3CAh, 04BC5h, 0ADh, 0A0h, 0D6h, 0D9h, 05Dh, 097h, 094h, 021h&gt;<br />IID_IDirectPlay8Address  GUID &lt;083783300h, 04063h, 04C8Ah, 09Dh, 0B3h, 082h, 083h, 00Ah, 07Fh, 0EBh, 031h&gt;<br />CLSID_DP8SP_TCPIP        GUID &lt;0EBFE7BA0h, 0628Dh, 011D2h, 0AEh, 00Fh, 000h, 060h, 097h, 0B0h, 014h, 011h&gt;<br />IPfmtW			 dw &quot;%&quot;,&quot;d&quot;,&quot;.&quot;,&quot;%&quot;,&quot;d&quot;,&quot;.&quot;,&quot;%&quot;,&quot;d&quot;,&quot;.&quot;,&quot;%&quot;,&quot;d&quot;,0<br />key_hostname             dw &quot;h&quot;,&quot;o&quot;,&quot;s&quot;,&quot;t&quot;,&quot;n&quot;,&quot;a&quot;,&quot;m&quot;,&quot;e&quot;,0,0<br />;-------------- Uninitialized data segment follows ------------------<br />udataseg<br />align 4<br />lpDP8			dd ?			;DirectPlay8Server, or DirectPlay8Client<br />ReleaselpDP		dd ?			;pointer to DirectPlay8's Release method<br />Initialize		dd ?			;pointer to DirectPlay8's Initialize method<br />Close			dd ?			;pointer to DirectPlay8's Close method<br />SetServerInfo		dd ?			;pointer to DirectPlay8's SetServerInfo method<br />Host			dd ?			;pointer to DirectPlay8's Host method<br />GetClientInfo		dd ?			;pointer to DirectPlay8's GetClientInfo method<br />DestroyClient		dd ?			;pointer to DirectPlay8's DestroyClient method<br />Connect			dd ?			;pointer to DirectPlay8's Connect method<br />lpDP8Addr		dd ?			;IID_IDirectPlay8Address<br />ReleaseAddr		dd ?			;pointer to DirectPlay8Address' Release method<br />SetSP			dd ?			;pointer to DirectPlay8Address' SetSP method<br />lpDP8Addr2		dd ?			;IID_IDirectPlay8Address<br />ReleaseAddr2		dd ?			;pointer to DirectPlay8Address's Release method<br />SetSP2			dd ?			;pointer to DirectPlay8Address's SetSP method<br />AddComponent		dd ?			;pointer to DirectPlay8Address's AddComponent method<br />IPbufW			db 40 DUP (?)		;buffer for IP<br />appdesc			DPN_APPLICATION_DESC ?<br /><br />;--------------------------------------------------------------<br />;------code segment follows------------------------------------<br /><br />			xor	edi, edi<br />		;--client creation<br />			call	CoCreateInstance, offset CLSID_DirectPlay8Client, edi, CLSCTX_INPROC_SERVER, offset IID_IDirectPlay8Client, offset lpDP8<br />			or	eax, eax<br />			jnz	handle_error<br />		; acquire pointers<br />			mov	eax, <br />			mov	eax, <br />			mov	ecx, <br />			mov	edx, <br />			mov	, ecx<br />			mov	, edx<br />			mov	ecx, <br />			mov	edx, <br />			mov	, ecx<br />			mov	, edx<br />		; start the client<br />			call	, , edi, offset clientmessage, edi<br />			or	eax, eax<br />			jnz	handle_error<br />		; Create DPLay address for the client<br />			call	CoCreateInstance, offset CLSID_DirectPlay8Address, edi, CLSCTX_ALL, offset IID_IDirectPlay8Address, offset lpDP8Addr<br />			or	eax, eax<br />			jnz	handle_error<br />		; Acquire pointers<br />			mov	eax, <br />			mov	eax, <br />			mov	ecx, <br />			mov	edx, <br />			mov	, ecx<br />			mov	, edx<br />		; Set SP to TCPIP<br />			call	, , offset CLSID_DP8SP_TCPIP<br />			or	eax, eax<br />			jnz	handle_error<br />		; Create DPLay address for the server<br />			call	CoCreateInstance, offset CLSID_DirectPlay8Address, edi, CLSCTX_ALL, offset IID_IDirectPlay8Address, offset lpDP8Addr2<br />			or	eax, eax<br />			jnz	handle_error<br />		; Acquire pointers<br />			mov	eax, <br />			mov	eax, <br />			mov	ecx, <br />			mov	edx, <br />			mov	, ecx<br />			mov	, edx<br />			mov	ecx, <br />			mov	, ecx<br />		; Set SP to TCPIP<br />			call	, , offset CLSID_DP8SP_TCPIP<br />			or	eax, eax<br />			jnz	handle_error<br />		; Add IP number<br />			mov	eax, 	;IP in format <br />			mov	ebx, eax<br />			mov	ecx, eax<br />			mov	edx, eax<br />			and	eax, 255<br />			shr	ebx, 8<br />			shr	ecx, 16<br />			shr	edx, 24<br />			and	ebx, 255<br />			and	ecx, 255<br />			call	wsprintfW, offset IPbufW, offset IPfmtW, edx, ecx, ebx, eax ;now we have unicode IP at IPbufW<br />			call	lstrlenW, offset IPbufW ;size<br />			inc	eax                     ;+null<br />			shl	eax, 1                  ;*2 (unicode)<br />			call	, , offset key_hostname, offset IPbufW, eax, DPNA_DATATYPE_STRING<br />			or	eax, eax<br />			jnz	handle_error<br />		;set the appdesc struct<br />			mov	edi, offset appdesc<br />			mov	ecx, (size DPN_APPLICATION_DESC)/4<br />			xor	eax, eax<br />			cld<br />			rep	stosd<br />			xor	edi, edi<br />		;fill GUID_APPLICATION with &quot;P2Pfileshare_001&quot;, dwSize with size DPN_APPLICATION_DESC, and dwFlags with DPNSESSION_CLIENT_SERVER or DPNSESSION_NODPNSVR<br />			mov	, &quot;fP2P&quot;	;GUID_APPLICATION<br />			mov	, size DPN_APPLICATION_DESC<br />			mov	, &quot;seli&quot;	;GUID_APPLICATION+4<br />			mov	, DPNSESSION_CLIENT_SERVER or DPNSESSION_NODPNSVR<br />			mov	, &quot;erah&quot;	;GUID_APPLICATION+8<br />			mov	, &quot;001_&quot;<br />		;connect to host<br />			call	, , offset appdesc, offset lpDP8Addr2, offset lpDP8Addr, edi, edi, edi, edi, edi, edi, DPNCONNECT_SYNC<br />			or	eax, eax<br />			jnz	handle_error<br /><br />;call  crashes!! it doesn't return - causes error c0000005</div>
    <div class="meta">Posted on 2003-12-04 13:21:51 by ti_mo_n</div>
   </div>
  </div>
 </body>
</html>