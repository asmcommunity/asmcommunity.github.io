<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>syntax highlighting in iczedit - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=8580" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=17">Iczelion's Tutorials</a> &raquo; <a href="../?id=8580">syntax highlighting in iczedit</a></p>
   <div class="post" id="post-63002">
    <div class="subject"><a href="#post-63002">syntax highlighting in iczedit</a></div>
    <div class="body">**This is a question about Iczelion's syntax highlighting algo in his Tut 35.  If it needs to be moved to the Main section so be it.**<br /><br /><pre><code><br />		;===================================================<br />		; Get the visible text into buffer<br />		;============================================<br />		lea eax,buffer<br />		mov txtrange.lpstrText,eax<br />		invoke SendMessage,hWnd,EM_GETTEXTRANGE,0,addr txtrange<br />		mov esi,eax		; esi == size of the text	<br />		.if esi&gt;0<br />			mov BufferSize,eax<br />			;============================================<br />			; Search for comments first<br />			;=============================================<br />			push edi<br />			push ebx<br />			lea edi,buffer<br />			mov edx,edi		; used as the reference point<br />			mov ecx,esi<br />			mov al,&quot;;&quot;<br />	ScanMore&#58;<br />			repne scasb<br />			je NextSkip<br />			jmp NoMoreHit<br />	NextSkip&#58;<br />			dec edi<br />			inc ecx<br />			mov pString,edi<br />			mov ebx,edi<br />			sub ebx,edx<br />			add ebx,FirstChar<br />			mov txtrange.chrg.cpMin,ebx<br />			;===================================================<br />			; search the end of line or the end of buffer<br />			;===================================================<br />			push eax<br />			mov al,0Dh<br />			repne scasb<br />			pop eax<br />	HiliteTheComment&#58;<br />			.if ecx&gt;0<br />				mov byte ptr &#91;edi-1&#93;,0<br />			.endif<br />			mov ebx,edi<br />			sub ebx,edx<br />			add ebx,FirstChar<br />			mov txtrange.chrg.cpMax,ebx<br />			pushad<br />			;======================================================<br />			; Now we must search the range for the tabs<br />			;=======================================================<br />			mov edi,pString<br />			mov esi,txtrange.chrg.cpMax<br />			sub esi,txtrange.chrg.cpMin		; esi contains the length of the buffer<br />			mov eax,esi<br />			push edi<br />			.while eax&gt;0<br />				.if byte ptr &#91;edi&#93;==9<br />					mov byte ptr &#91;edi&#93;,0<br />				.endif<br />				inc edi<br />				dec eax<br />			.endw<br />			pop edi<br />			.while esi&gt;0<br />				.if byte ptr &#91;edi&#93;!=0<br />					invoke lstrlen,edi<br />					push eax<br />					mov ecx,edi<br />					lea edx,buffer<br />					sub ecx,edx<br />					add ecx,FirstChar<br />					.if RichEditVersion==3<br />						invoke SendMessage,hWnd,EM_POSFROMCHAR,addr rect,ecx<br />					.else<br />						invoke SendMessage,hWnd,EM_POSFROMCHAR,ecx,0<br />						mov ecx,eax<br />						and ecx,0FFFFh<br />						mov rect.left,ecx<br />						shr eax,16<br />						mov rect.top,eax<br />					.endif<br />					invoke DrawText,hdc,edi,-1,addr rect,0<br />					pop eax<br />					add edi,eax<br />					sub esi,eax<br />				.else<br />					inc edi<br />					dec esi<br />				.endif			<br />			.endw<br />			mov ecx,txtrange.chrg.cpMax<br />			sub ecx,txtrange.chrg.cpMin<br />			invoke RtlZeroMemory,pString,ecx<br />			popad<br />			.if ecx&gt;0<br />				jmp ScanMore<br />			.endif<br />	NoMoreHit&#58;<br />			pop ebx<br />			pop edi<br />			;==================================================<br />			; Now that the comments are out of our way, Get rid of the separators<br />			;=======================================================<br />			mov ecx,BufferSize<br />			lea esi,buffer<br />			.while ecx&gt;0<br />				mov al,byte ptr &#91;esi&#93;<br />				.if al==&quot; &quot; || al==0Dh || al==&quot;/&quot; || al==&quot;,&quot; || al==&quot;|&quot; || al==&quot;+&quot; || al==&quot;-&quot; || al==&quot;*&quot; || al==&quot;&amp;&quot; || al==&quot;&lt;&quot; || al==&quot;&gt;&quot; || al==&quot;=&quot; || al==&quot;&#40;&quot; || al==&quot;&#41;&quot; || al==&quot;&#123;&quot; || al==&quot;&#125;&quot; || al==&quot;&#91;&quot; || al==&quot;&#93;&quot; || al==&quot;^&quot; || al==&quot;&#58;&quot; || al==9<br />					mov byte ptr &#91;esi&#93;,0<br />				.endif<br />				dec ecx<br />				inc esi<br />			.endw<br /><br /></code></pre><br /><br />This is a really odd problem that I'm having with this.  I noticed it only because I happened to have a comment with an ampersand followed with text like &quot;&amp;blahblah&quot;.  What happens is weird.  The ampersand will have an underline colored with the comment color, and as you type more text (even with spaces in between....anything but a tab) the text gets colored but the same text is also printed slightly offset to the left non-colored.<br />(I've attached a zip with a bmp of it which will explain what I'm talking about a bit better.)<br /><br />Above is Iczelion's unedited code.  I've removed all of the separator checks except for the space, end-of-line char, and comma just in case the problem was with something after the comment-finding algo.  It's kind of funky.  You can type &quot;;&quot; followed by multiple ampersands with the following effects:<br />1) first ampersand results in it being underlined with the underline having the comment color and the  ampersand having the default text color.<br />2) second ampersand is default text color and the first is comment color with no underlines<br />3) third ampersand is default text color, second is default text color with comment colored underline, and first ampersand is comment colored with no underline<br />4) fourth is default color as is the third, but the second and first are comment colored with no underlines.<br />....<br />etc<br /><br />I apologize for the long post.  What's so special about the ampersand character that it should cause these quirky problems?  I'm not sure how well I explained the problem but if anyone needs clarification just ask.<br /><br /><br />cheers,<br />will</div>
    <div class="meta">Posted on 2002-10-22 18:54:52 by Will</div>
   </div>
   <div class="post" id="post-63003">
    <div class="subject"><a href="#post-63003">syntax highlighting in iczedit</a></div>
    <div class="body">Previewing lost the attachment.  Here it is.</div>
    <div class="meta">Posted on 2002-10-22 18:55:47 by Will</div>
   </div>
   <div class="post" id="post-64581">
    <div class="subject"><a href="#post-64581">syntax highlighting in iczedit</a></div>
    <div class="body">This is easy to fix.<br />The reason is the DrawText - Api which interprets the &quot;&amp;&quot; char as prefix to underline the following char.<br /><br />int DrawText(<br />  HDC hDC,          // handle to device context<br />  LPCTSTR lpString, // pointer to string to draw<br />  int nCount,       // string length, in characters<br />  LPRECT lpRect,    // pointer to struct with formatting dimensions<br />  UINT uFormat      // text-drawing flags &lt;-- !!!!<br />);<br /><br />--&gt; DT_NOPREFIX Turns off processing of prefix characters. Normally, DrawText interprets the mnemonic-prefix character &amp; as a directive to underscore the character that follows, and the mnemonic-prefix characters &amp;&amp; as a directive to print a single &amp;. By specifying DT_NOPREFIX, this processing is turned off.</div>
    <div class="meta">Posted on 2002-11-04 08:23:56 by Rennsemmel</div>
   </div>
   <div class="post" id="post-64593">
    <div class="subject"><a href="#post-64593">syntax highlighting in iczedit</a></div>
    <div class="body">Thanks.  It's funny though, because I looked at the DrawText api but somehow I completely missed that.</div>
    <div class="meta">Posted on 2002-11-04 10:44:39 by Will</div>
   </div>
  </div>
 </body>
</html>