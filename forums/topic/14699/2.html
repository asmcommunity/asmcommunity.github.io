<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>PE optimizing - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=14699" />
  <link rel="prev" href="../?id=14699&amp;page=1" />  <link rel="next" href="../?id=14699&amp;page=3" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=14699">PE optimizing</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=14699&amp;page=1" style="">&laquo;</a><a href="../?id=14699&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="14699" /><input type="number" name="page" min="1" max="3" step="1" value="2" onchange="this.form.submit();" /><a href="../?id=14699&amp;page=3">&gt;</a><a href="../?id=14699&amp;page=3">&raquo;</a></form>   <div class="post" id="post-135682">
    <div class="subject"><a href="#post-135682">PE optimizing</a></div>
    <div class="body">Cool, nice to see another &quot;pervert&quot; :grin: <br /><br />I've been playing a bit with the minimal pe executable thing, here's my results so far..<br />The smallest one is 300 bytes and fully functional under xp and probably 2k as well.<br />Then there's one that actually calls ExitProcess, that one's 550 bytes using only VC++ and my beloved tool :)<br /><br />They don't work under win9x tho, just tested..<br />Nice work getting it to work under all windows versions, I'm gonna take a good look at your header if you don't mind ;)<br />That'd be nice to make it produce working executables for all windows versions.. Not that I care much about wether or not something is 9x compatible, but it's nice to have the option anyway!</div>
    <div class="meta">Posted on 2004-03-11 22:57:35 by snq</div>
   </div>
   <div class="post" id="post-135720">
    <div class="subject"><a href="#post-135720">PE optimizing</a></div>
    <div class="body">vecna, :P<br /><br />edited :)</div>
    <div class="meta">Posted on 2004-03-12 15:23:29 by Drocon</div>
   </div>
   <div class="post" id="post-135729">
    <div class="subject"><a href="#post-135729">PE optimizing</a></div>
    <div class="body">drocon,<br /><br />fixed ;)<br /><br />ancev</div>
    <div class="meta">Posted on 2004-03-12 20:24:19 by ancev</div>
   </div>
   <div class="post" id="post-135896">
    <div class="subject"><a href="#post-135896">PE optimizing</a></div>
    <div class="body">Hi vecna!<br /><br />I used time ago manual relocations to get the correct virtual<br />address, but this makes tiresome add uninitialized data.<br /><br /><a target="_blank" href="http://mipagina.cantv.net/numator/PEMAC.zip">http://mipagina.cantv.net/numator/PEMAC.zip</a><br /><br />Now I use virtual sections with NASM, that let NASM does all<br />the dirty work:<br /><br /><a target="_blank" href="http://mipagina.cantv.net/numator/NPEMAC.zip">http://mipagina.cantv.net/numator/NPEMAC.zip</a><br /><br />I've used these techniques in great projects without problems.</div>
    <div class="meta">Posted on 2004-03-14 11:55:07 by n u M I T_o r</div>
   </div>
   <div class="post" id="post-136024">
    <div class="subject"><a href="#post-136024">PE optimizing</a></div>
    <div class="body">Well, I'm only a newbie when it comes to the Win32Asm arena. Still, I've tried to put together what I consider my best results ever achieved in<br />PE size optimization. Included in the zip file is the NASM source and a batch file to produce the executable using VC++ linker. Also included are<br />two different EXEs produced from the sources, and a tiny stub.exe. The files were produced and tested on WinXP.<br /><br />The smallest I could achieve on my own was 544 bytes, without tinkering with the PE section, except the stub changing. This is probably<br />because of my lack of the experience required for such a work. Although, I felt proud when the resulting file was so small.<br /><br />Another included EXE is of size 480 bytes, compiled (term used for assmbling + linking, :grin: ) using the same source and batch files. So, what<br />caused the difference in size? A little cheating on my side. I used the linker hack posted in this very thread to remove some of the PE<br />header, thus causing the reduction.<br /><br />What makes me wonder is the work of truly brilliant hackers constantly trying to come up with a better solution. The 276 bytes EXE (by vecna?)<br />is truly a prime target for the most enlightened among us.<br /><br />Let me know what you people think of this work of mine. I know there is much to learn for having become one of you. However, I do expect<br />some help in form of insights, comments and yes, a few links to improve my knowledge. Keep up the good work! :)<br /><br />Regards,<br />AgentX</div>
    <div class="meta">Posted on 2004-03-15 15:28:52 by AgentX</div>
   </div>
   <div class="post" id="post-136092">
    <div class="subject"><a href="#post-136092">Why was the interesting info deleted?!</a></div>
    <div class="body">Where has the very interesting info about the encrypted data after the DOS stub gone?! It was somewhere in this thread before, I can swear. There are even several follow-up posts left in the thread, referencing that info, which aren't deleted!? Did MS send out their hitmen to clean it up, or what? That was some very interesting info! :(</div>
    <div class="meta">Posted on 2004-03-16 07:54:05 by dELTA</div>
   </div>
   <div class="post" id="post-136108">
    <div class="subject"><a href="#post-136108">PE optimizing</a></div>
    <div class="body">Hi  AgentX!<br /><br /><div class="quote"><br />What makes me wonder is the work of truly brilliant hackers<br />constantly trying to come up with a better solution. The 276<br />bytes EXE (by vecna?) is truly a prime target for the most <br />enlightened among us.<br /></div><br /><br />The 276 bytes EXE was written by blaz, from Spain. It was<br />written with a hexadecimal editor.<br /><br /><a target="_blank" href="http://pe.blazlabs.com/276.html">http://pe.blazlabs.com/276.html</a><br /><br />I know that does not run in win9x :(<br /><br />Sure you found it here:<br /><a target="_blank" href="http://mipagina.cantv.net/numetorl869/flatpe.html">http://mipagina.cantv.net/numetorl869/flatpe.html</a><br /><br />I have a 133 bytes EXE that only runs in w9x, but who<br />wrote this exe does not want that I share it.<br /><br /><div class="quote"><br />I do expect some help in form of insights, comments and yes, a <br />few links to improve my knowledge. Keep up the good work! <br /></div><br /><br />You need to know well the pe header structure:<br /><a target="_blank" href="http://spiff.tripnet.se/~iczelion/files/pe1.zip">http://spiff.tripnet.se/~iczelion/files/pe1.zip</a><br /><a target="_blank" href="http://www.msdn.microsoft.com/msdnmag/issues/02/03/PE2/default.aspx">http://www.msdn.microsoft.com/msdnmag/issues/02/03/PE2/default.aspx</a><br /><a target="_blank" href="http://www.msdn.microsoft.com/msdnmag/issues/02/02/PE/default.aspx">http://www.msdn.microsoft.com/msdnmag/issues/02/02/PE/default.aspx</a><br /><br />and some info about the windows loader:<br /><a target="_blank" href="http://msdn.microsoft.com/msdnmag/issues/02/03/Loader/default.aspx">http://msdn.microsoft.com/msdnmag/issues/02/03/Loader/default.aspx</a><br /><br />It seems to me that the best is write your EXE without use<br />linker, using only binary mode with NASM, possibly with FASM,<br />or using a hex editor. <br /><br />Look at the NASM macros that I've passed in the links above.<br />There are a lot of interesting things about the PE file structure.</div>
    <div class="meta">Posted on 2004-03-16 10:20:07 by n u M I T_o r</div>
   </div>
   <div class="post" id="post-136118">
    <div class="subject"><a href="#post-136118">PE optimizing</a></div>
    <div class="body">Hi nuMIT_or!<br /><br />Thanks for the info about the ownership of that tiny file. I was<br />never sure who coded it, anyway. I visited both the pages you<br />posted above about the 276 bytes file.<br /><br />Wow! 133 bytes is really small. Too bad it runs only on 9x, which<br />is officially a dead line of products, now.<br /><br />Thanks again for the M$ links. Of the three you mentioned, only the<br />loader one was new to me, and this is what I was lacking most.<br />I've already visited your site and also that of NAGOA. I truly thank<br />you for the work you've done to bring up such macros.<br /><br />Now, after all these personalized hacks and tricks, all the known<br />and unknown works of brave assembly hackers, there is only one<br />things lacking ...and that is some proper documentation in form of<br />a tutorial. I agree that PE documents are good, but they don't<br />elaborate much on optimization aspects. This is where one of you<br />people can outperform them. So, who's up for a tutorial there? ;)<br /><br />Regards,<br />AgentX</div>
    <div class="meta">Posted on 2004-03-16 12:08:33 by AgentX</div>
   </div>
   <div class="post" id="post-136542">
    <div class="subject"><a href="#post-136542">PE optimizing</a></div>
    <div class="body">Hello everyone,<br />Sometime time ago I disassembled <strong>Blaz's</strong> 276.exe, here it is again (assemble: nasmw -fbin d276.asm -od276.exe):</div>
    <div class="meta">Posted on 2004-03-20 13:36:15 by Poimander</div>
   </div>
   <div class="post" id="post-136567">
    <div class="subject"><a href="#post-136567">PE optimizing</a></div>
    <div class="body">Well, it turns out the BaseRelocation field and the first dword of the Debug field are freely editable in 276, this gives 12 bytes just large enough to store the asciiz string  'Hello World'. Hense the following modified version of 276 is now available:</div>
    <div class="meta">Posted on 2004-03-20 23:23:28 by Poimander</div>
   </div>
   <div class="post" id="post-136596">
    <div class="subject"><a href="#post-136596">PE optimizing</a></div>
    <div class="body">There's an error in the m276.asm source file I just discovered. The four bytes at offset 0b0h should be commented out:<br /><pre><code><br />;BaseRelocation    db 48h, 65h, 6Ch, 6Ch  ;Offset&#58; 0ach<br />;                            db 6Fh, 20h, 57h, 6Fh  ;Offset&#58; 0b0h &lt;---<br />;Debug                  db 72h, 6Ch, 64h, 00h  ;Offset&#58; 0b4h<br /></code></pre><br />I've uploaded the corrected source file here:</div>
    <div class="meta">Posted on 2004-03-21 11:26:25 by Poimander</div>
   </div>
   <div class="post" id="post-137090">
    <div class="subject"><a href="#post-137090">PE optimizing</a></div>
    <div class="body">Presenting 233.exe:</div>
    <div class="meta">Posted on 2004-03-26 20:38:04 by Poimander</div>
   </div>
   <div class="post" id="post-137094">
    <div class="subject"><a href="#post-137094">PE optimizing</a></div>
    <div class="body">Poimander,<br />Nice work, but I get an error when I run your 233.exe (on XP pro)<br /><br />Only part of a ReadProcessMemory or WriteProcessMemory request was completed</div>
    <div class="meta">Posted on 2004-03-26 20:48:18 by snq</div>
   </div>
   <div class="post" id="post-137095">
    <div class="subject"><a href="#post-137095">PE optimizing</a></div>
    <div class="body">Greetings <strong>snq</strong>, As far as I know the program <br />only runs on Win2KSp4. Thanks for testing it on XP. Perhaps <br />some variant of the program may be found that is compatible <br />with XP. Changing the image base may work however. I also<br />tested the program on Win98, and unfortunately it does'nt run<br />on that platform either.</div>
    <div class="meta">Posted on 2004-03-26 21:08:42 by Poimander</div>
   </div>
   <div class="post" id="post-138951">
    <div class="subject"><a href="#post-138951">PE optimizing</a></div>
    <div class="body">Ok, I had to register just because of this thread. About 2 years ago I focused on writing the smallest possible PE files.<br /><br />n u M I T_o r, I'm afraid to say that I don't believe you have a 133 byte PE, that runs in W9X, unless you mess with the loader. W9X is very picky when it comes to alignment. The minimum align is 512.<br /><br />I have been able to make a stable PE that works in every 32-bit Windows environment, and it should also work in DOS. It has a size of <u>552 bytes</u>.<br /><br />Windows NT systems don't have this alignment limitation, hence the EXE files can be made alot smaller. Windows Xp works best so far... I have a XP only EXE that is <u>97 bytes</u>!!<br /><br />Beware, alot of virus scanner go off on these files. (It's not a virus, but use at own risk)<br /><br /><strong>Edit: Just a reminder: I tested this PE on a second system and I got a nasty bluescreen (IRQL_LESS_OR_EQUAL, 0x0000000A). It works fine on my own PC. Must have to do with <br />If anybody knows what is causing this, I'd be interested. Tnx</strong><br /><br /><strong>Edit2: AFAIK Windows XP with SP1 will crash. It seems to have a different loader then the unupdated XP version.</strong><br /><br />Newer attachments will be uploaded as I make progress.<br />Later<br /><br /><br /><strong>pmpch</strong></div>
    <div class="meta">Posted on 2004-04-14 09:56:18 by pmpch</div>
   </div>
   <div class="post" id="post-139164">
    <div class="subject"><a href="#post-139164">PE optimizing</a></div>
    <div class="body">woah, neat stuff pmpch :alright:</div>
    <div class="meta">Posted on 2004-04-16 14:45:54 by Drocon</div>
   </div>
   <div class="post" id="post-139166">
    <div class="subject"><a href="#post-139166">PE optimizing</a></div>
    <div class="body">Sweet :grin: :alright:</div>
    <div class="meta">Posted on 2004-04-16 15:35:04 by Delight</div>
   </div>
   <div class="post" id="post-139239">
    <div class="subject"><a href="#post-139239">PE optimizing</a></div>
    <div class="body"><div class="quote"><br />n u M I T_o r, I'm afraid to say that I don't believe you have a 133<br />byte PE, that runs in W9X, unless you mess with the loader. W9X<br />is very picky when it comes to alignment. The minimum align is<br />512.<br /></div><br /><br />Oh, yes, I was sure that I had a PE file that runed in win9x that<br />had a size of 133 bytes, but really runs in w2k and wxp.<br /><br />But I have a PE file that runs in win9x and has a size of 250 bytes.</div>
    <div class="meta">Posted on 2004-04-17 11:02:18 by n u M I T_o r</div>
   </div>
   <div class="post" id="post-139242">
    <div class="subject"><a href="#post-139242">PE optimizing</a></div>
    <div class="body">Here is the 133 bytes PE file.<br /><br />I did not write this and I don't know who wrote it. So that is anonymous.<br /><br />I don't remember who wrote the win9x 250 bytes PE. I believe that was<br />xezaw, from Spain.<br /><br />These files were written in hexadecimal.<br /><br />I think that is possible to write a full portable small PE.</div>
    <div class="meta">Posted on 2004-04-17 11:15:29 by n u M I T_o r</div>
   </div>
   <div class="post" id="post-139249">
    <div class="subject"><a href="#post-139249">PE optimizing</a></div>
    <div class="body">Very nice! <br /><br />- It works on XP_SP1<br />- It doesn't work on Win98 (as I assumed)<br /><br />The 250 byte PE that works in W9X would really interest me.<br /><br /><br />Edit: Btw, I know whats crashing the 97 byte prog.... gonna fix it soon :grin:</div>
    <div class="meta">Posted on 2004-04-17 11:34:35 by pmpch</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=14699&amp;page=1" style="">&laquo;</a><a href="../?id=14699&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="14699" /><input type="number" name="page" min="1" max="3" step="1" value="2" onchange="this.form.submit();" /><a href="../?id=14699&amp;page=3">&gt;</a><a href="../?id=14699&amp;page=3">&raquo;</a></form>  </div>
 </body>
</html>