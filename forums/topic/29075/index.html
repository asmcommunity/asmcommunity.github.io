<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>dll unpack, GetThreadContext error... solution - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=29075" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=29075">dll unpack, GetThreadContext error... solution</a></p>
   <div class="post" id="post-205423">
    <div class="subject"><a href="#post-205423">dll unpack, GetThreadContext error... solution</a></div>
    <div class="body">Here is a unpacker for PECompact packed dll, but there are some error occur:<br />1?CreateProcess use command line: loaddll.exe *.dll (just like ollydbg)<br />2?While CREATE_PROCESS_DEBUG_EVENT,log the DBEvent.u.CreateProcessInfo.hProcess and DBEvent.u.CreateProcessInfo.hThread<br />3?While LOAD_DLL_DEBUG_EVENT, when load *.dll, SuspendThread DBEvent.u.CreateProcessInfo.hThread, than set breakpoint in OEP,and ResumeThread DBEvent.u.CreateProcessInfo.hThread, while GetThreadContext, Context.regEip always stop in ntdll.KiFastSystemCallRet, can not get dll&#039;s regEip:<br /><div class="quote"><br />ProcessDll proc<br />LOCAL Buffer [64]:byte<br />LOCAL BP1_data,BP2_data,BP3_data,BP4_data:DWORD<br />LOCAL BP1,BP2,BP3,BP4:DWORD<br />LOCAL hProcess:dword<br />LOCAL tempaddr:dword<br />LOCAL dlls_imported,PatchAddr:dword<br />LOCAL szContext[1024]:byte<br />LOCAL TEB,LDR:dword<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; mov flag,0<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke GetTempPath, sizeof TempPath, addr TempPath<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke wsprintf,addr OutBuff,addr Format,addr loaddllPath,addr FilePath&nbsp; ;loaddll.exe 2.dll<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke GetStartupInfo,addr startinfo<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke CreateProcess,NULL,addr OutBuff,NULL,NULL,FALSE,DEBUG_PROCESS+DEBUG_ONLY_THIS_PROCESS ,NULL,addr TempPath,addr startinfo,addr ProcessInfo<br />&nbsp; &nbsp; &nbsp; &nbsp; .while TRUE&nbsp; &nbsp; &nbsp; &nbsp;	<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp; invoke WaitForDebugEvent,addr DBEvent,INFINITE	&nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp; mov dwDebugOperation,DBG_CONTINUE&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp; .if DBEvent.dwDebugEventCode == EXIT_PROCESS_DEBUG_EVENT&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; invoke OutputInfo,CTEXT(&quot;Exit Debug&quot;),0&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; .break <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp;.elseif DBEvent.dwDebugEventCode == CREATE_PROCESS_DEBUG_EVENT <br />	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov edx,DBEvent.u.CreateProcessInfo.hProcess<br />	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov myProcess,edx<br />	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov ecx,DBEvent.u.CreateProcessInfo.hThread<br />	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov myThread,ecx&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp; .elseif DBEvent.dwDebugEventCode == LOAD_DLL_DEBUG_EVENT<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov Context.ContextFlags,CONTEXT_FULL <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke GetThreadContext,myThread,addr Context <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke GetThreadSelectorEntry,myThread,Context.regFs,addr ldte <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov ah,&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shl eax,16<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov ax,<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; assume fs:nothing<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov eax,fs:[18h]<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov eax,<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov eax,DBEvent.u.LoadDll.lpBaseOfDll<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov dwModBase,eax <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .if&nbsp; dwModBase &lt; 60000000h<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke ReadProcessMemory,myProcess,DBEvent.u.LoadDll.lpImageName,addr OutBuff,4,NULL<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov eax,dword ptr OutBuff<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke ReadProcessMemory,myProcess,eax,addr pDllName,256,NULL<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke Unicode2Ansi,addr pDllName,addr outinf<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke lstrcmp,addr outinf,addr FilePath<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .if eax==0<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inc flag<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke wsprintf,addr OutBuff,CTEXT(&quot;LoadDll sucess: handle:%08Xh,base:%08Xh,name:%s&quot;,13,10,0),DBEvent.u.LoadDll.hFile,DBEvent.u.LoadDll.lpBaseOfDll,addr outinf<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke OutputInfo,addr OutBuff,0<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov esi,DBEvent.u.LoadDll.lpBaseOfDll<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov DllBase,esi <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov eax,DBEvent.u.LoadDll.hFile<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov hDll,eax<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .elseif flag==1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov edi,DllBase<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add edi,EntryPiont<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add edi,1<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lea esi,Buffer<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke ReadProcessMemory,myProcess,edi,esi,4,0<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov edi,dword ptr  <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke wsprintf,addr OutBuff,CTEXT(&quot;%s: %.08X&quot;,13,10,0),CTEXT(&quot;Got the address of&nbsp; mov eax,xxxxxxxx &quot;),edi <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke OutputInfo,addr OutBuff,0<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke Searchcode,myProcess,edi,0ffd7h<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .if eax==0<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	invoke MessageBox,0,CTEXT(&quot;Searchcode Error&quot;),0,MB_OK<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	jmp @@exit<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .endif<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov BP1,eax<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke ReadProcessMemory,myProcess,BP1,addr BP1_data,2,0&nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke WriteProcessMemory,myProcess,BP1,CTEXT(0EBh,0FEh),2,0<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke wsprintf,addr OutBuff,CTEXT(&quot;%s: %.08X&quot;,13,10,0),CTEXT(&quot;Set Breakpoint in&nbsp; &#039;CALL EDI&#039; &quot;),BP1 <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke OutputInfo,addr OutBuff,0&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke Searchcode,myProcess,BP1,0FFe0h <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov BP2,eax<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke wsprintf,addr OutBuff,CTEXT(&quot;%s: %.08X&quot;,13,10,0),CTEXT(&quot;Set Breakpoint in &#039;JMP EAX&#039; &quot;),BP2<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke OutputInfo,addr OutBuff,0&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke ReadProcessMemory,myProcess,BP2,addr BP2_data,2,0 <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke WriteProcessMemory,myProcess,BP2,CTEXT(0CCh,00h),2,0&nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _10MB equ 1024*1024*10<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke VirtualAlloc,0,_10MB,MEM_COMMIT,PAGE_READWRITE<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov pNewImports,eax<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke OutputInfo,CTEXT(&quot;Start Unpacking...&quot;,13,10,0),0&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke ResumeThread,myThread&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke Sleep,100&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov esi,pNewImports<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; assume esi:ptr IMAGE_IMPORT_DESCRIPTOR<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov dlls_imported,0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov borland_flag,FALSE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov redirection_flag,FALSE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @loop:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke SuspendThread,myThread <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov Context.ContextFlags,CONTEXT_FULL<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke GetThreadContext,myThread,addr Context <br />;/////////////////////////////////////////////////////////////<br />;Error here, Context.regEip=ntdll.KiFastSystemCallRet always<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov eax,Context.regEip<br />;/////////////////////////////////////////////////////////////<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .if eax==BP1<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	invoke WriteProcessMemory,myProcess,BP1,addr BP1_data,2,0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	mov eax,Context.regEdi <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	mov tempaddr,eax <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	invoke Searchcode,myProcess,eax,5751h<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	add eax,3<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	mov ebx,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	mov BP3,ebx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	invoke ReadProcessMemory,myProcess,BP3,addr BP3_data,2,0 <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	invoke WriteProcessMemory,myProcess,ebx,CTEXT(0EBh,0FEh),2,0 <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	add ebx,6<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	mov BP4,ebx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	invoke ReadProcessMemory,myProcess,BP4,addr BP4_data,2,0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	invoke Searchcode,myProcess,tempaddr,4040h<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	invoke Searchcode,myProcess,tempaddr,8902h<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	add eax,1<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	mov PatchAddr,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	invoke WriteProcessMemory,myProcess,eax,CTEXT(16h),1,0 <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .elseif eax==BP3<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke WriteProcessMemory,myProcess,BP3,addr BP3_data,2,0 <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke WriteProcessMemory,myProcess,BP4,CTEXT(0EBh,0FEh),2,0&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov eax,Context.regEcx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub eax,DllBase<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov .Name1,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov eax, Context.regEdi<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .if borland_flag!=TRUE		&nbsp; &nbsp; &nbsp;	<br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pushad<br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; ReadProcessMemory,myProcess,Context.regEdi,addr Buffer,4,0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .if Buffer!=0 <br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov ebx,PatchAddr&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub ebx,3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke WriteProcessMemory,myProcess,ebx,CTEXT(90h,90h,90h,90h),4,0&nbsp; &nbsp; &nbsp; &nbsp;<br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov borland_flag,TRUE<br />		&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke OutputInfo,CTEXT(&quot;Borland stuff detected - inject code&quot;,13,10,0),0<br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .endif<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; no_borland:<br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; popad<br />	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .endif<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub eax,ImageBase<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov .FirstThunk,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add esi,sizeof IMAGE_IMPORT_DESCRIPTOR<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inc dlls_imported<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .elseif eax==BP4<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	invoke WriteProcessMemory,myProcess,BP4,addr BP4_data,2,0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	invoke WriteProcessMemory,myProcess,BP3,CTEXT(0EBh,0FEh),2,0 <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .elseif eax==BP2 <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke WriteProcessMemory,myProcess,BP2,addr BP2_data,2,0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke wsprintf,addr OutBuff,CTEXT(&quot;Set BreakPoint in %.08X&nbsp; &quot;,13,10,0),BP2 <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke OutputInfo,addr OutBuff,0&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	mov eax,Context.regEax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	invoke wsprintf,addr OutBuff,CTEXT(&quot;%s: %.08X&quot;,13,10,0),CTEXT(13,10,&quot;Find OEP&quot;),eax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	invoke OutputInfo,addr OutBuff,0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	invoke MessageBox,0,addr OutBuff,CTEXT(&quot;Got OEP&quot;),MB_OK<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	jmp @f<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .endif<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke ResumeThread,myThread <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke Sleep,8<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jmp @loop<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;@@:&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call FixIAT <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call NewPEinfo <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .endif <br />@continue:<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; 	&nbsp; &nbsp; &nbsp; &nbsp;.endif&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp;.elseif DBEvent.dwDebugEventCode == EXCEPTION_DEBUG_EVENT <br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp;.endif<br />&nbsp; &nbsp; &nbsp; &nbsp;	&nbsp; &nbsp; &nbsp; &nbsp;invoke ContinueDebugEvent,DBEvent.dwProcessId,DBEvent.dwThreadId,dwDebugOperation <br />&nbsp; &nbsp; &nbsp; &nbsp;.endw&nbsp; <br />@@exit:&nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; invoke CloseHandle,myProcess <br />&nbsp; &nbsp; &nbsp; &nbsp; invoke CloseHandle,ProcessInfo.hThread&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />	ret<br /><br />ProcessDll endp<br /></div><br /></div>
    <div class="meta">Posted on 2008-06-01 18:52:25 by laomms</div>
   </div>
   <div class="post" id="post-205424">
    <div class="subject"><a href="#post-205424">Re: can not read dll moudle baseaddress </a></div>
    <div class="body">GetModuleHandle should do it, though I don&#039;t know if it works on Vista.<br />(<a target="_blank" href="http://msdn.microsoft.com/en-us/library/ms683199(VS.85).aspx">http://msdn.microsoft.com/en-us/library/ms683199(VS.85).aspx</a>)<br /><br />GetModuleHandleEx() is thread-safe, but only works on winxp+<br />(<a target="_blank" href="http://msdn.microsoft.com/en-us/library/ms683200(VS.85).aspx">http://msdn.microsoft.com/en-us/library/ms683200(VS.85).aspx</a>)<br /><br /><br />Though technically a handle != an address, so this might break in future Windows versions.<br />If there&#039;s a better way to do it, I don&#039;t know it.<br /></div>
    <div class="meta">Posted on 2008-06-02 00:57:43 by iblis</div>
   </div>
   <div class="post" id="post-205425">
    <div class="subject"><a href="#post-205425">Re: can not read dll moudle baseaddress </a></div>
    <div class="body">If GetModuleHandle returns an error value instead of a module handle, then that DLL has not yet been loaded into the calling process... use the LoadLibrary or LoadLibraryEx function, and remember that you&#039;re responsible for unloading any DLLs that you loaded.</div>
    <div class="meta">Posted on 2008-06-02 02:08:51 by Homer</div>
   </div>
   <div class="post" id="post-205430">
    <div class="subject"><a href="#post-205430">Re: can not read dll moudle baseaddress </a></div>
    <div class="body">guys, laomms wanted to read from module base of another process but he mistakingly tried to read directly instead of using ReadProcessMemory..<br />I think he deleted his post after finding the &quot;solution...&quot;.</div>
    <div class="meta">Posted on 2008-06-02 09:58:35 by drizz</div>
   </div>
   <div class="post" id="post-205435">
    <div class="subject"><a href="#post-205435">Re: can not read dll moudle baseaddress </a></div>
    <div class="body"><div class="quote"><br />guys, laomms wanted to read from module base of another process but he mistakingly tried to read directly instead of using ReadProcessMemory..<br />I think he deleted his post after finding the &quot;solution...&quot;.<br /></div><br /><br />Pretty lame, but in case someone is searching for the solution to the actual question and comes upon this thread, if you don&#039;t trust GetModuleHandle, you can use the PSAPI to do the trick with GetModuleInformation...<br /><br /><pre><code>invoke GetCurrentProcess<br />mov , eax<br />invoke GetModuleHandle, &quot;MyDll.dll&quot;<br />mov , eax<br />invoke GetModuleInformation, , , offset modinfo, SIZEOF MODULEINFO</code></pre><br /><br />The member lpBaseOfDll will contain the base address of the DLL. You can also use this method with other processes in order to get the base address of their DLLs though you must first obtain a handle using OpenProcess.<br /><br />Note that the process must have PROCESS_QUERY_INFORMATION and PROCESS_VM_READ rights in order to use GetModuleInformation.<br /><br />Donkey</div>
    <div class="meta">Posted on 2008-06-02 23:18:38 by donkey</div>
   </div>
   <div class="post" id="post-205438">
    <div class="subject"><a href="#post-205438">Re: can not read dll moudle baseaddress </a></div>
    <div class="body">Would have to question the motives if the DLL didn&#039;t belong to the local process.<br /></div>
    <div class="meta">Posted on 2008-06-03 05:28:19 by Homer</div>
   </div>
   <div class="post" id="post-205449">
    <div class="subject"><a href="#post-205449">Re: dll unpack, GetThreadContext error</a></div>
    <div class="body">loaddll source<br /><pre><code><br />start: <br />&nbsp; &nbsp; &nbsp; &nbsp; invoke GetModuleHandle,0<br />&nbsp; &nbsp; &nbsp; &nbsp; mov hInstance,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke GetCommandLine<br />&nbsp; &nbsp; &nbsp; &nbsp; mov esi,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; inc esi<br />&nbsp; &nbsp; &nbsp; &nbsp; cmp al, 22h<br />&nbsp; &nbsp; &nbsp; &nbsp; je @next<br />@@:<br />&nbsp; &nbsp; &nbsp; &nbsp; .if al==0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke MessageBox,0,CTEXT(&quot;Missing DLL name&quot;),0,MB_OK<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke ExitProcess,0<br />&nbsp; &nbsp; &nbsp; &nbsp; .endif<br />&nbsp; &nbsp; &nbsp; &nbsp; mov al, byte ptr <br />&nbsp; &nbsp; &nbsp; &nbsp; inc esi<br />&nbsp; &nbsp; &nbsp; &nbsp; cmp al, 22h<br />&nbsp; &nbsp; &nbsp; &nbsp; jnz @b<br />@next:<br />&nbsp; &nbsp; &nbsp; &nbsp; mov al, byte ptr <br />&nbsp; &nbsp; &nbsp; &nbsp; inc esi<br />&nbsp; &nbsp; &nbsp; &nbsp; cmp al, 20h<br />&nbsp; &nbsp; &nbsp; &nbsp; jnz @load<br />@@:<br />&nbsp; &nbsp; &nbsp; &nbsp; mov al, byte ptr <br />&nbsp; &nbsp; &nbsp; &nbsp; inc esi<br />&nbsp; &nbsp; &nbsp; &nbsp; cmp al, 20h<br />&nbsp; &nbsp; &nbsp; &nbsp; je @b<br />@load:<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke LoadLibraryEx,esi,NULL,DONT_RESOLVE_DLL_REFERENCES&nbsp; &nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; .if eax==0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke MessageBox,0,CTEXT(&quot;Unable to load DLL&quot;),0,MB_OK<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke ExitProcess,0<br />&nbsp; &nbsp; &nbsp; &nbsp; .endif<br />&nbsp; &nbsp; &nbsp; &nbsp; mov DllBase,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke ImageNtHeader,DllBase<br />&nbsp; &nbsp; &nbsp; &nbsp; mov edi,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; assume edi:ptr IMAGE_NT_HEADERS<br />&nbsp; &nbsp; &nbsp; &nbsp; mov eax,.OptionalHeader.AddressOfEntryPoint<br />&nbsp; &nbsp; &nbsp; &nbsp; add eax,DllBase<br />&nbsp; &nbsp; &nbsp; &nbsp; mov EP,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; mov ecx,.OptionalHeader.SizeOfImage<br />&nbsp; &nbsp; &nbsp; &nbsp; mov SizeOfImage,ecx<br />&nbsp; &nbsp; &nbsp; &nbsp; mov edi,DllBase&nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; mov esi,EP<br />&nbsp; &nbsp; &nbsp; &nbsp; movzx edx, byte ptr <br />&nbsp; &nbsp; &nbsp; &nbsp; mov byte ptr ,0CCh<br />&nbsp; &nbsp; &nbsp; &nbsp; call EP<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke	ExitProcess,NULL<br />&nbsp; &nbsp; &nbsp; &nbsp; <br />end start <br /></code></pre></div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=2586" target="_blank">loaddll.zip</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2008-06-04 17:57:28 by laomms</div>
   </div>
   <div class="post" id="post-205473">
    <div class="subject"><a href="#post-205473">Re: dll unpack, GetThreadContext error... solution</a></div>
    <div class="body">I think I have found the solution.<br /><br /></div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=2591" target="_blank">dllunpack.zip</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2008-06-09 00:31:01 by laomms</div>
   </div>
   <div class="post" id="post-205476">
    <div class="subject"><a href="#post-205476">Re: dll unpack, GetThreadContext error... solution</a></div>
    <div class="body">What was the problem, then? Missing SeDebugPrivilege?<br /><br />Iirc PECompact stopped turning that off in recent versions, because it would give compatibility programs with... hm, I think it was some printer or twain drivers, whatever.<br /><br />I hope you aren&#039;t unpacking for nefarious deeds...</div>
    <div class="meta">Posted on 2008-06-09 17:17:12 by f0dder</div>
   </div>
  </div>
 </body>
</html>