<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>ole automation in asm??? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=3812" />
  <link rel="prev" href="../?id=3812&amp;page=1" />   </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=116">Windows</a> &raquo; <a href="../?id=3812">ole automation in asm???</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=3812&amp;page=1" style="">&laquo;</a><a href="../?id=3812&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="3812" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>   <div class="post" id="post-26422">
    <div class="subject"><a href="#post-26422">ole automation in asm???</a></div>
    <div class="body">acab,<br /><br />where did you get your VARIANTARG struct from?<br /><br />When I look in my definition I see<br /><br />1. VARIANTARG is defined as:<br /><br />VARIANTARG typedef VARIANT<br /><br />2. VARIANT is defined as<br /><br /><pre><code><br />VARIANT struct <br />vt	 VARTYPE	?                  ;VARTYPE is type WORD<br />wReserved1	 WORD	?<br />wReserved2	 WORD	?<br />wReserved3	 WORD	?<br />Union<br />lVal	SDWORD	?	; VT_I4<br />bVal	BYTE	?	; VT_UI1<br />...<br />ends<br />VARIANT ends<br /><br /></code></pre><br /><br />Your definition differs from that. Are you sure yours is correct?<br /><br />japheth</div>
    <div class="meta">Posted on 2002-02-28 10:48:26 by japheth</div>
   </div>
   <div class="post" id="post-26429">
    <div class="subject"><a href="#post-26429">ole automation in asm???</a></div>
    <div class="body"><div class="quote">where did you get your VARIANTARG struct from?</div><br />I felt like the includes could be wrong, that's why I've posted them together with the code.<br />However I've taken the struct def from a borland cpp include file...<br /><strong>except I've copied the WRONG LINES</strong><br />I feel quite an <strong>idiot</strong>, sorry :( and thanks for your patience!!!<br /><br />acab<br /><br />P.S.:I've fixed the variantarg definition but I still can't set properties. I always get 80020009 = Exception occurred.<br />Is there somethin else to fix?!<br /><br />P.P.S.: Ok, ok, I'm even more stupid...<br />Please forget the pevious line I just used the ID of a ReadOnly property.<br />Now EVERYTHING works perfectly thanx to all you people who patiently replyed to my silly posts...<br /><strong>THANKS EVERYONE</strong><br /><br />Just last (I promise) little question: how do I get an interface vtable from a com server (exe or dll)?<br />Thanks again,<br />acab</div>
    <div class="meta">Posted on 2002-02-28 11:03:56 by acab</div>
   </div>
   <div class="post" id="post-26523">
    <div class="subject"><a href="#post-26523">ole automation in asm???</a></div>
    <div class="body">Ahh, VB? I've got that (versions 3 thru 6), so if the .exe is small enough, you can send that along.<br /><br />But let me show you how I would find a vtable for a new class. I'm going to make a exe server project in VB. The only code I wrote was in the supplied class using the Add Procedure menu:<br /><br /><pre><code><br />Option Explicit<br /><br />Public Sub Sub1&#40;&#41;<br /><br />End Sub<br /><br />Public Property Get SomeProperty&#40;&#41; As Long<br /><br />End Property<br /><br />Public Property Let SomeProperty&#40;ByVal vNewValue As Long&#41;<br /><br />End Property<br /><br />Public Function Function1&#40;&#41;<br /><br />End Function<br /></code></pre><br /><br />Pretty simple for a sample. Now, after I compile it (which also registers it), I open OLE View and scan for Project1. Complete disaster. OLE View has always been buggy, and you are lucky when it works.<br /><br />So I move on to Tlb2Inc.exe, a utility written by  Maurice MONTGENIE. It reads type libs, and translated them into MASM .inc files. It's WONDERFUL, though I'm not so sure it got the method names correct this time (but it usually does, so it's worth a try).<br /><br />Here's what it told me about Project1:<br /><pre><code><br />;-===========================================================================-<br />;<br />; Generated .INC file &#40;by Tlb2Inc v1.2.3 - Copyright &#40;c&#41; 2001 Maurice MONTGENIE&#41;<br />;<br />; TypeLib filename&#58; Project1.exe<br />;<br />;-===========================================================================-<br /><br />IFNDEF _Project1_INC_<br />_Project1_INC_ EQU 1<br /><br />;Library &#58; Project1<br />;~~~~~~~~~~~~~~~~~~<br />;&#123;CB61A1D9-2C99-11D6-A324-0050BA5A9F26&#125;<br />sLIBID_Project1 TEXTEQU &lt;&#123;0CB61A1D9H, 02C99H, 011D6H, \<br />                                            &#123;0A3H, 024H, 000H, 050H, 0BAH, 05AH, 09FH, 026H&#125;&#125;&gt;<br /><br />;CoClass &#58; Class1<br />;~~~~~~~~~~~~~~<br />;&#123;CB61A1DB-2C99-11D6-A324-0050BA5A9F26&#125;<br />sCLSID_Class1 TEXTEQU &lt;&#123;0CB61A1DBH, 02C99H, 011D6H,  \<br />                                          &#123;0A3H, 024H, 000H, 050H, 0BAH, 05AH, 09FH, 026H&#125;&#125;&gt;<br /><br />;DispInterface &#58; _Class1<br />;~~~~~~~~~~~~~~~~~~~<br />;&#123;CB61A1DA-2C99-11D6-A324-0050BA5A9F26&#125;<br />sIID__Class1 TEXTEQU &lt;&#123;0CB61A1DAH, 02C99H, 011D6H,  \<br />                                        &#123;0A3H, 024H, 000H, 050H, 0BAH, 05AH, 09FH, 026H&#125;&#125;&gt;<br /><br />_Class1_Sub1Proto typedef proto _Class1_Sub1Proto &#58;DWORD<br />_Class1_get_SomePropertyProto typedef proto _Class1_get_SomePropertyProto &#58;DWORD,&#58;DWORD<br />_Class1_put_SomePropertyProto typedef proto _Class1_put_SomePropertyProto &#58;DWORD,&#58;SDWORD<br />_Class1_Function1Proto typedef proto _Class1_Function1Proto &#58;DWORD,&#58;DWORD<br /><br />_Class1_Sub1Val typedef ptr _Class1_Sub1Proto<br />_Class1_get_SomePropertyVal typedef ptr _Class1_get_SomePropertyProto<br />_Class1_put_SomePropertyVal typedef ptr _Class1_put_SomePropertyProto<br />_Class1_Function1Val typedef ptr _Class1_Function1Proto<br /><br />  _vt_Class1 MACRO CastName&#58;REQ<br />  ; IDispatch methods<br />  _vtIDispatch CastName<br />  ; _Class1 methods<br />  &amp;CastName&amp;_Sub1 _Class1_Sub1Val ?<br />  &amp;CastName&amp;_get_SomeProperty _Class1_get_SomePropertyVal ?<br />  &amp;CastName&amp;_put_SomeProperty _Class1_put_SomePropertyVal ?<br />  &amp;CastName&amp;_Function1 _Class1_Function1Val ?<br /><br />ENDM<br /><br />_Class1 STRUCT<br />  _vt_Class1 _Class1<br />_Class1 ENDS<br /><br />ENDIF<br /></code></pre><br /><br />Cool, huh? Almost makes you wanna use MASM over TASM, huh?  &lt;wink&gt;<br /><br />You can get this handy tool at <br /><a target="_blank" href="http://www.maguyane.net/com4me/win32asm/fichiers/tlb2inc_v123.zip">COM4ME</a></div>
    <div class="meta">Posted on 2002-02-28 22:09:31 by Ernie</div>
   </div>
   <div class="post" id="post-26651">
    <div class="subject"><a href="#post-26651">ole automation in asm???</a></div>
    <div class="body">Hi Ernie,<br />I managed at last to write a fully functional ole client in (t)asm.<br />Yesterday, after all the strictly-ole-related issues were fixed, I felt in troubles again with string arguments. I needed to deeply reverse a pack of code to fix the bug. At last I discovered (my win32.hlp says nothing about this) that a Unicode string need to be preceded by a dword that specifies its length in bytes.<br />Except for this I found out that com programming is quite easy once you learn how it works. It's just little documented :(.<br />Just one more question. I downloaded Tlb2inc: it's great! It works perfectly also determining ID's (oleview scrambles them around).<br />What I still can't figure out is why some entries inside the vtable are zeroed.<br />For example, in my case, I found out that the entry that should correspond to IApplication.Quit method is just an empty dword. So I used IDispatch::Invoke and I traced the code for a while just to reach the true function entrypoint. Then I've searched for a corresponding entry inside the vtable but I got no result.<br />Is it possible that some methods are implemented only through IDispatch and not via the vtablr?<br /><br />Thanx a lot for all your help,<br />acab</div>
    <div class="meta">Posted on 2002-03-01 14:44:45 by acab</div>
   </div>
   <div class="post" id="post-26659">
    <div class="subject"><a href="#post-26659">ole automation in asm???</a></div>
    <div class="body"><div class="quote">What I still can't figure out is why some entries inside the vtable are zeroed. </div><br /><br />Where are these values? Are you tracing into the object you requested?<br /><br />While this is OK for debugging, it's strictly a violation of the COM standard, as clients are permitted to do anything in there they want, and you're not supposed to peek. <br /><br />But it does sound quite odd to me, I could not explain it.<br /><br /><div class="quote">Is it possible that some methods are implemented only through IDispatch and not via the vtablr?</div> <br /><br />An interface with a vtable entry for every method is called a dual interface, it gives you the best of both worlds, IDispatch for late binding clients (mostly script driven code) and a vtable for early binding for compiled type library code (such as VB or VC).<br /><br />However, that is just one way to do it. A dispinterface has no vtable for the methods, it just has the 7 IDispatch methods.<br /><br />Now for some methods having a vtable, and some not, I don't think such an interface is legal. Perhaps if a dual interface is inherited by a dispinterface it might have some but not all methods, but I've never seen that, nor do I have a guess how to define it in IDL (interface definition language, the interface language of COM).<br /><br />If you get an answer on your own, please post it back. I'm curious to see what this is.<br /><br /><br /><br /><br />And also, congratulations on your first TASM client. I believe you are the first one to achieve that.</div>
    <div class="meta">Posted on 2002-03-01 17:27:00 by Ernie</div>
   </div>
   <div class="post" id="post-26660">
    <div class="subject"><a href="#post-26660">ole automation in asm???</a></div>
    <div class="body"><div class="quote"><br />Platform SDK: COM <br /><br />Dual Interfaces<br />OLE Automation enables an object to expose a set of methods in two ways: via the IDispatch interface, and through direct OLE VTable binding. IDispatch is used by most tools available today, and offers support for late binding to properties and methods. VTable binding offers much higher performance because this method is called directly instead of through IDispatch::Invoke. IDispatch offers late bound support, where direct VTable binding offers a significant performance gain; both techniques are valuable and important in different scenarios. <strong>By labeling an interface as dual in the type library, an OLE Automation interface can be used either via IDispatch, or it can be bound to directly. Containers can thus choose the most appropriate technique.</strong> Support for dual interfaces is strongly recommended for both controls and containers. <br /><br /></div><br /><br />From this I myself conclude that it would be considered 'illegal' for an OLE Automation Object to NOT support all functions via vtable that it supports via IDispatch, since a COM object has no way of telling a client that it can not use direct VTable binding.</div>
    <div class="meta">Posted on 2002-03-01 17:55:12 by Hiroshimator</div>
   </div>
   <div class="post" id="post-26899">
    <div class="subject"><a href="#post-26899">ole automation in asm???</a></div>
    <div class="body">This is the vtable struct for IApplication reported by Tlb2Inc for IApplication interface:<br /><pre><code><br />_vtIApplication MACRO CastName&#58;REQ<br />; IDispatch methods<br />_vtIDispatch CastName<br />; IApplication methods<br />CastName&amp;_Quit IApplication_QuitVal ? ; &lt;--- This is the method I need to call<br />&amp;CastName&amp;_PrinterSystem IApplication_PrinterSystemVal ?<br />&amp;CastName&amp;_Resize IApplication_ResizeVal ?<br />&amp;CastName&amp;_Move IApplication_MoveVal ?<br />&amp;CastName&amp;_ShowHelp IApplication_ShowHelpVal ?<br />&amp;CastName&amp;_GetLastError IApplication_GetLastErrorVal ?<br />&amp;CastName&amp;_ErrorMessage IApplication_ErrorMessageVal ?<br /></code></pre><br /><br />And this is the actual vtable returned by cocreateinstance and dumped from the debugger:<br /><pre><code><br />1b ee 34 65  4d 4c 34 65  53 4c 34 65  f0 22 b9 7e<br />0a 23 b9 7f  20 2d b9 7f  cb 52 34 65  00 00 00 00 &lt;---<br />c8 6b 34 65  40 67 34 65  ...........  ...........<br /></code></pre><br /><br />As you can see the first seven entries (IUnknown+IDispatch) are ok.<br />The 8th entry, that should point to IApplication.Quit is zeroed.<br />Can you explain this?<br /><br />acab</div>
    <div class="meta">Posted on 2002-03-03 07:27:59 by acab</div>
   </div>
   <div class="post" id="post-27125">
    <div class="subject"><a href="#post-27125">ole automation in asm???</a></div>
    <div class="body">It is odd but possibly its not &quot;illegal&quot;. Every function is described by a FUNCDESC structure, and in that structure there is member funckind with possible values:<br /><br /><pre><code><br /><br />So theoretically you can decide for every function if it can be called via vtable, dispatch or both<br /><br /><br />I think it must be possible to set these flags by IDL/ODL, but currently I have no doc available.</div>
    <div class="meta">Posted on 2002-03-04 07:24:41 by japheth</div>
   </div>
   <div class="post" id="post-27239">
    <div class="subject"><a href="#post-27239">ole automation in asm???</a></div>
    <div class="body">I'd still need to peek at the program, or at least the typelib for the program.<br /><br />Do you have a resource editor that can tear the typelib out of the resource and just post/email me that?</div>
    <div class="meta">Posted on 2002-03-04 19:23:43 by Ernie</div>
   </div>
   <div class="post" id="post-27267">
    <div class="subject"><a href="#post-27267">ole automation in asm???</a></div>
    <div class="body">Hi Ernie,<br />you have mail.<br /><br />Phanx<br />acab</div>
    <div class="meta">Posted on 2002-03-05 04:51:57 by acab</div>
   </div>
   <div class="post" id="post-27433">
    <div class="subject"><a href="#post-27433">ole automation in asm???</a></div>
    <div class="body">I got it, thanks. Gimmy a day or two to digest it (OLE view doesn't like it).</div>
    <div class="meta">Posted on 2002-03-05 23:10:42 by Ernie</div>
   </div>
   <div class="post" id="post-27466">
    <div class="subject"><a href="#post-27466">ole automation in asm???</a></div>
    <div class="body">thanx Ernie</div>
    <div class="meta">Posted on 2002-03-06 05:03:01 by acab</div>
   </div>
   <div class="post" id="post-109249">
    <div class="subject"><a href="#post-109249">Changes I made to Beaster's Wrapper proc</a></div>
    <div class="body">Hope ya don't mind - had some minor glitches implementing this...<br />My DISPPARAMS struct shows that dwType should have been a WORD size.<br />Aside from that it's now using COINVOKE, and I fixed a problem with one of the error checks ... Hopefully someone else will find this useful.<br /><pre><code><br /><br />ComCall	PROC	wType&#58;WORD, lpvResult&#58;DWORD, hObject&#58;DWORD, lpszName&#58;DWORD, dwArgs&#58;DWORD, lpxArgs&#58;PTR<br />LOCAL	lpWide&#58;DWORD, idProp&#58;DWORD, lpxParams&#58;PTR, dwPut&#58;DWORD<br /><br />	sub	esp, MAX_PATH<br />	mov	lpWide, esp<br />	sub	esp, sizeof DISPPARAMS<br />	mov	lpxParams, esp<br /><br />	mov	eax, hObject<br />	test	eax, eax<br />	je	auwParam<br /><br /><br />;----------------- convert name to unicode<br />	invoke	MultiByteToWideChar,CP_ACP,MB_PRECOMPOSED,lpszName,-1,lpWide,MAX_PATH<br />	.if eax==0<br />	   jmp auwError<br />            .endif<br />;----------------- get id for the name<br />	coinvoke hObject, IDispatch,GetIDsOfNames, addr IID_NULL, addr lpWide, 1, LOCALE_USER_DEFAULT, addr idProp<br />	.if !SUCCESS<br />    	   jmp	auwExit<br />            .endif<br /><br />;----------------- fill param struc<br />	xor	edx, edx<br />	mov	ebx, lpxArgs<br />	mov	eax, lpxParams<br />	mov	ecx, dwArgs<br />	mov	&#91;eax.DISPPARAMS.cArgs&#93;, cx<br />	mov	&#91;eax.DISPPARAMS.rgvarg&#93;, ebx<br />	mov	&#91;eax.DISPPARAMS.cNamedArgs&#93;, dx<br />	mov	&#91;eax.DISPPARAMS.rgdispidNamedArgs&#93;, edx<br />	test	wType, DISPATCH_PROPERTYPUT<br />	je	auwInvoke<br /><br />	lea	ecx, dwPut<br />	mov	dwPut, DISPID_PROPERTYPUT<br />	mov	&#91;eax.DISPPARAMS.cNamedArgs&#93;, 1<br />	mov	&#91;eax.DISPPARAMS.rgdispidNamedArgs&#93;, ecx<br /><br />;----------------- invoke object<br />auwInvoke&#58;<br />  	xor	eax, eax<br />	coinvoke hObject, IDispatch,Invoke,idProp,addr IID_NULL,LOCALE_USER_DEFAULT,wType,lpxParams,lpvResult,0,0<br />	jmp auwExit<br />                    <br /><br />;----------------- exit cases<br /><br />auwParam&#58;	mov	eax, E_INVALIDARG<br />	jmp	auwExit<br /><br />auwError&#58;	call	GetLastError<br />auwExit&#58;	add	esp, sizeof DISPPARAMS<br />	            add	esp, MAX_PATH<br />	            ret<br /></code></pre><br /><br />ComCall	ENDP</div>
    <div class="meta">Posted on 2003-07-04 12:19:34 by Homer</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=3812&amp;page=1" style="">&laquo;</a><a href="../?id=3812&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="3812" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>  </div>
 </body>
</html>