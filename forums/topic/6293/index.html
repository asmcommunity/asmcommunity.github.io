<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>SnapShot Process on NT and 98 - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=6293" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=6293">SnapShot Process on NT and 98</a></p>
   <div class="post" id="post-45273">
    <div class="subject"><a href="#post-45273">SnapShot Process on NT and 98</a></div>
    <div class="body">yo all members, i'm a french newbie programmers and it's my second question on this board. So :<br />i want to find all process which run on windows like rundll32.exe, mstask.exe, explorer.exe, smss.exe, etc...<br />i success on win98 but not on win NT  and win NT is most important for me :)<br />So, i paste my code and if someone can help me, it will be very brilliant<br />i put too a source in c++ to help you to understand<br />PS: i use psapi.dll for the process on NT<br /><br /><pre><code><br />.386<br />.MODEL Flat, STDCALL<br />option casemap&#58;none<br /><br />; Prototype de WinMain &#40;4 arguments&#41;<br />WinMain PROTO &#58;DWORD, &#58;DWORD, &#58;DWORD, &#58;DWORD <br />InsertColumn PROTO<br />InsertItem PROTO &#58;DWORD, &#58;DWORD<br />GetProcess PROTO<br />GetProcessNT PROTO &#58;DWORD<br />GetProcess98 PROTO<br /><br /><br />;____________________Inclusion des biblioth?ques_______________________<br /><br />include		\masm32\include\windows.inc<br />include		\masm32\include\kernel32.inc<br />include		\masm32\include\user32.inc<br />include		\masm32\include\gdi32.inc<br />include		\masm32\include\comctl32.inc<br /><br />includelib	\masm32\lib\kernel32.lib<br />includelib	\masm32\lib\user32.lib<br />includelib	\masm32\lib\gdi32.lib<br />includelib	\masm32\lib\comctl32.lib<br /><br />;____________________D?claration des variables initialis?es____________<br /><br />.DATA<br /><br />ClassName		db	&quot;WndClass&quot;, 0<br />WindowName		db	&quot;Get Process List&quot;, 0<br />ListviewClass		db	&quot;SysListView32&quot;, 0<br />szProcess		db	&quot;Process&quot;, 0<br />szProcessID		db	&quot;ProcessID&quot;, 0<br />szLibName		db	&quot;psapi.dll&quot;, 0<br />szEnumProcesses		db	&quot;EnumProcesses&quot;, 0<br />EnumProcesses		dd	0<br />szGetModuleFileNameEx	db	&quot;GetModuleFileNameEx&quot;, 0<br />GetModuleFileNameEx	dd	0<br />szCaptionError		db	&quot;Working Only On NT Station&quot;, 0<br />szTitleError		db	&quot;GetProcessList&quot;, 0<br />Format 			db	&quot;%d&quot;, 0<br /><br />lpidProcess		dd	1024 dup&#40;0&#41;<br /><br />;___________________D?claration des donn?es non-initialis?es___________<br /><br />.DATA?<br /><br />hInstance		HINSTANCE	?<br />CommandLine		LPSTR		?<br />hList			HWND		?<br />hDLL			HWND		?<br />cbNeeded		dd		?<br />testtest			db	128 dup&#40;?&#41;<br /><br /><br />;___________________D?claration des constantes et boutons______________<br /><br />.CONST<br /><br />IDC_LIST	equ		1000<br /><br />;___________________________Code source________________________________<br /><br />.CODE<br /><br />start&#58;<br />	invoke	GetModuleHandle, NULL<br />	mov	hInstance, eax<br />	invoke	GetCommandLine<br />	mov	CommandLine, eax<br />	invoke	WinMain, hInstance, NULL, CommandLine, SW_SHOWDEFAULT<br />	invoke 	ExitProcess, NULL<br />	call	InitCommonControls<br />	<br />WinMain	Proc	hInst&#58;HINSTANCE, hPrevInst&#58;HINSTANCE, lpCmdLine&#58;LPSTR, CmdShow&#58;DWORD<br /><br />	; d?claration des<br />	; variables locales<br />	<br />	LOCAL wc&#58;WNDCLASSEX<br />	LOCAL msg&#58;MSG<br />	LOCAL hwnd&#58;HWND<br />	<br />		; initialisation des membres<br />		; de la structure de la fen?tre<br />		<br />	mov	wc.cbSize, SIZEOF WNDCLASSEX<br />	mov	wc.style, CS_HREDRAW or CS_VREDRAW<br />	mov	wc.lpfnWndProc, OFFSET WndProc<br />	mov	wc.cbClsExtra, NULL<br />	mov	wc.cbWndExtra, NULL<br />	push	hInstance<br />	pop	wc.hInstance<br />	invoke	LoadIcon, NULL, IDI_APPLICATION<br />	mov	wc.hIcon, eax<br />	mov	wc.hIconSm, eax<br />	invoke	LoadCursor, NULL, IDC_ARROW<br />	mov	wc.hCursor, eax<br />	mov	wc.hbrBackground, COLOR_WINDOW+1<br />	mov	wc.lpszMenuName, NULL<br />	mov	wc.lpszClassName, OFFSET ClassName<br />	<br />	; enregistrement de la classe fen?tre<br />	<br />	invoke	RegisterClassEx, ADDR wc<br />	<br />	; cr?ation de la fen?tre<br />	<br />	invoke CreateWindowEx,	WS_EX_CLIENTEDGE,<br />				ADDR ClassName,<br />				ADDR WindowName,<br />				WS_OVERLAPPEDWINDOW,<br />				300,<br />				300,<br />				400,<br />				300,<br />				NULL,<br />				NULL,<br />				hInst,<br />				NULL<br />				<br />	mov	hwnd, eax	; r?cup?ration de l'handle<br />				; de la fen?tre<br />	<br />	<br />	invoke	ShowWindow, hwnd, CmdShow<br />	invoke	UpdateWindow, hwnd<br />	<br />	.WHILE TRUE<br />		invoke	GetMessage, ADDR msg, hwnd, 0, 0<br />		.BREAK .IF &#40;!eax&#41;<br />		invoke TranslateMessage, ADDR msg<br />		invoke DispatchMessage, ADDR msg<br />	.ENDW<br /><br />	mov	eax, msg.wParam<br />	ret<br /><br />WinMain endp<br /><br />WndProc proc	hWnd&#58;HWND, uMsg&#58;UINT, wParam&#58;WPARAM, lParam&#58;LPARAM<br />	<br />	<br />	.IF	uMsg == WM_CLOSE<br />		<br />			invoke	PostQuitMessage, 0<br />			<br />	.ELSEIF uMsg == WM_CREATE<br />	<br />			invoke	CreateWindowEx, NULL, ADDR ListviewClass, NULL, WS_VISIBLE+WS_CHILD+LVS_REPORT,<br />						0, 0, 0, 0, hWnd, IDC_LIST, hInstance, NULL<br />						<br />			mov	hList, eax<br />			<br />			call	InsertColumn<br />			call	GetProcess			<br />	<br />	.ELSEIF	uMsg == WM_SIZE<br />	<br />			mov	eax, lParam<br />			mov	edx, eax<br />			shr	edx, 16<br />			and	edx, 0FFFFh<br />			<br />			invoke	MoveWindow, hList, 0, 0, eax, edx, TRUE<br />	<br />	.ELSE	<br />			invoke	DefWindowProc, hWnd, uMsg, wParam, lParam<br />			ret<br />	.ENDIF<br />	<br />	xor eax, eax<br />	ret<br /><br />WndProc endp<br /><br />InsertColumn	proc<br /><br />	LOCAL	lvc&#58;LV_COLUMN<br />	<br />	mov	lvc.imask, LVCF_FMT or LVCF_TEXT or LVCF_WIDTH<br />	mov	lvc.lx, 210<br />	push	OFFSET szProcess<br />	pop	lvc.pszText <br /><br />	invoke	SendMessage, hList, LVM_INSERTCOLUMN, 0, ADDR lvc<br />	<br />	mov	lvc.fmt, LVCFMT_CENTER<br />	push	OFFSET szProcessID<br />	pop	lvc.pszText<br />	<br />	invoke	SendMessage, hList, LVM_INSERTCOLUMN, 1, ADDR lvc<br />	<br />	ret<br />	<br />InsertColumn	endp<br /><br />InsertItem	proc	pPName&#58;DWORD, pPiD&#58;DWORD<br /><br />	LOCAL	lvi&#58;LV_ITEM<br />	<br />	mov	lvi.imask, LVIF_TEXT	<br />	mov	lvi.iItem, 0<br />	mov	lvi.iSubItem, 0<br />	push	pPName<br />	pop	lvi.pszText<br />	<br />	invoke	SendMessage, hList, LVM_INSERTITEM, 0, ADDR lvi<br />	<br />	mov	lvi.iSubItem, 1<br />	push	pPiD<br />	pop	lvi.pszText<br />	<br />	invoke	SendMessage, hList, LVM_SETITEM, 1, ADDR lvi<br />	<br />	ret<br />	<br />InsertItem	endp<br /><br />GetProcess	proc	uses esi edi<br /><br />	LOCAL	CountProcess &#58; DWORD<br />	<br />	invoke	LoadLibrary, ADDR szLibName<br />	mov	hDLL, eax<br />	<br />	.IF &#40;hDLL != NULL&#41;<br />	<br />		; ///////////////// R?cup?ration des adresses dans psapi.Dll \\\\\\\\\\\\\\\\\\\\\\<br /><br />		invoke	GetProcAddress, hDLL, ADDR szGetModuleFileNameEx<br />		mov	GetModuleFileNameEx, eax<br />		invoke	GetProcAddress, hDLL, ADDR szEnumProcesses<br />		mov	EnumProcesses, eax<br />		<br />		; //////////////// Fonction pour mettre les pid dans un tableau \\\\\\\\\\\\\\\\\\\\<br />		<br />		push	OFFSET cbNeeded<br />		push	SIZEOF lpidProcess<br />		push	OFFSET lpidProcess<br />		call	&#91;EnumProcesses&#93;<br />		<br />		<br />		.IF &#40;eax != NULL&#41;<br />		<br />			; //////////////// Division pour conna?tre le nb de process \\\\\\\\\\\\\\\<br />		<br />			mov	eax, cbNeeded<br />			mov	ecx, SIZEOF DWORD<br />			cdq<br />			idiv	ecx<br />			mov	CountProcess, eax<br />			<br />			;invoke	wsprintf, ADDR testtest, ADDR Format, CountProcess<br />			;invoke	MessageBox, NULL, ADDR testtest, ADDR WindowName, NULL<br /><br />			;	Utilisation d'ecx comme compteur du nb de process<br />			xor	edi, edi<br />			<br />			;	On r?cup?re l'addr de lpidProcess dans esi<br />			lea	esi, lpidProcess	<br />			<br />			<br />	; //////////////////// On commence la boucle pour traiter chaque process un ? un \\\\\\\\\\\\\\\\\\\\		<br />			<br />	beginloop&#58;<br />	<br />			;	On incr?mente l'indice du tableau et on passe le pid ? la fonction<br />			;	GetprocessNT qui s'occupe d'ins?rer le nom du process dans le listview<br />			push	&#91; esi &#93;<br />			call	GetProcessNT<br />			add	esi, 4<br />			<br />			cmp	edi, CountProcess<br />			jz	endloop<br />			inc	edi<br />			jmp	beginloop<br />	endloop&#58;<br />			<br />		.ENDIF<br />	.ELSE<br /><br />		call	GetProcess98<br />	.ENDIF<br />		<br />	ret<br />	<br />GetProcess	endp<br /><br />GetProcessNT	proc	PID &#58; DWORD<br />	<br />	LOCAL	hProcess&#58;HANDLE<br />	LOCAL	hModule&#58;HANDLE<br />	LOCAL	buf&#91;128&#93;&#58;BYTE<br />	<br />	; HANDLE MODULE<br />	<br />	LOCAL	szProcessName&#91;256&#93; &#58; BYTE<br />	<br />	<br />	invoke	wsprintf, ADDR buf, ADDR Format, PID<br />	invoke	MessageBox, NULL, ADDR buf, ADDR WindowName, NULL<br />	<br />	invoke	OpenProcess, PROCESS_ALL_ACCESS, FALSE, PID<br />	mov	hProcess, eax<br />	.IF eax != NULL<br />		<br />	;	invoke	wsprintf, ADDR buf, ADDR Format, PID<br />	;	invoke	MessageBox, NULL, ADDR buf, ADDR WindowName, NULL<br />		<br />		mov	eax, SIZEOF szProcessName<br />		push	eax<br />		lea	eax, szProcessName<br />		push	eax<br />		push	hModule<br />		push	hProcess<br />		call	&#91;GetModuleFileNameEx&#93;<br />		<br />		<br />		<br />		lea	eax, szProcessName<br />		push	eax<br />		lea	eax, PID<br />		push	eax<br />		call	InsertItem<br />	<br />	.ENDIF<br />	<br />	ret<br />	<br />GetProcessNT	endp	<br /><br />GetProcess98	proc<br /><br />	LOCAL	hProcessSnap&#58;HANDLE<br />	LOCAL	pe32&#58;PROCESSENTRY32<br /><br />	invoke	CreateToolhelp32Snapshot, TH32CS_SNAPPROCESS, 0<br />	mov	hProcessSnap, eax<br />	<br />	.IF &#40;hProcessSnap != INVALID_HANDLE_VALUE&#41;<br /><br />		mov	pe32.dwSize, SIZEOF pe32<br />		invoke	Process32First, hProcessSnap, ADDR pe32<br /><br />			.WHILE eax != NULL<br />					<br />				push	0<br />				lea	eax, pe32.szExeFile<br />				push	eax<br />				call	InsertItem<br />				<br />				invoke	Process32Next, hProcessSnap, ADDR pe32<br />			.ENDW<br />	<br />	.ENDIF<br />		<br />	ret<br />	<br />GetProcess98	endp<br /><br />end start</code></pre><br /><br />i join my asm file and psapi.dll : <a target="_blank" href="http://www.winutils.com/psapi.dll">http://www.winutils.com/psapi.dll</a><br />oh, the goal of this program is to catch all system process and to display them in a listview<br />sorry for my very bad english and thanx a lot for your help :)</div>
    <div class="meta">Posted on 2002-06-26 08:45:19 by SpYflaX</div>
   </div>
   <div class="post" id="post-45303">
    <div class="subject"><a href="#post-45303">take a look at this...</a></div>
    <div class="body">look at this source...</div>
    <div class="meta">Posted on 2002-06-26 16:29:57 by hunter</div>
   </div>
   <div class="post" id="post-45305">
    <div class="subject"><a href="#post-45305">SnapShot Process on NT and 98</a></div>
    <div class="body">ohh great, thanx a lot hunter :)</div>
    <div class="meta">Posted on 2002-06-26 16:46:23 by SpYflaX</div>
   </div>
  </div>
 </body>
</html>