<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>FSG Encryption,--header-- - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=21377" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=21377">FSG Encryption,--header--</a></p>
   <div class="post" id="post-161578">
    <div class="subject"><a href="#post-161578">FSG Encryption,--header--</a></div>
    <div class="body">heres example of encrypting a file packed with fsg<br /><br />enjoy<br />not by me ---------------------------------------<br /><pre><code>format PE gui 4.0<br />include &quot;C:\fasm\INCLUDE\win32a.inc&quot;<br /><br />;_IMAGE_SECTION_HEADER<br />;Name: packed array[0..IMAGE_SIZEOF_SHORT_NAME-1] of Byte;&nbsp; 0<br />;Misc: TISHMisc;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8<br />;VirtualAddress: DWORD;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  12<br />;SizeOfRawData: DWORD;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 16<br />;PointerToRawData: DWORD;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  20<br />;PointerToRelocations: DWORD;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  24<br />;PointerToLinenumbers: DWORD;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  28<br />;NumberOfRelocations: Word;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  30<br />;NumberOfLinenumbers: Word;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  32<br />;Characteristics: DWORD;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 36<br />;end;<br /><br />MAX_PATH equ 260<br />SIZEOF_IMAGENTHEADERS equ 248<br />SIZEOF_IMAGESECTIONHEADER equ 40<br />OEP equ 40<br /><br />call <br />mov edi, eax<br />inc edi<br />cld<br />mov al, &#39;&quot;&#39;<br />xor ecx, ecx<br />nop<br />not ecx<br />repne scasb<br />cmp byte , &#39;&quot;&#39;<br />jne OpenBox<br /><br />xor ecx, ecx<br />not ecx<br />repne scasb<br /><br />mov esi, edi<br />nop<br />xor ecx, ecx<br />nop<br />nop<br />not ecx<br />repne scasb<br />not ecx<br />dec ecx<br />mov edi, FileName<br />rep movsb<br />jmp OpenTheFile<br /><br /><br />OpenBox:<br />mov , ofnsize - ofn<br />mov , FileName<br />mov , MAX_PATH<br />mov , OFN_NOREADONLYRETURN or OFN_HIDEREADONLY<br />mov , Title<br />push ofn<br />call <br />test eax ,eax<br />jz fin<br /><br />OpenTheFile:<br /><br />push OF_READWRITE<br />push FileName<br />call [_lopen]<br />cmp eax, 0xFFFFFFFF<br />je erreur<br />mov ebx, eax<br /><br />push 0<br />push ebx<br />call <br />test eax, eax<br />jz erreur<br />mov , eax<br /><br />add eax, 28<br />push eax<br />push LPTR<br />call <br />test eax, eax<br />NOP<br />jz erreur<br />mov , eax<br />mov , ebx<br /><br />push dword <br />push eax<br />push ebx<br />call [_lread]<br />test eax, eax<br />jz erreur<br /><br />mov ebx, <br />cmp word , &#39;MZ&#39;<br />jne erreur<br />cmp dword , &#39;FSG!&#39;<br />jne erreur<br />mov dword , &#39;QWET&#39;<br />add ebx, <br />cmp word , &#39;PE&#39;<br />jne erreur<br /><br />mov eax, ebx<br />add eax, SIZEOF_IMAGENTHEADERS + SIZEOF_IMAGESECTIONHEADER<br /><br />;---------------------------------------------------------------<br />; section code &amp; executable<br /><br />or dword , 0x20000020<br /><br />;---------------------------------------------------------------<br />; config decrypt code<br /><br />; find the start crypt RVA + ImageBase<br />mov edx, 0x154<br />add edx, <br />add edx, 2<br />mov edx, <br />sub edx, &nbsp;  ; image base<br />sub edx, &nbsp;  ; rva<br />add edx, &nbsp;  ; raw offset<br />add edx, <br />mov edx, 	&nbsp; ; end to crypt<br />sub edx, &nbsp;  ; image base<br />sub edx, &nbsp;  ; rva<br />add edx, &nbsp;  ; raw offset<br />add edx, <br />mov edx, &nbsp; &nbsp; ; start to crypt<br /><br />mov ecx, &nbsp; ; RVA import table<br />add ecx, &nbsp;  ; RVA + ib importtable<br />sub ecx, 0x20	&nbsp; &nbsp; &nbsp; ;its a litlte shitty, but ididnt really find a way to calculate the size of dat to encrypt<br />sub ecx, edx	&nbsp; &nbsp; &nbsp; ; size to crypt<br />shr ecx, 2<br /><br />push edx<br />push eax<br />rdtsc		&nbsp; &nbsp;  ; generate a random key<br />mov esi, eax<br />nop<br />xor esi, edx<br />nop<br />pop eax<br />pop edx<br /><br />mov , edx<br />mov , ecx<br />mov , esi<br />mov edi, <br />add edi, <br />mov , edi<br /><br />;---------------------------------------------------------------<br />; set the new entry point<br /><br />mov edi, <br />sub edi, <br />add edi, <br />mov , edi<br /><br />;---------------------------------------------------------------<br /><br />add dword , 28<br /><br />mov edi, edx<br />sub edi, &nbsp;  ; image base<br />sub edi, &nbsp;  ; rva<br />add edi, &nbsp;  ; raw offset<br />add edi, <br />bouclecrypt:<br />xor dword , esi<br />add edi, 4<br />dec ecx<br />jnz bouclecrypt<br /><br />mov edi, <br />add edi, <br />mov ecx, 28<br />mov esi, decryptcode<br />rep movsb<br /><br />push FILE_BEGIN<br />push 0<br />push dword <br />call [_llseek]<br /><br />add dword , 28<br /><br />push dword <br />push dword <br />push dword <br />call [_lwrite]<br /><br />push dword <br />call [_lclose]<br /><br />push MB_ICONINFORMATION<br />push Title<br />push TextOK<br />push 0<br />call <br /><br />jmp fin<br /><br />erreur:<br />push MB_ICONERROR<br />push Title<br />push TextError<br />push 0<br />call <br /><br />fin:<br />call <br />push eax<br />call <br /><br />decryptcode:<br />mov edi, 0xABCDEFAA<br />mov ecx, 0xBCDEFBBB<br />crypting:<br />xor dword , 0xCDEFCCCC<br />add edi, 4<br />dec ecx<br />jnz crypting<br />push 0xDEFDDDDD<br />ret<br /><br />ofn OPENFILENAME<br />ofnsize:<br /><br />FileName rb MAX_PATH<br />Title db &#39;FSg 2.0 Modded crypter &#39;, 0<br />TextError db &#39;/!\ Sure your using fsg 2.0 /!\&#39;, 0<br />TextOK db &#39;Salut Encrypted&#39;, 0<br />FileBuffer rd 1<br />FileSize rd 1<br />hFile rd 1<br /><br />data import<br />&nbsp; library kernel32, &quot;KERNEL32.DLL&quot;,\<br />	&nbsp; comdlg32, &quot;COMDLG32.DLL&quot;,\<br />	&nbsp; user32, &quot;USER32.DLL&quot;<br /><br />&nbsp; include &quot;C:\fasm\INCLUDE\APIA\KERNEL32.INC&quot;<br />&nbsp; include &quot;C:\fasm\INCLUDE\APIA\COMDLG32.INC&quot;<br />&nbsp; include &quot;C:\fasm\INCLUDE\APIA\USER32.INC&quot;<br />end data</code></pre></div>
    <div class="meta">Posted on 2005-06-29 10:15:58 by johndoe</div>
   </div>
   <div class="post" id="post-161587">
    <div class="subject"><a href="#post-161587">Re: FSG Encryption,--header--</a></div>
    <div class="body">isn`t smaller (FSG general idea):<br /><br />decryptcode:<br />mov edi, 0xABCDEFAA<br />mov ecx, 0xBCDEFBBB<br />crypting:<br />xor dword , 0xCDEFCCCC<br />add edi, 4<br />loop crypting<br />jmp 0xDEFDDDDD<br /><br />yes, it`s smaller - 2 bytes.<br />: )<br /></div>
    <div class="meta">Posted on 2005-06-29 13:38:16 by rambo</div>
   </div>
   <div class="post" id="post-161588">
    <div class="subject"><a href="#post-161588">Re: FSG Encryption,--header--</a></div>
    <div class="body">smaller by a few bytes but slower.&nbsp; The loop opcode is kind of slow like the string opcodes. <br />I&#39;d bet benchmarking wise that the dec ecx + conditional jmp would be a little bit faster.</div>
    <div class="meta">Posted on 2005-06-29 14:41:12 by r22</div>
   </div>
   <div class="post" id="post-161590">
    <div class="subject"><a href="#post-161590">Re: FSG Encryption,--header--</a></div>
    <div class="body"><div class="quote">mov ebx, <br />cmp word , &#39;MZ&#39;<br />jne erreur<br />cmp dword , &#39;FSG!&#39;<br />jne erreur<br />mov dword , &#39;QWET&#39;<br />add ebx, <br />cmp word , &#39;PE&#39;<br />jne erreur<br /></div><br /><br /><div class="quote">mov dword , &#39;QWET&#39;</div><br /><br />u can add ur own 4 letter something lol<br />i modded it for 8 while back<br />i dunno i mess around</div>
    <div class="meta">Posted on 2005-06-29 15:02:04 by johndoe</div>
   </div>
  </div>
 </body>
</html>