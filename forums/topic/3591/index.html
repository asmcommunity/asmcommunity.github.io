<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>The Svins Math Book, Collisions - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=3591" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=3591">The Svins Math Book, Collisions</a></p>
   <div class="post" id="post-23978">
    <div class="subject"><a href="#post-23978">The Svins Math Book, Collisions</a></div>
    <div class="body">This was suggested by eko as an addition to a previous question. If he doesn't mind I'm just going to reword here as a full question on its own as I think it works better that way.<br /><br />You have two balls of mass m1 &amp; m2. Each has a velocity u1 &amp; u2. The velocities will be of different sign. Allowance should also be made foe the cahce that one ball isn't moving initially. The balls are placed so that they will colide, therefore you don't need to worry about the initial placing in you solution. Additionally, all movent should take place purely on the horizontal plane. So this is all 1 dimensional.<br /><br />Here's some terible ASCII art to show what I mean.<br />u1 = 10           u2 = -3<br /> O ---&gt;             &lt;- o<br />m1 = 20           m2 = 10 <br /><br />After any collision each balls is probably going to fly off in a different direction, you need to find those velocities. There is also a additional value <em>e</em> which is called the coefficient of restitution. This controls how much energy is lost in the collision.<br /><br />So to formalise the question. <br />Given<br />u1 Initial velocity of ball1<br />m1 Mass of ball1<br />u2 Initial velocity of ball2<br />m2 Mass of ball2<br />e  Coeffieient of restitution <br /><br />Find<br />v1 Final velocity of ball1<br />v2 Final velocity of ball2 <br /><br />All values should be real4, don't worry about acceleration, friction, etc.<br /><br />Finally, seeing as some of us will already know the equations involved, its only fair to repeat them here so that everyone has a fair chance.<br /><br />So first we have eko's one, The conservation of momentium equation.<br />m1u1 + m2u2 = m1v1 + m2v2 <br /><br />Secondly we have the energy transfer equation.<br />v2 - v1<br />------- = e<br />u1 - u2 <br /><span style="font-size:9px>Note the different order for the subtractions above and below the line, otherwise you'll get some bizarre results</span> <br /><br />Best of luck everyone.</div>
    <div class="meta">Posted on 2002-02-12 05:39:27 by Eóin</div>
   </div>
   <div class="post" id="post-24238">
    <div class="subject"><a href="#post-24238">The Svins Math Book, Collisions</a></div>
    <div class="body">No one yet? :( <br /><br />Come on, give it a try. :alright:</div>
    <div class="meta">Posted on 2002-02-14 02:49:19 by Eóin</div>
   </div>
   <div class="post" id="post-24244">
    <div class="subject"><a href="#post-24244">The Svins Math Book, Collisions</a></div>
    <div class="body">Sorry E?in,<br /><br />My maths is so lousy that if I can't count it on my fingers, it wil not happen. :tongue: <br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-02-14 04:13:16 by hutch--</div>
   </div>
   <div class="post" id="post-24264">
    <div class="subject"><a href="#post-24264">The Svins Math Book, Collisions</a></div>
    <div class="body">LOL, not to worry Hutch. At least you replied :grin: <br /><br />Can I ask seriously though as to why the lack of intrest. The Svin hmself said <em>I'm surpised that even given task weren't solve by many programmers</em>. I have to say I'm inclined to agree with him.<br /><br />Is it maths ability or assembly ability that keeps most of our members here from suggesting answers. I mean this question is difficult enough, but for most people where does the difficulty lie? Is it in the deriving of the formula need to express the answer in terms of the given values? Or is it in coding that formula in assembly.<br /><br />What I'd like to see and I'm sure others would agree is many members here contributing solutions. It doesn't matter if your solution isn't the fastest nor the simplest. By trying it yourself first you'll better understand the various optimisations our more experienced programmers have to demonstrate. Anything you don't understand, just ask. :) <br /><br />Also, even if you feel you couldn't code an equation in the FPU, why not post your equations. For example, the above two equations have to be combined to create equations for v1 &amp; v2.<br /><br />I'll leave it open till tomorrow, then if noone else has made an attempt I'll post the fully derived equations and hopefully someone will try and code them.<br /><br />I just hope people aren't holding back because they're worried about embarassing themselves. Maths is hard enough without the added difficulty of FPU assembly code, everyone struggles at it. :alright:</div>
    <div class="meta">Posted on 2002-02-14 07:48:08 by Eóin</div>
   </div>
   <div class="post" id="post-24276">
    <div class="subject"><a href="#post-24276">The Svins Math Book, Collisions</a></div>
    <div class="body">It is a matter of time for me. :(</div>
    <div class="meta">Posted on 2002-02-14 10:23:43 by bitRAKE</div>
   </div>
   <div class="post" id="post-24280">
    <div class="subject"><a href="#post-24280">The Svins Math Book, Collisions</a></div>
    <div class="body">I realise that bitRAKE, with universtiy Thomas is probaly in the same position. Indeed I too am fairly restricted Monday to Thursday as I'm away at college and can only go online on the college PCs, which don't have Masm.<br /><br />But I was curious mainly as too why the three go us are the only real contributers. Not the onlys at all, but definitly the main ones. <br /><br />I'd like to see many people giving them a try. Worst case scenario you'll learn something new.</div>
    <div class="meta">Posted on 2002-02-14 11:04:22 by Eóin</div>
   </div>
   <div class="post" id="post-24317">
    <div class="subject"><a href="#post-24317">My try</a></div>
    <div class="body">my simplified formula for calculating it<br />v1=( u2m2(1+e)+u1(m1-em2) )/(m1+m2)<br />v2=e(u1-u2)+v1<br />I dont know how to use fpu :( but here is my try<br /><br /><pre><code><br />;;m1=eax<br />;u1=ebx<br />;m2=ecx<br />;u2=edx<br />;e=edi<br />;v1=ebx<br /><br /><br />imul edx,ecx ;u2*m2<br />inc edi ;e+1<br />imul edx,edi ;u2*m2&#40;e+1&#41;<br />dec edi ;e<br />imul edi,ecx ;e*m2<br />push eax  ;store m1<br />sub eax,edi ;m1-e*m2<br />imul ebx,eax ;ebx&#40;m1-e*m2&#41;<br />add ebx,edx ;u2m2&#40;1+e&#41;+u1&#40;m1-em2&#41;<br />pop eax     ;m1<br />add eax,ecx ;m1+m2<br />idiv ebx,eax  ;v1<br /><br /></code></pre><br />I didnt tested it hope it works :)</div>
    <div class="meta">Posted on 2002-02-14 19:15:04 by LaptoniC</div>
   </div>
   <div class="post" id="post-24383">
    <div class="subject"><a href="#post-24383">The Svins Math Book, Collisions</a></div>
    <div class="body">Congratulations LaptoniC, those equations generate the correct answers. <br /><br />Your code unfortunatly doesn't work just right at the end with the idiv instruction. :(<br /><br />Don't forget that idiv only takes one operand. And it divides EDX:EAX by that operand. Your code tries to divide EBX by EAX. The simple solution is the swap ebx and eax at the end. You also need to sign extend eax into edx.<br /><br />With a bit of restructring of your code you can get all this to work nicely.<br /><br />But congratulations again. Now does anyone else wish to convert it to FPU code. :)</div>
    <div class="meta">Posted on 2002-02-15 11:19:07 by Eóin</div>
   </div>
   <div class="post" id="post-24436">
    <div class="subject"><a href="#post-24436">The Svins Math Book, Collisions</a></div>
    <div class="body">Right, for all those interested, I'm going to do a detailed run down of the solution.<br /><br />First we need the equations, LaptioniC provided us with those:<br />v1=(u2m2(1+e)+u1(m1-em2) )/(m1+m2) <br />v2=e(u1-u2)+v1 <br /> <br /><br />These are correct, but I found a slightly different form of the equations was more efficient;<br />v1 = (m1u1 + m2<u>e(u1 - u2)]/(m1 + m2)<br />v2 = v1 + e(u1 - u2)<br /><br />My first equation and LaponiCs are the same, just reordered. But note the key bit in red which is duplicated for v1 &amp; v2, this allows us to reuse it and save on some calculation.<br /><br />Right, now we want to code this. Lets do it very simply, first we calculate v1 so lets look a the equation. The overall form is a/b. b is simply m1 + m2. We'll deal with the top bit, a, first. <br /><br />Basically you want to break the equation into seperate bits. For example the start of it, m1u1, is seperate, so lets calculate that first<br /><br />fld m1<br />fmul u1<br /><br />Now you leave that on the stack and go to the next bit, m2<u>. The first thing we see is multiplication by m2, however thats on its own so we should calculate inside the brackets first and simply use a final fmul m2 to multiply by m2.<br /><br />Inside the bracket again the first thing we see is a variable, u2, on its own so we move on. Next we see e, again on its own so move on again. Ahh, now we have something to calculate, u1 - u2, here we go<br /><br />fld u1<br />fsub u2 <br /><br />Right, now that we have u1 - u2 we can multiply by e to get e(u1 - u2).<br /><br />fmul e <br /><br />Next we can work out the subtracion u2 - e(u1 - u2). Be careful here, you can't use fsub u2 as that would give you e(u1 - u2) - u2. Instead we must use reverse subtraction<br /><br />fsubr u2 <br /><br />And now multiply by m2 to get m2<u><br /><br />fmul m2<br /><br />At this stage you may remember that we left m1u1 on the stack when we calculated it, since we haven't messed with the stack it should now be back at st(1) so to get m1u1 = m2<u> we simplt add st &amp; st(1), which is written as faddp st(1),st or the much simpler short form<br /><br />fadd <br /><br />Right, thats the top half, leave that on the stack and onto the bottom part, m1 + m2;<br /><br />fld m1<br />fadd m2 <br /><br />We need to divide these now, so fdivp st(1),st would do it, but I'm using the short form again;<br /><br />fdiv <br /><br />And hey presto we have calculated v1. You store that in a variable, however we're not going to pop it off the stack as we'll use it to calculate v2.<br /><br />fst v1 <br /><br />To get v2 we add e(u1 - u2) to v1 which is on the stack.<br /><br />fld u1<br />fsub u2<br />fmul e<br />fadd <br /><br />And store the result<br /><br />fstp v2 <br /><br />Now your're asking, what about optimistaions, what happened to that great plan to reuse the e(u1 - u2) bit. Well what I want'ed to describe to you there is the basics for coding an equation. Optimisations are harder to follow, but for the sake of it I'll go through the e(u1 - u2) bit.<br /><br />Just after we ahve calculated e(u1 - u2) we will store it with fst.<br /><br />fmul e<br /><em>fst st(?)</em><br />fsubr u2 <br /><br />But where are we going to store, you could plonk it into a memory vriable, but lets be more efficient and put it in one of the free spots on the fpu stack. We know st(0) holds e(u1 - u2), and remember st(1) is still holding m1u1 at this stage, so put it in st(2).<br /><br />What this mean is that when it comes to calculating v2, we have v1 in st(0) and e(u1 - u2) in st(1). But v2 is the sum of those two values so fadd and we're home free, no recalculation of e(u1 - u2).<br /><br />Another good fpu optimisation is to try and never load a value more than once. The following show the most optimised version I could write. Hopefully anyone who wishs to will be able to follow this and learn.<br /><br /><pre><code>		; Stack | st0			       | st1		| st2	   | st3      | st4	<br />		;----------------------------------------------------------------------------------------<br />fld m2		;	| m2			       |			|	   |	      |			<br />fld u1		;	| u1			       | m2		|	   |	      |			<br />fld u2		;	| u2			       | u1		| m2	   |	      |			<br />fld st&#40;1&#41;		;	| u1			       | u2		| u1	   | m2	      |			<br />fsub st,st&#40;1&#41;	;	| u1-u2			       | u2		| u1	   | m2	      |			<br />fmul e		;	| e&#40;u1-u2&#41;		       | u2		| u1	   | m2	      |			<br />fst st&#40;4&#41;		;	| e&#40;u1-u2&#41;		       | u2		| u1	   | m2	      | e&#40;u1-u2&#41;	<br /><br />fsub		;	| u2-&#40;u1-u2&#41;		       | u1		| m2	   | e&#40;u1-u2&#41; |			<br />fmul st,st&#40;2&#41;	;	| m2&#40;u2-&#40;u1-u2&#41;&#41;	     	       | u1		| m2	   | e&#40;u1-u2&#41; |			<br />				<br />fld m1		;	| m1			       | m2&#40;u2-&#40;u1-u2&#41;&#41;	| u1	   | m2+m1    | e&#40;u1-u2&#41;		<br />fadd st&#40;3&#41;,st	;	| m1			       | m2&#40;u2-&#40;u1-u2&#41;&#41;	| m1	   | m2+m1    | e&#40;u1-u2&#41;	<br />fmulp st&#40;2&#41;,st	;	| m2&#40;u2-&#40;u1-u2&#41;&#41;	     	       | m1u1		| m2+m1	   | e&#40;u1-u2&#41; |<br />				<br />fadd		;	| m1u1+m2&#40;u2-e&#40;u1-u2&#41;	       | m2+m1		| e&#40;u1-u2&#41; |	      |<br />fdivr		;	|&#40;m1u2+m2&#40;u2-e&#40;u1-u2&#41;&#41;/&#40;m2+m1&#41;    | e&#40;u1-u2&#41;		|	   |	      |<br />fst v1		;	|&#40;m1u2+m2&#40;u2-e&#40;u1-u2&#41;&#41;/&#40;m2+m1&#41;    | e&#40;u1-u2&#41;		|	   |	      |			<br />fadd		;	| v1 + e&#40;u1-u2&#41;		       |			|	   |	      |<br />fstp v2		;	|			       |			|	   |	      |</code></pre><br /><br />And to end on an interesting note. When I looked at the VC++ output for the following, <br />v1 = (m1*m1 + m2*(u2-e*(u1-u2)))/(m2+m1);<br />v2 = v1 + e*(u1-u2); <br /><br />It had generated the following code<br /><span style="font-size:9px><pre><code>fld         qword ptr &#91;m1&#93; <br />fmul        qword ptr &#91;u1&#93; <br /> 				<br />fld         qword ptr &#91;u1&#93; <br />fsub        qword ptr &#91;u2&#93; <br />fmul        qword ptr &#91;e&#93; <br />fsubr       qword ptr &#91;u2&#93; <br />fmul        qword ptr &#91;m2&#93; <br /><br />faddp       st&#40;1&#41;,st <br />fld         qword ptr &#91;m2&#93; <br />fadd        qword ptr &#91;m1&#93; <br />fdivp       st&#40;1&#41;,st <br />fstp        qword ptr &#91;v1&#93; <br /> <br />fld         qword ptr &#91;u1&#93; <br />fsub        qword ptr &#91;u2&#93; <br />fmul        qword ptr &#91;e&#93; <br />fadd        qword ptr &#91;v1&#93; <br />fstp        qword ptr &#91;v2&#93;</code></pre></span> <br /><br />Look familiar? This is exactly the code I used to explain things above. Actually, its slightly different, It pops v1 off the stack when it stores it and therefore has to reload it later, so it's less efficient.<br /><br />What does this mean? VCs output for FPU code in this case is less efficient to than even badly written assembly. And its a whole 26% slower than the optimised version. <br /><br />Something for those who hold as easy to code equations as a plus for HLLs to think about. :tongue: <br /><br />Hope someone finds this useful, or at least interesting. :alright:</div>
    <div class="meta">Posted on 2002-02-15 18:21:32 by Eóin</div>
   </div>
   <div class="post" id="post-24508">
    <div class="subject"><a href="#post-24508">The Svins Math Book, Collisions</a></div>
    <div class="body"><strong>&quot;But I was curious mainly as too why the three go us are the only real contributers.&quot; </strong> <br /><br />Because it's sooooo HEAVY....Most of us only got a D- in math...<br /><br />I'm sure we all are enjoying stuff like this, we just don't know what to say or do just yet...It's nice to see the HEAVY'S having fun and optimizing wars....<br /><br />Please Don't Stop<br /><br /><span style="font-size:9px>Stuff like this is going to make most of us REAL programmer one day ...because we get to see the super HEAVY  coding  today</span></div>
    <div class="meta">Posted on 2002-02-16 06:25:50 by cmax</div>
   </div>
   <div class="post" id="post-115977">
    <div class="subject"><a href="#post-115977">The Svins Math Book, Collisions</a></div>
    <div class="body">No other questions? btw. i've found this thread while looking to all thread containing FPU. I'm too late indeed.:(</div>
    <div class="meta">Posted on 2003-08-28 12:11:20 by inFinie</div>
   </div>
   <div class="post" id="post-116019">
    <div class="subject"><a href="#post-116019">The Svins Math Book, Collisions</a></div>
    <div class="body">Its no harm to revive an old thread. Besides I need to correct a mistake I made. VC optimizing compiler can actually generate quite efficient code give the two equations;<br /><br />v1 = (m1*u1 + m2*<u>/(m1 + m2)<br />v2 = v1 + e*(u1 - u2)<br /><br />It produces<br />fld     u1<br />fmul    e<br />fld     u2<br />fsub    st,st(1)<br />fmul    m2<br />fld     m1<br />fmul    u1<br />faddp   st(1),st<br />fld     m1<br />fadd    m2<br />fdivrp  st(1),st<br />fld     st<br />fstp    v1<br />fxch    st(1)<br />fadd    st,st(1)<br />fstp    v2<br />fstp    st<br /><br />This is actually the same length (no. of instructions) as the solution I suggested. Note though that the compiler never tends to access registers from st(2) or higher. This means it doen't end up storing any of the values on the stack and instead has to reload them when needed.<br /><br />In the end it tends to run about 10% slower than my version. Its not much, but at least there still some hope for us.</div>
    <div class="meta">Posted on 2003-08-28 18:24:14 by Eóin</div>
   </div>
   <div class="post" id="post-116020">
    <div class="subject"><a href="#post-116020">The Svins Math Book, Collisions</a></div>
    <div class="body"><strong>E?in</strong>,<br />Normalization of the equation for <strong>v1</strong> may afford some simplication.<br />Note that <strong>v1 = (m3*u1 + <u>)/(m3 + 1)</strong>, where <strong>m3 = m1/m2</strong>.</div>
    <div class="meta">Posted on 2003-08-28 18:47:49 by Poimander</div>
   </div>
   <div class="post" id="post-116137">
    <div class="subject"><a href="#post-116137">Hi</a></div>
    <div class="body">Hope you discuss about Geometry, like Phytagoras, ArcCos and else. I need it.:alright:</div>
    <div class="meta">Posted on 2003-08-29 11:50:07 by realvampire</div>
   </div>
   <div class="post" id="post-116140">
    <div class="subject"><a href="#post-116140">The Svins Math Book, Collisions</a></div>
    <div class="body">Pominader thats a good suggestion. In a once off calculation the the act of normalising the values would probably offset any advantages, but there are plenty of situations where it would improve things.<br /><br />It just goes to show the importance of algebra as much as coding.<br /><br />realvampire, fell free to suggest math questions/problems, if I don't answer it'll probably only be because someone beat me to it.</div>
    <div class="meta">Posted on 2003-08-29 12:13:21 by Eóin</div>
   </div>
   <div class="post" id="post-117008">
    <div class="subject"><a href="#post-117008">Hi .</a></div>
    <div class="body">Hi,<br />I have Angle Function From the GLib. There are 3 Parameter to obtain the Angle. Ax=DeltaY, DX=DeltaY, and BX= address of Normalisation Factor. The question is what is normalisation factor?<br /><br /><br />THank you</div>
    <div class="meta">Posted on 2003-09-04 21:33:17 by realvampire</div>
   </div>
  </div>
 </body>
</html>