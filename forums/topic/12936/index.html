<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Some thougths on LOCAL and OOP, and what I wish it could do. - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=12936" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=12936">Some thougths on LOCAL and OOP, and what I wish it could do.</a></p>
   <div class="post" id="post-100530">
    <div class="subject"><a href="#post-100530">Some thougths on LOCAL and OOP, and what I wish it could do.</a></div>
    <div class="body">Yes, I abuse LOCAL and EBP, because LOCAL only works with ebp.<br />Gaze upong my abuse and be horrified and amazed:<br /><pre><code><br />	OPTION PROLOGUE&#58;NONE ;***Notice- no stack frame<br />	OPTION EPILOGUE&#58;NONE<br /><br />align 16<br />Render PROC PUBLIC<br />	LOCAL D3D&#91;0&#93;&#58;_D3D<br />	mov .EBP,ebp                    ;***just to be safe, save ebp<br />	mov ebp,&#91;D3Dvt&#93;               ;***Now set ebp to the address of the vtable<br />	<br />		invoke &#91;D3D&#93;.Clear,&#91;g_pd3dDevice&#93; ,0,0,D3DCLEAR_TARGET,0FF0000FFh,f1x0,0<br />		<br />		invoke &#91;D3D&#93;.BeginScene,&#91;g_pd3dDevice&#93;<br /><br />		invoke &#91;D3D&#93;.SetStreamSource,&#91;g_pd3dDevice&#93;,0,g_pVB,0,sizeof &#40;CUSTOMVERTEX&#41;<br />		invoke &#91;D3D&#93;.SetFVF,&#91;g_pd3dDevice&#93;,D3DFVF_CUSTOMVERTEX<br />		invoke &#91;D3D&#93;.DrawPrimitive,&#91;g_pd3dDevice&#93;,D3DPT_TRIANGLELIST,0,1<br /><br />		invoke &#91;D3D&#93;.EndScene,&#91;g_pd3dDevice&#93;<br /><br />		invoke &#91;D3D&#93;.Present,&#91;g_pd3dDevice&#93;,0,0,0,0<br /><br />	mov ebp,.EBP                   ;***jus to be safe restore EBP<br />	ret<br />Render endp<br /><br />	OPTION PROLOGUE&#58;PROLOGUEDEF<br />	OPTION EPILOGUE&#58;EPILOGUEDEF<br />-----------------------------------------------------------------------------------<br />Disassembly&#58;<br />00401140 89 2D 44 30 40 00 mov         dword ptr &#91;.EBP &#40;403044h&#41;&#93;,ebp <br />	mov ebp,&#91;D3Dvt&#93;	<br />00401146 8B 2D 4C 30 40 00 mov         ebp,dword ptr &#91;D3Dvt &#40;40304Ch&#41;&#93; <br />	<br />		invoke &#91;D3D&#93;.Clear,&#91;g_pd3dDevice&#93; ,0,0,D3DCLEAR_TARGET,0FF0000FFh,f1x0,0<br />0040114C 6A 00            push        0    <br />0040114E 68 00 00 80 3F   push        3F800000h <br />00401153 68 FF 00 00 FF   push        0FF0000FFh <br />00401158 6A 01            push        1    <br />0040115A 6A 00            push        0    <br />0040115C 6A 00            push        0    <br />0040115E FF 35 04 30 40 00 push        dword ptr &#91;g_pd3dDevice &#40;403004h&#41;&#93; <br />00401164 FF 95 AC 00 00 00 call        dword ptr &#91;ebp+0ACh&#93; <br />		<br />		invoke &#91;D3D&#93;.BeginScene,&#91;g_pd3dDevice&#93;<br />0040116A FF 35 04 30 40 00 push        dword ptr &#91;g_pd3dDevice &#40;403004h&#41;&#93; <br />00401170 FF 95 A4 00 00 00 call        dword ptr &#91;ebp+0A4h&#93; <br /><br />			invoke &#91;D3D&#93;.SetStreamSource,&#91;g_pd3dDevice&#93;,0,g_pVB,0,sizeof &#40;CUSTOMVERTEX&#41;<br />00401176 6A 14            push        14h  <br />00401178 6A 00            push        0    <br />0040117A FF 35 08 30 40 00 push        dword ptr &#91;g_pVB &#40;403008h&#41;&#93; <br />00401180 6A 00            push        0    <br />00401182 FF 35 04 30 40 00 push        dword ptr &#91;g_pd3dDevice &#40;403004h&#41;&#93; <br />00401188 FF 95 90 01 00 00 call        dword ptr &#91;ebp+190h&#93; <br />			invoke &#91;D3D&#93;.SetFVF,&#91;g_pd3dDevice&#93;,D3DFVF_CUSTOMVERTEX<br />0040118E 6A 44            push        44h  <br />00401190 FF 35 04 30 40 00 push        dword ptr &#91;g_pd3dDevice &#40;403004h&#41;&#93; <br />00401196 FF 95 64 01 00 00 call        dword ptr &#91;ebp+164h&#93; <br />			invoke &#91;D3D&#93;.DrawPrimitive,&#91;g_pd3dDevice&#93;,D3DPT_TRIANGLELIST,0,1<br />0040119C 6A 01            push        1    <br />0040119E 6A 00            push        0    <br />004011A0 6A 04            push        4    <br />004011A2 FF 35 04 30 40 00 push        dword ptr &#91;g_pd3dDevice &#40;403004h&#41;&#93; <br />004011A8 FF 95 44 01 00 00 call        dword ptr &#91;ebp+144h&#93; <br /><br />		invoke &#91;D3D&#93;.EndScene,&#91;g_pd3dDevice&#93;<br />004011AE FF 35 04 30 40 00 push        dword ptr &#91;g_pd3dDevice &#40;403004h&#41;&#93; <br />004011B4 FF 95 A8 00 00 00 call        dword ptr &#91;ebp+0A8h&#93; <br /><br />		invoke &#91;D3D&#93;.Present,&#91;g_pd3dDevice&#93;,0,0,0,0<br />004011BA 6A 00            push        0    <br />004011BC 6A 00            push        0    <br />004011BE 6A 00            push        0    <br />004011C0 6A 00            push        0    <br />004011C2 FF 35 04 30 40 00 push        dword ptr &#91;g_pd3dDevice &#40;403004h&#41;&#93; <br />004011C8 FF 55 44         call        dword ptr &#91;ebp+44h&#93; <br /><br />	mov ebp,.EBP<br />004011CB 8B 2D 44 30 40 00 mov         ebp,dword ptr &#91;.EBP &#40;403044h&#41;&#93; <br />	ret<br />004011D1 C3               ret         <br />----------------------------------------------------------------<br />more complex example&#58;<br /><br />Cleanup PROC PUBLIC<br />	LOCAL D3D&#91;0&#93;&#58;_D3D<br />	LOCAL ID3D9&#91;0&#93;&#58;_ID3D9<br />	LOCAL D3DVB&#91;0&#93;&#58;_D3DVB <br />	mov .EBP,ebp<br />	mov ebp,&#91;D3Dvt&#93;                 ;***move EBP to the start of one vtable<br /><br />		cmp	dword ptr &#91;g_pd3dDevice&#93;,0 <br />		je .1  <br /><br />		invoke &#91;D3D&#93;.Release,&#91;g_pd3dDevice&#93;<br />.1&#58;<br />		cmp dword ptr &#91;g_pD3D&#93;,0 <br />		je .2  <br /><br />	mov ebp,&#91;D9vt&#93;                  ;***now move to the start of another vtable<br /><br />		invoke &#91;ID3D9&#93;.Release,&#91;g_pD3D&#93;<br />.2&#58;<br />		cmp dword ptr &#91;g_pVB&#93;,0<br />		je .3<br /><br />	mov ebp,&#91;DVBvt&#93;                ;***again, move EBP to the start of another vtable<br />		<br />		invoke &#91;D3DVB&#93;.Release,&#91;g_pVB&#93;<br />.3&#58;<br />	mov ebp,.EBP<br />	ret<br />Cleanup endp<br /></code></pre><br />You are not supposed to use LOCAL without a stack, but I am anyway.  I'm no C++ expert, but I think I'm using EBP similar the C++ this pointer.<br /><br />Visual C++ uses ecx as its this pointer.  I'm wonder if it is possible to make a macro that duplicates the functionality of LOCAL  using a reg besides EBP.  I've notice that VC with stack frames removed sometimes uses EDI as a vtable pointer.<br /><br />I do not know much about macro.  I looked at a lot of stuff last night, but could not find what I was looking for.  Most examples assume you want your macro to produce code.  LOCAL does not produce code.  LOCAL does produce locally scoped typed variables with EBP as an index*.<br /><br />*If you use LOCAL foobar:DWORD, it does not use EBP, just the variable. BUT if you use LOCAL foobar[0]:MYSTRUCT, it will use the form , and the [0] aligns  to the top of the struct. You set EBP to the start address of the memory that you want to be treaded as that struct.  An easy to use pointer to dynamically allocated structs, etc.<br /><br />Why would I want to do this?  I try to make readable code.  The downside is that I must use EBP.  What if I want a stackframe, and want to use stack based locals with floating struture pointer?  I can't, unless there is a way to get a macro that will do what LOCAL does, but with another register.   Has anyone made a macro like this?  If anyone knows how to use macros to make types, and not code.  If you give me some hints on how it is done, I can try to make such a macro.<br /><br />Thanks.</div>
    <div class="meta">Posted on 2003-05-01 07:39:31 by ThoughtCriminal</div>
   </div>
   <div class="post" id="post-100532">
    <div class="subject"><a href="#post-100532">Some thougths on LOCAL and OOP, and what I wish it could do.</a></div>
    <div class="body">Heh, cute :)<br /><br />With the ebp save/restore method your code isn't thread safe, but that hardly matters in a global &quot;render&quot; function. Seems like a cute trick for DirectX stuff.<br /><br />If you want the usual LOCAL support, you should be able to achieve much the same for any register with an ASSUME directive, I suppose.<br /><br />Of course it'd be like &quot;invoke .Release,&quot; instead of , but that could be taken care of with a local EQU or something.</div>
    <div class="meta">Posted on 2003-05-01 07:50:41 by f0dder</div>
   </div>
   <div class="post" id="post-100660">
    <div class="subject"><a href="#post-100660">Some thougths on LOCAL and OOP, and what I wish it could do.</a></div>
    <div class="body">Thanks for your input f0dder.<br /><br />Actually the whole program except for WinMain and WndProc use the same method of using EBP to point to data structures and vtables.  WinMain and WndProc still have stack frames.<br /><div class="quote"><br />With the ebp save/restore method your code isn't thread safe, but that hardly matters in a global &quot;render&quot; function. Seems like a cute trick for DirectX stuff.<br /></div><br />I have not used threading yet.  The reason for this post is I'd like to do the same thing, but with a safer reg like ecx.<br /><div class="quote"><br />If you want the usual LOCAL support, you should be able to achieve much the same for any register with an ASSUME directive, I suppose.<br /><br />Of course it'd be like &quot;invoke .Release,&quot; instead of , but that could be taken care of with a local EQU or something.<br /></div><br />I have not used ASSUME too much.  I'll have to look into what kind of code it generates.<br /><br />I started thinking about the equate idea too.  Is there a difference between TEXTEQU and EQU?<br /><br />D3D  TEXTEQU  ecx<br /><br />Then check the code and see if I get <br /><br />I found when translating C++ to assem, with COM objects and vtables base+index is easier than just and address to translate.  VC will use base + index for those things.  For example, if your Release method and the VC release method, when disassembled,are both the same.  Chances are your translation of the structure was correct.<br /><br />Thanks.</div>
    <div class="meta">Posted on 2003-05-01 23:14:04 by ThoughtCriminal</div>
   </div>
   <div class="post" id="post-100664">
    <div class="subject"><a href="#post-100664">Some thougths on LOCAL and OOP, and what I wish it could do.</a></div>
    <div class="body">Write your own PROLOGUE/EPILOGUE!  Your are not using the default, so write your own!<br /><br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=2153&amp;highlight=PROLOGUE">http://www.asmcommunity.net/board/index.php?topic=2153&amp;highlight=PROLOGUE</a></div>
    <div class="meta">Posted on 2003-05-01 23:35:45 by bitRAKE</div>
   </div>
   <div class="post" id="post-100676">
    <div class="subject"><a href="#post-100676">Some thougths on LOCAL and OOP, and what I wish it could do.</a></div>
    <div class="body">Thanks bitRAKE!!  Great idea.<br /><br />Now does anyone know were I can get some newbie tutorials on macros?<br /><br />Thanks.</div>
    <div class="meta">Posted on 2003-05-02 01:24:06 by ThoughtCriminal</div>
   </div>
   <div class="post" id="post-100695">
    <div class="subject"><a href="#post-100695">Some thougths on LOCAL and OOP, and what I wish it could do.</a></div>
    <div class="body">I have thought about this a week before, I am doing a work about this. I think it will work.</div>
    <div class="meta">Posted on 2003-05-02 03:03:19 by taowen2002</div>
   </div>
   <div class="post" id="post-100907">
    <div class="subject"><a href="#post-100907">Some thougths on LOCAL and OOP, and what I wish it could do.</a></div>
    <div class="body">Guess I was really missing something by not using assume:<br /><pre><code><br />_foo STRUC<br /><br />	bar1 FCALL@4			PTR	0<br />	bar2 FCALL@4			PTR	0<br />	bar3 FCALL@4			PTR	0<br /><br />_foo ENDS<br />	<br />_bar STRUC<br /><br />	foo1 FCALL@4			PTR	0<br />	foo2 FCALL@4			PTR	0<br />	foo3 FCALL@4			PTR	0<br /><br />_bar ENDS<br /><br />assume ecx&#58;ptr _foo<br />	call &#91;ecx&#93;.bar2<br />0040101A FF 51 04         call        dword ptr &#91;ecx+4&#93; <br /><br />assume ecx&#58;ptr _bar<br />	call &#91;ecx&#93;.foo3<br />0040101D FF 51 08         call        dword ptr &#91;ecx+8&#93; <br /></code></pre><br />This is not working code, but I'm getting the instruction form I want.<br />Then I could do a TEXTEQU<br /><br />D3D TEXTEQU ecx<br /><br />And it would probably work.<br /><br />oops, make that:<br /><br />D3D TEXTEQU &lt;ecx&gt;<br /><br />and it works.</div>
    <div class="meta">Posted on 2003-05-03 05:50:24 by ThoughtCriminal</div>
   </div>
   <div class="post" id="post-101417">
    <div class="subject"><a href="#post-101417">Why?</a></div>
    <div class="body"><div class="quote">With the ebp save/restore method your code isn't thread safe, but that hardly matters in a global &quot;render&quot; function. Seems like a cute trick for DirectX stuff.</div> <br />Why is that?<br />Thanks.</div>
    <div class="meta">Posted on 2003-05-06 00:32:48 by GogetaSSJ4</div>
   </div>
   <div class="post" id="post-101427">
    <div class="subject"><a href="#post-101427">Some thougths on LOCAL and OOP, and what I wish it could do.</a></div>
    <div class="body">With most stuff, you will only have a single thread running something like a &quot;global render&quot; function. With other COM stuff, especially if it's something you write once and stuff into a library for re-use, the picture can be quite different though.<br /><br />The problem is the saving of EBP into a global variable - global variables == big re-entrancy problems.</div>
    <div class="meta">Posted on 2003-05-06 01:59:39 by f0dder</div>
   </div>
  </div>
 </body>
</html>