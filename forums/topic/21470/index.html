<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>PointConstraint (N Sources) - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=21470" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=10">Graphics &amp; Game Development</a> &raquo; <a href="../?id=21470">PointConstraint (N Sources)</a></p>
   <div class="post" id="post-162150">
    <div class="subject"><a href="#post-162150">PointConstraint (N Sources)</a></div>
    <div class="body">Here&#39;s another one for public discussion.<br />This object represents a Constraint placed on a target Vec3, usually a Point, usually Position.<br />The Target Vec3&#39;s value will be the averaged sum of the Input Vec3&#39;s.<br />Example1 : if you constrain the Position of Object A to the Position of Object B, then Object A is &quot;glued&quot; to Object B. This can be used to attach anything to anything else.<br />Example2 : if you constrain the Position of Object A to the Positions of Object B and Object C, then Object A will be forced to exist half way between Objects B and C.<br />This can be used to create &quot;flocking behaviours&quot; among troops, to simulate needs-based behaviours including fear and loathing, etc :)<br /><br /><pre><code><br />MAX_CONSTRAINTS equ 4<br /><br />;We want to Constrain a foreign Position to a local Position&#39;s value?<br />;The Target Position will be relative to one or more Sources :)<br />;This object should be stored in a list of some kind,<br />;and that list updated within the main loop.<br /><br />Object PointConstraint,PointConstraintID,Primer<br />RedefineMethod Init<br />RedefineMethod Done<br />StaticMethod SetTargetPoint<br />StaticMethod AddSourceConstraintPoint,Pointer<br />DefineVariable pTargetPoint,Pointer,0<br />DefineVariable PointConstraintSourcePoints,Pointer,0<br />ObjectEnd<br /><br />Method Done,uses esi<br />	Destroy .PointConstraintSourcePoints<br />MethodEnd<br /><br />Method PointConstraint.Init,uses esi<br />	SetObject esi<br />	mov .PointConstraintSourcePoints,$New(DwordCollection,Init,NULL,MAX_CONSTRAINTS,MAX_CONSTRAINTS,MAX_CONSTRAINTS)<br />MethodEnd<br /><br />Method PointConstraint.AddSourceConstraintPoint,uses esi,pSourcePoint<br />	SetObject esi<br />	OCall .PointConstraintSourcePoints::DwordCollection.Insert,pSourcePoint<br />MethodEnd<br /><br />;This method updates the Target Point position.<br />;The calculation is as follows:<br />;Target = (Sum of Sources) / #Sources<br />Method PointConstraint.Update,uses esi edi ecx<br />	SetObject esi<br />	xor ecx,ecx<br />	mov ebx,.PointConstraintSourcePoints<br />	mov edi,.pTargetPoint	<br />	fld r4_0_0f<br />	fst .Vec3.X<br />	fst .Vec3.Y<br />	fstp .Vec3.Z	<br />	.while ecx&lt;.DwordCollection.dCount<br />		push ecx<br />		push ebx<br />		push edi<br />		;Fetch ptr to Source Point<br />		OCall ebx::DwordCollection.ItemAt,ecx<br />		pop edi<br />		fld .Vec3.X<br />		fadd .Vec3.X<br />		fstp .Vec3.X<br />		fld .Vec3.Y<br />		fadd .Vec3.Y<br />		fstp .Vec3.Y<br />		fld .Vec3.Z<br />		fadd .Vec3.Z<br />		fstp .Vec3.Z<br />		pop ebx<br />		pop ecx<br />		inc ecx<br />	.endw<br />&nbsp; &nbsp; fld .Vec3.X<br />&nbsp; &nbsp; fidiv .DwordCollection.dCount<br />&nbsp; &nbsp; fstp .Vec3.X<br />&nbsp; &nbsp; fld .Vec3.Y<br />&nbsp; &nbsp; fidiv .DwordCollection.dCount<br />&nbsp; &nbsp; fstp .Vec3.Y<br />&nbsp; &nbsp; fld .Vec3.Z<br />&nbsp; &nbsp; fidiv .DwordCollection.dCount<br />&nbsp; &nbsp; fstp .Vec3.Z&nbsp; &nbsp; &nbsp; &nbsp; <br />MethodEnd<br /></code></pre><br /></div>
    <div class="meta">Posted on 2005-07-17 09:34:06 by Homer</div>
   </div>
   <div class="post" id="post-162235">
    <div class="subject"><a href="#post-162235">Re: PointConstraint (N Sources)</a></div>
    <div class="body">Hi Homer<br />The same code, a little optimized, but untested!<br /><br /><pre><code>MAX_CONSTRAINTS equ 4<br /><br />;We want to Constrain a foreign Position to a local Position&#39;s value?<br />;The Target Position will be relative to one or more Sources :)<br />;This object should be stored in a list of some kind,<br />;and that list updated within the main loop.<br /><br />Object PointConstraint, PointConstraintID, Primer<br />? RedefineMethod? Init<br />? RedefineMethod? Done<br />? StaticMethod? ? SetTargetPoint<br />? StaticMethod? ? AddSourceConstraintPoint,? ? ?Pointer<br />? <br />? DefineVariable? pTargetPoint,? ? ? ? ? ? ? ? ?Pointer, NULL<br />? DefineVariable? PointConstraintSourcePoints,? Pointer, NULL<br />ObjectEnd<br /><br />Method PointConstraint.Done<br />? ? SetObject ecx<br />? ? Destroy .PointConstraintSourcePoints<br />? ? ACall Done<br />MethodEnd<br /><br />Method PointConstraint.Init, uses esi<br />? ? SetObject esi<br />? ? ACall esi.Init, NULL<br />? ? New DwordCollection, Init, NULL, MAX_CONSTRAINTS, MAX_CONSTRAINTS, MAX_CONSTRAINTS<br />? ? mov .PointConstraintSourcePoints, eax<br />MethodEnd<br /><br />Method PointConstraint.AddSourceConstraintPoint,, pSourcePoint:Pointer<br />? ? SetObject ecx<br />? ? OCall .PointConstraintSourcePoints::DwordCollection.Insert, pSourcePoint<br />MethodEnd<br /><br />;This method updates the Target Point position.<br />;The calculation is as follows:<br />;Target = (Sum of Sources) / #Sources<br />Method PointConstraint.Update, uses ebx edi esi<br />? ? SetObject esi<br />? ? fldz<br />? ? xor edi, edi<br />? ? fldz<br />? ? mov ebx, .PointConstraintSourcePoints<br />? ? fldz<br /><br />? ? .while edi &lt; .DwordCollection.dCount<br />? ? ? OCall ebx::DwordCollection.ItemAt, edi<br />? ? ? fld .Vec3.X<br />? ? ? faddp st(1), st(0)<br />? ? ? fld .Vec3.y<br />? ? ? faddp st(2), st(0)<br />? ? ? inc edi<br />? ? ? fld .Vec3.z<br />? ? ? faddp st(3), st(0)<br />? ? .endw<br />? ? fild .DwordCollection.dCount<br />? ? fdiv st(1), st(0)? ?<br />? ? fdiv st(2), st(0)? ?<br />? ? fdivp st(3), st(0)? ?<br /><br />? ? mov edi, .pTargetPoint <br />? ? fstp .Vec3.X<br />? ? fstp .Vec3.y<br />? ? fstp .Vec3.z<br />MethodEnd</code></pre><br /><br />Regards,<br /><br />Biterider</div>
    <div class="meta">Posted on 2005-07-20 15:49:36 by Biterider</div>
   </div>
   <div class="post" id="post-162242">
    <div class="subject"><a href="#post-162242">Re: PointConstraint (N Sources)</a></div>
    <div class="body">And a little more optimized, yet not tested :<br /><pre><code><br />Method PointConstraint.Update, uses ebx edi esi<br />&nbsp; &nbsp; SetObject esi<br />&nbsp; &nbsp; fldz<br />&nbsp; &nbsp; xor edi, edi<br />&nbsp; &nbsp; fldz<br />&nbsp; &nbsp; mov ebx, .PointConstraintSourcePoints<br />&nbsp; &nbsp; fldz<br />&nbsp; &nbsp; fld1<br />&nbsp; &nbsp; fidiv .DwordCollection.dCount<br /><br />&nbsp; &nbsp; .while edi &lt; .DwordCollection.dCount<br />&nbsp; &nbsp; &nbsp; OCall ebx::DwordCollection.ItemAt, edi<br />&nbsp; &nbsp; &nbsp; fld .Vec3.X<br />&nbsp; &nbsp; &nbsp; faddp st(2), st(0)<br />&nbsp; &nbsp; &nbsp; fld .Vec3.y<br />&nbsp; &nbsp; &nbsp; faddp st(3), st(0)<br />&nbsp; &nbsp; &nbsp; inc edi<br />&nbsp; &nbsp; &nbsp; fld .Vec3.z<br />&nbsp; &nbsp; &nbsp; faddp st(4), st(0)<br />&nbsp; &nbsp; .endw<br />&nbsp; &nbsp; fmul st(1), st(0)&nbsp;  <br />&nbsp; &nbsp; fmul st(2), st(0)&nbsp;  <br />&nbsp; &nbsp; mov edi, .pTargetPoint<br />&nbsp; &nbsp; fmulp st(3), st(0)&nbsp;  <br /><br />&nbsp; &nbsp; <br />&nbsp; &nbsp; fstp .Vec3.X<br />&nbsp; &nbsp; fstp .Vec3.y<br />&nbsp; &nbsp; fstp .Vec3.z<br />MethodEnd<br /></code></pre><br />I think &quot;OCall ebx::DwordCollection.ItemAt, edi&quot;&nbsp; should be replaced for further optimization</div>
    <div class="meta">Posted on 2005-07-20 18:30:57 by Ultrano</div>
   </div>
   <div class="post" id="post-162257">
    <div class="subject"><a href="#post-162257">Re: PointConstraint (N Sources)</a></div>
    <div class="body">Hi<br />Good idea Ultrano. Knowing that the items of any collection are stored in a linear memory block without gaps, the code can be rewritten as follows:<br /><br /><pre><code>Method PointConstraint.Update, uses ebx edi esi<br />&nbsp; &nbsp; SetObject esi<br />&nbsp; &nbsp; fldz<br />&nbsp; &nbsp; xor edi, edi<br />&nbsp; &nbsp; fldz<br />&nbsp; &nbsp; mov ebx, .PointConstraintSourcePoints<br />&nbsp; &nbsp; fldz<br />&nbsp; &nbsp; fld1<br />&nbsp; &nbsp; fidiv .DwordCollection.dCount<br /><br />&nbsp; &nbsp; lea eax, .DwordCollection.pItems<br />&nbsp; &nbsp; .while edi &lt; .DwordCollection.dCount<br />&nbsp; &nbsp; &nbsp; fld .Vec3.x<br />&nbsp; &nbsp; &nbsp; faddp st(2), st(0)<br />&nbsp; &nbsp; &nbsp; fld .Vec3.y<br />&nbsp; &nbsp; &nbsp; faddp st(3), st(0)<br />&nbsp; &nbsp; &nbsp; inc edi<br />&nbsp; &nbsp; &nbsp; fld .Vec3.z<br />&nbsp; &nbsp; &nbsp; add eax, 4<br />&nbsp; &nbsp; &nbsp; faddp st(4), st(0)<br />&nbsp; &nbsp; .endw<br />&nbsp; &nbsp; fmul st(1), st(0)&nbsp;  <br />&nbsp; &nbsp; fmul st(2), st(0)&nbsp;  <br />&nbsp; &nbsp; mov edi, .pTargetPoint<br />&nbsp; &nbsp; fmulp st(3), st(0)&nbsp;  <br />&nbsp; &nbsp; <br />&nbsp; &nbsp; fstp .Vec3.x<br />&nbsp; &nbsp; fstp .Vec3.y<br />&nbsp; &nbsp; fstp .Vec3.z<br />MethodEnd</code></pre><br /><br />Biterider</div>
    <div class="meta">Posted on 2005-07-21 00:17:00 by Biterider</div>
   </div>
   <div class="post" id="post-162259">
    <div class="subject"><a href="#post-162259">Re: PointConstraint (N Sources)</a></div>
    <div class="body">Good stuff :)<br />I&#39;d like to expand this topic to cover more complex constraints shortly, and I&#39;ve found precious little information regarding implementations :(<br /><br />I&#39;m interested particularly in Joint Constraints, including but not limited to the following:<br />-Simple Rotation Constraints, including nDOF joints such as Ball and Hinge<br />-Complex Rotation Constraints, including Aim (orientation) Constraint<br />-Non-Commutative association constraints, eg, rotation of jetplane landing gear is constrained to the 3D Y position of the jetplane, so it automatically retracts on takeoff, etc.<br /><br /><br />Do you think I&#39;m handling N-source point constraints correctly?<br />Am I doing it backwards?<br /></div>
    <div class="meta">Posted on 2005-07-21 00:33:21 by Homer</div>
   </div>
   <div class="post" id="post-162260">
    <div class="subject"><a href="#post-162260">Re: PointConstraint (N Sources)</a></div>
    <div class="body">Non-commutative constraints require a Type field.<br />The constraint needs to know the following information regarding Source and Target objects:<br />-constrainor data type<br />-constrainor data range<br />-constrainee data type<br />-constrainee data range<br /><br />Let&#39;s go with the example I gave in the previous post.<br />We have some landing gear on a jetplane.<br />Let&#39;s keep it simple.<br />Let&#39;s assume that this Constraint can only have a single Source of known Type.<br />Let&#39;s assume theres a single axial hinged joint to extend and retract the landing gear<br />Let&#39;s assume that at 0 degrees, it&#39;s fully retracted, and at 120 degrees, its fully extended.<br />Now for that Y constraint.<br />Let&#39;s assume that at Y=5, the jetplane is on the runway, its landing gear at 120 degrees.<br />Furthermore, that at Y=20+, the landing gear is at 0 degrees.<br />We are constraining a float to another float here, it&#39;s not too hard to implement..<br />We can get away with simple interpolation, if we apply the LIMITS first.<br />If Y&lt;YMin, Y=YMin<br />If Y&gt;YMax, Y=YMax<br />Now we can calculate the &quot;completion ratio&quot; of current Y value, and apply it to the Angular Range to produce a value that is rationally equivalent.<br />How would YOU do it?<br /></div>
    <div class="meta">Posted on 2005-07-21 00:55:06 by Homer</div>
   </div>
  </div>
 </body>
</html>