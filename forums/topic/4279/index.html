<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>calculating normals - complete - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=4279" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=4279">calculating normals - complete</a></p>
   <div class="post" id="post-29594">
    <div class="subject"><a href="#post-29594">calculating normals - complete</a></div>
    <div class="body">hello!<br /><br />i've written a procedure and i'd like to ask how you would improve it...? <br /><br />it takes a pointer to an array of at least 3 source Vertices and a pointer to a single target vertex.<br /><br />for example <br /><br />asm_normal(&amp;SourceV[0], &amp;TargetV);<br /><br /><br /><br />here's the procedure:<br /><br /><pre><code><br /> asm_normal PROC uses ecx psrcVArr&#58;DWORD, ptrgV&#58;DWORD          ;  gets source VertexArray&#91;4&#93; and dest Vertex<br /><br />  <br />     mov    ecx, &#91;psrcVArr&#93;<br />     fld    DWORD PTR &#91;ecx&#93;                  ; st&#40;0&#41; = V&#91;0&#93;.x<br />     fsub   DWORD PTR &#91;ecx + 12&#93;             ; st&#40;0&#41; = V&#91;0&#93;.x - V&#91;1&#93;.x<br />     fld    DWORD PTR &#91;ecx + 4&#93;              ; st&#40;0&#41; = V&#91;0&#93;.y<br />     fsub   DWORD PTR &#91;ecx + 12 + 4&#93;         ; st&#40;0&#41; = V&#91;0&#93;.y - V&#91;1&#93;.y<br />     fld    DWORD PTR &#91;ecx + 8&#93;              ; st&#40;0&#41; = V&#91;0&#93;.z<br />     fsub   DWORD PTR &#91;ecx + 12 + 8&#93;         ; st&#40;0&#41; = V&#91;0&#93;.z - V&#91;1&#93;.z<br />     add    ecx, 12<br />     fld    DWORD PTR &#91;ecx&#93;                  ; st&#40;0&#41; = V&#91;1&#93;.x<br />     fsub   DWORD PTR &#91;ecx + 12&#93;             ; st&#40;0&#41; = V&#91;1&#93;.x - V&#91;2&#93;.x<br />     fld    DWORD PTR &#91;ecx + 4&#93;              ; st&#40;0&#41; = V&#91;1&#93;.y<br />     fsub   DWORD PTR &#91;ecx + 12 + 4&#93;         ; st&#40;0&#41; = V&#91;1&#93;.y - V&#91;2&#93;.y<br />     fld    DWORD PTR &#91;ecx + 8&#93;              ; st&#40;0&#41; = V&#91;1&#93;.z<br />     fsub   DWORD PTR &#91;ecx + 12 + 8&#93;         ; st&#40;0&#41; = V&#91;1&#93;.z - V&#91;2&#93;.z<br /><br />     mov    ecx, &#91;ptrgV&#93;     <br />     fld    st&#40;4&#41;                               ; st&#40;0&#41; = temp&#91;0&#93;.y<br />     fmul   st, st&#40;1&#41;                        ; st&#40;0&#41; = temp&#91;0&#93;.y*temp&#91;1&#93;.z<br />     fld    st&#40;4&#41;                               ; st&#40;0&#41; = temp&#91;0&#93;.z<br />     fmul   st, st&#40;3&#41;                        ; st&#40;0&#41; = temp&#91;0&#93;.z * temp&#91;1&#93;.y<br />     fsubp  st&#40;1&#41;, st                        ; st&#40;0&#41; = temp&#91;0&#93;.y*temp&#91;1&#93;.z-temp&#91;0&#93;.z * temp&#91;1&#93;.y<br />     fstp   DWORD PTR &#91;ecx&#93;<br /><br />     fld    st&#40;3&#41;<br />     fmul   st, st&#40;3&#41;<br />     fld    st&#40;6&#41;<br />     fmul   st, st&#40;2&#41;<br />     fsubp  st&#40;1&#41;, st<br />     fstp   DWORD PTR &#91;ecx + 4&#93;<br /><br />     fld    st&#40;5&#41;<br />     fmul   st, st&#40;2&#41;                      <br />     fld    st&#40;5&#41;<br />     fmul   st, st&#40;4&#41;<br />     fsubp  st&#40;1&#41;, st<br />     fstp   DWORD PTR &#91;ecx + 8&#93;<br /><br />     mov    ecx, 6                  ;  maybe FINIT would be better?<br />    @@&#58;<br />     fstp    st&#40;0&#41;<br />     dec     ecx<br />     jnz     @B<br />     <br />     mov    ecx, &#91;ptrgV&#93;<br />     fld    DWORD PTR &#91;ecx&#93;<br />     fld    DWORD PTR &#91;ecx + 4&#93;<br />     fld    DWORD PTR &#91;ecx + 8&#93;<br />     fld    st&#40;2&#41;<br />     fmul   st, st           ; x?<br />     fld    st&#40;2&#41;<br />     fmul   st, st           ; y?<br />     fld    st&#40;2&#41; <br />     fmul   st, st           ; z?<br />     faddp  st&#40;1&#41;, st        ; st&#40;0&#41; = z?+y?        <br />     faddp  st&#40;1&#41;, st        ; st&#40;0&#41; = &#40;z?+y?&#41;+x?<br />     fsqrt<br /><br />     fdiv   st&#40;3&#41;, st        ; x?/l<br />     fdiv   st&#40;2&#41;, st        ; y?/l<br />     fdivp  st&#40;1&#41;, st        ; z?/l<br />     fstp   DWORD PTR &#91;ecx + 8&#93;<br />     fstp   DWORD PTR &#91;ecx + 4&#93;<br />     fstp   DWORD PTR &#91;ecx&#93;<br /><br />    ret     <br /> asm_normal ENDP<br /></code></pre> <br /><br /><br />there are some points where i'm not sure what's the best to do, one is the loop that pops the FPU-registers away.<br />the algorithm itself isn't optimized as you will probably see...well.<br /><br />thanks for any helpful reaction</div>
    <div class="meta">Posted on 2002-03-17 13:59:22 by 08/15</div>
   </div>
   <div class="post" id="post-29600">
    <div class="subject"><a href="#post-29600">calculating normals - complete</a></div>
    <div class="body">ffreep st(3)<br />ffreep st(3)<br />ffreep st(3)<br />; three values popped from FPU stack,<br />; and top three FPU values are empty<br /><br />fcompp<br />fcompp<br />fcompp<br />; this pops all six values, but the above is faster</div>
    <div class="meta">Posted on 2002-03-17 15:45:46 by bitRAKE</div>
   </div>
   <div class="post" id="post-29620">
    <div class="subject"><a href="#post-29620">calculating normals - complete</a></div>
    <div class="body">thank you bitrake...<br /><br />one problem remains: can't find FFREEP in the docs and MASM gives an error when i try to assemble it.;)<br />it just sets the register to empty, it doesn't affect the TOS-pointer.<br />i tried using FFREE, but it ends up just like FSTP, i have to do it 6 times.</div>
    <div class="meta">Posted on 2002-03-17 16:48:52 by 08/15</div>
   </div>
   <div class="post" id="post-29625">
    <div class="subject"><a href="#post-29625">calculating normals - complete</a></div>
    <div class="body">FFREEP instruction is supported on Pentium processors and above, but MASM doesn't support it and it is not documented by Intel. It works. :)<br /><br /><a target="_blank" href="http://www.geocities.com/SiliconValley/Heights/1295/nasmdoca.htm#section-A.55">http://www.geocities.com/SiliconValley/Heights/1295/nasmdoca.htm#section-A.55</a><br /><a target="_blank" href="http://fatphil.org/x86/pentopt/29.html">http://fatphil.org/x86/pentopt/29.html</a><br /><br /><strong>HEX</strong>: DF C0+reg</div>
    <div class="meta">Posted on 2002-03-17 17:03:09 by bitRAKE</div>
   </div>
   <div class="post" id="post-29627">
    <div class="subject"><a href="#post-29627">calculating normals - complete</a></div>
    <div class="body">You can improve he final bit by first dividing 1 by (z?+y?)+x? then multiplying the x,y &amp; z by this. It's faster because division is very slow compared to multiplication. I always use the following MACRO to normalise the top three values on the FPU stack:<br /><pre><code>Normalise Macro<br />	fld st<br />	fmul st, st<br />	fld st&#40;2&#41;<br />	fmul st, st<br />	fadd<br />	fld st&#40;3&#41;<br />	fmul st, st<br />	fadd<br />	fsqrt<br />	fdivr fpc&#40;1.0&#41;<br />	fmul st&#40;3&#41;, st<br />	fmul st&#40;2&#41;, st<br />	fmul<br />EndM</code></pre> eg:<br /><pre><code>     mov    ecx, &#91;ptrgV&#93;<br />     fld    DWORD PTR &#91;ecx&#93;<br />     fld    DWORD PTR &#91;ecx + 4&#93;<br />     fld    DWORD PTR &#91;ecx + 8&#93;<br />     &#91;COLOR=darkred&#93;Normalise&#91;/COLOR&#93; <br />     fstp   DWORD PTR &#91;ecx + 8&#93;<br />     fstp   DWORD PTR &#91;ecx + 4&#93;<br />     fstp   DWORD PTR &#91;ecx&#93;<br /></code></pre></div>
    <div class="meta">Posted on 2002-03-17 17:09:46 by Eóin</div>
   </div>
   <div class="post" id="post-29630">
    <div class="subject"><a href="#post-29630">calculating normals - complete</a></div>
    <div class="body">hey :grin:, thank you. <br /><br />seems like you really know what you're doing<br /><br /><br /><br />fpc(1.0) is another macro, right?</div>
    <div class="meta">Posted on 2002-03-17 17:14:42 by 08/15</div>
   </div>
   <div class="post" id="post-29642">
    <div class="subject"><a href="#post-29642">calculating normals - complete</a></div>
    <div class="body">works perfectly, eoin! thx<br /><br />i do a FLD1 before FDIVRP to go around the fpc(1.0)<br /><br /><br /><br />bitrake, <br /><br />FFREE st(3) becomes DD C3, and as stated on the website you gave, FFREEP st(3) should be DF C3.<br /><br />so, i assembled, opened the *.obj and fixed the three DD C3 values (simply used FFREE to make space for FFREEP in the binary) to DF C3.<br /><br />when i run ollydbg and the first DF C3 is executed, it says &quot;unknown instruction&quot;. <br />now i'm really confused...<br /><br />do you know why that is?</div>
    <div class="meta">Posted on 2002-03-17 17:54:16 by 08/15</div>
   </div>
   <div class="post" id="post-29704">
    <div class="subject"><a href="#post-29704">calculating normals - complete</a></div>
    <div class="body">wow, 3 in a row;) <br /><br />here's the fasterFDIVR/FMUL version:<br />(without macro, though)<br /><br />FFREEP doesn't work yet.<br /><br /><pre><code><br /> asm_normal PROC uses ecx psrcVArr&#58;DWORD, ptrgV&#58;DWORD          ;  gets source VertexArray&#91;4&#93; and dest Vertex<br /><br />     mov    ecx, &#91;psrcVArr&#93;<br />     fld    DWORD PTR &#91;ecx&#93;                  ; st&#40;0&#41; = V&#91;0&#93;.x<br />     fsub   DWORD PTR &#91;ecx + 12&#93;             ; st&#40;0&#41; = V&#91;0&#93;.x - V&#91;1&#93;.x<br />     fld    DWORD PTR &#91;ecx + 4&#93;              ; st&#40;0&#41; = V&#91;0&#93;.y<br />     fsub   DWORD PTR &#91;ecx + 12 + 4&#93;         ; st&#40;0&#41; = V&#91;0&#93;.y - V&#91;1&#93;.y<br />     fld    DWORD PTR &#91;ecx + 8&#93;              ; st&#40;0&#41; = V&#91;0&#93;.z<br />     fsub   DWORD PTR &#91;ecx + 12 + 8&#93;         ; st&#40;0&#41; = V&#91;0&#93;.z - V&#91;1&#93;.z<br />     add    ecx, 12<br />     fld    DWORD PTR &#91;ecx&#93;                  ; st&#40;0&#41; = V&#91;1&#93;.x<br />     fsub   DWORD PTR &#91;ecx + 12&#93;             ; st&#40;0&#41; = V&#91;1&#93;.x - V&#91;2&#93;.x<br />     fld    DWORD PTR &#91;ecx + 4&#93;              ; st&#40;0&#41; = V&#91;1&#93;.y<br />     fsub   DWORD PTR &#91;ecx + 12 + 4&#93;         ; st&#40;0&#41; = V&#91;1&#93;.y - V&#91;2&#93;.y<br />     fld    DWORD PTR &#91;ecx + 8&#93;              ; st&#40;0&#41; = V&#91;1&#93;.z<br />     fsub   DWORD PTR &#91;ecx + 12 + 8&#93;         ; st&#40;0&#41; = V&#91;1&#93;.z - V&#91;2&#93;.z<br /><br />     mov    ecx, &#91;ptrgV&#93;     <br />     fld    st&#40;4&#41;                            ; st&#40;0&#41; = temp&#91;0&#93;.y<br />     fmul   st, st&#40;1&#41;                        ; st&#40;0&#41; = temp&#91;0&#93;.y*temp&#91;1&#93;.z<br />     fld    st&#40;4&#41;                            ; st&#40;0&#41; = temp&#91;0&#93;.z<br />     fmul   st, st&#40;3&#41;                        ; st&#40;0&#41; = temp&#91;0&#93;.z * temp&#91;1&#93;.y<br />     fsubp  st&#40;1&#41;, st                        ; st&#40;0&#41; = temp&#91;0&#93;.y*temp&#91;1&#93;.z-temp&#91;0&#93;.z * temp&#91;1&#93;.y<br />     fstp   DWORD PTR &#91;ecx&#93;<br />     fld    st&#40;3&#41;<br />     fmul   st, st&#40;3&#41;<br />     fld    st&#40;6&#41;<br />     fmul   st, st&#40;2&#41;<br />     fsubp  st&#40;1&#41;, st<br />     fstp   DWORD PTR &#91;ecx + 4&#93;<br />     fld    st&#40;5&#41;<br />     fmul   st, st&#40;2&#41;                      <br />     fld    st&#40;5&#41;<br />     fmul   st, st&#40;4&#41;<br />     fsubp  st&#40;1&#41;, st<br />     fstp   DWORD PTR &#91;ecx + 8&#93;<br /><br />     mov    ecx, 6     ; replace with 3x FFREEP ST&#40;3&#41; &#40;in HEX!!! MASM won't do it - PII and above&#41;<br />     @@&#58;<br />      fstp    st&#40;0&#41;<br />      dec     ecx<br />      jnz     @B<br /><br />;     ffree st&#40;3&#41;           &lt;-- hex&#58; DD C3; when changed to DF C3 &#40;FFREEP st&#40;3&#41;&#41;<br />;     ffree st&#40;3&#41;                           it doesn't recognize the instruction<br />;     ffree st&#40;3&#41;                           <br />    <br />     mov    ecx, &#91;ptrgV&#93;<br />     fld    DWORD PTR &#91;ecx&#93;<br />     fld    DWORD PTR &#91;ecx + 4&#93;<br />     fld    DWORD PTR &#91;ecx + 8&#93;<br />     fld    st&#40;2&#41;<br />     fmul   st, st           ; x?<br />     fld    st&#40;2&#41;<br />     fmul   st, st           ; y?<br />     fld    st&#40;2&#41; <br />     fmul   st, st           ; z?<br />     faddp  st&#40;1&#41;, st        ; st&#40;0&#41; = z?+y?        <br />     faddp  st&#40;1&#41;, st        ; st&#40;0&#41; = &#40;z?+y?&#41;+x?<br />     fsqrt<br /><br />     fld1<br />     fdivrp st&#40;1&#41;, st<br />     fmul   st&#40;3&#41;, st        ; x?/l<br />     fmul   st&#40;2&#41;, st        ; y?/l<br />     fmulp  st&#40;1&#41;, st        ; z?/l<br /><br />     fstp   DWORD PTR &#91;ecx + 8&#93;<br />     fstp   DWORD PTR &#91;ecx + 4&#93;<br />     fstp   DWORD PTR &#91;ecx&#93;<br /><br />    ret     <br /> asm_normal ENDP<br /></code></pre></div>
    <div class="meta">Posted on 2002-03-18 03:33:38 by 08/15</div>
   </div>
   <div class="post" id="post-29733">
    <div class="subject"><a href="#post-29733">calculating normals - complete</a></div>
    <div class="body">First bitRAKE, that freep comand is interesting, I've never heard of it before. I always went by Anger Fog who said fspt st is the fastest way to free the TOS, while fcompp is the fastest way to free two values. But this freep seems more useful altogether.<br /><br />Second 08/15, you can avoid freeing the stack by using the values in it throughout the middle calculation. From what I gather the stack at the start of the calculation starts at<br />0: z1-z2, call it zb<br />1: y1-y2, call it yb<br />2: x1-x2, call it xb<br />3: z0-z1, call it za<br />4: y0-y1, call it ya<br />5: x0-x1, call it xa<br /><br /><br />And you want to calculate:<br />ya*zb-za*yb<br />za*xb-zb*xa<br />xa*yb-xb*ya <br /><br />Since all the values in the first equation are needed by the other two your code is the fastest way to work it:<pre><code>mov    ecx, &#91;ptrgV&#93;     <br />fld    st&#40;4&#41;                            ; st&#40;0&#41; = temp&#91;0&#93;.y<br />fmul   st, st&#40;1&#41;                        ; st&#40;0&#41; = temp&#91;0&#93;.y*temp&#91;1&#93;.z<br />fld    st&#40;4&#41;                            ; st&#40;0&#41; = temp&#91;0&#93;.z<br />fmul   st, st&#40;3&#41;                        ; st&#40;0&#41; = temp&#91;0&#93;.z * temp&#91;1&#93;.y<br />fsubp  st&#40;1&#41;, st                        ; st&#40;0&#41; = temp&#91;0&#93;.y*temp&#91;1&#93;.z-temp&#91;0&#93;.z * temp&#91;1&#93;.y<br />fstp   DWORD PTR &#91;ecx&#93;<br /></code></pre> Now however the third equation doesn't use za/b at all, so we might as well overwrite in the calculation of the second equation.<pre><code>fmul st,st&#40;5&#41;  ; st0 = zb*xa<br />fxch st&#40;3&#41;<br />fmul st,st&#40;2&#41;  ;  st0 = za*xb<br />fsubrp st&#40;3&#41;,st  ; st&#40;2&#41; = za*xb-zb*xa</code></pre>Now at this stage the result we want is stuck at st(2) so we cant store it, but never mind. Continue on calculating the third equation and the second value will be freed eventually.<pre><code>fmulp st&#40;4&#41;,st  ; st&#40;3&#41; = xa*yb<br />fmulp st&#40;2&#41;,st  ; st&#40;1&#41; = xb*ya</code></pre> <br />Now the result to the second equation is at st(0) so store it<pre><code>fstp   DWORD PTR &#91;ecx + 4&#93;</code></pre> <br />And finish af the third equation<pre><code>fsub ; st&#40;0&#41; = xa*yb-ya*xb<br />fstp   DWORD PTR &#91;ecx + 8&#93;<br /></code></pre> And you can forget about freeing the values now as theres nothing left on the stack. Note I haven't tested this so sorry if it doesn't work.</div>
    <div class="meta">Posted on 2002-03-18 07:05:09 by Eóin</div>
   </div>
   <div class="post" id="post-29924">
    <div class="subject"><a href="#post-29924">calculating normals - complete</a></div>
    <div class="body">thank you very much eoin, i haven't tried yet because i was very busy.<br /><br />btw, did you actually try to use this FFREEP instructions?<br />did it work?<br /><br />just curious...<br /><br />:confused:</div>
    <div class="meta">Posted on 2002-03-19 12:50:04 by 08/15</div>
   </div>
   <div class="post" id="post-30026">
    <div class="subject"><a href="#post-30026">calculating normals - complete</a></div>
    <div class="body">No I haven't had a chance yet, I won't get to my computer till thursday. :(</div>
    <div class="meta">Posted on 2002-03-20 03:17:25 by Eóin</div>
   </div>
   <div class="post" id="post-30061">
    <div class="subject"><a href="#post-30061">calculating normals - complete</a></div>
    <div class="body"><div class="quote"><br />btw, did you actually try to use this FFREEP instructions?<br />did it work?</div>What processor are you using?<br />Did you try using it outside the debugger?<br />Encode the instruction inline:<br /><br />db 0DFh, 0C3h ; FFREEP st(3)<br />db 0DFh, 0C3h ; FFREEP st(3)<br />db 0DFh, 0C3h ; FFREEP st(3)<br /><br />MASM will allow this in a code section.</div>
    <div class="meta">Posted on 2002-03-20 10:12:24 by bitRAKE</div>
   </div>
   <div class="post" id="post-30066">
    <div class="subject"><a href="#post-30066">calculating normals - complete</a></div>
    <div class="body">333 celeron...<br /><br />i'll try to do it inline like you suggested<br /><br />thanx for helping again, bitrake<br />:)</div>
    <div class="meta">Posted on 2002-03-20 10:51:29 by 08/15</div>
   </div>
   <div class="post" id="post-30067">
    <div class="subject"><a href="#post-30067">calculating normals - complete</a></div>
    <div class="body">:grin: <br />how could i doubt that<br /><br />you're certainly right, this command exists and it works very well.<br />i was really confused about the message in OllyDebug, it felt like walking on thin ice without being able to test in the debugger first, but it worx.<br /><br />now i'll go and look for an olly-update <br /><br />you made my day with the inline stuff.<br />i guess the hex-edit works too. too dumb i never tried to just run it...well, have a nice day!<br /><br /><br /><br /><br />just dl'ed OllyDebug v1.06 (had 1.05 step 1 before), no difference. <br />undocumented and obviously unrecognized.;)<br /><br /><br /><br />eoins method of optimizing the algo itself is of course the better solution, just to make it clear. <br />though, FFREEP may be useful in other cases, and i really appreciate to know it now. cheers</div>
    <div class="meta">Posted on 2002-03-20 11:22:19 by 08/15</div>
   </div>
   <div class="post" id="post-30665">
    <div class="subject"><a href="#post-30665">calculating normals - complete</a></div>
    <div class="body">finally, i sat down and did some optimizing<br /><br />there's actually no need to free the stack as i did before, and i removed the save to memory/load from memory stuff which was really dumb.<br /><br />this is the result:<br /><br /><pre><code><br /><br />asm_normal PROC uses ecx psrcVArr&#58;DWORD, ptrgV&#58;DWORD          ;  gets source VertexArray&#91;4&#93; and dest Vertex<br /><br />     mov    ecx, &#91;psrcVArr&#93;<br />     fld    DWORD PTR &#91;ecx&#93;                  ; st&#40;0&#41; = V&#91;0&#93;.x<br />     fsub   DWORD PTR &#91;ecx + 12&#93;             ; st&#40;0&#41; = V&#91;0&#93;.x - V&#91;1&#93;.x<br />     fld    DWORD PTR &#91;ecx + 4&#93;              ; st&#40;0&#41; = V&#91;0&#93;.y<br />     fsub   DWORD PTR &#91;ecx + 12 + 4&#93;         ; st&#40;0&#41; = V&#91;0&#93;.y - V&#91;1&#93;.y<br />     fld    DWORD PTR &#91;ecx + 8&#93;              ; st&#40;0&#41; = V&#91;0&#93;.z<br />     fsub   DWORD PTR &#91;ecx + 12 + 8&#93;         ; st&#40;0&#41; = V&#91;0&#93;.z - V&#91;1&#93;.z<br />     add    ecx, 12<br />     fld    DWORD PTR &#91;ecx&#93;                  ; st&#40;0&#41; = V&#91;1&#93;.x<br />     fsub   DWORD PTR &#91;ecx + 12&#93;             ; st&#40;0&#41; = V&#91;1&#93;.x - V&#91;2&#93;.x<br />     fld    DWORD PTR &#91;ecx + 4&#93;              ; st&#40;0&#41; = V&#91;1&#93;.y<br />     fsub   DWORD PTR &#91;ecx + 12 + 4&#93;         ; st&#40;0&#41; = V&#91;1&#93;.y - V&#91;2&#93;.y<br />     fld    DWORD PTR &#91;ecx + 8&#93;              ; st&#40;0&#41; = V&#91;1&#93;.z<br />     fsub   DWORD PTR &#91;ecx + 12 + 8&#93;         ; st&#40;0&#41; = V&#91;1&#93;.z - V&#91;2&#93;.z<br /><br />     fld    st&#40;4&#41;                            ; st&#40;0&#41; = temp&#91;0&#93;.y<br />     fmul   st, st&#40;1&#41;                        ; st&#40;0&#41; = temp&#91;0&#93;.y*temp&#91;1&#93;.z<br />     fld    st&#40;4&#41;                            ; st&#40;0&#41; = temp&#91;0&#93;.z<br />     fmul   st, st&#40;3&#41;                        ; st&#40;0&#41; = temp&#91;0&#93;.z * temp&#91;1&#93;.y<br />     fsubp  st&#40;1&#41;, st                        ; st&#40;0&#41; = temp&#91;0&#93;.y*temp&#91;1&#93;.z-temp&#91;0&#93;.z * temp&#91;1&#93;.y<br />     fstp   st&#40;7&#41;                            ; make it last element<br /><br />     fxch   <br />     fmul   st, st&#40;5&#41;                      <br />     fxch<br />     fxch   st&#40;4&#41;<br />     fmul   st, st&#40;2&#41;<br />     fsubp  st&#40;1&#41;, st                       ; st&#40;0&#41; = temp&#91;0&#93;.x*temp&#91;1&#93;.y-temp&#91;0&#93;.y * temp&#91;1&#93;.x<br />     fstp   st&#40;6&#41;                           ; make it last element<br /><br />     fmulp  st&#40;1&#41;, st<br />     fxch   <br />     fmulp  st&#40;2&#41;, st<br />     fsubrp st&#40;1&#41;, st <br />   <br />     fld    st&#40;2&#41;<br />     fmul   st, st           ; z?<br />     fld    st&#40;2&#41;<br />     fmul   st, st           ; x?<br />     fld    st&#40;2&#41; <br />     fmul   st, st           ; y?<br />     faddp  st&#40;1&#41;, st        ; st&#40;0&#41; = x?+y?        <br />     faddp  st&#40;1&#41;, st        ; st&#40;0&#41; = &#40;x?+y?&#41;+z?<br />     fsqrt                   ; st&#40;0&#41; = l<br /><br />     fld1<br />     fdivrp st&#40;1&#41;, st        ; st&#40;0&#41; = 1/l<br />     fmul   st&#40;3&#41;, st        ; z?/l<br />     fmul   st&#40;2&#41;, st        ; x?/l<br />     fmulp  st&#40;1&#41;, st        ; y?/l<br />     fxch <br />     <br />     mov    ecx, &#91;ptrgV&#93;     <br />     fstp   DWORD PTR &#91;ecx&#93;<br />     fstp   DWORD PTR &#91;ecx + 4&#93;<br />     fstp   DWORD PTR &#91;ecx + 8&#93;<br /><br />    ret     <br /> asm_normal ENDP<br /></code></pre><br /><br />maybe it's more useful now</div>
    <div class="meta">Posted on 2002-03-24 17:15:20 by 08/15</div>
   </div>
  </div>
 </body>
</html>