<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>calling convention &amp; ss0:esp0 from tss - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=14281" />
  <link rel="prev" href="../?id=14281&amp;page=1" />   </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=34">OS Development</a> &raquo; <a href="../?id=14281">calling convention &amp; ss0:esp0 from tss</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=14281&amp;page=1" style="">&laquo;</a><a href="../?id=14281&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="14281" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>   <div class="post" id="post-111261">
    <div class="subject"><a href="#post-111261">calling convention &amp; ss0:esp0 from tss</a></div>
    <div class="body">But you don't need to put any extra bytes on the stack manually with the code above.<br />From user code, you would do this:<br />mov al,funcnumber<br />int 0x30<br /><br />And from system code:<br />call function<br /><br />If you would like to use eax as a parameter, you could have the interrupt handler be like this instead:<br />push ebp<br />mov ebp,esp<br />mov esp,<br />call l0<br />mov ,esp<br />leave<br />pop eax<br />iretd<br />l0:<br />push eax<br />push es<br />mov eax,<br />mov es,ax<br />mov eax,<br />movzx eax,byte es:<br />inc dword <br />pop es<br />mov eax,<br />xchg eax,<br />ret<br /><br />This would be called in the following way from user code:<br />int 0x30<br />db funcnumber</div>
    <div class="meta">Posted on 2003-07-20 07:29:44 by Sephiroth3</div>
   </div>
   <div class="post" id="post-111264">
    <div class="subject"><a href="#post-111264">calling convention &amp; ss0:esp0 from tss</a></div>
    <div class="body"><div class="quote"><br />But you don't need to put any extra bytes on the stack manually with the code above.<br />From user code, you would do this:<br />mov al,funcnumber<br />int 0x30<br /><br />And from system code:<br />call function<br /></div><br />no, i can't do it like that - thats the problem i'm thinking about all the time. the int 0x30-call from ring0 puts eflags, cs, eip on the stack (12 bytes), a call function just eip (4 bytes), a int 0x30-call from ring3 even ss3, esp3, eflags, cs, eip - and switches the stacks. if i have parameters the would be once at esp+16 (when i preserve ebp) and once at esp+8 and once even somewhere else - the function doesn't know. furthermore: what if i have an external ring0 code - it can't call the function directly. but um... <strong>is there still a possibility?</strong><br /><br />using eax as function number seems no problem to me. the <strong>mov al,funcNo</strong>-instruction just needs 2 bytes. eax is &quot;trashed&quot;  for the returnvalue anyway. but that's still a nice idea.<br /><br />this is the code i'm using currently - i up to know i couldn't test it for ring3 since there are just ring0-things in my code now :):<br /><pre><code><br />syscall_handler_new&#58;<br />  cmp al,NUM_SYSCALLs<br />  jge syscall_handler.end<br />    sti ;&#91;b&#93;why is the interrupt-flag cleared when i call the interrupt?&#91;/b&#93;<br />    movzx eax,al<br />    test word &#91;esp+4&#93;,0x0003 ;check cs for dpl<br />    jnz @f ;ring3?<br />      call dword &#91;syscall_table_new+eax*4&#93;<br />      jmp syscall_handler.end<br />    @@&#58;<br />    push ecx<br />    push edx ;push on ring0-stack<br />    xor ebx,ebx<br />    mov bx,ss<br />    mov ecx,esp<br />    mov dx,&#91;esp+16&#93; ;ss3 &#40;from taskswitch&#41;<br />    mov esp,&#91;esp+12&#93; ;esp3<br />    mov ss,dx ;now on ring3-stack<br />    push ebx ;save ring0-stack-pointer<br />    push ecx<br />    sub esp,4 ;redundant dword<br />    call dword &#91;syscall_table+eax*4&#93; ;work on ring3-stack!<br />    add esp,4 <br />    pop ecx<br />    pop ss<br />    mov esp,ecx ;back on ring0-stack<br />    pop edx<br />    pop ecx<br />syscall_handler.end&#58;<br />  iret<br /></code></pre></div>
    <div class="meta">Posted on 2003-07-20 08:57:09 by hartyl</div>
   </div>
   <div class="post" id="post-111287">
    <div class="subject"><a href="#post-111287">calling convention &amp; ss0:esp0 from tss</a></div>
    <div class="body">But since it calls it on the Ring 3 stack, the parameters will be in the right spot.<br /><br />How about this?<br /><br />syscall_handler_new:<br />cmp al,NUM_SYSCALLs<br />jae sch0<br />movzx eax,al<br />test byte ,2<br />jnz @f<br />push <br />popfd<br />pop <br />add esp,4<br />jmp <br />@@:<br />push ebp<br />mov ebp,esp<br />push eax<br />mov eax,<br />call SomehowGetSelectorBase<br />mov esp,eax<br />add esp,<br />xchg eax,<br />sti<br />call <br />push eax<br />lea eax,<br />sub eax,<br />mov ,eax<br />pop eax<br />leave<br />sch0:<br />iretd<br /><br />See if that works.</div>
    <div class="meta">Posted on 2003-07-20 12:39:43 by Sephiroth3</div>
   </div>
   <div class="post" id="post-111294">
    <div class="subject"><a href="#post-111294">calling convention &amp; ss0:esp0 from tss</a></div>
    <div class="body">um.. have you typed down the code right now?<br />i have commented your code, i don't know everywhere what you're doing...<br /><div class="quote"><em>Originally posted by Sephiroth3 </em><br /><pre><code><br />syscall_handler_new&#58;<br />cmp al,NUM_SYSCALLs<br />jae sch0<br />movzx eax,al<br />test byte &#91;esp+4&#93;,2 &#91;b&#93;;the privilege-level check?&#91;/b&#93;<br />jnz @f<br />push &#91;esp+8&#93; &#91;b&#93;;restore the flags&#91;/b&#93;<br />popfd<br />pop &#91;esp+4&#93; &#91;b&#93;;get the eip and overwrite cs?!&#91;/b&#93;<br />add esp,4 &#91;b&#93;;correct stack again&#91;/b&#93;<br />jmp &#91;syscall_table+eax*4&#93; &#91;b&#93;;jump to function... how to return? i guess with a iret&#91;/b&#93;<br />@@&#58; &#91;b&#93;;this is now the ring3-handler?&#91;/b&#93;<br />push ebp<br />mov ebp,esp<br />push eax<br />mov eax,&#91;ebp+20&#93; &#91;b&#93;;is this ss3?&#91;/b&#93;<br />call SomehowGetSelectorBase &#91;b&#93;;this sould be no problem&#91;/b&#93;<br />mov esp,eax<br />add esp,&#91;ebp+16&#93; &#91;b&#93;;the address of parameters?&#91;/b&#93;<br />xchg eax,&#91;ebp-4&#93; &#91;b&#93;;from here on i don't get it anymore...&#91;/b&#93;<br />sti<br />call &#91;calltable+eax*4&#93;<br />push eax<br />lea eax,&#91;esp+4&#93;<br />sub eax,&#91;ebp-4&#93;<br />mov &#91;ebp+16&#93;,eax<br />pop eax<br />leave<br />sch0&#58;<br />iretd<br /></code></pre><br /></div><br /><br />it's very nice when you write code for me - but it's even more helpful when you explain me how to do it. what did you intend with this code?</div>
    <div class="meta">Posted on 2003-07-20 13:21:20 by hartyl</div>
   </div>
   <div class="post" id="post-111308">
    <div class="subject"><a href="#post-111308">calling convention &amp; ss0:esp0 from tss</a></div>
    <div class="body">I was assuming that all of your R0 code was in the same code segment. If they aren't, a few changes are in order. I marked those changes with italics.<br /><br />Okay, here goes...<br /><div class="quote"><em>Originally posted by Sephiroth3 </em><br /><pre><code><br />syscall_handler_new&#58;<br />cmp al,NUM_SYSCALLs<br />jae sch0<br />movzx eax,al<br />test byte &#91;esp+4&#93;,2 ; yep, it's the privilege level check &#40;you'll need the<br />jnz @f ; system to run at ring 1 for this, so you can trap stack faults with a<br />push &#91;esp+8&#93; ; ring 0 stack&#41;<br />popfd<br />pop &#91;esp+4&#93; ; overwrites the flags with EIP<br />add esp,4 ; get rid of CS<br />&#91;i&#93;; if using far procedures, the above two lines are replaced with the following&#58;<br />;xchg eax,&#91;esp&#93; ; save function number and get EIP<br />;xchg eax,&#91;esp+4&#93; ; overwrite CS with EIP<br />;xchg eax,&#91;esp+8&#93; ; overwrite flags with CS<br />;pop eax ; get function number back&#91;/i&#93;<br />jmp &#91;syscall_table+eax*4&#93; ; just return with a ret &#91;i&#93;&#40;or retf&#41;&#91;/i&#93;, since only the return address is on the stack now<br />@@&#58;<br />push ebp<br />mov ebp,esp<br />push eax ; save function number<br />mov eax,&#91;ebp+20&#93; ; yup, it's ss3<br />call SomehowGetSelectorBase<br />mov esp,eax ; if your ss isn't at 0, just subtract the base first<br />add esp,&#91;ebp+16&#93; ; and esp3, now esp points to the parameters<br />xchg eax,&#91;ebp-4&#93; ; get the function number back, and save the ss base<br />sti<br />&#91;i&#93;; push cs&#91;/i&#93;<br />call &#91;calltable+eax*4&#93; ; call the function on the Ring 3 stack<br />push eax<br />lea eax,&#91;esp+4&#93;<br />sub eax,&#91;ebp-4&#93; ; subtract the saved ss base<br />mov &#91;ebp+16&#93;,eax ; and store it<br />pop eax<br />leave ; restore esp and ebp<br />sch0&#58;<br />iretd ; return to caller with the new esp<br /></code></pre></div></div>
    <div class="meta">Posted on 2003-07-20 14:58:07 by Sephiroth3</div>
   </div>
   <div class="post" id="post-111405">
    <div class="subject"><a href="#post-111405">calling convention &amp; ss0:esp0 from tss</a></div>
    <div class="body">erm... i gotta say that this one won't work either.<br />in the part for ring0 you get rid of the calling cs. what if the sysfunction is called outside of the kernel, i.e. with a different cs, i couldn't return to it anymore.<br />i still don't get your ring3-part. how are you doing? you seem to access the parameters by the linear address of em. actually i don't like this idea.<br />btw, how have you been writing this code? directly out of your head or are you developing an os too and been dealing with that problem?<br />but you don't need to break your head about my problems anymore. i think i'll keep my 20 bytes per call and let it as is.</div>
    <div class="meta">Posted on 2003-07-21 14:22:10 by hartyl</div>
   </div>
   <div class="post" id="post-111406">
    <div class="subject"><a href="#post-111406">calling convention &amp; ss0:esp0 from tss</a></div>
    <div class="body">It's just out of the top of my head (written in 5 minutes or so) :P<br />The reason I suggested to use your own SS was so you could have it be the same as DS and use pointers interchangeably, but it might not be a good idea after all... Anyway, if you uncomment the italicized code and remove the two lines above it, you should be able to call the system functions from Ring 0 code in different segment. Just return with a retf instead of a ret. You would have to save DS in the functions. And maybe prefix the indirect jump and call up there with cs:.</div>
    <div class="meta">Posted on 2003-07-21 14:40:37 by Sephiroth3</div>
   </div>
   <div class="post" id="post-113110">
    <div class="subject"><a href="#post-113110">macro problem</a></div>
    <div class="body">i had not much time in the last days (and actually i don't feel like programming... - hating myself for that :))<br />but i've created a macro for my c-like-calling-convention. you know, i want to push (reverse) all arguments, put the funciton-number into al, call my sys-int and correct the stack. this is what i have, but theres one problem (following):<br /><br /><pre><code><br />macro syscall funcNo, &#91;arg&#93;<br />&#123; common local argsize<br />  argsize=0<br />  reverse pushd arg <br />  argsize=argsize+4<br />  common mov al,funcNo<br />  common int 0x30<br /> if argsize&gt;0<br />  add esp,argsize<br /> end if<br />&#125;<br /><br />calling like that&#58;<br /><br />syscall PrintDword,0xba5ec0de<br /></code></pre><br /><br />the problem: this piece doesn't work for functions like<br /><br /><pre><code><br />syscall BootLog<br /></code></pre><br /><br />any solutions?<br /><br />@<strong>Sephiroth3</strong>: ds=ss is what i want to do (not implemented yet...); i need the &quot;compatibility&quot; between pointers on stack/data-segment. i think that's what windows also does - but with paging to prevent the stack-pointer from moving to data-section.<br /><br />greets, hartyl</div>
    <div class="meta">Posted on 2003-08-05 13:34:21 by hartyl</div>
   </div>
   <div class="post" id="post-114441">
    <div class="subject"><a href="#post-114441">calling convention &amp; ss0:esp0 from tss</a></div>
    <div class="body">in the last days i was working on a completely new approach of my system, a complete<br />redesign. i found the paging-mechanism is the only possibility to make a good memory-<br />management. finally i chose the flat memory model and it's now possible to design the<br />systemcalls completely different.<br /><br />i've found 2 instructions that are just like *made for me* - like made for my purposes.<br />the instructions are <strong>sysenter</strong> and <strong>sysexit</strong>. the use some MSRs to transfer the execution<br />to ring0/ring3. the require the flat model to do that. this is how i'll do the syscalls:<br />- on initializing i set the cs:eip for a function in the os-code that will use the<br />sysenter/sysexit-instructions. the function number is still passed in eax (al).<br /><br /><pre><code><br />  push params<br />  mov al,funcNo<br />  call dword &#91;execute_function&#93;<br /><br />execute_function&#58;<br />  dd ring3_execute ;that value will be set by the loader<br /><br />;in the os-code<br />ring3_execute&#58;<br />  ;al still has funcNo<br />  ;ebx becomes stackpointer<br />  mov ebx,esp<br />  pop edx ;the return address to ring3-app<br />  sysenter ;transfer modifies cs&#58;eip will transfer the execution<br />           ;into ring0. the destination is 0008&#58;enter_ring0 and esp<br />           ;will get a dump-value like zero, but i'll backup it in ebx<br />enter_ring0&#58;<br />  mov esp,ebx<br />  movzx eax,al<br />  call dword &#91;syscall_table+eax*4&#93; ;edx musnt be changed here &#40;and won't&#41;<br />  push edx ;the return address to ring3-app<br />  push ecx ;value souldn't be changed<br />  mov ecx,esp ;esp=ecx after transfer<br />  mov edx,leave_ring0<br />  sysexit ;transfer execution to 0018&#58;edx, the new esp will be ecx and<br />          ;things will continue in ring3<br />leave_ring0&#58;<br />  pop ecx ;restore the value<br />  ret ;the return address to ring3-app is still on the stack<br /><br />-----------------------------------------------------------------------------------<br /><br />in an ring0-app things won't look different, but things behind it will&#58;<br />  push params<br />  mov al,funcNo<br />  call dword &#91;execute_function&#93;<br /><br />execute_function&#58;<br />  dd ring0_execute ;loader sets a different value for ring0/ring3 apps<br /><br />ring0_execute&#58;<br />  movzx eax,al<br />  jmp dword &#91;syscall_table+eax*4&#93; ;the ret in the function will return to the ring0-app<br /></code></pre><br /><br />well, what do you think of that method? would it make the system insecure in any<br />point of view?<br />i'd like to get rid of the &quot;functionNumber in al&quot;-thingy, does anyone have an idea for that?<br /><br />thanks all!<br />greets, hartyl</div>
    <div class="meta">Posted on 2003-08-19 13:35:14 by hartyl</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=14281&amp;page=1" style="">&laquo;</a><a href="../?id=14281&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="14281" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>  </div>
 </body>
</html>