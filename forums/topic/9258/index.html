<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>High speed message dispatcher - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=9258" />
    <link rel="next" href="../?id=9258&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=9258">High speed message dispatcher</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=9258&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=9258&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="9258" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=9258&amp;page=2">&gt;</a><a href="../?id=9258&amp;page=2">&raquo;</a></form>   <div class="post" id="post-68245">
    <div class="subject"><a href="#post-68245">High speed message dispatcher</a></div>
    <div class="body">The attached program is an example I have had in mind for a while to test out a different message dispatching architecture in a Windows GUI application.<br /><br />It carries the overhead of a 4k array but once loaded, it will branch to any message in 2 assembler instructions, no matter how many messages there are to process. It also simplifies the WndProc by removing the large switch block associated with normal Wndproc message processing.<br /><br />The catches are these, every message you wish to process must be added to the array, (a macro is provided to do this) and if you wish to use private messages that can range in value to 0FFFFh, you must make the array size 65536 which is 256k of memory.<br /><br />I don't know if its an original idea but in performance terms for branching, it will rip the titz off anything else I have seen.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-11-30 02:15:20 by hutch--</div>
   </div>
   <div class="post" id="post-68252">
    <div class="subject"><a href="#post-68252">High speed message dispatcher</a></div>
    <div class="body"><div class="quote">it will rip the titz off anything else I have seen.</div>LMAO! :grin: is this suppose to be a figure of speech or should I take it literally? :stupid:</div>
    <div class="meta">Posted on 2002-11-30 02:34:06 by stryker</div>
   </div>
   <div class="post" id="post-68254">
    <div class="subject"><a href="#post-68254">WoW!</a></div>
    <div class="body">I'm impressed, this kind of message dispatcher would make great in an app where time is limited (eg games)...<br />I think you're the first that's implented it, but I'm sure others have scratched the surface of the idea but never given it any depper thoughts (or trying to code it), untill you made the working example. :)<br /><br /><div class="quote">it will rip the titz off anything else I have seen.</div> <br />I just heard a scream... ;)<br /><br />I just implented the &quot;Hutch Fast Message Dispatch Algorithm&quot; (:) ) into an application (sill pre-alpha, thus in the phase where bugs are written ;) ) and, the message dispatching works flawless... :)</div>
    <div class="meta">Posted on 2002-11-30 03:43:01 by scientica</div>
   </div>
   <div class="post" id="post-68277">
    <div class="subject"><a href="#post-68277">High speed message dispatcher</a></div>
    <div class="body"><div class="quote">it will rip the titz off anything else I have seen.</div> <br /><div class="quote">LMAO!  is this suppose to be a figure of speech or should I take it literally? </div> <div class="quote">I just heard a scream... </div> <br /><br />LOL. Too funny. Still cant stop laughing. :grin: <br /><br />Btw, Stryker whats the full form of LMAO and also IIRC. I seen that in quite a few places too.<br /><br />Anyway nice work hutch :)</div>
    <div class="meta">Posted on 2002-11-30 09:25:37 by clippy</div>
   </div>
   <div class="post" id="post-68278">
    <div class="subject"><a href="#post-68278">High speed message dispatcher</a></div>
    <div class="body"><div class="quote"><br /> <br />Btw, Stryker whats the full form of LMAO and also IIRC. I seen that in quite a few places too.<br /></div><br /><br /><a target="_blank" href="www.acronymfinder.com">www.acronymfinder.com</a></div>
    <div class="meta">Posted on 2002-11-30 09:28:27 by bazik</div>
   </div>
   <div class="post" id="post-68283">
    <div class="subject"><a href="#post-68283">High speed message dispatcher</a></div>
    <div class="body">nice link Bazik.<br /><br />Btw hutch,<br />      What are 'global' labels? And how are they different from local labels?</div>
    <div class="meta">Posted on 2002-11-30 10:26:52 by clippy</div>
   </div>
   <div class="post" id="post-68288">
    <div class="subject"><a href="#post-68288">High speed message dispatcher</a></div>
    <div class="body">I found this in my HutchOutgoing Directory of March 2000. Not high speed but ....<br /><br /><br />James</div>
    <div class="meta">Posted on 2002-11-30 11:59:32 by jcfuller</div>
   </div>
   <div class="post" id="post-68312">
    <div class="subject"><a href="#post-68312">High speed message dispatcher</a></div>
    <div class="body">James,<br /><br />I confess I have on and off chewed over you idea for a couple of years and while I don't think this one fully enacts your design for proper encapsulation of each message I think it can be done if you want to manage the stack so that the parameters are passed along with it to the designated procedure for each message.<br /><br />I just don't see a way around the global scope labels but then this may not be a problem with your basic design anyway as the code to place the label addresses into the array only needs to be within the same module and the labels are not accessed from outside the WndProc while the app is running normally.<br /><br />Josh,<br /><br />&quot;rip the titz off&quot;. Idiom does not always translate well but I will try.<br /><br />When something goes past a bit faster, it may be noticed. When it goes past a fair bit faster it will cause a breeze. When it goes past a lot faster it may leave their titz in a tangle but when it goes past so much faster, it just rips the titz off them. :tongue: <br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-11-30 17:10:00 by hutch--</div>
   </div>
   <div class="post" id="post-68339">
    <div class="subject"><a href="#post-68339">High speed message dispatcher</a></div>
    <div class="body">Sound soooo Gooood<br /><br /><span style="font-size:9px>Soon we have the whole 9 YARDS</span> Ready to  Rip<br /><br />Thanks  <strong>Mr. hutch--</strong><br /><br /><span style="font-size:9px>&quot;goes past so much faster&quot; .... When the Flag Drop ____</span></div>
    <div class="meta">Posted on 2002-11-30 20:16:11 by cmax</div>
   </div>
   <div class="post" id="post-68359">
    <div class="subject"><a href="#post-68359">High speed message dispatcher</a></div>
    <div class="body">Something i don't want to get an Mis-Understanding about...<br /><br />What do you hutch.. mean by private messages... It's just like for a long time I thought virtural protect mean protect your app but come to find out it was only vesa-versa.  Private message sound like it should not be easy seen by other app's or the OS itself. Is this true.<br /><br /><span style="font-size:9px>Maybe not as usually, .but it would be nice...</span></div>
    <div class="meta">Posted on 2002-11-30 21:31:43 by cmax</div>
   </div>
   <div class="post" id="post-68365">
    <div class="subject"><a href="#post-68365">High speed message dispatcher</a></div>
    <div class="body">I think he means application-defined messages.</div>
    <div class="meta">Posted on 2002-11-30 23:25:19 by iblis</div>
   </div>
   <div class="post" id="post-68372">
    <div class="subject"><a href="#post-68372">High speed message dispatcher</a></div>
    <div class="body">Nice example Hutch,<br /><br />&quot;High speed message dispatcher&quot;<br /><br />pls correct me if I'm wrong, but you use the standard message dispatch loop<br />with GetMessage(), TranslateMessage() and DispatchMessage()<br />When the DispatchMessage() dispatch the  message to WndProc you<br />execute correct procedure using  mov eax, uMsg  /  jmp DWORD PTR <br /><br />The idea is not new, (see ASM journal)  but I'm wondering<br />why the title is &quot;High speed message dispatcher&quot; <br />I saw similar new idea in an example here: <a target="_blank" href="http://www.asmcommunity.net/board/showthread.php?threadid=5702&amp;highlight=BuliaNaza">http://www.asmcommunity.net/board/showthread.php?threadid=5702&amp;highlight=BuliaNaza</a><br />and learned how to get the message  and execute the correct procedure<br />DIRECTLY without DispatchMessage(),  i.e. skip not only one Windows API<br />but to reduce the messages traffic also<br /><br />May be I'm wrong (pls, correct me) but for me it is  a<br />&quot;High speed message dispatcher&quot; because understood his/her new idea:<br /> &quot;after GetMessage(), the message is here in the main message loop,<br />and we can execute DIRECTLY  the correct procedure without ANY dispatching,<br />or it is a waste of time and recourses to dispatch the message again to Windows<br />with DispatchMessage() and to receive the same message again later from<br />Windows in WndProc&quot;<br /><br />&quot;This example allocates an array in the uninitialised DATA SECTION...&quot;<br /><br />I'm wondering why you do that ...just use  the stack, and why<br />you continue to use .if .elseif .elseif .endif  with WM_COMMAND messages<br /><br /><br />Thanks again for posting,<br /><br /><br />Regards,<br />Lingo</div>
    <div class="meta">Posted on 2002-12-01 01:14:20 by lingo12</div>
   </div>
   <div class="post" id="post-68378">
    <div class="subject"><a href="#post-68378">High speed message dispatcher</a></div>
    <div class="body">lingo12,<br /><br />I have seen various attempts to bypass the Wndproc and dispatch messages directly from the message loop but I have yet to see one that is reliable and extendable and works on all windows versions.<br /><br />The API calls in the message loop are OS defined and the location for the dispatched messages from the message loop is again OS defined in the WNDCLASSEX structure so I have yet to see an advantage in deviating from this.<br /><br />Now in regard to you suggestion and following question,<br /><br />&quot;This example allocates an array in the uninitialised DATA SECTION...&quot;<br /><br />I'm wondering why you do that ...just use the stack,<br /><br />The addresses to dispatch to still must be loaded and doing this on the stack each time a message is passed to the location defined in the WNDCLASSEX structure would be really slow. Using the uninitialised data section only has to be done once as it has GLOBAL scope.<br /><br />and why you continue to use .if .elseif .elseif .endif with WM_COMMAND messages<br /><br />I modified one of my standard templates which used the .if block syntax as I was writing an example for branching in the WndProc procedure. It is possible to do the same for any collections of branches that may impinge on performance but I doubt that 3 branch testing is a performance problem.<br /><br />The example does what it is supposed to do, it branches to any message in the WndProc in 2 instructions and it is a variation of a branching technique that is generally known as a dispatcher, the difference is that it is a lot faster than a list of comparisons.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-12-01 02:14:23 by hutch--</div>
   </div>
   <div class="post" id="post-68383">
    <div class="subject"><a href="#post-68383">High speed message dispatcher</a></div>
    <div class="body">:alright: I've known it was possible to do it this way, but have never needed the raw speed enough to justify the code bloat.</div>
    <div class="meta">Posted on 2002-12-01 03:09:16 by tenkey</div>
   </div>
   <div class="post" id="post-68455">
    <div class="subject"><a href="#post-68455">High speed message dispatcher</a></div>
    <div class="body">Hutch,<br /><br />&quot;The API calls in the message loop are OS defined..&quot;<br /><br />I agree, in Basic and high level languages with hidden message loop,<br />but in assembly we have not a canon , i.e. in message loop we can<br />mix our code and freely chosen by US &quot;OS defined API&quot;  without &quot;OS defined&quot; restrictions..<br /><br /><br />&quot;The addresses to dispatch to still must be loaded and doing this on the stack <strong>each time</strong> a message  <br />is passed to the location defined in the WNDCLASSEX structure would be really slow. Using the  <br />uninitialised data section only has to be done once as it has GLOBAL scope.&quot;<br /><br />Why each time?<br />In assembly we have a freedom to work with &quot;non balanced&quot; stack and we can do:<pre><code><br />    .data?<br />	      ;  wMsgs dd asize dup &#40;?&#41;      ; save space!!!<br />	        hInstance dd ?<br />	       ..... <br />	       .....<br />      .code<br />start&#58;<br />	lea  eax, &#91;esp- asize*4&#93;     	; room for table with addresses	<br />	mov esp, eax		; where asize-&gt;array item count          <br />	invoke InitMsgArray<br />	invoke InitCommonControls<br />	.....<br />	.....<br />; in the end of program we can balance the stack<br />	.......<br />	lea  esp, &#91;esp+asize*4&#93;<br />	invoke ExitProcess, eax<br />	<br />InitMsgArray proc<br />    ; ---------------------------------------------------------------<br />    ; fill array with address of default processing label in WndProc<br />    ; ---------------------------------------------------------------<br />	      push edi<br />	;     mov edi, OFFSET wMsgs       ; array address<br />	      mov edi, eax		     ; eax-&gt;array address parameter<br />	      mov eax, OFFSET DEF_MSG_HANDLER   ; default processing label in WndProc<br />	      mov ecx, asize              ; array item count<br />	      rep stosd<br />	      pop edi     </code></pre>As you see, I just add 3 new rows in your code and modify one<br /><br />Regards,<br />Lingo</div>
    <div class="meta">Posted on 2002-12-01 12:02:06 by lingo12</div>
   </div>
   <div class="post" id="post-68481">
    <div class="subject"><a href="#post-68481">High speed message dispatcher</a></div>
    <div class="body">Sorry for interrupting you guys but me being pretty new to asm i cant understand this algo too well. Can somebody explain me these things-<br />What exactly are global variables and how are they different from local variables?<br />What exactly do u mean by offset?<br />If the array you are using stores the address of label then how is it that when you use the message as the index in the array the appropriate label comes out?</div>
    <div class="meta">Posted on 2002-12-01 15:45:57 by clippy</div>
   </div>
   <div class="post" id="post-68499">
    <div class="subject"><a href="#post-68499">High speed message dispatcher</a></div>
    <div class="body">gladiator,<br /><br />A GLOBAL label has the :: at the end of it and it denotes that you can access the label from anywhere in the program. A local label has a single : which denotes that it can only be accessed from within the procedure it is written in. From memory there is also options to change this in MASM.<br /><br />A label is only a place holder for the next instruction and that place holder is an address in memory. What the application I posted does is load the addresses into an array and at the beginning of the Wndproc, it gets the address of the label from the array and jumps to that address.<br /><br />lingo12/Bulianaza,<br /><br />The suggestion of using stack memory is an interesting one but you get nothing for nothing. Stack is allocated memory like any other memory and where the problem will occur with an unbalanced stack is that you lose range in the stack by amount of stack imbalance. It probably does not matter with 4k when default stack is 1 meg but try it with 256k imbalance and run highly recursive procedures and you go past the end and crash. To compensate you must allocate more stack memory to have the same range.<br /><br />Uninitialised data does not have this problem and it does not make the file larger either so it is a better choice in this instance.<br /><br />With message delivery, what you have defined with the OS is that messages for a window will arrive at a predefined address with 4 DWORD parameters on the stack. What you do with it is your own choice as long as you can get it to be reliable and extendable.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-12-01 17:53:18 by hutch--</div>
   </div>
   <div class="post" id="post-68542">
    <div class="subject"><a href="#post-68542">Event driven version of high speed message dispatcher</a></div>
    <div class="body">I have modified the original file to make a version that is in the architecture type that is suitable for &quot;event driven&quot; programming. The original JMP had been replaced by a CALL and for each message processed, there is a seperate procedure to do it that has the 4 parameters from ther WndProc passed to it.<br /><br />To do this requires 4 additional pushes for the stack parameters as they are available in the WndProc which makes the version marginally slower but it is probably not a problem in peformance terms.<br /><br />It is an architecture that is suitable for a VB or a Visual Assembler style of coding where each &quot;event&quot; pops up in a window of its own.<br /><br />The downside of this architecture if you have bad habits like I do of jumping across messages is that you lose some of you design freedom in message processing.<br /><br />It has the same technical demends as the earlier version, 4k overhead for the normal messages because of the array size and if you want to process messages that you define yourself, the overhead for the array grows to 256k, a 64k DWORD array.<br /><br />I think the original is the one that is the performance advantage and is more flexible while processing messages.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-12-02 00:35:59 by hutch--</div>
   </div>
   <div class="post" id="post-68586">
    <div class="subject"><a href="#post-68586">An optimization for your algo</a></div>
    <div class="body">Ok hutch, i fully understand your algo now :) A few suggestions -<br /><div class="quote"><br />if you want to process messages that you define yourself, the overhead for the array grows to 256k, a 64k DWORD array.<br /></div><br /><br />Instead of doing that why dont you do this-<br />Keep 2 arrays, one for windows defined msgs and the other for user defined msgs. <br />The maximum size of array of user defined msgs will obviously be know during assemble time, cause after all the user only has defined those msgs. Plus you dont need to initialize them with pointer to DefWindowProc cause if you define a msg that definetly means you are gonna implement it.<br /><br />In WndProc add a check -<br /><pre><code>.IF uMsg&gt;1024<br />uMsg=uMsg-1024; sutract 1024 from msg to get an index in the array for user-defined msg</code></pre><br />this way if user defined msg was WM_USER+1 we get 1 in uMsg and now uMsg<br />can be used as an index for the user msgs array<br /><pre><code>.ELSE IF uMSG&lt;=1024<br />;use your normal method here</code></pre><br /><br />this way u can keep a separate array for handling WM_COMMAND msgs too.<br /><br />Btw, <strong>your algo has onemajor disadvantage</strong>. For every window or dialog that you create it has to go through a loop of 1024 to fill in the array with the pointer to DefWindowProc.<br /><br />First i was thinking of not to fill the array with pointer to DefWindowProcand only fill those indexes which do have a pointer to a function. And each time a msg is to be processed do a check for 0 on the index in the array. If its not 0 that means a msg is contained there. But then i realized that instead of 0 that location may be filled with garbage value, so that would make the prog buggy.<br /><br />Anyone know any way to optimize the loading of the win by somehow avoiding the loop of 1000?</div>
    <div class="meta">Posted on 2002-12-02 06:08:06 by clippy</div>
   </div>
   <div class="post" id="post-68660">
    <div class="subject"><a href="#post-68660">High speed message dispatcher</a></div>
    <div class="body">do you really need to push the uMsg param?<br /><br />i mean, in a WM_COMMAND event, wouldn't uMsg always be WM_COMMAND...?</div>
    <div class="meta">Posted on 2002-12-02 14:51:00 by Sloat</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=9258&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=9258&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="9258" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=9258&amp;page=2">&gt;</a><a href="../?id=9258&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>