<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>EXCEPTION 01h - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=970" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=970">EXCEPTION 01h</a></p>
   <div class="post" id="post-6270">
    <div class="subject"><a href="#post-6270">EXCEPTION 01h</a></div>
    <div class="body">Hi, <br /><br />I have a big problem. I have mad a little Debugger witch trace taget with CreateProcess, WaitForDebugEvent, ContinueDebugEvent... fonctions.<br />But some progs send it and 'EXCEPTION 01H' and that's stop my debugger. (Asprotect for example)<br /><br /><br />Can I Send You my source ? to see it... I have'nt any solution<br /><br />(At this time, my prog keep EIP of each lines and find the last EIP of the .LOADER section and find Entry-Point of the real .TEXT section, so I'll could do a dump for progs compressed)<br />(it works with ASPAK but not with ASPROTECT due to EXCEPTION 01h)<br /><br /><br /><br /><br /><br /><br />.386<br />.model flat,stdcall <br />option casemap:none <br />include \masm32\include\windows.inc <br />include \masm32\include\kernel32.inc <br />include \masm32\include\comdlg32.inc <br />include \masm32\include\user32.inc <br />includelib \masm32\lib\kernel32.lib <br />includelib \masm32\lib\comdlg32.lib <br />includelib \masm32\lib\user32.lib <br />			<br />			<br />			<br />.data			<br />AppName db &quot;BPMB_EMULATION (Morgatte)&quot;,0 ;&lt;-- Titre de mon unique fen?tre (une MessageBox)<br />ofn OPENFILENAME &lt;&gt;  			  ;&lt;-- Structure pour cr?er la DialogBox qui sert ? <br />FilterString db &quot;Executable Files&quot;,0,&quot;*.exe&quot;,0 ;choisir un fichier (et son filtre de type de fichiers)<br />             db &quot;All Files&quot;,0,&quot;*.*&quot;,0,0 <br />;??????????<br />;??????????<br />;??????????<br />resultat db &quot;COMPTE RENDU :&quot;,0Dh,0Ah <br />         db &quot;La derni?re instruction du loader est : %lxh&quot;,0dh<br />	 db &quot;Et elle saute vers l'Entry-Point du programme&quot;,0dh<br />	 db &quot;D?compress? qui se trouve en : %lxh&quot;,0d,0ah<br />ADRESSEDEBUTLOADER 	dd 0040D000h<br />ADRESSEFINLOADER	dd 0040F000h<br />sortie_du_loader	db 0	; sert ? compter combien de lignes ne font pas parti du Loader<br />				; si il y en a plus qu'une alors c'est qu'on est bien<br />				; en dehors du loader<br /><br /><br /><br /><br /><br />.data? <br />buffer db 512 dup(?) <br />startinfo STARTUPINFO &lt;&gt; ;&lt;-- Structure pour la fonction GetStartUpInfo <br />pi PROCESS_INFORMATION &lt;&gt; ;&lt;-- Structure pour les fonctions Get&amp;SetThreadContext<br />DBEvent DEBUG_EVENT &lt;&gt; ;&lt;-- Structure pour receuillir le Debugging ?v?nement (WaitForDebugEvent)<br />context CONTEXT &lt;&gt; ;&lt;-- Stucture pour recup?rer le context (en particulier regEip)<br />EipMoinsUn 	dd ?<br />EipMoinsDeux 	dd ?<br />LOADER dd ?<br /><br /><br /><br /><br /><br />.code <br />start: <br />mov ofn.lStructSize,SIZEOF ofn <br />mov ofn.lpstrFilter, OFFSET FilterString <br />mov ofn.lpstrFile, OFFSET buffer <br />mov ofn.nMaxFile,512 <br />mov ofn.Flags, OFN_FILEMUSTEXIST or OFN_PATHMUSTEXIST or OFN_LONGNAMES or OFN_EXPLORER \<br />               or OFN_HIDEREADONLY	;Dans un premier temps on ouvre la DialogBox permettant<br />invoke GetOpenFileName, ADDR ofn	;de s?lectionner le programme cible qui sera debugg?<br />.if eax==TRUE 				<br />    invoke GetStartupInfo,addr startinfo  ;On r?cup?re des infos sur lui (pour son demarrage)<br />    invoke CreateProcess, addr buffer, NULL, NULL, NULL, FALSE, \ ;Cr?e le Process et le <br />                  DEBUG_PROCESS+ DEBUG_ONLY_THIS_PROCESS, \ ;lien primaire de la cible<br />                  NULL, NULL, addr startinfo, addr pi ;puis la d?marre.<br />;??????????<br />;??????????<br />;??????????<br /><br /><br />    .while TRUE <br />       invoke WaitForDebugEvent, addr DBEvent, INFINITE ;Attend qu'un Debugging ?v?nement ne se<br />	   		  				;produise<br />			<br />	;--------------ICI-mettre-la-valeur-de-regEip-(Donc de la ligne suspecte)-------<br /><br /><br />        <br />	;-------------------------------------------------------------------------------<br /><br /><br />	.if DBEvent.dwDebugEventCode==EXIT_PROCESS_DEBUG_EVENT <br />                    .break<br />	.elseif DBEvent.dwDebugEventCode==EXCEPTION_DEBUG_EVENT<br />          .if DBEvent.u.Exception.pExceptionRecord.ExceptionCode==EXCEPTION_BREAKPOINT ; (80000003h) <br />             mov context.ContextFlags, CONTEXT_CONTROL <br />             invoke GetThreadContext, pi.hThread, addr context <br />             or context.regFlag,100h <br />             invoke SetThreadContext,pi.hThread, addr context <br />             invoke ContinueDebugEvent, DBEvent.dwProcessId, DBEvent.dwThreadId, DBG_CONTINUE <br />             .continue<br />          .elseif DBEvent.u.Exception.pExceptionRecord.ExceptionCode==EXCEPTION_SINGLE_STEP ; (80000004h)<br />		;-----------ICI-mettre-la-lecture-du-contenu-de-l'adresse---------------------<br />		<br />mov eax, context.regEip							; Regarde si le EIP actuel<br />.if (ADRESSEDEBUTLOADER&lt;=eax &amp;&amp; eax&lt;=ADRESSEFINLOADER &amp;&amp; LOADER!=TRUE)	; appartient au LOADER<br />	mov LOADER, TRUE						; si oui, on met<br />.endif									; LOADER ? TRUE<br /><br />.if ((ADRESSEDEBUTLOADER&gt;eax || eax&gt;ADRESSEFINLOADER) &amp;&amp; LOADER==TRUE)  ;<br />	inc sortie_du_loader					; Si on est d?j? pass? par le LOADER<br />	.if (sortie_du_loader &lt; 2)				; Et que maintenant EIP est en-dehors<br />		mov eax, EipMoinsUn				; Alors c'est qu'on en est sorti<br />		mov EipMoinsDeux, eax				; On est dans le prog D?compress?<br />	.else							; <br />		invoke wsprintf, addr buffer, addr resultat, EipMoinsDeux, EipMoinsUn <br />        	invoke MessageBox, 0, addr buffer, addr AppName, MB_OK+MB_ICONINFORMATION<br />		.break						; <br />	.endif							; Et EipMoinUn est l'EntryPoint du<br />.else								; prog d?compress?.<br />	mov sortie_du_loader,0					; EipMoinsDeux est la derni?re<br />.endif								; instruction du LOADER<br /><br /><br /><br /><br />		;-----------------------------------------------------------------------------<br /><br /><br /><br />             mov eax, context.regEip	;------------On garde en m?moire la valeur<br />	     mov EipMoinsUn, eax	;------------du EIP pr?c?dant<br /><br />	     invoke GetThreadContext,pi.hThread,addr context ; on rappelle le context<br />             or context.regFlag,100h ; on remet le Trap Bit ? 1<br />             invoke SetThreadContext,pi.hThread, addr context ; Et on r?injecte le new context<br />             invoke ContinueDebugEvent, DBEvent.dwProcessId, DBEvent.dwThreadId,DBG_CONTINUE <br />             .continue <br />          .endif <br />       .endif <br />       invoke ContinueDebugEvent, DBEvent.dwProcessId, DBEvent.dwThreadId, \ <br />                                  DBG_EXCEPTION_NOT_HANDLED <br />    .endw <br />.endif <br />invoke CloseHandle,pi.hProcess ;Quand on termine totalement le d?bugger on DOIT refermer le Process et le Lien <br />invoke CloseHandle,pi.hThread  ;primaire de la cible, sinon la fonction CreateProcess n'appr?cie pas du tout, et l?<br />invoke ExitProcess, 0	       ;votre ordi plante.<br />end start</div>
    <div class="meta">Posted on 2001-09-05 11:09:49 by Morgatte</div>
   </div>
  </div>
 </body>
</html>