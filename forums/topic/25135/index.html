<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>SSE Random Number Generator (64bit) - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=25135" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=25135">SSE Random Number Generator (64bit)</a></p>
   <div class="post" id="post-184056">
    <div class="subject"><a href="#post-184056">SSE Random Number Generator (64bit)</a></div>
    <div class="body">Testing with ENT shows that it&#39;s a solid algorithm.<br />I may use it for an encryption project in the near future,<br />unless a better algorithm/ or optimization for this one comes along.<br /><br /><pre><code><br />DQ1 equ 0 <br />DQ2 equ 16 <br />DQ3 equ 32 <br />DQ4 equ 48 <br />DQ5 equ 64 <br />DQ6 equ 80 <br />DQ7 equ 96 <br />DQ8 equ 112 <br />;;This function creates a random block of 64bytes <br />;;based on the 128 byte key. <br />;;The key structure is modified, so subsequent calls return different <br />;;random 64byte buffers <br />;;Return is void <br />;;IN: <br />;;Param1 rcx = address of Key struct <br />;;Param2 rdx = address of output buffer 64bytes 16byte ALIGNED <br />RandomBlock: <br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  rax, rsp ;;save stack ptr <br />&nbsp; &nbsp; &nbsp; &nbsp; and&nbsp; &nbsp;  rsp, 0xFFFFFFFFFFFFFFF0 ;; 16byte align <br />&nbsp; &nbsp; &nbsp; &nbsp; sub&nbsp; &nbsp;  rsp, 16*9 <br />;;save XMM8-15 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; , xmm15 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; , xmm14 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; , xmm13 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; , xmm12 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; , xmm11 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; , xmm10 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; , xmm9 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; , xmm8 <br />;;setup <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm0,  <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm1,  <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm2,  <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm3,  <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm4,  <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm5,  <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm6,  <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm7,  <br />;;copy <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm8, xmm0 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm9, xmm1 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm10, xmm2 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm11, xmm3 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm12, xmm4 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm13, xmm5 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm14, xmm6 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm15, xmm7 <br />;;mask highest qword bit <br />&nbsp; &nbsp; &nbsp; &nbsp; pand&nbsp; &nbsp; xmm8, dqword <br />&nbsp; &nbsp; &nbsp; &nbsp; pand&nbsp; &nbsp; xmm9, dqword <br />&nbsp; &nbsp; &nbsp; &nbsp; pand&nbsp; &nbsp; xmm10, dqword <br />&nbsp; &nbsp; &nbsp; &nbsp; pand&nbsp; &nbsp; xmm11, dqword <br />&nbsp; &nbsp; &nbsp; &nbsp; pand&nbsp; &nbsp; xmm12, dqword <br />&nbsp; &nbsp; &nbsp; &nbsp; pand&nbsp; &nbsp; xmm13, dqword <br />&nbsp; &nbsp; &nbsp; &nbsp; pand&nbsp; &nbsp; xmm14, dqword <br />&nbsp; &nbsp; &nbsp; &nbsp; pand&nbsp; &nbsp; xmm15, dqword <br />;;shift right logical 63bits to have the masked bit the lowest spot <br />&nbsp; &nbsp; &nbsp; &nbsp; psrlq&nbsp;  xmm8, 63 <br />&nbsp; &nbsp; &nbsp; &nbsp; psrlq&nbsp;  xmm9, 63 <br />&nbsp; &nbsp; &nbsp; &nbsp; psrlq&nbsp;  xmm10, 63 <br />&nbsp; &nbsp; &nbsp; &nbsp; psrlq&nbsp;  xmm11, 63 <br />&nbsp; &nbsp; &nbsp; &nbsp; psrlq&nbsp;  xmm12, 63 <br />&nbsp; &nbsp; &nbsp; &nbsp; psrlq&nbsp;  xmm13, 63 <br />&nbsp; &nbsp; &nbsp; &nbsp; psrlq&nbsp;  xmm14, 63 <br />&nbsp; &nbsp; &nbsp; &nbsp; psrlq&nbsp;  xmm15, 63 <br />;;shift left to clear the highest bit and empty the lowest <br />&nbsp; &nbsp; &nbsp; &nbsp; psllq&nbsp;  xmm4, 1 <br />&nbsp; &nbsp; &nbsp; &nbsp; psllq&nbsp;  xmm5, 1 <br />&nbsp; &nbsp; &nbsp; &nbsp; psllq&nbsp;  xmm6, 1 <br />&nbsp; &nbsp; &nbsp; &nbsp; psllq&nbsp;  xmm7, 1 <br />;;add masked bit <br />&nbsp; &nbsp; &nbsp; &nbsp; paddq&nbsp;  xmm0, xmm12 <br />&nbsp; &nbsp; &nbsp; &nbsp; paddq&nbsp;  xmm1, xmm13 <br />&nbsp; &nbsp; &nbsp; &nbsp; paddq&nbsp;  xmm2, xmm14 <br />&nbsp; &nbsp; &nbsp; &nbsp; paddq&nbsp;  xmm3, xmm15 <br />;;logical or lowest bit <br />&nbsp; &nbsp; &nbsp; &nbsp; por&nbsp; &nbsp;  xmm4, xmm8 <br />&nbsp; &nbsp; &nbsp; &nbsp; por&nbsp; &nbsp;  xmm5, xmm9 <br />&nbsp; &nbsp; &nbsp; &nbsp; por&nbsp; &nbsp;  xmm6, xmm10 <br />&nbsp; &nbsp; &nbsp; &nbsp; por&nbsp; &nbsp;  xmm7, xmm11 <br />;;copy <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm8, xmm0 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm9, xmm1 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm10, xmm2 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm11, xmm3 <br />;;Bit ROLL by prime numbers 7, 5, 3, 11 <br />&nbsp; &nbsp; &nbsp; &nbsp; psllq&nbsp;  xmm0, 7 <br />&nbsp; &nbsp; &nbsp; &nbsp; psllq&nbsp;  xmm1, 5 <br />&nbsp; &nbsp; &nbsp; &nbsp; psllq&nbsp;  xmm2, 3 <br />&nbsp; &nbsp; &nbsp; &nbsp; psllq&nbsp;  xmm3, 11 <br />&nbsp; &nbsp; &nbsp; &nbsp; psrlq&nbsp;  xmm8, 57;64-7 <br />&nbsp; &nbsp; &nbsp; &nbsp; psrlq&nbsp;  xmm9, 59;64-5 <br />&nbsp; &nbsp; &nbsp; &nbsp; psrlq&nbsp;  xmm10, 61;64-3 <br />&nbsp; &nbsp; &nbsp; &nbsp; psrlq&nbsp;  xmm11, 53;64-11 <br />&nbsp; &nbsp; &nbsp; &nbsp; por&nbsp; &nbsp;  xmm0, xmm8 <br />&nbsp; &nbsp; &nbsp; &nbsp; por&nbsp; &nbsp;  xmm1, xmm9 <br />&nbsp; &nbsp; &nbsp; &nbsp; por&nbsp; &nbsp;  xmm2, xmm10 <br />&nbsp; &nbsp; &nbsp; &nbsp; por&nbsp; &nbsp;  xmm3, xmm11 <br />;;Dword order switching <br />&nbsp; &nbsp; &nbsp; &nbsp; pshufd&nbsp; xmm0, xmm0, 00011011b <br />&nbsp; &nbsp; &nbsp; &nbsp; pshufd&nbsp; xmm1, xmm1, 00011011b <br />&nbsp; &nbsp; &nbsp; &nbsp; pshufd&nbsp; xmm2, xmm2, 00011011b <br />&nbsp; &nbsp; &nbsp; &nbsp; pshufd&nbsp; xmm3, xmm3, 00011011b <br />;;Modify Key with rotation of dq words <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; , xmm1 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; , xmm2 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; , xmm3 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; , xmm0 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; , xmm4 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; , xmm5 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; , xmm6 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; , xmm7 <br />;;prepare output <br />&nbsp; &nbsp; &nbsp; &nbsp; paddb&nbsp;  xmm0, xmm4 <br />&nbsp; &nbsp; &nbsp; &nbsp; paddb&nbsp;  xmm1, xmm5 <br />&nbsp; &nbsp; &nbsp; &nbsp; paddb&nbsp;  xmm2, xmm6 <br />&nbsp; &nbsp; &nbsp; &nbsp; paddb&nbsp;  xmm3, xmm7 <br />&nbsp; &nbsp; &nbsp; &nbsp; pxor&nbsp; &nbsp; xmm0, xmm7 <br />&nbsp; &nbsp; &nbsp; &nbsp; pxor&nbsp; &nbsp; xmm1, xmm6 <br />&nbsp; &nbsp; &nbsp; &nbsp; pxor&nbsp; &nbsp; xmm2, xmm5 <br />&nbsp; &nbsp; &nbsp; &nbsp; pxor&nbsp; &nbsp; xmm3, xmm4 <br />&nbsp; &nbsp; &nbsp; &nbsp; paddb&nbsp;  xmm0, xmm5 <br />&nbsp; &nbsp; &nbsp; &nbsp; paddb&nbsp;  xmm1, xmm4 <br />&nbsp; &nbsp; &nbsp; &nbsp; paddb&nbsp;  xmm2, xmm7 <br />&nbsp; &nbsp; &nbsp; &nbsp; paddb&nbsp;  xmm3, xmm6 <br />&nbsp; &nbsp; &nbsp; &nbsp; pxor&nbsp; &nbsp; xmm0, xmm6 <br />&nbsp; &nbsp; &nbsp; &nbsp; pxor&nbsp; &nbsp; xmm1, xmm7 <br />&nbsp; &nbsp; &nbsp; &nbsp; pxor&nbsp; &nbsp; xmm2, xmm4 <br />&nbsp; &nbsp; &nbsp; &nbsp; pxor&nbsp; &nbsp; xmm3, xmm5 <br />;;save output <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; , xmm0 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; , xmm1 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; , xmm2 <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; , xmm3 <br />;;restore xmm8-15 and return <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm15,  <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm14,  <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm13,  <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm12,  <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm11,  <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm10,  <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm9,  <br />&nbsp; &nbsp; &nbsp; &nbsp; movdqa&nbsp; xmm8,  <br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  rsp, rax <br />&nbsp; &nbsp; &nbsp; &nbsp; ret&nbsp; &nbsp;  0 ;;return<br /></code></pre></div>
    <div class="meta">Posted on 2006-07-27 19:07:06 by r22</div>
   </div>
  </div>
 </body>
</html>