<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Calling ASM func in VB - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=16181" />
  <link rel="prev" href="../?id=16181&amp;page=1" />   </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=16181">Calling ASM func in VB</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=16181&amp;page=1" style="">&laquo;</a><a href="../?id=16181&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="16181" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>   <div class="post" id="post-125772">
    <div class="subject"><a href="#post-125772">Calling ASM func in VB</a></div>
    <div class="body">hi Pradeepan,<br /><br />while your suggestion is absolutely useful here, it only applies to vb programmers. Making dlls for a whole range of languages is the aim. Thanks for your suggestions anyway.<br /><br />the thing behind introducing the mangling here was for the ability to detect the number and size of parameters passed to a function without referring to something. Producing inc files becomes much easier for large dlls then.<br /><br />So including your tlb into the package, it becomes even more open to languages.<br /><br />Regards,<br />Art</div>
    <div class="meta">Posted on 2003-11-27 11:40:42 by art_sands</div>
   </div>
   <div class="post" id="post-125773">
    <div class="subject"><a href="#post-125773">Calling DLL from VB</a></div>
    <div class="body">OK - there seems to be many opinions on how to call DLLs from VB.<br /><br />If you use a Windows API call you use the Private Declare function method - and that is the way to call your assy DLL<br /><br />build your DLL and use a .DEF file to Export (make public) the routines you want to use.<br /><br />Once the file has been assembled(turned into a DLL) to use the DLL routines, whilst developing your VB program copy the DLL to the windows system folder - otherwise VB won't know where to look for it.<br /><br />In your VB program declare a function eg:<br /><br />Private Declare function My_DLL_Routine lib &quot;the name of your dll.DLL&quot; (byval params as long , byval params as long etc etc) as long<br /><br />Naturally your params may not be a LONG - so put the correct para type in - also you may use byref instead of byval - but becareful with this as it this most common form of mistake which will cause a crash. Remember BYVAL passes the value whereas BYREF pass a pointer to the variable.<br />Don't forget the AS LONG (etc) after the closing bracket on the list of params - miss it off and you get some strange results.<br /><br />To call the routine simply type the name of the function eg<br /><br />My_DLL_Routine param1,param2 etc<br /><br /><br />And that is all there is to it - there is absolutely no need for all of these unusual and unnecessary routines. Just remember how you call a Windows API call like BitBlt and you can't go wrong.<br /><br />One more thing if you miss off the byval in the declaration statement 9 times out of 10 the function will still work - however the routine will not work correctly or return incorrect values or quite simply just crash - i've never had it bring up an error of Bad DLL Calling Convention.<br /><br />A Bad DLL Calling Convention is quite simply corruption of the aforementioned assy registers - remember it is Windows that is flagging the error because the value in the registers are not what it expected to see.</div>
    <div class="meta">Posted on 2003-11-27 11:49:14 by s1cjet</div>
   </div>
   <div class="post" id="post-125775">
    <div class="subject"><a href="#post-125775">Calling ASM func in VB</a></div>
    <div class="body">s1cjet I'm sorry but you are wrong.<br /><br />I'm having a Bad DLL calling convention right now and I'm preserving all those registers.<br /><br />&quot;Bad DLL calling convention (Error 49)<br />See Also    Specifics<br /><br />Arguments passed to a dynamic-link library (DLL) must exactly match those expected by the routine. Calling conventions deal with number, type, and order of arguments. This error has the following causes and solutions: <br /><br />Your program is calling a routine in a DLL that's being passed the wrong type of arguments. <br />Make sure all argument types agree with those specified in the declaration of the routine you are calling.<br /><br />Your program is calling a routine in a DLL that's being passed the wrong number of arguments. <br />Make sure you are passing the same number of arguments indicated in the declaration of the routine you are calling.<br /><br />Your program is calling a routine in a DLL, but isn't using the StdCall calling convention. <br />If the DLL routine expects arguments by value, then make sure ByVal is specified for those arguments in the declaration for the routine.<br /><br />Your Declare statement for a Windows DLL includes CDecl. &quot;<br /><br />This is about parameters not registers.<br /><br />:alright:</div>
    <div class="meta">Posted on 2003-11-27 12:01:14 by Eternal Idol Birmingham</div>
   </div>
   <div class="post" id="post-125791">
    <div class="subject"><a href="#post-125791">Calling ASM func in VB</a></div>
    <div class="body">Hi Idol,<br /><br />that's really strange - i've just tried producing an error using the method you have explained and it doesn't produce any error !!<br /><br />I'm using VB6 enterprise edition - i can't really see why the versions of VB would affect it !<br /><br />Any way - there seems to be a number of attributes to this error code and what will correct them ! In my situation corrupting the ESI EDI EBP or EBX causes the problems.</div>
    <div class="meta">Posted on 2003-11-27 14:33:35 by s1cjet</div>
   </div>
   <div class="post" id="post-125792">
    <div class="subject"><a href="#post-125792">Calling ASM func in VB</a></div>
    <div class="body">so instead of draggin it any further into the gloom of debate let's summarize a few points, whether they apply to the situation or not:<br /><br />1. Save and restore ESI, EDI, EBX, and EBP. (Never change EBP)<br />2. Verify number and type of parameters passed to be correct.<br />3. Export functions with mangled names.<br />4. Use a .def file to create function labels pointing to equivalent exported functions, thus adding support for languages that may not support name mangling.<br />5. Add typelibs for easing programming for VHLLS.<br />6. For calling functions in VC++ (a) add libs and (b) declare prototypes like this<br /><br />extern &quot;C&quot; int __stdcall MyFunc(void); (check that Mariano).<br /><br />7. Continue research and debate.<br /><br />lol<br />:grin: <br /><br />Regards,<br />Art</div>
    <div class="meta">Posted on 2003-11-27 15:08:43 by art_sands</div>
   </div>
   <div class="post" id="post-125793">
    <div class="subject"><a href="#post-125793">yahooooo</a></div>
    <div class="body">Well said Art_Sands.</div>
    <div class="meta">Posted on 2003-11-27 15:11:55 by s1cjet</div>
   </div>
   <div class="post" id="post-125808">
    <div class="subject"><a href="#post-125808">Calling ASM func in VB</a></div>
    <div class="body">Yes you are right about this three : ESI EDI and EBX, you should preserve them always.<br /><br />And of course if you change badly EBP there's a problem with PARAMETERS because EBP is the stack pointer ... <br /><br />&quot;VB can only handle _stdcall or _fastcall. Both calling conventions mean that the called function cleans up the stack and parameters are passed from right to left.<br />If you ever run into a ?Bad DLL calling convention? when you call a specific function from VB, it means that this function doesn?t support the stdcall or fastcall calling convention.&quot;<br /><br /><a target="_blank" href="http://www.mentalis.org/vbtutor/vcdll1.shtml">http://www.mentalis.org/vbtutor/vcdll1.shtml</a><br /><br />Regards.<br />:alright:</div>
    <div class="meta">Posted on 2003-11-28 02:23:52 by Eternal Idol Birmingham</div>
   </div>
   <div class="post" id="post-125868">
    <div class="subject"><a href="#post-125868">Calling ASM func in VB</a></div>
    <div class="body"><div class="quote"><br />i've been writing software for 20 years - started when i was 16 am now 36 and i've been writing commercial software for the UKs oldest and greatest software house all that time - please don't assume you know my lifes history just from one message.</div><br />Ok, good for you. That means you are not a newbie, and have even less excuse for getting the solution to this problem wrong.<br /><br /><div class="quote"><em>Originally posted by s1cjet</em><br />Once the file has been assembled(turned into a DLL) to use the DLL routines, whilst developing your VB program copy the DLL to the windows system folder - otherwise VB won't know where to look for it.</div><br />This is misleading to the point of being incorrect. You can have your assembled dll sitting in the same folder as your VB exe, as Windows checks that location first when looking for a module that needs loading (note that it is Windows that looks, not VB as you mentioned), this location is known as &quot;AppPath&quot;, most HLL programmers know of it ;) <br /><br />You can also:<br /> - add the path to the PATHs environmental variable (either USER or SYSTEM version)<br /> - directly specify the path to the dll in the VB function declare (but this is not an ideal practice)<br />It is not good practice to just throw all your dlls into the %system32% directory &quot;just so Windows can find them&quot;. As a professional developer you will already understand the reasons for that.<br /><br /><div class="quote"><em>Originally posted by s1cjet</em><br />Don't forget the AS LONG (etc) after the closing bracket on the list of params - miss it off and you get some strange results.</div><br />No you won't. The VB compiler lets you call a function and not assign the return value, it is a feature of VB (ie it allows you to treat a Function as a Sub). You will get a runtime problem though if you declare a non-value-returning API function as a Function, but then attempt to assign the return value to a variable, the compiler will be fine with this but you will get garbage in your variable, because whatever is in eax is the value assigned to the variable.<br /><br /><div class="quote"><em>Originally posted by s1cjet</em><br />A Bad DLL Calling Convention is quite simply corruption of the aforementioned assy registers - remember it is Windows that is flagging the error because the value in the registers are not what it expected to see</div><br />This is absolutely incorrect. If the registers are not preserved, you will get strange results, and most often a GPF. Windows *does not* flag an error if you don't preserve, Windows does not check for this at all. The error occurs when the calling function tries to execute an operation on, or using the value in, one of the registers that should have been preserved.<br /><br /><div class="quote"><em>Originally posted by s1cjet </em><br />before you go around telling people something is wrong please ask a few others - Windows DOES use the following registers ESI EDI EBP EBX - it doesn't matter if you are writing an EXE, DLL, Library , COM, Object or something you would like inserted up your rectum it still uses those registers.</div>No kidding? You obviously have a reading problem: i *never* said that Windows does not use those registers. *All* OS's use them (especially ebp ;) ) What i said was: the original problem had nothing to do with register preservation, and that out of the *original* list you mentioned only ebx was the mandatory one to preserve, and the rest were just preserved out of politeness to the calling function. There *are* other registers that need to be preserved, but they were not being discussed.<br /><br /><div class="quote"><em>Originally posted by s1cjet </em><br /> There are plenty of tutorials around which describe fairly well what I - and everyone who wrote the last few messages - already seem to know about this. </div>Yep, that seems to be the only place you get your knowledge from - other people's tutorials. And &quot;seem to know&quot; is a good phrase, as you have demonstrated that you actually *didn't* know. I think that if you check the following threads: <br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=6563"><u>here</u>, </a> <br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=3933"><u>here</u>, </a><br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=5501"><u>here</u>, </a><br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=5488"><u>here</u>, </a><br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=5286"><u>here</u>, </a><br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=4775"><u>here</u>, </a> <br />you will see that i indeed do &quot;seem&quot; to &quot;know about this&quot;. Also note the date on those posts (early 2002), and note that this list is not an exhaustive one on my replies to VB-&gt;asm topics. Would you like me to write you a tutorial so you can learn a little more? :alright:<br /><br /><div class="quote"><em>Originally posted by s1cjet </em><br />I'm starting to wonder if you know what assy or VB is !!! </div><br />Umm, yeah, i do, that is what my job is: a senior developer for a very large multinational software company. But this is not a pissing contest, so let's not turn it into one. The reason why i have bothered to answer your posts is because some of your information is wrong, and some of it is misleading. When there are newbies around, they take what you say as gospel, so it is important that it is correct, or at least points them to a source for correct information.<br /><br /><br /><strong>s1cjet</strong>, <br />before you write another inane flame to me, carefully read what has been written, and make sure you fully understand it. Yes i have (sort of) flamed you, but i have also pointed out your errors. Live and learn, and know your HLLs before trying to educate others on how to use a LLL.<br /><br /><br /><strong>everyone else</strong>,<br />if you are still looking for information, check the threads linked to in this post. Like i have said previously, this subject has already been discussed extensively many times before in this forum.<br /><br /><br /><br />P.S. I will not be answering any more flames in this thread because:<br /> - this forum is not the place for it<br /> - my time is too precious, i have far too many other things to be doing instead<br /> - nobody is really interested in a flame war</div>
    <div class="meta">Posted on 2003-11-28 20:08:23 by sluggy</div>
   </div>
   <div class="post" id="post-125869">
    <div class="subject"><a href="#post-125869">Oh WHAT</a></div>
    <div class="body">Sluggy,<br />I can't believe you wated your time writing that - talking about reading problems - if you look back over the recent posts you'll find that the preservation of the registers did fix the guys problem - end of story - or did you not read that art_sands said I was correct <br /><br />:alright:</div>
    <div class="meta">Posted on 2003-11-28 20:20:33 by s1cjet</div>
   </div>
   <div class="post" id="post-125884">
    <div class="subject"><a href="#post-125884">Calling ASM func in VB</a></div>
    <div class="body">jeez sluggy,<br /><br />i didn't see that comin. well let's say the debate is closed until someone else pops it out once again in some other thread. salad got what he wanted, but left us fighting. sluggy, i would say we've all poured our bits of knowledge into this thread, and everybody who contributed taught something and learnt something. Nobody's perfect.<br /><br />BTW, the links you've provided are really richie rich. Thanks and take care.<br /><br />Regards,<br />Art</div>
    <div class="meta">Posted on 2003-11-29 02:38:12 by art_sands</div>
   </div>
   <div class="post" id="post-128063">
    <div class="subject"><a href="#post-128063">Calling ASM func in VB</a></div>
    <div class="body">another good FAQ contender.</div>
    <div class="meta">Posted on 2003-12-16 18:59:59 by evil__donkey</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=16181&amp;page=1" style="">&laquo;</a><a href="../?id=16181&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="16181" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>  </div>
 </body>
</html>