<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>AVI to BMP and WAV again - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=14126" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=14126">AVI to BMP and WAV again</a></p>
   <div class="post" id="post-109158">
    <div class="subject"><a href="#post-109158">AVI to BMP and WAV again</a></div>
    <div class="body">so here are my sources.<br />the first on is a skeleton of a program that extracts first x frames from an AVI file. it works OK. the full source is in the attachment. You just have to change &quot;moviename&quot; in the source to some avi file of yours.<br /><br /><pre><code><br />.data<br />moviename db &quot;c&#58;\movies\40 40\The Prodigy - Out Of Space.mpg.avi&quot;,0<br /><br />.data?<br />hmovie dd ?<br />streami dd ?<br />bimpinfo BITMAPINFOHEADER &lt;&gt;<br />getframe dd ?<br />framenow dd ?<br /><br />.code<br />WndProc proc hWnd&#58;HWND, uMsg&#58;UINT, wParam&#58;WPARAM, lParam&#58;LPARAM<br />.if uMsg==WM_USER+1<br />	;opening file<br />	ii AVIFileOpen,addr hmovie,addr moviename,OF_SHARE_DENY_WRITE or OF_READ,0<br />	.if !eax<br />	;get video stream<br />                  ii AVIFileGetStream,hmovie,addr streami,streamtypeVIDEO,0<br />	  .if !eax<br />	     ;fill &quot;bimpinfo&quot; which is a BITMAPINFOHEADER with proper width and stuff<br />	     ;...<br />	     ;start getting frames<br />	     ii AVIStreamGetFrameOpen,streami,addr bimpinfo<br />                      .if eax<br />                  	mov getframe,eax<br />                   	mov framenow,0<br />         .repeat<br />            ii AVIStreamGetFrame,getframe,framenow<br />            .if eax<br />            	;if eax is not NULL it points to a DIB. I can write it to disk, print on screen or whatever<br />            .endif<br />            inc framenow<br />          .until framenow==30<br /><br />        	;cleaning<br />        	ii AVIStreamGetFrameClose,getframe<br />        .endif<br /><br />       ii AVIStreamRelease,streami<br />     .endif<br />    ii AVIFileRelease,hmovie<br />   .endif<br /></code></pre><br /><br /><br />and here is the second one:<br />it should extract first seconds of audio and write them, but it doesn't.<br />i dont know what is the last parameter in AVIMakeCompressedStream function so I set it to zero.<br /><br /><pre><code><br />.data<br />moviename db &quot;c&#58;\movies\40 40\The Prodigy - Out Of Space.mpg.avi&quot;,0<br />desting WAVEFORMATEX &lt;1,2,44100,44100*4,4,16,0&gt;<br />.data?<br />hmovie dd ?<br />fileboxes dd 256 dup &#40;?&#41;<br /><br />streami dd ?<br />streaminfo AVISTREAMINFO &lt;&gt;<br />streamname db &#40;sizeof AVISTREAMINFO.szName+1&#41; dup &#40;?&#41;<br /><br />deststream dd ?<br />aco AVICOMPRESSOPTIONS &lt;&gt;<br /><br /><br />.code<br />		ii AVIFileOpen,addr hmovie,addr moviename,OF_SHARE_DENY_WRITE or OF_READ,0<br />		.if !eax<br />			ii AVIFileGetStream,hmovie,addr streami,streamtypeAUDIO,0<br />			.if !eax<br />        mov aco.fccType,streamtypeAUDIO<br />        mov aco.fccHandler,0<br />        mov aco.dwKeyFrameEvery,0<br />        mov aco.dwQuality,0<br />        mov aco.dwBytesPerSecond,0<br />        mov aco.dwFlags,0 ; AVICOMPRESSF_VALID<br />        mov aco.lpFormat,offset desting<br />        mov aco.cbFormat,sizeof desting<br />        mov aco.lpParms,0<br />        mov aco.cbParms,0<br />        mov aco.dwInterleaveEvery,0<br /><br />        ii AVIMakeCompressedStream,addr deststream,streami,addr aco,0<br />        .if !eax<br />        	seconds equ 1<br />        	;ii AVIStreamRead,streami,0,44100*seconds,0,0,addr readbytes,addr readsamples<br />        	ii AVIStreamRead,deststream,0,44100*seconds,0,0,addr readbytes,addr readsamples<br />        	.if !eax<br />        		.if readbytes<br />        			;make buffer<br />        			;...<br />        			;read<br />        			;ii AVIStreamRead,streami,0,44100*seconds,eax,ecx,addr readbytes,addr readsamples<br />        			ii AVIStreamRead,deststream,0,44100*seconds,eax,ecx,addr readbytes,addr readsamples<br />        		.endif<br />        	.endif<br />        	ii AVIStreamRelease,deststream<br />        .endif<br />				ii AVIStreamRelease,streami<br /><br /></code></pre><br /><br />It works until the second AVIStreamRead func which returns FILE_READ_ERROR or sth<br /><br />in attached zip there are full sources. you have to extract all to your masm32 dir (because of macros and includes)</div>
    <div class="meta">Posted on 2003-07-03 11:22:58 by stolarz</div>
   </div>
  </div>
 </body>
</html>