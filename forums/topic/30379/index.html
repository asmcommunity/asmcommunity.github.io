<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>How do i get stdin from CGI Post method? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=30379" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=30379">How do i get stdin from CGI Post method?</a></p>
   <div class="post" id="post-213695">
    <div class="subject"><a href="#post-213695">How do i get stdin from CGI Post method?</a></div>
    <div class="body">Hello everyone.<br /><br />So i have this web-form that submits a query string using the Post method.<br />To dig this submitted query string out, i need to look at stdin.<br /><br />I know this can be done using C/C++ or assembly language using the C/C++ library;<br />but i want to learn to do this with raw assembly language and WindowsAPI.<br /><br />I did a little research and found that to get stdin, i need msvcrt.lib library and call the procedure __imp____iob.<br /><br />I even went as far as writing the following program at C and debug it:<br /><pre><code>char Buffer[512];<br />	int InputLength = 5;<br />	fread( Buffer, InputLength, 1, stdin );<br /></code></pre><br />And the disassembly shows me that stdin is actually calling the same function:<br /><pre><code><br />	char Buffer[512];<br />	int InputLength = 5;<br />0096120F &nbsp;mov &nbsp; &nbsp; &nbsp; &nbsp; dword ptr ,5 &nbsp;<br />	fread( Buffer, InputLength, 1, stdin );<br />00961219 &nbsp;mov &nbsp; &nbsp; &nbsp; &nbsp; esi,esp &nbsp;<br />0096121B &nbsp;call &nbsp; &nbsp; &nbsp; &nbsp;dword ptr [__imp____iob_func (966188h)] &nbsp;<br />.....<br /></code></pre><br /><br />The problem is that i am unable to declare the external function __imp____iob nor call it.<br />I have tried:<br /><pre><code><br />	extern __imp____iob@0:proc<br />	call	__imp____iob@0<br /><br />	or<br /><br />	extern __imp____iob_func@0:proc<br />	call	__imp____iob_func@0<br /></code></pre><br />But neither worked. So, i am wondering if it is actually named differently or something wrong i am doing.<br /><br />Here is a sample full code but not functional:<br /><pre><code>.386<br />.model flat, stdcall<br /><br />includelib kernel32.lib<br />includelib msvcrt.lib<br /><br />;Writes to stdout or browser<br />WriteFile macro consoleHandle, stringAddr, stringSize, outBytesWritten<br />	extern WriteFile@20:proc<br />	push	0<br />	push	offset outBytesWritten<br />	mov	ebx, stringSize<br />	push	ebx<br />	push	offset stringAddr<br />	push	consoleHandle<br />	call	WriteFile@20<br />endm<br /><br />.data<br />string byte &quot;content-type: text/plain&quot;,0Ah,0Ah<br />stringSize equ ($ - string)<br /><br />STD_OUTPUT_HANDLE equ -11<br />consoleOutputHandle dword ?<br />bytesWritten dword ?<br /><br />queryString byte 5 dup(?)<br /><br />.code<br />main PROC<br />	;Trying to call stdin<br />	extern __imp__iob@0:proc<br />	call	__imp__iob@0<br />	mov	dword ptr queryString, eax<br /><br />	;Get the console handle to output into stdout<br />	extern GetStdHandle@4:proc<br />	push	STD_OUTPUT_HANDLE<br />	call	GetStdHandle@4<br />	mov	consoleOutputHandle, eax<br /><br />	WriteFile consoleOutputHandle, string, stringSize, bytesWritten<br />	WriteFile consoleOutputHandle, queryString, 4, bytesWritten<br /><br />	;Exit program<br />	extern ExitProcess@4:proc<br />	push	0<br />	call	ExitProcess@4<br />main ENDP<br />END main</code></pre></div>
    <div class="meta">Posted on 2010-12-21 20:25:41 by banzemanga</div>
   </div>
   <div class="post" id="post-213697">
    <div class="subject"><a href="#post-213697">Re: How do i get stdin from CGI Post method?</a></div>
    <div class="body">I was able to find my own answer.<br />msvcrt.lib stands for Microsoft Visual C Runtime meaning that __imp____iob_func is part of Microsoft&#039;s C library which is not what i wanted.<br /><br />To get stdin from Windows API i need to use ReadFile. I was using ReadConsole which did not access stdin.</div>
    <div class="meta">Posted on 2010-12-22 01:33:24 by banzemanga</div>
   </div>
   <div class="post" id="post-213698">
    <div class="subject"><a href="#post-213698">Re: How do i get stdin from CGI Post method?</a></div>
    <div class="body">In case anybody is interested, here is the full working code:<br /><div class="quote">includelib kernel32.lib<br /><br />extern ExitProcess@4:proc<br />exit macro	<br />	push	0<br />	call	ExitProcess@4<br />endm<br /><br />GetEnvironmentVariableA macro envVar, buffer, outBufferSize<br />	extern GetEnvironmentVariableA@12:proc<br />	push	0<br />	push	0<br />	push	offset envVar<br />	call	GetEnvironmentVariableA@12<br />	push	eax<br />	dec		eax<br />	mov		outBufferSize, eax<br />	push	offset buffer<br />	push	offset envVar<br />	call	GetEnvironmentVariableA@12<br />endm<br /><br />STD_INPUT_HANDLE equ -10<br />STD_OUTPUT_HANDLE equ -11<br />STD_ERROR_HANDLE equ -12<br />GetStdHandle macro requestHandle, returnHandle<br />	extern GetStdHandle@4:proc<br />	push	requestHandle<br />	call	GetStdHandle@4<br />	mov		returnHandle, eax<br />endm<br /><br />ReadFile macro consoleHandle, buffer, numberOfCharsToRead, pNumberOfCharsRead<br />	extern ReadFile@20:proc<br />	push	0<br />	push	offset pNumberOfCharsRead<br />	push	numberOfCharsToRead<br />	push	offset buffer<br />	push	consoleHandle<br />	call	ReadFile@20<br />endm<br /><br />WriteFile macro consoleHandle, stringAddr, stringSize, outBytesWritten<br />	extern WriteFile@20:proc<br />	push	0<br />	push	offset outBytesWritten<br />	mov		ebx, stringSize<br />	push	ebx<br />	push	offset stringAddr<br />	push	consoleHandle<br />	call	WriteFile@20<br />endm</div><br /><div class="quote">.386<br />.model flat, stdcall<br /><br />include macros.inc<br /><br />.data<br />;Variables<br />consoleInputHandle dword ?<br />consoleOutputHandle dword ?<br />bytesWritten dword ?<br />bytesRead dword ?<br /><br />string byte &quot;content-type: text/plain&quot;,0Ah,0Ah<br />stringSize equ ($ - string)<br /><br />envVar byte &quot;content_length&quot;,0<br />envVarOut byte 128 dup (?)<br />envVarSize dword ?<br /><br />buffer byte 128 dup (?)<br /><br /><br />.code<br />main PROC<br />	GetEnvironmentVariableA envVar, envVarOut, envVarSize<br /><br />	GetStdHandle STD_OUTPUT_HANDLE, consoleOutputHandle<br />	GetStdHandle STD_INPUT_HANDLE, consoleInputHandle<br />	<br />	;Converts numeric string to integer<br />	xor		eax, eax<br />	mov		ebx, offset envVarOut<br />	xor		edx, edx<br />	next_char:<br />		mov		ecx, eax<br />		shl		eax, 1<br />		shl		ecx, 3<br />		add		eax, ecx<br />		add		eax, edx<br />		mov		edx, byte ptr <br />		add		ebx, 1<br />		sub		edx, 48<br />	jnb next_char<br /><br />	ReadFile consoleInputHandle, buffer, eax, bytesRead<br /><br />	WriteFile consoleOutputHandle, string, stringSize, bytesWritten<br />	WriteFile consoleOutputHandle, buffer, bytesRead, bytesWritten<br /><br />	exit<br />main ENDP<br />END main</div></div>
    <div class="meta">Posted on 2010-12-22 03:40:07 by banzemanga</div>
   </div>
  </div>
 </body>
</html>