<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>WinFax, ANSI, Unicode String Problems - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=13581" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=13581">WinFax, ANSI, Unicode String Problems</a></p>
   <div class="post" id="post-105239">
    <div class="subject"><a href="#post-105239">WinFax, ANSI, Unicode String Problems</a></div>
    <div class="body">Hi Guys,<br />I am trying to develop a fax application using the winfax API but i am<br />running into a problem at the FaxSendDocument call.<br />If i call FaxSendDocument the program terminates and start Ollydbg however<br />if i call FaxSendDocumentW then the program runs normally but it will not <br />find the file i am trying to send even if the file is available in the <br />directory. <br />The problem seems to be Ansi string vs Unicode String but i am sure. I am<br />running on a windows 2000 PC.<br />Any help greatly appreciated.<br /><br />Shiny <br /><br />;---------------------MakeFile-----------------------------------------------<br />FaxApp.exe: FaxApp.obj FaxDlg.res<br />        Link /SUBSYSTEM:WINDOWS FaxApp.obj FaxDlg.res<br />FaxDlg.res: FaxDlg.rc<br />        rc FaxDlg.rc<br />FaxApp.obj: FaxApp.asm<br />        ml /c /coff FaxApp.asm<br />;----------------------------------------------------------------------------------<br /><br />.486<br />.model flat, stdcall  ;32 bit memory model<br />option casemap :none  ;case sensitive<br /><br />;----------------IMPORT LIBRARIES----------------------------------------<br />includelib \masm32\lib\user32.lib<br />includelib \masm32\lib\kernel32.lib<br />includelib \Masm32\lib\winfax.lib<br />;-------------------------------------------------------------------------------------<br /><br />;----------------INCLUDE FILES------------------------------------------------<br />include \masm32\include\windows.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\user32.inc<br />include \Masm32\include\winfax.inc<br />;--------------------------------------------------------------------------------------<br /><br />;----------------PROCEDURE PROTOTYPES--------------------------------<br />SendProc proto  hWnd:UINT<br />DlgProc PROTO :DWORD,:DWORD,:DWORD,:DWORD<br />PERR PROTO :DWORD<br />;---------------------------------------------------------------------------------------<br /><br />.const	<br />	btnSend				equ 1004<br />	<br />.data<br />	RName				db		&quot;Shiny&quot;,0 	<br />	RNumber				db		&quot;228547&quot;,0<br />	SName				db		&quot;Shiny&quot;,0<br />	SNumber				db		&quot;202992&quot;,0<br />	SId				db		&quot;Gainaco&quot;,0<br />	TPage 				db		&quot;confident.cov&quot;,0<br />	msg 				db		&quot;Successful&quot;,0<br />	AppName				db		&quot;Fax Application&quot;,0<br />	dlgName				db		&quot;FaxDialog&quot;,0<br />	<br />	<br />.data?<br />	hFax				dd ?<br />	hInstance			dd ?<br />	CommandLine			dd ?<br />	JobId				dd ?<br />	<br />.code<br /><br />start:<br />	invoke GetModuleHandle,NULL<br />	mov		hInstance,eax<br />	invoke GetCommandLine<br />	mov		CommandLine,eax<br />	;Show dialogbox<br />	invoke DialogBoxParam,hInstance,ADDR dlgName,NULL, addr DlgProc,NULL<br />	<br />	invoke ExitProcess,0<br /><br /><br />DlgProc proc hWin:HWND,uMsg:UINT,wParam:WPARAM,lParam:LPARAM<br /><br />	mov		eax,uMsg<br />	.if eax==WM_INITDIALOG<br />	.elseif eax==WM_COMMAND<br />		mov		eax,wParam<br />		mov		edx,eax<br />		shr		edx,16<br />		and		eax,0FFFFh<br />		.if edx==BN_CLICKED<br />			.if eax==btnBrowse<br />			.elseif eax==btnSend<br />				INVOKE SendProc, hWin<br />			.elseif eax==btnCancel<br />			.endif<br />		.endif<br />	.elseif eax==WM_CLOSE<br />		invoke EndDialog,hWin,0<br />	.else<br />		mov		eax,FALSE<br />		ret<br />	.endif<br /><br />	mov		eax,TRUE<br />	ret<br />DlgProc endp<br /><br />SendProc proc  hWnd:UINT<br />	LOCAL fjp:FAX_JOB_PARAMA<br />	LOCAL fci:FAX_COVERPAGE_INFOA<br />	<br />	INVOKE FaxConnectFaxServer, NULL, ADDR hFax	<br />	<br />cmp eax, 0			;If equals an error has occured<br />je ErrorMessage		<br />		mov fjp.SizeOfStruct, SIZEOF FAX_JOB_PARAMA<br />		mov fjp.RecipientNumber, OFFSET RNumber<br />		mov fjp.RecipientName, OFFSET RName <br />		mov fjp.Tsid, OFFSET SId<br />		mov fjp.SenderName, OFFSET SName <br />		mov fjp.ScheduleAction, JSA_NOW<br />		mov fjp.DeliveryReportType, DRT_NONE<br />		mov fjp.DeliveryReportAddress, NULL<br /><br />		mov fci.SizeOfStruct, SIZEOF FAX_COVERPAGE_INFOA<br />			<br />		INVOKE FaxSendDocumentW, hFax, ADDR TPage, ADDR fjp, ADDR fci, ADDR JobId<br />		<br />cmp eax, 0			;If equals an error has occured<br />je ErrorMessage				<br />		invoke MessageBox,hWnd,addr msg,addr AppName,MB_OK	<br />		jmp EndError<br />ErrorMessage:<br />		INVOKE PERR, hWnd<br />				<br />EndError:<br /><br />ret<br />SendProc endp<br /><br /><br />PERR	PROC uses ebx edi esi hWnd:DWORD	<br />	LOCAL	szMsgBuf[200]:BYTE<br /><br />	INVOKE GetLastError<br />	mov	ebx, eax<br />	INVOKE FormatMessage, \<br />		FORMAT_MESSAGE_FROM_SYSTEM,\<br />		NULL, \<br />		ebx, \					;Message Id<br />		LANG_NEUTRAL + SUBLANG_DEFAULT*1024, \	;Message language<br />		ADDR szMsgBuf, \			;Buffer to store message<br />		500, \					;Buffer size<br />		NULL					;No more arguments<br />	INVOKE	MessageBox, hWnd, ADDR szMsgBuf, NULL, MB_OK<br /><br />	ret<br />PERR	ENDP<br /><br />end start<br />;---------------------------------------------------------------------------------------<br /><br /><br /><br />;---------------------FaxDlg.rc-------------------------------------------------------------<br />#define IDDD 1000<br />#define btnSend 1004<br />FaxDialog DIALOGEX 4,4,100,44<br />CAPTION &quot;Send Fax Document&quot;<br />FONT 12,&quot;MS Sans Serif&quot;<br />STYLE 0x10CE0000<br />EXSTYLE 0x00000000<br />BEGIN<br />  <br />  PUSHBUTTON &quot;Send&quot;,btnSend,30,20,57,12,NOT 0x00820000|0x50010000,0x00000000<br /><br />END<br />;-------------------------------------------------------------------------------------------<br /><br /><br /><br />;---------------------------------Structures------------------------------------------------<br />FAX_COVERPAGE_INFOA       STRUCT<br />    SizeOfStruct                                        DWORD ?  ;  Size of this structure<br />    CoverPageName                                       LPCSTR ?  ;  coverpage document name<br />    UseServerCoverPage                                  BOOL ?  ;  coverpage exists on the fax server<br />    RecName                                             LPCSTR ?  ; <br />    RecFaxNumber                                        LPCSTR ?  ; <br />    RecCompany                                          LPCSTR ?  ; <br />    RecStreetAddress                                    LPCSTR ?  ; <br />    RecCity                                             LPCSTR ?  ; <br />    RecState                                            LPCSTR ?  ; <br />    RecZip                                              LPCSTR ?  ; <br />    RecCountry                                          LPCSTR ?  ; <br />    RecTitle                                            LPCSTR ?  ; <br />    RecDepartment                                       LPCSTR ?  ; <br />    RecOfficeLocation                                   LPCSTR ?  ; <br />    RecHomePhone                                        LPCSTR ?  ; <br />    RecOfficePhone                                      LPCSTR ?  ; <br />    SdrName                                             LPCSTR ?  ; <br />    SdrFaxNumber                                        LPCSTR ?  ; <br />    SdrCompany                                          LPCSTR ?  ; <br />    SdrAddress                                          LPCSTR ?  ; <br />    SdrTitle                                            LPCSTR ?  ; <br />    SdrDepartment                                       LPCSTR ?  ; <br />    SdrOfficeLocation                                   LPCSTR ?  ; <br />    SdrHomePhone                                        LPCSTR ?  ; <br />    SdrOfficePhone                                      LPCSTR ?  ; <br />    Note                                                LPCSTR ?  ; <br />    Subject                                             LPCSTR ?  ; <br />    TimeSent                                            SYSTEMTIME &lt;&gt;  ;  Time the fax was sent<br />    PageCount                                           DWORD ?  ;  Number of pages<br />FAX_COVERPAGE_INFOA ENDS<br /><br /><br />FAX_JOB_PARAMA       STRUCT<br />    SizeOfStruct                                        DWORD ?  ;  size of this structure<br />    RecipientNumber                                     LPCSTR ?  ;  recipient fax number<br />    RecipientName                                       LPCSTR ?  ;  recipient name<br />    Tsid                                                LPCSTR ?  ;  transmitter's id<br />    SenderName                                          LPCSTR ?  ;  sender name<br />    SenderCompany                                       LPCSTR ?  ;  sender company<br />    SenderDept                                          LPCSTR ?  ;  sender department<br />    BillingCode                                         LPCSTR ?  ;  billing code<br />    ScheduleAction                                      DWORD ?  ;  when to schedule the fax, see JSA defines<br />    ScheduleTime                                        SYSTEMTIME &lt;&gt;  ;  time to send the fax when JSA_SPECIFIC_TIME is used (must be local time)<br />    DeliveryReportType                                  DWORD ?  ;  delivery report type, see DRT defines<br />    DeliveryReportAddress                               LPCSTR ?  ;  email address for delivery report (ndr or dr) thru MAPI / SMTP<br />    DocumentName                                        LPCSTR ?  ;  document name (optional)<br />    CallHandle                                          DWORD 0  ;  optional call handle<br />    Reserved                                            DWORD 3 dup(0)  ;  reserved for ms use only<br />FAX_JOB_PARAMA ENDS<br />;--------------------------------------------------------------------------------------------<br /><br /><br />---------------------Equates--------------------------------------------------------<br />JSA_NOW    					equ 00000000h   <br />DRT_NONE					equ 00000000h<br />;-----------------------------------------------------------------------------------</div>
    <div class="meta">Posted on 2003-05-29 05:52:59 by shiny</div>
   </div>
   <div class="post" id="post-109136">
    <div class="subject"><a href="#post-109136">WinFax, ANSI, Unicode String Problems</a></div>
    <div class="body">Hi<br /><br />I have managed to figure out the problem. The problem is that FAX_JOB_PARAMA and FAX_COVERPAGE_INFOA structures should not be declared as local. They should be in the data section. I have successfully sent a fax with the program.<br /><br />shiny</div>
    <div class="meta">Posted on 2003-07-03 06:09:20 by shiny</div>
   </div>
  </div>
 </body>
</html>