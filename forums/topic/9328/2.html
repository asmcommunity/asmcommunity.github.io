<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Predefined WNDCLASSEX? Any dis-/advantage? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=9328" />
  <link rel="prev" href="../?id=9328&amp;page=1" />   </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=9328">Predefined WNDCLASSEX? Any dis-/advantage?</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=9328&amp;page=1" style="">&laquo;</a><a href="../?id=9328&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="9328" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>   <div class="post" id="post-69220">
    <div class="subject"><a href="#post-69220">Predefined WNDCLASSEX? Any dis-/advantage?</a></div>
    <div class="body">Steve,<br />your size optimization has nothing to do<br />with our discussion of LOCAL wc vs GLOBAL.<br />Size of exe is small for the only reason:<br />you didn't use .data section placing all asciiz constant<br />into .code section.<br />BTW:<br />You don't need to put it this way:<br />jmp lbl<br />someasciiz db 'Text',0<br />lbl:<br />It waste of clocks and size.<br />If you want to have them in code section<br />just declare them after .code statemnt but BEFORE<br />entry point<br />Example:<br />.code<br />txtvar db 'Some text',0<br />somedata dd 12345<br />start:<br /><br />This way you put it into code section but don't need to jump<br />over the data.<br /><br />OK to our discussion:<br />I failed to compile your source using your make file and inc:<br />(paths were changed, of course)<br />It asked me for proto.<br />So I added line in inc file<br />include C:\masm32\INCLUDEX\ARGCOUNT.ASM <br />it is your macro.<br />This way it was compiled but size was 2048.<br />Might be different LINK or whatever. I don't know yet.<br />However it is irrelevant to discussion: I show later why.<br /><br />As I said size is small only because of not using .data section,<br />so I think it was fare enough to place WNDCLASSEX sturture in<br />code section also.<br />For clarity of experiment I didn't optimize anything (though<br />some places looks starnge - for example you have 0 in esi<br />but don't use it all time - in LoadIcon,LoadCursor for example)<br /><br />What I did: <br />I placed WNDCLASSEX struct with predefined members in code<br />section:<br /><pre><code><br />.code<br />; ?????????????????????????????????????????????????????????????????????????<br />wc WNDCLASSEX &lt;sizeof wc,CS_VREDRAW or CS_HREDRAW,offset WndProc,,,400000h,,,\<br />		COLOR_BTNFACE+1,,offset szClassName,&gt;<br /><br />start&#58;<br /></code></pre><br />then I commented declaretion of local wc<br />and all code that moves values to members that are already filled in wc.<br />I left only code for members that need to be fill in runtime using edi as <br />pointer to wc<br />    mov edi, offset wc        ; edi = pointer to wc<br />    assume edi: ptr WNDCLASSEC<br />it costs 5 extra bytes for mov edi,imm32<br />but make addressing to members as short as in your code<br />(locals addressed by ebp+offset)<br />and also save bytes that you waste in loading address of wc in eax<br />when:<br />	RegisterClassEx, addr wc ; addr wc = lea eax,wc push eax<br /><br />That's all I did, I didn't change anithing else exept for specifing .code section<br />as writable in makefile.<br />And I got the same size exe.<br /><br />Now let's look inside both of them and extract the only data that is matter<br />for our discussion:<br />In your case you fill all members but don't waste size for predefined structure<br />In my case I waste 48 bytes of code section for predefined structure <br />but don't waste size for code to fill members that is already filled in design time<br />HAVE A LOOK:<br />LOCAL wc approach:<br /><pre><code><br />00401016  |. BF 00004000    MOV EDI,SMALLWIN.00400000<br />5 bytes<br />0040103A  |&gt; C745 B0 30000000       MOV &#91;LOCAL.20&#93;,30<br />00401041  |. C745 B4 03000000       MOV &#91;LOCAL.19&#93;,3<br />00401048  |. C745 B8 FF104000       MOV &#91;LOCAL.18&#93;,SMALLWIN.004010FF<br />0040104F  |. 8975 BC                MOV &#91;LOCAL.17&#93;,ESI<br />00401052  |. 8975 C0                MOV &#91;LOCAL.16&#93;,ESI<br />00401055  |. 897D C4                MOV &#91;LOCAL.15&#93;,EDI<br />00401058  |. C745 D0 10000000       MOV &#91;LOCAL.12&#93;,10<br />0040105F  |. 8975 D4                MOV &#91;LOCAL.11&#93;,ESI<br />00401062  |. C745 D8 1D104000       MOV &#91;LOCAL.10&#93;,SMALLWIN.0040101D         ;  ASCII &quot;smallwin_Class&quot;<br />47 bytes<br />00401076  |. 8945 C8                MOV &#91;LOCAL.14&#93;,EAX<br />00401079  |. 8945 DC                MOV &#91;LOCAL.9&#93;,EAX<br /><br />6 bytes<br />00401089  |. 8945 CC                MOV &#91;LOCAL.13&#93;,EAX<br />0040108C  |. 8D45 B0                LEA EAX,&#91;LOCAL.20&#93;<br /><br />6 bytes<br />5+47+6+6 = 64 bytes<br />=========================================================<br />Predefined wc approach<br />size of WNDCLASSEX = 30h = 48 bytes<br />+<br />004010A3  |. BF 40104000            MOV EDI,Smallwin.00401040 ;pointer to wc<br />5 bytes<br />fill icon handlers<br />004010B4  |. 8947 18                MOV &#91;DWORD DS&#58;EDI+18&#93;,EAX<br />004010B7  |. 8947 2C                MOV &#91;DWORD DS&#58;EDI+2C&#93;,EAX<br />6 bytes<br />fill cursor handler<br />004010C6  |. 8947 1C                MOV &#91;DWORD DS&#58;EDI+1C&#93;,EAX<br />3 bytes<br />48+5+6+3= 62 bytes<br /></code></pre><br /><br />64 in your code<br />62 in mine.<br /><br />+ because of data of wc in my code can not be spoiled I can use it for<br />some purpose in other windows code.</div>
    <div class="meta">Posted on 2002-12-05 07:27:17 by The Svin</div>
   </div>
   <div class="post" id="post-69338">
    <div class="subject"><a href="#post-69338">Predefined WNDCLASSEX? Any dis-/advantage?</a></div>
    <div class="body">Alex,<br /><br />The macro for the prototype style I used is in the windows.inc from version 7 of MASM32. The only reason why I used the alternative prototype form was that I had this example on this machine.<br /><br />I also use the linker from the win98ddk as it has more capacity than the later versions, library production being just one of them.<br /><br />I posted the 1536 byte example for a reason, it is built with dynamic code only and for its functionality, the alternative preloaded static data design does not build smaller. I think your approach is clever but it comes at the expense of a writable code section and a single global structure that hads to be overwritten each time it is used.<br /><br />You can get an advantage if you only ever change the classname for a registered windows class but it falls off quickly when you must change window styles, icons, cursors, window memory, background colour etc ...<br /><br />Now putting the embedded data before the start label is a good idea except that you lose the proximity to the code that uses it to save a single jump and the code is no smaller for doing so.<br /><br />I have sold the view for some time that close range micro optimisation at the mnemonics level does not produce smaller exe files but it certainly can produce code that is hard to read and hard to maintain and even harder to extend into useful application code.<br /><br />There are in fact places where you can take advantage of preset data and you can get an advantage in performance terms but loading the parameters into a WNDCLASSEX structure for a RegisterClassEx call is simply not one of them.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-12-05 18:44:12 by hutch--</div>
   </div>
   <div class="post" id="post-69392">
    <div class="subject"><a href="#post-69392">Predefined WNDCLASSEX? Any dis-/advantage?</a></div>
    <div class="body">Further trivial size optimised code.<br /><br />Source<br /><pre><code><br />  ; --------------------------------<br />  ; zero fill structure in 12 bytes<br />  ; --------------------------------<br />    lea edi, wc<br />    xor eax, eax<br />    mov ecx, 12<br />    rep stosd<br /><br />    xor esi, esi            ; store zero in ESI<br />    mov edi, 400000h        ; store EXE instance handle in EDI<br /><br />    mov wc.cbSize,         sizeof WNDCLASSEX<br />    mov wc.style,          CS_VREDRAW or CS_HREDRAW<br />    mov wc.lpfnWndProc,    offset WndProc<br />    mov wc.hInstance,      edi<br />    mov wc.hbrBackground,  COLOR_BTNFACE+1<br />    mov wc.lpszClassName,  offset szClassName<br />    <br />    invoke LoadIcon,esi,IDI_ASTERISK<br />    mov wc.hIcon,          eax<br />    mov wc.hIconSm,        eax<br /><br />    invoke LoadCursor,esi,IDC_ARROW<br />    mov wc.hCursor,        eax<br /></code></pre><br /><br />Disassembly<br /><pre><code><br />00401031 8D7DB0                 lea     edi,&#91;ebp-50h&#93;                   ; 12<br />00401034 33C0                   xor     eax,eax<br />00401036 B90C000000             mov     ecx,0Ch<br />0040103B F3AB                   rep     stosd<br /><br />0040103D 33F6                   xor     esi,esi<br /><br />; -------------------------------------<br />; used after loading structure as well, 5 bytes<br />; -------------------------------------<br />0040103F BF00004000             mov     edi,400000h                     ; 5<br /><br />00401044 C745B030000000         mov     dword ptr &#91;ebp-50h&#93;,30h         ; 7<br />0040104B C745B403000000         mov     dword ptr &#91;ebp-4Ch&#93;,3           ; 7<br />00401052 C745B8FE104000         mov     dword ptr &#91;ebp-48h&#93;,4010FEh     ; 7<br />00401059 897DC4                 mov     &#91;ebp-3Ch&#93;,edi                   ; 3<br />0040105C C745D010000000         mov     dword ptr &#91;ebp-30h&#93;,10h         ; 7<br />00401063 C745D800104000         mov     dword ptr &#91;ebp-28h&#93;,401000h     ; 7<br />0040106A 68047F0000             push    7F04h<br />0040106F 56                     push    esi<br />00401070 FF1534204000           call    dword ptr &#91;LoadIconA&#93;<br />00401076 8945C8                 mov     &#91;ebp-38h&#93;,eax                   ; 3<br />00401079 8945DC                 mov     &#91;ebp-24h&#93;,eax                   ; 3<br />0040107C 68007F0000             push    7F00h<br />00401081 56                     push    esi<br />00401082 FF1530204000           call    dword ptr &#91;LoadCursorA&#93;<br />00401088 8945CC                 mov     &#91;ebp-34h&#93;,eax                   ; 3<br /><br />--------------------------------------------------total = 64 bytes<br /></code></pre><br /><br />For 64 bytes, you save the extra bytes in the following CreateWindowEx call with the instance handle already being in EDI.<br /><br />None of these things make the final EXE size any smaller and if you enable the equate in the one I posted to exclude code in the Wndproc, it will build bigger to the tune of 512 bytes.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-12-05 21:55:32 by hutch--</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=9328&amp;page=1" style="">&laquo;</a><a href="../?id=9328&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="9328" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>  </div>
 </body>
</html>