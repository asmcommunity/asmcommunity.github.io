<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Predefined WNDCLASSEX? Any dis-/advantage? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=9328" />
    <link rel="next" href="../?id=9328&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=9328">Predefined WNDCLASSEX? Any dis-/advantage?</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=9328&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=9328&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="9328" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=9328&amp;page=2">&gt;</a><a href="../?id=9328&amp;page=2">&raquo;</a></form>   <div class="post" id="post-68860">
    <div class="subject"><a href="#post-68860">Predefined WNDCLASSEX? Any dis-/advantage?</a></div>
    <div class="body">The other day I started to think about why do you need<br />to use mov/pop etc. to fill that structure? couldnt it just be<br />predefined? or will it just have no advantage at all?<br /><br />Needless to say that you would still need to fill some<br />values with calls like 'LoadIcon/LoadCursor' etc.<br /><br />Example code,<br /><pre><code>WNDCLASSEX &lt;sizeof WNDCLASSEX,\<br />CS_HREDRAW or CS_VREDRAW,\<br />offset WndProc,0,0,\<br />400000h,0,0,\<br />COLOR_WINDOW+1,0,\<br />offset szClassName,0&gt;</code></pre></div>
    <div class="meta">Posted on 2002-12-03 13:32:18 by natas</div>
   </div>
   <div class="post" id="post-68862">
    <div class="subject"><a href="#post-68862">Predefined WNDCLASSEX? Any dis-/advantage?</a></div>
    <div class="body">That looks like my code :grin: <br /><br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=6645&amp;highlight=WNDCLASSEX">http://www.asmcommunity.net/board/index.php?topic=6645&amp;highlight=WNDCLASSEX</a><br /><br />The only advantage is that you dont need all that mov/push/pop stuff :) The WNDCLASSEX contains fixed data anyway, so why should you add it dynamic then? :)</div>
    <div class="meta">Posted on 2002-12-03 13:35:25 by bazik</div>
   </div>
   <div class="post" id="post-68864">
    <div class="subject"><a href="#post-68864">WOW! Your right! it does look like your code.</a></div>
    <div class="body"><strong>Bazik,</strong> What? trust me when I say that I have never seen<br />that thread before(seriously, but what a coincidence.) So then<br />there is an advantage. Since it produces less code it's way<br />better. Thanks for confirming what i believed to be correct. :alright:</div>
    <div class="meta">Posted on 2002-12-03 13:41:04 by natas</div>
   </div>
   <div class="post" id="post-68866">
    <div class="subject"><a href="#post-68866">Predefined WNDCLASSEX? Any dis-/advantage?</a></div>
    <div class="body">JFYI: I use WNDCLASSEX that way since <strong>The Svin</strong> posted this method in the old assembly forum (also the 400000h thing) and never had any problems :)</div>
    <div class="meta">Posted on 2002-12-03 14:05:23 by bazik</div>
   </div>
   <div class="post" id="post-68869">
    <div class="subject"><a href="#post-68869">Gotta love The Svin!</a></div>
    <div class="body">After I started to 'really' think about my question. I know believe<br />it was a pretty dumb thing to ask. Since all the code does is to define <br />variables inside the structure. Wich should be no different from defining <br />something like: 'szDoobie DB &quot;MyDoobie&quot;,0'. Oh well.. <br />:stupid: <br /><br />Anyway, The Svin always have alot of good things to say.<br />Maybe he could write some optimizations for W32Asm? ( ;) )<br />Hopefully he reads this and wants to comment.</div>
    <div class="meta">Posted on 2002-12-03 14:44:37 by natas</div>
   </div>
   <div class="post" id="post-68873">
    <div class="subject"><a href="#post-68873">Re: Gotta love The Svin!</a></div>
    <div class="body"><div class="quote"><br />After I started to 'really' think about my question. I know believe<br />it was a pretty dumb thing to ask. Since all the code does is to define <br />variables inside the structure. Wich should be no different from defining <br />something like: 'szDoobie DB &quot;MyDoobie&quot;,0'. Oh well.. <br />:stupid:  </div><br /><br />But as I said you dont need to mov/push/pop stuff in the structure and that saves some bytes :grin:</div>
    <div class="meta">Posted on 2002-12-03 15:01:09 by bazik</div>
   </div>
   <div class="post" id="post-68875">
    <div class="subject"><a href="#post-68875">Predefined WNDCLASSEX? Any dis-/advantage?</a></div>
    <div class="body"><strong>Bazik,</strong> <span style="font-size:18px><em>Dont /PushME/PopME/ OR MoveME!</em></span><span style="font-size:9px>AGREE?</span> :grin:</div>
    <div class="meta">Posted on 2002-12-03 15:26:21 by natas</div>
   </div>
   <div class="post" id="post-68879">
    <div class="subject"><a href="#post-68879">Predefined WNDCLASSEX? Any dis-/advantage?</a></div>
    <div class="body"><div class="quote">The Svin always have alot of good things to say. Maybe he could write some optimizations for W32Asm?</div><br /><br />You need to spend some time on the Algo &amp; Source forum...  :grin:</div>
    <div class="meta">Posted on 2002-12-03 15:52:56 by S/390</div>
   </div>
   <div class="post" id="post-68883">
    <div class="subject"><a href="#post-68883">Predefined WNDCLASSEX? Any dis-/advantage?</a></div>
    <div class="body"><div class="quote"><em>Originally posted by S/390 </em><strong><br />You need to spend some time on the Algo &amp; Source forum...  :grin: </div><br />Actually I think you're right! ( :) ) I dont spend enough time there. Maybe<br />the time has come for me to be brave and camp there for a couple of days :grin:</div>
    <div class="meta">Posted on 2002-12-03 16:01:00 by natas</div>
   </div>
   <div class="post" id="post-68891">
    <div class="subject"><a href="#post-68891">Predefined WNDCLASSEX? Any dis-/advantage?</a></div>
    <div class="body">Predefined structures work fine but you have this problem, it does add to the size of the assembled file as it is in the initialised data section and it still must have runtime derived data added to it at runtime so it reduces the advantage by requiring code to be added to it.<br /><br />This is fine in tiny test pieces but it is not reusable code so for each window you need to create, you have to add another predefined WNDCLASSEX structure to your initialised data section.<br /><br />A WNDCLASSEX structure is 48 bytes long and you still have to add code to it at runtime.<br /><br />96 bytes gives you fully reusable code that does not inflate the .DATA section and handles all of the parameter placement in the WNDCLASSEX in one place. This is why I use the following code.<br /><pre><code><br />; ?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?<br /><br />RegisterWinClass proc lpWndProc&#58;DWORD, lpClassName&#58;DWORD,<br />                      Icon&#58;DWORD, Cursor&#58;DWORD, bColor&#58;DWORD<br /><br />    LOCAL wc&#58;WNDCLASSEX<br /><br />    mov wc.cbSize,         sizeof WNDCLASSEX<br />    mov wc.style,          CS_BYTEALIGNCLIENT or \<br />                           CS_BYTEALIGNWINDOW<br />    m2m wc.lpfnWndProc,    lpWndProc<br />    mov wc.cbClsExtra,     NULL<br />    mov wc.cbWndExtra,     NULL<br />    m2m wc.hInstance,      hInstance<br />    m2m wc.hbrBackground,  bColor<br />    mov wc.lpszMenuName,   NULL<br />    m2m wc.lpszClassName,  lpClassName<br />    m2m wc.hIcon,          Icon<br />    m2m wc.hCursor,        Cursor<br />    m2m wc.hIconSm,        Icon<br /><br />    invoke RegisterClassEx, ADDR wc<br /><br />    ret<br /><br />RegisterWinClass endp<br /><br />; ?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?<br /></code></pre><br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-12-03 16:32:59 by hutch--</div>
   </div>
   <div class="post" id="post-68901">
    <div class="subject"><a href="#post-68901">Predefined WNDCLASSEX? Any dis-/advantage?</a></div>
    <div class="body"><div class="quote">it is not reusable code so for each window you need to create, you have to add another predefined WNDCLASSEX structure to your initialised data section.</div><br /><br />hutch, I don't think this is correct. I've used the same structure to register multiple windows. I'll just change the name, proc address, style, maybe icon, etc. Once you issue registerclass the struture is never referenced again. That's also why you can get away with making it a local.<br /><br />:)</div>
    <div class="meta">Posted on 2002-12-03 17:50:43 by S/390</div>
   </div>
   <div class="post" id="post-68902">
    <div class="subject"><a href="#post-68902">Predefined WNDCLASSEX? Any dis-/advantage?</a></div>
    <div class="body">I had a little time to waste this morning so I put the theories to the test. Size results are below.<br /><br />For identical functionality of a dynamically produced instance handle, both static and dynamic methods are 88 bytes long. Where you can save 10 bytes is if you preset the instance handle at 400000h but this cannot be used in a DLL as it is not known at assembler time.<br /><br />What removes the advantage of presetting the parameters for the RegisterClassEx function is that some parameters can only be determined at runtime and this means providing the code to overwrite the memory locations in the .DATA section.<br /><br />In both examples, the shorter code<br /><pre><code><br />mov eax, mem<br />mov othermem, eax<br /></code></pre><br />has been used and it is to the advantage of the dynamic code version by a couple of bytes for each instruction pair.<br /><br />Reuse gives the advantage to the dynamic version as the parameters are written on the stack instead of having to repeatedly overwrite memory locations in the .DATA section. You simply keep a procedure that does the changes you require and pass the number of parameters you need to be changed.<br /><br /><pre><code><br />========================================================<br /><br />    48 bytes<br /><br />    wc WNDCLASSEX &lt;sizeof WNDCLASSEX, \<br />                   CS_BYTEALIGNCLIENT or CS_BYTEALIGNWINDOW, \<br />                   OFFSET WndProc, \<br />                   NULL,NULL, \<br />                   400000h, \<br />                   NULL,NULL,COLOR_BTNFACE+1, \<br />                   NULL,OFFSET szClassName,NULL&gt;<br /><br />    40 bytes<br /><br />    mov eax, hInstance<br />    mov wc.hInstance, eax<br />    mov eax, hIcon<br />    mov wc.hIcon, eax<br />    mov eax, hCursor<br />    mov wc.hCursor, eax<br />    mov eax, hIcon<br />    mov wc.hIconSm, eax<br /><br />    004014D3 A170334000             mov     eax,&#91;403370h&#93;<br />    004014D8 A335304000             mov     &#91;403035h&#93;,eax<br />    004014DD A178334000             mov     eax,&#91;403378h&#93;<br />    004014E2 A339304000             mov     &#91;403039h&#93;,eax<br />    004014E7 A17C334000             mov     eax,&#91;40337Ch&#93;<br />    004014EC A33D304000             mov     &#91;40303Dh&#93;,eax<br />    004014F1 A178334000             mov     eax,&#91;403378h&#93;<br />    004014F6 A34D304000             mov     &#91;40304Dh&#93;,eax<br /><br />    Total   88 bytes<br /><br />========================================================<br /><br />    Total   88 bytes<br /><br />    mov wcx.cbSize,         sizeof WNDCLASSEX<br />    mov wcx.style,          CS_BYTEALIGNCLIENT or \<br />                            CS_BYTEALIGNWINDOW<br />    mov wcx.lpfnWndProc,    OFFSET WndProc<br />    mov wcx.cbClsExtra,     NULL<br />    mov wcx.cbWndExtra,     NULL<br />    mov eax, hInstance<br />    mov wcx.hInstance,      eax<br />    mov wcx.hbrBackground,  COLOR_BTNFACE+1<br />    mov wcx.lpszMenuName,   NULL<br />    mov wcx.lpszClassName,  OFFSET szClassName<br />    mov eax, hIcon<br />    mov wcx.hIcon, eax<br />    mov eax, hCursor<br />    mov wcx.hCursor, eax<br />    mov eax, hIcon<br />    mov wcx.hIconSm, eax<br /><br />    004014D3 C745C030000000         mov     dword ptr &#91;ebp-40h&#93;,30h<br />    004014DA C745C400300000         mov     dword ptr &#91;ebp-3Ch&#93;,3000h<br />    004014E1 C745C81A164000         mov     dword ptr &#91;ebp-38h&#93;,40161Ah<br />    004014E8 C745CC00000000         mov     dword ptr &#91;ebp-34h&#93;,0<br />    004014EF C745D000000000         mov     dword ptr &#91;ebp-30h&#93;,0<br />    004014F6 A170334000             mov     eax,&#91;403370h&#93;<br />    004014FB 8945D4                 mov     &#91;ebp-2Ch&#93;,eax<br />    004014FE C745E010000000         mov     dword ptr &#91;ebp-20h&#93;,10h<br />    00401505 C745E400000000         mov     dword ptr &#91;ebp-1Ch&#93;,0<br />    0040150C C745E812304000         mov     dword ptr &#91;ebp-18h&#93;,403012h<br />    00401513 A178334000             mov     eax,&#91;403378h&#93;<br />    00401518 8945D8                 mov     &#91;ebp-28h&#93;,eax<br />    0040151B A17C334000             mov     eax,&#91;40337Ch&#93;<br />    00401520 8945DC                 mov     &#91;ebp-24h&#93;,eax<br />    00401523 A178334000             mov     eax,&#91;403378h&#93;<br />    00401528 8945EC                 mov     &#91;ebp-14h&#93;,eax<br /><br />========================================================<br /></code></pre><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-12-03 19:23:07 by hutch--</div>
   </div>
   <div class="post" id="post-68913">
    <div class="subject"><a href="#post-68913">Predefined WNDCLASSEX? Any dis-/advantage?</a></div>
    <div class="body">Nice one, hutch--  :)<br /><br />So for the first call to RegisterClassEx we need 88 bytes either way. What about subsequent calls?<br /><br />With wc in the .DATA section, it will often be possible to leave the previous settings of wc.hIcon, wc.hIconSm, and wc.hCursor unchanged. Two or three MOV's at any place in the code may suffice to prepare the wc structure for another call to RegisterClassEx.<br /><br />With wc on the stack, and a dedicated procedure to fill it in, the overhead in other places of the code may be much larger. For example, you posted your RegisterWinClass procedure above:<br /><br /><div class="quote"><br />RegisterWinClass proc lpWndProc:DWORD, lpClassName:DWORD,<br />                      Icon:DWORD, Cursor:DWORD, bColor:DWORD<br /></div><br /><br />Each call to it requires five PUSHes (for parameter passing) someplace else in the code. The more flexible that procedure, the greater the overhead: Assume we wished to be able to change wc.style with that procedure, too (which it currently does not allow), then six parameter PUSHes would be required. Not only the one time where we actually do want to change wc.style, but each time that we call the procedure. These &quot;hidden costs&quot; may grow much more quickly (in terms of bytes in the .CODE section) than if we used a wc structure in the .DATA section and did a single MOV wc.style, IMM as in the static method.<br /><br />Regards,<br /><br />    Frank</div>
    <div class="meta">Posted on 2002-12-03 21:16:46 by Frank</div>
   </div>
   <div class="post" id="post-68937">
    <div class="subject"><a href="#post-68937">Predefined WNDCLASSEX? Any dis-/advantage?</a></div>
    <div class="body">Mine looks like this:<pre><code><br />    wc WNDCLASSEX &lt;sizeof WNDCLASSEX, \<br />                   CS_BYTEALIGNCLIENT or CS_BYTEALIGNWINDOW, \<br />                   OFFSET WndProc, \<br />                   NULL,NULL, \<br />                   400000h, \<br />                   NULL,NULL,COLOR_BTNFACE+1, \<br />                   NULL,OFFSET szClassName,NULL&gt;<br /><br />    hInstance EQU &lt;wc.hInstance&gt;<br />    hIcon EQU &lt;wc.hIcon&gt;<br />    hCursor EQU &lt;wc.hCursor&gt;</code></pre></div>
    <div class="meta">Posted on 2002-12-03 23:45:45 by bitRAKE</div>
   </div>
   <div class="post" id="post-68970">
    <div class="subject"><a href="#post-68970">Predefined WNDCLASSEX? Any dis-/advantage?</a></div>
    <div class="body">Rickey,<br /><br />I gather that you load the structure members with the return values from the functions that get the icon and cursor handles ?<br /><br />It is actually a good idea and is very code efficient over using a seperate variable.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-12-04 03:53:54 by hutch--</div>
   </div>
   <div class="post" id="post-69020">
    <div class="subject"><a href="#post-69020">Predefined WNDCLASSEX? Any dis-/advantage?</a></div>
    <div class="body"><strong>Thanks</strong> for all the reply's guys. And a special thanks to Hutch <br />for pointing out some things wich should have been obvious (:o).</div>
    <div class="meta">Posted on 2002-12-04 08:28:47 by natas</div>
   </div>
   <div class="post" id="post-69064">
    <div class="subject"><a href="#post-69064">Predefined WNDCLASSEX? Any dis-/advantage?</a></div>
    <div class="body">Steve,<br />difference in size in your example is not because of using<br />data in .data section or data in local vars.<br />It just 'cause working with locals you use for addressing ebp<br />as base that's way addressing need 2 bytes(if offset from <br />base is in range from - 128 to + 127) instead of 4 when you<br />specify offset as imm.<br />You can do the same with data in .data section if you load<br />address of structure in some reg and then address members<br />as <br />Using predefined vars is always shorter and faster code,<br />it's simple arithmitics:<br />dinamically loading is data in opcode + opcode to load.<br />predefind data -  just the same data that is in above line but <br />without opcode.<br />So you are wrong about size, size of executable is not<br />just size of data, it is size of code and data.<br />And part that need to fill structure in code section are always<br />bigger then sum of predefined data and code you need to fill<br />members that you can not define in desing time.<br />Actually you might be right but only if:<br />1. You don't have .data section at all<br />2. You exe does almost nothing so that having both<br />data and code in .code section their size &lt;= file alignment.<br />In this case if it is not exceed size of alignment it will be shorter<br />than the same in two section with data predefined.<br />We are talking of 1 kb exe only.<br />As I said almost two years ago - give me example of exe with<br />local structs that you dinamically fill and we'll see if I can<br />write the same code but with predefined data in .data section<br />and if I can make it shorter in size.<br /><br />Also talking of time to access data in data section you<br />forget of two separate caches for code and data. And both stack and data<br />section share the same data line chache.<br /><br />Working with stack is nothing else then working with data that is<br />pointed by esp reg. Load into esp addresses of vars in .data <br />section and nothing will change.<br />And stack and .data section are both data.</div>
    <div class="meta">Posted on 2002-12-04 11:16:36 by The Svin</div>
   </div>
   <div class="post" id="post-69102">
    <div class="subject"><a href="#post-69102">Predefined WNDCLASSEX? Any dis-/advantage?</a></div>
    <div class="body"><strong>Thanks The Svin</strong>, at first I thought I had all the answers i<br />could get. But suddenly out of nowhere you come and enlighten<br />me even more. I have learned a great deal in this thread, since<br />the responses made me see some things in a new light. :alright:<br /><br /><em>Out of the thread</em>: I started reading a book titled: <br />Windows Assembly &amp; Systems Programming(Second Edition) by Barry Kauler.<br />Have anyone read this book? or maybe someone knows a better one?<br />I have just read some chapters, but it looks pretty good sofar.</div>
    <div class="meta">Posted on 2002-12-04 14:11:06 by natas</div>
   </div>
   <div class="post" id="post-69129">
    <div class="subject"><a href="#post-69129">Predefined WNDCLASSEX? Any dis-/advantage?</a></div>
    <div class="body">Example seems to solve the debate about the virtues of dynamic versus static code. I have attached a 1536 byte EXE file with a working window to make the point. This EXE file has no .DATA section at all.<br /><br />I have done the pseudo smart VC++ style micro-optimisations and as usual it make no difference in size at all. There has always been more to code size optimisation than nitpicking mnemonics and to prove the point, the example has an equate that excludes a couple of blocks of code in the WndProc which actually make the code larger.<br /><br />The action in both size and speed optimisation has always been in terms of architecture, not close range nitpicking to remove a byte here and there. The only place I know where this type of coding is practiced to any advantage is with the virus nerds who are overwriting locations in existing EXE files where size is very limited.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-12-04 18:16:51 by hutch--</div>
   </div>
   <div class="post" id="post-69136">
    <div class="subject"><a href="#post-69136">Predefined WNDCLASSEX? Any dis-/advantage?</a></div>
    <div class="body">I think rather the optimization should be focused more on CreateWindowEx, which has an obscene number of arguments, and many times most of them are constant, or known at compile time.<br /><br /><br /><pre><code>&#91;size=12&#93;.data<br />cwArgs CREATESTRUCT &lt; NULL, etc... &gt;<br /><br />.code<br />CreateWindow2 proc uses ecx, edi esi, lpCreateStruct&#58;dword<br />   mov ecx, sizeof CREATESTRUCT<br />   mov esi, lpCreateStruct<br />   sub esp, ecx<br />   mov edi, esp<br />   rep movsb<br />   call CreateWindowEx<br />   ret<br />CreateWindow2 endp&#91;/size&#93;</code></pre><br /><br />...and then somewhere in your program:<br /><br /><pre><code>&#91;size=12&#93;   ...<br />   ...<br />   invoke CreateWindow2, offset cwArgs<br />   test eax, eax<br />   jz error<br />   mov hWnd, eax<br />   ...<br />   ...&#91;/size&#93;</code></pre><br /><br />...and if you want to create similar windows afterwards, you only need to make minimal, if any, changes to the structure.</div>
    <div class="meta">Posted on 2002-12-04 19:52:28 by iblis</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=9328&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=9328&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="9328" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=9328&amp;page=2">&gt;</a><a href="../?id=9328&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>