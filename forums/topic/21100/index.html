<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>shell, shell_ex and wshell - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=21100" />
    <link rel="next" href="../?id=21100&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=12">The Heap</a> &raquo; <a href="../?id=21100">shell, shell_ex and wshell</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=21100&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=21100&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="21100" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=21100&amp;page=2">&gt;</a><a href="../?id=21100&amp;page=2">&raquo;</a></form>   <div class="post" id="post-159723">
    <div class="subject"><a href="#post-159723">shell, shell_ex and wshell</a></div>
    <div class="body">SpooK,<br /><br />Thanks for the tidy up of this nonsense.<br /><br />Here is my response under your new guidelines.<br /><br />Ther are 3 seperate shell style procedures in the MASM32 library. Source code is available as usual at www.masm32.com .<br /><br />1. shell&nbsp; DOS style emulation with no process priority changes to run on old or badly set up boxes that crash other types.<br /><br />2. shell_ex&nbsp; Priority changing procedure of modern design. May not work on old or damaged boxes.<br /><br />3. wshell&nbsp; The wrong way to perform the task but it runs on most later boxes. May not work on old or damaged boxes.<br /><br />All three (3) algos are documented in the masmlib.hlp file under the category &quot;Misc&quot;.<br /><br />I have writen demonstrations in the past when this topic has been recycled before so I don&#39;t intend to waste the time doing it again. Souce code and documentation provided at the above link.<br /><br />Regards,<br /><br />hutch at movsd dot com</div>
    <div class="meta">Posted on 2005-05-06 17:52:30 by hutch--</div>
   </div>
   <div class="post" id="post-159725">
    <div class="subject"><a href="#post-159725">Re: shell, shell_ex and wshell</a></div>
    <div class="body"><div class="quote">I have writen demonstrations in the past when this topic has been recycled before so I don&#39;t intend to waste the time doing it again. Souce code and documentation provided at the above link.</div><br />Ok, thanks for the reply. Could you please point me to the bug demonstration code? I couldn&#39;t find it in this or the MASM board, and I&#39;d like to take a look at it. :)</div>
    <div class="meta">Posted on 2005-05-06 17:56:34 by QvasiModo</div>
   </div>
   <div class="post" id="post-159730">
    <div class="subject"><a href="#post-159730">Re: shell, shell_ex and wshell</a></div>
    <div class="body">QvasiModo,<br /><br />I don&#39;t know where it is any longer, I may have it on one of my machines but it would take a detailed search to find it.<br /><br />I did the tests this way. With the old <strong>shell</strong> proc that must run on anything, I ran it in a loop calling a small test piece to demonstrate how much memory was lost with the two unallocated handles. It also demonstrated that the memory is recovered on exit.<br /><br />The <strong>shell_ex</strong> proc was tested in the same loop design but without the memory leak test as it deallocates the two handles. It is useful in this type of test to have a number of test pieces that use low, medium and high priority set while the calling app has its priority set to idle. this shows the effects under the useful range of priority settings.<br /><br />The <strong>wshel</strong>l proc was to shut up the noise, its is a standard WaitForSingleObject() style proc that correctly zeros the STARTUPINFO structure for future compatibility with OS changes but I don&#39;t like the design and don&#39;t trust it and have documented it that way. It should use the same test design as the shell_ex proc.<br /><br />As far as the documenation for the old AMD K6-2 3D NOW processor running at 550 meg, it died recently and I replaced it with a Sempron 2.4 to run my printer and scanner but it was a problematic processor for a few reasons, Microsoft had to issue a pach for win95b so it could run it as it had a LOOP instruction that was too fast for the win95 code design.<br /><br />When I get my digital camera back I wil pull the board out of the junk and take a pretty pic of it for any who don&#39;t know what they were.<br /><br />Regads,<br /><br />hutch at movsd dot com</div>
    <div class="meta">Posted on 2005-05-06 18:49:34 by hutch--</div>
   </div>
   <div class="post" id="post-159760">
    <div class="subject"><a href="#post-159760">Re: shell, shell_ex and wshell</a></div>
    <div class="body">Here is some data from Microsoft on the K6-2 processor. The box used to use a 350 K6-2 but it was upgraded to a 550 K6-2 and the win95b problem became critical.<br /><br />I eventually gave up and ran win98se on it but this processor is the one that crashed <strong>EVERY TIME</strong> the handles were dealocated.<br /><br />http://www.microsoft.com/windows95/downloads/contents/WURecommended/S_WUServicePacks/AMDPatch/Default.asp<br /><br /><div class="quote"><br />Windows 95 Update for AMD-K6?-2/350<br />Download Now<br /><br />Read Me First<br />Microsoft? Windows? 95 Update for AMD-K6?-2/350 and Above Patch for Windows 95 OEM SR2 and above fixes a software timing loop that is sensitive to processor frequency and is not a processor erratum. Please note that this patch will not resolve issues associated with any other versions of Windows 95 other than the OEM SR2 version.<br /><br />To determine the version that you have on your system, please read below. If you are not sure which version of Windows 95 you have, you can find out simply by checking your System Properties. To do this, right mouse click on &quot;My Computer&quot; and select &quot;Properties&quot;. An OEM SR2 system will show a designator, such as &quot;4.00.9500 B&quot; as the version. The number may vary slightly, but the letter designator will be a &quot;B&quot; for the OSR2 version. Version designators without a &quot;B&quot;, such as an &quot;A&quot; or nothing after the number, cannot utilize this patch.<br /></div></div>
    <div class="meta">Posted on 2005-05-07 04:48:53 by hutch--</div>
   </div>
   <div class="post" id="post-159761">
    <div class="subject"><a href="#post-159761">Re: shell, shell_ex and wshell</a></div>
    <div class="body"><div class="quote">I did the tests this way. With the old <strong>shell</strong> proc that must run on anything, I ran it in a loop calling a small test piece to demonstrate how much memory was lost with the two unallocated handles. It also demonstrated that the memory is recovered on exit.</div><br /><br />Ok. I know I posted examples of all the issues last time the topic was discussed (about a year ago), but here is another proof of concept as per the new rules ;).<br /><br /><span class="mono">leaktest.exe</span> runs in a loop calling the M32LIB shell function to run <span class="mono">client.exe</span> which does nothing but exit. It shows a dot every 256 calls, and on my fresh Win98SE install I can get about 1 and 1/3 lines of dots before either the app crashes, windows hangs, or BSOD.<br /><br />I know most apps won&#39;t call shell so many times, but that&#39;s why this is a proof of concept -- it&#39;s merely to show that there is a potential problem :).<br /><br /><strong>Edit</strong>: I tried using wshell instead, and it worked fine .. completed the 35000 rounds without any problems. It worries me a bit that there is no error checking in either of the three functions :|.</div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=609" target="_blank">shell_leak.zip</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2005-05-07 06:33:32 by Jibz</div>
   </div>
   <div class="post" id="post-159765">
    <div class="subject"><a href="#post-159765">Re: shell, shell_ex and wshell</a></div>
    <div class="body"><div class="quote"><br />It worries me a bit that there is no error checking in either of the three functions<br /></div><br />This *could* be why hutch has had crash with the handle-closing version? I don&#39;t know just how badly mannered win95 is, but it wouldn&#39;t surprise me that CloseHandle with bogus arguments could cause a detour to BSOD-land - since there&#39;s no checking on the return value from CreateProcess, handles could very well be bogus...<br /></div>
    <div class="meta">Posted on 2005-05-07 06:58:40 by f0dder</div>
   </div>
   <div class="post" id="post-159766">
    <div class="subject"><a href="#post-159766">Re: shell, shell_ex and wshell</a></div>
    <div class="body">Running under Windows 2000 SP4, it took about half a line of dots to use up all of the available 130mb of physical memory, after which CreateProcess fails (dots continue, because of no error checking).<br /><br />wshell, again, runs with no problems, and no increase in memory usage.</div>
    <div class="meta">Posted on 2005-05-07 07:32:30 by Jibz</div>
   </div>
   <div class="post" id="post-159769">
    <div class="subject"><a href="#post-159769">Re: shell, shell_ex and wshell</a></div>
    <div class="body">Jibz,<br /><br />It runs fine on my win2k box, completes the 35k iterations with no problems. I tested it on an installation of win98se and it runs about 10k iterations then GP faults. Diagnostics say access violation in kernel32. I changed the test program to shell_ex with priority set to NORMAL_PRIORITY_CLASS for the called app and it completes the test on both OS versions.<br /><br />Probably a handle limitation in win98se but its hardly a problem, you don&#39;t use the original shell ago for this type of task, it is designed as failsafe on old boxes with the cost being the leaked handles. For simplified high repeat requirements, the shell_ex works fine but any serious app that did something like this would need a &quot;roll your own&quot; to have enough flexibility to do the job.<br /><br />LATER: After reading your reply, the same effect on win2k but no crash. It takes off about 2 thirds of the way through so it is the same effect. Again probably a handle limit.</div>
    <div class="meta">Posted on 2005-05-07 07:58:50 by hutch--</div>
   </div>
   <div class="post" id="post-159772">
    <div class="subject"><a href="#post-159772">Re: shell, shell_ex and wshell</a></div>
    <div class="body">I am glad I finally got you to the point where you acknowledge that there is in fact a leak and that it can cause crashes, excessive memory usage and silent failure depending on the OS ;).<br /><br />If you are still refusing to do anything about it other than point to the two other versions, I would strongly encourage you to add a warning to the documentation of the shell function, like you did with your claimed Win9x problems. Perhaps something like:<br /><br /><strong>Warning</strong>: May randomly crash, use up all availabe memory, or silently fail if you call it too many times. Uses CPU time while waiting for program to exit.<br /><br />And the note at the end of the wshell description is hardly enough .. the note should be with the function that has the problem :D.</div>
    <div class="meta">Posted on 2005-05-07 08:19:57 by Jibz</div>
   </div>
   <div class="post" id="post-159774">
    <div class="subject"><a href="#post-159774">Re: shell, shell_ex and wshell</a></div>
    <div class="body">Jibz, ran your leaktest (almost identical to mine :)) under Win98. Ends up GP faulting, and repeatedly - you can&#39;t terminate the app. Can&#39;t restart or shut down the computer, and can&#39;t bring up the ctrl-alt-del dialog.<br /><br />If leaktest is terminated before the GPF&#39;ing, after it has started slugging the computer, there&#39;s a multi-minute stall while 9x cleans up - but it *usually* recovers. This is on a 1.7GHz P4 celeron with 256 megs of ram, btw - so the real sluggish performance is not because of crap hardware.<br /><br />On XP it runs until it exhausts memory (or some process number limit?), then the dots fly rapidly until it terminates gracefully. If, however, I have sysinternals&#39; Process Explorer running, the system crawls to a halt, and doesn&#39;t recover until procexp is shut down (which is a difficult thing to do when you can hardly change active window).<br /><br />For a fun show, try running a bunch of the leaktests at the same time - it also shows how the GetExitCodeProcess polling affects the performance of other tasks.<br /></div>
    <div class="meta">Posted on 2005-05-07 08:24:21 by f0dder</div>
   </div>
   <div class="post" id="post-159777">
    <div class="subject"><a href="#post-159777">Re: shell, shell_ex and wshell</a></div>
    <div class="body">Jibz,<br /><br /><span class="mono"><br />I am glad I finally got you to the point where you acknowledge that there is in fact a leak<br /></span><br /><br />Your memory is failing you, I published a test last round of nonsense that demonstrated the leak. Its hard to finally acknowledge something that I published at least a&nbsp; year ago.</div>
    <div class="meta">Posted on 2005-05-07 08:38:07 by hutch--</div>
   </div>
   <div class="post" id="post-159779">
    <div class="subject"><a href="#post-159779">Re: shell, shell_ex and wshell</a></div>
    <div class="body">Noting SpooK&#39; new rule,<br /><br /><span class="mono"><br />For a fun show, try running a bunch of the leaktests at the same time - it also shows how the GetExitCodeProcess polling affects the performance of other tasks.<br /></span><br /><br />Run it with shell_ex.</div>
    <div class="meta">Posted on 2005-05-07 08:49:15 by hutch--</div>
   </div>
   <div class="post" id="post-159780">
    <div class="subject"><a href="#post-159780">Re: shell, shell_ex and wshell</a></div>
    <div class="body"><div class="quote"><br />Run it with shell_ex.<br /></div><br />Nope - not when the purpose is showing the bad effect of GetExitCodeProcess polling.<br /></div>
    <div class="meta">Posted on 2005-05-07 08:52:34 by f0dder</div>
   </div>
   <div class="post" id="post-159781">
    <div class="subject"><a href="#post-159781">Re: shell, shell_ex and wshell</a></div>
    <div class="body">Noting SpooK&#39;s new rule,<br /><br /><span class="mono"><br />&nbsp; @@:<br />&nbsp; &nbsp; invoke GetExitCodeProcess,pr_info.hProcess,ADDR xc<br />&nbsp; &nbsp; invoke Sleep, 0<br />&nbsp; &nbsp; cmp xc, STILL_ACTIVE<br />&nbsp; &nbsp; je @B<br /></span><br /><br />The loop code in shell_ex.</div>
    <div class="meta">Posted on 2005-05-07 08:56:24 by hutch--</div>
   </div>
   <div class="post" id="post-159782">
    <div class="subject"><a href="#post-159782">Re: shell, shell_ex and wshell</a></div>
    <div class="body">Sleep(0) still exhibits problems with background threads - you need a non-zero argument to &quot;fix&quot; this problem (as I already mentioned and showed code for *before* &quot;SpooK&#39;s new rule&quot;). Besides, adding a Sleep is a symptomatic treatment, not a fix.<br /></div>
    <div class="meta">Posted on 2005-05-07 09:00:57 by f0dder</div>
   </div>
   <div class="post" id="post-159783">
    <div class="subject"><a href="#post-159783">Re: shell, shell_ex and wshell</a></div>
    <div class="body">Here is a test app for showing the CPU usage problem of the shell function.<br /><br />What I used to test is: <span class="mono">rar a -ri1 bison.rar bison-1.31.tar</span><br /><br />This runs rar and lowers it&#39;s priority while compressing, which is a nice way to run large backups without having to leave the computer alone in the meantime. But it&#39;s merely an example to illustrate any task running in the background at a lower priority.<br /><br />The 3mb file takes roughly 1 second to compress on my box.<br /><br /><span class="mono">cputest.exe</span> uses M32LIB shell to run <span class="mono">client.exe</span>, which shows a messagebox. This means the shell GetExitCodeProcess loop will be running until you press the OK button.<br /><br />With it running, compressing the 3mb file took 1 minute and 55 seconds.<br /><br /><span class="mono">cputestw.exe</span> uses M32LIB wshell instead, but otherwise does the same thing.<br /><br />With it running, compressing the 3mb file took roughly 1 second.<br /><br /><div class="quote">The loop code in shell_ex.</div><br /><br />shell_ex suffers the reverse problem. Try running <span class="mono">cputeste.exe</span> and then start rar on compressing some huge file. If you then press OK, it takes a while for the loop to get scheduled. On my box it took about 5 seconds before the loop figured out the client had exited :).<br /><br /></div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=610" target="_blank">cpu_usage.zip</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2005-05-07 09:12:30 by Jibz</div>
   </div>
   <div class="post" id="post-159784">
    <div class="subject"><a href="#post-159784">Re: shell, shell_ex and wshell</a></div>
    <div class="body"><div class="quote">Your memory is failing you, I published a test last round of nonsense that demonstrated the leak. Its hard to finally acknowledge something that I published at least a&nbsp; year ago.</div><br /><br />Yes, you probably did somewhere along the way.<br /><br />Still, nothing changed about shell or it&#39;s description in the docs. I can see you added a note under wshell about the leak, but that&#39;s a bit of a strange place to put it :D.</div>
    <div class="meta">Posted on 2005-05-07 09:19:29 by Jibz</div>
   </div>
   <div class="post" id="post-159785">
    <div class="subject"><a href="#post-159785">Re: shell, shell_ex and wshell</a></div>
    <div class="body">Noting SpooK&#39;s new rules,<br /><br />Here is the objective test of the two algos, shell_ex and wshell.<br /><br />wshell is slightly faster as it does a bit less but the difference is about 1 - 2 %. Both top out at 100% processor usage during the test. You need to run task manager to see the processor usage. Note that shell_ex sets the priority to NORMAL.</div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=611" target="_blank">SHLTST.ZIP</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2005-05-07 09:27:19 by hutch--</div>
   </div>
   <div class="post" id="post-159786">
    <div class="subject"><a href="#post-159786">Re: shell, shell_ex and wshell</a></div>
    <div class="body">hutch--, your test might be objective, but it fails to show a couple of problems that Jibz perfectly illustrates; going from 1 second to 1min55sec is clearly a performance degradation.<br /></div>
    <div class="meta">Posted on 2005-05-07 09:34:29 by f0dder</div>
   </div>
   <div class="post" id="post-159787">
    <div class="subject"><a href="#post-159787">Re: shell, shell_ex and wshell</a></div>
    <div class="body">I must admit that it&#39;s a very objective test. It nicely measures the time taken to execute either function 5000 times.<br /><br />Unfortunately, it doesn&#39;t address the problem, since there is nothing else running that can be slowed down by, or slow down the loop.</div>
    <div class="meta">Posted on 2005-05-07 09:37:19 by Jibz</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=21100&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=21100&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="21100" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=21100&amp;page=2">&gt;</a><a href="../?id=21100&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>