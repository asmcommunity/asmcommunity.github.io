<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>shell, shell_ex and wshell - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=21100" />
  <link rel="prev" href="../?id=21100&amp;page=1" />   </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=12">The Heap</a> &raquo; <a href="../?id=21100">shell, shell_ex and wshell</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=21100&amp;page=1" style="">&laquo;</a><a href="../?id=21100&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="21100" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>   <div class="post" id="post-159789">
    <div class="subject"><a href="#post-159789">Re: shell, shell_ex and wshell</a></div>
    <div class="body">I take that back, at least partially ;).<br /><br />Try runing rar to compress some huge file, and then try your test app at the same time.<br /><br />It took shell_ex 1 minute and 40 seconds to finish 10 calls, whereas wshell took 800 ms.</div>
    <div class="meta">Posted on 2005-05-07 10:03:30 by Jibz</div>
   </div>
   <div class="post" id="post-159791">
    <div class="subject"><a href="#post-159791">Re: shell, shell_ex and wshell</a></div>
    <div class="body">Your testing method is defective, running PKZIP on a 75 meg VOB file, I get about the same variation between the two algos, both run at about 14 seconds.<br /><br />Changes to the demo file are as follows.<br /><br /><span class="mono"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fn shell_ex,&quot;pkzip kari.zip kari.vob&quot;,NORMAL_PRIORITY_CLASS<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fn wshell,&quot;pkzip kari.zip kari.vob&quot;<br /></span><br /><br />Degradation percentage is zero point zero.<br /><br />LATER : I removed the loop to get single timings on a single LARGE file.<br /></div>
    <div class="meta">Posted on 2005-05-07 10:20:49 by hutch--</div>
   </div>
   <div class="post" id="post-159792">
    <div class="subject"><a href="#post-159792">Re: shell, shell_ex and wshell</a></div>
    <div class="body"><div class="quote"><br />This runs rar and <strong>lowers it&#39;s priority</strong> while compressing, which is a nice way to run large backups without having to leave the computer alone in the meantime.<br /></div><br />... try again, hutch--.<br /></div>
    <div class="meta">Posted on 2005-05-07 10:23:11 by f0dder</div>
   </div>
   <div class="post" id="post-159793">
    <div class="subject"><a href="#post-159793">Re: shell, shell_ex and wshell</a></div>
    <div class="body">Read NORMAL_PRIORITY_CLASS.<br /><br />I am not interested in your opinion and the rules are not either.</div>
    <div class="meta">Posted on 2005-05-07 10:26:12 by hutch--</div>
   </div>
   <div class="post" id="post-159794">
    <div class="subject"><a href="#post-159794">Re: shell, shell_ex and wshell</a></div>
    <div class="body">Since when is NORMAL_PRIORITY_CLASS a lower than normal priority?<br /><br />Jibz&#39; method of testing is not flawed. He runs a compression <strong>at a lower priority</strong>, which is a useful and often-used thing to do when you&#39;re compressing large amounts of data and want to do other work on your box at the same time. </div>
    <div class="meta">Posted on 2005-05-07 10:33:49 by f0dder</div>
   </div>
   <div class="post" id="post-159795">
    <div class="subject"><a href="#post-159795">Re: shell, shell_ex and wshell</a></div>
    <div class="body">I ran PKZIP which is a common program for archiving and there is no difference. It is a compressor that runs at the same time as the test app so the theory is wrong and the test is defective.<br /><br />For the theory to be correct that GetExitCodeProcess() slows down other processes of whatever priority, it would show when running BOTH pkzip and the test app. There is no difference in the timing, both run at 14 seconds. Proof delivered.<br /><br />Note again that I am not inerested in opinion and neither are the rules.</div>
    <div class="meta">Posted on 2005-05-07 10:39:36 by hutch--</div>
   </div>
   <div class="post" id="post-159797">
    <div class="subject"><a href="#post-159797">Re: shell, shell_ex and wshell</a></div>
    <div class="body"><div class="quote"><br />I ran PKZIP which is a common program for archiving and there is no difference. It is a compressor that runs at the same time as the test app so the theory is wrong and the test is defective.<br /></div><br />So, by using a completely different program, running at normal priority while the point is that *lower* priority threads are slowed down, you believe you&#39;ve disproved there is a performance problem?<br /><br />Jibz clearly showed the problem. Posted reproducible information, with a 1sec-&gt;1min55sec slowdown as a result.<br /><br />Like it or not, lowering priority on a big compression task is pretty normal, since it allows you to use your computer at the same time, without any perceptible slowdown. Before WinRAR had the ability to lower it&#39;s priority, I used taskmgr to do it manually...<br /><br /></div>
    <div class="meta">Posted on 2005-05-07 10:50:33 by f0dder</div>
   </div>
   <div class="post" id="post-159798">
    <div class="subject"><a href="#post-159798">Re: shell, shell_ex and wshell</a></div>
    <div class="body">The rules require proof, not opinion. I have delivered proof that the polling loop using GetExitCodeProcess() is not slower. The test I have used is a perfectly reasonable test using a processor intensive task running at the same time as the test app. There is no difference in the times.<br /><br />Proof delivered.</div>
    <div class="meta">Posted on 2005-05-07 10:56:56 by hutch--</div>
   </div>
   <div class="post" id="post-159801">
    <div class="subject"><a href="#post-159801">Re: shell, shell_ex and wshell</a></div>
    <div class="body">Jibz delivered proof of the slowdown - and it&#39;s obviously quite massive.<br /><br />It&#39;s perfectly reproducible as well - &quot;rar a -ri1 out.rar ..\*.zip&quot; executes within a second with cputestw. Running cputest, I terminated the compression after a minute.<br /><br />Proof delivered.<br /></div>
    <div class="meta">Posted on 2005-05-07 11:09:17 by f0dder</div>
   </div>
   <div class="post" id="post-159802">
    <div class="subject"><a href="#post-159802">Re: shell, shell_ex and wshell</a></div>
    <div class="body">So is this.<br /><br /><span class="mono"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fn shell_ex,&quot;pkzip kari.zip kari.vob&quot;,NORMAL_PRIORITY_CLASS<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fn wshell,&quot;pkzip kari.zip kari.vob&quot;<br /></span><br /><br />Massage a test hard enough and you can get any result you like. Start altering priorities and you have changed the task being run. For the view that both yourself and Jibz have failed to sell that GetExitCodeProcess() slows down external processes to be correct, it would show while running another task (pkzip) but the times prove that it does not. Also note that with the code for the algo published at www.masm32.com that the priority of the calling app using the shell_ex proc is set to THREAD_PRIORITY_IDLE so it is doubtful that an idle priority thread can effect another task to the extent claimed.<br /><br />The only proof that has been delivered on Jibz&#39;s part is that altering thread priority alters the thread priority.<br /><br />As you have not contribued to the debate apart from nuisance value and endless opinion, take note of the rules that SpooK has put in place regarding your opinion without backing..</div>
    <div class="meta">Posted on 2005-05-07 11:25:05 by hutch--</div>
   </div>
   <div class="post" id="post-159804">
    <div class="subject"><a href="#post-159804">Re: shell, shell_ex and wshell</a></div>
    <div class="body"><div class="quote"><br />As you have not contribued to the debate apart from nuisance value and endless opinion, take note of the rules that SpooK has put in place regarding your opinion without backing..<br /></div><br />I&#39;ve backed my claims - refer to the thread_priority tests I&#39;ve submitted. Jibz&#39; rar example is 100% reproducible, and I&#39;ve confirmed it.<br /><br /><div class="quote"><br />Massage a test hard enough and you can get any result you like<br /></div><br />Which is exactly what you&#39;ve been doing - ignoring the samples I&#39;ve provided, claiming Jibz&#39; result is invalid, and fudging around with a bunch of different shell routines to hide the fact that the original shell has bad performance.<br /></div>
    <div class="meta">Posted on 2005-05-07 11:33:21 by f0dder</div>
   </div>
   <div class="post" id="post-159809">
    <div class="subject"><a href="#post-159809">Re: shell, shell_ex and wshell</a></div>
    <div class="body"><span style="font-size:14pt><strong><br />Here&#39;s a self-contained example that shows the various MASM32LIB shell routine deficiencies. It runs a background thread compressing a 1meg buffer with Jibz&#39; aPlib.<br /></strong></span><br /><br />There&#39;s two versions included compress_low.exe sets the thread priority to THREAD_PRIORITY_BELOW_NORMAL. compress_normal.exe doesn&#39;t. You could compress_low.exe a simulation of running winrar in &quot;background mode&quot;.<br /><br />First, try running compress_normal.exe. Try opening a few programs (larger than notepad, but not necessarily megabyte monsters). Performance should be sluggish, unless you have a dual-cpu or hyperthreading system. Notice 100% CPU usage in task manager.<br /><br />Terminate compress_normal and run compress_low. It will also show 100% CPU usage in task manager, but try launching a few programs again - there should be no sluggishness at all, or at least considerably less than compress_normal.<br /><br />Now for the m32lib shell tests - using the included binaries Jibz provided. Keep compress_low running.<br /><br />cputestw.exe - compress keeps running normally.<br /><br />cputeste.exe - compress keeps running normally, but when you hit the OK button it takes 10-20 seconds before it detects client.exe has terminated.<br /><br />cputest.exe - compress suddenly runs in &quot;bursts&quot;, and on my system, the worst-case compression time goes from 47 to 5218 ticks. That&#39;s a 111x speed drop, and 347x the normal speed at 15 ticks. At least it doesn&#39;t take those 10-20 seconds before it realises client.exe has terminated, though.<br /><br />All the cputest* binaries use the standard MASM32LIB shell routines.<br /><br />cputest.exe&nbsp; - uses shell, loops GetExitCodeProcess, has a Sleep(0) call.<br /><br />cputeste.exe - uses shell_ex, which still loops GetExitCodeProcess... but sets its priority to IDLE (this is symptomatic treatment, known as a &quot;hack&quot; or a &quot;fudge&quot;).<br /><br />cputestw.exe - uses wshell, which relies on WaitForSingleObject.<br /></div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=614" target="_blank">compress_test.zip</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2005-05-07 12:25:01 by f0dder</div>
   </div>
   <div class="post" id="post-159818">
    <div class="subject"><a href="#post-159818">Re: shell, shell_ex and wshell</a></div>
    <div class="body">... easy now ;).<br /><br />I&#39;m sorry I left the discussion where I did, but I had to leave to visit some family for the weekend. I am on dialup now, so I will only post a quick note.<br /><br />I&#39;m a bit sorry I posted the comments about shell and shell_ex so close to each other, as it seems to have brought about a little confusion :|.<br /><br />The cpu-related problem with shell is that it takes cpu cycles away from programs when doing it&#39;s loop .. the example for this was running a program at lower priority like rar background archiving or some similar background task (my virus scanner showed the same issue).<br /><br />The problem with shell_ex is that while lowering the priority of the waiting thread does free up cpu time for other tasks including background tasks to run, it means that the waiting thread won&#39;t get scheduled again until the OS gets around to it. The example for this was to run rar at normal priority on the side.<br /><br />Now, the problem with using (pk)zip instead of rar is that zip is quite i/o bound because the compression is so simple and fast, and the buffer size is so small. This means the waiting thread in shell_ex will get scheduled every time zip performs i/o, and thus it can be hard to tell the difference. You need something a bit more cpu heavy like rar or aPLib.<br /><br />The two functions really just shift the problem forward and back, but do not solve it in general as the wshell function does (which is basically identical to what f0dder suggested).<br /><br />I am happy to see the wshell function is in M32LIB, although I do really think there should be a version that checks the success of the CreateProcess call as well.<br /><br />But I think it&#39;s a bit problematic that the shell function is listed as the default choice, and with no warnings as to the potential problems in it&#39;s documentation page. It works fine if you only run it a limited number of times, and the programs you run finish quickly, but people should be aware of the behaviour under other circumstances.<br /></div>
    <div class="meta">Posted on 2005-05-07 14:42:19 by Jibz</div>
   </div>
   <div class="post" id="post-159825">
    <div class="subject"><a href="#post-159825">f0dder.lib, when will you fix it ?</a></div>
    <div class="body">Source code is by f0dder. Posted in accordance with the rules. f0dder has claimed that this is a &quot;generic&quot; routine that should be used instead of any of the shell based routines in the MASM32 library.<br /><br />Defect one (1)<br />For the routine to be generic code (defined as being able to be used in every circumstance) it has un-necessary redundant code in the form,<br /><span class="mono"><br />invoke GetStartupInfo, addr st_info<br /></span><br /><br />The vast majority of Windows applications that can be called with this routine never require the structure to be filled with any values so this code is un-necessary.<br /><br />Defect two (2)<br />For the routine to be generic it would need to be able to set the priority of the called app to a user defined value.<br /><br /><strong><span style="font-size:20pt>When will this defect be fixed or alternatively labelled as defective ?</span></strong><br /><br />It is fair to say in this context that the first instance of f0dder.lib shows poor procedure design and a lack of understanding of the considerations involved.<br /><br /><span class="mono"><br />shell proc cmdline:DWORD<br />LOCAL st_info:STARTUPINFO<br />LOCAL pr_info:PROCESS_INFORMATION<br /><br />invoke GetStartupInfo, addr st_info<br /><br />invoke CreateProcess, NULL, cmdline, NULL, NULL,<br />NULL, NULL, NULL, NULL, ADDR st_info, ADDR pr_info<br />test eax, eax<br />jz @@out<br /><br />invoke WaitForSingleObject, pr_info.hProcess, INFINITE<br /><br />invoke CloseHandle, pr_info.hProcess<br />invoke CloseHandle, pr_info.hThread<br /><br />@@out:<br />ret<br /><br />shell endp<br /></span></div>
    <div class="meta">Posted on 2005-05-07 17:55:10 by hutch--</div>
   </div>
   <div class="post" id="post-159827">
    <div class="subject"><a href="#post-159827">Re: shell, shell_ex and wshell</a></div>
    <div class="body">Let&#39;s see. Reasonable example showing defect is posted. Hutch ignores, and tries a smokescreen diversion.<br /><br /><div class="quote"><br />Defect one (1)<br />For the routine to be generic code (defined as being able to be used in every circumstance) it has un-necessary redundant code in the form,<br /></div><br />It might be superfluous in most situations, but it works - in every circumstance. Also, this is an example of choosing size over speed, since the overhead of GetStartupInfo is unnoticable even if you were running on a 486.<br /><br /><div class="quote"><br />Defect two (2)<br />For the routine to be generic it would need to be able to set the priority of the called app to a user defined value.<br /></div><br />The routine was designed to have the same interface and functionality as the original shell, so this is an invalid point.<br /><br /><div class="quote"><br />It is fair to say in this context that the first instance of f0dder.lib shows poor procedure design and a lack of understanding of the considerations involved.<br /></div><br />I&#39;m not doing a &quot;f0dder.lib&quot; and I&#39;ve never claimed that I would. The issue is that masm32libs implemetation of shell is broken, and I have shown a fix with the same interface and functionality.<br /><br />If you review my previous post, http://www.asmcommunity.net/board/index.php?topic=21100.msg159809#msg159809 , that is a clear and unambiguous example of the shortcoming of the masm32lib shell function.<br /></div>
    <div class="meta">Posted on 2005-05-07 19:23:13 by f0dder</div>
   </div>
   <div class="post" id="post-159828">
    <div class="subject"><a href="#post-159828">Re: shell, shell_ex and wshell</a></div>
    <div class="body">To help resolve the primary issue, I have to ask both of you to provide the most common, realistic, and relevant examples of quality code (i.e. the way it should be done). Don&#39;t post examples that may be causes of poor programming, I personally do not wish to promote poor programming methods in this community.</div>
    <div class="meta">Posted on 2005-05-07 19:31:40 by SpooK</div>
   </div>
   <div class="post" id="post-159831">
    <div class="subject"><a href="#post-159831">Re: shell, shell_ex and wshell</a></div>
    <div class="body">SpooK,<br /><br />This issue cannot be resolved as the basic ground rules cannot be established. I publically invite you to close this thread so that the forum is not used as a vehicle for personal attacks of the type that has continued in here for years. I will happily resolve the issue elsewhere.<br /><br />Regards,<br /><br />hutch at movsd dot com</div>
    <div class="meta">Posted on 2005-05-07 20:12:10 by hutch--</div>
   </div>
   <div class="post" id="post-159832">
    <div class="subject"><a href="#post-159832">Re: shell, shell_ex and wshell</a></div>
    <div class="body">The original subject was that masm32lib shell functions are broken, and that the idea was to show *why* they are broken and how to fix it. That&#39;s why I stayed with the original interface and functionality of &quot;shell&quot;.<br /><br />If I need something roughly equivalent to the ANSI C system() function (which the original shell() appears to have been modelled after), I use something very similar to the fixed shell() routine I&#39;ve shown above.<br /><br />If more flexibility is required than what system() offers, I tend to need a lot of additional flexibility, and directly use CreateProcess. The following code is a generic system() implementation, with proper error checking and resource freeing.<br /><br /><pre><code><br />;<br />; DWORD system(char *cmdline) - roughly equivalent to ANSI C system() call.<br />;&nbsp;  input:&nbsp; cmdline = command line to execute<br />;&nbsp;  output: -1 on error, otherwise process return code<br />;&nbsp;  remark: re-uses st_info.cb field to avoid extra local storage and cuts<br />;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  down slightly on instructions - mostly done because it&#39;s cute.<br />;<br />system proc cmdline:DWORD<br />&nbsp; &nbsp; LOCAL&nbsp;  st_info:STARTUPINFO<br />&nbsp; &nbsp; LOCAL&nbsp;  pr_info:PROCESS_INFORMATION<br /><br />&nbsp; &nbsp; ; the st_info.cb initialization should be superfluous, as PlatformSDK says<br />&nbsp; &nbsp; ; the lpStartupInfo is OUT only. But better safe than sorry...<br />&nbsp; &nbsp; mov&nbsp; &nbsp;  st_info.cb, sizeof st_info<br />&nbsp; &nbsp; invoke&nbsp; GetStartupInfo, addr st_info<br /><br />&nbsp; &nbsp; invoke&nbsp; CreateProcess, 0, cmdline, 0, 0, 0, 0, 0, 0, ADDR st_info, ADDR pr_info<br />&nbsp; &nbsp; mov&nbsp; &nbsp;  st_info.cb, -1<br />&nbsp; &nbsp; test&nbsp; &nbsp; eax, eax<br />&nbsp; &nbsp; jz&nbsp; &nbsp; &nbsp; @@out<br /><br />&nbsp; &nbsp; ; wait for process termination<br />&nbsp; &nbsp; invoke&nbsp; WaitForSingleObject, pr_info.hProcess, INFINITE<br /><br />&nbsp; &nbsp; ; re-use st_info.cb field instead of adding a local var<br />&nbsp; &nbsp; invoke&nbsp; GetExitCodeProcess, pr_info.hProcess, addr st_info.cb<br />&nbsp; &nbsp; test&nbsp; &nbsp; eax, eax<br />&nbsp; &nbsp; jz&nbsp; &nbsp; &nbsp; @@out<br /><br />&nbsp; &nbsp; ; handle cleanup to avoid kernelmode object leak<br />&nbsp; &nbsp; invoke&nbsp; CloseHandle, pr_info.hProcess<br />&nbsp; &nbsp; invoke&nbsp; CloseHandle, pr_info.hThread<br /><br />@@out:<br />&nbsp; &nbsp; mov&nbsp; &nbsp;  eax, st_info.cb ; process returncode or -1 <br />&nbsp; &nbsp; ret<br />system endp<br /><br />ENTRY32:<br />&nbsp; &nbsp; invoke&nbsp; system, CTEXT(&quot;blah&quot;)<br />&nbsp; &nbsp; invoke&nbsp; system, CTEXT(&quot;notepad&quot;)<br />&nbsp; &nbsp; invoke&nbsp; system, CTEXT(&quot;notepad.exe c:\test.txt&quot;)&nbsp; &nbsp; <br /><br />&nbsp; &nbsp; invoke&nbsp; ExitProcess, 0<br /><br />END ENTRY32<br /></code></pre><br /><strong>EDIT:</strong> - tabs to spaces, since I use 4space tabs.<br /></div>
    <div class="meta">Posted on 2005-05-07 20:17:03 by f0dder</div>
   </div>
   <div class="post" id="post-159833">
    <div class="subject"><a href="#post-159833">Re: shell, shell_ex and wshell</a></div>
    <div class="body">I again note that the topic as it has been addressed is not a technical subject but fits into the class of &quot;other&quot;, one I am willing to resolve elsewhere so that this forum can be used for its original purpose, assembler programming.<br /><br />The criticism has been going for a few years on the same basic premise yet there has been nothing new for over two years in the suggestions. To summarise, the original &quot;shell&quot; procedure does not close 2 handles and it is obvious in the source code noting that the source code is published with the MASM32 prject and it is targetted at assembler programmers who actually CAN read assembler code.. I have long ago explained why this procedure is done this way, complete with the leak of the two handles. It is designed as a fail safe DOS emulation procedure that runs on hadware that the suggested replacement crashes on.<br /><br />I have published the processor type, an AMD K6-2 3D NOW running at 550 meg. This processor is know to cause problem with Microsoft operating systems to the extent that Microsoft have published an errata and a patch to try and fix the problem of it crashing with win95b installed on it.<br /><br />The following URL is proof that operating system defined code is not garranteed to run on all hardware.<br /><br />http://www.microsoft.com/windows95/downloads/contents/WURecommended/S_WUServicePacks/AMDPatch/Default.asp<br /><br />The original &quot;shell&quot; procedure succeeds in what it was written for, to be &quot;fail safe&quot; on a massive range of hardware and this is proven by it not failing on hardware that the suggested replacement does fail on. I get substantial feedback on some of the most obscure problem with people installing the MASM32 project on different hardware with diferent language versions of Windows and different versions of Windows.<br /><br />Among the range of variations are virus damaged machines, machine with other hardware problems, machines with damaged system DLLs and the like yet the original &quot;shell&quot; procedure works on all of them so far. While I have had feedback on many other problems over the years, I have never had any over the operation performed by &quot;shell&quot;.<br /><br />I have made the point some years ago when this issue was first raised that the original shell procedure will NEVER BE MODIFIED as I need its fail safe characeristic for exactly what I use it for, the masm32 installation.<br /><br />The issue of repeatedly raising this criticism is not technically based, it has been known for years for exactly the reason I have mentioned above, it must work where other will crash. The repeated raising of the SAME issue has motivations that fit into the class of &quot;other&quot;. To save the noise and nonsense that will continue to be posted in here I have offered Spook the opportunity to close the thread and I will happily deal with it elsewhere were the noise does not matter.</div>
    <div class="meta">Posted on 2005-05-07 20:56:03 by hutch--</div>
   </div>
   <div class="post" id="post-159834">
    <div class="subject"><a href="#post-159834">Re: shell, shell_ex and wshell</a></div>
    <div class="body">I guess it is resolved then. Since f0dder cannot convince hutch on how to fix a possible problem and hutch is convinced that there is no problem, no matter who is right or wrong, then I see no reason to continue the discussion. Thread closed.<br /><br /></div>
    <div class="meta">Posted on 2005-05-07 21:00:21 by SpooK</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=21100&amp;page=1" style="">&laquo;</a><a href="../?id=21100&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="21100" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>  </div>
 </body>
</html>