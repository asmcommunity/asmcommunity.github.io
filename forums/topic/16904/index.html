<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Calculating Frustrum BoundingBox - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=16904" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=10">Graphics &amp; Game Development</a> &raquo; <a href="../?id=16904">Calculating Frustrum BoundingBox</a></p>
   <div class="post" id="post-131113">
    <div class="subject"><a href="#post-131113">Calculating Frustrum BoundingBox</a></div>
    <div class="body">Here's a snippet that shows how to calculate the current Frustrum.<br />It assumes that the View and Projection transforms have been applied, and that the World transform is Identity.<br />Code is untested, I just wanted to record this snippet in the Public Domain for the sake of those few who might be interested in performing Frustrum Culling in their D3D apps in the near future.<br /><br /><pre><code><br />;The following example shows calculation of the Camera View Frustrum in terms of World Space.<br />;If we wanted Camera Space &#40;aka world and view matrices are Identity&#41; we use matProjection only.<br />;If we wanted World Space &#40;only world matrix is Identity&#41; we use this code, ie projection and view.<br />;If we wanted Object Space we would concatentate the World, projection and view matrices.<br /><br /><br />.data<br />FrustumUn  D3DXVECTOR3 &lt;-1.0f, -1.0f,  0.0f&gt;<br />                    D3DXVECTOR3 &lt; 1.0f, -1.0f,  0.0f&gt;<br />                    D3DXVECTOR3 &lt;-1.0f,  1.0f,  0.0f&gt;<br />                    D3DXVECTOR3 &lt; 1.0f,  1.0f,  0.0f&gt;<br />                    D3DXVECTOR3 &lt;-1.0f, -1.0f,  1.0f&gt;<br />                    D3DXVECTOR3 &lt; 1.0f, -1.0f,  1.0f&gt;<br />                    D3DXVECTOR3 &lt;-1.0f,  1.0f,  1.0f&gt;<br />                    D3DXVECTOR3 &lt; 1.0f,  1.0f,  1.0f&gt;<br />.code<br /><br /><br />class CCamera<br />void CalcFrustrum<br />des viewMat D3DXMATRIX<br />des projMat D3DXMATRIX<br />array Points,D3DXVECTOR3,8<br />array Planes,D3DXPLANE,6<br />endclass<br /><br /><br />;This procedure is to be called AFTER the camera view has changed.<br />;It calculates the current Viewing Frustrum using the current view and projection matrices.<br /><br />CCamera_CalcFrustrum proc uses ecx<br />local mat&#58;D3DXMATRIX<br />local ppt0, ppt1, ppt2, ppt3, ppt4, ppt5, ppt6, ppt7&#58;DWORD<br />local me&#58;DWORD<br />mov me,ecx<br /><br />lea eax,&#91;ecx&#93;.CCamera.Points            ;First set up some lazycoder local pointers<br />mov ppt0,eax<br />add eax,sizeof D3DXVECTOR3<br />mov ppt1,eax<br />add eax,sizeof D3DXVECTOR3<br />mov ppt2,eax<br />add eax,sizeof D3DXVECTOR3<br />mov ppt3,eax<br />add eax,sizeof D3DXVECTOR3<br />mov ppt4,eax<br />add eax,sizeof D3DXVECTOR3<br />mov ppt5,eax<br />add eax,sizeof D3DXVECTOR3<br />mov ppt6,eax<br />add eax,sizeof D3DXVECTOR3<br />mov ppt7,eax<br /><br />;Calculate the inverse matrix of the combined view and projection matrices<br />invoke D3DXMatrixMultiply, addr mat, addr &#91;ecx&#93;.CCamera.viewMat, addr &#91;ecx&#93;.CCamera.projMat<br />invoke D3DXMatrixInverse, addr mat,NULL, addr mat<br /><br />;Transform the untransformed boundingbox of the Frustrum by the inverse view/projection<br />xor ecx,ecx<br />.while ecx&lt;8<br />        push ecx<br />        mov eax,sizeof D3DXVECTOR3<br />        mul ecx<br />        lea esi,FrustrumUn<br />        add esi,eax<br />        mov ecx,me<br />        invoke D3DXVec3TransformCoord, addr &#91;ecx+eax&#93;.CCamera.Points,esi, addr mat<br />        pop ecx<br />        inc ecx<br />.endw<br /><br />;Now calculate the planes of the new Frustrum boundingbox<br />mov ecx,me<br />lea edi,&#91;ecx&#93;.CCamera.Planes<br />mov pPlane,edi<br />invoke D3DXPlaneFromPoints, pPlane, ppt0, ppt1, ppt2       ;Near <br />add pPlane,sizeof D3DXPLANE<br />invoke D3DXPlaneFromPoints, pPlane, ppt6, ppt7, ppt5       ;Far <br />add pPlane,sizeof D3DXPLANE<br />invoke D3DXPlaneFromPoints, pPlane, ppt2, ppt6, ppt4       ;Left<br />add pPlane,sizeof D3DXPLANE<br />invoke D3DXPlaneFromPoints, pPlane, ppt7, ppt3, ppt5       ;Right  <br />add pPlane,sizeof D3DXPLANE<br />invoke D3DXPlaneFromPoints, pPlane, ppt2, ppt3, ppt6       ;Up<br />add pPlane,sizeof D3DXPLANE<br />invoke D3DXPlaneFromPoints, pPlane, ppt1, ppt0, ppt4       ;Down<br />ret<br />CCamera_CalcFrustrum endp<br /></code></pre></div>
    <div class="meta">Posted on 2004-01-20 02:03:53 by Homer</div>
   </div>
   <div class="post" id="post-131124">
    <div class="subject"><a href="#post-131124">Calculating Frustrum BoundingBox</a></div>
    <div class="body">Perhaps you can post it on Thomas's snipplet library? He maintains a snipplet library on his site <a target="_blank" href="http://www.madwizard.org/">http://www.madwizard.org/</a></div>
    <div class="meta">Posted on 2004-01-20 05:55:14 by roticv</div>
   </div>
   <div class="post" id="post-131133">
    <div class="subject"><a href="#post-131133">Calculating Frustrum BoundingBox</a></div>
    <div class="body">Well I would, but his site has no uplink for posting, and doesn't seem conducive to public postings, maybe he could alter his layout, but then he's have to actually monitor the incoming posts to determine which were worth keeping, and which were just junk I suppose... however, he might change his mind if he though people would contribute useful code... besides, anyone interesting in asmcoding is likely to run into this forum before they find a link to his site...</div>
    <div class="meta">Posted on 2004-01-20 08:58:59 by Homer</div>
   </div>
   <div class="post" id="post-131197">
    <div class="subject"><a href="#post-131197">Calculating Frustrum BoundingBox</a></div>
    <div class="body">That method sucks, here is a better one: <a target="_blank" href="http://www2.ravensoft.com/users/ggribb/plane%20extraction.pdf">http://www2.ravensoft.com/users/ggribb/plane%20extraction.pdf</a><br />It's faster and more stable.<br />Oh and it's frustum, not frustRum.<br /><br />Oh, and f0dder says I can't say your method sucks... Why not? I'll be banned anyway, who cares. That's how this Nazi-board works... You get banned everytime hutch says something stupid... Which is all the time.<br />When you try to help, nobody values it anyway, nobody is friendly to you anyway, so why be friendly to anyone else?<br />Fuck it.</div>
    <div class="meta">Posted on 2004-01-20 17:56:57 by Jan</div>
   </div>
   <div class="post" id="post-131213">
    <div class="subject"><a href="#post-131213">Calculating Frustrum BoundingBox</a></div>
    <div class="body">Hey thanks for the feedback.<br />I had actually come across a link to that document somewhere else, however after speedreading it once, I came to the following two conclusions: both are similar in that they rely on the precalculation of a combined matrix, but the &quot;faster&quot; method does not yield the boundingbox itself in terms of its vertices in world coordinates, which is so critical to me - it's a fast way of extracting planes only, leaving me some work to extract the vertices themselves, which pretty much evens them in terms of execution speed at a guess. So I guess in terms of non axially aligned bounding boxes, the fast planes extraction is the one that sucks.<br />I can't guarantee my frustRum will always be axially aligned, and I prefer the tightest-fit model. Which brings me to the term frustRum. Obviously, frustum is one of those butchered Americanisms of the English language, but I guess both are acceptable. I was taught frustrum, and a quick search for the term reveals its historical use with a second R, and its modern use with both, or just one R.<br />I'll continue to use the second R, and if you don't like it, you can run my source through an American spellcheck :tongue:<br />No offence was taken, as I am sure none was meant :)<br />As for the gestapo elements around here, I have no real comment since they don't bother me personally, and don't appear to shoo away newbs in general, maybe familiarity does breed contempt .. heh.</div>
    <div class="meta">Posted on 2004-01-20 22:11:29 by Homer</div>
   </div>
   <div class="post" id="post-131232">
    <div class="subject"><a href="#post-131232">Calculating Frustrum BoundingBox</a></div>
    <div class="body">Why would you need the vertices? You can do frustum culling by checking against the planes.<br />And what I don't see is how axis-alignment has anything to do with it.<br />The plane-extraction will just get the 6 frustum planes from the compound matrix.<br />There's no issue of axis-alignment or not, or tightest fit or not...<br />You just get the exact frustum planes, however the frustum is transformed, in any space. So you can do the culling in whatever space is most convenient. I generally find object-space msot convenient, because then you don't have to transform your bounding volume, which means it's very easy to support non-uniform scaling and translation.</div>
    <div class="meta">Posted on 2004-01-21 02:36:48 by Jan</div>
   </div>
   <div class="post" id="post-131234">
    <div class="subject"><a href="#post-131234">Calculating Frustrum BoundingBox</a></div>
    <div class="body">I guess maybe you missed my point then :)<br />Axially-aligned boundingboxes are fine for performing plane-based culling of geometry against a single boundingbox.<br />Imagine now a situation where we have two boundingboxes, lets call them BB1 and BB2. BB1 is axially aligned, and BB2 is rotated by 45 degrees on two axes to form a diamond shape. One corner of BB2 intersects BB1. Don't you think it makes sense to perform a test of all POINTS of BB1 against all PLANES of BB2 (or vice-versa)? We can determine partial occlusions this way. Note that I don't want to simply test geometry against the frustrum boundingbox, I want to test boundingboxes against boundingboxes in the same way as used in hierarchical bounding volumes used in the newer model of osp, and cannot make the assumption that those boxen are aligned in any way. Am I making sense? :)</div>
    <div class="meta">Posted on 2004-01-21 02:45:57 by Homer</div>
   </div>
   <div class="post" id="post-131236">
    <div class="subject"><a href="#post-131236">Calculating Frustrum BoundingBox</a></div>
    <div class="body">Not really, box-to-box checking is probably easiest by using half-axis vectors for the BB of the object and the planes of the frustum. There is a decent algorithm for it, but sadly the name escapes me at this time.<br />In general I always keep the frustum as a set of planes, and the bounding volumes of the objects are in a 'handy' format. Either sphere (center and radius) or box (center and half-axis vectors), usually.<br />Since you can get the frustum planes in object-space without much effort, you can simply do all frustum checks in object-space, without requiring any transforms to the sphere or box whatsoever, making it simple, fast and robust.<br />So what is your point?<br /><br />Besides, you specifically said your code was for calculating the bounding box of the frustum, which the plane-extraction paper does in a more efficient and more stable way..<br />So I don't really care how you try to defend your unrelated BB-stuff now. It's not relevant.</div>
    <div class="meta">Posted on 2004-01-21 03:00:54 by Jan</div>
   </div>
   <div class="post" id="post-131254">
    <div class="subject"><a href="#post-131254">Calculating Frustrum BoundingBox</a></div>
    <div class="body">Bleargh at your bitching... you can't use a half-axis method on a deformed boundingbox such as a transformed frustrum. You did mention that you prefer to do this in object space, which implies that not one, not two but all three major transforms have been applied. I can't assume that bounding boxes will always be cubes any more than I can assume they will have coplanar symmetry - my bounding boxes can be any shape that can be afforded by eight vertices.<br />If you know of an algo which precludes this logic and is applicable in all cases, sure I'd love to hear it. As for politics... I'd vote for hiro or hutch before any of the candidates I have to choose from...</div>
    <div class="meta">Posted on 2004-01-21 06:19:34 by Homer</div>
   </div>
   <div class="post" id="post-131255">
    <div class="subject"><a href="#post-131255">Calculating Frustrum BoundingBox</a></div>
    <div class="body">You bring it onto yourself scali. If you'd actually behave and not insult people then I would not care that you'd be a member (even if I would know you'd have registered). Yet somehow, you deem it fit to throw insults at people right from the start. No doubt such behaviour is tolerated on &quot;Scali's DX messageboard&quot; but not here and you've known that for a few years already.<br /><br />It's all very simple: behave -&gt; you can post, act like a child and insult people -&gt; you get banned.</div>
    <div class="meta">Posted on 2004-01-21 06:42:54 by Hiroshimator</div>
   </div>
   <div class="post" id="post-131257">
    <div class="subject"><a href="#post-131257">Calculating Frustrum BoundingBox</a></div>
    <div class="body"><div class="quote">you can't use a half-axis method on a deformed boundingbox such as a transformed frustrum.</div><br /><br />I think you are missing the point.<br />The frustum is NOT a bounding-box defined by half-axis vectors.<br />The frustum is ALWAYS a set of 6 planes... By definition your frustum is always a (perspective) deformed cube, so therefore all faces of the cube are still planar, and it can ALWAYS be represented by 6 planes (which does not necessarily have to be a box, obviously).<br /><br />And since you are able to get these planes in any space you want, including object-space, you can use the half-axis vectors of the bounding box of the OBJECT in object-space, meaning that you can simply form the bounding box in object-space, and use it as-is, and test each vector against the planes of the frustum.<br />This is quite trivial stuff, really. You might want to get a clue.<br /><br /><div class="quote">my bounding boxes can be any shape that can be afforded by eight vertices.</div><br /><br />You mean you even have deformed boxes in object-space? Then they're not boxes anyway, are they? What the hell are you talking about anyway? You mean you have convex hulls of 6 planes or something?<br /><br /><div class="quote">If you know of an algo which precludes this logic and is applicable in all cases, sure I'd love to hear it.</div><br /><br />If you mean frustum vs AABB/OOBB, I already gave it, you just didn't get it.<br />If you mean arbitrary convex hulls, perhaps you should re-think your strategy, these are considerably less efficient. And don't call them boxes then!<br /><br /><div class="quote">act like a child and insult people -&gt; you get banned.</div><br /><br />Then by all means, ban hutch... Obviously he was full of shit about the SGI stuff (yes they use Taiwanese Terrors! ATi GPUs!), and he only started a flamewar, which he blamed on me. HE should be banned, then I can behave because I won't be provoked and blamed for things I didn't cause. THINK damnit</div>
    <div class="meta">Posted on 2004-01-21 06:45:57 by Henk</div>
   </div>
   <div class="post" id="post-131260">
    <div class="subject"><a href="#post-131260">Calculating Frustrum BoundingBox</a></div>
    <div class="body">Thanks for your insight anyway, it's always refreshing to hear another point of view.<br />My issue with BB's defined by planes AND points stems from my translation of the doxygene engine (or whatever the hell it's called) which uses that in its CBoundingBox class, and in all the math therein. They test for intersections of point and plane, line and plane (just two point checks) and plane and plane, etc. Now I see what you were driving at, and I think you are right about this. Now take a deep breath and relax, I'm not an idiot, and I'm glad I didn't have you as a math teacher in my school days :)</div>
    <div class="meta">Posted on 2004-01-21 07:26:32 by Homer</div>
   </div>
   <div class="post" id="post-131265">
    <div class="subject"><a href="#post-131265">Calculating Frustrum BoundingBox</a></div>
    <div class="body"><div class="quote">Now take a deep breath and relax, I'm not an idiot, and I'm glad I didn't have you as a math teacher in my school days</div><br />Perhaps it's a blessing in disguise, after all, you DO learn in the end :)<br />I just don't really get the smugness of most asm-coders... They think they know everything, and won't accept it if you present a better method...<br />Also, if you just look at your box... You defined points with only 1, -1 and 0...<br />Now I don't know about you, but when I see such numbers, and multiplies are involved, I realize that these can only translate in add, sub or nop operations... Therefore, you can optimize them considerably... Which is how the plane-extraction came to life... It (ab)uses the properties of the viewing volume in post-projection space.<br />Especially asm-coders should have an instinct for picking up this sort of stuff, after all, you code asm because you want to get faster and smaller code, right? Then start by optimizing your algorithms!</div>
    <div class="meta">Posted on 2004-01-21 09:13:31 by Henk-Jan</div>
   </div>
  </div>
 </body>
</html>