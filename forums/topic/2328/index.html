<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>passwords on exe --&gt; PE? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=2328" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=2328">passwords on exe --&gt; PE?</a></p>
   <div class="post" id="post-14742">
    <div class="subject"><a href="#post-14742">passwords on exe --&gt; PE?</a></div>
    <div class="body">hi,<br /><br />i would like to program a tool, that can set passwords dialog on different exes, so that the user first has to type in the correct password to run it. now my question: how to do that? i heard something about PE-file-format, which seems to be the win-exe-format. a little code snippet or something like that wouldn't be bad.... <br /><br />thanks.<br /><br />nop</div>
    <div class="meta">Posted on 2001-12-12 14:36:28 by NOP-erator</div>
   </div>
   <div class="post" id="post-14747">
    <div class="subject"><a href="#post-14747">passwords on exe --&gt; PE?</a></div>
    <div class="body">ahh the refined and lovely art of code appending :)<br />I've toyed with this a lot sometime ago..and believe me, is this fun or what!!? :)<br />Yes you'll have to study the P(ortable) E(xecutable) format. why? well because you'll take a compiled closed binary image and you'll modify it and that is not as simple as createfile,writefile,closefile.<br />You will increase section's size's or even add a section to the exe. And those changes will have to be reflected in the PE header.<br />Basically you'll have to take an exe file, add the 'dialog box' code, modify the PE header accordingly,change the executable's entrypoint , modify Import Address Table, etc. <br />It's not very hard, but you'll have to study and code :)<br />I coded a tool that parses the PE header of a given executable file ('pelabs' is it's name). Get it at <a target="_blank" href="www.latigo.cjb.net">www.latigo.cjb.net</a> ('coding' section). Also check some PE tutes i wrote for further info.<br />There is a tool which exactly does what you want to do and it includes source code, so i guess that the whole thing makes a nice package ;). Get that tool at protools.cjb.net or playtools.cjb.net or at your local tool repository :)<br /><br />Ask further if you got any doubts..<br />See you!<br /><br />Latigo</div>
    <div class="meta">Posted on 2001-12-12 15:21:39 by latigo</div>
   </div>
   <div class="post" id="post-14791">
    <div class="subject"><a href="#post-14791">passwords on exe --&gt; PE?</a></div>
    <div class="body">if you understand the pe-header (which would be<br />a very hard task) it is very very simple to do that...<br />coz i'm at work right now i canot do this now but<br />wait till tomorrow and i'll give you the code to append<br />working code to a executable (maybe a simple msgbox<br />at start)... until then try to study the pe-header or<br />my bad-written example in hutchs masm7 sp <br />(exmpl 8/mob/no_imports)... :(</div>
    <div class="meta">Posted on 2001-12-13 05:38:00 by mob</div>
   </div>
   <div class="post" id="post-14801">
    <div class="subject"><a href="#post-14801">some code</a></div>
    <div class="body">here's some code i had to do once. Some guy hired me to make  some kind of 'packer'. This is not a packer since it does not compress. It's just  a crypter. Takes an exe, crypts it's code section and adds code so the exe will first look for a certain dll to decrypt itself . Easy protection to be bypassed. But that's what they wanted :).<br />Anyway, here's the code. I never 'released' it so it's not very tidy and there are no readmes and the comments are in spanish. But you are smart enough ;)<br />Hope it helps.<br /><br />Latigo</div>
    <div class="meta">Posted on 2001-12-13 07:57:39 by latigo</div>
   </div>
   <div class="post" id="post-14802">
    <div class="subject"><a href="#post-14802">passwords on exe --&gt; PE?</a></div>
    <div class="body">here are the dlls used for the encryption and decryption. If these are not present 'LatPack' is useless. <br /><br /><br />Latigo</div>
    <div class="meta">Posted on 2001-12-13 08:10:21 by latigo</div>
   </div>
   <div class="post" id="post-14835">
    <div class="subject"><a href="#post-14835">passwords on exe --&gt; PE?</a></div>
    <div class="body">you can also check my website (<a target="_blank" href="http://www.effervescence.com">http://www.effervescence.com</a>), there is some tuts on reversing</div>
    <div class="meta">Posted on 2001-12-13 12:30:44 by roy</div>
   </div>
   <div class="post" id="post-14858">
    <div class="subject"><a href="#post-14858">btw,</a></div>
    <div class="body">There is already a EXE password maker :-) (PE)<br />i also wrote a nive BruteForcer to it :-))<br />it called &quot;SMT's password protected exe&quot; u can find it in:<br />Protools.cjb.net / protools.com :alright: <br />cya all later :-)</div>
    <div class="meta">Posted on 2001-12-13 13:43:23 by Bengaly</div>
   </div>
   <div class="post" id="post-14862">
    <div class="subject"><a href="#post-14862">passwords on exe --&gt; PE?</a></div>
    <div class="body">ok, thanks. i'll have a look at it in the weekend, writing a physics test tomorrow.</div>
    <div class="meta">Posted on 2001-12-13 14:08:26 by NOP-erator</div>
   </div>
   <div class="post" id="post-14865">
    <div class="subject"><a href="#post-14865">passwords on exe --&gt; PE?</a></div>
    <div class="body">this is ~EXACTLY~ what you want, should be easy<br />to understand if you're familiar with the pe-header...<br />at start it let's you choose some executable and<br />changes this file, the result: on every start a little<br />msgbox is displayed... bye<br /><br /><pre><code><br />.486                                                           <br />.MODEL                  FLAT, STDCALL                          <br />OPTION                  CASEMAP&#58; NONE                           <br />INCLUDE                 \MASM32\INCLUDE\WINDOWS.INC            <br />INCLUDE                 \MASM32\INCLUDE\KERNEL32.INC           <br />INCLUDE                 \MASM32\INCLUDE\USER32.INC             <br />INCLUDE                 \MASM32\INCLUDE\COMDLG32.INC           <br />INCLUDELIB              \MASM32\LIB\USER32.LIB                 <br />INCLUDELIB              \MASM32\LIB\KERNEL32.LIB               <br />INCLUDELIB              \MASM32\LIB\COMDLG32.LIB               <br /><br />.DATA                                                          <br />MSGCAPTION              DB &quot;INFPE&quot;,0                           <br />MSGBOXTEXT              DB &quot;TARGET IS CHANGED&quot;,0              <br /><br />PROGSIZE                DD PROG_SIZE                          <br />MAPSIZE                 DD PROG_SIZE + 1000H                  <br /><br />OFN                     OPENFILENAME &lt;&gt;                        <br />FILTERSTRING            DB &quot;EXECUTABLE FILES&quot;,0,&quot;*.EXE&quot;,0      <br />                        DB &quot;ALL FILES&quot;,0,&quot;*.*&quot;,0,0              <br /><br />.DATA?                                                          <br />FILENAME                DB 256 DUP &#40; ? &#41;                          <br />FILEHANDLE              DD ?                                    <br />FILESIZE                DD ?                                    <br />H_BUFFER                DD ?                                    <br />M_BUFFER                DD ?                                    <br />                                                        <br />.CODE                                                   <br />START&#58;                                                  <br />;________________ _ _ _ &#91;    -CODE____SEC-     &#93; _ _ _ __              <br />        MOV             OFN.lStructSize,SIZEOF OFN       ; OPENFILENAME DIALOG<br />        MOV             OFN.lpstrFilter, OFFSET FILTERSTRING   <br />        MOV             OFN.lpstrFile, OFFSET FILENAME     <br />        MOV             OFN.nMaxFile,512                   <br />        MOV             OFN.Flags, OFN_FILEMUSTEXIST or \ <br />                        OFN_PATHMUSTEXIST or OFN_LONGNAMES or\ <br />                        OFN_EXPLORER or OFN_HIDEREADONLY  <br />        INVOKE          GetOpenFileName, ADDR OFN          <br />                                                                 <br />        INVOKE          _lopen,ADDR FILENAME,OF_READWRITE; READ &amp; WRITE ACCESS<br />        MOV             FILEHANDLE,EAX                         <br />                                                                     <br />        INVOKE          GetFileSize,EAX,NULL             ; GET FILESIZE<br />        INC             EAX                               <br />        JZ              _EXIT                             <br />        DEC             EAX                               <br />                                                        <br />        MOV             FILESIZE,EAX                            <br />        ADD             MAPSIZE,EAX                      ; MAPSIZE=PROG_SIZE+FILESIZE              <br />                                                         ;         +1000H&#40;EXTRA BUFFER&#41;              <br />        INVOKE          GlobalAlloc,GHND, MAPSIZE        ; ALLOCATE MEMORY              <br />        MOV             H_BUFFER, EAX                    ; GHND=ZERO INITIALIZED              <br />                                                         ;      +NON FIXED MEMORY BLOCK              <br />        INVOKE          GlobalLock,EAX                   ; LOCK MEMORY BLOCK              <br />        MOV             M_BUFFER, EAX                    ; M_BUFFER IS THE RESULTING              <br />        MOV             EDI,M_BUFFER                     ; POINTER TO OUR ALLOCATED MEMORY             <br />                                                                    <br />        INVOKE          _lread,FILEHANDLE,M_BUFFER,FILESIZE; READ ENTIRE FILE INTO BUFFER              <br />        INVOKE          _lclose,FILEHANDLE               ; CLOSE FILE &#40;???&#41;              <br />                                                         ; &gt;&gt;&gt;DO SOME CHECKS&lt;&lt;&lt;              <br />        CMP             WORD PTR &#91; EDI &#93;, &quot;ZM&quot;           ; CHECK FOR 'MZ'             <br />        JNZ             _EXIT                                       <br />        ADD             EDI, &#91;EDI + 03CH&#93;                ; EDI=POINTER TO PE HEADER              <br />        CMP             WORD PTR &#91; EDI &#93;, &quot;EP&quot;           ; CHECK FOR 'PE'             <br />        JNZ             _EXIT                                       <br />        CMP             DWORD PTR &#91; EDI + 04CH &#93;, 0      ; CHECK IF OTHER OR OUR PROG              <br />        JNZ             _EXIT                            ; HAS INFECTED THIS EXECUTABLE              <br />                                                         ; &gt;&gt;&gt;GET LAST SECTION&lt;&lt;&lt;              <br />        MOV             ECX, &#91; EDI + 074H &#93;              ; ECX=NBR OF DATAENTRIES              <br />        LEA             ECX, &#91; ECX * 8 + EDI &#93;           ;     *8&#40;2 DD'S&#41;+EDI&#40;MAPBASE&#41;              <br />        MOVZX           EAX, WORD PTR &#91; EDI + 006H &#93;     ; EAX=WORD PTR &#91;PE_6H&#93;&#40;SECTIONNBR&#41;              <br />        DEC             EAX                              ;     -1              <br />        LEA             EBX, &#91; EAX + EAX * 4 &#93;           ; EBX=EAX*28H&#40;SECTION LEN&#41;                <br />        LEA             EBX, &#91; EBX * 8 &#93;                 ; ...              <br />        LEA             EBX, &#91; EBX + ECX + 078H &#93;        ;     +ECX+78H&#40;OPTIONAL_HDR LEN&#41;                              <br />                                                         ; &gt;&gt;&gt;CHANGE VIRTUAL SIZE&lt;&lt;&lt;             <br />        MOV             EAX, PROGSIZE                      <br />        XADD            &#91; EBX + 008H &#93;, EAX                       <br />        CMP             EAX, &#91; EBX + 010H &#93;              ; CHECK IF PE IS CORRUPTED              <br />        JA              _EXIT                            ; &#40;PE-PACK/UPX/...&#41;             <br />                                                          <br />        PUSH            EAX                              ; SAVE OLDVIRTUALSIZE             <br />                                                                  <br />        PUSH            DWORD PTR &#91; EBX + 010H &#93;         ; SAVE OLDSIZEOFRAWDATA              <br />                                                         ; &gt;&gt;&gt;CHANGE SIZE OF RAW DATA&lt;&lt;&lt;              <br />        ADD             EAX, PROGSIZE                    ; EAX=NEWVIRTUALSIZE             <br />        XOR             EDX, EDX                         ;             <br />        MOV             ECX, &#91; EDI + 03CH &#93;              ; ECX=FILEALIGN VALUE              <br />        DIV             ECX                              ; EAX=EAX&#40;VIRTUALSIZE&#41;/ECX              <br />        INC             EAX                              ;     +1              <br />        IMUL            EAX, ECX                         ;     *ECX              <br />        MOV             &#91; EBX + 010H &#93;, EAX              ; STORE RESULT TO SIZEOFRAWDATA              <br />                                                         ; &gt;&gt;&gt;CHANGE SIZE OF IMAGE&lt;&lt;&lt;              <br />        POP             ECX                              ; ECX=OLDSIZEOFRAWDATA              <br />        MOV             EAX, &#91; EBX + 010H &#93;              ; EAX=NEWSIZEOFRAWDATA              <br />        SUB             EAX, ECX                         ;     -ECX              <br />        ADD             &#91; EDI + 050H &#93;, EAX              ; ADD RESULT             <br />                                                                     <br />        OR              DWORD PTR &#91; EBX + 024H &#93;, 0C0000000H; MAKE SECTION READABLE &amp; WRITABLE           <br />        MOV             DWORD PTR &#91; EDI + 04CH &#93;, 'ARAS' ; MARK FILE             <br />                                                         ;             <br />        POP             EAX                              ; EAX=OLDVIRTUALSIZE              <br />        ADD             EAX, &#91; EBX + 00CH &#93;              ;     +VIRTUALADDRESS              <br />        XCHG            &#91; EDI + 028H &#93;, EAX              ; STORE NEW ENTRYPOINT             <br />        ADD             EAX, &#91; EDI + 034H &#93;                   <br />                                                                    <br />        MOV             EDI, &#91; EBX + 014H &#93;              ; EAX=POINTERTORAWDATA              <br />        ADD             EDI, &#91; EBX + 008H &#93;              ; EAX=EAX+VIRTUALSIZE              <br />        MOV             ECX, PROGSIZE                                        <br />        SUB             EDI, ECX                         ;         -PROG_LENGHT              <br />        ADD             EDI, M_BUFFER                    ; EAX=EAX+MAPOFFSET              <br />        MOV             ESI, OFFSET PROG_START           ; ESI-&gt;PROG_BODY                      <br />        REP             MOVSB                            ; WRITE PROG TO FILEBUFFER              <br />                                                                              <br />        MOV             &#91; EDI - &#40; PROG_END - HRETURN &#41; + 1 &#93;, EAX; PUSH OLDEP + IMGBASE / RET<br />                                                                     <br />        INVOKE          _lcreat,ADDR FILENAME,0          ; OVERWRITE FILE...             <br />                                                                  <br />        MOV             EAX, &#91; EBX + 014H &#93;              ; EAX=POINTERTORAWDATA              <br />        ADD             EAX, &#91; EBX + 010H &#93;              ;     +SIZEOFRAWDATA             <br />                                                         ;             <br />                                                  <br />        INVOKE          _lwrite,FILEHANDLE,M_BUFFER,EAX  ; WRITE BUFFER TO FILE              <br />        INVOKE          _lclose,FILEHANDLE               ; CLOSE FILE             <br />_EXIT&#58;                                                         <br />                                                                     <br />        INVOKE          GlobalUnlock,M_BUFFER            ; CLOSE ALLOCATED MEMORY BLOCK<br />        INVOKE          GlobalFree,H_BUFFER                     <br />                                                       <br />        INVOKE          MessageBox, NULL,ADDR MSGBOXTEXT, ADDR MSGCAPTION,0<br />        INVOKE          ExitProcess,NULL                        <br /><br />;________________ _ _ _ &#91;    -HOST___PROG-     &#93; _ _ _ __<br />PROG_START&#58;                                              ; &lt;-TRANSFERED LATER ON<br />        PUSHAD                                          <br />                                                        <br />        CALL            DELTA                            ; GET DELTA<br />DELTA&#58;  POP             EBP                                     <br />        SUB             EBP, DELTA                              <br /><br />        CALL            GET_KERNEL                       ; GET KERNEL BASE     <br /><br />        MOV             ECX,2                            ; HOW MANY KERNEL API'S DO WE<br />        LEA             ESI, &#91; EBP + ___KERNEL32 &#93;       ; WANT? 2 I THINK...       <br />        CALL            GET_APIS                                <br /><br />        LEA             EAX, &#91; EBP + _USER32 &#93;           ; GET USER32 BASE VIA LOADLIB       <br />        PUSH            EAX                              <br />        CALL            &#91; EBP + _LOADLIBRARY &#93;           <br /><br />        TEST            EAX, EAX                         ; HUH???       <br />        JZ              ERR_EXT                                 <br /><br />        MOV             &#91; EBP + _DEFAULT &#93;, EAX          ; DEFAULT = USER32.DLL       <br /><br />        MOV             ECX, 1                           ; WE ONLY NEED ONE SINGLE USER <br />        LEA             ESI, &#91; EBP + ___USER32 &#93;         ; API &#40;MSGBOX&#41; THIS TIME...       <br />        CALL            GET_APIS                                <br /><br />        PUSH            0                                ; SAY HELLO...       <br />        CALL            @F                                      <br />        DB              &quot;LITTLE TEST&quot;,0                         <br />@@&#58;     CALL            @F                                      <br />        DB              &quot;HELLO FROM INFECTED HOST&quot;,0            <br />@@&#58;     PUSH            0                                       <br />        CALL            &#91; EBP + _MESSAGEBOX &#93;                   <br /><br />ERR_EXT&#58;POPAD                                            ; GET OLD REG VALUES<br />HRETURN&#58;PUSH            DWORD PTR 0                      ; ...IS CHANGED LATER!!       <br />        RET                                              ; BYYYE       <br /><br />;________________ _ _ _ &#91;     -GET_KERNEL-     &#93; _ _ _ __<br />GET_KERNEL&#58;                                              ; RETURNS THE KERNEL BASE<br />        MOV             ECX, &#91; ESP + 9 * 4 &#93;             ; SIMPLE BUT SMALL &#58;&#41;      <br />@@&#58;     DEC             ECX<br />        MOVZX           EDX, WORD PTR &#91; ECX + 03CH &#93;     ; EDX = POINTER TO PE_HDR<br />        CMP             ECX, &#91; ECX + EDX + 034H &#93;        ; COMPARE CURRENT BASE WITH<br />        JNZ             @B                               ; THE KERNEL IMAGE_BASE &#40;MZ&#41;<br />        MOV             &#91; EBP + _KERNEL &#93;, ECX           ; STORE RESULT<br />        MOV             &#91; EBP + _DEFAULT &#93;, ECX<br />        RET<br /><br />;________________ _ _ _ &#91;      -GET_APIS-      &#93; _ _ _ __<br />GET_APIS&#58;                                                ; SCANS THROUGH API TABLE<br />        INC             ESI                              ; AND RETURNS ADDRESSES<br />        PUSH            ECX<br />        CALL            GET_API                          ; SEARCH SINGLE API ADDRESS<br />        POP             ECX<br />        MOVZX           EBX, BYTE PTR &#91; ESI - 1 &#93;<br />        ADD             ESI, EBX                         ; STORE ADDRESS IN THE<br />        MOV             &#91; ESI &#93;, EAX                     ; API TABLE...<br />        ADD             ESI, 4<br />        LOOP            GET_APIS                         ; NEXT ONE<br />        RET<br /><br />;________________ _ _ _ &#91;      -GET_API-       &#93; _ _ _ __<br />GET_API&#58;                                                 ; SCANS FOR A SINGLE API ADR<br />        MOV             EDX, &#91; EBP + _DEFAULT &#93;          ; EDX = DEFAULT MODULE BASE                                              <br />        ADD             EDX, &#91; EDX + 03CH &#93;              ;       + OFFSET PE_HEADER<br />        MOV             EDX, &#91; EDX + 078H &#93;              ; EDX = PTR EXPORT_DIR RVA<br />        ADD             EDX, &#91; EBP + _DEFAULT &#93;          ;       + BASE<br />        MOV             EDI, &#91; EDX + 020H &#93;              ; EDI = PTR ADDRESS_OF_NAMES RVA<br />        ADD             EDI, &#91; EBP + _DEFAULT &#93;          ;       + BASE<br />        MOV             EDI, &#91; EDI &#93;                     ; EDI = PTR ADR_OF_NAMES RVA<br />        ADD             EDI, &#91; EBP + _DEFAULT &#93;          ;       + BASE<br />        MOV             EAX, &#91; EDX + 018H &#93;              ; EAX = NUMBER_OF_NAMES<br />        XOR             EBX, EBX<br />NXT_ONE&#58;INC             EBX<br />        MOVZX           ECX, BYTE PTR &#91; ESI - 1 &#93;        ; LENGHT OF SPEZIFED API NAME<br />        PUSH            ESI<br />        PUSH            EDI<br />        REPZ            CMPSB                            ; COMPARE API NAME WITH<br />        POP             EDI                              ; EXPORT ENTRY<br />        POP             ESI <br />        JZ              FOUND<br />        PUSH            EAX<br />        XOR             AL, AL<br />        SCASB                                            ; GET NEXT ONE<br />        JNZ             $ - 1<br />        POP             EAX<br />        DEC             EAX                              ; DECREASE NUMBER_OF_NAMES<br />        JZ              ERR_EXT<br />        JMP             NXT_ONE<br />FOUND&#58;  MOV             ECX, &#91; EDX + 024H &#93;              ; ECX = PTR NBR_NAME_ORDS RVA<br />        ADD             ECX, &#91; EBP + _DEFAULT &#93;          ;       + BASE<br />        DEC             EBX<br />        MOVZX           EAX, WORD PTR &#91; ECX + EBX * 2 &#93;  ; EAX = ORDINAL OF FUNCTION<br />        MOV             EBX, &#91; EDX + 01CH &#93;              ; EBX = PTR ADR_OF_FUNCTIONS RVA<br />        ADD             EBX, &#91; EBP + _DEFAULT &#93;          ;       + BASE<br />        MOV             EAX, &#91; EBX + EAX * 4 &#93;           ; EAX = FUNCTION RVA!!!!<br />        ADD             EAX, &#91; EBP + _DEFAULT &#93;          ;       + BASE<br />        RET<br /><br />;________________ _ _ _ &#91;      -API_TAB-       &#93; _ _ _ __ <br />___KERNEL32&#58;                                             ; KERNEL APIS, YOU CAN ADD AS<br />                        db 11,&quot;LoadLibrary&quot;              ; MANY AS YOU WANT BUT DON'T FORGET      <br />_LOADLIBRARY            dd 0                             ; TO CHANGE THE API-NUMBER ABOVE       <br />                        db 11,&quot;ExitProcess&quot;              ; BEFORE MAKING THE CALL TO GET_APIS     <br />_EXITPROCESS            dd 0                                    <br /><br /><br />___USER32&#58;                                               ; USER32 API'S<br />                        db 10,&quot;MessageBox&quot;               ;      <br />_MESSAGEBOX             dd 0                                    <br /><br />;________________ _ _ _ &#91;        -DATA-        &#93; _ _ _ __<br />_KERNEL                 dd 0                             ; ...     <br />_USER32                 db &quot;User32&quot;,0                           <br />_DEFAULT                dd 0                                    <br /><br />PROG_END&#58;                                                      <br /><br />PROG_SIZE               EQU $ - PROG_START                       <br /><br />END START<br /></code></pre></div>
    <div class="meta">Posted on 2001-12-13 14:37:38 by mob</div>
   </div>
  </div>
 </body>
</html>