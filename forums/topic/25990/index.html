<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Data in cs? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=25990" />
    <link rel="next" href="../?id=25990&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=113">Low Level Concepts</a> &raquo; <a href="../?id=25990">Data in cs?</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=25990&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=25990&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="25990" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=25990&amp;page=2">&gt;</a><a href="../?id=25990&amp;page=2">&raquo;</a></form>   <div class="post" id="post-189417">
    <div class="subject"><a href="#post-189417">Data in cs?</a></div>
    <div class="body">Can Win32 apps have and use data in the code section ?<br /><br />Thanks.<br /><br />.DATA<br /><br />.CODE<br /><br />Start:<br /><br />jmp&nbsp; &nbsp;  short ready<br />;mark&nbsp; &nbsp; db &quot;start&quot;,0<br />number&nbsp; dw&nbsp; 8<br /><br />ready:<br /><br />mov&nbsp;  cx,word ptr <br /><br />invoke ExitProcess, 0<br /><br />END Start<br /></div>
    <div class="meta">Posted on 2007-05-30 10:55:15 by skywalker</div>
   </div>
   <div class="post" id="post-189418">
    <div class="subject"><a href="#post-189418">Re: Data in cs?</a></div>
    <div class="body">Yup, remember it&#39;s a flat memory model :)<br /><br /><br /><br /></div>
    <div class="meta">Posted on 2007-05-30 12:37:12 by Ultrano</div>
   </div>
   <div class="post" id="post-189419">
    <div class="subject"><a href="#post-189419">Re: Data in cs?</a></div>
    <div class="body">Remember that, in most cases, data in the code section is &quot;read only&quot;. You may not be able to alter it with your program.<br /><br />Raymond<br /></div>
    <div class="meta">Posted on 2007-05-30 13:03:55 by Raymond</div>
   </div>
   <div class="post" id="post-189424">
    <div class="subject"><a href="#post-189424">Re: Data in cs?</a></div>
    <div class="body">sure u can<br /><br />virtualprotect<br /><br />and/or mark the section as read, write, execute...<br /><br />again, skywalker your queries really raise some serious questions as to the nature of your inquiries.....</div>
    <div class="meta">Posted on 2007-05-30 16:36:06 by evlncrn8</div>
   </div>
   <div class="post" id="post-189427">
    <div class="subject"><a href="#post-189427">Re: Data in cs?</a></div>
    <div class="body"><div class="quote"><br />again, skywalker your queries really raise some serious questions as to the nature of your inquiries.....<br /></div><br /><br />... personally i can see many reasons for this question that are well within the scope of this board such as<br /><br />minimizing file size<br />SMC for file protection<br /><br />take the following example<br /><br /><br />push 0<br />call @F<br />db &quot;test&quot;,0<br />@@: call @F<br />db &quot;test2&quot;,0<br />@@: push 0<br />Call MessageBoxA</div>
    <div class="meta">Posted on 2007-05-30 19:13:44 by paradox</div>
   </div>
   <div class="post" id="post-189428">
    <div class="subject"><a href="#post-189428">Re: Data in cs?</a></div>
    <div class="body"><div class="quote"><br />Remember that, in most cases, data in the code section is &quot;read only&quot;. You may not be able to alter it with your program.<br /><br />Raymond<br /><br /></div><br /><br />I am assimilating help I have received. I believe that code can be injected but I looked at that and it is way too complicated. As another poster said, I want to protect/and or slow down DD.(disassembler dudes).<br /><br />You can put data in a 16 bit program and use it freely. I just want to know if it can be done in a 32 bit app.<br /><br />Thanks for not thinking the worst. :-)<br /><br />Take care.</div>
    <div class="meta">Posted on 2007-05-30 20:26:46 by skywalker</div>
   </div>
   <div class="post" id="post-189429">
    <div class="subject"><a href="#post-189429">Re: Data in cs?</a></div>
    <div class="body"><div class="quote"><br /><div class="quote"><br />again, skywalker your queries really raise some serious questions as to the nature of your inquiries.....<br /></div><br /><br />... personally i can see many reasons for this question that are well within the scope of this board such as<br /><br />minimizing file size<br />SMC for file protection<br /><br />take the following example<br /><br /><br />push 0<br />call @F<br />db &quot;test&quot;,0<br />@@: call @F<br />db &quot;test2&quot;,0<br />@@: push 0<br />Call MessageBoxA<br /></div><br /><br />Thanks, I will look at it.<br /><br />Andy</div>
    <div class="meta">Posted on 2007-05-30 20:28:05 by skywalker</div>
   </div>
   <div class="post" id="post-189430">
    <div class="subject"><a href="#post-189430">Re: Data in cs?</a></div>
    <div class="body"><div class="quote"><br />sure u can<br /><br />virtualprotect<br /><br />and/or mark the section as read, write, execute...<br /><br />again, skywalker your queries really raise some serious questions as to the nature of your inquiries.....<br /></div><br /><br />There you go with the negative vibes. :-)<br /><br /></div>
    <div class="meta">Posted on 2007-05-30 20:31:22 by skywalker</div>
   </div>
   <div class="post" id="post-189443">
    <div class="subject"><a href="#post-189443">Re: Data in cs?</a></div>
    <div class="body">There&#39;s fundamentally no difference between code and data segments except for the &#39;permission flags on memory pages&#39;, as mentioned by evlncrn8.<br />These flags include Read, Write and Execute permissions.<br />With the appropriate flags set, you can do weird stuff, like execute code in a non-code segment (eg data segment).<br /><br />There&#39;s actually two ways to alter these page permissions.<br />evlncrn8 mentioned one of them, VirtualProtect(Ex) api function can be used to change the permissions at runtime. But there&#39;s another way.<br />You can modify the permissions of the FileSections in the PE file header.<br />The Windows PE Loader sets the permissions for segments based on the permissions that the corresponding filesection has.<br />Memory Segment(s) directly inherit the permissions of the corresponding FileSection(s) in the PE File Header.<br /><br /><br /></div>
    <div class="meta">Posted on 2007-05-31 22:47:21 by Homer</div>
   </div>
   <div class="post" id="post-189447">
    <div class="subject"><a href="#post-189447">Re: Data in cs?</a></div>
    <div class="body">Look up the /SECTION argument for link.exe , if you don&#39;t want to do without VirtualProtect.<br /><br />Imho, you should stay away from self-modifying code, and if you need to construct code at runtime, use VirtualAlloc with READWRITE permissions, construct the code, then use VirtualProtect to toggle to READONLY+EXECUTE.<br /></div>
    <div class="meta">Posted on 2007-06-01 06:21:25 by f0dder</div>
   </div>
   <div class="post" id="post-189448">
    <div class="subject"><a href="#post-189448">Re: Data in cs?</a></div>
    <div class="body">Windows OS can not be using Paging mechanisms for allowing a page be an executable page. A page can only be set as Present/Not present, Read Only/Read and write and 7 other flags (total number of 9 flags can be set for each PTE (Page Table Entry) and also for each PDE (Page Directory Entry)). Windows must be using the Type field of the segment descriptor for each segment selector in the GDT to prevent something in the data segment to be executed (Bits 8 to 11 inclusive for each Segment Descriptor).<br /><br />If you invoke the CreateThread Win32 API and trace the code down to NTDLL.dll you will see how the Windows Scheduler puts threads in a queue for the scheduler to pick in its next shot. The Windows&#39; scheduler does not update the CS field of its processes&#39; structure so you should not be able to change the code segment. When you jump to a data in the data segment, you are NOT executing the stuff in the data segment because only codes in the code segment will be executed and the data/code in the data segment will be accessed (read from and/or written to). The CPU uses the CS segment selector to execute code and not DS. So it doesn&#39;t matter what you put in DS, it should not get executed.<br /><br />Finally, I think Win32 APPs *are* allowed to use the CS as DS because AFAIK, the Type field of the segment descriptor of the CS in the GDT/LDT is set to 1010b (Not tested on XP) which is for Code Segment -&gt; Execute/Read so you must be able to access data in the CS.</div>
    <div class="meta">Posted on 2007-06-01 06:28:45 by XCHG</div>
   </div>
   <div class="post" id="post-189449">
    <div class="subject"><a href="#post-189449">Re: Data in cs?</a></div>
    <div class="body"><div class="quote"><br />Windows OS can not be using Paging mechanisms for allowing a page be an executable page.<br /></div><br />Wrong, since the NX bit was introduced, it can. It requires being in PAE mode though, and it requires CPU support (though there&#39;s some emulation methods that The Owl + friends originally camed up with (and got ripped off by OpenBSD, MS, etc) that can give similar effects at a cost).<br /><br />Even though the CS,DS,ES,SS selectors all point to the same memory space (base0 limit4g), you can never write with a CS: override, that&#39;s hardwired in the CPU. Page permissions are what&#39;s interesting in a flat linear memory model operating system, anyway.<br /></div>
    <div class="meta">Posted on 2007-06-01 06:57:22 by f0dder</div>
   </div>
   <div class="post" id="post-189450">
    <div class="subject"><a href="#post-189450">Re: Data in cs?</a></div>
    <div class="body">Thanks for all the info. I will study and do a search for example code.<br /><br />The only self modifying code I have is a counter value in a 16bit example that<br />increments a counter in the program itself each time the program is run.<br /><br />Andy</div>
    <div class="meta">Posted on 2007-06-01 07:27:08 by skywalker</div>
   </div>
   <div class="post" id="post-189451">
    <div class="subject"><a href="#post-189451">Re: Data in cs?</a></div>
    <div class="body">Does Windows XP use Physical Address Extension? I don&#39;t think so!</div>
    <div class="meta">Posted on 2007-06-01 07:56:53 by XCHG</div>
   </div>
   <div class="post" id="post-189452">
    <div class="subject"><a href="#post-189452">Re: Data in cs?</a></div>
    <div class="body">If you have a CPU with NX bit support and turn on Data Execution Prevention, it does...<br /></div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=2367" target="_blank">xp_pae.png</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2007-06-01 08:10:48 by f0dder</div>
   </div>
   <div class="post" id="post-189453">
    <div class="subject"><a href="#post-189453">Re: Data in cs?</a></div>
    <div class="body">No mine is not using PAE as I guessed and so I was not wrong about Paging protection mechanism. I think the best way is to use the Type bits on the Segment Descriptor in the GDT/LDT to protect a segment&#39;s content to be written to. Windows could also be using those 3 available bits of each PTE to put some flags for each of the PTEs (Bits 9 to 11). Whatever mechanism Windows is using I don&#39;t think I could care less about it&nbsp; :lol:</div>
    <div class="meta">Posted on 2007-06-01 08:53:53 by XCHG</div>
   </div>
   <div class="post" id="post-189454">
    <div class="subject"><a href="#post-189454">Re: Data in cs?</a></div>
    <div class="body">Well, then you don&#39;t have a CPU with NX bit support, or you have one but haven&#39;t enabled DEP.<br /><br />And duh, you can&#39;t use GDT/LDT to protect anything in a flat operating system.<br /></div>
    <div class="meta">Posted on 2007-06-01 08:56:29 by f0dder</div>
   </div>
   <div class="post" id="post-189455">
    <div class="subject"><a href="#post-189455">Re: Data in cs?</a></div>
    <div class="body">The Type bits are for protection; why do you they have put it there? Although I am totally against segmentation but those bits can sometimes come real handy!&nbsp; :P</div>
    <div class="meta">Posted on 2007-06-01 09:19:48 by XCHG</div>
   </div>
   <div class="post" id="post-189467">
    <div class="subject"><a href="#post-189467">Re: Data in cs?</a></div>
    <div class="body"><div class="quote"><br /><br />Imho, you should stay away from self-modifying code, and if you need to construct code at runtime, use VirtualAlloc with READWRITE permissions, construct the code, then use VirtualProtect to toggle to READONLY+EXECUTE.<br /><br /></div><br /><br />Well, changing some code to &quot;ro+x&quot; would be fine until someone loaded the exe into something like Ollydbg, and clicked &quot;Set Access&quot; -&gt; &quot;Full Access&quot;.</div>
    <div class="meta">Posted on 2007-06-02 07:44:38 by skywalker</div>
   </div>
   <div class="post" id="post-189470">
    <div class="subject"><a href="#post-189470">Re: Data in cs?</a></div>
    <div class="body">skywalker: that&#39;s not the point of page protection... it&#39;s to prevent against erroneous code, some types of program exploits, etc.<br /></div>
    <div class="meta">Posted on 2007-06-02 10:22:07 by f0dder</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=25990&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=25990&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="25990" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=25990&amp;page=2">&gt;</a><a href="../?id=25990&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>