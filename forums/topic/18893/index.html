<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>A shaped window - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=18893" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=18893">A shaped window</a></p>
   <div class="post" id="post-146205">
    <div class="subject"><a href="#post-146205">A shaped window</a></div>
    <div class="body">Hi,<br /><br />I am looking for a possibility to display a high resolution picture (jpeg) as shaped window (so that the background is transparent). I saw the source of doing that in the download area of iczelion. But this is just for bmps. Now my question: Is that also possible for jpegs? Or do those formats differ too much? I couldnt get it to work.<br /><br />DKT</div>
    <div class="meta">Posted on 2004-07-16 11:31:48 by Kreatief</div>
   </div>
   <div class="post" id="post-146207">
    <div class="subject"><a href="#post-146207">A shaped window</a></div>
    <div class="body">I think it's possible using Ernies Jpeg library. here:<br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=4239&amp;highlight=jp%2Ag">http://www.asmcommunity.net/board/index.php?topic=4239&amp;highlight=jp%2Ag</a><br /> After you got the DC from the picture the steps should be the same.</div>
    <div class="meta">Posted on 2004-07-16 11:56:38 by JimmyClif</div>
   </div>
   <div class="post" id="post-146209">
    <div class="subject"><a href="#post-146209">A shaped window</a></div>
    <div class="body">Remember that when using Ernie's JPEG routines, you need to fix BitmapFromMemory.asm, line 113, remove the &quot;invoke CoTaskMemFree, pGlobal&quot; line - it's already handled when calling the IStream Release method.<br /><br />Most of the &quot;create regions from bitmap&quot; sources out there are pretty inefficient (read: ungodly slow), you should access the pixel data directly (rather than call GetPixel), and build the RECT list and finally use ExtCreateRegion. (I've written code to do this in C, couldn't be bothered writing it in assembly since my C code already beat everything else I could find).<br /><br />Look at these two threads, btw:<br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=17519">http://www.asmcommunity.net/board/index.php?topic=17519</a><br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=14967">http://www.asmcommunity.net/board/index.php?topic=14967</a></div>
    <div class="meta">Posted on 2004-07-16 12:13:23 by f0dder</div>
   </div>
   <div class="post" id="post-146212">
    <div class="subject"><a href="#post-146212">A shaped window</a></div>
    <div class="body">Hi,<br /><br />hmm reading your relplies make me feel i dont know much... <br /><br />It seems as if I made a step into an area I shouldnt access now. I know too less to understand all that.<br /><br />Anyway, thank you!<br /><br /><br />DKT</div>
    <div class="meta">Posted on 2004-07-16 12:49:50 by Kreatief</div>
   </div>
   <div class="post" id="post-146217">
    <div class="subject"><a href="#post-146217">A shaped window</a></div>
    <div class="body">Don't be scared away :) - you can always start with the simpler methods, and look into the the more advanced methods when you feel ready.<br /><br />And please do ask any questions and such here, we will try to help you :)</div>
    <div class="meta">Posted on 2004-07-16 13:57:15 by f0dder</div>
   </div>
   <div class="post" id="post-146229">
    <div class="subject"><a href="#post-146229">A shaped window</a></div>
    <div class="body"><div class="quote"><br />Remember that when using Ernie's JPEG routines, you need to fix BitmapFromMemory.asm, line 113, remove the &quot;invoke CoTaskMemFree, pGlobal&quot; line - it's already handled when calling the IStream Release method.<br /><br />Most of the &quot;create regions from bitmap&quot; sources out there are pretty inefficient (read: ungodly slow), you should access the pixel data directly (rather than call GetPixel), and build the RECT list and finally use ExtCreateRegion. (I've written code to do this in C, couldn't be bothered writing it in assembly since my C code already beat everything else I could find).<br /><br />Look at these two threads, btw:<br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=17519">http://www.asmcommunity.net/board/index.php?topic=17519</a><br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=14967">http://www.asmcommunity.net/board/index.php?topic=14967</a> </div><br /><br />Here's some ASM code that I use to load an image and create a region from it.  This code assume you already have the image into a HBITMAP handle.  There are two functions inside the ASM file.   Call CreateRegionFromHBITMAP passing it the HBITMAP handle,  width, height,  color used for transparency and a bool value (specifying it should use the first pixel color instead of the transparency color).<br /><br />Relvinian</div>
    <div class="meta">Posted on 2004-07-16 16:36:54 by Relvinian</div>
   </div>
   <div class="post" id="post-146247">
    <div class="subject"><a href="#post-146247">A shaped window</a></div>
    <div class="body">Hmm ok. Youre right, I will give it another try!<br /><br />For the beginning I am dealing with simple bitmaps. Everything works fine. I get a shaped window! But I have one problem:<br /><br />I just see half of the picture painted (colored), the rest is grey. And when I drag the picture and move it outside the Windows-window, and move it back this part is also greyed!<br /><br />What can that be? Can you answer this question or do you need any source code or any more infos?<br /><br />I know Ill get a wonderful shaped window in some time...;) <br /><br />Thanks so far!<br /><br /><br />DKT</div>
    <div class="meta">Posted on 2004-07-17 07:50:19 by Kreatief</div>
   </div>
   <div class="post" id="post-146253">
    <div class="subject"><a href="#post-146253">A shaped window</a></div>
    <div class="body">Very nice code, Relvinian! :alright:<br /><br />Well structured, well commented, etc :)<br /><br />Just a few things:  access instead of GetProcessHeap? Isn't that a bit unnecessary? It might be unlikely that this address will ever change, but it will suck if it does!<br /><br />BitBlt vs. GetDIBits - what about color conversions? Pretty interesting, BitBlt says &quot;ICM: No color management is performed when blits occur.&quot;, so BitBlt might actually be better than GetDIBits - I guess I should do some test with a non-32bpp desktop resolution.<br /><br />But again, nice code :alright:</div>
    <div class="meta">Posted on 2004-07-17 09:36:13 by f0dder</div>
   </div>
   <div class="post" id="post-146269">
    <div class="subject"><a href="#post-146269">A shaped window</a></div>
    <div class="body">Can you see my last post? Or do I just need to wait a bit longer for a replie? :notsure: <br /><br /><br />DKT</div>
    <div class="meta">Posted on 2004-07-17 13:41:41 by Kreatief</div>
   </div>
   <div class="post" id="post-146270">
    <div class="subject"><a href="#post-146270">A shaped window</a></div>
    <div class="body">Hm, I think attaching your source in a .zip and/or a screenshot of what happens would help a lot :)</div>
    <div class="meta">Posted on 2004-07-17 14:00:59 by f0dder</div>
   </div>
   <div class="post" id="post-146271">
    <div class="subject"><a href="#post-146271">A shaped window</a></div>
    <div class="body">Heres the complete source...<br /><br />I just heard, it may be the graphiccard... Is that possible? Then I am asking: Is there any better code than that, that will do the job?!<br /><br />DKT</div>
    <div class="meta">Posted on 2004-07-17 14:06:27 by Kreatief</div>
   </div>
   <div class="post" id="post-146282">
    <div class="subject"><a href="#post-146282">A shaped window</a></div>
    <div class="body"><div class="quote"><br />Very nice code, Relvinian! :alright:<br /><br />Well structured, well commented, etc :)<br /></div><br /><br />Thanks.  This is my normal style.  Takes a little longer to code because of comments, etc but I think it is worth it.  Same goes for modifying because I will change comments, etc.<br /><br /><div class="quote"><br />Just a few things:  access instead of GetProcessHeap? Isn't that a bit unnecessary? It might be unlikely that this address will ever change, but it will suck if it does!<br /></div><br /><br />I think for the most part, if you want to GetProcessHeap instead of using the FS:xxx stuff, there's no problem.  Definitely safer for and new versions coming out.  But I was in the habit of using that and so I dont' even think about the GetProcessHeap API call.  I just code the mov eax, fs:[30h] without thinking about it now.<br /><br /><div class="quote"><br />BitBlt vs. GetDIBits - what about color conversions? Pretty interesting, BitBlt says &quot;ICM: No color management is performed when blits occur.&quot;, so BitBlt might actually be better than GetDIBits - I guess I should do some test with a non-32bpp desktop resolution.<br /></div><br /><br />I have tested this in 16bit, 24bit and 32bit colors and haven't seen any difference with doing it this way.  When reading a HBITMAP, etc and using DIBs, then there are.  But with the BitBlt, there seems to be some correcting in windows which helps.<br /><br /><br />But again, nice code :alright: </div></div>
    <div class="meta">Posted on 2004-07-17 16:17:47 by Relvinian</div>
   </div>
   <div class="post" id="post-146286">
    <div class="subject"><a href="#post-146286">A shaped window</a></div>
    <div class="body"><div class="quote"><br />Thanks. This is my normal style. Takes a little longer to code because of comments, etc but I think it is worth it. Same goes for modifying because I will change comments, etc.<br /></div><br />I think it's worth it - makes it easier to read the code, makes it easier to remember what you did more than a week ago, makes it easier to re-use, and makes it easier for _other_ people to understand (and learn from) your code.<br /><br /><div class="quote"><br />I think for the most part, if you want to GetProcessHeap instead of using the FS:xxx stuff, there's no problem. Definitely safer for and new versions coming out. But I was in the habit of using that and so I dont' even think about the GetProcessHeap API call. I just code the mov eax, fs:[30h] without thinking about it now.<br /></div><br />I do a single GetProcessHeap() call at the start of my applications and store that in a global variable - I _think_ this is safe, probably &quot;safer&quot; than the fs:xx stuff anyway, and a bit more optimal :)<br /><br /><div class="quote"><br />I have tested this in 16bit, 24bit and 32bit colors and haven't seen any difference with doing it this way. When reading a HBITMAP, etc and using DIBs, then there are. But with the BitBlt, there seems to be some correcting in windows which helps.<br /></div><br />What I'm wondering, is... if you load a 32bit image, and the desktop is either 16bpp or (heavens forbid) 256color, do colors get remapped? Since BitBlt documentation says no ICM is being done, I think not... but GetDIBits (as you say) is slow, so this _might_ actually do color mapping? Under any circumstance, we _must_ avoid color mapping, or we risk the region-color is remapped, so invalid region data is created...</div>
    <div class="meta">Posted on 2004-07-17 16:47:05 by f0dder</div>
   </div>
   <div class="post" id="post-146298">
    <div class="subject"><a href="#post-146298">A shaped window</a></div>
    <div class="body"><div class="quote"><em>Originally posted by f0dder </em><br /><br />I do a single GetProcessHeap() call at the start of my applications and store that in a global variable - I _think_ this is safe, probably &quot;safer&quot; than the fs:xx stuff anyway, and a bit more optimal :)<br /><br /></div><br /><br />I did that at first then I started sharing ASM files and people wondered or tried to use the code I posted and started giving too much tech support about what a  variable was and how to set it up.   Maybe I just hit the wrong crowd or something.<br /><br /><div class="quote"><br /><br />What I'm wondering, is... if you load a 32bit image, and the desktop is either 16bpp or (heavens forbid) 256color, do colors get remapped? Since BitBlt documentation says no ICM is being done, I think not... but GetDIBits (as you say) is slow, so this _might_ actually do color mapping? Under any circumstance, we _must_ avoid color mapping, or we risk the region-color is remapped, so invalid region data is created...</div><br /><br />I know if you create a 32bit image and try to display it on a 16bit desktop, using what I posted works well.  My original code that I wrote didn't do well in this method.   But I finally have it down.  Now, I don't know how it looks at 256colors though.<br /><br />Relvinian</div>
    <div class="meta">Posted on 2004-07-17 22:53:37 by Relvinian</div>
   </div>
   <div class="post" id="post-146300">
    <div class="subject"><a href="#post-146300">A shaped window</a></div>
    <div class="body"><div class="quote"><br />I did that at first then I started sharing ASM files and people wondered or tried to use the code I posted and started giving too much tech support about what a  variable was and how to set it up. Maybe I just hit the wrong crowd or something.<br /></div><br />;-) - that sort of stuff should be fixable with a comment anyway, and (if extreme), add a &quot;see declaration of dwProcessHeapID for explanation&quot; on each use of the variable, hehe.<br /><br /><div class="quote"><br />I know if you create a 32bit image and try to display it on a 16bit desktop, using what I posted works well. My original code that I wrote didn't do well in this method. But I finally have it down. Now, I don't know how it looks at 256colors though.<br /></div><br />Thanks, seems like I should fix my own code not to use GetDIBits - I'll play around a bit if I get the time.</div>
    <div class="meta">Posted on 2004-07-18 04:17:17 by f0dder</div>
   </div>
  </div>
 </body>
</html>