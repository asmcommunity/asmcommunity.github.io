<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>SSE Cosine Algo - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=21501" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=21501">SSE Cosine Algo</a></p>
   <div class="post" id="post-162407">
    <div class="subject"><a href="#post-162407">SSE Cosine Algo</a></div>
    <div class="body">I worked on this over night using the Infinite Addition algorithm for cosines<br />It took a while, because I didn&#39;t know that a ! meant integer PRODUCT from 1*2*3..*Number<br /><br />The benchmarking was done on a P4 3.2ghz with varying radian values.<br /><br />Making the algorithm parallel took a little fancy DataTable organizing and decent sized setup before the iterations and take down after. This will of course be made much easier with the new SSE3 instructions (I don&#39;t have access to a machine with SSE3 yet). <br /><br /><pre><code><br />;IN: ptr to qword double precision FP value in radians<br />;OUT: value of in ptr replaced with Cosine<br />align 16&nbsp; ;Lou Ricci, SSE Cosine, for the Community<br />CosSSE8_2:&nbsp; ;;parallelism<br />&nbsp; &nbsp;  mov eax, ;note: unrolling makes SSE slower on P4<br />&nbsp; &nbsp;  MOVSD xmm0,qword&nbsp; ;\<br />&nbsp; &nbsp;  MOVHPD xmm0,qword ;SSE3 MOV-DUP<br />&nbsp; &nbsp;  MOVDQA xmm1,xmm0 ; HI&nbsp; LO<br />&nbsp; &nbsp;  MULPD xmm0,xmm1 ; x^2 | x^2<br />&nbsp; &nbsp;  MULPD xmm1,xmm1 ; x^2 | x^2<br />&nbsp; &nbsp;  MULSD xmm0,xmm1 ; x^2 | x^4<br />&nbsp; &nbsp;  MULPD xmm1,xmm1 ; x^4 | x^4<br />&nbsp; &nbsp;  MOVDQA xmm3, dqword ; 1.0 | 0.0<br />&nbsp; &nbsp;  MOVDQA xmm2,xmm0 ;copy for scaling x^&#39;s with xmm1<br />&nbsp; &nbsp;  mov ecx,-16*6 ;12 iterations (6*2) parallel<br />&nbsp; .LP:<br />&nbsp; &nbsp;  MULPD xmm0, dqword ;x^? / (?)!<br />&nbsp; &nbsp;  ADDPD xmm3,xmm0&nbsp; &nbsp; ;1 - + - + -...<br />&nbsp; &nbsp;  MULPD xmm2,xmm1&nbsp; &nbsp; ;x^? | x^? TO x^(?+4) | x^(?+4)<br />&nbsp; &nbsp;  MOVDQA xmm0,xmm2<br />&nbsp; &nbsp;  add ecx,16<br />&nbsp; &nbsp;  js .LP<br />&nbsp; &nbsp;  ;add high qword and low qword of xmm3 for result<br />&nbsp; &nbsp;  ;err no SSE3 horizontal add yet so, cheap work around<br />&nbsp; &nbsp;  ;SSE3 HADDPD<br />&nbsp; &nbsp;  MOVHPD qword,xmm3<br />&nbsp; &nbsp;  ADDSD xmm3,qword<br />&nbsp; &nbsp;  MOVSD qword,xmm3<br />&nbsp; &nbsp;  ret 4<br />align 16<br />CosOneP dq 1.0, 0.0<br />align 16 ;Table of 1/4! | 1/2!, 1/8! | 1/6! ...<br />CosTableP dq 0.041666666666666666666666666666667, -0.5<br />&nbsp; &nbsp; &nbsp; &nbsp;  dq 2.4801587301587301587301587301587e-5, -0.0013888888888888888888888888888889<br />&nbsp; &nbsp; &nbsp; &nbsp;  dq 2.0876756987868098979210090321201e-9, -2.7557319223985890652557319223986e-7<br />&nbsp; &nbsp; &nbsp; &nbsp;  dq 4.7794773323873852974382074911175e-14, -1.1470745597729724713851697978682e-11<br />&nbsp; &nbsp; &nbsp; &nbsp;  dq 4.1103176233121648584779906184361e-19, -1.5619206968586226462216364350057e-16<br />&nbsp; &nbsp; &nbsp; &nbsp;  dq 1.6117375710961183490487133048012e-24, -8.8967913924505732867488974425025e-22<br />&nbsp; &nbsp; &nbsp; &nbsp;  dq 3.2798892370698379101520417273121e-30, -2.479596263224797460074943545848e-27<br /></code></pre><br /><br />The above code is faster than the FPU FCOS opcode.<br />You can scale precision (and speed of execution) by<br />lessening the number of loop iterations (ie change 16*6 to 16*5 in two lines of code).<br /><br />Last note, aligning the qword ptr that you pass to the function (and that receives the result), to 16bytes may improve speed slightly if the function is called A LOT.</div>
    <div class="meta">Posted on 2005-07-23 15:46:05 by r22</div>
   </div>
   <div class="post" id="post-162418">
    <div class="subject"><a href="#post-162418">Re: SSE Cosine Algo</a></div>
    <div class="body"><div class="quote">It took a while, because I didn&#39;t know that a ! meant integer PRODUCT from 1*2*3..*Number</div><br />It&#39;s called a &#39;factorial&#39; ;)</div>
    <div class="meta">Posted on 2005-07-23 23:50:36 by ti_mo_n</div>
   </div>
   <div class="post" id="post-162454">
    <div class="subject"><a href="#post-162454">Re: SSE Cosine Algo</a></div>
    <div class="body">Nice :)&nbsp; <br />The aliasing when compiling the CosTableP data can cause a bit of more incorrection of the result, what about computing them on the first call of the func ? <br />Again, I note that actual benchmark results (and comparisons) are important to state. </div>
    <div class="meta">Posted on 2005-07-24 21:54:18 by Ultrano</div>
   </div>
   <div class="post" id="post-162456">
    <div class="subject"><a href="#post-162456">Little optimization and Benchmarking</a></div>
    <div class="body">FPU function<br /><pre><code><br />CosFPU:<br />mov eax,<br />FLD qword<br />fcos<br />FSTP qword<br />retn 4<br /></code></pre><br /><br />Only the 2nd to last 2 lines were changed in the function using Shuffle instead of a High Mov<br />Iterations changed from 6 to 5<br /><pre><code><br />align 16? ;Lou Ricci, SSE Cosine, for the Community<br />CosSSE8_2:? ;;parallelism<br />? ? ?mov eax, ;note: unrolling makes SSE slower on P4<br />? ? ?MOVSD xmm0,qword? ;\<br />? ? ?MOVHPD xmm0,qword ;SSE3 MOV-DUP<br />? ? ?MOVDQA xmm1,xmm0 ; HI? LO<br />? ? ?MULPD xmm0,xmm1 ; x^2 | x^2<br />? ? ?MULPD xmm1,xmm1 ; x^2 | x^2<br />? ? ?MULSD xmm0,xmm1 ; x^2 | x^4<br />? ? ?MULPD xmm1,xmm1 ; x^4 | x^4<br />? ? ?MOVDQA xmm3, dqword ; 1.0 | 0.0<br />? ? ?MOVDQA xmm2,xmm0 ;copy for scaling x^&#39;s with xmm1<br />? ? ?mov ecx,-16*5 ;10 iterations (5*2)<br />? .LP:<br />? ? ?MULPD xmm0, dqword ;x^? / (?)!<br />? ? ?ADDPD xmm3,xmm0? ? ;1 - + - + -...<br />? ? ?MULPD xmm2,xmm1? ? ;x^? | x^? TO x^(?+4) | x^(?+4)<br />? ? ?MOVDQA xmm0,xmm2<br />? ? ?add ecx,16<br />? ? ?js .LP<br />? ? ?;add high qword and low qword of xmm3 for result<br />? ? ?;err no SSE3 horizontal add yet so, cheap work around<br />? ? ?;SSE3 HADDPD<br />? ? ?pshufd xmm1,xmm3,0eeh ;didn&#39;t think of it<br />? ? ?addsd xmm3,xmm1? ? ? ?;suggested by: revolution<br />? ? ?MOVSD qword,xmm3<br />? ? ?ret 4<br />align 16<br />CosOneP dq 1.0, 0.0<br />align 16 ;Table of 1/4! | 1/2!, 1/8! | 1/6! ...<br />CosTableP dq 0.041666666666666666666666666666667, -0.5<br />? ? ? ? ?dq 2.4801587301587301587301587301587e-5, -0.0013888888888888888888888888888889<br />? ? ? ? ?dq 2.0876756987868098979210090321201e-9, -2.7557319223985890652557319223986e-7<br />? ? ? ? ?dq 4.7794773323873852974382074911175e-14, -1.1470745597729724713851697978682e-11<br />? ? ? ? ?dq 4.1103176233121648584779906184361e-19, -1.5619206968586226462216364350057e-16<br />? ? ? ? ?dq 1.6117375710961183490487133048012e-24, -8.8967913924505732867488974425025e-22<br />? ? ? ? ?dq 3.2798892370698379101520417273121e-30, -2.479596263224797460074943545848e-27<br /></code></pre><br /><br />Test Values<br />---------------------------------------------------------------<br />Pi/2: 1.5707963267948966192313216916398<br />Pi/6: 0.52359877559829887307710723054658<br /><br />Precision Of Results<br />Cos(Pi/2): Cos(Pi/6)? <br />--------------------------------------------------------------<br />WinXP Calc.exe<br />0: 0.86602540378443864676372317075294<br />CosFPU (using printf api with a format string of %1.30f)<br />0.000000000000000061230317691119: 0.866025403784438600000000000000<br />CosSSE8_2 (using printf api with a format string of %1.30f)<br />0.000000000000000222044604925031: 0.866025403784438600000000000000<br /><br />Benchmark speed results in (ms)<br />------------------------------------------------------------<br />CosFPU (called 00 FF FF FF H times)<br />1313<br />CosSSE8_2 (called 00 FF FF FF H times)<br />1015? ? ? ? ?~20% speed up<br /><br />Benchmark was done on a P4 3.2ghz 1gbDDR WinXPsp2 box<br /><br /><br />20% speed increase, percision loss after the 15-16 decimal place <br /><br />I&#39;d like to see the GCC amd64 function for Cosine using SSE (if anyone has it at hand I&#39;d like to see it)</div>
    <div class="meta">Posted on 2005-07-24 23:01:18 by r22</div>
   </div>
  </div>
 </body>
</html>