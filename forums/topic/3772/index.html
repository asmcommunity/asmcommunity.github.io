<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Can MASM produce Com files - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=3772" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=3772">Can MASM produce Com files</a></p>
   <div class="post" id="post-25373">
    <div class="subject"><a href="#post-25373">Can MASM produce Com files</a></div>
    <div class="body">Can MASM32 produce COM files.  I'm a Visual Basic programmer and am new to assembler.  I have an example Visual Basic program with a very small machine code program embedded in a string constant.  The Hex string data is loaded into byte array and executed using the CallWindowProc api call.<br /><br />An example assembly file is included that produces a 14 byte com file.<br /><br />This is the Com file from MASM Open binary Hext command<br />---------------------------------------------------------------------------<br />; C:\Applications\Desktop\MASM32\MachCd\TEST.COM  14 bytes<br /><br />00000000: 55 89 E5 B8 4E 61 BC 00 - 89 EC 5D C2 10 00<br /><br /><br />This is the asm file that produced the above com file.<br />---------------------------------------------------------------------------<br />;Test.asm<br />;eax goes into result&amp; of CallWindowProc<br />USE32<br />push ebp<br />mov ebp,esp<br /><br />mov eax,12345678<br /><br />mov esp,ebp<br />pop ebp<br />ret 16<br /><br /><br />I have tried to modify it to work with MASM as follows:<br />---------------------------------------------------------------------------<br />.386<br />.model small<br />.code<br /><br />push ebp<br />mov ebp,esp<br /><br />mov eax,12345678<br /><br />mov esp,ebp<br />pop ebp<br />ret 16<br />END<br /><br /><br /><br />I've tried the following batch file to try and create the Com file without success. <br />---------------------------------------------------------------------------<br />\masm32\bin\ml /AT /c /FlMList.txt Test1.asm<br /><br />It assembles, but wont link.  Is this my main problem or does MASM32 not produce small files without the file headers on them? <br /><br />I know I may not be asking the right questions, but I'm new to assembler and all this is confusing to me.<br /><br />Thanks - Jack Rasnick<br /><a href="mailto:rasnick@att.net">rasnick@att.net</a></div>
    <div class="meta">Posted on 2002-02-21 18:06:54 by JackRazz</div>
   </div>
   <div class="post" id="post-25386">
    <div class="subject"><a href="#post-25386">Can MASM produce Com files</a></div>
    <div class="body">Actually the MASM32 package contains the linker from the win98ddk but other Microsoft linker will work fine as long as you understand the file alignment switch and ignore the warning.<br /><br />To produce a DOS memory image COM file, you need the old OMF linker which is available from either the Microsoft web site or if you cannot find it, get it from Iczelions site.<br /><pre><code><br />I have tried to modify it to work with MASM as follows: <br />     <br />&#91;code&#93;<br />      <br />                         .386 <br />                         .model small <br />                         .code <br /><br />                         push ebp <br />                         mov ebp,esp <br /><br />                         mov eax,12345678 <br /><br />                         mov esp,ebp <br />                         pop ebp <br />                         ret 16 <br />                         END               <br />&#91;/code&#93;<br /><br />The .386 forces MASM to build 32 bit code, the stack handling is not necessary as there are no stack parameters and you are using a dos segmented memory model for an EXE file, not a COM file.<br /><br />Let us know what you are trying to do and I am sure some of our members can help you if it can be done.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-02-21 20:09:45 by hutch--</div>
   </div>
   <div class="post" id="post-25485">
    <div class="subject"><a href="#post-25485">Can MASM produce Com files</a></div>
    <div class="body">The end result is to learn a little about assembler and create a simple CPU signature procedure that can be called from Visual Basic.<br /><br />At this point, I'm simply trying to create a Com file with MASM.  <br />I got the Microsoft Linker (version 5.63) from Iczelion's site.<br /><br />But I don't know how to create an COM file with it.   The original MASM linker has a 'Link.txt' file with the switches for it, but the MS 5.63 linker didn't have one.  Do you know the switches for link.exe to make it work?  I've attached a zip file with my asm, obj and bat files.<br /><br />When I try a simple link, It wants the exe name, etc and doesn't like the first byte, which is 4C.  'Fatal Error L1101: invalid object module, Object file offset: 1 Record type: 4c'.<br /><br />Next I try to create a simple routine that has values passed to it from Visual Basic based on the example below.  Finally, I'll try to get the CPU signature based on the example Pascal code I've attached below.  Whew, this is a lot for me.  But I'm gonna try.<br /><br />Thanks for your help - Jack Rasnick<br /><br /><br /><br /><br />Example asm to get parameters from CallWindowProc api call<br />----------------------------------------------------------<br />;This gets param into eax and to res&amp;<br />USE32<br /><br />long1 equ<br />long2 equ<br />long3 equ<br />long4 equ<br /><br />push ebp<br />mov ebp,esp<br /><br />mov eax,long1<br /><br />mov esp,ebp<br />pop ebp<br />ret 16<br /><br /><br /><br /><br /><br />Example Pascal code that I'll try to convert<br />-----------------------------------------------------<br />function AzCpuSignature: Longword;<br />{ -&gt; none<br />  &lt;- dword processor signiture or 0<br />     0..3: Stepping<br />     3..7: Model<br />     7..11: Family<br />     11..13: Type<br />     13..32: Intel reserved<br />}<br />asm<br />       CALL AzHasCpuId<br />       CMP AL, TRUE<br />       JNE @Unknown<br /><br />       PUSH EBX<br />       XOR EAX, EAX<br />       DW $A20F<br />       POP EBX<br /><br />       CMP EAX, 1<br />       JL @Unknown<br />       JMP @CpuId1<br /><br />@Unknown:<br />       XOR EAX, EAX<br />       JMP @End<br /><br />@CpuId1:<br />       PUSH EBX<br />       MOV EAX, 1<br />       DW $A20F<br />       POP EBX<br />@End:<br />end;<br /><br />function AzHasCpuId: Boolean;<br />{ -&gt; none<br />  &lt;- True if processor can execute CPUID instruction. False otherwise.<br />     Function tries to modify ID bit in Flags        }<br />asm<br />       MOV EDX, FALSE<br />       PUSHFD<br />       POP EAX<br />       MOV ECX, EAX<br />       XOR EAX, $200000<br />       PUSH EAX<br />       POPFD<br /><br />       PUSHFD<br />       POP EAX<br />       XOR ECX, EAX<br />       JZ @Skip<br />       MOV EDX, TRUE<br />@Skip:<br />       PUSH EAX<br />       POPFD<br />       MOV EAX, EDX<br />end;</div>
    <div class="meta">Posted on 2002-02-22 13:50:41 by JackRazz</div>
   </div>
   <div class="post" id="post-25535">
    <div class="subject"><a href="#post-25535">Can MASM produce Com files</a></div>
    <div class="body">Jack,<br /><br />It really depends what you are trying to do with the asm file you want to build. If you make a DOS com file and call it from VB, it will run in the DOS 16 bit subsystem, not in 32 bit so you cannot call it that way and get a return value back at all.<br /><br />What I would suggest is building a DLL in MASM as you can both call it from VB and get a return value back from it with no problems at all. It is in fact a good way to target speed critical operations for a VB program.<br /><br />Now if you want the info for using the old linker, just run it from a dos box and redirect the output to a text file.<br /><pre><code><br />LINK /? &gt; linkhelp.txt<br /></code></pre><br /><br />This is the only piece of DOS com code I have left, lost the rest on a dead disk a fw years ago.<br /><br /><pre><code><br />;----------------------- Hello.ASM ----------------------------<br /><br />com_seg segment byte public            ; define the ONLY segment<br /><br />        assume cs&#58;com_seg, ds&#58;com_seg  ; both code &amp; data in same segment.<br />        org 100h                       ; go to start adress in memory.<br /><br />start&#58;<br />        mov ah, 40h                    ; the DOS function number.<br />        mov bx, 1                      ; the screen handle.<br />        mov cx, 11                     ; the length of the text to display.<br />        mov dx, offset Greeting        ; the address of the text.<br />        int 21h                        ; get DOS to execute the function.<br /><br />        mov ax, 4Ch                    ; the TERMINATE process function.<br />        int 21h                        ; call DOS again to EXIT.<br /><br />Greeting db &quot;Hello World&quot;,13,10        ; specify the text as byte data.<br /><br />com_seg ends                           ; define the end of the segment.<br /><br />        end start<br /><br />;----------------------------------------------------------------<br /></code></pre><br /><br />the code example you are posting LOOKJ like 32 bit code so building a DLL may be the best way for you to go. There is an example in the MASM32 package on how to do a basic DLL.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-02-22 20:45:28 by hutch--</div>
   </div>
   <div class="post" id="post-25659">
    <div class="subject"><a href="#post-25659">Can MASM produce Com files</a></div>
    <div class="body">Jack,<br /><br />  I've one question for you before you kill yourself doing it this way.  Mine you, I like VB, and remember the 'good old days' when any programmer would code his interface in Basic, and drop in assembly statements for speed. (For you youngsters out there, this is in the pre-PC days).<br /><br />  I would ask why use the CallWindowProc to call the code? Wouldn't a simple dll call be easier to impliment? Or for someone else to follow? Not to mention probably faster too since it lacks the message proccessing API overhead.<br /><br />  Or even a Component Object Model COM style interface for even simpler reuse?<br /><br />  In any case, if you do go your way and get this to work, I would appreciate seeing an example.</div>
    <div class="meta">Posted on 2002-02-23 22:59:46 by Ernie</div>
   </div>
   <div class="post" id="post-25667">
    <div class="subject"><a href="#post-25667">Can MASM produce Com files</a></div>
    <div class="body">Ernie,<br />Thanks for the reply.  Its primarily license code that I don't want exposed with a public dll interface.  If the cpu signature (used to identify hardware) were exposed in a dll, it would then need to be encrypted (which I've already done in vb) to prevent a hacker from simply replacing the dll.  Based on the example code attached, it should have been fairly easy to embed it.  I have a CRC32 class module where someone else did it.  <br /><br />Speed isn't important.  In a lot of ways, it looks like a stupied hack (more maintenance, less readable, etc), but I simply didn't want to take a lot of trouble fixing an exposed dll.  I even have a Delphi class module ready to wrap into a dll, so yes, its more work.<br /><br />It would have been very small so it would have fit in a 1 line string easy.  I've run into a brick wall because I cannot link 32 bit code into machine code (COM file) and I don't know enough about assembly to do it.  I'm stuck<br /><br />Jack Rasnick:confused:</div>
    <div class="meta">Posted on 2002-02-24 00:18:11 by JackRazz</div>
   </div>
   <div class="post" id="post-25668">
    <div class="subject"><a href="#post-25668">Can MASM produce Com files</a></div>
    <div class="body">This is the original example code showing how to embed machine code into the vb project itself.</div>
    <div class="meta">Posted on 2002-02-24 00:23:58 by JackRazz</div>
   </div>
   <div class="post" id="post-25764">
    <div class="subject"><a href="#post-25764">Can MASM produce Com files</a></div>
    <div class="body">Jack,<br /><br />One of the few guys I know who is fluent in these sort of tricks with VB is a guy who hangs in the #win32asm channel on EFnet by the nick of cynica_l or variations of the same.<br /><br />I vaguely recollect him speaking of a method of adding an OBJ file into VB during its build stage.<br />An old version of CL.EXE and a version of LINK.EXE were available for compiled VB programs and it has something to do with stopping the process during build and adding the extra obj module.<br /><br />Maybe its worth giving that a try.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-02-24 23:21:36 by hutch--</div>
   </div>
   <div class="post" id="post-25908">
    <div class="subject"><a href="#post-25908">Can MASM produce Com files</a></div>
    <div class="body">hutch,<br />Thanks for the info.  I'm currently loading the machine code from the obj file, by starting at byte &amp;H65 in it.  There may be serious drawbacks to doing this, but it seems to be working.   I'm slowly learning assembler by doing everything wrong and spending a lot of time figuring it out.  This is typical for me.  First return a simple number (mov eax,12345), then return a argument (mov eax, long1) and so on.  <br /><br />At the moment, no debugger due to the approach I'm using - I may revise the way i'm doing it to get it.  Lets see, add the includes, figure out where the main procedure starts and finally start the CallWindowProc from there:cool:.<br /><br />Sometimes you have the most fun by just playing and not reading books, instructions, etc.  I may look for a simple assembler book tomorrow.<br /><br />Thanks again - Jack<br /><br />ps. - I like your wizard.  Just saw the Lord of the Rings director  discussing his wizard char on charlie rose last night.</div>
    <div class="meta">Posted on 2002-02-25 22:47:10 by JackRazz</div>
   </div>
  </div>
 </body>
</html>