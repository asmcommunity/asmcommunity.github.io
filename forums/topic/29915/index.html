<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Boot loader at&amp;t assembly syntax. - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=29915" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=34">OS Development</a> &raquo; <a href="../?id=29915">Boot loader at&amp;t assembly syntax.</a></p>
   <div class="post" id="post-211302">
    <div class="subject"><a href="#post-211302">Boot loader at&amp;t assembly syntax.</a></div>
    <div class="body">Hello,<br />I am using the following code for reading the kernel of 128 sectors.<br />when i allocate stack to the kernel and pass control to it,its code is not executed.Could you plz help me what is wrong in the following code??<br />Thanks,<br /><br /><pre><code><br />########################################################<br />.equ BOOT_SEGMENT,0x07c0<br />.equ DISPLAY_SEGMENT,0xb800<br />equ SECTOR_SIZE, 0x0200<br /><br />.text # Code segment<br />.globl _start # The entry point must be global<br />.code16 # Real mode<br /><br />_start:<br />jmp over<br /><br />os_size:<br />.long 0x00000000<br />drive_number:<br />.byte 0x00<br />max_sector:<br />.byte 0x00<br />max_head:<br />.byte 0x00<br />over:<br />movw $NEW_BOOT_SEGMENT, %ax #The address where the bios loaded the bootloader<br />movw %ax, %ds<br />movb %dl, drive_number #Address of the boot device<br />movb $0x08, %ah #getting parameters of boot device<br />int $0x13<br />andb $0x3f, %cl<br />movb %cl, max_sector<br />movb %dh, max_head<br />movw os_size, %bp #loop counter<br />movw $0x0002, %cx<br />movb $0x00, %dh<br />movw $0x0000, %ax<br />movw %ax, %es<br />movw $0x0100, %bx<br />read_sectors:<br />cmpw $0x0000, %bp #termination check<br />jng after_load<br />decw %bp<br />movw $0x0201, %ax #reading 1 sector at a time<br />int $0x13<br />jc error #if cf=1<br />cmpb max_sector, %cl<br />jnl next_head<br />incb %cl<br />jmp after_next<br /><br />next_head:<br />movb $0x01, %cl<br />cmpb max_head, %dh<br />jnl next_cylinder<br />incb %dh<br />jmp after_next<br />next_cylinder:<br />movb $0x00, %dh<br />incb %ch<br />after_next:<br />addw $SECTOR_SIZE, %bx<br />jnc read_sectors<br />after_load:<br />movw $0x0003, %ax<br />int $0x10<br />mov $0x0e.%ah #after loading kernel at es:bx display a flag character<br />mov $&#039;O&#039;,%al<br />int $0x10<br /><br />mov $0x9000,%bx #allocate stack to the kernel<br />mov %bx,%ss<br />mov $0xfffe,%sp<br />ljmp 0x01000 #long jump to the kernel location<br />error:<br />mov $0x0e.%ah<br />mov $&#039;E&#039;,%al<br />int $0x10<br />forever:<br /># Loop forever<br />hlt<br />jmp forever<br /></code></pre><br /><br /><span style="font-size:8pt><em>Edit by SpooK: Please put code in CODE blocks.</em></span></div>
    <div class="meta">Posted on 2010-04-12 07:25:42 by Ehsanulhaq</div>
   </div>
   <div class="post" id="post-211304">
    <div class="subject"><a href="#post-211304">Re: Bootloader code.</a></div>
    <div class="body"><strong>Ehsanulhaq</strong>,<br /><br />Are you sure this code compiles? GAS doesn&#039;t think so:<br /><br /><pre><code><br />...<br />equ SECTOR_SIZE, 0x0200<br />bootloader.gas:4: Error: no such instruction: `equ SECTOR_SIZE,0x0200&#039;<br />...<br />mov $0x0e.%ah #after loading kernel at es:bx display a flag character<br />&nbsp; &nbsp; &nbsp; &nbsp;  ^&nbsp; &nbsp; #before loading kernel GAS chokes on dot<br />...<br />ljmp 0x01000 #long jump to the kernel location<br />bootloader.gas:74: Warning: indirect ljmp without `*&#039;<br /></code></pre><br /><br />Additionally, boot sector is expected to contain 0x55,0xAA signature at offset 510 (otherwise BIOS considers media as non-bootable).<br /><br />As a sidenote, [?code] [?/code] BBCode tags show that you respect the readers.</div>
    <div class="meta">Posted on 2010-04-12 13:58:27 by baldr</div>
   </div>
   <div class="post" id="post-211306">
    <div class="subject"><a href="#post-211306">Re: Bootloader code.</a></div>
    <div class="body">Thank you for your reply.Plz try this code.it works.<br /><br /><pre><code><br /># .equ symbol, expression<br /># These directive set the value of the symbol to the expression<br /> &nbsp; &nbsp;.equ &nbsp; &nbsp;BOOT_SEGMENT,0x07c0<br /> &nbsp; &nbsp;.equ &nbsp; &nbsp;DISPLAY_SEGMENT,0xb800<br /> &nbsp; &nbsp;.equ	SECTOR_SIZE, 0x0200<br /><br /><br />.text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Code segment<br />.globl &nbsp; &nbsp;_start &nbsp; &nbsp;# The entry point must be global<br />.code16 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Real mode<br /><br />#<br /># The first instruction to execute in a program is called the entry<br /># point. The linker expects to find the entry point in the &quot;symbol&quot; _start<br /># (with underscore).<br />#<br /><br />_start:<br /> &nbsp; &nbsp;jmp &nbsp; &nbsp; over<br /><br />drive_number:<br />	.byte	0x00<br />max_sector:<br />	.byte	0x00<br />max_head:<br />	.byte	0x00<br />os_size:<br /> &nbsp; &nbsp;# Area reserved for createimage to write the OS size<br /> &nbsp; &nbsp;.word &nbsp; 0<br /> &nbsp; &nbsp;.word &nbsp; 0<br /><br /> &nbsp; &nbsp;# This is where the bootloader goes<br /> &nbsp; &nbsp;# Over prints a single character to the screen<br />over:<br /> &nbsp; &nbsp;movw &nbsp; &nbsp;$DISPLAY_SEGMENT,%bx<br /> &nbsp; &nbsp;movw &nbsp; &nbsp;%bx,%es<br /> &nbsp; &nbsp;movw &nbsp; &nbsp;$0x074b,%es:(0x0)<br /><br /><br />movw	$BOOT_SEGMENT, %ax<br />movw	%ax, %ds<br /><br />movb	%dl,drive_number<br /><br />movb	$0x08, %ah<br />int	$0x13<br /><br />andb	$0x3f, %cl<br />movb	%cl, max_sector<br /><br />movb	%dh, max_head<br />movw	os_size, %bp<br /><br />movw	$0x0002, %cx #sector number<br />movb	$0x00, %dh<br /><br />movw	$0x0000, %ax<br />movw	%ax, %es<br />movw	$0x0100,%bx<br /><br />	movw	$0, &nbsp;%dx	<br />load_loop:	<br />	cmpw	$5, %dx		<br />	jge	loop1done	<br /> <br />	mov $0x0e,%ah<br />	mov $&#039;:&#039;,%al<br />	int $0x10<br /><br />	#movw	%cx, %dx	<br />	incw	%dx<br /><br />movb	drive_number, %dl<br />movw	$0x0201, %ax<br /><br />xchgw	%bx, %bx<br /><br />int $0x13<br />jc error<br /><br />cmpb	max_sector, %cl<br />jnl	next_head<br />incb	%cl<br />jmp	after_next<br /><br />jmp	load_loop<br /><br /><br />next_head:<br /><br /><br />	movb	$0x01, %cl<br />	cmpb	max_head, %dh<br />	jnl	next_cylinder<br />	incb	%dh<br />	jmp	after_next<br />next_cylinder:<br />	movb	$0x00, %dh<br />	incb	%ch<br />after_next:<br />	# Increment the destination<br />	addw	$SECTOR_SIZE, %bx<br />	# Check the carry bit<br />	jnc	load_loop<br />	# Advance the segment if it&#039;s on<br />	<br />	movw	%es, %ax<br />	addw	$0x1000, %ax<br />	movw	%ax, %es<br />	jmp	load_loop<br /><br />error:<br /><br />mov $0x0e,%ah<br />mov $&#039;E&#039;,%al<br />int $0x10<br /><br /><br />forever: <br /> &nbsp; &nbsp;# Loop forever<br /> &nbsp; &nbsp;hlt<br /> &nbsp; &nbsp;jmp &nbsp; &nbsp; forever<br /><br />loop1done:<br />mov $0x0e,%ah<br />mov $&#039;C&#039;,%al<br />int $0x10<br /><br /><br />	#mov $0x9000,%bx<br />	#mov %bx,%ss<br />	#mov $0xfffe,%sp<br /><br /> &nbsp; &nbsp; &nbsp; &nbsp;jmp 0x01000<br /></code></pre><br /><br /><span style="font-size:8pt><em>Edit by SpooK: Please put code in CODE blocks.</em></span></div>
    <div class="meta">Posted on 2010-04-12 21:35:11 by Ehsanulhaq</div>
   </div>
   <div class="post" id="post-211307">
    <div class="subject"><a href="#post-211307">Re: Bootloader code.</a></div>
    <div class="body"><div class="quote"><br />As a sidenote, [?code] [?/code] BBCode tags show that you respect the readers.<br /></div><br /><br />Yes... so we don&#039;t feel compelled to yell <span style="font-size:12pt><strong>PUT YOUR CODE IN [</strong><strong>code</strong><strong>] [</strong><strong>/code</strong><strong>] BBCode BLOCKS :!:</strong></span> :)</div>
    <div class="meta">Posted on 2010-04-12 22:21:46 by SpooK</div>
   </div>
   <div class="post" id="post-211308">
    <div class="subject"><a href="#post-211308">Re: Bootloader code.</a></div>
    <div class="body">I forgot to mention one thing that i have found this project on website of princeton university. I am completing this project for learning purpose.Could you plz help??</div>
    <div class="meta">Posted on 2010-04-13 00:19:10 by Ehsanulhaq</div>
   </div>
   <div class="post" id="post-211312">
    <div class="subject"><a href="#post-211312">Boot loader at&amp;t assembly syntax.</a></div>
    <div class="body">Hello,<br />I am using the following code for reading the kernel of 128 sectors,store it at address 0000:1000 and then pass control to it.<br />The code is not working properply.Could anyone plz help??<br /><pre><code><br />	.equ	NEW_BOOT_SEGMENT, 0x00e0<br />	# Number of bytes in a sector<br />	.equ	SECTOR_SIZE, 0x0200<br />	# The boot loader puts the OS here<br />	.equ	OS_SEGMENT, 0x0100<br />	# offset in the GDT of the OS code segment<br />	.equ	OS_CODE_DESCRIPTOR, 0x00<br />	# offset in the GDT of the OS data segment<br />	.equ	OS_DATA_DESCRIPTOR, 0x10<br />	# Initial stack setup<br />	.equ	STACK_SEGMENT, 0x9000<br />	.equ	STACK_POINTER, 0xfffe<br />&nbsp; &nbsp; .equ&nbsp; &nbsp; BOOT_SEGMENT,0x07c0<br />&nbsp; &nbsp; .equ&nbsp; &nbsp; DISPLAY_SEGMENT,0xb800<br /><br />.text&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  # Code segment<br />.globl&nbsp; &nbsp; _start&nbsp; &nbsp; # The entry point must be global<br />.code16&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  # Real mode<br /><br />#<br /># The first instruction to execute in a program is called the entry<br /># point. The linker expects to find the entry point in the &quot;symbol&quot; _start<br /># (with underscore).<br />#<br /><br />_start:<br />&nbsp; &nbsp; jmp&nbsp; &nbsp;  over<br />boot_flag:&nbsp; &nbsp; &nbsp; <br />.word 0xAA55<br /><br />os_size:<br />	.long	0x10000000<br /># Reserve space for the drive parameters<br />drive_number:<br />	.byte	0x00<br />max_sector:<br />	.byte	0x00<br />max_head:<br />	.byte	0x00<br /><br />&nbsp; &nbsp; # Area reserved for createimage to write the OS size<br />&nbsp; &nbsp; .word&nbsp;  0<br />&nbsp; &nbsp; .word&nbsp;  0<br /><br />&nbsp; &nbsp; # This is where the bootloader goes<br />&nbsp; &nbsp; # Over prints a single character to the screen<br />over:<br />&nbsp; &nbsp; movw&nbsp; &nbsp; $DISPLAY_SEGMENT,%bx<br />&nbsp; &nbsp; movw&nbsp; &nbsp; %bx,%es<br />&nbsp; &nbsp; movw&nbsp; &nbsp; $0x074b,%es:(0x0)<br /><br />	<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; movw	$0x0030, %ax<br />	movw	%ax, %ss<br />	movw	$0x0100, %sp<br />	<br />	<br />	movw	$BOOT_SEGMENT, %ax<br />	movw	%ax, %ds<br />	movw	$0x0000, %si<br />	<br />&nbsp; &nbsp; &nbsp; &nbsp; movw	$NEW_BOOT_SEGMENT, %ax<br />	movw	%ax, %es<br />	movw	$0x0000, %di<br />	<br />	movw	$SECTOR_SIZE, %cx<br />	<br />	cld<br />	<br />	rep movsb<br /><br />after_move:<br /><br />movw	$NEW_BOOT_SEGMENT, %ax<br />movw	%ax, %ds<br /><br />movb	%dl,drive_number<br /><br />movb	$0x08, %ah<br />int	$0x13<br /><br />andb	$0x3f, %cl<br />movb	%cl, max_sector<br /><br />movb	%dh, max_head<br />movw	os_size, %bp<br /><br />movw	$0x0002, %cx #sector number<br />movb	$0x00, %dh<br /><br />movw	$0x0000, %ax<br />movw	%ax, %es<br />movw	$0x1000,%bx<br /><br /><br />load_loop:<br /><br />cmpw	$0x0000, %bp<br />jng	after_load<br />decw	%bp<br /><br />movb	drive_number, %dl<br />movw	$0x0201, %ax<br /><br />xchgw	%bx, %bx<br /><br />int $0x13<br />jc error<br />cmpb max_sector, %cl<br />jnl	next_head<br />incb	%cl<br />jmp	after_next<br />next_head:<br />	movb	$0x01, %cl<br />	cmpb	max_head, %dh<br />	jnl	next_cylinder<br />	incb	%dh<br />	jmp	after_next<br />next_cylinder:<br />	movb	$0x00, %dh<br />	incb	%ch<br /><br />after_next:<br /><br />	# Increment the destination<br />	addw	$SECTOR_SIZE, %bx<br />	# Check the carry bit<br />	jnc	load_loop<br /><br />	# Advance the segment if it&#039;s on<br />	<br />	movw	%es, %ax<br />	addw	$0x1000, %ax<br />	movw	%ax, %es<br />	jmp	load_loop<br /><br />error:<br /><br />mov $0x0e,%ah<br />mov $&#039;E&#039;,%al<br />int $0x10<br /><br />jmp forever<br /><br />after_load:<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; movw	$0x0003, %ax<br />	int	$0x10<br />&nbsp; <br />mov $0x0e,%ah<br />mov $&#039;C&#039;,%al<br />int $0x10<br />&nbsp; &nbsp; &nbsp; &nbsp; movw	$0x0, %ax<br />	movw	%ax, %ds<br /><br />movw $0x00,%ax<br />movw $0x00,%bx<br />movw $0x00,%cx<br />movw $0x00,%dx<br />movw %bx,%ss<br />movw %bx,%es<br /><br />	# Set up the stack<br />	mov $0x9000,%bx<br />	mov %bx,%ss<br />	mov $0xfffe,%sp<br />&nbsp; &nbsp; &nbsp; &nbsp; ljmp 0x1000<br />forever:<br />mov $0x0e,%ah<br />mov $&#039;F&#039;,%al<br />int $0x10<br />&nbsp; &nbsp; # Loop forever<br />&nbsp; &nbsp; hlt<br />&nbsp; &nbsp; jmp&nbsp; &nbsp;  forever<br /></code></pre></div>
    <div class="meta">Posted on 2010-04-13 04:22:14 by Ehsanulhaq</div>
   </div>
   <div class="post" id="post-211313">
    <div class="subject"><a href="#post-211313">Re: Bootloader code.</a></div>
    <div class="body"><strong>Ehsanulhaq</strong>,<br /><br />OK, it compiles. Probably you can even <strong>--force</strong> GRUB to chain-load and <em>execute</em> it (or disable bootsig check in Bochs; do you understand why it won&#039;t be executed by regular BIOS?). What have you learnt from it already?</div>
    <div class="meta">Posted on 2010-04-13 07:16:04 by baldr</div>
   </div>
   <div class="post" id="post-211314">
    <div class="subject"><a href="#post-211314">Re: Bootloader code.</a></div>
    <div class="body">Thanks for your reply.I have learnt one thing that it is very to write code for a boot loader :) .I am using QEMU for testing the image.could you plz point out what is wrong in the code.<br /></div>
    <div class="meta">Posted on 2010-04-13 07:24:01 by Ehsanulhaq</div>
   </div>
   <div class="post" id="post-211317">
    <div class="subject"><a href="#post-211317">Re: Bootloader code.</a></div>
    <div class="body"><div class="quote"><br />I am using QEMU for testing the image.could you plz point out what is wrong in the code.<br /></div><br /><br /><strong>baldr</strong> explained that in his first response to this thread, the code you posted is missing the standard MBR boot signature.</div>
    <div class="meta">Posted on 2010-04-13 11:57:19 by SpooK</div>
   </div>
   <div class="post" id="post-211319">
    <div class="subject"><a href="#post-211319">Re: Boot loader at&amp;t assembly syntax.</a></div>
    <div class="body"><strong>Ehsanulhaq</strong>, I&#039;ve merged your &quot;boot loader&quot; threads into this single discussion, as they are fundamentally no different from each other and exhibit the same problem(s).</div>
    <div class="meta">Posted on 2010-04-13 12:09:54 by SpooK</div>
   </div>
   <div class="post" id="post-211320">
    <div class="subject"><a href="#post-211320">Re: Boot loader at&amp;t assembly syntax.</a></div>
    <div class="body"><div class="quote"><br />I am using the following code for reading the kernel of 128 sectors,store it at address 0000:1000 and then pass control to it.<br />The code is not working properply.Could anyone plz help??<br /></div><br /><br />Yes, I can help by pointing out that you have a severe misunderstanding of what a MBR is and its corresponding structure/format.<br /><br />I recommend that you read the <a target="_blank" href="http://wiki.osdev.org/MBR_%28x86%29">OSDev Wiki article on the MBR</a>.</div>
    <div class="meta">Posted on 2010-04-13 12:14:48 by SpooK</div>
   </div>
   <div class="post" id="post-212796">
    <div class="subject"><a href="#post-212796">Re: Boot loader at&amp;t assembly syntax.</a></div>
    <div class="body">Alot of pointless code included like yours equivalent bytes-you only have 510 bytes, don&#039;t waste it.&nbsp; :lol:<br /><span class="mono">Lol</span></div>
    <div class="meta">Posted on 2010-08-18 12:09:34 by marcalexanderreed</div>
   </div>
  </div>
 </body>
</html>