<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>GetVersionEx? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=25039" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=25039">GetVersionEx?</a></p>
   <div class="post" id="post-183354">
    <div class="subject"><a href="#post-183354">GetVersionEx?</a></div>
    <div class="body">I have some code i found to get the windows version, i am trying to make it &#39;lower level&#39; so that i can learn masm32/asm better. here is what i have so far  -<br /><br /><pre><code><br /><br />print macro lpszText:VARARG<br />	LOCAL txt<br /> 	.data<br />&nbsp; 		txt DB lpszText,13,10,0<br /> 	.code<br />&nbsp; 		invoke StdOut, ADDR txt<br />ENDM<br /><br />.data?<br /><br /><br />osinfo&nbsp; &nbsp; &nbsp; OSVERSIONINFO &lt;&gt;<br />AppName&nbsp; &nbsp;  DB ?<br />tmp			DD ?<br />buffer&nbsp; &nbsp; &nbsp; db 512 dup (?)<br /><br /><br />.const<br /><br /><br />szOSError&nbsp;  DB &quot;Error Determining Windows version&quot;,0<br />szOSUnknown	DB &quot;Unknown Version of Windows&quot;,0<br />szWin98&nbsp; &nbsp; &nbsp;  DB &quot;Windows 98&quot;,0<br />szWinME&nbsp; &nbsp; &nbsp;  DB &quot;Windows ME&quot;,0<br />szWinNT&nbsp; &nbsp; &nbsp;  DB &quot;Windows NT&quot;,0<br />szWin2k&nbsp; &nbsp; &nbsp;  DB &quot;Windows 2000&quot;,0<br />szWinXP&nbsp; &nbsp; &nbsp;  DB &quot;Windows XP&quot;,0<br />szWin2k3&nbsp; &nbsp; &nbsp; DB &quot;Windows 2003&quot;,0<br /><br />.code<br /><br /><br />GetOS proc<br />	MOV osinfo.dwOSVersionInfoSize, SIZEOF OSVERSIONINFO<br />	; Get Windows Version<br />	PUSH osinfo<br />	call GetVersionEx<br />	; Test for success<br />	CMP EAX, 0<br />	JE @F<br />	@@:<br />&nbsp;  		print szOSError<br />		PUSH 0<br />&nbsp;  		CALL ExitProcess<br />	.IF osinfo.dwMajorVersion==5 &amp;&amp;osinfo.dwMinorVersion==2<br />		invoke wsprintf,addr buffer,addr format,addr Win2k3,addr osinfo.szCSDVersion<br />	.ELSEIF osinfo.dwMajorVersion==5 &amp;&amp;osinfo.dwMinorVersion==1<br />		invoke wsprintf,addr buffer,addr format,addr WinXP,addr osinfo.szCSDVersion<br />	.ELSEIF osinfo.dwMajorVersion==5 &amp;&amp;osinfo.dwMinorVersion==0<br />		invoke wsprintf,addr buffer,addr format,addr Win2k,addr osinfo.szCSDVersion<br />	.ELSEIF osinfo.dwMajorVersion==4 &amp;&amp;osinfo.dwMinorVersion==0<br />		invoke wsprintf,addr buffer,addr format,addr WinNT,addr osinfo.szCSDVersion<br />	.ELSEIF osinfo.dwMajorVersion==4 &amp;&amp;osinfo.dwMinorVersion==90<br />		invoke wsprintf,addr buffer,addr format,addr WinME,addr osinfo.szCSDVersion&nbsp; &nbsp; <br />	.ELSEIF osinfo.dwMajorVersion==4 &amp;&amp;osinfo.dwMinorVersion==10<br />		invoke wsprintf,addr buffer,addr format,addr Win98,addr osinfo.szCSDVersion&nbsp; <br />	.ELSE<br />		invoke MessageBox,NULL,addr Upgrade,addr AppName,MB_OK<br />&nbsp;  		print szOSUnknown<br />	.ENDIF<br />	print &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />	invoke MessageBox,NULL,aDDr buffer,aDDr AppName,MB_OK<br />	RET<br />GetOS endp<br /></code></pre><br /><br />Any ideas what i am doing wrong?</div>
    <div class="meta">Posted on 2006-07-10 19:26:51 by p0wder</div>
   </div>
   <div class="post" id="post-183363">
    <div class="subject"><a href="#post-183363">Re: GetVersionEx?</a></div>
    <div class="body">Here is a striped down code which should work: <br /><br /><pre><code>.486<br />.model flat, stdcall&nbsp; <br />option casemap:none <br /><br />include \masm32\include\windows.inc<br />include \MASM32\INCLUDE\user32.inc<br />include \MASM32\INCLUDE\kernel32.inc<br />includelib \MASM32\LIB\user32.lib<br />includelib \MASM32\LIB\kernel32.lib<br /><br />.data<br /><br />format db &quot;%s %s&quot;,0<br /><br />.data?<br /><br />osinfo&nbsp; &nbsp; &nbsp; OSVERSIONINFO &lt;&gt;<br />buffer&nbsp; &nbsp; &nbsp; db 512 dup (?)<br /><br />.const<br /><br />AppName&nbsp; &nbsp;  DB &quot;test app&quot;,0<br />szOSError&nbsp;  DB &quot;Error Determining Windows version&quot;,0<br />szOSUnknown	DB &quot;Unknown Version of Windows&quot;,0<br />szWin98&nbsp; &nbsp; &nbsp;  DB &quot;Windows 98&quot;,0<br />szWinME&nbsp; &nbsp; &nbsp;  DB &quot;Windows ME&quot;,0<br />szWinNT&nbsp; &nbsp; &nbsp;  DB &quot;Windows NT&quot;,0<br />szWin2k&nbsp; &nbsp; &nbsp;  DB &quot;Windows 2000&quot;,0<br />szWinXP&nbsp; &nbsp; &nbsp;  DB &quot;Windows XP&quot;,0<br />szWin2k3&nbsp; &nbsp; &nbsp; DB &quot;Windows 2003&quot;,0<br /><br />.code<br /><br />start:<br /><br />	MOV osinfo.dwOSVersionInfoSize, SIZEOF OSVERSIONINFO<br />	; Get Windows Version<br />	PUSH offset osinfo<br />	call GetVersionEx<br />	; Test for success<br />	CMP EAX, 0<br />	JNE @F<br />&nbsp;  		invoke MessageBox,NULL,aDDr szOSError,aDDr AppName,MB_OK<br />		PUSH 0<br />&nbsp;  		CALL ExitProcess<br />&nbsp; &nbsp;  @@:		<br /><br />	.IF osinfo.dwMajorVersion==5 &amp;&amp; osinfo.dwMinorVersion==2<br />		invoke wsprintf,addr buffer,addr format,addr szWin2k3,addr osinfo.szCSDVersion<br />	.ELSEIF osinfo.dwMajorVersion==5 &amp;&amp; osinfo.dwMinorVersion==1<br />		invoke wsprintf,addr buffer,addr format,addr szWinXP,addr osinfo.szCSDVersion<br />	.ELSEIF osinfo.dwMajorVersion==5 &amp;&amp; osinfo.dwMinorVersion==0<br />		invoke wsprintf,addr buffer,addr format,addr szWin2k,addr osinfo.szCSDVersion<br />	.ELSEIF osinfo.dwMajorVersion==4 &amp;&amp; osinfo.dwMinorVersion==0<br />		invoke wsprintf,addr buffer,addr format,addr szWinNT,addr osinfo.szCSDVersion<br />	.ELSEIF osinfo.dwMajorVersion==4 &amp;&amp; osinfo.dwMinorVersion==90<br />		invoke wsprintf,addr buffer,addr format,addr szWinME,addr osinfo.szCSDVersion&nbsp; &nbsp; <br />	.ELSEIF osinfo.dwMajorVersion==4 &amp;&amp; osinfo.dwMinorVersion==10<br />		invoke wsprintf,addr buffer,addr format,addr szWin98,addr osinfo.szCSDVersion&nbsp; <br />	.ELSE<br />&nbsp;  		invoke MessageBox,NULL,aDDr szOSUnknown,aDDr AppName,MB_OK<br />&nbsp;  		PUSH 0<br />&nbsp;  		CALL ExitProcess<br />	.ENDIF<br />	&nbsp; &nbsp; &nbsp; &nbsp; <br />	invoke MessageBox,NULL,aDDr buffer,aDDr AppName,MB_OK<br />	PUSH 0<br />&nbsp;  	CALL ExitProcess<br /><br />end start</code></pre><br /><br />There were just to many errors and stuff that didn&#39;t made sense in the code you have provided. So I guess it&#39;ll be pointless to explain each fault. However if you have a specific question regarding something, don&#39;t hesitate to ask. We will be happy to help. </div>
    <div class="meta">Posted on 2006-07-10 20:06:22 by arafel</div>
   </div>
  </div>
 </body>
</html>