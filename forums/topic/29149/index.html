<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>[Solved] Why does LVM_GETITEM cause this to crash - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=29149" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=29149">[Solved] Why does LVM_GETITEM cause this to crash</a></p>
   <div class="post" id="post-205889">
    <div class="subject"><a href="#post-205889">[Solved] Why does LVM_GETITEM cause this to crash</a></div>
    <div class="body">Here is the code. Put the LVM_GETITEM anywhere. Macros follow the first section. Used RadASM for dialog and listview.<br /><br /><pre><code><br />.486<br />.model flat,stdcall<br />option casemap:none<br /><br />include ListView.inc<br /><br />.code<br /><br />start:<br /><br />	invoke GetModuleHandle,NULL<br />	mov&nbsp; &nbsp; hInstance,eax<br />	invoke GetCommandLine<br />	invoke InitCommonControls<br />	invoke WinMain,hInstance,NULL,CommandLine,SW_SHOWDEFAULT<br />	invoke ExitProcess,eax<br /><br />WinMain proc hInst:HINSTANCE,hPrevInst:HINSTANCE,CmdLine:LPSTR,CmdShow:DWORD<br />	LOCAL	wc:WNDCLASSEX<br />	LOCAL	msg:MSG<br /><br />	mov		wc.cbSize,SIZEOF WNDCLASSEX<br />	mov		wc.style,CS_HREDRAW or CS_VREDRAW<br />	mov		wc.lpfnWndProc,OFFSET WndProc<br />	mov		wc.cbClsExtra,NULL<br />	mov		wc.cbWndExtra,DLGWINDOWEXTRA<br />	push	hInst<br />	pop		wc.hInstance<br />	mov		wc.hbrBackground,COLOR_BTNFACE+1<br />	mov		wc.lpszMenuName,OFFSET MenuName<br />	mov		wc.lpszClassName,OFFSET ClassName<br />	invoke LoadIcon,NULL,IDI_APPLICATION<br />	mov		wc.hIcon,eax<br />	mov		wc.hIconSm,eax<br />	invoke LoadCursor,NULL,IDC_ARROW<br />	mov		wc.hCursor,eax<br />	invoke RegisterClassEx,addr wc<br />	invoke CreateDialogParam,hInstance,addr DlgName,NULL,addr WndProc,NULL<br />	invoke ShowWindow,hWnd,SW_SHOWNORMAL<br />	invoke UpdateWindow,hWnd<br />	.while TRUE<br />		invoke GetMessage,addr msg,NULL,0,0<br />	&nbsp; .BREAK .if !eax<br />		invoke TranslateMessage,addr msg<br />		invoke DispatchMessage,addr msg<br />	.endw<br />	mov		eax,msg.wParam<br />	ret<br /><br />WinMain endp<br /><br />WndProc proc hWin:HWND,uMsg:UINT,wParam:WPARAM,lParam:LPARAM<br />	LOCAL rDC:DWORD<br />	LOCAL ps:PAINTSTRUCT<br />	LOCAL rect:RECT<br />	<br />	mov		eax,uMsg<br />	.if eax==WM_INITDIALOG<br />		push	hWin<br />		pop		hWnd<br />		mov hIDC_LSV1,rv(GetDlgItem,hWin,IDC_LSV1)<br />		invoke&nbsp; SendMessage,hIDC_LSV1,LVM_GETNEXTITEM,-1, LVNI_FOCUSED<br />		invoke SendMessage,hIDC_LSV1,LVM_SETEXTENDEDLISTVIEWSTYLE,0,LVS_EX_FULLROWSELECT or LVS_EX_GRIDLINES<br /><br />		InsertColumn 60,&quot;Date&quot;,0			<br />		InsertColumn 60,&quot;Time&quot;,1			<br />		InsertColumn 150,&quot;Purpose&quot;,2		&nbsp; &nbsp; &nbsp; &nbsp; <br />		InsertColumn 150,&quot;Place&quot;,3			<br />		InsertItem 0,0,&quot;New Item0&quot;			<br />		InsertItem 1,0,&quot;New Item1&quot;			<br />		SetItemText 0,1,&quot;New subitem0&quot;		<br />		SetItemText 1,1,&quot;Newer subitem1&quot;	&nbsp; &nbsp; &nbsp; &nbsp; <br />	.elseif eax==WM_PAINT<br />		invoke BeginPaint,hWnd,addr ps<br />		mov rDC,eax<br />		invoke GetClientRect,hWnd,addr rect<br />		RGB 100,100,0<br />		invoke FillRect,rDC,addr rect,rv(CreateSolidBrush,eax)<br />		<br />		ret<br />	.elseif eax==WM_NOTIFY<br /><br />	.elseif eax==WM_COMMAND<br />		mov		eax,wParam<br />		and		eax,0FFFFh<br />		.if eax==IDM_FILE_EXIT<br />			invoke SendMessage,hIDC_LSV1,LVM_GETCOLUMN,1,addr col<br />; Here is the crash point. Move this line anywhere...<br />			invoke SendMessage,hIDC_LSV1,LVM_GETITEM,0,addr pitem<br />			invoke SendMessage,hWin,WM_CLOSE,0,0<br />		.elseif eax==IDM_HELP_ABOUT<br />			invoke ShellAbout,hWin,addr AppName,addr AboutMsg,NULL<br />		.endif<br />	.elseif uMsg==WM_SIZE<br />		mov eax,lParam<br />		mov edx,eax<br />		and eax,0ffffh<br />		sub eax,10			<br />		shr edx,16<br />		sub edx,30			<br />		invoke MoveWindow,hIDC_LSV1, 5, 25, eax,edx,TRUE<br />	.elseif eax==WM_CLOSE<br />		invoke DestroyWindow,hWin<br />	.elseif uMsg==WM_DESTROY<br />		invoke PostQuitMessage,NULL<br />	.else<br />		invoke DefWindowProc,hWin,uMsg,wParam,lParam<br />		ret<br />	.endif<br />	xor&nbsp; &nbsp; eax,eax<br />	ret<br />WndProc endp<br /><br />end start<br /></code></pre><br /><br />Thanks...<br /><pre><code><br />RGB macro red,green,blue<br />&nbsp; &nbsp; &nbsp; &nbsp; xor eax,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; mov ah,blue<br />&nbsp; &nbsp; &nbsp; &nbsp; shl eax,8<br />&nbsp; &nbsp; &nbsp; &nbsp; mov ah,green<br />&nbsp; &nbsp; &nbsp; &nbsp; mov al,red<br />endm<br /><br />InsertColumn MACRO width,colHeader,colPos<br />	LOCAL lbl<br />	LOCAL header<br />	jmp	lbl<br />	header db colHeader,0<br />lbl:<br />	mov	col.imask,LVCF_TEXT or LVCF_WIDTH or LVCF_FMT<br />	mov	col.fmt,LVCFMT_LEFT<br />	mov	col.lx,width<br />	mov	col.pszText,offset header<br />	GetTextLen<br />	invoke	SendMessage,hIDC_LSV1,LVM_INSERTCOLUMN,colPos,addr col<br />ENDM<br /><br />InsertItem MACRO itemNum,subitemNum,itemText<br />	LOCAL lbl<br />	LOCAL itemTxt<br />	jmp	lbl<br />	itemTxt db itemText,0<br />lbl:<br />	mov	pitem.imask,LVIF_TEXT<br />	mov	pitem.iItem,itemNum<br />	mov	pitem.iSubItem,subitemNum<br />	mov	pitem.pszText,offset itemTxt<br />	GetTextLen<br />	invoke	SendMessage,hIDC_LSV1,LVM_INSERTITEM,0,addr pitem	<br />ENDM<br /><br />SetItemText MACRO itemNum,subitemNum,itemText<br />	LOCAL lbl<br />	LOCAL itemTxt<br />	jmp	lbl<br />	itemTxt db itemText,0<br />lbl:<br />	mov	pitem.imask,LVIF_TEXT<br />	mov	pitem.iItem,itemNum<br />	mov	pitem.iSubItem,subitemNum<br />	mov	pitem.pszText,offset itemTxt<br />	GetTextLen<br />	invoke	SendMessage,hIDC_LSV1,LVM_SETITEMTEXT,itemNum,addr pitem<br />ENDM<br /><br />GetTextLen Macro<br />	invoke	lstrlen,pitem.pszText<br />	mov	pitem.cchTextMax,eax<br />ENDM<br /></code></pre></div>
    <div class="meta">Posted on 2008-09-09 06:31:42 by green</div>
   </div>
   <div class="post" id="post-205890">
    <div class="subject"><a href="#post-205890">Re: Why does LVM_GETITEM cause this to crash</a></div>
    <div class="body">where is pitem defined? is your pitem a ptr to a LV_ITEM struct, or is it the struct itself? <br />usually the &#039;p&#039; prefix indicates that the variable concerned is a Pointer - not a Struct.<br />I am guessing you are passing the address of the pointer to the struct, ie, a pointer to a pointer.<br />I&#039;d have to see the rest of the code, but I assure you the problem is not LVM_GETITEM.</div>
    <div class="meta">Posted on 2008-09-09 07:47:53 by Homer</div>
   </div>
   <div class="post" id="post-205891">
    <div class="subject"><a href="#post-205891">Re: Why does LVM_GETITEM cause this to crash</a></div>
    <div class="body">Thanks for your interest Homer and here is the rest from the .inc.<br /><br /><pre><code><br />col 				LVCOLUMN	&lt;&gt;<br />pitem 			LVITEM	&lt;&gt;<br /></code></pre><br /><br />This is what Windows API states:<br /><pre><code><br />lResult = SendMessage(&nbsp; &nbsp; &nbsp; // returns LRESULT in lResult&nbsp; &nbsp;  <br />(HWND) hWndControl,&nbsp; &nbsp; &nbsp; // handle to destination control&nbsp; &nbsp;  <br />(UINT) LVM_GETITEM,&nbsp; &nbsp; &nbsp; // message ID&nbsp; &nbsp;  <br />(WPARAM) wParam,&nbsp; &nbsp; &nbsp; // = 0; not used, must be zero&nbsp; &nbsp; <br />(LPARAM) lParam&nbsp; &nbsp; &nbsp; // = (LPARAM) (LPLVITEM) pitem; <br />); <br /><br />Parameters<br /><br />wParam <br />&nbsp; &nbsp; &nbsp;  Must be zero.<br /><br />pitem <br />&nbsp; &nbsp; &nbsp; Pointer to an LVITEM structure that specifies the information to retrieve and receives information about the list-view item. <br /><br />Return Value<br />&nbsp; &nbsp; &nbsp; Returns TRUE if successful, or FALSE otherwise.<br /><br /></code></pre><br /><br />&#039;addr pitem&#039; is the pointer to the struct as I understand it. Remove LVM_GETITEM and the code runs fine.</div>
    <div class="meta">Posted on 2008-09-09 08:59:32 by green</div>
   </div>
   <div class="post" id="post-205893">
    <div class="subject"><a href="#post-205893">Re: Why does LVM_GETITEM cause this to crash</a></div>
    <div class="body">Looking at some code i have for using a listview i dont use that LVM_GETITEM directly, but use other LV_ messages to retrieve information<br /><br />Such as getting the currently selected row:<br /><pre><code>;**************************************************************************	<br />; Get Index of Currently Selected Item in Listview<br />;**************************************************************************	<br />ListViewGetSelection	PROC hWin:DWORD<br />	Invoke SendMessage, hListview,LVM_GETNEXTITEM, -1, LVNI_FOCUSED<br />	ret<br />ListViewGetSelection endp</code></pre><br /><br />Getting text from a list item or sub item:<br /><pre><code>;**************************************************************************<br />; Gets the text of the specified index. Stored in LVItemText on return<br />;**************************************************************************<br />ListViewGetItemText		PROC hWin:DWORD, nItem:DWORD, nSubItem:DWORD<br />	mov eax, nSubItem<br />	mov LVItem.iSubItem, eax<br />	invoke SendMessage, hListview, LVM_GETITEMTEXT, nItem, Addr LVItem<br />	ret<br />ListViewGetItemText endp</code></pre><br /><br />In my data section i have:<br /><pre><code>.DATA<br />LVItemText			db MAX_PATH dup (0) ; Buffer to hold text to display when used with LVItem<br />LVItem				LV_ITEM &lt;LVIF_TEXT,1,0,LVIS_FOCUSED,0,LVItemText,MAX_PATH,0,0&gt;<br />.DATA?<br />hListview			dd ?	 	; Listview handle</code></pre><br /><br />but im thinking you need to specify in your LVItem variable before hand to tell the message what you are looking to retrieve, so that you will need to set the item index, and mask of the item type to retrieve.<br /><br /><div class="quote">When the message is sent, the iItem and iSubItem members identify the item or subitem to retrieve information about and the mask member specifies which attributes to retrieve. <br /><br />If the mask member specifies the LVIF_TEXT value, the pszText member must contain the pointer to the buffer that receives the item text and the cchTextMax member must specify the size of the buffer.<br /><br />If the mask member specifies the LVIF_STATE value, the stateMask member specifies which item states are to be returned.</div><br /><br /><br />Not sure if that will help you, ive a few more procs for using listviews if you want.</div>
    <div class="meta">Posted on 2008-09-09 14:16:21 by keithsrobertson</div>
   </div>
   <div class="post" id="post-205894">
    <div class="subject"><a href="#post-205894">Re: Why does LVM_GETITEM cause this to crash</a></div>
    <div class="body">Hi keithsrobertson, you have evidently got it right. I did some more research after your message and finally came up with this and it did not crash:<br /><pre><code><br />mov pitem.iItem,1<br />mov pitem.iSubItem,1<br />mov pitem.imask, LVIF_TEXT<br />lea eax, szBuff<br />mov pitem.pszText, eax<br />mov pitem.cchTextMax, 256<br />invoke SendMessage,hIDC_LSV1,LVM_GETITEM,0,addr pitem<br /></code></pre><br /><br />What I have been trying to do is get the current column when it is being resized so that I can save it as a setting and LVM_GETITEM not going to work. Do you have an answer??<br /><br />Thanks again...</div>
    <div class="meta">Posted on 2008-09-09 14:48:23 by green</div>
   </div>
   <div class="post" id="post-205895">
    <div class="subject"><a href="#post-205895">Re: Why does LVM_GETITEM cause this to crash</a></div>
    <div class="body">Ive had a look at the list of notification messages passed back to the main window from a listview and cant see an exact one that would allow you to monitor the column resize directly.<br /><br />Might be better to use the LVM_GETCOLUMNWIDTH message to retrieve the column widths and save them when the user exits the program instead.</div>
    <div class="meta">Posted on 2008-09-09 16:29:50 by keithsrobertson</div>
   </div>
   <div class="post" id="post-205896">
    <div class="subject"><a href="#post-205896">[Solved] Why does LVM_GETITEM cause this to crash</a></div>
    <div class="body">Thanks keithsrobertson, I guess we will consider this one as solved at this point. Thanks again.</div>
    <div class="meta">Posted on 2008-09-09 18:04:31 by green</div>
   </div>
   <div class="post" id="post-205899">
    <div class="subject"><a href="#post-205899">Re: [Solved] Why does LVM_GETITEM cause this to crash</a></div>
    <div class="body">is the pitem structure defined in the DATA segment or in with the CODE? because writing to that address would cause a GPF due to default page permission for CODE segments.</div>
    <div class="meta">Posted on 2008-09-10 08:57:58 by Homer</div>
   </div>
   <div class="post" id="post-205900">
    <div class="subject"><a href="#post-205900">Re: [Solved] Why does LVM_GETITEM cause this to crash</a></div>
    <div class="body">Hello Homer, it is defined in &#039;data?&#039;. I tried what keithsrobertson said and it worked.</div>
    <div class="meta">Posted on 2008-09-10 16:29:17 by green</div>
   </div>
   <div class="post" id="post-205901">
    <div class="subject"><a href="#post-205901">Re: [Solved] Why does LVM_GETITEM cause this to crash</a></div>
    <div class="body">It looks like you&#039;re using pitem for every item you add. I think the trouble is that the last time you used it<br />you left imask=LVIF_TEXT and pszText as the address of a string - which your macro puts in the code section.<br />When you try to use LVM_GETITEM it uses imask which tells it that pszText points to a buffer in .code -&gt; access violation.<br /><br />An interesting bit from the sdk<br /><div class="quote">Applications should not assume that the text will necessarily be placed in the specified buffer. The control may instead change the pszText member of the structure to point to the new text, rather than place it in the buffer.</div><br />WTF???</div>
    <div class="meta">Posted on 2008-09-10 21:54:50 by sinsi</div>
   </div>
   <div class="post" id="post-205902">
    <div class="subject"><a href="#post-205902">Re: [Solved] Why does LVM_GETITEM cause this to crash</a></div>
    <div class="body">Well think about it - handing the user a pointer to the internal string buffer avoids the need to copy the string into the buffer that the user supplied - if we just grab the pszText pointer after the call, its always going to be valid - even if its not the pointer that we supplied.<br /></div>
    <div class="meta">Posted on 2008-09-11 02:04:04 by Homer</div>
   </div>
   <div class="post" id="post-205904">
    <div class="subject"><a href="#post-205904">Re: [Solved] Why does LVM_GETITEM cause this to crash</a></div>
    <div class="body">My usual way of using a buffer is<br /><pre><code><br />.data?<br />buffer db 260 dup (?)<br />.code<br />...<br /> &nbsp;mov pitem.pszText,offset buffer<br /> &nbsp;invoke SendMessage,hIDC_LSV1,LVM_GETITEM,0,offset pitem<br /> &nbsp;;here I would use<br /> &nbsp;invoke lstrlen,offset buffer<br /> &nbsp;;rather than<br /> &nbsp;invoke lstrlen,pitem.pszText<br /></code></pre><br />If the pointer gets changed, who owns the memory it points to?</div>
    <div class="meta">Posted on 2008-09-11 03:24:53 by sinsi</div>
   </div>
  </div>
 </body>
</html>