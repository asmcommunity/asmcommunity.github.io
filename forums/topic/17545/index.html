<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Why did I fail to enum workgroups? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=17545" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=17545">Why did I fail to enum workgroups?</a></p>
   <div class="post" id="post-135753">
    <div class="subject"><a href="#post-135753">Why did I fail to enum workgroups?</a></div>
    <div class="body">Why did I fail to enum workgroups? <br />I want to enum workgroups in LAN by calling Windows API  WNetOpenEnum() and WNetEnumResource() under MASM V8. <br />But the result differed from the real.<br />This program is consulted MSDN demonstrates program.<br /><br />I need your helps.<br /><br />Thanks<br /><pre><code><br />; &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;<br />; FileName&#58; GrpList.asm<br />; Function&#58; Call SendMessageBufferSend&#40;&#41; to list all group in LAN<br />;   Author&#58; Purple Endurer<br />;  Develop&#58; MASM32 V8<br />&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;<br />.386<br />.model flat, stdcall<br />option casemap &#58;none<br /><br />include /masm32/include/windows.inc<br /><br />include /masm32/include/mpr.inc<br />include /masm32/include/user32.inc<br />include /masm32/include/kernel32.inc<br />include /masm32/include/comctl32.inc<br /><br />includelib /masm32/lib/mpr.lib<br />includelib /masm32/lib/user32.lib<br />includelib /masm32/lib/kernel32.lib<br />includelib /masm32/lib/comctl32.lib<br /><br />IDC_gbSTATE     EQU     3000<br /><br />   WinMain PROTO &#58;HINSTANCE, &#58;HINSTANCE, &#58;LPSTR, &#58;DWORD<br />   DlgProc PROTO &#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD<br />   lvResInstertColumn PROTO<br />   AddResLine PROTO &#58;DWORD, &#58;DWORD<br /><br />.const<br />    conShowDbgMsg   equ 0<br />    conRES_BUFF_LEN equ 16384<br />    con_lvResID equ 10000<br /><br />.data <br />    szDlgName db &quot;DlgGrpList&quot;,0<br />    szAppName db &quot;Workgroup List&quot;, 0<br /><br />    szLVClassName db &quot;SysListView32&quot;, 0<br />    szCreateListBoxFail db     &quot;Fail to Create ListBox!&quot;, 0<br />    szlvResHeading1 db &quot;Remote Name&quot;, 0<br />    szlvResHeading2 db &quot;Local Name&quot;, 0<br />    szlvResHeading3 db &quot;comment&quot;, 0<br /><br /><br />    g_cCount    DWORD   -1<br />    g_cbBuff    DWORD   conRES_BUFF_LEN<br />    <br />    szERROR_NOT_CONTAINER       db &quot;ERROR_NOT_CONTAINER&quot;, 0<br />    szERROR_INVALID_PARAMETER   db &quot;ERROR_INVALID_PARAMETER&quot;, 0<br /><br />    szERROR_NO_MORE_ITEMS       db &quot;There are no more entries. The buffer contents are undefined.&quot;, 0<br />    szERROR_MORE_DATA           db &quot;More entries are available with subsequent calls.&quot;, 0<br />    szERROR_INVALID_HANDLE      db &quot;The handle specified by the hEnum parameter is not valid.&quot;, 0<br />    szERROR_NO_NETWORK          db &quot;The network is unavailable.&quot;, 0<br />    szERROR_EXTENDED_ERROR      db &quot;A network-specific error occurred!&quot;, 0<br /><br />    g_szFmt   db &quot;Find %d resurces!&quot;, 0<br /><br />.data?<br />    g_hInstance     dd      ?<br />    g_hDlg          dd      ?<br /><br />    g_hlvRes        HANDLE  ?<br /><br />    g_hResEnum      HANDLE  ?<br />    g_nrLocal       DWORD   conRES_BUFF_LEN  dup &#40;?&#41;<br /><br />    g_szBuff        db      256 dup &#40;?&#41;<br /><br />.code<br /><br />start&#58;<br />    invoke GetModuleHandle, NULL<br />    mov g_hInstance, eax<br /><br />    invoke DialogBoxParam, g_hInstance, offset szDlgName, NULL, offset DlgProc, NULL<br /><br />    invoke ExitProcess, 0<br />    invoke InitCommonControls<br /><br /><br />DlgProc proc hDlg&#58; DWORD, uMsg&#58; DWORD, wParam&#58; DWORD, lParam&#58; DWORD<br /><br />    .if uMsg == WM_INITDIALOG<br />      ;-- --------------------------------<br />      ; Create List Box<br />      ;----------------------------------<br /><br />        invoke CreateWindowEx, WS_EX_CLIENTEDGE, offset szLVClassName, NULL,\<br />          LVS_REPORT + WS_CHILD + WS_VISIBLE + WS_EX_WINDOWEDGE + WS_TABSTOP,\<br />          2, 15, 310, 150, hDlg, con_lvResID, g_hInstance, NULL<br /><br />        .IF eax == NULL<br />            invoke MessageBox, hDlg, offset szCreateListBoxFail, offset szAppName, MB_OK + MB_ICONSTOP<br />            invoke EndDialog, hDlg, NULL<br />            ret<br />        .ENDIF<br />       <br />        mov    g_hlvRes, eax<br /><br /><br />      ;----------------------------------<br />      ; Set List Box's column caption<br />      ;----------------------------------<br /><br />        invoke lvResInstertColumn<br /><br />      ;----------------------------------<br />      ; Get the handle is need to enum resource<br />      ;----------------------------------<br /><br />         ;         DWORD WNetOpenEnum&#40;<br />         ;           DWORD dwScope,<br />         ;           DWORD dwType,<br />         ;           DWORD dwUsage,<br />         ;           LPNETRESOURCE lpNetResource,<br />         ;           LPHANDLE lphEnum<br />         ;         &#41;;<br /><br />        invoke  WNetOpenEnum, RESOURCE_GLOBALNET, RESOURCETYPE_DISK, RESOURCEUSAGE_CONTAINER,\<br />                NULL, offset g_hResEnum<br /><br />      ;----------------------------------<br />      ; fail and handle<br />      ;----------------------------------<br /><br />        .IF EAX != NO_ERROR<br />            .if eax == ERROR_NOT_CONTAINER<br />                ;The lpNetResource parameter does not point to a container.<br />                mov esi, offset szERROR_NOT_CONTAINER<br />                <br />            .elseif eax == ERROR_INVALID_PARAMETER<br />                ;Either the dwScope or the dwType parameter is invalid,<br />                ;or there is an invalid combination of parameters.<br />                mov esi, offset szERROR_INVALID_PARAMETER<br /><br />            .elseif eax == ERROR_NO_NETWORK<br />                ;The network is unavailable. <br />                mov esi, offset szERROR_NO_NETWORK<br /><br />            .elseif eax == ERROR_EXTENDED_ERROR<br />                ;A network-specific error occurred. To obtain a description of the error,<br />                ;call the WNetGetLastError function.<br />                mov esi, offset szERROR_EXTENDED_ERROR<br />            .endif<br />            invoke MessageBox, hDlg, esi, offset szAppName, MB_OK + MB_ICONSTOP<br />            invoke EndDialog, hDlg, NULL<br />            ret<br />        .ENDIF<br /><br /><br />      ;----------------------------------<br />      ; succeed! begin to enum resource<br />      ;----------------------------------<br /><br /><br /> .WHILE TRUE<br />            invoke RtlZeroMemory, offset g_nrLocal, sizeof g_nrLocal<br /><br />             ;         DWORD WNetEnumResource&#40;<br />             ;           HANDLE hEnum,<br />             ;           LPDWORD lpcCount,<br />             ;           LPVOID lpBuffer,<br />             ;           LPDWORD lpBufferSize<br />             ;         &#41;;<br /><br /><br />            invoke WNetEnumResource, g_hResEnum, offset g_cCount, offset g_nrLocal, offset g_cbBuff<br /><br />            .if eax == NO_ERROR<br /><br />		;----------------------------------<br />		; Find the resource<br />		;----------------------------------<br /><br />		;----------------------------------<br />		;Display the resource number<br />		;----------------------------------<br />		pushad<br />		invoke wsprintf, offset g_szBuff, offset g_szFmt, g_cCount<br />		invoke MessageBox, hDlg, offset g_szBuff, offset szAppName, MB_OK<br />		popad<br /><br />		;----------------------------------<br />	        ; Get the information of found resource<br />		;----------------------------------<br /><br />                push edx<br />                mov  edx, offset g_nrLocal                <br />                ;assume edx&#58; ptr NETRESOURCE<br /><br />                 mov eax, g_cCount<br />                .WHILE &#40;eax&#41;<br />                    push eax<br />                    push edx<br />                    invoke AddResLine, eax, edx<br />                    pop  edx<br />                    ;inc  edx<br />                    add edx, sizeof NETRESOURCE<br />                    pop  eax<br />                    dec  eax<br />                .ENDW<br />                pop edx<br />                ;assume edx&#58;ptr nothing<br /><br />            .else<br /><br /><br />		;----------------------------------<br />                ; No find resource<br />                ; ----------------------------------<br /><br />                .IF eax == ERROR_NO_MORE_ITEMS<br />                    ;There are no more entries. The buffer contents are undefined<br />                    mov edx, offset szERROR_NO_MORE_ITEMS<br />                .ELSEIF eax == ERROR_MORE_DATA<br />                    ;More entries are available with subsequent calls.<br />                    mov edx, offset szERROR_MORE_DATA<br />                .ELSEIF eax == ERROR_INVALID_HANDLE<br />                    ;The handle specified by the hEnum parameter is not valid.<br />                    mov edx, offset szERROR_INVALID_HANDLE<br />                .ELSEIF eax == ERROR_NO_NETWORK<br />                    ;The network is unavailable.<br />                    ;&#40;This condition is tested before hEnum is tested for validity.&#41;<br />                    mov edx, offset szERROR_NO_NETWORK<br />                .ELSEIF eax == ERROR_EXTENDED_ERROR<br />                    ;A network-specific error occurred. <br />                    ;To obtain a description of the error, call the WNetGetLastError function. <br />                    mov edx, offset szERROR_EXTENDED_ERROR<br />                .ENDIF<br /><br />                invoke MessageBox, hDlg, edx, offset szAppName, MB_OK + MB_ICONSTOP<br />                .break<br />            .endif            <br />        .ENDW<br /><br />    .elseif uMsg == WM_CLOSE<br />  ;         DWORD WNetCloseEnum&#40;<br />  ;           HANDLE hEnum<br />  ;         &#41;;<br />            invoke WNetCloseEnum, g_hResEnum<br /><br />            invoke EndDialog, hDlg, 0  <br />            ret<br />    .endif<br /><br />    xor eax,eax<br />    ret<br />DlgProc endp<br /><br /><br />;================================<br />; Set List Box's column caption<br />;================================<br /><br />lvResInstertColumn proc<br /> LOCAL lvc&#58; LV_COLUMN<br /><br /> mov lvc.imask, LVCF_TEXT + LVCF_WIDTH<br /> mov lvc.pszText, offset szlvResHeading1<br /> mov lvc.lx, 150<br /> invoke SendMessage, g_hlvRes, LVM_INSERTCOLUMN, 0, addr lvc<br /><br /> or lvc.imask, LVCF_FMT<br /> mov lvc.fmt, LVCFMT_CENTER<br /> mov lvc.pszText, offset szlvResHeading2<br /> mov lvc.lx, 80<br /> invoke SendMessage, g_hlvRes, LVM_INSERTCOLUMN, 1, addr lvc<br /><br /> mov lvc.pszText, offset szlvResHeading3<br /> invoke SendMessage, g_hlvRes, LVM_INSERTCOLUMN, 2, addr lvc<br /><br /> ret  <br />lvResInstertColumn endp<br /><br /><br />;===========================================<br />;Add the information of resource to  LISTBOX<br />;===========================================<br />AddResLine proc uses edi row&#58; DWORD, lpNetRes&#58; DWORD<br /> LOCAL lvi&#58; LV_ITEM<br /> LOCAL buffer&#91;20&#93;&#58; BYTE<br /> <br /> ;                 typedef struct _NETRESOURCE &#123;<br /> ;                   DWORD dwScope;<br /> ;                   DWORD dwType;<br /> ;                   DWORD dwDisplayType;<br /> ;                   DWORD dwUsage;<br /> ;                   LPTSTR lpLocalName;<br /> ;                   LPTSTR lpRemoteName;<br /> ;                   LPTSTR lpComment;<br /> ;                   LPTSTR lpProvider;<br /> ;                 &#125; NETRESOURCE;<br /><br /> mov edi, lpNetRes<br /> assume edi&#58; ptr NETRESOURCE<br /><br /> mov lvi.imask, LVIF_TEXT<br /> push row<br /> pop lvi.iItem <br /> mov lvi.iSubItem, 0<br /> ;lea eax, &#91;edi&#93;.lpRemoteName<br />       mov eax, &#91;edi&#93;.lpRemoteName <br /> mov lvi.pszText, eax<br /> invoke SendMessage, g_hlvRes, LVM_INSERTITEM, 0, addr lvi<br /><br /> mov lvi.imask, LVIF_TEXT<br /> inc lvi.iSubItem<br /> ;lea eax, &#91;edi&#93;.lpLocalName<br />       mov eax, &#91;edi&#93;.lpLocalName<br /> mov lvi.pszText, eax<br /> invoke SendMessage, g_hlvRes, LVM_SETITEM, 0, addr lvi<br /><br /> inc lvi.iSubItem<br /> ;lea eax, &#91;edi&#93;.lpComment<br />       mov eax, &#91;edi&#93;.lpComment<br /> mov lvi.pszText, eax<br /> invoke SendMessage, g_hlvRes, LVM_SETITEM, 1, addr lvi<br /><br /> assume edi&#58; nothing<br /> ret<br />AddResLine endp<br /><br />end start<br /><br /><br /><br /><br /><br /><br />; &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;<br />; rsrc.rc<br />; &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;<br /><br /><br />#include &quot;\masm32\include\resource.h&quot;<br /><br />DlgGrpList DIALOG DISCARDABLE  0, 0, 253, 120<br />STYLE DS_CENTER | WS_VISIBLE | WS_CAPTION | WS_SYSMENU | DS_3DLOOK | WS_EX_TOOLWINDOW<br />CAPTION &quot;Workgroup list&quot;<br />&#123;<br />&#125;</code></pre></div>
    <div class="meta">Posted on 2004-03-13 04:23:29 by purpleendurer</div>
   </div>
   <div class="post" id="post-135774">
    <div class="subject"><a href="#post-135774">Why did I fail to enum workgroups?</a></div>
    <div class="body"><strong>purpleendurer</strong>,<br /><br />1. Don't post in multiple forums<br />2. Use <pre><code> tags around your code next time<br />3. What have you tried yourself? Where does it go wrong? Have you debugged your program? Please try some things yourself and explain what you've tried instead of just posting a lot of code.<br /><br />Thomas</div>
    <div class="meta">Posted on 2004-03-13 08:00:10 by Thomas</div>
   </div>
   <div class="post" id="post-135790">
    <div class="subject"><a href="#post-135790">Why did I fail to enum workgroups?</a></div>
    <div class="body">To Thomas:<br /><br />Sorry, I am a freshman!<br /><br /><br />This program can only find &quot;Microsoft Windows Network&quot;  running under Windows 98 and Windows 2000 professional, but there are 3 workgroups in the LAN.<br /><br />I tracked this program with OllDbg, but find nothing...</div>
    <div class="meta">Posted on 2004-03-13 09:31:04 by purpleendurer</div>
   </div>
   <div class="post" id="post-135894">
    <div class="subject"><a href="#post-135894">Why did I fail to enum workgroups?</a></div>
    <div class="body">purpleendurer, your workgroups are subnodes of the &quot;Microsoft Windows Network&quot; node. If the NETRESOURCE indicates a RESOURCEUSAGE_CONTAINER, you just have to WNetOpenEnum() it and iterate through its WNetEnumResource() results.</div>
    <div class="meta">Posted on 2004-03-14 11:06:00 by Morris</div>
   </div>
   <div class="post" id="post-136097">
    <div class="subject"><a href="#post-136097">Why did I fail to enum workgroups?</a></div>
    <div class="body">To Morris:<br /><br />Thanks.<br /><br />I will test according to your way.</div>
    <div class="meta">Posted on 2004-03-16 08:43:21 by purpleendurer</div>
   </div>
   <div class="post" id="post-136346">
    <div class="subject"><a href="#post-136346">Why did I fail to enum workgroups?</a></div>
    <div class="body">I has sovlved the question!<br /><br />Thanks all.<br /><br /><br />Here is the code:<br /><br /><pre><code><br />; &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;<br />; FileName&#58; GrpList.asm<br />; Function&#58; Call WNetOpenEnum&#40;&#41; and WNetEnumResource&#40;&#41;<br />;                  to enum all groups in LAN<br />;    Author&#58; Purple Endurer<br />;   Develop&#58; MASM32 V8<br />; 2004-03-19<br />;   Replaced ListBox with TreeView<br />; 2004-03-18<br />;   OK!   <br />; 2004-03-10<br />;   Created!<br />; &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;<br /><br />.386<br />.model flat, stdcall<br />option casemap&#58; none<br /><br />include /masm32/include/windows.inc<br /><br />include /masm32/include/mpr.inc<br />include /masm32/include/gdi32.inc<br />include /masm32/include/user32.inc<br />include /masm32/include/comctl32.inc<br />include /masm32/include/kernel32.inc<br /><br />includelib /masm32/lib/mpr.lib<br />includelib /masm32/lib/gdi32.lib<br />includelib /masm32/lib/user32.lib<br />includelib /masm32/lib/comctl32.lib<br />includelib /masm32/lib/kernel32.lib<br /><br /><br />WinMain PROTO &#58;DWORD, &#58;DWORD, &#58;DWORD, &#58;DWORD<br />GetEnumHandle PROTO &#58;DWORD, &#58;DWORD, &#58;DWORD, &#58;DWORD, &#58;DWORD<br />EnumNetResource PROTO &#58;DWORD, &#58;DWORD, &#58;HANDLE, &#58;HANDLE<br /><br /><br />.const<br />IDB_TREE	equ 4006<br />conRES_BUFF_LEN equ 16384<br /><br /><br />.data<br />g_szClassName 	db &quot;GrpListWinCls&quot;, 0<br />g_szAppName		db &quot;WorkGroup List&quot;, 0<br /><br />g_szTreeViewClass	db &quot;SysTreeView32&quot;, 0<br />szCreateTreeViewFail db  &quot;Fail to create TreeView!&quot;, 0<br /><br />g_cCount    DWORD   -1<br />g_cbBuff    DWORD   conRES_BUFF_LEN<br /><br />g_szWNetOpenEnum     db &quot;WNetOpenEnum&quot;, 0<br />g_szWNetEnumResource db &quot;WNetEnumResource&quot;, 0<br />szERROR_NOT_CONTAINER       db &quot;ERROR_NOT_CONTAINER&quot;, 0<br />szERROR_INVALID_PARAMETER   db &quot;ERROR_INVALID_PARAMETER&quot;, 0<br /><br />szERROR_NO_MORE_ITEMS       db &quot;There are no more entries. The buffer contents are undefined.&quot;, 0<br />szERROR_MORE_DATA           db &quot;More entries are available with subsequent calls.&quot;, 0<br />szERROR_INVALID_HANDLE      db &quot;The handle specified by the hEnum parameter is not valid.&quot;, 0<br />szERROR_NO_NETWORK          db &quot;The network is unavailable.&quot;, 0<br />szERROR_EXTENDED_ERROR      db &quot;A network-specific error occurred!&quot;, 0<br /><br />g_szFmt   db &quot;Find&#58; %d&quot;, 0<br /><br /><br />.data?<br />hInstance       HINSTANCE ?<br />g_hWnd          HANDLE ?<br />g_hTreeView     HANDLE ?<br />g_hTreeRoot     HANDLE ?<br />g_hImageList    HANDLE ?<br /><br />g_hResEnum      HANDLE  ?<br />g_nrLocal       db      conRES_BUFF_LEN  dup &#40;?&#41;<br />g_nrLocal1      db      conRES_BUFF_LEN  dup &#40;?&#41;<br /><br />g_szBuff        db      256 dup &#40;?&#41;<br /><br /><br />.code<br />start&#58;<br />	invoke GetModuleHandle, NULL<br />	mov    hInstance, eax<br />	invoke WinMain, hInstance, NULL, NULL, SW_SHOWDEFAULT<br />	invoke ExitProcess, eax<br />	invoke InitCommonControls<br /><br />WinMain proc hInst&#58;HINSTANCE, hPrevInst&#58;HINSTANCE, CmdLine&#58;LPSTR, CmdShow&#58;DWORD<br />	LOCAL wc&#58;WNDCLASSEX<br />	LOCAL msg&#58;MSG<br />	LOCAL hwnd&#58;HWND<br /><br />	mov   wc.cbSize, SIZEOF WNDCLASSEX<br />	mov   wc.style, CS_HREDRAW or CS_VREDRAW<br />	mov   wc.lpfnWndProc, OFFSET WndProc<br />	mov   wc.cbClsExtra, NULL<br />	mov   wc.cbWndExtra, NULL<br />	push  hInst<br />	pop   wc.hInstance<br />	mov   wc.hbrBackground, COLOR_APPWORKSPACE<br />	mov   wc.lpszMenuName, NULL<br />	mov   wc.lpszClassName, OFFSET g_szClassName<br />	invoke LoadIcon, NULL, IDI_APPLICATION<br />	mov   wc.hIcon, eax<br />	mov   wc.hIconSm, eax<br />	invoke LoadCursor, NULL, IDC_ARROW<br />	mov   wc.hCursor, eax<br />	invoke RegisterClassEx, addr wc<br />	invoke CreateWindowEx, WS_EX_CLIENTEDGE, ADDR g_szClassName, ADDR g_szAppName,\<br />           WS_OVERLAPPED+WS_CAPTION+WS_SYSMENU+WS_MINIMIZEBOX+WS_MAXIMIZEBOX+WS_VISIBLE,\<br />           CW_USEDEFAULT, CW_USEDEFAULT, 200, 400, NULL, NULL, hInst, NULL<br />	mov   hwnd, eax<br />	.while TRUE<br />		invoke GetMessage, ADDR msg, NULL, 0, 0<br />		.BREAK .IF &#40;!eax&#41;<br />		invoke TranslateMessage, ADDR msg<br />		invoke DispatchMessage, ADDR msg<br />	.endw<br />	mov eax, msg.wParam<br />	ret<br />WinMain endp<br /><br /><br />WndProc proc uses edi hWnd&#58;HWND, uMsg&#58;UINT, wParam&#58;WPARAM, lParam&#58;LPARAM<br />	LOCAL hBitmap&#58; DWORD<br /><br />	.if uMsg==WM_CREATE<br />            push hWnd<br />            pop  g_hWnd<br /><br />            ;----------------<br />            ;Create TrewView<br />            ;----------------<br />            invoke CreateWindowEx, NULL, ADDR g_szTreeViewClass, NULL,\<br />                WS_CHILD+WS_VISIBLE+TVS_HASLINES+TVS_HASBUTTONS+TVS_LINESATROOT, 0,\<br />                0, 200, 400, hWnd, NULL, hInstance, NULL<br /><br />            .IF eax == NULL<br />                invoke MessageBox, hWnd, offset szCreateTreeViewFail, offset g_szAppName, MB_OK + MB_ICONSTOP<br />                invoke PostMessage, hWnd, WM_CLOSE, 0, 0<br />                ret<br />            .ENDIF<br /><br />            mov g_hTreeView, eax<br /><br />            ;----------------<br />            ;Create ImageList<br />            ;----------------<br />            invoke ImageList_Create, 16, 16, ILC_COLOR16, 2, 10<br />            mov g_hImageList, eax<br />            invoke LoadBitmap, hInstance, IDB_TREE<br />            mov hBitmap, eax<br />            invoke ImageList_Add, g_hImageList, hBitmap, NULL<br />            invoke DeleteObject, hBitmap<br /><br />            ;----------------------------------<br />            ;Set ImageList relation to TreeView<br />            ;----------------------------------<br />            invoke SendMessage, g_hTreeView, TVM_SETIMAGELIST, 0, g_hImageList<br /><br />            ;----------------------------------<br />            ;Enum the root of the network<br />            ;----------------------------------<br />            invoke GetEnumHandle, RESOURCE_GLOBALNET, RESOURCETYPE_DISK, RESOURCEUSAGE_CONTAINER,\<br />                     NULL, offset g_hResEnum<br />            .IF &#40;eax == 1&#41;<br />                invoke PostMessage, hWnd, WM_CLOSE, 0, 0<br />                ret<br />            .ENDIF<br />        <br />            invoke EnumNetResource, g_hResEnum, offset g_nrLocal, NULL, TVI_ROOT<br /><br />            ;----------------------------------<br />            ;Get the handle of root of TreeView<br />            ;----------------------------------<br />            invoke SendMessage, g_hTreeView, TVM_GETNEXTITEM, TVGN_ROOT, 0<br />            mov g_hTreeRoot, eax<br /><br />            ;----------------------------------<br />            ;Enum the group of the network<br />            ;----------------------------------<br />&#91;color=red&#93;<br />            ;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<br />            ;These two instructions below are essential <br />            ;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<br />            mov dword ptr g_cCount, -1<br />            mov dword ptr g_cbBuff, conRES_BUFF_LEN<br />&#91;/color&#93;<br />            invoke GetEnumHandle, RESOURCE_GLOBALNET, RESOURCETYPE_DISK, RESOURCEUSAGE_CONTAINER,\<br />                    offset g_nrLocal, offset g_hResEnum<br />            .IF &#40;eax == 1&#41;<br />                invoke PostMessage, hWnd, WM_CLOSE, 0, 0<br />                ret<br />            .ENDIF<br /><br />            invoke EnumNetResource, g_hResEnum, offset g_nrLocal1, g_hTreeRoot, TVI_LAST<br /><br />	.elseif uMsg==WM_DESTROY<br />            invoke PostQuitMessage, NULL<br /><br />	.else<br />            invoke DefWindowProc, hWnd, uMsg, wParam, lParam		<br />            ret<br />	.endif<br />	xor eax, eax<br />	ret<br />WndProc endp<br /><br /><br />;//////////////////////////////////////////////////////////////////////////////////////////////////////<br />;Function&#58; Get the handle to enum net resource<br />;   Input&#58; dwNetResScope - Scope of the enumeration<br />;          dwResType     - Resource types to be enumerated<br />;          dwNetResUsage - Resource usage type to be enumerated<br />;          lpNetRes      - Pointer to a NETRESOURCE structure that specifies the container to enumerate.   <br />;          lphResEnum    - pointer to the handle that identifies an enumeration instance<br />;  Output&#58; If succeeds, return 0, and lphResEnum  pointer to the handle to enum net resource<br />;          else return 1<br />;////////////////////////////////////////////////////////////////////////////////////////////////////////<br />GetEnumHandle proc dwResScope&#58; DWORD, dwResType&#58; DWORD,\<br />                   dwResUsage&#58; DWORD, lpNetRes&#58; DWORD, lphResEnum&#58; DWORD<br />        <br />         ;         DWORD WNetOpenEnum&#40;<br />         ;           DWORD dwScope, <br />         ;           DWORD dwType, <br />         ;           DWORD dwUsage, <br />         ;           LPNETRESOURCE lpNetResource, <br />         ;           LPHANDLE lphEnum<br />         ;         &#41;;<br /><br />        invoke  WNetOpenEnum, dwResScope, dwResType, dwResUsage,\<br />                lpNetRes, lphResEnum<br /><br />        .IF EAX != NO_ERROR<br />            .if eax == ERROR_NOT_CONTAINER<br />                ;The lpNetResource parameter does not point to a container.<br />                mov esi, offset szERROR_NOT_CONTAINER<br />                <br />            .elseif eax == ERROR_INVALID_PARAMETER<br />                ;Either the dwScope or the dwType parameter is invalid, <br />                ;or there is an invalid combination of parameters.<br />                mov esi, offset szERROR_INVALID_PARAMETER<br /><br />            .elseif eax == ERROR_NO_NETWORK<br />                ;The network is unavailable. <br />                mov esi, offset szERROR_NO_NETWORK<br /><br />            .elseif eax == ERROR_EXTENDED_ERROR<br />                ;A network-specific error occurred. To obtain a description of the error, <br />                ;call the WNetGetLastError function.<br />                mov esi, offset szERROR_EXTENDED_ERROR<br />            .endif<br />            invoke MessageBox, g_hWnd, esi, offset g_szWNetOpenEnum, MB_OK + MB_ICONSTOP<br />            mov eax, 1<br />            ret<br />        .ENDIF<br />xor  eax, eax<br />ret<br />GetEnumHandle endp<br /><br /><br />;//////////////////////////////////////////////////////////////////////////////////////<br />;Function&#58; Enum the net resources and insert it into TreeView<br />;   Input&#58; hEnumRes      - Handle that identifies an enumeration instance<br />;          lpNetResBuf   - Pointer to the buffer that receives the enumeration results.<br />;                          &#40;The buffer is an array of NETRESOURCE structures&#41;<br />;          hParent       - Handle to the parent item in TreeView<br />;          hInsertAfter  - Handle to the item after which the new item is to be inserted, <br />;                          or one of the following values&#58; <br />;                          TVI_FIRST, TVI_LAST, TVI_ROOT, TVI_SORT<br />;<br />;  Output&#58; &#40;none&#41;<br />;///////////////////////////////////////////////////////////////////////////////////////<br /><br />EnumNetResource proc hEnumRes&#58; DWORD, lpNetResBuf&#58; DWORD, hParent&#58; HANDLE, hInsertAfter; HANDLE<br />    LOCAL tvinsert&#58;TV_INSERTSTRUCT<br /><br />    invoke RtlZeroMemory, lpNetResBuf, sizeof g_nrLocal<br />    .WHILE TRUE<br /><br />        ;         DWORD WNetEnumResource&#40;<br />        ;           HANDLE hEnum, <br />        ;           LPDWORD lpcCount, <br />        ;           LPVOID lpBuffer, <br />        ;           LPDWORD lpBufferSize<br />        ;         &#41;;<br /><br /><br />        invoke WNetEnumResource, hEnumRes, offset g_cCount, lpNetResBuf, offset g_cbBuff<br /><br />        .if eax == NO_ERROR<br /><br />            pushad<br />            invoke wsprintf, offset g_szBuff, offset g_szFmt, g_cCount<br />            invoke MessageBox, g_hWnd, offset g_szBuff, offset g_szAppName, MB_OK<br />            popad<br /><br />            mov eax, g_cCount<br />            .IF &#40;g_cCount == 0&#41;<br />                jmp @NoMore<br />            .endif           <br />	<br />             ;                 typedef struct _NETRESOURCE &#123;<br />             ;                   DWORD dwScope;<br />             ;                   DWORD dwType;<br />             ;                   DWORD dwDisplayType;<br />             ;                   DWORD dwUsage;<br />             ;                   LPTSTR lpLocalName;<br />             ;                   LPTSTR lpRemoteName;<br />             ;                   LPTSTR lpComment;<br />             ;                   LPTSTR lpProvider;<br />             ;                 &#125; NETRESOURCE;<br /><br />            push edi<br />            mov  edi, lpNetResBuf<br /><br />            .WHILE &#40;eax &gt; 0&#41;<br />                push eax<br />                push edi<br />                <br />                push hParent<br />                pop  tvinsert.hParent<br />                push hInsertAfter<br />                pop  tvinsert.hInsertAfter<br />                mov  tvinsert.item._mask, TVIF_TEXT + TVIF_IMAGE + TVIF_SELECTEDIMAGE<br /><br />                assume edi&#58; ptr NETRESOURCE<br />                push &#91;edi&#93;.lpRemoteName<br />                assume edi&#58; ptr nothing<br />	         pop  tvinsert.item.pszText<br />        	  mov tvinsert.item.iImage, 0<br />                mov tvinsert.item.iSelectedImage, 1<br />		  invoke SendMessage, g_hTreeView, TVM_INSERTITEM, 0, addr tvinsert<br /><br />                pop  edi<br />                ;inc  edx<br />                add edi, sizeof NETRESOURCE<br />                pop  eax<br />                dec  eax<br />            .ENDW<br />            pop edi<br /><br />        .else<br />            .IF eax == ERROR_NO_MORE_ITEMS<br />@NoMore&#58;<br />                ;There are no more entries. The buffer contents are undefined<br />                mov edx, offset szERROR_NO_MORE_ITEMS<br />            .ELSEIF eax == ERROR_MORE_DATA<br />                ;More entries are available with subsequent calls.<br />                mov edx, offset szERROR_MORE_DATA<br />            .ELSEIF eax == ERROR_INVALID_HANDLE<br />                ;The handle specified by the hEnum parameter is not valid.<br />                mov edx, offset szERROR_INVALID_HANDLE<br />            .ELSEIF eax == ERROR_NO_NETWORK<br />                ;The network is unavailable.<br />                ;&#40;This condition is tested before hEnum is tested for validity.&#41;<br />                mov edx, offset szERROR_NO_NETWORK<br />            .ELSEIF eax == ERROR_EXTENDED_ERROR<br />                ;A network-specific error occurred. <br />                ;To obtain a description of the error, call the WNetGetLastError function. <br />                mov edx, offset szERROR_EXTENDED_ERROR<br />            .ENDIF<br /><br />            invoke MessageBox, g_hWnd, edx, offset g_szWNetEnumResource, MB_OK + MB_ICONSTOP<br />            .break<br />        .endif            <br />    .ENDW<br /><br />    invoke WNetCloseEnum, g_hResEnum<br />    ret<br />EnumNetResource endp<br /><br />end start<br /></code></pre></div>
    <div class="meta">Posted on 2004-03-19 01:25:04 by purpleendurer</div>
   </div>
  </div>
 </body>
</html>