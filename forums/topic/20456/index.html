<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>AsmCtrl Property Page woes ! - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=20456" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=116">Windows</a> &raquo; <a href="../?id=20456">AsmCtrl Property Page woes !</a></p>
   <div class="post" id="post-156405">
    <div class="subject"><a href="#post-156405">AsmCtrl Property Page woes !</a></div>
    <div class="body">I've been trying to add a custom property page to Japheth's Asmctrl with little success. It crashes VB when drawing the property frame. I believe I must be returning a bad pointer to VB. Any help?<br /><br /><br />Get it here:<br />http://us.f2.yahoofs.com/bc/41d369a4_14d10/bc/Public/AsmCtlPP.zip?BCEBv.BB2GTefdME</div>
    <div class="meta">Posted on 2005-01-28 19:58:51 by Wayne</div>
   </div>
   <div class="post" id="post-156428">
    <div class="subject"><a href="#post-156428">AsmCtrl Property Page woes !</a></div>
    <div class="body">Hi Wayne,<br /><br />regretably the download location cannot be found.<br /><br />I have an AsmCtrl version with a property page, but recently I switched to other include files and somehow managed to add a bug in the sample's drawing code, so it wont be any help.</div>
    <div class="meta">Posted on 2005-01-29 09:45:56 by japheth</div>
   </div>
   <div class="post" id="post-156435">
    <div class="subject"><a href="#post-156435">AsmCtrl Property Page woes !</a></div>
    <div class="body">Sorry about the link.<br />Please try :<br />http://f2.pg.briefcase.yahoo.com/wayne.lozinski@sbcglobal.net<br /><br />Select the Public folder.<br /><br />At this point I am only trying to get a blank Prop Page.</div>
    <div class="meta">Posted on 2005-01-29 10:53:23 by Wayne</div>
   </div>
   <div class="post" id="post-156438">
    <div class="subject"><a href="#post-156438">AsmCtrl Property Page woes !</a></div>
    <div class="body">I think method GetPageInfo isnt correct. Besides that, my property page version (CAsmProp.asm) looks pretty similiar  (dont let yourself confuse by some include file changes at the top):<br /><br /><pre><code><br /><br /><br />;*** methods of CAsmProp coclass<br /><br />	.586<br />	.model flat, stdcall<br />	option casemap&#58;none ; case sensitive<br />	option proc&#58;private<br /><br />	.nolist<br />	.nocref<br />WIN32_LEAN_AND_MEAN equ 1<br />INC_OLE2			equ 1<br />	include windows.inc<br />	include olectl.inc<br /><br />	include macros.inc<br />	include disphlp.inc<br />	include olecntrl.inc<br />	include debugout.inc<br /><br />	include AsmCtrl.inc		;type information &#40;COMView generated&#41;<br />	.list<br />	.cref<br /><br />	include CAsmClass.inc<br />	include CAsmProp.inc<br /><br />IDD_PROPPAGE	equ 1001<br />IDC_EDIT1		equ 40000<br /><br />Destroy@CAsmProp proto &#58;ptr CAsmProp<br /><br />	.const<br /><br />CLSID_CAsmProp      sCLSID_AsmProp<br /><br />;--------------------------------------------------------------------------<br />;--- IUnknown interface&#58; the table of supp. interfaces must be defined<br />;--------------------------------------------------------------------------<br /><br />	.const<br /><br />	DEFINE_KNOWN_INTERFACES CAsmProp, IPropertyPage<br /><br />;--------------------------------------------------------------------------<br />;--- define table of registry entries for this CLSID<br />;--- REGSTRUCT  = &#123;LPSTR lpszSubKey; LPSTR lpszValueName; LPSTR lpszData&#125;<br />;--- -1 in lpszSubKey -&gt; key in HKEY_CLASSES_ROOT, in which next<br />;--- entries will be written. %s is szCLSID in such entries.<br />;--- else&#58; -1 in lpszData&#58; replaced by szCLSID, -2 in lpszData&#58; replaced by szTLBID<br />;--- %s is module path in such entries<br />;--------------------------------------------------------------------------<br /><br />Description		textequ &lt;&quot;OCX control in ASM Property Page&quot;&gt;<br /><br />RegKeys_CAsmProp label REGSTRUCT<br />	REGSTRUCT &lt;-1, 0, CStr&#40;&quot;CLSID\%s&quot;&#41;&gt;<br />	REGSTRUCT &lt;0, 0, CStr&#40;Description&#41;&gt;<br />	REGSTRUCT &lt;CStr&#40;&quot;InprocServer32&quot;&#41;, 0, CStr&#40;&quot;%s&quot;&#41;&gt;<br />	REGSTRUCT &lt;CStr&#40;&quot;InprocServer32&quot;&#41;, CStr&#40;&quot;ThreadingModel&quot;&#41;, CStr&#40;&quot;Apartment&quot;&#41;&gt;<br />	REGSTRUCT &lt;CStr&#40;&quot;Programmable&quot;&#41;, 0, 0&gt;<br />	REGSTRUCT &lt;-1, 0, 0&gt;<br /><br />;-----------------------------------------------------------------<br />	.const<br />    <br />CAsmPropVtbl	label IPropertyPageVtbl<br />	IUnknownVtbl &#123;QueryInterface@CAsmProp, AddRef@CAsmProp, Release@CAsmProp&#125;<br />    dd SetPageSite<br />    dd Activate<br />    dd Deactivate<br />    dd GetPageInfo<br />    dd SetObjects<br />    dd Show<br />    dd Move<br />    dd IsPageDirty<br />    dd Apply<br />    dd Help<br />    dd TranslateAccelerator_<br /><br />	.code<br /><br />__this	textequ &lt;ebx&gt;<br />_this	textequ &lt;&#91;__this&#93;.CAsmProp&gt;<br /><br />	MEMBER pPropertyPageSite, hWnd, pObject, rect, bModal<br /><br />	DEFINE_STD_COM_METHODS CAsmProp<br /><br />;--------------------------------------------------------------------------<br />;--------------- constructor CAsmProp<br />;--------------------------------------------------------------------------<br /><br />Create@CAsmProp	proc public uses __this pClass&#58; ptr ObjectEntry, pUnkOuter&#58;LPUNKNOWN<br />	<br />    DebugOut &quot;Create@CAsmProp&quot;<br /><br />	invoke LocalAlloc, LMEM_FIXED or LMEM_ZEROINIT,sizeof CAsmProp<br />	.if &#40;eax == NULL&#41;<br />		ret<br />	.endif<br />	mov __this,eax<br />	mov	m__IPropertyPage, OFFSET CAsmPropVtbl<br />	STD_COM_CONSTRUCTOR CAsmProp<br /><br />if ?AGGREGATION<br />	lea eax, m__IUnknown<br />	ret<br />else<br />	return __this<br />endif<br /><br />Create@CAsmProp	endp<br /><br />;--------------------------------------------------------------------------<br />;--------------- destructor<br />;--------------------------------------------------------------------------<br /><br />Destroy@CAsmProp PROC public uses __this this_&#58;ptr CAsmProp<br /><br />	DebugOut &quot;Destroy@CAsmProp enter&quot;<br />    mov __this,this_<br />	STD_COM_DESTRUCTOR CAsmProp<br />	invoke LocalFree, __this<br />    ret<br /><br />Destroy@CAsmProp ENDP<br /><br />;--- the window proc of the property sheet <br /><br />dlgproc proc uses __this hWnd&#58;HWND, uMessage&#58;DWORD, wParam&#58;WPARAM, lParam&#58;LPARAM<br /><br />local	dwValue&#58;DWORD<br />local	szText&#91;64&#93;&#58;byte<br /><br />    mov eax,uMessage<br />    .IF &#40;eax == WM_COMMAND&#41;<br />	    DebugOut &quot;CAsmProp wndproc WM_COMMAND&quot;<br />		xor eax,eax<br />    .ELSEIF &#40;eax == WM_INITDIALOG&#41;<br />	    DebugOut &quot;CAsmProp wndproc WM_INITDIALOG&quot;<br />    	invoke SetWindowLong, hWnd, DWL_USER, lParam<br />        mov __this, lParam<br />        .if &#40;m_pObject&#41;<br />	        invoke vf&#40;m_pObject, IAsmClass, get_Value&#41;, addr dwValue <br />            .if &#40;eax == S_OK&#41;<br />            	invoke wsprintf, addr szText, CStr&#40;&quot;%u&quot;&#41;, dwValue<br />            	invoke SetDlgItemText, hWnd, IDC_EDIT1, addr szText<br />            .endif<br />        .endif<br />		mov eax,1<br />    .ELSEIF &#40;eax == WM_CLOSE&#41;<br />	    DebugOut &quot;CAsmProp wndproc WM_CLOSE&quot;<br />       	invoke DestroyWindow, hWnd<br />	.ELSE<br />		xor eax,eax<br />    .ENDIF<br />    ret<br />dlgproc endp<br /><br /><br />SetPageSite	proc uses __this this_&#58;ptr CAsmProp, pSite&#58;ptr IPropertyPageSite<br /><br />    DebugOut &quot;SetPageSite@CAsmProp&quot;<br />	mov __this, this_<br />	invoke ComPtrAssign, addr m_pPropertyPageSite, pSite<br />	mov eax, S_OK<br />	ret<br />SetPageSite endp<br /><br />Activate	proc uses __this this_&#58;ptr CAsmProp, hWnd&#58;HWND, pRect&#58;LPRECT, bModal&#58;BOOL<br /><br />    DebugOut &quot;Activate@CAsmProp&quot;<br />	mov __this, this_<br />    invoke CopyRect, addr m_rect, pRect<br />    invoke CreateDialogParam, g_hInstance, IDD_PROPPAGE, hWnd, offset dlgproc, __this<br />    .if &#40;eax&#41;<br />    	mov m_hWnd, eax<br />        mov eax, S_OK<br />    .else<br />    	mov eax, E_OUTOFMEMORY<br />    .endif<br />	ret<br />Activate endp<br /><br />Deactivate	proc uses __this this_&#58;ptr CAsmProp<br />    DebugOut &quot;Deactivate@CAsmProp&quot;<br />	mov __this, this_<br />	.if &#40;m_hWnd&#41;<br />    	invoke DestroyWindow, m_hWnd<br />        mov m_hWnd, NULL<br />	.endif<br />	mov eax, S_OK<br />	ret<br />Deactivate endp<br /><br />GetPageInfo proc uses __this esi this_&#58;ptr CAsmProp, pPPInfo&#58;ptr PROPPAGEINFO<br />    DebugOut &quot;GetPageInfo@CAsmProp&quot;<br />	mov __this, this_<br />	mov esi, pPPInfo<br />    mov &#91;esi&#93;.PROPPAGEINFO.cb, sizeof PROPPAGEINFO<br />    invoke CoTaskMemAlloc, 32*2<br />    mov &#91;esi&#93;.PROPPAGEINFO.pszTitle, eax<br />    .if &#40;eax&#41;<br />    	invoke lstrcpyW, eax, CStrW&#40;L&#40;AsmCtrl PropPage&#41;&#41;<br />	.endif    <br />    mov &#91;esi&#93;.PROPPAGEINFO.size_.cx_, 240<br />    mov &#91;esi&#93;.PROPPAGEINFO.size_.cy, 180<br />    invoke CoTaskMemAlloc, 32*2<br />    mov &#91;esi&#93;.PROPPAGEINFO.pszDocString, eax<br />    .if &#40;eax&#41;<br />    	invoke lstrcpyW, eax, CStrW&#40;L&#40;AsmCtrl DocString&#41;&#41;<br />	.endif    <br />    invoke CoTaskMemAlloc, 32*2<br />    mov &#91;esi&#93;.PROPPAGEINFO.pszHelpFile, eax<br />    .if &#40;eax&#41;<br />    	invoke lstrcpyW, eax, CStrW&#40;L&#40;AsmCtrl HelpFile&#41;&#41;<br />	.endif    <br />    mov &#91;esi&#93;.PROPPAGEINFO.dwHelpContext, 0<br />	mov eax, S_OK<br />	ret<br />GetPageInfo endp<br /><br />;--- currently only 1 object supported<br /><br />SetObjects proc uses __this this_&#58;ptr CAsmProp, cObjects&#58;DWORD, ppUnk&#58;ptr LPUNKNOWN<br /><br />    DebugOut &quot;SetObjects@CAsmProp&quot;<br />	mov __this, this_<br />	mov ecx, cObjects<br />    .if &#40;ecx&#41;<br />    	mov edx, ppUnk<br />        mov eax, &#91;edx&#93;<br />        .if &#40;eax&#41;<br />        	lea ecx, m_pObject<br />        	invoke vf&#40;eax, IUnknown, QueryInterface&#41;, offset IID_IAsmClass, ecx<br />        .endif<br />    .else<br />    	.if &#40;m_pObject&#41;<br />        	invoke vf&#40;m_pObject, IUnknown, Release&#41;<br />            mov m_pObject, NULL<br />        .endif<br />    .endif<br />    mov eax, S_OK<br />	ret<br />SetObjects endp<br /><br />Show proc uses __this this_&#58;ptr CAsmProp, nCmdShow&#58;DWORD<br />    DebugOut &quot;Show@CAsmProp&quot;<br />	mov __this, this_<br />	.if &#40;nCmdShow&#41;<br />		invoke ShowWindow, m_hWnd, SW_SHOW<br />    .else<br />		invoke ShowWindow, m_hWnd, SW_HIDE<br />    .endif<br />    mov eax, S_OK<br />	ret<br />Show endp<br /><br />Move proc uses __this this_&#58;ptr CAsmProp, pRect&#58;LPRECT<br />    DebugOut &quot;Move@CAsmProp&quot;<br />	mov __this, this_<br />    invoke CopyRect, addr m_rect, pRect<br />	mov eax, S_OK<br />	ret<br />Move endp<br /><br />IsPageDirty proc uses __this this_&#58;ptr CAsmProp<br />    DebugOut &quot;IsPageDirty@CAsmProp&quot;<br />	mov eax, S_FALSE<br />	ret<br />IsPageDirty endp<br /><br />Apply proc uses __this this_&#58;ptr CAsmProp<br />    DebugOut &quot;Apply@CAsmProp&quot;<br />	mov __this, this_<br />    .if &#40;m_hWnd&#41;<br />    	invoke GetDlgItemInt, m_hWnd, IDC_EDIT1, NULL, FALSE<br />        invoke vf&#40;m_pObject, IAsmClass, put_Value&#41;, eax<br />    .endif<br />	mov eax, S_OK<br />	ret<br />Apply endp<br /><br />Help proc uses __this this_&#58;ptr CAsmProp, pHelp&#58;LPOLESTR<br />    DebugOut &quot;Help@CAsmProp&quot;<br />	mov eax, E_NOTIMPL<br />	ret<br />Help endp<br /><br />TranslateAccelerator_ proc uses __this this_&#58;ptr CAsmProp, pMsg&#58;ptr MSG<br />    DebugOut &quot;TranslateAccelerator@CAsmProp&quot;<br />	mov eax, E_NOTIMPL<br />	ret<br />TranslateAccelerator_ endp<br /><br />	end<br /></code></pre><br /><br />Furthermore, I added the propsheet coclass to AsmCtrl.idl:<br /><br /><pre><code><br />	&#91;<br />		uuid&#40;B0D96E70-04EB-11D6-B064-8494AF9D1B52&#41;,<br />		version&#40;1.0&#41;,<br />//		control,<br />		helpstring&#40;&quot;AsmClass coclass&quot;&#41;<br />	&#93;<br />	coclass AsmClass<br />	&#123;<br />		&#91;default&#93; interface IAsmClass;<br />		&#91;default, source&#93; dispinterface _AsmClassEvent;<br />	&#125;;<br /><br />    &#91;<br />		uuid&#40;B0D96E7F-04EB-11D6-B064-8494AF9D1B52&#41;,<br />		helpstring&#40;&quot;AsmClass PropertyPage coclass&quot;&#41;<br />	&#93;<br />	coclass AsmProp<br />	&#123;<br />		interface IUnknown;<br />	&#125;;<br /><br /></code></pre><br /><br />and AsmProp.inc is:<br /><br /><pre><code><br />;--------------------------------------------------------------------------<br />;--- defines CAsmProp class<br />;--------------------------------------------------------------------------<br /><br />CAsmProp struct<br /><br />BEGIN_COM_MAP CAsmProp<br />	COM_INTERFACE_ENTRY IPropertyPage<br />END_COM_MAP<br /><br />pPropertyPageSite LPPROPERTYPAGESITE ?<br />hWnd	HWND ?<br />pObject	LPUNKNOWN ?<br />rect	RECT &lt;&gt;<br />bModal	BOOL ?<br /><br />CAsmProp ends<br /><br />;--------------------------------------------------------------------------<br />;--- externdefs + protos<br />;--------------------------------------------------------------------------<br /><br />externdef CLSID_CAsmProp&#58;GUID<br />externdef RegKeys_CAsmProp&#58;REGSTRUCT<br /><br />Create@CAsmProp		proto pClass&#58;ptr ObjectEntry, pUnkOuter&#58;LPUNKNOWN<br /><br />;--------------------------------------------------------------------------<br />;--- debugging support<br />;--------------------------------------------------------------------------<br />ifdef _DEBUG<br />externdef DEBUGPREFIX&#58;LPSTR<br />endif<br />;--------------------------------------------------------------------------<br /></code></pre><br /><br />the property sheet shows/edits AsmCtrl property &quot;Value&quot;</div>
    <div class="meta">Posted on 2005-01-29 12:20:07 by japheth</div>
   </div>
   <div class="post" id="post-156463">
    <div class="subject"><a href="#post-156463">AsmCtrl Property Page woes !</a></div>
    <div class="body">Well, it's back to Assembler 101 for me. I was so tunnel vision'd that my problem was in the COM implementation that I overlooked preserving ebx. A few 'uses __this' solved the crashing problem. <br /><br />japheth,<br /> Thank you for the advice and code. It was really quite usefull to have other code to compare to.</div>
    <div class="meta">Posted on 2005-01-30 08:02:55 by Wayne</div>
   </div>
  </div>
 </body>
</html>