<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>MX Lookup 2K+ - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=16703" />
    <link rel="next" href="../?id=16703&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=16703">MX Lookup 2K+</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=16703&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=16703&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="16703" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=16703&amp;page=2">&gt;</a><a href="../?id=16703&amp;page=2">&raquo;</a></form>   <div class="post" id="post-129797">
    <div class="subject"><a href="#post-129797">MX Lookup 2K+</a></div>
    <div class="body">The following demo contains a hardcoded domain name, so change it :)<br />The demo takes a host domain name and attempts to fetch any and all MailServers by using an MX Lookup on the DNS of the host.<br />A few people have been asking about this for a while now, and so I finally got off my ass and translated the snippet that Thomas handed me many moons ago.<br />AFAIK it will only work on Win2K and up.<br /><br />Somehow, somewhere, one of the structs I translated from WinDNS.h has become 16 bytes too large, and so theres a cheap fix in the code.<br />If anyone spots the issue in the structs, please feel free to fix it and repost it.<br /><br />Have a nice day :)</div>
    <div class="meta">Posted on 2004-01-05 03:46:30 by Homer</div>
   </div>
   <div class="post" id="post-129801">
    <div class="subject"><a href="#post-129801">Too bad</a></div>
    <div class="body">Too bad it works only in 2k. But how does all the SMTP server progs for win98 work(eg. Free SMTP Server, Advanced SMTP server)<br /><br />Thomas ANtony:confused: :stupid: :notsure: :(</div>
    <div class="meta">Posted on 2004-01-05 05:54:34 by thomasantony</div>
   </div>
   <div class="post" id="post-129806">
    <div class="subject"><a href="#post-129806">MX Lookup 2K+</a></div>
    <div class="body">One way for win98 is to use the undocumented ICMP.DLL <br /><a target="_blank" href="http://tangentsoft.net/wskfaq/examples/dllping.html">Look here for info</a></div>
    <div class="meta">Posted on 2004-01-05 07:05:41 by Homer</div>
   </div>
   <div class="post" id="post-129807">
    <div class="subject"><a href="#post-129807">MX Lookup 2K+</a></div>
    <div class="body">Here is version that work all OS:<br /><pre><code>;##########################################################################<br />; dns-mx<br />; 22.06.2003 - 17.12.2003<br />; coded by comrade &lt;comrade2k@hotmail.com&gt;<br />; IRC&#58; #asm, #coders, #win32asm on EFnet<br />; Web&#58; &#91;url&#93;http&#58;//comrade64.cjb.net/&#91;/url&#93;<br />;      &#91;url&#93;http&#58;//comrade.win32asm.com/&#91;/url&#93;<br />;##########################################################################<br />format PE GUI 4.0<br />entry start<br />;##########################################################################<br />include &quot;%include%/win32a.inc&quot;<br />include &quot;%include%/macro/if.inc&quot;<br />include &quot;%include%/macro/macros.inc&quot;<br />OFFSET equ<br />;##########################################################################<br />macro dddb long,bytes &#123;<br />        dd long<br />        db bytes<br />&#125;<br />;##########################################################################<br />DNS_FLAGS_QUERY         = 0 shl 15      ; x1<br />DNS_FLAGS_RESPONSE      = 1 shl 15<br />DNS_FLAGS_OPCODE_QUERY  = 0 shl 11      ; x4<br />DNS_FLAGS_OPCODE_IQUERY = 1 shl 11<br />DNS_FLAGS_OPCODE_STATUS = 2 shl 11<br />DNS_FLAGS_AA            = 1 shl 10      ; x1<br />DNS_FLAGS_TC            = 1 shl 09      ; x1<br />DNS_FLAGS_RD            = 1 shl 08      ; x1<br />DNS_FLAGS_RA            = 1 shl 07      ; x1<br />DNS_FLAGS_Z             = 1 shl 04      ; x3<br />DNS_FLAGS_RCODE         = 1 shl 00      ; x4<br />DNS_TYPE_A              = 01 shl 8<br />DNS_TYPE_NS             = 02 shl 8<br />DNS_TYPE_MD             = 03 shl 8<br />DNS_TYPE_MF             = 04 shl 8<br />DNS_TYPE_CNAME          = 05 shl 8<br />DNS_TYPE_SOA            = 06 shl 8<br />DNS_TYPE_MB             = 07 shl 8<br />DNS_TYPE_MG             = 08 shl 8<br />DNS_TYPE_MR             = 09 shl 8<br />DNS_TYPE_NULL           = 10 shl 8<br />DNS_TYPE_WKS            = 11 shl 8<br />DNS_TYPE_PTR            = 12 shl 8<br />DNS_TYPE_HINFO          = 13 shl 8<br />DNS_TYPE_MINFO          = 14 shl 8<br />DNS_TYPE_MX             = 15 shl 8<br />DNS_TYPE_TXT            = 16 shl 8<br />DNS_CLASS_IN            = 01 shl 8<br />DNS_CLASS_CS            = 02 shl 8<br />DNS_CLASS_CH            = 03 shl 8<br />DNS_CLASS_HS            = 04 shl 8<br />struc DNSHeader &#123;<br />        .id      dw ?<br />        .flags   dw ?<br />        .qdcount dw ?<br />        .adcount dw ?<br />        .nscount dw ?<br />        .arcount dw ?<br />&#125;<br />struct DNSHeader        ; 12 bytes<br />struc DNSQuestion &#123;<br />        .type    dw ?<br />        .class   dw ?<br />&#125;<br />struct DNSQuestion      ; 4 bytes<br />struc DNSResource &#123;<br />        .type     dw ?<br />        .class    dw ?<br />        .ttl      dd ?<br />        .rdlength dw ?<br />&#125;<br />struct DNSResource      ; 8 bytes<br />struc DNSMX &#123;<br />        .preference  dw ?<br />        .exchange    dw ?<br />&#125;<br />struct DNSMX            ; 4 bytes<br />;##########################################################################<br />;##########################################################################<br />;##########################################################################<br />section &quot;.code&quot; code readable executable<br />;##########################################################################<br />start&#58;<br />;##########################################################################<br />;##########################################################################<br />        push    ebx esi edi<br />        ; initialize<br />        mov     eax,OFFSET sendwrap<br />        mov     ecx,OFFSET recvwrap<br />        xchg    eax,&#91;send&#93;<br />        xchg    ecx,&#91;recv&#93;<br />        mov     &#91;ws32send&#93;,eax<br />        mov     &#91;ws32recv&#93;,ecx<br />        stdcall &#91;WSAStartup&#93;,101h,OFFSET wsd<br />        test    eax,eax<br />        jnz     .quit<br />        call    &#91;GetTickCount&#93;<br />        mov     &#91;dwTime&#93;,eax<br />        stdcall &#91;WSASetBlockingHook&#93;,OFFSET BlockHook<br />        stdcall getMX,OFFSET szHost,OFFSET dwRootServers,0<br />        stdcall &#91;inet_ntoa&#93;,eax<br />        mov     ebx,eax<br />        showfmt &quot;MX for %s is %s&quot;,OFFSET szHost,ebx<br />.quit&#58;  call    &#91;WSACleanup&#93;<br />        pop     edi esi ebx<br />        stdcall &#91;ExitProcess&#93;,0<br />;##########################################################################<br />proc getMX,pszDomain,lpServers,dwDepth<br />        .addr   rd 02h<br />        .buffer rd 01h<br />        .domain rb 100h<br />        .answer rb 100h<br />        .sin    sockaddr_in<br />        .dnshdr DNSHeader<br />        .dnsq   DNSQuestion<br />        .pref   rw 01h<br />        rb 02h<br />        enter<br />        push    ebx esi edi<br />        xor     eax,eax<br />        mov     &#91;.pref&#93;,-1<br />        mov     &#91;.addr+00h&#93;,eax<br />        mov     &#91;.addr+04h&#93;,eax<br />        mov     &#91;.answer&#93;,0<br />        stdcall allocBuffer,10000h<br />        mov     &#91;.buffer&#93;,eax<br />        cmp     &#91;dwDepth&#93;,8<br />        jge     .err<br /><br />        mov     esi,&#91;lpServers&#93;<br />.serv&#58;  push    esi<br />        mov     ebx,&#91;esi&#93;<br />        stdcall &#91;socket&#93;,PF_INET,SOCK_DGRAM,0<br />        cmp     eax,INVALID_SOCKET<br />        je      .serr<br />        xchg    eax,ebx<br />        lea     edx,&#91;.sin&#93;<br />        mov     &#91;edx+sockaddr_in.sin_family&#93;,AF_INET<br />        mov     &#91;edx+sockaddr_in.sin_port&#93;,53 shl 8<br />        mov     &#91;edx+sockaddr_in.sin_addr&#93;,eax<br />        stdcall &#91;connect&#93;,ebx,edx,sizeof.sockaddr_in<br />        test    eax,eax<br />        jnz     .serr<br />        ; send<br />        lea     edi,&#91;.dnshdr&#93;<br />        mov     ecx,sizeof.DNSHeader shr 2<br />        rep     stosd<br />        sub     edi,sizeof.DNSHeader<br />        mov     &#91;edi+DNSHeader.id&#93;,01 shl 8<br />        mov     &#91;edi+DNSHeader.flags&#93;,01<br />        mov     &#91;edi+DNSHeader.qdcount&#93;,01 shl 8<br />        mov     &#91;.dnsq.type&#93;,DNS_TYPE_MX<br />        mov     &#91;.dnsq.class&#93;,DNS_CLASS_IN<br />        stdcall addBuffer,&#91;.buffer&#93;,edi,sizeof.DNSHeader<br />        mov     esi,&#91;pszDomain&#93;<br />        mov     edi,esi<br />        dec     esi<br />.next&#58;  inc     esi<br />        cmp     byte &#91;esi&#93;,&quot;.&quot;<br />        je      @F<br />        cmp     byte &#91;esi&#93;,0<br />        jne     .next<br />@@&#58;     mov     eax,esi<br />        sub     eax,edi<br />        push    eax<br />        mov     eax,esp<br />        stdcall addBuffer,&#91;.buffer&#93;,eax,1<br />        stdcall addBuffer,&#91;.buffer&#93;,edi         ; length on stack<br />        inc     esi<br />        mov     edi,esi<br />        cmp     byte &#91;esi-1&#93;,0<br />        jne     .next<br />        stdcall addBuffer,&#91;.buffer&#93;,OFFSET szBlank,1<br />        lea     eax,&#91;.dnsq&#93;<br />        stdcall addBuffer,&#91;.buffer&#93;,eax,sizeof.DNSQuestion<br />        stdcall getBufferLength,&#91;.buffer&#93;<br />        stdcall &#91;send&#93;,ebx,&#91;.buffer&#93;,eax,0<br />        ; receive<br />        stdcall &#91;recv&#93;,ebx,&#91;.buffer&#93;,10000h,0<br />        stdcall setBufferLength,&#91;.buffer&#93;,eax<br />        cmp     eax,sizeof.DNSHeader<br />        jl      .serr<br />        mov     esi,&#91;.buffer&#93;<br />        movzx   eax,&#91;.dnshdr.id&#93;<br />        cmp     &#91;esi+DNSHeader.id&#93;,ax<br />        jne     .serr<br />        cmp     &#91;esi+DNSHeader.flags&#93;,DNS_FLAGS_RESPONSE<br />        jz      .serr<br />        ; copy header<br />        lea     edi,&#91;.dnshdr&#93;<br />        mov     ecx,sizeof.DNSHeader shr 2<br />        rep     movsd<br />        ; parse questions<br />        movzx   ebx,&#91;.dnshdr.qdcount&#93;<br />        test    ebx,ebx<br />        jz      .qdone<br />        rol     bx,8<br />.qnext&#58; lea     edi,&#91;.domain&#93;<br />        xor     ecx,ecx<br />        stdcall copydomain,&#91;.buffer&#93;<br />        add     esi,sizeof.DNSQuestion<br />        dec     ebx<br />        jnz     .qnext<br />.qdone&#58; ; parse answers, authority, and additional records<br />        movzx   eax,&#91;.dnshdr.nscount&#93;<br />        movzx   ebx,&#91;.dnshdr.adcount&#93;<br />        movzx   ecx,&#91;.dnshdr.arcount&#93;<br />        xchg    al,ah<br />        xchg    bl,bh<br />        xchg    cl,ch<br />        add     ebx,eax<br />        add     ebx,ecx<br />        jz      .rdone<br />.rnext&#58; lea     edi,&#91;.domain&#93;<br />        xor     ecx,ecx<br />        stdcall copydomain,&#91;.buffer&#93;<br />        movzx   ecx,&#91;esi+DNSResource.rdlength&#93;<br />        xchg    cl,ch<br />        cmp     &#91;esi+DNSResource.type&#93;,DNS_TYPE_MX<br />        je      .rmx<br />        cmp     &#91;esi+DNSResource.type&#93;,DNS_TYPE_NS<br />        je      .rns<br />        cmp     &#91;esi+DNSResource.type&#93;,DNS_TYPE_A<br />        je      .ra<br />        cmp     &#91;esi+DNSResource.type&#93;,DNS_TYPE_SOA<br />        je      .rsoa<br />        ; skip<br />        add     esi,ecx<br />        add     esi,sizeof.DNSResource<br />        jmp     .rskip<br />.rmx&#58;   ; MX records<br />        add     esi,sizeof.DNSResource<br />        lodsw<br />        rol     ax,8<br />        lea     edi,&#91;.domain&#93;<br />        cmp     ax,&#91;.pref&#93;<br />        mov     &#91;.pref&#93;,ax<br />        jae     @F<br />        lea     edi,&#91;.answer&#93;<br />@@&#58;     stdcall copydomain,&#91;.buffer&#93;<br />        jmp     .rskip<br />.rns&#58;   ; NS records<br />        add     esi,sizeof.DNSResource<br />        cmp     &#91;.pref&#93;,-1<br />        je      @F<br />        add     esi,ecx<br />        jmp     .rskip<br />@@&#58;     cmp     &#91;.answer&#93;,0<br />        je      @F<br />        add     esi,ecx<br />        jmp     .rskip<br />@@&#58;     lea     edi,&#91;.answer&#93;<br />        stdcall copydomain,&#91;.buffer&#93;<br />        jmp     .rskip<br />.ra&#58;    ; A records<br />        add     esi,sizeof.DNSResource<br />        push    ecx<br />        lea     eax,&#91;.answer&#93;<br />        lea     ecx,&#91;.domain&#93;<br />        stdcall strcmpi,ecx,eax<br />        test    eax,eax<br />        pop     ecx<br />        jz      @F<br />        add     esi,ecx<br />        jmp     .rskip<br />@@&#58;     lea     edi,&#91;.addr&#93;<br />        movsd<br />        jmp     .rskip<br />.rsoa&#58;  ; SOA records<br />        add     esi,sizeof.DNSResource<br />        cmp     &#91;.answer&#93;,0<br />        je      @F<br />        ; skip<br />        add     esi,ecx<br />        jmp     .rskip<br />@@&#58;     add     ecx,esi<br />        push    ecx<br />        lea     edi,&#91;.answer&#93;<br />        stdcall copydomain,&#91;.buffer&#93;<br />        pop     esi<br />.rskip&#58; dec     ebx<br />        jnz     .rnext<br />.rdone&#58; lea     eax,&#91;.answer&#93;<br />        ;msgbox  eax<br />        mov     eax,&#91;.addr&#93;<br />        cmp     &#91;.answer&#93;,0<br />        je      .serr<br />        test    eax,eax<br />        jnz     @F<br />        lea     eax,&#91;.answer&#93;<br />        stdcall &#91;gethostbyname&#93;,eax<br />        test    eax,eax<br />        jz      .serr<br />        mov     eax,&#91;eax+hostent.h_list&#93;<br />        mov     eax,&#91;eax&#93;<br />        mov     eax,&#91;eax&#93;<br />        mov     &#91;.addr&#93;,eax<br />@@&#58;     cmp     &#91;.pref&#93;,-1<br />        jne     .done<br />        ; try another nameserver<br />        stdcall &#91;closesocket&#93;,ebx<br />        mov     eax,&#91;dwDepth&#93;<br />        inc     eax<br />        lea     edx,&#91;.addr&#93;<br />        stdcall getMX,&#91;pszDomain&#93;,edx,eax<br />        test    eax,eax<br />        jnz     .done<br />.serr&#58;  pop     esi<br />        add     esi,4<br />        cmp     dword &#91;esi&#93;,0<br />        jne     .serv<br />.err&#58;   xor     eax,eax<br />.done&#58;  pop     esi<br />.quit&#58;  push    eax<br />        stdcall &#91;closesocket&#93;,ebx<br />        stdcall freeBuffer,&#91;.buffer&#93;<br />        pop     eax edi esi ebx<br />        return<br />;##########################################################################<br />proc Lookup,pszValue,lpLookupTable<br />        enter<br />        push    ebx esi edi<br />        mov     esi,&#91;lpLookupTable&#93;<br />.next&#58;  lodsd<br />        test    eax,eax<br />        mov     ebx,eax<br />        jz      .quit<br />        stdcall strcmpi,esi,&#91;pszValue&#93;<br />        test    eax,eax<br />        jz      .fnd<br />        dec     esi<br />        xor     eax,eax<br />@@&#58;     lodsb<br />        test    eax,eax<br />        jnz     @B<br />        jmp     .next<br />.fnd&#58;   mov     eax,ebx<br />.quit&#58;  pop     edi esi ebx<br />        return<br />;##########################################################################<br />proc cacheMX,pszAddress,dwAddress<br />        enter<br />        push    ebx esi edi<br />        cmp     &#91;dwAddress&#93;,0<br />        je      .err<br />        stdcall Lookup,&#91;pszAddress&#93;,OFFSET cache<br />        test    eax,eax<br />        jnz     .quit<br />        stdcall strlen,&#91;pszAddress&#93;<br />        test    eax,eax<br />        lea     ecx,&#91;eax+1&#93;<br />        jle     .err<br />        mov     edi,&#91;cachesz&#93;<br />        add     eax,5<br />        add     eax,edi<br />        cmp     eax,20h<br />        jge     .del<br />        add     edi,OFFSET cache<br />.store&#58; mov     eax,&#91;dwAddress&#93;<br />        stosd<br />        add     &#91;cachesz&#93;,ecx<br />        add     &#91;cachesz&#93;,4<br />        mov     esi,&#91;pszAddress&#93;<br />        rep     movsb<br />        jmp     .quit<br />.del&#58;   add     ecx,4<br />        mov     esi,OFFSET cache<br />.next&#58;  lodsd<br />        xor     eax,eax<br />@@&#58;     lodsb<br />        test    eax,eax<br />        jnz     @B<br />        mov     edx,esi<br />        sub     edx,OFFSET cache<br />        cmp     edx,ecx<br />        jl      .next<br />        push    ecx<br />        mov     edi,OFFSET cache<br />        lea     esi,&#91;edi+edx&#93;<br />        mov     eax,&#91;cachesz&#93;<br />        sub     &#91;cachesz&#93;,edx<br />        sub     edx,eax<br />        neg     edx<br />        mov     ecx,edx<br />        shr     ecx,2<br />        rep     movsd<br />        mov     ecx,edx<br />        and     ecx,03h<br />        rep     movsb<br />        pop     ecx<br />        sub     ecx,4<br />        jmp     .store<br />.err&#58;   xor     eax,eax<br />.quit&#58;  pop     edi esi ebx<br />        return<br />;##########################################################################<br />proc allocBuffer,dwLength<br />        enter<br />        push    edi<br />        mov     eax,&#91;dwLength&#93;<br />        add     eax,0Ch<br />        stdcall &#91;GlobalAlloc&#93;,GMEM_MOVEABLE,eax<br />        test    eax,eax<br />        jz      .quit<br />        push    eax<br />        stdcall &#91;GlobalLock&#93;,eax<br />        test    eax,eax<br />        mov     edi,eax<br />        jnz     @F<br />        stdcall &#91;GlobalUnlock&#93;,&#91;esp&#93;<br />        call    &#91;GlobalFree&#93;<br />        jmp     .quit<br />@@&#58;     mov     ecx,&#91;dwLength&#93;<br />        pop     dword &#91;edi+00h&#93;         ; hMemory<br />        xor     eax,eax<br />        mov     &#91;edi+04h&#93;,ecx           ; maximum length<br />        add     edi,08h<br />        add     ecx,04h                 ; +length<br />        shr     ecx,2<br />        push    edi<br />        rep     stosd<br />        mov     ecx,&#91;dwLength&#93;<br />        add     ecx,04h<br />        and     ecx,03h<br />        rep     stosb<br />        pop     eax<br />        add     eax,04h<br />.quit&#58;  pop     edi<br />        return<br />;##########################################################################<br />proc freeBuffer,lpBuffer<br />        enter<br />        mov     eax,&#91;lpBuffer&#93;<br />        test    eax,eax<br />        jz      .quit<br />        sub     eax,0Ch<br />        pushd   &#91;eax&#93;<br />        stdcall &#91;GlobalUnlock&#93;,&#91;eax&#93;<br />        call    &#91;GlobalFree&#93;<br />.quit&#58;  return<br />;##########################################################################<br />proc addBuffer,lpBuffer,lpData,dwLength<br />        enter<br />        push    esi edi<br />        mov     edi,&#91;lpBuffer&#93;<br />        sub     edi,0Ch<br />        xor     ecx,ecx<br />        mov     eax,&#91;edi+08h&#93;           ; length<br />        add     eax,&#91;dwLength&#93;<br />        cmp     eax,&#91;edi+04h&#93;           ; maximum length<br />        jg      .quit<br />        mov     &#91;edi+08h&#93;,eax           ; length<br />        mov     ecx,&#91;dwLength&#93;<br />        mov     esi,&#91;lpData&#93;<br />        lea     edi,&#91;edi+eax+0Ch&#93;<br />        sub     edi,ecx<br />        shr     ecx,2<br />        rep     movsd<br />        mov     ecx,&#91;dwLength&#93;<br />        and     ecx,03h<br />        rep     movsb<br />        mov     ecx,&#91;dwLength&#93;<br />.quit&#58;  mov     eax,ecx<br />        pop     edi esi<br />        return<br />;##########################################################################<br />proc clearBuffer,lpBuffer<br />        enter<br />        push    edi ebx<br />        mov     edi,&#91;lpBuffer&#93;<br />        test    edi,edi<br />        jz      .quit<br />        sub     edi,0Ch<br />        mov     ebx,&#91;edi+04h&#93;   ; maximum length<br />        add     edi,08h<br />        add     ebx,04h<br />        mov     ecx,ebx<br />        shr     ecx,2<br />        rep     stosd<br />        mov     ecx,ebx<br />        and     ecx,03h<br />        rep     stosb<br />.quit&#58;  pop     ebx edi<br />        return<br />;##########################################################################<br />proc getBufferLength,lpBuffer<br />        enter<br />        mov     eax,&#91;lpBuffer&#93;<br />        test    eax,eax<br />        jz      .quit<br />        mov     eax,&#91;eax-04h&#93;<br />.quit&#58;  return<br />;##########################################################################<br />proc setBufferLength,lpBuffer,dwLength<br />        enter<br />        mov     ecx,&#91;lpBuffer&#93;<br />        test    ecx,ecx<br />        mov     eax,&#91;dwLength&#93;<br />        jz      .quit<br />        mov     &#91;ecx-04h&#93;,eax<br />.quit&#58;  return<br />;##########################################################################<br />proc copydomain,buffer<br />        enter<br />        push    ecx<br />.next&#58;  movzx   eax,byte &#91;esi&#93;<br />        test    eax,00C0h<br />        jz      .reg<br />        ; compressed<br />        lodsw<br />        rol     ax,8<br />        push    esi<br />        and     eax,3FFFh<br />        mov     esi,&#91;buffer&#93;<br />        add     esi,eax<br />        stdcall copydomain,&#91;buffer&#93;<br />        pop     esi eax<br />        jmp     .return<br />.reg&#58;   inc     esi<br />        mov     ecx,eax<br />        rep     movsb<br />        mov     byte &#91;edi&#93;,&quot;.&quot;<br />        inc     edi<br />        test    eax,eax<br />        jz      .quit<br />        dec     dword &#91;esp&#93;<br />        jnz     .next<br />        xor     eax,eax<br />.quit&#58;  sub     edi,2<br />        stosb<br />        pop     eax<br />.return&#58;return<br />;##########################################################################<br />proc BlockHook<br />        enter<br />        call    &#91;GetTickCount&#93;<br />        sub     eax,&#91;dwTime&#93;<br />        cmp     eax,2500<br />        jl      .quit<br />        call    &#91;WSACancelBlockingCall&#93;<br />.quit&#58;  return<br />;##########################################################################<br />sendwrap&#58;<br />        stdcall hexdump,OFFSET szTitleSend,&#91;esp+0Ch&#93;,&#91;esp+0Ch&#93;<br />        push    eax ecx edx<br />        call    &#91;GetTickCount&#93;<br />        mov     &#91;dwTime&#93;,eax<br />        pop     edx ecx eax<br />        jmp     &#91;ws32send&#93;<br />;##########################################################################<br />recvwrap&#58;<br />        push    eax ecx edx<br />        call    &#91;GetTickCount&#93;<br />        mov     &#91;dwTime&#93;,eax<br />        pop     edx ecx eax<br />        stdcall &#91;ws32recv&#93;,&#91;esp+10h&#93;,&#91;esp+10h&#93;,&#91;esp+10h&#93;,&#91;esp+10h&#93;<br />        push    eax<br />        stdcall hexdump,OFFSET szTitleRecv,&#91;esp+10h&#93;,eax<br />        pop     eax<br />        retn    10h<br />;##########################################################################<br />proc hexdump,pszTitle,lpData,dwLength<br />        .hFile dd ?<br />        .chars rb 20h<br />        enter<br />        push    ebx esi edi<br />        stdcall &#91;CreateFile&#93;,OFFSET szTrafficFile,GENERIC_WRITE,0,0,OPEN_ALWAYS,0,0<br />        mov     &#91;.hFile&#93;,eax<br />        cmp     eax,INVALID_HANDLE_VALUE<br />        je      .quit<br />        stdcall &#91;SetFilePointer&#93;,eax,0,0,FILE_END<br />        stdcall strlen,&#91;pszTitle&#93;<br />        stdcall &#91;WriteFile&#93;,&#91;.hFile&#93;,&#91;pszTitle&#93;,eax,esp,0<br />        lea     edi,&#91;.chars&#93;<br />        ccall   &#91;wsprintf&#93;,edi,OFFSET szDecimalFormat,&#91;dwLength&#93;<br />        add     edi,eax<br />        mov     eax,&quot; byt&quot;<br />        stosd<br />        mov     eax,&quot;es&quot;<br />        stosw<br />        lea     eax,&#91;.chars&#93;<br />        sub     edi,eax<br />        stdcall &#91;WriteFile&#93;,&#91;.hFile&#93;,eax,edi,esp,0<br />        call    .nl<br />        mov     esi,&#91;lpData&#93;<br />        mov     ecx,&#91;dwLength&#93;<br />        xor     ebx,ebx<br />        test    ecx,ecx<br />        jle     .quit<br />.next&#58;  push    ecx<br />        lea     edi,&#91;.chars&#93;<br />        lodsb<br />        mov     ah,al<br />        shr     al,4<br />        and     ah,0Fh<br />        cmp     al,10<br />        sbb     al,69h<br />        das<br />        stosb<br />        mov     al,ah<br />        cmp     al,10<br />        sbb     al,69h<br />        das<br />        stosb<br />        mov     al,&quot; &quot;<br />        stosb<br />        sub     edi,3<br />        stdcall &#91;WriteFile&#93;,&#91;.hFile&#93;,edi,3,esp,0<br />        inc     ebx<br />        cmp     ebx,10h<br />        jl      .skip<br />        call    .ascii<br />        call    .nl<br />.skip&#58;  pop     ecx<br />        loop    .next<br />        call    .ascii<br />        push    OFFSET .quit<br />        and     &#91;pszTitle&#93;,0<br />.nl&#58;    lea     edi,&#91;.chars&#93;<br />        mov     word &#91;edi&#93;,0A0Dh<br />        stdcall &#91;WriteFile&#93;,&#91;.hFile&#93;,edi,2,esp,0<br />        stdcall strlen,&#91;pszTitle&#93;<br />        test    eax,eax<br />        mov     ebx,eax<br />        jz      .nopad<br />        mov     byte &#91;edi&#93;,&quot; &quot;<br />@@&#58;     stdcall &#91;WriteFile&#93;,&#91;.hFile&#93;,edi,1,esp,0<br />        dec     ebx<br />        jg      @B<br />.nopad&#58; retn<br />.ascii&#58; mov     ecx,10h<br />        sub     ecx,ebx<br />        inc     ecx<br />        test    ecx,ecx<br />        jle     .anopad<br />        lea     ecx,&#91;ecx*3&#93;<br />        lea     edi,&#91;.chars&#93;<br />        mov     byte &#91;edi&#93;,&quot; &quot;<br />@@&#58;     push    ecx<br />        stdcall &#91;WriteFile&#93;,&#91;.hFile&#93;,edi,1,esp,0<br />        pop     ecx<br />        dec     ecx<br />        jg      @B<br />.anopad&#58;sub     esi,ebx<br />.achar&#58; lodsb<br />        cmp     al,20h<br />        jae     @F<br />        mov     al,&quot;.&quot;<br />@@&#58;     mov     &#91;edi&#93;,al<br />        stdcall &#91;WriteFile&#93;,&#91;.hFile&#93;,edi,1,esp,0<br />        dec     ebx<br />        jg      .achar<br />        retn<br />.quit&#58;  stdcall &#91;CloseHandle&#93;,&#91;.hFile&#93;<br />        pop     edi esi ebx<br />        return<br />;##########################################################################<br />proc strlen,pszInput<br />        enter<br />        xor     eax,eax<br />        mov     edx,&#91;pszInput&#93;<br />        test    edx,edx<br />        jz      .quit<br />        dec     eax<br />        dec     edx<br />@@&#58;     inc     edx<br />        inc     eax<br />        cmp     byte &#91;edx&#93;,0<br />        jne     @B<br />.quit&#58;  return<br />;##########################################################################<br />proc strcmpi,pszPrimary,pszSecondary<br />        enter<br />        push    esi edi<br />        xor     eax,eax<br />        mov     esi,&#91;pszPrimary&#93;<br />        mov     edi,&#91;pszSecondary&#93;<br />.next&#58;  mov     al,byte &#91;esi&#93;<br />        mov     ah,byte &#91;edi&#93;<br />        cmp     al,0<br />        jne     @F<br />        sub     al,ah<br />        jmp     .quit<br />@@&#58;     cmp     ah,0<br />        jne     @F<br />        sub     al,ah<br />        jmp     .quit<br />@@&#58;     cmp     al,&quot;Z&quot;<br />        ja      @F<br />        cmp     al,&quot;A&quot;<br />        jb      @F<br />        add     al,32<br />@@&#58;     cmp     ah,&quot;Z&quot;<br />        ja      @F<br />        cmp     ah,&quot;A&quot;<br />        jb      @F<br />        add     ah,32<br />@@&#58;     inc     esi<br />        inc     edi<br />        sub     al,ah<br />        je      .next<br />.quit&#58;  cbw<br />        cwde<br />        pop     edi esi<br />        return<br />;##########################################################################<br />;##########################################################################<br />;##########################################################################<br />section &quot;.data&quot; import data readable writeable<br />        library kernel32,&quot;kernel32.dll&quot;,user32,&quot;user32.dll&quot;,wsock32,&quot;wsock32.dll&quot;<br />        include &quot;%include%/apia/kernel32.inc&quot;<br />        include &quot;%include%/apia/user32.inc&quot;<br />        include &quot;%include%/apia/wsock32.inc&quot;<br />;##########################################################################<br />        szTrafficFile   db      &quot;traffic.txt&quot;,0<br />        szTitleSend     db      &quot;send&#58; &quot;,0<br />        szTitleRecv     db      &quot;recv&#58; &quot;,0<br />        szTitleDump     db      &quot;dump&#58; &quot;,0<br />        szHost          db      &quot;yahoo.com&quot;,0<br />        szBlank         db      0<br />        szDecimalFormat db      &quot;%u&quot;,0<br />        dwRootServers   dd      040029C6h,6B000980h,0C0421C0h,5A0A0880h,0AE6CBC0h,0F10505C0h,042470C0h,35023F80h,119424C0h,1E803AC0h,810E00C1h,0C4020C6h,211B0CCAh,0<br />;##########################################################################<br />        align 4<br />        dwTime          rd      01h<br />        ws32send        rd      01h<br />        ws32recv        rd      01h<br />        cachesz         rd      01h<br />        cache           rb      1000h<br />        wsd             WSADATA<br />;##########################################################################<br />;##########################################################################</code></pre></div>
    <div class="meta">Posted on 2004-01-05 07:16:29 by comrade</div>
   </div>
   <div class="post" id="post-129809">
    <div class="subject"><a href="#post-129809">MX Lookup 2K+</a></div>
    <div class="body">Wow thats a lotta code to send a lousy udp request :tongue: <br />Nice :alright:</div>
    <div class="meta">Posted on 2004-01-05 07:33:22 by Homer</div>
   </div>
   <div class="post" id="post-129811">
    <div class="subject"><a href="#post-129811">thanx</a></div>
    <div class="body">Thanx for that code, comrade :alright: . And EvlkHome, which funcs in the Icmp dll should I use to do a MX lookup?:confused:<br /><br />Thomas Antony</div>
    <div class="meta">Posted on 2004-01-05 07:40:53 by thomasantony</div>
   </div>
   <div class="post" id="post-129813">
    <div class="subject"><a href="#post-129813">MASM</a></div>
    <div class="body">Hi comrade,<br />  Can you convert that code into MASM syntax and post it as a zip file?:) :confused: <br /><br />Thomas Antony</div>
    <div class="meta">Posted on 2004-01-05 07:59:00 by thomasantony</div>
   </div>
   <div class="post" id="post-129886">
    <div class="subject"><a href="#post-129886">OK</a></div>
    <div class="body">OK, if nobody can translate that code:mad: :(  , can you tell me what format it as?MASM, TASM, GoASM, or NASM<br /><br />Thomas Antony</div>
    <div class="meta">Posted on 2004-01-06 02:48:53 by thomasantony</div>
   </div>
   <div class="post" id="post-129890">
    <div class="subject"><a href="#post-129890">MX Lookup 2K+</a></div>
    <div class="body">Hi Thomas,<br /><br />Looks like FASM to me :)</div>
    <div class="meta">Posted on 2004-01-06 04:13:01 by donkey</div>
   </div>
   <div class="post" id="post-129891">
    <div class="subject"><a href="#post-129891">Where</a></div>
    <div class="body">Hi donkey,<br />  I didn't get the macros.inc file when I downloaded fasm .Where can I get it?<br /><br />Thomas Antony:confused: :notsure:</div>
    <div class="meta">Posted on 2004-01-06 05:00:25 by thomasantony</div>
   </div>
   <div class="post" id="post-129895">
    <div class="subject"><a href="#post-129895">MX Lookup 2K+</a></div>
    <div class="body">Yes it is fasm. Probably marco.inc is a personalised marco include file by comrade.. Therefore I think the best is to ask him...</div>
    <div class="meta">Posted on 2004-01-06 07:35:28 by roticv</div>
   </div>
   <div class="post" id="post-130127">
    <div class="subject"><a href="#post-130127">please</a></div>
    <div class="body">Can someone please please translate the above file into MASM or TASM format. And comrade, can you upload that macros.inc file?<br /><br />Thomas Antony</div>
    <div class="meta">Posted on 2004-01-09 00:52:12 by thomasantony</div>
   </div>
   <div class="post" id="post-130270">
    <div class="subject"><a href="#post-130270">allright</a></div>
    <div class="body">All right! If no one wants to reply, don't:mad: . At least can you tell me what this stands for?<br /><br />        dwRootServers   dd       040029C6h,6B000980h,0C0421C0h,5A0A0880h,0AE6CBC0h,<br /> 0F10505C0h,042470C0h,35023F80h,119424C0h,1E803AC0h<br />,810E00C1h,0C4020C6h,211B0CCAh,0<br /><br />Does it indicate the addresses of name servers?:confused: :stupid: <br /><br />Thomas Antony</div>
    <div class="meta">Posted on 2004-01-10 07:47:15 by thomasantony</div>
   </div>
   <div class="post" id="post-130298">
    <div class="subject"><a href="#post-130298">MX Lookup 2K+</a></div>
    <div class="body">You do not macros.inc. Yes, those are addresses of Internet root servers.</div>
    <div class="meta">Posted on 2004-01-10 16:03:41 by comrade</div>
   </div>
   <div class="post" id="post-130303">
    <div class="subject"><a href="#post-130303">MX Lookup 2K+</a></div>
    <div class="body">IcmpCreateFile, IcmpSendEcho, IcmpCloseHandle :)<br />All the information is in the link I provided.<br />Jeez :grin:</div>
    <div class="meta">Posted on 2004-01-10 17:04:30 by Homer</div>
   </div>
   <div class="post" id="post-130321">
    <div class="subject"><a href="#post-130321">where</a></div>
    <div class="body">Hi,<br />   Comrade, what do you mean I don not need macros.ionc.How can I compile the above code without it. :confused: .ANd EvilHome, where is the link 'provided' .:confused: :stupid: :notsure: .<br /><br />Thomas Antony</div>
    <div class="meta">Posted on 2004-01-10 23:39:41 by thomasantony</div>
   </div>
   <div class="post" id="post-130322">
    <div class="subject"><a href="#post-130322">MX Lookup 2K+</a></div>
    <div class="body">Hi Thomas,<br /><br />EvilHomer2K's link was in his post :<br /><br /><a target="_blank" href="http://tangentsoft.net/wskfaq/examples/dllping.html">http://tangentsoft.net/wskfaq/examples/dllping.html</a><br /><br />I could not see any macros called in the source Comrade provided but I may have missed one, download fasm and try to compile it. If you are missing a specific macro I am sure Comrade will provide it.</div>
    <div class="meta">Posted on 2004-01-10 23:51:44 by donkey</div>
   </div>
   <div class="post" id="post-130325">
    <div class="subject"><a href="#post-130325">this one</a></div>
    <div class="body">I am talking abt this line comrade's code<br /><br />include &quot;%include%/macro/macros.inc&quot;<br /><br />He uses some macro called showfmt. Thats why I said I wanted that include file.<br /><br />:confused: :stupid: :notsure: <br /><br />Thomas Antony</div>
    <div class="meta">Posted on 2004-01-11 00:33:55 by thomasantony</div>
   </div>
   <div class="post" id="post-130328">
    <div class="subject"><a href="#post-130328">MX Lookup 2K+</a></div>
    <div class="body">You can replace it with a call to wsprintf and MessageBox, that is basically what the macro does.</div>
    <div class="meta">Posted on 2004-01-11 00:53:14 by comrade</div>
   </div>
   <div class="post" id="post-130332">
    <div class="subject"><a href="#post-130332">doubt</a></div>
    <div class="body">Hi,<br />  I understood the code a little. What structs in which order should we send after we are connected to the name server on port 53:confused: :stupid: :notsure: ?<br /><br />Thomas Antony</div>
    <div class="meta">Posted on 2004-01-11 03:23:59 by thomasantony</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=16703&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=16703&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="16703" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=16703&amp;page=2">&gt;</a><a href="../?id=16703&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>