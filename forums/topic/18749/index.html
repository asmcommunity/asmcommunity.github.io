<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>CD3DArcBall - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=18749" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=10">Graphics &amp; Game Development</a> &raquo; <a href="../?id=18749">CD3DArcBall</a></p>
   <div class="post" id="post-145185">
    <div class="subject"><a href="#post-145185">CD3DArcBall</a></div>
    <div class="body">Here's my atc version of CD3DArcBall :)<br /><br /><pre><code><br />D3DXQuaternionAxisToAxis proto &#58;DWORD,&#58;DWORD,&#58;DWORD<br /><br />.data<br />iCurMouseX dd 0<br />iCurMouseY dd 0<br />s_vDown D3DXVECTOR3 &lt;0.0f,-1.0f,0.0f&gt;<br />s_vCur D3DXVECTOR3 &lt;NULL&gt;<br />fp0 FLOAT 0.0f<br />fp2 FLOAT 2.0f<br />fp5 FLOAT 5.0f<br />fp0pt85 FLOAT 0.85<br />.code<br /><br />class CD3DArcBall, ,C++ compatible<br />    virtual ScreenToVector&#58;sx,sy<br />    virtual HandleMouseMessages&#58;hwin,uint,wparam,lparam<br />    virtual GetRotationMatrix<br />    virtual GetRotationDeltaMatrix<br />    virtual GetTranslationMatrix<br />    virtual GetTranslationDeltaMatrix<br />    virtual IsBeingDragged<br />    virtual SetRadius<br />    virtual SetWindow&#58;iWidth, iHeight, fRadius<br />    virtual SetRightHanded&#58;bRightHanded<br />    virtual Init<br /><br />    long iWidth                   ;   // ArcBall's window width<br />    long iHeight                  ;  // ArcBall's window height<br />    float fRadius                 ;  // ArcBall's radius in screen coords<br />    float fRadiusTranslation; // ArcBall's radius for translating the target<br />    des qDown D3DXQUATERNION ;           // Quaternion before button down<br />    des qNow D3DXQUATERNION  ;            // Composite quaternion for current drag<br />    Mat matRotation ;                      // Matrix for arcball's orientation<br />    Mat matRotationDelta ;             // Matrix for arcball's orientation<br />    Mat matTranslation  ;                // Matrix for arcball's position<br />    Mat matTranslationDelta ;  // Matrix for arcball's position<br />    bool bDrag  ;                             // Whether user is dragging arcball<br />    bool bRightHanded ;                 // Whether to use RH coordinate system<br />endclass<br /><br />CD3DArcBall_CD3DArcBall proc<br />icall ecx, CD3DArcBall, Init<br />ret<br />CD3DArcBall_CD3DArcBall endp<br /><br />CD3DArcBall_$CD3DArcBall proc<br />ret<br />CD3DArcBall_$CD3DArcBall endp<br /><br />CD3DArcBall_Init proc<br />local me&#58;DWORD<br />    mov me,ecx<br />    invoke D3DXQuaternionIdentity, addr &#91;ecx&#93;.CD3DArcBall.qDown <br />    mov ecx,me<br />    invoke D3DXQuaternionIdentity,addr &#91;ecx&#93;.CD3DArcBall.qNow <br />    mov ecx,me<br />    invoke D3DXMatrixIdentity,addr &#91;ecx&#93;.CD3DArcBall.matRotation <br />    mov ecx,me<br />    invoke D3DXMatrixIdentity,addr &#91;ecx&#93;.CD3DArcBall.matRotationDelta <br />    mov ecx,me<br />    invoke D3DXMatrixIdentity,addr &#91;ecx&#93;.CD3DArcBall.matTranslation <br />    mov ecx,me<br />    invoke D3DXMatrixIdentity,addr &#91;ecx&#93;.CD3DArcBall.matTranslationDelta <br />    mov ecx,me<br />    mov &#91;ecx&#93;.CD3DArcBall.bDrag , FALSE<br />    m2m &#91;ecx&#93;.CD3DArcBall.fRadiusTranslation , fp1<br />    mov &#91;ecx&#93;.CD3DArcBall.bRightHanded , FALSE<br />    ret<br />CD3DArcBall_Init endp<br /><br />CD3DArcBall_SetWindow proc  iWidth&#58;DWORD, iHeight&#58;DWORD, fRadius&#58;FLOAT<br />;    // Set ArcBall info<br />    m2m &#91;ecx&#93;.CD3DArcBall.iWidth  , iWidth<br />    m2m &#91;ecx&#93;.CD3DArcBall.iHeight , iHeight<br />    m2m &#91;ecx&#93;.CD3DArcBall.fRadius , fRadius<br />    ret<br />CD3DArcBall_SetWindow endp<br /><br />CD3DArcBall_ScreenToVector proc sx, sy <br />local fx<br />local fy<br />local fz<br />local fmag<br />local scale&#58;FLOAT<br /><br /><br />;    // Scale to screen<br />    fild sx<br />    fild &#91;ecx&#93;.CD3DArcBall.iWidth<br />    fdiv fp2<br />    fsub<br />    fld &#91;ecx&#93;.CD3DArcBall.fRadius<br />    fild &#91;ecx&#93;.CD3DArcBall.iWidth<br />    fdiv fp2<br />    fmul<br />    fdiv<br />    fchs<br />    fstp fx             ;fx   = -&#40;sx - m_iWidth/2&#41;  / &#40;m_fRadius*m_iWidth/2&#41;;<br />    <br />    fild sy<br />    fild &#91;ecx&#93;.CD3DArcBall.iHeight<br />    fdiv fp2<br />    fsub<br />    fld &#91;ecx&#93;.CD3DArcBall.fRadius<br />    fild &#91;ecx&#93;.CD3DArcBall.iHeight<br />    fdiv fp2<br />    fmul<br />    fdiv<br />    fstp fy            ;fy   =  &#40;sy - m_iHeight/2&#41; / &#40;m_fRadius*m_iHeight/2&#41;;<br /><br />    .if &#91;ecx&#93;.CD3DArcBall.bRightHanded <br />        fld fx<br />        fchs<br />        fstp fx<br />        fld fy<br />        fchs  <br />        fstp fy<br />    .endif<br /><br />    mov fz,0<br />    fld fx<br />    fmul fx<br />    fld fy<br />    fmul fy<br />    fadd<br />    fstp fmag;    fmag = x*x + y*y;<br /><br />    fld fmag<br />    fcomp fp1<br />    __FJLE @F<br />;    if&#40; mag &gt; 1.0f &#41;<br />;        FLOAT scale = 1.0f/sqrtf&#40;mag&#41;;<br />        fld fp1<br />        fld fmag<br />        fsqrt<br />        fdiv<br />        fst scale<br />        fmul fx<br />        fstp fx<br />        fld scale<br />        fmul fy<br />        fstp fy<br />        jmp cya<br />@@&#58;<br />;    else<br />        fld fp1<br />        fsub fmag<br />        fsqrt<br />        fstp fz ;        fz = sqrtf&#40; 1.0f - mag &#41;;<br />;    endif<br /><br />;    // Return ptr to vector<br />cya&#58; lea eax,fx<br />        ret                         ;    return D3DXVECTOR3&#40; x, y, z &#41;;<br />CD3DArcBall_ScreenToVector endp<br /><br /><br />CD3DArcBall_SetRadius proc fRadius<br />    m2m &#91;ecx&#93;.CD3DArcBall.fRadiusTranslation , fRadius<br />    ret<br />CD3DArcBall_SetRadius endp<br /><br /><br />CD3DArcBall_HandleMouseMessages proc hWnd, uMsg, wParam, lParam <br />local iMouseX<br />local iMouseY<br />local ftemp1<br />local ftemp2<br />local me<br />local fDeltaX <br />local fDeltaY<br />local vCur&#58;D3DXVECTOR3 <br />local qAxisToAxis&#58;D3DXQUATERNION <br /><br />mov me,ecx<br />;    UNREFERENCED_PARAMETER&#40; hWnd &#41;;<br /><br />;    // Current mouse position<br />;    int iMouseX = GET_X_LPARAM&#40;lParam&#41;;    <br />;    int iMouseY = GET_Y_LPARAM&#40;lParam&#41;;<br />    mov ebx,lParam<br />    mov eax,ebx<br />    and eax,0FFFFh<br />    mov iMouseX,eax<br />    mov eax,ebx<br />    shr eax,16<br />    mov iMouseY,eax<br /><br />    .if uMsg==WM_RBUTTONDOWN<br />    .elseif uMsg==WM_MBUTTONDOWN<br />;            // Store off the position of the cursor when the button is pressed<br />            m2m iCurMouseX , iMouseX<br />            m2m iCurMouseY , iMouseY<br />            return TRUE<br /><br />    .elseif uMsg==WM_LBUTTONDOWN<br />;            // Start drag mode<br />            mov ecx,me<br />            mov &#91;ecx&#93;.CD3DArcBall.bDrag , TRUE<br />            icall me, CD3DArcBall, ScreenToVector, iMouseX, iMouseY     ;returns ptr to temp 3dvector - grab values now !!<br />            m2m s_vDown.x, &#91;eax&#93;.D3DVECTOR.x<br />            m2m s_vDown.y, &#91;eax&#93;.D3DVECTOR.y<br />            m2m s_vDown.y, &#91;eax&#93;.D3DVECTOR.z<br />            mov ecx,me<br />            invoke RtlMoveMemory,addr &#91;ecx&#93;.CD3DArcBall.qDown,addr &#91;ecx&#93;.CD3DArcBall.qNow,sizeof D3DXQUATERNION<br />            return TRUE<br /><br />    .elseif uMsg==WM_LBUTTONUP<br />;            // End drag mode<br />            mov ecx,me<br />            mov &#91;ecx&#93;.CD3DArcBall.bDrag , FALSE<br />            return TRUE<br /><br />    .elseif uMsg==WM_MOUSEMOVE<br />;            // Drag object<br />            mov eax,wParam       <br />            .if eax &amp; MK_LBUTTON     <br />                mov ecx,me  <br />                .if &#91;ecx&#93;.CD3DArcBall.bDrag                 <br />;                    // recompute m_qNow<br />                    icall me, CD3DArcBall, ScreenToVector, iMouseX, iMouseY <br />                    m2m s_vCur.x, &#91;eax&#93;.D3DVECTOR.x<br />                    m2m s_vCur.y, &#91;eax&#93;.D3DVECTOR.y<br />                    m2m s_vCur.y, &#91;eax&#93;.D3DVECTOR.z<br /><br />                    invoke D3DXQuaternionAxisToAxis,addr qAxisToAxis, addr s_vDown, addr vCur<br />                    mov ecx,me<br />                    invoke RtlMoveMemory,addr &#91;ecx&#93;.CD3DArcBall.qNow,addr &#91;ecx&#93;.CD3DArcBall.qDown,sizeof D3DXQUATERNION           ;           m_qNow = m_qDown;<br />                    mov ecx,me<br />                    invoke D3DXQuaternionMultiply,addr &#91;ecx&#93;.CD3DArcBall.qNow, addr &#91;ecx&#93;.CD3DArcBall.qNow, addr qAxisToAxis<br />                    mov ecx,me<br />                    invoke D3DXMatrixRotationQuaternion,addr &#91;ecx&#93;.CD3DArcBall.matRotationDelta, addr qAxisToAxis<br />                .else<br />                    invoke D3DXMatrixIdentity,addr &#91;ecx&#93;.CD3DArcBall.matRotationDelta<br />                    invoke D3DXMatrixRotationQuaternion,addr &#91;ecx&#93;.CD3DArcBall.matRotation, addr &#91;ecx&#93;.CD3DArcBall.qNow<br />                    mov ecx,me<br />                    mov &#91;ecx&#93;.CD3DArcBall.bDrag , TRUE<br />                .endif<br />            <br />            .elseif &#40;eax &amp; MK_RBUTTON&#41; || &#40;eax &amp; MK_MBUTTON&#41;<br />;                // Normalize based on size of window and bounding sphere radius<br />;                FLOAT fDeltaX = &#40; iCurMouseX-iMouseX &#41; * m_fRadiusTranslation / m_iWidth;<br />                fild iCurMouseX<br />                fisub iMouseX <br />                fld &#91;ecx&#93;.CD3DArcBall.fRadiusTranslation <br />                fidiv &#91;ecx&#93;.CD3DArcBall.iWidth<br />                fmul<br />                fstp fDeltaX <br />;                FLOAT fDeltaY = &#40; iCurMouseY-iMouseY &#41; * m_fRadiusTranslation / m_iHeight;<br />                fild iCurMouseY<br />                fisub iMouseY <br />                fld &#91;ecx&#93;.CD3DArcBall.fRadiusTranslation <br />                fidiv &#91;ecx&#93;.CD3DArcBall.iHeight<br />                fmul<br />                fstp fDeltaY <br /><br />                .if&#40; wParam &amp; MK_RBUTTON &#41;<br />                    fld fDeltaX <br />                    fmul fp2<br />                    fchs<br />                    fstp ftemp1     ; -2*fDeltaX<br />                    fld fDeltaY<br />                    fmul fp2<br />                    fstp ftemp2     ; 2*fDeltaY<br />                    mov ecx,me<br />                    invoke D3DXMatrixTranslation, addr &#91;ecx&#93;.CD3DArcBall.matTranslationDelta,ftemp1, ftemp2, fp0 <br />                    mov ecx,me<br />                    invoke D3DXMatrixMultiply, addr &#91;ecx&#93;.CD3DArcBall.matTranslation, addr &#91;ecx&#93;.CD3DArcBall.matTranslation, addr &#91;ecx&#93;.CD3DArcBall.matTranslationDelta <br />                .else ; // wParam &amp; MK_MBUTTON<br />                    fld fDeltaY<br />                    fmul fp5<br />                    fstp ftemp2     ; 5*fDeltaY<br />                    mov ecx,me<br />                    invoke D3DXMatrixTranslation, addr &#91;ecx&#93;.CD3DArcBall.matTranslationDelta, fp0, fp0, ftemp2 <br />                    mov ecx,me<br />                    invoke D3DXMatrixMultiply, addr &#91;ecx&#93;.CD3DArcBall.matTranslation, addr &#91;ecx&#93;.CD3DArcBall.matTranslation, addr &#91;ecx&#93;.CD3DArcBall.matTranslationDelta <br />                .endif<br /><br />;                // Store mouse coordinate<br />                m2m iCurMouseX , iMouseX<br />                m2m iCurMouseY , iMouseY<br />            .endif<br />            return TRUE<br />    .endif<br /><br />    return FALSE<br />CD3DArcBall_HandleMouseMessages endp<br /><br />CD3DArcBall_IsBeingDragged proc<br />    return &#91;ecx&#93;.CD3DArcBall.bDrag<br />CD3DArcBall_IsBeingDragged endp<br /><br />CD3DArcBall_GetTranslationDeltaMatrix proc<br />    lea eax, &#91;ecx&#93;.CD3DArcBall.matTranslationDelta<br />    ret<br />CD3DArcBall_GetTranslationDeltaMatrix endp<br /><br />CD3DArcBall_GetTranslationMatrix proc<br />    lea eax, &#91;ecx&#93;.CD3DArcBall.matTranslation<br />    ret<br />CD3DArcBall_GetTranslationMatrix endp<br /><br />CD3DArcBall_GetRotationDeltaMatrix proc<br />    lea eax, &#91;ecx&#93;.CD3DArcBall.matRotationDelta<br />    ret<br />CD3DArcBall_GetRotationDeltaMatrix endp<br /><br />CD3DArcBall_GetRotationMatrix proc<br />    lea eax, &#91;ecx&#93;.CD3DArcBall.matRotation<br />    ret<br />CD3DArcBall_GetRotationMatrix endp<br /><br />CD3DArcBall_SetRightHanded proc bRightHanded&#58;DWORD<br />    m2m &#91;ecx&#93;.CD3DArcBall.bRightHanded, bRightHanded<br />    ret<br />CD3DArcBall_SetRightHanded endp<br /></code></pre></div>
    <div class="meta">Posted on 2004-07-01 01:47:07 by Homer</div>
   </div>
  </div>
 </body>
</html>