<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Macro problem...... - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=14288" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=14288">Macro problem......</a></p>
   <div class="post" id="post-110490">
    <div class="subject"><a href="#post-110490">Macro problem......</a></div>
    <div class="body">I have a MACRO problem, that i think can not be solved, but I thought i would post it to test the limitless knowledge of this community ;)<br /><br />If at compile time, a macro &quot;A&quot; builds a table of data at a label in the .data segment:<br /><br /><strong>A_Macro_Output </strong>LABLE DWORD<br />  dd   0<br />  dd   1<br />  dd   3<br /><br /><u>As well, this same macro stores the size:</u><br /><br /><strong>A_Macro_Output_Size</strong> equ 12<br /><br /><br />Can another compile time macro copy the 12 data bytes at compile time to another area in the .data segment further on in the source compilation??<br /><br /><strong>B_Macro_Copy</strong>  A_Macro_Output,  A_Macro_Output_Size<br /><br /><u>And generate a new table:</u><br /><br />B_Macro_Output LABEL DWORD<br />  dd  0<br />  dd  1<br />  dd  3<br /><br />This is a tough conundrum.  In theory it should be able to, since the first macro has immediate data to compile, it thus means the latter macro should find immediate data at the label location in the segment.  However, on the flip side, i dont know how M$ made MASM, and it may not linerally build the .data segment (as im assuming), and place the .data immediate values on another compiler pass through the source.<br /><br />Anywho, if you think you can crack this problem, please let me know!<br />Thanks alot!<br />:NaN:</div>
    <div class="meta">Posted on 2003-07-14 19:41:25 by NaN</div>
   </div>
   <div class="post" id="post-110492">
    <div class="subject"><a href="#post-110492">Macro problem......</a></div>
    <div class="body">This is the best i can come up with (names are arbitrary):<pre><code>QC MACRO LA&#58;REQ, DA&#58;REQ<br />.data<br /> LA LABEL DWORD<br /> dd  DA<br /> dd  DA + 1<br /> dd  DA + 2<br />ENDM<br /><br /><br />QCC MACRO LA&#58;REQ, LB&#58;REQ<br />.data<br />   LA LABEL DWORD<br />   dd DWORD PTR &#91;LB + 0&#93;<br />   dd DWORD PTR &#91;LB + 4&#93;<br />   dd DWORD PTR &#91;LB + 8&#93;<br />   <br />ENDM</code></pre><br /><br />With test code:<pre><code>QC ABCD, 5<br /><br />PrintHex ABCD+0, &quot;TEST&quot;<br />PrintHex ABCD+4, &quot;TEST&quot;<br />PrintHex ABCD+8, &quot;TEST&quot;<br /><br />QCC EFG, ABCD<br /><br />PrintHex EFG+0, &quot;TEST&quot;<br />PrintHex EFG+4, &quot;TEST&quot;<br />PrintHex EFG+8, &quot;TEST&quot;</code></pre><br />Produces this output:<pre><code>ABCD+0 = 00000005, TEST<br />ABCD+4 = 00000006, TEST<br />ABCD+8 = 00000007, TEST<br />EFG+0 = 00403060, TEST<br />EFG+4 = 00403064, TEST<br />EFG+8 = 00403068, TEST</code></pre><br /><br />Turns out that it places a pointer, to *where* to copy from, instead of the data itself.  Despite my best efforst to tell it to get the data.  ((00403060h points to a dword in memory initialized to &quot;00000005&quot;))<br /><br />:NaN:</div>
    <div class="meta">Posted on 2003-07-14 20:05:38 by NaN</div>
   </div>
   <div class="post" id="post-110497">
    <div class="subject"><a href="#post-110497">Macro problem......</a></div>
    <div class="body">Hi NaN<br /><br />Why not coding:<br /><br /><pre><code><br />QC MACRO LA&#58;REQ, DA&#58;REQ<br />.data<br /> LA LABEL DWORD<br />LA&amp;0 equ DA<br />LA&amp;1 equ DA + 1<br />LA&amp;2 equ DA + 2<br />	dd  LA&amp;0<br />	dd  LA&amp;1<br />	dd  LA&amp;2<br />ENDM<br /><br /><br />QCC MACRO LA&#58;REQ, LB&#58;REQ<br />.data<br />   LA LABEL DWORD<br />   dd LB&amp;0<br />   dd LB&amp;1<br />   dd LB&amp;2<br />   <br />ENDM<br /></code></pre><br /><br />?</div>
    <div class="meta">Posted on 2003-07-14 21:19:30 by japheth</div>
   </div>
   <div class="post" id="post-110498">
    <div class="subject"><a href="#post-110498">Macro problem......</a></div>
    <div class="body">Nan,<br />No problem, I do this sort of thing all the time.  The trick is to use specific global variables.  Specific in the sense that they will not be confused with the global variables of another macro, and global in that they can be referenced anywhere in the assembly.  I make them specific by including the macro name as part of the global variable name.  See example below.  Ratch<br /><br /><pre><code><br /> = OFFSET			@ EQU OFFSET<br /><br />				QC MACRO LA&#58;REQ,DA&#58;REQ ;define macro<br />				 <br />				 QC$1=DA      ;load global variable<br />				 QC$2=DA+1    ;load global variable<br />				 QC$3=DA+2    ;load global variable<br />				 ;<br />				 LA LABEL DWORD<br />				 DD DA<br />				 DD DA+1<br />				 DD DA+2<br />				ENDM<br /><br />				QCC MACRO LA&#58;REQ ;define macro<br />				 LA LABEL DWORD<br />				 DD QC$1      ;reference global variable<br />				 DD QC$2      ;reference global variable<br />				 DD QC$3      ;reference global variable<br />				ENDM<br /><br /> 00000000			.DATA?<br /><br /> 00000000			.DATA<br /> 00000000  00000009		 DD 9<br /> 00000004  0000000A		 DD 10<br /><br />				 QC ABCD,4            ;call the macro<br />			     1	 <br /> = 00000004		     1	 QC$1=4      ;load global variable<br /> = 00000005		     1	 QC$2=4+1    ;load global variable<br /> = 00000006		     1	 QC$3=4+2    ;load global variable<br />			     1	 ;<br /> 00000008		     1	 ABCD LABEL DWORD<br /> 00000008  00000004	     1	 DD 4<br /> 0000000C  00000005	     1	 DD 4+1<br /> 00000010  00000006	     1	 DD 4+2<br /><br /> 00000014  8B C1		 MOV EAX,ECX<br /> 00000016  90			 NOP<br /> 00000017  83 C1 04		 ADD ECX,4<br /><br />				 QCC EFG              ;call the macro<br /> 0000001A		     1	 EFG LABEL DWORD<br /> 0000001A  00000004	     1	 DD QC$1      ;reference global variable<br /> 0000001E  00000005	     1	 DD QC$2      ;reference global variable<br /> 00000022  00000006	     1	 DD QC$3      ;reference global variable<br /> 00000000			.CODE<br />				.LISTALL<br /><br /> 00000000			START&#58;<br /> 00000000  B8 00000008 R	 MOV EAX,@ ABCD       ;address of label<br /> 00000005  A1 00000008 R	 MOV EAX,&#91;ABCD&#93;       ;contents of label<br /> 0000000A  B8 0000001A R	 MOV EAX,@ EFG        ;address of label<br /> 0000000F  A1 0000001A R	 MOV EAX,&#91;EFG&#93;        ;contents of label<br /><br />				 END START<br /></code></pre></div>
    <div class="meta">Posted on 2003-07-14 21:27:51 by Ratch</div>
   </div>
   <div class="post" id="post-110501">
    <div class="subject"><a href="#post-110501">Macro problem......</a></div>
    <div class="body"><strong>NaN</strong>, I don't really understand your requirements, but in the extreme case you could even create the array of data in assemble-time constants and then create a macro to build the array where ever.<br /><br />What is stated in the first post is impossible - MASM cannot copy arbitrary data from one part of the .data segment to another.  So, the key now becomes duplicating the table creation method in another location.  If <strong>Ratch</strong>'s method is sufficient then it is the way to go.  {<strong>japheth</strong>'s code is basically the same.}</div>
    <div class="meta">Posted on 2003-07-14 22:25:58 by bitRAKE</div>
   </div>
   <div class="post" id="post-110502">
    <div class="subject"><a href="#post-110502">Macro problem......</a></div>
    <div class="body">Thanks both of you for your suggestion (im actually doing the same thing myself at the moment).<br /><br />However, im still reluctant.  I dont like having to add all those equates (One per line of memory i want to copy).  I was hoping for a more logic driven solution. <br /><br />The reason is cause im almost finished my next version of my OOP model.  And for polymorphic action, i need to copy existing vtables into a new one for classes that are to be used polymorphicly.  So to allow for *any* class vtable to be copied, i would have to make an extra equate for every method, to hold a copy at compile time of function offsets.  All this just for the chance the equate may be called upon for a polymorphic class that inherits another vtable's methods as a base class.<br /><br />It works, just not the prettiest solution.  ((I want to make an honest attempt at limiting how much compiler overhead is required to process the objects ))<br /><br />Thanx again!  It is appreciated!<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-07-14 22:33:53 by NaN</div>
   </div>
   <div class="post" id="post-110503">
    <div class="subject"><a href="#post-110503">Macro problem......</a></div>
    <div class="body">While i got everyone's attention, I have another, simpler macro question.<br /><br />I dont ever to MACRO for or while loops.  I know they unroll at compile time, but thats about it.  Im about to hit the reference manual my self to &quot;relearn&quot; them, but i thought i would toss out what i need to do at the same time ;)<br /><br />I have in an equate the number of bytes that need to be &quot;copied&quot;. Since difference classes will have different lengths, this value is a random multiple of 4bytes (dword pointers).<br /><br />I want to make a macro for loop that will loop like the C++ version:<br /><br />for ( new_equ = 0; new_equ &lt; equ_sized; new_equ += 4)<br />{<br />...<br />}<br /><br />And have it unroll with new_equ holding 0, 4, 8, etc. depending on the value of the sized equate.<br /><br />If you can help here, thanx in advanced!<br />:NaN:</div>
    <div class="meta">Posted on 2003-07-14 22:41:31 by NaN</div>
   </div>
   <div class="post" id="post-110505">
    <div class="subject"><a href="#post-110505">Macro problem......</a></div>
    <div class="body">Heh, nevermind, that was easier than i thought it would be ;)<br /><br />Found the solution in an old macro i wrote for Unicode (while loops)<br /><br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=9273">http://www.asmcommunity.net/board/index.php?topic=9273</a><br /><br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-07-14 22:50:31 by NaN</div>
   </div>
   <div class="post" id="post-110566">
    <div class="subject"><a href="#post-110566">Macro problem......</a></div>
    <div class="body">If I understood correctly, you were trying to set two &quot;blocks&quot; of variables in the .data section, with the same size, and initialized with the same values. Both &quot;blocks&quot; are defined using macros. So why not using a single macro, and the ORG directive to place them wherever you want? I'm not familiar with the use of ORG under MASM, but I remember you could do something like that in the old A86 for DOS (by the way, I don't know much of the macro languaje in MASM yet, but it seems to me that A86 was far better in some aspects, don you think? :) )</div>
    <div class="meta">Posted on 2003-07-15 09:31:42 by QvasiModo</div>
   </div>
   <div class="post" id="post-110586">
    <div class="subject"><a href="#post-110586">Macro problem......</a></div>
    <div class="body">I never used A86.  But i do have clear reasons for two separate macro's.  Like i said earlier, im working on a next generation OOP model.  Its now finished, and i got a working solution (as Japheth &amp; Ratch pointed out).  Again the reason I need to copy is since some class instances may be &quot;Lines&quot; and others &quot;Squares&quot;, where squares utilize all of the data/methods that Line has, and extends it further to act as a square class.  So I need two &quot;finger prints&quot; of line, one for each class, and add more to the square above and beyond its copy.  <br /><br />Sorry if this confuses you, its as simple as I can put it...<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-07-15 11:44:33 by NaN</div>
   </div>
   <div class="post" id="post-110630">
    <div class="subject"><a href="#post-110630">Macro problem......</a></div>
    <div class="body">Don't worry NaN, you haven't been confusing, it's just I don't know anything about OOP :grin:</div>
    <div class="meta">Posted on 2003-07-15 16:33:51 by QvasiModo</div>
   </div>
   <div class="post" id="post-110902">
    <div class="subject"><a href="#post-110902">Macro problem......</a></div>
    <div class="body"><div class="quote"><br />Thanks both of you for your suggestion (im actually doing the same thing myself at the moment).<br /><br />However, im still reluctant.  I dont like having to add all those equates (One per line of memory i want to copy).  I was hoping for a more logic driven solution. <br /><br />The reason is cause im almost finished my next version of my OOP model.  And for polymorphic action, i need to copy existing vtables into a new one for classes that are to be used polymorphicly.  So to allow for *any* class vtable to be copied, i would have to make an extra equate for every method, to hold a copy at compile time of function offsets.  All this just for the chance the equate may be called upon for a polymorphic class that inherits another vtable's methods as a base class.<br /><br />It works, just not the prettiest solution.  ((I want to make an honest attempt at limiting how much compiler overhead is required to process the objects ))<br /><br />Thanx again!  It is appreciated!<br />:alright:<br />NaN </div><br /><br />You're encountering many of the same problems I had when using MASM back in 1995/6 that drove me to design and implement HLA!<br /><br />Seriously, though, the best I was able to do with respect to maintaining &quot;compile-time&quot; variables, particularly arrays, in ASM to to create a string of values separated by some delimiter (e.g., &quot;:&quot; ) and then pick apart those objects later on. For some of the craziness I wound up creating in MASM, check out<br /><a target="_blank" href="http://webster.cs.ucr.edu/Page_asm/ucrlib/stdlibv2.html">http://webster.cs.ucr.edu/Page_asm/ucrlib/stdlibv2.html</a><br /><br />I'll warn you that many of the macros I wrote wound up breaking as Microsoft moved from MASM v6.11a to v6.11d; that's when I gave up and started work on HLA.<br /><br />You will find some interesting macros in this package, though. For example, I implemented a try..except..endtry macro sequence (fully nestable) using the trick I mentioned above (I used a string to hold a &quot;stack&quot; of data to remember the nesting level in the &quot;try&quot; statement).<br /><br />If you ever find that MASM's macro facilities don't cut it for your object implementation, you might take a look at HLA - it already has classes built into it and handles VMT generation automatically (well, mostly, you still have to tell HLA *where* to put the VMT for a given class).<br />Cheers,<br />Randy Hyde</div>
    <div class="meta">Posted on 2003-07-17 11:47:26 by rhyde</div>
   </div>
   <div class="post" id="post-111484">
    <div class="subject"><a href="#post-111484">macro problem</a></div>
    <div class="body">Hell over there!<br /><br />What can I do, to use labels in a macro.<br />I want to use the macro several times, but it's not possoble, cuz than there a labels wich are the same.<br /><br />Do someone have a glory idea ?</div>
    <div class="meta">Posted on 2003-07-22 05:55:48 by Bubu-Boy</div>
   </div>
   <div class="post" id="post-111503">
    <div class="subject"><a href="#post-111503">Macro problem......</a></div>
    <div class="body">How about defining your labels as locals?<br /><pre><code><br />SAMPLE macro<br />  local MyLabel<br /><br />  ; put some stuff here<br />MyLabel&#58;<br />  ;some more stuff here<br />  jmp MyLabel<br />  ;well, you get the picture ;&#41;<br />endm<br /></code></pre><br />I never tried (I'm new to macro programming too :) ), but it should work...</div>
    <div class="meta">Posted on 2003-07-22 11:21:19 by QvasiModo</div>
   </div>
   <div class="post" id="post-111505">
    <div class="subject"><a href="#post-111505">Macro problem......</a></div>
    <div class="body">hI!<br /><br />This works with MASM, if assembler does two cicles. <br /><br />;; ** FOR     ******************************** MACRO DE CONTROL ESTRUCTURADO **<br />;; Macro FOR estructurada. Util?cese as?:<br />;;       FOR   contador,inicio,final,signo<br />;;<br />fork     MACRO    p1,p2,p3,p4,p5<br />         LOCAL    primero<br />         LOCAL    ifcierto<br />         IFNDEF   ?for_nivel     ;; establece nuevo nivel de anidado<br />?for_nivel        =        10<br />         ELSE<br />?for_nivel        =        ?for_nivel + 1<br />         ENDIF<br />;; Establece nuevo n?mero de secuencia para nivel de anidado<br />         testsim  ?for_anid,%?for_nivel<br />         IF       (?simdef)<br />         incrsim  ?for_anid,%?for_nivel<br />         ELSE<br />         cerosim  ?for_anid,%?for_nivel<br />         ENDIF<br />;; Inserta inicializaci?n de contador en el c?digo: (evitando paso 1)<br />         mov      &amp;p1,&amp;p2        ; Inicializa contador<br />         jmp      primero        ; Comienza bucle FOR<br />;; Inserta etiqueta inicio bucle para salto<br />         etsalto  ?for_,%?for_nivel,?for_anid<br />;; Inserta c_lculo paso en c?digo, y comprueba que el paso es correcto<br />         IFIDN    &lt;p4&gt;,&lt;+&gt;<br />         add      &amp;p1,&amp;p5        ; Incremento de contador<br />         ELSE<br />         IFIDN    &lt;p4&gt;,&lt;-&gt;<br />         sub      &amp;p1,&amp;p5        ; Decremento de contador<br />         ELSE<br />; ERROR: especificaci?n de paso incorrecta para sentencia FOR<br />         EXITM<br />         ENDIF<br />         ENDIF<br />primero:                         ; Comprueba la continuaci?n<br />;; Inserta en el c?digo la comprobaci?n de condici?n<br />         cmp      &amp;p1,&amp;p3        ; ?Se alcanz? el final?<br />;; Salto a la secci?n de c?digo de FOR: CIERTO<br />         IFIDN    &lt;p4&gt;,&lt;+&gt;<br />         jl       ifcierto       ; No: contin?a en el bucle FOR<br />         ELSE                    ;; caso '-' (por defecto)<br />         jg       ifcierto       ; No: contin?a en el bucle FOR<br />         ENDIF<br />;; Pasa a la etiqueta siguiente<br />         incrsim  ?for_anid,%?for_nivel<br />;; Inserta, en c?digo, salto al final del bucle<br />         salto    ?for_,%?for_nivel,?for_anid<br />ifcierto:<br />         ENDM<br />;; ** FOREND  ******************************** MACRO DE CONTROL ESTRUCTURADO **<br />;; Macro FOR_END estructurada para combinar con FOR<br />;; FOREND genera el c?digo de un bucle FOR estructurado<br />forend   MACRO<br />         IFNDEF   ?for_nivel<br />; ERROR: FOREND sin sentencia FOR<br />         EXITM<br />         ENDIF<br />         IF       (?for_nivel LT 10)<br />; ERROR: FOREND sin sentencia FOR<br />         EXITM<br />         ENDIF<br />;; Vuelta a la etiqueta anterior de la secuencia<br />         decrsim  ?for_anid,%?for_nivel<br />;; Genera salto al comienzo del bucle<br />         salto    ?for_,%?for_nivel,?for_anid<br />;; Pasa a la siguiente etiqueta de la secuencia<br />         incrsim  ?for_anid,%?for_nivel<br />;; Genera etiqueta FOREND<br />         etsalto  ?for_,%?for_nivel,?for_anid<br />?for_nivel        =        ?for_nivel - 1<br />         ENDM</div>
    <div class="meta">Posted on 2003-07-22 11:47:54 by miguelossa</div>
   </div>
   <div class="post" id="post-111507">
    <div class="subject"><a href="#post-111507">Macro problem......</a></div>
    <div class="body">Sorry, the macro above doesn't work without other dependencies.<br /><br />I attach all the file. You'll see that incloses another macros.<br /><br />Please, I didn't test these macros with masm32. Coult you tell me if they can compile?<br /><br />Thanks<br />:alright:</div>
    <div class="meta">Posted on 2003-07-22 12:07:13 by miguelossa</div>
   </div>
  </div>
 </body>
</html>