<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>ATC VECTOR class for 3D Vector math - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=20709" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=38">Object Oriented Programming</a> &raquo; <a href="../?id=20709">ATC VECTOR class for 3D Vector math</a></p>
   <div class="post" id="post-157780">
    <div class="subject"><a href="#post-157780">ATC VECTOR class for 3D Vector math</a></div>
    <div class="body">Here's a handy utility class I've been working with lately.<br />Combined with hcall, it becomes even more useful.<br /><br /><pre><code><br />;VECTOR Class<br />;OOP Support for 3D Vectors &#40;ATC 3.2+&#41;<br />;Written by Evil Homer on March 6, 2005<br />;<br />;Notes on use&#58;<br />;Just watch out for &quot;destructive&quot; methods which modify the data of the object<br />;apon which they are called, for example, &quot;CrossProduct&quot;.<br />;They are intended to be called apon &quot;target objects&quot;, which both carry<br />;data as input and receive the result.<br /><br /><br />VECTOR_Magnitude = VECTOR_GetLength<br /><br />class VECTOR, ,C++ compatible<br />    void Reset                         ;Sets Vector to 0,0,0<br />    void Copy&#58;pOtherVector    ;Copies &quot;this&quot;=&quot;other&quot;<br />    void Set&#58;fx,fy,fz                 ;Sets Vector to x,y,z<br />    void GetLength                  ;Calculates 3D length of vector, result on fpu<br />    void SetLength&#58;fLength     ;Scales Vector to given Length<br />    void Add&#58;pOtherVector       ;&quot;this&quot;=&quot;this&quot; + &quot;other<br />    void Subtract&#58;pOtherVector ;&quot;this&quot;=&quot;this&quot; - &quot;other&quot;<br />    void Magnitude<br />    void Multiply&#58;pOtherVector ;&quot;this&quot;=&quot;this&quot; * &quot;other&quot;<br />    void MultiplyFPU    ;Multiplies &quot;this&quot; vector xyz * fpu value<br />    void DivideFPU ;Divides &quot;this&quot; vector xyz / fpu value<br />    void IsZero                       ;Returns TRUE or FALSE<br />    void Normalize                 ;Destructively forces &quot;this&quot; vector length to 1 &#40;unit length&#41;<br />    void CrossProduct&#58;pOtherVector ;Destructively forces &quot;this&quot; vector = &quot;this&quot; cross &quot;other&quot;<br />    void DotProduct&#58;pOtherVector     ;Calculates &quot;this&quot; dot &quot;other&quot; , result on fpu<br />    void Wedge&#58;pOtherVector, pResultVector ;Calculates vector between vectors<br />    float x<br />    float y<br />    float z<br />endclass<br /><br />VECTOR_VECTOR proc<br />    ret<br />VECTOR_VECTOR endp<br /><br />VECTOR_$VECTOR proc<br />    ret<br />VECTOR_$VECTOR endp<br /><br />VECTOR_IsZero proc<br />.if    &#91;ecx&#93;.VECTOR.x==0 \<br />  &amp;&amp; &#91;ecx&#93;.VECTOR.y==0 \<br />  &amp;&amp; &#91;ecx&#93;.VECTOR.z==0<br />    return TRUE<br />.endif<br />return FALSE<br />VECTOR_IsZero endp<br /><br />VECTOR_Reset proc<br />    fld r4_0_0<br />    fst &#91;ecx&#93;.VECTOR.x<br />    fst &#91;ecx&#93;.VECTOR.y<br />    fstp &#91;ecx&#93;.VECTOR.z<br />    ret<br />VECTOR_Reset endp<br /><br />VECTOR_Copy proc uses ebx pOtherVector<br />    mov ebx, pOtherVector<br />    fld   &#91;ebx&#93;.VECTOR.x<br />    fstp &#91;ecx&#93;.VECTOR.x<br />    fld   &#91;ebx&#93;.VECTOR.y<br />    fstp &#91;ecx&#93;.VECTOR.y<br />    fld   &#91;ebx&#93;.VECTOR.z<br />    fstp &#91;ecx&#93;.VECTOR.z<br />    ret<br />VECTOR_Copy endp<br /><br />;Since the parameters are actually DWORD sized<br />;&#40;disregarding the fact that they contain floating point values&#41;<br />;we can use stack operation &#40;push/pop&#41; to move the data<br />;from the input parameters into the object data fields..<br />VECTOR_Set proc fx&#58;REAL4,fy&#58;REAL4,fz&#58;REAL4<br />    m2m &#91;ecx&#93;.VECTOR.x, fx<br />    m2m &#91;ecx&#93;.VECTOR.y, fy<br />    m2m &#91;ecx&#93;.VECTOR.z, fz<br />    ret<br />VECTOR_Set endp<br /><br />;WARNING !! WARNING !!<br />;DANGER, WILL ROBINSON !!<br />;The result of this procedure is left on the FPU !!<br />VECTOR_DotProduct proc uses ebx pInputVect&#58;ptr VECTOR<br />    mov ebx, pInputVect<br />    fld &#91;ecx&#93;.VECTOR.x<br />    fmul &#91;ecx&#93;.VECTOR.x<br />    fld &#91;ecx&#93;.VECTOR.y<br />    fmul &#91;ecx&#93;.VECTOR.y<br />    fld &#91;ecx&#93;.VECTOR.z<br />    fmul &#91;ecx&#93;.VECTOR.z<br />    fadd<br />    fadd<br />    ret<br />VECTOR_DotProduct endp<br /><br />;This procedure calculates the crossproduct vector <br />;from &quot;this&quot; vector and some &quot;other&quot; vector.<br />;The result is stored in &quot;this&quot; vector.<br />VECTOR_CrossProduct proc uses ebx pInputVect<br />local vtemp&#58;VECTOR<br />    fld &#91;ecx&#93;.VECTOR.x  ;&lt;-- Copy &quot;this&quot; vector's xyz values<br />    fld &#91;ecx&#93;.VECTOR.y  ;&lt;-- into a temporary vector<br />    fld &#91;ecx&#93;.VECTOR.z<br />    fstp vtemp.z<br />    fstp vtemp.y<br />    fstp vtemp.x<br /><br />    mov ebx,pInputVect<br /><br />    fld &#91;ebx&#93;.VECTOR.y      ;&lt;-- x = vect.y * temp.z - vect.z * temp.y;<br />    fmul vtemp.z<br />    fld &#91;ebx&#93;.VECTOR.z<br />    fmul vtemp.y<br />    fsub<br />    fstp &#91;ecx&#93;.VECTOR.x<br /><br />    fld &#91;ebx&#93;.VECTOR.z      ;&lt;-- y = vect.z * temp.x - vect.x * temp.z;<br />    fmul vtemp.x<br />    fld &#91;ebx&#93;.VECTOR.x<br />    fmul vtemp.z<br />    fsub<br />    fstp &#91;ecx&#93;.VECTOR.y<br /><br />    fld &#91;ebx&#93;.VECTOR.x      ;&lt;-- z = vect.x * temp.y - vect.y * temp.x;<br />    fmul vtemp.y<br />    fld &#91;ebx&#93;.VECTOR.y<br />    fmul vtemp.x<br />    fsub<br />    fstp &#91;ecx&#93;.VECTOR.z<br />    ret<br />VECTOR_CrossProduct endp<br /><br />VECTOR_GetLength proc<br />    fld    &#91;ecx&#93;.VECTOR.x<br />    fmul &#91;ecx&#93;.VECTOR.x<br />    fld    &#91;ecx&#93;.VECTOR.y<br />    fmul &#91;ecx&#93;.VECTOR.y<br />    fld    &#91;ecx&#93;.VECTOR.z<br />    fmul &#91;ecx&#93;.VECTOR.z<br />    fadd<br />    fadd<br />    fsqrt<br />    ret<br />VECTOR_GetLength endp<br /><br />VECTOR_Subtract proc uses ebx pOtherVector<br />mov ebx, pOtherVector<br />fld    &#91;ecx&#93;.VECTOR.x<br />fsub &#91;ebx&#93;.VECTOR.x<br />fstp  &#91;ecx&#93;.VECTOR.x<br />fld    &#91;ecx&#93;.VECTOR.y<br />fsub &#91;ebx&#93;.VECTOR.y<br />fstp  &#91;ecx&#93;.VECTOR.y<br />fld    &#91;ecx&#93;.VECTOR.z<br />fsub &#91;ebx&#93;.VECTOR.z<br />fstp  &#91;ecx&#93;.VECTOR.z<br />ret<br />VECTOR_Subtract endp<br /><br />VECTOR_Add proc uses ebx pOtherVector<br />mov ebx, pOtherVector<br />fld    &#91;ecx&#93;.VECTOR.x<br />fadd &#91;ebx&#93;.VECTOR.x<br />fstp  &#91;ecx&#93;.VECTOR.x<br />fld    &#91;ecx&#93;.VECTOR.y<br />fadd &#91;ebx&#93;.VECTOR.y<br />fstp  &#91;ecx&#93;.VECTOR.y<br />fld    &#91;ecx&#93;.VECTOR.z<br />fadd &#91;ebx&#93;.VECTOR.z<br />fstp  &#91;ecx&#93;.VECTOR.z<br />ret<br />VECTOR_Add endp<br /><br />VECTOR_Multiply proc uses ebx pOtherVector<br />mov ebx, pOtherVector<br />fld    &#91;ecx&#93;.VECTOR.x<br />fmul &#91;ebx&#93;.VECTOR.x<br />fstp  &#91;ecx&#93;.VECTOR.x<br />fld    &#91;ecx&#93;.VECTOR.y<br />fmul &#91;ebx&#93;.VECTOR.y<br />fstp  &#91;ecx&#93;.VECTOR.y<br />fld    &#91;ecx&#93;.VECTOR.z<br />fmul &#91;ebx&#93;.VECTOR.z<br />fstp  &#91;ecx&#93;.VECTOR.z<br />ret<br />VECTOR_Multiply endp<br /><br />VECTOR_MultiplyFPU proc<br />local ftemp&#58;REAL8<br />fstp ftemp<br />fld    &#91;ecx&#93;.VECTOR.x<br />fmul ftemp<br />fstp  &#91;ecx&#93;.VECTOR.x<br />fld    &#91;ecx&#93;.VECTOR.y<br />fmul ftemp<br />fstp  &#91;ecx&#93;.VECTOR.y<br />fld    &#91;ecx&#93;.VECTOR.z<br />fmul ftemp<br />fstp  &#91;ecx&#93;.VECTOR.z<br />ret<br />VECTOR_MultiplyFPU endp<br /><br />VECTOR_DivideFPU proc<br />local ftemp&#58;REAL8<br />fstp ftemp<br />fld    &#91;ecx&#93;.VECTOR.x<br />fdiv ftemp<br />fstp  &#91;ecx&#93;.VECTOR.x<br />fld    &#91;ecx&#93;.VECTOR.y<br />fdiv ftemp<br />fstp  &#91;ecx&#93;.VECTOR.y<br />fld    &#91;ecx&#93;.VECTOR.z<br />fdiv ftemp<br />fstp  &#91;ecx&#93;.VECTOR.z<br />ret<br />VECTOR_DivideFPU endp<br /><br />VECTOR_SetLength proc  fl&#58;REAL4<br />local flen&#58;REAL8<br />    ; GLfloat len = sqrt&#40;v.x*v.x + v.y*v.y + v.z*v.z&#41;;	<br />    icall ecx, VECTOR, GetLength<br />    fstp flen<br /><br />    ;v.x *= l/len;<br />    ;v.y *= l/len;<br />    ;v.z *= l/len;<br />    fld fl<br />    fdiv flen<br />    fmul &#91;ecx&#93;.VECTOR.x<br />    fstp  &#91;ecx&#93;.VECTOR.x<br />    fld fl<br />    fdiv flen<br />    fmul &#91;ecx&#93;.VECTOR.y<br />    fstp  &#91;ecx&#93;.VECTOR.y<br />    fld fl<br />    fdiv flen<br />    fmul &#91;ecx&#93;.VECTOR.z<br />    fstp  &#91;ecx&#93;.VECTOR.z<br />    ret<br />VECTOR_SetLength endp<br /><br />VECTOR_Wedge proc uses eax ebx pOtherVector, pResultVector<br />mov ebx,pOtherVector<br />mov eax,pResultVector<br /><br />fld    &#91;ecx&#93;.VECTOR.y       ; result.x = &#40;v1.y * v2.z&#41; - &#40;v2.y * v1.z&#41;;<br />fmul &#91;ebx&#93;.VECTOR.z<br />fld    &#91;ebx&#93;.VECTOR.y<br />fmul &#91;ecx&#93;.VECTOR.z<br />fsub<br />fstp  &#91;eax&#93;.VECTOR.x<br /> <br />fld    &#91;ecx&#93;.VECTOR.z       ; result.y = &#40;v1.z * v2.x&#41; - &#40;v2.z * v1.x&#41;;<br />fmul &#91;ebx&#93;.VECTOR.x<br />fld    &#91;ebx&#93;.VECTOR.z<br />fmul &#91;ecx&#93;.VECTOR.x<br />fsub<br />fstp  &#91;eax&#93;.VECTOR.y<br /><br />fld    &#91;ecx&#93;.VECTOR.x       ; result.z = &#40;v1.x * v2.y&#41; - &#40;v2.x * v1.y&#41;;<br />fmul &#91;ebx&#93;.VECTOR.y<br />fld    &#91;ebx&#93;.VECTOR.x<br />fmul &#91;ecx&#93;.VECTOR.y<br />fsub<br />fstp  &#91;eax&#93;.VECTOR.z<br /><br />ret<br />VECTOR_Wedge endp<br /><br />VECTOR_Normalize proc<br />            icall ecx, VECTOR, Magnitude           ; Get the magnitude of our normal<br /><br />; Now that we have the magnitude, we can divide our normal by that magnitude.<br />; That will make our normal a total length of 1.  This makes it easier to work with too.<br />        icall ecx, VECTOR, DivideFPU<br />        ret<br />VECTOR_Normalize endp<br /><br /><br /><br /><br /></code></pre></div>
    <div class="meta">Posted on 2005-03-07 02:46:11 by Homer</div>
   </div>
   <div class="post" id="post-159295">
    <div class="subject"><a href="#post-159295">Re: ATC VECTOR class for 3D Vector math</a></div>
    <div class="body">Awesome class man,</div>
    <div class="meta">Posted on 2005-04-26 02:09:04 by Rain Dog</div>
   </div>
   <div class="post" id="post-159382">
    <div class="subject"><a href="#post-159382">Re: ATC VECTOR class for 3D Vector math</a></div>
    <div class="body">But shouldn&#39;t the class be &quot;non-virtual&quot; ?<br />class VECTOR, ,non-virtual</div>
    <div class="meta">Posted on 2005-04-28 23:22:45 by Ultrano</div>
   </div>
   <div class="post" id="post-159409">
    <div class="subject"><a href="#post-159409">Re: ATC VECTOR class for 3D Vector math</a></div>
    <div class="body">Yes it should, but I wrote it for ATC version 32.<br />If I&#39;m not mistaken, non-virtual support appears in version 34.<br />By the way, did you include my hcall macro? This is the class which inspired me to write it, as its handy to declare temp vec3&#39;s as locals.<br /><br /><br /></div>
    <div class="meta">Posted on 2005-04-30 05:27:04 by Homer</div>
   </div>
   <div class="post" id="post-159410">
    <div class="subject"><a href="#post-159410">Re: ATC VECTOR class for 3D Vector math</a></div>
    <div class="body">I didn&#39;t include it - I had an idea on how to enhance the hcall and pcall macros - but I didn&#39;t find time to upgrade them :| . I&#39;ll include your hcall in ATC and reupload it at www.ultrano.com/ilix&nbsp; &nbsp; now. </div>
    <div class="meta">Posted on 2005-04-30 06:07:22 by Ultrano</div>
   </div>
  </div>
 </body>
</html>