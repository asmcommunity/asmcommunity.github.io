<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Run executable from memory - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=15479" />
    <link rel="next" href="../?id=15479&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=15479">Run executable from memory</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=15479&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=15479&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="15479" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=15479&amp;page=2">&gt;</a><a href="../?id=15479&amp;page=2">&raquo;</a></form>   <div class="post" id="post-120305">
    <div class="subject"><a href="#post-120305">Run executable from memory</a></div>
    <div class="body">Is it possible to run an executable from memory, is a question that has turned up several times on the board. With intent to find out if it is possible i have made a deep dive in the process of creating a process. The attachment is the result of creating a process from a file on the disk. Normaly you start it with kernel API CreateProcess. The code only works on win2K.<br /><br />I have turned the code out and in and came to the conclusion that it is <strong>not</strong> possible to run an executable from memory. You have to use the nativ API NtCreateSection to map the file into memory and the only way to do that is via a disk file.<br /><br />If someone has another opinion please tell me. Feel free to play about with the code to try to map from memory.<br /><br />Best regards</div>
    <div class="meta">Posted on 2003-10-02 14:58:45 by minor28</div>
   </div>
   <div class="post" id="post-120306">
    <div class="subject"><a href="#post-120306">Run executable from memory</a></div>
    <div class="body">im sure its possible, it just requires a fair bit of work</div>
    <div class="meta">Posted on 2003-10-02 15:17:20 by evlncrn8</div>
   </div>
   <div class="post" id="post-120405">
    <div class="subject"><a href="#post-120405">Run executable from memory</a></div>
    <div class="body">Hi minor28, when I'm right you have to get rid from the PE-Format fist, bevor you can run it.<br />When the pure source leaded in the memory it might be possible let it run with the MP instruction. - Am I right ?<br /><br />Greets</div>
    <div class="meta">Posted on 2003-10-03 15:13:25 by Bubu-Boy</div>
   </div>
   <div class="post" id="post-120407">
    <div class="subject"><a href="#post-120407">Run executable from memory</a></div>
    <div class="body">I think it should be possible under Win9X, since you can access ring-0 and tweak anything you want. Under NT or XP, though, there are more restrictions. Since I don't know much about how NT based versions work, I'd rather trust minor28's opinion... if there is no native API call to create a process without disk access, it can't be done.<br /><br />However, you could always create a temporary file, write to it, and then create the process... but that would be cheating :grin:<br /><br />EDIT: Perhaps there is a way using handle -1 (paging file). Are there any native calls to create a section from a file mapping handle rather than a file handle?</div>
    <div class="meta">Posted on 2003-10-03 15:25:51 by QvasiModo</div>
   </div>
   <div class="post" id="post-120408">
    <div class="subject"><a href="#post-120408">Run executable from memory</a></div>
    <div class="body">if you strip of the PE header then you wont know where the OEP is... <br /><br />also you loose the memory rights to the program... <br /><br />also you will loos where the date ,code and other sections are located...<br /><br />so just for that you would have to record everything or store the header some where..<br /><br /><br />after that you have to adjust the import table and any other parts of the code that call jmp dword ptr...<br /><br />which can be a pain...<br /><br />what most people are looking for is a way to properly load the exe into memory so that it has its own heap and stack and so that it can be executed with out code modding..<br /><br />oh and a side note... the memory access of a file on xp can befully write able and execute able with out messing up the program but on win 9x you are not allowed to in all areas...<br /><br />this is true because i made a WriteProcessMemory Replacement and i originally got the file size and unprotected the whole exe in memory... xp had no problems but win 98 se did..</div>
    <div class="meta">Posted on 2003-10-03 15:29:45 by devilsclaw</div>
   </div>
   <div class="post" id="post-120415">
    <div class="subject"><a href="#post-120415">Run executable from memory</a></div>
    <div class="body">Hi devilsclaw - thats sounds interisting.<br />Perhaps you upload your code. - I would like to test it to.<br /><br />Greets Bubu-Boy</div>
    <div class="meta">Posted on 2003-10-03 15:50:01 by Bubu-Boy</div>
   </div>
   <div class="post" id="post-120417">
    <div class="subject"><a href="#post-120417">Run executable from memory</a></div>
    <div class="body">well the theory would be (not sure this would be as easy for an exe but should work for a dll)...<br /><br />virtualalloc memory block of the size of the image (from the pe header)<br />build up the image in the virtualalloc mem block from the section information<br />find the iat, and fill the imports, use the .reloc information in the dll to rebase<br />the image you have now loaded in memory patching the va's it lists with the base<br />adjustment (using the virtualalloc mem block start as the base), that should<br />in theory work, the only downside is that possibly loading resources mightnt work<br />but code should... also remember to virtualprotect the sections (after doing all the work above) to the states specified in the section info from the pe header, then<br />call the entrypoint with the 3 parameters typical for dll_process_attach... for an<br />exe its slightly trickier but im sure its doable, regardless of the system being 9x or 2k/xp/nt, and i really dont think you'd have to use ring 0 for it either, if the system can do it, why cant you? ;).. again, for an exe it'd require a different strategy<br /><br />might try and do some code for it later on after i've finished my current project</div>
    <div class="meta">Posted on 2003-10-03 16:36:45 by evlncrn8</div>
   </div>
   <div class="post" id="post-120497">
    <div class="subject"><a href="#post-120497">Run executable from memory</a></div>
    <div class="body">But maybe you do need ring-0... after all, the kernel runs in that ring. And under Win9X, the kernel runs on ring-3 but it can access ring-0 anytime with VxD or other means, so we have no guarantee that a full PE loader can be implemented in ring-3. By full I mean resources working, and all that.<br />However, there ould be a way to efficiently simulate it... maybe with some heavy API hooks it can be done reasonably well.</div>
    <div class="meta">Posted on 2003-10-04 11:24:44 by QvasiModo</div>
   </div>
   <div class="post" id="post-120555">
    <div class="subject"><a href="#post-120555">Run executable from memory</a></div>
    <div class="body">I have tryed virtual allocated memory and global allocated memory with the expanded image. Not working. The nearest I have come is the attached example (this has been on the board this summer) <br /><br />The dialog.exe reside as as rcdata resource in the EXERES app. From loaded resource the dialog image is expanded into a global allocated memory. EXERES then pushes the parameters for WriteProcessMemory and pushes the returnaddress to the entrypoint of the dialog.exe. Next a jump to kernel function WriteProcessMemory. The function replaces the EXERES code in process memory with the dialog.exe code. The return goes to entrypoint of dialog.exe. The dialog.exe starts executing but the dialog never shows up. I suppose the exe is not properly registrated. You can't fool windows.<br /><br />I think I have tryed the most. You can't run an exe from memory. If someone has another opinion then prove it.<br /><br />Best regards</div>
    <div class="meta">Posted on 2003-10-05 13:23:25 by minor28</div>
   </div>
   <div class="post" id="post-120653">
    <div class="subject"><a href="#post-120653">Run executable from memory</a></div>
    <div class="body">hi,<br /><br />if the file dont have resources, it can be done without problems. <br /><br />you will have the code running normally, but the 'new' process dont exists to windows - its just a program running a new thread in allocated memory.<br /><br />ancev</div>
    <div class="meta">Posted on 2003-10-06 20:21:58 by ancev</div>
   </div>
   <div class="post" id="post-120895">
    <div class="subject"><a href="#post-120895">Run executable from memory</a></div>
    <div class="body">this has all been discussed before, more than one time.<br /><br />As ancev says, as long as the exe doesn't have resources (and a couple things that are not so standard), it's pretty easy to execute a PE yourself - but it will not appear as a new process and there's all sorts of catches.<br /><br />If you find a non-dirty/ring0 (use of NT Native API accepted, though) way to more properly run a piece of code from memory (ie, create a new process), don't hesitate to post info =)</div>
    <div class="meta">Posted on 2003-10-09 16:35:56 by f0dder</div>
   </div>
   <div class="post" id="post-120933">
    <div class="subject"><a href="#post-120933">Run executable from memory</a></div>
    <div class="body">Yes f0dder, I know the item has been on the board several times before but I wouldn't say discussed. What I have seen is questions if it is possible and answers that you have to code your own PE-loader, jump table problems and so on. No really constructive discussion how to create a new process from an memory image.<br /><br />The subject is interesting. I am now in kernel-mode trying to find out the secrecy of creating a new process. As you know documentation is insufficient and I have a lot to learn. <br /><br />I take it that the key between an exe image and its process is the mapping by create section.<br /><br />I have seen the expressions &quot;non-dirty&quot; and &quot;dirty&quot; before. What does &quot;non-dirty&quot; and &quot;dirty&quot; mean? I don't want to post dirty things.<br /><br />Best regards</div>
    <div class="meta">Posted on 2003-10-10 01:05:10 by minor28</div>
   </div>
   <div class="post" id="post-121032">
    <div class="subject"><a href="#post-121032">Run executable from memory</a></div>
    <div class="body">minor28,<br /><br />take a look in elicz site... maybe you can discover how create a process taking a look in how he create remote thread<br /><br />ancev</div>
    <div class="meta">Posted on 2003-10-10 17:52:55 by ancev</div>
   </div>
   <div class="post" id="post-121100">
    <div class="subject"><a href="#post-121100">Run executable from memory</a></div>
    <div class="body">Ok, I will have a look at elicz site.<br /><br />Now I have moved the Create Section procedure from user-mode to kernel-mode. The Create Section procedure is executed in CrSec.sys<br /><br />Regards<br /><br />edit: I still don't know what &quot;non-dirty&quot; means.</div>
    <div class="meta">Posted on 2003-10-11 15:57:38 by minor28</div>
   </div>
   <div class="post" id="post-121125">
    <div class="subject"><a href="#post-121125">Run executable from memory</a></div>
    <div class="body">&quot;dirty&quot; means that it's not reliable, in other words that it could be changed by Microsoft in any patch. So non-dirty means using only official API's and semi-official API's like the NT native API (Microsoft can't change this because some programs by other people depend on them).</div>
    <div class="meta">Posted on 2003-10-12 07:52:58 by Qweerdy</div>
   </div>
   <div class="post" id="post-121436">
    <div class="subject"><a href="#post-121436">Run executable from memory</a></div>
    <div class="body">As matters now stand I have done following.<br /><br />A. RUNNING FROM DISK<br /><br />In user mode:<br />1. Loading a file object attribute structure with data<br />2. Creating a driver service passing data needed for open file function.<br /><br />In kernel mode:<br />3. Retrieving file handle by calling ntoskrn.exe!ObOpenObjectByName. I have not succeeded with the ObDereferenceObject function but it works without. Is it important with this function?<br />4. Passing the file handle to user mode<br /><br />In user mode:<br />5. Create section and so on till the exe is running.<br /><br />This works.<br /><br /><br />Now my intention was to switch ObOpenObjectByName to ObOpenObjectByPointer.<br /><br />B. RUNNING FROM MEMORY<br /><br />In user mode:<br />1. Open the exe file<br />2. Allocate memory<br />3. Read exe file into memory giving a pointer to address of MZ<br />4. Creating a driver service passing pointer<br /><br />In kernel mode:<br />5. Calling ntoskrn.exe!ObOpenObjectByPointer<br /><br />The return value is STATUS_OBJECT_TYPE_MISMATCH.<br />This indicates that it is not possible to create an object from memory but I am not sure yet.<br /><br />I would appraciate id?as.<br /><br />Regards</div>
    <div class="meta">Posted on 2003-10-15 13:57:25 by minor28</div>
   </div>
   <div class="post" id="post-121454">
    <div class="subject"><a href="#post-121454">Run executable from memory</a></div>
    <div class="body">Hi minor28<br /><br />&gt; ObOpenObjectByName to ObOpenObjectByPointer.<br />&gt;5. Calling ntoskrn.exe!ObOpenObjectByPointer<br />&gt;The return value is STATUS_OBJECT_TYPE_MISMATCH.<br /><br />I'm not sure but the problem here might be one that occurs when dealing with several kernel functions which require a pointer to an OBJECT (be it thread, event, mutex...), rather than a HANDLE, which is what is generally returned with several other kernel functions that actually *create* the thread, event, mutex...<br /><br />To convert the Handle to a Object you need to call ObReferenceObjectByHandle.<br />ObReferenceObjectByHandle increments the reference count of the object, so requires ObDereferenceObject to lower it's reference count when finished with it.<br /><br />I'm not sure about your ObOpenObjectByName, but it may also return a handle, and ObOpenObjectByPointer requires an object pointer I believe.<br /><br /><br />I've had to do this for both Events and Threads. For example, a convenient way of synchronizing communication between a user app and driver thread (remote or otherwise) is to use a Named Event using IoCreateNotificationEvent. This function returns an event HANDLE, but to use the event in other functions you need to convert it to a direct OBJECT pointer with ObReferenceObjectByHandle first. i.e.<br /><br /><pre><code>&#91;size=12&#93;<br />invoke RtlInitUnicodeString, offset pUNICODE_STRING, offset EventName<br />invoke IoCreateNotificationEvent, offset pUNICODE_STRING, offset EventHandle<br />invoke ObReferenceObjectByHandle, &#91;EventHandle&#93;, EVENT_ALL_ACCESS,\<br />                  NULL, KernelMode, offset pEventObject, NULL<br /><br />; we've converted an EventHandle to an EventObject,<br />; now it can be used in other functions...<br /><br />; &#40;if you don't need the handle you can delete it since we<br />; have a pointer to the actual object structure now&#41;<br />; invoke ZwClose, &#91;EventHandle&#93;    ; &#40;will call ObDereferenceObject&#41;<br /><br />; IoCreateNotificationEvent creates an event in the signalled state,<br />; set it to unsignalled<br />invoke KeInitializeEvent, &#91;pEventObject&#93;, NotificationEvent, FALSE<br /><br />;...<br /><br />; elsewhere we can wait for the Event to be signalled from user<br />; mode with OpenEvent / SetEvent...<br />; &#40;note that driver created named events must be placed in the<br />; system directory \BaseNamedObjects\&lt;eventname&gt;  to match<br />; any User event name &#40;automatically placed in that directory&#41;&#41;<br /><br /><br />;...in a PsCreateSystemThread created thread far, far away...<br />invoke KeReadStateEvent, _pEventObject ; returns 0 = non-signalled<br /><br />; Wait indefinitely for User mode to wake up this thread by<br />; signalling event...<br />invoke KeWaitForSingleObject, _pEventObject, Executive, \<br />                                          KernelMode, TRUE, NULL<br /><br />; after returning, event is in signalled state <br />invoke KeReadStateEvent, _pEventObject ; returns 1 = signalled<br /><br />;...<br /><br />invoke ObDereferenceObject, _pEventObject<br /><br />;&#40;PsTerminateSystemThread required if thread created<br />; in system context&#41; <br />&#91;/SIZE&#93; </code></pre><br /><br />You might also go through the same process with threads of converting a thread handle to a thread object pointer if you wanted to use a function such as KeSetPriorityThread for example. <br /><br /><br />DO make sure you call ObDereferenceObject wherever necessary to avoid memory leaks.  The system *might* clean up for you but I've had some slow lockups while developing that might be tied to this. I believe ObDereferenceObject returns the current reference count, but I haven't been able to see it de-reference down to '0', the current reference count in various places in my code seems higher than I would have expected by any associated calls to ObReferenceObjectByHandle or prior creation calls.<br /><br />As a side-bar to this, there is an undocumented function called ObGetObjectPointerCount that also returns the current reference count on an object (matches that returned by ObDereferenceObject). However, I could not directly Invoke the function ObGetObjectPointerCount and had to call its address directly by using MmGetSystemRoutineAddress first.<br /><br />Good luck with this, it will be interesting to see the results.<br /><br />Regards,<br />Kayaker</div>
    <div class="meta">Posted on 2003-10-15 23:56:59 by Kayaker</div>
   </div>
   <div class="post" id="post-121694">
    <div class="subject"><a href="#post-121694">Run executable from memory</a></div>
    <div class="body">Hi<br /><br />ObOpenObjectByName makes an internal call to ObReferenceObjectByHandle thus you have to decrement the reference count. Earlier the return value of ObReferenceObjectByHandle was -1h which I assumed was an error. Now it returns 1. I don't know if it's a succees or error. Most kernel mode functions return 0 (equ STATUS_SUCCESS)at success. 1 could be &quot;ERROR_INVALID_FUNCTION&quot;.<br /><br />This is a function in CrSec.sys:<br /><pre><code>_GetHandleFromName proc uses ebx esi edi FileHandleAddr&#58;dword,DesiredAccess&#58;dword,\<br />	oaAddr&#58;dword,iosbAddr&#58;dword,namesize&#58;dword<br /><br />	LOCAL FO&#58;FILE_OBJECT<br />	LOCAL filehandle&#58;dword<br /><br />	mov FO._Type,IO_TYPE_OPEN_PACKET<br />	mov FO._Size,50h<br />	mov FO.FileName._Length,0 <br />	mov FO.FileName.Buffer,1<br />	<br />	lea eax,filehandle<br />	push eax			;File handle <br />	lea eax,FO<br />	push eax			;Pointer to File object structure <br />	push DesiredAccess		;Desired access<br />	push KernelMode		;Access mode &#40;not sure. KernelMode=0&#41;<br />	push 0				;Object type &#40;nor sure&#41;<br />	push FILE_ANY_ACCESS	;Access state &#40;nor sure. FILE_ANY_ACCESS=0&#41;<br />	push oaAddr		;Pointer to object attributes <br />	call ObOpenObjectByName<br />	.if eax==0<br />		mov eax,filehandle<br />		mov ecx, FileHandleAddr<br />		mov &#91;ecx&#93;,eax<br />		push FO.DeviceObject<br />		call ObDereferenceObject<br />	.endif<br />	ret<br /><br />_GetHandleFromName  endp</code></pre><br />I haven't found any documentation so I have tryed a lot. First I'm not sure FILE_OBJECT is the correct sturcture. FO._Size only works with the value 50h no matter which exe file is started. I can understand the FO.FileName._Length equ 0, but not why FO.FileName.Buffer must be 1. I am also unsure about the second, third and fourth argument. All are 0 so it doesn't matter. However the function delivers a file handle and the exe i running.<br /><br />Now to the try to execute from memory.<br /><br />Swithing commenting of lines 161-166 to lines 155-159 in CreateProcess.asm and lines 134-139 to 127-131 in CrSec.asm turns CreateProcess.exe to start Dialog.exe from memory.<br /><br />This is a function in CrSec.sys:<br /><pre><code>_GetHandleFromPointer proc uses ebx esi edi FileHandleAddr&#58;dword,DesiredAccess&#58;dword,\<br />	oaAddr&#58;dword,iosbAddr&#58;dword,pMem&#58;dword<br /><br />	LOCAL FO&#58;FILE_OBJECT<br />	LOCAL filehandle&#58;dword<br /><br />	mov FO._Type,IO_TYPE_OPEN_PACKET<br />	mov FO._Size,50h<br />	mov FO.FileName._Length,0 <br />	mov FO.FileName.Buffer,1<br />	mov eax,pMem<br />	mov FO.SectionObjectPointer,eax<br />	<br />;	lea eax,filehandle<br />;	push eax 			;File handle <br />;	push KernelMode		;Access mode<br />;	push 0				;Object type<br />;	push DesiredAccess		;Desired access<br />;	push FILE_ANY_ACCESS	;Access state<br />;	push 0			;Flags<br />;	lea eax,FO<br />;	push eax 			;Pointer to object structure<br /><br />	lea eax,filehandle<br />	push eax			;File handle <br />	lea eax,FO<br />	push eax			;Pointer to File object structure <br />	push DesiredAccess		;Desired access<br />	push KernelMode		;Access mode &#40;not sure. KernelMode=0&#41;<br />	push 0				;Object type &#40;nor sure&#41;<br />	push FILE_ANY_ACCESS	;Access state &#40;nor sure. FILE_ANY_ACCESS=0&#41;<br />	push oaAddr		;Pointer to object attributes <br />	call ObOpenObjectByPointer<br />	.if eax==0<br />		mov eax,filehandle<br />		mov ecx, FileHandleAddr<br />		mov &#91;ecx&#93;,eax<br />		push FO.DeviceObject<br />		call ObDereferenceObject<br />	.endif<br /><br />	ret<br /><br />_GetHandleFromPointer endp</code></pre><br />The commented argument are as I have found them from an article on a Google seach. But whatever I do it will crach, not a blue screen but rebooting. The same arguments as ..ByName gives a return value of &quot;STATUS_OBJECT_TYPE_MISMATCH&quot;.<br /><br />Now I have got stuck and would be glad for suggestions.<br /><br />Best regards.</div>
    <div class="meta">Posted on 2003-10-18 16:42:24 by minor28</div>
   </div>
   <div class="post" id="post-121723">
    <div class="subject"><a href="#post-121723">Run executable from memory</a></div>
    <div class="body">Hi<br /><br />There does seem to be some confusion with the definition of ObOpenObjectByPointer.  This may help, it is defined as the following in <br />Building NT File System Drivers, A Developer's Guide, O'Reilly. Rajeev Nagar<br /><br /><pre><code>&#91;size=12&#93;<br />In the description of the ZwCreateSection&#40;&#41; routine, I mentioned the existence<br />of an Object Manager routine that can be used to obtain a handle to an object<br />in the context of any arbitrary process, given a pointer to that object.<br />This routine is called ObOpenObjectByPointer&#40;&#41; and is defined as follows&#58;<br /><br />NTSTATUS<br />ObOpenObjectByPointer&#40;<br />IN PVOID Object,<br />IN ULONG HandleAttributes,<br />IN PACCESS_STATE PassedAccessState OPTIONAL,<br />IN ACCESS_MASK DesiredAccess OPTIONAL,<br />IN POBJECT_TYPE ObjectType OPTIONAL,<br />IN KPROCESSOR_MODE AccessMode,<br />OUT PHANDLE Handle<br />&#41; ;<br /><br />Typically, you can pass in NULL for PassedAccessState and for<br />the ObjectType. Be careful to request only the type of access in<br />the DesiredAccess argument permitted by the original open operation<br />&#40;from which you obtained a pointer to the object&#41;. The HandleAttributes<br />can be obtained from the previous invocation to<br />ObReferenceObjectByHandle&#40;&#41;. That routine returns Handlelnformation,<br />which in turn contains the returned Handle-Attributes.<br /><br />There is also a routine called ObReferenceObjectByPointer&#40;&#41;,<br />which simply increments the object reference count for the<br />specified object. This function is defined in the Windows NT IPS kit<br />as follows&#58;<br /><br />NTSTATUS<br />ObReferenceObjectByPointer&#40;<br />IN PVOID Object,<br />IN ACCESS_MASK DesiredAccess OPTIONAL,<br />IN POBJECT_TYPE ObjectType OPTIONAL,<br />IN KPROCESSOR_MODE AccessMode, &#125;;<br />&#91;/size&#93;</code></pre>   <br /><br />I might be off base here but one thing I noticed with your code, if I'm reading it right, is about using the pMem location of the MZ header (this is a pointer to SECTION_OBJECT_POINTERS I believe?) in a Locally declared FILE_OBJECT structure as opposed to a Global one.  From this you generate a FileHandle by using either ObOpenObjectByName or ObOpenObjectByPointer which is used back in usermode by NtCreateSection, then immediately deleted. The FileHandle identifies the file from which to create the section object (the executable image).<br /><br />Since memory locations of LOCAL variables can be overwritten once out of the proc, even if this is in kernel mode, it seems to me the Section object defined by the FILE_OBJECT structure (and which the FileHandle refers to), may be invalid, both in permanency and perhaps in context. Handles can come and go, but I would think the underlying object must be a permanent structure for its lifetime.<br /><br />If you are running your created section image from disk (the successful part), is the FileHandle actually necessary with NtCreateSection?, or does it simply act as if the FileHandle is zero (as defined) - the VMM creates a section object backed by the paging file (piece of shared memory) rather than by a named file in the file system.<br /><br />Cheers,<br />Kayaker</div>
    <div class="meta">Posted on 2003-10-19 01:10:37 by Kayaker</div>
   </div>
   <div class="post" id="post-121862">
    <div class="subject"><a href="#post-121862">Run executable from memory</a></div>
    <div class="body">Hi Kayaker<br /><br />Thanks for your help. The parameters of the ObOpenObjectByPointer is similar to the one I found on the Google seach. However I follow the advice in the quoted text. I replace the two CrSec functions __GetHandleFromName and _GetHandleFromPointer with following function.<br /><pre><code>_GetHandle proc uses ebx esi edi FileHandleAddr&#58;dword,DesiredAccess&#58;dword,\<br />				handle&#58;dword,obj&#58;dword<br /><br />	LOCAL hi&#91;8&#93;&#58;dword ;Reservation of sufficient memory for HandleInformation struct<br />	LOCAL pObject&#58;dword<br />	LOCAL filehandle&#58;dword<br /><br />	lea eax,hi<br />	push eax			;OUT HandleInformation OPTIONAL<br />	lea eax,pObject<br />	push eax			;OUT *Object<br />	push KernelMode		;IN AccessMode<br />	push 0				;IN ObjectType  OPTIONAL<br />	push 0				;IN DesiredAccess<br />	push handle			;IN Handle<br />	call ObReferenceObjectByHandle<br />	.if eax==0<br />		mov eax,pObject<br />		mov ecx,obj<br />		mov &#91;ecx&#93;,eax<br />		lea eax,filehandle<br />		push eax			;OUT Handle<br />		push KernelMode		;IN AccessMode,<br />		push 0				;IN ObjectType OPTIONAL,<br />		push DesiredAccess	;IN DesiredAccess OPTIONAL,<br />		push 0				;IN PassedAccessState OPTIONAL<br />		push hi				;IN HandleAttributes<br />		push pObject		;IN Object<br />		call ObOpenObjectByPointer<br />		.if eax==0<br />			mov eax,filehandle<br />			mov ecx, FileHandleAddr<br />			mov &#91;ecx&#93;,eax<br />			push pObject<br />			call ObDereferenceObject<br />		.endif<br />	.endif<br />	ret<br /><br />_GetHandle  endp</code></pre>. This function can be used for both disk file and memory file. First part, the call to ObReferenceObjectByHandle (DesiredAccess is insignificant) gives the pointer to the object, The second part ObOpenObjectByPointer (DesiredAccess is important) gives the correct value of the filehandle. The third part ObDereferenceObject decrement the reference counter. Perhaps you have to decrement twice because the two firs calls each increment the reference counter. I haven't found the structure of the Handle Information thus I reservate 8 dwords of memory (Any one know?).<br /><br />To run the executable from disk still succeeds. If you switch hFile (file handle) to hMem (handle of allocated memory) the driver delivers an object pointer of 0h and a FileHandle of 0h. The error message from NtCreateSection is STATUS_INVALID_FILE_FOR_SECTION. I have tested several combinations of access and handles. No one works.<br /><br /><div class="quote">I might be off base here but one thing I noticed with your code, if I'm reading .......... must be a permanent structure for its lifetime.</div><br />As far as I know the only thing I need is a valid FileHandle with the correct access rights. The CreateProcess pass the address of FileHandle to the driver and the driver deliver a value to the address. There is no need for an outBuffer from the driver.<br /><br /><div class="quote">If you are running your created section image from disk (the successful part), is the FileHandle actually necessary with NtCreateSection?, or does it simply act as if the FileHandle is zero (as defined) - the VMM creates a section object backed by the paging file (piece of shared memory) rather than by a named file in the file system.</div><br />The FileHandle is necessary and important. It must be a file handle with correct access rights. For example if you push hFile coded with the GENERIC_READ access the error message is STATUS_ACCESS_DENIED and a file handle of 0 the error message is STATUS_INVALID_FILE_FOR_SECTION.<br /><br />My conclusion is that object manager functions might be a wrong track. Is my conclusion right or wrong? Does somebody have any id?as or hints, let's hear it.<br /><br />I attach the revised asm-files.<br /><br />Best regards</div>
    <div class="meta">Posted on 2003-10-20 13:37:47 by minor28</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=15479&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=15479&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="15479" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=15479&amp;page=2">&gt;</a><a href="../?id=15479&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>