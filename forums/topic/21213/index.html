<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Recursive file searching - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=21213" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=21213">Recursive file searching</a></p>
   <div class="post" id="post-160549">
    <div class="subject"><a href="#post-160549">Recursive file searching</a></div>
    <div class="body">having trouble with moving into directories while searching for files<br />anyone think of a better way to search for certain file extentions?<br />or know why the code is failing<br /><pre><code><br />.386<br />.model flat,stdcall<br />option casemap:none<br />include \masm32\include\windows.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\user32.inc<br />include \masm32\include\masm32.inc<br />includelib \masm32\lib\kernel32.lib<br />includelib \masm32\lib\user32.lib<br />includelib \masm32\lib\masm32.lib<br />FindMe	&nbsp; &nbsp; PROTO :DWORD,:DWORD<br />.data<br />AppName&nbsp; &nbsp; &nbsp; &nbsp; db &#39;MP3 Lister&#39;,0<br />TheString&nbsp; &nbsp; &nbsp; db &#39;*&#39;,0<br />TheExtention&nbsp;  db &#39;*.mp3&#39;,0<br />FileCaption&nbsp; &nbsp; db &quot;The File&#39;s Name Is...&quot;,0 ;&quot;<br />FolderCaption&nbsp; db &quot;Found a folder , going in :)&quot;,0 ;&quot;<br />dirback&nbsp; &nbsp; &nbsp; &nbsp; db &quot;..&quot;,0<br /><br />.data?<br />fd&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  WIN32_FIND_DATA &lt;&gt;<br />buffer&nbsp; &nbsp; &nbsp; &nbsp;  db 256 dup(?)<br /><br />.code<br />start:<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke GetLogicalDriveStrings, 100,addr buffer ;get the current drives attached to system<br />&nbsp; &nbsp; &nbsp; &nbsp; mov edi,offset buffer&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;copy it into edi<br />DriveLoop:&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; invoke GetDriveType, edi&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;get the drive type<br />&nbsp; &nbsp; &nbsp; &nbsp; cmp eax, DRIVE_FIXED&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; see if its a HDD or cdROM Drive&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; jnz NextDrive&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;if not a fixed drive then check the next drive<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke MessageBox,0,edi,addr AppName,0&nbsp; &nbsp; &nbsp; &nbsp;  ;show the current Drive you&#39;re scanning&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; invoke FindMe,edi,addR TheString&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;start scanning it bitch<br />NextDrive: <br />&nbsp; &nbsp; &nbsp; &nbsp; add edi, 4<br />&nbsp; &nbsp; &nbsp; &nbsp; cmp byte ptr [ edi ], 0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;last drive on the list?<br />&nbsp; &nbsp; &nbsp; &nbsp; jnz&nbsp; DriveLoop&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;if not get some more bitch<br />invoke ExitProcess,NULL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;else get out fuck out of town<br /><br /><br />FindMe proc&nbsp;  Path :DWORD, filter :DWORD<br />&nbsp; LOCAL PathName[256]:byte&nbsp; ;buffer to hold the current path<br />&nbsp; LOCAL buffer1[256]:byte<br />&nbsp; LOCAL hFind&nbsp; &nbsp; :DWORD&nbsp; &nbsp;  ;file pointer to the current file <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  invoke lstrcpy, addR PathName, Path&nbsp; &nbsp; ; put initial dir to PathName<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  invoke lstrcat, addR PathName, filter&nbsp;  ; add * wildcard to PathName<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  invoke FindFirstFile, addr PathName, addr fd&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  mov hFind, eax<br />&nbsp;  <br />&nbsp;  .while eax &gt; 0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; look for &#39;.&#39;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp&nbsp; byte ptr ,&quot;.&quot;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; if &#39;.&#39;found skip them&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jz nextf<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; test fd.dwFileAttributes, FILE_ATTRIBUTE_DIRECTORY&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; check if its a dir<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jz itsafile&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;if not then jump to the file proc<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  invoke MessageBox,0,addr fd.cFileName,addr FolderCaption,0&nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  invoke SetCurrentDirectory,addr fd.cFileName&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; if so set as current dir <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  invoke GetCurrentDirectory,sizeof buffer1, addR buffer1&nbsp; &nbsp; ; save full dir name into buffer&nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  invoke FindMe,addR buffer1, filter&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; recursive call<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  invoke SetCurrentDirectory, addR dirback&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; go back <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  jmp nextf <br />itsafile:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; its a file :)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;;;;;do file extension check here;;;;;;;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;invoke lstrcmp,addr filename,fd.cFileName <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  invoke MessageBox,0,addr fd.cFileName,addr FileCaption,0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />nextf:&nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke FindNextFile, hFind, addr fd&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; next<br />&nbsp;  .endw<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke FindClose,hFind<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ret&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />FindMe endp<br />end start<br /></code></pre></div>
    <div class="meta">Posted on 2005-05-28 21:19:11 by illwill</div>
   </div>
   <div class="post" id="post-160578">
    <div class="subject"><a href="#post-160578">Re: Recursive file searching</a></div>
    <div class="body">A couple of quick notes before I pop off for bed: your buffers are too small. You need to use <strong>MAX_PATH+1</strong> instead of <strong>256</strong>, otherwise you can get bitten pretty hard by the buffer overflow beast. Also, the lstr* functions are pretty unsafe... and since you change current directory, you should save+restore the original directory (but you can do some string concatenation instead, and avoid changing directory).<br /></div>
    <div class="meta">Posted on 2005-05-29 19:59:37 by f0dder</div>
   </div>
   <div class="post" id="post-160592">
    <div class="subject"><a href="#post-160592">Re: Recursive file searching</a></div>
    <div class="body"> :D<br />http://www.asmcommunity.net/board/index.php?topic=14133.0<br /><br />Regards,<br />Lingo</div>
    <div class="meta">Posted on 2005-05-30 05:55:53 by lingo12</div>
   </div>
  </div>
 </body>
</html>