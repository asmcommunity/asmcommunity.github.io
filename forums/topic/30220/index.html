<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Custom hash - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=30220" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=30220">Custom hash</a></p>
   <div class="post" id="post-213050">
    <div class="subject"><a href="#post-213050">Custom hash</a></div>
    <div class="body">just a question about some custom hash algorithm.<br /><br />i made 2 complete different Proc&#039;s<br />one normal and a version that is using mmx<br />i should be simple, but this algorithm is driving me nuts @!# &nbsp;:shock:<br /><br />mybe a asm diehard can point me to the right direction ?<br />i would be very happy to see what i am doing wrong &nbsp; :roll:<br /><br />the output from both the proc&#039;s gives me 8E244C8179D31E12<br />but it should be &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8E245D9679D31E12<br /><br />source html page with the sample avi file is<br />http://trac.opensubtitles.org/projects/opensubtitles/wiki/HashSourceCodes<br /><br />Thanks in advance for anyone who want to look at it.<br />jpam<br /><br />HashFormat1&nbsp;  db &quot;%.8X%.8X&quot;,0<br />HashFormat2&nbsp;  db &quot;%I64x&quot;,0<br /><br /><pre><code>Calc_Hash proc uses esi ebx edx pFile:dword<br /><br />	LOCAL hFile:dword, fSize:dword, NBR:dword, pMem:dword<br />	LOCAL Result[8]:byte<br />	<br />	invoke CreateFile,pFile,GENERIC_ALL,0,0,OPEN_EXISTING,0,0<br />	mov hFile,eax	<br />	cmp eax,INVALID_HANDLE_VALUE<br />	jz @Error<br />	<br />	invoke GetFileSize,hFile,0<br />	mov fSize,eax<br />	push eax<br />	<br />	invoke GlobalAlloc,GPTR,131072<br />	mov pMem,eax<br />	<br />	invoke ReadFile,hFile,pMem,65536,addr NBR,NULL<br />	sub fSize,65536<br />	add pMem,65536<br />	invoke SetFilePointer,hFile,fSize,NULL,FILE_BEGIN<br />	invoke ReadFile,hFile,pMem,65536,addr NBR,NULL<br />	invoke CloseHandle,hFile<br />	<br />	sub pMem,65536<br />	mov esi,pMem<br />	mov ecx,131072<br />	pop eax<br />	mov edx,eax<br /><br />	@@:<br />	add edx,<br />	add ebx,<br />	add esi,8<br />	sub ecx,8<br />	jnz @B<br />	<br />	push edx<br />	push ebx<br />	invoke wsprintf,addr Result,addr HashFormat1<br />	PrintString Result<br />	pop eax<br />	pop eax<br />	jmp @F<br />	<br />	@Error:<br />		szText error7,&quot;CreateFile error&quot;<br />		invoke MessageBox,0,addr error7,addr error7,MB_OK<br />	@@:<br />	<br />	invoke GlobalFree,pMem<br />	ret<br />	<br />Calc_Hash endp</code></pre><br /><br /><pre><code>Calc_Hash proc pFile:dword<br /><br />	LOCAL hFile:dword, NBR:dword<br />	LOCAL fSize:dword,count:dword<br />	LOCAL uint64:qword,tmp64:qword<br />	<br />	invoke CreateFile,pFile,GENERIC_ALL,0,0,OPEN_EXISTING,0,0<br />	mov hFile,eax	<br />	cmp eax,INVALID_HANDLE_VALUE<br />	jz @Error<br />	<br />	invoke GetFileSize,hFile,0<br />	movd mm0,eax<br />	mov fSize,eax	<br />	mov count,0<br />	<br />	@@:<br />	invoke ReadFile,hFile,addr uint64,8,addr NBR,NULL<br />	paddd mm0,qword ptr <br />	inc count	<br />	cmp count,8192<br />	jnz @B<br />	<br />	sub fSize,65536<br />	invoke SetFilePointer,hFile,fSize,NULL,FILE_BEGIN<br />	mov count,0<br />	<br />	@@:<br />	invoke ReadFile,hFile,addr uint64,8,addr NBR,NULL<br />	paddd mm0,qword ptr <br />	inc count	<br />	cmp count,8192<br />	jnz @B<br /><br />	movd eax,mm0<br />	push eax<br />	punpckhdq mm0,mm0<br />	movd eax,mm0<br />	push eax<br />	<br />	invoke wsprintf,addr tmp64,addr HashFormat1<br />	PrintString tmp64<br />	jmp @F<br />	<br />	@Error:<br />		szText error8,&quot;CreateFile error&quot;<br />		invoke MessageBox,0,addr error8,addr error8,MB_OK<br />	@@:<br />	<br />	invoke CloseHandle,hFile<br />	ret<br />	<br />Calc_Hash endp</code></pre><br /><br /></div>
    <div class="meta">Posted on 2010-09-06 13:21:53 by jpam</div>
   </div>
   <div class="post" id="post-213082">
    <div class="subject"><a href="#post-213082">Re: Custom hash</a></div>
    <div class="body">Problem solved !<br /><br />Thanks to Tedd<br />Upper 4 bytes must be add with carry<br /><br />correct version:<br /><br /><pre><code>Calc_Hash proc uses esi ebx edx pFile:dword, pBuf:dword<br /><br />	LOCAL hFile:dword, fSize:dword, NBR:dword, pMem:dword<br />	<br />	invoke CreateFile,pFile,GENERIC_ALL,0,0,OPEN_EXISTING,0,0<br />	mov hFile,eax	<br />	cmp eax,INVALID_HANDLE_VALUE<br />	jz @Error<br />	<br />	invoke SetFilePointer,hFile,0,NULL,FILE_END<br />	mov fSize,eax<br />	push eax<br />	<br />	invoke GlobalAlloc,GPTR,131072<br />	mov pMem,eax<br />	<br />	invoke SetFilePointer,hFile,0,NULL,FILE_BEGIN<br />	invoke ReadFile,hFile,pMem,65536,addr NBR,NULL<br />	<br />	sub fSize,65536<br />	add pMem,65536<br />	<br />	invoke SetFilePointer,hFile,fSize,NULL,FILE_BEGIN<br />	invoke ReadFile,hFile,pMem,65536,addr NBR,NULL<br />	<br />	sub pMem,65536<br />	mov esi,pMem<br />	mov ecx,131072<br />	pop eax<br />	mov edx,eax<br />	push eax<br /><br />	@@:<br />	add edx,<br />	adc ebx,<br />	add esi,8<br />	sub ecx,8<br />	jnz @B<br />	<br />	push edx<br />	push ebx<br />	invoke wsprintf,pBuf,addr HashFormat<br />	pop eax<br />	pop eax<br />	<br />	invoke CloseHandle,hFile<br />	invoke GlobalFree,pMem<br />	pop ecx<br />	<br />	@Error: ; If error eax returns (INVALID_HANDLE_VALUE)<br />	<br />	; Hash value is copied to pBuf<br />	; eax returns Movie Filesize<br />	<br />	ret<br />	<br />Calc_Hash endp</code></pre></div>
    <div class="meta">Posted on 2010-09-08 17:22:48 by jpam</div>
   </div>
  </div>
 </body>
</html>