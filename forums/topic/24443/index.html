<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>a snippet about dll - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=24443" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=24443">a snippet about dll</a></p>
   <div class="post" id="post-178540">
    <div class="subject"><a href="#post-178540">a snippet about dll</a></div>
    <div class="body">The example code is written in CBuilder,but I cannot make it in masm,please help me!<br />The .cpp is:<br /><pre><code>//---------------------------------------------------------------------------<br />#pragma hdrstop<br /><br />#include &quot;Unit1.h&quot;<br />//---------------------------------------------------------------------------<br />#pragma package(smart_init)<br />#pragma resource &quot;*.dfm&quot;<br />TForm1 *Form1;<br />//---------------------------------------------------------------------------<br />__fastcall TForm1::TForm1(TComponent* Owner)<br />&nbsp; &nbsp; &nbsp; &nbsp; : TForm(Owner)<br />{<br />}<br />char* (__stdcall *GetNumber)(int, char*);<br />int (__stdcall *GetSize)(int, char*);<br />HINSTANCE DllInst = NULL;<br />//---------------------------------------------------------------------------<br /><br />void __fastcall TForm1::Button2Click(TObject *Sender)<br />{<br />&nbsp; char* Code = &quot;012345678910&quot;;<br />&nbsp; int i;<br />&nbsp; <br />&nbsp; i = edt-&gt;Text.ToInt();<br /><br />&nbsp; if (DllInst == NULL) DllInst = LoadLibrary(&quot;Get.dll&quot;);<br />&nbsp; if (DllInst)<br />&nbsp; {<br />&nbsp; &nbsp; GetNumber = (char* (__stdcall*)(int, char*))GetProcAddress(DllInst,&quot;GetNumber&quot;);<br />&nbsp; &nbsp; GetSize = (int (__stdcall*)(int, char*))GetProcAddress(DllInst,&quot;GetSize&quot;);<br /><br />&nbsp; &nbsp; //Call GetNumber<br />&nbsp; &nbsp; Edit1-&gt;Text = GetNumber(i, Code);<br /><br />&nbsp; &nbsp; //Call GetSize<br />&nbsp; &nbsp; Edit2-&gt;Text = GetSize(i, Code);&nbsp;  <br />&nbsp; }<br />}<br />//---------------------------------------------------------------------------<br />void __fastcall TForm1::Button3Click(TObject *Sender)<br />{<br />&nbsp; Close();<br />}<br />//---------------------------------------------------------------------------<br />void __fastcall TForm1::FormClose(TObject *Sender, TCloseAction &amp;Action)<br />{<br />&nbsp; if ( DllInst ) FreeLibrary (DllInst);<br />}<br />//---------------------------------------------------------------------------</code></pre><br /><br /><br />How can I change it to MASM format, I cannot make the &quot;GetNumber = (char* (__stdcall*)(int, char*))GetProcAddress(DllInst,&quot;GetNumber&quot;);&quot; and &quot;Edit1-&gt;Text = GetNumber(i, Code);&quot; clear.</div>
    <div class="meta">Posted on 2006-03-21 21:43:04 by Eric4ever</div>
   </div>
   <div class="post" id="post-178553">
    <div class="subject"><a href="#post-178553">Re: a snippet about dll</a></div>
    <div class="body">the first statement should look like this:<pre><code>	.data<br /><br />	pfnGet	dd	?<br />	szGetFunc	db	&quot;GetNumber&quot;, 0<br /><br />	.code<br /><br />	push	offset szGetFunc<br />	push	DllInst<br />	call	GetProcAddress<br />	mov	pfnGet, eax<br /></code></pre>the second statement needs the structure offset of the &quot;Text&quot; variable, if you have access to this code in a debugger / disassembler, you need to check out the offset there. If you have it, then it will be probably:<pre><code>	push	Code<br />	push	i<br />	call	pfnGet<br /><br />	mov	ecx, Edit1<br />	mov	, eax</code></pre></div>
    <div class="meta">Posted on 2006-03-23 04:21:40 by beaster</div>
   </div>
   <div class="post" id="post-178560">
    <div class="subject"><a href="#post-178560">Re: a snippet about dll</a></div>
    <div class="body"><div class="quote"><br />the first statement should look like this:<pre><code>	.data<br /><br />	pfnGet	dd	?<br />	szGetFunc	db	&quot;GetNumber&quot;, 0<br /><br />	.code<br /><br />	push	offset szGetFunc<br />	push	DllInst<br />	call	GetProcAddress<br />	mov	pfnGet, eax<br /></code></pre>the second statement needs the structure offset of the &quot;Text&quot; variable, if you have access to this code in a debugger / disassembler, you need to check out the offset there. If you have it, then it will be probably:<pre><code>	push	Code<br />	push	i<br />	call	pfnGet<br /><br />	mov	ecx, Edit1<br />	mov	, eax</code></pre><br /></div><br /><br />beaster,<br /><br />the &quot;push&nbsp; Code&quot;&nbsp;  error:&nbsp; &nbsp; &nbsp; error A2070: invalid instruction operands<br /><br />and I use &quot;invoke	pfnGet,i,addr Code&quot;&nbsp; &nbsp; error:&nbsp;  error A2190: INVOKE requires prototype for procedure</div>
    <div class="meta">Posted on 2006-03-23 20:55:14 by Eric4ever</div>
   </div>
   <div class="post" id="post-178680">
    <div class="subject"><a href="#post-178680">Re: a snippet about dll</a></div>
    <div class="body">I tried &quot;push offset Code&quot;, it link well but run error!<br />The code is:<br /><br /><pre><code>&nbsp; .data?<br />dllInst&nbsp;  dd ?<br />i&nbsp; &nbsp; &nbsp; &nbsp;  dd ?<br />GetNumber dd ?<br />GetSize&nbsp;  dd ?<br />&nbsp; .data<br />szDll&nbsp; &nbsp; &nbsp; &nbsp; db &quot;Get.dll&quot;,0&nbsp; <br />szVerbOpen&nbsp;  db &quot;open&quot;,0<br />&nbsp; .const<br />szError&nbsp;  db &#39;Get.dll Missing!&#39;,0<br />Code&nbsp; &nbsp; &nbsp; db &#39;000000000000&#39;,0&nbsp; &nbsp; &nbsp; &nbsp;  <br />strGetNumber&nbsp; db &#39;GetNumber&#39;,0<br />strGetSize&nbsp;  db &#39;GetSize&#39;,0<br /><br />&nbsp;  invoke GetDlgItemInt,hWnd,IDC_NUM,NULL,FALSE&nbsp; &nbsp; &nbsp; ; IDC_NUM is a EDITTEXT<br />&nbsp;  mov i,eax&nbsp; <br />&nbsp;  invoke LoadLibrary,addr szDll<br />&nbsp;  .if eax<br />&nbsp; &nbsp; mov dllInst,eax<br />&nbsp; &nbsp; invoke GetProcAddress,dllInst,addr strGetNumber<br />&nbsp; &nbsp; mov GetNumber,eax<br />&nbsp; &nbsp; invoke GetProcAddress,dllInst,addr strGetSize<br />&nbsp; &nbsp; mov GetSize,eax<br />&nbsp;  .else<br />&nbsp; &nbsp; invoke MessageBox,hWnd,addr szError,NULL,MB_OK or MB_ICONWARNING<br />&nbsp;  .endif<br /><br />&nbsp; &nbsp; push Offset Code&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; push i<br />&nbsp; &nbsp; call dword ptr <br />&nbsp; &nbsp; invoke SetDlgItemText,hWnd,IDC_Edit,addr GetNumber&nbsp; &nbsp; ; IDC_Edit is a EDITTEXT(display the result)</code></pre></div>
    <div class="meta">Posted on 2006-03-27 19:11:41 by Eric4ever</div>
   </div>
   <div class="post" id="post-178684">
    <div class="subject"><a href="#post-178684">Re: a snippet about dll</a></div>
    <div class="body"><div class="quote"><br />I tried &quot;push offset Code&quot;, it link well but run error!<br />The code is:<br /><br /><pre><code><br />/ -- snip -- /<br /><br />&nbsp; .const<br />szError&nbsp;  db &#39;Get.dll Missing!&#39;,0<br />Code&nbsp; &nbsp; &nbsp; db &#39;000000000000&#39;,0&nbsp; &nbsp; &nbsp; &nbsp;  <br />strGetNumber&nbsp; db &#39;GetNumber&#39;,0<br />strGetSize&nbsp;  db &#39;GetSize&#39;,0<br /><br />/ -- snip -- /<br /><br />&nbsp; &nbsp; push Offset Code&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; push i<br />&nbsp; &nbsp; call dword ptr <br />&nbsp; &nbsp; invoke SetDlgItemText,hWnd,IDC_Edit,addr GetNumber&nbsp; &nbsp; ; IDC_Edit is a EDITTEXT(display the result)</code></pre><br /></div><br /><br />Well, what exactly is the &quot;GetNumber&quot; function supposed to do? What does it return? What is the second parameter? Is it IN-buffer or OUT-buffer? If OUT, then I guess putting it in .const section might be a problem here.<br /><br />Anyway, here&#39;s how you can INVOKE dynamically loaded functions - just two typedefs do it possible:<br /><pre><code><br />&nbsp; __GetNumber typedef proto integer :DWORD, character :LPSTR<br />&nbsp; _GetNumber&nbsp; typedef ptr __GetNumber<br /><br />.data?<br />&nbsp; GetNumber _GetNumber ?<br /><br />;then somewhere in the code<br />&nbsp; invoke GetProcAddress, hLib, addr szGetNumber<br />&nbsp; mov GetNumber, eax<br /><br />;...<br /><br />&nbsp; invoke GetNumber, your_integer, addr your_charbuffer<br /></code></pre></div>
    <div class="meta">Posted on 2006-03-28 05:52:30 by Morris</div>
   </div>
   <div class="post" id="post-178700">
    <div class="subject"><a href="#post-178700">Re: a snippet about dll</a></div>
    <div class="body"><div class="quote"><br /><div class="quote"><br />I tried &quot;push offset Code&quot;, it link well but run error!<br />The code is:<br /><br /><pre><code><br />/ -- snip -- /<br /><br />?&nbsp; .const<br />szError?&nbsp; ?&nbsp;db &#39;Get.dll Missing!&#39;,0<br />Code?&nbsp; ?&nbsp; ?&nbsp; db &#39;000000000000&#39;,0?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp;<br />strGetNumber?&nbsp; db &#39;GetNumber&#39;,0<br />strGetSize?&nbsp; ?&nbsp;db &#39;GetSize&#39;,0<br /><br />/ -- snip -- /<br /><br />?&nbsp; ?&nbsp; push Offset Code?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; <br />?&nbsp; ?&nbsp; push i<br />?&nbsp; ?&nbsp; call dword ptr <br />?&nbsp; ?&nbsp; invoke SetDlgItemText,hWnd,IDC_Edit,addr GetNumber?&nbsp; ?&nbsp; ; IDC_Edit is a EDITTEXT(display the result)</code></pre><br /></div><br /><br />Well, what exactly is the &quot;GetNumber&quot; function supposed to do? What does it return? What is the second parameter? Is it IN-buffer or OUT-buffer? If OUT, then I guess putting it in .const section might be a problem here.<br /><br />Anyway, here&#39;s how you can INVOKE dynamically loaded functions - just two typedefs do it possible:<br /><pre><code><br />?&nbsp; __GetNumber typedef proto integer :DWORD, character :LPSTR<br />?&nbsp; _GetNumber?&nbsp; typedef ptr __GetNumber<br /><br />.data?<br />?&nbsp; GetNumber _GetNumber ?<br /><br />;then somewhere in the code<br />?&nbsp; invoke GetProcAddress, hLib, addr szGetNumber<br />?&nbsp; mov GetNumber, eax<br /><br />;...<br /><br />?&nbsp; invoke GetNumber, your_integer, addr your_charbuffer<br /></code></pre><br /></div><br /><br />Hi Morris,<br /><br />Thanks for your kindly help and explanation :D<br />It works!<br /><br />Regards,<br />Eric </div>
    <div class="meta">Posted on 2006-03-28 19:45:29 by Eric4ever</div>
   </div>
  </div>
 </body>
</html>