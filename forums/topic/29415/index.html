<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Module32First Help - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=29415" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=29415">Module32First Help</a></p>
   <div class="post" id="post-207665">
    <div class="subject"><a href="#post-207665">Module32First Help</a></div>
    <div class="body">Am trying to find the full path of the processes that is running on my machine. I was able to find the name of the processes using the Process32Next and Process32First functions.<br /><br />But now to find the complete path of the running processes am finding problems. Here is my code,<br /><br /><pre><code><br />include C:\masm32\include\kernel32.inc <br />includelib C:\masm32\lib\kernel32.lib<br />include C:\masm32\include\user32.inc <br />includelib C:\masm32\lib\user32.lib <br /><br />.data?<br /><br />CreateToolhwnd dd ?<br />CreateToolhwnd1 dd ?<br /><br />.data<br /><br />Processentry PROCESSENTRY32 &lt;&gt;<br />Moduleentry MODULEENTRY32 &lt;&gt;<br /><br />.code<br />start:<br /><br />invoke CreateToolhelp32Snapshot, TH32CS_SNAPPROCESS, 0<br />mov CreateToolhwnd, eax<br /><br /><br />mov ecx, SIZEOF Processentry<br />mov Processentry.dwSize, ecx<br /><br />invoke Process32First, CreateToolhwnd, ADDR Processentry<br /><br />invoke MessageBox, NULL, ADDR Processentry.szExeFile, ADDR MsgCap, MB_OK<br /><br />.while TRUE<br /><br />invoke CreateToolhelp32Snapshot, TH32CS_SNAPMODULE, Processentry.th32ProcessID<br />mov CreateToolhwnd1, eax<br /><br />mov ecx, SIZEOF Moduleentry<br />mov Moduleentry.dwSize, ecx<br /><br />invoke Module32First, CreateToolhwnd1, ADDR Moduleentry<br />.if eax == TRUE<br />invoke MessageBox, NULL, ADDR Moduleentry.szExePath, ADDR MsgCap, MB_OK<br />invoke CloseHandle, CreateToolhwnd1<br />.else<br />jmp aa<br />.endif<br /><br />invoke Process32Next, CreateToolhwnd, ADDR Processentry<br /><br />.endw<br /><br />aa:<br /><br />invoke CloseHandle, CreateToolhwnd<br /><br />invoke ExitProcess, NULL<br /><br />end start<br /></code></pre><br /><br />Not sure as to what am missing out....<br /><br />Thanks for your help in advance,<br /><br />C K.</div>
    <div class="meta">Posted on 2009-05-20 04:22:01 by karthikeyanck</div>
   </div>
   <div class="post" id="post-207679">
    <div class="subject"><a href="#post-207679">Re: Module32First Help</a></div>
    <div class="body">Use these APIs:<br /><br />EnumProcesses()<br />OpenProcess()<br />EnumProcessModules()<br />GetModuleFilenameEx()<br /><br />That&#039;s all you need. Enumerate the processes. Open each process with PROCESS_VM_READ access. Then enumerate the modules of each process with EnumProcessModules() and use GetModuleFilenameEx() to get the file name of that module. I haven&#039;t done any MASM in a long time so I can&#039;t put anything together fast as an example. You will figure it out though.</div>
    <div class="meta">Posted on 2009-05-21 04:56:50 by XCHG</div>
   </div>
   <div class="post" id="post-207680">
    <div class="subject"><a href="#post-207680">Re: Module32First Help</a></div>
    <div class="body">Okay I wrote this now:<br /><br /><pre><code>.586<br />.model flat,stdcall<br />option casemap:none<br /><br />&nbsp;  include windows.inc<br />&nbsp;  include user32.inc<br />&nbsp;  include kernel32.inc<br />&nbsp;  include psapi.inc<br />&nbsp;  <br />&nbsp;  <br />&nbsp;  includelib user32.lib<br />&nbsp;  includelib kernel32.lib<br />&nbsp;  includelib psapi.lib<br />&nbsp;  <br /><br /><br />WinMain proto :DWORD,:DWORD,:DWORD,:DWORD<br /><br /><br />.data<br />&nbsp;  ClassName db &quot;MainWinClass&quot;,0<br />&nbsp;  AppName&nbsp; db &quot;Main Window&quot;,0<br /><br />.data?<br />&nbsp;  hInstance HINSTANCE ?<br />&nbsp;  CommandLine LPSTR ?<br />&nbsp;  FileAddress DB 1024 DUP(?)<br />&nbsp;  <br />&nbsp;  ProcessHandleArray DWORD 1024 DUP(?)<br />&nbsp;  CB&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  DWORD ?<br /><br />.code<br /><br /><br />; ---------------------------------------------------------------------------<br /><br /><br />start:<br />	invoke GetModuleHandle, NULL<br />	mov&nbsp; &nbsp; hInstance,eax<br />	<br />	invoke GetCommandLine<br />	mov&nbsp; &nbsp; CommandLine,eax<br />	<br />	invoke WinMain, hInstance,NULL,CommandLine, SW_SHOWDEFAULT<br />	invoke ExitProcess,eax<br /><br />WinMain proc hInst:HINSTANCE,hPrevInst:HINSTANCE,CmdLine:LPSTR,CmdShow:DWORD<br />	LOCAL wc:WNDCLASSEX<br />	LOCAL msg:MSG<br />	LOCAL hwnd:HWND<br />	<br />	mov&nbsp;  wc.cbSize,SIZEOF WNDCLASSEX<br />	mov&nbsp;  wc.style, CS_HREDRAW or CS_VREDRAW<br />	mov&nbsp;  wc.lpfnWndProc, OFFSET WndProc<br />	mov&nbsp;  wc.cbClsExtra,NULL<br />	mov&nbsp;  wc.cbWndExtra,NULL<br />	push&nbsp; hInstance<br />	pop&nbsp;  wc.hInstance<br />	mov&nbsp;  wc.hbrBackground,COLOR_BTNFACE+1<br />	mov&nbsp;  wc.lpszMenuName,NULL<br />	mov&nbsp;  wc.lpszClassName,OFFSET ClassName<br />	<br />	invoke LoadIcon,NULL,IDI_APPLICATION<br />	mov&nbsp;  wc.hIcon,eax<br />	mov&nbsp;  wc.hIconSm,eax<br />	<br />	invoke LoadCursor,NULL,IDC_ARROW<br />	mov&nbsp;  wc.hCursor,eax<br />	<br />	invoke RegisterClassEx, addr wc<br />	INVOKE CreateWindowEx,NULL,ADDR ClassName,ADDR AppName,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  WS_OVERLAPPEDWINDOW,CW_USEDEFAULT,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  CW_USEDEFAULT,CW_USEDEFAULT,CW_USEDEFAULT,NULL,NULL,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  hInst,NULL<br />	mov&nbsp;  hwnd,eax<br />	<br />	invoke ShowWindow, hwnd,SW_SHOWNORMAL<br />	invoke UpdateWindow, hwnd<br />	<br />	.WHILE TRUE<br />		invoke GetMessage, ADDR msg,NULL,0,0<br />		.BREAK .IF (!eax)<br />		invoke TranslateMessage, ADDR msg<br />		invoke DispatchMessage, ADDR msg<br />	.ENDW<br />	<br />	mov&nbsp; &nbsp;  eax,msg.wParam<br />	ret<br />WinMain endp<br /><br />WndProc proc hWnd:HWND, uMsg:UINT, wParam:WPARAM, lParam:LPARAM<br />	<br />	<br />	LOCAL&nbsp; &nbsp;  ThisProcess:DWORD<br />	LOCAL&nbsp; &nbsp;  Module:DWORD<br />	<br />	<br />	.IF uMsg==WM_DESTROY<br />		invoke PostQuitMessage,NULL<br />	.ELSEIF uMsg==WM_CREATE<br /><br />		<br />&nbsp; &nbsp; INVOKE&nbsp; &nbsp; &nbsp; EnumProcesses, OFFSET ProcessHandleArray, sizeof ProcessHandleArray, OFFSET CB<br />&nbsp; &nbsp; LEA&nbsp; &nbsp; &nbsp; &nbsp;  EDI , DWORD PTR <br />&nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp;  ECX , DWORD PTR <br />&nbsp; &nbsp; SHR&nbsp; &nbsp; &nbsp; &nbsp;  ECX , 2<br />&nbsp; &nbsp; @@Loop:<br />&nbsp; &nbsp; &nbsp; PUSH&nbsp; &nbsp; &nbsp; &nbsp; ECX<br />&nbsp; &nbsp; &nbsp; INVOKE&nbsp; &nbsp; &nbsp; OpenProcess, PROCESS_QUERY_INFORMATION OR PROCESS_VM_READ, FALSE, DWORD PTR <br />&nbsp; &nbsp; &nbsp; ADD&nbsp; &nbsp; &nbsp; &nbsp;  EDI , sizeof DWORD<br />&nbsp; &nbsp; &nbsp; TEST&nbsp; &nbsp; &nbsp; &nbsp; EAX , EAX<br />&nbsp; &nbsp; &nbsp; JZ&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @@LoopTail<br />&nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp;  DWORD PTR  , EAX<br />&nbsp; &nbsp; &nbsp; INVOKE&nbsp; &nbsp; &nbsp; EnumProcessModules, DWORD PTR , ADDR Module, SIZEOF Module, ADDR CB<br />&nbsp; &nbsp; &nbsp; INVOKE&nbsp; &nbsp; &nbsp; GetModuleFileNameEx, DWORD PTR , DWORD PTR , OFFSET FileAddress, SIZEOF FileAddress<br />&nbsp; &nbsp; &nbsp; INVOKE&nbsp; &nbsp; &nbsp; MessageBox, 0, OFFSET FileAddress, 0, MB_ICONINFORMATION&nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; INVOKE&nbsp; &nbsp; &nbsp; CloseHandle, DWORD PTR  <br />&nbsp; &nbsp; &nbsp; @@LoopTail:<br />&nbsp; &nbsp; &nbsp; POP&nbsp; &nbsp; &nbsp; &nbsp;  ECX<br />&nbsp; &nbsp; &nbsp; DEC&nbsp; &nbsp; &nbsp; &nbsp;  ECX<br />&nbsp; &nbsp; &nbsp; JNZ&nbsp; &nbsp; &nbsp; &nbsp;  @@Loop<br />&nbsp; &nbsp; <br />		<br />	.ELSE<br />		invoke DefWindowProc,hWnd,uMsg,wParam,lParam		<br />		ret<br />	.ENDIF<br />	<br />	xor eax,eax<br />	ret<br />WndProc endp<br /><br /><br />end start</code></pre></div>
    <div class="meta">Posted on 2009-05-21 06:18:46 by XCHG</div>
   </div>
   <div class="post" id="post-207681">
    <div class="subject"><a href="#post-207681">Re: Module32First Help</a></div>
    <div class="body">Thanks XCHG, works perfectly fine&nbsp; 8)<br /><br />But can&#039;t we achieve the same through Module32Next and Module32First API&#039;s (ofcourse other API&#039;s will be included when required).... Is there any difference in performance?<br /><br />Thanks,<br /><br />C K</div>
    <div class="meta">Posted on 2009-05-21 08:21:49 by karthikeyanck</div>
   </div>
  </div>
 </body>
</html>