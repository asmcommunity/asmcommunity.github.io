<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Transposing 6x4 bit matrix - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=21717" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=21717">Transposing 6x4 bit matrix</a></p>
   <div class="post" id="post-163823">
    <div class="subject"><a href="#post-163823">Transposing 6x4 bit matrix</a></div>
    <div class="body">Hi all,<br /><br />I have a situation where I need to transpose a 6x4 bit matrix, stored in six 32-bit variables. So I start with this:<br /><br /><pre><code>--------------------------a1a2a3a4<br />--------------------------b1b2b3b4<br />--------------------------c1c2c3c4<br />--------------------------d1d2d3d4<br />--------------------------e1e2e3e4<br />--------------------------f1f2f3f4</code></pre><br /><br />And I&#39;d like to end up with:<br /><br /><pre><code>------------------------a1b1c1d1e1f1<br />------------------------a2b2c2d2e2f2<br />------------------------a3b3c3d3e3f3<br />------------------------a4b4c4d4e4f4</code></pre><br /><br />Of course I could do it one bit at a time, but I really want to do it as fast as possible. All tricks allowed. 8)<br /><br />Thanks!</div>
    <div class="meta">Posted on 2005-08-27 14:38:56 by C0D1F1ED</div>
   </div>
   <div class="post" id="post-163826">
    <div class="subject"><a href="#post-163826">Re: Transposing 6x4 bit matrix</a></div>
    <div class="body">Here&#39;s what I came up with.<br />It&#39;s pretty long, but seems to be efficient.<br />The only other way I would think about doing it would be to load all the data into<br />XMM0 and XMM1 and then use PEXTRW to get 2 bytes out at a time and move them to the correct locations. If the following solution is too slow I&#39;d suggest implementing the SSE one described above.<br /><br /><pre><code><br />6x4:<br />d1 dd ? ;a1-4<br />d2 dd ? ;b1-4<br />d3 dd ? ;c1-4<br />d4 dd ? ;d1-4<br />d5 dd ? ;e1-4<br />d6 dd ? ;f1-4<br />4x6:<br />nd1 rb 8 ;abcdef1 0 0 ;2zero bytes as buffer for alignement<br />nd2 rb 8 ;abcdef2 0 0 ; and easier write<br />nd3 rb 8 ;abcdef3 0 0<br />nd4 rb 8 ;abcdef4 0 0<br /><br />;;;;;;;;;;;;;;ALL REGISTERS ARE KILLED<br />mov eax,<br />movzx ebx,al<br />movzx ecx,ah<br />shr eax,16<br />movzx edx,al<br />movzx esi,ah<br />shl ebx,8<br />shl ecx,8<br />shl edx,8<br />shl esi,8<br />;;;;;;;;;d1-4 in place<br />;;;;;;;;;working backwards to avoid a 8bswap&#39;s<br />mov eax,<br />movzx ebp,al<br />movzx edi,ah<br />or ebx,ebp<br />or ecx,edi<br />shr eax,16<br />movzx ebp,al<br />movzx edi,ah<br />or edx,ebp<br />or esi,edi<br />shl ebx,8<br />shl ecx,8<br />shl edx,8<br />shl esi,8<br />;;;;;;;;;c1-4 in place<br />mov eax,<br />movzx ebp,al<br />movzx edi,ah<br />or ebx,ebp<br />or ecx,edi<br />shr eax,16<br />movzx ebp,al<br />movzx edi,ah<br />or edx,ebp<br />or esi,edi<br />shl ebx,8<br />shl ecx,8<br />shl edx,8<br />shl esi,8<br />;;;;;;;;;;b1-4 in place<br />mov eax,<br />movzx ebp,al<br />movzx edi,ah<br />or ebx,ebp<br />or ecx,edi<br />shr eax,16<br />movzx ebp,al<br />movzx edi,ah<br />or edx,ebp<br />or esi,edi<br />;;;;;;;;;;;a1-4 in place<br />;;;;;;;;;;;write and repeat for e1-4 &amp; f1-4<br />mov ,ebx<br />mov ,ecx<br />mov ,edx<br />mov ,esi<br />;;;;;;;;;; last 2 columns<br />mov eax,<br />movzx ebx,al<br />movzx ecx,ah<br />shr eax,16<br />movzx edx,al<br />movzx esi,ah<br />shl ebx,8<br />shl ecx,8<br />shl edx,8<br />shl esi,8<br />;;;;;;;;;f1-4 in place now do e1-4<br />mov eax,<br />movzx ebp,al<br />movzx edi,ah<br />or ebx,ebp<br />or ecx,edi<br />shr eax,16<br />movzx ebp,al<br />movzx edi,ah<br />or edx,ebp<br />or esi,edi<br />;;;;;;;;;;write the last 2 columns<br />mov ,ebx<br />mov ,ecx<br />mov ,edx<br />mov ,esi<br /></code></pre></div>
    <div class="meta">Posted on 2005-08-27 18:44:54 by r22</div>
   </div>
   <div class="post" id="post-163832">
    <div class="subject"><a href="#post-163832">Re: Transposing 6x4 bit matrix</a></div>
    <div class="body"><div class="quote">Of course I could do it one bit at a time,</div><br /><br />This is probably the way you would have intended to proceed.<br /><br /><pre><code>.data<br />&nbsp; &nbsp; A6x4&nbsp;  dd&nbsp;  6 dup(?)&nbsp;  ;original 6x4 bit matrix<br />&nbsp; &nbsp; B4x6&nbsp;  dd&nbsp;  4 dup(?)&nbsp;  ;converted 4x6 bit matrix<br /><br />.code<br />&nbsp; &nbsp; mov&nbsp;  edi,offset A6x4<br />&nbsp; &nbsp; mov&nbsp;  bl,&nbsp; &nbsp; &nbsp; ;a1a2a3a4<br />&nbsp; &nbsp; add&nbsp;  edi,4<br />&nbsp; &nbsp; mov&nbsp;  bh,&nbsp; &nbsp; &nbsp; ;b1b2b3b4<br />&nbsp; &nbsp; add&nbsp;  edi,4<br />&nbsp; &nbsp; mov&nbsp;  cl,&nbsp; &nbsp; &nbsp; ;c1c2c3c4<br />&nbsp; &nbsp; add&nbsp;  edi,4<br />&nbsp; &nbsp; mov&nbsp;  ch,&nbsp; &nbsp; &nbsp; ;d1d2d3d4<br />&nbsp; &nbsp; add&nbsp;  edi,4<br />&nbsp; &nbsp; mov&nbsp;  dl,&nbsp; &nbsp; &nbsp; ;e1e2e3e4<br />&nbsp; &nbsp; add&nbsp;  edi,4<br />&nbsp; &nbsp; mov&nbsp;  dh,&nbsp; &nbsp; &nbsp; ;f1f2f3f4<br /><br />&nbsp; &nbsp; mov&nbsp;  edi,offset B4x6 + 16<br />&nbsp; &nbsp; mov&nbsp;  esi,4<br />&nbsp; @@:<br />&nbsp; &nbsp; xor&nbsp;  eax,eax<br />&nbsp; &nbsp; shr&nbsp;  bl,1<br />&nbsp; &nbsp; rcl&nbsp;  al,1<br />&nbsp; &nbsp; shr&nbsp;  bh,1<br />&nbsp; &nbsp; rcl&nbsp;  al,1<br />&nbsp; &nbsp; shr&nbsp;  cl,1<br />&nbsp; &nbsp; rcl&nbsp;  al,1<br />&nbsp; &nbsp; shr&nbsp;  ch,1<br />&nbsp; &nbsp; rcl&nbsp;  al,1<br />&nbsp; &nbsp; shr&nbsp;  dl,1<br />&nbsp; &nbsp; rcl&nbsp;  al,1<br />&nbsp; &nbsp; shr&nbsp;  dh,1<br />&nbsp; &nbsp; rcl&nbsp;  al,1<br />&nbsp; &nbsp; sub&nbsp;  edi,4<br />&nbsp; &nbsp; mov&nbsp;  ,eax<br />&nbsp; &nbsp; dec&nbsp;  esi<br />&nbsp; &nbsp; jnz&nbsp;  @B</code></pre><br /><br />Raymond<br /></div>
    <div class="meta">Posted on 2005-08-27 20:55:53 by Raymond</div>
   </div>
   <div class="post" id="post-163836">
    <div class="subject"><a href="#post-163836">Re: Transposing 6x4 bit matrix</a></div>
    <div class="body">That&#39;s awesome, thanks!<br /><br />It already works great now (it&#39;s for encryption by the way), but I noticed that I actually only need to transpose 3x4 bits to make it work the same way. So it gets reduced to:<br /><br /><pre><code>--------------------------a1a2a3a4<br />--------------------------b1b2b3b4<br />--------------------------c1c2c3c4<br /><br />---------------------------a1b1c1<br />---------------------------a2b2c2<br />---------------------------a3b3c3<br />---------------------------a4b4c4</code></pre><br /><br />This enables the use of a lookup table, using the 12 input bits as offset into the table. This takes at least 8 kB of precious memory though, so I&#39;m wondering if an arithmetic approach could be equally fast? This operation is really time critical to the whole application...<br /><br />Here&#39;s my first attempt (in C code):<br /><br /><pre><code><br />unsigned int a = (a1a2a3a4 &gt;&gt; 1) | (a1a2a3a4 &lt;&lt; 4) | (a1a2a3a4 &lt;&lt; 9) | (a1a2a3a4 &lt;&lt; 14);<br />unsigned int b = (b1b2b3b4 &gt;&gt; 2) | (b1b2b3b4 &lt;&lt; 3) | (b1b2b3b4 &lt;&lt; 8) | (b1b2b3b4 &lt;&lt; 13);<br />unsigned int c = (c1c2c3c4 &gt;&gt; 3) | (c1c2c3c4 &lt;&lt; 2) | (c1c2c3c4 &lt;&lt; 7) | (c1c2c3c4 &lt;&lt; 12);<br /><br />a = a &amp; 0x00004444;<br />b = b &amp; 0x00002222;<br />c = c &amp; 0x00001111;<br /><br />a = a | b | c;<br /><br />unsigned int r0 = (a &amp; 0x00000007) &gt;&gt; 0;<br />unsigned int r1 = (a &amp; 0x00000070) &gt;&gt; 4;<br />unsigned int r2 = (a &amp; 0x00000700) &gt;&gt; 8;<br />unsigned int r3 = (a &amp; 0x00007000) &gt;&gt; 12;<br /></code></pre><br /><br />With the 4-bit registers in assembler this can probably be done a lot faster...</div>
    <div class="meta">Posted on 2005-08-27 21:49:44 by C0D1F1ED</div>
   </div>
   <div class="post" id="post-163837">
    <div class="subject"><a href="#post-163837">Re: Transposing 6x4 bit matrix</a></div>
    <div class="body">Actually I can let three small lookup tables do all the work:<br /><br /><pre><code><br />unsigned short lut0[16] =<br />{<br />&nbsp; &nbsp; 0x0000,<br />&nbsp; &nbsp; 0x0001,<br />&nbsp; &nbsp; 0x0010,<br />&nbsp; &nbsp; 0x0011,<br />&nbsp; &nbsp; 0x0100,<br />&nbsp;  ...<br />};<br /><br />unsigned short lut1[16] =<br />{<br />&nbsp; &nbsp; 0x0000,<br />&nbsp; &nbsp; 0x0002,<br />&nbsp; &nbsp; 0x0020,<br />&nbsp; &nbsp; 0x0022,<br />&nbsp; &nbsp; 0x0200,<br />&nbsp;  ...<br />};<br /><br />unsigned short lut2[16] =<br />{<br />&nbsp; &nbsp; 0x0000,<br />&nbsp; &nbsp; 0x0004,<br />&nbsp; &nbsp; 0x0040,<br />&nbsp; &nbsp; 0x0044,<br />&nbsp; &nbsp; 0x0400,<br />&nbsp;  ...<br />};<br /><br />unsigned short _a4b4c4_a3b3c3_a2b2c2_a1b1c1 = lut2 | lut1<strong> | lut0;<br /><br />unsigned short _a1b1c1 = (_a4b4c4_a3b3c3_a2b2c2_a1b1c1 &amp; 0x0007) &gt;&gt; 0;<br />unsigned short _a2b2c2 = (_a4b4c4_a3b3c3_a2b2c2_a1b1c1 &amp; 0x0070) &gt;&gt; 4;<br />unsigned short _a3b3c3 = (_a4b4c4_a3b3c3_a2b2c2_a1b1c1 &amp; 0x0700) &gt;&gt; 8;<br />unsigned short _a4b4c4 = (_a4b4c4_a3b3c3_a2b2c2_a1b1c1 &amp; 0x7000) &gt;&gt; 12;<br /></code></pre><br /><br />So essentially it&#39;s three lookups and two or operations. 8) The tables take only 3 x 16 x 2 = 96 bytes.</div>
    <div class="meta">Posted on 2005-08-27 22:24:16 by C0D1F1ED</div>
   </div>
   <div class="post" id="post-163838">
    <div class="subject"><a href="#post-163838">Re: Transposing 6x4 bit matrix</a></div>
    <div class="body"><strong>i was bored...</strong>  :roll:<br /><pre><code><br />	.data<br />	align 8<br />_6x4 label dword<br />	db 0a1h,0a2h,0a3h,0a4h <br />	db 0b1h,0b2h,0b3h,0b4h<br />	db 0c1h,0c2h,0c3h,0c4h<br />	db 0d1h,0d2h,0d3h,0d4h<br />	db 0e1h,0e2h,0e3h,0e4h<br />	db 0f1h,0f2h,0f3h,0f4h<br />_4x6 label qword<br />	db 8 dup(0)<br />	db 8 dup(0)<br />	db 8 dup(0)<br />	db 8 dup(0)<br />	.code<br />Transponse:<br />	IFNDEF .MMX <br />	pushad<br />	xor edx,edx<br />	xor ebp,ebp<br />	mov esi,offset _6x4<br />	mov edi,offset _4x6<br />@@:	mov al,<br />	mov bl,<br />	mov cl,<br />	mov ah,<br />	mov bh,<br />	mov ch,<br />	mov ,ax<br />	mov ,bx<br />	mov ,cx<br />	add edx,8<br />	inc ebp<br />	cmp edx,8*4<br />	jb @B<br />	popad<br />	ELSE<br />	mov eax,offset _6x4<br />	mov edx,offset _4x6<br />	MOVD mm0,<br />	PUNPCKLBW mm0,<br />	MOVD mm7,<br />	PUNPCKLBW mm7,<br />	MOVQ mm1,mm0<br />	PUNPCKLWD mm0,mm7<br />	PUNPCKHWD mm1,mm7<br />	MOVD mm6,<br />	PUNPCKLBW mm6,<br />	PUNPCKLWD mm2,mm6<br />	PUNPCKHWD mm3,mm6<br />	MOVQ mm4,mm2<br />	PUNPCKLDQ mm4,mm0<br />	PUNPCKHDQ mm2,mm0<br />	MOVQ mm5,mm3<br />	PUNPCKLDQ mm5,mm1<br />	PUNPCKHDQ mm3,mm1<br />	PSRLQ mm4,16<br />	PSRLQ mm2,16<br />	PSRLQ mm5,16<br />	PSRLQ mm3,16<br />	MOVQ ,mm4<br />	MOVQ ,mm2<br />	MOVQ ,mm5<br />	MOVQ ,mm3<br />	ENDIF<br />	retn<br /></code></pre><br /><br />EDIT: didn&#39;t read thoroughly... :(</div>
    <div class="meta">Posted on 2005-08-27 23:08:51 by drizz</div>
   </div>
   <div class="post" id="post-163842">
    <div class="subject"><a href="#post-163842">Re: Transposing 6x4 bit matrix</a></div>
    <div class="body">ok.. second try... bits this time<br /><pre><code><br />	pushad<br />	i = 0<br />	for reg,&lt;eax,ebx,ecx,edx,edi,esi&gt;<br />	%mov &amp;reg&amp;,_6x4<em><br />	i = i +1<br />	endm<br />	xor ebp,ebp<br />	for reg,&lt;eax,ebx,ecx,edx,edi,esi&gt;<br />	shl &amp;reg&amp;,(32-4)+1<br />	adc ebp,ebp<br />	endm<br />	mov _4x6[0*4],ebp<br />	i = 1<br />	rept 3<br />		xor ebp,ebp<br />		for reg,&lt;eax,ebx,ecx,edx,edi,esi&gt;<br />		add &amp;reg&amp;,&amp;reg&amp;<br />		adc ebp,ebp <br />		;; shld ebp,&amp;reg&amp;,1<br />		endm<br />		mov _4x6<em>,ebp<br />		i = i + 1<br />	endm<br />	popad<br /></code></pre><br />most of the code should pair</div>
    <div class="meta">Posted on 2005-08-28 00:31:24 by drizz</div>
   </div>
   <div class="post" id="post-163844">
    <div class="subject"><a href="#post-163844">Re: Transposing 6x4 bit matrix</a></div>
    <div class="body">Oh it&#39;s 6x4 BITS, look up table is fastest.<br /><br />As for &quot;precious memory&quot; pff an exe with 10ish KB of size from a look up table is nothing.</div>
    <div class="meta">Posted on 2005-08-28 01:09:06 by r22</div>
   </div>
   <div class="post" id="post-163853">
    <div class="subject"><a href="#post-163853">Re: Transposing 6x4 bit matrix</a></div>
    <div class="body"><div class="quote"><br />As for &quot;precious memory&quot; pff an exe with 10ish KB of size from a look up table is nothing.<br /></div><br />It&#39;s meant to be used on an embedded device (like mobile phone). So for this component it&#39;s hardly acceptable to use more than a couple kBs.</div>
    <div class="meta">Posted on 2005-08-28 07:30:04 by C0D1F1ED</div>
   </div>
   <div class="post" id="post-163854">
    <div class="subject"><a href="#post-163854">Re: Transposing 6x4 bit matrix</a></div>
    <div class="body">even if it&#39;s useless, i enjoy these kind of tasks,  hope no-one minds my posts<br /><pre><code><br />__asm {<br />	mov eax,[_3x4+0*4]<br />	xor edx,edx<br />	shl eax,(32-4)+1  <br />	mov ebx,[_3x4+1*4]<br />	adc edx,edx<br />	mov ecx,[_3x4+2*4]<br />	shl ebx,(32-4)+1<br />	mov edi,0<br />	adc edx,edx<br />	mov esi,0<br />	shl ecx,(32-4)+1<br />	mov ebp,0<br />	adc edx,edx<br />	add eax,eax<br />	adc edi,edi<br />	add ebx,ebx<br />	adc edi,edi<br />	add ecx,ecx<br />	adc edi,edi<br />	add eax,eax<br />	adc esi,esi<br />	add ebx,ebx<br />	adc esi,esi<br />	add ecx,ecx<br />	adc esi,esi<br />	add eax,eax<br />	adc ebp,ebp<br />	add ebx,ebx<br />	adc ebp,ebp<br />	add ecx,ecx<br />	adc ebp,ebp<br />	mov [_4x3+0*4],edx<br />	mov [_4x3+1*4],edi<br />	mov [_4x3+2*4],esi<br />	mov [_4x3+3*4],ebp<br />}<br /></code></pre><br />35 lines / 2<br /></div>
    <div class="meta">Posted on 2005-08-28 07:53:16 by drizz</div>
   </div>
   <div class="post" id="post-163920">
    <div class="subject"><a href="#post-163920">Re: Transposing 6x4 bit matrix</a></div>
    <div class="body">an embedded device/mobile phone with x86 and sse o_O !!!<br /><br />?<br /><br /></div>
    <div class="meta">Posted on 2005-08-28 22:20:39 by HeLLoWorld</div>
   </div>
  </div>
 </body>
</html>