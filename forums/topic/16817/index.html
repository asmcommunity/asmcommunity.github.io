<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Can i include file jpeg instead bitmap - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=16817" />
    <link rel="next" href="../?id=16817&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=16817">Can i include file jpeg instead bitmap</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=16817&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=16817&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="16817" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=16817&amp;page=2">&gt;</a><a href="../?id=16817&amp;page=2">&raquo;</a></form>   <div class="post" id="post-130490">
    <div class="subject"><a href="#post-130490">Can i include file jpeg instead bitmap</a></div>
    <div class="body">Hi all !<br />Can i include jpeg file instead bitmap file , because .bmp very big. My app about 20k but my .bmp have 100k it make my app so huge, if i use .jpg it about 35k.</div>
    <div class="meta">Posted on 2004-01-13 02:32:48 by neverending</div>
   </div>
   <div class="post" id="post-130492">
    <div class="subject"><a href="#post-130492">Can i include file jpeg instead bitmap</a></div>
    <div class="body">Yes, you can, but then you should be able to load a jpeg as resource and use it</div>
    <div class="meta">Posted on 2004-01-13 02:38:03 by greenant</div>
   </div>
   <div class="post" id="post-130498">
    <div class="subject"><a href="#post-130498">Can i include file jpeg instead bitmap</a></div>
    <div class="body">Another option is to stick with BMP in resource, and simply compress the resulting exe using an executable packer like UPX.<br />Remember that even if you do use jpg, that jpg will be decompressed to a bmp regardless, and will still consume a bmp's worth of system resources at runtime.</div>
    <div class="meta">Posted on 2004-01-13 04:19:27 by Homer</div>
   </div>
   <div class="post" id="post-130509">
    <div class="subject"><a href="#post-130509">Can i include file jpeg instead bitmap</a></div>
    <div class="body">Using an exe compressor means your entire executable gets compressed, though... which is sorta bad because of the way paging works. Same old discussion.<br /><br />You can include a JPG or PNG (depending on what content the image has) as a binary resource, and use Thomas' PNGLib or find some JPG source (there's some old stuff around by promethee) to load it at runtime.<br /><br />Sure, you'll be adding code to decompress the file format, and you'll have both the compressed image + decompressed bitmap in memory... the advantage, however, is that pages from your executable can still be shared if you run multiple instances, et cetera.<br /><br /><br />PNG or JPG should also be able to give you better compression rate than just brute-force UPXing your executable, since these formats were specifically created for image data - especially JPG on 'photo' style data will yield much better ratios than stupid UPXing.</div>
    <div class="meta">Posted on 2004-01-13 08:54:49 by f0dder</div>
   </div>
   <div class="post" id="post-130515">
    <div class="subject"><a href="#post-130515">Can i include file jpeg instead bitmap</a></div>
    <div class="body">The masm32.lib library also comes with some functions to handle jpg and gif files using no extra libraries. I think the function name you're looking for is BitmapFromResouce, if I recall correctly.</div>
    <div class="meta">Posted on 2004-01-13 10:15:36 by QvasiModo</div>
   </div>
   <div class="post" id="post-130517">
    <div class="subject"><a href="#post-130517">Can i include file jpeg instead bitmap</a></div>
    <div class="body">Hi neverending,<br /><br />You use RadASM so select <strong>Resource</strong> from the <strong>Project</strong> menu. Click the <strong>Add</strong> button to add a new resource and in the <strong>type</strong> drop down you will find a type <strong>Image</strong> this can be used for JPG or GIF images. In order to translate this to a bitmap handle use the MASM32 library functions by Ernie to convert the image.<br /><pre><code>&#91;b&#93;&#91;i&#93;From the MASM32 library&#91;/i&#93;&#91;/b&#93;<br /><br />invoke BitmapFromResource, hModule, lpName<br />mov hBitmap,eax</code></pre><br /><strong>hModule</strong> is the instance handle returned from GetModuleHandle<br /><strong>lpName</strong> is the ID that you gave the image when you added it to the resources</div>
    <div class="meta">Posted on 2004-01-13 11:25:12 by donkey</div>
   </div>
   <div class="post" id="post-134514">
    <div class="subject"><a href="#post-134514">Can i include file jpeg instead bitmap</a></div>
    <div class="body"><div class="quote"><br />Using an exe compressor means your entire executable gets compressed, though... which is sorta bad because of the way paging works. Same old discussion.<br /><br />You can include a JPG or PNG (depending on what content the image has) as a binary resource, and use Thomas' PNGLib or find some JPG source (there's some old stuff around by promethee) to load it at runtime.<br /><br />Sure, you'll be adding code to decompress the file format, and you'll have both the compressed image + decompressed bitmap in memory... the advantage, however, is that pages from your executable can still be shared if you run multiple instances, et cetera.<br /><br />So it seems like you are saying that dealing with JPG is a pain in the arse.<br />Are you saying that MS is putting limits on what Win 32 apps can display?.<br /><br /><br /><br />PNG or JPG should also be able to give you better compression rate than just brute-force UPXing your executable, since these formats were specifically created for image data - especially JPG on 'photo' style data will yield much better ratios than stupid UPXing. </div></div>
    <div class="meta">Posted on 2004-02-22 22:41:21 by skywalker</div>
   </div>
   <div class="post" id="post-134533">
    <div class="subject"><a href="#post-134533">Can i include file jpeg instead bitmap</a></div>
    <div class="body"><div class="quote"><br />So it seems like you are saying that dealing with JPG is a pain in the arse.<br />Are you saying that MS is putting limits on what Win 32 apps can display?.<br /></div><br />Not really, they just don't support every display format on earth natively... There *IS* GIF and JPEG support via OleLoadPicture, though, this just requires a bit more code than a simple LoadBitmap.<br /><br />And using UPX is still bad :)</div>
    <div class="meta">Posted on 2004-02-23 00:45:30 by f0dder</div>
   </div>
   <div class="post" id="post-134535">
    <div class="subject"><a href="#post-134535">Can i include file jpeg instead bitmap</a></div>
    <div class="body">Loading jpgs from resources is fairly straight forward. This is the routine I use (GoAsm) :<br /><br /><pre><code>.data<br />IPicture STRUCT<br />	; IUnknown methods<br />	QueryInterface			DD<br />	AddRef				DD<br />	Release				DD<br />	; IPicture methods<br />	get_Handle			DD<br />	get_hPal			DD<br />	get_Type			DD<br />	get_Width			DD<br />	get_Height			DD<br />	Render				DD<br />	set_hPal			DD<br /><br />	get_CurDC			DD<br />	SelectPicture			DD<br />	get_KeepOriginalFormat		DD<br />	put_KeepOriginalFormat		DD<br />	PictureChanged			DD<br />	SaveAsFile			DD<br />	get_Attributes			DD<br />IPicture ENDS<br /><br />#define HIMETRIC_INCH 2540<br /><br />IID_IPicture GUID	&lt;07BF80980H, 0BF32H, 0101AH, 08BH, 0BBH, 000H, \<br />	0AAH, 000H, 030H, 00CH, 0ABH&gt;<br /><br />.code<br />LoadPicture FRAME hModule,IDPicture<br />	uses edi<br />	LOCAL pPicture			&#58;D<br />	LOCAL hDC			&#58;D<br />	LOCAL hTempDC			&#58;D<br />	LOCAL OldObj			&#58;D<br />	LOCAL hReturnBmp		&#58;D<br />	LOCAL OLE_YSIZE_HIMETRIC	&#58;D<br />	LOCAL OLE_XSIZE_HIMETRIC	&#58;D<br />	LOCAL dwWidth			&#58;D<br />	LOCAL dwHeight			&#58;D<br />	LOCAL ptTop			&#58;POINT<br />	LOCAL ptBtm			&#58;POINT<br /><br />	LOCAL pGlobal			&#58;D<br />	LOCAL pStream			&#58;D<br />	LOCAL hFindRes			&#58;D<br />	LOCAL ResSize			&#58;D<br />	LOCAL hResData			&#58;D<br />	LOCAL pResData			&#58;D<br /><br />	; Load the picture from the resource file<br />	invoke FindResource,&#91;hModule&#93;,&#91;IDPicture&#93;,2110 ;RT_IMAGE<br />	mov &#91;hFindRes&#93;,eax<br />	invoke SizeofResource,&#91;hModule&#93;,&#91;hFindRes&#93;<br />	mov &#91;ResSize&#93;,eax<br />	or eax,eax<br />	jnz &gt;<br />		dec eax<br />		ret<br />	&#58;<br />	invoke LoadResource,&#91;hModule&#93;,&#91;hFindRes&#93;<br />	mov &#91;hResData&#93;,eax<br />	invoke LockResource,&#91;hResData&#93;<br />	mov &#91;pResData&#93;,eax<br /><br />	invoke GlobalAlloc,GMEM_FIXED,&#91;ResSize&#93;<br />	mov &#91;pGlobal&#93;,eax<br />	<br />	invoke memcopy,&#91;pResData&#93;,&#91;pGlobal&#93;,&#91;ResSize&#93;<br /><br />	invoke CreateStreamOnHGlobal, &#91;pGlobal&#93;, TRUE, ADDR pStream<br />	invoke OleLoadPicture, &#91;pStream&#93;, NULL, TRUE, ADDR IID_IPicture, ADDR pPicture<br /><br />	test eax,eax<br />	jz &gt;<br />		; no interface<br />		invoke GlobalFree,&#91;pGlobal&#93;<br />		xor eax,eax<br />		dec eax<br />		ret<br />	&#58;<br /><br />	mov edi, &#91;pPicture&#93;<br /><br />	push OFFSET OLE_YSIZE_HIMETRIC<br />	push edi<br />	mov eax, &#91;edi&#93;<br />	call &#91;eax+IPicture.get_Height&#93;<br /><br />	push OFFSET OLE_XSIZE_HIMETRIC<br />	push edi<br />	mov eax, &#91;edi&#93;<br />	call &#91;eax+IPicture.get_Width&#93;<br /><br />	invoke GetDC,NULL<br />	mov &#91;hDC&#93;,eax<br />	invoke CreateCompatibleDC,&#91;hDC&#93;<br />	mov &#91;hTempDC&#93;,eax<br /><br />	invoke GetDeviceCaps, &#91;hDC&#93;, LOGPIXELSY<br />	invoke MulDiv, &#91;OLE_YSIZE_HIMETRIC&#93;, eax, HIMETRIC_INCH<br />	mov &#91;dwHeight&#93;, eax<br />	invoke GetDeviceCaps, &#91;hDC&#93;, LOGPIXELSX<br />	invoke MulDiv, &#91;OLE_XSIZE_HIMETRIC&#93;, eax, HIMETRIC_INCH<br />	mov &#91;dwWidth&#93;, eax<br />	invoke CreateIndependantBitmap,&#91;hDC&#93;,&#91;dwWidth&#93;,&#91;dwHeight&#93;<br />	mov &#91;hReturnBmp&#93;,eax<br />	invoke ReleaseDC,NULL,&#91;hDC&#93;<br />	invoke SelectObject,&#91;hTempDC&#93;,&#91;hReturnBmp&#93;<br />	mov &#91;OldObj&#93;,eax<br /><br />	xor ecx,ecx<br />	push ecx<br />	push &#91;OLE_YSIZE_HIMETRIC&#93;<br />	push &#91;OLE_XSIZE_HIMETRIC&#93;<br />	push ecx<br />	push ecx<br />	push &#91;dwHeight&#93;<br />	push &#91;dwWidth&#93;<br />	push ecx<br />	push ecx<br />	push &#91;hTempDC&#93;<br />	push edi<br />	mov eax, &#91;edi&#93;<br />	call &#91;eax+IPicture.Render&#93;<br /><br />	; release the stream<br />	mov eax, &#91;pStream&#93;<br />	push eax<br />	mov eax, &#91;eax&#93;<br />	call &#91;eax+IPicture.Release&#93; <br /><br />	push edi<br />	mov eax, &#91;edi&#93;<br />	call &#91;eax+IPicture.Release&#93;<br /> <br />	; Flip the bitmap<br />	xor ecx,ecx<br />	mov eax,&#91;dwWidth&#93;<br />	mov D&#91;ptBtm.x&#93;,eax<br />	mov D&#91;ptTop.x&#93;,ecx<br />	mov eax,&#91;dwHeight&#93;<br />	dec eax<br />	dec eax<br />	mov D&#91;ptTop.y&#93;,eax<br />	inc eax<br />	neg eax<br />	mov D&#91;ptBtm.y&#93;,eax<br />	invoke StretchBlt, &#91;hTempDC&#93;, ecx, ecx, &#91;dwWidth&#93;, &#91;dwHeight&#93;,\<br />		&#91;hTempDC&#93;, &#91;ptTop.x&#93;, &#91;ptTop.y&#93;, &#91;ptBtm.x&#93;,&#91; ptBtm.y&#93;, SRCCOPY<br /><br /><br />	invoke SelectObject,&#91;hTempDC&#93;,&#91;OldObj&#93;<br />	invoke DeleteDC,&#91;hTempDC&#93;<br />	invoke GlobalFree,&#91;pGlobal&#93;<br />	mov eax,&#91;hReturnBmp&#93;<br />	ret<br /><br />endf<br /><br />CreateIndependantBitmap FRAME hDC,SizeX,SizeY<br />	LOCAL bmi			&#58;BITMAPINFO<br /><br />	mov D&#91;bmi.bmiHeader.biSize&#93;,SIZEOF BITMAPINFOHEADER<br />	mov eax,&#91;SizeX&#93;<br />	mov D&#91;bmi.bmiHeader.biWidth&#93;,eax<br />	mov eax,&#91;SizeY&#93;<br />	mov D&#91;bmi.bmiHeader.biHeight&#93;,eax<br />	mov W&#91;bmi.bmiHeader.biPlanes&#93;,1<br />	mov W&#91;bmi.bmiHeader.biBitCount&#93;,32<br />	mov D&#91;bmi.bmiHeader.biCompression&#93;,BI_RGB<br />	xor ecx,ecx<br />	invoke CreateDIBSection,&#91;hDC&#93;,ADDR bmi,DIB_RGB_COLORS,ecx,ecx,ecx<br /><br />	push eax<br />	invoke GdiFlush<br />	pop eax<br />	ret<br /><br />endf</code></pre></div>
    <div class="meta">Posted on 2004-02-23 00:53:55 by donkey</div>
   </div>
   <div class="post" id="post-134591">
    <div class="subject"><a href="#post-134591">Can i include file jpeg instead bitmap</a></div>
    <div class="body">donkey: An idea: instead of converting himetric inches to pixels by yourself, isn't it better to let GDI do that for you? The DC can be set up to use himetric inches. I tried that some time ago and it worked, if you're interested I can post the sources. :)</div>
    <div class="meta">Posted on 2004-02-23 12:45:06 by QvasiModo</div>
   </div>
   <div class="post" id="post-134592">
    <div class="subject"><a href="#post-134592">Can i include file jpeg instead bitmap</a></div>
    <div class="body">Donkey,<br /><br />Nice work.<br /><br />I have a question for you: can you advise me some references / tutorials about using OLE library functions (ole32.dll and oleaut32.dll ) with Masm or C/C++ ?</div>
    <div class="meta">Posted on 2004-02-23 12:55:15 by Vortex</div>
   </div>
   <div class="post" id="post-134593">
    <div class="subject"><a href="#post-134593">Can i include file jpeg instead bitmap</a></div>
    <div class="body">Hi QvasiModo,<br /><br />Actually I was thinking that I could just call the IPicture::get_handle method and use GetObject to do everything. Using CopyBitmap I could make a local GDI handle and do it that way but it isn't much code and I use it so rarely that I have never really put in the effort to improve it. I may take the time one day. Actually I think that's how I did it in TBPaint for some image types but there were errors in the returned values or something, can't remember right now, I have to revisit the problem. In general though I do not like the IPicture interface or OleLoadPicture as it makes a botch of the color tables, I am currently looking at some alternative JPG libs.<br /><br /><br />Hi Vortex,<br /><br />I generally hack my way through each interface on an &quot;as needed&quot; basis but I think Mad Wizard has a few tutorials on it, the COM section here is loaded with great examples. Virtually no-one posts there much anymore so any questions are answered very quickly. For myself I have not really seen any tutorials, I just keep plugging at them until they work.<br /><br />You should also check out Ernie's COM folder in the MASM32 distribution.</div>
    <div class="meta">Posted on 2004-02-23 13:04:02 by donkey</div>
   </div>
   <div class="post" id="post-134595">
    <div class="subject"><a href="#post-134595">Can i include file jpeg instead bitmap</a></div>
    <div class="body"><div class="quote"><br />Hi QvasiModo,<br /><br />Actually I was thinking that I could just call the IPicture::get_handle method and use GetObject to do everything. Using CopyBitmap I could make a local GDI handle and do it that way but it isn't much code and I use it so rarely that I have never really put in the effort to improve it. I may take the time one day. Actually I think that's how I did it in TBPaint for some image types but there were errors in the returned values or something, can't remember right now, I have to revisit the problem. In general though I do not like the IPicture interface or OleLoadPicture as it makes a botch of the color tables, I am currently looking at some alternative JPG libs.<br /></div><br />I vaguely remember that get_Handle didn't work for all image types, but I have to check the docs.<br />Anyway, I also don't like to use IPicture either, but in the end it's much better than copying the image to a bitmap. Particularly for transparent GIF pictures, you have to make them opaque (at least I never figured out how to keep the transparency, or at least get the transparent color to build a region from it).<br /><br />I once thought of writing a wrapper, but I thought that it wouldn't be too different from Ernie's lib, or calling the COM interfaces directly... there's not much in between.</div>
    <div class="meta">Posted on 2004-02-23 13:24:39 by QvasiModo</div>
   </div>
   <div class="post" id="post-134596">
    <div class="subject"><a href="#post-134596">Can i include file jpeg instead bitmap</a></div>
    <div class="body">Yeah, for JPGs it seems fine though...<br /><br /><pre><code>LoadPictureRes FRAME hModule,IDPicture<br />	uses edi<br />	LOCAL pPicture				&#58;D<br />	LOCAL pGlobal				&#58;D<br />	LOCAL pStream				&#58;D<br />	LOCAL hFindRes				&#58;D<br />	LOCAL ResSize				&#58;D<br />	LOCAL hResData				&#58;D<br />	LOCAL pResData				&#58;D<br />	LOCAL hOleBmp				&#58;D<br /><br />	; Load the picture from the resource file<br />	invoke FindResource,&#91;hModule&#93;,&#91;IDPicture&#93;,2110 ;RT_IMAGE<br />	mov &#91;hFindRes&#93;,eax<br />	invoke SizeofResource,&#91;hModule&#93;,&#91;hFindRes&#93;<br />	mov &#91;ResSize&#93;,eax<br />	or eax,eax<br />	jnz &gt;<br />		dec eax<br />		ret<br />	&#58;<br />	invoke LoadResource,&#91;hModule&#93;,&#91;hFindRes&#93;<br />	mov &#91;hResData&#93;,eax<br />	invoke LockResource,&#91;hResData&#93;<br />	mov &#91;pResData&#93;,eax<br /><br />	invoke GlobalAlloc,GMEM_FIXED,&#91;ResSize&#93;<br />	mov &#91;pGlobal&#93;,eax<br />	<br />	invoke memcopy,&#91;pResData&#93;,&#91;pGlobal&#93;,&#91;ResSize&#93;<br /><br />	invoke CreateStreamOnHGlobal, &#91;pGlobal&#93;, TRUE, ADDR pStream<br />	invoke OleLoadPicture, &#91;pStream&#93;, NULL, TRUE, ADDR IID_IPicture,  ADDR pPicture<br /><br />	test eax,eax<br />	jz &gt;<br />		; no interface<br />		invoke GlobalFree,&#91;pGlobal&#93;<br />		ret<br />	&#58;<br /><br />	mov edi, &#91;pPicture&#93;<br /><br />	push OFFSET hOleBmp<br />	push edi<br />	mov eax, &#91;edi&#93;<br />	call &#91;eax+IPicture.get_Handle&#93;<br /><br />	invoke CopyImage,&#91;hOleBmp&#93;, IMAGE_BITMAP, 0, 0, LR_COPYDELETEORG<br />	push eax<br /><br />	; release the stream<br />	mov eax, &#91;pStream&#93;<br />	push eax<br />	mov eax, &#91;eax&#93;<br />	call &#91;eax+IPicture.Release&#93; <br /><br />	push edi<br />	mov eax, &#91;edi&#93;<br />	call &#91;eax+IPicture.Release&#93;<br />	<br />	invoke GlobalFree,&#91;pGlobal&#93;<br />	pop eax<br />	ret<br />ENDF</code></pre><br /><br />Just hacked it out and it returns a pretty good handle. A quick check only showed less than 1% change in the color table (variation in the RGBQUADs from the original) so it is fairly good. From the look of the table I would probably want to sort it before I used the bitmap as it does not seem to be in any good order but that can be expected from straight GDI functions.</div>
    <div class="meta">Posted on 2004-02-23 13:29:22 by donkey</div>
   </div>
   <div class="post" id="post-134597">
    <div class="subject"><a href="#post-134597">Can i include file jpeg instead bitmap</a></div>
    <div class="body">Great, I'll add it to my snippets folder. :alright: <br />I'll test it with GIFs and metafiles when I get the time. (Or should I say <em>if</em> I get the time? :grin: ).</div>
    <div class="meta">Posted on 2004-02-23 13:51:32 by QvasiModo</div>
   </div>
   <div class="post" id="post-134630">
    <div class="subject"><a href="#post-134630">Can i include file jpeg instead bitmap</a></div>
    <div class="body">Hi QvasiModo,<br /><br />Looked into the GIF format a little and this should return the transparency color :<br /><br /><pre><code>ReadGifHeader FRAME pFileName<br />	LOCAL hFile			&#58;D<br />	LOCAL cbRead			&#58;D<br />	LOCAL format&#91;8&#93;			&#58;B<br />	LOCAL header&#91;8&#93;			&#58;B<br />	<br />	LOCAL Width			&#58;D<br />	LOCAL Height			&#58;D<br />	LOCAL flag			&#58;D<br />	LOCAL iBkgnd			&#58;D<br />	LOCAL AspectRatio		&#58;D<br />	<br />	LOCAL ColorDepth		&#58;D<br />	LOCAL nColors			&#58;D<br />	<br />	LOCAL ColorTable&#91;256&#93;		&#58;D<br />	<br />	LOCAL ExtensionBlock&#91;4&#93;		&#58;D<br />	LOCAL TranspColor		&#58;D<br /><br />	invoke CreateFile,&#91;pFileName&#93;,GENERIC_READ,NULL,NULL,\<br />		OPEN_EXISTING,NULL,NULL<br />	mov &#91;hFile&#93;,eax<br /><br />	; File format &#58;<br />	invoke ReadFile,&#91;hFile&#93;,OFFSET format,6,OFFSET cbRead,NULL<br />	<br />	invoke ReadFile,&#91;hFile&#93;,OFFSET header,7,OFFSET cbRead,NULL<br />	<br />	movzx eax,W&#91;header&#93;<br />	mov &#91;Width&#93;,eax<br />	movzx eax,W&#91;header+2&#93;<br />	mov &#91;Height&#93;,eax<br />	movzx eax,B&#91;header+4&#93;<br />	mov &#91;flag&#93;,eax<br />	<br />	movzx eax,B&#91;header+5&#93;<br />	mov &#91;iBkgnd&#93;,eax<br />	movzx eax,B&#91;header+6&#93;<br />	mov &#91;AspectRatio&#93;,eax<br /><br />	mov eax,&#91;flag&#93;<br />	and eax,7<br />	mov &#91;ColorDepth&#93;,eax<br />	mov ecx,eax<br />	mov eax,2<br />	shl eax,cl<br /><br />	mov &#91;nColors&#93;,eax<br /><br />	mov ecx,eax<br />	shl eax,2<br />	sub eax,ecx<br />	invoke ReadFile,&#91;hFile&#93;,OFFSET ColorTable,eax,OFFSET cbRead,NULL<br /><br />	mov D&#91;TranspColor&#93;,-1<br />	E1&#58;<br />	; Scan the extension blocks for the transparency color &#40;249&#41;<br />	invoke ReadFile,&#91;hFile&#93;,OFFSET ExtensionBlock,2,OFFSET cbRead,NULL<br />	movzx eax,B&#91;ExtensionBlock&#93;<br />	cmp eax,021h<br />	jne &gt;&gt;E2<br />		movzx eax,B&#91;ExtensionBlock+1&#93;<br />		cmp eax,0F9h<br />		jne &lt;E1<br />		invoke ReadFile,&#91;hFile&#93;,OFFSET ExtensionBlock,8,OFFSET cbRead,NULL<br />		movzx eax,B&#91;ExtensionBlock+4&#93;<br />		mov ecx,eax<br />		shl eax,2<br />		sub eax,ecx<br />		mov eax,&#91;ColorTable+eax&#93;<br />		and eax,0FFFFFFh<br />		mov &#91;TranspColor&#93;,eax<br />		<br />	E2&#58;<br />	invoke CloseHandle,&#91;hFile&#93;<br />	mov eax,&#91;TranspColor&#93;<br />	RET<br />ENDF</code></pre></div>
    <div class="meta">Posted on 2004-02-23 19:54:26 by donkey</div>
   </div>
   <div class="post" id="post-135134">
    <div class="subject"><a href="#post-135134">Can i include file jpeg instead bitmap</a></div>
    <div class="body">Been toying with your snippets for a while... this is the result.<br />Two issues:<br /><br />1. Since we're using the get_Handle method to get the bitmap (and then copying it), shouldn't we copy the pallete as well?<br /><br />2. Your function will get the RGB values of the transparent GIF, and AFAIK we should use the pallete entry instead. We might have a repeated color in the pallete, one transparent and the other opaque. That would mess up the transparency. Should be easy to fix as long as the IPicture object does not alter the image's original pallete values.<br /><br />BTW, my sample prog isn't even loading the picture... don't know why. :confused:<br /><br />EDIT: Attachment updated. It's still not working as I want it to - but this is taking me time from other projects. Maybe I'll finish it later, maybe someone else will? :)</div>
    <div class="meta">Posted on 2004-03-01 18:41:44 by QvasiModo</div>
   </div>
   <div class="post" id="post-135135">
    <div class="subject"><a href="#post-135135">Can i include file jpeg instead bitmap</a></div>
    <div class="body">I also did this. :)<br />It's quick and dirty, and I didn't test it yet.<br /><pre><code>; LoadPictureRes<br />;  Loads a picture from a resource into a GDI bitmap, using the IPicture interface.<br />;  Original GoASM code by Donkey<br />;  Conversion to MASM by QvasiModo<br /><br />.code<br />align DWORD<br />LoadPictureRes PROC USES edi hModule&#58;DWORD,IDPicture&#58;DWORD<br />	LOCAL pPicture				&#58;DWORD<br />	LOCAL pGlobal				&#58;DWORD<br />	LOCAL pStream				&#58;DWORD<br />	LOCAL hFindRes				&#58;DWORD<br />	LOCAL ResSize				&#58;DWORD<br />	LOCAL hResData				&#58;DWORD<br />	LOCAL pResData				&#58;DWORD<br />	LOCAL hOleBmp				&#58;DWORD<br /><br />	; Load the picture from the resource file<br />	invoke FindResource, hModule, IDPicture, 2110 ;RT_IMAGE<br />	mov hFindRes, eax<br />	invoke SizeofResource, hModule, hFindRes<br />	test eax, eax<br />	.if zero?<br />		dec eax<br />		ret<br />	.endif<br />	mov ResSize, eax<br />	invoke LoadResource, hModule, hFindRes<br />	mov hResData, eax<br />	invoke LockResource, hResData	<br />	mov pResData, eax<br /><br />	invoke GlobalAlloc, GMEM_FIXED, ResSize<br />	mov pGlobal, eax<br />	<br />	invoke memcopy,pResData,pGlobal,ResSize<br /><br />	invoke CreateStreamOnHGlobal, pGlobal, TRUE, ADDR pStream<br />	invoke OleLoadPicture, pStream, NULL, TRUE, ADDR IID_IPicture, ADDR pPicture<br /><br />	test eax, eax<br />	.if ! zero?<br />		; no interface<br />		invoke GlobalFree, pGlobal<br />		ret<br />	.endif<br /><br />	mov edi, pPicture<br /><br />	push OFFSET hOleBmp<br />	push edi<br />	mov eax, &#91;edi&#93;<br />	call &#91;eax&#93;.IPicture.get_Handle<br /><br />	invoke CopyImage,hOleBmp, IMAGE_BITMAP, 0, 0, LR_COPYDELETEORG<br />	push eax<br /><br />	; release the stream<br />	mov eax, pStream<br />	push eax<br />	mov eax, &#91;eax&#93;<br />	call &#91;eax&#93;.IPicture.Release<br /><br />	push edi<br />	mov eax, &#91;edi&#93;<br />	call &#91;eax&#93;.IPicture.Release<br />	<br />	invoke GlobalFree,pGlobal<br />	pop eax<br />	ret<br /><br />LoadPictureRes ENDP</code></pre></div>
    <div class="meta">Posted on 2004-03-01 18:47:08 by QvasiModo</div>
   </div>
   <div class="post" id="post-135142">
    <div class="subject"><a href="#post-135142">Can i include file jpeg instead bitmap</a></div>
    <div class="body">Just to be pedantic - is it okay to use GMEM_FIXED for the GlobalAlloc call? CreateStreamOnHGlobal wants a HGLOBAL as the first parameter, but using GMEM_FIXED returns a pointer, not a HGLOBAL.<br /><br />Fortunately win32 works a lot different than old 16bit pmode, so a HGLOBAL seems to be more or less a memory pointer, but... there is some difference between allocating with GMEM_FIXED and getting a &quot;true pointer&quot;, and not using GMEM_FIXED and getting a (pseudo?) handle.<br /><br />I haven't experienced any crashes or such on my own win2k, but I guess there might be a tiny risk of some internal structure corruption (though that might only happen, if at all, when treating the return value of GlobalAlloc without GMEM_FIXED flag as a pointer).<br /><br />Don't know how bad it is in practice, but at least it <strong>seems</strong> &quot;logically wrong&quot; to use GMEM_FIXED for the memory?</div>
    <div class="meta">Posted on 2004-03-02 03:40:17 by f0dder</div>
   </div>
   <div class="post" id="post-135159">
    <div class="subject"><a href="#post-135159">Can i include file jpeg instead bitmap</a></div>
    <div class="body">You have a point, I overlooked the fact that a I needed a handle, not a pointer. I'll try that, thanks! :)</div>
    <div class="meta">Posted on 2004-03-02 13:29:35 by QvasiModo</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=16817&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=16817&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="16817" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=16817&amp;page=2">&gt;</a><a href="../?id=16817&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>