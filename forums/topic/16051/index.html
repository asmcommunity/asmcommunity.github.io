<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Need Help!!! - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=16051" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=16051">Need Help!!!</a></p>
   <div class="post" id="post-124433">
    <div class="subject"><a href="#post-124433">Need Help!!!</a></div>
    <div class="body">i am new to asm programming,the code below is to use SSE to compute the product of two 4*4 matrix,i use the visual studio.net 2003 to built it,it have runtime error,but it works well when i change <br />float m2[4][4],m1[4][4],m3[4][4];<br />to<br />float m1[4][4],m2[4][4],m3[4][4];<br />is it a bug in the complier?can try it in other environment.<br /> <br /><pre><code><br />/////////////////////////////<br /><br />#include&lt;stdio.h&gt;<br /><br />#define FILE_IN &quot;input.txt&quot;<br />#define FILE_OUT &quot;output.txt&quot;<br /><br />void MultiMatrix&#40;float dest&#91;4&#93;&#91;4&#93;,float src1&#91;4&#93;&#91;4&#93;,float src2&#91;4&#93;&#91;4&#93;&#41;<br />&#123;<br />    _asm<br />    &#123;<br />        mov     ecx,src1;<br />        mov     edx,src2;<br />        mov     eax,dest;<br />        movss   xmm0,&#91;ecx&#93;;<br />        shufps  xmm0,xmm0,00h;<br />        movss   xmm1,&#91;ecx+4&#93;;<br />        shufps  xmm1,xmm1,00h;<br />        movss   xmm2,&#91;ecx+8&#93;;<br />        shufps  xmm2,xmm2,00h;<br />        movss   xmm3,&#91;ecx+12&#93;;<br />        shufps  xmm3,xmm3,00h;<br />        movaps  xmm4,&#91;edx&#93;;<br />        movaps  xmm5,&#91;edx+16&#93;;<br />        movaps  xmm6,&#91;edx+32&#93;;<br />        movaps  xmm7,&#91;edx+48&#93;;<br />        mulps   xmm0,xmm4;<br />        mulps   xmm1,xmm5;<br />        mulps   xmm2,xmm6;<br />        mulps   xmm3,xmm7;<br />        addps   xmm0,xmm1;<br />        addps   xmm0,xmm2;<br />        addps   xmm0,xmm3;<br />        movups  &#91;eax&#93;,xmm0;<br />        <br />        movss   xmm0,&#91;ecx+16&#93;;<br />        shufps  xmm0,xmm0,00h;<br />        movss   xmm1,&#91;ecx+20&#93;;<br />        shufps  xmm1,xmm1,00h;<br />        movss   xmm2,&#91;ecx+24&#93;;<br />        shufps  xmm2,xmm2,00h;<br />        movss   xmm3,&#91;ecx+28&#93;;<br />        shufps  xmm3,xmm3,00h;<br />        mulps   xmm0,xmm4;<br />        mulps   xmm1,xmm5;<br />        mulps   xmm2,xmm6;<br />        mulps   xmm3,xmm7;<br />        addps   xmm0,xmm1;<br />        addps   xmm0,xmm2;<br />        addps   xmm0,xmm3;<br />        movups  &#91;eax+16&#93;,xmm0;<br /><br />        movss   xmm0,&#91;ecx+32&#93;;<br />        shufps  xmm0,xmm0,00h;<br />        movss   xmm1,&#91;ecx+36&#93;;<br />        shufps  xmm1,xmm1,00h;<br />        movss   xmm2,&#91;ecx+40&#93;;<br />        shufps  xmm2,xmm2,00h;<br />        movss   xmm3,&#91;ecx+44&#93;;<br />        shufps  xmm3,xmm3,00h;<br />        mulps   xmm0,xmm4;<br />        mulps   xmm1,xmm5;<br />        mulps   xmm2,xmm6;<br />        mulps   xmm3,xmm7;<br />        addps   xmm0,xmm1;<br />        addps   xmm0,xmm2;<br />        addps   xmm0,xmm3;<br />        movups  &#91;eax+32&#93;,xmm0;<br />        <br />        movss   xmm0,&#91;ecx+48&#93;;<br />        shufps  xmm0,xmm0,00h;<br />        movss   xmm1,&#91;ecx+52&#93;;<br />        shufps  xmm1,xmm1,00h;<br />        movss   xmm2,&#91;ecx+56&#93;;<br />        shufps  xmm2,xmm2,00h;<br />        movss   xmm3,&#91;ecx+60&#93;;<br />        shufps  xmm3,xmm3,00h;<br />        mulps   xmm0,xmm4;<br />        mulps   xmm1,xmm5;<br />        mulps   xmm2,xmm6;<br />        mulps   xmm3,xmm7;<br />        addps   xmm0,xmm1;<br />        addps   xmm0,xmm2;<br />        addps   xmm0,xmm3;<br />        movups  &#91;eax+48&#93;,xmm0;<br />    &#125;<br />&#125;<br /><br />int main&#40;&#41;<br />&#123;<br />    int i,j;<br />    FILE *fin,*fout;<br />    float m2&#91;4&#93;&#91;4&#93;,m1&#91;4&#93;&#91;4&#93;,m3&#91;4&#93;&#91;4&#93;;<br />    <br />    fin = fopen&#40;FILE_IN,&quot;r&quot;&#41;;<br />    fout = fopen&#40;FILE_OUT,&quot;w&quot;&#41;;<br /><br />    for&#40;i=0;i&lt;4;++i&#41;<br />        for&#40;j=0;j&lt;4;++j&#41;<br />            fscanf&#40;fin,&quot;%f&quot;,&amp;m1&#91;i&#93;&#91;j&#93;&#41;;<br />            <br />    for&#40;i=0;i&lt;4;++i&#41;<br />        for&#40;j=0;j&lt;4;++j&#41;<br />            fscanf&#40;fin,&quot;%f&quot;,&amp;m2&#91;i&#93;&#91;j&#93;&#41;;            <br />            <br />    MultiMatrix&#40;m3,m1,m2&#41;;<br />    <br />    for&#40;i=0;i&lt;4;++i&#41;<br />    &#123;<br />        for&#40;j=0;j&lt;4;++j&#41;<br />            fprintf&#40;fout,&quot;%f &quot;,m3&#91;i&#93;&#91;j&#93;&#41;;<br />        fprintf&#40;fout,&quot;\n&quot;&#41;;<br />    &#125;<br /><br />    fclose&#40;fin&#41;;<br />    fclose&#40;fout&#41;;<br /><br />    return 0;<br /><br />&#125;<br /><br />//////////////////////<br />input.txt<br /><br />1.2 2.1 3.2 0<br />1.0 1.0 1.0 1.0<br />3.0 4.1 5.2 192.1<br />2.3 4.3 5.8 6.0<br /><br />1.2 2.1 1.0 0<br />11.0 1.0 1.0 1.0<br />3.0 24.1 1.0 192.1<br />22.3 4.35 1.0 6.01<br /><br />/////////////////////<br /></code></pre></div>
    <div class="meta">Posted on 2003-11-15 07:32:26 by fairstar</div>
   </div>
   <div class="post" id="post-124514">
    <div class="subject"><a href="#post-124514">Need Help!!!</a></div>
    <div class="body">The problem is that movaps needs a pointer aligned on a 16-byte boundary and the local arguments are aligned on 4-byte boundary. Use movups or align the locals manually.<br /><br />__declspec(align(16)) will force 16-byte alignment for the local variables.</div>
    <div class="meta">Posted on 2003-11-16 10:57:02 by Dr. Manhattan</div>
   </div>
  </div>
 </body>
</html>