<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>The Web Browser Control (Once Again) - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=703" />
    <link rel="next" href="../?id=703&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=116">Windows</a> &raquo; <a href="../?id=703">The Web Browser Control (Once Again)</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=703&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=703&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="703" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=703&amp;page=2">&gt;</a><a href="../?id=703&amp;page=2">&raquo;</a></form>   <div class="post" id="post-4222">
    <div class="subject"><a href="#post-4222">The Web Browser Control (Once Again)</a></div>
    <div class="body">Hello All,<br /><br />At one time ernie and I were working on getting a Web Browser<br />control to inplace activate on a window. I did complete the code<br />but didn't transfer it to anyone. My harddrive crashed some time<br />ago and unfortunately, I'm now stuck on some of the original<br />problems I solved eariler:<br /><br />1) Is OLEIVERB_INPLACEACTIVATE = -5L the same as<br />    OLEIVERB_INPLACEACTIVATE equ 0FFFFFFFBh ?<br /><br />2) Ensuring that my client site is well defined.<br /><br />3) The return value from the LocalAlloc function in the<br />    &quot;CreateObject&quot; function is the C++ &quot;This&quot; pointer.<br />    RiGhT?????<br /><br />4) Getting people to <strong>not</strong> loose respect for me<br />    because of my QueryInterface code. It will be fixed...<br /><br /><br /><strong>See the source code attachment. Be sure to change the<br />paths in Browser.inc.</strong><br /><br /><br />:alright: Xtreme</div>
    <div class="meta">Posted on 2001-08-20 09:04:16 by Xtreme</div>
   </div>
   <div class="post" id="post-4272">
    <div class="subject"><a href="#post-4272">The Web Browser Control (Once Again)</a></div>
    <div class="body">According to calc.exe -5 = 0xFFFFxFFFB .  What does your code do?</div>
    <div class="meta">Posted on 2001-08-20 23:16:15 by eet_1024</div>
   </div>
   <div class="post" id="post-4301">
    <div class="subject"><a href="#post-4301">The Web Browser Control (Once Again)</a></div>
    <div class="body">1) My calc.exe agrees with eets. Basically, if you set HEX mode to DWORD, then set back to decimal mode, type in a negative number, then switch again to HEX, you get the HEX representation of the negative decimal number (IE, -5 becomes FFFFFFFB)<br /><br />2) Huh? (guess I best read your source later)<br /><br />3) exactly correct.<br /><br />4) No comment, as long as you don't comment on my registrar script parser. QueryInterface will always look ugly until you do something like make it scan a table (at which point it becomes inintelegable and thus looks 'realy leet.')</div>
    <div class="meta">Posted on 2001-08-21 06:39:07 by Ernie</div>
   </div>
   <div class="post" id="post-4308">
    <div class="subject"><a href="#post-4308">The Web Browser Control (Once Again)</a></div>
    <div class="body">eet_1024,<br /><br />This code should display the MS Web Browser control on a<br />window and allow one to display (D)HTML.<br /><br /><strong><br />Note: You have to click the client area of the window to make it<br />create the control. Or you could move &quot;invoke CreateWB&quot; to<br />WM_CREATE.<br /></strong><br /><br />Unfortunately the DoVerb function of IOleObject fails and I don't<br />understand why...<br /><br />Xtreme</div>
    <div class="meta">Posted on 2001-08-21 07:51:14 by Xtreme</div>
   </div>
   <div class="post" id="post-4310">
    <div class="subject"><a href="#post-4310">The Web Browser Control (Once Again)</a></div>
    <div class="body">Just for completeness:<br /><br />-5 =<br /><br />0xB for 4-bit<br />0xFB for 8-bit<br />0xFFFB for 16-bit<br />0xFFFFFFFB for 32-bit<br />0xFFFFFFFFFFFFFFFB for 64 bit<br />...you get the idea...<br />negitive numbers are a relitive concept, and the bit count includes one bit for sign.<br /><br />I'll have to checkout that code when I have more time.</div>
    <div class="meta">Posted on 2001-08-21 08:27:30 by bitRAKE</div>
   </div>
   <div class="post" id="post-4311">
    <div class="subject"><a href="#post-4311">The Web Browser Control (Once Again)</a></div>
    <div class="body">bitRAKE,<br /><br />Thanks for the breakdown. The primary thing that confused me<br />was the 'L' in -5L. There are other number &quot;extensions&quot; in the<br />C++ header files that I don't get as well: U and t (note the case).<br />I suppose these mean Long, UINT, and t...(something).<br /><br />At any rate the contant was defined correctly so there must be<br />a goof in my class definition (client site).</div>
    <div class="meta">Posted on 2001-08-21 08:44:31 by Xtreme</div>
   </div>
   <div class="post" id="post-4350">
    <div class="subject"><a href="#post-4350">The Web Browser Control (Once Again)</a></div>
    <div class="body">I have the original C++ source (<strong>NO mfc</strong>) if anyone needs it.<br />I may just post it here anyway...</div>
    <div class="meta">Posted on 2001-08-21 15:56:55 by Xtreme</div>
   </div>
   <div class="post" id="post-4424">
    <div class="subject"><a href="#post-4424">The Web Browser Control (Once Again)</a></div>
    <div class="body">X,<br /><br />  Do you realize that when you're done you should be able to host most any activeX control on your window?<br /><br />  To host any control, you need to build a client site. Client sites are kinda generic.</div>
    <div class="meta">Posted on 2001-08-22 07:03:09 by Ernie</div>
   </div>
   <div class="post" id="post-4430">
    <div class="subject"><a href="#post-4430">The Web Browser Control (Once Again)</a></div>
    <div class="body">Ernie,<br /><br />The Object struct instance is the client site.<br />Any idea why DoVerb is failing?<br /><br />Its probably something in &quot;CreateObject&quot;... <br /><br />Thanks! <br /><br />PS: When I'm finished I'll send you a formal version to put in the<br />COM section of the MASM32 package, along with a tut...</div>
    <div class="meta">Posted on 2001-08-22 07:43:47 by Xtreme</div>
   </div>
   <div class="post" id="post-4535">
    <div class="subject"><a href="#post-4535">The Web Browser Control (Once Again)</a></div>
    <div class="body">Sorry, I never got that far into insertable objects to know the fine points of do verbs.<br /><br />The general purpose stuff sounds great. You don't have to wait for me, you can publish on your own too. Want a link on my page?</div>
    <div class="meta">Posted on 2001-08-22 20:16:55 by Ernie</div>
   </div>
   <div class="post" id="post-4584">
    <div class="subject"><a href="#post-4584">The Web Browser Control (Once Again)</a></div>
    <div class="body">Xtreme,<br /><br />code in CreateObject should look like:<br /><br /><pre><code><br /><br />        mov  ebx, eax<br />        mov 	eax,pobj<br />        mov     &#91;eax&#93;, ebx<br /><br />        mov     &#40;Object ptr &#91;ebx&#93;&#41;.nRefCount,0                                           <br /></code></pre><br /><br />that is because parameter is a pointer to an object, not the object itself.<br /><br />After this change your program still crashes <br />:grin: <br /><br />Reason is: your parameter to SetClientSite is wrong. Be sure that your parameter is a pointer to an IClientSite interface. <br />May be you should change code to:<br /><pre><code><br />    ; Set the Web Browser Control's site<br />;        coinvoke _pIOleObject, IOleObject, SetClientSite, &#91;pif&#93;<br />		mov eax,pif<br />		lea eax,&#91;eax&#93;.Object.iOleClientSite.lpVtbl<br />        coinvoke _pIOleObject, IOleObject, SetClientSite, eax<br /><br /></code></pre><br /><br />with this changes done, the OleClientSite procs are called, but after some time the program crashes.<br /><br /><br />regards,<br /><br />japheth</div>
    <div class="meta">Posted on 2001-08-23 07:27:17 by japheth</div>
   </div>
   <div class="post" id="post-4590">
    <div class="subject"><a href="#post-4590">The Web Browser Control (Once Again)</a></div>
    <div class="body">Heres the original C++ source code. Its actually useful in itself<br />because it doesn't use MFC.<br /><br />The package includes an EXE that shows the WB Control in action.<br /><br />Note: Right-click somewhere on the window background to see the IE context menu.</div>
    <div class="meta">Posted on 2001-08-23 09:16:58 by Xtreme</div>
   </div>
   <div class="post" id="post-4596">
    <div class="subject"><a href="#post-4596">The Web Browser Control (Once Again)</a></div>
    <div class="body">Xtreme<br /><br />I had a second look at your code.<br /><br />you should think once again about your macro GETOBJECTPOINTER.<br /><br />In my opinion it does not work correctly. Consider QueryInterface: this function can be called from any interface. To subtract a value depending just on the queriing interface will not work.<br /><br />Have a look at Ernie's examples. For every supported Interface there exists an entry:<br /><br /><pre><code><br />ObjectEntry  STRUCT  DWORD<br />    m_pVtbl         DWORD       0       ; interface object<br />    m_pBase         DWORD       0       ; pointer to base<br />ObjectEntry  ENDS<br /></code></pre><br /><br />and the object (ASMCTRL i.e.) ist defined like:<br /><br /><pre><code><br />AsmCtrlObject    STRUCT<br />    ObjectData0     ObjectData      &#123; &#125;     ; base values<br />    AsmCtrlData0    AsmCtrlData     &#123; &#125;     ; custom object data<br />    ObjectEntry0    ObjectEntry     &#123; &#125;     ; delegated Unknown<br />    ObjectEntry1    ObjectEntry     &#123; &#125;     ; IAsmCtrl<br />    ObjectEntry2    ObjectEntry     &#123; &#125;     ; IOleObject<br /></code></pre><br /><br />this is more complicated I admit but it cannot be avoided.<br /><br />japheth</div>
    <div class="meta">Posted on 2001-08-23 10:32:22 by japheth</div>
   </div>
   <div class="post" id="post-4601">
    <div class="subject"><a href="#post-4601">The Web Browser Control (Once Again)</a></div>
    <div class="body">Japheth,<br /><br /><span style="font-size:9px><em>You are correct.<br /><br />I didn't change <a target="_blank" href="http://asm.tsx.org">Bill T's</a> original macro code to suit my needs. This<br />is a down side to having code &quot;definitions&quot; and source in different<br />files. The &quot;Object.Interface&quot; that Bill calls on does not exist in my<br />app...<br /><br />THANK YOU!</em></span><br /><br /><br />OOPs... I spoke too soon.<br /><br />I didn't relize that Interface is a parameter passed to the macro.<br />How can this then be incorrect? Besides how can the<br />IOleClientSite procs get called if this is wrong?</div>
    <div class="meta">Posted on 2001-08-23 11:20:09 by Xtreme</div>
   </div>
   <div class="post" id="post-4677">
    <div class="subject"><a href="#post-4677">The Web Browser Control (Once Again)</a></div>
    <div class="body">Xtreme,<br /><br />to get your code to work I have changed macro GETOBJECTPOINTER to:<br /><br /><pre><code><br />        GETOBJECTPOINTER MACRO Object, Interface, pif<br />                mov     eax, pif<br />	sub	eax,<br />        ENDM<br /><pre><code><br /><br />the definition of Object to:<br /><br />&#91;code&#93;<br />; declare the site structure<br /><br />        Object struct<br />               iUnknown            IIUnknown            &lt;?&gt;<br />	iBase0 dd ?<br />                iOleWindow          IIOleWindow          &lt;?&gt;<br />	iBase1 dd ?<br />                iOleClientSite      IIOleClientSite      &lt;?&gt;<br />	iBase2 dd ?<br />                iOleInPlaceSite     IIOleInPlaceSite     &lt;?&gt;<br />	iBase3 dd ?<br />                iDispatch           IIDispatch           &lt;?&gt;<br />	iBase4 dd ?<br />                iDocHostUIHandler   IIDocHostUIHandler   &lt;?&gt;<br />	iBase5 dd ?<br />                iDocHostShowUI      IIDocHostShowUI      &lt;?&gt;<br />	iBase6 dd ?<br />                nRefCount           dd                    ?<br />        Object ends<br />&#91;/code&#93;<br /><br />and CreateObject to:<br /><br />&#91;code&#93;<br />        mov     (Object ptr ).iOleInPlaceSite.lpVtbl, offset vtblIOleInPlaceSite       ; save the offset(pointer) to the interface VTABLE in lpVtbl<br />        mov     (Object ptr ).iDispatch.lpVtbl, offset vtblIDispatch                   ; save the offset(pointer) to the interface VTABLE in lpVtbl<br />        mov     (Object ptr ).iDocHostUIHandler.lpVtbl, offset vtblIDocHostUIHandler   ; save the offset(pointer) to the interface VTABLE in lpVtbl<br />        mov     (Object ptr ).iDocHostShowUI.lpVtbl, offset vtblIDocHostShowUI         ; save the offset(pointer) to the interface VTABLE in lpVtbl<br />		mov		.Object.iBase0,0<br />		mov		.Object.iBase1,8<br />		mov		.Object.iBase2,16<br />		mov		.Object.iBase3,24<br />		mov		.Object.iBase4,32<br />		mov		.Object.iBase5,40<br />		mov		.Object.iBase6,48<br />&#91;/code&#93;<br /><br />with this changes QueryInterface always returns the correct interface. Without this changes the webbrowser control queries for IDispatch and gets IOleInPlaceSite (or was it IOleClientSite? I forgot). And the interface pointer to IOleClientSite is received by the object thru the call IOleObject:SetClientSite, not by QueryInterface.<br /><br />when executing this code I get so far that IDispatch:Invoke is called from the webbrowser control twice. But then it crashes again. I had no time yet to check this.<br /><br />japheth</div>
    <div class="meta">Posted on 2001-08-24 03:13:55 by japheth</div>
   </div>
   <div class="post" id="post-4720">
    <div class="subject"><a href="#post-4720">The Web Browser Control (Once Again)</a></div>
    <div class="body">japeth,<br /><br />Last night I examined the macro more closely. I agree that is<br />is just too simple to work here. I also placed messageboxes<br />in the queryinterface function of both the C++ and ASM versions.<br />The C++ version doesn't call IOleClientSite at all (at least on start<br />up) but the ASM version does (its the second and fourth interface<br />call). This undoubtably means theres a problem with the ASM<br />QueryInterface function (As my second look at your post shows<br />you found!).<br /><br />Also note that I found some errors in:<br /><br /><ul><br />[*]Declarations of IDispatch, IOleWindow, IOleClientSite,<br />    and IOleInPlaceSite. See Ernie's \masm32\COM\include\<br />    component.inc for proper declares. Or does it really matter<br />    that I declare a BOOL as BYTE and SIZE as SIZEL?<br /><br />[*]AddRef and Release. I uncommented them and used nRefCount<br />    as a &quot;normal&quot; (global) variable as in the C++ version.<br /><br />[*]Possibly the CoCreateInstance call: Why are the first, forth,<br />    and fifth parameters, pointers and in the C++ version only the<br />    fifth one is? If you remove the addrs assembly error occurs... <br /><br /><br />---------------------------------------------------------------------------------<br /><br />The changes above wouldn't break the code to set the client<br />site would it? It looks to me that there are now two ways to<br />write that same code...</div>
    <div class="meta">Posted on 2001-08-24 08:53:02 by Xtreme</div>
   </div>
   <div class="post" id="post-4762">
    <div class="subject"><a href="#post-4762">The Web Browser Control (Once Again)</a></div>
    <div class="body">Xtreme,<br /><br />to answer your questions:<br /><br />1. No. Important is the number of parameters.<br />2. For the first step we can live without them<br />3. CoCreateInstance works definitely, this is no problem<br /><br />Currently your modified program does not crash any more, it shows a &quot;blank&quot; page. QueryInterface works. 2 additional errors I have found so far are:<br /><br />a. IOleInPlaceSite inherits from IOleWindow, not IUnknown. That is you must include GetWindow and ContextSensitiveHelp in the vtable.<br /><br />b. IsEqualGUID is a function from OLE32.LIB. Better use this function than implement your own version. For your own version does not save esi and edi registers.<br /><br />japheth</div>
    <div class="meta">Posted on 2001-08-24 14:02:09 by japheth</div>
   </div>
   <div class="post" id="post-4765">
    <div class="subject"><a href="#post-4765">The Web Browser Control (Once Again)</a></div>
    <div class="body">Japeth,<br /><br />I'm looking into your last post over the weekend...<br /><br />Thank You!</div>
    <div class="meta">Posted on 2001-08-24 14:17:47 by Xtreme</div>
   </div>
   <div class="post" id="post-4774">
    <div class="subject"><a href="#post-4774">The Web Browser Control (Once Again)</a></div>
    <div class="body">Xtreme,<br /><br />I have got it to work now.<br /><br />Note:<br /><br />- I have put your files together into one file (since without that VC could not display source code)<br /><br />- I had no definition for IWebBrowser2 available, so I just included the minimum of IWebBrowser interface<br /><br />- the path to frames.htm is hard coded in browser.asm<br /><br />- changing of client area isnt implemented yet<br /><br /><br />It is a very interesting project. Next step is to implement event sinks (support IConnectionPointContainer). <br /><br />japheth</div>
    <div class="meta">Posted on 2001-08-24 15:47:38 by japheth</div>
   </div>
   <div class="post" id="post-4776">
    <div class="subject"><a href="#post-4776">The Web Browser Control (Once Again)</a></div>
    <div class="body">Japheth,<br /><br />Only one problem Assembler can't find IWebBrowser_Navigate <br />at line 547....<br /><br />I look at it at home as well as connectionpoint....<br /><br />THANKS!</div>
    <div class="meta">Posted on 2001-08-24 16:12:24 by Xtreme</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=703&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=703&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="703" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=703&amp;page=2">&gt;</a><a href="../?id=703&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>