<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>A few socket problems - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=11691" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=8">Networking</a> &raquo; <a href="../?id=11691">A few socket problems</a></p>
   <div class="post" id="post-88768">
    <div class="subject"><a href="#post-88768">A few socket problems</a></div>
    <div class="body">While developing a client and server (both using blocking mode calls) I got into a few minor problems. <br />The client I'm creating should get one response for every time it does a request to the server. Once this &quot;ping - pong&quot; is done the client should disconnect and cleanup gracefully. This includes memory and the open socket.<br /><br />A typical sequense goes like this.<br /><br />1. Client sends request for server.<br />2. Server gives exactly one response.<br />...<br />3. Goto 1<br />...<br />4. Client is done and calls shutdown with parameter SD_BOTH and then closesocket.<br />5. Server will do a recv() call where it gets 0 as return value and assume the client is disconnecting.<br />6. Server calls shutdown with SD_BOTH param calls closesocket() and free's the memory used by the client.<br /><br />So both the server and client runs the same sequense.<br />Now I shut down both programs and netstat shows this:<br /><br />  TCP    cyber_server:4823      PII-400:6500           TIME_WAIT<br />  TCP    cyber_server:4824      PII-400:6500           TIME_WAIT<br />  TCP    cyber_server:4825      PII-400:6500           TIME_WAIT<br />  TCP    cyber_server:4826      PII-400:6500           TIME_WAIT<br />  TCP    cyber_server:4827      PII-400:6500           TIME_WAIT<br />  TCP    cyber_server:4828      PII-400:6500           TIME_WAIT<br />  TCP    cyber_server:4829      PII-400:6500           TIME_WAIT<br />  TCP    cyber_server:4830      PII-400:6500           TIME_WAIT<br />  TCP    cyber_server:4831      PII-400:6500           TIME_WAIT<br />  TCP    cyber_server:4832      PII-400:6500           TIME_WAIT<br />(This test was made by running the client in a endless loop)<br />The first column is the client and the server is second column which listens on port 6500.<br /><br />So how can the socket stay open even though I closed it?<br /><br />The other problem I'm having is a slow DNS lookup. On one of the machines I have it can take up to about 20-30 seconds to make a dns lookup even though it's on local network. The following code (written in C) is what I use to get the server ip:<br /><br />  // Try to use the host as a ip<br />  sin.sin_addr.s_addr = inet_addr(szHost);<br />  if (sin.sin_addr.s_addr == INADDR_NONE)<br />  {<br />    // Make a dns request<br />    if ((lpHost = gethostbyname(szHost)) == NULL)<br />    {<br />      printf(&quot;DNS lookup of server failed\n&quot;);<br />      return false;<br />    }<br />    sin.sin_addr.s_addr = *((unsigned long *) lpHost-&gt;h_addr);<br />  }<br /><br />It seems the process called System is taking all cpu time in the time the lookup happens. The odd thing is though that a few times in a row the lookup can be fast while most of the time it's slow. Is this a correct way to do DNS lookups?<br /><br />All tests were made under Windows 2000.<br /><br />Thanks in advance.<br /><br />// CyberHeg</div>
    <div class="meta">Posted on 2003-03-21 11:31:27 by CyberHeg</div>
   </div>
   <div class="post" id="post-88785">
    <div class="subject"><a href="#post-88785">Re: A few socket problems</a></div>
    <div class="body"><div class="quote"><em>Originally posted by CyberHeg </em><br />So both the server and client runs the same sequense.<br />Now I shut down both programs and netstat shows this:<br /><br />  TCP    cyber_server:4823      PII-400:6500           TIME_WAIT<br />  TCP    cyber_server:4824      PII-400:6500           TIME_WAIT<br />  TCP    cyber_server:4825      PII-400:6500           TIME_WAIT<br />  TCP    cyber_server:4826      PII-400:6500           TIME_WAIT<br />  TCP    cyber_server:4827      PII-400:6500           TIME_WAIT<br />  TCP    cyber_server:4828      PII-400:6500           TIME_WAIT<br />  TCP    cyber_server:4829      PII-400:6500           TIME_WAIT<br />  TCP    cyber_server:4830      PII-400:6500           TIME_WAIT<br />  TCP    cyber_server:4831      PII-400:6500           TIME_WAIT<br />  TCP    cyber_server:4832      PII-400:6500           TIME_WAIT<br />(This test was made by running the client in a endless loop)<br />The first column is the client and the server is second column which listens on port 6500.<br /><br />So how can the socket stay open even though I closed it?</div><br />Nothing to worry about :): <br /><a target="_blank" href="http://tangentsoft.net/wskfaq/advanced.html#waitstates">4.11 - What do the FIN_WAIT_x, TIME_WAIT, CLOSE_WAIT and other states mean?</a><br /><br /><div class="quote">The other problem I'm having is a slow DNS lookup. On one of the machines I have it can take up to about 20-30 seconds to make a dns lookup even though it's on local network. The following code (written in C) is what I use to get the server ip:<br /><br />  // Try to use the host as a ip<br />  sin.sin_addr.s_addr = inet_addr(szHost);<br />  if (sin.sin_addr.s_addr == INADDR_NONE)<br />  {<br />    // Make a dns request<br />    if ((lpHost = gethostbyname(szHost)) == NULL)<br />    {<br />      printf(&quot;DNS lookup of server failed\n&quot;);<br />      return false;<br />    }<br />    sin.sin_addr.s_addr = *((unsigned long *) lpHost-&gt;h_addr);<br />  }<br /><br />It seems the process called System is taking all cpu time in the time the lookup happens. The odd thing is though that a few times in a row the lookup can be fast while most of the time it's slow. Is this a correct way to do DNS lookups?<br /></div><br />It is the correct way, I don't know why your DNS lookup is so slow. Is it slow as well when you use nslookup in a cmd screen? The only time I've seen slow blocking host lookups is when the host doesn't exists. Maybe somehow your local network names are not resolved correctly and windows tries to find them with your ISPs DNS server :confused:. You could try a packet logger like ethereal to see what's happening behind the scenes.<br /> <br />Thomas</div>
    <div class="meta">Posted on 2003-03-21 13:10:44 by Thomas</div>
   </div>
   <div class="post" id="post-88951">
    <div class="subject"><a href="#post-88951">Re: Re: A few socket problems</a></div>
    <div class="body"><div class="quote"><br /><br /><br />Thanks thats what I wanted to know.<br />It is the correct way, I don't know why your DNS lookup is so slow. Is it slow as well when you use nslookup in a cmd screen? The only time I've seen slow blocking host lookups is when the host doesn't exists. Maybe somehow your local network names are not resolved correctly and windows tries to find them with your ISPs DNS server :confused:. You could try a packet logger like ethereal to see what's happening behind the scenes.<br /> <br />Thomas </div><br /><br />I just checked with ping command on the same machine and it acts the same way so I conclude it's some mess with bad dns setup.<br /><br />Thanks again.<br /><br />// CyberHeg</div>
    <div class="meta">Posted on 2003-03-22 01:47:18 by CyberHeg</div>
   </div>
  </div>
 </body>
</html>