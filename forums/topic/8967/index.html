<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Opcode #2 - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=8967" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=8967">Opcode #2</a></p>
   <div class="post" id="post-65986">
    <div class="subject"><a href="#post-65986">Opcode #2</a></div>
    <div class="body">Machine command is answering 3 question to processor.<br />1. What to do?<br />2. With what to do?<br />3. How to do?<br />3rd question is optional.<br />To answer those questions command may have several logical blocks.<br />Before enumerating those blocks we'll see some examples.<br />And before that examples let's make special programme which<br />will serve us as white sheet of paper.<br />Of course we may do it in any program loaded into debugger but better<br />do fool code app.<br />1. We'll do it small so it will be loaded faster in OllyDbg.<br />2. We'll fill it with 1byte mnemonic so we can that mnemonic<br />on unused space of the test prog and treat it as if it white<br />part of paper sheet.<br />3. If we use the same program for our tests we can create<br />either batfile to load it into OllyDbg. Or specify the name of<br />our app as command line inside shortcut (lnk file) to OllyDbg.<br />It gives us opportunity to load OllyDbg with testing white sheet app<br />inside it by dblclick.<br />Last loaded fileS in OllyDbg you may find in File menu at the bottom.<br />And last loaded file you load just by pressing ctrl+F2.<br /><br />     so here is &quot;white sheet app&quot; source.<br />.code<br />start:<br />	rept 256<br />	nop<br />	endm<br />	call ExitProcess<br />	end start<br />It will insert 256 nops inside.<br />Or as you already now 256 90h bytes before call ExitProcess code.<br />So maybe we code it partly in HEX then? :)<br />start:<br />	rept 256<br />	db 90h<br />	endm<br />	call ExitProcess<br />	end start<br />or maybe we chek if all this <br />	db 90h<br />	nop<br />	xchg eax,eax<br />are the same thing?<br />Let's retype and recompile it with<br />	rept 20<br />	nop<br />	endm<br />	rept 118<br />	xchg eax,eax<br />	endm<br />	rept 118<br />	db 90h<br />	endm<br />	call ExitProcess<br /><br />When you load it into debugger you'll this all the same 90 nop<br /> before<br /><br />	call ExitProcess.<br />Now I suggest that you are very advance Win32 user, and can add to your<br />start menu item with command OllyDbg.exe <br />and give it shortcut key for example ctrl-shift-t.<br />So you can load your test app in debugger with one keystroke.<br /><br />Introduction to opcode logical blocks<br />--------------------------------------<br />There are 6 logical blocks that might be used in opcode.<br />Important thing is not only names and meaning of them,<br />but also the order of them.<br />Here they are:<br />1.Prefixes<br />2.Code<br />3.byte mod r/m<br />4.byte sib<br />5.offset in command<br />6.imm. operand.<br />Not necessarily all of them are used.<br />But one block is used always<br />it is block2 -&gt; CODE.<br />Some commands used just this one block.<br /><br />Type in test prog opcodes (press enter after each byte and look to<br />what mnemonic appeared)<br />Remember? Ctrl-e to insert raw opcode.<br />	C3<br />	2F<br />	90 ;you already know what you'll see don't you :)<br />	AD<br />All this opcodes has the only field - CODE.<br />We already know opcode for lodsb - ACh<br />let's see if we can add additional block to it to extend<br />it usage.<br />Type in raw opcode F3 before AC<br />in other words type (after ctrl-e)<br />F3 AC<br />You can see: rep lodsb<br />We can specify block format for<br />AC as <pre><code><br />F3AC as <pre><code><br />F3 is prefix block.F3 is value of Rep prefix.<br />It is used the same way with movsb, stosb etc.<br />Now type those mnemonics of commands that you know can<br />be used with rep before them.<br />Look up their opcodes.<br />Now type in raw hex (ctrl-e)<br />each of these mnemonics opcode with leading F3 byte.<br />See results of recognized mnemonics.<br />So first thing to remember:<br />Command may be constructed using some of six logical<br />blocks. Not all are necessarily used, but one block<br />is always present - CODE(block#2)<br /><br />Now we'll make example of what real men see in opcode,<br />continuing looking through examples of opcode<br />in blocks.<br />To see what power can we get by knowing it.<br />Lets insert all 6 mnemonics for work with BCD numbers.<br />Type mnemonics in debugger:<br />          DAA<br />          DAS<br />          AAS<br />          AAA<br />          AAM<br />          AAD<br />When first time those commands were represented by Intel,<br />documentation said that all off them are 1 block commands.<br />That means that they are in format<br />code <br />Actually the real format of the last two was not documented.<br />Let us see if we can figure out this format and what we additionally<br />can discover looking in opcode:<br /><br />    27                         DAA<br />    2F                         DAS<br />    3F                         AAS<br />    37                         AAA<br />    D40A                       AAM<br />    D50A                       AAD<br /><br />Is there something different in AAM and AAD from the others?<br />Don't look for a while below.Try to think yourself about the difference.<br />......<br /><br /><br /><br /><br /><br /><br /><br />Yes. <br />1. These two are two bytes long while other 4 is 1 byte.<br />2. Second byte of both commands is 0A.<br />If  you remember of description of the commands<br />AAM - divide al by 10 <br />      place quotient in AH<br />      place reminder in AL<br />AAD - AL = AH*10+AL<br />So both commands works with 10.<br />And last byte of them opcode is 10 (0Ah)<br />Might be it is 0Ah not accidentally?<br />Maybe it is an operand?<br />And format of the commands is not<br />    D40A      for                 AAM<br />    D50A      for                 AAD<br />?<br />May be it is<br />D4:imm8<br />D5:imm8<br />?<br />And imm8 may be any value?<br />Try to check it. <br />Type for example:<br />as MNEMONIC <br />	mov al,8<br />then as OPCODE<br />	D407	;do the same as D40A does but divide by 7 not ten<br />if we are right then after running this opcode we<br />will have 01 in AH(quantient) and 01 in AL(reminder)<br />so type it and run step by step using F8, looking what happens in registers.<br />Now try the experiment with second byte of D5:imm8 opcode.<br />Try type and run example with imm8 different from 0Ah and see what <br />will happen.<br /><br />So now we not only saw another format example <br />format <pre><code> (block2 and block6) <br />we also saw type of opcode that exists but don't have mnemonic for it.<br />I must say that Oleh (Author of OllyDbg) use his notation for it:<br />he allows (as you could see after typing D407) to use immediate operand to<br />those two opcodes with AAM and AAD mnemonics.<br /><br />Understanding rules of opcode format helped low level coders recover those<br />undocumented opcodes and document them. Another advantage of opcode <br />understanding.<br /><br />We'll study each block of opcode in detail later.<br />Now we need to see some basic rules.<br />The second thing to remember is that though not necessary all blocks<br />are present in particular opcode the order of blocks never changed.<br />Some blocks may be missing but block with low order number never occurs<br />after block with higher number.<br />There is always <pre><code> in command and never <pre><code> in one<br />command.<br />Type OPCODE 0110 press enter<br />then type   1001 press enter<br />As you see we've to different commands.<br /><br />Next time we'll discuss how processor recognise start and end of opcode,<br />and will see how 2+2 maybe equal 3 ;)</div>
    <div class="meta">Posted on 2002-11-16 04:14:41 by The Svin</div>
   </div>
   <div class="post" id="post-66040">
    <div class="subject"><a href="#post-66040">Opcode #2</a></div>
    <div class="body">nice tutor  again.</div>
    <div class="meta">Posted on 2002-11-16 13:11:38 by nyook</div>
   </div>
   <div class="post" id="post-66691">
    <div class="subject"><a href="#post-66691">Opcode #2</a></div>
    <div class="body">BTW, F2/F3 prefix works very well against indiscretions ;)</div>
    <div class="meta">Posted on 2002-11-20 22:33:36 by Axial</div>
   </div>
  </div>
 </body>
</html>