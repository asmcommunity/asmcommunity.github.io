<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Homer's GameDev Blog - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=29358" />
  <link rel="prev" href="../?id=29358&amp;page=10" />  <link rel="next" href="../?id=29358&amp;page=12" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=10">Graphics &amp; Game Development</a> &raquo; <a href="../?id=29358">Homer's GameDev Blog</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=29358&amp;page=1" style="">&laquo;</a><a href="../?id=29358&amp;page=10" style="">&lt;</a><input type="hidden" name="id" value="29358" /><input type="number" name="page" min="1" max="15" step="1" value="11" onchange="this.form.submit();" /><a href="../?id=29358&amp;page=12">&gt;</a><a href="../?id=29358&amp;page=15">&raquo;</a></form>   <div class="post" id="post-209771">
    <div class="subject"><a href="#post-209771">Re: Homer's GameDev Blog</a></div>
    <div class="body">I&#039;ve improved the implementation of MP3 Streaming, eliminating &#039;popping/glitching&#039; artifacts, while still using the Event Notification scheme to refill half my SoundBuffer while the other half is Playing.<br />The trick was in dealing with &#039;overflow condition&#039;, where we decompressed more wav data than would fit in our &#039;halfbuffer&#039;... I&#039;m now caching this extraneous data in-situ, consuming it as soon as we&#039;re ready.<br />This solution is ideal as there is no &#039;double buffering&#039; / moving data unnecessarily, and I&#039;ve not been forced to march down the Microsoft MVP path of doing my own polling via GetCurrentPosition (what a god awful solution they proposed).<br /><br />Now all my MP3s play cleanly, I can get back to more important stuff.<br /></div>
    <div class="meta">Posted on 2009-11-30 00:03:41 by Homer</div>
   </div>
   <div class="post" id="post-209773">
    <div class="subject"><a href="#post-209773">PLEASE TEST THIS</a></div>
    <div class="body">Attached is a Binary Executable which implements a Player supporting realtime streaming of WAV and MP3 files.<br />PLEASE TEST, try a few different mp3 files, and tell me whether you can hear any problems in the output!<br /><br />I have a feeling that occasionally, the SoundBuffer Notification mechanism breaks down, causing my &#039;onWantData&#039; method to be called repeatedly as quickly as possible, rather than once per second &nbsp;(my playbuffer is two seconds long, I try to fill one half while the other half is being played).<br /><br />Latest change was to add EventManager methods for Unregistering events (by name, and by handle), and adding code to StreamingSound.Done to unregister its own notification event, preventing a leak of one Event Object every time we Unload a StreamingSound (or StreamingMP3Sound).<br />Also added a CriticalSection (shared across the audio engine) which is utilized by the &#039;onWantData&#039; event handler - this ensures that we cannot Unload a Sound whilst a notification event is being handled (would cause a gpf).<br /><br />NOTE: The attached binary does *NOT* contain these recent additions, so its possible to trigger a GPF by trying to play a subsequent soundfile, or simply by trying to close the application, while a soundfile is currently being played.<br /><br /></div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=2965" target="_blank">AudioDemo.rar</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2009-11-30 04:00:05 by Homer</div>
   </div>
   <div class="post" id="post-209779">
    <div class="subject"><a href="#post-209779">Re: Homer's GameDev Blog</a></div>
    <div class="body">Found and fixed a problem introduced somehow into WAV Streaming.<br />Located sourcecode example of OGG VORBIS decoding with respect to DirectSound.<br />Also located a binary DLL providing ogg encoding/decoding functionality.<br />Would much prefer to obtain the LIB and link it into my audio engine, anyone care to build the most recent version and make the LIB available?<br /><br />EDIT: Found a vorbis ACM codec YAY</div>
    <div class="meta">Posted on 2009-11-30 08:14:30 by Homer</div>
   </div>
   <div class="post" id="post-209787">
    <div class="subject"><a href="#post-209787">Re: Homer's GameDev Blog</a></div>
    <div class="body">Spoke too soon - found and fixed another WAV streaming bug, here&#039;s another test build, expect problems at the start or the end of an mp3 track, wav files should be fine, and the filesize limit is 32 bits currently.<br /><br />Please test this build for stability, and this time please tell me some feedback, even if its just a &quot;yeah it works&quot;.<br /><br />I&#039;ve begun to support ARBITRARY ACM CODECS !!! Over 100 possible codecs :D I won&#039;t be able to provide arbitrary file format support, but I can at least open the door to all these codecs for transcode purposes!&nbsp; 8)</div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=2967" target="_blank">AudioDemo.rar</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2009-12-01 04:24:27 by Homer</div>
   </div>
   <div class="post" id="post-209789">
    <div class="subject"><a href="#post-209789">Re: Homer's GameDev Blog</a></div>
    <div class="body">The attached file is dr watson&#039;s crash log.<br />How to reproduce: Just keep clicking &quot;play a local audio file&quot; button and opening random mp3&#039;s. Eventually, after about 10th opened mp3 the app will crash.<br />This happens both on limited and admin accounts.<br /><br />One comment, if I may: DirectSound is deprecated on Vista and dropped on 7. MS says that developers should use Xaudio2/XACT. (though I personally recommend OpenAL ^^).<br /><br />And 1 question, if I may: Could you please elaborate on MSACM? It&#039;s very poorly documented. I remember that I tried using it several years ago for decompression but managed to make it work only with few audio files (most probably I was doing something incorrectly). So a thorough explaination/tutorial would be appreciated.</div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=2968" target="_blank">AudioDemo.7z</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2009-12-01 13:41:06 by ti_mo_n</div>
   </div>
   <div class="post" id="post-209818">
    <div class="subject"><a href="#post-209818">Re: Homer's GameDev Blog</a></div>
    <div class="body">Thanks for the feedback!<br />Please read notes in previous post in regards to this GPF - its a known problem and has already been resolved.<br /><br />Coincidentally, I spent the entire day today searching for information on XACT/XAUDIO2... and here I will present my findings.<br /><br />With respect to XP, its like this:<br /><br />XACT-&gt;XAudio2-&gt;DirectSound-&gt;WaveIn/WaveOut<br /><br />And under Vista/Win7, its like this:<br /><br />XACT-&gt;XAudio2-&gt;SOFTWARE MUX-&gt;Windows Core Audio-&gt;WaveOut<br />AFAIK DirectSound is available on Win7, but DirectSound HARDWARE ACCELERATION is not... read on!<br /><br />First thing I need to say is that XAudio2 DOES NOT SUPPORT CAPTURE - Period.<br />Second thing is that, at least under XP, this is JUST a wrapper for DirectSound - in fact, all XAudio represents is a software mixer that spits wav data out to a single DirectSound buffer.<br />Third, Vista uses a 100% SOFTWARE audio stack which supports EMULATION of DirectSound - software on software with no chance of hardware acceleration.<br />This fixes problems caused by bad drivers from oem audio card manufacturers, but effectively means no hardware acceleration is possible... DirectSound will still work on Vista, but suffers the double indignity of a software-on-software base layer.<br /><br />So anyway, I tried playing around with microsoft&#039;s xact demos on XP to see if they suffer the same DirectSound problems I am currently coping with (which I will elaborate on shortly) - and they don&#039;t, it works nice, despite the fact that, on XP, DirectSound is still the base.<br />So I looked closer at the XAudio2 API and I quickly realized how they did it.<br /><br />The problem I&#039;m having, which is a fairly well known problem, is related to the Audio Event Notification interface, which I use to track the current position of directsound io buffers - it turns out that, even if a soundbuffer is Stopped, it can generate audio event notifications CAUSED BY SOUNDS BEING PLAYED IN ANOTHER PROCESS !!!<br />For me this is terrible - I have a two second soundbuffer, with two notification keys at the halfway and end of the buffer - when the play cursor reaches a &quot;halfbuffer&quot;, I fill the OTHER halfbuffer with more WAV data - so if I get untimely notifications generated by some other process, my audio will go out of synch and glitch like hell.... fire up two instances of my player to see what I mean.<br />The Notification scheme is simply too broken (under most audio drivers) which was probably the reason they deprecated DirectSound... it was a case of &quot;we cant trust these audio guys to get it right, so we&#039;ll do everything in software and then palm it to a vanilla audio driver&quot;. Say goodbye to Environmental Audio Effects!<br /><br />Microsoft MVPs propose that the solution is to not use DS notifications at all - instead, to provide a thread which POLLS the playbuffer, querying its position every 10ms or so - fine if theres only one soundbuffer, bad if theres a few... the idea is to periodically write *SOME* data to the soundbuffer, and my understanding is even this solution has inherent problems... so I am lead to believe anyway.<br /><br />Turns out that the XAudio2 api has a method called something like &quot;DoWork&quot; which we should call FREQUENTLY, I believe this method is doing that polling I mentioned, as well as generating soft notifications (rather than letting the audio driver do it).<br /><br />I think I can do something similar over DirectSound which will:<br /><br />A- solve my current problems wrt notifications<br />B- work on XP, Vista and Win7<br />C- allow CAPTURE of audio under a common audio framework<br />D- allow ACM-based streaming under any installed codecs (microsoft chose not to provide mp3 streaming examples in the DirectX SDK despite the fact that all these operating systems ship with a suitable codec - why do think that is?)<br /><br />I cannot believe that the DirectSound emulation layer on Vista is THAT slow - I say its the software mixer layer, which we&#039;re stuck with regardless. I think that microsoft is PUSHING developers onto XAudio2 with a scare campaign. We all know how much Microsoft wishes to dominate the game development market, as seen with their push toward developer-oriented products such as XNA. Maybe they should stick to their day jobs.<br /><br />So - I will continue working under DirectSound for the immediate future!<br /><br />I&#039;ve actually written about ACM in a previous post on this board, what would you like to know about it? Basically, the Audio Compression Manager api gives you access to every single audio codec installed on your system, and lets you use them compress/decompress &#039;frames&#039; of audio data, and if necessary, you can CHAIN codecs together (we can use intermediate codecs in cases where a codec can&#039;t directly produce what we want).<br />It&#039;s VERY easy to use, especially if you want to convert an entire file at once rather than streaming frames of data... although there are a couple of tricks worth knowing. The main one is about determining the size of your two buffers - assuming you want to decompress MP3, you can query the ACM for a suitable size buffer by nominating the size of the other buffer - say, &quot;how big should my wav buffer be if the mp3 buffer is 2k in size&quot; - the trick is that once you get the answer, you should query AGAIN for the OTHER buffersize, this time nominating the buffersize it told you in the first query - &quot;ok, so if I have an 8k WAV buffer, how big should the MP3 buffer be?&quot; - the value it returns will usually be different to the original value you handed in! It might tell you &quot;use an mp3 buffer of 2304 bytes&quot;... now we have a matched set of buffer sizes which were calculated AROUND the original value, and we&#039;re ready to rumble. 99% of the example sourcecode you will find DO NOT DO THIS - they use special magical predetermined values such as &quot;MP3_BLOCK_SIZE&quot; which work for a SPECIFIC BIT RATE, but wont work for all cases... seems everyone copied the same broken examples.<br /><br />Anyway I&#039;ll spend a day or two on design considerations before I go ahead, and I&#039;ll post another demo very soon.<br /></div>
    <div class="meta">Posted on 2009-12-04 07:52:05 by Homer</div>
   </div>
   <div class="post" id="post-209820">
    <div class="subject"><a href="#post-209820">Re: Homer's GameDev Blog</a></div>
    <div class="body">With OpenAL you can get hardware-accelerated audio under XP, Vista and Win7. It completely bypasses the whole XACT/XAudio2/DirectSound stack and is a solution which talks directly to the audio driver.<br />I think it&#039;s worth checking out before you get in too deep with another solution.<br /><br />As for mp3s, buffersizes and bitrates... Don&#039;t forget that there are also variable bitrate files, so at some point in the file the bitrate might go up, requiring larger buffers.<br />When variable bitrate mp3s first started appearing, cleanly designed players could handle them with ease, hardcoded stuff would break :)</div>
    <div class="meta">Posted on 2009-12-04 08:24:13 by Scali</div>
   </div>
   <div class="post" id="post-209821">
    <div class="subject"><a href="#post-209821">Re: Homer's GameDev Blog</a></div>
    <div class="body">My existing code does examine each MP3 frame header to detect Variable Bitrate, but Im yet to find any MP3s in my collection that uses this.<br />AFAIK ACM is VBR safe , the sizes it calculates are maximums for a given size frame, at maximum bitrate... after decompressing a frame, you still need to look how much PCM/WAV data was emitted.... and even with a FIXED BITRATE, this size WILL vary from one frame to another, so we cannot use any constants.<br /><br />My understanding is that Creative Labs is close to collapsing, and that OpenAL is effectively a dead duck waiting to be roasted. I won&#039;t be jumping on that bandwagon until I am convinced otherwise, although I will be watching closely! Theres also something else that redirects DirectSound calls to OpenAL, which then figures out what to do with them based on the local machine, forget what thats called, but if I choose to eventually use OpenAL, it will be likely that I&#039;ll do it that way.</div>
    <div class="meta">Posted on 2009-12-04 08:35:31 by Homer</div>
   </div>
   <div class="post" id="post-209823">
    <div class="subject"><a href="#post-209823">Re: Homer's GameDev Blog</a></div>
    <div class="body">Well, most mp3 encoders can encode VBR, so it&#039;s easy to create a test file.<br />I can send you a VBR mp3 if you want.<br /><br />As for Creative collapsing, I&#039;ve not heard anything of the sort. And even if Creative were to collapse, I&#039;m not sure if that would mean the end of OpenAL. There&#039;s quite a few games that use it. Developers will probably want continued support of OpenAL one way or another.<br />It wouldn&#039;t be the first time either... OpenGL was originally developed by SGI, but it was opened up, and eventually control was transferred to the Khronos group. With OpenCL, Apple moved to Khronos directy, merely providing them with a draft of the standard.<br /><br />The DirectSound-to-OpenAL redirection (ALchemy) is one of Creative&#039;s driver features. They needed it to continue supporting hardware-accelerated DSound and their custom 3D effects and post-processing (EAX) that is supposed to be one of the main selling points of their soundcards over onboard audio.</div>
    <div class="meta">Posted on 2009-12-04 08:53:05 by Scali</div>
   </div>
   <div class="post" id="post-209824">
    <div class="subject"><a href="#post-209824">Re: Homer's GameDev Blog</a></div>
    <div class="body">Sure, I&#039;d love to try a VBR mp3 file and make sure my code handles them as expected - if you create one, can you please make it an extreme example? say, an 8khz stream interleaved with a 192k stream or something.. and make sure that the first few frames use the lower bitrate of course.<br /></div>
    <div class="meta">Posted on 2009-12-04 09:06:18 by Homer</div>
   </div>
   <div class="post" id="post-209825">
    <div class="subject"><a href="#post-209825">Re: Homer's GameDev Blog</a></div>
    <div class="body"><div class="quote">The main one is about determining the size of your two buffers - assuming you want to decompress MP3, you can query the ACM for a suitable size buffer by nominating the size of the other buffer - say, &quot;how big should my wav buffer be if the mp3 buffer is 2k in size&quot; - the trick is that once you get the answer, you should query AGAIN for the OTHER buffersize, this time nominating the buffersize it told you in the first query - &quot;ok, so if I have an 8k WAV buffer, how big should the MP3 buffer be?&quot; - the value it returns will usually be different to the original value you handed in! It might tell you &quot;use an mp3 buffer of 2304 bytes&quot;... now we have a matched set of buffer sizes which were calculated AROUND the original value, and we&#039;re ready to rumble. 99% of the example sourcecode you will find DO NOT DO THIS - they use special magical predetermined values such as &quot;MP3_BLOCK_SIZE&quot; which work for a SPECIFIC BIT RATE, but wont work for all cases... seems everyone copied the same broken examples.</div><br />I haven&#039;t checked it yet, but I think this is exactly what I was doing wrong. This would explain why my code worked with some files and didn&#039;t with others. Thank you ^^<br /><br />OpenAl is now now ported on consoles, so I don&#039;t think it&#039;s going to die even if we assume Creative&#039;s collapse (which I haven&#039;t heard anything about). And OpenAL is easier to use (you can get pretty much any audio effect you want by using like 10 functions). The attached files are my test app which enumerates openal drivers (I can attach the source if anyone wants) and a screenshot showing how it works on Sound Blaster X-Fi (for those who don&#039;t want to download and run an exe). There was an update to OpenAl this summer (some bugfixes and enhanced driver enumeration) so it looks like it&#039;s really being developed (i.e. the project is not dead).<br /><br /><br /><br />I can send you a 6MB mp3 with bitrate jumping from less than 100 kbps to more than 500 kbps.</div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=2969" target="_blank">OpenAL_01_32.7z</a></li>
      <li><a href="../../attachments/?id=2970" target="_blank">xfi_02.png</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2009-12-04 09:07:08 by ti_mo_n</div>
   </div>
   <div class="post" id="post-209829">
    <div class="subject"><a href="#post-209829">Re: Homer's GameDev Blog</a></div>
    <div class="body">500k!! lol !!! sure, send it! :D<br /><br />Here is my preliminary work from this morning.. my version of the &quot;XAudio2::DoWork&quot; method ... since my soundbuffers are always a healthy 2 seconds in size, I should be able to call this around once per second, with plenty of room for lag caused by thread scheduling etc - not once every 10ms like Microsoft&#039;s model requires. Note that this method has been implemented at the Buffer abstraction level, I&#039;ll need to call this for all sounds currently being played.<br /><br />NextReadOffset is the offset into the source data - in this example, a large filemapped wav.<br />NextWriteOffset is an offset into the SoundBuffer where I will be writing my data (initially zero).<br />Worth noting that since I use Debug version of DirectX that I have to ensure my SoundBuffer is initialized with silence before I start it playing.<br /><br />By the way - your application works fine, and enumerates EAX support, does this imply that I have OpenAL binaries installed without my knowledge?<br /><br /><pre><code><br />;Method: &nbsp; &nbsp;StreamingSound.Advance<br />;Purpose: &nbsp; Fill the SoundBuffer *BEHIND* the PlayCursor<br />;Remarks: &nbsp; Must be called about once per second to maintain audio quality<br />Method StreamingSound.Advance,uses esi<br />LOCAL playpos,writelen<br /> &nbsp; &nbsp;SetObject esi<br /> &nbsp; &nbsp;<br /> &nbsp; &nbsp;;If we run out of data, stop playing<br /> &nbsp; &nbsp;mov eax,.dNextReadOffset<br /> &nbsp; &nbsp;.if eax&gt;=.dAudioSize<br /> &nbsp; &nbsp; &nbsp;DbgWarning &quot;Sound Data Exhausted - Stopping&quot;<br /> &nbsp; &nbsp; &nbsp;OCall esi.Stop<br /> &nbsp; &nbsp; &nbsp;ExitMethod<br /> &nbsp; &nbsp;.endif<br /><br /> &nbsp; &nbsp;;Find out where the PlayCursor is within the Buffer<br /> &nbsp; &nbsp;ICall .pDSBuffer::IDirectSoundBuffer.GetCurrentPosition,addr playpos,NULL<br /> &nbsp; &nbsp;.if eax==S_OK<br /> &nbsp; &nbsp; &nbsp; &nbsp;;Calculate how much data we can write<br /> &nbsp; &nbsp; &nbsp; &nbsp;;(after our last write offset, and before the playcursor)<br /> &nbsp; &nbsp; &nbsp; &nbsp;mov eax,playpos<br /> &nbsp; &nbsp; &nbsp; &nbsp;.if .dNextWriteOffset &lt; eax<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sub eax,.dNextWriteOffset &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br /> &nbsp; &nbsp; &nbsp; &nbsp;.else <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov edx,.dNextWriteOffset<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sub edx,eax<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov eax,.dBufferSize<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sub eax,edx<br /> &nbsp; &nbsp; &nbsp; &nbsp;.endif<br /> &nbsp; &nbsp; &nbsp; &nbsp;;Write as much data as possible to the Buffer<br /> &nbsp; &nbsp; &nbsp; &nbsp;push eax<br /> &nbsp; &nbsp; &nbsp; &nbsp;mov edx,.pStreamingData<br /> &nbsp; &nbsp; &nbsp; &nbsp;add edx,.dNextReadOffset<br /> &nbsp; &nbsp; &nbsp; &nbsp;OCall esi.WriteBuffer, edx, eax, .dNextWriteOffset<br /> &nbsp; &nbsp; &nbsp; &nbsp;pop eax<br /> &nbsp; &nbsp; &nbsp; &nbsp;add .dNextWriteOffset,eax<br /> &nbsp; &nbsp; &nbsp; &nbsp;add .dNextReadOffset,eax<br /> &nbsp; &nbsp;.endif <br /><br /> &nbsp; &nbsp;;Constrain the Write Cursor to the Buffer range<br /> &nbsp; &nbsp;mov eax,.dBufferSize<br /> &nbsp; &nbsp;.if eax&lt;.dNextWriteOffset<br /> &nbsp; &nbsp; &nbsp; &nbsp;sub .dNextWriteOffset,eax<br /> &nbsp; &nbsp;.endif<br /><br />MethodEnd<br /></code></pre><br /><br /></div>
    <div class="meta">Posted on 2009-12-04 20:44:27 by Homer</div>
   </div>
   <div class="post" id="post-209831">
    <div class="subject"><a href="#post-209831">Re: Homer's GameDev Blog</a></div>
    <div class="body">Good news - I just tested this code, hammering the Advance method from my Windows MessagePump loop, and it works perfectly - even when another process generates sounds.. I&#039;ll experiment with knocking on it once per second from another thread, and if all goes well, I&#039;ll write the StreamingMP3Sound version, and set up a thread to drive all currently playing sounds rather than polluting my application framework.<br /><br />Two thumbs up to me, so far I think.<br /> :thumbsup: :thumbsup:<br /><br /><br />EDIT:<br />Works fine as long as you keep generating windows messages by moving the mouse or whatever - driving from the WM pump under GetMessage is not gonna cut it, but a PeekMessage based pump, or a thread with a timed loop will be fine.<br />Attached is a DEBUG build using the new method for streaming WAV files - feed it a big fat wav and wiggle your mouse while its playing, should be cool, noting that we are calling the Advance method WAY more often than we need to.<br />I use DebugCenter to catch message string from my applications, you&#039;ll need to install that if you wanna test this.<br />Go to the ObjAsm website, download the standalone DebugCenter executable, put it somewhere permanent, and run it once to register its filepath - then you&#039;ll be able to see my debug strings - otherwise put up with a nag message and it should still work regardless.<br /><br /></div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=2972" target="_blank">AudioDemo.rar</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2009-12-04 22:39:30 by Homer</div>
   </div>
   <div class="post" id="post-209832">
    <div class="subject"><a href="#post-209832">Re: Homer's GameDev Blog</a></div>
    <div class="body">It will probably crash at end of data - issue resolved here, but not in the posted demo.<br />Would really like some Vista and Win7 results !!<br /></div>
    <div class="meta">Posted on 2009-12-04 23:21:20 by Homer</div>
   </div>
   <div class="post" id="post-209834">
    <div class="subject"><a href="#post-209834">Re: Homer's GameDev Blog</a></div>
    <div class="body">More good news - implemented the MP3-streaming version, which works perfectly !! Will probably move the stream decompression code into its own method, so we can effectively stream using any codec we have installed on the system.<br /><br /><br /></div>
    <div class="meta">Posted on 2009-12-05 21:06:27 by Homer</div>
   </div>
   <div class="post" id="post-209835">
    <div class="subject"><a href="#post-209835">Re: Homer's GameDev Blog</a></div>
    <div class="body"><div class="quote"><br />Good news - I just tested this code, hammering the Advance method from my Windows MessagePump loop, and it works perfectly - even when another process generates sounds.. I&#039;ll experiment with knocking on it once per second from another thread, and if all goes well, I&#039;ll write the StreamingMP3Sound version, and set up a thread to drive all currently playing sounds rather than polluting my application framework.<br /><br />Two thumbs up to me, so far I think.<br /> :thumbsup: :thumbsup:<br /><br /><br />EDIT:<br />Works fine as long as you keep generating windows messages by moving the mouse or whatever - driving from the WM pump under GetMessage is not gonna cut it, but a PeekMessage based pump, or a thread with a timed loop will be fine.<br />Attached is a DEBUG build using the new method for streaming WAV files - feed it a big fat wav and wiggle your mouse while its playing, should be cool, noting that we are calling the Advance method WAY more often than we need to.<br />I use DebugCenter to catch message string from my applications, you&#039;ll need to install that if you wanna test this.<br />Go to the ObjAsm website, download the standalone DebugCenter executable, put it somewhere permanent, and run it once to register its filepath - then you&#039;ll be able to see my debug strings - otherwise put up with a nag message and it should still work regardless.</div><br />omg i jumped off my chair when i tried this with a mp3 file, was just loud static sounding.<br />Previous versions have worked ok, produced sound that you can listen to (but it wasnt playing the mp3 file exactly how it should have) but using the same mp3 in this version was just loud static. Im using win xp</div>
    <div class="meta">Posted on 2009-12-05 21:30:23 by Azura</div>
   </div>
   <div class="post" id="post-209836">
    <div class="subject"><a href="#post-209836">Re: Homer's GameDev Blog</a></div>
    <div class="body">Yes, that version was testing a new method of filling the buffer (workaround for a bug in DirectSound), as mentioned I wanted to get WAV streaming working under that model before I went ahead with MP3 - which ive now done! (did you notice you can change the FILETYPE?) This workaround should correct all problems in MP3/WAV streamed playback.<br /><br />Attached is a new demo - this one has its own dedicated thread for updating all currently playing sound streams - since it only has to advance each stream once per second, it seemed unreasonable to use one thread per stream, so I&#039;m using a single thread to manage all the currently playing (streaming) sounds at once... ok this demo only lets you play one at a time, but the engine does support any number of simultaneous sound streams, in 2D and 3D.<br /><br />You may notice a 2 second delay before you can hear anything - this is due to me not priming the soundbuffer with data before playback commences, and can be eliminated... <br /><br />NOTE:<br />In fact the previous version should have played SILENCE when you loaded an MP3 - the fact that it didnt is a behavior caused by using DirectX runtimes in Debug mode, or explicitly binding to debug libraries (which I didnt). Either way, it won&#039;t happen anymore :)<br /><br /><br /><br /></div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=2975" target="_blank">AudioDemo.rar</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2009-12-05 21:34:54 by Homer</div>
   </div>
   <div class="post" id="post-209837">
    <div class="subject"><a href="#post-209837">Re: Homer's GameDev Blog</a></div>
    <div class="body">Interesting times, Biterider found a few files that won&#039;t play.<br /><br />One of them is a WAV file which contains MP3-compressed data.<br />I didn&#039;t even know WAV files could do that!<br /><br />The other two are small MP3 files which generate an error when I try to decompress them.<br />I gather something&#039;s weird in those files and they will require a closer examination.<br /><br />In regards to compressed wav files, I think I&#039;ll be able to twist things so that I can play those, but it might require that I move my &#039;acm decompression stream handle&#039; from the main engine into each compressed sound object (as I did with the &#039;acm decompression stream header&#039;), IE, I&#039;m pretty sure that the decompression stream will need to be initialized using the exact same values as parsed from the extended wave format header.<br /><br />Currently I decompress all mp3 files using the same shared decompression stream object, using a fixed set of values for &#039;preferred format of wave playback&#039;... <br /><br />So, it might not be a simple thing, but it kinda irks me that I can&#039;t handle these files.<br />Can anyone provide me with a WAV file containing data compressed by another codec?<br />I would love to try to write a unified solution that sets up the codec based on nothing more than the tag, although that may not be practical.<br /><br />Anyway, to handle mp3-compressed WAV files, I need to do the following from my WAV loader:<br />A - Detect that the WAV is indeed MP3 compressed (completed)<br />B - Initialize a StreamingMP3Sound container, handing it the size of the compressed data (size obtained from extended wav header)<br />C - Possibly create a special ACM Decompression Stream object for this special stream<br />D - Return the MP3 container INSTEAD OF the StreamingSound object I&#039;d normally be returning<br /><br />The application shouldn&#039;t care whether the returned object is a compressed stream, uncompressed stream or just a static uncompressed sound, I&#039;m using OOP to redefine (override) the appropriate methods, so calling StreamingSound.Advance apon a StreamingMP3Sound object will in fact result in a call to StreamingMP3Sound.Advance :)<br /><br />If I leave out Step C (for now, just to speed up the development time), I should be able to implement code to play these &quot;mp3 compressed wave files&quot; without having to abstract them away under a new class definition - just get my WAV loader to go &quot;ooh, thats not raw pcm wav data, and I can handle mp3 streams, so treat the WAV data as mp3 data, please!&quot;<br /><br />Note - eliminated the two second delay for streaming wav/mp3 <br /><br /><br /></div>
    <div class="meta">Posted on 2009-12-06 01:56:26 by Homer</div>
   </div>
   <div class="post" id="post-209838">
    <div class="subject"><a href="#post-209838">Re: Homer's GameDev Blog</a></div>
    <div class="body">Figured out why those MP3s refused to play - they use a nonstandard (not 44.1k) sample rate.<br />Most codecs are not great at sample rate conversions.<br />The ACM can do it, but only by using an intermediate conversion stream, eg<br /><br />22k MP3 -&gt; 22k WAV -&gt; 44.1k WAV<br /><br />The alternative is to use a separate conversion stream for each concurrent sound stream.<br />EG, to set the playback sample rate in each Secondary Buffer to whatever the source sample rate is, and let DirectSound deal with the samplerate conversion when it mixes them into the primary buffer.<br /><br />So it looks like I&#039;m going to need to move that conversion-stream object (currently shared across all sounds) into each, which I suggested in the previous post.<br /><br /></div>
    <div class="meta">Posted on 2009-12-06 04:13:37 by Homer</div>
   </div>
   <div class="post" id="post-209841">
    <div class="subject"><a href="#post-209841">Re: Homer's GameDev Blog</a></div>
    <div class="body">Today is officially a no coding day, I need one now and then.<br />Perhaps tomorrow I&#039;ll start looking at dealing with outstanding issues, theres not many now, and soon this audio engine will be out of beta, and the update published to the OA32 library.<br /></div>
    <div class="meta">Posted on 2009-12-06 21:37:31 by Homer</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=29358&amp;page=1" style="">&laquo;</a><a href="../?id=29358&amp;page=10" style="">&lt;</a><input type="hidden" name="id" value="29358" /><input type="number" name="page" min="1" max="15" step="1" value="11" onchange="this.form.submit();" /><a href="../?id=29358&amp;page=12">&gt;</a><a href="../?id=29358&amp;page=15">&raquo;</a></form>  </div>
 </body>
</html>