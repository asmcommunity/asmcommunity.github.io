<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Visual Basic - Raise Event of an Object From ASM DLL - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=25980" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=25980">Visual Basic - Raise Event of an Object From ASM DLL</a></p>
   <div class="post" id="post-189340">
    <div class="subject"><a href="#post-189340">Visual Basic - Raise Event of an Object From ASM DLL</a></div>
    <div class="body">I was making some project with asm to use in my vb, one of the main problems is the comunication betwheen vb and asm.<br />Everyone explains how to call an exported asm function of you dll, so you can comunicate from vb to your dll, but how to comunicate back to your vb code from asm, lets say that your asm code is waiting some event and then it is catched, how to pass this event to the vb.<br />you may think you could have some function like isThereAnEvent, and polling all the time with vb, but i dont find it very cool to do something like that.<br /><br />however, here is the example of full comunication betwheen languages. last sentence, sorry my english, but is understandable, isnt it?<br /><br /><br />vb source code<br /><br />create a class named class1 with this code<br />Event m()<br />Event M2(ByVal j As Long, ByVal r As Long)<br />Event m3()<br />Event m4()<br />Event m5(ByVal j As Long, ByVal k As Long, ByVal l As Long, ByVal m As Long, ByVal n As Long, ByVal o As Long)<br />Event m6(ByVal j As Long)<br /><br /><br /><br />create a form with 2 buttons with this code<br /><br />Private WithEvents miobj As Class1<br />Private Declare Function SomeFunc Lib &quot;thepath\EventRaiser.dll&quot; (ByRef X As Object) As Long<br />Private Declare Function SomeOther Lib &quot;thepath\EventRaiser.dll&quot; (ByVal X As Object) As Long<br /><br />Private Sub cmdCommand1_Click()<br />&nbsp; &nbsp; Call SomeFunc(miobj)<br />End Sub<br /><br />Private Sub cmdCommand2_Click()<br />&nbsp; &nbsp; Call SomeOther(miobj)<br />End Sub<br /><br />Private Sub Form_Load()<br />&nbsp; &nbsp; Set miobj = New Class1<br />End Sub<br /><br />Private Sub miobj_m()<br />&nbsp; &nbsp; MsgBox &quot;Event N? 1 Raised&quot;<br />End Sub<br /><br />Private Sub miobj_m5(ByVal j As Long, ByVal k As Long, ByVal l As Long, ByVal m As Long, ByVal n As Long, ByVal o As Long)<br />&nbsp; &nbsp; MsgBox &quot;Event N? 5 Raised, parameters: &quot; &amp; j &amp; &quot;-&quot; &amp; k &amp; &quot;-&quot; &amp; l &amp; &quot;-&quot; &amp; m &amp; &quot;-&quot; &amp; n &amp; &quot;-&quot; &amp; o &amp; &quot;-&quot;<br />End Sub<br /><br />Private Sub miobj_m6(ByVal j As Long)<br />&nbsp; &nbsp; MsgBox &quot;Event 6 Raised, parameter:&quot; &amp; j<br />End Sub<br /><br /><br />and the asm code of the dll is this:<br /><br /><br />.data<br />hInstance	dd 0<br />hDllVbVm	dd 0<br />pRaiseEvent	dd 0<br /><br />.code<br />DllEntry proc hInst:HINSTANCE, reason:DWORD, reserver1:DWORD<br />LOCAL hList:DWORD<br /><br />	.if reason == DLL_PROCESS_ATTACH<br />		push hInst<br />		pop hInstance<br />		invoke LoadLibrary,SADD(&quot;msvbvm60&quot;)<br />		mov hDllVbVm,eax<br />		invoke GetProcAddress,hDllVbVm,SADD(&quot;__vbaRaiseEvent&quot;)<br />		mov pRaiseEvent,eax<br />	.elseif reason == DLL_PROCESS_DETACH<br />	.endif<br />	mov eax,TRUE<br />	ret<br /><br />DllEntry endp<br /><br />CallEvent proc c pObj:DWORD,nEvent:DWORD,nParam:DWORD,args:VARARG<br />	<br />	push esi<br />	lea esi,args<br />	mov ecx,nParam;numero de parametros<br />	;lea esi,;esi = apunta al ultimo<br />	xor edx,edx<br />	.while edx!=ecx<br />		push dword ptr <br />		sub esp,12<br />		mov dword ptr,3<br />		.if edx==1<br />			mov dword ptr,012h;en el anteultimo siempre va esto<br />		.endif<br />		inc edx<br />		;lea esi,;-4 = bytes para cambiar de parametro en la pila<br />		lea esi,<br />	.endw<br />	.if nParam<br />		add esp,4<br />	.endif<br />	push nParam<br />	push nEvent<br />	push pObj<br />	call pRaiseEvent<br />	mov ecx,nParam<br />	lea esp,<br />	.if nParam<br />		mov ecx,nParam<br />		lea esp,;applying the formula<br />		lea esp,<br />	.endif<br />	pop esi<br />	ret<br /><br />CallEvent ENDP<br /><br />SomeFunc proc obj:DWORD<br />LOCAL buffer[1024]:BYTE	<br />	mov eax,obj<br />	;add eax,12*4<br />	.if pRaiseEvent<br />	<br />		;Raising an Object Event With no Parameters (the hard way)<br />		pushd 0					;0 = N? of parameters of the events<br />		push 1					;1 = Event Number<br />		mov ecx,			;the object pointer (is a byref field, just a double referenciated pointer, byval are single referenciated)<br />		push ecx				;pass it<br />		call pRaiseEvent<br />		add esp,3*4				;Stack clean<br />		<br />		;Raising an Event with 6 parameters<br />		pushd 1					;Parameter 6<br />		sub esp,12				;uve to leave 3 dwords up of the parameter, (i dont know why, dont ask me, i just debug it)<br />		mov dword ptr,3&nbsp; ;uve to put a 3 at 3 dwords distance from the parameter<br />		<br />		pushd 2					;Parameter 5<br />		sub esp,12				;same here<br />		mov dword ptr,3	;the 3<br />		mov dword ptr,012h;the parameter N? (total param num - 1) or the 5 in this case<br />								 ;Have to mark that is the penultimate parameter<br /><br />		pushd 3					;parametro 4<br />		sub esp,12<br />		mov dword ptr,3<br />		<br />		pushd 4					;parametro 3<br />		sub esp,12<br />		mov dword ptr,3<br />		<br />		pushd 5					;parametro 2<br />		sub esp,12<br />		mov dword ptr,3<br />		<br />		pushd 6					;First parameter<br />		sub esp,8				;only this is not equal to the rest<br />		mov dword ptr,3	;the 3 still 3 dword away fromthe parameter<br />		<br />		push 6					;Parameter Amount<br />		push 5					;Event Number<br />		mov eax,obj				;reference to the pointer of the object<br />		mov ecx,			;the pointer of the object<br />		push ecx;p objeto		;pushing it<br />		call pRaiseEvent<br />		add esp,3*4+6*16-4&nbsp; 	;Cleaning the stack, follow this formula:<br />								;formula: 3*4 + ( ParamAmount*16 - 4 )<br />								;include the parentesis only when there r parameters<br />								;kind of stupid comment<br />		<br />		;now whe know how to do it, just make a function, i made mine, i think work good<br />		;calling event n?5 with 6 parameters, easy way<br />		mov eax,obj<br />		mov ecx,<br />		invoke CallEvent,ecx,5,6,1,2,3,4,5,6<br />		;raising event n? 1 with 0 parameters<br />		mov eax,obj<br />		mov ecx,<br />		invoke CallEvent,ecx,1,0<br />		;raising event n?6 with 1 parameter<br />		mov eax,obj<br />		mov ecx,<br />		invoke CallEvent,ecx,6,1,9<br />	.endif<br />	ret<br /><br />SomeFunc endp<br /><br />SomeOther proc Obj:DWORD;testing with byval<br />	<br />	invoke CallEvent,Obj,1,0<br />	ret<br /><br />SomeOther endp<br /><br /><br /><br />that was all. Im pretty sure that anyone that program in vb and asm understand what you can do with this would be happy to have this code. ill make some applications with this and submit later. ill attach the projects of vb and asm so u can test it</div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=2353" target="_blank">VB Object Event.rar</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2007-05-22 11:07:39 by mauricioprado</div>
   </div>
   <div class="post" id="post-189342">
    <div class="subject"><a href="#post-189342">Re: Visual Basic - Raise Event of an Object From ASM DLL</a></div>
    <div class="body">mauricioprado,<br /><br />Very cool mate. I personally don&#39;t use/like VB, but I do know a few people that will find this example useful. I&#39;ll be sure to pass it along. Nice work :thumbsup:</div>
    <div class="meta">Posted on 2007-05-22 13:31:36 by Synfire</div>
   </div>
   <div class="post" id="post-189355">
    <div class="subject"><a href="#post-189355">Re: Visual Basic - Raise Event of an Object From ASM DLL</a></div>
    <div class="body"><div class="quote"><br />mauricioprado,<br /><br />Very cool mate. I personally don&#39;t use/like VB, but I do know a few people that will find this example useful. I&#39;ll be sure to pass it along. Nice work :thumbsup:<br /></div><br />thanks... i hope your friends find it usefull</div>
    <div class="meta">Posted on 2007-05-24 07:33:14 by mauricioprado</div>
   </div>
   <div class="post" id="post-189365">
    <div class="subject"><a href="#post-189365">Re: Visual Basic - Raise Event of an Object From ASM DLL</a></div>
    <div class="body">Hi mauricioprado,<br /><br />first once the concept is very nice, but it is hardly useful. He is fix bind to VB6 and other language is not supported. The code has some strange sections, like these for example:<br /><pre><code><br />.if nParam<br />&nbsp; &nbsp; &nbsp; add esp,4<br />.endif</code></pre><br />or these<br /><pre><code>mov ecx,nParam<br />lea esp,<br />.if nParam<br />&nbsp; &nbsp; &nbsp; mov ecx,nParam<br />&nbsp; &nbsp; &nbsp; lea esp,;applying the formula<br />&nbsp; &nbsp; &nbsp; lea esp,<br />.endif</code></pre><br />Your Stack is not correct, the VARIANTs are shifted by 4 bytes.<br /><br />When you will write Code for VB5/6, then use COM. VB5/6 is the COM Language and you can fully interact via COM with VB. A very nice work for you too help write COM in MASM is OA32. -&gt; <a target="_blank" href="http://objasm32.tripod.com/">http://objasm32.tripod.com/</a> You can find many sample in the package, e.g. OCX_LED.<br /><br />Greats<br />Obi</div>
    <div class="meta">Posted on 2007-05-25 12:29:56 by Obivan</div>
   </div>
   <div class="post" id="post-189370">
    <div class="subject"><a href="#post-189370">Re: Visual Basic - Raise Event of an Object From ASM DLL</a></div>
    <div class="body">i debug it, im pretty sure call is successfull, stack its ok i think</div>
    <div class="meta">Posted on 2007-05-26 03:48:11 by mauricioprado</div>
   </div>
   <div class="post" id="post-189386">
    <div class="subject"><a href="#post-189386">Re: Visual Basic - Raise Event of an Object From ASM DLL</a></div>
    <div class="body">Hi,<br /><br />now the Stackframe is correct:<br /><pre><code><br />CallEvent proc c pObj:DWORD,nEvent:DWORD,nParam:DWORD,args:VARARG<br />	push esi<br />	lea esi, args<br />	mov ecx, nParam;numero de parametros<br />	<br />	xor edx,edx<br />	.while edx != ecx<br />		sub esp, 16			;&lt;- 16 Bytes (sizeof(VARIANT))<br />		mov word ptr , VT_I4	;&lt;- the VARIANT Type<br />		mov eax, dword ptr <br />		mov dword ptr , eax	;&lt;- the VARIANT Value<br />		.if edx == 1<br />			mov dword ptr,012h;en el anteultimo siempre va esto<br />		.endif<br />		inc edx<br />		add esi, sizeof(DWORD)<br />	.endw<br />	<br />	push ecx 		;&lt;-nParam<br />	push nEvent<br />	push pObj<br />	call pRaiseEvent<br />	<br />	mov ecx, nParam<br />	lea esp, <br />	.if ecx<br />		lea esp, <br />		lea esp, <br />	.endif<br />	<br />	pop esi<br />	ret<br />CallEvent ENDP</code></pre><br /><br />Greats<br />Obi</div>
    <div class="meta">Posted on 2007-05-27 04:22:28 by Obivan</div>
   </div>
  </div>
 </body>
</html>