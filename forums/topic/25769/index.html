<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Subclassing a control in ObjAsm32 - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=25769" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=25769">Subclassing a control in ObjAsm32</a></p>
   <div class="post" id="post-188018">
    <div class="subject"><a href="#post-188018">Subclassing a control in ObjAsm32</a></div>
    <div class="body">I&#39;m trying to learn how to subclass a control in objasm32. So I&#39;ve created an EditControl&nbsp; <br />object using a WinControl object as the parent. Here&#39;s the object:<br /><pre><code><br />Object EditControl,EditControlID,WinControl			; class &quot;EDIT&quot;<br />	RedefineMethod Init,		Pointer, Handle, Pointer<br />	RedefineMethod Done<br />	RedefineMethod WndProc,	&nbsp; &nbsp; dword, dword, dword<br /><br />	DefineVariable hEdit,&nbsp; &nbsp; &nbsp;  Handle, 0<br />ObjectEnd<br /></code></pre><br />and here&#39;s the methods:<br /><pre><code><br />if IMPLEMENT<br /><br />; ????????????????????<br />; Method:&nbsp; &nbsp; EditControl.Init<br />; Purpose:<br />; Arguments: pOwner: Pointer to an owner object<br />;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hParentWnd: Handle to a parent window<br />;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pDefStruc: Pointer to initialization structure<br />; Return:&nbsp; &nbsp; Nothing<br /><br />Method EditControl.Init, uses esi, pOwner:Pointer, hParentWnd:Handle, pDefStruc:Pointer<br />&nbsp; &nbsp; SetObject esi<br /><br />&nbsp; &nbsp; mov ecx, pDefStruc<br />&nbsp; &nbsp; assume ecx:ptr EditDef<br />&nbsp; &nbsp; mov eax, .dStyle<br />&nbsp; &nbsp; or eax, WS_CHILD or WS_VISIBLE<br />&nbsp; &nbsp; @invoke CreateWindowEx, .dExStyle, &quot;EDIT&quot;, NULL, eax, \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .sdPosX, .sdPosY, .dWidth, .dHeight, \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hParentWnd, .dCtlID, hInstance, 0<br />&nbsp; &nbsp; mov .hEdit, eax<br />&nbsp; &nbsp; assume ecx:nothing<br />&nbsp; &nbsp; ACall esi.Init, pOwner, eax<br />&nbsp; &nbsp; Subclass EditControl&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Uses esi<br /><br />MethodEnd<br /><br />; ???????????????????????????<br />; Method:&nbsp; &nbsp; EditControl.Done<br />; Purpose:<br />; Arguments: None.<br />; Return:&nbsp; &nbsp; Nothing<br /><br />Method EditControl.Done, uses esi<br />&nbsp; &nbsp; SetObject esi<br /><br />&nbsp; &nbsp; Unsubclass EditControl&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Uses esi<br />&nbsp; &nbsp; ACall Done<br />MethodEnd<br />; ???????????????????????<br />; Method:&nbsp; &nbsp; EditControl.WndProc<br />; Purpose:<br />; Arguments: uMsg:&nbsp; Message identifier<br />;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wParam: 	First message parameter<br />;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  lParam:&nbsp; Second message parameter<br />;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  Window handle passed in esi<br />; Return:<br /><br />Method EditControl.WndProc,, uMsg:dword, wParam:dword, lParam:dword<br />&nbsp; &nbsp; GetSubclassingInst EditControl, Self<br />&nbsp; &nbsp; OCall eax::EditControl.Dispatch, Self, uMsg, wParam, lParam<br />MethodEnd</code></pre><br />The initialization structure is defined as:<br /><pre><code><br />EditDef struc<br />&nbsp; dCtlID&nbsp; &nbsp; &nbsp; dword&nbsp; &nbsp;  ?&nbsp;  ; Control ID<br />&nbsp; sdPosX&nbsp; &nbsp; &nbsp; sdword&nbsp; &nbsp; ?&nbsp;  ; X position<br />&nbsp; sdPosY&nbsp; &nbsp; &nbsp; sdword&nbsp; &nbsp; ?&nbsp;  ; Y position<br />&nbsp; dWidth&nbsp; &nbsp; &nbsp; dword&nbsp; &nbsp;  ?&nbsp;  ; Width<br />&nbsp; dHeight&nbsp; &nbsp;  dword&nbsp; &nbsp;  ?&nbsp;  ; Height<br />&nbsp; dStyle&nbsp; &nbsp; &nbsp; dword&nbsp; &nbsp;  ?&nbsp;  ; Control style.<br />&nbsp; dExStyle	&nbsp; dword		?&nbsp;  ; Extended style.<br />EditDef ends</code></pre><br />I can create and place an edit control on a window with this object.<br />Just for learning purposes using Icz&#39;s tut as an example, I tried using an &quot;Event&quot; for the WM_Char message and a Static method to filter out unwanted characters.<br />Here&#39;s the method:<br /><pre><code><br />Method EditControl.OnChar, , wParam:dword, lParam:dword<br /><br />&nbsp; &nbsp; mov eax, wParam<br /><br />&nbsp; &nbsp; .if (eax &gt;= &#39;a&#39;) &amp;&amp; (eax &lt;= &#39;f&#39;)<br />&nbsp; &nbsp; &nbsp; GetSubclassingInst EditControl, Self<br />&nbsp; &nbsp; &nbsp; OCall eax::EditControl.Dispatch, Self, WM_CHAR, wParam, lParam<br />&nbsp; &nbsp; .endif<br />&nbsp; &nbsp; xor eax, eax<br />MethodEnd<br /></code></pre><br />Well the unwanted chars are filtered out, but when I press a char in the wanted range ,the pro craps out and drwin pops up. <br />What am I missing/ doing wrong?<br />Regards,<br />&nbsp; &nbsp;  Rags</div>
    <div class="meta">Posted on 2007-02-06 12:22:57 by rags</div>
   </div>
   <div class="post" id="post-188020">
    <div class="subject"><a href="#post-188020">Re: Subclassing a control in ObjAsm32</a></div>
    <div class="body">Hi rags<br />First the good news: using the WinControl as the ancestor for the EditControl is a good choice. Take a look at it methods to see what it does. Basically, it has a message dispatch mechanism build in the Dispatch method and an abstract method for the new descendant method that will receive the Window messages and pass them to the dispatcher. Tollbar.inc is a short file you can use as orientation. Looking at your code I cant see nothing wrong with this.<br /><br />OK, now the problem is the last method, EditControl.OnChar. I guess that you only want the the characters in the range from a..f reach the Edit control. In that case you have to forward the message to the original Edit window using <br /><br /><pre><code>Method EditControl.OnChar, , wParam:dword, lParam:dword<br />&nbsp; &nbsp; SetObject ecx<br />&nbsp; &nbsp; mov eax, wParam<br />&nbsp; &nbsp; .if (eax &gt;= &#39;a&#39;) &amp;&amp; (eax &lt;= &#39;f&#39;)<br />&nbsp; &nbsp; &nbsp; invoke SendMessage, .hWnd, WM_CHAR, wParam, lParam<br />&nbsp; &nbsp; .else<br />&nbsp; &nbsp; &nbsp; xor eax, eax<br />&nbsp; &nbsp; .endif<br />MethodEnd</code></pre><br /><br />A second issue is where you store the handle if the subclassed Edit control. The parent of WinControl is called WinPrimer. It defines the hWnd member and there you must store it. You will see that the Subclass macro (WinHelpers.inc) makes use of it.<br />My suggestion is to remove the hEdit member and use something like<br /><br /><pre><code>Object EditControl,EditControlID,WinControl&nbsp; &nbsp; &nbsp; ; class &quot;EDIT&quot;<br />&nbsp; RedefineMethod Init,&nbsp; &nbsp; &nbsp; Pointer, Handle, Pointer<br />&nbsp; RedefineMethod Done<br />&nbsp; StaticMethod&nbsp;  OnChar,&nbsp; &nbsp; dword, dword<br />&nbsp; RedefineMethod WndProc,&nbsp;  dword, dword, dword<br />&nbsp; <br />&nbsp; Event OnChar, WM_CHAR<br /><br />ObjectEnd</code></pre><br /><br /><br /><pre><code>Method EditControl.Init, uses esi, pOwner:Pointer, hParentWnd:Handle, pDefStruc:Pointer<br />&nbsp; &nbsp; SetObject esi<br />&nbsp; &nbsp; mov ecx, pDefStruc<br />&nbsp; &nbsp; assume ecx:ptr EditDef<br />&nbsp; &nbsp; mov eax, .dStyle<br />&nbsp; &nbsp; or eax, WS_CHILD or WS_VISIBLE<br />&nbsp; &nbsp; @invoke CreateWindowEx, .dExStyle, &quot;EDIT&quot;, NULL, eax, \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .sdPosX, .sdPosY, .dWidth, .dHeight, \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hParentWnd, .dCtlID, hInstance, 0<br />&nbsp; &nbsp; assume ecx:nothing<br />&nbsp; &nbsp; ACall esi.Init, pOwner, eax<br />&nbsp; &nbsp; Subclass EditControl&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Uses esi<br />MethodEnd</code></pre><br /><br />I hope this helps&nbsp; ;)<br /><br />Regards,<br /><br />Biterider<br /></div>
    <div class="meta">Posted on 2007-02-06 14:58:05 by Biterider</div>
   </div>
   <div class="post" id="post-188090">
    <div class="subject"><a href="#post-188090">Re: Subclassing a control in ObjAsm32</a></div>
    <div class="body">BiteRider,<br /> I finally got a chance to sit down and look at and make the changes you suggested.<br /> The proposed changes to the code you made, seems to send the code into an endless loop.<br />After studying your code in the objects I came up with this, which seems to work properly.:<br /><pre><code><br />Method EditControl.OnChar,, wParam:dword, lParam:dword<br />&nbsp; &nbsp; SetObject ecx<br /><br />&nbsp; &nbsp; mov eax, wParam<br /><br /><br />&nbsp; &nbsp; .if&nbsp; (eax &gt;= &#39;a&#39;) &amp;&amp; (eax &lt;= &#39;f&#39;)<br /><br />&nbsp; &nbsp; invoke CallWindowProc ,.pPrevWndProc,.hWnd,WM_CHAR,wParam,lParam<br />&nbsp; &nbsp; xor eax, eax<br />&nbsp; &nbsp; .else<br />&nbsp; &nbsp; &nbsp;  xor eax, eax<br />&nbsp; &nbsp; .endif<br /><br />MethodEnd<br /><br /></code></pre><br />Thanks for taking the time to reply :)<br />regards,<br />&nbsp; &nbsp; Rags<br /><br /></div>
    <div class="meta">Posted on 2007-02-12 12:27:12 by rags</div>
   </div>
  </div>
 </body>
</html>