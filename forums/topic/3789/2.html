<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>The amusing code of conversion of hexadecimal character digi - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=3789" />
  <link rel="prev" href="../?id=3789&amp;page=1" />   </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=3789">The amusing code of conversion of hexadecimal character digi</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=3789&amp;page=1" style="">&laquo;</a><a href="../?id=3789&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="3789" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>   <div class="post" id="post-25748">
    <div class="subject"><a href="#post-25748">The amusing code of conversion of hexadecimal character digi</a></div>
    <div class="body">Test this one:<br /><pre><code><br />;edi - pointer to string<br />;===============================<br />	mov cl,2Fh<br />@@&#58;	inc cl<br />	sub al,100<br />	jnc @B<br />	add al,100<br />	cmp cl,31h<br />	mov &#91;edi&#93;,cl<br />	sbb edx,edx<br />	aam<br />	cmp ah,1<br />	lea eax,&#91;eax&#93;&#91;3030h&#93;<br />	sbb ecx,ecx <br />	mov &#91;edi&#93;&#91;edx&#93;&#91;1&#93;,ah <br />	and ecx,edx<br />	add edi,ecx<br />	mov &#91;edi&#93;&#91;edx&#93;&#91;2&#93;,al<br />	mov byte ptr &#91;edi&#93;&#91;edx&#93;&#91;3&#93;,&quot;,&quot;<br />;===============================<br />;	lea edi,&#91;edi&#93;&#91;edx&#93;&#91;4&#93; - will load addr of next to &quot;,&quot; byte<br /></code></pre></div>
    <div class="meta">Posted on 2002-02-24 18:54:37 by The Svin</div>
   </div>
   <div class="post" id="post-25768">
    <div class="subject"><a href="#post-25768">The amusing code of conversion of hexadecimal character digi</a></div>
    <div class="body"><strong>Nexo</strong>, maybe I should have used the term 'pre-decode' to stick with the terminology of the AMD documentation - as there are many stages to the pipeline.  Sorry, if I was confusing.  My analysis of the AMD pipeline is fuzzy in the middle - I understand the pre-decode and the OP execution, but my tests don't seem to fit with what the documentation states.</div>
    <div class="meta">Posted on 2002-02-25 00:51:25 by bitRAKE</div>
   </div>
   <div class="post" id="post-25771">
    <div class="subject"><a href="#post-25771">The amusing code of conversion of hexadecimal character digi</a></div>
    <div class="body">bitRAKE, I have made measurements for a cyclic code. Has received 10 clock ticks of execution for the own code, and for yours 11. The small difference of measurement with yours is coupled to differences of methods of measurement. Execution time of a cyclic code speaks absence of additional stages of the pipeline which were present at linear execution.<br />Always it is possible to find explanations. ;)</div>
    <div class="meta">Posted on 2002-02-25 02:56:32 by Nexo</div>
   </div>
   <div class="post" id="post-25772">
    <div class="subject"><a href="#post-25772">The amusing code of conversion of hexadecimal character digi</a></div>
    <div class="body">Hi, hutch--. <br />As a second approximation my code of your task looks so: <br />; Input: al-number , edi-chars buffer<br />	movzx	eax,al<br />	cmp	eax,10<br />	jb	@@1<br />	mov	ecx,' ,'shl 16<br />	cmp	eax,100<br />	jb	@@10<br />	xor	ecx,ecx<br />	add	eax,-200<br />	adc	ecx,1<br />	imul	ebx,ecx,-100<br />	add	ecx,',0'<br />	lea	eax,<br />	shl	ecx,16<br />@@10:<br />	mov	edx,0CCCCCCCDh<br />	mov	ebx,eax<br />	mul	edx<br />	shr	edx,3<br />	imul	eax,edx,-10<br />	shl	edx,8<br />	add	eax,ebx<br />	lea	ecx,<br />	add	eax,ecx<br />	bswap	eax<br />	mov	,eax<br />	add edi,4<br />	ret<br />@@1:<br />	shl	eax,24<br />	add	eax,'0,--'<br />	mov	,eax<br />	add edi,4<br />	ret<br /><br />--,9    1 digit - 3 clocks<br />-,99    2 digits - 11 clocks<br />,199    3 digits - 18 clocks (optimized from 23)</div>
    <div class="meta">Posted on 2002-02-25 02:57:27 by Nexo</div>
   </div>
   <div class="post" id="post-25780">
    <div class="subject"><a href="#post-25780">The amusing code of conversion of hexadecimal character digi</a></div>
    <div class="body">Nexo,<br /><br />I liked your suggestion on using a table as it removes the need to do the conversion on the fly. In the application I am not worried about 1k of table data in the code section so I coded up the first try of taking BYTE data as input and outputting formatted DB sequence data.<br /><br />Thsi version has not been close range optimised but it is reasonably tidy as is. It maintains DWORD size write and I think I have kept the alignment correct so the write speed should be OK.<br /><br />Important with this algo is to supply a buffer to write the data to that is 5 times the size of the source BYTE data. There is no size checking on the buffer and it will produce a page write fault if the buffer is not big enough.<br /><br />I have not done any benmchmarking on it yet as it is still in the test piece I wrote it in.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a><br /><pre><code><br />; ########################################################################<br /><br />AsciiDump proc lpsrc&#58;DWORD,lpbuf&#58;DWORD,lnsrc&#58;DWORD<br /><br />    LOCAL count  &#58;DWORD<br /><br />    jmp @F<br />    align 4<br />  StringTable&#58;<br />    db &quot;  0&quot;,44,&quot;  1&quot;,44,&quot;  2&quot;,44,&quot;  3&quot;,44,&quot;  4&quot;,44,&quot;  5&quot;,44,&quot;  6&quot;,44,&quot;  7&quot;,44<br />    db &quot;  8&quot;,44,&quot;  9&quot;,44,&quot; 10&quot;,44,&quot; 11&quot;,44,&quot; 12&quot;,44,&quot; 13&quot;,44,&quot; 14&quot;,44,&quot; 15&quot;,44<br />    db &quot; 16&quot;,44,&quot; 17&quot;,44,&quot; 18&quot;,44,&quot; 19&quot;,44,&quot; 20&quot;,44,&quot; 21&quot;,44,&quot; 22&quot;,44,&quot; 23&quot;,44<br />    db &quot; 24&quot;,44,&quot; 25&quot;,44,&quot; 26&quot;,44,&quot; 27&quot;,44,&quot; 28&quot;,44,&quot; 29&quot;,44,&quot; 30&quot;,44,&quot; 31&quot;,44<br />    db &quot; 32&quot;,44,&quot; 33&quot;,44,&quot; 34&quot;,44,&quot; 35&quot;,44,&quot; 36&quot;,44,&quot; 37&quot;,44,&quot; 38&quot;,44,&quot; 39&quot;,44<br />    db &quot; 40&quot;,44,&quot; 41&quot;,44,&quot; 42&quot;,44,&quot; 43&quot;,44,&quot; 44&quot;,44,&quot; 45&quot;,44,&quot; 46&quot;,44,&quot; 47&quot;,44<br />    db &quot; 48&quot;,44,&quot; 49&quot;,44,&quot; 50&quot;,44,&quot; 51&quot;,44,&quot; 52&quot;,44,&quot; 53&quot;,44,&quot; 54&quot;,44,&quot; 55&quot;,44<br />    db &quot; 56&quot;,44,&quot; 57&quot;,44,&quot; 58&quot;,44,&quot; 59&quot;,44,&quot; 60&quot;,44,&quot; 61&quot;,44,&quot; 62&quot;,44,&quot; 63&quot;,44<br />    db &quot; 64&quot;,44,&quot; 65&quot;,44,&quot; 66&quot;,44,&quot; 67&quot;,44,&quot; 68&quot;,44,&quot; 69&quot;,44,&quot; 70&quot;,44,&quot; 71&quot;,44<br />    db &quot; 72&quot;,44,&quot; 73&quot;,44,&quot; 74&quot;,44,&quot; 75&quot;,44,&quot; 76&quot;,44,&quot; 77&quot;,44,&quot; 78&quot;,44,&quot; 79&quot;,44<br />    db &quot; 80&quot;,44,&quot; 81&quot;,44,&quot; 82&quot;,44,&quot; 83&quot;,44,&quot; 84&quot;,44,&quot; 85&quot;,44,&quot; 86&quot;,44,&quot; 87&quot;,44<br />    db &quot; 88&quot;,44,&quot; 89&quot;,44,&quot; 90&quot;,44,&quot; 91&quot;,44,&quot; 92&quot;,44,&quot; 93&quot;,44,&quot; 94&quot;,44,&quot; 95&quot;,44<br />    db &quot; 96&quot;,44,&quot; 97&quot;,44,&quot; 98&quot;,44,&quot; 99&quot;,44,&quot;100&quot;,44,&quot;101&quot;,44,&quot;102&quot;,44,&quot;103&quot;,44<br />    db &quot;104&quot;,44,&quot;105&quot;,44,&quot;106&quot;,44,&quot;107&quot;,44,&quot;108&quot;,44,&quot;109&quot;,44,&quot;110&quot;,44,&quot;111&quot;,44<br />    db &quot;112&quot;,44,&quot;113&quot;,44,&quot;114&quot;,44,&quot;115&quot;,44,&quot;116&quot;,44,&quot;117&quot;,44,&quot;118&quot;,44,&quot;119&quot;,44<br />    db &quot;120&quot;,44,&quot;121&quot;,44,&quot;122&quot;,44,&quot;123&quot;,44,&quot;124&quot;,44,&quot;125&quot;,44,&quot;126&quot;,44,&quot;127&quot;,44<br />    db &quot;128&quot;,44,&quot;129&quot;,44,&quot;130&quot;,44,&quot;131&quot;,44,&quot;132&quot;,44,&quot;133&quot;,44,&quot;134&quot;,44,&quot;135&quot;,44<br />    db &quot;136&quot;,44,&quot;137&quot;,44,&quot;138&quot;,44,&quot;139&quot;,44,&quot;140&quot;,44,&quot;141&quot;,44,&quot;142&quot;,44,&quot;143&quot;,44<br />    db &quot;144&quot;,44,&quot;145&quot;,44,&quot;146&quot;,44,&quot;147&quot;,44,&quot;148&quot;,44,&quot;149&quot;,44,&quot;150&quot;,44,&quot;151&quot;,44<br />    db &quot;152&quot;,44,&quot;153&quot;,44,&quot;154&quot;,44,&quot;155&quot;,44,&quot;156&quot;,44,&quot;157&quot;,44,&quot;158&quot;,44,&quot;159&quot;,44<br />    db &quot;160&quot;,44,&quot;161&quot;,44,&quot;162&quot;,44,&quot;163&quot;,44,&quot;164&quot;,44,&quot;165&quot;,44,&quot;166&quot;,44,&quot;167&quot;,44<br />    db &quot;168&quot;,44,&quot;169&quot;,44,&quot;170&quot;,44,&quot;171&quot;,44,&quot;172&quot;,44,&quot;173&quot;,44,&quot;174&quot;,44,&quot;175&quot;,44<br />    db &quot;176&quot;,44,&quot;177&quot;,44,&quot;178&quot;,44,&quot;179&quot;,44,&quot;180&quot;,44,&quot;181&quot;,44,&quot;182&quot;,44,&quot;183&quot;,44<br />    db &quot;184&quot;,44,&quot;185&quot;,44,&quot;186&quot;,44,&quot;187&quot;,44,&quot;188&quot;,44,&quot;189&quot;,44,&quot;190&quot;,44,&quot;191&quot;,44<br />    db &quot;192&quot;,44,&quot;193&quot;,44,&quot;194&quot;,44,&quot;195&quot;,44,&quot;196&quot;,44,&quot;197&quot;,44,&quot;198&quot;,44,&quot;199&quot;,44<br />    db &quot;200&quot;,44,&quot;201&quot;,44,&quot;202&quot;,44,&quot;203&quot;,44,&quot;204&quot;,44,&quot;205&quot;,44,&quot;206&quot;,44,&quot;207&quot;,44<br />    db &quot;208&quot;,44,&quot;209&quot;,44,&quot;210&quot;,44,&quot;211&quot;,44,&quot;212&quot;,44,&quot;213&quot;,44,&quot;214&quot;,44,&quot;215&quot;,44<br />    db &quot;216&quot;,44,&quot;217&quot;,44,&quot;218&quot;,44,&quot;219&quot;,44,&quot;220&quot;,44,&quot;221&quot;,44,&quot;222&quot;,44,&quot;223&quot;,44<br />    db &quot;224&quot;,44,&quot;225&quot;,44,&quot;226&quot;,44,&quot;227&quot;,44,&quot;228&quot;,44,&quot;229&quot;,44,&quot;230&quot;,44,&quot;231&quot;,44<br />    db &quot;232&quot;,44,&quot;233&quot;,44,&quot;234&quot;,44,&quot;235&quot;,44,&quot;236&quot;,44,&quot;237&quot;,44,&quot;238&quot;,44,&quot;239&quot;,44<br />    db &quot;240&quot;,44,&quot;241&quot;,44,&quot;242&quot;,44,&quot;243&quot;,44,&quot;244&quot;,44,&quot;245&quot;,44,&quot;246&quot;,44,&quot;247&quot;,44<br />    db &quot;248&quot;,44,&quot;249&quot;,44,&quot;250&quot;,44,&quot;251&quot;,44,&quot;252&quot;,44,&quot;253&quot;,44,&quot;254&quot;,44,&quot;255&quot;,44<br />  @@&#58;<br /><br />    push ebx<br />    push esi<br />    push edi<br />  ; ============================<br /><br />    lea edx, StringTable<br />    xor ebx, ebx                    ; line length counter<br /><br />    mov eax, lpsrc<br />    add eax, lnsrc<br />    mov count, eax                  ; set count as exit condition<br /><br />    mov esi, lpsrc<br />    mov edi, lpbuf<br /><br />    mov &#91;edi&#93;, DWORD PTR 0D202020h  ; 3 space padding for alignment + CR<br />    add edi, 4<br />    mov &#91;edi&#93;, DWORD PTR 2062640Ah  ; LF + &quot;db &quot;<br />    add edi, 4<br /><br />    xor eax, eax                    ; avoid stall<br /><br />  ; %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<br /><br />  @@&#58;<br />    mov al, &#91;esi&#93;<br />    inc esi<br />    mov ecx, &#91;edx+eax*4&#93;            ; all table writes are DWORD size<br />    mov &#91;edi&#93;, ecx<br />    add edi, 4<br /><br />    cmp ebx, 16                     ; test character count per line<br />    je nxt1                         ; jump on less common choice<br />    inc ebx<br />    cmp esi, count                  ; test exit condition<br />    jne @B<br />    jmp The_Exit<br /><br />  nxt1&#58;<br />    dec edi<br />    mov &#91;edi&#93;, BYTE PTR 13          ; overwrite comma with CR<br />    inc edi<br />    mov &#91;edi&#93;, DWORD PTR 2062640Ah  ; write 4 bytes to maintain alignment<br />    add edi, 4<br />    xor ebx, ebx                    ; zero character count<br />    jmp @B<br /><br />  ; %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<br /><br />  The_Exit&#58;<br /><br />  ; only overwrite last character IF its a comma &quot;,&quot;<br /><br />    cmp &#91;edi-1&#93;, BYTE PTR &quot;,&quot;<br />    jne @F<br />    dec edi<br />  @@&#58;<br />    mov &#91;edi&#93;, DWORD PTR 00000A0Dh  ; append CRLF * 2 ascii zeros<br /><br />  ; ============================<br />    pop edi<br />    pop esi<br />    pop ebx<br /><br />    ret<br /><br />AsciiDump endp<br /><br />; #########################################################################<br /></code></pre></div>
    <div class="meta">Posted on 2002-02-25 05:31:06 by hutch--</div>
   </div>
   <div class="post" id="post-25783">
    <div class="subject"><a href="#post-25783">The amusing code of conversion of hexadecimal character digi</a></div>
    <div class="body"><div class="quote">Why you do not make the elementary sequential optimization of commands? The command &quot; and edx, 0FFFF0000h &quot; is absolutely not necessary. </div> <br /><br />Here is one good idea in your code, (it is not , of course, first two<br />lines) but in general it is not faster but slower in processors<br />it was written for.<br />It was written to use in Pplain and Pmmx without MMX commands<br />and performs 10-15% faster on them than the code you wrote.<br />As to MMX version, it's well written, I saw 3 or 4 versions using the algo with MMX after I released it.<br />I just wished to show you the algo, so you can use idea, wether<br />with usuall interger commands, or MMX or whatever :)</div>
    <div class="meta">Posted on 2002-02-25 06:56:29 by The Svin</div>
   </div>
   <div class="post" id="post-25789">
    <div class="subject"><a href="#post-25789">The amusing code of conversion of hexadecimal character digi</a></div>
    <div class="body"><strong>Hutch--</strong>, it's hard to beat the table - even with MMX. :)<br />I only make a couple small changes:<pre><code>AsciiDump proc lpsrc&#58;DWORD,lpbuf&#58;DWORD,lnsrc&#58;DWORD<br /><br />    jmp @F<br />    align 4<br />  StringTable&#58;<br />    ; &#123;clipped&#125;<br />  @@&#58;<br /><br />    push ebx<br />    push esi<br />    push edi<br />  ; ============================<br /><br />    lea edx, StringTable<br />    xor ecx, ecx                    ; byte counter for source<br /><br />    mov esi, lpsrc<br />    mov edi, lpbuf<br /><br />    mov &#91;edi&#93;, DWORD PTR 0D202020h  ; 3 space padding for alignment + CR<br />    add edi, 4<br />    mov &#91;edi&#93;, DWORD PTR 2062640Ah  ; LF + &quot;db &quot;<br />    add edi, 4<br /><br />    xor eax, eax                    ; avoid stall<br /><br />  ; %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<br /><br />  @@&#58;<br />    mov al, &#91;esi+ecx&#93;<br />    inc ecx<br />    mov ebx, &#91;edx+eax*4&#93;            ; all table writes are DWORD size<br />    mov &#91;edi&#93;, ebx<br />    add edi, 4<br /><br />    test ecx, 0Fh                   ; test character count per line<br />    je nxt1                         ; jump on less common choice<br />    cmp ecx, lnstr                  ; test exit condition<br />    jne @B<br />    jmp The_Exit<br /><br />  nxt1&#58;<br />    mov BYTE PTR &#91;edi-1&#93;, 13        ; overwrite comma with CR<br />    mov DWORD PTR &#91;edi&#93;, 2062640Ah  ; write 4 bytes to maintain alignment<br />    add edi, 4<br />    jmp @B<br /><br />  ; %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<br /><br />  The_Exit&#58;<br /><br />  ; only overwrite last character IF its a comma &quot;,&quot;<br /><br />    cmp &#91;edi-1&#93;, BYTE PTR &quot;,&quot;<br />    jne @F<br />    dec edi<br />  @@&#58;<br />    mov &#91;edi&#93;, DWORD PTR 00000A0Dh  ; append CRLF * 2 ascii zeros<br /><br />  ; ============================<br />    pop edi<br />    pop esi<br />    pop ebx<br /><br />    ret<br /><br />AsciiDump endp</code></pre>Your version was easier to change the bytes per line.</div>
    <div class="meta">Posted on 2002-02-25 08:36:02 by bitRAKE</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=3789&amp;page=1" style="">&laquo;</a><a href="../?id=3789&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="3789" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>  </div>
 </body>
</html>