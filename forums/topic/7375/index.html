<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>how debug vxd - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=7375" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=7375">how debug vxd</a></p>
   <div class="post" id="post-53559">
    <div class="subject"><a href="#post-53559">how debug vxd</a></div>
    <div class="body">Hello everybody,<br /><br />I know there has been lots of questions about which debugger is best.  Everybody has their preference.  I use OllyDdg but it doesn't debug vxd's.  I know softice supports this but I put it on my wish list last christmas and I'm still waiting:)  Is there any other debugger or method I can use?  How do other people debug vxd's?<br /><br /><br />best regards,<br /><br />czDrillard</div>
    <div class="meta">Posted on 2002-08-16 02:20:41 by czDrillard</div>
   </div>
   <div class="post" id="post-53566">
    <div class="subject"><a href="#post-53566">how debug vxd</a></div>
    <div class="body">use wdeb386. Very stable and nice user interface :)</div>
    <div class="meta">Posted on 2002-08-16 03:25:36 by japheth</div>
   </div>
   <div class="post" id="post-53631">
    <div class="subject"><a href="#post-53631">how debug vxd</a></div>
    <div class="body">If the VDD is not very long you can use a disassembler, and study it quietly somewhere, the park, the beach... :)</div>
    <div class="meta">Posted on 2002-08-16 11:07:46 by slop</div>
   </div>
   <div class="post" id="post-53639">
    <div class="subject"><a href="#post-53639">how debug vxd</a></div>
    <div class="body">Thanks for answers,<br /><br />japheth:  That sounded like what I wanted and I've got  wdeb386 in the DDK98.  I was just reading the documentation and at the end under 'How to Get Started' is the following quote:<br />______________________________________________<br /><br />You need a computer with a serial port, and you'll need to buy or make a null-modem cable. You only need a three-line null modem cable . . .<br /> ______________________________________________<br /><br />Disappointing, this sounds like a job for a mechanic not a programmer:)  Is there any more info about this anywhere?<br /><br />sloppy:  this a very small vxd, I'm writing it myself so I've got the source code.  Maybe I'm not thinking clearly, but would it help me much to disassemble the exe when I've got the source code?  I just got up so it's quite possible my brain is still disengaged:)<br /><br />best regards,<br /><br />czDrillard</div>
    <div class="meta">Posted on 2002-08-16 12:27:07 by czDrillard</div>
   </div>
   <div class="post" id="post-53641">
    <div class="subject"><a href="#post-53641">how debug vxd</a></div>
    <div class="body">Ok, you're right, your brain is tuned I think, my answer was a little sloppy, as always ;)<br /><br />If you have the code you can:<br /><br />1) Use a VDD-debug uyility provided by microsoft:<br /><a target="_blank" href="http://msdn.microsoft.com/library/en-us/dbgtools/">http://msdn.microsoft.com/library/en-us/dbgtools/</a> hh/dbgtools/dev_name_2of9.asp<br /><br />2)Send it to me and I?ll use my quiet and relaxing park-debugging (with a dissasembly list) ;)</div>
    <div class="meta">Posted on 2002-08-16 12:36:36 by slop</div>
   </div>
   <div class="post" id="post-53651">
    <div class="subject"><a href="#post-53651">how debug vxd</a></div>
    <div class="body">Hi sloppy,<br /><br />Your link is broken, I copied entire link and pasted but still page not found:(  I searched MS and wdeb386 seems to be the only tool to use anyway.<br /><br />I'm new to vxd writing and am working my way through Iczelion's tuts.  I got to vxd tut 6 and there should be a message box displayed from within the vxd.  This isn't happening and I wanted to check the value of edi.  So when I say 'I'm writing it myself' I mean I'm re-writing Iczelion's tutorial:)  Thanks anyway for the offer on the listing.<br /><br />Btw, where do you live that there is quiet parks?<br /><br />Eventually I want to write a vxd and use <strong>RO_SWAPPER_CALL SHR 8</strong>  It is my goal to clear contents of swap file.<br /><br />best regards,<br /><br />czDrillard</div>
    <div class="meta">Posted on 2002-08-16 13:29:54 by czDrillard</div>
   </div>
   <div class="post" id="post-53668">
    <div class="subject"><a href="#post-53668">how debug vxd</a></div>
    <div class="body">If you don't have softice, a secondary computer or vmware... and even with softice, a secondary computer<br />is nice, and vmware can be a timesaver too.</div>
    <div class="meta">Posted on 2002-08-16 15:35:31 by f0dder</div>
   </div>
   <div class="post" id="post-53704">
    <div class="subject"><a href="#post-53704">HOW TO: Create a system modal Message Box</a></div>
    <div class="body">Hi czDrillard,<br /><br />How about converting the register values you want to find out about to ascii and using VWIN32_SysErrorBox to generate a Ring0 system modal message box to signal you of the ultimate demise of your code? ;)  Up to 3 buttons can be defined in a VSEB structure, including 2 ascii buffers (message text and caption) you can use to relay information.  Depending on your response you could then direct the code any of 3 ways.<br /><br />The code below displays the register values of edi and  at an arbitrary place in vxd code in a message box which allows user input.  To be more useful for full debugging purposes, a complete module which accesses the CONTEXT structure in a self generated Interrupt Service Routine using an appropriate hook, and spits out the values wherever it's placed in code would be even better, but would likely be deemed inappropriate...<br /><br /><pre><code><br />VxD_PAGEABLE_DATA_SEG<br /><br />pszText	 	db 512 dup&#40;?&#41;	  ; buffer to contain message text<br />pszCaption 	db &quot;Caption&quot;, 0	  ; caption text<br />StringFmt db &quot;%08X&quot;,&quot;-&quot;,&quot;%08X&quot;,0  ; format string for VMMCall _Sprintf<br /><br />;--------------------------------------------------<br />; This is the vwin32.inc structure needed to display<br />; the system modal error box<br />;--------------------------------------------------<br />vseb_s	struct<br />	vseb_resp	DD	?<br />	vseb_b3		DW	?<br />	vseb_b2		DW	?<br />	vseb_b1		DW	?<br />	vseb_pszCaption	DD	?<br />	vseb_pszText	DD	?<br />vseb_s	ends<br /><br />MBInfo vseb_s &lt;&gt;<br /><br />VxD_PAGEABLE_DATA_ENDS<br /><br />;=================================<br /><br />VxD_PAGEABLE_CODE_SEG<br /><br />;==================================<br />; VMMCall _Sprintf, &lt;pOutBuf, pFormat, Param1, Param2, ...&gt;<br />; Formats a string in a manner analogous to the C procedure,<br />; Uses EAX, ECX, EDX and Flags. Returns length of string.<br />;<br />; VMMCall _Sprintf will output the values of EDI and &#91;EDI&#93;<br />; into the Message text buffer, defined in the format string<br />; as &quot;register - dword ptr &#91;register&#93;&quot;<br />;===================================<br />;...<br />	push &#91;edi&#93;		; Param2<br />	push edi		; Param1<br />	push offset32 StringFmt<br />	push offset32 pszText<br />	VMMCall _Sprintf<br />	add esp, 0Ch		; basic stack balance<br />	pop eax		; add for extra params pushed<br /><br />;===================================<br />; Create a Message box<br />;===================================<br /><br />;-------------------------------------------------------------<br />; Fill vseb_s structure with MessageBox info<br />; &#40;concatenate or use _Sprintf to create a longer string&#41;<br />;-------------------------------------------------------------<br />mov eax, offset32 pszText		; main message box text<br />mov MBInfo.vseb_pszText, eax		<br /><br />mov eax, offset32 pszCaption		; caption text<br />mov MBInfo.vseb_pszCaption, eax<br /><br />; define buttons<br />mov MBInfo.vseb_b1, 1	; Button with &quot;OK&quot;	<br />mov MBInfo.vseb_b2, 7	; Button with &quot;&amp;Ignore <br />mov MBInfo.vseb_b3, 8  	; Button with &quot;Close&quot;   <br />	<br />mov ebx, offset32 MBInfo <br />     ; pointer to start of vseb_s structure passed in EBX<br />VXDCall VWIN32_SysErrorBox<br /><br />;-------------------------------------------------------------<br />; Check users response - vseb_resp indicates which button<br />; the user pressed. May be 1, 2 or 3<br />;-------------------------------------------------------------<br />mov eax, MBInfo.vseb_resp <br />.if eax == 1<br />...	<br /><br /><br />ret<br />VxD_PAGEABLE_CODE_ENDS	<br /><br />;==========================================<br />; If you wanted to access the full CONTEXT structure from an ISR<br />; within a VxD_LOCKED_CODE_SEG, you could use these functions<br /><br />;push offset32 ContextStruct<br />     ; Address of a CONTEXT structure <br />;VMMCall Get_Cur_Thread_Handle<br />;push edi<br />     ; Ptcb Ring 0 thread handle		<br />;VXDCall _VWIN32_Get_Thread_Context<br />;==========================================<br /><br /></code></pre><br /><br />Hope this helps.<br /><br />Cheers,<br />Kayaker</div>
    <div class="meta">Posted on 2002-08-16 21:25:55 by Kayaker</div>
   </div>
   <div class="post" id="post-53708">
    <div class="subject"><a href="#post-53708">how debug vxd</a></div>
    <div class="body">:alright: Brilliant Kayaker, brilliant,<br /><br />I am going to be busy for awhile playing around with your code.  Who needs those expensive debuggers?  (I will in the future, but not today) I was dragging around the idea of filling the lpOutBuffer of the DeviceIOControl api with data from say the edi register.  Your methods cool.  Thanks<br /><br />best regards,<br /><br />czDrillard</div>
    <div class="meta">Posted on 2002-08-16 22:04:17 by czDrillard</div>
   </div>
   <div class="post" id="post-54032">
    <div class="subject"><a href="#post-54032">how debug vxd</a></div>
    <div class="body">yup! nice and handy one, Kayaker. but, it happened to me mostly, that the driver trigger a BSOD. i just disappointed why this BSOD doesnt show more infos, like what u said, ie  _CONTEXT struct or CLIENT struct. besides its wasting whole screen filling it just with 2-3 line line info. and it worsen when i dont know the base address(coz dynamic loaded) and it halt my pc &gt;(. i wonder how to patch this BSOD so that it shows more comprehensive one. do u know how to do that?<br /><br />thanks</div>
    <div class="meta">Posted on 2002-08-18 21:21:52 by dion</div>
   </div>
   <div class="post" id="post-54064">
    <div class="subject"><a href="#post-54064">how debug vxd</a></div>
    <div class="body">Hi<br /><br />Thank you czDrillard, I hope it works out for you.  What's handy is being able to redirect the code and possibly thwarting off a BSOD crash by sending it to a safe exit.  I suppose there's also the possibility of using some of the VMM Debugging services in your code in conjunction with a debugger, such as _Debug_Out_Service, _Trace_Out_Service..., though I've never looked into it.<br /><br />I'm glad you wrote dion, if you're having problems with this.  The system modal message box is generated from Ring0, but it should look almost identical to a regular Win32 message box, expect on a white background with bad system font and regular buttons, and your desktop should be visible behind it.  If you're getting a BSOD then there's a problem with the implementation of the code.  I sense you may be having more basic problems with the vxd, how are you using the code?  Understand that if you want the full CONTEXT information displayed, then you have to code that in yourself, the example was just to show the basic procedure on a single register.  There are many ways this code could be used, and the strings are how you build them, though I don't know if there is a buffer maximum for the text and caption strings.<br /><br />You don't need this system modal message box if all you're trying to do is relay information to the user, you can also pass a pointer to a structure back to Win32 with lpOutBuffer and extract any information you want from the vxd.  You need to address this BSOD before you can continue.  Start with a basic vxd skeleton that works and I think a VxD_PAGEABLE_CODE_SEG something like this should work?<br /><br /><pre><code><br />VxD_PAGEABLE_CODE_SEG<br /><br />BeginProc OnDeviceIoControl<br />assume esi&#58;ptr DIOCParams<br />.IF &#91;esi&#93;.dwIoControlCode==DIOC_Open<br />	; called on vxd loading by CreateFile <br />	xor eax,eax<br /><br />.ELSEIF &#91;esi&#93;.dwIoControlCode == 1<br />	mov pDIOC,esi	<br />	; save pointer to DIOC params struct 	 <br /><br />; CODE POSTED ABOVE, WITH VARIABLES<br />; DECLARED IN VxD_PAGEABLE_DATA_SEG<br />ret<br /><br />;-----------------END---------------<br />.ELSE<br />xor eax,eax<br />.ENDIF<br />ret<br />EndProc OnDeviceIoControl<br /><br />VxD_PAGEABLE_CODE_ENDS<br /></code></pre><br /><br />If you want to pass information from your vxd to your Win32 GUI, you can easily create a structure to hold any and all variables, pointers, strings, flags, etc., and pass a pointer to the structure back via lpOutBuffer of DeviceIoControl.<br /><br /><pre><code><br />; In VxD_PAGEABLE_DATA_SEG&#58;<br />DRIVER_INFO  struct<br />	strBuffer1 	db 16 dup&#40;?&#41;<br />	strBuffer2 	db 512 dup&#40;?&#41;<br />	PID 		DWORD ?<br />DRIVER_INFO ends<br /><br />Pass2ring3 DRIVER_INFO &lt;&gt;<br />	<br />; In VxD_PAGEABLE_CODE_SEG&#58;<br />; Fill structure variables with whatever...<br /><br />.ELSEIF &#91;esi&#93;.dwIoControlCode == 2<br />	; Can be a separate call<br /><br />;------------------------------------------<br />; Pass starting address of DRIVER_INFO<br />; structure to Win32 via lpvOutBuffer of <br />; DIOC params structure of DeviceIOControl.<br />;------------------------------------------<br /><br />;mov pDIOC,esi  ; save pointer to DIOC params struct 	 <br />mov eax, OFFSET32 Pass2ring3<br /> ; start of DRIVER_INFO structure<br /><br />mov edx, &#91;esi&#93;.lpvOutBuffer<br />mov &#91;edx&#93;, eax		<br /> ; Pass address of our variable structure<br />.endif<br /><br />clc<br />ret<br /></code></pre>	<br /><br />In Win32 you could access the structure in vxd code with<br /> something like<br /><br /><pre><code>	<br />invoke DeviceIoControl,hVxD,2,NULL, NULL,\<br /> OFFSET lpOutBuffer, 4, lpBytesReturned,NULL<br /><br />.IF lpOutBuffer != 0<br /><br />; strBuffer1<br />invoke SendDlgItemMessage, hWnd, IDC_EDIT1,\<br />  WM_SETTEXT, 0, lpOutBuffer<br /><br />; strBuffer2<br />mov edi, lpOutBuffer<br />add edi, 16<br />invoke SendDlgItemMessage, hWnd, IDC_EDIT2, \<br />  WM_SETTEXT, 0, edi<br /><br />; PID<br />add edi, 512<br />mov edi, &#91;edi&#93;<br />invoke wsprintf, ADDR StringBuff, ADDR StringFmt, edi<br />invoke SendDlgItemMessage, hWnd, IDC_EDIT3,\<br />   WM_SETTEXT, 0, ADDR StringBuff<br /><br />.ENDIF	<br /></code></pre>	<br /><br />Kayaker</div>
    <div class="meta">Posted on 2002-08-19 01:48:32 by Kayaker</div>
   </div>
   <div class="post" id="post-54136">
    <div class="subject"><a href="#post-54136">how debug vxd</a></div>
    <div class="body">Chapeau Kayaker!</div>
    <div class="meta">Posted on 2002-08-19 11:14:56 by slop</div>
   </div>
   <div class="post" id="post-54221">
    <div class="subject"><a href="#post-54221">how debug vxd</a></div>
    <div class="body">hmm... before all, thanks Kayaker. maybe i'm not explain it clearly. firstly, i dont want to use debugger . then, i dont want to code a counterpart in win32 gui just for displaying it . then... the most important info i need is like error msgbox in win32 gui, that display bytes at current EIP, so that i could find those byte pattern and knowing which code gets f*** up. the other one like registers contents is just complementary, if could, then better. i wonder maybe this thing can be done with SEH/PM_Fault hooking or whatever to alter BSOD callback. if it cant, then... never mind. just take some minutes to restart computer several times and take a time to think what have i ate before ;p.<br /><br />thx</div>
    <div class="meta">Posted on 2002-08-20 03:12:18 by dion</div>
   </div>
  </div>
 </body>
</html>