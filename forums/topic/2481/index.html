<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Accessing structures - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=2481" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=2481">Accessing structures</a></p>
   <div class="post" id="post-15645">
    <div class="subject"><a href="#post-15645">Accessing structures</a></div>
    <div class="body">Hi @all...<br />I have defined a structure this way:<br /><br /><br />   EXT_LOADER struct<br />      sExtension db 4 dup(?)<br />      sLoader    db 12 dup (?)<br />   EXT_LOADER ends<br /> <br /><br />I have declared in the .data? section:<br /><br /><br />Loaders EXT_LOADER 64 dup (&lt;&gt;)<br /><br /><br />In the code section I address its fields by manual calculation of the address. For example if I have to access the .sLoader of the 5th structure I do 16 * (5-1) + 4.<br />Is there a simpler way to access it, something like in C?<br /><br />   Loaders[5].sLoader<br /><br />It gives me errors!<br /><br />Thanx!<br /><br />Sincerely,<br />   Daniel</div>
    <div class="meta">Posted on 2001-12-21 12:12:45 by dguzz</div>
   </div>
   <div class="post" id="post-15649">
    <div class="subject"><a href="#post-15649">Accessing structures</a></div>
    <div class="body">I believe you can do it a couple of ways, but the way I often do it is:<br /><br /><pre><code>lea ebx, Loaders<br />mov edx, 4             ; &lt;&lt; Fifth item<br />shl edx, 4            ; since its 16 bytes long!<br /><br />mov &#40;EXT_LOADER PTR &#91;ebx + edx&#93;&#41;.sLoader, 1234h</code></pre><br /><br />I have an exam today in this stuff and learned that there is also a &quot;Based Relative Plus Index&quot; addressing mode for Intel systems (( Pretty screwy name but it goes like this ))<br /><br />mov ARRAY,DX<br /><br />if ARRAY = 1000H, BX=0300H, SI=0200H <br /><br />then this will move DX to address 1500H.<br /><br />This is the way <strong>your</strong> trying to attempt this.  Except the 'SI' if being equated as &quot;.sLoader&quot;, BX=5, and ARRAY = Loader.<br /><br />This is fine and well, but the reason your getting errors is because the program doesnt know your intentions.  you assume 5 means (5th structured occourance), but the compiler sees this as &quot;ADD 5&quot;.  So you actually locating:<br /><br />1000h : Base addrss of &quot;Loader&quot; (just a number)<br />+ 05h  : [5] term<br />+ 04h  : .sLoader is the 4th byte in the structure<br />=====================================<br />1009h  &gt;&gt; YOUR STILL within the first 16 bytes!!!<br /><br />This is why you get errors.. your still only messing with the first structure! <br /><br />To correct your way of doing things simply add:<br /><br />mov Loader[ <strong>4 * SIZEOF EXT_LOADER</strong> ].sLoader, 1234h  ; this is the 5th item<br /><br />Anywho.. there is a bit more than i expect you wanted..<br /><br />Hope it helps.<br />:alright: <br />NaN</div>
    <div class="meta">Posted on 2001-12-21 12:48:45 by NaN</div>
   </div>
   <div class="post" id="post-15660">
    <div class="subject"><a href="#post-15660">THANX!</a></div>
    <div class="body">Thanx NaN,<br />it surely helps... and thanx for the very complete answer.<br /><br />I coded the sma eway you exampled in the first part, but I think I'll translate to the last part of your message all of my code.<br /><br />Thanx again NaN<br /><br />Sincerely,<br /> Daniel<br />:alright:</div>
    <div class="meta">Posted on 2001-12-21 14:37:26 by dguzz</div>
   </div>
   <div class="post" id="post-15737">
    <div class="subject"><a href="#post-15737">Accessing structures</a></div>
    <div class="body">Nope problem.. glad to help :)  <br /><br />(( I learned a bit there too :) ))<br /><br />NaN</div>
    <div class="meta">Posted on 2001-12-22 01:08:23 by NaN</div>
   </div>
   <div class="post" id="post-15759">
    <div class="subject"><a href="#post-15759">I was very tired...</a></div>
    <div class="body">... and I didn't realize that my problem was explained not so good. Reading the answer I was very happy because it effectively replied my question, but my question is just a little bit different.<br /><br />Still valid the struct definition and the declaration, I need to access a field in it (both the first and the second in different parts of the code), but the numer of which structure I have to access is in EBX (it was the 5 in the preceding post) and is returned by another proc.<br />So I used this way:<br /><br />dec  ebx<br />shl  ebx, 4         ; EXT_LOADER is 16 bytes long<br />lea  edi, Loaders<br /><br />This way I get the starting address of the structure number EBX.<br /><br />I cannot use<br /><br />lea  edi, Loaders<br /><br />because masm won't compile.<br /><br />Now the question is the same: is there a simpler way to access it, something like in C?<br /><br />Loaders.sLoader <br /><br />Thanx again and please excuse me for not having explained my problem well enoguh (I was very tired)...<br /><br />Sincerely,<br />   Daniel</div>
    <div class="meta">Posted on 2001-12-22 04:35:36 by dguzz</div>
   </div>
   <div class="post" id="post-15777">
    <div class="subject"><a href="#post-15777">HI</a></div>
    <div class="body">Well ASM compilers/assemblers will help you on structures but will not help you with arrays. The reason is clear: this is one of the main jobs for high level compilers (be it C or others), in ASM this is a job for hummans ...<br /><br />Indexing into arrays offten needs you to calculate the base addres of element . This can be as simple as a multiplication with the size of the element and then adding the base addres of array element zero.<br /><br />Hummans and some times compilers try to optimise this calculations in many ways:<br />- use power of 2 for elements size:<br /> like 16,32,64,128,256 etc, this will make the multiplication into a <strong>shl</strong> instruction wich is much faster than a multiplication<br /><br />-incremental parse the array:  <br />there is no need for a multiplication when you know that you move from one element to the other, you can just add the size of one element on each loop<br /><br />given those options and many others assemblers do not know what to do, and IMHO you know it better!<br /><br />So IMHO the most simple way to do it is like this:<br />;----------------------------------------<br />;define one array element<br />;----------------------------------------<br />Array_element STRUC<br /> field01 dd ?<br /> field02 dw ?<br /> field03 db ?<br />Array_element ENDS<br />;-----------------------------------------<br />; define 1000 elements array<br />;-----------------------------------------<br />Array_base Array_element  1000 dup (&lt;?&gt;)<br /><br />;----------------------------------------------<br />;calculate base addres of element N<br />;----------------------------------------------<br />mov esi,offset Array_base<br />mov eax,N<br />mov ebx,SIZE Array_element<br />mul eax,ebx<br />add esi,eax<br />;----------------------------------<br />; start updating element N<br />;----------------------------------<br />mov ,ecx              ;dword<br />mov word ptr ,cx  ;word<br />mov byte ptr ,cl    ;byte<br />;------------------------<br />; etc etc<br />;----------------------<br /><br />As a speed optimization if you have 16 bytes array elements:<br /><br />;--------------------------------------------------------<br />;calculate faster base addres of element N<br />;--------------------------------------------------------<br />mov esi,offset Array_base<br />mov eax,N<br />shl eax,4<br />add esi,eax<br />;-----------------------------------<br /><br /><br />Of course you can make MACROs out of those basic things and then you will be able to acces your array allmost like in C.<br /><br />But i am not a macro guru ...<br /><br />It is important that you realise that every time you write in C:<br /><br />Array.filed01=some_data;<br /><br />the compiler generates those kind of instructions for you... by the quality of this generated code it will depend the speed of your program ... <br /><br />For example if you have multiple such instructions in your code (all with same index N) some compilers will generate multiply code each time...a thing that will never cross my mind because there is no reason to change the esi pointer until we move to the next/other N...isnt it? <br /><br />Besides if i need  (for filter graphic effects)  i will temporary only add SIZE ARRAY_element to esi this time and multiply next time...etc<br /><br /><br /><strong>That is why i like to do it myself and in ASM ;) </strong></div>
    <div class="meta">Posted on 2001-12-22 09:22:06 by BogdanOntanu</div>
   </div>
   <div class="post" id="post-15787">
    <div class="subject"><a href="#post-15787">Accessing structures</a></div>
    <div class="body">Hi BogdanOntanu,<br />thanx for the wide review of the argument...<br /><br />I created my struct 16 bytes long just to use shl ebx, 4 as you can see from my reported code. I also use ofetn a few tricks to optimize speed, but I was wondering id there was a more self-explicative way to address array of structures. This is because I'll release the code (it is part of what will be an Image Editor) and make it modifiable by anyone who wants to optimize it or to develop a plugin for it (even though the plugin interface is quite completed and does not need the source code of the main application).<br /><br />Anyway... thanx for the long answer.<br /><br />Sincerely,<br />   Daniel</div>
    <div class="meta">Posted on 2001-12-22 12:15:55 by dguzz</div>
   </div>
   <div class="post" id="post-15862">
    <div class="subject"><a href="#post-15862">Maybe a perfect spot for a Macro?</a></div>
    <div class="body">I don't have any expertise or talent in the field<br />of Macros, but this seems to be the place where<br />a well written macro would take care of indexing <br />into an array.  Would it be possible +/or<br />practical?:confused: <br /><br />farrier</div>
    <div class="meta">Posted on 2001-12-23 05:11:38 by farrier</div>
   </div>
   <div class="post" id="post-15891">
    <div class="subject"><a href="#post-15891">Accessing structures</a></div>
    <div class="body">The reason your getting errors is because there are two arrays.<br /><br /><strong>Try this</strong>:<br /><br />; zero to first byte of sExtension in sixth item in array.<br />mov Loaders[5].sExtension[0],0<br /><br />shl eax, 4 ; no macro needed...<br />mov Loaders.sExtension[2],0<br /><br /><strong>Chapter 5 - Defining and Using Complex Data Types</strong></div>
    <div class="meta">Posted on 2001-12-23 11:32:19 by bitRAKE</div>
   </div>
   <div class="post" id="post-15955">
    <div class="subject"><a href="#post-15955">Accessing structures</a></div>
    <div class="body">bitRAKE,<br /><br />That looks like the way to do it.  Even better <br />than a Macro;) But one thing confuses me.  I'll <br />use the word index to refer to the numbers inside<br />the []'s, just like indeces in a C array.  Is that<br />still the proper term here?<br /><br />One thing confused me about your post though.<br /><br /><div class="quote"><br />shl eax, 4 ; no macro needed... <br />mov Loaders.sExtension[2],0 <br /></div><br /><br />By using shl eax, 4 you are multiplying the <br />previous index for a Loaders struc by 16.  I would<br />have thought that to access the next Loaders <br />structure, you would simply increment the index <br />for Loaders.  For example:<br /><br />To access element 3 of Loaders and fourth byte of<br />sLoader you would use Loaders[2].sLoader[3] and<br />then to access element 4 of Loaders and fourth <br />byte of sLoader Loaders[3].sLoader[3]  Just <br />increasing from 2 to 3 for the Loaders index will<br />access 16 bytes beyond the previous reference.  Is<br />that right, that the index for Loaders only needs<br />to be incremented by 1 and not 16?<br /><br />Thanks,<br />:confused: <br />farrier</div>
    <div class="meta">Posted on 2001-12-24 06:16:31 by farrier</div>
   </div>
   <div class="post" id="post-15988">
    <div class="subject"><a href="#post-15988">Accessing structures</a></div>
    <div class="body">If you use a register, MASM doesn't know what to assume.  So, MASM assumes that you know what your doing.  :)<pre><code>mov &#91;eax*16&#93;,0 ; this will produce an error<br /></code></pre>There is no instruction for what you suggest, but the following will work because there is an addressing mode that matches.<pre><code>ArrayTest dd 64 dup &#40;?&#41;<br />mov ArrayTest&#91;eax*4&#93;,0</code></pre>You can multiply a register by 2, 4, or 8 in the addressing mode, but you must explicitly state that in your access of the array.  I don't think it would be consistent for MASM to automatically adjust accesses to arrays of 2,4,8 in size and not do so for larger arrays.  Leaving it to the programmer is more consistent.<br /><br />For the example in the above post, this also works:<pre><code>shl eax, 1 ; no macro needed... <br />mov Loaders&#91;eax*8&#93;.sExtension&#91;2&#93;,0<br />shr eax,1 ; now it's back to original value</code></pre></div>
    <div class="meta">Posted on 2001-12-24 11:32:16 by bitRAKE</div>
   </div>
   <div class="post" id="post-16709">
    <div class="subject"><a href="#post-16709">Accessing structures</a></div>
    <div class="body">To BogdanOntanu,<br /><br />I use the same technique for my structures as you<br />use in your example below.<br /><br />But I have a problem.<br />I can not use the following instruction:<br />mov   , ecx<br /><br />I always get an undefined symbol for fildd01<br />when I assemble.<br />So I have to compute the offset into the structure<br />and use:<br />eax = offset<br />mov   , ecx<br /><br />Is there a way to tell the assembler that field01<br />belongs to esi?<br /><br /><div class="quote"><br />;---------------------------------------- <br />                             ;define one array element <br />                             ;---------------------------------------- <br />                             Array_element STRUC <br />                             field01 dd ? <br />                             field02 dw ? <br />                             field03 db ? <br />                             Array_element ENDS <br />                             ;----------------------------------------- <br />                             ; define 1000 elements array <br />                             ;----------------------------------------- <br />                             Array_base Array_element 1000 dup (&lt;?&gt; ) <br /><br />                             ;---------------------------------------------- <br />                             ;calculate base addres of element N <br />                             ;---------------------------------------------- <br />                             mov esi,offset Array_base <br />                             mov eax,N <br />                             mov ebx,SIZE Array_element <br />                             mul eax,ebx <br />                             add esi,eax <br />                             ;---------------------------------- <br />                             ; start updating element N <br />                             ;---------------------------------- <br />                             mov ,ecx ;dword <br /></div><br /><br />Thanks,<br /><br />Ewayne</div>
    <div class="meta">Posted on 2001-12-29 23:07:48 by Ewayne</div>
   </div>
   <div class="post" id="post-16736">
    <div class="subject"><a href="#post-16736">Accessing structures</a></div>
    <div class="body"><strong>Ewayne</strong>, there are several methods in MASM:<pre><code>mov &#91;esi&#93;.Array_element.field01,ecx</code></pre>...or...<pre><code>ASSUME esi&#58;PTR Array_element<br />mov &#91;esi&#93;.field01,ecx<br />ASSUME esi&#58;NOTHING</code></pre>...or...(of course there is a way with macros :))<pre><code>OPTION&#58;DOTNAME<br />.field01 EQU &lt;&#91;0&#93;&gt; ; okay, I'm not seriously suggesting you use this &#58;&#41;<br />mov &#91;esi&#93;.field01,ecx</code></pre>Or, were you talking about in TASM?<br /><br />p.s. I'd like to say that your code examples have been some of the most helpful to me getting over the windows learning curve.  Thank you.</div>
    <div class="meta">Posted on 2001-12-30 02:07:17 by bitRAKE</div>
   </div>
   <div class="post" id="post-16790">
    <div class="subject"><a href="#post-16790">Accessing structures</a></div>
    <div class="body">To bitRAKE,<br /><br />I'm using MASM.<br /><br /><br />                                   code:<br /><br />                                   mov .Array_element.field01,ecx<br /><br />I don't want to use the structure name in the statments.<br /><br /><br />                                   code:<br /><br />                                   ASSUME esi:PTR Array_element<br />                                   mov .field01,ecx<br />                                   ASSUME esi:NOTHING<br /><br />I know the assume works, but thats an extra step.<br /><br /><br />                                   code:<br /><br />                                   OPTION:DOTNAME<br />                                   .field01 EQU &lt;[0]&gt; ; okay, I'm not seriously suggesting you use this <br />                                   mov .field01,ecx<br /><br />I don't like to use macro's if I don't need to.<br /><br />My problem is that in my current project I have<br />many different structures in many arrays and I<br />would like to be able to load the address of the<br />structure in the array and just do a:<br /><br />mov     , ecx<br /><br />Right know I have a routine that computes the <br />offset into the structure and add that to my<br />structure address.<br /><br />p.s. Thanks for your last comment.<br /><br />Thanks again,<br /><br />Ewayne</div>
    <div class="meta">Posted on 2001-12-30 08:39:03 by Ewayne</div>
   </div>
  </div>
 </body>
</html>