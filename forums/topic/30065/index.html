<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Convert program to a tray icon - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=30065" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=30065">Convert program to a tray icon</a></p>
   <div class="post" id="post-212181">
    <div class="subject"><a href="#post-212181">Convert program to a tray icon</a></div>
    <div class="body">I am trying to convert this to a trayicon.<br />I want it to just detect the USB drive and then run the batch file.<br /><br />I studied the trayicon.asm program but am not sure what to add and subtract.<br /><br />Thanks.<br /><br /><pre><code><br />CTEXT macro Text<br />&nbsp; &nbsp; local szText<br />&nbsp; &nbsp; .data<br />&nbsp; &nbsp; szText byte Text, 0<br />&nbsp; &nbsp; .code<br />&nbsp; &nbsp; exitm &lt;offset szText&gt;&nbsp;  <br />endm<br /><br />DlgProc			 PROTO	:HWND,:UINT,:WPARAM,:LPARAM<br />GetVolumeName&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PROTO	:DWORD<br /><br />DEV_BROADCAST_HDR STRUCT<br />dbch_size&nbsp; &nbsp; &nbsp;  DWORD&nbsp;  ?<br />dbch_devicetype DWORD&nbsp;  ?<br />dbch_reserved&nbsp;  DWORD&nbsp;  ?<br />DEV_BROADCAST_HDR ENDS<br /><br /><br />DEV_BROADCAST_VOLUME STRUCT<br />dbcv_size&nbsp; &nbsp; &nbsp; &nbsp; DWORD&nbsp;  ?<br />dbcv_devicetype&nbsp; DWORD&nbsp;  ?<br />dbcv_reserved&nbsp; &nbsp; DWORD&nbsp;  ?<br />dbcv_unitmask&nbsp; &nbsp; DWORD&nbsp;  ?<br />dbcv_flags&nbsp; &nbsp; &nbsp;  DWORD&nbsp;  ?<br />DEV_BROADCAST_VOLUME ENDS<br /><br />.const<br /><br />IDD_DIALOG	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  equ 1000<br />IDC_INFO&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  equ 101<br /><br />DBT_DEVICEARRIVAL&nbsp; &nbsp; &nbsp; &nbsp; equ 8000h<br />DBT_DEVICEREMOVECOMPLETE equ 8004h<br />DBT_DEVTYP_VOLUME&nbsp; &nbsp; &nbsp; &nbsp; equ 2h<br /><br />.data<br /><br />szDrivePath&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db &quot;%c:\\%s&quot;,0<br />SystemInfo&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  STARTUPINFO &lt;&gt;<br />ProcessInfo&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PROCESS_INFORMATION &lt;&gt; <br />szCommandLine&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db&nbsp;  &quot;C:\bat\F_cruzer.bat&quot;,0<br />&nbsp; <br />.data?<br /><br />hInstance		&nbsp; dd&nbsp;  ?<br />szBuf&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  db&nbsp;  16 dup(?)<br /><br />.code<br /><br />start:<br />	<br />	invoke GetModuleHandle,NULL<br />	mov	 hInstance,eax<br /><br />&nbsp; &nbsp; &nbsp; invoke InitCommonControls<br />&nbsp; &nbsp; &nbsp; invoke DialogBoxParam,hInstance,IDD_DIALOG,NULL,addr DlgProc,NULL<br />&nbsp; &nbsp; &nbsp; invoke ExitProcess,0<br /><br />DlgProc proc hWnd:HWND,uMsg:UINT,wParam:WPARAM,lParam:LPARAM<br />local dbt_h : DEV_BROADCAST_HDR<br />local dbt_v : DEV_BROADCAST_VOLUME<br />	<br />&nbsp; &nbsp; &nbsp; .if uMsg==WM_INITDIALOG<br />	<br />&nbsp; &nbsp; .elseif uMsg == WM_DEVICECHANGE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .if wParam == DBT_DEVICEARRIVAL<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  mov ebx, lParam<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; assume ebx:ptr DEV_BROADCAST_HDR<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .if .dbch_devicetype == DBT_DEVTYP_VOLUME<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke SetDlgItemText,hWnd, IDC_INFO,CTEXT (&quot;USB-Drive found&quot;)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov edx,lParam<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; assume edx:ptr DEV_BROADCAST_VOLUME<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke GetVolumeName,.dbcv_unitmask<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push eax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke wsprintf,offset szBuf,offset szDrivePath,eax,0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke GetDriveType,offset szBuf<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .if eax == DRIVE_REMOVABLE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke Sleep, 1500<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop eax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  invoke SetDlgItemText,hWnd, IDC_INFO,offset szBuf<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; run batch file to copy files to thumbdrive<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  INVOKE CreateProcess,NULL,ADDR szCommandLine, NULL, NULL, FALSE, \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  NORMAL_PRIORITY_CLASS, NULL, NULL, ADDR SystemInfo, ADDR ProcessInfo<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .endif<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; assume edx:nothing<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .endif<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; assume ebx:ptr nothing<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .elseif wParam == DBT_DEVICEREMOVECOMPLETE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke SetDlgItemText,hWnd, IDC_INFO,CTEXT (&quot;USB-Drive Removed&quot;)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .endif<br />	.elseif uMsg==WM_COMMAND<br /><br />	.elseif uMsg==WM_CLOSE<br />	@Exit:<br />		invoke EndDialog,hWnd,0<br />	.else<br />		mov		eax,FALSE<br />		ret<br />	.endif<br />	&nbsp; &nbsp; &nbsp; mov		eax,TRUE<br />	ret<br /><br />DlgProc endp<br /><br />GetVolumeName proc flag:DWORD<br /> push esi<br /> push ecx<br /> mov ecx, 26<br /> mov esi,flag<br /> @@:<br /> test esi,1h<br /> jnz @f<br /> shr esi,1h<br /> dec ecx<br /> test ecx,ecx<br /> jnz @b<br /> @@:<br /> mov eax,5Bh<br /> sub eax,ecx<br /> pop ecx<br /> pop esi<br /> ret<br />GetVolumeName endp<br /><br />end start<br /></code></pre><br /></div>
    <div class="meta">Posted on 2010-07-01 11:45:43 by skywalker</div>
   </div>
   <div class="post" id="post-212260">
    <div class="subject"><a href="#post-212260">Re: Convert program to a tray icon</a></div>
    <div class="body"><strong>skywalker</strong>,<br /><br />Hide your window and use <strong>Shell_NotifyIcon()</strong> to add icon to the tray. It&#039;s a pity that message-only windows don&#039;t receive broadcasts.</div>
    <div class="meta">Posted on 2010-07-11 00:45:52 by baldr</div>
   </div>
  </div>
 </body>
</html>