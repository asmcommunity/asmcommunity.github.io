<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>PE file header info - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=16590" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=16590">PE file header info</a></p>
   <div class="post" id="post-128985">
    <div class="subject"><a href="#post-128985">PE file header info</a></div>
    <div class="body">Is it possible to show the info that is with the file header struct of a pe-file<br />like the example from iczelion's tut 7 to show the info in a dlg box?<br /><br />if so how could it be done <br /><br />Mainly to learn more about pe-files<br />thanks in advance</div>
    <div class="meta">Posted on 2003-12-26 12:44:42 by Tweak</div>
   </div>
   <div class="post" id="post-129009">
    <div class="subject"><a href="#post-129009">PE file header info</a></div>
    <div class="body">Tweak,<br /><br />f0dder recently posted a link to a later version of the PE specifications from Microsoft which had been updated in about 2001. It is in PDF format but its a very useful document to have if you are interested in PE specifications.<br /><br />Regards,<br />http://www.asmcommunity.net/board/cryptmail.php?tauntspiders=in.your.face@nomail.for.you&amp;id=2f46ed9f24413347f14439b64bdc03fd</div>
    <div class="meta">Posted on 2003-12-26 20:02:19 by hutch--</div>
   </div>
   <div class="post" id="post-129011">
    <div class="subject"><a href="#post-129011">thanks hutch :)</a></div>
    <div class="body">But this was more like what I was trying to obtain.<br /><br />Just so I could peek and compare the differences of different pe files on my system.  <br />To see what kind of different info each may contain.   Most of it I copied from because<br />I don't understand SEH that well to write my own SEH.  but the rest I wriitten myself<br /><br />but masm complains about <br /><pre><code><br /><br />mov edi,&#91;edi&#93;.FileHeader<br /><br /></code></pre><br /><br /><br /> error A2022: instruction operands must be the same size<br /><br />plz help me to understand why I get these error</div>
    <div class="meta">Posted on 2003-12-26 21:04:57 by Tweak</div>
   </div>
   <div class="post" id="post-129013">
    <div class="subject"><a href="#post-129013">PE file header info</a></div>
    <div class="body">I got two errors trying to build the file. I have not got the time to debug the cde for you but there are a couple of basic things wrong with it.<br /><pre><code><br />1st error<br />invoke ShowTheStuff, hDlg, edi  ; 2 parameters passed<br />ShowTheStuff proc  hDlg&#58;DWORD   ; proc only has one parameter<br /><br />; 2nd error<br />; Add the &quot;DWORD PTR&quot; to SIZE cast the line.<br />; ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<br />mov edi,DWORD PTR &#91;edi&#93;.FileHeader<br /></code></pre><br />From a quick look at the code, you need to get the length of the structures with SIZEOF or similar and copy the correct number of bytes to a memory buffer.<br /><br />Regards,<br />http://www.asmcommunity.net/board/cryptmail.php?tauntspiders=in.your.face@nomail.for.you&amp;id=2f46ed9f24413347f14439b64bdc03fd</div>
    <div class="meta">Posted on 2003-12-26 22:04:38 by hutch--</div>
   </div>
   <div class="post" id="post-129016">
    <div class="subject"><a href="#post-129016">PE file header info</a></div>
    <div class="body">I think it should be<br /><pre><code><br />movzx edi, &#91;edi&#93;.FileHeader<br /></code></pre><br /><br />But I did not verify...</div>
    <div class="meta">Posted on 2003-12-26 22:31:46 by roticv</div>
   </div>
   <div class="post" id="post-129025">
    <div class="subject"><a href="#post-129025">PE file header info</a></div>
    <div class="body"><pre><code><br />mov edi,&#91;edi&#93;.FileHeader<br /></code></pre><br />- That's a sorta strange thing to do. FileHeader is a structure, not a variable. If you want to do anything at all with that, it would make more sense to make EDI point to this structure - like &quot;lea edi,.FileHeader&quot;. But considering you're testing EDI for 0 right afterwards, I suspect you're not quite sure what you're doing :)</div>
    <div class="meta">Posted on 2003-12-27 01:29:22 by f0dder</div>
   </div>
   <div class="post" id="post-129081">
    <div class="subject"><a href="#post-129081">PE file header info</a></div>
    <div class="body">I tested it for zero thinking that it might contain no info if I got to the wrong place during execution.<br /><br /><br />I think I fix the problems ya'll pointed out.  But I think there is something wrong with my includes file or masm itself<br /><br /><pre><code><br />error LNK2001&#58; unresolved external symbol _wsprintfA<br />fatal error LNK1120&#58; 1 unresolved externals<br /></code></pre><br /><br />Which gave me the idea that it's has to either masm's or the linker masm v8; linker v5.12.8078<br />even if I included<br /><pre><code><br />wsprintfA PROTO C &#58;DWORD,&#58;DWORD,&#58;VARARG<br />wsprintf equ &lt;wsprintfA&gt;<br /><br />or<br /><br />wsprintfA PROTO C &#58;DWORD,&#58;VARARG<br />wsprintf equ &lt;wsprintfA&gt;<br /></code></pre>  at the beginning of the file after the SEH struct<br />it would then give me  an error A2111: conflicting parameter definition<br /><br />Which why I think it's a linker problem I tried re-compiling a simple app I did awhile back that uses wsprintf and it compiled with no problem but now it gives me the same error msg A2111: conflicting parameter definition as above<br /><pre><code><br />;Feb. 24, 2003<br />;project&#58; asmtut2<br />;author&#58; Tweak aka Patrick Pippen<br /><br />.386<br />.model flat, stdcall<br />option casemap&#58;none<br /><br />include \masm32\include\windows.inc<br />include \masm32\include\masm32.inc<br />include \masm32\include\gdi32.inc<br />include \masm32\include\user32.inc<br />include \masm32\include\kernel32.inc<br /><br /><br />includelib \masm32\lib\masm32.lib<br />includelib \masm32\lib\gdi32.lib<br />includelib \masm32\lib\user32.lib<br />includelib \masm32\lib\kernel32.lib<br /><br />wsprintfA PROTO C &#58;DWORD,&#58;VARARG<br />wsprintf equ &lt;wsprintfA&gt;<br /><br />.data<br />bufferforstring db 10 dup&#40;0&#41;<br />titlestring db &quot;Result of calculation&#58;&quot;,0<br />szformat db &quot;%u&quot;,0<br />.data?<br /><br />.code<br /><br />start&#58;<br />mov eax,5 ;# to multiply with # in ecx<br />mov ecx,3 ; this is the multiplier<br />mul ecx ;<br />add eax,50<br />xor edx,edx  ;set edx to 0<br />div ecx<br />invoke wsprintf,ADDR bufferforstring,ADDR szformat,eax<br />invoke MessageBox,0,ADDR bufferforstring,ADDR titlestring,MB_OK<br />invoke ExitProcess,0<br />end start        <br /></code></pre><br />the above was the simple app I tried which gave the same error msg.   Could some explain why this strangeness from now coming from the linker</div>
    <div class="meta">Posted on 2003-12-27 13:32:22 by Tweak</div>
   </div>
   <div class="post" id="post-129219">
    <div class="subject"><a href="#post-129219">PE file header info</a></div>
    <div class="body">i copy pasted this wsprintf routine you posted and assembled it <br />it assembles without any problem nd displays a message box with 21 in it<br /><br />5*3+50 = 65 /3 = 21 2/3  so its ok whats the problem <br /><br />btw i tried assembling your earlier peinfo post also by deleting one param at line 157 and making it lea edi,.fileheader it assembles well without any problem in wsprintf<br /><br />========================<br /><br />edit<br />===========================<br />what do you mean by this<br />.if lParam==0  &lt;----- this is supposed to be the handle of control is it going to work<br />did you mean if handle is not 0 ?????????<br />mov eax,wParam<br /><br />and you are assuming there can be only one click in open button if it not clicked you asumme it is exit button and jump directly to wm_close you are not checking for exit <br /><br />invoke ShowExportFunctions,hDlg<br />.else	; IDM_EXIT<br />invoke SendMessage,hDlg,WM_CLOSE,0,0<br /><br />will aseemble like this<br />00401061  |.  8B45 10       MOV EAX,<br />00401064  |.  66:83F8 66    CMP AX,66<br />00401068  |.  75 0A         JNZ SHORT 00401074                       ;  pe-info.00401074<br /><br /><br />it will exit even before it shows your dialog when as system itself may send wm_command during setting of focus etc ( dunno i ve faced the problem)<br /><br />what is this <br />invoke SetDlgItemText,hDlg,IDC_EDIT,0<br />u are setinng null text ??? lpString is 0 ?????<br /><br />after setdlg u are using wsprintf what is the use of it<br />it will vanish into thin air when you return from wsprintf<br /><br /><br />and the result of your exe when you have corrected all the above queries<br /><br />0012FA80  ..======[ PE_Header ]======..Machine: 1..Number of Sections: 640<br />0012FAC0  32..Time Date Stamp: 1179648..Pointer to Symbol Table: 0..Number<br />0012FB00  of Symbols: 16843009..Sizeof Optional Header: 1243924..Character<br />0012FB40  istics: 2012971227..C:\masm32\BIN\glit\scrshfun.exe.</div>
    <div class="meta">Posted on 2003-12-29 02:41:43 by bluffer</div>
   </div>
   <div class="post" id="post-129547">
    <div class="subject"><a href="#post-129547">PE file header info</a></div>
    <div class="body"><div class="quote"><br /><br />it will exit even before it shows your dialog when as system itself may send wm_command during setting of focus etc ( dunno i ve faced the problem)<br /><br />what is this <br />invoke SetDlgItemText,hDlg,IDC_EDIT,0<br />u are setinng null text ??? lpString is 0 ?????<br /><br />after setdlg u are using wsprintf what is the use of it<br />it will vanish into thin air when you return from wsprintf<br /><br /><br />and the result of your exe when you have corrected all the above queries<br /><br />0012FA80  ..======[ PE_Header ]======..Machine: 1..Number of Sections: 640<br />0012FAC0  32..Time Date Stamp: 1179648..Pointer to Symbol Table: 0..Number<br />0012FB00  of Symbols: 16843009..Sizeof Optional Header: 1243924..Character<br />0012FB40  istics: 2012971227..C:\masm32\BIN\glit\scrshfun.exe. </div><br /><br />I see what your talking about now.  I thought that was the way to use SetDlgItem<br />could someone plz explain what type a parameters it should be passed to it.</div>
    <div class="meta">Posted on 2004-01-01 16:14:01 by Tweak</div>
   </div>
   <div class="post" id="post-129551">
    <div class="subject"><a href="#post-129551">PE file header info</a></div>
    <div class="body">Hi tweak<br /><br /><pre><code>invoke SetDlgItemText,hDlg,IDC_EDIT,0</code></pre><br /><br />In the case of SetDlgItemText it expects a pointer to a null terminated string to be passed in the 3rd parameter. So it is used like this :<br /><br /><pre><code>.data<br />string db &quot;this is a string&quot;,0<br />.code<br />invoke SetDlgItemText,&#91;hDlg&#93;,IDC_EDIT,OFFSET string</code></pre><br /><br />If you wish to display a number, you use SetDlgItemInt, and pass a DWORD in the 3rd parameter, you must also specify whether it should be displayed as signed or not in the 4th parameter (TRUE = signed). The API will convert it to text and display it properly in your control.<br /><br /><pre><code>.data<br />dwNumber DD 123<br />.code<br />invoke SetDlgItemInt,&#91;hDlg&#93;,IDC_EDIT,&#91;dwNumber&#93;,TRUE</code></pre></div>
    <div class="meta">Posted on 2004-01-01 17:56:56 by donkey</div>
   </div>
   <div class="post" id="post-129593">
    <div class="subject"><a href="#post-129593">PE file header info</a></div>
    <div class="body">well in you case you can use the setdlg after wsprintf and pass the address of temp to it for your lpString<br /><br />but your wsprintf will not give you correct details <br />as the params you are passing to wsprintf are having words as well as dwords <br />so the stack will be corrupted and it will diplay all wrong details<br /><br />study the dump i pasted it shows the the no of sections as 64032<br /><br />OR WATCH IT IN A DEBUGGER AS IT IS THERE WILL BE SOME ANONYMOUS PUSH 0<br />BEFORE AND AFTER ONE OF YOUR WORD PARAMS ARE PUSHED LIKE IFH.MACHINE ETC <br /><br />well some code <br />invoke GetMod<br />mov hinstance,eax<br />mov  some reg,eax<br />add somereg,el?? &lt;--- dos header+3c<br />add eax,&lt;--- peheader or 45ad so eax will probably be 40000c0 or c8<br />xor ecx,ecx<br />mov cx,word ptr  &lt;--- machine<br />push ecx<br />mov cx,wptr &lt;--no of sections<br />push ecx<br />mov ecx,&lt;--- tdstamp<br />push ecx<br />***,<br />***,<br />movzx ecx word ptr &lt;--size of optional header (see the movzx or you need to 0 out the ecx before you push the word)<br />***<br />***<br />invoke wsprintfa,addr peheader,addr temp<br />invoke setdlg,***** temp<br />invoke msgbox,*,temp,*,*<br />invoke endprocess,0<br /><br /><br />i got this code some where will attach it when i get to  that comp which has it<br /><br />till then ;)</div>
    <div class="meta">Posted on 2004-01-02 05:17:16 by bluffer</div>
   </div>
   <div class="post" id="post-129722">
    <div class="subject"><a href="#post-129722">PE file header info</a></div>
    <div class="body">i told that i ll paste the code that did it<br /><br />here it is<br /><br />ive also attached the whole package try it out and have fun<br /><br />.486<br />    .model flat, stdcall<br />    option casemap :none   ; case sensitive<br /><br />    include \masm32\include\windows.inc<br />    include \masm32\include\user32.inc<br />    include \masm32\include\kernel32.inc<br />    include \masm32\include\gdi32.inc<br /><br />    includelib \masm32\lib\user32.lib<br />    includelib \masm32\lib\kernel32.lib<br />    includelib \masm32\lib\gdi32.lib<br /><br />    useless PROTO <br /><br />    .data <br />    PeTable db 0Dh,0Ah, &quot;======[ PE_Header ]======&quot;<br />            db 0Dh,0Ah, &quot;Machine: %lu&quot;<br />            db 0Dh,0Ah,&quot;Number of Sections: %lu&quot;<br />            db 0Dh,0Ah,&quot;Time Date Stamp: %lu&quot;<br />            db 0Dh,0Ah,&quot;Pointer to Symbol Table: %lu&quot;<br />            db 0Dh,0Ah,&quot;Numberof Symbols: %lu&quot;<br />            db 0Dh,0Ah,&quot;Sizeof Optional Header: %lu&quot;<br />            db 0Dh,0Ah,&quot;Characteristics: %lu&quot;,0Dh,0Ah,0<br /><br />    <br />    <br />    .code<br /><br />start:<br />    <br /><br /><br />    invoke GetModuleHandle,NULL<br />    invoke useless<br />    invoke ExitProcess,0<br /><br /><br />useless proc<br />    LOCAL temp[512]:byte<br />    LOCAL ifh:IMAGE_FILE_HEADER<br /><br />    mov ebx,eax<br />    add ebx,03ch<br />    add eax,<br />    xor ecx,ecx<br />    mov cx,word ptr ds:<br />    mov ifh.Characteristics,cx<br />    push ecx<br />    mov cx,word ptr ds:<br />    mov ifh.SizeOfOptionalHeader,cx<br />    push ecx<br />    mov ecx,dword ptr ds:<br />    mov ifh.NumberOfSymbols,ecx<br />    push ecx<br />    mov ecx,dword ptr ds:<br />    mov ifh.PointerToSymbolTable,ecx<br />    push ecx<br />    mov ecx,dword ptr ds:<br />    mov ifh.TimeDateStamp,ecx<br />    push ecx<br />    movzx ecx,word ptr ds:<br />    mov ifh.NumberOfSections,cx<br />    push ecx<br />    movzx ecx,word ptr ds:<br />    mov ifh.Machine ,cx<br />    push ecx<br />    invoke wsprintf,ADDR temp,ADDR PeTable<br />    invoke MessageBoxA,NULL,ADDR temp,NULL,NULL<br />    ret<br /><br />useless endp</div>
    <div class="meta">Posted on 2004-01-04 06:00:01 by bluffer</div>
   </div>
  </div>
 </body>
</html>