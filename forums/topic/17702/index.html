<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>FPULIB Update - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=17702" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=17702">FPULIB Update</a></p>
   <div class="post" id="post-136747">
    <div class="subject"><a href="#post-136747">FPULIB Update</a></div>
    <div class="body">The original FPULIB (library of floating point math functions) was primarily designed for the beginners in assembly programming who had some need for such math functions but did not yet have the opportunity lo learn how to use the FPU and its instructions.<br /><br />Some feedback proved that a little knowledge can be dangerous. Some users were loading too many FPU registers themselves; called functions then resulted in failure because an insufficient number of free registers were remaining to accomplish the task.<br /><br />A modification was issued earlier this year to blindly free any register(s) required by the function, regardless of whether it contained valid data or not. This would have no effect on the beginner using strictly the lib functions. However, it would prevent &quot;FPU stack overflow&quot; errors due to inadvertant use of the FPU registers by &quot;intermediate&quot; programmers. The drawback for that latter group was that valid data on the FPU could be trashed.<br /><br />Lately, it also became evident that some assembler HLL instructions would blindly trash FPU registers to perform their task. Although such action seems to be generally accepted as &quot;fair game&quot;, an alternate version of the FPULIB has thus been prepared to avoid such blind trashing. Again, this modified version would have no effect on the beginner using strictly the lib functions. The only drawback is the added overhead to save the FPU registers and restore them.<br /><br />This version may be an advantage for intermediate users who may want to use some of the library functions without any fear of loosing valuable data in FPU registers, and without any need of preserving such data themselves.<br /><br />The only restriction of this modified version is that the ST7 register must be free whenever the FPU is not the source for any parameter AND the result must be returned on the FPU. If that ST7 register is NOT free under those conditions, it would NOT be trashed but the function would fail.<br /><br />This latest version also has one function more liberalized and one additional function. The FpuAtoFL function will now disregard all leading 0's and decimal trailing 0's in the count of numerical digits which is limited to 18. A string such as the following would now be converted without generating an error:<br /><br />&quot;000000.000000000000000000012345678900000000000&quot;,0<br /><br />But a string such as the following would still fail, having more than 18 numerical characters starting at the first non-zero digit and up to the last non-zero digit:<br /><br />10.00000000000000001000<br /><br />The new function is FpuState. It is primarily designed for the more advanced users during program development to retrieve the content of the FPU at any time (such as after some exception or error is detected at run time). The generated string is formatted as it would appear in the accompanying .gif image when displayed in a message box. Such strings could also be accumulated in an &quot;error&quot; file and reviewed later.<br /><br />The attached fpulib20.zip file contains all necessary files, including all source code. The bulk of the .zip file is the HELP file which has also been updated to reflect the modifications. <br /><br />Raymond</div>
    <div class="meta">Posted on 2004-03-22 23:04:22 by Raymond</div>
   </div>
   <div class="post" id="post-136748">
    <div class="subject"><a href="#post-136748">FPULIB Update</a></div>
    <div class="body">Can't seem to be able to attach more than one file per post.<br /><br />Here's the .gif file.<br /><br />Raymond</div>
    <div class="meta">Posted on 2004-03-22 23:05:57 by Raymond</div>
   </div>
   <div class="post" id="post-136749">
    <div class="subject"><a href="#post-136749">FPULIB Update</a></div>
    <div class="body">And my apologies to the person who downloaded the fpulib20 file first posted. The post has been edited with the proper file. Please scrap that first one and get the proper one. Most included files should now be dated 23/03/2004.<br /><br />Raymond</div>
    <div class="meta">Posted on 2004-03-22 23:51:44 by Raymond</div>
   </div>
   <div class="post" id="post-136750">
    <div class="subject"><a href="#post-136750">FPULIB Update</a></div>
    <div class="body">Hello Raymond!<br />Since my last experience, I think that your last modification of the FpuLib is an important improvement, specially for programmers that use the FPU without  care.  :grin: <br /><br />Regards,<br /><br />Biterider</div>
    <div class="meta">Posted on 2004-03-23 00:36:16 by Biterider</div>
   </div>
   <div class="post" id="post-137127">
    <div class="subject"><a href="#post-137127">FPULIB Update</a></div>
    <div class="body">Hi Raymond!<br />first id like to thank you for the lib, its great!<br />but im having some trouble with the FpuFLtoA function. not shure if its my code or if its the func, but since the error returned points into the code of the lib i figured i should post it here. heres my code:<br /><pre><code><br />.data<br />...<br /><br />tmpdb		dd 400 dup&#40;?&#41;<br /><br />freq	label qword	; are set through other func.<br />freqL	dd ?<br />freqH	dd ?<br /><br />;FPUtmp	dt ?<br /><br />...<br /><br />.code<br />...<br /><br />finit<br />fild qword ptr&#91;esp&#93;	; st&#40;0&#41;=top qword on stack=cycler<br />fild freq		; st&#40;0&#41;=freq=f, st&#40;1&#41;=cycler<br />fdivp st&#40;1&#41;,st&#40;0&#41;	; st&#40;0&#41;=time &#40;i know it could be reaplced with fdiv but<br />			; this makes it more readeble =&#41;<br />add esp,8		; fix stack.<br />; fstp FPUtmp		; used this with the old v. of FpuLib <br /><br />invoke FpuState,addr tmpdb	; see attached image for result.<br />invoke MessageBox,hWnd,addr tmpdb,NULL,MB_OK<br /><br />invoke FpuFLtoA,0,9,addr tmpdb,SRC1_FPU or SRC2_DMEM	; this is where the err occurs.<br />...<br /></code></pre> <br />and heres the errlog (sorry bout the swedish):<br /><pre><code><br />        Prg&#58;  &#40;pid=1292&#41;<br />        Tidpunkt&#58; 2004-03-27 kl 11&#58;13&#58;31.919<br />        Undantagsnummer&#58; c0000005 &#40;Access Violation&#41;<br /><br />*----&gt; Systeminformation &lt;----*<br />        Datornamn&#58; *<br />        Anv?ndarnamn&#58; *<br />        Antal processorer&#58; 1<br />        Processortyp&#58; x86 Family 6 Model 8 Stepping 10<br />        Windows 2000-version&#58; 5.0<br />        Aktuell build&#58; 2195<br />        Service Pack&#58; 4<br />        Aktuell typ&#58; Uniprocessor Free<br />        Registrerad organisation&#58; *<br />        Registrerad ?gare&#58; *<br /><br />*----&gt; Active program &lt;----*<br />...<br />1292 PhySC.exe<br />...<br /><br />&#40;00400000 - 00407000&#41; <br />&#40;77F80000 - 77FFC000&#41; <br />&#40;79880000 - 79936000&#41; <br />&#40;77E10000 - 77E6F000&#41; <br />&#40;77F40000 - 77F79000&#41; <br />&#40;77590000 - 777DA000&#41; <br />&#40;794B0000 - 79512000&#41; <br />&#40;77130000 - 7719E000&#41; <br />&#40;70A70000 - 70AD5000&#41; <br />&#40;78000000 - 78045000&#41; <br />&#40;71710000 - 71794000&#41; <br />&#40;76B20000 - 76B5E000&#41; <br />&#40;65720000 - 65729000&#41; <br />&#40;77560000 - 77590000&#41; <br /><br />Statusdumping f?r tr?d-ID 3b4<br /><br />eax=00000009 ebx=00000000 ecx=00000000 edx=00000000 esi=00401148 edi=00000111<br />eip=00401d9d esp=0012fba0 ebp=0012fc48 iopl=0         nv up ei pl nz na po nc<br />cs=001b  ss=0023  ds=0023  es=0023  fs=0038  gs=0000             efl=00000206<br /><br /><br />funktion&#58; &lt;nosymbols&gt;<br />        00401d81 dec1             faddp   st&#40;1&#41;,st<br />        00401d83 d9fd             fscale<br />        00401d85 ddd9             fstp    st&#40;1&#41;<br />        00401d87 c3               ret<br />        00401d88 55               push    ebp<br />        00401d89 8bec             mov     ebp,esp<br />        00401d8b 81c458ffffff     add     esp,0xffffff58<br />        00401d91 8b450c           mov     eax,&#91;ebp+0xc&#93;          ss&#58;00c89b2e=????????<br />        00401d94 f7451400040000  test dword ptr &#91;ebp+0x14&#93;,0x400 ss&#58;00c89b2e=????????<br />        00401d9b 7402             jz      0040a89f<br />FEL -&gt;00401d9d 8b00             mov     eax,&#91;eax&#93;              ds&#58;00000009=????????<br />        00401d9f 50               push    eax<br />        00401da0 0fb6c0           movzx   eax,al<br />        00401da3 83f80f           cmp     eax,0xf<br />        00401da6 7605             jbe     0040d5ad<br />        00401da8 b80f000000       mov     eax,0xf<br />        00401dad 8945f0           mov     &#91;ebp+0xf0&#93;,eax         ss&#58;00c89b2e=????????<br />        00401db0 58               pop     eax<br />        00401db1 0fb6c4           movzx   eax,ah<br />        00401db4 83f811           cmp     eax,0x11<br />        00401db7 7605             jbe     0040d5be<br />        00401db9 b811000000       mov     eax,0x11<br />...<br /></code></pre></div>
    <div class="meta">Posted on 2004-03-27 05:28:30 by sluggo</div>
   </div>
   <div class="post" id="post-137151">
    <div class="subject"><a href="#post-137151">FPULIB Update</a></div>
    <div class="body">sluggo<br /><br />This is the instruction you used (highlighting the flag you used for SRC2 having a value of 9):<pre><code>invoke FpuFLtoA,0,9,addr tmpdb,SRC1_FPU or &#91;b&#93;SRC2_DMEM&#91;/b&#93;	; this is where the err occurs.<br /></code></pre>And, from the Help file, here's the description of the flags you can use for that parameter:<div class="quote">SRC2_DMEM   Src2 is a pointer to a 32-bit unsigned integer<br />SRC2_DIMM   Src2 is a 32-bit unsigned integer</div> By specifying the SRC2 as a pointer to a memory location, you were then trying to access data at address DS:0009.<br /><br />Use the DIMM flag.<br /><br />Raymond</div>
    <div class="meta">Posted on 2004-03-27 12:03:38 by Raymond</div>
   </div>
   <div class="post" id="post-137156">
    <div class="subject"><a href="#post-137156">FPULIB Update</a></div>
    <div class="body">sorry, missunterstood it :o. thank you again.</div>
    <div class="meta">Posted on 2004-03-27 13:21:56 by sluggo</div>
   </div>
  </div>
 </body>
</html>