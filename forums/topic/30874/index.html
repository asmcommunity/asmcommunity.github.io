<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>jexp() my exponential function - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=30874" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=30874">jexp() my exponential function</a></p>
   <div class="post" id="post-215957">
    <div class="subject"><a href="#post-215957">jexp() my exponential function</a></div>
    <div class="body">Hi,<br />here my method for the exponentianal function e^x .<br />it is a mix of 2 fundamentals:<br />- Taylor series running at a 10 steps for decimals -1.0 &lt; x &lt; +1.0<br />- a couple of basic rules of the logarithms.<br /><br />Explanation.<br />say we want to calculate e^20.3. well,<br /><pre><code> 20.3 float double is 40344CCCCCCCCCCDh hexadecimal</code></pre><br />we convert it to base2 by multiplying it by lg2(e)<br /><pre><code>20.3 x 1.4426950408889632824453128103079f<br />result 20.3 base2 403D4965C85C0166h<br /></code></pre><br />it is needed to know later how much we should shift left<br />our partial result in its integer part.<br />now, for the fundamental of powers we know that<br /><pre><code>&nbsp; n^20.3 can be rewritten as n^20 * n^0.3</code></pre><br />also we round down 20.3 base2 to get<br /><pre><code> 20.0 and 0.3 float double remainder<br />&nbsp; 20.0 = 403D000000000000h<br />&nbsp; 0.3&nbsp; = 3FD2597217005980h<br /></code></pre><br />we store the remainder 0.3 now for later use.<br /><br />then we convert the integral part 20.0 base2 to an integer value,<br /><br />&nbsp; 20.0 float double -&gt; integer, s<br />&nbsp; after conversion<br />&nbsp; s = 1Dh&nbsp; 29 decimal<br /><br />we shift 1 by s times on the left<br /><br /> <pre><code>&nbsp; i = 1 &lt;&lt; s<br />&nbsp;  thus, i = 1 * 2^29&nbsp; = 20000000h ( 536&#039;870&#039;912 decimal)<br /></code></pre><br /> 3 additional checks are needed here. to avoid<br /> overflow after 63 shifts; in the case s &gt; 63 and<br /> checking wether s push i out of the float double capacity.<br /><br />we reconvert i to float for later use<br /><pre><code> 20000000h integer = 41C0000000000000h float double<br /></code></pre><br />we convert the float decimals we stored above in base2<br /> to float decimals in baseE. this is because we want to use<br /> Taylor series from the e^n. i choosed 10 steps max, and having<br /> -1.0 &lt; decimals &lt; +1.0 works enough good.<br /> NOTE: you can extend the range of action of the<br /> Taylor series up to +-8, stepping it ~20 or more times.<br /><br /> recall Taylor now on e^x :<br /> <pre><code>&nbsp; e^x = 1 + x + x^2 / 2! + x^3 / 3! ....&nbsp; + x^n / n!<br /></code></pre><br /> now, according fundamentals of logarithms<br /><pre><code>&nbsp; a) if e^x = 2^q<br />&nbsp; b) and generally, lgBASE(x)^n = n * lgBASE(x)<br />&nbsp; &nbsp;  then we can extend a) this way,<br />&nbsp; &nbsp; &nbsp; x * ln(e) = q * ln(2)<br />&nbsp; c) and thus x = q * ln(2) should verify the a) as true identity.<br />&nbsp; now, because ln(2) = lg10(2) / lg10(e)<br />&nbsp; &nbsp; lg10(2) = 0.30102999566398119521373889472449f<br />&nbsp; &nbsp; lg10(e) = 0.43429448190325179004808384911378f<br />&nbsp; &nbsp; ln(2)&nbsp;  = 0.69314718055994536943283387715543f<br />&nbsp; we apply c)<br />&nbsp; &nbsp; x =&nbsp; q * ln(2)&nbsp; where q = r our remainder<br />&nbsp; &nbsp; x = 0.3 base2 * 0.69314718055994536943283387715543f<br />&nbsp; &nbsp; x = 3FC9700ADD042628 baseE<br /></code></pre><br />&nbsp; we give this x to the Taylor expansion routine.<br />&nbsp; to get back<br /><pre><code>&nbsp; 3FF3848660139D52 as result of exp() on the remainder 0.3<br /></code></pre><br />&nbsp; finally for the fundamental of powers above<br />&nbsp; we multiply<br /><pre><code> 41C0000000000000h * 3FF3848660139D52h<br />&nbsp; &nbsp; n^20 base2&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; n^0.3 base2&nbsp; &nbsp;  = n^20.3 base2<br />&nbsp; to get back<br />&nbsp; 41C3848660139D52h that corresponds exactly<br />&nbsp; to our decimal 654904512.1532385<br /></code></pre><br />The resulting assmbly code can be found on my website at<br /><br />http://sites.google.com/site/x64lab/home/reloaded-algorithms/my-exp-function-jexp<br /><br />it is ~40 lines of code (my Taylors&#039;s exp() code + main routine)<br />it accepts only +numbers for now, and makes no exaustive check<br />on the floats. for those and negative values i leave it to the<br />reader&#039;s creativity ( being e^-x essentially 1 / e^x ).<br />this is the fastest method i know, it should time ~80 cycles totally,<br />i didnt check it yet. it&#039;s not so important.<br /><br />of some relevance to me was<br /><br />1) avoid the Intel Approx Math library license<br />2) avoid things like the cmath library<br />3) avoid the 2 FPU slow instructions<br />&nbsp; &nbsp; FYL2X to compute y * log2(x)<br />&nbsp; &nbsp; F2XM1 to compute 2^x - 1<br />&nbsp; because 250/300 cycles for 2 instro<br />&nbsp; it&#039;s the insanity, 100%, pure especially<br />&nbsp; on tests i am doing from huge RND-data outputs.<br /><br />4) using Taylor series the right way,<br />&nbsp;  because we would need lot of steps to get<br />&nbsp;  the right values on plugging in large x, as in the example e^20.3<br /><br />&nbsp;  but the true-truth is that i am not yet ready<br />&nbsp;  for Chebyshev; simply because i need some time<br />&nbsp;  to understand something more of his genial calculus.<br />&nbsp;  if you have simplified references about him,<br />&nbsp;  please share it.<br /><br />and not much time to write a full assembly<br />math library. if someone is interested to contribute<br />the library is open source, under MPL license, but assembly<br />required, please. the library lies under the name <strong>&quot;amrt&quot;</strong>,<br />in the same way as my other one, <strong>&quot;art&quot;</strong><br /><em>a-ssembly-run-t-ime</em>. i will write/update it from time to time<br />only on my needs. <br /><br />Cheers,<br /></div>
    <div class="meta">Posted on 2012-04-14 21:42:04 by hopcode</div>
   </div>
  </div>
 </body>
</html>