<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>problems with TSS - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=21196" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=34">OS Development</a> &raquo; <a href="../?id=21196">problems with TSS</a></p>
   <div class="post" id="post-160448">
    <div class="subject"><a href="#post-160448">problems with TSS</a></div>
    <div class="body">Hi people.<br /><br /><br />Here Im stuck again :), I normally are a person that dont ask, then you will perdon me if I dont know how to ask questions :) or paste to much code like anterior one post :), but I try to go to the poin.<br /><br />I have no time this days for rewrite the programm and see if it change something or I repeat the same error.<br /><br />this is the error I obtain from bochs...<br /><br /><pre><code><br />00000652162p &gt;&gt;PANIC&lt;&lt; fetch_raw_descriptor: LDTR.valid=0<br />00000652162i Last time is 1117073601<br />00000652162i protected mode<br />00000652162i CS.d_b = 16 bit<br />00000652162i SS.d_b = 16 bit<br />00000652162i | EAX=00000020&nbsp; EBX=00000030&nbsp; ECX=00150003&nbsp; EDX=00000d0c<br />00000652162i | ESP=0000f7ce&nbsp; EBP=00000000&nbsp; ESI=00000002&nbsp; EDI=000000ac<br />00000652162i | IOPL=0 NV UP DI PL NZ NA PO NC<br />00000652162i | SEG selector&nbsp; &nbsp;  base&nbsp; &nbsp; limit G D<br />00000652162i | SEG sltr(index|ti|rpl)&nbsp; &nbsp;  base&nbsp; &nbsp; limit G D<br />00000652162i |&nbsp; DS:0010( 0002| 0|&nbsp; 0) 00010000 0000ffff 0 0<br />00000652162i |&nbsp; ES:0010( 0002| 0|&nbsp; 0) 00010000 0000ffff 0 0<br />00000652162i |&nbsp; FS:0020( 0004| 0|&nbsp; 0) 000b8000 0000ffff 0 0<br />00000652162i |&nbsp; GS:0020( 0004| 0|&nbsp; 0) 000b8000 0000ffff 0 0<br />00000652162i |&nbsp; SS:0018( 0003| 0|&nbsp; 0) 00010000 0000ffff 0 0<br />00000652162i |&nbsp; CS:0008( 0001| 0|&nbsp; 0) 00010000 0000ffff 0 0<br />00000652162i | EIP=00000fe2 (00000fe0)<br />00000652162i | CR0=0x60000011 CR1=0x00000000 CR2=0x00000000<br />00000652162i | CR3=0x00000000 CR4=0x00000000<br />00000652162i[&nbsp; &nbsp;  ] restoring default signal behavior<br />00000652162i quit_sim called with exit code 1<br /></code></pre><br /><br /><br />From this value &quot;EIP=00000fe2 (00000fe0)&quot; I have taked fe0 = 4064 I hae a macro for print the &quot;offset&quot; about a line and here is that line: [4064] JMP FAR <br /><br />The scheduler look like this:<br /><pre><code><br />scheduler:<br />; ret ; uncomment this for &quot;manual test&quot;<br />	mov si, <br />	inc si<br />	cmp si, MAX_TASK<br />	jb .cont<br />		xor si, si<br />	.cont<br />	mov , si<br />	shl si, 1<br />	mov bx, <br />	OFFSETHERE JMP FAR  ; THIS IS THE MACRO FOR PRINT THE OFFSET<br />	jmp far <br />ret<br /></code></pre><br /><br />Things that are related to the task...<br /><br /><pre><code><br />gdt_label: times ((5+MAX_TASK)*DESCR_SEG_size) db 0<br />gdtr_label: times DESCR_GDTR_size db 0<br /><br />taskList: times MAX_TASK*DESCR_TSS_size db 0<br />total_task dw MAX_TASK<br />cur_task dw 0<br />task_sel times MAX_TASK dw 0<br /><br /><br />%define STACK_SIZE 1024<br />task_stack times STACK_SIZE db 0<br /></code></pre><br /><br /><br />How I setup pmode....<br /><br /><pre><code><br />setup_pmode:<br />&nbsp; &nbsp; ; /* disable interrupts so that IRQs don&#39;t cause exceptions */<br />	cli<br />	; /* disable NMIs as well */<br />	in al, 0x70<br />	or al, 0x80<br />	out 0x70, al<br /><br />	call setup_GDT<br />	call setup_IDT<br /><br />	; /* save IRQ masks */<br />	; old_IRQ_mask[0] = inportb (PORT_8259M+1);<br />	in al, PORT_8259M+1<br />	mov , al<br />	; old_IRQ_mask[1] = inportb (PORT_8259S+1);<br />	in al, PORT_8259S+1<br />	mov , al<br /><br />	; /* setup PIC */<br />	; setup_PIC (0x20, 0x28);<br />	invk setup_PIC, byte 0x20, byte 0x28<br />	; /* set new IRQ masks */<br />	; outportb (PORT_8259M+1, 0xFC);&nbsp; &nbsp; &nbsp;  /* enable timer and keyboard (master) */<br />	mov al, 0xfc<br />	out PORT_8259M+1, al<br />	; outportb (PORT_8259S+1, 0xFF);&nbsp; &nbsp; &nbsp;  /* disable all (slave) */<br />	mov al, 0xff<br />	out PORT_8259S+1, al<br /><br />	; /* saving real mode segment addresses */<br />	mov ax, cx<br />	mov , ax<br />	mov ax, ds<br />	mov , ax<br />	mov ax, ss<br />	mov , ax<br />;	mov ax, sp<br />;	mov , ax<br />	; /* WOW!!! This switches us to PMode just setting up CR0.PM bit to 1 */<br />	invk read_cr0 ; ; return dx:ax<br />	or ax, 1<br />	invk write_cr0, eax<br /><br />	; /* loading segment registers with PMode selectors */<br />	invk update_cs, 0x8<br />	mov ax, 0x10<br />	mov ds, ax<br />	mov es, ax<br />	mov ax, 0x18<br />	mov ss, ax ; I was having problems here... because at startup I put 0x9000 in SS in real mode...<br /><br />	; /* if we don&#39;t load fs and gs with valid selectors, task switching may fail. */<br />	invk load_fs, 0x10<br />	invk load_gs, 0x10<br /><br />	; /* due to the same reason, let&#39;s clear ldtr */<br />	invk load_ldt, gdt_label<br /><br />mov di, 80*1<br />mov si, pm_OK<br />invk write_msg<br /><br />	xor cx, cx<br />	mov bx, taskList<br />	xor edx, edx<br />	mov dx, task_stack<br />	.again:<br />		mov eax, 0<br />		mov , ax<br />		mov word, DESCR_TSS_size<br /><br />		or cx, cx<br />		jz .check<br />			mov , eax<br />			mov , eax<br />			mov , eax<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov eax, ds<br />			mov , eax<br />			mov , eax<br />			mov , eax<br /><br />			mov eax, cs<br />			mov , eax<br /><br />			mov dword, 0x202<br />			mov , edx<br />			add edx, STACK_SIZE<br />		.check<br />		add bx, DESCR_TSS_size<br />		inc cx<br />		cmp cx, 3<br />		jb .again<br />	mov dword, task1<br />	mov dword, task2<br /><br />	; /* load the TR register */<br />	OFFSETHERE MOV AX <br />	mov ax, <br />	invk load_ltr, ax<br />	sti<br />ret<br /></code></pre><br /><br />The task and the &quot;start&quot;<br /><br /><pre><code><br />task1:<br />	.again<br />		mov al, <br />		mov , al<br />		mov di, 80 * 8<br />		mov si, mt1<br />		invk write_msg<br />		jmp .again<br />ret<br />task2:<br />	.again<br />		mov al, <br />		mov , al<br />		mov di, 80 * 9<br />		mov si, mt2<br />		invk write_msg<br />		jmp .again<br />ret<br /><br /><br />start2:<br />....<br /><br />	call setup_pmode<br /><br />; db 0xea, 0,0, 0x28, 0 ; jump_protected: JUMP to busy 386 TSS unsupported.<br />; jmp 0x30:0 ; it is called ok :)<br />; jmp 0x38:0 ; called ok.<br /><br />	.again<br />		mov al, <br />		mov , al<br />		mov di, 80 * 6<br />		mov si, mt0<br />		push ax<br />		invk write_msg<br />		pop ax<br />		cmp al, 0x81<br />		je .end<br />		jmp .again<br />	.end<br /><br />; jmp 0x30:0 ; called OK<br />; jmp 0x38:0 ; called OK<br /><br />	invk shut_down<br /><br />	ret<br /></code></pre><br /><br />If you need other code... say me.<br /><br />OK, I have tested my &quot;tasks&quot; independent without the scheduler (see the diferent jumps, and uncomment the ret in the scheduler) for enter to manual test... and aparently, I can jump one time to them to task 1 and 2 And they print the msg and read the scancode and replace it on the screen, then aparently they work ok,one by one. but dont know what happend when I try to schedule them... I dont know, if you see bochs breaks with &quot;EBX=00000030&quot; and &quot;ESI=00000002&quot; with ip pointing (If Im not wrong ) to jmp far  if you see task sel, it will contain task_sel dw 0x28, 0x30, 0x38 (30 and 38 are task1 and 2) I assume that 0x28 is the actual code running (or main task? and not need be filled), like I see, was the first time the scheduler was entering, it take the actual task (initializated to zero), add 1 to si (first task no zero task) and mul by 2, then I move what is inside task_sel (a selector in the GDT) and then SI=2 bx=0x30 (task 1).<br /><br />Some one have a idea of what probably Im doing wrong?</div>
    <div class="meta">Posted on 2005-05-25 21:39:31 by rea</div>
   </div>
   <div class="post" id="post-160449">
    <div class="subject"><a href="#post-160449">Re: problems with TSS</a></div>
    <div class="body">OK, after the post, I have done some test.... in the last part, where I do my &quot;manual test&quot;, I use the next<br /><br /><pre><code><br />; db 0xea, 0,0, 0x28, 0 ; jump_protected: JUMP to busy 386 TSS unsupported.<br />; jmp 0x30:0 ; it is called ok :)<br />; jmp 0x38:0 ; called ok.<br /></code></pre><br /><br />I have added what Im doing inside the scheduler (the function that aparently cause the fault...)<br /><br /><pre><code><br />1<br />mov bx, 0x30<br />jmp far <br />;&nbsp; jmp 0x30:0 ; it is called ok :)<br /><br />2<br />mov bx, 0x38<br />jmp far <br />; jmp 0x38:0 ; it is called ok :)<br /></code></pre><br /><br /><br />Aparently 1 cause the thing about bochs to stop (the exact same thing) &quot;&gt;&gt;PANIC&lt;&lt; fetch_raw_descriptor: LDTR.valid=0&quot;, and with 2 cause a get out of PM but the exception handler dosent print a message.., tought If I initialize the cur_tas to 1, then task2 will be called by the scheduler, and there the exception handler print a message (dont know why manually tought it print out of PM, dosent print exception)<br /><br /><pre><code><br />Out Of PM<br />&nbsp; &nbsp; &nbsp; exception Number 000D&nbsp; &nbsp; &nbsp; &nbsp; At address 100C:00080002 ERROR EFE8<br /></code></pre><br /><br /><br />Im thinking now that jump far  is not exaclty jmp 0x30:00 or so....<br /><br />??????</div>
    <div class="meta">Posted on 2005-05-25 22:00:29 by rea</div>
   </div>
   <div class="post" id="post-160478">
    <div class="subject"><a href="#post-160478">Re: problems with TSS</a></div>
    <div class="body">Ok, I have changed a little my code for check the thing about the far jump with  and replace with a direct jump xxx:x, and aparently it work ok (for very short time...).<br /><br />scheduler:<br /><pre><code><br />scheduler:<br />	mov si, <br />	inc si<br />	cmp si, MAX_TASK<br />	jb .cont<br />		xor si, si<br />	.cont<br />	mov , si<br />	jnz .nextcase1<br />		jmp 0x28:0<br />	.nextcase1<br />	cmp si, 1<br />	jnz .nextcase2<br />		jmp 0x30:0<br />	.nextcase2<br />		jmp 0x38:0<br />ret<br /></code></pre><br />tasks<br /><pre><code><br />mt0 db &quot;&nbsp; Task 0&quot;, 0<br />mt1 db &quot;&nbsp; Task 1&quot;, 0<br />mt2 db &quot;&nbsp; Task 2&quot;, 0<br />;couters<br />ct1 db &quot;A&quot;<br />ct2 db &quot;A&quot;<br />ct0 db &quot;A&quot;<br /><br />task1:<br />	.again<br />		mov al, <br />			inc al<br />		mov , al<br />		mov , al<br />		mov di, 80 * 8<br />		mov si, mt1<br />		invk write_msg<br />		jmp .again<br />ret<br />task2:<br />	.again<br />		mov al, ;mov al, <br />			inc al<br />		mov , al<br />		mov , al ; mov , al<br />		mov di, 80 * 9<br />		mov si, mt2<br />		invk write_msg<br />		jmp .again<br />ret<br /><br /><br />start2:<br />....<br />	call setup_pmode<br />		.again<br />		mov al, <br />		inc al<br />		mov , al<br />		mov , al<br />		mov di, 80 * 6<br />		mov si, mt0<br />		push ax<br />		invk write_msg<br />		pop ax<br />		cmp al, 0x81<br />		je .end<br />		jmp .again<br />	.end<br />	invk shut_down<br />	ret<br /></code></pre><br /><br />The error that bochs give is:<br /><pre><code><br />00000653811p &gt;&gt;PANIC&lt;&lt; task_switch: CS NULL<br />00000653811i Last time is 1117123995<br />00000653811i protected mode<br />00000653811i CS.d_b = 16 bit<br />00000653811i SS.d_b = 16 bit<br />00000653811i | EAX=00000020&nbsp; EBX=00000022&nbsp; ECX=00000000&nbsp; EDX=00000000<br />00000653811i | ESP=000008dc&nbsp; EBP=00000000&nbsp; ESI=101b0000&nbsp; EDI=028601aa<br />00000653811i | IOPL=0 NV UP DI PL ZR NA PE NC<br />00000653811i | SEG selector&nbsp; &nbsp;  base&nbsp; &nbsp; limit G D<br />00000653811i | SEG sltr(index|ti|rpl)&nbsp; &nbsp;  base&nbsp; &nbsp; limit G D<br />00000653811i |&nbsp; DS:0000( 0000| 0|&nbsp; 0) 00010000 0000ffff 0 0<br />00000653811i |&nbsp; ES:0000( 0000| 0|&nbsp; 0) 00010000 0000ffff 0 0<br />00000653811i |&nbsp; FS:0000( 0000| 0|&nbsp; 0) 000b8000 0000ffff 0 0<br />00000653811i |&nbsp; GS:0000( 0000| 0|&nbsp; 0) 000b8000 0000ffff 0 0<br />00000653811i |&nbsp; SS:0000( 0000| 0|&nbsp; 0) 00010000 0000ffff 0 0<br />00000653811i |&nbsp; CS:0000( 0000| 0|&nbsp; 0) 00010000 0000ffff 0 0<br />00000653811i | EIP=00000fe1 (00000fe1)<br />00000653811i | CR0=0x60000019 CR1=0x00000000 CR2=0x00000000<br />00000653811i | CR3=0x00000000 CR4=0x00000000<br />00000653811i[&nbsp; &nbsp;  ] restoring default signal behavior<br />00000653811i quit_sim called with exit code 1<br /></code></pre><br /><br />But there is printed the following in the screen.<br /><pre><code><br />Hi. Welcome to the 5th PMode tutorial! Protected mode is OK<br />We are in Protected Mode<br /><br />F Task 0<br />I Task 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  I task2<br /></code></pre><br /><br /><br />If all the c(ounter)t(ask)N are initializate to &quot;A&quot;, task 0 as incremented 6 times and task1 and task2 8 times. But if there exist switch in that moment, what change the execution for cause that exception???</div>
    <div class="meta">Posted on 2005-05-26 11:14:42 by rea</div>
   </div>
  </div>
 </body>
</html>