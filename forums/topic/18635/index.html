<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Listview and color of the selected item - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=18635" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=18635">Listview and color of the selected item</a></p>
   <div class="post" id="post-144340">
    <div class="subject"><a href="#post-144340">Listview and color of the selected item</a></div>
    <div class="body">Well after several hours of frustration I was forced to post this question. I am trying to change the bakground color of the listview items that are selected. It's no problem to do that for non-selected icons, there are several examples here but for the selected items...hm yup there are also couple of examples of what I want to do, on the board but they are unsucessful:<br /><br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=14869&amp;highlight=listview+color+selected">http://www.asmcommunity.net/board/index.php?topic=14869&amp;highlight=listview+color+selected</a><br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=12970&amp;highlight=listview+color+selected">http://www.asmcommunity.net/board/index.php?topic=12970&amp;highlight=listview+color+selected</a><br /><br />Program called e-mule has what I want to accomplish, it uses nice light blue color for selected items instead of boring default dark blue. It's open source program but it's c++ (yuck) so I downloaded it but I was unable to find the part of the code that does it (probably wrapped with some classes or libs). <br />Anyone can help?</div>
    <div class="meta">Posted on 2004-06-20 18:09:12 by Mikky</div>
   </div>
   <div class="post" id="post-144349">
    <div class="subject"><a href="#post-144349">Listview and color of the selected item</a></div>
    <div class="body">Hi Mikky,<br /><br />I do exactly that in my Listview example on my website. I give it a yellow selection color, you just process the WM_NOTIFY/NM_CUSTOMDRAW message...<br /><br /><span style="font-size:9px><pre><code>.NM_CUSTOMDRAW<br />	cmp D&#91;edi+NMHDR.code&#93;,NM_CUSTOMDRAW<br />	jne &gt;&gt;.WMN_DONE<br />	mov eax,&#91;wParam&#93;<br />	cmp eax,IDC_LISTVIEW<br />	jne &gt;&gt;.TREEVIEW<br />		mov edi,&#91;lParam&#93;<br />		mov eax,&#91;edi+NMLVCUSTOMDRAW.nmcd.dwDrawStage&#93;<br />		cmp eax,CDDS_PREPAINT<br />		jne &gt;<br />			; Request an item draw notification<br />			invoke SetWindowLong,&#91;hwnd&#93;, DWL_MSGRESULT, CDRF_NOTIFYITEMDRAW<br />			xor eax,eax<br />			inc eax<br />			ret<br />		&#58;<br />		cmp eax,CDDS_ITEMPREPAINT<br />		jne &gt;&gt;.DODEFAULT<br />			; The item is about to be painted<br />			; intercept the paint process to do our own thing<br />			mov eax,&#91;edi+NMLVCUSTOMDRAW.nmcd.uItemState&#93;<br />			test eax,CDIS_SELECTED<br />			je &gt;&gt;<br />				; A selected item is being drawn<br />				; Get the item number<br />				mov esi,&#91;edi+NMLVCUSTOMDRAW.nmcd.dwItemSpec&#93;<br />				; Get the bounding rect of the icon<br />				mov D&#91;rect.left&#93;,LVIR_ICON<br />				invoke SendMessage,&#91;hListView&#93;, LVM_GETITEMRECT, esi, OFFSET rect<br />				push &#91;rect.right&#93;<br />				; Get the bounding rect of the item<br />				mov D&#91;rect.left&#93;,LVIR_BOUNDS<br />				invoke SendMessage,&#91;hListView&#93;, LVM_GETITEMRECT, esi, OFFSET rect<br />				pop ecx ; pop the right side of the icon<br />				inc ecx ; one pixel space<br />				mov &#91;rect.left&#93;,ecx<br /><br />				; Get the device context<br />				mov ebx,&#91;edi+NMLVCUSTOMDRAW.nmcd.hdc&#93;<br /><br />				; Draw the background color<br />				invoke FillRect,ebx,OFFSET rect,&#91;hLVBrush&#93;<br /><br />				; Set the text background color<br />				invoke SetBkColor,ebx,CONTROLSELCLR<br />				push eax ; push the old background color<br />				; Set the text color<br />				invoke SetTextColor,ebx,CONTROLTEXTCLR<br />				push eax ; push the old text color<br /><br />				; Get the item count from the header control<br />				invoke SendMessage,&#91;hListView&#93;, LVM_GETHEADER, 0, 0<br />				invoke SendMessage,eax, HDM_GETITEMCOUNT, 0, 0<br />				mov ecx,eax<br /><br />				; Loop through all the labels and draw their text<br />				mov &#91;lvi.iItem&#93;,esi<br />				mov &#91;lvi.pszText&#93;,OFFSET TextBuffer<br />				mov D&#91;lvi.cchTextMax&#93;,255<br />				; EDI is no longer needed so we'll use it for a counter<br />				xor edi,edi<br />				jmp &gt;W1<br />				W2&#58;<br />					push ecx ; save the item count<br />					; Get the bounding rect of the label<br />					; the API uses the rect struct to pass parameters<br />					mov D&#91;rect.left&#93;,LVIR_LABEL<br />					mov D&#91;rect.top&#93;,edi<br />					invoke SendMessage,&#91;hListView&#93;, LVM_GETSUBITEMRECT, esi, OFFSET rect<br />					or edi,edi<br />					jz &gt;W3<br />						add D&#91;rect.left&#93;,4 ; extra indent for sub items<br />					W3&#58;<br />					add D&#91;rect.left&#93;,2 ; indent isn't right with LVM_GETITEM<br />					mov D&#91;lvi.iSubItem&#93;,edi<br />					invoke SendMessage,&#91;hListView&#93;, LVM_GETITEMTEXT, esi, OFFSET lvi<br />					; Draw the text to the items<br />					invoke DrawText,ebx,OFFSET TextBuffer,-1,OFFSET rect,DT_LEFT + DT_VCENTER + DT_SINGLELINE<br />					pop ecx ; restore the item count<br />					inc edi<br />				W1&#58;<br />				cmp edi,ecx ; have we reached the last item ?<br />				jl &lt;W2<br /><br />				pop eax ; pop the old text color<br />				invoke SetTextColor,ebx,eax<br />				pop eax ; pop the old background color<br />				invoke SetBkColor,ebx,eax<br /><br />				; Draw the icon and we're all done !<br />				mov D&#91;lvi.imask&#93;,LVIF_IMAGE<br />				mov &#91;lvi.iItem&#93;,esi<br />				mov D&#91;lvi.iSubItem&#93;,0<br />				invoke SendMessage,&#91;hListView&#93;,LVM_GETITEM,0,OFFSET lvi<br />				invoke SendMessage,&#91;hListView&#93;, LVM_GETIMAGELIST, LVSIL_SMALL, 0<br />				mov edi,eax<br />				mov D&#91;rect.left&#93;,LVIR_ICON<br />				invoke SendMessage,&#91;hListView&#93;, LVM_GETITEMRECT, esi, OFFSET rect<br />				invoke ImageList_Draw,edi, &#91;lvi.iImage&#93;, ebx, &#91;rect.left&#93;, &#91;rect.top&#93;, ILD_BLEND50<br /><br />				; The drawing is all done so skip the default draw<br />				invoke SetWindowLong,&#91;hwnd&#93;, DWL_MSGRESULT, CDRF_SKIPDEFAULT<br />				xor eax,eax<br />				inc eax<br />				ret<br />			&#58;<br />				; The item is not selected so use the default draw<br />				invoke SetWindowLong, &#91;hwnd&#93;, DWL_MSGRESULT, CDRF_DODEFAULT<br />				xor eax,eax<br />				inc eax<br />				ret<br /><br />	.DODEFAULT<br />		invoke SetWindowLong, &#91;hwnd&#93;, DWL_MSGRESULT, CDRF_DODEFAULT<br />		xor eax,eax<br />		inc eax<br />		ret</code></pre></span> <br /><br /><a target="_blank" href="http://donkey.visualassembler.com/files/TestListView.zip">Listview</a></div>
    <div class="meta">Posted on 2004-06-20 19:16:26 by donkey</div>
   </div>
   <div class="post" id="post-144351">
    <div class="subject"><a href="#post-144351">Listview and color of the selected item</a></div>
    <div class="body">Hi Mikky,<br /><br />I guess I should note that I use dialogs not windows so when you see :<br /><br />invoke SetWindowLong,, DWL_MSGRESULT, CDRF_xxxxx<br /><br />Just return the value (CDRF_xxxxx) in EAX and remove the SetWindowLong.</div>
    <div class="meta">Posted on 2004-06-20 20:01:37 by donkey</div>
   </div>
  </div>
 </body>
</html>