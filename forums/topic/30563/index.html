<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Divide by Zero - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=30563" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=116">Windows</a> &raquo; <a href="../?id=30563">Divide by Zero</a></p>
   <div class="post" id="post-214429">
    <div class="subject"><a href="#post-214429">Divide by Zero</a></div>
    <div class="body">Hello.<br /><br />I&#039;ll be surprised if many of you remember the first time I logged in here at 13 years old, because now I&#039;m 17 and still haven&#039;t learned much. That is not to say I&#039;m not interested, but I kept running into walls and like most people my age, there is no shortage of other things that can occupy my interest.<br /><br />Since my last posts I&#039;ve moved almost entirely to Linux, with the help of WINE. I&#039;m currently using the FASM compiler, which could undoubtedly be one of my issues when trying to learn assembly, since the vast majority of code is in other languages. Nonetheless, I&#039;ve run into a problem and can&#039;t figure it out.<br /><br />The below code gives me divide by zero errors every time, and yet just before the DIV instructions I&#039;ve set up instructions to skip the DIV instruction if the divisor is zero. I&#039;ve traced the code with Ollydbg and I still can&#039;t figure it out.<br /><br />The programs is simply intended to count a number of CPU cycles using RTDSC and display the result in a messagebox. I&#039;ve written a separate chunk of code to attempt to translate the binary result to ASCII so I can pass the string to the MessageBox function.<br /><br />Please help? The compiled code is attached, source inline.<br /><br />Thank you for your time.<br /><br /><pre><code>; Template for program using standard Win32 headers<br /><br />format PE GUI 4.0<br />entry start<br /><br />include &#039;win32w.inc&#039;<br /><br /><br />section &#039;.text&#039; code readable executable<br /><br />&nbsp; start:<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; GetModuleHandle,0<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; LoadIcon,0,IDI_APPLICATION<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; LoadCursor,0,IDC_ARROW<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; RegisterClass,wc<br />&nbsp; &nbsp; &nbsp; &nbsp; test&nbsp; &nbsp; eax,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; jz&nbsp; &nbsp; &nbsp; error<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; CreateWindowEx,0,_class,_title,WS_VISIBLE+WS_DLGFRAME+WS_SYSMENU,128,128,800,192,NULL,NULL,,NULL<br />&nbsp; &nbsp; &nbsp; &nbsp; test&nbsp; &nbsp; eax,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; jz&nbsp; &nbsp; &nbsp; error<br /><br />&nbsp; msg_loop:<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; GetMessage,msg,NULL,0,0<br />&nbsp; &nbsp; &nbsp; &nbsp; cmp&nbsp; &nbsp;  eax,1<br />&nbsp; &nbsp; &nbsp; &nbsp; jb&nbsp; &nbsp; &nbsp; error<br />&nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; end_loop<br />&nbsp; &nbsp; &nbsp; &nbsp; jg&nbsp; &nbsp; &nbsp; msg_loop<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; TranslateMessage,msg<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; DispatchMessage,msg<br />&nbsp; &nbsp; &nbsp; &nbsp; jmp&nbsp; &nbsp;  msg_loop<br /><br />&nbsp; error:<br />&nbsp; &nbsp; &nbsp; &nbsp; ;invoke&nbsp; PeekMessage,msg,NULL,0,0,0<br />&nbsp; &nbsp; &nbsp; &nbsp; ;push&nbsp; &nbsp; edi<br />&nbsp; &nbsp; &nbsp; &nbsp; ;push&nbsp; &nbsp; esi<br />&nbsp; &nbsp; &nbsp; &nbsp; ;mov&nbsp; &nbsp;  edi, clcks<br />&nbsp; &nbsp; &nbsp; &nbsp; ;mov&nbsp; &nbsp;  esi, msg<br />&nbsp; &nbsp; &nbsp; &nbsp; ;movsd<br />&nbsp; &nbsp; &nbsp; &nbsp; ;pop&nbsp; &nbsp;  esi<br />&nbsp; &nbsp; &nbsp; &nbsp; ;pop&nbsp; &nbsp;  edi<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; MessageBox,NULL,,NULL,MB_ICONERROR+MB_OK<br /><br />&nbsp; end_loop:<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; ExitProcess,<br /><br />proc WindowProc uses eax ebx edx ecx esi edi, hwnd,wmsg,wparam,lparam<br />&nbsp; &nbsp; &nbsp; &nbsp; cmp&nbsp; &nbsp;  ,WM_DESTROY<br />&nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; .wmdestroy<br />&nbsp; &nbsp; &nbsp; &nbsp; jmp&nbsp; &nbsp;  .rdtsc&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Jump to my code<br />&nbsp; .defwndproc:<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; DefWindowProc,,,,<br />&nbsp; &nbsp; &nbsp; &nbsp; jmp&nbsp; &nbsp;  .finish<br />&nbsp; .wmdestroy:<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; PostQuitMessage,0<br />&nbsp; &nbsp; &nbsp; &nbsp; xor&nbsp; &nbsp;  eax,eax<br />&nbsp; .finish:<br />&nbsp; &nbsp; &nbsp; &nbsp; ret<br />&nbsp; &nbsp; &nbsp; &nbsp; jmp&nbsp; &nbsp;  error<br /><br />&nbsp; .rdtsc:<br />&nbsp; &nbsp; &nbsp; &nbsp; xor&nbsp; &nbsp;  eax,eax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;start of my code<br />&nbsp; &nbsp; &nbsp; &nbsp; cpuid<br />&nbsp; &nbsp; &nbsp; &nbsp; rdtsc<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  , eax<br />&nbsp; &nbsp; &nbsp; &nbsp; cpuid<br />&nbsp; &nbsp; &nbsp; &nbsp; rdtsc<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  , eax<br />&nbsp; &nbsp; &nbsp; &nbsp; sub&nbsp; &nbsp;  eax, <br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  , eax<br />&nbsp; .Start:<br />&nbsp; &nbsp; &nbsp; &nbsp; test&nbsp; &nbsp; eax, eax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Is it zero?<br />&nbsp; &nbsp; &nbsp; &nbsp; jz&nbsp; &nbsp; &nbsp; .Return&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;If Zero, return (to avoid divide by zero errors)<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  eax, Base<br /><br />&nbsp; .Mainloop:<br />&nbsp; &nbsp; &nbsp; &nbsp; cmp&nbsp; &nbsp;  , eax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Is the result greater than 9?<br />&nbsp; &nbsp; &nbsp; &nbsp; jge&nbsp; &nbsp;  .Carry&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;If so, move the decimal<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  eax, <br /><br />&nbsp; &nbsp; &nbsp; &nbsp; div&nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; add&nbsp; &nbsp;  eax, 30h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Convert to ASCII<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  , eax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;String this character<br />&nbsp; &nbsp; &nbsp; &nbsp; add&nbsp; &nbsp;  , 4<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  eax, Base<br />&nbsp; &nbsp; &nbsp; &nbsp; cmp&nbsp; &nbsp;  , eax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Have we reached the ones-place yet?<br />&nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; .Return&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;If so, terminate.<br />&nbsp; &nbsp; &nbsp; &nbsp; test&nbsp; &nbsp; eax,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; jz&nbsp; &nbsp; &nbsp; .Return<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  eax, <br />&nbsp; &nbsp; &nbsp; &nbsp; div&nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Raise decimal again<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  , eax<br />&nbsp; &nbsp; &nbsp; &nbsp; jmp&nbsp; &nbsp;  .Mainloop<br /><br />&nbsp; .Carry:<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  eax, <br />&nbsp; &nbsp; &nbsp; &nbsp; mul&nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Decimal*Base=Decimal. Lower the decimal<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  , eax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Reinstate the Decimal<br />&nbsp; &nbsp; &nbsp; &nbsp; jmp&nbsp; &nbsp;  .Mainloop<br /><br />&nbsp; .Return:<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; MessageBox,NULL,,_die,MB_OK+MB_ICONEXCLAMATION+MB_SYSTEMMODAL<br />&nbsp; &nbsp; &nbsp; &nbsp; jmp&nbsp; &nbsp;  .defwndproc<br /><br />endp<br /><br /><br />section &#039;.data&#039; data readable writeable<br /><br />&nbsp; _class TCHAR &#039;FASMWIN32&#039;,0<br />&nbsp; _title TCHAR &#039;yeahyeahyeah&#039;,0<br />&nbsp; _error TCHAR &#039;Startup failed.&#039;,0<br />&nbsp; _die&nbsp;  TCHAR &#039;DIED!&#039;,0<br />&nbsp; _bye&nbsp;  TCHAR &#039;bye&#039;,0<br /><br />&nbsp; clcks&nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp; &nbsp; &nbsp; 0<br />&nbsp; Time1&nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp; &nbsp; &nbsp; 0<br />&nbsp; Time2&nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp; &nbsp; &nbsp; 0<br />&nbsp; Base = 10<br />&nbsp; Basex&nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp; &nbsp; &nbsp; 10<br />&nbsp; Decimal&nbsp; &nbsp; &nbsp;  dd&nbsp; &nbsp; &nbsp; 10<br />&nbsp; Result&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 4096<br />&nbsp; String&nbsp; &nbsp; &nbsp; &nbsp; rd&nbsp; &nbsp; &nbsp; 10<br />&nbsp; StringPointer dd&nbsp; &nbsp; &nbsp; String<br /><br />&nbsp; wc WNDCLASS 0,WindowProc,0,0,NULL,NULL,NULL,COLOR_BTNFACE+1,NULL,_class<br /><br />&nbsp; msg MSG<br /><br /><br />section &#039;.idata&#039; import data readable writeable<br /><br />&nbsp; library kernel32,&#039;KERNEL32.DLL&#039;,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; user32,&#039;USER32.DLL&#039;<br /><br />&nbsp; include &#039;api\kernel32.inc&#039;<br />&nbsp; include &#039;api\user32.inc&#039;&nbsp; &nbsp; &nbsp;  </code></pre></div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=3331" target="_blank">RTDSC.zip</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2011-05-26 20:48:50 by keantoken</div>
   </div>
   <div class="post" id="post-214430">
    <div class="subject"><a href="#post-214430">Re: Divide by Zero</a></div>
    <div class="body">&#039;Scuse me for laughin&#039;. Seems like everybody gets bit by this one! As soon as I read &quot;divide by zero&quot;, I knew what the problem was.<br /><br />This is neither a Windows issue nor a Fasm issue.The implicit operands to &quot;div&quot; (by 32-bits) are edx:eax / . Note the &quot;edx&quot;! If the result won&#039;t fit in eax, which it won&#039;t if edx &gt;=10 (in this case), it causes an overflow exception. Instead of calling this a &quot;divide overflow exception&quot;, it gets reported as &quot;divide by zero&quot;, or sometimes &quot;floating point error&quot;(!). The solution is very simple: &quot;xor edx, edx&quot; (or &quot;mov edx, 0&quot;) right before the &quot;div&quot;. I&#039;m not sure your conversion routine will work, but that should restore forward progress.<br /><br />Hint: 1234 divided by ten gives eax=123, edx=4...<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2011-05-27 23:51:51 by fbkotler</div>
   </div>
   <div class="post" id="post-214431">
    <div class="subject"><a href="#post-214431">Re: Divide by Zero</a></div>
    <div class="body">Thanks!!<br /><br />Okay, I did what you said. Although I should include edx in the calculations, I am going to simply truncate it until I can get the program to work.<br /><br />I have another very odd problem. <br /><br />At this instruction in .Carry:<br /><br /><pre><code><br /> &nbsp; &nbsp; &nbsp; &nbsp;mov &nbsp; &nbsp; , eax &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</code></pre><br /><br />It appears that AH and AL are getting swapped because when eax=1027, l=2710. Or when eax=3e8, .</div>
    <div class="meta">Posted on 2011-05-28 17:13:22 by keantoken</div>
   </div>
   <div class="post" id="post-214432">
    <div class="subject"><a href="#post-214432">Re: Divide by Zero</a></div>
    <div class="body">This is a common misunderstanding when starting out with assembly.&nbsp; On Intel chips the &#039;little-endian&#039; memory layout is used.<br />That is, when moving from register to memory, the lower 16 bits of eax dword ( the little-end )&nbsp; - eg: the word contained in AX ( the AH/AL part ) - are stored in lower memory while the upper bits is stored in higher memory.&nbsp; It makes sense when you think about the <strong>higher</strong> bits stored <strong>higher</strong> in memory.<br />Of course, when you do a memory dump, you have to do a mental translation as us humans prefer the bigger parts of a number listed first ;)<br /></div>
    <div class="meta">Posted on 2011-05-28 18:57:15 by p1ranha</div>
   </div>
   <div class="post" id="post-214434">
    <div class="subject"><a href="#post-214434">YES</a></div>
    <div class="body">Finally, after doing this all day, I managed to get it to almost work.<br /><br />I still haven&#039;t figured out how to load the ASCII characters into a string and then forward that string to the MessagBox title, but up to that part the ASCII encoder works. Now I&#039;ll work on making it use EDX as well so it will return the right number from RTDSC.<br /><br />I&#039;m discovering how difficult it may be to divide 64-bit numbers by 64-bit numbers...</div>
    <div class="meta">Posted on 2011-05-29 06:04:23 by keantoken</div>
   </div>
  </div>
 </body>
</html>