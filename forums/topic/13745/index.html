<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Customizing GetOpenFileName - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=13745" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=13745">Customizing GetOpenFileName</a></p>
   <div class="post" id="post-106436">
    <div class="subject"><a href="#post-106436">Customizing GetOpenFileName</a></div>
    <div class="body">I was converting some VB code and couldn't find anything here that was what I was looking for so, here I will show how to modify the GetOpenFileName dialog box to include a ListView and upon file click, populate the listview with the selected files icon and resource name.  It is not really commented if any, but it shouldn't be too bad, I will try to explain as we go:<br /><br />Pick a button and on that button click call DoIt<br />If a varible is not local, then it is global<br />hHeap is obtained from GetProcessHeap<br />here they are:<br /><pre><code><br />ofn			OPENFILENAME &lt;?&gt;<br />hd			DWORD	?<br />m_hDlg			DWORD	?<br />m_hwnd			DWORD	?<br />tR			RECT &lt;?&gt;<br />tTR			RECT &lt;?&gt;<br />wLp			POINT &lt;?&gt;<br />DlgFilePath		BYTE	MAX_PATH + 1 dup &#40;?&#41;<br />hHeap                                      DWORD ?<br /></code></pre><br />Sorry if I missed any<br /><br /><pre><code><br />IS_INTRESOURCE proc IcoID:DWORD	<br />	mov	eax, IcoID<br />	shr	eax, 16<br />	ret<br />IS_INTRESOURCE endp<br />[/code<br /><br />&#91;code&#93;<br />DoIt proc<br />	mov	ofn.lStructSize, sizeof OPENFILENAME<br />	push	hMain<br />	pop	ofn.hwndOwner<br />	push	hInst<br />	pop	ofn.hInstance<br />	mov	ofn.lpstrFilter, offset DlgFilter<br />	mov	ofn.lpstrTitle, offset DlgTitle<br />	mov	ofn.Flags,  OFN_FILEMUSTEXIST\<br />				Or OFN_PATHMUSTEXIST\<br />				Or OFN_HIDEREADONLY\<br />				or OFN_ENABLEHOOK\<br />				or OFN_EXPLORER <br />	mov	ofn.lpfnHook, offset ProcDlgHook<br />	<br />	push	offset ofn<br />	call	GetOpenFileName<br /><br />	push	-1<br />	push	imlDlgLrg<br />	call	ImageList_Remove<br />	<br />	push	0<br />	push	0<br />	push	LVM_DELETEALLITEMS<br />	push	hLVDlg<br />	call	SendMessage<br /><br />	ret<br />DoIt endp<br />&#91;/code&#93;<br />Next we need are callback proc which will handle the dialog messages and initialization<br />&#91;code&#93;<br />ProcDlgHook proc hDlg:HWND, uiMsg:UINT, wParam:WPARAM, lParam:LPARAM<br /><br />	cmp	uiMsg, WM_INITDIALOG <br />	je	_INITDIALOG <br />	cmp	uiMsg, WM_NOTIFY	<br />	je	_NOTIFY<br />	<br />PassThrough:<br />	xor	eax, eax<br />	ret<br /><br />_NOTIFY:<br />	mov	eax, wParam<br />	cmp	eax, 59			; check to see if message is from our listview first<br />	je	LVMsg<br />	<br />	; Not from listview, so continue<br />	mov	eax, lParam<br />	mov	ecx, .NMHDR.code<br />	cmp	ecx, CDN_SELCHANGE<br />	je	@F<br />	cmp	ecx, CDN_FILEOK<br />	je	FileOk<br />	cmp	ecx, CDN_FOLDERCHANGE<br />	je	FolderChange<br />	cmp	ecx, CDN_TYPECHANGE<br />	je	TypeChange<br />	jmp	PassThrough	<br /><br />	@@:<br />	push	0<br />	push	MAX_PATH + 1<br />	push	offset DlgFilePath<br />	call	memfill	<br />	<br />	push	hDlg<br />	call	GetParent<br />	mov	m_hwnd, eax<br />	<br />	push	offset DlgFilePath<br />	push	MAX_PATH + 1<br />	push	CDM_GETFILEPATH<br />	push	m_hwnd<br />	call	SendMessage<br />	<br />	call	ShowIcons<br />	jmp	PassThrough<br />	<br />	FileOk:	<br />	; On file click, we want dialog to stay open<br />	push	TRUE<br />	push	DWL_MSGRESULT<br />	push	hDlg<br />	call	SetWindowLong<br />	<br />	mov	eax, TRUE<br />	ret<br />	<br />FolderChange:	<br />	jmp	PassThrough<br /><br />TypeChange:<br />	jmp	PassThrough<br />	<br />LVMsg:<br />	mov	eax, lParam<br />	mov	ecx, .NMHDR.code<br />	cmp	ecx, LVN_ITEMCHANGING<br />	je	@F<br />	jmp	PassThrough		<br /><br />	@@:<br />	mov	edx, .NMLISTVIEW.uNewState<br />	cmp	edx, LVIS_FOCUSED or LVIS_SELECTED<br />	je	@F<br />	jmp	PassThrough<br />			<br />	@@:<br />	; Do what you want with selected listview item here then <br />	; dialog will close<br />	push	hDlg<br />	call	GetParent<br />	mov	m_hwnd, eax<br />	<br />	push	0<br />	push	0 <br />	push	WM_CLOSE<br />	push	m_hwnd<br />	call	PostMessage<br />	ret<br />	<br />_INITDIALOG:<br />	push	hDlg<br />	call	GetParent<br />	mov	m_hwnd, eax<br /><br />	; We/I don't want the next 3 controls so hide em.<br />	; Hide Ok button<br />	push	0<br />	push	IDOK<br />	push	CDM_HIDECONTROL<br />	push	m_hwnd<br />	call	SendMessage<br /><br />	; Hide File Name edit control<br />	push	0<br />	push	edt1<br />	push	CDM_HIDECONTROL<br />	push	m_hwnd<br />	call	SendMessage<br /><br />	; Hide File Name static control<br />	push	0<br />	push	stc3<br />	push	CDM_HIDECONTROL<br />	push	m_hwnd<br />	call	SendMessage<br />	<br />	; now move the next 3 controls up<br />	; Adjust File type static top<br />	push	0<br />	push	sizeof tTR<br />	push	offset tTR<br />	call	memfill<br /><br />	push	0<br />	push	sizeof wLp<br />	push	offset wLp<br />	call	memfill<br />	<br />	push	stc2<br />	push	m_hwnd<br />	call	GetDlgItem<br />	mov	hd, eax<br />	<br />	push	offset tTR<br />	push	hd<br />	call	GetWindowRect<br />	<br />	push	offset wLp<br />	push	m_hwnd<br />	call	ScreenToClient<br />	<br />	mov	eax, wLp.x<br />	add	eax, tTR.left<br />	<br />	mov	ecx, wLp.y<br />	add	ecx, tTR.top<br />	sub	ecx, 30<br />	<br />	push	SWP_NOSIZE<br />	push	0<br />	push	0<br />	push	ecx<br />	push	eax<br />	push	0<br />	push	hd<br />	call	SetWindowPos<br /><br />	; Adjust File type combo top<br />	push	cmb1<br />	push	m_hwnd<br />	call	GetDlgItem<br />	mov	hd, eax<br />	<br />	push	0<br />	push	sizeof tTR<br />	push	offset tTR<br />	call	memfill<br /><br />	push	0<br />	push	sizeof wLp<br />	push	offset wLp<br />	call	memfill<br />		<br />	<br />	push	offset tTR<br />	push	hd<br />	call	GetWindowRect<br />	<br />	push	offset wLp<br />	push	m_hwnd<br />	call	ScreenToClient<br />	<br />	mov	eax, wLp.x<br />	add	eax, tTR.left<br />	<br />	mov	ecx, wLp.y<br />	add	ecx, tTR.top<br />	sub	ecx, 30<br />	<br />	push	SWP_NOSIZE<br />	push	0<br />	push	0<br />	push	ecx<br />	push	eax<br />	push	0<br />	push	hd<br />	call	SetWindowPos<br /><br />	; Adjust Cancel button top<br />	push	IDCANCEL<br />	push	m_hwnd<br />	call	GetDlgItem<br />	mov	hd, eax<br />	<br />	push	0<br />	push	sizeof tTR<br />	push	offset tTR<br />	call	memfill<br /><br />	push	0<br />	push	sizeof wLp<br />	push	offset wLp<br />	call	memfill<br />		<br />	<br />	push	offset tTR<br />	push	hd<br />	call	GetWindowRect<br />	<br />	push	offset wLp<br />	push	m_hwnd<br />	call	ScreenToClient<br />	<br />	mov	eax, wLp.x<br />	add	eax, tTR.left<br />	<br />	mov	ecx, wLp.y<br />	add	ecx, tTR.top<br />	sub	ecx, 28<br />	<br />	push	SWP_NOSIZE<br />	push	0<br />	push	0<br />	push	ecx<br />	push	eax<br />	push	0<br />	push	hd<br />	call	SetWindowPos<br /><br />	push	0<br />	push	hInst<br />	push	59<br />	push	hDlg<br />	push	211<br />	push	160<br />	push	5<br />	push	420<br />	push	WS_CHILD \<br />		or WS_VISIBLE\<br />		or WS_CLIPSIBLINGS\<br />		or WS_VSCROLL\<br />		or LVS_ICON\<br />		or LVS_SINGLESEL\<br />		or LVS_SHOWSELALWAYS\<br />		or LVS_SHAREIMAGELISTS<br />	push	0<br />	push	offset WndClsListView<br />	push	WS_EX_CLIENTEDGE<br />	call	CreateWindowEx		; Listview<br />	mov	hLVDlg, eax<br />	<br />	push	FALSE<br />	push	hFont<br />	push	WM_SETFONT<br />	push	hLVDlg<br />	call	SendMessage	<br />		<br />	push	imlDlgLrg<br />	push	LVSIL_NORMAL<br />	push	LVM_SETIMAGELIST<br />	push	hLVDlg<br />	call	SendMessage<br />		<br />	push	m_hwnd<br />	push	hLVDlg<br />	call	SetParent<br /><br />	push	0<br />	push	sizeof tTR<br />	push	offset tTR<br />	call	memfill<br /><br />	push	0<br />	push	sizeof wLp<br />	push	offset wLp<br />	call	memfill<br />		<br />	push	offset tTR<br />	push	m_hwnd<br />	call	GetWindowRect<br />	<br />	push	offset wLp<br />	push	m_hwnd<br />	call	ScreenToClient<br /><br />	mov	eax, wLp.x<br />	add	eax, tTR.right<br />	add	eax, 165<br /><br />	mov	ecx, wLp.y<br />	add	ecx, tTR.bottom<br />	sub	ecx, 25	<br />	<br />	push	SWP_NOMOVE<br />	push	ecx<br />	push	eax<br />	push	0<br />	push	0<br />	push	0<br />	push	m_hwnd<br />	call	SetWindowPos<br /><br />	mov	eax, TRUE<br />	ret<br />ProcDlgHook endp<br />&#91;/code&#93;<br />Now we will load listview with icons on file selection<br />Note: PathIsDirectory is from shlwapi so include the lib and inc.<br />&#91;code&#93;<br />ShowIcons proc<br />LOCAL	hLib:DWORD<br /><br />	; Clear imagelist<br />	push	-1<br />	push	imlDlgLrg<br />	call	ImageList_Remove<br />	<br />	; Clear listview<br />	push	0<br />	push	0<br />	push	LVM_DELETEALLITEMS<br />	push	hLVDlg<br />	call	SendMessage<br />	<br />	; is the path a directory?  If yes, leave<br />	push	offset DlgFilePath<br />	call	PathIsDirectory<br />	test	eax, eax<br />	jnz	Done<br />	<br />	; Get icon count<br />	push	-1<br />	push	offset DlgFilePath<br />	push	hInst<br />	call	ExtractIcon<br />	test	eax, eax<br />	jz	Done<br />	<br />	; We have icons! load the file<br />	push	LOAD_LIBRARY_AS_DATAFILE<br />	push	0<br />	push	offset DlgFilePath<br />	call	LoadLibraryEx<br />	test	eax, eax<br />	jz	Done<br />	mov	hLib, eax<br />	<br />	; Now get all the icon names<br />	push	0<br />	push	offset EnumResNamesProc <br />	push	RT_GROUP_ICON<br />	push	eax<br />	call	EnumResourceNames  <br />	<br />	push	hLib<br />	call	FreeLibrary<br />	<br />	Done:<br />	ret<br />ShowIcons endp<br />&#91;/code&#93;<br />Next proc is the Callback for EnumResourceNames<br />&#91;code&#93;<br />EnumResNamesProc proc uses esi hModule:DWORD,lpszType:DWORD, lpszName:DWORD, lParam:DWORD<br />LOCAL	IconTemp:DWORD<br />LOCAL	LVParam:DWORD<br /><br />	push	LR_DEFAULTCOLOR<br />	push	32<br />	push	32<br />	push	IMAGE_ICON<br />	push	lpszName<br />	push	hModule<br />	call	LoadImage<br />	mov	IconTemp, eax<br />	<br />	push	eax<br />	push	-1<br />	push	imlDlgLrg<br />	call	ImageList_ReplaceIcon<br />	<br />	push	IconTemp<br />	call	DestroyIcon<br />	<br />	push	imlDlgLrg<br />	call	ImageList_GetImageCount <br />	sub	eax, 1<br />	<br />	mov	lvi.imask, LVIF_IMAGE or LVIF_TEXT<br />	mov	lvi.iItem, eax<br />	mov	lvi.iSubItem, 0<br />	mov	lvi.iImage, eax<br />	<br />	push	50<br />	push	HEAP_ZERO_MEMORY<br />	push	hHeap<br />	call	HeapAlloc<br />	mov	LVParam, eax<br />	<br />	push	0<br />	push	50<br />	push	LVParam<br />	call	memfill<br />	<br />	push	lpszName<br />	call	IS_INTRESOURCE<br />	test	eax, eax<br />	jz	@F<br />	<br />	push	lpszName<br />	call	StrLen<br />	<br />	push	eax<br />	push	LVParam<br />	push	lpszName<br />	call	MemCopy<br />	jmp	Continue<br />	<br />	<br />	@@:<br />	push	LVParam<br />	push	lpszName<br />	call	dwtoa<br />	<br />	Continue:<br />	mov	eax, LVParam<br />	mov	lvi.pszText, eax<br />	push	offset lvi<br />	push	0<br />	push	LVM_INSERTITEM<br />	push	hLVDlg<br />	call	SendMessage	<br /><br />	push	LVParam<br />	push	0<br />	push	hHeap<br />	call	HeapFree<br />	<br />	mov	eax, TRUE<br />	ret<br /><br />EnumResNamesProc endp<br />&#91;/code&#93;<br /><br />I think that is it.<br /><br />Hope it helps.</div>
    <div class="meta">Posted on 2003-06-08 20:44:18 by Gunner</div>
   </div>
  </div>
 </body>
</html>