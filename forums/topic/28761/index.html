<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>calling win32 APIs without imports! - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=28761" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=113">Low Level Concepts</a> &raquo; <a href="../?id=28761">calling win32 APIs without imports!</a></p>
   <div class="post" id="post-203202">
    <div class="subject"><a href="#post-203202">calling win32 APIs without imports!</a></div>
    <div class="body">I found this code while browsing through the examples that come with the masm32 package.<br /><pre><code><br />; =======================================<br />; NO_IMPORT by mob aka drcmda<br />; this program demonstrates how to write<br />; portable code... this code could be<br />; added to other executables with no prob.<br />; i&#039;m over that virus shit so don&#039;t waste<br />; your time... i&#039;m working on something<br />; like a executable patcher right now so<br />; portable code was very interesting for<br />; me...................................<br />; if you want to use other apis or other<br />; dll&#039;s then use this structure:<br />;<br />; 00&nbsp; &nbsp; &nbsp; db ?? ;lenght of name<br />; 01 - ?? db ?? ;API name<br />; ??&nbsp; &nbsp; &nbsp; dd ?? ;pointer<br />;<br />; then use &#039;GetApis&#039; to find their<br />; pointers so you don&#039;t have to search<br />; the pointers with GetModuleHandle<br />; write to drcmda@gmx.de <br />; =======================================<br /><br />; ---------------------------------------------------<br />; Build with MAKEIT.BAT to merge the .text and .data<br />; sections. Result is a 1024 byte length EXE file.<br />; ---------------------------------------------------<br /><br />.486<br />.Model&nbsp; &nbsp; &nbsp; Flat, Stdcall<br />Option&nbsp; &nbsp; &nbsp; Casemap:None<br /><br />.Data<br /><br />; kernel32.dll api&#039;s<br />___Kernel32&nbsp; &nbsp; &nbsp; &nbsp;  db 14,&quot;GetProcAddress&quot;<br />_Getprocaddress&nbsp; &nbsp;  dd 0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db 11,&quot;LoadLibrary&quot;<br />_Loadlibrary&nbsp; &nbsp; &nbsp; &nbsp; dd 0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db 11,&quot;ExitProcess&quot;<br />_Exitprocess&nbsp; &nbsp; &nbsp; &nbsp; dd 0<br /><br />; user32.dll api&#039;s<br />___User32&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  db 11,&quot;MessageBeep&quot;<br />_Messagebeep&nbsp; &nbsp; &nbsp; &nbsp; dd 0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db 10,&quot;MessageBox&quot;<br />_MessageBox&nbsp; &nbsp; &nbsp; &nbsp;  dd 0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br /><br />_Kernel&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  Dd 0<br />_User32&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  db &quot;USER32&quot;,0<br />_Default&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Dd 0&nbsp;  <br /><br />.Code&nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; <br />Start:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Call&nbsp; &nbsp; Delta<br />Delta:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Pop&nbsp; &nbsp;  Ebp&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; get deltaofs&nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Sub&nbsp; &nbsp;  Ebp,Offset Delta&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; for portability&nbsp; &nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Call&nbsp; &nbsp; Get_Kernel&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; get kernel base/set default<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Push&nbsp; &nbsp; 3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; 3 api&#039;s in the kernel32 struc<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop&nbsp; &nbsp;  Ecx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lea&nbsp; &nbsp;  Esi,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Call&nbsp; &nbsp; Get_Apis&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; get kernel apis<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lea&nbsp; &nbsp;  Eax,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; load user32.dll<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Push&nbsp; &nbsp; Eax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Call&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; test&nbsp; &nbsp; Eax,Eax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jz&nbsp; &nbsp; &nbsp; Error_Exit<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mov&nbsp; &nbsp;  ,Eax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; store result in &#039;default&#039;<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; 2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; 4 api&#039;s in the user32 struc<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop&nbsp; &nbsp;  Ecx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lea&nbsp; &nbsp;  Esi, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Call&nbsp; &nbsp; Get_Apis&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; get user32 apis&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Push&nbsp; &nbsp; -1<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Call&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; beep<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Push&nbsp; &nbsp; 0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Call&nbsp; &nbsp; _t02<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db&nbsp; &nbsp; &nbsp; &quot;little test&quot;,0<br />_t02:&nbsp; &nbsp; &nbsp;  Call&nbsp; &nbsp; _t01<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db&nbsp; &nbsp; &nbsp; &quot;MessageBox without imports, funny eh?&quot;,0<br />_t01:&nbsp; &nbsp; &nbsp;  Push&nbsp; &nbsp; 0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Call&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; messagebox<br /><br />Error_Exit:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Push&nbsp; &nbsp; 0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Call&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; get out<br /><br /><br />; ######################## get kernel ########################<br />; returns kernelbase and stores it in &#039;default&#039; and &#039;kernel&#039;<br />Get_Kernel:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mov&nbsp; &nbsp;  Ecx, ; get kerneladdr from stack<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />Kernel_Loop:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Xor&nbsp; &nbsp;  Edx,Edx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Dec&nbsp; &nbsp;  Ecx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mov&nbsp; &nbsp;  Dx, <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Test&nbsp; &nbsp; Dx,0F800H<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Jnz&nbsp; &nbsp;  Kernel_Loop<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Cmp&nbsp; &nbsp;  Ecx,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Jnz&nbsp; &nbsp;  Kernel_Loop&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mov&nbsp; &nbsp;  ,Ecx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mov&nbsp; &nbsp;  ,Ecx&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Ret<br /><br />; ######################## get apis&nbsp;  ########################<br />; default&nbsp;  = dll base<br />; ecx&nbsp; &nbsp; &nbsp;  = number of api&#039;s in the structure<br />; esi&nbsp; &nbsp; &nbsp;  = pointer to structure<br />Get_Apis:&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Xor&nbsp; &nbsp;  Ebx,Ebx<br />Api_Loop:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Inc&nbsp; &nbsp;  Esi&nbsp; &nbsp; &nbsp; &nbsp;  ; scan through the api<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Push&nbsp; &nbsp; Ecx&nbsp; &nbsp; &nbsp; &nbsp;  ; table and try to<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Movzx&nbsp;  ecx, byte ptr  ; addresses...&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Push&nbsp; &nbsp; Ecx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Call&nbsp; &nbsp; Get_Api<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Pop&nbsp; &nbsp;  Ebx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Pop&nbsp; &nbsp;  Ecx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Add&nbsp; &nbsp;  Esi,Ebx&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mov&nbsp; &nbsp;  ,Eax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Add&nbsp; &nbsp;  Esi,4<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Loop&nbsp; &nbsp; Api_Loop<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Ret&nbsp; &nbsp; &nbsp;  <br /><br />; ######################## get api&nbsp; &nbsp; ########################<br />; default = dll base<br />; ecx&nbsp; &nbsp;  = structure entry<br />Get_Api:&nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mov&nbsp; &nbsp;  Edx, <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Add&nbsp; &nbsp;  Edx,  ; get default module&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mov&nbsp; &nbsp;  Edx, <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Add&nbsp; &nbsp;  Edx, <br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mov&nbsp; &nbsp;  Edi,  ;Get Addrofnames<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Add&nbsp; &nbsp;  Edi, <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mov&nbsp; &nbsp;  Edi,  ;Get Addrofnames<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Add&nbsp; &nbsp;  Edi, <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mov&nbsp; &nbsp;  Eax,  ;Get Numberofnames&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Xor&nbsp; &nbsp;  Ebx,Ebx<br />Next_One:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Push&nbsp; &nbsp; Ecx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Inc&nbsp; &nbsp;  Ebx&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Push&nbsp; &nbsp; Esi<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Push&nbsp; &nbsp; Edi<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Repz&nbsp; &nbsp; Cmpsb ; compare api with export<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Pop&nbsp; &nbsp;  Edi<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Pop&nbsp; &nbsp;  Esi<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Jnz&nbsp; &nbsp;  Not_Found&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Pop&nbsp; &nbsp;  Ecx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mov&nbsp; &nbsp;  Ecx,  ;Get Addrnameord<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Add&nbsp; &nbsp;  Ecx, <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Dec&nbsp; &nbsp;  Ebx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Movzx&nbsp;  eax, word ptr &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mov&nbsp; &nbsp;  Ebx,  ;Get Addroffunctions<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Add&nbsp; &nbsp;  Ebx, <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mov&nbsp; &nbsp;  Eax, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Add&nbsp; &nbsp;  Eax, <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Ret<br />Not_Found:&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Dec&nbsp; &nbsp;  Edi&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />Loop_1:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Inc&nbsp; &nbsp;  Edi<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Cmp&nbsp; &nbsp;  Byte Ptr ,0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Jnz&nbsp; &nbsp;  Loop_1<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Inc&nbsp; &nbsp;  Edi&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Dec&nbsp; &nbsp;  Eax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Jz&nbsp; &nbsp; &nbsp; Exit_Search&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Pop&nbsp; &nbsp;  Ecx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Jmp&nbsp; &nbsp;  Next_One<br />Exit_Search:&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Jmp&nbsp; &nbsp;  Error_Exit<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Ret&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; <br />End&nbsp; &nbsp; &nbsp; &nbsp;  Start<br /></code></pre><br />The problem is that i have some problems understanding it.Although I know about the PE file structure and this program is just getting the handle for the api from the dll handling that api.But still there is some consusion.<br />can somebody please give some hint.</div>
    <div class="meta">Posted on 2007-10-16 07:58:36 by shakuni</div>
   </div>
   <div class="post" id="post-203203">
    <div class="subject"><a href="#post-203203">Re: calling win32 APIs without imports!</a></div>
    <div class="body">Gee, that code looks familiar.<br /><br />This kind of code verges on breaching our Rules.<br />Please don&#039;t post this sort of code here again, at least not as a complete unit.<br />If you must, quote a few lines, ask specific questions, one at a time.<br />Don&#039;t expect anyone to explain the complete sourcecode to you.<br />You can get help, we just don&#039;t want to encourage (or be seen to encourage) malicious code and/or malicious coders.<br /><br /></div>
    <div class="meta">Posted on 2007-10-16 10:11:09 by Homer</div>
   </div>
   <div class="post" id="post-203204">
    <div class="subject"><a href="#post-203204">Re: calling win32 APIs without imports!</a></div>
    <div class="body">Sir<br />this code is NOT malicious(if it&#039;s malicious why it is distributed with the masm7 package that I downloaded a few months back).<br />it just displays a message box and nothing else but it does this WITHOUT importing any libraries and that is what I want to understand.<br />What I understand about this code is that it find out the address of the message box api in the place where dll is loaded when the OS is loaded,but I don&#039;t understand that how this code finds the address where the dll is loaded.So just point out to me how THAT part of code works.</div>
    <div class="meta">Posted on 2007-10-16 10:56:24 by shakuni</div>
   </div>
   <div class="post" id="post-203205">
    <div class="subject"><a href="#post-203205">Re: calling win32 APIs without imports!</a></div>
    <div class="body"><div class="quote"><br />Sir<br />this code is NOT malicious(if it&#039;s malicious why it is distributed with the masm7 package that I downloaded a few months back).<br /></div><br /><br />That is not saying much. The legality of the package itself is questionable, at best.<br /><br /><div class="quote"><br />it just displays a message box and nothing else but it does this WITHOUT importing any libraries and that is what I want to understand.<br /></div><br /><br />On that point I would not consider it malicious. However, please do adhere to Homer&#039;s warning and don&#039;t post whole chunks of code like that when it obviously originates from a current/former malware developer.<br /><br />Search engines are fickle creatures ;)<br /><br /><div class="quote"><br />What I understand about this code is that it find out the address of the message box api in the place where dll is loaded when the OS is loaded,but I don&#039;t understand that how this code finds the address where the dll is loaded.So just point out to me how THAT part of code works.<br /></div><br /><br />You&#039;ll need intimate knowledge of the Portable Executable format to understand what is going on here. The code is using the base address of the program itself to find the hard-coded import locations... which is actually not an entirely accurate explanation... but it should point you in the right direction.<br /><br />FYI: That code method will probably be tagged by any decent anti-virus software, since there is a good deal of malware-based methods being utilized. If you really want to do a Library-less call in ASM, look into INT 0x2E and the Windows System Call mechanism :)</div>
    <div class="meta">Posted on 2007-10-16 11:40:46 by SpooK</div>
   </div>
   <div class="post" id="post-203206">
    <div class="subject"><a href="#post-203206">Re: calling win32 APIs without imports!</a></div>
    <div class="body">shakuni,<br /><br />You are right that the code is not malicious, the problem is that this code uses a technique that borders on the edge of malicious coding. &quot;Portable coding&quot; is very rarely used in anything other than viruses or shellcode, both of which are against the rules of this forum. There are legitimate uses but too few to overlook malicious ones. If you read the comment, Mob even states what he was using this code in relation to, &quot;i&#039;m working on something like a executable patcher right now so portable code was very interesting for me&quot;. This would fall under reverse engineering and is also not allowed. This is why Homer asked for you not to post the complete source here again. Mob was a well known virus/trojan author and as for why hutch decided to include code by him in his package I can&#039;t answer that, you&#039;d have to ask him.<br /><br />Regards,<br />Bryant Keller</div>
    <div class="meta">Posted on 2007-10-16 11:48:57 by Synfire</div>
   </div>
   <div class="post" id="post-203207">
    <div class="subject"><a href="#post-203207">Re: calling win32 APIs without imports!</a></div>
    <div class="body">The method for finding the functions consists in getting KERNEL32.DLL address from the stack (the return address), and later doing some memory traversing to find out where the kernel32&#039;s export table is located and take LoadLibrary address from there.<br /><br />Note however that this method is unreliable, Windows 2000 needs KERNEL32.DLL imported directly or indirectly by another API that you import from the import table, otherwise the EXE is not executed at all. This method actually is ancient, I can&#039;t remember where I see it the first time (iczelion?). Well, there is a difference with the method I saw, while your example seems to get all addressess on its own, the other just used it to get LoadLibary&amp;GetProcAddress but this one abuses the fact that the instance returned by LoadLibrary is in fact a pointer to the loaded library location.<br /><br />PS: Sorry SpooK, I&#039;m repeating you in some aspects but to lazy to edit :P. BTW, what slow I am today :S &quot;Warning - while you were typing 2 new replies have been posted. You may wish to review your post.&quot;</div>
    <div class="meta">Posted on 2007-10-16 11:57:18 by LocoDelAssembly</div>
   </div>
   <div class="post" id="post-203208">
    <div class="subject"><a href="#post-203208">Re: calling win32 APIs without imports!</a></div>
    <div class="body"><div class="quote">Please don&#039;t post this sort of code here again, at least not as a complete unit.</div><br />I am sorry to post the whole code,I&#039;ll not do it again.<br /><br /><div class="quote">This kind of code verges on breaching our Rules.</div><br /><div class="quote">the problem is that this code uses a technique that borders on the edge of malicious coding.</div><br />Regarding the malicious background of the author and his code,I did&#039;nt knew about it.<br />Next time I will do proper research before posting anything.<br /><br /><div class="quote">&quot;Portable coding&quot;</div><br />Sir,Can you please tell me more abut this?I&#039;ve been reading that assembly language is NOT portable.<br /><br /><div class="quote">This method actually is ancient</div><br />Sir,What are the &quot;new&quot; methods of writing &quot;portable&quot; assembly code?<br /><br /><div class="quote">there is a difference with the method I saw</div><br />Sir,Can you please tell me what was the other methods?<br /><br />Sorry for so much questioning,but please try to understand my situation because I am still in the learning phase.<br /></div>
    <div class="meta">Posted on 2007-10-16 12:55:14 by shakuni</div>
   </div>
   <div class="post" id="post-203209">
    <div class="subject"><a href="#post-203209">Re: calling win32 APIs without imports!</a></div>
    <div class="body">Don&#039;t know what new methods are available, I just said that trick was published long time ago (the variation I saw at least).<br /><br />About portability (I talked about it apart of the Windows 2000 remark?), the problem with this method is that is not reliable across Windows versions (here the loss of portability comes). ASM is not portable, but by using these technics you are making your executable even less portable while executables that imports &quot;in the right way&quot;TM works on more versions and even in future versions (unless Microsoft decide in future to break compatibility with software designed for earlier versions of Windows).<br /><br />To sumarize, this method is not documented by Microsoft and hence you have no warranties that it will work OK always. Import APIs in the usual way. If you use fasm, by just doing<pre><code>include &#039;win32ax.inc&#039;<br /><br />.code<br />start:<br />&nbsp; invoke MessageBox, 0, &quot;Hello&quot;, &quot;Hello&quot;, 0<br />&nbsp; invoke ExitProcess, 0<br /><br />.end start&nbsp;  </code></pre><br />Automatically builds the import table for you. You can use a sightly lower level if you want or really constructing your import table by yourself, check the examples inside the package.</div>
    <div class="meta">Posted on 2007-10-16 13:25:54 by LocoDelAssembly</div>
   </div>
   <div class="post" id="post-203273">
    <div class="subject"><a href="#post-203273">Re: calling win32 APIs without imports!</a></div>
    <div class="body">The fix for win2k systems (assuming you can detect the OS without any api, which I can) is, as sp00k suggested, to use an int 2e call to get k32 loaded, and then everything is peachy.<br />Again, the key here is the ability to detect which OS the code is running on WITHOUT using any api.<br /></div>
    <div class="meta">Posted on 2007-10-23 00:23:36 by Homer</div>
   </div>
   <div class="post" id="post-203277">
    <div class="subject"><a href="#post-203277">Re: calling win32 APIs without imports!</a></div>
    <div class="body">What&#039;s the point in no-imports-whatever, anyway? You <strong>need</strong> to import (or end up importing) from kernel32, otherwise your app will silently fail to load on win2k.<br /><br />Using int2e/syscall doesn&#039;t sound like a too great idea to me either, there&#039;s no guarantee that syscall numbers won&#039;t be swapped around on a service pack or whatever.<br /></div>
    <div class="meta">Posted on 2007-10-23 03:40:45 by f0dder</div>
   </div>
   <div class="post" id="post-203290">
    <div class="subject"><a href="#post-203290">Re: calling win32 APIs without imports!</a></div>
    <div class="body"><div class="quote"><br />What&#039;s the point in no-imports-whatever, anyway? You <strong>need</strong> to import (or end up importing) from kernel32, otherwise your app will silently fail to load on win2k.<br /><br />Using int2e/syscall doesn&#039;t sound like a too great idea to me either, there&#039;s no guarantee that syscall numbers won&#039;t be swapped around on a service pack or whatever.<br /><br /></div><br /><br />That&#039;s the whole point of having such DLL wrappers :P</div>
    <div class="meta">Posted on 2007-10-23 13:34:06 by SpooK</div>
   </div>
   <div class="post" id="post-203301">
    <div class="subject"><a href="#post-203301">Re: calling win32 APIs without imports!</a></div>
    <div class="body"><div class="quote"><br /><div class="quote"><br />What&#039;s the point in no-imports-whatever, anyway? You <strong>need</strong> to import (or end up importing) from kernel32, otherwise your app will silently fail to load on win2k.<br /><br />Using int2e/syscall doesn&#039;t sound like a too great idea to me either, there&#039;s no guarantee that syscall numbers won&#039;t be swapped around on a service pack or whatever.<br /><br /></div><br /><br />That&#039;s the whole point of having such DLL wrappers :P<br /></div><br />Exactly - and <em>using</em> them :)</div>
    <div class="meta">Posted on 2007-10-24 06:22:32 by f0dder</div>
   </div>
   <div class="post" id="post-204180">
    <div class="subject"><a href="#post-204180">Re: calling win32 APIs without imports!</a></div>
    <div class="body"><div class="quote">Again, the key here is the ability to detect which OS the code is running on WITHOUT using any api.</div><br /><br />To detect NT based systems (ignoring NT4 you will get 2K+)<br /><br /><pre><code>fs mov eax, [18h] ; Test for NT<br />cmp eax, 7FFDE000h<br />setne B ; set the 9x flag based on the EFLAGS register</code></pre><br /><br />Donkey</div>
    <div class="meta">Posted on 2007-12-29 10:12:49 by donkey</div>
   </div>
   <div class="post" id="post-204182">
    <div class="subject"><a href="#post-204182">Re: calling win32 APIs without imports!</a></div>
    <div class="body">Iirc you can also check for 9x vs. NT by checking if you have LDT or GDT segments...<br /><br />But again, this is pretty dirty stuff, might fail running under emulation, etc.</div>
    <div class="meta">Posted on 2007-12-29 10:17:24 by f0dder</div>
   </div>
  </div>
 </body>
</html>