<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>DirectDraw gr... - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=7663" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=10">Graphics &amp; Game Development</a> &raquo; <a href="../?id=7663">DirectDraw gr...</a></p>
   <div class="post" id="post-55754">
    <div class="subject"><a href="#post-55754">DirectDraw gr...</a></div>
    <div class="body">Hi I'm having a Problem, I'm trying to use DirectDraw in my code so I can port a 2D gfx engine I have made into DirectX/Win32 so I can use more effects because the CPU power I can use  under DOS is limited by WindowsNT4/2000/XP. <br /><br /><pre><code><br />DllEntry proc hInstDLL&#58;HINSTANCE, reason&#58;DWORD, reserved1&#58;DWORD <br />invoke GetModuleHandle, NULL<br />mov hInst,eax                   ;Store it in RAM<br />;Now determing CPU feature set<br />invoke LoadIcon, NULL, IDI_WINLOGO<br />mov iconh,eax<br />invoke LoadCursor, NULL, IDC_ARROW<br />mov curh,eax <br />mov wc.hCursor,eax<br />mov eax,iconh<br />mov wc.hIcon,eax<br />invoke StartRender, 800, 600, 32, ADDR szDisplayName, ADDR WndProc  ;For debugging<br />xor eax,eax<br />cpuid                   ;Execute CPUID<br />mov esi,OFFSET vendstr  ;Grab OFFSET to ESI<br />mov &#91;esi&#93;,ebx           ;Store first 4 letters of string<br />mov &#91;esi+4&#93;,edx         ;Store<br />mov &#91;esi+8&#93;,ecx         ;Store <br />xor eax,eax             ;Clear out EAX<br />inc eax                 ;EAX==1<br />cpuid                   ;Execute CPUID<br />mov vend,eax            ;Store into memory, process it<br />.IF EAX &amp; 23            ;Is Bit 23 set? &#40;MMX&#41;<br />mov bl,1<br />mov esi,OFFSET mmx<br />mov &#91;esi&#93;,bl            ;Store 1 into MMX flag  <br />.ENDIF<br />.IF EAX &amp; 25            ;Is bit 25 set? &#40;SSE&#41;<br />mov bl,1<br />mov esi,OFFSET sse<br />mov &#91;esi&#93;,bl<br />.ENDIF<br />mov eax,80000000h       ;Check for Extended CPUID support<br />cpuid                   ;Execute CPUID<br />.IF EAX==NULL           ;No support for Extended CPUID<br />mov eax,TRUE<br />popad<br />.ELSEIF EAX!=NULL<br />mov eax,80000001h       ;Update EAX<br />cpuid                   ;Execute CPUID<br />.IF EAX &amp; 31            ;Bit 31 &#40;3DNow!&#41;<br />mov BYTE PTR k3d,1        <br />.ENDIF<br />;No need to test further &#58;D<br />.ENDIF<br />jmp StartRender<br />mov eax,TRUE<br />ret<br />DllEntry Endp<br /><br />StartRender PROC xdim&#58;WORD,ydim&#58;WORD,bpp&#58;WORD,winname&#58;DWORD,lpfunc&#58;DWORD<br /><br />mov eax,hInst<br />mov wc.hInstance,eax<br />invoke GetStockObject, BLACK_BRUSH<br />mov wc.hbrBackground,eax   <br />invoke RegisterClassEx, ADDR wc<br />mov class,eax       <br />movzx eax,xdim<br />movzx ebx,ydim<br />mov ecx,hInst<br />mov edx,hInst<br />invoke CreateWindowEx, NULL, ADDR szClassName, ADDR szDisplayName, WS_POPUP, 0,0, eax,ebx,NULL,NULL,edx,0<br />ret<br />StartRender ENDP<br /><br /><br />WndProc		PROC	hWin   &#58;DWORD,<br />					uMsg   &#58;DWORD,<br />					wParam &#58;DWORD,<br />					lParam &#58;DWORD<br />pushad                        ;Save all registers on the stack<br />popad<br />WndProc ENDP<br />END DllEntry<br /></code></pre><br /><br />The problem is when I do something to set the Cooperative Level I get back aweird value in the EAX register like 80000057h or something similar. Also when I try to Create The Window it flags an Access Violation!! I passed all the right parameters and everything but I dont know what is wrong! Can someone please help me by giving me example code on how to open a DirectDraw window at say, 800x600x32 and how to set up a Pointer to the Frame Buffer? Thats all I need to pull off some fancy effects that I learned how to do :D I'll try 'em out and then I'll post it here so everyone can use and possibly someone here can optimize it so its even faster :D <br />Thank you everyone!</div>
    <div class="meta">Posted on 2002-09-01 21:59:06 by x86asm</div>
   </div>
   <div class="post" id="post-55758">
    <div class="subject"><a href="#post-55758">DirectDraw gr...</a></div>
    <div class="body">My friend...<br /><br />Since you obviousely do not know much about Win32 or DirectDraw please make yourself a service and start simple, then grow up :)<br /><br />Now i will suggest that you make a simple win32 application with window and stuff first...<br /><br />A DLL is supposed to have a set of functions that can be used by diferent applications, haveing the code that creates a window and WndProc inside a DLL dosent make much sense to me...<br /><br /><br />If i recall corectly <strong>80000057</strong> is <strong>Invalid Params</strong> error for DirectDraw<br /><br />To quick help you ....below is the old but functional code we useed to setup DirectDraw in Hostile Encounter game, of course you will have to change it a little (define some vars not shown here and have some include files with DD interfaces) to make it wor in you 2D engine :) . You will also need the Flip() and Lock() methods for your engine IMHO<br /><br />I also remember i have posted such code in the past also so you could do a search of this board...<br />As you can see we use to print an debug string before starting an action and handle errors (somehow) if any action fails....<br /><br /><pre><code><br />;===========================================================<br />; This&#58;<br />; 1. Creates a DirectDraw object.<br />; 2. Greedily sets the coperative level so that it's in exclusive mode.<br />; 3. Switches display mode to 600 by 800  /16 bits = 65.000 CLOLORS<br />; 4. Creates a primary surface with a back buffer<br />; 5. Gets a pointer to the back buffer.<br />; 6. Creates a plain surface in memory for transparent blitting<br />; ........and many others<br />;========================================================<br /><br /><br />;*******************************<br />; DIRECT DRAW SETUP STARTS HERE<br />;*******************************<br /><br />Direct_Draw_Setup&#58;<br /><br />;===============================================<br />; 1. Create a DirectDraw object.<br />;==============================================<br /><br /><br />.data<br />	sz007	db	&quot;007=DirectDrawCreate&quot;,13,10,0<br />.code<br /><br />	call	OutputDebugStringA,offset sz007<br /><br />	call DirectDrawCreate, NULL, offset lpDD,NULL<br /><br />	; take action if it fails<br />	.IF eax != DD_OK<br />		call Fail, hwndmain, offset szDirectDrawCreateFail<br />		jmp end_loop<br />	.ENDIF<br /><br />;===============================<br />; 2. Greedily hehe set the coperative level <br />; so that it's in exclusive mode<br />;==============================<br /><br /><br />.data<br />	sz008	db	&quot;008=SetCooperativeLevel Exclusive&quot;,13,10,0<br />.code<br /><br />	call	OutputDebugStringA,offset sz008<br /><br />	mov	eax,&#40;DDSCL_EXCLUSIVE OR DDSCL_FULLSCREEN&#41;<br />	push 	eax<br /><br />	mov	eax,&#91;hwndmain&#93;<br />	push	eax<br /><br />	mov eax,&#91;lpDD&#93;<br />	push eax				; DD Object<br /><br />	mov eax,&#91;eax&#93;				; vtable addr<br />	call &#91;eax+DDO_SetCooperativeLevel&#93;	; call address for SetCooperativeLevel   <br /><br />	;check for error<br />	.IF eax != DD_OK<br />		call Fail, eax, offset szSetCooperativeLevelFail<br />		jmp end_loop<br />	.ENDIF	<br /><br />;=========================================<br />;  3. Switch display mode to&#58;<br />;	 screen_dx x screen_dy x screen_bpp<br />;==========================================<br /><br />.data<br />	sz009	db	&quot;009=SetDisplayMode&quot;,13,10,0<br />.code<br /><br />	call	OutputDebugStringA,offset sz009<br /><br />	mov	eax,screen_bpp		; bpp<br />	push	eax<br /><br />	mov	eax,screen_dy<br />	push	eax			; cy<br /><br />	mov	eax,screen_dx<br />	push	eax			; cx<br /><br />	mov	eax,&#91;lpDD&#93; 			; pointer to the instance of the DDObject<br />	push	eax<br /><br />	mov	eax,&#91;eax&#93;			; get the vtable addr<br />	call	&#91;eax + DDO_SetDisplayMode&#93;	; Call SetDisplayMode method by indexing<br />    						; into object's virtual table<br />	;check for error<br />	.IF eax != DD_OK<br />		call Fail, eax, offset szSetDisplayModeFail<br />		jmp end_loop<br />    	.ENDIF<br /><br /><br />;******************************************************<br />; 4. Create a primary surface with a back buffer.<br />;*******************************************************<br /><br /><br />.data<br />	sz010	db	&quot;010=CreatePrimarySurface&quot;,13,10,0<br />.code<br /><br />	call	OutputDebugStringA,offset sz010<br /><br />;=========================================<br />; first prepare the DDSD ie&#58;<br />; DirectDrawSurfaceDescription structure<br />;=========================================<br />	mov	ddsd.dwSize, SIZE ddsd	<br />	mov	ddsd.dwsurfFlags,DDSD_CAPS+DDSD_BACKBUFFERCOUNT			<br />;==============================================<br />; also has a DDS_Surf_Caps sub structure in it<br />;================================================<br />	mov	ddsd.ddssurfCaps.dwCaps,DDSCAPS_PRIMARYSURFACE OR\<br />						DDSCAPS_FLIP OR\<br />						DDSCAPS_COMPLEX <br /><br />;						DDSCAPS_VIDEOMEMORY<br /><br />	mov	ddsd.dwBackBufferCount,BUFFERS	; =1<br /> <br />	push	large NULL<br />	mov	eax, offset lpDDSPrimary<br />	push	eax<br />	mov	eax, offset ddsd<br />	push	eax<br />	mov	eax,&#91;lpDD&#93; 			;DD Object<br />	push	eax<br /><br />	mov	eax,&#91;eax&#93;			; get object's vtable addr<br />	call	&#91;eax + DDO_CreateSurface&#93;	; call CreateSurface<br /><br />	.IF eax != DD_OK<br />		call Fail, eax, offset szCreateSurfaceFail<br />		jmp end_loop<br />	.ENDIF<br /><br />;===============================================<br />; Get a pointer to the back buffer surface <br />;===============================================<br />.data<br />	sz011	db	&quot;011=GetPointerToBackBuffer&quot;,13,10,0<br />.code<br /><br />	call	OutputDebugStringA,offset sz011<br /><br />	mov	ddscaps.dwCaps, DDSCAPS_BACKBUFFER	; specify the back buffer<br /><br />	mov	eax,offset lpDDSBack			; place to store the pointer<br />	push	eax<br /><br />	mov	eax, offset ddscaps<br />	push	eax<br /><br />	mov	eax,&#91;lpDDSPrimary&#93;			; the surface the back buffer is attached to<br />	push	eax<br /><br />	mov	eax,&#91;eax&#93;<br />	call	&#91;eax + DDS_GetAttachedSurface&#93;		; GetAttachedSurface<br /><br />	.IF eax != DD_OK<br />		call Fail, eax, offset szGetAttachedSurfaceFail<br />		jmp end_loop<br />	.ENDIF<br /><br /><br />;====================================<br />;  GetPixelFormat for Primary surf<br />;====================================<br />.data<br />	ALIGN	4<br />	dd_pixelformat01	DDPIXELFORMAT	&lt;0&gt;<br />	dd_lp_pixelformat01	dd	0<br />	szGetPixelFormatFail	db	&quot;GetPixelFormat Failed&quot;,0,0,0,0<br />.code<br /><br />.data<br />	sz0012	db	&quot;012=GetPixelFormatForPrimary&quot;,13,10,0<br />.code<br /><br />	call	OutputDebugStringA,offset sz0012<br />	mov	eax,size dd_pixelformat01<br />	mov	dd_pixelformat01.dwSize,eax<br /><br />	mov	eax,offset dd_pixelformat01<br />	push	eax<br /><br />	mov	eax,&#91;lpDDSPrimary&#93;<br />	push	eax<br /><br />	mov	eax,&#91;eax&#93;			;vtable addr<br />	call	&#91;eax + DDS_GetPixelFormat&#93;	<br /><br /><br />	.IF eax != DD_OK<br />    		call Fail, eax, offset szGetPixelFormatFail<br />	    	jmp end_loop<br />	.ENDIF	 <br /><br />.data<br />	ALIGN	4<br /><br />	flag_565_pixelformat	dd	0<br />	GBitmask565		equ	7e0h<br />	test_gmask		dd	0<br />.code<br />	mov	eax,dd_pixelformat01.dwGBitMask<br />	mov	&#91;test_gmask&#93;,eax<br />	cmp	eax,GBitmask565<br />	jnz	Video_is_555<br />	mov	&#91;flag_565_pixelformat&#93;,1<br /><br />Video_is_555&#58;<br /><br /><br /><br /><br /></code></pre></div>
    <div class="meta">Posted on 2002-09-02 00:49:44 by BogdanOntanu</div>
   </div>
   <div class="post" id="post-55811">
    <div class="subject"><a href="#post-55811">DirectDraw gr...</a></div>
    <div class="body">Thank you very much for the code Bogdan I really appreciate it, can I also ask a quick question, how would I structure the DLL file? Cause I want to keep all of my graphics functions in a reusable DLL that I can make a few small games because in DOS I have some functions that I can just copy and paste and write the main game code and the game is finished. Should I do this:<br /><br />1. Have the main app set up DirectDraw and other stuff<br />2. Pass the pointer of main surface (vid memory) and back buffer<br /><br />Is that OK?</div>
    <div class="meta">Posted on 2002-09-02 12:15:34 by x86asm</div>
   </div>
   <div class="post" id="post-55844">
    <div class="subject"><a href="#post-55844">DirectDraw gr...</a></div>
    <div class="body">Well you see do not use any DLL in HE...<br /><br />but as Hiroshimator has very well pointed out it whould have been better if we used a DLL with the common functions used in both Game and Map Editor, in this way improvements in game whould have appeared faster in game editor also :)<br /><br />SO to answer you questions i guess YES it is better to let applications make their own windows/class and main directdraw object. Please do not forget that in a DLL the code is shared but the .data zones are owned by each process that actually uses the DLL.<br /><br />I guess you can also include the Initializations part as a helper in you DLL so if somebody dosent want to make his own DirectDraw Object but i guess makeing a window class is everybody's little work that he has to be &quot; do it yourself&quot; job :)<br /><br />Also do not forget about &quot;Pitch&quot; of a locked surface or primary/seccondary on screen surfaces whrn porting any 2D stuff<br /><br />Besides that choose your parameters carefully</div>
    <div class="meta">Posted on 2002-09-02 19:59:45 by BogdanOntanu</div>
   </div>
   <div class="post" id="post-55846">
    <div class="subject"><a href="#post-55846">DirectDraw gr...</a></div>
    <div class="body">Thank you for your guidance Bogdan, I really appreciate it :D</div>
    <div class="meta">Posted on 2002-09-02 20:05:42 by x86asm</div>
   </div>
  </div>
 </body>
</html>