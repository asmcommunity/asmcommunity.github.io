<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Using VPCID services - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=6054" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=6054">Using VPCID services</a></p>
   <div class="post" id="post-43368">
    <div class="subject"><a href="#post-43368">Using VPCID services</a></div>
    <div class="body">I am trying to write a serial port VxD. I think I am doing what supposed to be done, yet the interrupt service routine never runs.<br />Maybe someone can see what I am doing wrong or missed. All this is in a Vxd that does run. I have it send msgbox's at various points to see where its at.<br /><br />Here's where I build the IRQ_Descriptor<br />lea	edi, VP_Data<br />assume 	edi:ptr VPICD_IRQ_Descriptor<br />mov	eax, 04H ;&lt;- IRQ4 for COM1<br />mov	.VID_IRQ_Number, word ptr ax<br />mov	eax, VPICD_OPT_CAN_SHARE <br />mov	.VID_Options, word ptr ax<br />mov	eax, OFFSET32 IRQ4<br />mov	.VID_Hw_Int_Proc, dword ptr eax<br />mov	eax, 0H<br />mov	.VID_Virt_Int_Proc, dword ptr eax<br />mov	eax, 0H<br />mov	.VID_EOI_Proc, dword ptr eax<br />mov	eax, 0H<br />mov	.VID_Mask_Change_Proc, dword ptr eax<br />mov	eax, 0H<br />mov	.VID_IRET_Proc, dword ptr eax<br />mov	eax, 100<br />mov	.VID_IRET_Time_Out, dword ptr eax<br />mov	eax, 0H<br />mov	.VID_Hw_Int_Ref, dword ptr eax<br /><br />mov      edi, OFFSET32 VP_Data<br />VxDcall VPICD_Virtualize_IRQ<br />or         eax, eax<br />jz         Virt_Error	<br />mov      , eax<br /><br />here's where I unmask the interrupt (I think)<br />mov     eax, <br />VxDcall VPICD_Physically_Unmask<br /><br />here's where I trigger a interrupt<br />mov     eax, <br />mov     ebx, <br />VxDcall VPICD_Set_Int_Request			<br /><br /><br /><br />Last but not least, heres the interrupt handler<br />BeginProc IRQ4<br />cli<br />mov      eax, 1H<br />mov      , eax<br />mov      eax, <br />VxDcall  VPICD_Phys_EOI		<br />sti<br />stc <br />ret<br /><br />EndProc IRQ4<br /><br />I could really use some help here, cause it's dead in the water.<br /><br />Thanks,<br />sceptor</div>
    <div class="meta">Posted on 2002-06-14 17:17:56 by sceptor</div>
   </div>
   <div class="post" id="post-43451">
    <div class="subject"><a href="#post-43451">Using VPCID services</a></div>
    <div class="body">Hi sceptor,<br /><br />Interesting problem, just a couple of ideas, can you use VPICD_Get_Complete_Status and check the flags returned that the IRQ is actually physically unmasked, and that your interrupt is set?<br /><br />;----------------------<br />mov     eax, IRQHandle<br />mov     ebx, VMHandle<br />VxDcall VPICD_Get_Complete_Status<br />mov     , ecx<br /> <br />Retrieves the complete status for a virtual IRQ in a specified virtual machine. Uses ECX and Flags. <br />Returns a combination of these status flag values in ECX:<br /><br />VPICD_STAT_PHYS_MASK The IRQ is physically masked<br />VPICD_STAT_PHYS_REQ  The physical interrupt request has been set.  <br />;----------------------<br /><br /><br />The other thing you should check if you already haven't, is if your interrupt handler should go in a locked code segment VxD_LOCKED_CODE_SEG, which ISR routines should generally be in.  VPICD_Set_Int_Request simulates an interrupt in the virtual machine, but it may occur at a later time with VMMCall Simulate_Int, which waits for the VM to resume execution.  Your VPICD_IRQ_Descriptor data needs to be safe.<br /><br /><br />I've never done any IRQ programming so I may be off base, but from looking at the docs and your code, do you develop your code by simulating an interrupt, and change this to handle the data input from the serial port (as triggered by a real hardware interrupt).  Or do you detect an IRQ interrupt first with other code and simulate the interrupt as part of the calling procedure?  <br /><br />i.e. is VPICD_Set_Int_Request only used for development and debugging of your code, and this is a virtual interrupt, in which case your hook proc IRQ4 seems to be set in .VID_Hw_Int_Proc for a hardware interrupt.<br /><br />VID_Hw_Int_Proc <br />Address of the callback procedure that handles hardware interrupts for this IRQ. <br />VID_Virt_Int_Proc <br />Address of the callback procedure that handles virtual interrupts for this IRQ. <br /><br /><br /><br />I'm curious about the use of the VPICD_IRQ_Descriptor.VID_Options field.  When would you use VPICD_OPT_VIRT_INT_REJECT as a flag?<br />         <br />VPICD_OPT_VIRT_INT_REJECT<br />Within your virtual interrupt procedure, set this bit and return with the carry flag set if you no longer want the interrupt virtualized.  <br /><br />When would you want to do this?  When your code is ready for final use and you want to switch over to using VID_Hw_Int_Proc only instead of VID_Virt_Int_Proc? <br /><br /><br />There are a couple of other calls that seem associated with what you're doing that I wonder if you can't use:<br /><br />;----------------------<br />VID_Virt_Int_Proc<br />include vpicd.inc<br /><br />mov     eax, IRQHandle<br />mov     ebx, VMHandle<br />call    VID_Virt_Int_Proc<br /> <br />Handles virtual interrupts for a virtual device. The system calls the procedure whenever a simulated interrupt occurs. The procedure is useful for implementing critical sections around a simulated hardware interrupt. <br />;----------------------<br /><br />;----------------------<br />VPICD_Call_When_Hw_Int<br />include vpicd.inc<br /><br />pushfd<br />cli<br />mov     esi, OFFSET32 Callback<br />VxDcall VPICD_Call_When_Hw_Int<br />popfd<br />mov     , esi<br /> <br />Installs a callback procedure for hardware interrupts. The system calls the callback procedure whenever a hardware interrupt occurs. The caller must disable interrupts before calling this service. Uses ESI and Flags. <br />;----------------------<br /><br /><br />Don't know if any of this helped. <br /><br />Cheers,<br />Kayaker</div>
    <div class="meta">Posted on 2002-06-15 14:25:43 by Kayaker</div>
   </div>
  </div>
 </body>
</html>