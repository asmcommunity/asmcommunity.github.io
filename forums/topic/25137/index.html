<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Remove GUI [blah] - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=25137" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=25137">Remove GUI [blah]</a></p>
   <div class="post" id="post-184074">
    <div class="subject"><a href="#post-184074">Remove GUI [blah]</a></div>
    <div class="body">I am trying to remove the window in my applicaton, Not really interested in GUI developement except for the tray icon. I want my application to load and immediately be in the tray with the tray icon. Thats it. Not main window, as the win432 gui progamming is a bit new to me, I dont even know where to start ...<br /><br /><pre><code><br /><br /><br />; httpd.asm<br />; Portable HTTP Daemon<br /><br />; -- -----------------------------------------<br /><br />.586 <br />.MODEL flat, stdcall <br /><br />; Case sensitive<br />OPTION casemap :none<br /><br />; -------------------------------------------<br /><br />INCLUDE kernel32.inc<br />INCLUDE windows.inc<br />INCLUDE user32.inc<br />INCLUDE wsock32.inc<br />INCLUDE ole32.inc<br />INCLUDE shlwapi.inc<br />INCLUDE wininet.inc<br />INCLUDE advapi32.inc<br />INCLUDE urlmon.inc<br />INCLUDE shell32.inc<br />INCLUDE gdi32.inc<br />INCLUDE masm32.inc<br /><br />; -------------------------------------------<br /><br />INCLUDELIB masm32.lib<br />INCLUDELIB kernel32.lib<br />INCLUDELIB user32.lib<br />INCLUDELIB wsock32.lib<br />INCLUDELIB ole32.lib<br />INCLUDELIB shlwapi.lib<br />INCLUDELIB wininet.lib<br />INCLUDELIB advapi32.lib<br />INCLUDELIB urlmon.lib<br />INCLUDELIB shell32.lib<br />INCLUDELIB gdi32.lib<br /><br />; -------------------------------------------<br /><br />WM_SHELLNOTIFY	EQU	WM_USER+5<br />IDI_TRAY		EQU	0<br />IDM_EXIT		EQU	1010<br />IDM_MYIP		EQU	3<br />IDM_SETTINGS	EQU	4<br />IDM_ABOUT		EQU	5<br /><br />; Web Server Port Number to bind to<br />MYPORT		EQU	80<br /><br />; -------------------------------------------<br /><br />; Various Prototypes<br />WinMain		PROTO :DWORD,:DWORD,:DWORD,:DWORD<br />WSAStartup		PROTO wVersionRequested:DWORD, lpWSAData:DWORD<br />WSACleanup		PROTO<br />OpenHomepage	PROTO<br />OpenSettings	PROTO<br />About			PROTO<br />CreateXML		PROTO<br /><br />; -------------------------------------------<br /><br />.CONST<br /><br />; -------------------------------------------<br /><br />; XML Configuration File Prototype<br />szXMLData	DB	&quot;&lt;?xml version=&#39;1.0&#39; encoding=&#39;utf-8&#39; ?&gt;&quot;,0<br />		DB	&quot;&lt;HTTPD&gt;&quot;,0<br />		DB	&quot;&lt;configuration&gt;&quot;,0<br />		DB	&quot;&lt;config key=&#39;Port&#39;&gt;80&lt;/config&gt;&quot;,0<br />		DB	&quot;&lt;config key=&#39;RegistryEnabled&#39;&gt;0&lt;/config&gt;&quot;,0<br />		DB	&quot;&lt;/configuration&gt;&quot;,0<br />		DB	&quot;&lt;/HTTPD&gt;&quot;,0,0<br />		<br />szCaption	DB	&quot; HTTP Server&quot;,0 <br />szBoxText	DB	&quot; HTTP Server Successfully Started&quot;,0 <br />szURL		DB	&quot;http://www.murderdesign.com&quot;,0<br />szXMLConf	DB	&quot;Configuration.xml&quot;,0<br /><br />.DATA?<br /><br />; -------------------------------------------<br /><br />; Networking stuff<br />wsaData	WSADATA	&lt;?&gt;<br />sockAddr	sockaddr_in	&lt;?&gt;<br /><br />; -------------------------------------------<br /><br />; WSAData Error Infobox test<br />szBox		DB	?<br /><br />; -------------------------------------------<br /><br />; Various Handles<br />hTemp			DD	?<br />hInstance		DD	?<br />hPopupMenu		DD	?<br /><br />note			NOTIFYICONDATA	&lt;&gt;<br />iconData		NOTIFYICONDATA	&lt;?&gt;<br /><br />.DATA<br /><br />; Temporary Buffer<br />bTemp			DB	512 DUP(0)<br /><br />szClassName		DB	&quot;TrayIconWinClass&quot;,0<br />szAppName		DB	&quot;HTTPD Settings&quot;,0<br />szIP			DB	&quot;My IP&quot;,0<br />szSettings		DB	&quot;Settings&quot;,0<br />szAbout		DB	&quot;About&quot;,0<br />szExit		DB	&quot;Exit&quot;,0<br />szWebSettings	DB	&quot;http://localhost/?settings&quot;,0<br />szSubkey		DB	&quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Run&quot;,0<br />szName		DB	&quot;Portable HTTP Server&quot;,0<br />szPath		DB	&quot;C:\httpd.exe&quot;,0<br /><br />; -------------------------------------------<br /><br />.CODE<br /><br />; -------------------------------------------<br /><br />; Waits until connected to Internet<br />WaitUntilConnected PROC<br />	INVOKE InternetGetConnectedState, 0, 0<br />	CMP EAX, 0<br />	JZ @F <br />	@@:<br />		INVOKE Sleep, 2000<br />		JMP @B<br />	RET<br />WaitUntilConnected ENDP<br /><br />; -------------------------------------------<br /><br />; Notify user that the server has been initialized<br />About PROC<br />	; gethostbyname<br />	INVOKE MessageBox, NULL, ADDR szBoxText, ADDR szCaption, MB_OK <br />	RET<br />About ENDP<br /><br />; -------------------------------------------<br /><br />; Notify user that the server has been initialized<br />MyIP PROC<br />	; gethostbyname<br />	INVOKE MessageBox, NULL, ADDR szBoxText, ADDR szCaption, MB_OK <br />	RET<br />MyIP ENDP<br /><br />; -------------------------------------------<br /><br />; Add Registry Entries for Autorun<br />WriteAutoStart PROC<br />	INVOKE&nbsp; RegCreateKeyEx, HKEY_CURRENT_USER, ADDR szSubkey, 0, 0, 0, KEY_WRITE, 0, ADDR hTemp, 0<br />	CMP&nbsp; &nbsp;  EAX, ERROR_SUCCESS<br />	JNE&nbsp; &nbsp;  @F<br />	INVOKE&nbsp; RegSetValueEx, , ADDR szName, 0, REG_SZ, ADDR szPath, SIZEOF szPath<br />	INVOKE&nbsp; RegCloseKey, <br />	@@:<br />	RET<br />WriteAutoStart ENDP<br /><br />; -------------------------------------------<br /><br />; Settings Window<br />WinMain PROC hInst:HINSTANCE, hPrevInst:HINSTANCE, CmdLine:LPSTR, CmdShow:DWORD<br />	LOCAL wc:WNDCLASSEX<br />	LOCAL msg:MSG<br />	LOCAL hwnd:HWND<br />	MOV&nbsp;  wc.cbSize, SIZEOF WNDCLASSEX<br />	MOV&nbsp;  wc.style, CS_HREDRAW OR CS_VREDRAW OR CS_DBLCLKS<br />	MOV&nbsp;  wc.lpfnWndProc, OFFSET WndProc<br />	MOV&nbsp;  wc.cbClsExtra, NULL<br />	MOV&nbsp;  wc.cbWndExtra, NULL<br />	PUSH&nbsp; hInst<br />	POP&nbsp;  wc.hInstance<br />	MOV&nbsp;  wc.hbrBackground, COLOR_APPWORKSPACE<br />	MOV&nbsp;  wc.lpszMenuName, NULL<br />	MOV&nbsp;  wc.lpszClassName, OFFSET szClassName<br />	; Set Windows title icon<br />	INVOKE LoadIcon, hInstance, 2<br />	MOV&nbsp;  wc.hIcon, EAX<br />	MOV&nbsp;  wc.hIconSm, EAX<br />	MOV&nbsp;  note.hIcon, EAX<br />	INVOKE LoadCursor, NULL, IDC_ARROW<br />	MOV&nbsp;  wc.hCursor, EAX<br />	INVOKE RegisterClassEx, ADDR wc<br />	INVOKE CreateWindowEx,<br />		WS_EX_CLIENTEDGE,<br />		ADDR szClassName,ADDR szAppName,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  WS_OVERLAPPED+WS_CAPTION+WS_SYSMENU+WS_MINIMIZEBOX+WS_MAXIMIZEBOX+WS_VISIBLE,CW_USEDEFAULT,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  CW_USEDEFAULT,350,200,NULL,NULL,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  hInst, NULL<br />	MOV&nbsp;  hwnd, EAX<br />	.WHILE TRUE<br />		INVOKE GetMessage, ADDR msg,NULL,0,0<br />		.BREAK .IF (!EAX)<br />		INVOKE TranslateMessage, ADDR msg<br />		INVOKE DispatchMessage, ADDR msg<br />	.ENDW<br />	MOV eax,msg.wParam<br />	RET<br />WinMain ENDP<br /><br />; -------------------------------------------<br /><br />WndProc PROC hWnd:HWND, uMsg:UINT, wParam:WPARAM, lParam:LPARAM<br />	LOCAL pt:POINT<br />	LOCAL rect:RECT<br />	; Program was just launched<br />	.IF uMsg == WM_CREATE<br />		; Create PopUp menu for right clicking<br />		INVOKE CreatePopupMenu<br />		MOV hPopupMenu, EAX<br />		; Add menu items to the popup<br />		INVOKE AppendMenu, hPopupMenu, MF_STRING, IDM_MYIP, ADDR szIP<br />		INVOKE AppendMenu, hPopupMenu, MF_SEPARATOR, NULL, NULL<br />		INVOKE AppendMenu, hPopupMenu, MF_GRAYED, IDM_ABOUT, ADDR szAbout<br />		INVOKE AppendMenu, hPopupMenu, MF_SEPARATOR, NULL, NULL<br />		INVOKE AppendMenu, hPopupMenu, MF_GRAYED, IDM_SETTINGS, ADDR szSettings<br />		INVOKE AppendMenu, hPopupMenu, MF_SEPARATOR, NULL, NULL<br />		INVOKE AppendMenu, hPopupMenu, MF_STRING, IDM_EXIT, ADDR szExit<br />	; Destroy popup menu<br />	.ELSEIF uMsg == WM_DESTROY<br />		INVOKE DestroyMenu, hPopupMenu<br />		INVOKE PostQuitMessage, NULL<br />	.ELSEIF uMsg == WM_SIZE<br />		.IF wParam == SIZE_MINIMIZED<br />			MOV note.cbSize, SIZEOF NOTIFYICONDATA<br />			PUSH hWnd<br />			POP note.hwnd<br />			MOV note.uID,IDI_TRAY<br />			MOV note.uFlags, NIF_ICON+NIF_MESSAGE+NIF_TIP<br />			MOV note.uCallbackMessage, WM_SHELLNOTIFY<br />			INVOKE LoadIcon, hInstance, 2<br />			MOV note.hIcon, EAX<br />			INVOKE lstrcpy, ADDR note.szTip, ADDR szAppName<br />			INVOKE ShowWindow, hWnd, SW_HIDE<br />			INVOKE Shell_NotifyIcon, NIM_ADD, ADDR note<br />		.ENDIF<br />	.ELSEIF uMsg == WM_COMMAND<br />		.IF lParam == 0<br />			INVOKE Shell_NotifyIcon, NIM_DELETE, ADDR note<br />			MOV EAX, wParam<br />			.IF AX == IDM_MYIP<br />				INVOKE MyIP<br />			.ELSEIF AX == IDM_SETTINGS<br />				INVOKE OpenSettings<br />			.ELSEIF AX == IDM_ABOUT<br />				INVOKE About<br />			.ELSE<br />				INVOKE DestroyWindow, hWnd<br />			.ENDIF<br />		.ENDIF<br />	.ELSEIF uMsg == WM_SHELLNOTIFY<br />		.IF wParam == IDI_TRAY<br />			.IF lParam == WM_RBUTTONDOWN<br />				INVOKE GetCursorPos, ADDR pt<br />				INVOKE SetForegroundWindow, hWnd<br />				INVOKE TrackPopupMenu, hPopupMenu, TPM_RIGHTALIGN OR TPM_RIGHTBUTTON, pt.x, pt.y, NULL, hWnd, NULL<br />				INVOKE PostMessage, hWnd, WM_NULL, 0, 0<br />			.ELSEIF lParam == WM_LBUTTONDBLCLK<br />				INVOKE SendMessage, hWnd, WM_COMMAND, IDM_MYIP, 0<br />			.ENDIF<br />		.ENDIF<br />	.ELSE<br />		INVOKE DefWindowProc, hWnd, uMsg, wParam, lParam		<br />		RET<br />	.ENDIF<br />	; EAX = 0<br />	XOR EAX, EAX<br />	RET<br />WndProc ENDP<br /><br />; -------------------------------------------<br /><br />; Open Browser to software homepage<br />OpenHomepage PROC<br />	INVOKE ShellExecute, NULL, NULL, ADDR szURL, NULL, NULL, SW_SHOWNORMAL<br />	INVOKE ExitProcess, NULL<br />OpenHomepage ENDP<br /><br />; -------------------------------------------<br /><br />; Open Browser to software homepage<br />OpenSettings PROC<br />	INVOKE ShellExecute, NULL, NULL, ADDR szWebSettings, NULL, NULL, SW_SHOWNORMAL<br />	INVOKE ExitProcess, NULL<br />OpenSettings ENDP<br /><br />; -------------------------------------------<br /><br />; Initialize Web Server<br />HTTPD PROC<br />	; Start Winsock<br />	INVOKE WSAStartup, 0002h, ADDR wsaData<br />	; Test if winsock started by seeing if there was an error value in EAX<br />	TEST EAX, EAX<br />	JZ startupSucceeded<br />	; Error handling code goes below<br />	INVOKE MessageBox, NULL, ADDR szBox, ADDR szCaption, MB_OK <br />	startupSucceeded:<br />		; check lower byte of wVersion (major version number)<br />		CMP BYTE PTR , 2<br />		JAE versionOK<br />		; Error: version &lt; 2<br />		; Winsock still has to be cleaned up though:<br />		JMP doCleanup<br />		RET<br />	versionOK:<br />		; Call winsock functions here<br />		RET<br />	doCleanup:<br />		INVOKE WSACleanup<br />		TEST EAX, EAX<br />		JZ cleanupSucceeded<br />		; Error Handling Code goes below<br />	cleanupSucceeded:<br />		RET<br />HTTPD ENDP<br /><br />; -------------------------------------------<br /><br />; Create XML Configuration File<br />CreateXML PROC<br />	; Local Variables<br />	LOCAL hXMLConf	:DWORD	; File Handle<br />	LOCAL fSize		:DWORD	; File Size<br />	LOCAL	BWRTN		:DWORD	; Bytes Written<br />	LOCAL hMem		:DWORD	; Memory Handle<br />	; Create XML Configuration File<br />	INVOKE CreateFile,ADDR szXMLConf,<br />				GENERIC_READ,<br />				FILE_SHARE_READ,<br />				NULL,<br />				OPEN_ALWAYS,<br />				FILE_ATTRIBUTE_ARCHIVE,<br />				NULL<br />	; Place the XML File Handle in hXMLConf<br />	MOV hXMLConf, EAX<br />	; Get The XML Configuration File Size<br />	INVOKE GetFileSize, hXMLConf, NULL<br />	MOV fSize, EAX<br />	SUB fSize, 1<br />	; Allocate enough memory for the file<br />	INVOKE GlobalAlloc, GMEM_FIXED, fSize<br />	MOV hMem, EAX<br />	INVOKE ReadFile, hXMLConf, hMem, fSize, ADDR BWRTN, NULL<br />	INVOKE MessageBox, 0, hMem, ADDR szCaption, 0<br />	; Close The File Handle<br />	INVOKE CloseHandle, hXMLConf<br />	; Free the Allocated Memory<br />	INVOKE GlobalFree, hMem<br />	RET<br />CreateXML ENDP<br /><br />; -------------------------------------------<br /><br />Execute:<br />	; Get this programs handle<br />	INVOKE GetModuleHandle, NULL<br />	MOV hInstance, EAX<br />	INVOKE WinMain, hInstance, NULL, NULL, SW_SHOWDEFAULT<br />	INVOKE ExitProcess, EAX<br />END Execute<br /><br />; -------------------------------------------<br /><br /><br /><br /><br /></code></pre></div>
    <div class="meta">Posted on 2006-07-28 10:32:07 by p0wder</div>
   </div>
   <div class="post" id="post-184075">
    <div class="subject"><a href="#post-184075">Re: Remove GUI [blah]</a></div>
    <div class="body">Well, you could remove the WS_VISIBLE flag from your main window and do the Shell_NotifyIcon in the WM_CREATE handler.</div>
    <div class="meta">Posted on 2006-07-28 11:15:10 by JimmyClif</div>
   </div>
   <div class="post" id="post-184076">
    <div class="subject"><a href="#post-184076">Re: Remove GUI [blah]</a></div>
    <div class="body">Also, please consider using &quot;attach file&quot; for snippets as long as this instead of posting inline :)</div>
    <div class="meta">Posted on 2006-07-28 12:15:49 by f0dder</div>
   </div>
   <div class="post" id="post-184080">
    <div class="subject"><a href="#post-184080">Re: Remove GUI [blah]</a></div>
    <div class="body">But what am I looking for exactly to remove this? which parts of the code ... i dont even want to get involved with a gui. i am building a web server, which is administered via a web based interface, so i dont even want the code there .. just confusing while i try to learn ... thanks in advance</div>
    <div class="meta">Posted on 2006-07-28 12:42:15 by p0wder</div>
   </div>
   <div class="post" id="post-184081">
    <div class="subject"><a href="#post-184081">Re: Remove GUI [blah]</a></div>
    <div class="body">Well, obviously you need a window (although not necessarily a visible one) since you want a tray icon. You have a CreateWindowEx call for this. For this call, WS_VISIBLE is specified as one of the flags; remove this flag.<br /></div>
    <div class="meta">Posted on 2006-07-28 12:45:26 by f0dder</div>
   </div>
   <div class="post" id="post-184082">
    <div class="subject"><a href="#post-184082">Re: Remove GUI [blah]</a></div>
    <div class="body">Also, have another look at this piece of your code:<br /><br /><pre><code><br />INVOKE GetFileSize, hXMLConf, NULL<br />MOV fSize, EAX<br />SUB fSize, 1<br />; Allocate enough memory for the file<br />INVOKE GlobalAlloc, GMEM_FIXED, fSize<br />MOV hMem, EAX<br />INVOKE ReadFile, hXMLConf, hMem, fSize, ADDR BWRTN, NULL<br /></code></pre><br /><br />So you have the Size of the File. You deduct 1 from it and then you read less than the file is long into that exact same size of Memory? That is asking for trouble. It is possible that one day the 0 terminator of the File gets cut off, and the last byte in you buffer will be a char and upon scanning for the end your app crashes.<br /><br /></div>
    <div class="meta">Posted on 2006-07-28 13:16:28 by JimmyClif</div>
   </div>
   <div class="post" id="post-184083">
    <div class="subject"><a href="#post-184083">Re: Remove GUI [blah]</a></div>
    <div class="body">I already pointed out those errors <a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=25117.0">in another thread</a> :)<br /></div>
    <div class="meta">Posted on 2006-07-28 13:22:02 by f0dder</div>
   </div>
   <div class="post" id="post-184086">
    <div class="subject"><a href="#post-184086">Re: Remove GUI [blah]</a></div>
    <div class="body">Didn&#39;t see that thread. Good job. <img src="http://boards1.wizards.com/images/smilies/ThumbUp.gif" /><br /><br />Won&#39;t hurt pointing them out again as they&#39;re still not fixed though :lol:</div>
    <div class="meta">Posted on 2006-07-28 13:37:50 by JimmyClif</div>
   </div>
   <div class="post" id="post-184087">
    <div class="subject"><a href="#post-184087">Re: Remove GUI [blah]</a></div>
    <div class="body"><div class="quote"><br />Didn&#39;t see that thread. Good job. <img src="http://boards1.wizards.com/images/smilies/ThumbUp.gif" /><br /><br />Won&#39;t hurt pointing them out again as they&#39;re still not fixed though :lol:<br /></div><br />Yup - hence the link... and good that you pointed it out too, the more the merrier ^_^<br /></div>
    <div class="meta">Posted on 2006-07-28 13:40:21 by f0dder</div>
   </div>
  </div>
 </body>
</html>