<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>I can't get GetOpenFileName to work properly - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=8170" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=8170">I can't get GetOpenFileName to work properly</a></p>
   <div class="post" id="post-59823">
    <div class="subject"><a href="#post-59823">I can't get GetOpenFileName to work properly</a></div>
    <div class="body">I got it to work, but then when I exit , it doesn't really exit, the program is still there. I removed the GetOpenFileName code, and it worked fine. I think it has something to do with memory but I'm not sure........</div>
    <div class="meta">Posted on 2002-09-27 14:16:10 by CyberGuy</div>
   </div>
   <div class="post" id="post-59869">
    <div class="subject"><a href="#post-59869">I can't get GetOpenFileName to work properly</a></div>
    <div class="body">Probably your messing with the stack. It's probably an unbalanced stack. Or your application is not calling PostQuitMessage or something. If you can post some code, that would be nice than just guessing here.<br /><br />Here's a sample program to do just that. Though I have stripped this program from its features because this is a personal project.<br /><br />Note: To move the window around, just drag any part of the window excluding on the edit and button controls part.<br /><br />Warning: The code style may not be to your liking but don't worry, the important parts are the ones you should look at.<br /><br /><br /><br /><br /><br /><br /><br /><br />and the call to GetOpenFileName.<br /><br />Tested on Win2k SP3.</div>
    <div class="meta">Posted on 2002-09-28 01:34:27 by stryker</div>
   </div>
   <div class="post" id="post-59895">
    <div class="subject"><a href="#post-59895">I can't get GetOpenFileName to work properly</a></div>
    <div class="body">Thanks for the example, but i still can't figure out whats wrong<br />Sorry for not posting the code, here it is:<pre><code>format PE GUI 4.0<br />entry start<br /><br />include 'include\kernel.inc'<br />include 'include\user.inc'<br />include 'include\comdlg.inc'<br />include 'include\gdi.inc'<br /><br />include 'include\macro\stdcall.inc'<br />include 'include\macro\import.inc'<br />include 'include\macro\resource.inc'<br /><br />section '.data' data readable writeable<br /><br />  var1 dw 0<br />  mainhwnd dd 0                         ; handle of window<br />  hinstance dd 0                        ; handle of module<br />  edit dd 0<br />  msg MSG<br />  wc WNDCLASS<br />  size RECT<br />deffont LOGFONT<br />font_face db 'MS Sans Serif',0<br />dopen OPENFILENAME<br /><br />  _title db 'My Notepad',0<br />  _class db 'FASMWIN32',0<br /><br />_edit db 'EDIT',0<br />_filter db &quot;Text Files &#40;*.txt&#41;&quot;,0,&quot;*.txt&quot;,0<br />default_extension db 'TXT',0<br /><br />OPEN = 932<br />SAVE = 933<br />SAVEAS = 934<br />EXIT = 935<br />COPY = 936<br />PASTE = 937<br />CUT = 938<br />ALL = 939<br />UNDO = 940<br /><br />section '.code' code readable executable<br /><br />  start&#58;<br /><br />        invoke  GetModuleHandle,0<br />        mov     &#91;hinstance&#93;,eax<br />        invoke  LoadIcon,0,IDI_APPLICATION<br />        mov     &#91;wc.hIcon&#93;,eax<br />        invoke  LoadCursor,0,IDC_ARROW<br />        mov     &#91;wc.hCursor&#93;,eax<br />        mov     &#91;wc.style&#93;,0<br />        mov     &#91;wc.lpfnWndProc&#93;,WindowProc<br />        mov     &#91;wc.cbClsExtra&#93;,0<br />        mov     &#91;wc.cbWndExtra&#93;,0<br />        mov     eax,&#91;hinstance&#93;<br />        mov     &#91;wc.hInstance&#93;,eax<br />        mov     &#91;wc.hbrBackground&#93;,COLOR_BTNFACE+1<br />        mov     &#91;wc.lpszMenuName&#93;,0<br />        mov     &#91;wc.lpszClassName&#93;,_class<br />        invoke  RegisterClass,wc<br /><br />        invoke  LoadMenu,&#91;hinstance&#93;,29<br />        invoke  CreateWindowEx,0,_class,_title,WS_MINIMIZEBOX+WS_THICKFRAME+WS_MAXIMIZEBOX+WS_SYSMENU,78,78,640,480,NULL,eax,&#91;hinstance&#93;,NULL<br />        mov     &#91;mainhwnd&#93;,eax<br />        invoke ShowWindow,&#91;mainhwnd&#93;,SW_SHOWDEFAULT<br />  msg_loop&#58;<br />        invoke  GetMessage,msg,NULL,0,0<br />        or      eax,eax<br />        jz      end_loop<br />        invoke  TranslateMessage,msg<br />        invoke  DispatchMessage,msg<br />        jmp     msg_loop<br /><br />  end_loop&#58;<br />        invoke  ExitProcess,&#91;msg.wParam&#93;<br /><br />proc WindowProc, hwnd,wmsg,wparam,lparam<br />        enter<br />        push    ebx esi edi<br />        cmp     &#91;wmsg&#93;,WM_DESTROY<br />        je      wmdestroy<br />        cmp     &#91;wmsg&#93;,WM_CREATE<br />        je      wmcreate<br />        cmp     &#91;wmsg&#93;,WM_SIZE<br />        je      wmsize<br />        cmp     &#91;wmsg&#93;,WM_COMMAND<br />        je      wmcommand<br />  defwndproc&#58;<br />        invoke  DefWindowProc,&#91;hwnd&#93;,&#91;wmsg&#93;,&#91;wparam&#93;,&#91;lparam&#93;<br />        jmp     finish<br />  wmcreate&#58;<br />        invoke GetClientRect,&#91;hwnd&#93;,size<br />        invoke CreateWindowEx,WS_EX_CLIENTEDGE,_edit,0,WS_CHILD+ES_MULTILINE+WS_VSCROLL+WS_HSCROLL,&#91;size.left&#93;,&#91;size.top&#93;,&#91;size.right&#93;,&#91;size.bottom&#93;,&#91;hwnd&#93;,NULL,&#91;hinstance&#93;,NULL<br />        mov     &#91;edit&#93;,eax<br />        invoke ShowWindow,eax,SW_SHOWDEFAULT<br />        mov     &#91;dopen.lStructSize&#93;,dopen.size<br />        mov     eax,&#91;edit&#93;<br />        mov     &#91;dopen.hwndOwner&#93;,eax<br />        mov     eax,&#91;hinstance&#93;<br />        mov     &#91;dopen.hInstance&#93;,eax<br />        mov     &#91;dopen.lpstrFilter&#93;,_filter<br />        mov     &#91;dopen.lpstrCustomFilter&#93;,NULL<br />        mov     &#91;dopen.nFilterIndex&#93;,1<br />        mov     &#91;dopen.lpstrFileTitle&#93;,_title<br />        mov     &#91;dopen.nMaxFileTitle&#93;,100h<br />        mov     &#91;dopen.lpstrInitialDir&#93;,NULL<br />        mov     &#91;dopen.lpstrDefExt&#93;,default_extension<br /><br />        mov     &#91;deffont.lfHeight&#93;,10h<br />        mov     &#91;deffont.lfWidth&#93;,0<br />        mov     &#91;deffont.lfEscapement&#93;,0<br />        mov     &#91;deffont.lfOrientation&#93;,0<br />        mov     &#91;deffont.lfWeight&#93;,400<br />        mov     &#91;deffont.lfItalic&#93;,FALSE<br />        mov     &#91;deffont.lfUnderline&#93;,FALSE<br />        mov     &#91;deffont.lfStrikeOut&#93;,FALSE<br />        mov     &#91;deffont.lfCharSet&#93;,ANSI_CHARSET<br />        mov     &#91;deffont.lfOutPrecision&#93;,OUT_RASTER_PRECIS<br />        mov     &#91;deffont.lfClipPrecision&#93;,CLIP_DEFAULT_PRECIS<br />        mov     &#91;deffont.lfQuality&#93;,DEFAULT_QUALITY<br />        mov     &#91;deffont.lfPitchAndFamily&#93;,FF_SWISS<br />        mov     edi,deffont.lfFaceName<br />        mov     esi,font_face<br />        invoke CreateFontIndirect,deffont<br />        mov edx,eax<br />        invoke  SendMessage,&#91;edit&#93;,WM_SETFONT,edx,0<br />        jmp finish<br />  wmsize&#58;<br />        invoke GetClientRect,&#91;hwnd&#93;,size<br />        invoke MoveWindow,&#91;edit&#93;,&#91;size.left&#93;,&#91;size.top&#93;,&#91;size.right&#93;,&#91;size.bottom&#93;,TRUE<br />        xor eax,eax<br />        jmp finish<br />  wmcommand&#58;<br />        mov eax,&#91;wparam&#93;<br />        and eax,0FFFh<br />        cmp eax,EXIT<br />        je wmdestroy<br />        cmp eax,OPEN<br />        je open<br />        cmp eax,CUT<br />        je cut<br />        cmp eax,COPY<br />        je copy<br />        cmp eax,PASTE<br />        je paste<br />        cmp eax,UNDO<br />        je undo<br />        cmp eax,ALL<br />        je all<br />        jmp defwndproc<br />  wmdestroy&#58;<br />        invoke  PostQuitMessage,0<br />        xor     eax,eax<br />  open&#58;<br />        invoke GetOpenFileName,dopen<br />        jmp finish<br />  cut&#58;<br />        invoke  SendMessage,&#91;edit&#93;,WM_CUT,0,0<br />        jmp finish<br />  copy&#58;<br />        invoke  SendMessage,&#91;edit&#93;,WM_COPY,0,0<br />        jmp finish<br />  paste&#58;<br />        ;Not done yet<br />        jmp finish<br />  undo&#58;<br />        invoke  SendMessage,&#91;edit&#93;,EM_UNDO,0,0<br />        jmp finish<br />  all&#58;<br />        invoke SendMessage,&#91;edit&#93;,WM_KEYDOWN,VK_SHIFT+VK_DOWN,15<br />        jmp finish<br />  finish&#58;<br />        pop     edi esi ebx<br />        return<br /><br /><br /><br />section '.idata' import data readable writeable<br /><br />  library kernel,'KERNEL32.DLL',\<br />          user,'USER32.DLL',\<br />          comdlg,'COMDLG32.DLL',\<br />          gdi,'GDI32.DLL'<br /><br />  kernel&#58;<br />  import GetModuleHandle,'GetModuleHandleA',\<br />         strcpy,'lstrcpy',\<br />         strcpyn,'lstrcpyn',\<br />         strlen,'lstrlen',\<br />         strcat,'lstrcat',\<br />         VirtualAlloc,'VirtualAlloc',\<br />         VirtualFree,'VirtualFree',\<br />         ExitProcess,'ExitProcess'<br /><br />  user&#58;<br />  import RegisterClass,'RegisterClassA',\<br />         CreateWindowEx,'CreateWindowExA',\<br />         DefWindowProc,'DefWindowProcA',\<br />         GetClientRect,'GetClientRect',\<br />         SendMessage,'SendMessageA',\<br />         GetMessage,'GetMessageA',\<br />         MoveWindow,'MoveWindow',\<br />         ShowWindow,'ShowWindow',\<br />         TranslateMessage,'TranslateMessage',\<br />         DispatchMessage,'DispatchMessageA',\<br />         LoadCursor,'LoadCursorA',\<br />         MessageBox,'MessageBoxA',\<br />         LoadIcon,'LoadIconA',\<br />         LoadMenu,'LoadMenuA',\<br />         PostQuitMessage,'PostQuitMessage' \<br /><br />  comdlg&#58;<br />  import GetOpenFileName,'GetOpenFileNameA'<br /><br />  gdi&#58;<br />  import CreateFontIndirect,'CreateFontIndirectA'<br /><br />section '.rsrc' resource data readable<br /><br />  directory RT_MENU,menus<br /><br />  menus&#58;<br />  resource 29,LANG_ENGLISH+SUBLANG_DEFAULT,main<br /><br />  menu main<br />       menuitem '&amp;File',0,MFR_POPUP<br />                menuitem '&amp;Open',OPEN,0<br />                menuitem '&amp;Save',SAVE,0<br />                menuitem 'S&amp;ave as...',SAVEAS,0<br />                menuseparator<br />                menuitem 'E&amp;xit',EXIT,MFR_END<br />       menuitem '&amp;Edit',0,MFR_POPUP+MFR_END<br />                menuitem '&amp;Undo',UNDO,0<br />                menuitem '&amp;Copy Ctrl+C',COPY,0<br />                menuitem 'C&amp;ut Ctrl+X',CUT,0<br />                menuitem '&amp;Paste Ctrl+V',PASTE,0<br />                menuseparator<br />                menuitem '&amp;Select All Ctrl+A',ALL,MFR_END</code></pre></div>
    <div class="meta">Posted on 2002-09-28 11:07:43 by CyberGuy</div>
   </div>
   <div class="post" id="post-59900">
    <div class="subject"><a href="#post-59900">I can't get GetOpenFileName to work properly</a></div>
    <div class="body">The problem is how you setup the WindowProc procedure, there were some messages that are not returning 0, another thing was, you're jumping to DefWindowProc during a WM_COMMAND. I've edited parts of it, so it looks a liitle more readable.<pre><code>&#91;size=9&#93;proc WindowProc, hwnd,wmsg,wparam,lparam<br /><br />    enter<br /><br />    push    ebx<br />    push    esi<br />    push    edi<br /><br />    cmp     &#91;wmsg&#93;, WM_DESTROY<br />    je      wmdestroy<br />    cmp     &#91;wmsg&#93;, WM_CREATE<br />    je      wmcreate<br />    cmp     &#91;wmsg&#93;, WM_SIZE<br />    je      wmsize<br />    cmp     &#91;wmsg&#93;, WM_COMMAND<br />    je      wmcommand<br /><br />    invoke  DefWindowProc,&#91;hwnd&#93;,&#91;wmsg&#93;,&#91;wparam&#93;,&#91;lparam&#93;<br />    pop     edi<br />    pop     esi<br />    pop     ebx<br />    return<br /><br />    wmcreate&#58;<br /><br />        invoke  GetClientRect,&#91;hwnd&#93;,size<br />        invoke  CreateWindowEx, WS_EX_CLIENTEDGE, _edit, 0, WS_CHILD+ES_MULTILINE+WS_VSCROLL+WS_HSCROLL, \<br />                                &#91;size.left&#93;, &#91;size.top&#93;, &#91;size.right&#93;, &#91;size.bottom&#93;, &#91;hwnd&#93;, NULL, \<br />                                &#91;hinstance&#93;, NULL<br />        mov     &#91;edit&#93;,eax<br />        invoke  ShowWindow,eax,SW_SHOWDEFAULT<br />        mov     &#91;dopen.lStructSize&#93;,dopen.size<br />        mov     eax,&#91;edit&#93;<br />        mov     &#91;dopen.hwndOwner&#93;,eax<br />        mov     eax,&#91;hinstance&#93;<br />        mov     &#91;dopen.hInstance&#93;,eax<br />        mov     &#91;dopen.lpstrFilter&#93;,_filter<br />        mov     &#91;dopen.lpstrCustomFilter&#93;,NULL<br />        mov     &#91;dopen.nFilterIndex&#93;,1<br />        mov     &#91;dopen.lpstrFileTitle&#93;,_title<br />        mov     &#91;dopen.nMaxFileTitle&#93;,100h<br />        mov     &#91;dopen.lpstrInitialDir&#93;,NULL<br />        mov     &#91;dopen.lpstrDefExt&#93;,default_extension<br />        mov     &#91;deffont.lfHeight&#93;,10h<br />        mov     &#91;deffont.lfWidth&#93;,0<br />        mov     &#91;deffont.lfEscapement&#93;,0<br />        mov     &#91;deffont.lfOrientation&#93;,0<br />        mov     &#91;deffont.lfWeight&#93;,400<br />        mov     &#91;deffont.lfItalic&#93;,FALSE<br />        mov     &#91;deffont.lfUnderline&#93;,FALSE<br />        mov     &#91;deffont.lfStrikeOut&#93;,FALSE<br />        mov     &#91;deffont.lfCharSet&#93;,ANSI_CHARSET<br />        mov     &#91;deffont.lfOutPrecision&#93;,OUT_RASTER_PRECIS<br />        mov     &#91;deffont.lfClipPrecision&#93;,CLIP_DEFAULT_PRECIS<br />        mov     &#91;deffont.lfQuality&#93;,DEFAULT_QUALITY<br />        mov     &#91;deffont.lfPitchAndFamily&#93;,FF_SWISS<br />        mov     edi,deffont.lfFaceName<br />        mov     esi,font_face<br />        invoke  CreateFontIndirect,deffont<br />        mov     edx,eax<br />        invoke  SendMessage,&#91;edit&#93;,WM_SETFONT,edx,0<br />        jmp     finish<br /><br />    wmsize&#58;<br /><br />        invoke  GetClientRect,&#91;hwnd&#93;,size<br />        invoke  MoveWindow,&#91;edit&#93;,&#91;size.left&#93;,&#91;size.top&#93;,&#91;size.right&#93;,&#91;size.bottom&#93;,TRUE<br />        jmp     finish<br /><br />    wmcommand&#58;<br /><br />        cmp     &#91;lparam&#93;, 0<br />        jne     finish<br /><br />        mov     eax,&#91;wparam&#93;<br />        and     eax,0FFFh<br />        cmp     eax,EXIT<br />        je      wmdestroy<br />        cmp     eax,OPEN<br />        je      open<br />        cmp     eax,CUT<br />        je      cut<br />        cmp     eax,COPY<br />        je      copy<br />        cmp     eax,PASTE<br />        je      paste<br />        cmp     ax,UNDO<br />        je      undo<br />        cmp     eax,ALL<br />        je      all<br /><br />        open&#58;<br /><br />            invoke GetOpenFileName,dopen<br />            jmp finish<br /><br />        cut&#58;<br /><br />            invoke SendMessage,&#91;edit&#93;,WM_CUT,0,0<br />            jmp finish<br /><br />        copy&#58;<br /><br />            invoke SendMessage,&#91;edit&#93;,WM_COPY,0,0<br />            jmp finish<br /><br />        paste&#58;<br /><br />            ;Not done yet<br />            jmp finish<br /><br />        undo&#58;<br /><br />            invoke SendMessage,&#91;edit&#93;,EM_UNDO,0,0<br />            jmp finish<br /><br />        all&#58;<br /><br />            invoke SendMessage,&#91;edit&#93;,WM_KEYDOWN,VK_SHIFT+VK_DOWN,15<br />            jmp finish<br /><br />    wmdestroy&#58;<br /><br />        invoke PostQuitMessage,0<br /><br />    finish&#58;<br /><br />        xor eax,eax<br />        pop edi esi ebx<br />        return&#91;/size&#93;</code></pre></div>
    <div class="meta">Posted on 2002-09-28 13:09:47 by stryker</div>
   </div>
  </div>
 </body>
</html>