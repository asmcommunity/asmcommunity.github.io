<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>breakpoint alters result..?! - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=17949" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=17949">breakpoint alters result..?!</a></p>
   <div class="post" id="post-138567">
    <div class="subject"><a href="#post-138567">breakpoint alters result..?!</a></div>
    <div class="body">Hi!<br />im having some trouble with, what to me apears as a strange error. the purpose of the code is to catenate some strings into a buffer and then display it (by setdlgitemtext, the strings beeing put together are parts of computation to get the momentum of an object). theres also a check wich control if the result of the computation should be added, and heres the weird thing: if the last part (the result) is to be added to the string i overwrites the whole string!<br />ok, so i sat down i started to debug the code (using OllyDbg). I sat a 'on memory access' breakpoint on the buffer, F9-ing my way through the code. but now it worked! the string in the buffer didnt get overwritten. so i tried to run the prg again, without the bp, but no luck - the buffer had been overwritten by the last string. so i tried debugging it again, setting the same bp and it worked again... after doing this several times im confused!<br />heres the &quot;active&quot;code (crash course in swedish =): l?ngd=length, tid=time, hastighet=speed massa=mass):<br /><pre><code><br />.data<br />...<br />visaP	BOOL FALSE	; this ones changed elsewhere.<br /><br />tmpdb	db 18 dup&#40;0&#41;<br />resTxt	db 140 dup&#40;?&#41;<br />resTTxt	db 1150 dup&#40;?&#41;<br /><br />resMn	db 'M?tning %i&#58;',0dh,0ah,0<br />resT	db 't&#58; ',0<br />resTE	db ' s',0dh,0ah,0<br />resV	db 'v&#58; ',0<br />resVE	db ' m/s',0dh,0ah,0<br />resP	db 'P&#58; ',0<br />resPE	db ' Kgm/s2',0dh,0ah,0<br />resDelare db '----------------------------------------------------------',0dh,0ah,0<br />resKlar	db 'Labb Klar',0<br />...<br />.code<br />...<br />GoLabbGo&#58;<br />; doing some stuff to calculate the speed.<br />...<br />invoke FpuFLtoA,0,9,addr tmpdb,SRC1_FPU or SRC2_DIMM<br />invoke Strcat,offset resTxt,offset resT		; &quot;t&#58; &quot;<br />invoke Strcat,offset resTxt,offset tmpdb	; &lt;FpuFLtoA&gt;<br />invoke Strcat,offset resTxt,offset resTE	; &quot; s&quot;,0dh,0ah<br />	<br />invoke GetDlgItemText,hWnd,IDC_l1,addr l1,12h<br />invoke FpuAtoFL,addr l1,0,DEST_FPU		; st&#40;0&#41;=l?ngd, st&#40;1&#41;=tid<br />fdiv st&#40;0&#41;,st&#40;1&#41;	; st&#40;0&#41;=l?ngd/tid=hastighet, st&#40;1&#41;=tid<br />invoke FpuFLtoA,0,9,addr tmpdb,SRC1_FPU or SRC2_DIMM<br />invoke Strcat,offset resTxt,offset resV		; &quot;v&#58; &quot;<br />invoke Strcat,offset resTxt,offset tmpdb	; &lt;FpuFLtoA&gt;<br />invoke Strcat,offset resTxt,offset resVE	; &quot; m/s&quot;,0dh,0ah<br />							<br />cmp visaP,FALSE<br />je labb_fardig<br />invoke GetDlgItemText,hWnd,IDC_m1,addr m1,12h<br />invoke FpuAtoFL,addr m1,0,DEST_FPU	; st&#40;0&#41;=massa, st&#40;1&#41;=hastighet, st&#40;2&#41;=tid<br />fmulp st&#40;1&#41;,st&#40;0&#41;	; st&#40;0&#41;=hastighet*massa=P<br />invoke FpuFLtoA,0,9,addr tmpdb,SRC1_FPU or SRC2_DIMM<br />invoke Strcat,offset resTxt,offset resP		; &quot;P&#58; &quot;<br />invoke Strcat,offset resTxt,offset tmpdb	; &lt;FpuFLtoA&gt;<br />invoke Strcat,offset resTxt,offset resPE	; &quot; Kgm/s2&quot;,0dh,0ah<br />								<br />labb_fardig&#58;<br />invoke Strcat,offset resTxt,offset resDelare<br />invoke Strcat,offset resTTxt,offset resTxt<br />dec antalChkd<br />jnz GoLabbGo<br /><br />invoke Strcat,offset resTTxt,offset resKlar<br />invoke SetDlgItemText,hWnd,IDC_res1,addr resTTxt<br /><br />...<br /><br />; wanted to learn more about string handling so i wrote my own strcat and strlen.<br /><br />Strcat proc USES eax ecx esi edi TillStrang&#58;DWORD,FranStrang&#58;DWORD<br />	mov esi,FranStrang<br />	mov edi,TillStrang<br />	invoke Strlen,TillStrang<br />	inc eax<br />	add edi,eax<br />	invoke Strlen,FranStrang<br />	inc eax<br />	mov ecx,eax<br />	cld<br />	rep movsb<br />	mov byte ptr&#91;edi&#93;,0h	; NULL-ending.<br />	ret<br />Strcat endp<br />Strlen proc Sstrang&#58;LPSTR<br />	mov eax,&#91;Sstrang&#93;<br />	rakna&#58;<br />		cmp byte ptr&#91;eax&#93;,0h<br />		lea eax,&#91;eax+1&#93;<br />	jne rakna	<br />	sub eax,&#91;Sstrang&#93;<br />	dec eax<br />	ret<br />Strlen endp<br />...<br /></code></pre><br />the result looks something like this, when visaP is false:<br /><br />M?tning 1:<br />t:  xx.xxxxxxxxx s<br />v:  xxx.xxxxxxxxx m/s<br />----------------------------------------------------------<br />M?tning 2:<br />t:  xx.xxxxxxxxx s<br />v:  xxx.xxxxxxxxx m/s<br />----------------------------------------------------------<br />Labb Klar<br /><br />which it does. and this is how it should look if it is true:<br /><br />M?tning 1:<br />t:  xx.xxxxxxxxx s<br />v:  xxx.xxxxxxxxx m/s<br />P:  xxx.xxxxxxxxx Kgm/s2<br />----------------------------------------------------------<br />M?tning 2:<br />t:  xx.xxxxxxxxx s<br />v:  xxx.xxxxxxxxx m/s<br />P:  xxx.xxxxxxxxx Kgm/s2<br />----------------------------------------------------------<br />Labb Klar<br /><br />but it doesent, it looks like this (with an extra linefeed before the text):<br /><br /><br />M?tning 2:<br />t:  xx.xxxxxxxxx s<br />v:  xxx.xxxxxxxxx m/s<br />P:  xxx.xxxxxxxxx Kgm/s2<br />----------------------------------------------------------<br />MLabb Klar<br /><br />Unless theres a bp on the buffer memory-access...?!<br />ill attach the full project aswell (RadASM projectZipper :alright: ), so youll get to see the full code... if youd like =)!</div>
    <div class="meta">Posted on 2004-04-10 19:02:19 by sluggo</div>
   </div>
   <div class="post" id="post-138574">
    <div class="subject"><a href="#post-138574">breakpoint alters result..?!</a></div>
    <div class="body">I think your <strong>resTxt</strong> buffer may be too small. Based on your given theorital display, I counted 139 characters (including all the CRLF and terminating 0) and your buffer size is 140. <br /><br />However, as shown, each data line starts with a heading such as <strong>t: </strong> showing only 1 space between the &quot;:&quot; and the output number. That 1 space is part of the header string (db 't: ',0). <br /><br />The FpuFLtoA function would leave a blank space in front of the result if it is positive (as it is in your case). This would add another 3 characters to your string which would then start overwriting the <strong>resTTxt</strong> buffer with at least a terminating &quot;0&quot; and possibly a LF.<br /><br />I'm almost certain that increasing the size of the resTxt buffer will clear the problem.<br /><br />Raymond</div>
    <div class="meta">Posted on 2004-04-10 21:49:57 by Raymond</div>
   </div>
   <div class="post" id="post-138593">
    <div class="subject"><a href="#post-138593">breakpoint alters result..?!</a></div>
    <div class="body">The irony - Ive counted all the chars i dunno how many times to make shure the <strong>resTTxt</strong> buffer was big enough :rolleyes:. <br />But once again your right, thank you Raymond!:alright:<br />just out of curiosity, any ideas on why it (kinda) worked (some of the results got messed up but still the same amounts of chars) when i put a bp on access of the resTTxt-buf?</div>
    <div class="meta">Posted on 2004-04-11 05:14:31 by sluggo</div>
   </div>
   <div class="post" id="post-138622">
    <div class="subject"><a href="#post-138622">breakpoint alters result..?!</a></div>
    <div class="body">The only thing I can think of is that the bp may have temporarily overwritten the guilty terminating 0.<br /><br />Raymond</div>
    <div class="meta">Posted on 2004-04-11 11:11:08 by Raymond</div>
   </div>
  </div>
 </body>
</html>