<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>External function scanner supporting HLA - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=19246" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=19246">External function scanner supporting HLA</a></p>
   <div class="post" id="post-148641">
    <div class="subject"><a href="#post-148641">External function scanner supporting HLA</a></div>
    <div class="body">Hi friends, <br /><br />Originally, the tool was intended for Fasm, by the time, I decided to extend the features of my tool, it supports various assemblers Masm,Tasm,LzAsm,GoAsm and finally my little &quot;scanning&quot; tool can be used with HLA. <br /><br />So what does exactly the scanner? It reads an asm source file and looks for &quot;invoked&quot; functions which are originally external functions and then it creates a file containing a list of external function declarations. <br /><br />Let's consider this simple FASM example: <br /><pre><code> <br /><br />format PE GUI 4.0 <br />entry start <br /><br />include '%fasminc%\win32a.inc' <br /><br />section '.data' data readable writeable <br /><br />text    db &quot;Hi! I'm the example program!&quot;,0 <br />caption db &quot;Win32 Assembly&quot;,0 <br /><br />section '.code' code readable executable <br />start&#58; <br />        invoke  MessageBox,0,text,caption,MB_OK <br />        invoke  ExitProcess,0 <br /><br />include 'Msgbox.imp' <br /></code></pre> <br /><br /><pre><code><br />scan Msgbox.asm <br /></code></pre><br />The resulting Msgbox.imp file: <br /><pre><code><br />section '.idata' import data readable writeable <br /><br />  library kernel32,'kernel32.dll',\ <br />          user32,'user32.dll' <br /><br />  import kernel32,\ <br />         ExitProcess,'ExitProcess' <br /><br />  import user32,\ <br />         MessageBox,'MessageBoxA' <br /> </code></pre><br /><br />So, what is the benefit of using this technique based on creating the list with the &quot;just necessary&quot; function declarations? Simply, it reduces the work of the assembler\compiler which means &quot;reduced assembly time \ faster compilation&quot; <br /><br />To apply this technique to HLA, I created two macros, invoke for stdall API functions and cinvoke for C style functions: <br /><pre><code><br />#macro invoke&#40; varying&#91;&#93; &#41;; <br /><br />?counter &#58;= @elements&#40; varying &#41;-1; <br />#while&#40; counter &gt;0 &#41; <br />        ?temp1&#58;=varying&#91;counter&#93;; <br />        #if &#40;@peekChar&#40;temp1,'&amp;'&#41;==true&#41; <br />                ?temp2&#58;=@substr&#40;temp1,1,@length&#40;temp1&#41;-1&#41;; <br />                #if &#40;@class&#40;@eval&#40;temp2&#41;&#41;==4&#41; <br />                        pushd&#40;ebp&#41;; <br />                        add&#40;@eval&#40;@offset&#40;@eval&#40;temp2&#41;&#41;&#41;,&#40;type dword &#91;esp&#93;&#41;&#41;; <br />                #else <br />                        pushd&#40;@text&#40;varying&#91; counter &#93;&#41;&#41;; <br /><br />                #endif <br />        #else <br />                pushd&#40;@text&#40;varying&#91; counter &#93;&#41;&#41;; <br />        #endif <br />        ?counter &#58;= counter - 1; <br />#endwhile <br />call&#40;@text&#40;varying&#91;0&#93;&#41;&#41;; <br />#endmacro; <br /><br />#macro cinvoke&#40; varying&#91;&#93; &#41;; <br /><br />?counter &#58;= @elements&#40; varying &#41;-1; <br />#while&#40; counter &gt;0 &#41; <br />        ?temp1&#58;=varying&#91;counter&#93;; <br />        #if &#40;@peekChar&#40;temp1,'&amp;'&#41;==true&#41; <br />                ?temp2&#58;=@substr&#40;temp1,1,@length&#40;temp1&#41;-1&#41;; <br />                #if &#40;@class&#40;@eval&#40;temp2&#41;&#41;==4&#41; <br />                        pushd&#40;ebp&#41;; <br />                        add&#40;@eval&#40;@offset&#40;@eval&#40;temp2&#41;&#41;&#41;,&#40;type dword &#91;esp&#93;&#41;&#41;; <br />                #else <br />                        pushd&#40;@text&#40;varying&#91; counter &#93;&#41;&#41;; <br /><br />                #endif <br />        #else <br />                pushd&#40;@text&#40;varying&#91; counter &#93;&#41;&#41;; <br />        #endif <br />        ?counter &#58;= counter - 1; <br />#endwhile <br />call&#40;@text&#40;varying&#91;0&#93;&#41;&#41;; <br />add&#40;4*&#40;@elements&#40;varying&#41;-1&#41;,esp&#41;; <br />#endmacro; <br /></code></pre> <br /><br />Notice that you can get the address of local symbols with the &quot;enhanced&quot; &amp; operator: <br /><pre><code><br />var <br />   wc&#58;   w.WNDCLASSEX; <br />   msg&#58;   w.MSG; <br />   hwnd&#58;   dword; <br />. <br />. <br />. <br />invoke&#40;GetMessage,&amp;msg,NULL, 0, 0 &#41;; <br />breakif&#40; !eax &#41;; <br />invoke&#40;TranslateMessage,&amp;msg &#41;; <br />invoke&#40;DispatchMessage,&amp;msg &#41;; <br /></code></pre> <br /><br />A quick demonstration: <br /><pre><code><br />// Iczelion's tutorial #2&#58; MessageBox <br /><br />program msgBoxDemo; <br />#include&#40; &quot;w2.hhf&quot; &#41; <br />#include&#40; &quot;invoke.hhf&quot; &#41; <br /><br />static <br /><br />#include&#40;&quot;Msgbox.imp&quot;&#41; <br />                <br />caption&#58;string&#58;=&quot;Iczelion's tutorial no.2&quot;; <br />msg&#58;string&#58;=&quot;Win32/HLA Assembly is Great!&quot;; <br /><br />begin msgBoxDemo; <br /><br />   invoke&#40;MessageBox, <br />   0, <br />                msg, <br />                caption, <br />   w.MB_OK    <br />   &#41;; <br />           <br />end msgBoxDemo; <br /></code></pre> <br /><br /><pre><code><br />scan Msgbox.hla -h <br /></code></pre><br /><br /><br />Msgbox.imp file: <br /><pre><code><br />MessageBox &#58; procedure; <br />   external&#40;&quot;__imp__MessageBoxA@16&quot;&#41;; <br /></code></pre> <br /><br />w2.hhf is a smaller version of the original windows include file w.hhf It doesn't contain any API function declaration. <br /><br />You can check the attachment to see some HLA examples adapted for faster compilation. <br /><br />The tool doesn't support yet nested include files, to &quot;scan&quot; a project composed of source files main.hla, string.hla and graphproc.hla, you create a file with the .prj extension. <br /><br />Myproject.prj: <br /><pre><code><br />main.hla <br />string.hla <br />graphproc.hla <br /></code></pre><br /><br /><br />To run the scanner: <br /><pre><code><br />scan Myproject.prj -h <br /></code></pre> <br /><br />To get more information about the scanner: <br /><br />http://board.flatassembler.net/viewtopic.php?p=3729 <br />http://www.asmcommunity.net/board/viewtopic.php?t=13287</div>
    <div class="meta">Posted on 2004-08-28 07:20:28 by Vortex</div>
   </div>
   <div class="post" id="post-148647">
    <div class="subject"><a href="#post-148647">External function scanner supporting HLA</a></div>
    <div class="body">vortex, <br /><br />This is a really useful tool. When I first tried it I thought it would be really useful for HLA and I'm grateful that you've finally added HLA support. :)But I think I would have to adjust to using invoke for api functions.  :-D</div>
    <div class="meta">Posted on 2004-08-28 09:32:23 by Odyssey</div>
   </div>
   <div class="post" id="post-148663">
    <div class="subject"><a href="#post-148663">External function scanner supporting HLA</a></div>
    <div class="body">Hi Odyssey,<br /><br />Yes, you are right about the adjustment problem. Theoretically, it may be possible to develop the tool to search directly the API functions, it should be an interesting programming practice to find a suitable algorithm for such a process. My modest efforts are intended to discover the powerfull macro features of HLA.</div>
    <div class="meta">Posted on 2004-08-28 13:03:40 by Vortex</div>
   </div>
   <div class="post" id="post-154459">
    <div class="subject"><a href="#post-154459">External function scanner supporting HLA</a></div>
    <div class="body">Great work.  Suggestion - instead of specifying DLL names in an .ini file, you can create your own database of API functions.  <br /><br />You can use the command<br /><br />link -DUMP -EXPORTS xxx.lib<br /><br />to get a listing of the exports of a particular lib file.<br /><br />Using this technique you can create a big listing of all the API functions  which you can then search at run time.</div>
    <div class="meta">Posted on 2004-12-20 05:52:28 by gfalen</div>
   </div>
   <div class="post" id="post-154485">
    <div class="subject"><a href="#post-154485">External function scanner supporting HLA</a></div>
    <div class="body">Hi gfalen,<br /><br />Thanks for your kind words. The first versions of my tool ( V1.0 and V2.0 ) used the database technique you mentioned but I didn't support HLA at that time. The members of the forum recommended me that it should be better to search DLLs instead of database, that's why I changed the method. <br /><br />The attachment feature of the board is disabled for a while. If you would like to get the HLA example, please feel free to send me a PM with your e.mail address as the latest version of scan supports nested include files.</div>
    <div class="meta">Posted on 2004-12-20 12:05:42 by Vortex</div>
   </div>
   <div class="post" id="post-154505">
    <div class="subject"><a href="#post-154505">External function scanner supporting HLA</a></div>
    <div class="body">Hi Vortex.<br /><br />This would be a cool tool to use automated from make-files and IDE's<br /><br />I'm going to try it out and see how much it reduces HIDE full rebuild time (has about 17 units and processes about 20mb of source for full-rebuild).</div>
    <div class="meta">Posted on 2004-12-20 21:06:36 by Kain</div>
   </div>
   <div class="post" id="post-154540">
    <div class="subject"><a href="#post-154540">External function scanner supporting HLA</a></div>
    <div class="body">Hi Kain,<br /><br />The latest version V3.33 can be obtained from Privalov's flatassembler forum. This version supports nested include files. ( except files pointed by environment variables )</div>
    <div class="meta">Posted on 2004-12-21 11:56:24 by Vortex</div>
   </div>
   <div class="post" id="post-155967">
    <div class="subject"><a href="#post-155967">External function scanner supporting HLA</a></div>
    <div class="body">Scanner V3.34 :<br /><br />Now, the invoke macro is reduced to a very simple form:<br /><pre><code><br />#macro invoke;<br />#endmacro;<br /></code></pre><br /><br />The use of invoke macro is easy compared to the previous version:<br /><pre><code><br />invoke GetModuleHandle&#40;0&#41;;<br /></code></pre><br /><br />The tool supports nested include files. To reduce the processing time of the tool,by-pass the include files which doesn't contain any API function, this is possible by typing Invoke with uppercase I :<br /><pre><code><br />#Include&#40; &quot;strings.hhf&quot; &#41;<br />#Include&#40; &quot;memory.hhf&quot; &#41;<br />#Include&#40; &quot;args.hhf&quot; &#41;<br />#Include&#40; &quot;conv.hhf&quot; &#41;<br /></code></pre><br /><br />Click <a target="_blank" href="http://www.masmforum.com/simple/index.php?action=dlattach;topic=463.0;id=235">here</a> to get the attachment.</div>
    <div class="meta">Posted on 2005-01-18 14:23:48 by Vortex</div>
   </div>
  </div>
 </body>
</html>