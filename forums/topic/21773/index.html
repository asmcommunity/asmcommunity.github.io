<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>How should I do? I want use IPicture object to save screen snap in  bmp file. - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=21773" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=21773">How should I do? I want use IPicture object to save screen snap in  bmp file.</a></p>
   <div class="post" id="post-164295">
    <div class="subject"><a href="#post-164295">How should I do? I want use IPicture object to save screen snap in  bmp file.</a></div>
    <div class="body"><pre><code>.386<br />.Model Flat,StdCall<br />Option CaseMap :None<br /><br />Include Windows.inc<br />Include user32.inc<br />Include	Gdi32.inc<br />Include kernel32.inc<br />Include oleaut32.inc<br />include ole32.inc<br />IncludeLib user32.lib<br />IncludeLib	Gdi32.lib<br />IncludeLib kernel32.lib<br />IncludeLib oleaut32.lib<br />includelib ole32.lib<br /><br />Include MACRO.ASM<br />IPicture_SaveAsFileProto           typedef proto :DWORD, :DWORD,:DWORD,:DWORD<br />IPicture_SaveAsFile                typedef ptr IPicture_SaveAsFileProto<br />IPicture STRUCT<br />    ; IUnknown methods<br />    QueryInterface          dd   ?<br />    AddRef                  dd   ?<br />    Release                 dd   ?<br />    ; IPicture methods<br />    get_Handle              dd   ?<br />    get_hPal                dd   ?<br />    get_Type                dd   ?<br />    get_Width               dd   ?<br />    get_Height              dd   ?<br />    Render                  dd   ?	<br />    set_hPal                dd   ?<br />    get_CurDC               dd   ?<br />    SelectPicture           dd   ?<br />    get_KeepOriginalFormat  dd   ?<br />    put_KeepOriginalFormat  dd   ?<br />    PictureChanged          dd   ?<br />    SaveAsFile              IPicture_SaveAsFile   ?<br />    get_Attributes          dd   ?<br />IPicture ENDS<br /><br />PICTDESC_BMP STRUCT<br />    cbSizeOfStruct  		dd		?<br />    PicType	 				dd		?<br />    hBitmap 				dd		?<br />    hPal 					dd		?<br />    Reserved 				dd		?<br />PICTDESC_BMP ENDS<br /><br />IStream STRUCT<br />    Read					dd		?<br />    Write				dd		?<br />    Seek					dd		?<br />    SetSize				dd		?<br />    CopyTo				dd		? <br />    Commit				dd		?<br />    Revert				dd		?<br />    LockRegion			dd		? <br />    UnlockRegion		dd		? <br />    Stat					dd		? <br />    Clone				dd		? <br />IStream ENDS<br /><br />.data<br />	IID_IPicture	GUID &lt;00020400h,0000h,0000h,&lt;0C0h,000h, 000h,000h, 000h, 000h, 000h,046h&gt;&gt;<br />.data?<br />	buffer	db	256 dup(?)<br />.code<br /><br />_CreateBitmapPicture proc<br />	local hDCSrc ,hDCMemory,hBitmap,hOldBitmap<br />	local pPic,sStrm<br />	local dwWidth,dwHeight,dwByte<br />	local hPal,hPalPrev<br />	local hGlobal,hMem,lSize,@pData<br />	local HasPaletteScrn, PaletteSizeScrn<br />	local LogPal	:LOGPALETTE<br />	local pic		:PICTDESC_BMP<br /><br /><br />	invoke	GetSystemMetrics,SM_CXSCREEN<br />	mov dwWidth,eax<br />	invoke	GetSystemMetrics,SM_CYSCREEN<br />	mov dwHeight,eax<br />	invoke GetDC,0<br />	mov hDCSrc,eax	<br />   invoke CreateCompatibleDC,eax<br />   mov hDCMemory,eax<br />   invoke CreateCompatibleBitmap,hDCSrc,dwWidth,dwHeight<br />   mov hBitmap,eax<br />   invoke SelectObject,hDCMemory,eax<br />   mov hOldBitmap,eax<br />   invoke GetDeviceCaps,hDCSrc,RASTERCAPS;Raster<br />   and eax,RC_PALETTE<br />   mov HasPaletteScrn,eax   ;Palette<br />	invoke GetDeviceCaps,hDCSrc,SIZEPALETTE	;Size of<br />	mov PaletteSizeScrn,eax<br />	.if HasPaletteScrn &amp;&amp; (PaletteSizeScrn == 256)<br />		mov LogPal.palVersion , 300h<br />		mov LogPal.palNumEntries , 256<br />		invoke GetSystemPaletteEntries,hDCSrc,0,256,addr LogPal.palPalEntry<br />		invoke CreatePalette,addr LogPal<br />		mov hPal,eax<br />		invoke SelectPalette,hDCMemory,hPal,0<br />		mov hPalPrev,eax<br />		invoke RealizePalette,hDCMemory<br />	.endif<br />   invoke BitBlt,hDCMemory,0,0,dwWidth,dwHeight,hDCSrc,0,0,SRCCOPY<br />   invoke SelectObject,hDCMemory,hOldBitmap<br />   mov hBitmap,eax<br />   .if HasPaletteScrn &amp;&amp; (PaletteSizeScrn == 256)<br />   	invoke SelectPalette,hDCMemory,hPalPrev,0<br />   	mov hPal,eax<br />   .endif<br />   invoke ReleaseDC,0,hDCSrc<br />   invoke DeleteDC,hDCMemory<br />   <br />   mov pic.cbSizeOfStruct,sizeof pic		; Length of structure<br />   mov pic.PicType,1 							; Type of Picture (bitmap)<br />   mov eax,hBitmap<br />   mov pic.hBitmap,eax							; Handle to bitmap<br />   mov eax,hPal<br />   mov pic.hPal,eax								; Handle to palette (may be null)<br /><br />	invoke OleCreatePictureIndirect,addr pic,addr IID_IPicture,TRUE,addr pPic<br />	.if eax==S_OK<br />		invoke MessageBox,0,0,0,0<br />	.endif<br />	szText sf,&quot;snap.bmp&quot;<br />   invoke CreateStreamOnHGlobal,NULL,TRUE,addr sStrm<br />   mov ebx,pPic<br />   mov ebx,<br />   invoke (IPicture ptr ).SaveAsFile,pPic,sStrm,TRUE,addr dwByte          ;;;;;Here  ERROR!!!<br />    .if eax==S_OK<br />   	invoke MessageBox,0,addr sf,0,0<br />   .endif<br />  	invoke GetHGlobalFromStream,sStrm,hGlobal<br />	invoke GlobalLock,hGlobal<br />	mov hMem,eax<br />	invoke CreateFile,addr sf,GENERIC_WRITE,0,NULL,CREATE_ALWAYS,FILE_ATTRIBUTE_NORMAL,NULL<br />	invoke WriteFile,@hFile,hMem,lSize, @pData, NULL<br />	invoke CloseHandle,@hFile<br />	invoke GlobalUnlock,hGlobal<br />	invoke GlobalFree,hMem<br />   <br />	ret<br />_CreateBitmapPicture endp<br /><br />start:<br />		<br />		<br />		invoke _CreateBitmapPicture<br />		invoke	ExitProcess,NULL<br />	end start</code></pre><br /><br /><br /><br />First,I create a bitmap and a palette ,then call OleCreatePictureIndirect to create a picture object,<br />then save this picture object to a bmp file.<br />I use IPicture::SaveAsFile to a Stream, then call writefile put to a file. But have a ERR happend.<br /><br />Why error?<br />Pls anyone to help me! TKS!<br /><br /><br /><br /></div>
    <div class="meta">Posted on 2005-09-06 12:08:25 by soulee</div>
   </div>
   <div class="post" id="post-164296">
    <div class="subject"><a href="#post-164296">Re: How should I do? About IPictue:: SaveAsFile.</a></div>
    <div class="body">Posting the code is good :) now perhaps you could also explain what you&#39;re trying to accomplish, and what specific problems you have encountered.</div>
    <div class="meta">Posted on 2005-09-06 12:52:41 by QvasiModo</div>
   </div>
   <div class="post" id="post-164298">
    <div class="subject"><a href="#post-164298">Re: How should I do? About IPictue:: SaveAsFile.</a></div>
    <div class="body"><div class="quote"><br />.386<br />.Model Flat, StdCall<br />Option Casemap :None&nbsp;  <br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />Include \masm32\include\windows.inc<br />Include \masm32\include\user32.inc<br />Include \masm32\include\kernel32.inc<br />INCLUDE \masm32\include\Gdi32.inc<br />INCLUDE \masm32\include\oleaut32.inc<br />INCLUDE \masm32\include\ole32.inc<br /><br />IncludeLib \masm32\lib\user32.lib<br />IncludeLib \masm32\lib\kernel32.lib<br />INCLUDELIB \masm32\lib\Gdi32.lib<br />INCLUDELIB \masm32\lib\oleaut32.lib<br />INCLUDELIB \masm32\lib\ole32.lib<br /><br />INCLUDE \masm32\macros\macros.asm<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />IPicture_SaveAsFileProto&nbsp; &nbsp;  typedef proto :DWORD, :DWORD,:DWORD,:DWORD<br />IPicture_SaveAsFile&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; typedef ptr IPicture_SaveAsFileProto<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />IPicture STRUCT<br />&nbsp; &nbsp; ; IUnknown methods<br />&nbsp; &nbsp; QueryInterface&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; AddRef&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; Release&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />&nbsp; &nbsp; ; IPicture methods<br />&nbsp; &nbsp; get_Handle&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; get_hPal&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; get_Type&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; get_Width&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />&nbsp; &nbsp; get_Height&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; Render&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?	<br />&nbsp; &nbsp; set_hPal&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; get_CurDC&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />&nbsp; &nbsp; SelectPicture&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />&nbsp; &nbsp; get_KeepOriginalFormat&nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; put_KeepOriginalFormat&nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; PictureChanged&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; SaveAsFile&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IPicture_SaveAsFile&nbsp;  ?<br />&nbsp; &nbsp; get_Attributes&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />IPicture ENDS<br />;--------------------------------------------------------<br />PICTDESC_BMP STRUCT<br />&nbsp; &nbsp; cbSizeOfStruct&nbsp; 	&nbsp; &nbsp; dd	?<br />&nbsp; &nbsp; PicType		&nbsp; &nbsp; dd	?<br />&nbsp; &nbsp; hBitmap 		&nbsp; &nbsp; dd	?<br />&nbsp; &nbsp; hPal 		&nbsp; &nbsp; dd	?<br />&nbsp; &nbsp; Reserved 		&nbsp; &nbsp; dd	?<br />PICTDESC_BMP ENDS<br />;--------------------------------------------------------<br />IStream STRUCT<br />&nbsp; &nbsp; Read		&nbsp; &nbsp; dd	?<br />&nbsp; &nbsp; Write		&nbsp; &nbsp; dd	?<br />&nbsp; &nbsp; Seek		&nbsp; &nbsp; dd	?<br />&nbsp; &nbsp; SetSize		&nbsp; &nbsp; dd	?<br />&nbsp; &nbsp; CopyTo		&nbsp; &nbsp; dd	? <br />&nbsp; &nbsp; Commit		&nbsp; &nbsp; dd	?<br />&nbsp; &nbsp; Revert		&nbsp; &nbsp; dd	?<br />&nbsp; &nbsp; LockRegion		&nbsp; &nbsp; dd	? <br />&nbsp; &nbsp; UnlockRegion	&nbsp; &nbsp; dd	? <br />&nbsp; &nbsp; Stat		&nbsp; &nbsp; dd	? <br />&nbsp; &nbsp; Clone		&nbsp; &nbsp; dd	? <br />IStream ENDS<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.data<br />		dwWrite&nbsp;  dw 0<br />	IID_IPicture	GUID &lt;00020400h,0000h,0000h,&lt;0C0h,000h, 000h,000h, 000h, 000h, 000h,046h&gt;&gt;<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.data?<br />	szMessage	db 256 dup (?)<br />	seh		dd 6 dup (?)<br />	buffer		db 256 dup(?)<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.const<br />&nbsp;  szErrorThread&nbsp;  db 13, 10, &quot;Error at %08Xh&quot;, 13, 10, &quot;Registers:&quot;, 13, 10, &quot;eax = %08Xh ebx = %08Xh ecx = %08Xh&quot;, 13, 10, &quot;edx = %08Xh esp = %08Xh ebp = %08Xh&quot;, 13, 10, &quot;esi = %08Xh edi = %08Xh&quot;, 13, 10, 13, 10, &quot;Recovering...&quot;, 13, 10,0<br />&nbsp;  szErrorFinal&nbsp;  db 13, 10, &quot;Error at %08Xh&quot;, 13, 10, &quot;Quitting...&quot;, 13, 10, 0<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.code<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />ErrorHandler proc C lpExcept:DWORD, lpFrame:DWORD, lpContext:DWORD, lpDispatch:DWORD<br />	mov&nbsp;  eax, lpExcept<br />	mov&nbsp;  ecx, lpContext<br />	invoke&nbsp;  wsprintf, ADDR szMessage, ADDR szErrorThread, ,\<br />		, , , ,\<br />		, , , <br />	invoke MessageBox,NULL,&nbsp;  ADDR szMessage,&nbsp;  SADD(&quot;1_Error Occured&quot;),MB_ICONEXCLAMATION<br /><br />	mov&nbsp;  eax, lpContext<br />	m2m&nbsp;  , <br />	m2m&nbsp;  , <br />	m2m&nbsp;  , <br />	m2m&nbsp;  , <br />	m2m&nbsp;  , <br />	m2m&nbsp;  , <br /><br />	xor&nbsp;  eax, eax&nbsp;  ; continue execution<br />	ret<br />ErrorHandler endp<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />ExceptionFilter proc lpExcept:DWORD<br />	mov eax, lpExcept<br />	invoke wsprintf, ADDR szMessage, ADDR szErrorFinal, <br />	invoke MessageBox,NULL,&nbsp;  ADDR szMessage,&nbsp;  SADD(&quot;2_Error Occured&quot;),MB_ICONEXCLAMATION<br />	invoke ExitProcess, 0<br />	xor&nbsp;  eax, eax<br />	inc&nbsp;  eax&nbsp; &nbsp; &nbsp; ; EXCEPTION_EXECUTE_HANDLER<br />	ret<br />ExceptionFilter endp<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />_CreateBitmapPicture proc<br />	local hDCSrc ,hDCMemory,hBitmap,hOldBitmap<br />	local pPic,sStrm<br />	local dwWidth,dwHeight,dwByte<br />	local hPal,hPalPrev<br />	local hGlobal,hMem,lSize,@pData<br />	local HasPaletteScrn, PaletteSizeScrn<br />	local LogPal	:LOGPALETTE<br />	local pic	:PICTDESC_BMP<br />	Local @hFile:dword<br /><br />	invoke	GetSystemMetrics,SM_CXSCREEN<br />	mov dwWidth,eax<br />	invoke	GetSystemMetrics,SM_CYSCREEN<br />	mov dwHeight,eax<br />	invoke GetDC,0<br />	mov hDCSrc,eax	<br />	invoke CreateCompatibleDC,eax<br />	mov hDCMemory,eax<br />	invoke CreateCompatibleBitmap,hDCSrc,dwWidth,dwHeight<br />	mov hBitmap,eax<br />	invoke SelectObject,hDCMemory,eax<br />	mov hOldBitmap,eax<br />	invoke GetDeviceCaps,hDCSrc,RASTERCAPS;Raster<br />	and eax,RC_PALETTE<br />	mov HasPaletteScrn,eax&nbsp;  ;Palette<br />	invoke GetDeviceCaps,hDCSrc,SIZEPALETTE	;Size of<br />	mov PaletteSizeScrn,eax<br />	.if HasPaletteScrn &amp;&amp; (PaletteSizeScrn == 256)<br />		mov LogPal.palVersion , 300h<br />		mov LogPal.palNumEntries , 256<br />		invoke GetSystemPaletteEntries,hDCSrc,0,256,addr LogPal.palPalEntry<br />		invoke CreatePalette,addr LogPal<br />		mov hPal,eax<br />		invoke SelectPalette,hDCMemory,hPal,0<br />		mov hPalPrev,eax<br />		invoke RealizePalette,hDCMemory<br />	.endif<br />	invoke BitBlt,hDCMemory,0,0,dwWidth,dwHeight,hDCSrc,0,0,SRCCOPY<br />	invoke SelectObject,hDCMemory,hOldBitmap<br />	mov hBitmap,eax<br />	.if HasPaletteScrn &amp;&amp; (PaletteSizeScrn == 256)<br />&nbsp;  		invoke SelectPalette,hDCMemory,hPalPrev,0<br />&nbsp;  		mov hPal,eax<br />	.endif<br />	invoke ReleaseDC,0,hDCSrc<br />	invoke DeleteDC,hDCMemory<br />&nbsp;  <br />	mov pic.cbSizeOfStruct,sizeof pic		; Length of structure<br />	mov pic.PicType,1 				; Type of Picture (bitmap)<br />	mov eax,hBitmap<br />	mov pic.hBitmap,eax				; Handle to bitmap<br />	mov eax,hPal<br />	mov pic.hPal,eax				; Handle to palette (may be null)<br /><br />	invoke OleCreatePictureIndirect,addr pic,addr IID_IPicture,TRUE,addr pPic<br />	.if eax!=S_OK<br />		invoke MessageBox,0,0,0,0<br />	.endif<br />	invoke CreateStreamOnHGlobal,NULL,TRUE,addr sStrm<br />	mov ebx,pPic<br />	mov ebx,<br />	invoke (IPicture ptr ).SaveAsFile,pPic,sStrm,TRUE,addr dwByte&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;;;;;Here&nbsp; ERROR!!!<br />	.if eax==S_OK<br />&nbsp;  		invoke MessageBox,0,SADD(&quot;Sok_Error Occured&quot;),SADD(&quot;test&quot;),MB_OK<br />	.endif<br />&nbsp; 	invoke GetHGlobalFromStream,sStrm,hGlobal<br />	invoke GlobalAlloc,GPTR	,eax<br />	mov hMem,eax<br />	invoke CreateFile,SADD(&quot;scr_1.bmp&quot;),GENERIC_WRITE,0,NULL,CREATE_ALWAYS,FILE_ATTRIBUTE_NORMAL,NULL<br />	mov @hFile,eax<br />	invoke WriteFile,@hFile,hMem,lSize,addr dwWrite, NULL<br />	invoke CloseHandle,@hFile<br />	invoke GlobalUnlock,hGlobal<br />	invoke GlobalFree,hMem<br />&nbsp;  <br />	ret<br />_CreateBitmapPicture endp<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />start:<br />	invoke GetModuleHandle,NULL<br />	invoke SetUnhandledExceptionFilter, ADDR ExceptionFilter<br />	; install the SEH-frame<br />	assume&nbsp;  fs:nothing<br />	push&nbsp;  OFFSET ErrorHandler<br />	push&nbsp;  FS:[0]<br />	mov&nbsp;  , esp<br />	mov&nbsp;  , ebp<br />	mov&nbsp;  , ebx<br />	mov&nbsp;  , esi<br />	mov&nbsp;  , edi<br />	mov&nbsp;  , OFFSET @@safe<br />	mov&nbsp;  FS:[0], esp<br />	<br />	; critical code<br />	; zero uninitialized data<br />;==============================================================================<br />	; here is your code<br />	invoke _CreateBitmapPicture<br />	;mov eax,0<br />	;mov ecx,2<br />	;div ecx<br />;==============================================================================<br />	push&nbsp;  edi<br />	push&nbsp;  esi<br />	push&nbsp;  ebx<br />@@exit:&nbsp;  <br />	pop&nbsp;  ebx<br />	pop&nbsp;  esi<br />	pop&nbsp;  edi<br />@@safe:&nbsp;  <br />	pop&nbsp;  FS:[0]<br />	jmp&nbsp;  ExitProcess<br />	invoke	ExitProcess,NULL<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br /><br />end start<br /><br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</div><br />no error happens, can&#39;t do anything,except created a bmp file with 0 byte.</div>
    <div class="meta">Posted on 2005-09-06 13:33:54 by dcskm4200</div>
   </div>
   <div class="post" id="post-164311">
    <div class="subject"><a href="#post-164311">Re: How should I do? About IPictue:: SaveAsFile.</a></div>
    <div class="body">worked code.<br /><div class="quote">.386<br />.model flat, stdcall<br />option casemap :none<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />include \masm32\include\windows.inc<br />include \masm32\include\user32.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\shell32.inc<br />include \masm32\include\advapi32.inc<br />include \masm32\include\gdi32.inc<br />include \masm32\include\comctl32.inc<br />include \masm32\include\comdlg32.inc<br />include \masm32\include\masm32.inc<br /><br />includelib \masm32\lib\user32.lib<br />includelib \masm32\lib\kernel32.lib<br />includelib \masm32\lib\shell32.lib<br />includelib \masm32\lib\advapi32.lib<br />includelib \masm32\lib\gdi32.lib<br />includelib \masm32\lib\comctl32.lib<br />includelib \masm32\lib\comdlg32.lib<br />includelib \masm32\lib\masm32.lib<br /><br />include \masm32\macros\macros.asm<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.code<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />_CapScreen Proc lpFileName:DWORD<br />	LOCAL hdc:HDC<br />	LOCAL memdc:HDC<br />	LOCAL dwBytes:DWORD<br />	LOCAL bitmapfileheader:BITMAPFILEHEADER<br />	LOCAL bitmapinfoheader:BITMAPINFOHEADER<br />	LOCAL hFile:HANDLE<br />	LOCAL colors[256*4]:RGBQUAD<br />	LOCAL bmpinfo:BITMAPINFO<br />	LOCAL hBitmap:HBITMAP<br />	LOCAL pBits:DWORD<br />	LOCAL dwWidth:DWORD<br />	LOCAL dwHeight:DWORD<br />	LOCAL dwNumColors:DWORD<br />	LOCAL dwBPP:DWORD<br />	LOCAL ColorSize:DWORD<br />	local buffer [256]:BYTE<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; invoke GetDC,0<br />&nbsp; &nbsp; &nbsp; &nbsp; mov hdc,eax<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; invoke GetDeviceCaps, hdc, HORZRES<br />&nbsp; &nbsp; &nbsp; &nbsp; mov dwWidth,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke GetDeviceCaps, hdc, VERTRES<br />&nbsp; &nbsp; &nbsp; &nbsp; mov dwHeight,eax<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; invoke GetDeviceCaps, hdc, BITSPIXEL<br />&nbsp; &nbsp; &nbsp; &nbsp; mov dwBPP,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; .IF (eax&lt;=8)<br />		mov dwNumColors,256<br />&nbsp; &nbsp; &nbsp; &nbsp; .ELSE<br />		mov dwNumColors,0<br />&nbsp; &nbsp; &nbsp; &nbsp; .ENDIF<br />&nbsp; &nbsp; &nbsp; &nbsp; <br />	invoke CreateCompatibleDC, hdc<br />	mov memdc,eax<br /><br />	mov bmpinfo.bmiHeader.biSize,sizeof BITMAPINFOHEADER<br />	mov eax,dwWidth<br />	mov bmpinfo.bmiHeader.biWidth,eax<br />	mov eax,dwHeight<br />	mov bmpinfo.bmiHeader.biHeight,eax<br />	mov bmpinfo.bmiHeader.biPlanes,1<br />	mov ax,word ptr <br />	mov bmpinfo.bmiHeader.biBitCount,ax<br />	mov bmpinfo.bmiHeader.biCompression,BI_RGB&nbsp; &nbsp; ;BI_RGB<br />	mov bmpinfo.bmiHeader.biSizeImage,0<br />	mov bmpinfo.bmiHeader.biXPelsPerMeter,0<br />	mov bmpinfo.bmiHeader.biYPelsPerMeter,0<br />	mov bmpinfo.bmiHeader.biClrUsed,0<br />	mov bmpinfo.bmiHeader.biClrImportant,0<br />	invoke CreateDIBSection,hdc,addr bmpinfo, DIB_PAL_COLORS,addr pBits, NULL, 0<br />	mov hBitmap,eax<br />	invoke SelectObject, memdc, hBitmap<br />	invoke BitBlt, memdc,0,0, dwWidth, dwHeight, hdc, 0,0, SRCCOPY<br />	mov eax,dwNumColors<br />	.IF (eax!=0)<br />		invoke GetDIBColorTable, hdc,0, dwNumColors, addr colors<br />		mov dwNumColors,eax<br />	.ENDIF<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; mov bitmapfileheader.bfType,4D42h<br />&nbsp; &nbsp; &nbsp; &nbsp; mov eax,dwNumColors<br />&nbsp; &nbsp; &nbsp; &nbsp; xor edx,edx<br />&nbsp; &nbsp; &nbsp; &nbsp; mov ecx,sizeof(RGBQUAD)<br />&nbsp; &nbsp; &nbsp; &nbsp; mul ecx<br />&nbsp; &nbsp; &nbsp; &nbsp; mov ColorSize,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; mov eax,dwWidth<br />&nbsp; &nbsp; &nbsp; &nbsp; xor edx,edx<br />&nbsp; &nbsp; &nbsp; &nbsp; mov ecx,dwHeight<br />&nbsp; &nbsp; &nbsp; &nbsp; mul ecx<br />&nbsp; &nbsp; &nbsp; &nbsp; xor edx,edx<br />&nbsp; &nbsp; &nbsp; &nbsp; mov ecx,dwBPP<br />&nbsp; &nbsp; &nbsp; &nbsp; mul ecx<br />&nbsp; &nbsp; &nbsp; &nbsp; shr eax,3<br />&nbsp; &nbsp; &nbsp; &nbsp; add eax,ColorSize<br />&nbsp; &nbsp; &nbsp; &nbsp; mov bitmapinfoheader.biSizeImage,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; add eax,sizeof BITMAPFILEHEADER<br />&nbsp; &nbsp; &nbsp; &nbsp; add eax,sizeof BITMAPINFOHEADER<br />&nbsp; &nbsp; &nbsp; &nbsp; mov bitmapfileheader.bfSize,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; mov bitmapfileheader.bfReserved1,0<br />&nbsp; &nbsp; &nbsp; &nbsp; mov bitmapfileheader.bfReserved2,0<br />&nbsp; &nbsp; &nbsp; &nbsp; mov eax,ColorSize<br />&nbsp; &nbsp; &nbsp; &nbsp; add eax,sizeof BITMAPFILEHEADER<br />&nbsp; &nbsp; &nbsp; &nbsp; add eax,sizeof BITMAPINFOHEADER<br />&nbsp; &nbsp; &nbsp; &nbsp; mov bitmapfileheader.bfOffBits,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; mov bitmapinfoheader.biSize,sizeof BITMAPINFOHEADER<br />&nbsp; &nbsp; &nbsp; &nbsp; mov eax,dwWidth<br />&nbsp; &nbsp; &nbsp; &nbsp; mov bitmapinfoheader.biWidth,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; mov eax,dwHeight<br />&nbsp; &nbsp; &nbsp; &nbsp; mov bitmapinfoheader.biHeight,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; mov bitmapinfoheader.biPlanes,1<br />&nbsp; &nbsp; &nbsp; &nbsp; mov ax,word ptr <br />&nbsp; &nbsp; &nbsp; &nbsp; mov bitmapinfoheader.biBitCount,ax		<br />&nbsp; &nbsp; &nbsp; &nbsp; mov bitmapinfoheader.biCompression,BI_RGB&nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; mov bitmapinfoheader.biXPelsPerMeter,0<br />&nbsp; &nbsp; &nbsp; &nbsp; mov bitmapinfoheader.biYPelsPerMeter,0<br />&nbsp; &nbsp; &nbsp; &nbsp; mov bitmapinfoheader.biClrUsed,0<br />&nbsp; &nbsp; &nbsp; &nbsp; mov bitmapinfoheader.biClrImportant,0<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; invoke CreateFile, lpFileName,GENERIC_WRITE,0,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NULL,CREATE_ALWAYS,FILE_ATTRIBUTE_NORMAL,NULL<br />&nbsp; &nbsp; &nbsp; &nbsp; mov hFile,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke WriteFile, hFile, addr bitmapfileheader, sizeof BITMAPFILEHEADER,addr dwBytes, NULL<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke WriteFile, hFile, addr bitmapinfoheader, sizeof BITMAPINFOHEADER,addr dwBytes, NULL<br />&nbsp; &nbsp; &nbsp; &nbsp; mov eax,dwNumColors<br />&nbsp; &nbsp; &nbsp; &nbsp; .IF (eax!=0)<br />		invoke WriteFile, hFile, addr colors, ColorSize, addr dwBytes,NULL<br />&nbsp; &nbsp; &nbsp; &nbsp; .ENDIF<br />&nbsp; &nbsp; &nbsp; &nbsp; mov eax,dwWidth<br />&nbsp; &nbsp; &nbsp; &nbsp; xor edx,edx<br />&nbsp; &nbsp; &nbsp; &nbsp; mov ecx,dwHeight<br />&nbsp; &nbsp; &nbsp; &nbsp; mul ecx<br />&nbsp; &nbsp; &nbsp; &nbsp; xor edx,edx<br />&nbsp; &nbsp; &nbsp; &nbsp; mov ecx,dwBPP<br />&nbsp; &nbsp; &nbsp; &nbsp; mul ecx<br />&nbsp; &nbsp; &nbsp; &nbsp; shr eax,3<br />&nbsp; &nbsp; &nbsp; &nbsp; mov ColorSize,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke WriteFile, hFile, pBits, ColorSize, addr dwBytes,NULL<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke CloseHandle, hFile<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke DeleteObject ,hBitmap<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke DeleteDC, memdc<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke ReleaseDC,0,hdc<br />	ret<br />_CapScreen endp<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />start:<br />	invoke _CapScreen, SADD(&quot;Scr_1.bmp&quot;)<br />	invoke ExitProcess,0<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br /><br />end start<br /><br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</div></div>
    <div class="meta">Posted on 2005-09-06 19:13:31 by dcskm4200</div>
   </div>
   <div class="post" id="post-164315">
    <div class="subject"><a href="#post-164315">Re: How should I do? About IPictue:: SaveAsFile.</a></div>
    <div class="body">Tks dcskm4200!<br /><br />in your test,<div class="quote">no error happens, can&#39;t do anything,except created a bmp file with 0 byte.</div><br /><br />but in my pc,have a error,SHE Dilog hint 1 error occured.<br /><br /><br />Why?</div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=933" target="_blank">occurd.JPG</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2005-09-06 20:45:42 by soulee</div>
   </div>
   <div class="post" id="post-164316">
    <div class="subject"><a href="#post-164316">Re: How should I do? I want use IPicture object to save screen snap in  bmp file.</a></div>
    <div class="body">Hi,dcskm4200:<br />Your post a worked code,<br />Now have a small problem.<br /><br />Please see the diagram.<br /><br /></div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=935" target="_blank">err.JPG</a></li>
      <li><a href="../../attachments/?id=936" target="_blank">good.JPG</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2005-09-06 21:11:47 by soulee</div>
   </div>
   <div class="post" id="post-164318">
    <div class="subject"><a href="#post-164318">Re: How should I do? I want use IPicture object to save screen snap in  bmp file.</a></div>
    <div class="body">sorry,I forgot to say i test in 256 colors.<br /> 16 bit and 24 bit no problem.</div>
    <div class="meta">Posted on 2005-09-06 21:16:11 by soulee</div>
   </div>
   <div class="post" id="post-164323">
    <div class="subject"><a href="#post-164323">Re: How should I do? I want use IPicture object to save screen snap in  bmp file.</a></div>
    <div class="body">hey,soulee<br /><br />yes, there is an error on running. it is a difficult problem toward me. I&#39;m going to errands. next time, i&#39;ll try together with you.<br /><br />regards</div>
    <div class="meta">Posted on 2005-09-07 00:36:35 by dcskm4200</div>
   </div>
   <div class="post" id="post-164331">
    <div class="subject"><a href="#post-164331">Re: How should I do? I want use IPicture object to save screen snap in  bmp file</a></div>
    <div class="body"><br />hello,<br /><br />the version using IPicture contained some errors, the most severe one using a wrong IID for IPicture.<br /><br />I did some modifications and now this version seems to run<br /><br /><pre><code><br /><br />.386<br />.Model Flat, StdCall<br />Option Casemap :None&nbsp;  <br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />Include \masm32\include\windows.inc<br />Include \masm32\include\user32.inc<br />Include \masm32\include\kernel32.inc<br />INCLUDE \masm32\include\Gdi32.inc<br />INCLUDE \masm32\include\oleaut32.inc<br />INCLUDE \masm32\include\ole32.inc<br /><br />IncludeLib \masm32\lib\user32.lib<br />IncludeLib \masm32\lib\kernel32.lib<br />INCLUDELIB \masm32\lib\Gdi32.lib<br />INCLUDELIB \masm32\lib\oleaut32.lib<br />INCLUDELIB \masm32\lib\ole32.lib<br /><br />INCLUDE \masm32\macros\macros.asm<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />IPicture_SaveAsFileProto&nbsp; &nbsp;  typedef proto :DWORD, :DWORD,:DWORD,:DWORD<br />IPicture_SaveAsFile&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; typedef ptr IPicture_SaveAsFileProto<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />IPicture STRUCT<br />&nbsp; &nbsp; ; IUnknown methods<br />&nbsp; &nbsp; QueryInterface&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; AddRef&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; Release&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />&nbsp; &nbsp; ; IPicture methods<br />&nbsp; &nbsp; get_Handle&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; get_hPal&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; get_Type&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; get_Width&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />&nbsp; &nbsp; get_Height&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; Render&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?&nbsp;  <br />&nbsp; &nbsp; set_hPal&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; get_CurDC&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />&nbsp; &nbsp; SelectPicture&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />&nbsp; &nbsp; get_KeepOriginalFormat&nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; put_KeepOriginalFormat&nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; PictureChanged&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; SaveAsFile&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IPicture_SaveAsFile&nbsp;  ?<br />&nbsp; &nbsp; get_Attributes&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />IPicture ENDS<br />;--------------------------------------------------------<br />PICTDESC_BMP STRUCT<br />&nbsp; &nbsp; cbSizeOfStruct&nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />&nbsp; &nbsp; PicType&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; hBitmap&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />&nbsp; &nbsp; hPal&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />;&nbsp; &nbsp; Reserved&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />PICTDESC_BMP ENDS<br />;--------------------------------------------------------<br />protoRelease&nbsp; typedef proto :DWORD<br />pRelease&nbsp; &nbsp; &nbsp; typedef ptr protoRelease<br />IStream_SetSizeProto&nbsp; &nbsp;  typedef proto :DWORD, :DWORD<br />IStream_SetSize&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; typedef ptr IStream_SetSizeProto<br />IStream STRUCT<br />&nbsp; &nbsp; ; IUnknown methods<br />&nbsp; &nbsp; QueryInterface&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; AddRef&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; Release&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  pRelease ?<br />&nbsp; &nbsp; ; IStream methods<br />&nbsp; &nbsp; Read&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; Write&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; Seek&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; SetSize&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IStream_SetSize&nbsp;  ?<br />&nbsp; &nbsp; CopyTo&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; Commit&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; Revert&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; LockRegion&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; UnlockRegion&nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />&nbsp; &nbsp; Stat&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; Clone&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />IStream ENDS<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.data<br />&nbsp; &nbsp; &nbsp; dwWrite&nbsp;  dw 0<br />;&nbsp;  IID_IPicture&nbsp;  GUID &lt;00020400h,0000h,0000h,&lt;0C0h,000h, 000h,000h, 000h, 000h, 000h,046h&gt;&gt;<br />&nbsp; &nbsp; IID_IPicture&nbsp;  GUID &lt;7BF80980h,0BF32h,101Ah,&lt;8Bh,0BBh,00h,0AAh,00h,30h,0Ch,0ABh&gt;&gt;<br /><br /><br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.data?<br />&nbsp;  szMessage&nbsp;  db 256 dup (?)<br />&nbsp;  seh&nbsp; &nbsp; &nbsp; dd 6 dup (?)<br />&nbsp;  buffer&nbsp; &nbsp; &nbsp; db 256 dup(?)<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.const<br />&nbsp;  szErrorThread&nbsp;  db 13, 10, &quot;Error at %08Xh&quot;, 13, 10, &quot;Registers:&quot;, 13, 10, &quot;eax = %08Xh ebx = %08Xh ecx = %08Xh&quot;, 13, 10, &quot;edx = %08Xh esp = %08Xh ebp = %08Xh&quot;, 13, 10, &quot;esi = %08Xh edi = %08Xh&quot;, 13, 10, 13, 10, &quot;Recovering...&quot;, 13, 10,0<br />&nbsp;  szErrorFinal&nbsp;  db 13, 10, &quot;Error at %08Xh&quot;, 13, 10, &quot;Quitting...&quot;, 13, 10, 0<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.code<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br /><br />m2m macro dest, src<br />	push src<br />&nbsp; &nbsp; pop dest<br />	endm<br /><br />ErrorHandler proc C lpExcept:DWORD, lpFrame:DWORD, lpContext:DWORD, lpDispatch:DWORD<br />&nbsp;  mov&nbsp;  eax, lpExcept<br />&nbsp;  mov&nbsp;  ecx, lpContext<br />&nbsp;  invoke&nbsp;  wsprintf, ADDR szMessage, ADDR szErrorThread, ,\<br />&nbsp; &nbsp; &nbsp; , , , ,\<br />&nbsp; &nbsp; &nbsp; , , , <br />&nbsp;  invoke MessageBox,NULL,&nbsp;  ADDR szMessage,&nbsp;  SADD(&quot;1_Error Occured&quot;),MB_ICONEXCLAMATION<br /><br />&nbsp;  mov&nbsp;  eax, lpContext<br />&nbsp;  m2m&nbsp;  , <br />&nbsp;  m2m&nbsp;  , <br />&nbsp;  m2m&nbsp;  , <br />&nbsp;  m2m&nbsp;  , <br />&nbsp;  m2m&nbsp;  , <br />&nbsp;  m2m&nbsp;  , <br /><br />&nbsp;  xor&nbsp;  eax, eax&nbsp;  ; continue execution<br />&nbsp;  ret<br />ErrorHandler endp<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />ExceptionFilter proc lpExcept:DWORD<br />&nbsp;  mov eax, lpExcept<br />&nbsp;  invoke wsprintf, ADDR szMessage, ADDR szErrorFinal, <br />&nbsp;  invoke MessageBox,NULL,&nbsp;  ADDR szMessage,&nbsp;  SADD(&quot;2_Error Occured&quot;),MB_ICONEXCLAMATION<br />&nbsp;  invoke ExitProcess, 0<br />&nbsp;  xor&nbsp;  eax, eax<br />&nbsp;  inc&nbsp;  eax&nbsp; &nbsp; &nbsp; ; EXCEPTION_EXECUTE_HANDLER<br />&nbsp;  ret<br />ExceptionFilter endp<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />_CreateBitmapPicture proc<br />&nbsp;  local hDCSrc ,hDCMemory,hBitmap,hOldBitmap<br />&nbsp;  local pPic,sStrm<br />&nbsp;  local dwWidth,dwHeight,dwByte<br />&nbsp;  local hPal,hPalPrev<br />&nbsp;  local hGlobal,hMem,lSize,@pData<br />&nbsp;  local HasPaletteScrn, PaletteSizeScrn<br />&nbsp;  local LogPal&nbsp;  :LOGPALETTE<br />&nbsp;  local pic&nbsp;  :PICTDESC_BMP<br />&nbsp;  Local @hFile:dword<br /><br />&nbsp;  mov hPal,NULL<br />&nbsp;  invoke&nbsp;  GetSystemMetrics,SM_CXSCREEN<br />&nbsp;  mov dwWidth,eax<br />&nbsp;  invoke&nbsp;  GetSystemMetrics,SM_CYSCREEN<br />&nbsp;  mov dwHeight,eax<br />&nbsp;  invoke GetDC,0<br />&nbsp;  mov hDCSrc,eax&nbsp;  <br />&nbsp;  invoke CreateCompatibleDC,eax<br />&nbsp;  mov hDCMemory,eax<br />&nbsp;  invoke CreateCompatibleBitmap,hDCSrc,dwWidth,dwHeight<br />&nbsp;  mov hBitmap,eax<br />&nbsp;  invoke SelectObject,hDCMemory,eax<br />&nbsp;  mov hOldBitmap,eax<br />&nbsp;  invoke GetDeviceCaps,hDCSrc,RASTERCAPS;Raster<br />&nbsp;  and eax,RC_PALETTE<br />&nbsp;  mov HasPaletteScrn,eax&nbsp;  ;Palette<br />&nbsp;  invoke GetDeviceCaps,hDCSrc,SIZEPALETTE&nbsp;  ;Size of<br />&nbsp;  mov PaletteSizeScrn,eax<br />&nbsp;  .if HasPaletteScrn &amp;&amp; (PaletteSizeScrn == 256)<br />&nbsp; &nbsp; &nbsp; mov LogPal.palVersion , 300h<br />&nbsp; &nbsp; &nbsp; mov LogPal.palNumEntries , 256<br />&nbsp; &nbsp; &nbsp; invoke GetSystemPaletteEntries,hDCSrc,0,256,addr LogPal.palPalEntry<br />&nbsp; &nbsp; &nbsp; invoke CreatePalette,addr LogPal<br />&nbsp; &nbsp; &nbsp; mov hPal,eax<br />&nbsp; &nbsp; &nbsp; invoke SelectPalette,hDCMemory,hPal,0<br />&nbsp; &nbsp; &nbsp; mov hPalPrev,eax<br />&nbsp; &nbsp; &nbsp; invoke RealizePalette,hDCMemory<br />&nbsp;  .endif<br />&nbsp;  invoke BitBlt,hDCMemory,0,0,dwWidth,dwHeight,hDCSrc,0,0,SRCCOPY<br />&nbsp;  invoke SelectObject,hDCMemory,hOldBitmap<br />&nbsp;  mov hBitmap,eax<br />&nbsp;  .if HasPaletteScrn &amp;&amp; (PaletteSizeScrn == 256)<br />&nbsp; &nbsp; &nbsp; &nbsp;  invoke SelectPalette,hDCMemory,hPalPrev,0<br />&nbsp; &nbsp; &nbsp; &nbsp;  mov hPal,eax<br />&nbsp;  .endif<br />&nbsp;  invoke ReleaseDC,0,hDCSrc<br />&nbsp;  invoke DeleteDC,hDCMemory<br />&nbsp;  <br />&nbsp;  mov pic.cbSizeOfStruct,sizeof pic&nbsp; &nbsp; &nbsp; ; Length of structure<br />&nbsp;  mov pic.PicType,1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; Type of Picture (bitmap)<br />&nbsp;  mov eax,hBitmap<br />&nbsp;  mov pic.hBitmap,eax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; Handle to bitmap<br />&nbsp;  mov eax,hPal<br />&nbsp;  mov pic.hPal,eax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; Handle to palette (may be null)<br /><br />&nbsp;  invoke OleCreatePictureIndirect,addr pic,addr IID_IPicture,TRUE,addr pPic<br />&nbsp;  .if eax!=S_OK<br />&nbsp; &nbsp; &nbsp; invoke MessageBox,0,SADD(&quot;OleCreatePictureIndirect&quot;),0,0<br />&nbsp;  .endif<br />&nbsp;  invoke CreateStreamOnHGlobal,NULL,TRUE,addr sStrm<br />&nbsp;  mov ebx,pPic<br />&nbsp;  mov ebx,<br />&nbsp;  invoke (IPicture ptr ).SaveAsFile,pPic,sStrm,TRUE,addr lSize&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;;;;;Here&nbsp; ERROR!!!<br />&nbsp;  .if eax!=S_OK<br />&nbsp; &nbsp; &nbsp; &nbsp;  invoke MessageBox,0,SADD(&quot;IPicture.SaveAsFile&quot;),0,MB_OK<br />&nbsp;  .endif<br />&nbsp;  invoke GetHGlobalFromStream,sStrm,addr hGlobal<br />&nbsp;  .if (eax == S_OK)<br />	&nbsp;  invoke CreateFile,SADD(&quot;scr_1.bmp&quot;),GENERIC_WRITE,0,NULL,CREATE_ALWAYS,FILE_ATTRIBUTE_NORMAL,NULL<br />	&nbsp;  mov @hFile,eax<br />&nbsp; &nbsp; &nbsp;  invoke GlobalLock, hGlobal<br />&nbsp; &nbsp; &nbsp;  mov ecx, eax<br />	&nbsp;  invoke WriteFile,@hFile,ecx,lSize,addr dwWrite, NULL<br />&nbsp; &nbsp; &nbsp;  invoke GlobalUnlock, hGlobal<br />	&nbsp;  invoke CloseHandle,@hFile<br />&nbsp;  .endif	<br />&nbsp;  mov ebx,sStrm<br />&nbsp;  mov ebx,<br />&nbsp;  invoke (IStream ptr ).Release,sStrm<br />&nbsp;  <br />&nbsp;  ret<br />_CreateBitmapPicture endp<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />start:<br />&nbsp;  invoke GetModuleHandle,NULL<br />&nbsp;  invoke SetUnhandledExceptionFilter, ADDR ExceptionFilter<br />&nbsp;  ; install the SEH-frame<br />&nbsp;  assume&nbsp;  fs:nothing<br />&nbsp;  push&nbsp;  OFFSET ErrorHandler<br />&nbsp;  push&nbsp;  FS:[0]<br />&nbsp;  mov&nbsp;  , esp<br />&nbsp;  mov&nbsp;  , ebp<br />&nbsp;  mov&nbsp;  , ebx<br />&nbsp;  mov&nbsp;  , esi<br />&nbsp;  mov&nbsp;  , edi<br />&nbsp;  mov&nbsp;  , OFFSET @@safe<br />&nbsp;  mov&nbsp;  FS:[0], esp<br />&nbsp;  <br />&nbsp;  ; critical code<br />&nbsp;  ; zero uninitialized data<br />;==============================================================================<br />&nbsp;  ; here is your code<br />&nbsp;  invoke _CreateBitmapPicture<br />&nbsp;  ;mov eax,0<br />&nbsp;  ;mov ecx,2<br />&nbsp;  ;div ecx<br />;==============================================================================<br />&nbsp;  push&nbsp;  edi<br />&nbsp;  push&nbsp;  esi<br />&nbsp;  push&nbsp;  ebx<br />@@exit:&nbsp;  <br />&nbsp;  pop&nbsp;  ebx<br />&nbsp;  pop&nbsp;  esi<br />&nbsp;  pop&nbsp;  edi<br />@@safe:&nbsp;  <br />&nbsp;  pop&nbsp;  FS:[0]<br />&nbsp;  jmp&nbsp;  ExitProcess<br />&nbsp;  invoke&nbsp;  ExitProcess,NULL<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br /><br />end start<br /><br /><br /></code></pre></div>
    <div class="meta">Posted on 2005-09-07 06:16:17 by japheth</div>
   </div>
   <div class="post" id="post-164333">
    <div class="subject"><a href="#post-164333">Re: How should I do? I want use IPicture object to save screen snap in  bmp file.</a></div>
    <div class="body">Hey ,jaheth:<br /><br />Thanks for your reply!<br /><br />You modify the code works&nbsp; in 16 bits or 32bits system very good. <br /><br />but it run in 8 bits has a wrong hapend .<br /><br />IPicture.SaveAsFile method returns not is&nbsp; S_OK. <br />Result is make a zero byte .bmp file.<br /><br />Still IID error?<br /><br /></div>
    <div class="meta">Posted on 2005-09-07 07:23:52 by soulee</div>
   </div>
   <div class="post" id="post-164336">
    <div class="subject"><a href="#post-164336">Re: How should I do? I want use IPicture object to save screen snap in  bmp file</a></div>
    <div class="body">&gt; Still IID error?<br /><br />No. And I cant help because on my system it works for 8bits as well :)<br /><br /></div>
    <div class="meta">Posted on 2005-09-07 08:52:01 by japheth</div>
   </div>
   <div class="post" id="post-164337">
    <div class="subject"><a href="#post-164337">Re: How should I do? I want use IPicture object to save screen snap in  bmp file.</a></div>
    <div class="body">Hey,jaheth:<br /><div class="quote">No. And I cant help because on my system it works for 8bits as well </div><br /><br />Can you post a your bilud exe file to me?<br /><br /><br />I visit your web site. I find a good tool ::ComView.<br />It is a excellent tool.<br /><br />I find  &quot;IUnknown {00000000-0000-0000-C000-000000000046}&quot; ,this GUID also can work in 16bits or 32bits.<br />but same,in 8bits don&#39;t work.<br /><br />My asm code come from a Visual  Basic code. <br />it can work very good in all bits.<br />it use SavePicture to save file.<br /><br /><pre><code>&#39;Create Picture<br />Private Const RC_PALETTE As Long = &amp;H100<br />Private Const SIZEPALETTE As Long = 104<br />Private Const RASTERCAPS As Long = 38<br />Private Type PALETTEENTRY<br />    peRed As Byte<br />    peGreen As Byte<br />    peBlue As Byte<br />    peFlags As Byte<br />End Type<br />Private Type LOGPALETTE<br />    palVersion As Integer<br />    palNumEntries As Integer<br />    palPalEntry(255) As PALETTEENTRY &#39; Enough for 256 colors<br />End Type<br />Private Type GUID<br />    Data1 As Long<br />    Data2 As Integer<br />    Data3 As Integer<br />    Data4(7) As Byte<br />End Type<br />Private Type PicBmp<br />    Size As Long<br />    Type As Long<br />    hBmp As Long<br />    hPal As Long<br />    Reserved As Long<br />End Type<br />Private Declare Function OleCreatePictureIndirect Lib &quot;olepro32.dll&quot; (PicDesc As PicBmp, RefIID As GUID, ByVal fPictureOwnsHandle As Long, IPic As IPicture) As Long<br />Private Declare Function CreateCompatibleDC Lib &quot;gdi32&quot; (ByVal hdc As Long) As Long<br />Private Declare Function CreateCompatibleBitmap Lib &quot;gdi32&quot; (ByVal hdc As Long, ByVal nWidth As Long, ByVal nHeight As Long) As Long<br />Private Declare Function SelectObject Lib &quot;gdi32&quot; (ByVal hdc As Long, ByVal hObject As Long) As Long<br />Private Declare Function GetDeviceCaps Lib &quot;gdi32&quot; (ByVal hdc As Long, ByVal iCapabilitiy As Long) As Long<br />Private Declare Function GetSystemPaletteEntries Lib &quot;gdi32&quot; (ByVal hdc As Long, ByVal wStartIndex As Long, ByVal wNumEntries As Long, lpPaletteEntries As PALETTEENTRY) As Long<br />Private Declare Function CreatePalette Lib &quot;gdi32&quot; (lpLogPalette As LOGPALETTE) As Long<br />Private Declare Function SelectPalette Lib &quot;gdi32&quot; (ByVal hdc As Long, ByVal hPalette As Long, ByVal bForceBackground As Long) As Long<br />Private Declare Function RealizePalette Lib &quot;gdi32&quot; (ByVal hdc As Long) As Long<br />Private Declare Function BitBlt Lib &quot;gdi32&quot; (ByVal hDestDC As Long, ByVal x As Long, ByVal y As Long, ByVal nWidth As Long, ByVal nHeight As Long, ByVal hSrcDC As Long, ByVal xSrc As Long, ByVal ySrc As Long, ByVal dwRop As Long) As Long<br />Private Declare Function DeleteDC Lib &quot;gdi32&quot; (ByVal hdc As Long) As Long<br />Public Declare Function GetDC Lib &quot;user32&quot; (ByVal hwnd As Long) As Long<br /><br />Private Function CreateBitmapPicture(ByVal hBmp As Long, ByVal hPal As Long) As IPicture<br />    Dim R As Long, Pic As PicBmp, IPic As IPicture, IID_IDispatch As GUID<br /><br />    &#39;Fill GUID info<br />    With IID_IDispatch<br />        .Data1 = &amp;H20400<br />        .Data4(0) = &amp;HC0<br />        .Data4(7) = &amp;H46<br />    End With<br /><br />    &#39;Fill picture info<br />    With Pic<br />        .Size = Len(Pic) &#39; Length of structure<br />        .Type = vbPicTypeBitmap &#39; Type of Picture (bitmap)<br />        .hBmp = hBmp &#39; Handle to bitmap<br />        .hPal = hPal &#39; Handle to palette (may be null)<br />    End With<br /><br />    &#39;Create the picture<br />    R = OleCreatePictureIndirect(Pic, IID_IDispatch, 1, IPic)<br /><br />    &#39;Return the new picture<br />    Set CreateBitmapPicture = IPic<br />End Function<br /><br />Public Function hDCToPicture(ByVal hDCSrc As Long, ByVal LeftSrc As Long, ByVal TopSrc As Long, ByVal WidthSrc As Long, ByVal HeightSrc As Long) As IPicture<br />    Dim hDCMemory As Long, hBmp As Long, hBmpPrev As Long, R As Long<br />    Dim hPal As Long, hPalPrev As Long, RasterCapsScrn As Long, HasPaletteScrn As Long<br />    Dim PaletteSizeScrn As Long, LogPal As LOGPALETTE<br /><br />    &#39;Create a compatible device context<br />    hDCMemory = CreateCompatibleDC(hDCSrc)<br />    &#39;Create a compatible bitmap<br />    hBmp = CreateCompatibleBitmap(hDCSrc, WidthSrc, HeightSrc)<br />    &#39;Select the compatible bitmap into our compatible device context<br />    hBmpPrev = SelectObject(hDCMemory, hBmp)<br /><br />    &#39;Raster capabilities?<br />    RasterCapsScrn = GetDeviceCaps(hDCSrc, RASTERCAPS) &#39; Raster<br />    &#39;Does our picture use a palette?<br />    HasPaletteScrn = RasterCapsScrn And RC_PALETTE &#39; Palette<br />    &#39;What&#39;s the size of that palette?<br />    PaletteSizeScrn = GetDeviceCaps(hDCSrc, SIZEPALETTE) &#39; Size of<br /><br />    If HasPaletteScrn And (PaletteSizeScrn = 256) Then<br />        &#39;Set the palette version<br />        LogPal.palVersion = &amp;H300<br />        &#39;Number of palette entries<br />        LogPal.palNumEntries = 256<br />        &#39;Retrieve the system palette entries<br />        R = GetSystemPaletteEntries(hDCSrc, 0, 256, LogPal.palPalEntry(0))<br />        &#39;Create the palette<br />        hPal = CreatePalette(LogPal)<br />        &#39;Select the palette<br />        hPalPrev = SelectPalette(hDCMemory, hPal, 0)<br />        &#39;Realize the palette<br />        R = RealizePalette(hDCMemory)<br />    End If<br /><br />    &#39;Copy the source image to our compatible device context<br />    R = BitBlt(hDCMemory, 0, 0, WidthSrc, HeightSrc, hDCSrc, LeftSrc, TopSrc, vbSrcCopy)<br /><br />    &#39;Restore the old bitmap<br />    hBmp = SelectObject(hDCMemory, hBmpPrev)<br /><br />    If HasPaletteScrn And (PaletteSizeScrn = 256) Then<br />        &#39;Select the palette<br />        hPal = SelectPalette(hDCMemory, hPalPrev, 0)<br />    End If<br /><br />    &#39;Delete our memory DC<br />    R = DeleteDC(hDCMemory)<br /><br />    Set hDCToPicture = CreateBitmapPicture(hBmp, hPal)<br />    <br />End Function<br /></code></pre><br /><br /></div>
    <div class="meta">Posted on 2005-09-07 08:54:46 by soulee</div>
   </div>
   <div class="post" id="post-164339">
    <div class="subject"><a href="#post-164339">Re: How should I do? I want use IPicture object to save screen snap in  bmp file</a></div>
    <div class="body"><br />&gt; I visit your web site. I find a good tool ::ComView.<br /><br />Oh thanks for reminding me. totally forgotten this thing&nbsp; ;).<br /><br />I checked the code once again. As I said, it worked on my system with 8bit palette, but now I wonder why, because there is another error in it:<br /><br />&nbsp;  local LogPal&nbsp;  :LOGPALETTE<br /><br />The LOGPALETTE struct is dangerous, because it has a variable sized array at its end (with items of type PALETTEENTRY). Your code fills the palNumEntries field with 256, but the declaration on the stack has only room for 1 entry, which is a pretty severe error. It didn&#39;t crash on my system because the GetSystemPaletteEntries function call - and its successors - failed.<br /><br />I would suggest to move the LogPal to the .DATA? section, with 255 PALETTEENTY items behind it as it is done in this code. May be it helps.<br /><br /><pre><code><br /><br />.386<br />.Model Flat, StdCall<br />Option Casemap :None&nbsp;  <br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />Include \masm32\include\windows.inc<br />Include \masm32\include\user32.inc<br />Include \masm32\include\kernel32.inc<br />INCLUDE \masm32\include\Gdi32.inc<br />INCLUDE \masm32\include\oleaut32.inc<br />INCLUDE \masm32\include\ole32.inc<br /><br />IncludeLib \masm32\lib\user32.lib<br />IncludeLib \masm32\lib\kernel32.lib<br />INCLUDELIB \masm32\lib\Gdi32.lib<br />INCLUDELIB \masm32\lib\oleaut32.lib<br />INCLUDELIB \masm32\lib\ole32.lib<br /><br />INCLUDE \masm32\macros\macros.asm<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />IPicture_SaveAsFileProto&nbsp; &nbsp;  typedef proto :DWORD, :DWORD,:DWORD,:DWORD<br />IPicture_SaveAsFile&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; typedef ptr IPicture_SaveAsFileProto<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />IPicture STRUCT<br />&nbsp; &nbsp; ; IUnknown methods<br />&nbsp; &nbsp; QueryInterface&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; AddRef&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; Release&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />&nbsp; &nbsp; ; IPicture methods<br />&nbsp; &nbsp; get_Handle&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; get_hPal&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; get_Type&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; get_Width&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />&nbsp; &nbsp; get_Height&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; Render&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?&nbsp;  <br />&nbsp; &nbsp; set_hPal&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; get_CurDC&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />&nbsp; &nbsp; SelectPicture&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />&nbsp; &nbsp; get_KeepOriginalFormat&nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; put_KeepOriginalFormat&nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; PictureChanged&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; SaveAsFile&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IPicture_SaveAsFile&nbsp;  ?<br />&nbsp; &nbsp; get_Attributes&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />IPicture ENDS<br />;--------------------------------------------------------<br />PICTDESC_BMP STRUCT<br />&nbsp; &nbsp; cbSizeOfStruct&nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />&nbsp; &nbsp; PicType&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; hBitmap&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />&nbsp; &nbsp; hPal&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />;&nbsp; &nbsp; Reserved&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />PICTDESC_BMP ENDS<br />;--------------------------------------------------------<br />protoRelease&nbsp; typedef proto :DWORD<br />pRelease&nbsp; &nbsp; &nbsp; typedef ptr protoRelease<br />IStream STRUCT<br />&nbsp; &nbsp; ; IUnknown methods<br />&nbsp; &nbsp; QueryInterface&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; AddRef&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; Release&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  pRelease ?<br />&nbsp; &nbsp; ; IStream methods<br />&nbsp; &nbsp; Read&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; Write&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; Seek&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; SetSize&nbsp; &nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />&nbsp; &nbsp; CopyTo&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; Commit&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; Revert&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; LockRegion&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; UnlockRegion&nbsp; &nbsp; &nbsp;  dd&nbsp;  ?<br />&nbsp; &nbsp; Stat&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />&nbsp; &nbsp; Clone&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp;  ?<br />IStream ENDS<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.data<br />&nbsp; &nbsp; &nbsp; dwWrite&nbsp;  dd 0<br />;&nbsp;  IID_IPicture&nbsp;  GUID &lt;00020400h,0000h,0000h,&lt;0C0h,000h, 000h,000h, 000h, 000h, 000h,046h&gt;&gt;<br />&nbsp; &nbsp; IID_IPicture&nbsp;  GUID &lt;7BF80980h,0BF32h,101Ah,&lt;8Bh,0BBh,00h,0AAh,00h,30h,0Ch,0ABh&gt;&gt;<br /><br /><br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.data?<br />&nbsp;  szMessage&nbsp;  db 256 dup (?)<br />&nbsp;  seh&nbsp; &nbsp; &nbsp; dd 6 dup (?)<br />&nbsp;  buffer&nbsp; &nbsp; &nbsp; db 256 dup(?)<br />&nbsp;  LogPal&nbsp;  LOGPALETTE &lt;&gt;<br />		PALETTEENTRY 255 dup (&lt;&gt;)<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.const<br />&nbsp;  szErrorThread&nbsp;  db 13, 10, &quot;Error at %08Xh&quot;, 13, 10, &quot;Registers:&quot;, 13, 10, &quot;eax = %08Xh ebx = %08Xh ecx = %08Xh&quot;, 13, 10, &quot;edx = %08Xh esp = %08Xh ebp = %08Xh&quot;, 13, 10, &quot;esi = %08Xh edi = %08Xh&quot;, 13, 10, 13, 10, &quot;Recovering...&quot;, 13, 10,0<br />&nbsp;  szErrorFinal&nbsp;  db 13, 10, &quot;Error at %08Xh&quot;, 13, 10, &quot;Quitting...&quot;, 13, 10, 0<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.code<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br /><br />m2m macro dest, src<br />	push src<br />&nbsp; &nbsp; pop dest<br />	endm<br /><br />ErrorHandler proc C lpExcept:DWORD, lpFrame:DWORD, lpContext:DWORD, lpDispatch:DWORD<br />&nbsp;  mov&nbsp;  eax, lpExcept<br />&nbsp;  mov&nbsp;  ecx, lpContext<br />&nbsp;  invoke&nbsp;  wsprintf, ADDR szMessage, ADDR szErrorThread, ,\<br />&nbsp; &nbsp; &nbsp; , , , ,\<br />&nbsp; &nbsp; &nbsp; , , , <br />&nbsp;  invoke MessageBox,NULL,&nbsp;  ADDR szMessage,&nbsp;  SADD(&quot;1_Error Occured&quot;),MB_ICONEXCLAMATION<br /><br />&nbsp;  mov&nbsp;  eax, lpContext<br />&nbsp;  m2m&nbsp;  , <br />&nbsp;  m2m&nbsp;  , <br />&nbsp;  m2m&nbsp;  , <br />&nbsp;  m2m&nbsp;  , <br />&nbsp;  m2m&nbsp;  , <br />&nbsp;  m2m&nbsp;  , <br /><br />&nbsp;  xor&nbsp;  eax, eax&nbsp;  ; continue execution<br />&nbsp;  ret<br />ErrorHandler endp<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />ExceptionFilter proc lpExcept:DWORD<br />&nbsp;  mov eax, lpExcept<br />&nbsp;  invoke wsprintf, ADDR szMessage, ADDR szErrorFinal, <br />&nbsp;  invoke MessageBox,NULL,&nbsp;  ADDR szMessage,&nbsp;  SADD(&quot;2_Error Occured&quot;),MB_ICONEXCLAMATION<br />&nbsp;  invoke ExitProcess, 0<br />&nbsp;  xor&nbsp;  eax, eax<br />&nbsp;  inc&nbsp;  eax&nbsp; &nbsp; &nbsp; ; EXCEPTION_EXECUTE_HANDLER<br />&nbsp;  ret<br />ExceptionFilter endp<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />_CreateBitmapPicture proc<br />&nbsp;  local hDCSrc ,hDCMemory,hBitmap,hOldBitmap<br />&nbsp;  local pPic,sStrm<br />&nbsp;  local dwWidth,dwHeight,dwByte<br />&nbsp;  local hPal,hPalPrev<br />&nbsp;  local hGlobal,hMem,lSize,@pData<br />&nbsp;  local HasPaletteScrn, PaletteSizeScrn<br />&nbsp;  local pic&nbsp;  :PICTDESC_BMP<br />&nbsp;  Local @hFile:dword<br /><br />&nbsp;  mov hPal,NULL<br />&nbsp;  invoke&nbsp;  GetSystemMetrics,SM_CXSCREEN<br />&nbsp;  mov dwWidth,eax<br />&nbsp;  invoke&nbsp;  GetSystemMetrics,SM_CYSCREEN<br />&nbsp;  mov dwHeight,eax<br />&nbsp;  invoke GetDC,0<br />&nbsp;  mov hDCSrc,eax&nbsp;  <br />&nbsp;  invoke CreateCompatibleDC,eax<br />&nbsp;  mov hDCMemory,eax<br />&nbsp;  invoke CreateCompatibleBitmap,hDCSrc,dwWidth,dwHeight<br />&nbsp;  mov hBitmap,eax<br />&nbsp;  invoke SelectObject,hDCMemory,eax<br />&nbsp;  mov hOldBitmap,eax<br />&nbsp;  invoke GetDeviceCaps,hDCSrc,RASTERCAPS;Raster<br />&nbsp;  and eax,RC_PALETTE<br />&nbsp;  mov HasPaletteScrn,eax&nbsp;  ;Palette<br />&nbsp;  invoke GetDeviceCaps,hDCSrc,SIZEPALETTE&nbsp;  ;Size of<br />&nbsp;  mov PaletteSizeScrn,eax<br />&nbsp;  .if HasPaletteScrn &amp;&amp; (PaletteSizeScrn == 256)<br />&nbsp; &nbsp; &nbsp; mov LogPal.palVersion , 300h<br />&nbsp; &nbsp; &nbsp; mov LogPal.palNumEntries , 256<br />&nbsp; &nbsp; &nbsp; invoke GetSystemPaletteEntries,hDCSrc,0,256,addr LogPal.palPalEntry<br />&nbsp; &nbsp; &nbsp; invoke CreatePalette,addr LogPal<br />&nbsp; &nbsp; &nbsp; mov hPal,eax<br />&nbsp; &nbsp; &nbsp; invoke SelectPalette,hDCMemory,hPal,0<br />&nbsp; &nbsp; &nbsp; mov hPalPrev,eax<br />&nbsp; &nbsp; &nbsp; invoke RealizePalette,hDCMemory<br />&nbsp;  .endif<br />&nbsp;  invoke BitBlt,hDCMemory,0,0,dwWidth,dwHeight,hDCSrc,0,0,SRCCOPY<br />&nbsp;  invoke SelectObject,hDCMemory,hOldBitmap<br />&nbsp;  mov hBitmap,eax<br />&nbsp;  .if HasPaletteScrn &amp;&amp; (PaletteSizeScrn == 256)<br />&nbsp; &nbsp; &nbsp; &nbsp;  invoke SelectPalette,hDCMemory,hPalPrev,0<br />;&nbsp; &nbsp; &nbsp; &nbsp;  mov hPal,eax<br />&nbsp;  .endif<br />&nbsp;  invoke ReleaseDC,0,hDCSrc<br />&nbsp;  invoke DeleteDC,hDCMemory<br />&nbsp;  <br />&nbsp;  mov pic.cbSizeOfStruct,sizeof pic&nbsp; &nbsp; &nbsp; ; Length of structure<br />&nbsp;  mov pic.PicType,1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; Type of Picture (bitmap)<br />&nbsp;  mov eax,hBitmap<br />&nbsp;  mov pic.hBitmap,eax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; Handle to bitmap<br />&nbsp;  mov eax,hPal<br />&nbsp;  mov pic.hPal,eax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; Handle to palette (may be null)<br /><br />&nbsp;  invoke OleCreatePictureIndirect,addr pic,addr IID_IPicture,TRUE,addr pPic<br />&nbsp;  .if eax!=S_OK<br />&nbsp; &nbsp; &nbsp; invoke MessageBox,0,SADD(&quot;OleCreatePictureIndirect&quot;),0,0<br />&nbsp;  .endif<br />&nbsp;  invoke CreateStreamOnHGlobal,NULL,TRUE,addr sStrm<br />&nbsp;  mov ebx,pPic<br />&nbsp;  mov ebx,<br />&nbsp;  invoke (IPicture ptr ).SaveAsFile,pPic,sStrm,TRUE,addr lSize&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;;;;;Here&nbsp; ERROR!!!<br />&nbsp;  .if eax!=S_OK<br />&nbsp; &nbsp; &nbsp; &nbsp;  invoke MessageBox,0,SADD(&quot;IPicture.SaveAsFile&quot;),0,MB_OK<br />&nbsp;  .endif<br />&nbsp;  invoke GetHGlobalFromStream,sStrm,addr hGlobal<br />&nbsp;  .if (eax == S_OK)<br />	&nbsp;  invoke CreateFile,SADD(&quot;scr_1.bmp&quot;),GENERIC_WRITE,0,NULL,CREATE_ALWAYS,FILE_ATTRIBUTE_NORMAL,NULL<br />	&nbsp;  mov @hFile,eax<br />&nbsp; &nbsp; &nbsp;  invoke GlobalLock, hGlobal<br />&nbsp; &nbsp; &nbsp;  mov ecx, eax<br />	&nbsp;  invoke WriteFile,@hFile,ecx,lSize,addr dwWrite, NULL<br />&nbsp; &nbsp; &nbsp;  invoke GlobalUnlock, hGlobal<br />	&nbsp;  invoke CloseHandle,@hFile<br />&nbsp;  .endif	<br />&nbsp;  mov ebx,sStrm<br />&nbsp;  mov ebx,<br />&nbsp;  invoke (IStream ptr ).Release,sStrm<br />&nbsp;  <br />&nbsp;  ret<br />_CreateBitmapPicture endp<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />start:<br />&nbsp;  invoke GetModuleHandle,NULL<br />&nbsp;  invoke SetUnhandledExceptionFilter, ADDR ExceptionFilter<br />&nbsp;  ; install the SEH-frame<br />&nbsp;  assume&nbsp;  fs:nothing<br />&nbsp;  push&nbsp;  OFFSET ErrorHandler<br />&nbsp;  push&nbsp;  FS:[0]<br />&nbsp;  mov&nbsp;  , esp<br />&nbsp;  mov&nbsp;  , ebp<br />&nbsp;  mov&nbsp;  , ebx<br />&nbsp;  mov&nbsp;  , esi<br />&nbsp;  mov&nbsp;  , edi<br />&nbsp;  mov&nbsp;  , OFFSET @@safe<br />&nbsp;  mov&nbsp;  FS:[0], esp<br />&nbsp;  <br />&nbsp;  ; critical code<br />&nbsp;  ; zero uninitialized data<br />;==============================================================================<br />&nbsp;  ; here is your code<br />&nbsp;  invoke _CreateBitmapPicture<br />&nbsp;  ;mov eax,0<br />&nbsp;  ;mov ecx,2<br />&nbsp;  ;div ecx<br />;==============================================================================<br />&nbsp;  push&nbsp;  edi<br />&nbsp;  push&nbsp;  esi<br />&nbsp;  push&nbsp;  ebx<br />@@exit:&nbsp;  <br />&nbsp;  pop&nbsp;  ebx<br />&nbsp;  pop&nbsp;  esi<br />&nbsp;  pop&nbsp;  edi<br />@@safe:&nbsp;  <br />&nbsp;  pop&nbsp;  FS:[0]<br />&nbsp;  jmp&nbsp;  ExitProcess<br />&nbsp;  invoke&nbsp;  ExitProcess,NULL<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br /><br />end start<br /><br /><br /></code></pre><br /> <br /><br /></div>
    <div class="meta">Posted on 2005-09-07 09:40:16 by japheth</div>
   </div>
   <div class="post" id="post-164340">
    <div class="subject"><a href="#post-164340">Re: How should I do? I want use IPicture object to save screen snap in  bmp file.</a></div>
    <div class="body">yes , I just&nbsp; thought of it.<br />but I don&#39;t know to modify it.<br /><br />I test your code. It is works as well in 8bits.<br /><br /> :P<br />japheth,thanks you very very much!<br /><br /></div>
    <div class="meta">Posted on 2005-09-07 09:54:02 by soulee</div>
   </div>
  </div>
 </body>
</html>