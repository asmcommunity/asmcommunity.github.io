<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>BHM File Format - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=29830" />
    <link rel="next" href="../?id=29830&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=10">Graphics &amp; Game Development</a> &raquo; <a href="../?id=29830">BHM File Format</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=29830&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=29830&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="29830" /><input type="number" name="page" min="1" max="7" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=29830&amp;page=2">&gt;</a><a href="../?id=29830&amp;page=7">&raquo;</a></form>   <div class="post" id="post-210776">
    <div class="subject"><a href="#post-210776">BHM File Format</a></div>
    <div class="body">I have mentioned it before on a few occassions, but now it&#039;s time to dedicate a thread to it.<br />The BHM file format is a format that was originally developed for the Bohemiq demosystem. I have recently decided to make the file format open, and release the code under the BSD license. I have created a project on SourceForge for this:<br />http://bhmfileformat.sourceforge.net<br />The summary of the project reads:<br /><em>&quot;A generic hierarchical file format. BHM can be seen as the binary equivalent of XML. It allows flexible hierarchies of any type of data, in a platform-independent way. BHM however trades XML&#039;s readability for compactness and speed of processing.&quot;</em><br /><br />That pretty much covers the idea of BHM. It is tree-based, like XML, and it is flexible in the use of node types/tags, like XML. However, it stores everything in binary, rather than in human-readable ASCII, which makes the file a lot more compact, and faster to parse. This is especially interesting for large arrays of data, such as vertex buffers, textures, audio etc.<br />For more information, see the attached README.txt from the project.<br /><br />In short, the file format is meant to be platform-independent. An exporter for 3dsmax6 is included in the project source code.<br />I am currently working on a platform-independent example program that will read such exported files from 3dsmax6, and display the scene, complete with animation (<a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=29617.msg210622#msg210622">the skinned claw model in my D3D Engine example</a> is a BHM file modeled in 3dsmax6. I will be using this file for the BHM example code aswell).<br />Exporters for other modelers should also be possible, and everyone is free to join the project to add support for other modelers, and expand the BHM format to support more 3D/animation primitives.</div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=3071" target="_blank">README.txt</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2010-02-15 03:50:37 by Scali</div>
   </div>
   <div class="post" id="post-210792">
    <div class="subject"><a href="#post-210792">Re: BHM File Format</a></div>
    <div class="body">ChunkInfo has a uint Type and TreeNodeInfo has a uint Type<br />I&#039;ve only read the readme but it seems like TreeNodeInfo.ChunkID correlates with ChunkInfo.ID, in which case the repeated ChunkInfo.Type is unnecessary.<br /><br />Also, why not combine the two structures and just have <br /><div class="quote">typedef struct {<br />	unsigned int numchildren;<br /><br />	unsigned int type;<br /><br />	unsigned int datasize;<br />	unsigned int totalsize;<br /><br />	unsigned int dataoffs;<br />} TreeNodeInfo;</div><br /><br />If I&#039;m understanding correctly TreeNodeInfo and ChunkInfo have a 1 to 1 relationship, as a result normalizing with the ID relation is inefficient.<br /><br />Actually making datasize and total size part of the data pointed to by dataoffs would be the most efficient.<br /><div class="quote"><br />File Header:<br /><br /><br />Tree Node Info Array: <br />[#of children]<br />[#of childrend] <br />... <br />[#of childrend]<br /><br />Binary Data: (each entry 16byte aligned)<br />dataoffs1: [8byte pad]<br />dataoffs2: [8byte pad]<br />...<br />dataoffsN: [8byte pad]<br /></div><br /><br />?</div>
    <div class="meta">Posted on 2010-02-15 20:19:58 by r22</div>
   </div>
   <div class="post" id="post-210796">
    <div class="subject"><a href="#post-210796">Re: BHM File Format</a></div>
    <div class="body">The tree structure is decoupled from the chunks.<br />The tree just describes how the data is structured (the size of the data, or the offset from the start of the chunk don&#039;t seem to be relevant to the structure of the data, they&#039;d just make the tree more bloated). The chunks merely store the data (which is why that&#039;s where the size is stored... You don&#039;t need to look at the tree to load the data and find the next chunk). They are not required to be in any specific order (which can give you more freedom in modifying files).<br />If you were to combine them, you&#039;d need to scan through the whole file just to retrieve the tree.<br />With the current file layout, you can simply load the whole tree in one go, and rebuild it in memory.<br />You can then use this tree to determine which chunks you may be interested in, and then retrieve them from the rest of the file.<br />The type field in the chunk info is not strictly required, but it doesn&#039;t hurt to store it there. It might be useful when dealing with broken files.<br /><br />One concern I do have though... we didn&#039;t decide on using 64-bit integers back when we designed the format. This means that a single chunk is limited to 4 GB. Other than that, there are no limitations though.<br />Perhaps an extended chunk format should be designed to handle such large chunks. By making use of the dataoffset value, you can put extended info in the chunk header, and remain backwards compatible.</div>
    <div class="meta">Posted on 2010-02-16 03:33:54 by Scali</div>
   </div>
   <div class="post" id="post-210876">
    <div class="subject"><a href="#post-210876">Re: BHM File Format</a></div>
    <div class="body">Hum, I&#039;ve played around a bit with OpenGL under FreeBSD, but I found that although I have an Intel G31 chipset in my FreeBSD box, which technically is an SM2.0 part, and has OpenGL 2.0 support under Windows... in FreeBSD I am not that lucky.<br />I wanted to use GLSL to implement the skinning in a vertexshader, but ARB_VERTEX_SHADER is not supported. It does support ARB_VERTEX_PROGRAM, but at this point I&#039;m not sure if I want to implement it with that.<br />I think I will just concentrate on the Windows-version of the sample program for BHM loading and animation for now, and worry about other OSes later. In theory the GLSL version should also work on FreeBSD/linux, I just cannot test it on my own machine at this point.<br />Perhaps once the GLSL version is done, it&#039;s not that much extra work to make an ARB_VERTEX_PROGRAM version, in theory I would only have to rewrite a single shader.</div>
    <div class="meta">Posted on 2010-02-24 02:54:46 by Scali</div>
   </div>
   <div class="post" id="post-210898">
    <div class="subject"><a href="#post-210898">Re: BHM File Format</a></div>
    <div class="body">Played around a bit more, and I&#039;m definitely giving up on FreeBSD now... According to glxinfo, my Intel chip+driver supports ARB_vertex_buffer_object, but when I try to use it, I get a vague crash... not even during the creation of the VBOs, but after that.<br />So I thought perhaps my code was broken... so I decided to download some VBO tutorial and build that on my box... Did the exact same thing.<br /><br />Another thing that shows how D3D has &#039;deformed&#039; me... There doesn&#039;t seem to be a &#039;default&#039; math library for OpenGL, something like D3DX. The basic matrix/vector math in the OpenGL API is very limited. There are a few &#039;usual suspects&#039; as addons for OpenGL, such as GLU, GLUT and GLEW.<br />But it seems like there&#039;s no &#039;usual suspect&#039; for a sort of D3DX replacement.<br />In fact, even the datatypes of OGL themselves are barely datatypes... you just get flat arrays of GLfloat and related types, which are supposed to represent colour, vertex, normal, texcoord, matrix and that sort of data.<br /><br />On my travels I found various attempts at such a library, most of them in various stages of incompleteness... I did however find two that were reasonably promising... GLM and CML.<br />I think I&#039;ll give CML a try, it gave the best first impression of the two.</div>
    <div class="meta">Posted on 2010-03-01 08:37:55 by Scali</div>
   </div>
   <div class="post" id="post-210899">
    <div class="subject"><a href="#post-210899">Re: BHM File Format</a></div>
    <div class="body">nvMath suits my needs and style. It&#039;s buried deep in nvSDK9.5/10.5 (is not announced anywhere or listed in google) . It doesn&#039;t have SSE, but might be worth a look. It was easy to convert the stuff to left-hand. </div>
    <div class="meta">Posted on 2010-03-01 09:42:53 by Ultrano</div>
   </div>
   <div class="post" id="post-210928">
    <div class="subject"><a href="#post-210928">Re: BHM File Format</a></div>
    <div class="body"><div class="quote"><br />Played around a bit more, and I&#039;m definitely giving up on FreeBSD now... According to glxinfo, my Intel chip+driver supports ARB_vertex_buffer_object, but when I try to use it, I get a vague crash... not even during the creation of the VBOs, but after that.<br />So I thought perhaps my code was broken... so I decided to download some VBO tutorial and build that on my box... Did the exact same thing.</div><br /><br />I suddenly had this suspicion of what might go wrong in FreeBSD... As I said, it didn&#039;t crash DURING the creation of the VBOs, but it crashed at a later point.<br />It crashed when I entered the glutMainLoop().<br />I left my VBOs in a bound state though... as I use VBOs exclusively throughout my program.<br />In Windows this works correctly, and judging from the sample code I&#039;ve found around the web, it is common practice to not explicitly call glBindBuffers() with 0 to &#039;unbind&#039; the buffer after use.<br />As long as you don&#039;t do anything that requires geometry from something other than a VBO, it should be perfectly valid to leave the buffers bound.<br />However, that may be the problem with the runtime in FreeBSD. It may be using some kind of draw calls in the background when glutMainLoop() starts and opens the window, because that&#039;s where it went wrong.<br /><br />So, after the initial initialization, I &#039;unbound&#039; my VBOs, to see what happens. Instead of nothing happening at all, I could now see the glut window appearing, and a single frame being rendered, before it crashed.<br />Apparently I was on to something there...<br />So I figured... there might be some more VBO-incompatible stuff going on in glutSwapBuffers() or such... So after my draw calls I again &#039;unbound&#039; my VBOs, and yay, it works.<br /><br />That still doesn&#039;t get me very far, as I still lack GLSL support in FreeBSD... but at least the extensions I DO have actually work now :)<br />It also begs the question: who is right? If the FreeBSD runtime is the &#039;correct&#039; way and leaving VBOs bound is not the way to do it, it just &#039;accidentally&#039; works on some implementations... then I guess there&#039;s a LOT of broken code out there.</div>
    <div class="meta">Posted on 2010-03-07 12:13:23 by Scali</div>
   </div>
   <div class="post" id="post-210929">
    <div class="subject"><a href="#post-210929">Re: BHM File Format</a></div>
    <div class="body">There&#039;s no way FreeBSD&#039;s implementation is correct. The specs state clearly that only specific geometry-defining calls are affected by bound VBOs, just as you expected. </div>
    <div class="meta">Posted on 2010-03-07 21:51:47 by Ultrano</div>
   </div>
   <div class="post" id="post-210931">
    <div class="subject"><a href="#post-210931">Re: BHM File Format</a></div>
    <div class="body"><div class="quote"><br />There&#039;s no way FreeBSD&#039;s implementation is correct. The specs state clearly that only specific geometry-defining calls are affected by bound VBOs, just as you expected. <br /></div><br /><br />That part is clear yes, but the question is more: Does FreeBSD (or GLUT) use geometry-defining calls in parts of its runtime (eg, it may use a textured quad to render to the desktop window)? And if so, is that allowed?<br />I use freeglut on Windows, and the standard glut that is bundled with Mesa on FreeBSD, so I wonder if they are different. I could try using freeglut on BSD...<br />However, since I use Mesa (with the Tungsten Intel drivers), X.Org and KDE, one would think that the environment is pretty much identical to a linux installation, I wonder what happens there (then again, the VBO sample code I tried was probably developed for linux aswell).</div>
    <div class="meta">Posted on 2010-03-08 02:12:27 by Scali</div>
   </div>
   <div class="post" id="post-210932">
    <div class="subject"><a href="#post-210932">Re: BHM File Format</a></div>
    <div class="body">I&#039;d check the srccode of said libs and x-server, and also post this in a bug-tracker or forum/maillist. </div>
    <div class="meta">Posted on 2010-03-08 05:43:31 by Ultrano</div>
   </div>
   <div class="post" id="post-210934">
    <div class="subject"><a href="#post-210934">Re: BHM File Format</a></div>
    <div class="body"><div class="quote"><br />I&#039;d check the srccode of said libs and x-server, and also post this in a bug-tracker or forum/maillist. <br /></div><br /><br />I&#039;ve reported it to the FreeBSD team... I&#039;ll leave it up to them to figure out whether it&#039;s FreeBSD-specific, Intel-specific, Mesa-glut specific or otherwise.</div>
    <div class="meta">Posted on 2010-03-08 11:42:40 by Scali</div>
   </div>
   <div class="post" id="post-210952">
    <div class="subject"><a href="#post-210952">Re: BHM File Format</a></div>
    <div class="body">Hummm... it looks like AMD&#039;s OpenGL drivers still aren&#039;t all that great.<br />I added a simple FPS counter to my code, to get an idea of how well things are running so far.<br />I rendered a single triangle, using static VBOs, which should theoretically be the fastest way to render them.<br />First I tried on my laptop with Intel X3100. It got around 1000 fps, in Vista 32-bit.<br />Then on my desktop with Radeon HD5770. About 1500 fps in Vista 64-bit. Then I tried in Windows 7 64-bit, closer to 2000 fps.<br />Now I was getting curious.... Apparently there&#039;s quite a bit of CPU overhead somewhere, because the GPU should be WAY faster than the X3100, not just 1.5-2x as fast (especially since I also have a 1.5 GHz Core2 Duo in my laptop and a 3 GHz Core2 Duo in my desktop). What&#039;s more, if I run the ENTIRE BHM scene in D3D9/10/11 (as opposed to just a single triangle), animated, per-pixel lit and everything, I get about 6000 fps still, on the HD5770.<br />So I tried it in XP, which is generally slightly faster in windowed mode (gets about 7000 fps on my HD5770). Now I got about 3500 fps... that&#039;s more like it, but still a far cry from D3D9 performance.<br /><br />Now AMD&#039;s drivers have a bit more overhead than nVidia&#039;s anyway... Because on an old Pentium 4 system I have, with a GeForce 9800GTX (which is quite a bit slower than a HD5770), I would get 7000 fps in Vista/Win7, and 8000 fps in XP.<br />So f0dder ran the OpenGL thingie for me on his machine with Windows 7 and a GeForce. He got over 5000 fps... So apparently the overhead is mostly in AMD&#039;s OpenGL implementation. Even on nVidia&#039;s implementation, it&#039;s not *quite* as low overhead as D3D, but still it&#039;s considerably better than AMD.<br /><br />So... what do I conclude from this so far?<br />- Contrary to popular belief, basic driver overhead in D3D is lower than in OpenGL, in practice.<br />- Windowed mode 3d graphics have slightly more overhead on Vista/Windows 7 than on XP.<br />- The difference in overhead between Vista/Windows 7 and XP is larger with AMD than with nVidia.<br />- The overhead in AMD&#039;s drivers is higher than in nVidia&#039;s drivers.<br />- In OpenGL, the difference in overhead between AMD&#039;s and nVidia&#039;s drivers is significant.<br /><br />In practice it probably won&#039;t make that much of a difference though.<br />Namely:<br />- 1000 fps means 1 ms per frame<br />- 8000 fps means 0.125 ms per frame<br />- 60 fps means 16.667 ms per frame<br /><br />So, if we assume all of the difference fo rendering at 1000 fps vs 8000 fps to be overhead, then that means the driver will have 0.875 ms overhead per frame.<br />Now, if you were to translate that to the 60 fps figure, an extra 0.875 ms overhead per frame would only only make a difference of about 3 fps. So it&#039;s very marginal.<br />Once the OpenGL code can also render and animate the entire BHM file, I can do a more direct comparison. Frankly I don&#039;t expect the framerate to drop much, if at all, when it has to render the entire scene. I&#039;ll just have to wait and see if I&#039;m right about that.</div>
    <div class="meta">Posted on 2010-03-11 03:18:31 by Scali</div>
   </div>
   <div class="post" id="post-210953">
    <div class="subject"><a href="#post-210953">Re: BHM File Format</a></div>
    <div class="body">Single-triangle scenes are far from a viable benchmark :P<br />I&#039;ve had such scenes run at 22-25k fps, 720p; means nothing. <br />Or again, 12500 fps to render a whole CSS map in a 64x64, with texlod-biasing. </div>
    <div class="meta">Posted on 2010-03-11 03:41:15 by Ultrano</div>
   </div>
   <div class="post" id="post-210955">
    <div class="subject"><a href="#post-210955">Re: BHM File Format</a></div>
    <div class="body"><div class="quote"><br />Single-triangle scenes are far from a viable benchmark :P<br />I&#039;ve had such scenes run at 22-25k fps, 720p; means nothing. <br />Or again, 12500 fps to render a whole CSS map in a 64x64, with texlod-biasing. <br /></div><br /><br />They&#039;re a viable benchmark for the overhead because they measure everything in the OpenGL runtime and the rendering framework, with minimal actual geometry.<br />All the states are processed, lights and geometry are set, screen is cleared every frame, etc.<br />So I measure all the overhead, and the actual time spent rendering the scene is negligible, as it&#039;s just a single triangle (which, unlike NOT rendering anything, doesn&#039;t give the driver any opportunity to &#039;cheat&#039; and skip setting states altogether, if it has some kind of lazy/optimized state machine).<br /><br />And yes, I know you can do better, you always can. You tell that in every post. Problem is, I don&#039;t care. It&#039;s not a contest.</div>
    <div class="meta">Posted on 2010-03-11 03:51:13 by Scali</div>
   </div>
   <div class="post" id="post-210956">
    <div class="subject"><a href="#post-210956">Re: BHM File Format</a></div>
    <div class="body">These &quot;overhead benchmarks&quot; vary greatly even between minor driver revisions. And I was telling that there are drivers that can transform and lit a whole scene two times faster than the one-triangle bench. This overhead is not &quot;0.875ms lost time&quot;, it gets masked once you start drawing actual geometry. </div>
    <div class="meta">Posted on 2010-03-11 04:12:59 by Ultrano</div>
   </div>
   <div class="post" id="post-210958">
    <div class="subject"><a href="#post-210958">Re: BHM File Format</a></div>
    <div class="body"><div class="quote"><br />These &quot;overhead benchmarks&quot; vary greatly even between minor driver revisions. And I was telling that there are drivers that can transform and lit a whole scene two times faster than the one-triangle bench. This overhead is not &quot;0.875ms lost time&quot;, it gets masked once you start drawing actual geometry. <br /></div><br /><br />I don&#039;t think you understood my post. I didn&#039;t say anything like that. But I&#039;m not going to bother to explain and clarify.<br />I let you do your thing... Why don&#039;t you let me do mine...</div>
    <div class="meta">Posted on 2010-03-11 04:18:22 by Scali</div>
   </div>
   <div class="post" id="post-210960">
    <div class="subject"><a href="#post-210960">Re: BHM File Format</a></div>
    <div class="body">ok</div>
    <div class="meta">Posted on 2010-03-11 04:50:53 by Ultrano</div>
   </div>
   <div class="post" id="post-210980">
    <div class="subject"><a href="#post-210980">Re: BHM File Format</a></div>
    <div class="body"><br />Hey, since I got back into opengl, I have to ask you about your file format.<br />I just implementing code for MS3D extension (skinmesh with skinweights) and I was wondering if you had expressed a format for animation bones and keyframes, and what it looks like.<br />If it looks nice, I&#039;ll write import/export code and support it.<br /></div>
    <div class="meta">Posted on 2010-03-12 00:59:05 by Homer</div>
   </div>
   <div class="post" id="post-210982">
    <div class="subject"><a href="#post-210982">Re: BHM File Format</a></div>
    <div class="body">Well, I don&#039;t know all the details from the top of my head...<br />But roughly, it supports standard keyframing animation, based on the rotation and position keys as 3dsmax uses them.<br />The skeleton is exported the same way (3dsmax even exports the actual geometry for it), so you get a bunch of objects with animation keys attached to them.<br />Skinning in an object is implemented by having a reference to the bone names in the skeleton. So each object knows which bones will affect it.<br />You then animate the skeleton the same way as regular objects (but don&#039;t draw it, obviously), which gives you the resulting bone matrices in world space. These will then be used as a matrix palette, which is indexed in the shader.</div>
    <div class="meta">Posted on 2010-03-12 03:52:16 by Scali</div>
   </div>
   <div class="post" id="post-211056">
    <div class="subject"><a href="#post-211056">Re: BHM File Format</a></div>
    <div class="body">Last night, I did a quick port of the basic BHM file code to FreeBSD.<br />The OpenGL engine can now load the geometry and the camera from the BHM file, on both Windows and FreeBSD (and theoretically it should also work on similar OSes such as linux, Solaris, OS X etc).<br /><br />There are now two steps left to complete the BHM sample:<br />- Interpolation of the animation keyframe data.<br />- Shaders for the skinning animation.<br /><br />So far, I&#039;m not too happy with the cml library that I chose as the underlying math library. It&#039;s rather clunky to use, since it isn&#039;t that easy to just take an array of OpenGL float data, and interpret it as a vector or array (like how D3DX seamlessly blends in with the standard D3D types).<br />I haven&#039;t exactly decided what to do about that yet.<br />Before cml, I had made my own basic data wrappers, which work more like D3DX. So far they were just for data storage, and they don&#039;t actually support any math operations yet. I could extend these wrappers and use cml internally, so the code remains easy and intuitive to read.<br />I could also give GLM a look, it may integrate with OpenGL better than cml does.<br />Or I could just give up on my idea to keep it clean and simple, and just build the entire math lib myself.<br />It almost looks like the OpenGL world needs such a math lib. Thing is just that I don&#039;t feel I&#039;m the right person to build and maintain such a library, and especially not as part of this project.</div>
    <div class="meta">Posted on 2010-03-18 04:51:11 by Scali</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=29830&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=29830&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="29830" /><input type="number" name="page" min="1" max="7" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=29830&amp;page=2">&gt;</a><a href="../?id=29830&amp;page=7">&raquo;</a></form>  </div>
 </body>
</html>