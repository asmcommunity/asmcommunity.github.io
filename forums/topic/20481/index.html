<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>FStream (ATC) oop class for File IO - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=20481" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=38">Object Oriented Programming</a> &raquo; <a href="../?id=20481">FStream (ATC) oop class for File IO</a></p>
   <div class="post" id="post-156592">
    <div class="subject"><a href="#post-156592">FStream (ATC) oop class for File IO</a></div>
    <div class="body">**EDIT** Revised SetPointer Method - better error handling and correct 64bit filepointer handling<br /><br />Here is the most recent version of FStream.<br />Feel free to remove or comment the DEBUG stuff - in fact, do whatever you like with it.. I don't mind how you use this code module.<br /><br /><br /><pre><code><br />;This class provides support for general-purpose file IO.<br /><br /><br />;FStream_Open will fetch the size of existing file to 'internal size'<br />;FStream_Put will add the size of file write to 'internal size'<br />;Killing instance closes the file<br /><br />class FStream, ,C++ compatible<br />    virtual Open&#58;pName                          ;Opens a new OR existing file for read/write<br />    virtual Put&#58;pData, dwData                 ;Writes Data of given Size to file<br />    virtual Get&#58;ppData, dwData              ;Reads Data of given Size from file<br />    virtual SetName&#58;pName                   ;Called by FStream_Open<br />    virtual SetPointer&#58;dwLow, dwHigh<br />    virtual ReadLine&#58;pReturnString<br />    long pName<br />    long hFile<br />    long SizeLow<br />    long SizeHigh<br />endclass<br /><br />FStream_ReadLine proc pReturnString<br />local DidRead<br />local _done<br />local dwsize<br />local hfile<br />local buf&#91;2&#93;&#58;BYTE<br /><br />mov _done,FALSE<br />mov dwsize,0<br />mov edi,pReturnString<br />m2m hfile,&#91;ecx&#93;.FStream.hFile<br />.repeat<br />        invoke ReadFile,hfile,addr buf,1,addr DidRead,0<br />        .if buf&#91;0&#93;==0<br />@@&#58;<br />            mov _done,TRUE<br />            .break<br />        .elseif buf&#91;0&#93;==13<br />            .if dwsize==0<br />                mov byte ptr&#91;edi&#93;,255        <br />            .else<br />                    mov byte ptr&#91;edi&#93;,0        <br />            .endif<br />            inc edi<br />            inc dwsize   <br />            invoke ReadFile,hfile,addr buf&#91;1&#93;,1,addr DidRead,0<br />            .if buf&#91;1&#93;!=10<br />                invoke SetFilePointer,hfile,-1, NULL, FILE_CURRENT                                <br />            .endif<br />            jmp @B<br />        .elseif buf&#91;0&#93;==10  <br />            jmp @B<br />        .else<br />            mov al,buf&#91;0&#93;<br />            mov byte ptr&#91;edi&#93;,al        <br />            inc edi<br />            inc dwsize<br />        .endif<br /><br />.until _done==TRUE<br />mov byte ptr&#91;edi&#93;,0<br />return dwsize<br />FStream_ReadLine endp<br /><br />FStream_SetPointer proc dwLow,dwHigh<br />    invoke SetFilePointer, &#91;ecx&#93;.FStream.hFile, dwLow, addr dwHigh, FILE_BEGIN<br />    .if eax==-1<br />        invoke GetLastError<br />        .if eax!=NO_ERROR<br />            if __DEBUG__<br />                LogDWORD CTEXT&#40;&quot;&lt;FStream Failed to Set FilePointer - Error %lu&quot;&#41;,eax<br />            endif<br />            return FALSE<br />        .endif<br />    .endif<br />    if __DEBUG__<br />        LogDWORD CTEXT&#40;&quot;&lt;FStream Set FilePointer to %lu&quot;&#41;,dwHigh<br />        LogDWORD CTEXT&#40;&quot;, %lu&gt;&quot;,13,10&#41;,dwLow<br />    endif<br />    return TRUE<br />FStream_SetPointer endp<br /><br />FStream_Put proc pData&#58;DWORD, dwData&#58;DWORD<br />local DidWrite&#58;DWORD <br />    if __DEBUG__<br />        LogDWORD CTEXT&#40;&quot;&lt;FStream Put %lu bytes&quot;&#41;,dwData<br />        LogDWORD CTEXT&#40;&quot; to %s&gt;&quot;,13,10&#41;,&#91;ecx&#93;.FStream.pName<br />    endif<br />WriteMore&#58;<br />  push ecx<br />  invoke WriteFile, &#91;ecx&#93;.FStream.hFile, pData,dwData, addr DidWrite,0<br />  pop ecx<br />  .if eax!=0<br />        mov eax,DidWrite<br />        sub dwData,eax<br />        add eax,pData<br />        clc<br />        add &#91;ecx&#93;.FStream.SizeLow,eax<br />        jnc @F<br />           inc &#91;ecx&#93;.FStream.SizeHigh<br />   .else<br />        invoke GetLastError<br />        $Message &quot;Write Error in FStream - %lu&quot;,eax<br />   .endif<br />@@&#58;<br />    .if dwData!=0<br />        jmp WriteMore<br />    .endif<br />    ret<br />FStream_Put endp<br /><br />;=====================================================<br />FStream_Get proc ppData, dwData<br />local DidRead<br />local dwTotalRead<br /><br />    if __DEBUG__<br />        LogDWORD CTEXT&#40;&quot;&lt;FStream Get %lu bytes&quot;&#41;,dwData<br />        LogDWORD CTEXT&#40;&quot; from %s&gt;&quot;,13,10&#41;,&#91;ecx&#93;.FStream.pName<br />    endif<br />   <br />    mov dwTotalRead,0<br /><br />.while dwData!=0<br />    push ecx<br />    invoke ReadFile, &#91;ecx&#93;.FStream.hFile, ppData, dwData, addr DidRead,0<br />    pop ecx<br />    .if eax==FALSE<br />        $Message &quot;Error reading from file %s&quot;,&#91;ecx&#93;.FStream.pName<br />        invoke GetLastError<br />        .if eax==ERROR_HANDLE_EOF<br />            Message &quot;FStream Get EOF&quot;<br />            if __DEBUG__<br />                Log CTEXT&#40;&quot;&lt;FStream Get EOF&gt;&quot;,13,10&#41;<br />            endif<br />        .else<br />            $Message &quot;ErrorCode=%lu&quot;,eax<br />        .endif<br />    .else<br />        .if DidRead==0<br />            if __DEBUG__<br />                Message &quot;FStream Get EOF&quot;<br />                Log CTEXT&#40;&quot;&lt;FStream Get EOF&gt;&quot;,13,10&#41;<br />                jmp @F<br />            endif<br />        .else<br />            mov eax,DidRead<br />            add dwTotalRead,eax<br />            sub dwData,eax<br />            add ppData,eax<br />        .endif<br />    .endif<br />.endw<br />@@&#58;<br />        if __DEBUG__<br />        LogDWORD CTEXT&#40;&quot;&lt;FStream Got %lu bytes&gt;&quot;,13,10&#41;,dwTotalRead<br />        endif<br />    return dwTotalRead<br />FStream_Get endp<br /><br />FStream_SetName proc pName<br />    .if &#91;ecx&#93;.FStream.pName!=0<br />        free &#91;ecx&#93;.FStream.pName<br />    .endif<br />    invoke AllocString, pName<br />    mov &#91;ecx&#93;.FStream.pName, eax<br />    ret<br />FStream_SetName endp<br /><br />FStream_Open proc pName<br />local HighSize<br />local me<br />    mov me,ecx <br />    icall me, FStream, SetName, pName<br />    invoke CreateFile, pName, GENERIC_READ or GENERIC_WRITE,FILE_SHARE_READ or FILE_SHARE_WRITE,NULL, OPEN_ALWAYS, 0,0<br />    .if eax!=INVALID_HANDLE_VALUE<br />        mov ecx,me<br />        mov &#91;ecx&#93;.FStream.hFile,eax<br />        invoke GetLastError<br />        .if eax==ERROR_ALREADY_EXISTS<br />            if __DEBUG__<br />                LogDWORD CTEXT&#40;&quot;&lt;FStream Opened Existing File '%s'.&gt;&quot;,13,10&#41;,pName<br />            endif<br />            mov ecx,me<br />            invoke GetFileSize,  &#91;ecx&#93;.FStream.hFile, addr HighSize<br />            mov ecx,me<br />            mov &#91;ecx&#93;.FStream.SizeLow,eax<br />            m2m &#91;ecx&#93;.FStream.SizeHigh,HighSize<br />            if __DEBUG__<br />                LogDWORD CTEXT&#40;&quot;&lt;FStream Opened Existing File of Size %lu&quot;,13,10&#41;,&#91;ecx&#93;.FStream.SizeHigh<br />                LogDWORD CTEXT&#40;&quot;, %lu .&gt;&quot;,13,10&#41;,&#91;ecx&#93;.FStream.SizeLow<br />            endif<br />        .else<br />            if __DEBUG__<br />                LogDWORD CTEXT&#40;&quot;&lt;FStream Created New File '%s'&gt;&quot;,13,10&#41;,pName<br />            endif<br />            mov ecx,me<br />            mov &#91;ecx&#93;.FStream.SizeLow,0<br />            mov &#91;ecx&#93;.FStream.SizeHigh,0<br />            icall ecx, FStream, SetPointer, 0, 0<br />        .endif   <br />        icall me, FStream, SetPointer, 0, 0         <br />        return S_OK<br />    .else<br />            if __DEBUG__<br />                LogDWORD CTEXT&#40;&quot;&lt;FStream_Open Failed for File '%s'&gt;&quot;,13,10&#41;,pName<br />            endif<br />    .endif<br />    return E_FAIL<br />FStream_Open endp<br />    <br />FStream_FStream proc<br />    ret<br />FStream_FStream endp<br /><br />FStream_$FStream proc<br />    .if &#91;ecx&#93;.FStream.pName!=0<br />        free &#91;ecx&#93;.FStream.pName<br />    .endif<br />    .if &#91;ecx&#93;.FStream.hFile!=0<br />        invoke CloseHandle,&#91;ecx&#93;.FStream.hFile<br />    .endif<br />    ret<br />FStream_$FStream endp<br /><br /><br /></code></pre></div>
    <div class="meta">Posted on 2005-02-02 02:17:32 by Homer</div>
   </div>
  </div>
 </body>
</html>