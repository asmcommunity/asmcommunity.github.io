<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Japheth::SimpleServer Example - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=15222" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=116">Windows</a> &raquo; <a href="../?id=15222">Japheth::SimpleServer Example</a></p>
   <div class="post" id="post-118276">
    <div class="subject"><a href="#post-118276">Japheth::SimpleServer Example</a></div>
    <div class="body">Japheth,<br /><br />Im still hacking thru your COM example (Simple server).   And im wondering why you bother to use offsets in the interface map.<br /><br />I mean, the IUnknown, IDispatch, ISimpleServer is all based at an offest of zero.  And should always be this if your truely inheriting other interfaces (albeit, non-aggregated).<br /><br />I see you like to use typing alot with your source, but when you boil it down, the code ultimately places a zero offest every time (CSimpleServe._IDispatch == offset 0):<pre><code>iftab	label dword<br />	dd offset IID_IUnknown, 0<br />	dd offset IID_IDispatch, CSimpleServer._IDispatch<br />	dd offset IID_ISimpleServer, CSimpleServer._IDispatch<br />;--------------------- insert new exposed interfaces here<br />iftabsize equ &#40;$ - offset iftab&#41; / 8</code></pre><br /><br />Thanks..<br />:NaN:</div>
    <div class="meta">Posted on 2003-09-15 20:20:55 by NaN</div>
   </div>
   <div class="post" id="post-118294">
    <div class="subject"><a href="#post-118294">Japheth::SimpleServer Example</a></div>
    <div class="body">NaN,<br /><br />youre right, the offset is always zero in this sample.<br /><br />But if you add another interface (say: IProvideClassInfo) the server object will implement &quot;multiple inheritance&quot; and needs more than one vtable (first at offset 0 for IUnknown, IDispatch, IComExeSvr, second at offset 4 for IProvideClassInfo). BTW: thats the same way as VC does implement this.<br /><br />I made an EXE server sample supporting events, which adds interface IConnectionPointContainer and so in fact needs more than one vtable. Download it from <a target="_blank" href="http://www.japheth.de/download/ComExeSvr2.zip">http://www.japheth.de/download/ComExeSvr2.zip</a>. Besides the event stuff (and being an EXE instead of DLL) the sample is mainly the same.<br /><br /><br />I just looked around a bit and found a C++ sample (hosting webbrowser control, which was converted to ASM by Xtreme some years ago). The class is defined as:<br /><pre><code><br />class CBrowserWindow &#58;	public IOleClientSite,<br />						public IOleInPlaceSite,<br />						public IDocHostUIHandler,<br />						public IDocHostShowUI,<br />						public IDispatch<br />&#123;<br /><br />	public&#58;<br />		CBrowserWindow&#40;&#41;;<br />		~CBrowserWindow&#40;&#41;;<br /></code></pre><br /><br />and QueryInterface is implemented as<br /><pre><code><br />STDMETHODIMP CBrowserWindow&#58;&#58;QueryInterface&#40;REFIID riid, LPVOID* ppvObject&#41;<br />&#123;<br />   *ppvObject= NULL;<br /><br />   if &#40;IsEqualIID&#40;riid, IID_IUnknown&#41;&#41;<br />   &#123;<br />      *ppvObject = this;<br />   &#125;<br />   else if &#40;IsEqualIID&#40;riid, IID_IOleClientSite&#41;&#41;<br />   &#123;<br />      *ppvObject = static_cast&lt;IOleClientSite*&gt;&#40;this&#41;;<br />   &#125;   <br />   else if &#40;IsEqualIID&#40;riid, IID_IDocHostUIHandler&#41;&#41;<br />   &#123;<br />      *ppvObject = static_cast&lt;IDocHostUIHandler*&gt;&#40;this&#41;;<br />   &#125;     <br />   else if &#40;IsEqualIID&#40;riid, IID_IDocHostShowUI&#41;&#41;<br />   &#123;<br />      *ppvObject = static_cast&lt;IDocHostShowUI*&gt;&#40;this&#41;;<br />   &#125;     <br />   else if &#40;IsEqualIID&#40;riid, IID_IOleInPlaceSite&#41;&#41;<br /></code></pre><br /><br />the casting done here will in fact add offset of vtables to &quot;this&quot; as it is done in simpleserver sample.<br /> <br /><br /><br />Japheth</div>
    <div class="meta">Posted on 2003-09-16 00:01:41 by japheth</div>
   </div>
   <div class="post" id="post-118366">
    <div class="subject"><a href="#post-118366">Japheth::SimpleServer Example</a></div>
    <div class="body">Thanks, i will have to look closer at this.  Im still not a 100% how this works, but hopefully it will sink in ;)<br /><br />I was under the impression you would make a separate interface map for another interface.  Not offset to it.<br /><br />Regards,<br />NaN</div>
    <div class="meta">Posted on 2003-09-16 17:05:13 by NaN</div>
   </div>
   <div class="post" id="post-118675">
    <div class="subject"><a href="#post-118675">Japheth::SimpleServer Example</a></div>
    <div class="body">Ok. I finally found the example in your source:<br /><pre><code>iftab	label dword<br />	dd offset IID_IUnknown, 0<br />	dd offset IID_IDispatch, CComExeSvr2._IDispatch<br />	dd offset IID_IComExeSvr2, CComExeSvr2._IDispatch<br />	dd offset IID_IConnectionPointContainer, CComExeSvr2._IConnectionPointContainer<br />;--------------------- insert new exposed interfaces here<br />iftabsize equ &#40;$ - offset iftab&#41; / 8</code></pre><br /><br />And the Class Object structure is defined as<br /><pre><code>CComExeSvr2	struct<br />_IDispatch					IDispatch	&lt;&gt;<br />_IConnectionPointContainer    IConnectionPointContainer    &lt;&gt;<br />dwRefCount					DWORD	?<br />pTypeInfo					LPTYPEINFO ?<br />pConnectionPoint			LPCONNECTIONPOINT ?NUMCP dup &#40;?&#41;<br />dwValue	 					DWORD	?<br />CComExeSvr2	ends</code></pre><br /><br />My problem here is that your &quot;inherited&quot; Interface is not a position 0 in the object.  This means you can not take this object and call with early binding:<br /><pre><code><br />invoke vf&#40; pObject, IConnectionPointContainer, EnumConnectionPoints&#41;, ppIEnumConnectionPoints</code></pre><br /><br />This is because (as i understand things) a COM Interface object calls itself by:<br /><pre><code>mov eax, &#91;eax&#93;<br />call eax+vtble_offset</code></pre><br /><br />What am i missing here??  <br />:stupid:</div>
    <div class="meta">Posted on 2003-09-19 10:23:03 by NaN</div>
   </div>
   <div class="post" id="post-118685">
    <div class="subject"><a href="#post-118685">Japheth::SimpleServer Example</a></div>
    <div class="body"><span style="font-size:24px>I UNDERSTAND!</span><br /><br />I finally got it all into the grey matter!  You can forget the above reply.  I now see how it all works, start to finish.  I see now how you support multiple Interfaces and Multiple classes, and in the end they all work the same when calling their methods.<br /><br />The catch that i now see, which is minor, is that for the second unique interface (and so forth) with a separate vtable for the specific class will have to do adjustments to the &quot;lpTHIS&quot; that is recieved by every method of the second interface.<br /><br />lpTHIS = lpTHIS - (Inteface offset from IMAP)<br /><br />Such that lpTHIS will align with the beginning of the class data structure.<br /><br />How am i doing so far?<br />:NaN:</div>
    <div class="meta">Posted on 2003-09-19 11:59:57 by NaN</div>
   </div>
   <div class="post" id="post-118745">
    <div class="subject"><a href="#post-118745">Japheth::SimpleServer Example</a></div>
    <div class="body">Very good, NaN ;) ,<br /><br />as already mentioned, thats the same approach as VC implements it. I compiled a C++ source file implementing muliple inheritance with virtual base classes (=interfaces) and studied the ASM file generated.<br /><br />Japheth</div>
    <div class="meta">Posted on 2003-09-20 00:58:21 by japheth</div>
   </div>
   <div class="post" id="post-119472">
    <div class="subject"><a href="#post-119472">Japheth::SimpleServer Example</a></div>
    <div class="body">Japheth,<br /><br />Theory asside, in actual implimentation im hitting the wall registering the object.  I have it registers without a problem, but when viewed from comview the TypeLib is not available.<br /><br />I suspect the typelib is not being found in the resource file.  However, im puzzled where in your framework you reference the typelib in the resource file?  I have it indicated as ID 201.  And i know your framework doesnt have this ID anywhere.<br /><br />Its something I assumed, and overlooked.  How does it get referenced.  I didnt find any direct &quot;LoadResource&quot; in the source and assume its somehow related with GetRegTypeLib (or whatever the api is ~ im at work at the moment).<br /><br />If you can help me out here it would be appreciated.  Im pretty sure this is the last snag im on!<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-09-25 13:45:49 by NaN</div>
   </div>
   <div class="post" id="post-119507">
    <div class="subject"><a href="#post-119507">Japheth::SimpleServer Example</a></div>
    <div class="body">Ok.. got kinda past this...  Turns out that RadASM wasnt including the resource obj file with the link :rolleyes: <br /><br />Now i got it registering, and with ComView i can see the type lib, as well as the registered class etc. <br /><br />When i unregister it it get this error:</div>
    <div class="meta">Posted on 2003-09-25 18:33:43 by NaN</div>
   </div>
   <div class="post" id="post-119513">
    <div class="subject"><a href="#post-119513">Japheth::SimpleServer Example</a></div>
    <div class="body">I was so frustrated trying to chase this one down that I even directly cut and pasted your source in, with no solution.  <br /><br />I dont get it.  Im running out of &quot;leads&quot; to follow.  I do know that comview returns an error when i try to instanciate this, but thats different and running different functions in the DLL.  For now im trying to simply get it registering and unregistering properly.  <br /><br />I do know that the registry is not being corrupted, and the proper keys are both registered and removed (After all, it is your source ;) )<br /><br />I thought it was the tlb file, but it looks correct to me.  The only Clue i get is the top line of the error box shown above &quot;DllUnregisterServer in <strong>DllInstall</strong> failed.&quot;.  When i run the register function it says &quot;RegisterServer in <strong>JAYMESON.DLL</strong> Successful&quot;.   I though this was odd, so i compared it to your example SIMPLESERVER.DLL.  I dont get the error message, but it does say the correct name with its success message.  I dont know what this means, if anything.<br /><br />Anywho, here is your source, reworked for a single file compile:<br /><br /><ul><br />[*]COMDll.asm is the main DLL entry stuff<br />[*]CClassFactory is what you expect<br />[*]COMHelp.asm is your utility functions and ClassObject (your ObjectEntry) structure ~ didnt like the name<br />[*]CJaymeson.asm is the unique stuf that makes each COM object different.  Here i define the ObjectMap, Registry stuff and specific methods.<br /><br /><br />I hope your experience might be able to spot this bug, cause mine is failing.... :rolleyes:<br /><br />Thanks,<br />:NaN:</div>
    <div class="meta">Posted on 2003-09-25 18:42:46 by NaN</div>
   </div>
   <div class="post" id="post-119556">
    <div class="subject"><a href="#post-119556">Japheth::SimpleServer Example</a></div>
    <div class="body">Hi NaN,<br /><br />there's a rather sophisticated bug in the source:<br /><br />heres the original ObjectEntry structure<br /><pre><code><br />ObjectEntry struct<br />pClsId		REFGUID ?<br />pLibId		REFGUID ?<br />dwVerMajor	SWORD ?<br />dwVerMinor	SWORD ?	<br />pRegKeys	LPREGSTRUCT ?<br />constructor	LPCONSTRUCTOR ?<br />ObjectEntry ends<br /></code></pre><br /><br />and heres your modified structure<br /><br /><pre><code><br />    ClassObject STRUC<br />        pClsId		dd ?                            ; Class GUID pointer<br />        pLibId		dd ?                            ; Typelib GUID pointer<br />        dwVerMajor	dw ?                            ; Major Version<br />        dwVerMinor	dw ?	                        ; Minor Version<br />        pRegKeys	dd ?                            ; Registry Keys pointer<br />        constructor	dd ?                            ; Class Constructor pointer<br />    ClassObject ENDS<br /></code></pre><br /><br />what basically has changed is type of members dwVerMajor and dwVerMinor<br /><br />now look at this code:<br /><br /><pre><code><br />;------------------------------ Unregister Type Library and Interfaces<br />	invoke UnRegisterTypeLib, &#91;edi&#93;.ClassObject.pLibId,\<br />		&#91;edi&#93;.ClassObject.dwVerMajor, &#91;edi&#93;.ClassObject.dwVerMinor, 0, SYS_WIN32<br /></code></pre><br /><br />Its not modified, but it doesnt work any more. Thats because of a well known (;) ) bug in MASM, which pushes WORD values in wrong size, but has no problems pushing signed WORD values. Thats the only reason why I had defined it as SWORD. Should have documented that, thou.<br /><br />Japheth</div>
    <div class="meta">Posted on 2003-09-26 01:52:51 by japheth</div>
   </div>
   <div class="post" id="post-119652">
    <div class="subject"><a href="#post-119652">Japheth::SimpleServer Example</a></div>
    <div class="body">Thanks, i was aware that when you push WORDS, the stack ends up with DWORDS in 32 bit mode, but i wasnt aware that this API was truely expecting a 16 bit value.  Thanks for spotting this!  Very much apprechiated!<br /><br />As a return, i noticed that your source has a potential bug in it:<br />SimpleServer.asm, function DllUnregisterServer, line 358:<pre><code>invoke StringFromGUID2, &#91;edi&#93;.ObjectEntry.pClsId, addr wszGUID,40</code></pre>Should be:<pre><code>invoke StringFromGUID2, &#91;edi&#93;.ObjectEntry.pClsId, addr wszGUID,&#91;b&#93;sizeof wszGUID&#91;/b&#93;</code></pre><br /><br />Since the buffer is 40 WORDS not BYTES.  You wouldnt have noticed this i figure until you unregister something deep in a directory structure....<br /><br />The same applies to:<br />Line 268, 272 of the same file in the RegisterServer routine.<br /><br /><br />Thanks again!<br />:NaN:</div>
    <div class="meta">Posted on 2003-09-26 17:44:39 by NaN</div>
   </div>
   <div class="post" id="post-119679">
    <div class="subject"><a href="#post-119679">Japheth::SimpleServer Example</a></div>
    <div class="body">All seems to be going well... Except two things (both are non critical):<br /><br />1)  For some reason my object appears in you comview with a &quot; 0&quot; after it.  I checked the IDL and there is no spelling errors  that I can find.  I aslo check the registry entries with your ComView and again no spelling mistakes...  Im not sure how its doing this.  (see picture below)<br /><br />2) Im testing with VB5 now and I get it working with the following code:<pre><code>Private Sub Command1_Click&#40;&#41;<br />Dim A As Object<br />Set A = CreateObject&#40;&quot;_JaymesonServerASM.1&quot;&#41;<br />    A.MyMethod 1, 2<br />Set A = Nothing<br />End Sub</code></pre><br />However, I thought VB would automatically parse the typelib for the method/property names and arguments in its tool tip.  Im findings this is not the case.  Im not a VB programmer, so i may simply be forgetting to turn on this feature (somehow).  If not, is this the difference between Dispatchable objects and OCX's??<br /><br />Thankx for your help.</div>
    <div class="meta">Posted on 2003-09-26 22:13:59 by NaN</div>
   </div>
   <div class="post" id="post-119683">
    <div class="subject"><a href="#post-119683">Japheth::SimpleServer Example</a></div>
    <div class="body">Hi NaN,<br /><br /><div class="quote"><br />1) For some reason my object appears in you comview with a &quot; 0&quot; after it. I checked the IDL and there is no spelling errors that I can find. I aslo check the registry entries with your ComView and again no spelling mistakes... Im not sure how its doing this. (see picture below)<br /></div><br /><br />Comview displays the &quot;default&quot; value of an IDispatch object - if any - in window caption. This is the property with dispid 0.<br /><br /><div class="quote"><br />However, I thought VB would automatically parse the typelib for the method/property names and arguments in its tool tip. Im findings this is not the case. Im not a VB programmer, so i may simply be forgetting to turn on this feature (somehow). If not, is this the difference between Dispatchable objects and OCX's??<br /></div><br /><br />Try this:<br /><pre><code><br />Dim obj1 As New JAYMESON.JAYMESON<br />Private Sub Form_Load&#40;&#41;<br /> obj1.MyProp = 1<br />End Sub<br /></code></pre><br /><br /><div class="quote"><br />As a return, i noticed that your source has a potential bug in it:<br />SimpleServer.asm, function DllUnregisterServer, line 358:<br />code:--------------------------------------------------------------------------------invoke StringFromGUID2, .ObjectEntry.pClsId, addr wszGUID,40--------------------------------------------------------------------------------<br />Should be:<br />code:--------------------------------------------------------------------------------invoke StringFromGUID2, .ObjectEntry.pClsId, addr wszGUID,sizeof wszGUID--------------------------------------------------------------------------------<br /></div><br /><br />Dont think this is a bug. function transfers a GUID (which is always 16 bytes) to a string (which in no case can be &gt; 40. Besides that, are you sure the third parameter should be size in bytes? It should be size in characters, so best is possibly &quot;LENGTHOF wszGUID&quot;<br /><br />Japheth</div>
    <div class="meta">Posted on 2003-09-27 01:20:41 by japheth</div>
   </div>
   <div class="post" id="post-119701">
    <div class="subject"><a href="#post-119701">Thanks Again!</a></div>
    <div class="body">Thanks again Japheth!  <br /><br />You've been extremely helpful!   I will chase down this last bug and i think i will be finished (the dispatch name thingy).<br /><br />All along i have been fixing up Extremes early attempt at a Com object generator.  Im nearly finished it too.  I revised the created files it outputs to utilize your COMVeiw /B option.  As well it builds a default RADAsm project for the generated files.  Working pretty good actually...  I just need to get the output data right ;)<br /><br />:NaN:</div>
    <div class="meta">Posted on 2003-09-27 07:22:38 by NaN</div>
   </div>
   <div class="post" id="post-119722">
    <div class="subject"><a href="#post-119722">Japheth::SimpleServer Example</a></div>
    <div class="body">A code generator for COM objects in ASM is very interesting, NaN. Xtreme's version hasnt interested me because of its use of colib, which I personally dont appreciate too much.<br /><br />Japheth</div>
    <div class="meta">Posted on 2003-09-27 09:56:39 by japheth</div>
   </div>
   <div class="post" id="post-119765">
    <div class="subject"><a href="#post-119765">Japheth::SimpleServer Example</a></div>
    <div class="body">With no offense to Ernie, I seriously appreciate the level of work he put into co-lib (studied it up before your model), however, I've personally COM to agree with your version as i find it simpler to understand in general and work with.  A black box lib with specific dependancies is not what i like.   Your solution alows people to change nutz &amp; bolts if they need to at any point.<br /><br />As well your version is more direct for new people to get aquainted with.  This is another hope from the generator... to get more people interested in the COM topic.<br /><br />I have 100% removed any co-lib dependancies and made it 100% alike to your.   Actually the &quot;JAYMESON.DLL&quot; is the output generated by the tool. (Im very unimaginative with testing names ;) )<br /><br />Will have it out soon...<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-09-27 21:24:37 by NaN</div>
   </div>
  </div>
 </body>
</html>