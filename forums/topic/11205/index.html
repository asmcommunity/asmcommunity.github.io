<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Converting JPG to BMP - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=11205" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=116">Windows</a> &raquo; <a href="../?id=11205">Converting JPG to BMP</a></p>
   <div class="post" id="post-84493">
    <div class="subject"><a href="#post-84493">Converting JPG to BMP</a></div>
    <div class="body">I want to convert JPG file to BMP using OLE. I wrote the following code, but the SaveAsFile method doesn't work. What I do wrong? Are there other methods to do this?<br /><br />BTW: This is my first post to win32asm community messageboard!<br /><br /><pre><code><br />.data<br />IID_IPicture  dd 07BF80980h<br />              dw 0BF32h,0101Ah<br />              db 08Bh,0BBh,0,0AAh,0,030h,0Ch,0ABh<br />gpPicture     dd 0<br />pstm          dd ?<br />pstm2         dd ?<br />FILESIZE      = 30474              ;size of jpeg file<br />gfx_title     LABEL DWORD<br />include       gfx_title4.inc       ;jpeg file &#40;db ..., db ..., db ..., ...&#41;<br />                                   ;jpg converted to include file using BinToDb<br />pcbSize       dd ?<br /><br />.code<br />start&#58;<br />       invoke GlobalAlloc,GMEM_FIXED,FILESIZE<br />       mov    ecx,FILESIZE<br />       mov    esi,offset gfx_title<br />       mov    edi,eax<br />       rep    movsb<br />       invoke CreateStreamOnHGlobal,eax,TRUE,addr pstm<br />       invoke OleLoadPicture,pstm,FILESIZE,1,addr IID_IPicture,addr gpPicture<br /><br />       invoke GlobalAlloc,GMEM_FIXED,250000<br />       invoke CreateStreamOnHGlobal,eax,TRUE,addr pstm2<br /><br />       push   offset pcbSize<br />       push   0<br />       push   dword ptr &#91;pstm2&#93;<br />       mov    edx,gpPicture<br />       push   edx<br />       mov    edx,&#91;edx&#93;<br />       call   dword ptr &#91;edx+60&#93;   ;IPicture&#58;&#58;SaveAsFile<br />       ;this doesn't work - returns E_FAIL<br />       mov    eax,gpPicture        ;return number of bytes<br /><br />       invoke ExitProcess,eax<br />end start<br /></code></pre></div>
    <div class="meta">Posted on 2003-03-02 09:51:46 by Czajnick</div>
   </div>
   <div class="post" id="post-84495">
    <div class="subject"><a href="#post-84495">Converting JPG to BMP</a></div>
    <div class="body">With out really studying up you problem, are you sure that the method you want is the 60th DECIMAL offset, or the 60th HEX offset ;) .  If there is confusion here it will for sure fail.<br /><br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-03-02 09:56:39 by NaN</div>
   </div>
   <div class="post" id="post-84501">
    <div class="subject"><a href="#post-84501">Converting JPG to BMP</a></div>
    <div class="body">I am almost sure. I think this is the right offset because when I change 1 to 0 in the following line, everything works (but the program writes JPG instead of BMP):<br /><br />invoke OleLoadPicture,pstm,FILESIZE,1,addr IID_IPicture,addr gpPicture</div>
    <div class="meta">Posted on 2003-03-02 10:21:25 by Czajnick</div>
   </div>
   <div class="post" id="post-84887">
    <div class="subject"><a href="#post-84887">Converting JPG to BMP</a></div>
    <div class="body"><div class="quote">IPicture::SaveAsFile <br />Saves the picture?s data into a stream in the same format that it would save itself into a file. Bitmaps use the BMP file format, metafiles the WMF format, and icons the ICO format. For more information, see the Win32 Programmer?s Reference. <br /><br />HRESULT SaveAsFile( IStream * pstream , <br /> //Pointer to stream where picture writes its data <br /> <br />BOOL fSaveMemCopy , <br /> //Indicates whether to save the picture in memory <br /> <br />LONG* pcbSize <br /> //Receives a pointer to the number of bytes written to stream <br /> <br />); <br />  <br /><br /><br />Parameters <br /><br />pstream <br /> Pointer to the stream into which the picture writes its data. <br />fSaveMemCopy <br /> Flag indicating whether or not to save a copy of the picture in memory. <br />pcbSize <br /> Pointer to the caller?s LONG variable to receive the number of bytes written into the stream. This value can be NULL, indicating that the caller does not require this information. <br />Return Values <br /><br />This method supports the standard return values E_FAIL and E_INVALIDARG, as well as the following: <br /><br />S_OK <br />The picture was saved successfully. </div><br /><br />I gave your problem another 5 minutes or so to look it over (sorry, dont much time to myself these days).  The above lists a flag to indicate if the stream is in memory or not.  Your telling it that its not, however, your stream pointer is defined out of memory.  This maybe where its failing.<br /><br /><div class="quote">I am almost sure. I think this is the right offset because when I change 1 to 0 in the following line, everything works (but the program writes JPG instead of BMP):<br /><br />invoke OleLoadPicture,pstm,FILESIZE,1,addr IID_IPicture,addr gpPicture</div><br />This is because 0 implies the picture object has its property set to keep the origional file format in the stream, when the bool value is FALSE.  You definitely want it to be TRUE to do any conversions.  (However the docs' i have also say that the provided stream must only be either a BMP, WMF, or ICO stream.  No mention of JPG's at all (which is odd) ).<br /><br />A little more digging around and i found this link (dated 2003): <a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/com/htm/cten_a2z_0orp.asp">PICTTYPE</a><br /><br />I suspect your screwed.  There is not clear support for JPG types.  For the OleLoadPicture or OleCreatePictureIndirect.  The fact we have been using this to display JPG's seems to be a &quot;patch&quot; to the OS, somewhere down the line and not documented.  My suspisions for this is probably because of rights to create JPG's.  MS wants to display them from an OS point of view, but doesnt want to get into the legal BS, if someone like yourself wants to create JPG's with the OS's API.<br /><br />:rolleyes:<br />Time to hit the web and write your engin, i guess.<br />:NaN:</div>
    <div class="meta">Posted on 2003-03-04 00:14:02 by NaN</div>
   </div>
   <div class="post" id="post-85205">
    <div class="subject"><a href="#post-85205">Converting JPG to BMP</a></div>
    <div class="body">I found another way to do this. Here is my little program. It creates a file, which contains decompressed JPEG (the generated raw file could be read eg. by Paint Shop Pro). Do you have any comments or suggestions how to optimize this code?<br /><br /><pre><code><br />.data<br />gfx_title LABEL DWORD<br />include   gfx_title4.inc   ;jpeg file &#40;db ..., db ..., db ..., ...&#41;<br />                           ;jpg converted to include file using BinToDb<br />bitmap    BITMAP &lt;?&gt;<br />naz       db &quot;d.raw&quot;,0<br />dupa      dd ?<br />IID_IPicture dd 07BF80980h<br />          dw 0BF32h,0101Ah<br />          db 08Bh,0BBh,0,0AAh,0,030h,0Ch,0ABh<br /><br />.code<br />_Mapping2BMP proc uses esi jpeg_data&#58;DWORD,sizeof_jpeg_data&#58;DWORD,bitmap_struc&#58;DWORD<br />   LOCAL  gdi_handle&#58;DWORD<br />   LOCAL  pstm&#58;DWORD<br />   LOCAL  gpPicture&#58;DWORD<br /><br />   invoke GlobalAlloc,GMEM_FIXED,sizeof_jpeg_data<br />   mov    ecx,sizeof_jpeg_data<br />   mov    esi,jpeg_data<br />   mov    edi,eax<br />   rep    movsb<br />   lea    ecx,pstm<br />   push   ecx<br />   push   TRUE<br />   push   eax<br />   call   CreateStreamOnHGlobal<br /><br />   invoke OleLoadPicture,pstm,sizeof_jpeg_data,TRUE,offset IID_IPicture,addr gpPicture<br /><br />   mov    eax,pstm<br />   push   eax<br />   mov    eax,&#91;eax&#93;<br />   call   dword ptr &#91;eax+8&#93;    ;pstm-&gt;Release&#40;&#41;<br /><br />   lea    eax,gdi_handle<br />   push   eax<br />   mov    eax,gpPicture<br />   push   eax<br />   mov    eax,&#91;eax&#93;<br />   call   dword ptr &#91;eax+12&#93;   ;gpPicture-&gt;get_Handle&#40;&amp;gdi_handle&#41;<br /><br />   mov    esi,bitmap_struc<br />   invoke GetObject,gdi_handle,sizeof BITMAP,esi<br />   mov    ecx,gpPicture<br />   mov    &#91;esi&#93;,ecx    ;bitmap_struc.bmType=gpPicture<br />   ret<br />_Mapping2BMP endp<br /><br />_Kill_JPEG proc bitmap_struc&#58;DWORD<br />   mov    eax,bitmap_struc<br />   mov    eax,&#91;eax&#93;<br />   push   eax<br />   mov    eax,&#91;eax&#93;<br />   call   dword ptr &#91;eax+8&#93;    ;&#91;bitmap_struc.bmType&#93;-&gt;Release&#40;&#41;<br />   ret<br />_Kill_JPEG endp<br /><br />start&#58;<br />   invoke _Mapping2BMP,addr gfx_title,30474,addr bitmap<br /><br />   invoke CreateFile,addr naz,GENERIC_WRITE,0,0,CREATE_ALWAYS,FILE_ATTRIBUTE_NORMAL,0<br />   push   eax<br />   invoke WriteFile,eax,bitmap.bmBits,416*180*3,addr dupa,0<br />   call   CloseHandle<br /><br />   invoke _Kill_JPEG,addr bitmap<br /><br />   invoke ExitProcess,eax<br />end start<br /></code></pre></div>
    <div class="meta">Posted on 2003-03-05 09:04:59 by Czajnick</div>
   </div>
   <div class="post" id="post-85494">
    <div class="subject"><a href="#post-85494">Converting JPG to BMP</a></div>
    <div class="body">Due to the use of file API's there really isnt much use of trying to optomize it.  Your code looks fine to me.  However, from a coding point of view you may find this <a target="_blank" href="http://www.asmcommunity.net/board/showthread.php?threadid=9268&amp;highlight=MGUID">GUID macro</a> will make things a bit easier.<br /><br /><pre><code>Example&#58;<br /><br />;Make text equate<br />sIID_IPicture MGUID &#40;7BF80980-BF32-101A-8BBB-00AA00300CAB&#41;<br /><br />;Define memory data<br />.data<br />IID_IPicture  sIID_IPicture</code></pre><br /><br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-03-06 18:46:21 by NaN</div>
   </div>
  </div>
 </body>
</html>