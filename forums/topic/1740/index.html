<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Lbuttondown True - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=1740" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=1740">Lbuttondown True</a></p>
   <div class="post" id="post-11114">
    <div class="subject"><a href="#post-11114">Lbuttondown True</a></div>
    <div class="body">Can Someone fix this code.  It will tell me how to do a LBUTONDOWN Click with-in the WndProc proc.  This is from Icz LISTBOX tute.  I striped most part and eliminated one of the ListBox Procedure so that I can try to get an LBUTTONDOWN click under the standard WndProc proc and not a ListBox proc.  This is something that a have tried to do for a very long time with no success.  Heres the whole thing so that its easy to know what I am talking about. I tried the 0FFFFh thing but it only allow you to close the whole window from any clicked point.  I think my main problem is that I don't know where and how to use the 0FFFFh in the code.  If you click the listbox its suppose to close.  Thanks<br /><br />; ########################################<br />    .386<br />      .model flat, stdcall<br />      option casemap :none   ; case sensitive<br /><br />; ########################################<br />      include \masm32\include\windows.inc<br />      include \masm32\include\user32.inc<br />      include \masm32\include\kernel32.inc<br />      includelib \masm32\lib\user32.lib<br />      includelib \masm32\lib\kernel32.lib<br /><br />; ########################################<br />      szText MACRO Name, Text:VARARG<br />        LOCAL lbl<br />          jmp lbl<br />            Name db Text,0<br />          lbl:<br />        ENDM<br /><br />      m2m MACRO M1, M2<br />        push M2<br />        pop  M1<br />      ENDM<br /><br />      return MACRO arg<br />        mov eax, arg<br />        ret<br />      ENDM<br /><br />        ;=================<br />        ; Local prototypes<br />        ;=================<br />        WinMain PROTO :DWORD,:DWORD,:DWORD,:DWORD<br />        WndProc PROTO :DWORD,:DWORD,:DWORD,:DWORD<br />        <br />        ListBox PROTO :DWORD,:DWORD,:DWORD,:DWORD,:DWORD,:DWORD<br /><br />    .data<br />        szDisplayName db &quot;List Box Demo&quot;,0<br />        CommandLine   dd 0<br />        hWnd          dd 0<br />        hInstance     dd 0<br />     <br />        hList1        dd 0<br />        lpLstBox1     dd 0<br /><br />    .code<br /><br />start:<br />        invoke GetModuleHandle, NULL<br />        mov hInstance, eax<br /><br />        invoke GetCommandLine<br />        mov CommandLine, eax<br /><br />        invoke WinMain,hInstance,NULL,CommandLine,SW_SHOWDEFAULT<br />        invoke ExitProcess,eax<br /><br />; #######################################<br /><br />WinMain proc hInst     :DWORD,<br />             hPrevInst :DWORD,<br />             CmdLine   :DWORD,<br />             CmdShow   :DWORD<br /><br />        LOCAL wc   :WNDCLASSEX<br />        LOCAL msg  :MSG<br />        mov wc.cbSize,         sizeof WNDCLASSEX<br />        mov wc.style,          CS_HREDRAW or CS_VREDRAW \<br />                               or CS_BYTEALIGNWINDOW<br />        mov wc.lpfnWndProc,    offset WndProc<br />        mov wc.cbClsExtra,     NULL<br />        mov wc.cbWndExtra,     NULL<br />       	push  hInst<br />	pop   wc.hInstance<br />        mov wc.hbrBackground,  COLOR_WINDOW+1<br />        mov wc.lpszMenuName,   NULL<br />        mov wc.lpszClassName,  offset szClassName<br />          invoke LoadIcon,hInst,500    ; icon ID<br />        mov wc.hIcon,          eax<br />          invoke LoadCursor,NULL,IDC_ARROW<br />        mov wc.hCursor,        eax<br />        mov wc.hIconSm,        0<br />        invoke RegisterClassEx, ADDR wc<br />        szText szClassName,&quot;Template_Class&quot;<br /><br />INVOKE CreateWindowEx,WS_EX_WINDOWEDGE,ADDR szClassName,ADDR szDisplayName,\<br />WS_OVERLAPPEDWINDOW ,100,\<br />0,300,375,NULL,NULL,hInst,NULL<br /><br />        mov   hWnd,eax<br /><br />        invoke LoadMenu,hInst,600  ; menu ID<br />        invoke SetMenu,hWnd,eax<br /><br />        invoke ShowWindow,hWnd,SW_SHOWNORMAL<br />        invoke UpdateWindow,hWnd<br /><br />      <br />      ;===================================<br />      ; Loop until PostQuitMessage is sent<br />      ;===================================<br /><br />    StartLoop:<br />      invoke GetMessage,ADDR msg,NULL,0,0<br />      cmp eax, 0<br />      je ExitLoop<br />      invoke TranslateMessage, ADDR msg<br />      invoke DispatchMessage,  ADDR msg<br />      jmp StartLoop<br />    ExitLoop:<br /><br />      return msg.wParam<br /><br />WinMain endp<br /><br />; #######################################<br /><br />WndProc proc hWin   :DWORD,<br />             uMsg   :DWORD,<br />             wParam :DWORD,<br />             lParam :DWORD<br /><br />LOCAL        hCtl   :DWORD<br /><br />;;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *<br /><br />    .if uMsg == WM_CREATE<br /><br />        invoke ListBox,21,50,44,25,hWin,501<br />        mov hList1, eax<br /><br />        invoke SetWindowLong,hList1,GWL_WNDPROC,ADDR WndProc<br />        mov lpLstBox1, eax<br /><br />;;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *<br />;    mov eax,wParam<br />;    and eax,0FFFFh<br />;    .if  eax == static1<br />    ; handle static1<br /><br />;;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * <br />;;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * <br />;;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * <br /><br />.elseif uMsg == WM_COMMAND<br /><br />.if uMsg == WM_LBUTTONDOWN      ;;;@@@     T H E   WM_LBUTTONDOWN<br /> mov eax,wParam<br /> mov eax, hList1<br /><br />.if hList1 == eax<br /><br /> invoke PostQuitMessage,NULL<br /><br /> invoke CallWindowProc,lpLstBox1,hCtl,uMsg,wParam,lParam<br /><br />ret<br /><br />.endif<br />.endif<br />;;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * <br />;;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * <br />;;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * <br /><br /><br />    ;======== menu commands ========<br />        .if wParam == 1000<br />            invoke SendMessage,hWin,WM_SYSCOMMAND,SC_CLOSE,NULL<br />            .endif<br /><br /><br />    .elseif uMsg == WM_CLOSE<br />      <br />          .if eax == IDNO<br />            return 0<br />          .endif<br />    .elseif uMsg == WM_DESTROY<br />        invoke PostQuitMessage,NULL<br />        return 0 <br />    .endif<br /><br />    invoke DefWindowProc,hWin,uMsg,wParam,lParam<br /><br />    ret<br /><br />WndProc endp<br /><br /><br />; ########################################<br /><br />ListBox proc a:DWORD,b:DWORD,wd:DWORD,ht:DWORD,hParent:DWORD,ID:DWORD<br /><br />    szText lstBox,&quot;LISTBOX&quot;<br /><br />    invoke CreateWindowEx,WS_EX_WINDOWEDGE,ADDR lstBox,0,<br />              WS_CHILD or WS_VISIBLE or \<br />              WS_BORDER or \<br />              LBS_HASSTRINGS,<br />              a,b,wd,ht,hParent,ID,hInstance,NULL<br /><br />    ret<br /><br />ListBox endp<br /><br /><br />; ########################################<br /><br />end start</div>
    <div class="meta">Posted on 2001-11-03 20:33:38 by cmax</div>
   </div>
   <div class="post" id="post-11155">
    <div class="subject"><a href="#post-11155">Lbuttondown True</a></div>
    <div class="body">cmax,<br />Your code has several problems.<br /><pre><code><br />.elseif uMsg == WM_COMMAND <br />   .if uMsg == WM_LBUTTONDOWN ;;;@@@ T H E WM_LBUTTONDOWN <br />      mov eax,wParam <br />      mov eax, hList1 <br />      .if hList1 == eax <br />         invoke PostQuitMessage,NULL <br />         invoke CallWindowProc,lpLstBox1,hCtl,uMsg,wParam,lParam <br />         ret <br />      .endif <br />   .endif <br /></code></pre><br /><br />First, you never get to the WM_LBUTTONDOWN line<br />because it is inside the WM_COMMAND handler.<br /><br />Next, if the uMsg is WM_LBUTTONDOWN, wParam indicates<br />if any virtualkeys are down, NOT a handle.<br /><br />Then you move wParam to eax and immediately move hList1 to eax. <br />when you compare eax to hList1, guess what ? they match ! but<br />like I said, this code is not getting executed.<br /><br /><div class="quote"><br />The WM_LBUTTONDOWN message is posted when the user presses the left mouse button while the cursor is in the client area of a window. If the mouse is not captured, the message is posted to the window beneath the cursor. Otherwise, the message is posted to the window that has captured the mouse. <br /><br />A window receives this message through its WindowProc function. <br /><br />LRESULT CALLBACK WindowProc(<br />  HWND hwnd,       // handle to window<br />  UINT uMsg,       // WM_LBUTTONDOWN<br />  WPARAM wParam,   // key indicator<br />  LPARAM lParam    // horizontal and vertical position<br />);<br />Parameters<br />wParam <br />Indicates whether various virtual keys are down. This parameter can be one or more of the following values. Value Description <br />MK_CONTROL The CTRL key is down. <br />MK_LBUTTON The left mouse button is down. <br />MK_MBUTTON The middle mouse button is down. <br />MK_RBUTTON The right mouse button is down. <br />MK_SHIFT The SHIFT key is down. <br />MK_XBUTTON1 Windows 2000/XP: The first X button is down. <br />MK_XBUTTON2 Windows 2000/XP: The second X button is down. <br /><br /><br />lParam <br />The low-order word specifies the x-coordinate of the cursor. The coordinate is relative to the upper-left corner of the client area. <br />The high-order word specifies the y-coordinate of the cursor. The coordinate is relative to the upper-left corner of the client area. <br /><br />Return Values<br />If an application processes this message, it should return zero.<br /></div><br /><br />So to fix this you need to handle WM_LBUTTONDOWN on its own.<br />Then you could use lParam to see if you are over the listbox and<br />if you are, then destroy the listbox.<br /><br />example:<br /><pre><code><br />.if uMsg == WM_LBUTTONDOWN<br />   invoke GetClientRect,hList1,addr Rct<br />   mov    eax,lParam<br />   and    eax,0FFFFh ;mouse X position<br />   mov    edx,lParam,<br />   shr    edx,16        ; mouse Y position<br />   .if    eax &gt;= Rct.left &amp;&amp; eax &lt;= Rct.right &amp;&amp; edx &gt;= Rct.top &amp;&amp; edx &lt;= Rct.bottom<br />      invoke DestroyWindow,hList1<br />   .endif<br />.elseif uMsg == WM_COMMAND<br /></code></pre><br />I did not try this code, but the general idea is correct.<br />You might have to use the API ScreenToClient to change the<br />listbox coordinants to match the mouse coordinants<br /><br />Good Luck !</div>
    <div class="meta">Posted on 2001-11-04 19:37:31 by anon</div>
   </div>
   <div class="post" id="post-11200">
    <div class="subject"><a href="#post-11200">Lbuttondown True</a></div>
    <div class="body">Another problem is that clicking on a control sends the WM_LBUTTONDOWN message to the <strong>control</strong> (gotta remember it's also a window) and <strong>not to the parent (enclosing) window</strong>. Each control type (class) has its own predefined window proc. That's where the WM_COMMAND and other notification messages are generated.<br /><br />Most (if not all) controls avoid echoing mouse messages to the parent window. To capture the original mouse button message for a specific control, use subclassing (see Icz). I don't know if using the mouse capture functions will work the way you want them to.</div>
    <div class="meta">Posted on 2001-11-05 15:26:55 by tank</div>
   </div>
   <div class="post" id="post-11285">
    <div class="subject"><a href="#post-11285">Lbuttondown True</a></div>
    <div class="body">Hey Guys<br />I been working with your ideas and it seems feable.  I only get error A2166: structure field expected . . . . I tried to follow other programs that had simular coding as above (used in other ways) but could not match it structure field (if I was doing it right) .  Anywayl one thing for sure, you guys pointed me in the right direction.<br /><br />Thanks again</div>
    <div class="meta">Posted on 2001-11-06 15:21:03 by cmax</div>
   </div>
  </div>
 </body>
</html>