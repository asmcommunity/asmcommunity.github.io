<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>My First Win32 Application - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=25365" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=25365">My First Win32 Application</a></p>
   <div class="post" id="post-185450">
    <div class="subject"><a href="#post-185450">My First Win32 Application</a></div>
    <div class="body">Hello everyone. Short introduction: I&#39;ve been programming for a long time. However, most of those years have been spent in Linux with C (and some ASM). Now I&#39;m trying to learn some Win32 programming. <br /><br />Here is my first attempt at a program:<br /><br /><pre><code><br />%define		STD_INPUT_HANDLE	-10<br />%define		STD_OUTPUT_HANDLE	-11<br /><br />segment .data<br />hello		db	&quot;Hello World!&quot;<br /><br />segment .bss<br />out_handle	resd	1<br />in_handle	resd	1<br /><br /><br />segment .text<br />		global _WinMainCRTStartup<br /><br />		extern _AllocConsole@0<br />		extern _GetStdHandle@4<br />		extern _WriteConsoleA@20<br />		extern _ExitProcess@4<br /><br />_WinMainCRTStartup:<br />		push	ebp<br />		mov	ebp, esp<br /><br />		call	_AllocConsole@0<br /><br />		push 	dword STD_OUTPUT_HANDLE<br />		call	_GetStdHandle@4<br />		<br />		mov	, eax<br /><br />		push	dword STD_INPUT_HANDLE<br />		call	_GetStdHandle@4<br /><br />		mov	, eax<br /><br />		push	dword <br />		push	hello<br />		push	13<br />		push	0<br />		push 	0<br />		call	_WriteConsoleA@20<br /><br />; so that the window does not close right away!<br />B:<br />		jmp	B<br /><br />		push	0<br />		call	_ExitProcess@4<br /><br />		mov	esp, ebp<br />		pop	ebp<br />		ret<br /></code></pre><br /><br />To assemble:<br />nasm -f win32 hello.asm<br /><br />To link:<br />link.exe /subsystem:windows hello.obj kernel32.lib<br /><br />The problem is that nothing is printed to the new console. A new console DOES open up but nothing is printed. Any ideas why? I&#39;ve been searching for quite a bit of time but I can&#39;t seem to get it.<br /><br />Thanks.</div>
    <div class="meta">Posted on 2006-09-23 02:00:35 by lithium</div>
   </div>
   <div class="post" id="post-185452">
    <div class="subject"><a href="#post-185452">Re: My First Win32 Application</a></div>
    <div class="body">Hello Lithium,<br /><br />Welcome on board. As you are building a console application, you need to use the swicth <strong>/SUBSYSTEM:CONSOLE</strong><br /><br /><pre><code>link.exe /subsystem:console hello.obj kernel32.lib</code></pre></div>
    <div class="meta">Posted on 2006-09-23 02:50:22 by Vortex</div>
   </div>
   <div class="post" id="post-185453">
    <div class="subject"><a href="#post-185453">Re: My First Win32 Application</a></div>
    <div class="body">Vortex, <br /><br />Thank you for your reply. However, I am NOT trying to build a console application. I am trying to build a Win32 application that just so happens to open a console window and perform I/O on it. Later it will show message boxes, etc. This would just be the first part of the program.<br /><br />If I do change the switch to /subsystem:console (and replace _WinMainCRTStartup with _mainCRTStartup) then, when the executable is run, absolutely nothing happens. No console window is opened, nothing. Strange. <br /><br />Regardless, I want a Win32 application and not a console application.</div>
    <div class="meta">Posted on 2006-09-23 03:16:46 by lithium</div>
   </div>
   <div class="post" id="post-185456">
    <div class="subject"><a href="#post-185456">Re: My First Win32 Application</a></div>
    <div class="body">Lithium,<br /><br />I found why it doesn&#39;t work. <span class="mono">WriteConsole</span> is a <span class="mono">STDCALL</span> function and it expects the parameters to be passed in reverse order. If you push the parameters in &quot;normal&quot; order, the function will fail :<br /><br /><pre><code>.code<br /><br />start:<br /><br />&nbsp; &nbsp; call&nbsp; &nbsp; AllocConsole<br />&nbsp; &nbsp; push 	STD_OUTPUT_HANDLE<br />&nbsp; &nbsp; call	GetStdHandle<br />&nbsp; &nbsp; mov&nbsp; &nbsp;  out_handle,eax<br />&nbsp; &nbsp; push&nbsp; &nbsp; STD_INPUT_HANDLE<br />&nbsp; &nbsp; call&nbsp; &nbsp; GetStdHandle<br />&nbsp; &nbsp; mov&nbsp; &nbsp;  in_handle,eax<br />&nbsp; &nbsp; push&nbsp; &nbsp; 0<br />&nbsp; &nbsp; push&nbsp; &nbsp; OFFSET pNumberOfCharsWritten<br />&nbsp; &nbsp; push&nbsp; &nbsp; 12&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; no need to include the NULL string terminator<br />&nbsp; &nbsp; push&nbsp; &nbsp; OFFSET hello<br />&nbsp; &nbsp; push&nbsp; &nbsp; out_handle<br />&nbsp; &nbsp; call&nbsp; &nbsp; WriteConsole<br /><br />; so that the window does not close right away!<br /><br />&nbsp; &nbsp; call&nbsp; &nbsp; wait_key<br />&nbsp; &nbsp; push	0<br />&nbsp; &nbsp; call&nbsp; &nbsp; ExitProcess<br /></code></pre><br /><br />Instead of using an infinite loop preventing the console window from disappearing, you can select a method more flexible like waiting for keyboard input before exiting.<br /></div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=2105" target="_blank">AllocConsole2.zip</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2006-09-23 05:32:32 by Vortex</div>
   </div>
   <div class="post" id="post-185463">
    <div class="subject"><a href="#post-185463">Re: My First Win32 Application</a></div>
    <div class="body"><div class="quote"><br />I am NOT trying to build a console application. I am trying to build a Win32 application that just so happens to open a console window and perform I/O on it.<br /></div><br /><br />In Windows, console applications generally are Win32 applications that simply utilize a console window instead of a graphical one.<br /><br />Since you are using NASM, you may want to check out the <a target="_blank" href="http://www.asmcommunity.net/projects/nasm32"><u>NASM32 Project</u></a>. The package comes many include files and examples of both GUI and Console programs written in NASM.<br /><br />The big thing that will help you specifically is the &quot;INVOKE&quot; macro that was developed, which automatically resolves API calls so you don&#39;t have to worry about which are STDCALL and which are CCALL :)</div>
    <div class="meta">Posted on 2006-09-23 12:59:34 by SpooK</div>
   </div>
   <div class="post" id="post-185468">
    <div class="subject"><a href="#post-185468">Re: My First Win32 Application</a></div>
    <div class="body">Vortex, <br /><br />Thanks a lot. That worked out nicely. A question about the code: what exactly is wait_key? Which library is it located in? <br /><br />SpooK,<br /><br />NASM32 looks great. It&#39;s a wonder I haven&#39;t heard of it before. <br /><br />Thanks for the help.</div>
    <div class="meta">Posted on 2006-09-23 16:35:43 by lithium</div>
   </div>
   <div class="post" id="post-185471">
    <div class="subject"><a href="#post-185471">Re: My First Win32 Application</a></div>
    <div class="body">No problem. NASM32 is fairly new and not that popular.<br /><br />&quot;wait_key&quot; is something found in the MASM32 library, which would require using MASM. He probably didn&#39;t notice that you mentioned NASM.<br /><br />Using <a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/vclib/html/_crt__getch.2c_._getche.asp"><strong>_getch</strong></a>, provided by the already existing and massively supported MSVCRT library, is probably the equivalent you would wish to use in NASM32.</div>
    <div class="meta">Posted on 2006-09-23 16:52:06 by SpooK</div>
   </div>
   <div class="post" id="post-185472">
    <div class="subject"><a href="#post-185472">Re: My First Win32 Application</a></div>
    <div class="body">How would I link to msvcrt.lib?<br /><br />If I call __getch from my code and link with:<br /><br />link.exe /subsystem:windows hello.obj kernel32.lib msvcrt.lib<br /><br />I get an error message that says MSVCR80.dll was not found. Of course, if I move the dll to the same directory as the EXE file I get an error message stating that I am attempting to load the C runtime library incorrectly. <br /><br />Is there a way to do this without linking into the C runtime library? If I do link into msvcrt that then I may as well use printf, scanf, etc... and the whole point here is for me to learn the Win32 API as much as possible.</div>
    <div class="meta">Posted on 2006-09-23 17:19:19 by lithium</div>
   </div>
   <div class="post" id="post-185473">
    <div class="subject"><a href="#post-185473">Re: My First Win32 Application</a></div>
    <div class="body">You might not have MSVCRT installed (properly), which is rare these days on Windows. Which version of Windows (or emulator) are you using?<br /><br />As for __getch, just about every example I see utilizes this MSVCRT function... even the &quot;wait_key&quot; one that Vortex mentioned. It doesn&#39;t surprise me as the rest of the Win32 API is dedicated to more Graphical I/O as the Console I/O (CONIO) functions, which are in MSVCRT under Win32, just work(TM).<br /><br />I&#39;ll look into it a bit and see if I can find an alternative :)</div>
    <div class="meta">Posted on 2006-09-23 18:03:08 by SpooK</div>
   </div>
   <div class="post" id="post-185475">
    <div class="subject"><a href="#post-185475">Re: My First Win32 Application</a></div>
    <div class="body">OK, good news. I searched through some of my Win32 &quot;console interface source&quot; and was reminded of certain techniques. <br /><br /><strong><u>Summary</u></strong><br />-<a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dllproc/base/getstdhandle.asp"><u>GetStdHandle</u></a> to get the Handle of the Console Window (STD_OUTPUT_HANDLE)<br />-<a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/fileio/fs/writefile.asp"><u>WriteFile</u></a> to write the &quot;Press any key to continue...&quot; message<br />-<a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dllproc/base/getstdhandle.asp"><u>GetStdHandle</u></a> to get the Handle of the Console Window (STD_INPUT_HANDLE)<br />-<a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dllproc/base/getconsolemode.asp"><u>GetConsoleMode</u></a> to get the current mode of the console<br />-Mask unwanted characteristics of the current console mode (like disabling the wait for carriage return/pressing enter), done in reference to MSDN (see Get/SetConsoleMode&#39;s <em>lpMode</em>)<br />-<a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dllproc/base/setconsolemode.asp"><u>SetConsoleMode</u></a> to set the newly modified console mode<br />-<a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/fileio/fs/readfile.asp"><u>ReadFile</u></a> to wait for a key to be pressed<br />-<a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dllproc/base/exitprocess.asp"><u>ExitProcess</u></a> with &quot;0&quot; to terminate the program with no error indication<br /><br />Here is example code of a pure Win32 (Kernel32) approach in NASM32... please search MSDN (like the links above) for any clarification of the API calls in question...<br /><br /><pre><code><br />;nasmw -f win32 demo.asm -o demo.obj<br />;polink.exe /SUBSYSTEM:CONSOLE /ENTRY:main /LIBPATH:\nasm32\lib demo.obj kernel32.lib<br /><br />%include &quot;\nasm32\inc\win32\windows.inc&quot;<br />%include &quot;\nasm32\inc\win32\kernel32.inc&quot;<br />%include &quot;\nasm32\inc\nasm32.inc&quot;<br /><br />	entry	demo<br /><br /><br />	msg	DB	&#39;Press any key to continue...&#39;<br />	.len<br /><br /><br />	hConsole	RESD 1<br />	hBuffer		RESD 1<br />	hNum		RESD 1<br />	hMode		RESD 1<br /><br /><br />proc	demo<br />	invoke	GetStdHandle, STD_OUTPUT_HANDLE<br />	invoke	WriteFile, eax, DWORD msg, DWORD msg.len-msg, DWORD hNum, DWORD 0<br />	invoke	GetStdHandle, STD_INPUT_HANDLE<br />	mov	DWORD, eax<br />	invoke	GetConsoleMode, eax, DWORD hMode<br />	mov	eax, DWORD<br />	and	al, 1 ;MASK unwanted characteristics of the current console mode<br />	invoke	SetConsoleMode, DWORD, eax<br />	invoke	ReadFile, DWORD, DWORD hBuffer, DWORD 1, DWORD hNum, DWORD 0<br />	invoke	ExitProcess, DWORD 0<br />endproc<br /></code></pre><br /><br />I will probably include this as an example in the next NASM32 release.<br /><br />You (lithium) should be able to easily integrate it into your current code. Have fun with it :)</div>
    <div class="meta">Posted on 2006-09-23 19:19:36 by SpooK</div>
   </div>
   <div class="post" id="post-185476">
    <div class="subject"><a href="#post-185476">Re: My First Win32 Application</a></div>
    <div class="body">Thanks a lot for that. You&#39;ve been really helpful.<br /><br />Your code works well but I&#39;m having a slight problem with it. I modified the program to ask for the person&#39;s name and give the person a greeting.<br /><br />The maximum length of a person&#39;s name is X characters and there are no buffer overflows in the program. However, if a person enters X+N characters and I call ReadFile to get a keypress for the &quot;Press any key to continue&quot; the remaining N characters remain on the input buffer and the ReadFile immediately treats them as a keypress and closes the window. So, in other words, the extra characters in the name remain on the input buffer. I tried calling FlushConsoleInputBuffer but that does nothing. Any ideas?<br /><br />EDIT:<br />Also, for the MSVCRT error. I am using Windows XP Pro and I have Visual Studio 2005 installed.</div>
    <div class="meta">Posted on 2006-09-23 19:53:41 by lithium</div>
   </div>
   <div class="post" id="post-185477">
    <div class="subject"><a href="#post-185477">Re: My First Win32 Application</a></div>
    <div class="body">lithium,<br /><br />Regarding the MSVCRT error, read this: <a target="_blank" href="http://www.itwriting.com/blog/?postid=261">Visual Studio 2005 DLL Hell</a>. <br /><br />Your msvcrt.lib file must be referring to msvcr80.dll, which is from Visual C++ 2005.<br /><br />Essentially, if you dynamically link to msvcr80.dll you need to have the .NET Framework 2.0 or the <a target="_blank" href="http://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=32BC1BEE-A3F9-4C13-9C99-220B62A191EE">Visual C++ 2005 Redistributable Package</a> installed for your program to run.<br /> <br />If you have Visual Studio 2005 installed you don&#39;t need the items above.<br /> <br /></div>
    <div class="meta">Posted on 2006-09-23 20:13:46 by Greg</div>
   </div>
   <div class="post" id="post-185479">
    <div class="subject"><a href="#post-185479">Re: My First Win32 Application</a></div>
    <div class="body">It would be easier to use LIB.EXE (from the visual studio) to create msvcrt.lib from msvcrt.dll (There is &quot;_getch&quot; inside it). It&#39;s nearly impossible to find a Windows without msvcrt.dll.</div>
    <div class="meta">Posted on 2006-09-23 20:54:21 by ti_mo_n</div>
   </div>
   <div class="post" id="post-185480">
    <div class="subject"><a href="#post-185480">Re: My First Win32 Application</a></div>
    <div class="body">Greg,<br /><br />I do have Visual Studio 2005 installed. Nevertheless, I installed the redistributable package. The same errors occur. <br /><br /><div class="quote"><br />This application has failed to start because MSVCR80.dll was not found. Re-installing the application may fix this problem<br /></div><br /><br />ti_mo_n,<br /><br />How would I do this and why is this necessary?</div>
    <div class="meta">Posted on 2006-09-23 22:40:59 by lithium</div>
   </div>
   <div class="post" id="post-185481">
    <div class="subject"><a href="#post-185481">Re: My First Win32 Application</a></div>
    <div class="body"><div class="quote"><br />Thanks a lot for that. You&#39;ve been really helpful.<br /><br />Your code works well but I&#39;m having a slight problem with it. I modified the program to ask for the person&#39;s name and give the person a greeting.<br /><br />The maximum length of a person&#39;s name is X characters and there are no buffer overflows in the program. However, if a person enters X+N characters and I call ReadFile to get a keypress for the &quot;Press any key to continue&quot; the remaining N characters remain on the input buffer and the ReadFile immediately treats them as a keypress and closes the window. So, in other words, the extra characters in the name remain on the input buffer. I tried calling FlushConsoleInputBuffer but that does nothing. Any ideas?<br /><br />EDIT:<br />Also, for the MSVCRT error. I am using Windows XP Pro and I have Visual Studio 2005 installed.<br /></div><br /><br />Sounds like an issue with buffer synchronization.<br /><br />Throw in a &quot;invoke WaitForSingleObject, DWORD, DWORD 0xFFFFFFFF&quot;, to tell your program to wait indefinitely (0xFFFFFFFF) for the &quot;FlushConsoleInputBuffer&quot; operation to be complete and the buffer clear.<br /><br />To tell you the truth, and along the same lines, you might not even need to use &quot;FlushConsoleInputBuffer&quot;. Instead, you should be able to simply use &quot;WaitForSingleObject&quot; before the last ReadFile operation (the one that triggers the exit) to achieve the result of the buffer being &quot;clear&quot; (i.e. no delayed input).<br /><br />Let me know which one of these methods works for you ;)<br /><br />As for the MSVCRT issue, <a target="_blank" href="http://www.itwriting.com/blog/?postid=261"><u>the link</u></a> that ti_mo_n posted suggests that you may need the .NET framework (2.0) installed. I have both that and VS2K5 installed and I have no issues with using MSVCRT with the NASM32 package.</div>
    <div class="meta">Posted on 2006-09-23 22:57:47 by SpooK</div>
   </div>
   <div class="post" id="post-185482">
    <div class="subject"><a href="#post-185482">Re: My First Win32 Application</a></div>
    <div class="body">Genius! Pure Genius!<br /><br />It worked. I&#39;m just not sure why it worked. Like you said, I didn&#39;t even need to call FlushInputBuffer. Is the problem that Windows was in the process of flushing the input buffer but the last ReadFile obtained access to the handle before the flushing operation was complete? Or is this completely wrong?<br /><br />Thanks again.</div>
    <div class="meta">Posted on 2006-09-23 23:09:18 by lithium</div>
   </div>
   <div class="post" id="post-185483">
    <div class="subject"><a href="#post-185483">Re: My First Win32 Application</a></div>
    <div class="body">I honestly can&#39;t tell you why it works that way. My best guess is that as there is probably some delay or carry-over from the last key being pressed that is not being taken care of until this form of synchronization is achieved. Almost like it forgot to say &quot;we are done taking input&quot; until interrogated about it :P<br /><br />According to MSDN on <a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dllproc/base/waitforsingleobject.asp"><u>WaitForSingleObject</u></a>, &quot;The function modifies the state of some types of synchronization objects&quot;... and shortly after that it mentions that it also applies directly to Console Input, among other things.<br /><br />To illustrate this, imagine that when dealing with more input than it is willing accept (your example), the function returns while leaving other things in an unknown state. Maybe when you call &quot;ReadFile&quot; the next time, it picks-up from this last state because of the lack of synchronization (i.e. &quot;I am done accepting input from last time&quot;)... and &quot;WaitForSingleObject&quot; forces that signal to occur.<br /><br />Please don&#39;t take my absolute word on this, as it is my best guess with the given material and examples. It is a sizeable amount of code just to replace &quot;_getch&quot;, but it is worth it when it helps you to avoid including MSVCRT just to use that one function... plus it is on an exit routine anyhow... no love-loss for efficiency there :)<br /><br />Whatever the reason... welcome to the world of Windows programming ;)<br /><br />BTW: Here is what the new code looks like for all those who are interested... I&#39;ll probably make it &quot;DEMO12&quot; in NASM32 for the next release...<br /><br /><pre><code><br />%include &quot;\nasm32\inc\win32\windows.inc&quot;<br />%include &quot;\nasm32\inc\win32\kernel32.inc&quot;<br />%include &quot;\nasm32\inc\nasm32.inc&quot;<br /><br />	entry	demo12<br /><br /><br />	msg	DB	&#39;Press any key to continue...&#39;,13,10<br />	.len<br /><br /><br />	hConsole	RESD 1<br />	hBuffer		RESD 1<br />	hNum		RESD 1<br />	hMode		RESD 1<br /><br /><br />proc	demo12<br />	invoke	GetStdHandle, STD_OUTPUT_HANDLE<br />	invoke	WriteFile, eax, DWORD msg, DWORD msg.len-msg, DWORD hNum, DWORD 0<br />	invoke	GetStdHandle, STD_INPUT_HANDLE<br />	mov	DWORD, eax<br />	invoke	GetConsoleMode, eax, DWORD hMode<br />	mov	eax, DWORD<br />	and	al, 1<br />	invoke	SetConsoleMode, DWORD, eax<br />	invoke&nbsp; WaitForSingleObject, DWORD, DWORD 0xFFFFFFFF<br />	invoke	ReadFile, DWORD, DWORD hBuffer, DWORD 1, DWORD hNum, DWORD 0<br />	invoke	ExitProcess, DWORD 0<br />endproc<br /></code></pre><br /><br />Enjoy :)</div>
    <div class="meta">Posted on 2006-09-24 01:23:55 by SpooK</div>
   </div>
  </div>
 </body>
</html>