<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Weird eax value?... - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=12989" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=12989">Weird eax value?...</a></p>
   <div class="post" id="post-100914">
    <div class="subject"><a href="#post-100914">Weird eax value?...</a></div>
    <div class="body">I keep getting a weird eax value for a room number in my in-progress HLA text adventure. Here is the link for the game:<br /><br /><a target="_blank" href="http://panks.tripod.com/hlaadv.html">http://panks.tripod.com/hlaadv.html</a><br /><br />Download it, run it, and you'll see what I mean. I made sure to print out all relevant values when the player issues a &quot;go &lt;direction&gt;&quot; command (e.g. go north, go south, go east, etc.) <br /><br />The game starts out in the village guild. Typing &quot;go east&quot; (based on the map: <a target="_blank" href="http://members.tripod.com/~panks/hlaadv.html">http://members.tripod.com/~panks/hlaadv.html</a>) should place the player in the room with the village well. It does that, and you can go back to the guild via &quot;go west&quot;, go any attempt to move north, south or east from the village well makes the destination room some crazy, out of bounds number like 657163. This is not a valid room number. If I attempt to go in any direction from this false room, the program then crashes with HLA Exception ($c000_0005) &quot;Memory Access Violation&quot;.<br /><br />The routine for the go verb (the command for how the player moves about the adventure) is in lines 1078 through 1089.<br /><br />Any ideas as to what is causing eax to go wacky?<br /><br />Here's the code for lines 1078 through 1089:<br /><br />stdout.put(r,nl);<br />mov(r,eax);<br />imul(r);<br />stdout.put(r,nl);<br />add(s,eax);<br />mov(eax,r);<br />stdout.put(eax,nl);<br />if(m&gt;0) then<br />mov(m,r);<br />stdout.put(r,nl);<br />jmp Room;<br />endif;<br /><br />&quot;jmp Room&quot; just sends the program back to the routine for printing out the new room description.<br /><br />Regards,<br /><br />Paul Panks<br /><a href="mailto:dunric@yahoo.com">dunric@yahoo.com</a></div>
    <div class="meta">Posted on 2003-05-03 06:36:23 by Paul Panks</div>
   </div>
   <div class="post" id="post-100930">
    <div class="subject"><a href="#post-100930">Re: Weird eax value?...</a></div>
    <div class="body"><div class="quote"><br />I keep getting a weird eax value for a room number in my in-progress HLA text adventure. Here is the link for the game:<br /><br /><a target="_blank" href="http://panks.tripod.com/hlaadv.html">http://panks.tripod.com/hlaadv.html</a><br /><br />any attempt to move north, south or east from the village well makes the destination room some crazy, out of bounds number like 657163. This is not a valid room number. <br />Here's the code for lines 1078 through 1089:<br /><br />stdout.put(r,nl);<br />mov(r,eax);<br />imul(r);<br />stdout.put(r,nl);<br />add(s,eax);<br />mov(eax,r);<br />stdout.put(eax,nl);<br />if(m&gt;0) then<br />mov(m,r);<br />stdout.put(r,nl);<br />jmp Room;<br />endif;<br /><br />&quot;jmp Room&quot; just sends the program back to the routine for printing out the new room description.<br /><br />Regards,<br /><br />Paul Panks<br /><a href="mailto:dunric@yahoo.com">dunric@yahoo.com</a> </div><br /><br />mov(r,eax);<br />imul(r);<br /><br />Computes r*r into EAX.  Is this what you wanted?<br />Also, don't forget that imul wipes out the value in EDX -<br />hopefully it doesn't contain a value you want preserved.<br /><br />If m is a multi-dimensional array that you want to access<br />as m then the computation you want is<br /><br />(c*(size of row) + r) * (size of array element).<br />Cheers,<br />Randy Hyde</div>
    <div class="meta">Posted on 2003-05-03 09:23:16 by rhyde</div>
   </div>
   <div class="post" id="post-100954">
    <div class="subject"><a href="#post-100954">Weird eax value?...</a></div>
    <div class="body">Randy,<br /><br />Do I inset the mov(eax,r), imul(r) in a second time? Or are you suggesting the code is reversed of what I want? Does this fix it from crashing?<br /><br />Paul</div>
    <div class="meta">Posted on 2003-05-03 12:10:47 by Paul Panks</div>
   </div>
   <div class="post" id="post-101158">
    <div class="subject"><a href="#post-101158">Weird eax value?...</a></div>
    <div class="body"><div class="quote"><br />Randy,<br /><br />Do I inset the mov(eax,r), imul(r) in a second time? Or are you suggesting the code is reversed of what I want? Does this fix it from crashing?<br /><br />Paul </div><br />No, I was just commenting that your sequence produces r*r and you<br />probably want r*n where n is the number of columns.<br /><br />The intmul instruction, btw, is perfect for computing array indexes.<br />Assuming n is a constant, you can compute r*n -&gt; eax with a single<br />instruction, e.g.,<br /><br />intmul( n, r, eax );<br /><br />or, in your case,<br /><br />intmul( 6, r, eax );<br /><br />btw, HLA has a compile-time function you might be interested in using,<br />@dim that returns an array constant containing the bounds for each<br />dimension of the array (i.e., @dims(m) in your example would return the<br />array constant [42, 6]).  You can use this to improve the maintainability<br />of your code as follows:<br /><br />intmul( @dim(m)[1], 4, eax );<br /><br />@dim(m) returns the array constant [42, 6] and the [1] subscript returns the<br />number of columns (i.e., the row size).<br /><br />Along with the @elementSize compile-time function, you can make a completely<br />general array access using code like the following:<br /><br /><br /><pre><code><br />program t;<br />static<br />    r   &#58;uns32;<br />    c   &#58;uns32;<br />    m   &#58;int32&#91; 42, 6 &#93;;<br />            <br />begin t;<br /><br />    // Code to index into array m&#91; r, c &#93;;<br />    <br />    intmul&#40; @dim&#40;m&#41;&#91;1&#93;, r, eax &#41;;<br />    add&#40; c, eax &#41;;<br />    <br />    // Must multiply by element size.<br />    // Note that this isn't really necessary for int32<br />    // objects as you can use the &#91;eax*4&#93; addressing mode<br />    // instead, but this is the general solution.<br />    <br />    intmul&#40; @elementSize&#40;m&#41;, eax &#41;;<br />    <br />    // ebx = m&#91;r,c&#93;;<br />    <br />    mov&#40; m&#91;eax&#93;, ebx &#41;;<br />    <br /><br />end t;<br /><br /></code></pre> <br /><br />The cool thing about this code is that you can change the array dimensions and type<br />to your heart's content and the code will automatically work (with just a recompile)<br />with no other changes.<br /><br />Cheers,<br />Randy Hyde</div>
    <div class="meta">Posted on 2003-05-04 19:15:41 by rhyde</div>
   </div>
   <div class="post" id="post-101165">
    <div class="subject"><a href="#post-101165">Weird eax value?...</a></div>
    <div class="body">Randy,<br /><br />I tried your example but for some reason I kept getting repeats (e.g. m[1*5] versus m[5*1]).<br /><br />I then simplified the code as follows, and included the map portion in the same block of code. See: <a target="_blank" href="http://www.geocities.com/dunric/hlaadv.html">http://www.geocities.com/dunric/hlaadv.html</a>  for a map of the game):<br /><br />verb1:<br />// room 1<br />mov(5,m[3]);<br />mov(2,m[6]);<br /><br />// room 2<br />mov(4,m[7]);<br />mov(1,m[10]);<br /><br />// room 3<br />mov(5,m[13]);<br /><br />// room 4<br />mov(2,m[20]);<br /><br />// room 5<br />mov(1,m[26]);<br />mov(6,m[27]);<br />mov(3,m[28]);<br />// room 6<br />mov(5,m[37]);<br />mov(11,m[38]);<br />mov(7,m[39]);<br />mov(10,m[40]);<br /><br />// room 7<br />mov(8,m[50]);<br />mov(6,m[53]);<br /><br />// room 8<br />mov(7,m[66]);<br />mov(9,m[67]);<br /><br />// room 9<br />mov(8,m[85]);<br /><br />// room 10<br />mov(6,m[103]);<br /><br />// room 11<br />mov(6,m[122]);<br />mov(12,m[123]);<br /><br />// room 12<br />mov(11,m[145]);<br />mov(13,m[146]);<br /><br />// room 13<br />mov(12,m[170]);<br />mov(14,m[171]);<br /><br />// room 14<br />mov(13,m[197]);<br />mov(28,m[198]);<br />mov(22,m[199]);<br />mov(29,m[200]);<br /><br />// room 15<br />mov(19,m[227]);<br /><br />// room 16<br />mov(20,m[258]);<br /><br />// room 17<br />mov(18,m[292]);<br />mov(16,m[295]);<br /><br />// room 18<br />mov(17,m[328]);<br /><br />// room 19<br />mov(15,m[362]);<br />mov(22,m[363]);<br />mov(20,m[364]);<br /><br />// room 20<br />mov(16,m[401]);<br />mov(23,m[402]);<br />mov(21,m[403]);<br />mov(19,m[404]);<br /><br />// room 21<br />mov(20,m[445]);<br /><br />// room 22<br />mov(19,m[485]);<br />mov(27,m[486]);<br />mov(23,m[487]);<br />mov(14,m[488]);<br /><br />// room 23<br />mov(20,m[530]);<br />mov(26,m[531]);<br />mov(24,m[532]);<br />mov(22,m[533]);<br /><br />// room 24<br />mov(23,m[580]);<br /><br />// room 25<br />mov(26,m[629]);<br /><br />// room 26<br />mov(23,m[677]);<br />mov(25,m[679]);<br /><br />// room 27<br />mov(22,m[730]);<br /><br />// room 28<br />mov(14,m[795]);<br /><br />// room 29<br />mov(14,m[844]);<br />mov(30,m[845]);<br /><br />// room 30<br />mov(29,m[903]);<br />mov(31,m[904]);<br /><br />// room 31<br />mov(32,m[962]);<br />mov(30,m[964]);<br />mov(34,m[965]);<br /><br />// room 32<br />mov(33,m[1025]);<br />mov(31,m[1026]);<br /><br />// room 33<br />mov(32,m[1091]);<br /><br />mov(r,eax);<br />imul(r);<br />add(s,eax);<br />stdout.put(m,nl);<br />if(m&gt;0) then<br />mov(m,ebx);<br />mov(ebx,r);<br />stdout.put(r,nl);<br />jmp Room;<br />endif;<br /><br />console.setOutputAttr( win.fgnd_LightRed | win.bgnd_Black );<br />stdout.put( &quot;You can't go that way!&quot;, nl);<br />jmp parse;<br /><br />The code section:<br /><br />mov(r,eax);<br />imul(r);<br />add(s,eax);<br />stdout.put(m,nl);<br />if(m&gt;0) then<br />mov(m,ebx);<br />mov(ebx,r);<br />stdout.put(r,nl);<br />jmp Room;<br />endif;<br /><br />Works going from Room#10 (the guild) to the village well (#6) but trying to go from the village well (#6) to Rooad (#5), inflates &quot;r&quot; to an impossible room number. Is there a reason this occurs? If m is greater than 0, then:<br /><br />mov(m,ebx);<br />mov(ebx,r)<br />Jmp Room;<br /><br />Any ideas? m is m (&quot;r&quot; is the current room number; &quot;s&quot; is 1 through 6, 1 for north, 2 for south, 3 for east, 4 for west, 5 for up and 6 for down).<br /><br />Regards,<br /><br />Paul Panks<br /><a href="mailto:dunric@yahoo.com">dunric@yahoo.com</a></div>
    <div class="meta">Posted on 2003-05-04 19:34:15 by Paul Panks</div>
   </div>
   <div class="post" id="post-101200">
    <div class="subject"><a href="#post-101200">Weird eax value?...</a></div>
    <div class="body"><div class="quote"><br />Randy,<br /><br />I tried your example but for some reason I kept getting repeats (e.g. m[1*5] versus m[5*1]).<br /><br />I then simplified the code as follows, and included the map portion in the same block of code. See: <a target="_blank" href="http://www.geocities.com/dunric/hlaadv.html">http://www.geocities.com/dunric/hlaadv.html</a>  for a map of the game):<br /><br /><br />Any ideas? m is m (&quot;r&quot; is the current room number; &quot;s&quot; is 1 through 6, 1 for north, 2 for south, 3 for east, 4 for west, 5 for up and 6 for down).<br /><br />Regards,<br /><br />Paul Panks<br /><a href="mailto:dunric@yahoo.com">dunric@yahoo.com</a> </div><br /><br />1*5 and 5*1 should definitely not generate the same value for the row-major computation. Given this array:<br /><br />m:dword[42,6];<br /><br />Then the &quot;rowsize&quot; is 6 (six elements per row).<br /><br />Row major computation to access element m is<br /><br />r*rowsize+c.<br /><br />IOW:<br /><br />r*6+c<br /><br />with r=1 and c=5 you should have<br /><br />1*6+5 = 11<br /><br />with r=5 and c=1 you should have<br /><br />5*6+1 = 30<br /><br />If you're getting the same result when swapping the value of r and c,<br />then your code sequence that does the row-major order computation<br />is incorrect.<br /><br />I still argue that it's much better to use the HLA arrays module to<br />do this computation for you.  Given *any* array you declare in HLA,<br />you can write<br /><br />array.index( &lt;some-32-bit-register&gt;, arrayName, &lt;&lt;list of indexes&gt;&gt; );<br />and this will place the appropriate index into the register you specify.<br />So, for example, to access m you'd use code like the following:<br /><br />array.index( ebx, m, r, c );<br /><br />After this, ebx would point at the specified array element.<br />If m is an array of double words, you could access the array element<br />using code like this:<br /><br />mov( , eax  );  // Retrieve m into eax<br /><br /> -or-<br />    <br />mov( eax,  );  // Store EAX away into m<br /><br /><br />If m is an array of some other type (let's say a structure of type &quot;room&quot;) then<br />you could access that array element using code like this:<br /><br />mov( (type room ).SomeFieldInRoom, eax );<br /><br />The array.index code is actually a macro that is fairly smart and<br />generates decent code to access the array element.  In some special<br />cases you can beat it by writing the code out manually, but most of the<br />time you shouldn't be afraid to use this macro from the HLA Standard Library.<br />It's so easy to use, and will save you all the headaches you're having,<br />I heartily recommend that you consider using it.<br />Cheers,<br />Randy Hyde</div>
    <div class="meta">Posted on 2003-05-04 21:37:16 by rhyde</div>
   </div>
   <div class="post" id="post-101219">
    <div class="subject"><a href="#post-101219">Weird eax value?...</a></div>
    <div class="body">The code I wish to use is the following:<br />&lt;code&gt;<br />  stdout.put(r,nl);<br />  mov(r,eax);<br />  imul(eax);<br />  stdout.put(r,nl);<br />  add(s,eax);<br />  mov(eax,r);<br />  stdout.put(eax,nl);<br />  if(m&gt;0) then<br />  mov(m,r);<br />  stdout.put(r,nl);<br />  jmp Room;<br />  endif;<br />  console.setOutputAttr( win.fgnd_LightRed | win.bgnd_Black );<br />  stdout.put( &quot;You can't go that way!&quot;, nl);<br />  jmp parse;<br />&lt;/code&gt;<br /><br />Let me explain what I am trying to do here.<br /><br />I first move &quot;r&quot; (the current room number) into eax.<br />I then multiply eax by eax (value of r*r since &quot;r&quot; is in eax, so &quot;imul(eax)  )<br />I then add s to the value of eax (add (s,eax) )<br /><br />This should be equivalent to the following (if I did the code correctly):<br /><br />m<br /><br />&quot;s&quot; is assigned a value earlier in the program based on what is entered for the noun. 1 for north, 2 for south, 3 for east, 4 for west, 5 for up, 6 for down. <br /><br />Earlier in the program I set m to equal room numbers based on the values of room*room together, added to s. So in the case of moving from the guild (room #10) to the village well (Room #6), the following code should work:<br /><br />m(10*10+3]:=6<br /><br />or<br /><br />m[103]:=6<br /><br />&quot;10&quot; is the current room number (the guild), &quot;3&quot; is the direction (east) and &quot;6&quot; is the destination room (the village well).<br /><br />I had to issue about 50 or 60 lines of mov(x,m) for it to work. You can download and view source code at: <a target="_blank" href="http://members.tripod.com/~panks/hlaadv.html">http://members.tripod.com/~panks/hlaadv.html</a><br /><br />But when I do the code below:<br /><br />&lt;code&gt;<br />stdout.put(r,nl);<br />mov(r,eax);<br />imul(eax);<br />stdout.put(r,nl);<br />add(s,eax);<br />mov(eax,r);<br />stdout.put(eax,nl);<br />if(m&gt;0) then<br />mov(m,r);<br />stdout.put(r,nl);<br />jmp Room;<br />endif;<br />console.setOutputAttr( win.fgnd_LightRed | win.bgnd_Black );<br />stdout.put( &quot;You can't go that way!&quot;, nl);<br />jmp parse;<br />&lt;/code&gt;<br /><br />I receive the following output:<br /><br />Guild<br />You are standing in a large guild room. A large crescent flag<br />with a star emblazoned on it drapes down from the ceiling. A few<br />tables and chairs are here, as well as a large fireplace.<br />Exits: &lt;east&gt;<br />&gt;go east<br />10<br />0000_0064<br />0000_0067<br />6<br />Village well<br />You are looking down on your reflection over a deep artisan<br />well. The water rises some 100 feet below ground level, and<br />the sides are green with moss.<br />Exits: &lt;north,south,east,west&gt;<br />&gt;go north<br />6<br />0000_0024<br />0000_0025<br />168233733<br />&gt;<br /><br />It is the &quot;168233733&quot; which concerns me most. In the previous room:<br /><br />Guild<br />You are standing in a large guild room. A large crescent flag<br />with a star emblazoned on it drapes down from the ceiling. A few<br />tables and chairs are here, as well as a large fireplace.<br />Exits: &lt;east&gt;<br />&gt;go east<br />10<br />0000_0064<br />0000_0067<br />6<br />Village well<br />You are looking down on your reflection over a deep artisan<br />well. The water rises some 100 feet below ground level, and<br />the sides are green with moss.<br />Exits: &lt;north,south,east,west&gt;<br /><br />The value of m[10*10+3] was equal to 6, and so the player moved to the village well. You can also move back from the well to the guild:<br /><br />Village well<br />You are looking down on your reflection over a deep artisan<br />well. The water rises some 100 feet below ground level, and<br />the sides are green with moss.<br />Exits: &lt;north,south,east,west&gt;<br />&gt;go west<br />6<br />0000_0024<br />0000_0028<br />10<br />Guild<br />You are standing in a large guild room. A large crescent flag<br />with a star emblazoned on it drapes down from the ceiling. A few<br />tables and chairs are here, as well as a large fireplace.<br />Exits: &lt;east&gt;<br />&gt;<br /><br />You might be wondering what &quot;6&quot;,&quot;0000_0024&quot; and other numbers mean. In my code below:<br /><br />&lt;code&gt;<br />stdout.put(r,nl);<br />mov(r,eax);<br />imul(eax);<br />stdout.put(r,nl);<br />add(s,eax);<br />mov(eax,r);<br />stdout.put(eax,nl);<br />if(m&gt;0) then<br />mov(m,r);<br />stdout.put(r,nl);<br />jmp Room;<br />endif;<br />console.setOutputAttr( win.fgnd_LightRed | win.bgnd_Black );<br />stdout.put( &quot;You can't go that way!&quot;, nl);<br />jmp parse;<br />&lt;/code&gt;<br /><br />stdout.put(r,nl) is printing out the room location. Later on, &quot;stdout.put(eax,nl) should be printing out the value results of &quot;mov(r,eax); imul(eax); add(s,eax);&quot;.<br /><br />What I'm trying to figure out is why a room number such as &quot;168233733&quot; is assigned to &quot;r&quot; when the player moves north from the village well:<br /><br />6<br />Village well<br />You are looking down on your reflection over a deep artisan<br />well. The water rises some 100 feet below ground level, and<br />the sides are green with moss.<br />Exits: &lt;north,south,east,west&gt;<br />&gt;go north<br />6<br />0000_0024<br />0000_0025<br />168233733<br />&gt;<br /><br />Sorry if this is terribly confusing. :)<br /><br />Regards,<br /><br />Paul Panks<br /><a href="mailto:dunric@yahoo.com">dunric@yahoo.com</a></div>
    <div class="meta">Posted on 2003-05-04 23:31:33 by Paul Panks</div>
   </div>
   <div class="post" id="post-101234">
    <div class="subject"><a href="#post-101234">Weird eax value?...</a></div>
    <div class="body">Paul, you should be using r*42+c (r * n + c) not r * r + c.<br /><br />Where n is the total number of rows you have initialized the array for.</div>
    <div class="meta">Posted on 2003-05-05 01:28:35 by V Coder</div>
   </div>
   <div class="post" id="post-101261">
    <div class="subject"><a href="#post-101261">Weird eax value?...</a></div>
    <div class="body">V Coder,<br /><br />Yes, that is true. But it still doesn't explain the weird eax values. I can't seem to pinpoint why they occur from my code.<br /><br />Paul</div>
    <div class="meta">Posted on 2003-05-05 05:52:05 by Paul Panks</div>
   </div>
   <div class="post" id="post-101715">
    <div class="subject"><a href="#post-101715">Weird eax value?...</a></div>
    <div class="body"><div class="quote"><br />V Coder,<br /><br />Yes, that is true. But it still doesn't explain the weird eax values. I can't seem to pinpoint why they occur from my code.<br /><br />Paul </div><br /><br />The weird values are almost certainly due to the fact that you're indexing the<br />array as though it were a byte array, but you're storing and retrieving dword<br />values.  You need to use the edx*4 address mode when accessing elements<br />of a dword (int32) array.<br />Cheers,<br />Randy Hyde</div>
    <div class="meta">Posted on 2003-05-06 22:45:59 by rhyde</div>
   </div>
  </div>
 </body>
</html>