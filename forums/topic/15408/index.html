<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>CPU add voltage elements - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=15408" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=15408">CPU add voltage elements</a></p>
   <div class="post" id="post-119725">
    <div class="subject"><a href="#post-119725">CPU add voltage elements</a></div>
    <div class="body">HI~  having Good ,I is Chinee. think consultation Entries about CPU add voltage elements question. <br />undersurface is my whole CPU add frequency code. code to ring0 at (98)<br /><br />.586p<br />.model flat<br />extrn MessageBoxA: proc<br />extrn ExitProcess: proc<br /><br />SMBus_Port = 5000h<br /><br />NEWIODELAY     	MACRO<br />out	0ebh,al              <br />ENDM  <br /><br />.data<br />YANG db 'YANGMIN',0<br />MIN  db 'YM',0<br />.code <br />YM:<br />    pushad<br />    push  eax <br />    sidt    <br />    pop   ebx     <br />    add   ebx,3*8  <br />    mov   ecx,   <br />    mov   edx, <br />    call  SetMyInt03<br />MyInt03:          ; ring 0<br />    pushad<br />		mov	ah, 078h<br />		mov	cx,0d211h		<br />		call	Ct_I2CWriteWord<br />		NEWIODELAY<br />		NEWIODELAY   <br />		mov	cx,0d212h		<br />		mov	ah,0Eh			<br />		call	Ct_I2CWriteWord<br />		NEWIODELAY<br />		NEWIODELAY<br />                mov	cx,0d21fh		<br />                xor	ax, 0000h			<br />                call	Ct_I2CWriteWord<br />		NEWIODELAY<br />		NEWIODELAY<br />                popad<br />                iretd<br />Ct_I2CWriteWord:<br />		push	ax<br />		push	cx<br />                mov	dx,SMBus_Port +04h<br />		mov	al,ch			<br />		out	dx,al<br />		NEWIODELAY<br />		NEWIODELAY<br />                call	CT_Chk_SMBus_Ready <br />                pop	ax<br />		mov	dl,03h<br />		out	dx,al		<br />		NEWIODELAY<br />		NEWIODELAY<br />                pop	ax<br />		mov	dl,05<br />		out	dx,al			<br />		NEWIODELAY<br />		NEWIODELAY<br />                mov	dl,06<br />		mov	al,ah<br />		out	dx,al			<br />		NEWIODELAY<br />		NEWIODELAY<br />                mov	dl,02h<br />		mov	al,4ch<br />		out	dx,al			<br />		NEWIODELAY<br />		NEWIODELAY<br />                xor	cx,cx<br />;@@:				<br />		NEWIODELAY	<br />		NEWIODELAY<br />		NEWIODELAY		<br />;		loop	short @@			<br />                call	CT_Chk_SMBus_Ready <br />                ret <br />CT_Chk_SMBus_Ready:<br />		mov	dx,SMBus_Port + 0;status port<br />		clc<br />		mov	cx,0800h<br />Chk_I2c_OK:<br />		in	al,dx		<br />		NEWIODELAY<br />		out 	dx,al		<br />		NEWIODELAY<br />                test	al, 02H		<br />		jnz	short Clear_final<br />                and	al, NOT 40H	<br />		or	al,al		<br />		jz	short Clear_final<br />                test	al,04h		<br />		jnz	short SMBus_Err<br />                loop	short Chk_I2c_OK<br />SMBus_Err:<br />                stc<br />		ret<br />Clear_final:<br />		clc<br />		ret<br /><br /><br />SetMyInt03:<br />    cli    <br />    pop   word ptr<br />    pop   word ptr  <br />    int   03        <br />Ring3GoNo:<br />    sti<br />    popad<br />push large 0<br />push offset YANG<br />push offset MIN<br />push large 0<br />call MessageBoxA<br /><br />push large 0<br />call ExitProcess<br />ends<br />end YM<br /><br /><br />why Failed ?<br /><br />china chat tools QQ:64529179<br /><br />sis thank you!!!!!!!!!!!!!!!:) :alright:</div>
    <div class="meta">Posted on 2003-09-27 11:10:09 by yangmin26</div>
   </div>
   <div class="post" id="post-119736">
    <div class="subject"><a href="#post-119736">CPU add voltage elements</a></div>
    <div class="body">1)First of all this is NOT the proper way to get into ring0.<br /><br />To run code into ring0:<br />-one must use either an VxD for win9x <br />-or an KMD for Win2k/XP<br />- another option is to use an OS (like my SOLAR OS) that runs in ring0 all the time.<br />This can help fast and easy tetsing hardware drivers code..postponing KMD until needed.<br /><br />2)Second:<br />Your code is very hard to read and understand. I am aware of the Callgates and IDT patching -- hackish style--  to get into ring0 under win9x but i can barely read the code you have posted.<br /><br />Clear up your mind a little and  and arrange your code in a manner more easy to understand and read by others. After all before beeing a Chinese you are an humman beeing. Please explain what it is intended to do...<br /><br />There are so many reasons for such kind of bad code to fail that i can not test them all. Please let us know: <br />-How is it failing and where?<br /><br />Besides a more clar explanation of your reasons for dooing this will help a lot...<br /><br />Have you read the rules?<br /><br />Please explain why are you not using an Vxd or an KMD?</div>
    <div class="meta">Posted on 2003-09-27 12:49:54 by BogdanOntanu</div>
   </div>
   <div class="post" id="post-119779">
    <div class="subject"><a href="#post-119779">CPU add voltage elements</a></div>
    <div class="body">happy :)   Enter Windows98 kernel Do not use vxd, use i of code stabilization alike good .  <br />i think is Write Frequency occurrence machine Underneath these initialize data error .<br />;Input : CL - register index<br />;           CH - device ID <br />;           AX - Value to write<br /><br />Underneath I proceed the code explains.<br /><br />.586p<br />.model flat<br />extrn MessageBoxA: proc<br />extrn ExitProcess: proc<br /><br />SMBus_Port = 5000h              <br /><br />NEWIODELAY     	MACRO         ;IO Sleep<br />out	0ebh,al              <br />ENDM  <br /><br />.data<br />YANG db 'YANGMIN',0<br />MIN  db 'YM',0<br />.code <br />YM:<br />    pushad              ;Save all register<br />    push  eax <br />    sidt         ;Save IDT Base address<br />    pop   ebx           ;pop-up IDT Base address<br />    add   ebx,3*8       ;gained int 3 linetype address pointer<br />    mov   ecx,   <br />    mov   edx,   ;Save int 3 linetype address pointer<br />    call  SetMyInt03<br />MyInt03:         <br />    pushad<br />		mov	ah, 078h         ; likelihood  error<br />		mov	cx,0d211h	 ; likelihood  error	<br />		call	Ct_I2CWriteWord<br />		NEWIODELAY<br />		NEWIODELAY   <br />		mov	cx,0d212h	 ; likelihood  error	<br />		mov	ah,0Eh		 ; likelihood  error	 <br />		call	Ct_I2CWriteWord<br />		NEWIODELAY<br />		NEWIODELAY<br />                mov	cx,0d21fh	  ; likelihood  error	<br />                xor	ax, 0000h	  ; likelihood  error		<br />                call	Ct_I2CWriteWord<br />		NEWIODELAY<br />		NEWIODELAY<br />                popad<br />                iretd                     ;exit ring0 to ring3<br /><br />;Write Frequency occurrence machine code <br />;Input : CL - register index<br />;        CH - device ID <br />;	 AX - Value to write<br />Ct_I2CWriteWord:<br />		push	ax<br />		push	cx<br />                mov	dx,SMBus_Port +04h<br />		mov	al,ch			;ID cmd(Write)<br />		out	dx,al<br />		NEWIODELAY<br />		NEWIODELAY<br />                call	CT_Chk_SMBus_Ready <br />                pop	ax<br />		mov	dl,03h<br />		out	dx,al			;Index<br />		NEWIODELAY<br />		NEWIODELAY<br />                pop	ax<br />		mov	dl,05<br />		out	dx,al			;Data0<br />		NEWIODELAY<br />		NEWIODELAY<br />                mov	dl,06<br />		mov	al,ah<br />		out	dx,al			;Data1<br />		NEWIODELAY<br />		NEWIODELAY<br />                mov	dl,02h<br />		mov	al,4ch<br />		out	dx,al			;write data<br />		NEWIODELAY<br />		NEWIODELAY<br />                xor	cx,cx<br />;@@:				<br />		NEWIODELAY	<br />		NEWIODELAY<br />		NEWIODELAY		<br />;		loop	short @@			<br />                call	CT_Chk_SMBus_Ready <br />                ret <br /><br /><br />CT_Chk_SMBus_Ready:<br />		mov	dx,SMBus_Port + 0;status port<br />		clc<br />		mov	cx,0800h<br />Chk_I2c_OK:<br />		in	al,dx		;get status<br />		NEWIODELAY<br />		out 	dx,al		;clear status<br />		NEWIODELAY<br />                test	al, 02H		;termination of command ?<br />		jnz	short Clear_final<br />                and	al, NOT 40H	;mask INUSE bit	;R06<br />		or	al,al		;status OK ?<br />		jz	short Clear_final<br />                test	al,04h		;device error<br />		jnz	short SMBus_Err<br />                loop	short Chk_I2c_OK<br />	;SMbus error due to timeout<br />SMBus_Err:<br />                stc<br />		ret<br />Clear_final:<br />		clc<br />		ret<br /><br /><br />SetMyInt03:<br />    cli    <br />    pop   word ptr<br />    pop   word ptr   ;make over  int 3 linetype address pointer<br />    int   03                 ;enter Ring0 flage MyInt03<br />Ring3GoNo: <br />    sti<br />    popad<br /><br />push large 0<br />push offset YANG<br />push offset MIN<br />push large 0<br />call MessageBoxA<br /><br />push large 0<br />call ExitProcess<br />ends<br />end YM</div>
    <div class="meta">Posted on 2003-09-28 01:44:45 by yangmin26</div>
   </div>
   <div class="post" id="post-119781">
    <div class="subject"><a href="#post-119781">CPU add voltage elements</a></div>
    <div class="body">Chinaman YangMin</div>
    <div class="meta">Posted on 2003-09-28 02:06:09 by yangmin26</div>
   </div>
   <div class="post" id="post-119782">
    <div class="subject"><a href="#post-119782">CPU add voltage elements</a></div>
    <div class="body">publicize me of portion not need Driver at(winnt and win2000 and winxp) ring0 code :)!!!!!!!!!!!!!!!<br /> everybody remember my name !YangMin!<br /><br />VOID SetPhyscialMemorySectionCanBeWrited(HANDLE hSection)<br />    {<br /><br />       PACL pDacl=NULL;<br />       PACL pNewDacl=NULL;<br />       PSECURITY_DESCRIPTOR pSD=NULL;<br />       DWORD dwRes;<br />       EXPLICIT_ACCESS ea;<br /><br />       if(dwRes=GetSecurityInfo(hSection,SE_KERNEL_OBJECT,DACL_SECURITY_INFORMATION,<br />                  NULL,NULL,&amp;pDacl,NULL,&amp;pSD)!=ERROR_SUCCESS)<br />          {<br />             printf( &quot;GetSecurityInfo Error %u\n&quot;, dwRes );<br />             goto CleanUp;<br />          }<br /><br />       ZeroMemory(&amp;ea, sizeof(EXPLICIT_ACCESS));<br />       ea.grfAccessPermissions = SECTION_MAP_WRITE;<br />       ea.grfAccessMode = GRANT_ACCESS;<br />       ea.grfInheritance= NO_INHERITANCE;<br />       ea.Trustee.TrusteeForm = TRUSTEE_IS_NAME;<br />       ea.Trustee.TrusteeType = TRUSTEE_IS_USER;<br />       ea.Trustee.ptstrName = &quot;CURRENT_USER&quot;;<br /><br /><br />       if(dwRes=SetEntriesInAcl(1,&amp;ea,pDacl,&amp;pNewDacl)!=ERROR_SUCCESS)<br />          {<br />             printf( &quot;SetEntriesInAcl %u\n&quot;, dwRes );<br />             goto CleanUp;<br />          }<br /><br />       if(dwRes=SetSecurityInfo(hSection,SE_KERNEL_OBJECT,DACL_SECURITY_INFORMATION,NULL,NULL,pNewDacl,NULL)!=ERROR_SUCCESS)<br />          {<br />             printf(&quot;SetSecurityInfo %u\n&quot;,dwRes);<br />             goto CleanUp;<br />          }<br /><br />    CleanUp:<br /><br />       if(pSD)<br />          LocalFree(pSD);<br />       if(pNewDacl)<br />          LocalFree(pSD);<br />    }<br /><br /><br />typedef struct gdtr {<br />        short Limit;<br />        short BaseLow;<br />        short BaseHigh;<br />    } Gdtr_t, *PGdtr_t;<br /><br />    ULONG MiniMmGetPhysicalAddress(ULONG virtualaddress)<br />    {<br />        if(virtualaddress&lt;0x80000000||virtualaddress&gt;=0xA0000000)<br />           return 0;<br />        return virtualaddress&amp;0x1FFFF000;<br />    }<br /><br />    BOOL ExecRing0Proc(ULONG Entry,ULONG seglen)<br />    {<br />       Gdtr_t gdt;<br />       __asm sgdt gdt;<br />     <br />       ULONG mapAddr=MiniMmGetPhysicalAddress(gdt.BaseHigh&lt;&lt;16U|gdt.BaseLow);<br />       if(!mapAddr) return 0;<br /><br />       HANDLE   hSection=NULL;<br />       NTSTATUS status;<br />       OBJECT_ATTRIBUTES        objectAttributes;<br />       UNICODE_STRING objName;<br />       CALLGATE_DESCRIPTOR *cg;<br /><br />       status = STATUS_SUCCESS;<br />   <br />       RtlInitUnicodeString(&amp;objName,L&quot;\\Device\\PhysicalMemory&quot;);<br /><br />       InitializeObjectAttributes(&amp;objectAttributes,<br />                                  &amp;objName,<br />                                  OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,<br />                                  NULL,<br />                                 (PSECURITY_DESCRIPTOR) NULL);<br /><br />       status = ZwOpenSection(&amp;hSection,SECTION_MAP_READ|SECTION_MAP_WRITE,&amp;objectAttributes);<br /><br />       if(status == STATUS_ACCESS_DENIED){<br />          status = ZwOpenSection(&amp;hSection,READ_CONTROL|WRITE_DAC,&amp;objectAttributes);<br />          SetPhyscialMemorySectionCanBeWrited(hSection);<br />          ZwClose(hSection);<br />          status =ZwOpenSection(&amp;hSection,SECTION_MAP_WRITE|SECTION_MAP_WRITE,&amp;objectAttributes);<br />       }<br /><br />       if(status != STATUS_SUCCESS)<br />         {<br />            printf(&quot;Error Open PhysicalMemory Section Object,Status:%08X\n&quot;,status);<br />            return 0;<br />         }<br />      <br />       PVOID BaseAddress;<br /><br />       BaseAddress=MapViewOfFile(hSection,<br />                     FILE_MAP_READ|FILE_MAP_WRITE,<br />                     0,<br />                     mapAddr,    //low part<br />                     (gdt.Limit+1));<br /><br />       if(!BaseAddress)<br />          {<br />             printf(&quot;Error MapViewOfFile:&quot;);<br />             PrintWin32Error(GetLastError());<br />             return 0;<br />          }<br /><br />       BOOL setcg=FALSE;<br /><br />       for(cg=(CALLGATE_DESCRIPTOR *)((ULONG)BaseAddress+(gdt.Limit&amp;0xFFF8));(ULONG)cg&gt;(ULONG)BaseAddress;cg--)<br />           if(cg-&gt;type == 0){<br />             cg-&gt;offset_0_15 = LOWORD(Entry);<br />             cg-&gt;selector = 8;<br />             cg-&gt;param_count = 0;<br />             cg-&gt;some_bits = 0;<br />             cg-&gt;type = 0xC;          // 386 call gate<br />             cg-&gt;app_system = 0;      // A system descriptor<br />             cg-&gt;dpl = 3;             // Ring 3 code can call<br />             cg-&gt;present = 1;<br />             cg-&gt;offset_16_31 = HIWORD(Entry);<br />             setcg=TRUE;<br />             break;<br />          }<br /><br />       if(!setcg){<br />            ZwClose(hSection);<br />            return 0;<br />       }<br /><br />       short farcall[3];<br /><br />       farcall[2]=((short)((ULONG)cg-(ULONG)BaseAddress))|3;  //Ring 3 callgate;<br /><br />       if(!VirtualLock((PVOID)Entry,seglen))<br />          {<br />             printf(&quot;Error VirtualLock:&quot;);<br />             PrintWin32Error(GetLastError());<br />             return 0;<br />          }<br /><br />       SetThreadPriority(GetCurrentThread(),THREAD_PRIORITY_TIME_CRITICAL);<br /><br />       Sleep(0);<br /><br />       _asm call fword ptr <br /><br />       SetThreadPriority(GetCurrentThread(),THREAD_PRIORITY_NORMAL);<br /><br />       VirtualUnlock((PVOID)Entry,seglen);<br /><br />       //Clear callgate<br />       *(ULONG *)cg=0;<br />       *((ULONG *)cg+1)=0;<br /><br />       ZwClose(hSection);<br />       return TRUE;<br /><br />    }</div>
    <div class="meta">Posted on 2003-09-28 02:08:54 by yangmin26</div>
   </div>
  </div>
 </body>
</html>