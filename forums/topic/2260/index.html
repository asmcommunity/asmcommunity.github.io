<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>GDI --&gt; DirectX - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=2260" />
    <link rel="next" href="../?id=2260&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=2260">GDI --&gt; DirectX</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=2260&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=2260&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="2260" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=2260&amp;page=2">&gt;</a><a href="../?id=2260&amp;page=2">&raquo;</a></form>   <div class="post" id="post-14280">
    <div class="subject"><a href="#post-14280">GDI --&gt; DirectX</a></div>
    <div class="body">hi,<br /><br />it's me again, with another problem. perhaps some of you already have seen my &quot;balls&quot;-program. anyways, i've a new problem with it. originally the program is a physical simulation. at the moment, it is just important that the balls (actually gas molecules) have a nearly constant pressure. but i've only 28 balls, and the pressure is NOT constant. so i decided to create about 60 layers. all the 60 layers have 28 balls in them, that are independent of the other layers. just the pressure is calculated together. i hope to get a constant pressure with it, it seems to work pretty well. but here is the problem: i only show the first layer, the first 28 balls. when i use 10 layers, the whole stuff goes very slow, and i want to have about 60 layers. it doesn't help to increase the velocities of the balls, they just cause errors in the calculation (too difficult to explain now.) <br /><br />so i let the GDI drawing operations out, and noticed that it goes about 75 times or more, faster!!!!! the drawing operation is pretty easy too. i have a procedure that gets x1, y1, x2, y2 coordinates (the balls are actually rectangle bitmaps), calculates the middle and does a BitBlt on a DC. that dc is then copied to the screen, on my window. then the whole dc is cleared, and the whole drawing starts again, with the new position of the balls. as you can see, pretty easy. now my question (finally :grin: ): would a directx window make the whole stuff much faster instead of using GDI? if yes, could somebody make the code for me? yeah, that sound very lame, but it would take too much time to get into the whole stuff, and i just need it for this program. that means: creating a directx window, &quot;painting&quot; bitmaps on the screen at x,y coordinates. that's all.<br /><br />i would really appreciate any help. i attached the program, too. the main part is &quot;testkug.asm&quot; for the balls moving and drawing procedure, and &quot;window.inc&quot; for creating the window. <br /><br />please help me!</div>
    <div class="meta">Posted on 2001-12-07 14:54:04 by NOP-erator</div>
   </div>
   <div class="post" id="post-14285">
    <div class="subject"><a href="#post-14285">its pretty easy</a></div>
    <div class="body">If you place the balls surface in video memory, you will sure get big speed increase with DirectDraw. (100-200fps)<br /><br /> Just do not try to read from video memory ... this is extra slow<br /><br />Asking for somebody else to write your code is lame indeed... after all this is a very simple task:<br /><br />1.setup directx full screen, exclusive<br />2.load bitmaps into video surfaces<br /><br />for very frame:<br />3.do your calculations and update bitmap positions<br />4.blit bitmaps into back buffer<br />5.flip primary/back buffers<br />go to 3<br /><br />But its also naive to belive the GFX in your program will be the fast part :) ... esp if you have many GFX to do ... still i guess it depends on what you do in the non GFX part of the app :P<br /><br />PS.<br />there is some source code just for this (simple blitting and flipping)called &quot;asm flips&quot; on Iczelion's site ...</div>
    <div class="meta">Posted on 2001-12-07 17:11:58 by BogdanOntanu</div>
   </div>
   <div class="post" id="post-14350">
    <div class="subject"><a href="#post-14350">ok, ok</a></div>
    <div class="body">hi,<br /><br />i really hoped that you answer my question Bogdan. Thanks for your reply. I didn't find the example code on Iczelion's site, but somewhere else. I couldn't compile it, and downloaded some other DD sources. I now managed it to build a DD window and tried to implement the &quot;Update&quot; procedure of &quot;ASM FLIPS&quot;. My program crashes, and I don't know why. There is my &quot;update&quot; procedure at the bottom. <br />OK, after i will have managed that problem, could you tell me, how i can get a bitmap into the back surface? and how do i specify the coordinates where the balls should be pastet in? btw: where can i get a documentation from, about the DirectDraw &quot;APIs&quot;?<br /><br /><pre><code><br />Update proc uses edi esi ebx edx <br />      ;invoke GetFrameRate<br />      mov ddbltfx.dwSize, sizeof ddbltfx <br />	mov ddbltfx.dwFillColor,0FFFFFFh<br />      DDSINVOKE Blt,lpDDSBack,0,0,0,DDBLT_COLORFILL + DDBLT_WAIT,addr ddbltfx<br />      .IF eax!= DD_OK<br />            FATAL &quot;BLT &#40;Make the screen white&#41; failed!&quot;<br />      .ENDIF<br />      mov ddbltfx.dwFillColor,0<br />      DDSINVOKE Blt,lpDDSBack,addr rectsrc,0,0,DDBLT_COLORFILL + DDBLT_WAIT,addr ddbltfx<br />      .IF eax!= DD_OK<br />            FATAL &quot;BLT &#40;Paint rectangle&#41; failed!&quot;<br />      .ENDIF<br />      DDSINVOKE Flip,lpDDSPrimary,0,DDFLIP_WAIT<br />      .IF eax!= DD_OK<br />            FATAL &quot;Flipping the buffers failed!&quot;<br />      .ENDIF<br /><br />      ret<br />Update endp<br /></code></pre><br /><br />bye</div>
    <div class="meta">Posted on 2001-12-08 10:55:38 by NOP-erator</div>
   </div>
   <div class="post" id="post-14358">
    <div class="subject"><a href="#post-14358">GDI --&gt; DirectX</a></div>
    <div class="body">here is an windowed example with your kugel1.bmp :<br /><br />it use offscreen buffer (not backbuffer+flip method) , it doesnt process any error conditions.<br /><br />and i'm not sure if buffers created in video memory or not, try including DDSCAPS_VIDEOMEMORY flag in ddsd structure</div>
    <div class="meta">Posted on 2001-12-08 14:48:19 by kamilh</div>
   </div>
   <div class="post" id="post-14360">
    <div class="subject"><a href="#post-14360">I'm confused....</a></div>
    <div class="body">Hi,<br /><br />thanks kamilh for your effort, but your program confused me. the way you call the DirectX APIs is another than I am using. This for example is my DirectDraw init part:<br /><br /><pre><code><br />INVOKE	DirectDrawCreate, NULL, ADDR lpDD, NULL<br />    .IF eax != DD_OK<br />		FATAL &quot;Couldn't init DirectDraw&quot;<br />    .ENDIF<br />    DDINVOKE SetCooperativeLevel, lpDD, hWnd, DDSCL_EXCLUSIVE or DDSCL_FULLSCREEN<br />    .IF eax != DD_OK<br />		FATAL &quot;Couldn't set DirectDraw cooperative level&quot;<br />   .ENDIF<br />   DDINVOKE	SetDisplayMode, lpDD, 640, 480, 16<br />   .IF eax != DD_OK<br />		FATAL &quot;Couldn't set display mode&quot;<br />   .ENDIF<br />   mov		&#91;ddsd.dwSize&#93;, sizeof ddsd<br />   mov		&#91;ddsd.dwFlags&#93;, DDSD_CAPS + DDSD_BACKBUFFERCOUNT<br />   mov		&#91;ddsd.ddsCaps.dwCaps&#93;, 	DDSCAPS_PRIMARYSURFACE OR\<br />    								 	DDSCAPS_FLIP OR\<br />    								  	DDSCAPS_COMPLEX OR\<br />    								  	DDSCAPS_VIDEOMEMORY<br />   mov ddsd.dwBackBufferCount, 1<br />   DDINVOKE	CreateSurface, lpDD, ADDR ddsd, ADDR lpDDSPrimary, NULL<br />   .IF eax != DD_OK<br />		FATAL &quot;Couldn't create primary surface&quot;<br />   .ENDIF<br />   mov &#91;ddscaps.dwCaps&#93;,DDSCAPS_BACKBUFFER<br />   DDSINVOKE GetAttachedSurface,lpDDSPrimary,addr ddscaps,addr lpDDSBack<br />   .IF eax!= DD_OK<br />            FATAL &quot;GetAttachedSurface failed!&quot;<br />   .ENDIF<br /></code></pre><br /><br />I don't think that the two methods are compatible. which one is better, or doesn't it matter? I attached my new code, with the DirectDraw Window. There is &quot;update&quot; proc in &quot;window.inc&quot;. The program crashes, and it seems to be because of the &quot;Blt&quot;. It would be very nice, if someone of you could show me how to Blt a bitmap on the screen with my method (just if it doesn't matter which i use). It would be too much work to change the whole stuff. <br />BTW: @kamilh: you told me that you don't flip the buffers. hmm, you know, i never did anything with direct draw, i don't understand the difference between what you have done, and between this &quot;flipping&quot;. is the template you created good for animation without flickering? that means, painting the balls, &quot;deleting&quot; the whole screen, and painting them at the new positions. <br /><br />i would appreciate an answer. thanks in advance....<br /><br />Noppy</div>
    <div class="meta">Posted on 2001-12-08 15:14:09 by NOP-erator</div>
   </div>
   <div class="post" id="post-14376">
    <div class="subject"><a href="#post-14376">GDI --&gt; DirectX</a></div>
    <div class="body">the probleme with your testdcc.exe is :<br /><br />update proc is called before ddinit proc so lpDDSBack variable is null at the first call, i did not checked when you first update&amp;init ddraw but changing update proc like :<br /><br />.if lpDDSBack        ; check backbuffer pointer is valid or not?<br />invoke Update<br />endif<br /><br />may solve the probleme..<br /><br />DDINVOKE &amp; mcall are to different macros (maybe samething with different name, i'm not sure), it doesnt matter which one your are using.<br /><br />in my example backbuffer is an offscreen surface, (constant width &amp; height), it is scaled to window (part of primary surface) size when you blt.. with backbuffer/flip you have variable size surface (not in your case, exclusive fullscr mode).<br />i dont know which one is better for your special purpose.<br />flip method is faster but both methods prevents flickering. (you delete offscreen surface not visible surface before update)</div>
    <div class="meta">Posted on 2001-12-08 21:41:37 by kamilh</div>
   </div>
   <div class="post" id="post-14398">
    <div class="subject"><a href="#post-14398">ay</a></div>
    <div class="body">@kamilh:<br /><br />i decided to build in your method in my program, but: when i try to compile it, i get an &quot;Unresolved external symbol _DirectDrawCreateEx@16&quot; error, even when i try to compile your program.....<br /><br />and something else: i begin to understand the system behind directdraw. but first: where can i get a documentation about the directdraw apis, and second: could you explain me, what this &quot;Clipper&quot; is, please?<br /><br />thanks,<br />    noppy</div>
    <div class="meta">Posted on 2001-12-09 05:00:59 by NOP-erator</div>
   </div>
   <div class="post" id="post-14418">
    <div class="subject"><a href="#post-14418">GDI --&gt; DirectX</a></div>
    <div class="body">nop-erator ;<br /><br />directdrawcreateex is used to create ddraw7 object, you need directx7 lib files to compile my project.<br /><br /> copy this lib file to masm32\lib library, it's from directx7 sdk, or better download directx sdk from microsoft (it has directx help files too.)<br />but new directx8 sdk doesnt have ddraw related hep files, you have to find directx7 sdk help files.<br /><br />clipper prevents writing outside of your window (when using windowed DDSCL_NORMAL mode, primary surface holds entire desktop, not only your window region)</div>
    <div class="meta">Posted on 2001-12-09 11:02:38 by kamilh</div>
   </div>
   <div class="post" id="post-14419">
    <div class="subject"><a href="#post-14419">ok, thanks</a></div>
    <div class="body">thanks, but one question left: wouldn't it be better to start with directx8? i read somewhere, that they removed that directdraw/direct3d stuff, and combined the two. will i get problems when i use directx7 stuff in the future?<br /><br />noppy</div>
    <div class="meta">Posted on 2001-12-09 11:07:40 by NOP-erator</div>
   </div>
   <div class="post" id="post-14421">
    <div class="subject"><a href="#post-14421">GDI --&gt; DirectX</a></div>
    <div class="body">You will not get problems. When you use DirectX, you query for an<br />interface version, say DX7, and you'll get it. So newer versions of<br />DX basically contain all the old versions, and the new one..</div>
    <div class="meta">Posted on 2001-12-09 11:28:00 by f0dder</div>
   </div>
   <div class="post" id="post-14514">
    <div class="subject"><a href="#post-14514">yeeehaaa!</a></div>
    <div class="body">hi,<br /><br />thanks to you all! i finally managed it to port the program graphics from GDI to DirectDraw. but there are still some questions and problems left.<br /><br />1) it seems, that the program runs with the same speed. the balls don't move faster, although they should, because of the faster painting. but there is one thing that goes faster: when you press &quot;p&quot; or &quot;m&quot;, you can force the program to show the next/previous layer. with the old version i took sometimes 4-5 seconds (obviously depending where the loop was), with the new version, it goes directly, without any delay. so, something goes faster, but why not the balls? <br /><br />2) when you look at the balls, you probably notice, that they have a black corner (because it's a rectangular bitmap). how would i create sprites? how to do that? especially with this direct draw stuff. <br /><br />3) i use InvalidateRect in the main message loop that causes a WM_PAINT message. there i call my &quot;kugproc&quot; (the procedure that calculates the balls coordinates). but when i call &quot;kugproc&quot; directly from the main message loop, the programs doesn't work (works, but very slowly, or doesn't work completely, graphic errors and stuff), i really don't know why. perhaps you can try out, and find out what's wrong? i attached one zip file with the working program, and there is also &quot;windowb.inc&quot;, that you have to rename to window.inc and compile then. this would be the bad version in this case then. <br /><br />thanks again for your help, it would be very cool, if i could solve the problems above, too, with your help. <br /><br />thank you, thank you, thank you.</div>
    <div class="meta">Posted on 2001-12-10 11:36:27 by NOP-erator</div>
   </div>
   <div class="post" id="post-14516">
    <div class="subject"><a href="#post-14516">GDI --&gt; DirectX</a></div>
    <div class="body">When in fullscreen. A DirectX application (or an openGL one for that matter), defaults to wait for the vertical retrace. (In windowed mode its default is not wait for retrace). So if you are getting 60Hz, 85hz or something like that thats possible the problem.<br /><br />Then again, its probably a good idea to wait for the vertical retrace, no streaks and 60Hz is better than having 300Hz and streaks on the display.<br /><br />If thats not the problem, it could be many things, including but not limited to:<br /><br />- Bitmaps not on video card memory<br />- Sincronization with card. (Try tripple buffering instead of double if you have enough ram).<br />- Use PeekMessage and then wait when there is no message to flip your pages.<br />- If in windowed mode, the video card you are using maybe does not support page flipping on windowed mode.<br /><br />etc, etc</div>
    <div class="meta">Posted on 2001-12-10 12:28:39 by dxantos</div>
   </div>
   <div class="post" id="post-14521">
    <div class="subject"><a href="#post-14521">hmmm</a></div>
    <div class="body">sorry dxantos,<br /><br />but i suppose that you even didn't look at my source, did you? for example, i don't flip anything! and i'm pretty sure, that my problems don't have anything to do with vertical retrace and stuff (If i'm wrong, then sorry). i'm sorry to say that, but that didn't help me actually.....<br /><br />bye,<br />noppy</div>
    <div class="meta">Posted on 2001-12-10 13:25:15 by NOP-erator</div>
   </div>
   <div class="post" id="post-14528">
    <div class="subject"><a href="#post-14528">GDI --&gt; DirectX</a></div>
    <div class="body">Sorry I didnt read the code before answering. I dindn't have time and just wanted to help anyway.<br /><br />Your loop is:<br /><pre><code><br />  StartLoop&#58;<br />      invoke GetMessage,ADDR msg,NULL,0,0<br />      cmp eax, 0<br />      je ExitLoop<br />      invoke TranslateMessage, ADDR msg<br />      invoke DispatchMessage,  ADDR msg<br />      <br />      ;|&gt; we call InvalidateRect to send a WM_PAINT message to our window and there is<br />      ;|&gt; called out animation loop. i tried to call the animation loop directly from here<br />      ;|&gt; but the program gets really slow, i don't know why<br />      invoke InvalidateRect,hWnd,addr updatescr,FALSE<br />      ;invoke kugproc,hWnd,hDC<br />      jmp StartLoop<br />    ExitLoop&#58;<br /></code></pre> <br /><br />You are using GetMessage, that is telling Windows to wait until there is a message. <br /><br />Instead try:<br /><br />1. Add a flag to tell if your app is active or not. <br /><pre><code><br />app_flag dd 0<br />APP_ACTIVE = 1<br /></code></pre><br /><br />2. Change the loop to this one:<br /><pre><code><br />StartLoop&#58;<br />    mov eax, app_flags<br />    test eax, APP_ACTIVE<br />    jz NonActive<br />	<br />    ;This is the loop called when the application is active<br />    ;PeekMessage will return inmediately.<br />    invoke PeekMessage, addr msg, NULL, 0, 0, PM_REMOVE<br />    and eax, eax<br />    jz IdleTime<br />    cmp &#91;msg.message&#93;, WM_QUIT<br />    je ExitLoop<br />    invoke TranslateMessage, ADDR msg<br />    invoke DispatchMessage,  ADDR msg<br />    jmp StartLoop<br /><br />IdleTime&#58;	<br />    ;This should be called ONLY when there is no windows msg available.<br />;Otherwise things will slow down.<br />    invoke kugproc,hWnd,hDC<br />    jmp StartLoop<br /><br />NonActive&#58;<br />    ; This area is executed when the application is not active, so it doent take all CPU cycles.<br />    ; GetMessage will WAIT UNTIL there is a message available<br />    invoke GetMessage,ADDR msg,NULL,0,0<br />    and eax, eax<br />    jz ExitLoop<br />    invoke TranslateMessage, ADDR msg<br />    invoke DispatchMessage,  ADDR msg<br />    jmp StartLoop<br />ExitLoop&#58;<br /></code></pre><br /><br />3. In the windows proc intersect the WM_ACTIVATE message. This is necesary because we dont wat to take too many CPU cycles when the app is not active.<br /><br /><pre><code><br />.elseif uMsg == WM_ACTIVATE<br />   .if wParam &amp; 0FFFFh<br />     or app_flag, APP_ACTIVE<br />   .else<br />     and app_flag,  NOT APP_ACTIVE<br />   .endif<br />    invoke DefWindowProc,hWin,uMsg,wParam,lParam<br />    ret<br /></code></pre><br /><br />I havent tested the code. (Have no time to do that). But it should work.</div>
    <div class="meta">Posted on 2001-12-10 14:22:13 by dxantos</div>
   </div>
   <div class="post" id="post-14531">
    <div class="subject"><a href="#post-14531">sprites</a></div>
    <div class="body">if you want to learn how to do sprites there's a great vb tutorial at <a target="_blank" href="http://www.vbexplorer.com/show.asp?id=188">http://www.vbexplorer.com/show.asp?id=188</a><br /><br />Basically you first draw a bitmask and then the graphic...</div>
    <div class="meta">Posted on 2001-12-10 14:46:15 by grv575</div>
   </div>
   <div class="post" id="post-14534">
    <div class="subject"><a href="#post-14534">thank you dxantos</a></div>
    <div class="body">thank you for your posting dxantos! i don't have time now too, to test the code, but i'll do it tomorrow evening (24h since this post). but it sound very sensible what you're telling......thanks!<br /><br />@grv575: i basically wanted to know how to &quot;draw&quot; the sprites with direct draw. is it the same stuff as with one ball, but just that i Blt the sprite bitmap over the other, or is there a special function?<br /><br />bye, and thanks again</div>
    <div class="meta">Posted on 2001-12-10 14:53:22 by NOP-erator</div>
   </div>
   <div class="post" id="post-14544">
    <div class="subject"><a href="#post-14544">GDI --&gt; DirectX</a></div>
    <div class="body">Yeah just use two DCs and two bitmaps.  Make a kugel2.bmp where the ball is black and the background white.  Then bitblt that onto the window first.  Then bitblt kugel1.bmp using SRCAND as the raster-operation code.  What happends is the black background gets anded with the mask bitmap's white background and it shows up clear.</div>
    <div class="meta">Posted on 2001-12-10 16:03:15 by grv575</div>
   </div>
   <div class="post" id="post-14553">
    <div class="subject"><a href="#post-14553">GDI --&gt; DirectX</a></div>
    <div class="body">nop erator<br /><br />replace line (inside putball proc)<br /><br />mcall ,IDirectDrawSurface7_Blt,addr rc,dds_bitmap,NULL,DDBLT_WAIT,addr ddbltfx<br /><br />with<br /><br />mcall ,IDirectDrawSurface7_Blt,addr rc,dds_bitmap,NULL,DDBLT_WAIT or DDBLT_KEYSRCOVERRIDE,addr ddbltfx<br /><br />it will set black as source surface (your bitmap) color key &amp; black pixels wont be drawn on screen.</div>
    <div class="meta">Posted on 2001-12-10 16:42:17 by kamilh</div>
   </div>
   <div class="post" id="post-14636">
    <div class="subject"><a href="#post-14636">ok</a></div>
    <div class="body">hi,<br /><br />ok, everything works fine now. but changing the loop just helped me out not to use InvalidateRect, this is pretty cool. but the whole stuff doesn't go really faster (moving of the balls) than with GDI. i just can press the left mouse button and other keys on the keyboard and there happens something directly. with gdi (as i said), i had to wait a few seconds. but why isn'T the loop executed faster, still?<br /><br />bye</div>
    <div class="meta">Posted on 2001-12-11 12:52:19 by NOP-erator</div>
   </div>
   <div class="post" id="post-14657">
    <div class="subject"><a href="#post-14657">static window</a></div>
    <div class="body">hi,<br /><br />i just noticed another problem: the static box where the pressure of the gas is shown in, isn't displayed on the screen anymore. why? is it because of the direct x stuff? how can i put text on the window, and delete it again? <br /><br />thanks,<br /> nop</div>
    <div class="meta">Posted on 2001-12-11 15:49:46 by NOP-erator</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=2260&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=2260&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="2260" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=2260&amp;page=2">&gt;</a><a href="../?id=2260&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>