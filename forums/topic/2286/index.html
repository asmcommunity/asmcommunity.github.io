<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Replace substring in string? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=2286" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=2286">Replace substring in string?</a></p>
   <div class="post" id="post-14420">
    <div class="subject"><a href="#post-14420">Replace substring in string?</a></div>
    <div class="body">Hello everyone,<br />I tried to write a function to replace all occurences of a substring in a string by other substring, but it didn't work. It crashes my system and I have to reboot.<br />==================================<br /><br />ReplaceString proc Phrase:DWORD,SourceWord:DWORD,ReplaceWord:DWORD<br />LOCAL PosSW:DWORD<br />LOCAL LenSW:DWORD<br />LOCAL LenRW:DWORD<br />LOCAL Phrase2:DWORD<br />LOCAL tmpstr1:DWORD<br />LOCAL tmpstr2:DWORD<br />LOCAL LenPhrase:DWORD<br /><br />invoke lstrcpy, Phrase2, Phrase<br />invoke lstrlen, SourceWord<br />mov LenSW, eax<br />invoke InString, 1, Phrase2, SourceWord<br />mov PosSW, eax<br />.WHILE PosSW&gt;0<br /> sub PosSW, 1<br /> invoke szLeft, Phrase2, tmpstr1, PosSW<br /> mov ecx, LenSW<br /> add PosSW, ecx<br /> add PosSW, 1<br /> invoke lstrlen, Phrase2<br /> sub eax, PosSW<br /> mov LenPhrase, eax<br /> invoke szRight, Phrase2, tmpstr2, LenPhrase<br /> invoke szMultiCat, 3, Phrase2, tmpstr1, ReplaceWord, tmpstr2<br /> invoke InString, 1, Phrase2, SourceWord<br /> mov PosSW, eax<br />.ENDW<br />invoke lstrcpy, eax, Phrase2<br />ReplaceString endp<br /><br />======================================<br />What I've done wrong?<br />Can anyone help me?<br />Does anyone have a function that does this?<br />Thanks in advance. Sorry for my bad english.</div>
    <div class="meta">Posted on 2001-12-09 11:27:26 by dilau</div>
   </div>
   <div class="post" id="post-14438">
    <div class="subject"><a href="#post-14438">Replace substring in string?</a></div>
    <div class="body">Where you can get into trouble is if the total length with the replacements is longer than the original buffer. One or more replacement will make the written data longer than the data that is read and you will over run the original buffer.<br /><br />The replacement algo is not that complicated, just scan for the bytes you wish to replace, write the replacement at that offset, calculate the length of the original from the source and move that far along the data to write the next byte.<br /><br />What you need is some form of memory allocation strategy so that the buffer length is never exceeded.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2001-12-09 15:59:29 by hutch--</div>
   </div>
   <div class="post" id="post-14510">
    <div class="subject"><a href="#post-14510">I did it! =))))</a></div>
    <div class="body">Thanks, hutch! =)<br />I realized that I was doing the wrong way. I decided to learn to do this without using already made functions like InString, szMid, etc. I was doing it like I've done in Delphi. I think now I am really learning Assembly. I spent the whole day reading tutorial about working with string in asm.<br />I wanna thank you hutch (You wrote asmintro.hlp that comes with the Masm32v7 package, right? The topic &quot;Working with Strings&quot; really helped me a lot.) and  (I am posting his string tutorial in attachment).<br />And here is my function:<br />==================================<br /><br />ReplaceString proc StrSource:DWORD,StrDest:DWORD,SubStrSource:DWORD,SubStrDest:DWORD<br />LOCAL esi1:DWORD<br />LOCAL lensubstr:DWORD<br />push esi<br />push edi<br />push ebx<br />push edx<br /><br />invoke lstrlen, SubStrSource<br />sub eax, 1<br />mov lensubstr, eax<br /><br />cld<br />mov esi, StrSource<br />mov edi, StrDest<br />mov ebx, SubStrSource<br />mov edx, SubStrDest<br /><br />compare:<br />mov al, <br />inc esi<br />mov ah, <br />cmp al, ah<br />je compare2<br />comparesub:<br />cmp al, 0<br />je theend<br />mov , al<br />inc edi<br />jmp compare<br /><br />compare2:<br />mov esi1, esi<br />dec esi<br />loopc2:<br />mov ah, <br />inc ebx<br />mov cl, <br />inc esi<br />cmp ah, 0<br />je found<br />cmp ah, cl<br />jne backtocompare<br /><br />found:<br />mov esi, esi1<br />add esi, lensubstr<br />mov ebx, SubStrSource<br />copynewstr:<br />mov ah, <br />inc edx<br />cmp ah, 0<br />je foundend<br />mov , ah<br />inc edi<br />jmp copynewstr<br />foundend:<br />mov edx, SubStrDest<br />jmp compare<br /><br />backtocompare:<br />mov esi, esi1<br />mov ebx, SubStrSource<br />jmp comparesub<br /><br />theend:<br />mov StrSource, edi<br />pop edx<br />pop ebx<br />pop edi<br />pop esi<br />ret<br />ReplaceString endp<br /><br />==================================<br />What do you think, hutch?<br />Does anyone have any suggestions to improve my code?</div>
    <div class="meta">Posted on 2001-12-10 11:00:51 by dilau</div>
   </div>
   <div class="post" id="post-14546">
    <div class="subject"><a href="#post-14546">My first bug! =/</a></div>
    <div class="body">I found a bug in my code... I forget one line:<br />jmp loopc2<br />Right after:<br />jne backtocompare<br /><br />Now I have other problem, how can I replace a substring in a string without having to having a destination buffer?<br />I have to do several replacements in a string.<br /><br />Here is the code again:<br />=========================<br />ReplaceString proc StrSource:DWORD,StrDest:DWORD,SubStrSource:DWORD,SubStrDest:DWORD<br />LOCAL esi1:DWORD<br />LOCAL lensubstr:DWORD<br />push esi<br />push edi<br />push ebx<br />push edx<br /><br />invoke lstrlen, SubStrSource<br />sub eax, 1<br />mov lensubstr, eax<br /><br />cld<br />mov esi, StrSource<br />mov edi, StrDest<br />mov ebx, SubStrSource<br />mov edx, SubStrDest<br /><br />compare:<br />mov al, <br />inc esi<br />mov ah, <br />cmp al, ah<br />je compare2<br />comparesub:<br />cmp al, 0<br />je theend<br />mov , al<br />inc edi<br />jmp compare<br /><br />compare2:<br />mov esi1, esi<br />dec esi<br />loopc2:<br />mov ah, <br />inc ebx<br />mov cl, <br />inc esi<br />cmp ah, 0<br />je found<br />cmp ah, cl<br />jne backtocompare<br />jmp loopc2<br /><br />found:<br />mov esi, esi1<br />add esi, lensubstr<br />mov ebx, SubStrSource<br />copynewstr:<br />mov ah, <br />inc edx<br />cmp ah, 0<br />je foundend<br />mov , ah<br />inc edi<br />jmp copynewstr<br />foundend:<br />mov edx, SubStrDest<br />jmp compare<br /><br />backtocompare:<br />mov esi, esi1<br />mov ebx, SubStrSource<br />jmp comparesub<br /><br />theend:<br />mov StrSource, edi<br />pop edx<br />pop ebx<br />pop edi<br />pop esi<br />ret<br />ReplaceString endp</div>
    <div class="meta">Posted on 2001-12-10 16:14:40 by dilau</div>
   </div>
   <div class="post" id="post-14548">
    <div class="subject"><a href="#post-14548">My second bug! =//</a></div>
    <div class="body">I found another bug! I forget to put the 0 at the end of the destination string.<br />I hope it is my last bug. <br />Here is the correction:<br />=============================<br />ReplaceString proc StrSource:DWORD,StrDest:DWORD,SubStrSource:DWORD,SubStrDest:DWORD<br />LOCAL esi1:DWORD<br />LOCAL lensubstr:DWORD<br />push esi<br />push edi<br />push ebx<br />push edx<br /><br />invoke lstrlen, SubStrSource<br />sub eax, 1<br />mov lensubstr, eax<br /><br />cld<br />mov esi, StrSource<br />mov edi, StrDest<br />mov ebx, SubStrSource<br />mov edx, SubStrDest<br /><br />compare:<br />mov al, <br />inc esi<br />mov ah, <br />cmp al, ah<br />je compare2<br />comparesub:<br />mov , al<br />cmp al, 0<br />je theend<br />inc edi<br />jmp compare<br /><br />compare2:<br />mov esi1, esi<br />dec esi<br />loopc2:<br />mov ah, <br />inc ebx<br />mov cl, <br />inc esi<br />cmp ah, 0<br />je found<br />cmp ah, cl<br />jne backtocompare<br />jmp loopc2<br /><br />found:<br />mov esi, esi1<br />add esi, lensubstr<br />mov ebx, SubStrSource<br />copynewstr:<br />mov ah, <br />inc edx<br />cmp ah, 0<br />je foundend<br />mov , ah<br />inc edi<br />jmp copynewstr<br />foundend:<br />mov edx, SubStrDest<br />jmp compare<br /><br />backtocompare:<br />mov esi, esi1<br />mov ebx, SubStrSource<br />jmp comparesub<br /><br />theend:<br />mov StrSource, edi<br />pop edx<br />pop ebx<br />pop edi<br />pop esi<br />ret<br />ReplaceString endp</div>
    <div class="meta">Posted on 2001-12-10 16:24:16 by dilau</div>
   </div>
  </div>
 </body>
</html>