<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>really weird problem - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=1310" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=1310">really weird problem</a></p>
   <div class="post" id="post-8451">
    <div class="subject"><a href="#post-8451">really weird problem</a></div>
    <div class="body">I have a program that emmediatly starts a thread created in response to WM_Create for an animation. What is really strange is that sometimes the windows does exactly what i want it to. And then when i close and launch the window again peices of my window in the client are are missing. Now i thought that once a window is assembled it should act the same way everytime. Any body ever run into this? I'm beginning to think the CIA is fucking with me.  <br /><br />P.S.<br /><br />Whats even stranger is when i recompile the code without changing any of the code i can get different results again.<br /><br />I'm really getting pissed.<br /><br />Anybody having experienced this  &quot;phenomena&quot; i would respect your comments.<br /><br />The code i was fooling with when this all started is below and is contained in my thread. The program is not complex and niether is my code.<br /><br />invoke MoveToEx,hdc,XBOXS,29,NULL<br />invoke LineTo,hdc, XBOXE,29<br />invoke LineTo,hdc,XBOXE, 70           &lt;This makes a box<br />invoke LineTo,hdc,XBOXS,70<br />invoke LineTo,hdc,XBOXS,29<br /><br /><br /><br />mov X,30<br />mov Y,200<br />.while Y &lt; 500<br />.while X&lt;400<br />invoke SetPixel,hdc,X,Y,999h            &lt; this makes a square <br /> inc X<br /> .endw<br /> mov X,30<br /> inc Y<br /> .endw</div>
    <div class="meta">Posted on 2001-10-01 19:52:17 by titan</div>
   </div>
   <div class="post" id="post-8454">
    <div class="subject"><a href="#post-8454">really weird problem</a></div>
    <div class="body">First of all, use FillRect instead of the PutPixel solution :).<br /><br />When you say<br /><div class="quote"><br />when i close and launch the window again<br /></div><br />do you mean the program, or the window?<br /><br />Do you always remember to clean up? (Release/Delete the<br />HDC, stop the thread when closing the window, etc).<br /><br />Do you spawn multiple threads? Do your main thread and<br />the spawned thread share data?<br /><br />Try uploading the .asm file here :).</div>
    <div class="meta">Posted on 2001-10-01 21:09:22 by f0dder</div>
   </div>
   <div class="post" id="post-8455">
    <div class="subject"><a href="#post-8455">really weird problem</a></div>
    <div class="body">fodder my program does not need to release the DC because i use OWN_DC in the window creation.<br /><br />When i say i launch the program i mean i click on the icon<br /><br />I'm a newbie<br /><br />My prog has at most two threads<br /><br />That is the main window and my thread that is initialized with the response to WM_CREATE<br /><br />Here is the code<br /><br />Hope you can make sense of it<br /><br />The previose code i posted is in my thread.<br /><br /><br />A lot of stuff is bleaped out with the colon as i am always experimenting:<br />.586<br />.model flat,stdcall<br />OPTION SCOPED<br />option casemap:none<br /><br />WinMain proto :DWORD,:DWORD,:DWORD,:DWORD<br />SETGAME PROTO :DWORD<br />GETARRAYSIZE PROTO :DWORD<br />include  \masm32\include\windows.inc<br />include  \masm32\include\user32.inc<br />include  \masm32\include\kernel32.inc<br />include  \masm32\include\gdi32.inc<br />include  \masm32\include\winmm.inc<br /><br />includelib  \masm32\lib\user32.lib<br />includelib  \masm32\lib\kernel32.lib<br />includelib  \masm32\lib\gdi32.lib<br />includelib  \masm32\lib\winmm.lib<br /><br />include  d:\masm32\mystuff\gamedata.asm<br />include  d:\masm32\mystuff\gamedatani.asm<br />include  d:\masm32\mystuff\gameconst.asm<br />include  d:\masm32\mystuff\gamemacros.asm<br />include  d:\masm32\mystuff\gamethread.asm<br />include  d:\masm32\mystuff\gamestruct.asm<br />.code<br /> <br /><br /><br /><br />GETARRAYSIZE proc uses ebx sizeArray:DWORD<br />xor edx,edx<br />mov eax,sizeArray<br />mov ebx,4<br />div ebx<br />mov N,eax<br />sub N,1<br />xor eax,eax<br />ret <br />GETARRAYSIZE endp<br /><br />SETGAME proc uses ebx ecx lpArray:DWORD<br />XOR ECX,ECX<br /><br />   @@:<br /><br />mov EAX,lpArray<br />   MOV ebx,<br />   mov BMID,ebx<br />   inc ecx<br />   mov ebx,<br />   mov XPOS,ebx<br />   inc ecx<br />   mov ebx,<br />   mov YPOS,ebx<br />   push ecx<br />   GETDIM<br />   <br />   BLITMAP<br />   pop ecx<br />   CMP ecx,N<br />   inc ecx<br />   JB @B    <br /> xor eax,eax<br />    <br />ret 0 <br /><br />SETGAME endp<br /><br />Play Proc uses ebx<br />LOCAL lop:DWORD<br /><br />mov lop,0<br />.while lop&lt;3<br />mov eax, RAND32(36)<br />.IF ax &lt; 12<br />mov ebx,23<br />push ebx<br />.ELSEIF ax &gt;24<br />mov ebx,24<br />push ebx<br />.ELSE <br />mov ebx,25<br />push ebx<br />.ENDIF<br />inc lop<br />.endw<br /><br />XOR ECX,ECX<br /><br />   @@:<br />LEA EAX,play_array<br />   <br />   mov ebx,<br />   mov XPOS,ebx<br />   inc ecx<br />   mov ebx,<br />   mov YPOS,ebx<br />   pop BMID<br />   push ecx<br />   GETDIM<br />   BLITMAP<br />   pop ecx<br />   CMP ecx,N<br />   inc ecx<br />   JB @B<br /> <br />     <br /> xor eax,eax<br />    <br />ret 0<br /><br />Play ENDP<br /><br />start:<br />	invoke GetModuleHandle, NULL<br />	mov    hInstance,eax<br />	invoke GetCommandLine<br />	mov CommandLine,eax<br />	invoke WinMain, hInstance,NULL,CommandLine, SW_NORMAL<br />	invoke ExitProcess,eax<br />   <br /><br /><br />WinMain proc hInst:HINSTANCE,hPrevInst:HINSTANCE,CmdLine:LPSTR,CmdShow:DWORD<br />	LOCAL wc:WNDCLASSEX<br />	LOCAL msg:MSG<br />	LOCAL hwnd:HWND<br />	mov   wc.cbSize,SIZEOF WNDCLASSEX<br />	mov   wc.style, CS_BYTEALIGNCLIENT or CS_HREDRAW or CS_VREDRAW or CS_OWNDC<br />	mov   wc.lpfnWndProc, OFFSET WndProc<br />	mov   wc.cbClsExtra,NULL<br />	mov   wc.cbWndExtra,NULL<br />	push  hInst<br />	pop   wc.hInstance<br />	mov   wc.hbrBackground,COLOR_WINDOW+2<br />	mov   wc.lpszMenuName,OFFSET MenuName<br />	mov   wc.lpszClassName,OFFSET ClassName<br />	invoke LoadIcon,NULL,IDI_WINLOGO<br />	mov   wc.hIcon,eax<br />	;mov   wc.hIconSm,eax<br />	invoke LoadCursor,hInstance,IDC_1<br />	mov   wc.hCursor,eax<br />	invoke RegisterClassEx, addr wc<br /><br />       INVOKE CreateWindowEx,WS_EX_CONTEXTHELP,ADDR ClassName,ADDR AppName,\<br />       WS_CAPTION or WS_SYSMENU,CW_USEDEFAULT,\     <br />       CW_USEDEFAULT,CW_USEDEFAULT,CW_USEDEFAULT,NULL,\<br />       NULL,hInst,NULL<br />       <br />	<br />	mov   hwnd,eax<br />	INVOKE ShowWindow, hwnd,SW_SHOWMAXIMIZED <br />	INVOKE UpdateWindow, hwnd<br />        <br />	.WHILE TRUE<br />                INVOKE GetMessage, ADDR msg,NULL,0,0<br />                .BREAK .IF (!eax)<br /><br />                INVOKE DispatchMessage, ADDR msg<br /><br />	.ENDW<br />	<br />mov     eax,msg.wParam<br />	ret     ;&lt; IS THIS RIGHT?<br />WinMain endp<br />WndProc proc hWnd:HWND, uMsg:UINT, wParam:WPARAM, lParam:LPARAM<br />LOCAL ps:PAINTSTRUCT<br />      <br /><br />	.IF uMsg==WM_DESTROY<br />  	invoke PostQuitMessage,NULL<br />  <br />    .ELSEIF uMsg==WM_CREATE<br />   <br /> invoke GetDC,hWnd<br /> mov hdc,eax<br /> invoke SetICMMode,hdc,ICM_ON<br />invoke CreateCompatibleDC,NULL<br />mov cdc,eax<br />invoke SetICMMode,cdc,ICM_ON<br />;invoke GetClientRect,hWnd,ADDR rect<br /> <br />mov  eax,OFFSET ThreadProc <br />                invoke CreateThread,NULL,NULL,eax,\ <br />                                        hWnd,0,\ <br />                                        ADDR ThreadID <br />mov Threadh,eax<br />               <br /><br /><br /><br />.ELSEIF uMsg==WM_TIMER<br /> <br />;invoke MessageBox,hWnd,ADDR Hello_string,OFFSET AppName,MB_OK or MB_APPLMODAL or MB_HELP or MB_ICONQUESTION	<br />;.ELSEIF uMsg==BN_PUSHED<br />            ;invoke Beep,NULL,NULL<br /><br />.ELSEIF uMsg==WM_COMMAND<br />	mov eax,wParam<br />     <br />      <br />		.IF ax==IDM_NEW<br />invoke SuspendThread,Threadh<br />invoke CloseHandle,Threadh<br /><br />invoke GETARRAYSIZE, sizeof my_array<br />invoke SETGAME,addr my_array<br />invoke PlaySound,IDW_2,hInstance,SND_RESOURCE<br />   	invoke CreateWindowEx,NULL, ADDR ButtonClassName,ADDR ButtonText,\<br />                        WS_CHILD or WS_VISIBLE or BS_PUSHBUTTON or BS_BITMAP or BS_NOTIFY,\<br />                        80,110,124,40,hWnd,ButtonID,hInstance,NULL<br /> mov  hwndButton,eax<br />invoke LoadBitmap,hInstance,30 <br />mov hBitBtnBmp,eax <br />invoke PostMessage,hwndButton,BM_SETIMAGE,IMAGE_BITMAP,hBitBtnBmp <br /><br /><br />            .ELSEIF wParam==ButtonID<br />            invoke PlaySound,IDW_1,hInstance,SND_RESOURCE<br />            invoke GETARRAYSIZE, sizeof play_array<br />            call Play<br />            invoke GETARRAYSIZE, sizeof cash_array<br />            invoke SETGAME,addr cash_array<br />           <br />           <br />		.ELSEIF ax==IDM_OPEN<br />            invoke MessageBox,NULL,ADDR Goodbye_string,OFFSET AppName,MB_OK<br /><br />	      <br />EnableMenuItem,hMenu,IDM_SCROLL,MF_BYCOMMAND or MF_GRAYED<br />            <br />            ;invoke EnableMenuItem,hMenu,IDM_STOPSCROLL,MF_BYCOMMAND or MF_ENABLED<br />            ;invoke CloseHandle,hMenu<br />            <br />            <br />            .ELSEIF ax==IDM_SAVE<br />            invoke MessageBox,hWnd,ADDR Hello_string,OFFSET AppName,MB_OK or MB_APPLMODAL or MB_HELP or MB_ICONQUESTION	<br /><br />         	.ELSEIF ax==IDM_EXIT<br />			invoke DestroyWindow,hWnd<br />             <br />             <br />            <br />            .ENDIF<br />            .ELSE<br />            invoke DefWindowProc,hWnd,uMsg,wParam,lParam<br />            <br />		ret<br />		<br /><br />.ENDIF<br /><br /><br />	xor    eax,eax<br />	ret           <br /><br />WndProc endp<br />    <br /><br />end start</div>
    <div class="meta">Posted on 2001-10-01 21:32:59 by titan</div>
   </div>
  </div>
 </body>
</html>