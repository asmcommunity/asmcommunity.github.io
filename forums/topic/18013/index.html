<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>ExcelHost problem - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=18013" />
    <link rel="next" href="../?id=18013&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=116">Windows</a> &raquo; <a href="../?id=18013">ExcelHost problem</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=18013&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=18013&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="18013" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=18013&amp;page=2">&gt;</a><a href="../?id=18013&amp;page=2">&raquo;</a></form>   <div class="post" id="post-139089">
    <div class="subject"><a href="#post-139089">ExcelHost problem</a></div>
    <div class="body">Hi,<br /><br />I am trying to learn how com is working. I can't understand which condition telling if the SDWORD should be or not. For example Get/Put ActivePrinter and Caption have no parameters and a &quot;return value&quot; BSTR. But why is SDWORD present in case of ActivePrinter but not in case of Caption? I have not found any pattern. And what value should SDWORD have (0?)?<br /><br />VB code<br /><br />Dim EXC As Excel.Application<br />Dim x as String<br />Set EXC = CreateObject(&quot;Excel.Application&quot;)<br /><br />x = EXC.ActivePrinter<br />EXC.ActivePrinter = &quot;printer&quot;<br /><br />corresponds to assembler<br /><br />STDMETHOD	get_ActivePrinter	, :SDWORD,:ptr BSTR<br />STDMETHOD	put_ActivePrinter	, :SDWORD,:BSTR<br /><br />and VB code<br /><br />x = EXC.Caption<br />EXC.Caption = &quot;caption&quot;<br /><br />corresponds to assembler<br /><br />STDMETHOD	get_Caption	, :ptr BSTR<br />STDMETHOD	put_Caption	, :BSTR<br /><br />The VB code for caption and activeprinter are build-up on the same manner, but not assembler code. I would be very grateful if somebody could explain this to me.<br /><br />Best regards</div>
    <div class="meta">Posted on 2004-04-15 17:15:47 by minor28</div>
   </div>
   <div class="post" id="post-139109">
    <div class="subject"><a href="#post-139109">ExcelHost problem</a></div>
    <div class="body">If i remember correctly this is the LCID parameter.  Its a 'hidden' parameter that is used by VB/C++ and other HLLs to describle the OS language.  For english i believe the value is 1033, however 0 seems to work as well.<br /><br />Looking at ComView, its setup to pass 800h in... (in the Options.General tab).<br /><br />Hope this helps.<br />Regards,<br />:NaN:</div>
    <div class="meta">Posted on 2004-04-15 22:50:58 by NaN</div>
   </div>
   <div class="post" id="post-139118">
    <div class="subject"><a href="#post-139118">ExcelHost problem</a></div>
    <div class="body">Hi minor28,<br /><br />the  attribute - for parameters - is described in MIDL language reference.<br />it is always the last parameter, with the exception of a  parameter.<br /><br />Japheth</div>
    <div class="meta">Posted on 2004-04-16 02:33:26 by japheth</div>
   </div>
   <div class="post" id="post-139207">
    <div class="subject"><a href="#post-139207">ExcelHost problem</a></div>
    <div class="body">Thanks NAN and japheth.<br /><br />Ok I understand &quot;what&quot; but not &quot;how&quot;. The reason for asking is that the ComView and includefiles is somewhat hard to apply to practise with my limited knowledge, though the function is working fine.<br /><br />My idea is to create include files to each Asm project with only parts necessary to the project. I am working with RadAsm which gives the possibility to help information as tooltips. To achieve this I am creating a RadAsm tool. With the tool I create the include files (in Excel example) ExcelC.inc with constants, ExcelF.inc with functions (as struct with dd ? pointers). According to the need I can add functions and constants to the include files.<br /><br />Clicking on an item in column 2 opens a dialog with editable asm code to paste into the project. Now I am working with the function parameters which is the reason for my question on the hidden LCID parameter.<br /><br />I have not found any method to identify which function has the LCID parameter. I attach the tool (it is written in VB6.0) and would be glad to hear your comments.<br /><br />Best regard</div>
    <div class="meta">Posted on 2004-04-17 04:37:44 by minor28</div>
   </div>
   <div class="post" id="post-139227">
    <div class="subject"><a href="#post-139227">ExcelHost problem</a></div>
    <div class="body">Hi minor28,<br /><br />finding functions with lcid parameter requires in fact some thorough understanding of IDispatch and automation, so I wont describe it here.<br /><br />But I'm able to tell how to navigate with comview to find such infos<br /><br />An example:<br /><br />1. open the excel type library.<br />2. get dispatch interface _Workbook<br />3. select tab &quot;interfaces&quot;<br />4. dblclick the _Workbook entry (will open another typeinfo dialog)<br />5. now property &quot;Author&quot; for example has the lcid parameter<br /><br />what makes this stuff so complicated is that for dual interfaces there exist in fact 2 typeinfos,<br />one describes the dispatchable part, the other describes the vtable part. Only the &quot;vtable&quot; typeinfo<br />will have &quot;lcid&quot; and &quot;retval&quot; parameters, all functions in such typeinfos return a HRESULT and it is this<br />typeinfo that is used by comview to generate include files.<br /><br />Japheth</div>
    <div class="meta">Posted on 2004-04-17 09:57:59 by japheth</div>
   </div>
   <div class="post" id="post-139459">
    <div class="subject"><a href="#post-139459">ExcelHost problem</a></div>
    <div class="body">Thanks japheth for your hints,<br /><br />I have dug a little deeper and now I know how to find out if an object has a lcid parameter.<br /><br />Regards</div>
    <div class="meta">Posted on 2004-04-19 10:58:44 by minor28</div>
   </div>
   <div class="post" id="post-139497">
    <div class="subject"><a href="#post-139497">ExcelHost problem</a></div>
    <div class="body">Interesting tool there... I hope you share it when your finished.  :alright:<br /><br /><br />Regards,<br />:NaN:</div>
    <div class="meta">Posted on 2004-04-19 17:12:35 by NaN</div>
   </div>
   <div class="post" id="post-139561">
    <div class="subject"><a href="#post-139561">ExcelHost problem</a></div>
    <div class="body">Hi<br /><br />yes, I will share it but the tool is VB. Perhaps I will convert it to asm later. Having the tool it shouldn't be to difficult i hope.<br /><br />Some Excel functions have a lot of parameters, up to 30. Most of them are optional. In normally VB coding you can disregard these parameters but not in assembler. To handle all these parameters I need some macro writing. In fact I don't like macros but I think it is nessesary here. I have succeeded to write a macro pushing all what needs for a disregarded optional parameter (NoParam). <br /><br />Could sombody help me with macro &quot;Params&quot;. The following example shows how I intend to generate code to open an existing workbook.<pre><code>mov eax,pWorkbooks<br />mov edx,&#91;eax&#93;<br />push offset pWorkbook<br />push 0<br />;Params&#40; Filename, &#91;UpdateLinks&#93;, &#91;ReadOnly&#93;, &#91;Format&#93;, &#91;Password&#93;, &#91;WriteResPassword&#93;, &#91;IgnoreReadOnlyRecommended&#93;, &#91;Origin&#93;, &#91;Delimiter&#93;, &#91;Editable&#93;, &#91;Notify&#93;, &#91;Converter&#93;, &#91;AddToMru&#93;&#41;<br />Params&#40; &#58;VT_BSTR, NoParam, NoParam, NoParam, NoParam, NoParam, NoParam, NoParam, NoParam, NoParam, NoParam, NoParam, NoParam&#41;<br />push pWorkbooks<br />call dword ptr &#91;edx&#93;.Workbooks._Open</code></pre><br />As you can see there are 13 parameters excluding lcid parameter and return paramet. The commented line will also be generated to simplify recognization.<br /><br />How do I write a macro to handle the parameters in reverse order. All is about pushing a lot stuff on the stack. I would be grateful.<br /><br />Attached is the previous Com.exe and a Com.mdb. The database will hold code snippets and macros.<br /><br />Best regards</div>
    <div class="meta">Posted on 2004-04-20 10:04:09 by minor28</div>
   </div>
   <div class="post" id="post-139577">
    <div class="subject"><a href="#post-139577">ExcelHost problem</a></div>
    <div class="body">I didnt test this, but this should work:<br /><br /><pre><code>DUMB_TEST MACRO FileName, args&#58;VARARG<br />    IFNB &lt;args&gt;<br />    pargs CATSTR &lt;!&lt;&gt;, &lt;args&gt;, &lt;!&gt;&gt;<br />    %FOR arg, @ArgRev&#40;pargs&#41;<br />        push arg<br />    ENDM<br />    call    FileName<br />ENDM<br /><br /></code></pre><br /><br />Regards,<br />:NaN:</div>
    <div class="meta">Posted on 2004-04-20 11:32:34 by NaN</div>
   </div>
   <div class="post" id="post-139587">
    <div class="subject"><a href="#post-139587">ExcelHost problem</a></div>
    <div class="body">Thanks NAN,<br /><br />But I suppose I didn't make it clear. Params is the macro that I can't write and the arguments list is the function parameters. The function parameters can vary from function to function both in amount and type. In this example FileName is a pointer to the workbook to open. The rest of the parameters are VARIANTs. NoParam is a macro I have written.<pre><code>NoParam macro<br />	LOCAL var<br />	.data<br />	var VARIANT &lt;&gt;<br />	.code<br />	mov var.vt,VT_ERROR<br />	mov var.scode,DISP_E_PARAMNOTFOUND<br />	push dword ptr &#91;var+0ch&#93;<br />	push dword ptr &#91;var+8&#93;<br />	push dword ptr &#91;var+4&#93;<br />	push dword ptr &#91;var&#93;<br />endm</code></pre><br /><br />So a VARIANT parameter requires four pushes. This code opens the selected workbook i.e FileName=&quot;Book1.xls&quot;<pre><code>	invoke MultiByteToWideChar,CP_ACP,0,addr szWorkbook,-1,addr lpWideCharStr,\<br />					sizeof lpWideCharStr<br />	invoke SysAllocString,addr lpWideCharStr<br />	mov pWideAllocStr,eax<br />	mov eax,pWorkbooks<br />	mov edx,&#91;eax&#93;<br />	push offset pWorkbook<br />	push 0<br />	&#91;color=red&#93;mov ecx,12<br />@@&#58;	<br />	NoParam<br />	loop @B<br />	push pWideAllocStr&#91;/color&#93; 'Book1.xls<br />	push pWorkbooks<br />	call dword ptr &#91;edx&#93;.Workbooks._Open</code></pre><br />It's the red lines I want to replace with a macro. I have tested @argrev but I always get an compile error.<br /><br />Regards</div>
    <div class="meta">Posted on 2004-04-20 13:36:38 by minor28</div>
   </div>
   <div class="post" id="post-139631">
    <div class="subject"><a href="#post-139631">ExcelHost problem</a></div>
    <div class="body">Perhaps your looking for something like this then?:<pre><code>NULL_PUSH   MACRO Num&#58;=&lt;1&gt;<br />    LOCAL a1, a2, a3<br />    a1 equ &lt;Num&gt;<br />    a2 = 0<br />    while a1 ne a2<br />        push    00000000h<br />        push    80020004h<br />        push    00000000h<br />        push    0000000Ah<br />        a2 = a2 + 1<br />    endm    <br />endm</code></pre><br /><br />Used as:<br /><br /><pre><code>	invoke MultiByteToWideChar,CP_ACP,0,addr szWorkbook,-1,addr lpWideCharStr,\<br />					sizeof lpWideCharStr<br />	invoke SysAllocString,addr lpWideCharStr<br />	mov pWideAllocStr,eax<br />	mov eax,pWorkbooks<br />	mov edx,&#91;eax&#93;<br />	push offset pWorkbook<br />	push 0<br />    NULL_PUSH 12<br />	push pWideAllocStr 'Book1.xls<br />	push pWorkbooks<br />	call dword ptr &#91;edx&#93;.Workbooks._Open</code></pre><br /><br />I havent tested this, but it should work for you.<br />PS: Macros are worth embracing ;)<br />:alright:<br />:NaN:</div>
    <div class="meta">Posted on 2004-04-20 23:48:25 by NaN</div>
   </div>
   <div class="post" id="post-139704">
    <div class="subject"><a href="#post-139704">ExcelHost problem</a></div>
    <div class="body">Hi Nan,<br /><br />My macro knowledge is indeed bad. <br /><br />But the NoPar macro works. For example 10 optional parameters I don't want to use is coded NoPar(10) and the macro acording to your instruction is<pre><code>NoPar macro Num&#58;=&lt;1&gt;<br />    LOCAL a1, a2<br />    a1 equ &lt;Num&gt;<br />    a2 = 0<br />    while a1 ne a2<br />		push 0<br />		push DISP_E_PARAMNOTFOUND<br />		push 0<br />		push VT_ERROR<br />        a2 = a2 + 1<br />    endm    <br />endm</code></pre><br /><br />Now if I want to put a value in such optional parameter as Open Book readonly. The readonly parameter should be TRUE. I call a macro like this: Par(VT_BOOL,boolVal,TRUE) and the macro is<pre><code>Par macro _vt,_union,_value<br />	LOCAL a,v<br />	a equ _vt<br />	v equ &lt;_value&gt;<br />	push 0<br />	push &#40;v<br />	push 0<br />	push a&#41;<br />endm</code></pre><br />The red part is not used. This works with TRUE and FALSE but nothing else. Perhaps a number can work but I haven't tested. Text doesn't work. In fact I am rather suprised that it worked for boolean. I don't understand the parantheses before v and after a. The compiler told me to put them there. When this probleme is solved I intend to show an example how to use the tool.<br /><br />Best regards</div>
    <div class="meta">Posted on 2004-04-21 17:06:13 by minor28</div>
   </div>
   <div class="post" id="post-139713">
    <div class="subject"><a href="#post-139713">ExcelHost problem</a></div>
    <div class="body">Im confused as well what the parentheses is required for...  And not 100% sure i follow what your problem is, but my suggestion would be to try this macro on for size <pre><code>VAR MACRO v2&#58;=&lt;0&gt;, v1&#58;=&lt;VT_I4&gt;<br />    if @InStr&#40;1,v1,&lt;VT_R8&gt;&#41; NE 0<br />        push    v1<br />        push    0<br />        push    DWORD PTR &#91;v2&#93;<br />        push    DWORD PTR &#91;v2+4&#93;<br />    else<br />        push    v1<br />        push    0<br />        push    v2<br />        push    0<br />    endif<br />ENDM</code></pre><br /><br />Its some what robust in that it will handle DWORDS, PTRS, REAL8's, BOOLS, Etc. <br /><br />Ex:<br /><br />VAR ebx, VT_R8  ; ebx = addr of REAL8 value<br />VAR 3                 ; Defult is VT_I4<br />VAR TRUE, VT_BOOL  <br /><br />Etc.<br /><br />Like the last macro, I didnt test it, i only whipped it up on the fly for you.  Lemme know if this helps you out.<br /><br />PS:  If you want inline macros out of these, simply do the following<pre><code><br /><br />$VAR MACRO v1&#58;=&lt;1&gt;, v2&#58;=&lt;VT_I4&gt;<br />   VAR v1, v2<br />   EXITM &lt;&gt;  ;; Return nothing at all<br />ENDM<br /><br /><br />$NoPar MACRO a1&#58;=&lt;1&gt;<br />    NoPar a1<br />    EXITM &lt;&gt;  ;; Return nothing at all<br />endm<br /></code></pre><br /><br />Enjoy!<br />:alright:<br />:NaN:</div>
    <div class="meta">Posted on 2004-04-21 21:54:07 by NaN</div>
   </div>
   <div class="post" id="post-139769">
    <div class="subject"><a href="#post-139769">ExcelHost problem</a></div>
    <div class="body">Hi<br /><br />The parantheses confusion was due to my way to call the macro. I wrote &quot;Par(VT_BOOL,boolVal,TRUE)&quot; with parantheses.<br /><br />Now I have two macros working<pre><code>NoPar macro Num&#58;=&lt;1&gt;<br />    LOCAL a1, a2<br />    a1 equ &lt;Num&gt;<br />    a2 = 0<br />    while a1 ne a2<br />		push 0<br />		push DISP_E_PARAMNOTFOUND<br />		push 0<br />		push VT_ERROR<br />        a2 = a2 + 1<br />    endm    <br />endm</code></pre><br /><br />with a call from &quot;NoPar X&quot; and<pre><code>Par MACRO v1&#58;=&lt;VT_I4&gt;,v2&#58;=&lt;0&gt; <br />    if @InStr&#40;1,v1,&lt;VT_R8&gt;&#41; NE 0<br />        push    0<br />        push    DWORD PTR &#91;v2&#93;<br />        push    0<br />        push    v1<br />    else<br />        push    0<br />        push    v2<br />        push    0<br />        push    v1<br />    endif<br />ENDM</code></pre><br /><br />with a call from &quot;Par VT_BOOL,TRUE&quot;. The last one works with bool, pointers etc. However sometimes the &quot;Par VT_INT,eax&quot; (eax==00000002) works and sometimes not. I can't understand why. These macros eliminate the need of the VARIANT structure.<br /><br />Your inline proposal is interesting. I tried this macro but failed<pre><code>Params macro args&#58;VARARG<br />	<br />	LOCAL arg<br />	for arg,&lt;&amp;args&gt;<br />		if @InStr&#40;1,arg,&lt;$NoPar 3&gt;&#41; ne 0<br />			$NoPar MACRO a1&#58;=&lt;1&gt;<br />			    NoPar a1<br />			    EXITM &lt;&gt;  ;; Return nothing at all<br />			endm<br />		else<br />			$Par MACRO v1&#58;=&lt;1&gt;, v2&#58;=&lt;VT_I4&gt;<br />			   Par v1, v2<br />			   EXITM &lt;&gt;  ;; Return nothing at all<br />			ENDM<br />		endif<br />	endm<br />endm</code></pre><br />called from &quot;Param NoPar 3&quot; and how do I do if a parameter is not a variant.<br /><br />I attach the excel example and the COM.exe. I put in a simple VB browser. I don't know if it vill easy up the use of the tool.<br /><br />I you don't quit excel with the button you have to terminate it with the tasm manager.</div>
    <div class="meta">Posted on 2004-04-22 11:08:52 by minor28</div>
   </div>
   <div class="post" id="post-139771">
    <div class="subject"><a href="#post-139771">ExcelHost problem</a></div>
    <div class="body">I forgot to attach the excel example. There are no security arrangements in the code so if you puch buttons in wrong order the app will probobly crash. Then you have to terminate excel with the task manager</div>
    <div class="meta">Posted on 2004-04-22 11:22:13 by minor28</div>
   </div>
   <div class="post" id="post-139812">
    <div class="subject"><a href="#post-139812">ExcelHost problem</a></div>
    <div class="body">Your well on your way with COM and Active-X automation.  <br /><br />As for the macro's, i think you got me misunderstood.  I ment inline to be used in this sort of case<pre><code><br />    ; Stack push order -&gt;<br />    $NoPar&#40;2&#41; $Par&#40;VT_BOOL, TRUE&#41;<br />    call &#91;ebx&#93;.ComMethod</code></pre><br />Which would produce the following code:<br /><pre><code>00401C77  |. 6A 00          PUSH 0<br />00401C79  |. 68 04000280    PUSH 80020004<br />00401C7E  |. 6A 00          PUSH 0<br />00401C80  |. 6A 0A          PUSH 0A<br />00401C82  |. 6A 00          PUSH 0<br />00401C84  |. 68 04000280    PUSH 80020004<br />00401C89  |. 6A 00          PUSH 0<br />00401C8B  |. 6A 0A          PUSH 0A<br />00401C8D  |. 6A 00          PUSH 0<br />00401C8F  |. 6A 01          PUSH 1<br />00401C91  |. 6A 00          PUSH 0<br />00401C93  |. 6A 0B          PUSH 0B<br />00401C95  |. E8 DCFFFFFF    CALL &#91;ebx+04&#93;</code></pre><br /><br />I hope this is more clear to you. <br /><br />Below is the macros i used to produce the code above<pre><code>NoPar macro Num&#58;=&lt;1&gt;<br />    LOCAL a1, a2<br />    a1 equ &lt;Num&gt;<br />    a2 = 0<br />    while a1 ne a2<br />		push 0<br />		push DISP_E_PARAMNOTFOUND<br />		push 0<br />		push VT_ERROR<br />        a2 = a2 + 1<br />    endm    <br />endm<br /><br />Par MACRO v1&#58;=&lt;VT_I4&gt;,v2&#58;=&lt;0&gt; <br />    if @InStr&#40;1,v1,&lt;VT_R8&gt; &#41; NE 0<br />        push    0<br />        push    DWORD PTR &#91;v2&#93;<br />        push    0<br />        push    v1<br />    else<br />        push    0<br />        push    v2<br />        push    0<br />        push    v1<br />    endif<br />ENDM<br /><br />VT_ERROR            equ 10<br />DISP_E_PARAMNOTFOUND                 equ 80020004h<br /><br /><br /><br />$Par MACRO v1&#58;=&lt;VT_I4&gt;,v2&#58;=&lt;0&gt;<br />   Par v1, v2<br />   EXITM &lt;&gt;  ;; Return nothing at all<br />ENDM<br /><br /><br />$NoPar macro Num&#58;=&lt;1&gt;<br />    NoPar Num<br />    EXITM &lt;&gt;  ;; Return nothing at all<br />endm</code></pre><br /><br />Regards,<br />:NaN:</div>
    <div class="meta">Posted on 2004-04-22 18:43:44 by NaN</div>
   </div>
   <div class="post" id="post-140201">
    <div class="subject"><a href="#post-140201">ExcelHost problem</a></div>
    <div class="body">I have worked the COM tool over and it fullfills my needs now. I have added a VB browser more like the one shiped with VB6.0. I have also added possibility to launch the com help files from help menu or with F1. I believe it is easier to code asm if you can see the corresponding VB code and help.<br /><br />I have only tested the tool on win2k and Excel. It will only work if you have TLBINF32.dll. This dll i shiped with VB6.0 and Visual studio. I don't know if it is legal to add it to the tool but you can google after it. Registration of the dll can be done with the tool.<br /><br />The Access file holds the asm code and macros. You can edit the text as you like.<br /><br />If this tool is interesting for use in general I would be glad if someone will test it and comment it.</div>
    <div class="meta">Posted on 2004-04-26 14:37:28 by minor28</div>
   </div>
   <div class="post" id="post-140371">
    <div class="subject"><a href="#post-140371">ExcelHost problem</a></div>
    <div class="body">New update version 1.2.0.<br /><br />- fixed a bug<br /><br />- You can search constants<br /><br />- in function listing a third column showing return pointers to function pointer. Clicking on the pointer opens the new function members, even if the function is in an external library.</div>
    <div class="meta">Posted on 2004-04-28 15:53:17 by minor28</div>
   </div>
   <div class="post" id="post-140747">
    <div class="subject"><a href="#post-140747">W2k Bug</a></div>
    <div class="body">Hi Minor28,<br /><br />Error when starting com.exe under windows 2000 sp3.<br /><br />Regards<br />ipadilla</div>
    <div class="meta">Posted on 2004-05-02 23:23:22 by ipadilla</div>
   </div>
   <div class="post" id="post-140790">
    <div class="subject"><a href="#post-140790">ExcelHost problem</a></div>
    <div class="body">Hi ipadilla,<br /><br />I don't understand spanish. It looks like: error during startup. Can't find name of database  and terminating the application or something.<br /><br />Have you copied the Com.mdb to application folder. It is an access database with code snippets and macros.</div>
    <div class="meta">Posted on 2004-05-03 13:28:28 by minor28</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=18013&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=18013&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="18013" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=18013&amp;page=2">&gt;</a><a href="../?id=18013&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>