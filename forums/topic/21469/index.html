<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Yet Another Particle System - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=21469" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=10">Graphics &amp; Game Development</a> &raquo; <a href="../?id=21469">Yet Another Particle System</a></p>
   <div class="post" id="post-162147">
    <div class="subject"><a href="#post-162147">Yet Another Particle System</a></div>
    <div class="body">What follows is a draft - it is not debugged, and is missing vital code.<br />I&#39;m posting this here for suggestions before I finish it up.<br />Please voice your opinions :)<br /><br /><pre><code><br />;Title&nbsp; - ParticleSystem Object for ObjAsm32<br />;Author - Evil Homer<br />;Dated&nbsp; - 17 July, 2005<br />;<br />;A ParticleSystem can be thought of as a Particle Emitter.<br />;You can attach them to anything, they squirt stuff.<br />;This ParticleSystem object implementation contains<br />;some interesting features, particularly its runtime<br />;capabilities such as overriding the Render method at runtime,<br />;and the ability to attach and detach Emitters at runtime.<br />;This opens the possibility for ParticleSystems to be<br />;attached to Particles owned by another ParticleSystem,<br />;such that Particles may emit SubParticles during their lifetime.<br />;Many other interesting possibilities exist.<br />;<br />;=================================================<br />;Data Members (All TIMES are in Floating Seconds)<br />;=================================================<br />;<br />;TimeOfLastEmission (REAL4)<br />;Time at which the previous Particle Emission occurred<br />;<br />;TimeBetweenEmissions (REAL4)<br />;Period of Time to elapse between Particle Emissions<br />;<br />;ParticlesPerEmission (DWORD)<br />;Maximum Particles to emit during a Particle Emission<br />;<br />;LifeTimePerParticle (REAL4)<br />;Period of Time for which a Particle is &quot;alive&quot;<br />;<br />;MaxParticles (REAL4)<br />;Capacity of the ParticleSystem<br />;<br />;pPositionAttach (Pointer to Vec3)<br />;Pointer to a Vec3 Position to serve as the 3D Origin<br />;for newly-emitted Particles, ie the Emitter Position.<br />;As an example use for this field, the Vec3 could<br />;be a point on any moving object in the world..<br />;<br />;Position (Vec3)<br />;Position of the Particle Emitter when NOT Attached by Position.<br />;Remembers the Detachment Position.<br />;<br />;Force (Vec3)<br />;Defines the ambient Force to apply to active Particles over Time<br />;Includes Gravity, and can be used to introduce &quot;wind&quot; effects etc.<br />;<br />;Particles<br />;Pointer to Heap-Allocated memory containing the Particle Array<br />;<br />;=================================================<br />;				METHODS<br />;=================================================<br />;<br />;Done<br />;As usual, this is the Destructor Method, called by the Destroy macro.<br />;<br />;Init (MaxParticles,ParticlesPerEmission,TimeBetweenEmissions,<br />;	&nbsp;  LifeTimePerParticle,AppTime)<br />;This is the Constructor Method, which you must call yourself.<br />;<br />;AttachPosition (pPosition=ptr Vec3)<br />;This method attaches the ParticleSystem to an arbitrary external Vec3<br />;such that the Emitter is now &quot;glued&quot; in worldspace to this (possibly moving) <br />;3D Position value.<br />;<br />;DetachPosition<br />;This method detaches the ParticleSystem from its attached Position<br />;and sets the detachment position as the ParticleSystem (emitter) Position<br />;such that the Emitter is now &quot;glued&quot; in worldspace at the point of detachment<br />;<br />;RenderParticle (pParticle)<br />;This method , which can be dynamically overidden in derived objects,<br />;renders a single Particle to the screen.<br />;The default Method supplied is designed for rendering a textured<br />;rectangle with alphablending, presumably under Othographic projection.<br />;<br />;Reset<br />;This method sets up Particle Colors and Revives all Particles<br />;<br />;ReviveParticle (pParticle)<br />;This method breathes new life into a &quot;dead&quot; Particle<br />;<br />;Update<br />;This method updates Particle Positions and Velocities over Time<br />;<br />Object ParticleSystem,ParticleSystemID,Primer<br />	RedefineMethod&nbsp; Done<br />	RedefineMethod	Init,dword,dword,REAL4,REAL4,REAL4			;#Particles,ParticlesPerEmission,TimeBetweenEmissions,LifeTimePerParticle,AppTime<br />	StaticMethod	AttachPosition,Pointer		;pVec3<br />	StaticMethod	DetachPosition<br />	DynamicMethod	RenderParticle,Pointer		;pParticle<br />	StaticMethod	Reset,REAL4					;AppTime<br />	StaticMethod	ReviveParticle,Pointer		;pParticle<br />	StaticMethod	Update,REAL4,REAL4			;AppTime,ElapsedTime<br /><br />	DefineVariable	TimeOfLastEmission,REAL4,0<br />	DefineVariable	TimeBetweenEmissions,REAL4,0	<br />	DefineVariable	ParticlesPerEmission,dword,0<br />	DefineVariable	LifeTimePerParticle,REAL4,0	<br />	DefineVariable	MaxParticles,dword,0<br />	DefineVariable&nbsp; pPositionAttach,dword,0<br />	DefineVariable&nbsp; Position,Vec3,{}<br />	DefineVariable	Force,	 Vec3,{}	<br />	DefineVariable	Particles,dword,0	<br />ObjectEnd<br /><br />Particle struct<br />	active&nbsp; dd ?&nbsp; 					; Active (Yes/No)<br />	life	REAL4 ?					; Particle Life<br />	fade	REAL4 ?					; Fade Speed<br />	r		REAL4 ?					; Red Value<br />	g		REAL4 ?					; Green Value<br />	b		REAL4 ?					; Blue Value<br />	Position Vec3 &lt;&gt;<br />	Velocity Vec3 &lt;&gt;<br />Particle ends<br /><br />;Macro to load a &quot;random signed float&quot; onto the fpu<br />;The random value X is in the Range of -Y&gt; X &lt;+Y<br />;where Y is a Positive REAL4 Range Limiting Value<br />;which can be a Named Variable or an immediate float<br />;Example1 : FLDRndSignedFloat 26.0f<br />;Example2 : FldRndSignedFloat r4_26_0_f<br />FLDRndSignedFloat macro t<br />local we, wa, OYeah1, OYeah2, OYeah<br />we = 0<br />wa InStr &lt;t&gt;, &lt;.&gt;<br />invoke TFRandom<br />fsub r4_half<br />if wa ne 0<br />	;We found a DOT so assume its an immediate Float , ie 1.0f<br />	we InStr &lt;t&gt;, &lt;-&gt;<br />	if we ne 0		<br />		OYeah1 SubStr &lt;t&gt;, we+1, wa-2<br />		OYeah1 CatStr &lt;m&gt;, OYeah1	<br />	else<br />	&nbsp; &nbsp; OYeah1 SubStr &lt;t&gt;, 1, wa - 1<br />&nbsp; &nbsp; endif<br />	OYeah2 SubStr &lt;t&gt;, wa + 1&nbsp; &nbsp; <br />&nbsp; &nbsp; OYeah&nbsp; CatStr &lt;r4_&gt;,OYeah1,&lt;_&gt;,OYeah2<br />&nbsp; &nbsp; OYeah1 CatStr &lt;_&gt;,OYeah<br />	<br />	%ifndef OYeah1<br />		OYeah1 = 1<br />		%ECHO OYeah REAL4 t		<br />		.data<br />			OYeah REAL4 t<br />		.code<br />	endif<br />	fmul OYeah<br />else<br />	;We found no DOT so assume its the name of a REAL4 variable<br />	fmul t<br />endif<br />endm<br /><br />.data<br />colors glColor3 {1.0f,0.5f,0.5f},<br />				{1.0f,0.75f,0.5f},<br />				{1.0f,1.0f,0.5f},<br />				{0.75f,1.0f,0.5f},<br />				{0.5f,1.0f,0.5f},<br />				{0.5f,1.0f,0.75f},<br />				{0.5f,1.0f,1.0f},<br />				{0.5f,0.75f,1.0f},<br />				{0.5f,0.5f,1.0f},<br />				{0.75f,0.5f,1.0f},<br />				{1.0f,0.5f,1.0f},<br />				{1.0f,0.5f,0.75f}<br /><br />Method ParticleSystem.Done,uses esi<br />	SetObject esi<br />	MemFree .Particles<br />MethodEnd<br />	<br />Method ParticleSystem.Init,uses esi,MaxParticles,ParticlesPerEmission,TimeBetweenEmissions,LifeTimePerParticle,fTime<br />SetObject esi<br />m2m .MaxParticles,MaxParticles<br />m2m .ParticlesPerEmission,ParticlesPerEmission<br />m2m .TimeBetweenEmissions,TimeBetweenEmissions<br />m2m .LifeTimePerParticle,LifeTimePerParticle<br />mov eax,sizeof Particle<br />mul MaxParticles<br />mov .Particles,$MemAlloc(eax)<br />OCall DetachPosition<br />OCall Reset,fTime<br />MethodEnd<br /><br />Method ParticleSystem.AttachPosition,uses esi,pPosition<br />	SetObject esi<br />	m2m .pPositionAttach,pPosition<br />MethodEnd<br /><br />Method ParticleSystem.DetachPosition,uses esi<br />	SetObject esi<br />	.if .pPositionAttach!=NULL<br />		mov eax,.pPositionAttach<br />		fld .Vec3.X<br />		fstp .Position.X<br />		fld .Vec3.Y<br />		fstp .Position.Y<br />		fld .Vec3.Z<br />		fstp .Position.Z<br />		mov .pPositionAttach,NULL<br />	.endif<br />MethodEnd<br /><br />Method ParticleSystem.Update,uses esi ecx,fAbsoluteTime,fElapsedTime<br />local ParticlesEmittedThisEmission<br />local EmissionRequired<br />local EmissionPerformed<br /><br />	mov ParticlesEmittedThisEmission,0<br />	mov EmissionPerformed,FALSE	<br />	SetObject esi<br />	<br />	;Calculate whether it&#39;s time to perform<br />	;a Particle Emission yet<br />	;(Sets EmissionRequired=TRUE or FALSE)<br />	mov EmissionRequired,FALSE<br />	fld fAbsoluteTime<br />	fsub .TimeOfLastEmission<br />	fcomp .TimeBetweenEmissions	<br />	GetFPUFlags<br />	ja @F<br />	mov EmissionRequired,TRUE<br />@@: <br /><br />	;For each Particle...<br />	mov ebx,.Particles<br />	xor ecx,ecx	<br />	.while ecx&lt;.MaxParticles<br />		push ecx<br />		mov eax,sizeof Particle<br />		mul ecx<br />		add ebx,eax<br />		;Is this Particle &quot;dead&quot; ??<br />		.if .Particle.active==FALSE<br />			;And it&#39;s time to Emit Particles ??<br />			.if EmissionRequired==TRUE<br />				;And we&#39;ve not Emitted enough Particles ??<br />				mov eax,ParticlesEmittedThisEmission<br />				.if eax&lt;.ParticlesPerEmission<br />					;Then give this Particle NEW LIFE !!! IT LIVES :D<br />					mov EmissionPerformed,TRUE<br />					inc ParticlesEmittedThisEmission<br />					OCall ReviveParticle,ebx<br />				.endif<br />			.endif<br />		.else<br />			;Update Particle Life Timer<br />			fld .Particle.life<br />			fsub fElapsedTime<br />			fcomp r4_0_0f<br />			GetFPUFlags<br />			ja @F<br />			mov .Particle.active,FALSE<br />			jmp doLoop<br />@@:			;Update Particle Position<br />			fld .Particle.Velocity.X<br />			fadd .Particle.Position.X<br />			fstp .Particle.Position.X<br />			fld .Particle.Velocity.Y<br />			fadd .Particle.Position.Y<br />			fstp .Particle.Position.Y<br />			fld .Particle.Velocity.Z<br />			fadd .Particle.Position.Z<br />			fstp .Particle.Position.Z			<br />			;Update Particle Velocity<br />			;NewVelocity = (Force * dTime) + OldVelocity<br />			fld fElapsedTime<br />			fmul .Force.X<br />			fadd .Particle.Velocity.X<br />			fstp .Particle.Velocity.X<br />			fld fElapsedTime<br />			fmul .Force.Y<br />			fadd .Particle.Velocity.Y<br />			fstp .Particle.Velocity.Y<br />			fld fElapsedTime<br />			fmul .Force.Z<br />			fadd .Particle.Velocity.Z<br />			fstp .Particle.Velocity.Z			<br />			;Render Particle		<br />			OCall RenderParticle,ebx<br />		.endif<br />		.if EmissionPerformed==TRUE<br />			fld fAbsoluteTime<br />			fstp .TimeOfLastEmission<br />		.endif<br />doLoop:		<br />		pop ecx<br />		inc ecx<br />	.endw<br />MethodEnd	<br /><br />Method ParticleSystem.Reset,uses esi ecx,fAbsoluteTime<br />local pParticle<br />	SetObject esi<br />	mov ebx,.Particles<br />	fld fAbsoluteTime<br />	fstp .TimeOfLastEmission<br />	xor ecx,ecx<br />	.while ecx&lt;.MaxParticles<br />		mov eax,sizeof Particle<br />		mul ecx<br />		add ebx,eax<br />		<br />		;Set up Particle Color<br />		mov eax,ecx<br />		div 12<br />		mov eax,sizeof glColor<br />		mul edx<br />		m2m .Particle.r, colors<br />		add eax,sizeof glColor<br />		m2m .Particle.g, colors<br />		add eax,sizeof glColor	<br />		m2m .Particle.b, colors		<br /><br />		OCall ReviveParticle,ebx<br /><br />		inc ecx<br />	.endw<br />MethodEnd<br /><br />Method ParticleSystem.ReviveParticle,uses esi ebx ecx,pParticle<br />SetObject esi<br />	mov ebx,pParticle<br />	mov .Particle.active,TRUE						; Make All The Particles Active<br />	fld .LifeTimePerParticle<br />	fstp .Particle.life<br />	invoke TIRandom,1,100<br />	fadd r4_0_003f<br />	fstp .Particle.fade&nbsp; ;(rand%100)/1000.0f+0.003f;	// Random Fade Speed<br />	<br />	FLDRndSignedFloat 26.0f<br />	fstp .Particle.Velocity.X<br />	FLDRndSignedFloat 26.0f<br />	fstp .Particle.Velocity.Y<br />	FLDRndSignedFloat 26.0f<br />	fstp .Particle.Velocity.Z<br /><br />	.if .pPositionAttach==NULL<br />		fld&nbsp; .Position.X<br />		fstp&nbsp; .Particle.Position.X<br />		fld&nbsp; .Position.Y<br />		fstp&nbsp; .Particle.Position.Y<br />		fld&nbsp; .Position.Z<br />		fstp&nbsp; .Particle.Position.Z		<br />	.else<br />		mov eax,pPositionAttach<br />		fld .Vec3.X<br />		fstp .Particle.Position.X<br />		fld .Vec3.Y<br />		fstp .Particle.Position.Y<br />		fld .Vec3.Z<br />		fstp .Particle.Position.Z<br />	.endif<br />	fld r4_0_0<br />	fst&nbsp; .Force.X<br />	fstp .Force.Z<br />	fld&nbsp; r4_gravity	;-0.86<br />	fstp .Force.Y<br />MethodEnd<br /><br /><br />Method ParticleSystem.RenderParticle,uses esi,pParticle<br />local x1,y1,fz<br />local x2,y2<br />	mov esi,pParticle<br />	fld .Particle.Position.X<br />	fadd r4_half<br />	fstp x1<br />	fld .Particle.Position.X<br />	fsub r4_half<br />	fstp x2<br />	<br />	fld .Particle.Position.Y<br />	fadd r4_half<br />	fstp y1	<br />	fld .Particle.Position.Y<br />	fsub r4_half<br />	fstp y2<br />	<br />	fld .Particle.Position.Z<br />	fstp fz<br />	_glColor4f .Particle.r,.Particle.g,.Particle.b,.Particle.life<br />	; Build Quad From A Triangle Strip<br />	invoke glBegin,GL_TRIANGLE_STRIP<br />	_glTexCoord2d 1.0f,1.0f		<br />	_glVertex3f x1,y1,fz); // Top Right<br />	_glTexCoord2d 0.0f,1.0f		<br />	_glVertex3f x2,y1,fz; // Top Left<br />	_glTexCoord2d 1.0f,0.0f		<br />	_glVertex3f x1,y2,fz; // Bottom Right<br />	_glTexCoord2d 0.0f,0.0f		<br />	_glVertex3f x2,y2,fz; // Bottom Left<br />	invoke glEnd	<br />MethodEnd<br /><br /><br /></code></pre><br /></div>
    <div class="meta">Posted on 2005-07-17 06:30:51 by Homer</div>
   </div>
   <div class="post" id="post-162167">
    <div class="subject"><a href="#post-162167">Re: Yet Another Particle System</a></div>
    <div class="body"><br />All I asked for was your opinion, that&#39;s a crap response.<br />I implemented the ParticleSystem.<br />This isn&#39;t showing much off, but regardless:<br /><br />http://homer.rantx.com/UDPClient.exe<br /><br />Cmon guys, gimme some feedback :(<br />If you have DebugCenter installed, you will see Debug information :)<br /></div>
    <div class="meta">Posted on 2005-07-18 03:56:54 by Homer</div>
   </div>
   <div class="post" id="post-162173">
    <div class="subject"><a href="#post-162173">Re: Yet Another Particle System</a></div>
    <div class="body">i think the particles are too fast - i can hardly see them.<br />when i hold LMB on a menuitem, the debug center keeps shooting the text about selected option ( &quot;play alone&quot; etc).? when i leave the window, while holding LMB, release it, then it still keeps shooting the text (probably thinks that i hold it.<br /><br /><br /><br />/edit<br />Added CPU&#39;s clock frequency</div>
    <div class="meta">Posted on 2005-07-18 07:20:59 by ti_mo_n</div>
   </div>
   <div class="post" id="post-162176">
    <div class="subject"><a href="#post-162176">Re: Yet Another Particle System</a></div>
    <div class="body">On my machine it works nice... (P3 500)<br /><br />Biterider</div>
    <div class="meta">Posted on 2005-07-18 08:33:25 by Biterider</div>
   </div>
   <div class="post" id="post-162177">
    <div class="subject"><a href="#post-162177">Re: Yet Another Particle System</a></div>
    <div class="body">Thanks for the replies.<br /><br />I can understand the bug regarding moving off the window with the button down, I&#39;ll sort it out, it&#39;s because I enable a flag on mousedown, and disable it on mouseup.<br /><br />I&#39;ve improved the code somewhat and tweaked some of the settings for the particlesystem.<br />Particle Emitter is now attached to a point manipulated with trig.<br />Particle initial random velocity was screwed with.<br />Particles never go toward you, and they have less thrust so you can see gravity working.<br />I&#39;m thinking about making an overridable &quot;Particle Behaviour&quot; method ..<br /><br />modified exe was uploaded to same url as last given.<br />Have a nice day :)</div>
    <div class="meta">Posted on 2005-07-18 10:39:49 by Homer</div>
   </div>
   <div class="post" id="post-162178">
    <div class="subject"><a href="#post-162178">Re: Yet Another Particle System</a></div>
    <div class="body">the emitrer is going in circles and shoots the particles so fast, that I can see -at most- 10 of them. I think that it would look nicer if there were more of them. ...and they should move slower! :)</div>
    <div class="meta">Posted on 2005-07-18 11:14:51 by ti_mo_n</div>
   </div>
   <div class="post" id="post-162179">
    <div class="subject"><a href="#post-162179">Re: Yet Another Particle System</a></div>
    <div class="body">That&#39;s interesting - it indicates that there&#39;s a problem with my &quot;elapsed time&quot; function and/or the way the particle physics works.. If you resize the window smaller, they seem to speed up, which is wrong.. I&#39;ll try to remedy it tomorrow.. just implemented some more of the Menu, which was commented out.. checked that menu page switches work, and fixed the mousebutton bug.<br /><br />Have a nice day :)</div>
    <div class="meta">Posted on 2005-07-18 11:30:49 by Homer</div>
   </div>
   <div class="post" id="post-162182">
    <div class="subject"><a href="#post-162182">Re: Yet Another Particle System</a></div>
    <div class="body">Mousebutton bug is still present... :|</div>
    <div class="meta">Posted on 2005-07-18 12:32:20 by ti_mo_n</div>
   </div>
   <div class="post" id="post-162185">
    <div class="subject"><a href="#post-162185">Re: Yet Another Particle System</a></div>
    <div class="body">Homer, when are you registering mouseclicks? mouse-down or mouse-up?</div>
    <div class="meta">Posted on 2005-07-18 13:19:32 by f0dder</div>
   </div>
   <div class="post" id="post-162188">
    <div class="subject"><a href="#post-162188">Re: Yet Another Particle System</a></div>
    <div class="body">on buttondown use &quot;set capture&quot; and on buttonup use &quot;release capture&quot;. this way you&#39;ll get &#39;buttonup&#39; even if the button gets released outside the window.</div>
    <div class="meta">Posted on 2005-07-18 14:38:12 by ti_mo_n</div>
   </div>
   <div class="post" id="post-162190">
    <div class="subject"><a href="#post-162190">Re: Yet Another Particle System</a></div>
    <div class="body">re mousebug:<br />I&#39;m detecting mousedown, mouseup no longer handled at all.<br />I simply hadn&#39;t had a chance to upload an updated exe yet, sorry.. there&#39;s a new update available now :)<br />This time I&#39;ve enabled one of the SubMenus and change the &quot;current menu&quot; on mouseclick.<br />The menu still needs the items to be switched around since my 2D artist decided to change things around without letting me know .. that&#39;s why you see incorrect debug feedback on menu item selections.<br /><br />Have a nice day :)</div>
    <div class="meta">Posted on 2005-07-18 22:55:50 by Homer</div>
   </div>
  </div>
 </body>
</html>