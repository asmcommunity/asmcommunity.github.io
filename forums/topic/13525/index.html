<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>RadASM Spreadsheet problem - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=13525" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=42">RadASM</a> &raquo; <a href="../?id=13525">RadASM Spreadsheet problem</a></p>
   <div class="post" id="post-104790">
    <div class="subject"><a href="#post-104790">RadASM Spreadsheet problem</a></div>
    <div class="body">KetilO,<br /><br />I've been experimenting with your SpreadSheet tool, and it is just what I need for a project I'm working on.  But I've run into a problem.<br /><br />I'm running on Win95, using RadASM 2.0.2.1, with MASM32 V8.  I wrote a stand alone masm program to do what I want, and it worked perfectly.  When I incorporated the code into the main project I get an error if I try to type or press enter in any cell of the sheet.  The spreadsheet opens fine, I programatically add text, numbers, and formulas into cells and then do a recalculate and everything works fine.  At this point I can use the arrow keys, page up, page down, and navigate with the mouse.  But as soon as press a number, letter, or the enter key I get the following error:<br /><br />SEED(TRACK) caused an invalid page fault in<br />module SPRSHT.DLL at 0137:00fd7ae3.<br />Registers:<br />EAX=00000000 CS=0137 EIP=00fd7ae3 EFLGS=00010203<br />EBX=0069d7d2 SS=013f ESP=0069bf70 EBP=0069d780<br />ECX=00000000 DS=013f ESI=000087f6 FS=5977<br />EDX=00008812 ES=013f EDI=0069d788 GS=12bf<br />Bytes at CS:EIP:<br />53 56 8b 45 0c 83 f8 08 75 28 e8 7a 00 00 00 e8 <br />Stack dump:<br /><br /><br />Do you have any idea why this might happen?  I've examined the code and can't find any of the &quot;usual suspects&quot; and as I said it works fine as a stand alone program.  I've tried to use OllyDbg but was unable to trace into the SPRSHT.dll program.<br /><br />Thanks for our help!<br /><br />Thanks for RadASM!<br /><br />Thanks for the SpreadSheet Tool!<br /><br />farrier<br /><br />Answering my own question:<br /><br />This is the code where it crashes:<br /><pre><code><br />10007ADA 55                     push    ebp<br />10007ADB 8BEC                   mov     ebp,esp<br />10007ADD 81C4F0E7FFFF           add     esp,0FFFFE7F0h<br />10007AE3 53                     push    ebx<br />10007AE4 56                     push    esi<br />10007AE5 8B450C                 mov     eax,&#91;ebp+0Ch&#93;<br />10007AE8 83F808                 cmp     eax,8<br />10007AEB 7528                   jnz     loc_10007B15<br />10007AED E87A000000             call    fn_10007B6C<br /></code></pre><br /><br />the offending instruction is push ebx, right after adding 6160 to the stack pointer.  So I'm going to assume I've gone past my allotted stack space.  Now I need to discover how to increase the stack space!  Using the search button, now!<br /><br />farrier</div>
    <div class="meta">Posted on 2003-05-26 02:02:15 by farrier</div>
   </div>
   <div class="post" id="post-104805">
    <div class="subject"><a href="#post-104805">RadASM Spreadsheet problem</a></div>
    <div class="body">Hi  farrier<br /><br />Only thing I can think of. Are you using WM_NOTIFY in your project?<br />Also the spread sheet allocates a fixed chunk of memory. Are you having a lot of data in your sheet?<br /><br />KetilO</div>
    <div class="meta">Posted on 2003-05-26 03:04:44 by KetilO</div>
   </div>
   <div class="post" id="post-104828">
    <div class="subject"><a href="#post-104828">RadASM Spreadsheet problem</a></div>
    <div class="body">Thanks KetilO,<br /><br />It was a problem  with not enough stack space.  Thanks to posts from f0dder and 	<br />donkey I was able to determine what the stack size is and how to set it in RadASM.<br /><br />In f0dder ' s post from <a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=1462&amp;highlight=link+stack">http://www.asmcommunity.net/board/index.php?topic=1462&amp;highlight=link+stack</a> <br />  I used:<br /><br /><pre><code><br />	assume		FS&#58;nothing<br />	push		dword ptr FS&#58;08<br />	pop			eax<br />	PrintDec	eax<br />;Address limit for stack<br />	push		dword ptr FS&#58;04<br />	pop			eax<br />	PrintDec	eax<br />;Beginning stack address<br /></code></pre><br /><br />And using donkey ' s suggestions from <a target="_blank" href="http://www.asmcommunity.net/board/showthread.php?s=&amp;postid=104265.msg104265">http://www.asmcommunity.net/board/showthread.php?s=&amp;postid=104265.msg104265</a><br /> I changed the Project/Project Options/Link options to include:<br /><br />/Stack:65536|65536<br /><br />Both values /Stack:Reserve,Commit were required, and the comma had to be replaced with the pipe '|' symbol to make it through RadASM.<br /><br />By the way the default value for committed stack was 8192<br /><br />farrier</div>
    <div class="meta">Posted on 2003-05-26 05:36:28 by farrier</div>
   </div>
   <div class="post" id="post-105631">
    <div class="subject"><a href="#post-105631">RadASM Spreadsheet problem</a></div>
    <div class="body">Farrier,<br /><br />You don't add to the stack, you substract from the stack.<br />Even local variables are accessed by allocating a portion on the stack for them (notice the sub esp,xxx at the start of the proc which you have local variables).<br />If you need to allocate 2048bytes you do soemthing like<br /><br /><pre><code><br />sub esp,2048<br />mov esi,esp<br />...<br />add esp,2048;clear up the stack<br /></code></pre></div>
    <div class="meta">Posted on 2003-06-01 04:46:08 by roticv</div>
   </div>
   <div class="post" id="post-105635">
    <div class="subject"><a href="#post-105635">RadASM Spreadsheet problem</a></div>
    <div class="body">roticv,<br /><br />Thanks for the reply!  I'm familiar with how the stack works.  What I meant to say was &quot;right after adding -6160 to the stack pointer.&quot;  <br /><br /><pre><code>10007ADD 81C4F0E7FFFF           add     esp,0FFFFE7F0h</code></pre><br /><br />This is the original asm code from KetilO's SpreadSheet DLL code, from the file SprSht.asm:<br /><br /><pre><code><br />EditProc proc uses ebx esi,hWin&#58;HWND,uMsg&#58;UINT,wParam&#58;WPARAM,lParam&#58;LPARAM<br />	LOCAL	buffer&#91;2048&#93;&#58;BYTE<br />	LOCAL	buffer1&#91;4096&#93;&#58;BYTE<br />	LOCAL	spredt&#58;SPR_EDIT<br /><br />	mov		eax,uMsg<br />	.if eax==WM_KILLFOCUS<br />...</code></pre><br /><br />My problem seems to be with the default stack size in my program, on my machine.  The default size came out to be just 8K.  When the 6160 byte &quot;adjustment&quot; was made to the stack pointer, it appears the next push &quot;crossed the line&quot; into memory I was not authorized to use.  f0dder mentioned &quot;touching&quot; the reserved stack memory, in order to use it.  I'm not sure what he meant, or how to do it.  Does anyone know what he meant?<br /><br />farrier</div>
    <div class="meta">Posted on 2003-06-01 05:08:37 by farrier</div>
   </div>
   <div class="post" id="post-105636">
    <div class="subject"><a href="#post-105636">RadASM Spreadsheet problem</a></div>
    <div class="body">What about try emailing him? Or maybe finding him on #win32asm EFnet.</div>
    <div class="meta">Posted on 2003-06-01 05:31:17 by roticv</div>
   </div>
   <div class="post" id="post-105637">
    <div class="subject"><a href="#post-105637">RadASM Spreadsheet problem</a></div>
    <div class="body">The only place I have seen pre-touching is in discussions about processor architecture (closely allied to pre-fetch), it involves moving data into the cache without tying up registers. Can't say that I really understood the concept though. Best bet is to do what roticv said and email f0dder, he has said that he will reply to email questions.</div>
    <div class="meta">Posted on 2003-06-01 05:41:11 by donkey</div>
   </div>
   <div class="post" id="post-105638">
    <div class="subject"><a href="#post-105638">RadASM Spreadsheet problem</a></div>
    <div class="body">This was in an MMX paper I got from intel a while back, it defines pre-touching data:<div class="quote"> Pre-fetching data several clocks before the instructions that actually use it. By putting one MOV reg, mem instruction in a loop, and incrementing the memory address by 32 every time, entire 32-byte cache lines will be loaded into the cache. Then subsequent uses of that data within the loop or in the next code sequence get cache hits. Of course, this technique of data &quot;pre-touching&quot; works well only if the algorithm can find something useful for the CPU to do during the prefetching time, which does not involve writes to memory, such as shifts or multiplies. One experiment showed a simple loop of loads and stores (using MOVQ) got only 58 MBytes/sec in a naive implementation. But with pre-touching, it increased to 96 MBytes/sec. </div>How this is related to f0dders stuff I don't know.</div>
    <div class="meta">Posted on 2003-06-01 06:17:42 by donkey</div>
   </div>
   <div class="post" id="post-105643">
    <div class="subject"><a href="#post-105643">RadASM Spreadsheet problem</a></div>
    <div class="body">A guard page is set-up to notify the operating system that more memory is needed for the stack - when an access to this 4K page is made a signal is sent.  Search the API for gaurd pages, or look under the memory management functions.<br /><br />Pre-touching can be done in many ways - I like to use the ENTER instruction because it backs the stack up and accesses the memory.<pre><code>enter	_STACK_TOUCH_INTERVAL_ - 4, 0</code></pre>Here is the logic from one of my macros:<pre><code>;; 'touch' the stack when locals are greaterthan _STACK_TOUCH_INTERVAL_<br /><br />IF lbytes GE _STACK_TOUCH_INTERVAL_<br />	y = lbytes<br />	WHILE y GE _STACK_TOUCH_INTERVAL_<br />		enter _STACK_TOUCH_INTERVAL_ - 4,0<br />		y = y - _STACK_TOUCH_INTERVAL_<br />	ENDM<br />	IF y NE 0<br />		sub esp,y<br />	ENDIF<br />	;; fix ebp to equal old esp<br />	lea ebp,&#91;esp + lbytes&#93;<br />ELSE<br />	enter lbytes,0<br />ENDIF</code></pre>...it ensures that lbytes is availible on the stack.</div>
    <div class="meta">Posted on 2003-06-01 09:17:45 by bitRAKE</div>
   </div>
   <div class="post" id="post-105700">
    <div class="subject"><a href="#post-105700">RadASM Spreadsheet problem</a></div>
    <div class="body">Thanks!<br /><br />bitRAKE,<br />donkey,<br />roticv,<br />KetilO<br /><br />I'll look into these methods and report anything I find.<br /><br />I'm  still curious if 8K is the standard size for the Win95 stack and larger for other Win versions?<br /><br />Thanks for the help!<br /><br />farrier</div>
    <div class="meta">Posted on 2003-06-02 00:05:35 by farrier</div>
   </div>
   <div class="post" id="post-105730">
    <div class="subject"><a href="#post-105730">RadASM Spreadsheet problem</a></div>
    <div class="body">Hi  farrier<br /><br />A new version of the custom control has been uploaded to my web site.<br />The new version should avoid this problem.<br /><br />KetilO</div>
    <div class="meta">Posted on 2003-06-02 05:50:45 by KetilO</div>
   </div>
   <div class="post" id="post-105860">
    <div class="subject"><a href="#post-105860">RadASM Spreadsheet problem</a></div>
    <div class="body">Hi all<br /><br />Yet another new version of the custom control has been uploaded to my web site.<br />A cell calculation bug has been fixed.<br /><br />KetilO</div>
    <div class="meta">Posted on 2003-06-03 09:22:24 by KetilO</div>
   </div>
   <div class="post" id="post-105995">
    <div class="subject"><a href="#post-105995">RadASM Spreadsheet problem</a></div>
    <div class="body">Thanks KetilO,<br /><br />Thanks for all your help!!!<br /><br />To follow-up on my original problem:<br /><br />My program experienced a problem with the stack, when 6162 bytes worth of local variables were declared.  That didn't seem like a lot to me, and made me wonder about the stack as I never had before--mainly because I never ran into a stack problem before.<br /><br />Writing a simple program to determine the state of the stack:<br /><br /><pre><code>	assume		FS&#58;nothing<br /><br />	mov		eax, dword ptr FS&#58;08<br />	mov		ebx, dword ptr FS&#58;04<br /><br />	PrintDec	eax<br />	PrintDec	ebx<br /><br />	sub		ebx, eax<br />	invoke		dwtoa, ebx, addr lpstacksize<br /><br />	invoke		GetModuleHandle, NULL<br />	mov		hInstance,eax<br />	<br />	invoke		MessageBox, hInstance, addr lpstacksize, addr SS_caption, MB_OK<br />	<br />	invoke		ExitProcess,eax</code></pre><br /><br />The message box reported 8192 bytes between the starting point for the stack and the stack limit.  This might explain why my program bombed when the local varialbles were declared, they crossed the 8192 byte limit.  When I disassembled my program using the Dis-assemble EXE file option under the Tools menu in Hutch--'s Quick Editor program, I found the following values reported:<br /><br />Size Of Stack Reserve                   00100000<br />Size Of Stack Commit                    00001000<br /><br />1 MEG reserved stack<br />4 K commited stack<br /><br />So it seems that the amount of stack commited was the cause of the error.  I had tried to use the /STACK switch of the MASM linker to increase the reserved amount of stack, but that never helped.  I included the commit option, /STACK:65535,65536 which actually reduced the amount of reserved stack, but increased the amount of commited stack.  The increase in the amount of commited stack allowed the program to work.<br /><br />I then wrote a procedure which allocated the same amount of stack space as KetilO's spreadsheet program and no error was generated.  I created a proc which declared a LOCAL array of 6162 bytes--the original amount allocated--and increased the size of the array until the program bombed:<br /><pre><code><br />stack_check proc	uses ebx esi		<br />                 ;the 'uses ebx esi' is where the program bombs, <br />                 ;when it tries to save ebx with&#58; push ebx<br />	LOCAL	buffer&#91;11824&#93;&#58;BYTE<br />	ret<br />stack_check endp</code></pre><br /><br />The size of the LOCAL array could be increased to 11824 bytes before the program bombed at 11825 bytes.  The stack limit address was reported as 63e000h and the value of ESP when the program bombed was 63d000h which crossed a  4096 byte boundary.<br /><br />NAN's stack test program:<br /><br /><pre><code>	mov eax, esp<br />	PrintHex eax, &quot;Start ESP&quot;<br />	@@&#58;<br />	push eax<br />	jmp @B</code></pre><br /><br />runs fine inline with the main program--or in a proc--until ESP differed from starting stack address by fd000h (1,036,288) not quite 1Meg.  It appears that if the stack is approached 1 DWORD at a time you can use just about all of the 1 MEG reserved for the stack.  According to Jeremy Gordon--of GoAsm fame--http://www.jorgon.freeserve.co.uk/GoasmHelp/usstack2.htm#enlarge, accesses to the stack cannot cross the current commited stack areas plus the page size--4096 bytes--without causing an exception.  This may explain the program bombing when an attempt was made to allocate 11,825 bytes of local array, causing the stack limit to be exceeded by 4096 bytes.<br /><br />Using ENTER and LEAVE within the procedure did not prevent the program from bombing, because we were still exceeding the commited stack space by more than 4096 bytes.<br /><br />So now we have to &quot;touch&quot; the stack, to commit more stack memory.  Using Jeremy's code:<br /><br /><pre><code>	MOV	ECX,10<br />L0&#58;<br />	SUB	ESP,1000h<br />	MOV	D&#91;ESP&#93;,0			;MOV	DWORD ptr ESP, 0<br />	LOOP	L0<br /><br />And adding&#58;<br />	ADD	ESP, 0a000h</code></pre><br />to correct the stack, ten 4K page of stack have been commited and allow the stack to grow in &quot;large chunks&quot;  The code to &quot;touch&quot; the stack would be called just before the procedure requiring large chunks of local variables.  As Jeremy says, it would be preferable to commit the stack at link time, but in my case the error occured within KetilO's DLL and I had no idea what sort of LOCAL variables were being declared.  So maybe the solution here would be to &quot;touch&quot; two 4K pages in KetilO's DLL just before calling the proc requiring lots of LOCAL variables.<br /><br />farrier</div>
    <div class="meta">Posted on 2003-06-04 15:58:22 by farrier</div>
   </div>
  </div>
 </body>
</html>