<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Revisited: C like calls - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=18038" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=18038">Revisited: C like calls</a></p>
   <div class="post" id="post-139232">
    <div class="subject"><a href="#post-139232">Revisited: C like calls</a></div>
    <div class="body">Well I finally had some free time to download the manuals heh.<br /><br />I remember a thread on this, but all my searches are coming up with junk.<br />Doesnt matter I guess.  Been playing around with macros again and I seem<br />to have come up with one possible solution steming from an interesting<br />side effect (depends on how you look at it).  This perhaps is common knowledge<br />but its new to me and I havnt seen it discussed before so I thought I would<br />just throw it out there.<br /><br />test MACRO arg1, arg2 arg3<br />ENDM<br /><br />Doing alot of poking around, turns out that if you include parenths in the<br />call they end up in the parameters to the macro itself...<br /><br />ie -&gt; test( 1, 2, 3 )<br />arg1 &quot;( 1&quot;<br />arg2 &quot;2&quot;<br />arg3 &quot;3 )&quot;<br /><br />which, normally, will create alot of errors... for those interested in this sort of<br />thing I have some cut and paste code for ya.<br /><br />:notsure:<br />Goes in Windows.inc<br /><pre><code><br />; #########################################################################<br />; STCALL MACRO<br /><br />stcall MACRO funcname&#58;REQ,param,p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13,p14,p15,p16,p17,p18,p19,p20<br />	LOCAL pos,counter<br />	counter=0<br />	FOR arg,&lt;p20,p19,p18,p17,p16,p15,p14,p13,p12,p11,p10,p9,p8,p7,p6,p5,p4,p3,p2,p1&gt;<br />		IFNB &lt;arg&gt;<br />			counter=counter+1<br />			pos=@InStr&#40;1,arg,&lt;ADDR&gt;&#41; OR @InStr&#40;1,arg,&lt;addr&gt;&#41; OR @InStr&#40;1,arg,&lt;Addr&gt;&#41;<br />			IF pos<br />				IF &#40;OPATTR&#40;@SubStr&#40;arg,%pos+5&#41;&#41;&#41; EQ 98<br />					lea eax,@SubStr&#40;&lt;arg&gt;,%pos+5&#41;<br />					push eax<br />				ELSE<br />					push OFFSET @SubStr&#40;&lt;arg&gt;,%pos+5&#41;<br />				ENDIF<br />			ELSE<br />				push arg<br />			ENDIF<br />		ENDIF<br />	ENDM<br />	IF counter NE param<br />		tmp TEXTEQU %&#40;@Line&#41;<br />%		echo  Line &#58; tmp , funcname , invalid number of parameters<br />		.ERR<br />	ENDIF<br />	call funcname<br />ENDM<br /><br />; #########################################################################<br />; INLINESTR MACRO<br /><br />InlineStr MACRO Quoted_Text&#58;VARARG<br />	LOCAL Local_Text<br />	DATA segment<br />		ALIGN 4<br />		Local_Text db Quoted_Text,0<br />		ALIGN 4<br />	DATA ends<br />	EXITM &lt;OFFSET Local_Text&gt;<br />ENDM<br /><br />; #########################################################################<br />; IMPLEMENTCFUNC MACRO<br /><br />ImplementCFunc MACRO linkto&#58;REQ, numargs&#58;REQ, args&#58;VARARG<br />	LOCAL Temp,Pos<br />	LOCAL BuildStr,ArgIter,CharIter,Count<br /><br />	IF numargs EQ 0 ;; function call w/ no args<br />		stcall linkto, numargs, 0<br />	ELSE<br />		BuildStr TEXTEQU &lt;&gt;<br />		Count = 0<br />		FOR ArgIter&#58;REQ, &lt;args&gt;<br />			Temp TEXTEQU &lt;ArgIter&gt;<br />			Count = Count + 1<br /><br />			;; strip opening parenth from function call<br />			IF Count EQ 1<br />				Temp TEXTEQU @SubStr&#40; &lt;%Temp&gt;, 2 &#41;<br />			ENDIF<br />			;; strip closing parenth from function call<br />			IF Count EQ numargs<br />				Temp TEXTEQU @SubStr&#40; &lt;%Temp&gt;, 1, @SizeStr&#40;&lt;%Temp&gt;&#41;-1 &#41;<br />			ENDIF<br />			<br />			;; strip leading spaces from params &#40;if any&#41;<br />%			FORC CharIter, &lt;Temp&gt;<br />				IFIDN &lt;CharIter&gt;, &lt; &gt;<br />					Temp TEXTEQU @SubStr&#40; &lt;%Temp&gt;, 2 &#41;<br />				ELSE<br />					EXITM<br />				ENDIF<br />			ENDM<br /><br />			;; check for string and declare if needed<br />%			FORC CharIter, &lt;Temp&gt;<br />				IFIDN &lt;CharIter&gt;, &lt;&quot;&gt;<br />					Temp TEXTEQU @CatStr&#40; &lt;InlineStr!&#40;&gt;, &lt;%Temp&gt;, &lt;!&#41;&gt; &#41;<br />				ELSEIFIDN &lt;CharIter&gt;, &lt;&amp;&gt;<br />					Temp TEXTEQU @CatStr&#40; &lt;ADDR &gt;, &lt;@SubStr&#40;&lt;%Temp&gt;,2&#41;&gt; &#41;<br />				ENDIF<br />				EXITM<br />			ENDM<br /><br />			BuildStr TEXTEQU @CatStr&#40; &lt;%BuildStr,&gt;, &lt;%Temp&gt; &#41;<br />		ENDM<br /><br />%		stcall linkto,numargs&amp;BuildStr<br />	ENDIF<br />ENDM<br /><br />; #########################################################################<br />; DEFINECFUNC MACRO<br /><br />DefineCFunc MACRO funcname&#58;REQ, linkto&#58;REQ, numargs&#58;REQ<br />	EXTERNDEF linkto&#58;PROC<br />	funcname MACRO args&#58;VARARG<br />		ImplementCFunc linkto, numargs, args<br />	ENDM<br />ENDM<br /><br />; #########################################################################<br /></code></pre><br /><br />:notsure: Goes in the other inc's (examples)<br />Note: You should comment out the regular declarations to prevent dup errors<br /><br />User32.inc<br /><pre><code><br />DefineCFunc	MessageBox, MessageBoxA@16, 4<br /></code></pre><br /><br />Kernel32.inc<br /><pre><code><br />DefineCFunc	ExitProcess, ExitProcess@4, 1<br /></code></pre><br /><br />With these mods, it allows more C like calls in your code (if you really want this kinda thing).<br />Modified minimum.asm code from examples.<br /><pre><code><br />; #########################################################################<br /><br />	.386<br />	.model flat, stdcall<br />	option casemap &#58;none   ; case sensitive<br /><br />; #########################################################################<br /><br />	include \masm32\include\windows.inc<br />	include \masm32\include\user32.inc<br />	include \masm32\include\kernel32.inc<br /><br />	includelib \masm32\lib\user32.lib<br />	includelib \masm32\lib\kernel32.lib<br /><br />; #########################################################################<br /><br />	.code<br /><br />start&#58;<br />	jmp @F<br />		szMsg         db &quot;Assembler Pure and Simple&quot;, 0<br />	@@&#58;<br /><br />	MessageBox&#40; 0, &quot;Minimum MASM&quot;, &amp;szMsg, MB_OK &#41;<br />	ExitProcess&#40; 0 &#41;<br />end start<br /></code></pre><br /><br />I plan on piddling with this some more so perhaps its not quite done yet.  Oh yeah.<br />I have shamelessly cut and pasted some of the open source code from the board<br />to get this working.  I do not have the original authors names so please excuse me<br />if your not properly credited for any snipplits that are yours.<br /><br />The only new macro of interest that I filled in with is ImplementCFunc.<br /><br />Enjoy.<br />:alright:</div>
    <div class="meta">Posted on 2004-04-17 10:16:25 by Graebel</div>
   </div>
   <div class="post" id="post-139237">
    <div class="subject"><a href="#post-139237">Revisited: C like calls</a></div>
    <div class="body">Hi,<br /><br />So look like you are one that looked into my suggestion :grin:<br />Take a look at <br /><br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=17566">http://www.asmcommunity.net/board/index.php?topic=17566</a></div>
    <div class="meta">Posted on 2004-04-17 10:22:45 by roticv</div>
   </div>
   <div class="post" id="post-139253">
    <div class="subject"><a href="#post-139253">Revisited: C like calls</a></div>
    <div class="body">Ahha!  I knew that post was somewhere.  Thanks for the link back =) just couldnt find it.<br /><br />Once I figured out what the parser was doing, it wasnt really too hard to implement.  I dont think I will personally use this, but who knows.  If it can be extended enough it might not be so bad.  A completely customizable language even down to the parser rules and operators would rock =)</div>
    <div class="meta">Posted on 2004-04-17 11:51:15 by Graebel</div>
   </div>
   <div class="post" id="post-139291">
    <div class="subject"><a href="#post-139291">Revisited: C like calls</a></div>
    <div class="body">Graebel,<br /><br />Dou you need any extra information about the stcall macro? :)</div>
    <div class="meta">Posted on 2004-04-18 03:55:54 by Vortex</div>
   </div>
   <div class="post" id="post-139384">
    <div class="subject"><a href="#post-139384">Revisited: C like calls</a></div>
    <div class="body">Noop,<br />I know exactly what its doing and why.  Just didnt see a need to reinvent the wheel... 8)</div>
    <div class="meta">Posted on 2004-04-18 20:04:04 by Graebel</div>
   </div>
  </div>
 </body>
</html>