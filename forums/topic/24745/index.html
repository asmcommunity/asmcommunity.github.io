<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Searching for SATA serial number - why DeviceIoControl failed? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=24745" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=12">The Heap</a> &raquo; <a href="../?id=24745">Searching for SATA serial number - why DeviceIoControl failed?</a></p>
   <div class="post" id="post-180753">
    <div class="subject"><a href="#post-180753">Searching for SATA serial number - why DeviceIoControl failed?</a></div>
    <div class="body">Searching for SATA serial number - why DeviceIoControl failed?<br /><br />I use the following code to get hard disk serial number. But with some disks (SATA)this code failed. Do you know why?<br />What should I use instead of DFP_GET_VERSION?<br />1.First way:<br /><sup><br />…<br />#define&nbsp; DFP_GET_VERSION&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x00074080<br />typedef struct _GETVERSIONOUTPARAMS<br />{<br />&nbsp;  BYTE bVersion;&nbsp; &nbsp; &nbsp; // Binary driver version.<br />&nbsp;  BYTE bRevision;&nbsp; &nbsp;  // Binary driver revision.<br />&nbsp;  BYTE bReserved;&nbsp; &nbsp;  // Not used.<br />&nbsp;  BYTE bIDEDeviceMap; // Bit map of IDE devices.<br />&nbsp;  DWORD fCapabilities; // Bit mask of driver capabilities.<br />&nbsp;  DWORD dwReserved[4]; // For future use.<br />} GETVERSIONOUTPARAMS, *PGETVERSIONOUTPARAMS, *LPGETVERSIONOUTPARAMS;<br />…<br />char driveName [256];<br />sprintf (driveName, &quot;\\\\.\\PhysicalDrive%d&quot;, drive);<br />hPhysicalDriveIOCTL = CreateFile (driveName,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GENERIC_READ | GENERIC_WRITE, <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  FILE_SHARE_READ | FILE_SHARE_WRITE , NULL,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  OPEN_EXISTING, 0, NULL);<br />if (hPhysicalDriveIOCTL != INVALID_HANDLE_VALUE)<br />{<br />&nbsp; &nbsp; GETVERSIONOUTPARAMS VersionParams;<br />&nbsp; &nbsp; DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  cbBytesReturned = 0;<br />&nbsp; &nbsp; memset ((void*) &amp;VersionParams, 0, sizeof(VersionParams));<br />&nbsp; &nbsp; if ( ! <strong>DeviceIoControl</strong> (hPhysicalDriveIOCTL, DFP_GET_VERSION,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  NULL, 0, &amp;VersionParams, sizeof(VersionParams),&nbsp;  &amp;cbBytesReturned, NULL) )<br />&nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; &nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // printf (&quot;DFP_GET_VERSION failed for drive %d\n&quot;, i);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  // continue;<br />&nbsp; &nbsp; &nbsp; &nbsp; }<br />...<br /></sup><br /><br />2. Second way:<br /><sup><br />…<br />typedef enum _STORAGE_QUERY_TYPE {<br />&nbsp; &nbsp; 	PropertyStandardQuery = 0,<br />&nbsp; &nbsp; 	PropertyExistsQuery,<br /> 	PropertyMaskQuery,&nbsp; &nbsp;  <br />PropertyQueryMaxDefined<br />} STORAGE_QUERY_TYPE, *PSTORAGE_QUERY_TYPE;<br /><br /><br />typedef enum _STORAGE_PROPERTY_ID {<br />&nbsp; &nbsp; StorageDeviceProperty = 0,<br />&nbsp; &nbsp; StorageAdapterProperty<br />} STORAGE_PROPERTY_ID, *PSTORAGE_PROPERTY_ID;<br /><br />typedef struct _STORAGE_PROPERTY_QUERY {<br />&nbsp; &nbsp; STORAGE_PROPERTY_ID PropertyId;<br />&nbsp; &nbsp; STORAGE_QUERY_TYPE QueryType;<br />&nbsp; &nbsp; UCHAR AdditionalParameters[1];<br />} STORAGE_PROPERTY_QUERY, *PSTORAGE_PROPERTY_QUERY;<br />#define IOCTL_STORAGE_QUERY_PROPERTY&nbsp;  CTL_CODE(IOCTL_STORAGE_BASE, 0x0500, METHOD_BUFFERED, FILE_ANY_ACCESS)<br />…<br />char driveName [256];<br />sprintf (driveName, &quot;\\\\.\\PhysicalDrive%d&quot;, drive);<br />hPhysicalDriveIOCTL = CreateFile (driveName, 0,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  FILE_SHARE_READ | FILE_SHARE_WRITE, NULL,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  OPEN_EXISTING, 0, NULL);<br />if (hPhysicalDriveIOCTL != INVALID_HANDLE_VALUE)<br />{<br />STORAGE_PROPERTY_QUERY query;<br />&nbsp; &nbsp; &nbsp; DWORD cbBytesReturned = 0;<br />	char buffer [10000];<br /><br />&nbsp; &nbsp; &nbsp; memset ((void *) &amp; query, 0, sizeof (query));<br />	query.PropertyId = StorageDeviceProperty;<br />	query.QueryType = PropertyStandardQuery;<br />&nbsp; &nbsp; &nbsp; memset (buffer, 0, sizeof (buffer));<br /><br />if ( <strong>DeviceIoControl </strong> (hPhysicalDriveIOCTL, IOCTL_STORAGE_QUERY_PROPERTY, &amp;query, sizeof (query), &amp;buffer,&nbsp; &nbsp; sizeof (buffer), &amp; cbBytesReturned, NULL) )<br />&nbsp; &nbsp; &nbsp; {&nbsp; &nbsp; &nbsp; &nbsp;  <br />STORAGE_DEVICE_DESCRIPTOR * descrip = (STORAGE_DEVICE_DESCRIPTOR *) &amp;buffer;<br />….<br /></sup><br />3. Third way<br /><sup><br />…<br />char&nbsp;  driveName [256];<br />sprintf (driveName, &quot;\\\\.\\Scsi%d:&quot;, controller);<br />hScsiDriveIOCTL = CreateFile (driveName,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  GENERIC_READ | GENERIC_WRITE, <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  FILE_SHARE_READ | FILE_SHARE_WRITE, NULL,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  OPEN_EXISTING, 0, NULL);<br />if (hScsiDriveIOCTL != INVALID_HANDLE_VALUE)<br />{<br />&nbsp;  int drive = 0;<br />&nbsp;  for (drive = 0; drive &lt; 2; drive++)<br />&nbsp;  {<br />&nbsp; &nbsp; &nbsp;  char buffer ;<br />&nbsp; &nbsp; &nbsp;  SRB_IO_CONTROL *p = (SRB_IO_CONTROL *) buffer;<br />&nbsp; &nbsp; &nbsp;  SENDCMDINPARAMS *pin =<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  (SENDCMDINPARAMS *) (buffer + sizeof (SRB_IO_CONTROL));<br />&nbsp; &nbsp; &nbsp;  DWORD dummy;<br />&nbsp; &nbsp; &nbsp;  memset (buffer, 0, sizeof (buffer));<br />&nbsp; &nbsp; &nbsp;  p -&gt; HeaderLength = sizeof (SRB_IO_CONTROL);<br />&nbsp; &nbsp; &nbsp;  p -&gt; Timeout = 10000;<br />&nbsp; &nbsp; &nbsp;  p -&gt; Length = SENDIDLENGTH;<br />&nbsp; &nbsp; &nbsp;  p -&gt; ControlCode = IOCTL_SCSI_MINIPORT_IDENTIFY;<br />&nbsp; &nbsp; &nbsp;  strncpy ((char *) p -&gt; Signature, &quot;SCSIDISK&quot;, 8);<br />&nbsp; &nbsp; &nbsp;  pin -&gt; irDriveRegs.bCommandReg = IDE_ATA_IDENTIFY;<br />&nbsp; &nbsp; &nbsp;  pin -&gt; bDriveNumber = drive;<br /><br />&nbsp; &nbsp; &nbsp;  if (<strong>DeviceIoControl</strong> (hScsiDriveIOCTL, IOCTL_SCSI_MINIPORT, <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  buffer,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  sizeof (SRB_IO_CONTROL) +<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  sizeof (SENDCMDINPARAMS) - 1,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  buffer,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  sizeof (SRB_IO_CONTROL) + SENDIDLENGTH,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &amp;dummy, NULL))<br />}<br />...<br /></sup><br /><br />I know that my device has got serial number because other program (aida) find it.<br /></div>
    <div class="meta">Posted on 2006-05-18 05:21:06 by adamrogoz</div>
   </div>
   <div class="post" id="post-180755">
    <div class="subject"><a href="#post-180755">Re: Searching for SATA serial number - why DeviceIoControl failed?</a></div>
    <div class="body">There are people here proficient in c/c++ code.But since this is an ASM board, I would tend to think that you would be better off posting your code and questions about it on a C/C++ board.<br />Rags</div>
    <div class="meta">Posted on 2006-05-18 07:42:06 by rags</div>
   </div>
   <div class="post" id="post-180757">
    <div class="subject"><a href="#post-180757">Re: Searching for SATA serial number - why DeviceIoControl failed?</a></div>
    <div class="body">It&#39;s a fine enough question to post on this board, considering it&#39;s low-level nature. But since the code is C, I&#39;ve moved the topic to The Heap.<br /><br />The closest I&#39;ve come with a quick google search was this: http://forums.wugnet.com/windows/DiskId32-SATA-drives-ftopict435387.html . Perhaps you can email Lynn and ask how he got it to work? (And post your results here :) )</div>
    <div class="meta">Posted on 2006-05-18 07:53:36 by f0dder</div>
   </div>
  </div>
 </body>
</html>