<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Crashy Crashy Win32 Socket Under Load - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=6066" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=8">Networking</a> &raquo; <a href="../?id=6066">Crashy Crashy Win32 Socket Under Load</a></p>
   <div class="post" id="post-43445">
    <div class="subject"><a href="#post-43445">Crashy Crashy Win32 Socket Under Load</a></div>
    <div class="body">Heya all.<br />I am having issues with a client I'm coding for IRC.<br />The problem relates to flooding of a single socket connection.<br />Some IRC commands can generate a lot of packets quite fast.<br />My application falls over when this happens.<br /><br />Here is the source of my socket read procedure, called from the FD_READ handler. If you can see any obvious problems with this implementation, I'd love to hear your suggestions.<br />I wanted to try not to use a state-based procedure, because I am unsure of the asynchronicity of IRC servers in their replies, ie, what is the likelihood of getting some arbitrary message in the middle of a larger reply, say a PING during a /LIST ??<br />Please try this app, login to IRC and type /LIST (ENTER) and u will see the problem I refer to.<br /><br />;This procedure globally allocates a chunk of memory for data,<br />;then reads the data into it, character by character.<br />;It seeks to find complete lines terminated by linefeeds,<br />;and won't act iuntil it has a complete line.<br />;In this manner it can handle lines split over two or more packets,<br />;should an incomplete line be issued on the end of a packet.<br /><br />ReadData PROC<br />LOCAL sizetoread:DWORD<br />LOCAL mHandle:DWORD         ;Handle to our allocated memory<br />LOCAL buffer:DWORD          ;Pointer to the same<br />LOCAL outbuf[256]:BYTE<br />                    szText szData,&quot;Incoming %lu&quot;<br />                invoke ioctlsocket,hMommaSocket,FIONREAD,addr sizetoread  ; Check the number of bytes available to read from the socket                <br />Moore:<br />                mov eax,sizetoread<br />                inc eax<br />                push eax<br />                invoke GlobalAlloc,GHND,eax      ; allocate memory enough for the data to read from the socket<br />                mov mHandle,eax<br />                invoke GlobalLock,eax<br />                mov buffer,eax<br />                pop eax<br />                invoke RtlZeroMemory,buffer,eax<br />                invoke recv,hMommaSocket,buffer,sizetoread,0    ; Read the data from the socket<br />                .if eax!=SOCKET_ERROR<br />                        sub sizetoread,eax              ; Save the actual number of bytes read from the socket<br />                                                        ; BEWARE! The value returned from ioctlsocket and the actual number of bytes<br />                                                        ; read in from the socket are not always equal.<br />                        push eax<br />                        invoke RtlZeroMemory,addr lilbuf,sizeof lilbuf<br />                        pop eax<br />                        invoke wsprintf,addr lilbuf,addr szData,eax<br />                        invoke SendMessage,hStatus,SB_SETTEXT,0,ADDR lilbuf <br /><br />                        lea edi,linebuffer<br />                        .while byte ptr!=0         ;skip possible incomplete line<br />                            inc edi                     ;leftover from end of last packet<br />                        .endw<br />                        <br />                        mov esi,buffer<br />                        push edi<br />                        .while byte ptr!=0<br />                            .if byte ptr==13       ;Ignore Carriage Returns (skip em)<br />                                inc esi<br />                            .else<br />                                mov al,byte ptr<br />                                mov byte ptr,al<br />                                inc esi<br />                                inc edi<br />                                .if al==10        ;We have a complete line (includes LineFeed)<br />                                    mov byte ptr,0<br /><br />                                    szText findme1,&quot;NOTICE AUTH&quot;<br />                                    szText findme2,&quot; 001 %s&quot;<br />                                    szText findme3,&quot; 002 %s&quot;<br />                                    szText findme4,&quot; 003 %s&quot;<br />                                    szText findme5,&quot; 004 %s&quot;<br />                                    szText findme6,&quot; 005 %s&quot;<br />                                    szText findme7,&quot; 251 %s&quot;<br />                                    szText findme8,&quot; 252 %s&quot;<br />                                    szText findme9,&quot; 254 %s&quot;<br />                                    szText findmea,&quot; 255 %s&quot;<br />                                    szText findmeb,&quot; 266 %s&quot;<br />                                    szText findmec,&quot; 372 %s&quot;<br />                                    szText findme1a,&quot;%s MODE %s&quot;<br />                                    szText findme1b,&quot;NOTICE %s&quot;                                    <br />                                    szText ChanName,&quot; 322 %s &quot;<br />                                    szText szPing,&quot;PING &quot;<br />                                    szText szPong,&quot;PONG &quot;<br /><br />                                    invoke RtlZeroMemory,addr lilbuf,sizeof lilbuf<br />                                    invoke wsprintf,addr lilbuf,addr szPing,addr NickName<br />                                    invoke InString,1,addr linebuffer,addr lilbuf<br />                                    .if eax!=0<br />                                        add eax,4<br />                                        lea edi,linebuffer<br />                                        add edi,eax<br />                                        push edi<br />                                        invoke RtlZeroMemory,addr outbuf,sizeof outbuf<br />                                        invoke lstrcat,addr outbuf,addr szPong<br />                                        pop edi<br />                                        invoke lstrcat,addr outbuf,edi<br />                                        invoke lstrlen,addr outbuf<br />                                        invoke send,hMommaSocket,addr outbuf,eax,0<br />                                        jmp my2                                        <br />                                    .endif<br /><br />                                   invoke RtlZeroMemory,addr lilbuf,sizeof lilbuf<br />                                    invoke wsprintf,addr lilbuf,addr findme1b,addr NickName<br />                                    invoke InString,1,addr linebuffer,addr lilbuf<br />                                    .if eax!=0<br />                                        jmp matched<br />                                    .endif<br /><br />                                    invoke InString,1,addr linebuffer,addr findme1<br />                                    .if eax!=0<br />                                        invoke SendMessage,hRichEd,EM_SETCHARFORMAT,SCF_SELECTION,addr charformat01<br />                                        lea edi,linebuffer<br />                                        inc edi<br />                                        .while byte ptr!=&quot;:&quot;<br />                                            inc edi<br />                                        .endw<br />                                        jmp my2<br />                                    .endif<br />                                                                        <br />                                    invoke RtlZeroMemory,addr lilbuf,sizeof lilbuf<br />                                    invoke wsprintf,addr lilbuf,addr findme2,addr NickName<br />                                    invoke SendMessage,hRichEd,EM_SETCHARFORMAT,SCF_SELECTION,addr charformat02<br />                                    invoke InString,1,addr linebuffer,addr lilbuf<br />                                    .if eax!=0<br />                                        lea edi,linebuffer                                    <br />                                        jmp matched<br />                                    .endif<br />                                    <br />                                    invoke RtlZeroMemory,addr lilbuf,sizeof lilbuf<br />                                    invoke wsprintf,addr lilbuf,addr findme3,addr NickName<br />                                    invoke InString,1,addr linebuffer,addr lilbuf<br />                                    .if eax!=0<br />                                        jmp matched<br />                                    .endif<br /><br />                                    invoke RtlZeroMemory,addr lilbuf,sizeof lilbuf<br />                                    invoke wsprintf,addr lilbuf,addr findme4,addr NickName<br />                                    invoke InString,1,addr linebuffer,addr lilbuf<br />                                    .if eax!=0<br />                                        jmp matched<br />                                    .endif<br /><br />                                    invoke RtlZeroMemory,addr lilbuf,sizeof lilbuf<br />                                    invoke wsprintf,addr lilbuf,addr findme5,addr NickName<br />                                    invoke InString,1,addr linebuffer,addr lilbuf<br />                                    .if eax!=0<br />                                        jmp matched<br />                                    .endif<br /><br />                                    invoke RtlZeroMemory,addr lilbuf,sizeof lilbuf<br />                                    invoke wsprintf,addr lilbuf,addr findme6,addr NickName<br />                                    invoke InString,1,addr linebuffer,addr lilbuf<br />                                    .if eax!=0<br />                                        jmp matched<br />                                    .endif<br /><br />                                    invoke RtlZeroMemory,addr lilbuf,sizeof lilbuf<br />                                    invoke wsprintf,addr lilbuf,addr findme7,addr NickName<br />                                    invoke InString,1,addr linebuffer,addr lilbuf<br />                                    .if eax!=0<br />                                        jmp matched<br />                                    .endif<br /><br />                                    invoke RtlZeroMemory,addr lilbuf,sizeof lilbuf<br />                                    invoke wsprintf,addr lilbuf,addr findme8,addr NickName<br />                                    invoke InString,1,addr linebuffer,addr lilbuf<br />                                    .if eax!=0<br />                                        jmp matched<br />                                    .endif<br />                                    <br /><br />                                    invoke RtlZeroMemory,addr lilbuf,sizeof lilbuf<br />                                    invoke wsprintf,addr lilbuf,addr findme9,addr NickName<br />                                    invoke InString,1,addr linebuffer,addr lilbuf<br />                                    .if eax!=0<br />                                        jmp matched<br />                                    .endif<br /><br />                                    invoke RtlZeroMemory,addr lilbuf,sizeof lilbuf<br />                                    invoke wsprintf,addr lilbuf,addr findmea,addr NickName<br />                                    invoke InString,1,addr linebuffer,addr lilbuf<br />                                    .if eax!=0<br />                                        jmp matched<br />                                    .endif<br /><br />                                    invoke RtlZeroMemory,addr lilbuf,sizeof lilbuf<br />                                    invoke wsprintf,addr lilbuf,addr findmeb,addr NickName<br />                                    invoke InString,1,addr linebuffer,addr lilbuf<br />                                    .if eax!=0<br />                                        jmp matched<br />                                    .endif<br /><br />                                    invoke RtlZeroMemory,addr lilbuf,sizeof lilbuf<br />                                    invoke wsprintf,addr lilbuf,addr findme1a,addr NickName,addr NickName<br />                                    invoke InString,1,addr linebuffer,addr lilbuf<br />                                    .if eax!=0<br />                                        mov LoggedIn,1<br />                                        jmp matched<br />                                    .endif<br /><br /><br />                                    invoke RtlZeroMemory,addr lilbuf,sizeof lilbuf<br />                                    invoke wsprintf,addr lilbuf,addr findmec,addr NickName<br />                                    invoke InString,1,addr linebuffer,addr lilbuf<br />                                    .if eax!=0<br />                                        jmp matched<br />                                    .endif<br />                                    <br /><br />                                    <br /><br />                            ;*** What to do with an unrecognized line<br />                                    lea edi,linebuffer<br />                                    jmp my2<br /><br /><br /><br /><br />                                                                <br />matched:                               push eax<br />                                        mov ecx,charformat02.yHeight<br />                                        mov edx,ecx                    ;reduce current size by<br />                                        shr edx,6                      ;1/64 of current size<br />                                        sub ecx,edx<br />                                        mov charformat02.yHeight,ecx<br /><br />                                        ;//Fade Text Color<br />                                        mov ecx,charformat02.crTextColor  <br />                                        mov ebx,ecx                    ;Split into RGB bytes<br />                                        shr ebx,4                      ;divide each by 16<br />                                        mov al,bl                      ;and subtract from current ie<br />                                        and al,15                      ;color=color-(color/16)<br />                                        shl eax,8<br />                                        shr ebx,8<br />                                        mov al,bl<br />                                        and al,15<br />                                        shl eax,8<br />                                        shr ebx,8<br />                                        mov al,bl<br />                                        and al,15<br />                                        mov ebx,eax<br />                                        sub ecx,ebx<br />                                        mov charformat02.crTextColor,ecx<br />                                        <br /><br />                                        pop ebx<br />                                        invoke lstrlen,addr lilbuf<br />                                        add eax,ebx<br />                                        lea edi,linebuffer<br />                                        add edi,eax<br />my2:                                     .if byte ptr==&quot;:&quot;<br />                                            inc edi<br />                                        .endif<br />                                        invoke SendMessage,hRichEd,EM_GETLINECOUNT,0,0<br />                                        invoke SendMessage,hRichEd,EM_LINEINDEX,eax,0<br />                                        invoke SendMessage,hRichEd,EM_SETSEL,eax,-1<br />                                        invoke SendMessage,hRichEd,EM_REPLACESEL,0,edi<br />                                        jmp owt<br /><br /><br />owt:                                invoke RtlZeroMemory,addr linebuffer,sizeof linebuffer<br />                                    lea edi,linebuffer                                    <br />                                    <br />                                .endif<br />                             .endif<br />                         .endw<br />                         pop edi<br /><br /><br />                        invoke GlobalUnlock,buffer<br />                        invoke GlobalFree,mHandle<br />                .endif<br />                .if sizetoread!=0<br />                    <br />                    jmp Moore<br />                .endif<br />        ret<br />ReadData ENDP</div>
    <div class="meta">Posted on 2002-06-15 12:45:01 by Homer</div>
   </div>
   <div class="post" id="post-43453">
    <div class="subject"><a href="#post-43453">Crashy Crashy Win32 Socket Under Load</a></div>
    <div class="body">Well I must have been tired - I forgot to post the link to the executable !! Silly Homer.<br /><a target="_blank" href="http://s-a-l-l-y.com/files/YRCBeta.rar">Here 'Tis</a></div>
    <div class="meta">Posted on 2002-06-15 16:05:48 by Homer</div>
   </div>
  </div>
 </body>
</html>