<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Suggestions for a macro - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=5441" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=5441">Suggestions for a macro</a></p>
   <div class="post" id="post-38690">
    <div class="subject"><a href="#post-38690">Suggestions for a macro</a></div>
    <div class="body">Thius is a question mainly for BiTRAKE, I have the following macro working but its clunky because it requires an extra comma (,)<br /><pre><code><br />    ASM MACRO inst1,inst2,inst3<br />      inst1 inst2,inst3<br />    EXITM &lt;inst2&gt;<br />    ENDM<br /></code></pre><br />It works OK and can be used with other mnemonics but what I am after is being able to pass TWO parameters to the macro so it can be used with the normal asm syntax.<br /><pre><code><br />    mov eax, ASM&#40;mov edx, 1&#41;<br /></code></pre><br />MOV EAX being parameter one and the second parameter being whatever is required for the instruction.<br /><br />I forget how to do the parsing of the first parameter so that it seperates the MOV from the EAX component on the basis of the seperating space between them.<br /><br />Any suggestions that will work here will be appreciated as I want it for a code wizard that I have more or less finished.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-05-17 07:21:53 by hutch--</div>
   </div>
   <div class="post" id="post-38694">
    <div class="subject"><a href="#post-38694">Suggestions for a macro</a></div>
    <div class="body">Something like this should work:<pre><code>ASM MACRO val&#58;VARARG<br />	LOCAL a,b,y<br /><br />%	val ;; execute passed instruction<br /><br />	;; pry out the destination parameter<br />	a INSTR 1,&lt;&amp;val&gt;,&lt;! &gt;<br />	IF a EQ 0<br />		;; could assume EAX?<br />		.ERR &lt;burp!&gt;<br />	ELSE<br />		;; trim instruction and space<br />		y TEXTEQU @SubStr&#40;&lt;&amp;val&gt;,a+1,&#41;	;; dest&#40;?,source&#41;<br /><br />		b INSTR a+1,&lt;&amp;val&gt;,&lt;!,&gt;<br />		IF b NE 0<br />			;; trim off source and comma<br />			y TEXTEQU @SubStr&#40;&lt;&amp;val&gt;,a+1,b-a-1&#41; ;; dest<br />		ENDIF<br />	ENDIF<br />	EXITM y ; return destination<br />ENDM</code></pre>This allows for instructions of one or more operands.<br /><br /><strong>Edit</strong>: <span style="font-size:9px>fixed and</span> Tested!</div>
    <div class="meta">Posted on 2002-05-17 08:31:54 by bitRAKE</div>
   </div>
   <div class="post" id="post-38695">
    <div class="subject"><a href="#post-38695">Suggestions for a macro</a></div>
    <div class="body">OK,<br /><br />I have the following working, its for normal 2 argument instructions and it sems to do what it is supposed to do.<br /><pre><code><br />    ASM MACRO parameter1,parameter2<br />      LOCAL mnemonic<br />      LOCAL arg1<br />      LOCAL poz<br /><br />      % poz INSTR 1,&lt;parameter1&gt;,&lt; &gt;             ;; get the space position<br />      % mnemonic SUBSTR &lt;parameter1&gt;, 1, poz-1   ;; get the mnemonic<br />      % arg1 SUBSTR &lt;parameter1&gt;, poz+1          ;; get the first argument<br /><br />      mnemonic arg1, parameter2<br /><br />      EXITM &lt;arg1&gt;<br />    ENDM<br /></code></pre><br />I will have a play with the version you have posted, it looks interesting.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-05-17 08:44:24 by hutch--</div>
   </div>
   <div class="post" id="post-38723">
    <div class="subject"><a href="#post-38723">Suggestions for a macro</a></div>
    <div class="body">With a slight change my macro could return EAX if instruction is INVOKE. :)  This is a very cool idea <strong>Hutch--</strong> - thanks for bringing it to attention.<br /><br />sub ebx, ASM(pop eax)<br />and ebx, ASM(shld edx,eax,cl)<br /><br />It's not very good for speed optimization, but I'm hoping that gets fixed in the next version of MASM. ;)  Should be able to nest 24 level deep, iirc.</div>
    <div class="meta">Posted on 2002-05-17 13:03:43 by bitRAKE</div>
   </div>
   <div class="post" id="post-38730">
    <div class="subject"><a href="#post-38730">Suggestions for a macro</a></div>
    <div class="body">I like the idea as well hutch.  Its a good one ;)<br /><br />I noticed bitRake Likes small variable names ;) , So Im posting this as well as extra reference.  Its from the Console Window program i E-Mailled you about a while ago.  Its was written for Quages to follow, so im sure you should have no problem ;)<br /><pre><code>; %#%#%#%#%#%#%#%#%#%#%#%#%#%#%#%<br />; %&amp;  THis macro will take an input string like&#58;<br />; %&amp;  <br />; %&amp;  ON Exit THEN Do_Exit<br />; %&amp;  <br />; %&amp;  And produce the code&#58;<br />; %&amp;  <br />; %&amp;  .data<br />; %&amp;    UniqueName db &quot;Exit&quot;,0<br />; %&amp;  .code<br />; %&amp;  <br />; %&amp;  invoke StringCompare, addr UniqueName<br />; %&amp;  jz Do_Exit<br />; %&amp;  <br />; %#%#%#%#%#%#%#%#%#%#%#%#%#%#%#%#%#%<br />ON MACRO CommandString&#58;REQ<br />   LOCAL chop1, chop2, P1, NewName<br />   <br />%  P1 equ @InStr&#40;1,&lt;CommandString&gt;,&lt;THEN &gt;&#41;       ; Look for the word 'THEN'<br />   IFE P1 eq 0                                    ; If P1 is NOT zero &#40;IFE&#41;<br />     Chop1 SUBSTR &lt;CommandString&gt;, 1, P1 - 2      ; Get the &quot;text&quot;<br />     Chop2 SUBSTR &lt;CommandString&gt;, P1 + 5         ; Move past &quot;THEN &quot;<br />       .data<br />         ; Place this into the data segment&#58;<br />%        NewName db @CatStr&#40; &lt;!&quot;&gt;,&lt;&amp;Chop1&gt;,&lt;!&quot;&gt;&#41; , 0<br />       .code<br />%    invoke StringCompare, addr NewName<br />%    jz Chop2<br />     <br />   ELSE<br />     .err &lt; NO 'THEN' FOUND, CAN'T PROCESS COMMANDS &gt;<br />   ENDIF<br />ENDM<br /></code></pre><br /><br /><br />My only suggestion to your idea is to trim off a letter from &quot;ASM&quot; to keep it as small as possible.  From exerience, it gets hard to manage alot of $invoke()'s in one line, mainly cause i run out of line space!!  ( You cant break them up into multiple lines ).<br /><br />My sugestion would be something like this:<br /><pre><code><br />&#91;b&#93;$$&#91;/b&#93; MACRO parameter1,parameter2<br />      LOCAL mnemonic<br />      LOCAL arg1<br />      LOCAL poz<br /><br />      % poz INSTR 1,&lt;parameter1&gt;,&lt; &gt;             ;; get the space position<br />      % mnemonic SUBSTR &lt;parameter1&gt;, 1, poz-1   ;; get the mnemonic<br />      % arg1 SUBSTR &lt;parameter1&gt;, poz+1          ;; get the first argument<br /><br />      mnemonic arg1, parameter2<br /><br />      EXITM &lt;arg1&gt;<br />    ENDM<br /></code></pre><br /><br />And :<br /><pre><code><br />$I MACRO args&#58;VARARG<br />      invoke args<br />      EXITM &lt;eax&gt;<br />    ENDM<br /></code></pre><br /><br />This way its quick to type $$() is easy, since ASM could get fumbled itno AMS and overlooked (i do stuff like this alot).  As well its Quite short, so you can fill your string space with more important information, like long API names ;) .  As well using $I() is just as simple and will perform the invoke, with out needing to have the word &quot;invoke&quot; as a mnemonic (which wastes space).<br /><br />Just my 2 Cents ;)  (I know you asked bitRake first)<br />:NaN:</div>
    <div class="meta">Posted on 2002-05-17 14:20:10 by NaN</div>
   </div>
   <div class="post" id="post-38752">
    <div class="subject"><a href="#post-38752">Suggestions for a macro</a></div>
    <div class="body"><strong>NaN</strong>, I'm sure <strong>Hutch--</strong> and I both appreciate your input.  Yeah, I use short names on local labels - makes changes easier, and forces me to document where needed.<br /><br />Please, note I've fixed and tested the macro above, now that I'm home.  When there are a small number of them, I can keep them all in my head and find outlining control flow more important.  I wasn't too far off: one error in logic, one error in syntax.<br /><br />Try this:<br />push ASM(sub eax, ASM(and ebx, ASM(shld edx,eax,cl)))</div>
    <div class="meta">Posted on 2002-05-17 19:31:38 by bitRAKE</div>
   </div>
   <div class="post" id="post-38760">
    <div class="subject"><a href="#post-38760">Suggestions for a macro</a></div>
    <div class="body">Nan,<br /><br />Your contribution is more than welcome, the problem is with me is that I usually do my parsing in a very grunty dialect of basic and to come back to the format of MASM macros takes a bit of adjustment to get it to work again. :)<br /><br />I already &quot;borrowed&quot; your $invoke macro because it was more efficient than the form I had written, renamed it FUNC to be consistent with the macro naming I have with the code wizards and I wanted ASM to be consistent with the existing naming.<br /><pre><code><br />    invoke DialogBoxParam,ASM&#40;mov hInstance,FUNC&#40;GetModuleHandle, NULL&#41;&#41;,100,0,<br />                          ASM&#40;mov eax,offset WndProc0&#41;,0<br /><br /></code></pre><br />About the only limitation I can find is that the macros don't like being split across lines and the &quot;\&quot; line join operator does not work with it. Maybe I am doing something wrong but I have not found a way around it yet.<br /><br />I have to work out if I can use Ricky's macro as I had in mind being able to use it like a function with 2 argument instructions where the destination being the result is placed in the context where it occurs.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-05-17 23:02:02 by hutch--</div>
   </div>
   <div class="post" id="post-38769">
    <div class="subject"><a href="#post-38769">Suggestions for a macro</a></div>
    <div class="body"><div class="quote"><em>Originally posted by hutch-- </em><br />About the only limitation I can find is that the macros don't like being split across lines and the &quot;\&quot; line join operator does not work with it. Maybe I am doing something wrong but I have not found a way around it yet. </div><br /><br />Not at all, this is a limitation i discovered a while ago.  Its a little disapointing, as due to API name lengths, you can run out of room (visually) quite quickly and not be able to &quot;nest&quot; deeper with these macros.  This is back to my point of keeping their names as small as possible.<br /><br />But i also realize it is *more* cryptic here :grin:<br /><br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-05-18 00:28:12 by NaN</div>
   </div>
  </div>
 </body>
</html>