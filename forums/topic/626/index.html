<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Error Description proc for M32lib - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=626" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=626">Error Description proc for M32lib</a></p>
   <div class="post" id="post-3727">
    <div class="subject"><a href="#post-3727">Error Description proc for M32lib</a></div>
    <div class="body"><pre><code><br />To use it as one of proc from masm32.lib&#58;<br />1. Save the code as file with .asm extention in<br />M32lib folder<br />2. Add string to masm32.inc in the folder&#58;<br />GetErrDescription PROTO &#58;DWORD<br />3. Run make.bat<br />=========<br />The proc is primary for developing and cathcing errors<br />it's easy to insert just a line of code calling it when something<br />going wrong to   get description of the error.<br />And it reasonably short &#40;though add couple bytes to .data<br />and fast.<br /><br />Here it is&#58;<br /><br />.586<br />.model flat,stdcall<br />option casemap&#58;none<br />include C&#58;\masm32\include\windows.inc<br />include C&#58;\masm32\include\kernel32.inc<br />include C&#58;\masm32\include\user32.inc<br /><br />;The Proc will produce MsgBox with Last error number and description<br />;==================================<br />;GetErrDescription, ErrNum if ErrNum = 0 the procedure call GetLastError to obtain LastErrorNumber<br />;If you already know the error number &#40;for Example WNetAddConnection2 return 0 on seccess and<br />;Error number when failes&#41; pass it as ErrNum<br />;Example&#58;<br />;invoke WNetAddConnection2,offset nr,offset Pass,0,CONNECT_UPDATE_PROFILE<br />;or eax,eax<br />;jne GetErr<br />;..... ;code if OK<br />;GetErr&#58;<br />; invoke GetErrDescription,eax <br />;===================================<br />;When you don't get the error code pass 0 as parameter<br />; Example&#58;<br />; invoke LocalFree,1234<br />;jne OK ;0 if error<br />;invoke GetErrDescription,eax ;eax=0<br />;OK&#58;<br />;==================================<br />.data<br />ErrMsgTmpl db 'Error Code %i',13,10<br />	     db 'Description&#58; %s',0<br />Unknown db 'UnKnownError',0<br />.code<br />GetErrDescription proc uses ebx edi ErrNum&#58;DWORD<br />LOCAL hLocal&#58;DWORD<br />LOCAL Buffer&#91;256&#93;&#58;BYTE<br /><br />	mov eax,ErrNum<br />	or eax,eax<br />	jne WeAlreadyKnowIt<br />	invoke GetLastError<br /><br />WeAlreadyKnowIt&#58;<br />	mov edi,eax<br />	invoke FormatMessage,FORMAT_MESSAGE_ALLOCATE_BUFFER or FORMAT_MESSAGE_FROM_SYSTEM,<br />		0, 		;GetItFromSystem<br />		edi,0, 		;ErrNum,Default language<br />		addr hLocal, 	;where to send the address of string from system<br />		0,0 		; any size, no arguments<br />		or eax,eax	;<br />	mov ebx,offset UnKnown<br />		je UnKnown<br />	invoke LocalLock,hLocal<br />	mov ebx,eax<br />UnKnown&#58;<br />	invoke wsprintf,addr Buffer,offset ErrMsgTmpl,edi,ebx<br />	invoke MessageBox,0,addr Buffer,0,0<br />	cmp ebx,offset UnKnown<br />	je @F<br />	invoke LocalFree,hLocal<br />@@&#58;<br />	ret<br />GetErrDescription endp<br />;=======================================<br />	end<br /></code></pre></div>
    <div class="meta">Posted on 2001-08-14 06:34:50 by The Svin</div>
   </div>
   <div class="post" id="post-3765">
    <div class="subject"><a href="#post-3765">Error Description proc for M32lib</a></div>
    <div class="body">Alex,<br /><br />I copied the proc and built it and it runs OK but I get an unusual result from it on success in the piece I tested with.<br /><br />            stralloc -1 ; 100000<br />            mov var, eax<br /><br />            ShowLastError<br />            ; invoke GetErrDescription, eax<br /><br />            strfree var<br /><br />I tested between the macro &quot;ShowlastError&quot; and the new module &quot;GetErrDescription&quot;.<br /><br />Both yield error 127 for the error but if I cange the memory alocation to a positive value, the MACRO returns error 0 SUCCESS where the proc returns error code 4259964<br />Description: SWh3@<br /><br />I don't know what is happening here.<br /><br />PS: I would post the file rather than the just the code as the PHP messes up the formatting in Netscape and its hard to read the file as it is copied .<br /><br />Regards,<br /><br /><a href="mailto:hutch@pbq.com.au">hutch@pbq.com.au</a></div>
    <div class="meta">Posted on 2001-08-14 14:37:30 by hutch--</div>
   </div>
   <div class="post" id="post-3794">
    <div class="subject"><a href="#post-3794">Error Description proc for M32lib</a></div>
    <div class="body">Steve, I'haven't quite understood you.<br />I think, it because of my English.<br />What do you mean by changing memory location?<br /><br />But at least I have couple things in mind to say.<br />The proc has some unusual approach -<br />it should be called only if an error occured.<br />Since it treat 0 in parameter as command to call<br />GetLastError itself, assuming that the calling code doesn't<br />retreave the error code yet (you know there are lots of APIs<br />func. that returned zero if failed and apps need to call<br />GetLastError to get exact code)<br />For the above it would never discribe any success codes<br />since they all have actually zero value.<br /><br />I'm not sure that it helps to your post, at least I tried to make a move in the darkness :)<br /><br />The other thing (not relative to your post - just thoughts about the proc) - there are ways to describe more errors actully then<br />from system.<br />1. Error code may have some values description on which is<br />in netmsg.dll (they all related to net and it means that you<br />can get some net related error descriptions from system but<br />some of them described only in netmsg.dll.<br /><br />2. There are also net messages descriptions you can only get through<br />WNetGetLastError function. but this means that to use<br />the proc use needs to include mpr.lib in the source.<br /><br />Anyway I can easily change the proc so that if Error Code is unkown to the system, it would try to get description from<br />netmsg.dll and through WNetGetLastError.<br /><br />What do you think?</div>
    <div class="meta">Posted on 2001-08-15 01:32:18 by The Svin</div>
   </div>
   <div class="post" id="post-3803">
    <div class="subject"><a href="#post-3803">Error Description proc for M32lib</a></div>
    <div class="body">I think, I can explain now.<br />There is actually such an error code, though I have no Idea what it means SWh :)<br />But if there were not such an error FormatMessage would have returned 0, but it didn't - I explicatly call it with 4259964 <br />as immediate parameter and it returned with the same result as you had.<br />Zero as parameter is treated by the proc as request for<br />the proc to call GetLastError<br />The last error was 0, and after that 4259964 set.<br />It did the proc comftable for myself :)<br />So if some function doesn't fail, dont call the proc.<br />Call it only when function upon return indicate that there was<br />errow (with 0 as parameter) or when you know the code<br />and can send it as immediate or if your code somehow obtained the code other then 0(success).</div>
    <div class="meta">Posted on 2001-08-15 04:59:26 by The Svin</div>
   </div>
  </div>
 </body>
</html>