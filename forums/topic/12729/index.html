<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>PIDL from path - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=12729" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=12729">PIDL from path</a></p>
   <div class="post" id="post-98414">
    <div class="subject"><a href="#post-98414">PIDL from path</a></div>
    <div class="body">This snipplet will extract the PIDL from a given path. You just pass a window handle and the address of a string containing a fully qualified path to the function and the PIDL is returned in eax. Others might find this useful for any place where you need a simple DWORD to identify a file, for me it has saved alot of space as I no longer have to store full paths in my proggy <pre><code>GetPIDLFromPath proc hWnd&#58;DWORD,pszObject&#58;DWORD<br />	LOCAL pShellFolder			&#58;DWORD<br />	LOCAL wsz&#91;MAX_PATH&#93;			&#58;WORD<br />	LOCAL Attribs				&#58;DWORD<br />	LOCAL Pidl&#91;32&#93;				&#58;DWORD<br />	LOCAL Eaten				&#58;DWORD<br />	LOCAL LibLoaded				&#58;DWORD<br /><br />	invoke CoInitialize,NULL<br />	mov LibLoaded,eax<br /><br />	invoke MultiByteToWideChar,CP_ACP,NULL,pszObject,-1,ADDR wsz,MAX_PATH<br />	invoke SHGetDesktopFolder,ADDR pShellFolder<br /><br />	lea eax,Attribs<br />	push eax<br />	lea eax,Pidl<br />	push eax<br />	lea eax,Eaten<br />	push eax<br />	lea eax,wsz<br />	push eax<br />	push NULL<br />	push hWnd<br />	push pShellFolder<br />	mov edi,pShellFolder<br />	mov edi,&#91;edi&#93;<br />	call DWORD PTR &#91;edi+12&#93; ; IShellFolder&#58;&#58;ParseDisplayName<br /><br />	push pShellFolder<br />	mov edi,pShellFolder<br />	mov edi,&#91;edi&#93;<br />	call DWORD PTR &#91;edi+8&#93; ; IShellFolder&#58;&#58;Release<br />	<br />	cmp LibLoaded,S_OK<br />	jne @F<br />		invoke CoUninitialize<br />	@@&#58;<br /><br />	mov eax,Pidl<br />	ret<br />GetPIDLFromPath endp</code></pre>Use the following to extract the path from the returned PIDL :<br /><br />invoke SHGetPathFromIDList,PIDL,ADDR szPath</div>
    <div class="meta">Posted on 2003-04-21 13:44:15 by donkey</div>
   </div>
   <div class="post" id="post-98416">
    <div class="subject"><a href="#post-98416">PIDL from path</a></div>
    <div class="body">Nice, Donkey  :alright:<br /><br />Just one comment.  I was thinking that maybe it'd be cleaner to keep CoInitialize and CoUninitialize out of there and just remind  the reader that they need to initialize the com library before calling it.  This way if they need to use more com objects then they can initialize the lib at program startup and no redundant calls to CoInitialize.</div>
    <div class="meta">Posted on 2003-04-21 13:58:53 by iblis</div>
   </div>
   <div class="post" id="post-98420">
    <div class="subject"><a href="#post-98420">PIDL from path</a></div>
    <div class="body">You're right Iblis,<br /><br />I made the change. The application I used it in only had this one COM call so I had it in the proc it is better to remove it from the proc completely and make the call independantly. The proc will now attempt to load the COM library and if it is already loaded it will not unload it, otherwise it works as usual.</div>
    <div class="meta">Posted on 2003-04-21 14:12:32 by donkey</div>
   </div>
   <div class="post" id="post-98458">
    <div class="subject"><a href="#post-98458">PIDL from path</a></div>
    <div class="body">I've been reading a bit more about the SHGetDesktopFolder function and I believe that you have to free the MAlloc of the PIDL that is generated by it. Problem is that once it's freed the PIDL is no longer valid. To solve this problem I have written the following function. All it does is uses the IMalloc interface and frees the memory used by the PIDL, call the function with the PIDL as the only parameter once you are done with it <pre><code>FreePIDL Proc PIDL&#58;DWORD<br />	LOCAL pMalloc				&#58;DWORD<br /><br />	invoke SHGetMalloc,ADDR pMalloc<br /><br />	push PIDL<br />	push pMalloc<br />	mov edi,pMalloc<br />	mov edi,&#91;edi&#93;<br />	call DWORD PTR &#91;edi+20&#93; ;IMalloc.Free<br /><br />	push pMalloc<br />	mov edi,pMalloc<br />	mov edi,&#91;edi&#93;<br />	call DWORD PTR &#91;edi+8&#93; ; IMalloc&#58;Release<br /><br />	ret<br />FreePIDL endp</code></pre>BTW I'm not 100% certain that this is necessary but it can't hurt. A COM guru might be able to tell me more about it.</div>
    <div class="meta">Posted on 2003-04-21 21:03:52 by donkey</div>
   </div>
  </div>
 </body>
</html>