<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>How to achieve &quot;function level linking&quot; with MASM? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=9910" />
    <link rel="next" href="../?id=9910&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=9910">How to achieve &quot;function level linking&quot; with MASM?</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=9910&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=9910&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="9910" /><input type="number" name="page" min="1" max="3" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=9910&amp;page=2">&gt;</a><a href="../?id=9910&amp;page=3">&raquo;</a></form>   <div class="post" id="post-73976">
    <div class="subject"><a href="#post-73976">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">Hi,<br /><br />does anyone know of how to support this feature with MASM? No problem with VC. Obviously a flags in the section records of the .OBJ file has to be set. And a special section to be written? Any clues here would be apreciated. <br /><br />Japheth</div>
    <div class="meta">Posted on 2003-01-02 05:14:44 by japheth</div>
   </div>
   <div class="post" id="post-73989">
    <div class="subject"><a href="#post-73989">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body"><a target="_blank" href="http://www.launcherasm.com/technical/comdats.html">http://www.launcherasm.com/technical/comdats.html</a><br /><br />The segment directive does have a COMDAT flag, but I have not have a need to play with it.  The docs I've read state that only the first segment is included when the names are the same and the COMDAT flag is set.</div>
    <div class="meta">Posted on 2003-01-02 07:41:47 by bitRAKE</div>
   </div>
   <div class="post" id="post-74006">
    <div class="subject"><a href="#post-74006">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">Hi bitRAKE<br /><br /><div class="quote"><br />The segment directive does have a COMDAT flag, but I have not have a need to play with it. The docs I've read state that only the first segment is included when the names are the same and the COMDAT flag is set.<br /></div><br /><br />That's not the &quot;feature&quot; im interested in. I want to extract single function definitions from one .OBJ file. In VC thats achieved with option /Gy.<br /><br />I have one file with many small functions, and want to link some of them into my exe.  In VC it works, but looks pretty bad (see code below). But not found a way yet to get the same results with MASM. Possible it cannot be done (without extra tools)<br /><br /><pre><code><br /><br />#include &lt;windows.h&gt;<br /><br />extern __stdcall InvokeHelper&#40;void&#41;;<br /><br />void __declspec&#40; naked &#41; Range_get_Application&#40;LPDISPATCH pDispatch, PVOID arg1&#41;<br />&#123;<br />	_asm&#123;<br />	call InvokeHelper<br />	ret 8<br />	_emit 0				//dw numArgs<br />	_emit 0<br />	_emit &#40;VT_USERDEFINED or VT_BYREF&#41; and 0FFh	//dw rettype<br />	_emit &#40;VT_USERDEFINED or VT_BYREF&#41; shr 8<br />	<br />	_emit DISPATCH_PROPERTYGET	//dw functype<br />	_emit 0<br /><br />	_emit 94h			//dd dispid<br />	_emit 0<br />	_emit 0<br />	_emit 0<br /><br />	_emit 4			// size returnparm<br />	_emit 0<br />	&#125;;<br /><br />&#125;<br />void __declspec&#40; naked &#41; Range_get_Item&#40;LPDISPATCH pDispatch, VARIANT arg1, VARIANT arg2, PVOID arg3&#41;<br />&#123;<br />	_asm&#123;<br />	call InvokeHelper<br />	ret 40<br />	_emit 2				//dw numArgs<br />	_emit 0<br />	_emit VT_VARIANT			//dw type arg1<br />	_emit 0<br />	_emit VT_VARIANT			//dw type arg2<br />	_emit 0<br />	_emit &#40;VT_VARIANT or VT_BYREF&#41; and 0FFh 		//dw rettype<br />	_emit &#40;VT_VARIANT or VT_BYREF&#41; shr 8<br /><br />	_emit DISPATCH_PROPERTYGET	//dw functype<br />	_emit 0<br /><br />	_emit 0AAh			//dd dispid<br />	_emit 0<br />	_emit 0<br />	_emit 0<br /><br />	_emit 16			// size returnparm<br />	_emit 0<br />	&#125;;<br />&#125;<br />void __declspec&#40; naked &#41; Range_put_Item&#40;LPDISPATCH pDispatch, VARIANT arg1, VARIANT arg2, VARIANT arg3&#41;<br />&#123;<br />	_asm&#123;<br />	call InvokeHelper<br />	ret 52<br />	_emit 3				//dw numArgs<br />	_emit 0<br />	_emit VT_VARIANT			//dw type arg1<br />	_emit 0<br />	_emit VT_VARIANT			//dw type arg2<br />	_emit 0<br />	_emit VT_VARIANT			//dw type arg3<br />	_emit 0<br />	_emit 0				//dw rettype<br />	_emit 0<br /><br />	_emit DISPATCH_PROPERTYPUT	//dw functype<br />	_emit 0<br /><br />	_emit 0AAh				//dd dispid<br />	_emit 0<br />	_emit 0<br />	_emit 0<br /><br />	_emit 0				// size returnparm<br />	_emit 0<br />	&#125;;<br />&#125;<br /><br /></code></pre></div>
    <div class="meta">Posted on 2003-01-02 09:54:30 by japheth</div>
   </div>
   <div class="post" id="post-74062">
    <div class="subject"><a href="#post-74062">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">The assembler must tell the linker where, in the .OBJ file, each function starts and ends. If the assembler doesn't provide this information, it cannot be done.<br /><br />The old fashioned way is to put each function in a separate .ASM file, generate the separate .OBJ files, and then combine the .OBJ files into a single .LIB file.</div>
    <div class="meta">Posted on 2003-01-02 17:05:30 by tenkey</div>
   </div>
   <div class="post" id="post-74092">
    <div class="subject"><a href="#post-74092">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">tenkey, <br /><br />thanks for the reply. Im aware of that &quot;old way&quot; possibility, but didnt want to generate 6500 small ASM files :grin: .<br /><br />But priority of that item has diminished in the meantime.</div>
    <div class="meta">Posted on 2003-01-02 19:45:11 by japheth</div>
   </div>
   <div class="post" id="post-74270">
    <div class="subject"><a href="#post-74270">This thread inpired me tonight ;)</a></div>
    <div class="body">Heres a nice addon for your MASM32 bin:  <strong>LIBM.EXE</strong> :grin:<br /><br />This will take an *.asm file and chop / build a static lib for function level linking (as this thread is about).<br /><br />There are five different 'labels' you need to put in your asm file for this purpose:<br /><br /><strong>;#HEADER START</strong> - This is a universal header section (.386 / include's etc)<br /><br /><strong>;#HEADER END</strong> - This is the end of header label. It will abort if not found.<br /><br /><strong>;#COFF_PROC <em>FunctionName</em></strong> - This is the start of a unique function to linked on a per call basis<br /><br /><strong>;#COFF_ENDP</strong> - This is the end of coff function section. It wil get grumpy if not found ;)<br /><br /><strong>;#PROTO <em>Prototype_line_for_function</em></strong> - This must be within the scope of the #COFF lables.  It too will make the tool complain if its not found ;)<br /><br />So with all this in mind, here is a samle file:<pre><code>;----------------------------------------<br /><br />;#HEADER START<br />.386<br />.model flat,stdcall<br />option casemap&#58;none<br /><br />; Any includes and Libs used<br /><br />;#HEADER END<br /><br />;----------------------------------------<br /><br />;#COFF_PROC One<br />;#PROTO One PROTO<br />.code<br />One   PROC<br />   nop<br />   ret<br />One   ENDP<br />;#COFF_ENDP<br /><br />;----------------------------------------<br /><br />;#COFF_PROC Two<br />;#PROTO Two PROTO<br />.code<br />Two   PROC<br />   nop<br />   nop<br />   ret<br />Two   ENDP<br />;#COFF_ENDP<br /><br />;----------------------------------------<br />end</code></pre><br /><br />By the way it is designed, you can build and test your functions before hand and when decidedly finished, you simply pass it thru LIBM to make it into the static lib.  It outputs into the calling directory..<br /><br />As an added bonus, it <strong>also generates an output include header for your lib</strong>!  <br />You will find the include in the same directory as the generated lib.<br /><br />Please try it out, and give me feedback.  I will open source it, eventually.  But i want to get it right first ;)<br /><br />There is only one area of noticeable problem.  The ShellExecute API is not syncronized for commandline functions.  So i have made a defualt (time-out), which doesnt make me sit well... :rolleyes: .  I havent found a way of making my app wait until ShellExecute finishes.  I searched the board and got two possible solutions:<br /><br />1) Use WaitForSingleObject.  But the returned 'handle' by ShellExe is not a 'real' instance handle (as the MSDN indicates, and proven empirically).  So this fails.<br /><br />2) Use the &quot;shell&quot; function in the masm package.  I searched the entire M32Lib dir and found nothing of it.  (It was a comment made by Hutch in an old thread on a related topic). <br /><br />I guess the only other solution is going multi-threading (somehow), still cant see how it would be any advantage since the ShellExe is not sychronized anyways...<br /><br />Anywho, for now, the time-out is happily balanced between 'fast-enough' and 'still-gets-the-job-done' ;)<br /><br />Let me know if you have any thoughts you can add to this.  I would like to use something more trusty than a delay...<br /><br />Anywho.. Enjoy!<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-01-04 04:39:49 by NaN</div>
   </div>
   <div class="post" id="post-74277">
    <div class="subject"><a href="#post-74277">Fixed!</a></div>
    <div class="body">Ok.. I think i got it all working perfect now... <br /><br />No delays!! And i fixed a bug with LineFeeds....<br /><br />I took half the MASM32.INC's from the M32LIB dir and made one big file, and it works every time! <br /><br />So I feel alot more confident it will work for you ;)<br />One thing i noticed tho, Ensue your include / includelib paths in the header section have a drive letter indicated.<br /><br />It works by setting up a WIndows/temp directory, which may not be the same drive as your masm32 package. <br /><br />And dont worry, Everytime its ran, i programmed it to empty the WINDOW\TEMP\MASMLIB directory first.  If its not there to begin with, i programmed it to make one..  So if you want to look at the generated files, look there ;)<br /><br />Enjoy! (Please give feedback)<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-01-04 05:47:35 by NaN</div>
   </div>
   <div class="post" id="post-74282">
    <div class="subject"><a href="#post-74282">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">The attachment ( ;) )<br /><br /><strong>.:EDIT:.</strong> Removed outdated attachment.  See end of post.</div>
    <div class="meta">Posted on 2003-01-04 06:21:23 by NaN</div>
   </div>
   <div class="post" id="post-74284">
    <div class="subject"><a href="#post-74284">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">NaN,<br /><br />This is the &quot;shell&quot; procedure I did some time ago, it seems to work OK.<br /><pre><code><br />; #########################################################################<br /><br />    .486                      ; create 32 bit code<br />    .model flat, stdcall      ; 32 bit memory model<br />    option casemap &#58;none      ; case sensitive<br /><br />    include \masm32\include\windows.inc<br />    include \masm32\include\kernel32.inc<br /><br />    .code<br /><br />; ########################################################################<br /><br />shell proc lpfilename&#58;DWORD<br /><br />    LOCAL xc &#58;DWORD         ; exit code<br /><br />    .data<br />      st_info STARTUPINFO &lt;0&gt;<br />      pr_info PROCESS_INFORMATION &lt;0&gt;<br />    .code<br /><br />    invoke CreateProcess,NULL,lpfilename,NULL,NULL,<br />                         NULL,NULL,NULL,NULL,<br />                         ADDR st_info,<br />                         ADDR pr_info<br /><br />  ; -------------------------------------------<br />  ; loop while created process is still active<br />  ; -------------------------------------------<br />  @@&#58;<br />    invoke GetExitCodeProcess,pr_info.hProcess,ADDR xc<br />    cmp xc, STILL_ACTIVE<br />    je @B<br /><br />    ret<br /><br />shell endp<br /><br />; ########################################################################<br /></code></pre><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2003-01-04 07:10:36 by hutch--</div>
   </div>
   <div class="post" id="post-74291">
    <div class="subject"><a href="#post-74291">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">that doesn't look threadsafe though. Ok, your startupinfo is zeroed out and you're not using the process_information, so theoretically that doesn't matter; but I think it's more optimal to WaitForSingleObject instead of looping GetExitCodeProcess? Also, PSDK says you ought to CloseHandle the stuff in the process_information structure. I dunno if these handles are freed when the target app stops executing, or if they linger until your app stops - but there's a potential for leaking there. One more thing. This *might* just be me remembering wrong, or it might be some windows versions that are more picky than others - but I think you ought to set at least startupinfo.cb (or whatever the size-of-structure member is called in the masm32 includes).</div>
    <div class="meta">Posted on 2003-01-04 09:45:56 by f0dder</div>
   </div>
   <div class="post" id="post-74298">
    <div class="subject"><a href="#post-74298">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">Hi NaN,<br /><br />thats a very good idea with your libm tool. I tried it out and it worked. 2 things remain to mention:<br /><br />- possibly libm could say one word or two about where it has written its stuff. It took me some time to find out where the output stuff has been written :stupid: .<br />- I would prefer these #proto statements to be optional. Currently libm complains if it founds none, but if I delete all except one, it runs without errors giving strange results.<br /><br />:alright: <br /><br />Japheth<br /><br /><br /><br />After some time I realized that every time your tool comes to this &quot;finished&quot; message, a invisible &quot;msdos&quot; or &quot;winoa386&quot; process remains running, filling the process list with this things. So there goes something wrong.<br />(using WIN98 SE, starting libm from the command line)<br /></div>
    <div class="meta">Posted on 2003-01-04 10:37:11 by japheth</div>
   </div>
   <div class="post" id="post-74314">
    <div class="subject"><a href="#post-74314">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">Thanx Japheth, i will add some command line switches (and look into the 'proto' bug)...<br /><br />However, im more concerned with the ugly by product of process trash.  I didnt notice this, but after retesting i too get a &quot;winoldapp&quot; in my process list :rolleyes: .<br /><br />So to save time and hopefully get some expert help, how *should* i be calling an external process.  The external process is calling a batch file.  I generate dynamically in the Temp director (mentioned above (\TEMP\MASMLIB\)) the batch file everytime, and run it as follows:<pre><code>@Finished&#58;<br />;-------------------------------------------  Build the output bat file<br />   DESTROY hINC<br />   lea edx, tempDir<br />   add edx, cPath<br />   xor eax, eax<br />   mov &#91;edx&#93;, eax<br />   lea edx, buffer<br />   mov &#91;edx&#93;, eax<br />   invoke szCatStr, addr buffer, addr tempDir<br />   invoke szCatStr, addr buffer, CStr&#40;&quot;MAKE.BAT&quot;&#41;<br />   <br />   lea esi, buffer<br />   mov hINC, $NEW&#40; CFile, esi,CFILE_WRITE, 128 &#41;<br />   ; Open&#58; \WINDOWS\TEMP\MAKE.BAT<br /><br />   ; Compile Line...<br />   xor eax, eax<br />   lea edx, buffer<br />   mov &#91;edx&#93;, eax<br />   invoke szCatStr, addr buffer, CStr&#40;&quot;ML.EXE /c /coff &quot;&#41;<br />   invoke szCatStr, addr buffer, addr tempDir<br />   invoke szCatStr, addr buffer, CStr&#40;&quot;*.ASM&quot;&#41;<br />   invoke szCatStr, addr buffer, CStr&#40;&lt;&lt;13,10,13,10&gt;&gt;&#41;<br />   METHOD hINC, CFile, WriteLine, addr buffer<br />   ; Writeline&#58; ML.EXE /c /coff C&#58;\WINDOWS\TEMP\MASMLIB\*.ASM<br />   <br />   ; Lib Line...<br />   xor eax, eax<br />   lea edx, buffer<br />   mov &#91;edx&#93;, eax<br />   invoke szCatStr, addr buffer, CStr&#40;&quot;LIB.EXE &quot;&#41;<br />   invoke szCatStr, addr buffer, addr tempDir<br />   invoke szCatStr, addr buffer, CStr&#40;&quot;*.OBJ /out&#58;&quot;&#41;<br />   invoke szCatStr, addr buffer, addr tempDir<br />   invoke szCatStr, addr buffer, addr fname <br />   invoke szCatStr, addr buffer, CStr&#40;&quot;.LIB&quot;&#41;<br />   invoke szCatStr, addr buffer, CStr&#40;&lt;&lt;13,10,13,10&gt;&gt;&#41;<br />   METHOD hINC, CFile, WriteLine, addr buffer<br />   ; WriteLine&#58; LIB.EXE C&#58;\WINDOWS\TEMP\MASMLIB\*.OBJ /out&#58;C&#58;\WINDOWS\TEMP\MASMLIB\name.lib<br /><br />   <br />   ; Copy line<br />   xor eax, eax<br />   lea edx, buffer<br />   mov &#91;edx&#93;, eax<br />   invoke szCatStr, addr buffer, CStr&#40;&quot;COPY &quot;&#41;<br />   invoke szCatStr, addr buffer, addr tempDir<br />   invoke szCatStr, addr buffer, addr fname <br />   invoke szCatStr, addr buffer, CStr&#40;&quot;.* &quot;&#41;<br />   invoke szCatStr, addr buffer, addr apath<br />   invoke szCatStr, addr buffer, CStr&#40;&quot;*.*&quot;&#41;<br />   invoke szCatStr, addr buffer, CStr&#40;&lt;&lt;13,10,13,10&gt;&gt;&#41;<br />   METHOD hINC, CFile, WriteLine, addr buffer<br />   ; WriteLine&#58; COPY C&#58;\WINDOWS\TEMP\MASMLIB\name.* D&#58;\app_path\*.*<br /><br />   DESTROY hINC<br />   xor eax, eax<br />   mov hINC, eax<br />   ; Close output writing file.<br /><br />;-------------------------------------------  Build the Lib<br />   xor eax, eax<br />   lea edx, buffer<br />   mov &#91;edx&#93;, eax<br />   invoke szCatStr, addr buffer, addr tempDir<br />   invoke szCatStr, addr buffer, CStr&#40;&quot;MAKE.BAT&quot;&#41;<br /><br />   invoke ShellExecute, NULL, NULL, addr buffer, NULL, addr tempDir, SW_HIDE<br />   invoke StdOut, CStr&#40;&lt;&lt;13,10,&quot;Finished!...&quot;&gt;&gt;&#41;</code></pre><br /><br />Since its a console mode app, i dont have a window 'parent' handle, so i placed NULL in its place.  Perhaps this is why its doing this?<br /><br />Does anyone have a better solution?  (Im new in these areas of the Windows API ;) )  I just know how to use the MSDN, thats all ;)<br /><br />(( Perhaps i should make it a dialog box window? ))<br />Anyone, please give me your thoughts.. thanx in advance.<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-01-04 12:44:39 by NaN</div>
   </div>
   <div class="post" id="post-74315">
    <div class="subject"><a href="#post-74315">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">CreateProcess. It's more flexible anyway. Remember to close Thead and Process<br />handles when you're done using them. It's probably a good idea to create a simple wrapper around CreateProcess, so you don't have to specify the long parameter list CreateProcess takes, every time you want to call an app. You can use hutches shell proc above as a template.</div>
    <div class="meta">Posted on 2003-01-04 12:53:36 by f0dder</div>
   </div>
   <div class="post" id="post-74322">
    <div class="subject"><a href="#post-74322">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">Thanx f0dder,<br /><br />I didnt think i should use it, cause of your above concerns... I figured since you found *some* flaw i would wait till some conclusion had arrived...<br /><br />I will consult the MSDN and the example and see what i can produce ;)  I agree a wrapper would be good.. and would make a good lib entry as well ;)<br /><br />Hmm.. I wonder what good the ShellExecute is for then.. (besides web links and printing documents... :rolleyes: ).  Ah well i thought it was too ez for M$ standards anyways ;)<br /><br />On the lighter side, I got the PROTO bug fixed.. I didnt limit the search for PROTO's to within the scope.. It was finding PROTO statements outside of the function scope, and moving happily along.<br /><br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-01-04 14:06:46 by NaN</div>
   </div>
   <div class="post" id="post-74324">
    <div class="subject"><a href="#post-74324">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">NaN, it's not much work creating a good wrapper around CreateProcess. Put the two required structures as LOCAL variables. Set their sizes. Fill the startupinfo with GetStartupInfo (and perhaps modify some members). Do the CreateProcess call, and if you want the wrapper to wait until app is done executing, WaitForSingleObject on the pi.hProcess. Remember to CloseHandle pi.hProcess and pi.hThread (you can GetExitCodeProcess on pi.hProcess after the process is done executing, so I assume the kernel mode object for at least the hProcess isn't automatically freed until _your_ app stops - and we don't like leaks, do we?).<br /><br />ShellExecute is ok for quick and dirty stuff, but it's not very flexible. You could code your own ShellExecute, but that's a somewhat larger project and involves quite some mucking around in the registry to find filetype associations etc.</div>
    <div class="meta">Posted on 2003-01-04 14:15:52 by f0dder</div>
   </div>
   <div class="post" id="post-74343">
    <div class="subject"><a href="#post-74343">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">Hi NaN,<br /><br />This is my tool to run exe/bat file from dos. It is not optimize yet but it works in ME &amp; 2K<br /><br />It also doesn't leave the winoldap<br /><br /><br />To run it:<br />e.g:<br />- RunDOS notepad readme.txt<br />- RunDOS Make.bat<br /><br />for long filename:<br />in W2K -&gt; RunDOS notepad readme first.txt<br />in W9X -&gt; RunDOS notepad &quot;readme first.txt&quot;<br /><br /><pre><code><br />; ####################################<br />    .586<br />    .model flat, stdcall<br />    option casemap &#58;none   ; case sensitive<br /><br />; ####################################<br />   include \masm32\include\windows.inc<br />   include \masm32\include\masm32.inc   <br />   include \masm32\include\user32.inc<br />   include \masm32\include\kernel32.inc<br />   include clash.inc<br /><br />   includelib \masm32\lib\user32.lib<br />   includelib \masm32\lib\masm32.lib<br />   includelib \masm32\lib\kernel32.lib<br />   includelib clash.lib<br /><br />   Main      PROTO<br />   MyShell   PROTO &#58;LPSTR<br />   IsNT      PROTO<br /><br />   ; ---------------------<br />   ; literal string MACRO<br />   ; ---------------------<br />     literal MACRO quoted_text&#58;VARARG<br />       LOCAL local_text<br />       .data<br />         local_text db quoted_text,0<br />       .code<br />       EXITM &lt;local_text&gt;<br />     ENDM<br /><br />   ; --------------------------------<br />   ; string address in INVOKE format<br />   ; --------------------------------<br />     SAddr MACRO quoted_text&#58;VARARG<br />       EXITM &lt;ADDR literal&#40;quoted_text&#41;&gt;<br />     ENDM<br /><br />; ####################################<br />.DATA?<br />CommandLine LPSTR ? <br /><br />.CODE<br /><br />START&#58;<br /><br />   call Main<br />   invoke ExitProcess,0<br /><br />; ####################################<br /><br />Main Proc USES ESI<br />Local Params&#91;128&#93;&#58;BYTE, ln_Count&#58;DWORD<br /><br />   invoke GetCommandLine<br />   mov CommandLine, eax<br />   invoke CL_ScanArgsX, CommandLine<br />   .If &#40;eax &gt; 1&#41;<br />      mov ecx, eax<br />      dec ecx<br />      push ecx<br />      mov dword ptr Params&#91;0&#93;, 0<br />      invoke IsNT<br />      .If &#40;eax == 1&#41;<br />         invoke lstrcat, Addr Params, SAddr&#40;&quot;Cmd.exe /C &quot;&quot;&quot;&#41;<br />         pop ecx<br />         mov esi, 4<br />         NextArg1&#58;<br />            push ecx<br />            invoke lstrcat, Addr Params, CL_argv&#91;esi&#93;<br />            pop ecx<br />            .If &#40;ecx &gt; 1&#41;<br />               invoke lstrcat, Addr Params, SAddr&#40;&quot; &quot;&#41;<br />               add esi, 4<br />               .If &#40;CL_argv&#91;esi&#93; == NULL&#41;<br />                  mov ecx,1<br />               .endif<br />            .endif<br />         loop NextArg1<br />         invoke lstrcat, Addr Params, SAddr&#40;&quot;&quot;&quot;&quot;&#41;<br /><br />      .else<br />         invoke lstrcat, Addr Params, SAddr&#40;&quot;Command.Com /C &quot;&#41;<br /><br />         pop ecx<br />         mov esi, 4<br />         NextArg2&#58;<br />            push ecx<br />            invoke lstrcat, Addr Params, SAddr&#40;&quot;&quot;&quot;&quot;&#41;<br />            invoke lstrcat, Addr Params, CL_argv&#91;esi&#93;<br />            invoke lstrcat, Addr Params, SAddr&#40;&quot;&quot;&quot;&quot;&#41;<br />            pop ecx<br />            .If &#40;ecx &gt; 1&#41;<br />               invoke lstrcat, Addr Params, SAddr&#40;&quot; &quot;&#41;<br />               add esi, 4<br />            .endif<br />         loop NextArg2<br />      .endif<br /><br />      invoke MyShell, Addr Params<br />   .endif<br /><br />   ret<br />Main EndP<br /><br />; ####################################<br /><br />MyShell proc tp_CommandLine&#58;LPSTR<br />.Data<br />   SInfo STARTUPINFO &lt;0&gt;<br />   Pr_Info PROCESS_INFORMATION &lt;0&gt;<br /><br />.Code<br />   mov SInfo.cb, SizeOf STARTUPINFO<br />   mov SInfo.dwFlags, STARTF_USESHOWWINDOW<br />   mov SInfo.wShowWindow, SW_HIDE<br />   invoke CreateProcess, NULL,  tp_CommandLine, NULL, NULL,<br />         FALSE, 0, NULL, NULL, Addr SInfo, Addr Pr_Info<br /><br />  ; -------------------------------------------<br />  ; loop while created process is still active<br />  ; -------------------------------------------<br />   .If &#40;eax &gt; 0&#41;<br />     @@&#58;<br />      invoke WaitForSingleObject, Pr_Info.hProcess, 200<br />      cmp eax, WAIT_OBJECT_0<br />      jne @B<br />   .endif<br />   invoke CloseHandle, Pr_Info.hProcess<br />   invoke CloseHandle, Pr_Info.hThread<br />   ret<br />MyShell endp<br /><br />; ####################################<br /><br />IsNT proc<br />Local vi&#58;OSVERSIONINFO<br /><br />    mov vi.dwOSVersionInfoSize, SizeOf vi<br />    invoke GetVersionEx, Addr vi ; eax<br />    cmp eax, 0<br />    je  ErrorCheck<br /><br />    mov ecx, vi.dwPlatformId<br />    cmp ecx, VER_PLATFORM_WIN32_NT<br />    je  Win_NT<br /><br />    mov eax, 0    ; Not Win NT<br />    ret<br /><br />    Win_NT&#58;<br />    mov eax, 1    ; Win NT<br />    ret<br /><br />    ErrorCheck&#58;<br />    mov eax, 2    ; Error<br /><br />    ret<br />IsNT endp<br /><br />; ####################################<br /><br />END START<br /></code></pre><br /><br />The clash.inc &amp; lib I took it from <strong>Jibz</strong><br /><br />Hope you can find it useful :) <br /><br />Btw, I tried your tools and find a minor bug. My masm is located in drive E:<br />If in the program I have a code like &quot;include \masm32\include\windows.inc&quot; (lib also) the tools cannot build the lib.<br />But if a add a drive letter before it &quot;include e:\masm32 \include\windows.inc&quot;, it builds the lib<br /><br />I would also prefer if we don't have to put #COFF_ / #PROTO (search PROC automatically). It will be more useful. If it is difficult just ignore this one. But I still hoping...:) <br /><br />:alright:</div>
    <div class="meta">Posted on 2003-01-04 17:05:49 by HermanT</div>
   </div>
   <div class="post" id="post-74372">
    <div class="subject"><a href="#post-74372">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">Here is a working, bug free (hopefully) version.  I managed to put togther exactly what HermanT had (should have simply waited ;) ).<br /><br />As well i modified the ;#PROTO usage.  Its your options to use it.  It will not complain at all if you dont add a single one.  However, if you do, there is no checking.. only a simple cut&amp;paste into an include file.<br /><br />In future versions i will see how much overhead it would be to process the lines for PROC and ENDP statements.  This will elimenate the ;#COFF_START and ;COFF_END statements.  However, for now it is still in there ;)<br /><br />As well, cause im using createprocess, it pipes output directly to you, so if you have a problem, its in your face ;)<br /><br />Please try it out, and give me feedback... (i think HermanT's will be the next focus).<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-01-04 20:14:51 by NaN</div>
   </div>
   <div class="post" id="post-74383">
    <div class="subject"><a href="#post-74383">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">grrrrr.....:mad: <br />I knew my program has a bug, and I missed it (BUT HOW!!!) :o :grin: <br /><br />NaN, don't use the code before, use this one instead! (attachment)<br /><br />Now I already tried the new one. It is crash on my W2K.<br />If you already use the code above maybe that's what causing error.<br /><br />Also i forgot to mentioned that when i used the old one (libm 1.3), the lib size is bigger than if compiled from make.bat directly.<br />What i mean here is, i use LIBM to create lib for my test program with 2 proc (trans.asm), the lib size is 1,286 bytes. Then I simply copy the make.bat from the temp directory into my program directory, and change it to compile the trans.asm directly. The lib size is 688 bytes!<br /><br />I guess it's because the program separated into a smaller program (one proc by one proc) but the header is on every program including the data section. So the data section is duplicated. Then how if we have more than 2 proc ?? :confused: <br /><br /><br />This is the code for my test program <br />; Program trans.asm<br /><pre><code><br />;#HEADER START<br />   .386<br />   .model flat, stdcall  ; 32 bit memory model<br />   option casemap &#58;none  ; case sensitive<br />   include \masm32\include\windows.inc<br /><br />.Data<br />   cMsg  db 'Test',0<br />;#HEADER END<br /><br /><br />;#COFF_PROC Clear<br />;#PROTO Clear PROTO &#58;DWORD<br />.Code<br />Clear Proc hWnd&#58;DWORD<br />   mov eax, 0<br />   ret<br />Clear endp<br />;#COFF_ENDP<br /><br />;#COFF_PROC Two<br />;#PROTO Two PROTO<br />.code<br />Two   PROC<br />   nop<br />   nop<br />   ret<br />Two   ENDP<br />;#COFF_ENDP<br /><br />End<br /></code></pre><br /><br />And this is the rundos program (fixed)<br /><br />Regards :alright:</div>
    <div class="meta">Posted on 2003-01-04 22:41:36 by HermanT</div>
   </div>
   <div class="post" id="post-74400">
    <div class="subject"><a href="#post-74400">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">Hello HermanT,<br /><br /><div class="quote"><br />grrrrr.....:mad: <br />I knew my program has a bug, and I missed it (BUT HOW!!!) :o :grin: <br />NaN, don't use the code before, use this one instead! (attachment)<br />Now I already tried the new one. It is crash on my W2K.<br />If you already use the code above maybe that's what causing error.</div><br />Thanx for the testing.. I dont have an NT type OS, so this is good to know.. Thanx!<br /><div class="quote"><strong>Also i forgot to mentioned that when i used the old one (libm 1.3), the lib size is bigger than if compiled from make.bat directly.<br />What i mean here is, i use LIBM to create lib for my test program with 2 proc (trans.asm), the lib size is 1,286 bytes. Then I simply copy the make.bat from the temp directory into my program directory, and change it to compile the trans.asm directly. The lib size is 688 bytes!</div><br />If i understood this correctly, then the reason is because you defeat the purpose of the LIBM.  The extra size (i assume) is because the files are separate, and thus have their own COFF header section in the LIB ( 2 functions, 2 COFF headers).  By copying out the make.bat (from the old v1.3 version), and compiling the origional source, it ends up with only one COFF section ( 2 functions, 1 COFF header).  This means if you only want use of function1 in the lib, you have to have function 2 as extra 'filler' in your code, cause there is not separate COFF headers....<br /><br />So as i see it:<br />1 COFF, 2 Functions == 688byte lib (non-function level linking)<br />2 COFF, 2 Functions == 1286byte lib (function level linking).<br /><br />This is the solution to your test program.<pre><code><br />;#HEADER START<br />   .386<br />   .model flat, stdcall  ; 32 bit memory model<br />   option casemap &#58;none  ; case sensitive<br />   include \masm32\include\windows.inc<br /><br />;#HEADER END<br /><br /><br />;#COFF_PROC Clear<br />;#PROTO Clear PROTO &#58;DWORD<br />&#91;b&#93;.Data<br />   cMsg  db 'Test',0&#91;/b&#93;<br /><br />.Code<br />Clear Proc hWnd&#58;DWORD<br />   mov eax, 0<br />   ret<br />Clear endp<br />;#COFF_ENDP<br /><br />;#COFF_PROC Two<br />;#PROTO Two PROTO<br />&#91;b&#93;.data<br /> dataForTwoProc dd 0&#91;/b&#93;<br />.code<br />Two   PROC<br />   nop<br />   nop<br />   ret<br />Two   ENDP<br />;#COFF_ENDP<br /><br />End<br /></code></pre><br /><br /><div class="quote"><strong>And this is the rundos program (fixed)</div><br />Thanks i will look it over..<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-01-05 00:44:15 by NaN</div>
   </div>
   <div class="post" id="post-74401">
    <div class="subject"><a href="#post-74401">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">Correct me if im wrong here, but did you say that v1.5 crashed on NT?<br /><br />Cause looking over your solution, all i see is you separating a prefixed &quot;CMD.EXE&quot; or &quot;COMMAND.COM&quot; if the version is NT or Not.  The reason im puzzled is because i dont use either when calling an external process.  I leave all this up to the OS to decide what to do.  I simpy gave it the filename and arguments in a string.<br /><br />Or perhaps your trying to tell me that i need to add &quot;CMD.EXE /C &quot; for NT stype OS's?  Cause 9x version work well without it...<br /><br />Thanx<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-01-05 00:57:41 by NaN</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=9910&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=9910&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="9910" /><input type="number" name="page" min="1" max="3" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=9910&amp;page=2">&gt;</a><a href="../?id=9910&amp;page=3">&raquo;</a></form>  </div>
 </body>
</html>