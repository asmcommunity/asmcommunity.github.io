<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>How to achieve &quot;function level linking&quot; with MASM? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=9910" />
  <link rel="prev" href="../?id=9910&amp;page=1" />  <link rel="next" href="../?id=9910&amp;page=3" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=9910">How to achieve &quot;function level linking&quot; with MASM?</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=9910&amp;page=1" style="">&laquo;</a><a href="../?id=9910&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="9910" /><input type="number" name="page" min="1" max="3" step="1" value="2" onchange="this.form.submit();" /><a href="../?id=9910&amp;page=3">&gt;</a><a href="../?id=9910&amp;page=3">&raquo;</a></form>   <div class="post" id="post-74406">
    <div class="subject"><a href="#post-74406">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">NaN,<br /><br />If you really want to make the #COFF_xxx statements superfluous and analyse &quot;proc&quot; and &quot;endp&quot; directly please be careful about public and private procs. private procs in separate modules would be useless. So your tool would have to analyse which public procs need which private procs. Possibly libm has to analyse &quot;option proc:xxx&quot; as well then.<br /><br />Just to remind you :) <br /><br />Japheth</div>
    <div class="meta">Posted on 2003-01-05 02:12:17 by japheth</div>
   </div>
   <div class="post" id="post-74418">
    <div class="subject"><a href="#post-74418">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">NaN, thanks for the solution. I think i have to try more to get the exact behavior :) ( I just jumped in when I found problem he..he.. that's me :grin: )<br />But now I can''t try it anymore. The new one crash on my 2K sp 3 (yes, libm 1.5 crashed :( ). The old one has been deleted, and i can't download it again cause the attachment for your old one has gone. :confused: <br /><br />About using &quot;Cmd.exe&quot; or &quot;Command.com&quot; it is up to what you like. W2K has both file, cmd.exe is for 32bit dos and command.com for 16bit. I prefer to use a 32bit dos, which is also the system default.<br /><br />For the reason i use prefixed is, I want to run the cmd.exe directly plus i want to give additional parameter ( /C ), to tell cmd.exe to run anything that pass to it as a command line until finish and then terminates itself, the result is a clean system ( no winoldapp left ).<br /><br />There is a big different between cmd.exe for 2K and command.com for 9X. Cmd.exe only take one single string parameter as command line. This single string can contain the filename to run plus the argument for that file. Cmd.exe will take care of it including long filename. If you want to pass more than one command line, you have to concatenate using symbol &quot;&amp;&amp;&quot;<br />But on 9X, command.com treat the argument an array of string (separated by spaces) this is why you have to call rundos differently for long filename in 9X (i mentioned this earliar)<br /><br />in W2K -&gt; RunDOS notepad readme first.txt<br />in W9X -&gt; RunDOS notepad &quot;readme first.txt&quot;<br /><br />Look at this code<br /><pre><code><br />; NT<br />invoke lstrcat, Addr lc_Params, SAddr&#40;&quot;Cmd.exe /C &quot;&quot;&quot;&#41;<br />.While &#40;ln_Count &gt; 0&#41;<br />   invoke lstrcat, Addr lc_Params, CL_argv&#91;esi&#93;<br />   .If &#40;ln_Count &gt; 1&#41;<br />      invoke lstrcat, Addr lc_Params, SAddr&#40;&quot; &quot;&#41;<br />      add esi, 4<br />   .endif<br />   dec ln_Count<br />.EndW<br />invoke lstrcat, Addr lc_Params, SAddr&#40;&quot;&quot;&quot;&quot;&#41;<br /></code></pre><br />If i run the program like this -&gt; rundos notepad readme file.txt<br /><br />The lc_Params will be form like this -&gt; Cmd.exe /C &quot;notepad readme file.txt&quot; <br /><br /><pre><code><br />;9X<br />invoke lstrcat, Addr lc_Params, SAddr&#40;&quot;Command.Com /C &quot;&#41;<br /><br />.While &#40;ln_Count &gt; 0&#41;<br />   invoke lstrcat, Addr lc_Params, SAddr&#40;&quot;&quot;&quot;&quot;&#41;<br />   invoke lstrcat, Addr lc_Params, CL_argv&#91;esi&#93;<br />   invoke lstrcat, Addr lc_Params, SAddr&#40;&quot;&quot;&quot;&quot;&#41;<br />   .If &#40;ln_Count &gt; 1&#41;<br />      invoke lstrcat, Addr lc_Params, SAddr&#40;&quot; &quot;&#41;<br />      add esi, 4<br />   .endif<br />   dec ln_Count<br />.EndW<br /></code></pre><br />If i run the program like this -&gt; rundos notepad readme file.txt<br /><br />The lc_Params will be form like this -&gt; Command.com /C &quot;notepad&quot; &quot;readme&quot; &quot;file.txt&quot; <br /><br />So -&gt; RunDOS notepad &quot;readme first.txt&quot;<br /><br />will be form -&gt; Command.com /C &quot;notepad&quot; &quot;readme file.txt&quot; <br /><br />Well, that's it I guess :grin: <br />I am sorry if it takes too long, cause my english is not good and i can't explain it in a proper word<br /><br />Regards :alright:</div>
    <div class="meta">Posted on 2003-01-05 03:37:24 by HermanT</div>
   </div>
   <div class="post" id="post-74419">
    <div class="subject"><a href="#post-74419">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">NaN,<br /><br />The &quot;shell&quot; proc works fine and is a part of the end of the installation in MASM32. It is not specifically designed for multithreading but thats hardly a problem when you want to synchronously stop one app while it runs another.<br /><br />If you wanted to use LOCAL memory for the structures, all you need to do is get the length of both structures and use a REP STOSD or similar to initialise them to zero.<br /><br />It is by design a simple and unproblematic procedure that works well in practice. You don't need to run ExitProcess() as the application that is started is shut down to restart the calling app.<br /><br />GetExitCodeProcess is a published API function designed to work with CreateProcess so it is not a problem.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2003-01-05 03:39:04 by hutch--</div>
   </div>
   <div class="post" id="post-74424">
    <div class="subject"><a href="#post-74424">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">Ok.. im confused...<br /><br />On one hand, i read that i have to do special consideration for WinNT/2000/XP users (big surprise :rolleyes: ), and on the other hand i have Hutch defending the Shell saying it worked in the Masm32... (and i *know* NT users arnt complaining about it).<br /><br />So Why is HermanT getting crashes??<br /><br />HermanT, please post the Error info (EIP, EBP, ESP,..... etc. etc.) so that i can look at where your getting this problem.<br /><br />Anywho.. here is the latest version.  It nolonger requires PROTO and COFF lables. It parses and extracts the PROTO info from the PROC line.<br /><br />It looks for '&lt;Space/tab&gt;PROC' as a start point, and '&lt;Space/tab&gt;ENDP' to end the function.  You only need headers tags now.  The files generated are based on the first 8 chars of the file name.  As well, the PROC/ENDP is not case sensitive in the search ;)<br /><br />Example File:<br /><pre><code>;#HEADER START<br />.386<br />.model flat,stdcall<br />option casemap&#58;none<br /><br />include D&#58;\MASM32\INCLUDE\kernel32.inc<br /><br />;#HEADER END<br /><br /><br />a2dw proc uses ecx edi edx esi String&#58;DWORD<br /><br />      ;----------------------------------------<br />      ; Convert decimal string into dword value<br />      ; return value in eax<br />      ;----------------------------------------<br /><br />      xor ecx, ecx<br />      mov edi, String<br />      invoke lstrlen, String<br /><br />      .while eax != 0<br />        xor edx, edx<br />        mov dl, byte ptr &#91;edi&#93;<br />        sub dl, &quot;0&quot; ; subtrack each digit with &quot;0&quot; to convert it to hex value<br />        mov esi, eax<br />        dec esi<br />        push eax<br />        mov eax, edx<br />        push ebx<br />        mov ebx, 10<br />          .while esi &gt; 0<br />            mul ebx<br />            dec esi<br />          .endw<br />        pop ebx<br />        add ecx, eax<br />        pop eax<br />        inc edi<br />        dec eax<br />      .endw<br /><br />        mov eax, ecx<br />        ret<br /><br />a2dw endp<br /><br /><br />atodw proc String&#58;DWORD<br /><br />  ; ----------------------------------------<br />  ; Convert decimal string into dword value<br />  ; return value in eax<br />  ; ----------------------------------------<br /><br />    push esi<br />    push edi<br /><br />    xor eax, eax<br />    mov esi, &#91;String&#93;<br />    xor ecx, ecx<br />    xor edx, edx<br />    mov al, &#91;esi&#93;<br />    inc esi<br />    cmp al, 2D<br />    jne proceed<br />    mov al, byte ptr &#91;esi&#93;<br />    not edx<br />    inc esi<br />    jmp proceed<br /><br />  @@&#58; <br />    sub al, 30h<br />    lea ecx, dword ptr &#91;ecx+4*ecx&#93;<br />    lea ecx, dword ptr &#91;eax+2*ecx&#93;<br />    mov al, byte ptr &#91;esi&#93;<br />    inc esi<br /><br />  proceed&#58;<br />    or al, al<br />    jne @B<br />    lea eax, dword ptr &#91;edx+ecx&#93;<br />    xor eax, edx<br /><br />    pop edi<br />    pop esi<br /><br />    ret<br /><br />atodw endp<br /><br />END<br /></code></pre><br />If you have function specific .data to include it must be added within the proc itself!  This is no big deal:<pre><code>Bla PROC<br />.data<br />  Mydata dd 0<br />.code<br /><br /> ...<br /> rest of proc<br /> ...<br /> ret<br />BLa ENDP</code></pre><br /><br />This version has no changes regarding this NT crash business... Pleae let me know if it crashes or not, your platform, and debug info if you can.. <br /><br />Otherwise, it works pretty good on Win98SE... <br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-01-05 04:50:48 by NaN</div>
   </div>
   <div class="post" id="post-74425">
    <div class="subject"><a href="#post-74425">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">For everyone to debate.. here is the code im using to run processes:<pre><code>   xor eax, eax<br />   lea edx, buffer<br />   mov &#91;edx&#93;, eax<br />   invoke szCatStr, addr buffer, CStr&#40;&quot;ML.EXE /c /coff &quot;&#41;<br />   invoke szCatStr, addr buffer, addr tempDir<br />   invoke szCatStr, addr buffer, CStr&#40;&quot;*.ASM&quot;&#41;<br />   invoke ExecuteApp, addr buffer</code></pre><br /><br />And the Function:<pre><code>ExecuteApp PROC lpfilename&#58;DWORD<br />   LOCAL st_info     &#58;STARTUPINFO<br />   LOCAL pr_info     &#58;PROCESS_INFORMATION<br /><br />   invoke RtlZeroMemory, addr st_info, sizeof STARTUPINFO<br />   invoke RtlZeroMemory, addr pr_info, sizeof PROCESS_INFORMATION<br />   mov st_info.cb, sizeof STARTUPINFO<br />   mov st_info.dwFlags, STARTF_USESHOWWINDOW<br />   mov st_info.wShowWindow, SW_HIDE<br /><br />   invoke CreateProcess,NULL,lpfilename,NULL,NULL,<br />                        NULL,NULL,NULL,NULL,<br />                        ADDR st_info,<br />                        ADDR pr_info<br />   @@&#58;<br />   invoke WaitForSingleObject, pr_info.hProcess, 300<br />   cmp eax, WAIT_OBJECT_0<br />   jne @B<br /><br />   invoke CloseHandle, pr_info.hThread<br />   invoke CloseHandle, pr_info.hProcess<br />   invoke TerminateProcess, pr_info.hProcess, NULL   <br />   ret   <br />ExecuteApp ENDP</code></pre><br /><br />Please feel free to point out any problems...<br />:nAn:</div>
    <div class="meta">Posted on 2003-01-05 04:58:37 by NaN</div>
   </div>
   <div class="post" id="post-74427">
    <div class="subject"><a href="#post-74427">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body"><strong>NaN</strong>: It crashes on my system too (w2k sp3), it appears you call GetCurrentDirectory with the parameters in the wrong order; the first parameter is the buffer size, the second the buffer pointer. On one of the calls (the one before SetCurrentDirectory and StdOut(&quot;Compiling Functions...&quot;)), you have 100h as the buffer pointer and the address of some local buffer as the buffer size :).<br /><br />Thomas<br /><br /><strong>edit:</strong> Your tool seems to work fine after I fixed the bug, except for that the lib is called 'test' without an extension.</div>
    <div class="meta">Posted on 2003-01-05 05:29:53 by Thomas</div>
   </div>
   <div class="post" id="post-74434">
    <div class="subject"><a href="#post-74434">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">NaN<br /><br />I think you don't have to use TerminateProcess cause it's already terminated when eax == WAIT_OBJECT_0, unless you have something in the process you created. Also you can actually use INFINITE for the time out<br /><pre><code><br />; wait for the interval to elapse<br />@@&#58;<br />  invoke WaitForSingleObject, pr_info.hProcess, 300<br />  cmp eax, WAIT_OBJECT_0<br />  jne @B<br /><br />; --- replace with<br />; wait until the process terminated<br />  invoke WaitForSingleObject, pr_info.hProcess, INFINITE<br /></code></pre><br /><br />Btw, here is the crashed log<br /><pre><code><br />Microsoft &#40;R&#41; Windows 2000 &#40;TM&#41; Version 5.00 DrWtsn32<br />Copyright &#40;C&#41; 1985-1999 Microsoft Corp. All rights reserved.<br /><br />Application exception occurred&#58;<br />        App&#58;  &#40;pid=1252&#41;<br />        When&#58; 05-01-2003 @ 14&#58;58&#58;48.514<br />        Exception number&#58; c0000005 &#40;access violation&#41;<br /><br />*----&gt; Task List &lt;----*<br />   0 Idle.exe<br />   8 System.exe<br /> 156 SMSS.exe<br /> 180 CSRSS.exe<br /> 200 WINLOGON.exe<br /> 228 SERVICES.exe<br /> 240 LSASS.exe<br /> 396 svchost.exe<br /> 428 svchost.exe<br /> 480 spoolsv.exe<br /> 540 regsvc.exe<br /> 556 mstask.exe<br /> 584 WinMgmt.exe<br /> 628 inetinfo.exe<br />1092 explorer.exe<br /> 888 CTHELPER.exe<br /> 992 EM_EXEC.exe<br />1132 loadqm.exe<br /> 844 netsrv.exe<br />1212 Proxomitron.exe<br /> 308 IEXPLORE.exe<br />1084 msimn.exe<br /> 860 NC.exe<br />1076 NTVDM.exe<br /> 284 NTVDM.exe<br />1040 CMD.exe<br />1252 LIBM.exe<br />1208 DRWTSN32.exe<br />   0 _Total.exe<br /><br />&#40;00400000 - 00404000&#41; <br />&#40;77F80000 - 77FFB000&#41; <br />&#40;77E80000 - 77F35000&#41; <br /><br />State Dump for Thread Id 0x364<br /><br />eax=7ffdec08 ebx=00000045 ecx=7ffb0222 edx=00000014 esi=00000104 edi=00000004<br />eip=77f82eb0 esp=0012f8b4 ebp=0012f8c0 iopl=0         nv up ei ng nz ac po cy<br />cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000297<br /><br /><br />function&#58; RtlUnicodeToMultiByteN<br />        77f82e8f 8a1c0b           mov     bl,&#91;ebx+ecx&#93;                 ds&#58;7ffb0222=00<br />        77f82e92 885ef9           mov     &#91;esi+0xf9&#93;,bl                ds&#58;00a7d6d6=??<br />        77f82e95 0fb758f4         movzx   ebx,word ptr &#91;eax+0xf4&#93;    ds&#58;80a5c1db=????<br />        77f82e99 8a1c0b           mov     bl,&#91;ebx+ecx&#93;                 ds&#58;7ffb0222=00<br />        77f82e9c 885efa           mov     &#91;esi+0xfa&#93;,bl                ds&#58;00a7d6d6=??<br />        77f82e9f 0fb758f6         movzx   ebx,word ptr &#91;eax+0xf6&#93;    ds&#58;80a5c1db=????<br />        77f82ea3 8a1c0b           mov     bl,&#91;ebx+ecx&#93;                 ds&#58;7ffb0222=00<br />        77f82ea6 885efb           mov     &#91;esi+0xfb&#93;,bl                ds&#58;00a7d6d6=??<br />        77f82ea9 0fb758f8         movzx   ebx,word ptr &#91;eax+0xf8&#93;    ds&#58;80a5c1db=????<br />        77f82ead 8a1c0b           mov     bl,&#91;ebx+ecx&#93;                 ds&#58;7ffb0222=00<br />FAULT -&gt;77f82eb0 885efc           mov     &#91;esi+0xfc&#93;,bl                ds&#58;00a7d6d6=??<br />        77f82eb3 0fb758fa         movzx   ebx,word ptr &#91;eax+0xfa&#93;    ds&#58;80a5c1db=????<br />        77f82eb7 8a1c0b           mov     bl,&#91;ebx+ecx&#93;                 ds&#58;7ffb0222=00<br />        77f82eba 885efd           mov     &#91;esi+0xfd&#93;,bl                ds&#58;00a7d6d6=??<br />        77f82ebd 0fb758fc         movzx   ebx,word ptr &#91;eax+0xfc&#93;    ds&#58;80a5c1db=????<br />        77f82ec1 8a1c0b           mov     bl,&#91;ebx+ecx&#93;                 ds&#58;7ffb0222=00<br />        77f82ec4 885efe           mov     &#91;esi+0xfe&#93;,bl                ds&#58;00a7d6d6=??<br />        77f82ec7 0fb758fe         movzx   ebx,word ptr &#91;eax+0xfe&#93;    ds&#58;80a5c1db=????<br />        77f82ecb 8a1c0b           mov     bl,&#91;ebx+ecx&#93;                 ds&#58;7ffb0222=00<br />        77f82ece 885eff           mov     &#91;esi+0xff&#93;,bl                ds&#58;00a7d6d6=??<br />        77f82ed1 6a10             push    0x10<br />        77f82ed3 2bd7             sub     edx,edi<br /><br />*----&gt; Stack Back Trace &lt;----*<br /><br />FramePtr ReturnAd Param#1  Param#2  Param#3  Param#4  Function Name<br />0012F8C0 77F8302A 00000100 00000014 0012F8F8 7FFDEC00 ntdll!RtlUnicodeToMultiByteN <br />0012F8EC 77E88B87 0012F908 00000014 00000000 00132FA7 ntdll!RtlUnicodeStringToAnsiString <br />0012F910 00401EB6 00000014 00000100 7FFDF000 00000000 kernel32!GetCurrentDirectoryA <br />0012FFBC 004018BE 77E8D326 00000000 00000000 7FFDF000 !&lt;nosymbols&gt; <br />0012FFF0 00000000 004018B9 00000000 000000C8 00000100 !&lt;nosymbols&gt; <br /><br />*----&gt; Raw Stack Dump &lt;----*<br />0012f8b4  f8 eb fd 7f 08 f9 12 00 - 00 00 00 00 ec f8 12 00  ................<br />0012f8c4  2a 30 f8 77 00 01 00 00 - 14 00 00 00 f8 f8 12 00  *0.w............<br />0012f8d4  00 ec fd 7f 28 00 00 00 - fe ff 00 00 f8 eb fd 7f  ....&#40;...........<br />0012f8e4  bf fd 12 00 00 00 00 00 - 10 f9 12 00 87 8b e8 77  ...............w<br />0012f8f4  08 f9 12 00 14 00 00 00 - 00 00 00 00 a7 2f 13 00  ............./..<br />0012f904  bc fc 12 00 14 00 fe ff - 00 01 00 00 bc ff 12 00  ................<br />0012f914  b6 1e 40 00 14 00 00 00 - 00 01 00 00 00 f0 fd 7f  ..@.............<br />0012f924  00 00 00 00 00 00 00 00 - 00 e0 20 20 00 00 80 d3  ..........  ....<br />0012f934  a0 d3 8f b4 c2 01 80 d3 - a0 d3 8f b4 c2 01 80 d3  ................<br />0012f944  a0 d3 8f b4 c2 01 00 00 - 00 00 1f 01 00 00 00 00  ................<br />0012f954  00 00 00 00 00 00 54 77 - 6f 2e 61 73 6d 00 63 00  ......Two.asm.c.<br />0012f964  0c fd 12 00 0c fd 12 00 - 0c fd 12 00 19 99 fb 77  ...............w<br />0012f974  78 b2 f8 77 ff ff ff ff - 98 fc 12 00 c3 fe f8 77  x..w...........w<br />0012f984  30 fd 12 00 00 f0 fd 7f - 00 e0 fd 7f 00 00 00 00  0...............<br />0012f994  43 00 3a 00 5c 00 57 00 - 49 00 4e 00 4e 00 54 00  C.&#58;.\.W.I.N.N.T.<br />0012f9a4  5c 00 53 00 79 00 73 00 - 74 00 65 00 6d 00 33 00  \.S.y.s.t.e.m.3.<br />0012f9b4  32 00 5c 00 6e 00 74 00 - 64 00 6c 00 6c 00 2e 00  2.\.n.t.d.l.l...<br />0012f9c4  64 00 6c 00 6c 00 00 00 - 72 00 6f 00 73 00 6f 00  d.l.l...r.o.s.o.<br />0012f9d4  66 00 74 00 5c 00 57 00 - 69 00 6e 00 64 00 6f 00  f.t.\.W.i.n.d.o.<br />0012f9e4  77 00 73 00 20 00 4e 00 - 54 00 5c 00 43 00 75 00  w.s. .N.T.\.C.u.<br /></code></pre><br /><br /><br />You don't have to confuse about the different things between 9X - NT (It's only based on my experienced :) ) as long as you play safety, e.g.: use a short filename (8.3 format) just leave it to the system.<br /><br /><br />:alright:</div>
    <div class="meta">Posted on 2003-01-05 06:55:21 by HermanT</div>
   </div>
   <div class="post" id="post-74443">
    <div class="subject"><a href="#post-74443">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">NaN, indeed the TerminateProcess call should be superfluous; if you're going to use it for other purposes another day, know that it's not a 100% clean way to terminate other apps, as certain resources might not be cleaned out. DLL usage counts etc...<br /><br />Also, as herman noticed, use INFINITE as you value for WaitForSingleObject. The neat thing about WaitForSingleObject is that your thread wont be scheduled until the object is triggered, which means you use a little less CPU time than looping WaitForSingleObject or GetExitCodeProcess. Sure, this is hardly noticeable in cases like this, but every little thing counts, right? ;)<br /><br />herman, why is it you call command.com or cmd.exe to spawn external processes? It ought to be superfluous (unless you're doing it to use shell commands like &quot;copy&quot;, in which case you really ought to write your own routines :)).</div>
    <div class="meta">Posted on 2003-01-05 08:41:19 by f0dder</div>
   </div>
   <div class="post" id="post-74473">
    <div class="subject"><a href="#post-74473">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">Thanx to:<br /><br /><strong><em>  f0dder, HermanT, Hutch, Japheth, and Thomas </strong></em><br /><br />Everything should be corrected for now.<br /><br />I also added in an optional directory output location, so you can specifiy an dir if you dont want to use the temp dir.<br /><br /><strong>Use optional output dir:</strong><br /><br />LIBM .\include\MyAsm.asm .\NewOutDir<br />LIBM X:\Path\MyAsm.asm X:\Path\NewOutDir<br /><br /><strong>Use Temp Dir:</strong><br /><br />LIBM .\include\MyAsm.asm<br />LIBM X:\Path\MyAsm.asm <br /><br />You only need to spell out the ;#HEADER START/STOP section.  Everything else is done automatically (assuming you use PROC and ENDP statements ;) ). <br /><br />I didnt remake an assembler, so dont expect perfect handling for all cases.  If your source compiles, it will run fine thru this tool.  However, you have to be mindfull of any .data/.const./data? sections you use.   <br /><br />If you want it to repeate into every function, place it in the scope of the HEADER area.  If its specific to a function, place it in the scope of the PROC/ENDP statements..<br /><br />Thats it!  Have fun, and please give feedback ;)<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-01-05 14:28:59 by NaN</div>
   </div>
   <div class="post" id="post-74477">
    <div class="subject"><a href="#post-74477">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body"><span style="font-size:120>WARNING!</span> <br /><br />I forgot to mention, if you specify an alternate direcotry that exists it will erase the contents of the directory before executing!<br /><br /><strong>So DO NOT SPECIFY \masm\include</strong> as an altenate!<br /><br />It was designed this way cause i wanted a local temp area that was easy to look at the outputs (ie, a subdirectory of your working project directory).<br /><br />I've been using it with <strong>.\libout</strong> from within the directory im building the lib.</div>
    <div class="meta">Posted on 2003-01-05 15:05:08 by NaN</div>
   </div>
   <div class="post" id="post-74486">
    <div class="subject"><a href="#post-74486">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">Your tool's becoming very dangerous, NaN :grin: <br /><br />I have tested version 2.1 (you may soon reach version 10.0 if speed doesnt slow down)<br /><br />A very simple test with:<br /><br /><pre><code><br />;#HEADER START<br />.386<br />.model flat,stdcall<br />option casemap&#58;none<br />;#HEADER END<br /><br />;#COFF_PROC Two<br />;#PROTO Two PROTO<br />.code<br />Two   PROC<br />   nop<br />   nop<br />   ret<br />Two   ENDP<br />;#COFF_ENDP<br /><br />#COFF_PROC xxx<br /><br />myfavorite proc private<br />  mov eax, 1<br />  mov ecx, 2<br />  ret<br />myfavorite endp<br /><br /><br />mypublic proc public<br />  call myfavorite<br />  mov edx, 1<br />  ret<br />mypublic endp<br /><br />;#COFF_ENDP<br /><br /><br />end<br /></code></pre><br /><br />Now guess what has happened! :) <br /><br /><br /><br />1. compile error since procs myfavorite and mypublic are in different source files (You obviously havent read my last post. Your tools ignores the #COFF statements now, which is BAD.<br /><br />2. myfavorite as file name has been truncated to 8 bytes. Im relatively sure if I would have 2 procs myfavorite1 and myfavorite2, I will possibly have to search a while for .OBJ of myfavorite1. Havent tested that though<br /><br />Regards<br /><br />Japheth</div>
    <div class="meta">Posted on 2003-01-05 16:34:39 by japheth</div>
   </div>
   <div class="post" id="post-74490">
    <div class="subject"><a href="#post-74490">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body"><strong>japheth</strong>: although <strong>NaN</strong> has written a nice tool, why doesn't the method on the site <strong>bitRAKE</strong> showed work for you? The only downside is that you have to create a segment around each function and run a utility to set the comdat flags but isn't the result the same as with NaN's tool?<br /><br />Thomas</div>
    <div class="meta">Posted on 2003-01-05 17:02:19 by Thomas</div>
   </div>
   <div class="post" id="post-74492">
    <div class="subject"><a href="#post-74492">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">Im open for suggetions...<br /><br />If you think you can spell out a methology to do things correctly, let me know...  <br />Perhaps external definitions in the header? (i will play around a bit).<br /><br />If you have a better idea for the file names, please speak up, cause it has to come from somewhere (and i limit it to 8.3 standard).  How about FILE001.asm, FILE002.ASM .... would that be better? (perhaps another switch?)<br /><br />:nAn:</div>
    <div class="meta">Posted on 2003-01-05 17:12:19 by NaN</div>
   </div>
   <div class="post" id="post-74496">
    <div class="subject"><a href="#post-74496">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">Thomas, <br /><br />Its nice to see someone likes it...<br /><br />As well, i tried the tool from the link, and while it claims to set up COFF flags in the .OBJ, it doesnt, and still links the entire .obj, not just the proc being called for..<br /><br />This is why i decieded to make this tool..  (( I hade CFile.asm already which took out 40% of the problem to start with ~~ if you remember this class )).<br /><br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-01-05 17:15:27 by NaN</div>
   </div>
   <div class="post" id="post-74497">
    <div class="subject"><a href="#post-74497">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body"><strong>NaN</strong>: I tried it with two procs and only one actually used and the proc that wasn't referenced disappeared from the mapfile when I used the enablecomdat tool. Though I haven't checked the actual executable, I assume the map file is correct. I'll have another look tomorrow, I'm too tired right now.<br /><br />Thomas</div>
    <div class="meta">Posted on 2003-01-05 17:18:44 by Thomas</div>
   </div>
   <div class="post" id="post-74500">
    <div class="subject"><a href="#post-74500">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">Ya, i dissasembled the One / Two example with one nop, and two nop's in speparate proc's (with segments around it).  When dissasembled with OlyDbg it has both of them in there even tho i only called One. :rolleyes:</div>
    <div class="meta">Posted on 2003-01-05 17:28:47 by NaN</div>
   </div>
   <div class="post" id="post-74506">
    <div class="subject"><a href="#post-74506">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">NaN, my suggestion ?s:<br /><br />1. procs outside of #COFF blocks your tools may handle like it does currently. procs inside #COFF blocks your tool shouldnt touch.<br /><br />2. your tool shouldnt care about the 8.3 naming scheme, at least not inside #COFF blocks.</div>
    <div class="meta">Posted on 2003-01-05 18:02:30 by japheth</div>
   </div>
   <div class="post" id="post-74507">
    <div class="subject"><a href="#post-74507">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body"><div class="quote"><br />NaN, my suggestion ?s:<br /><br />1. procs outside of #COFF blocks your tools may handle like it does currently. procs inside #COFF blocks your tool shouldnt touch.<br /><br />2. your tool shouldnt care about the 8.3 naming scheme, at least not inside #COFF blocks. </div><br /><br />This makes no sense to me.  If you want to ignore stuff inside coff blocks, then simply dont add the 'stuff'...?<br /><br />As well, there is no 8.3 scheme inside anything..  Its to generate file names from function lables.??</div>
    <div class="meta">Posted on 2003-01-05 18:08:12 by NaN</div>
   </div>
   <div class="post" id="post-74509">
    <div class="subject"><a href="#post-74509">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">Japheth, the tool as is will handle your concerns... i just had to play and discover how to handle them :grin:<br /><br /><strong>Here is a sample test file</strong>:<pre><code>;#HEADER START<br />.386<br />.model flat,stdcall<br />option casemap&#58;none<br /><br />include D&#58;\MASM32\INCLUDE\kernel32.inc<br /><br />;#HEADER END<br />.code<br /><br />One proc uses ecx edi edx esi String&#58;DWORD<br />&#91;b&#93;Two PROTO &#58;DWORD<br />NEST_NEXT TEXTEQU &lt;endp&gt;&#91;/b&#93;  ; This could be placed in the header as well<br />   nop<br />   nop<br />   invoke Two,1 <br />   ret<br /><br />One &#91;b&#93;NEST_NEXT&#91;/b&#93;<br /><br />Two proc &#91;b&#93;private&#91;/b&#93; String&#58;DWORD<br />   nop<br />   nop<br />   nop<br />   nop<br />   ret<br />Two endp<br /><br />end</code></pre><br /><br /><strong>If i comple a test program to use the generated test.inc/test.lib:</strong><pre><code>.386<br />.model flat,stdcall<br />option casemap&#58;none<br /><br />include \masm32\include\kernel32.inc<br />includelib \masm32\lib\kernel32.lib<br /><br />include test.inc<br />includelib test.lib<br />.code<br />start&#58;<br />   invoke One, 4<br />   invoke ExitProcess, 0<br />end start<br />END</code></pre><br /><br />The generated file is:<pre><code>00401008 &gt; $ 6A 04          PUSH 4<br />0040100A   . E8 0D000000    CALL TEST2.0040101C<br />0040100F   . 6A 00          PUSH 0                                   ; /ExitCode = 0<br />00401011   . E8 00000000    CALL &lt;JMP.&amp;KERNEL32.ExitProcess&gt;         ; \ExitProcess<br />00401016   $-FF25 00104000  JMP DWORD PTR DS&#58;&#91;&lt;&amp;KERNEL32.ExitProcess&gt;<br />0040101C  /$ 55             PUSH EBP<br />0040101D  |. 8BEC           MOV EBP,ESP<br />0040101F  |. 51             PUSH ECX<br />00401020  |. 57             PUSH EDI<br />00401021  |. 52             PUSH EDX<br />00401022  |. 56             PUSH ESI<br />00401023  |. 90             NOP<br />00401024  |. 90             NOP<br />00401025  |. 6A 01          PUSH 1<br />00401027  |. E8 08000000    CALL TEST2.00401034<br />0040102C  |. 5E             POP ESI<br />0040102D  |. 5A             POP EDX<br />0040102E  |. 5F             POP EDI<br />0040102F  |. 59             POP ECX<br />00401030  |. C9             LEAVE<br />00401031  \. C2 0400        RETN 4<br />00401034  /$ 55             PUSH EBP<br />00401035  |. 8BEC           MOV EBP,ESP<br />00401037  |. 90             NOP<br />00401038  |. 90             NOP<br />00401039  |. 90             NOP<br />0040103A  |. 90             NOP<br />0040103B  |. C9             LEAVE<br />0040103C  \. C2 0400        RETN 4</code></pre><br /><br />And the generated test.inc only has a proto for the function One!  Its design is to find a 'PROC' then find the 'ENDP' and then make an asm file based on the data inbetween.. So you nest as many private procs all the way down with the macro, just place a final ENDP when the last private proc is included (to close the file's scope).<br /><br />Hopefully this is what your hoping for?  The only overhead is masking the ENDP until the desired scope is finished, and providing a PROTO within the calling PROC, which is a hell of alot easier than redesigning the tool's engine...<br /><br />Try it out and let me know what you think..<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-01-05 18:33:18 by NaN</div>
   </div>
   <div class="post" id="post-74526">
    <div class="subject"><a href="#post-74526">How to achieve &quot;function level linking&quot; with MASM?</a></div>
    <div class="body">NaN,<br /><br />An obvious suggestion if you want synchronous operation with command line tools is to write a batch file that does the work you want. It does not work with GUI apps with a message loop but a linear console app works fine.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2003-01-05 20:19:06 by hutch--</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=9910&amp;page=1" style="">&laquo;</a><a href="../?id=9910&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="9910" /><input type="number" name="page" min="1" max="3" step="1" value="2" onchange="this.form.submit();" /><a href="../?id=9910&amp;page=3">&gt;</a><a href="../?id=9910&amp;page=3">&raquo;</a></form>  </div>
 </body>
</html>