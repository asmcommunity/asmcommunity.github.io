<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>on win9x it works - on NT not...why ? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=3956" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=3956">on win9x it works - on NT not...why ?</a></p>
   <div class="post" id="post-26894">
    <div class="subject"><a href="#post-26894">on win9x it works - on NT not...why ?</a></div>
    <div class="body">hossa,<br /><br />i start coding my own registry enum function and on my win98 se it work fine ,then i send it to a friend who use NT and it wont work.<br />he is loged in as admin ,i dont use KEY_ALL_ACCESS.<br /><br />any ideas what might be wrong ?<br /><br />thanks<br /><br /><br />                .386<br />                .MODEL FLAT,STDCALL<br />               <br /><br />                UNICODE=0<br /><br />                include  w32.inc<br /><br /><br /><br />extrn lstrcat                          : proc<br />extrn lstrcpy		:Proc<br />extrn lstrcatA		:Proc<br />extrn lstrcmpi		:Proc<br />extrn RegOpenKeyA:proc<br />extrn RegEnumValueA:proc<br />extrn RegEnumKeyEx:proc<br /><br />.DATA<br />;[--------==========================================================--------];<br /><br />IndexNum	dd 0<br />szRegPath	db      256 dup(?),0<br />szKeyName              db &quot;\&quot;  ,0<br />Error	                db &quot;ERROR&quot;,0<br /><br />TType        dd ?<br />pKey          dd ?<br />lpszBuffer dd ?<br /><br />.data?<br />szTopKey    dd ?<br /><br />.CODE<br />;[--------==========================================================--------];<br /><br />main:<br />  <br />                mov szTopKey, HKEY_LOCAL_MACHINE<br />                call   EnumReg<br /><br />                call   ExitProcess ,0                <br /><br />;[--------==========================================================--------];<br />EnumReg proc<br /><br />firstrun:<br />                mov  TType, REG_NONE<br />                call   RegCreateKey,szTopKey,offset szKeyName,offset pKey<br />               cmp   eax,ERROR_SUCCESS <br />               jnz     @Error<br /> <br />@loop:<br />             call      RegEnumKey, pKey, IndexNum, offset szRegPath, 255<br />            cmp     eax,ERROR_NO_MORE_ITEMS<br />              je        @endloop<br />            call       RegQueryValueEx, pKey, lpszValueName,NULL, offset TType, lpszBuffer, 256 <br />            call       MessageBox,0,offset szRegPath,offset szRegPath,+MB_YESNO<br />             cmp     eax,IDNO<br />                 je     @endloop<br />            inc        IndexNum<br />            jmp       @loop<br /><br />@endloop:<br />	call    RegCloseKey, pKey<br />	mov  IndexNum, 0<br />                ret<br /><br />@Error:<br />                call  MessageBox,0,offset Error,offset Error,0<br />                ret<br /><br /><br />EnumReg endp<br />;[--------==========================================================--------];<br /><br />ends<br />end main</div>
    <div class="meta">Posted on 2002-03-03 06:21:20 by Max</div>
   </div>
   <div class="post" id="post-26897">
    <div class="subject"><a href="#post-26897">on win9x it works - on NT not...why ?</a></div>
    <div class="body">Hi,<br /><br />i once had the same problem, too. dunno why...but KEY_ALL_ACCESS did it! <br /><br />NOP</div>
    <div class="meta">Posted on 2002-03-03 06:57:14 by NOP-erator</div>
   </div>
   <div class="post" id="post-26912">
    <div class="subject"><a href="#post-26912">on win9x it works - on NT not...why ?</a></div>
    <div class="body">--------<br />but KEY_ALL_ACCESS did it!<br />--------<br /><br />this mean it worked for you ?<br />because i try it with :<br /><br />call RegCreateKey, szTopKey,offset szKeyName,0,0,0,KEY_ALL_ACCESS,0,offset pKey,offset TType<br /><br />and again..error<br /><br />if i use regcreatekey as single function it worked and i set a new key but if i use it in the enum function not.<br />thats hard to understand.<br /><br />how do you set your key on nt ?</div>
    <div class="meta">Posted on 2002-03-03 09:00:13 by Max</div>
   </div>
   <div class="post" id="post-26922">
    <div class="subject"><a href="#post-26922">on win9x it works - on NT not...why ?</a></div>
    <div class="body">Max,<br /><br />may be that is because your function call &quot;RegEnumValueEx&quot; is still wrong. Last parameter is a pointer to a dword containing the size of the buffer (and will be filled by the function with length of value). I vaguely remember having posted that some time ago.<br /><br />japheth</div>
    <div class="meta">Posted on 2002-03-03 09:40:03 by japheth</div>
   </div>
   <div class="post" id="post-27115">
    <div class="subject"><a href="#post-27115">on win9x it works - on NT not...why ?</a></div>
    <div class="body">hossa<br /><br />so there is the misstake :)<br />thanks !<br /><br />since im a newbie i take the calls to work with the registry from VomBonjour (sorry if name is wrong) registry samples.<br />possible he had to check his sources ,too :)<br />i browse now google to see how to set regkeys right ,seams most use nt here but dont know how to set keys so i make a sample tutorial for working with registry :)<br /><br />ps: the source works well on Win98se so its hard to understand that the error i get on NT come from a wrong reg call :-)</div>
    <div class="meta">Posted on 2002-03-04 04:52:49 by Max</div>
   </div>
   <div class="post" id="post-27120">
    <div class="subject"><a href="#post-27120">on win9x it works - on NT not...why ?</a></div>
    <div class="body">Don't use KEY_ALL_ACCESS under NT that's it.<br />It mentioned in many sources.<br />And there is no need for KEY_ALL_ACCESS whatever.<br />Exept of course as excuse for lazyness.</div>
    <div class="meta">Posted on 2002-03-04 06:30:02 by The Svin</div>
   </div>
   <div class="post" id="post-27140">
    <div class="subject"><a href="#post-27140">on win9x it works - on NT not...why ?</a></div>
    <div class="body">hossa ,<br /><br />thanks for the answer....but<br />i first dont use key_all_access ,i use key_write and it wont work...i read about this in the board archiv.<br /><br />now after browsing google and downloading some samples im wirred !<br />every source use another way to use the registry :(<br />one use regopenkey ,other regopenkeyA ,Ex ....<br />regenum the same...Ex,ExA,A<br />why are more ways for read/write regkeys ?<br />when i start with the registry i think there is only one way you can use it.<br /><br />yesterday i start with the source from VomBonjour ,regenum and port it to tasm.<br />ok ,now i understand more what i do yesterday and i modify it but again it work on win98 only.<br />on nt i get the error message ,so the first reg call is wrong.<br />i also try the function with key_write and again...error<br /><br />im not lazy !<br />but coding this on win98 ,testing it and when it work mailing to a friend ... wait that he test it... get answer mail = wont work.<br />sit again ,think where is the error....fix some small lines ,try again...it work send to my friend ,get back error...become MAD.<br /><br />if i ask here i browse google or try hours try &amp; error.<br />i dont like it to ask questions like.....hey fix my code..do it for me.<br />if i have no client to work for i spend my time learning by doing.<br />so sometime i ask more because i work more with asm ,sometime im weeks not here because i work for other people.<br />im not 20 and have all time in my life to learn from books and so - i had to feet me and others ,pay my bills.<br />only sayed as lame excuse ,for lame questions :-)<br /><br />new code<br />-----------------------------------------<br /><br /><br /><br />               mov szTopKey, HKEY_LOCAL_MACHINE<br />                call   EnumReg<br /><br />                call   ExitProcess ,0                <br /><br />;[--------==========================================================--------];<br />EnumReg proc<br /><br />firstrun:<br />                mov  TType, REG_SZ<br />                call    RegCreateKeyExA,szTopKey,offset szKeyName,0,0,REG_OPTION_NON_VOLATILE,KEY_ALL_ACCESS,0,offset pKey,offset TType<br />               cmp   eax,ERROR_SUCCESS<br />                jnz     @Error<br /><br />@loop:<br />            call      RegEnumKeyA,pKey,IndexNum,offset szRegPath,256<br />            cmp     eax,ERROR_NO_MORE_ITEMS<br />              je        @endloop<br />            call       RegCloseKey, pKey<br /><br />            call       MessageBox,0,offset szRegPath,offset szRegPath,+MB_YESNO<br />             cmp     eax,IDNO<br />                 je     @endloop<br />            inc        IndexNum<br />            jmp       @loop<br /><br />@endloop:<br />	call    RegCloseKey, pKey<br />	mov  IndexNum, 0<br />                ret<br /><br />@Error:<br />                call  RegCloseKey, pKey<br />                call  MessageBox,0,offset Error,offset Error,0<br />                ret<br /><br /><br />EnumReg endp<br /><br /><br />-----------------------<br /><br />any ideas what now might be wrong ?</div>
    <div class="meta">Posted on 2002-03-04 08:28:54 by Max</div>
   </div>
   <div class="post" id="post-27175">
    <div class="subject"><a href="#post-27175">on win9x it works - on NT not...why ?</a></div>
    <div class="body">Max,<br /><br />if u use nt u &quot;must&quot; know that u cant set the regkey &quot;\&quot; to hkey_local_machine<br />i used it to get the first entry...<br /><br />then on NT are much restrictions so create a reg key to enum the reg is stupid and better is open reg key.<br /><br />there is no use of key_all_access ,thats right...in fact there is no use of any key_write or so !<br /><br />the code should look like this and works well under nt and win9x,win2k<br /><br />.DATA<br />;[--------==========================================================--------];<br />IndexNum	dd 0<br /><br />Error	                db &quot;Error&quot;,0<br />Found                    db &quot;Found&quot;  ,0<br /><br />TType                   dd ?<br />pKey                     dd ?<br /><br />.data? <br />szTopKey             dd ?<br />szRegPath            db 255 dup (?)<br /><br />.code<br />;[--------==========================================================--------];<br /><br />main:<br />  <br />                mov szTopKey, HKEY_LOCAL_MACHINE<br />                call   EnumReg<br /><br />                call   ExitProcess ,0                <br /><br />;[--------==========================================================--------];<br />EnumReg proc<br />                call   RegOpenKeyA, szTopKey,0, offset pKey<br />.WHILE TRUE<br />                call   RegEnumKey, pKey, IndexNum, offset szRegPath, 255<br />.BREAK .IF ( eax != ERROR_SUCCESS )              <br />                call   MessageBox,0,offset szRegPath,offset Found,0                         <br />                inc    IndexNum<br />.ENDW     <br />            call       RegCloseKey, pKey<br />            ret<br />EnumReg endp<br /><br />-----------------<br /><br />if u dont know it before im happy to submit my first helpfull src. to this board :)</div>
    <div class="meta">Posted on 2002-03-04 13:35:16 by Max</div>
   </div>
  </div>
 </body>
</html>