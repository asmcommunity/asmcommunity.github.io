<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Win32 API - Dynamic Link Library Loading - behind the scenes - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=4704" />
    <link rel="next" href="../?id=4704&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=4704">Win32 API - Dynamic Link Library Loading - behind the scenes</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=4704&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=4704&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="4704" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=4704&amp;page=2">&gt;</a><a href="../?id=4704&amp;page=2">&raquo;</a></form>   <div class="post" id="post-33021">
    <div class="subject"><a href="#post-33021">Win32 API - Dynamic Link Library Loading - behind the scenes</a></div>
    <div class="body">Hi everybody !<br /><br />My problem is that I want to load a library (DLL)<br />that resides in memory.  Actually this<br />questions is targeted at those amongst you<br />who have got some deeper knowledge of the<br />Win32 Sub-system. Concerning dynamic loading<br />of libraries you would either statically link a DLL's<br />library to the final executable or load the DLL<br />at runtime via LoadLibrary() and then get the<br />the address/handle via GetProcAddress of the<br />relevant function.<br />What I want to do is to load a DLL without using<br />the mentioned functions. Win32 is doing quite a lot<br />_behind the scenes_ - For Example RVA to Offset<br />calculation and such stuff is done via APIs<br />that are rather undocumented. IAT patching is also<br />done in the background - without any user interaction<br />respectively user code being involved in that process.<br />Although I do know a couple of functions that are<br />executed I don't know everything what's going on<br />behind LoadLibrary() and GetProcAddress().<br />In particular I need those functions that are involved<br />with memory mapped files - DLLs are mapped when<br />being executed. So that I would be able to<br />load an image of a DLL that's been loaded into  memory <br />without the usual functions. <br /><br />Thanks for all comments/ideas (if any)<br /><br /><br />regards<br /><br />MikeJ</div>
    <div class="meta">Posted on 2002-04-10 14:25:46 by MikeJ</div>
   </div>
   <div class="post" id="post-33024">
    <div class="subject"><a href="#post-33024">Win32 API - Dynamic Link Library Loading - behind the scenes</a></div>
    <div class="body">Ahhhh..this makes for a great learning process!<br /><br />For starters I would recommend that you use softice to set a break point on the LoadLibrary and/or GetProcAddress function; looking up the arguments and usage inside your Win32 API docs; take notes of the param's passed in; perform some single stepping and then repeat for each new function that you uncover.  Soon enough you will have the answers that you are looking for and so much more as this technique will help you un-lock the secrets of Windows.<br /><br />To help kick you off, I would recommend that you include the following exports in your softice session:<br />(1) Kernel32.dll<br />(2) User32.dll<br />(3) GDI32.dll<br />(4) Ntoskrnl.dll<br />(5) Hal.dll<br /><br />If you run into difficulties and / or have questions about undocumented functions that you find then post back here<br /><br />:alright:</div>
    <div class="meta">Posted on 2002-04-10 14:57:16 by madprgmr</div>
   </div>
   <div class="post" id="post-33031">
    <div class="subject"><a href="#post-33031">Win32 API - Dynamic Link Library Loading - behind the scenes</a></div>
    <div class="body">I'd rather have a good look in a win32 API reference + PE docs than<br />tracing through microsoft's code.<br /><br />The steps in loading a PE file aren't too bad, and there's a couple<br />of ways to do it. Easiest is to create a file mapping, look at SizeOfImage,<br />VirtualAlloc a buffer, and copy in the stuff according to section VAs and<br />such. Then you'll need to apply relocs (unless you can alloc pehdr.imagebase),<br />fix up imports... and you're done. For standard PEs anyway.<br /><br />Perhaps one can use CreateFileMapping with a Copy-On-Write flag instead<br />of loading into an additional buffer... haven't looked into this.</div>
    <div class="meta">Posted on 2002-04-10 15:41:40 by f0dder</div>
   </div>
   <div class="post" id="post-33039">
    <div class="subject"><a href="#post-33039">Win32 API - Dynamic Link Library Loading - behind the scenes</a></div>
    <div class="body"><div class="quote"><em>(5) Hal.dll</em></div>I doubt this dll has anything to do with the loading of dlls, it is the Hardware Abstraction Layer dll, it sits under the kernel and provides an interface to the hardware (therefore it can be different on different machines running the same OS).</div>
    <div class="meta">Posted on 2002-04-10 18:39:47 by sluggy</div>
   </div>
   <div class="post" id="post-33047">
    <div class="subject"><a href="#post-33047">Win32 API - Dynamic Link Library Loading - behind the scenes</a></div>
    <div class="body"><div class="quote">I doubt this dll has anything to do with the loading of dlls</div><br /><br />With full realization of what the dll is for, it does not hurt to have a core componentd of Windows listed under the Exports section of SoftIce when performing Windows system level debugging.  Should on the off chance that you single step into a section that references a area of this dll wouldn't be better to see that symbolic through SoftIce than as a hex number ?  Besides it takes two seconds to add in and the overhead for it is about zilch.<br /><br />However, if you are just installing SoftIce (and then uninstalling) to look at this one issue then yes there is no point in adding this dll; but if you are leaving SoftIce on the system for future debugging then it is my opinion that at best, adding this DLL could not hurt an may actually be of benefit.<br /><br />To each his own.</div>
    <div class="meta">Posted on 2002-04-10 19:35:56 by madprgmr</div>
   </div>
   <div class="post" id="post-33048">
    <div class="subject"><a href="#post-33048">Win32 API - Dynamic Link Library Loading - behind the scenes</a></div>
    <div class="body">Okay, first - thanks so far.<br /><br />Concerning sICE and the BPX(s) you are suggesting-<br />yes, would be admittedly an idea...Personally,<br />I have had a thorough look at imagehlp.dll - this<br />is the DLL that's responsible for PE-file handling.<br /><br />So, I am quite aware of the fact that I need to proceed<br />the subtleties of the PE-files. I do know that the<br />PE format is quite well documented. But actually<br />I was not going to re-implement everything.<br />I am sure that Micro$oft's sub-system provides the<br />corresponding functionality. Well, it's just way<br />too undocumented. Win NT5 is practically passing<br />most kernel32 function calls to NTLOADKRNL.<br /><br />And mapping the file itself isn't a problem - as  already<br />said CreateFileMappingA etc. is the way to go.<br />But I want to work only with/in memory. Sure, I could<br />easily dump the memory area to a file on disk<br />and call the DLL then the old fashioned way.<br /><br />Unfortunately imagehlp.dll is not everything I need-<br />though, it does offer some basic functions that are<br />useful for the said purpose.<br /><br />I have already considered to use sICE - but<br />actually it should be possible to get all information<br />without spending an hour or so in sICE just to <br />find the underlying functions - despite from that<br />there's still the problem to determine the passed<br />parameters. Which to solve would take an additional<br />hour...</div>
    <div class="meta">Posted on 2002-04-10 19:44:19 by MikeJ</div>
   </div>
   <div class="post" id="post-33049">
    <div class="subject"><a href="#post-33049">resources</a></div>
    <div class="body">hi,<br /><br />loading a pe in memory, for run, is easy, as already was said. just alloc the mem, parse the imports and relocs, jmp to entrypoint and most files will run ok.<br /><br />but anybody know how one can make to load the resources? is not enought have they be in memory, in the right place, when you call, as example, CreateWindowExA().<br /><br />seens that some work is done in the loader. anybody have any tip?<br /><br />ancev</div>
    <div class="meta">Posted on 2002-04-10 19:54:56 by ancev</div>
   </div>
   <div class="post" id="post-33050">
    <div class="subject"><a href="#post-33050">Re: resources</a></div>
    <div class="body"><div class="quote"><br />hi,<br />loading a pe in memory, for run, is easy, as already was said. <br /></div><br /><br />The point is not only loading the PE file but doing<br />everything that's done by windows in the<br />background. IAT patching and so on.<br /><br /><div class="quote"><br /><br />just alloc the mem, parse the imports and relocs, jmp to entrypoint and most files will run ok.<br /></div><br /><br />Okay, fine -<br />though, it's not only about parsing but also<br />CHANGING data...<br />how do you PARSE the imports and relocations ?<br />I don't mean to do that all manually with<br />a good PE documentation - that approach is<br />definitely possible. Would take some time...<br />no, what I want to do is to use WINDOW'S <br />libraries to do all this stuff for me.<br /><br /><div class="quote"><br /><br />but anybody know how one can make to load the resources? is not enought have they be in memory, in the right place, when you call, as example, CreateWindowExA().seens that some work is done in the loader. anybody have any tip?<br /></div><br /><br />You name it: the *LOADER* does quite a lot<br />of stuff _behind the scenes_ !<br />But if you've got everything in the DLL - the <br />code and the data/resources then it shouldn't<br />be a problem to load the res.</div>
    <div class="meta">Posted on 2002-04-10 20:02:48 by MikeJ</div>
   </div>
   <div class="post" id="post-33052">
    <div class="subject"><a href="#post-33052">Win32 API - Dynamic Link Library Loading - behind the scenes</a></div>
    <div class="body">I agree with f0dder. The PE header contains every information necessary to map the dll into memory. After mapping all sections were done, you have to fix up imports (walk the import entries, load the import dlls, obtain the addresses of the import functions and fill them in import address table), handle relocations if necessary, and update the data directories to reflect the RVA of the corresponding data such as the resource.<br /><br />However, loading the dll with this method doesn't add the dll to the internal module list maintained by Windows.<br /><br />To study how Windows loads dll, I recommend that you disassemble LoadLibrary with IDA and then take a look at the real thing under SoftICE for something that is not clear from just looking at the dead listing.</div>
    <div class="meta">Posted on 2002-04-10 20:10:25 by Iczelion</div>
   </div>
   <div class="post" id="post-33054">
    <div class="subject"><a href="#post-33054">Win32 API - Dynamic Link Library Loading - behind the scenes</a></div>
    <div class="body"><div class="quote"><br />I agree with f0dder. The PE header contains every information necessary to map the dll into memory.<br /> </div><br /><br />Sure, it does - otherwise it couldn't work ;-)<br /><br /><br /><div class="quote"><br /><br /> After mapping all sections were done, you have to fix up imports (walk the import entries, load the import dlls, obtain the addresses of the import functions and fill them in import address table), handle relocations if necessary, and update the data directories to reflect the RVA of the corresponding data such as the resource.<br /> </div><br /><br />Yeah, I do know what to do in theory quite well.<br />And I did also consider in the past to do all that<br />stuff manually. But that's way too much effort<br />if you take into account that all this stuff is <br />also done by windows and can probably be<br />accessed via &quot;undocumented&quot; function calls.<br /><br /><br /><div class="quote"><br /><br />However, loading the dll with this method doesn't add the dll to the internal module list maintained by Windows.<br /> </div><br /><br /><br />okay, that's understandable - but can probably<br />also easily be covered by calling the corresponding<br />function - IF existing ;-)<br /><br /><br /><div class="quote"><br /><br />To study how Windows loads dll, I recommend that you disassemble LoadLibrary with IDA and then take a look at the real thing under SoftICE for something that is not clear from just looking at the dead listing. </div><br /><br />Yes, I see - thanks for all the suggestions, but as you<br />might have noticed I am not so much in favour of <br />disassembling and reverse engineering windows'<br />inner life...<br />By the way...thanks for the opportunity to talk<br />to such a prominent guy like you Iczelion :-)</div>
    <div class="meta">Posted on 2002-04-10 20:26:14 by MikeJ</div>
   </div>
   <div class="post" id="post-33081">
    <div class="subject"><a href="#post-33081">Win32 API - Dynamic Link Library Loading - behind the scenes</a></div>
    <div class="body">since you were talking about dll/image loading 'n stuff i had a little question too: dlls are shared in memory is what my is told. but dlls do often import functions too. but the addresses of these functions are not always the same in every processes address space. for example, if my.dll imports a function from bla.dll in one processes, and in another process too, but if bla.dll has in the two processes another baseaddress because it is relocated.<br /><br />that means that the IAT is not shared because they differ?</div>
    <div class="meta">Posted on 2002-04-11 04:55:45 by roeldebikkel</div>
   </div>
   <div class="post" id="post-33090">
    <div class="subject"><a href="#post-33090">Win32 API - Dynamic Link Library Loading - behind the scenes</a></div>
    <div class="body">When DLL's are shared in memory it means that every 4KB page which was unmodifyed will be really shared, while any page modifyed will use 4KB of your process's memory.<br />In the whole there will be a big saving of memory anyway.<br /><br />So, to explain it differently: if you load a shared DLL then (ideally) you dont use any memory.. but as soon as you modify any part of it, that corresponding page will not be shared anymore but will use some other memory. It's all transparent to your process, though.</div>
    <div class="meta">Posted on 2002-04-11 06:23:59 by Maverick</div>
   </div>
   <div class="post" id="post-33107">
    <div class="subject"><a href="#post-33107">Win32 API - Dynamic Link Library Loading - behind the scenes</a></div>
    <div class="body"><div class="quote"><br /><br /><br />Yes, I see - thanks for all the suggestions, but as you<br />might have noticed I am not so much in favour of <br />disassembling and reverse engineering windows'<br />inner life...<br />By the way...thanks for the opportunity to talk<br />to such a prominent guy like you Iczelion :-) </div><br /><br /> Wtf is it you want? If you wanna know what windows does when loading a dll, go to the source ... rip out the code and study it. You say you know what it does in theory, so I take it you want to know every step it takes. In what other way than looking at the code behind - as you like to refer to it - could you find out? Hopefully you're not waiting for someone to spoonfeed you commented code on windows' loadlibrary function and it's colleagues.<br /> If you know the theory of what windows does, studying it in person is not a problem. Neither would it be much of a problem to implement it yourself, if that's what you want.<br /><br />Fake</div>
    <div class="meta">Posted on 2002-04-11 09:08:21 by Fake51</div>
   </div>
   <div class="post" id="post-33110">
    <div class="subject"><a href="#post-33110">Win32 API - Dynamic Link Library Loading - behind the scenes</a></div>
    <div class="body"><div class="quote"><br /><br />Wtf is it you want? <br /></div><br /><br />Well, first of all: thank  you very much for<br />being sooo kind to reply to this posting !!<br />Second, I appreciate your interest in knowing<br />what I want.<br /><br /><br /><div class="quote"><br /><br />If you wanna know what windows does when loading a dll, go to the source ... rip out the code and study it. <br /></div><br /><br />Okay, thank you very much for this great idea.<br />Though, we are unlikely to have much in common<br />you can assume that I also got a brain. And yes,<br />ocassionally I even use it. My initial posting was<br />actually supposed to be rather clear: I was seeking<br />for the information of Windows' subsystem that<br />is not that easily available. And admittedly I am<br />somehow satisfied with the responses I received<br />since the same question didn't have that many<br />responses in another forum. The idea to get all<br />the necessary information manually by using a<br />decent debugger and lots of time was my very<br />first idea. But I did find other information on<br />the windows subsystem, and on functions that<br />the API redirects to, that is why I thought asking<br />if there is additional info couldn't hurt.<br /><br /><br /><br /><div class="quote"><br /><br />You say you know what it does in theory, so I take it you want to know every step it takes. <br /></div><br /><br />Cool down fake, nobody urged you to read<br />this posting, nobody asked you to reply to<br />it, and even more important: nobody wants<br />you to despair because of my posting. TRANQUILO<br />hombre :-)<br /><br />No, I didn't look for a step by step guide.<br />Actually, I insinuated several times that I am<br />not going to take that approach, regardless<br />whether others write the corresponding<br />source or I do. I mentioned that I am looking<br />for the EXACT functions behind the said<br />API calls. By no means I was going to make<br />anybody else do my work. Rather, I was merely<br />asking if there is any documentation on that topic.<br />So, there is no reason for you to panic and screw everything up.<br /><br /><br /><div class="quote"><br /><br />In what other way than looking at the code behind - as you like to refer to it - could you find out? <br /></div><br /><br />Okay, somehow I feel forced to mention that I<br />watched this board and its threads for a while<br />and I find it rather sad how some &quot;wannabe-coders&quot;<br />react so fu***in' aggressively towards certain<br />postings. I am not a newbie, luckily - otherwise<br />I might  feel pretty discouraged by people like you.<br /><br />It cannot be right to pretend so much annoyance<br />and importance. Think about it - PLEASE.<br />Even if those people are &quot;real&quot; coders they<br />still don't have the right to react the way some<br />tend to do here. The objective of such a board is not to<br />block eachother, not to create barriers - rather<br />you ought to support and assist eachother. If<br />you can't do that, or maybe if you don't want to,<br />no problem - but then I would really recommend<br />you to STFU. Intimidating newbies is not only stupid<br />and arrogant but also superflous and a waste of time.<br />The time of everbody who reads those lines !<br /><br /><br /><div class="quote"><br /><br />Hopefully you're not waiting for someone to spoonfeed you commented code on windows' loadlibrary function and it's colleagues.<br /></div><br /><br />OMG ...<br />Okay, I just thought about it thoroughly - maybe<br />I was too vague. But I am quite sure that<br />my question didn't appear too stupid or naive.<br />Nor did I ask anybody to do any assignment :-)<br /><br /><div class="quote"><br /><br /> If you know the theory of what windows does, studying it in person is not a problem. Neither would it be much of a problem to implement it yourself, if that's what you want.<br /></div><br /><br />Okay, again: thank you very much for your posting -<br />but you could have saved the  time...</div>
    <div class="meta">Posted on 2002-04-11 10:12:07 by MikeJ</div>
   </div>
   <div class="post" id="post-33111">
    <div class="subject"><a href="#post-33111">Win32 API - Dynamic Link Library Loading - behind the scenes</a></div>
    <div class="body">Easy, MikeJ.<br /><br />As for using windows APIs to do PE loading... I suppose NT and 9x<br />handle this very differently, and if anything is exported it's probably<br />NT native (undocumented) stuff. And still I doubt it. Just guesses, though.<br /><br />Thing is, there isn't really that much work involved in writing a PE<br />loader (except for some stuff like resources, and perhaps a few of<br />the very rarely used features of the PE format). If you had started<br />writing code before posting, you'd probably have something running now ;).<br />Now, how do you want to load the image? I suppose it's a DLL...<br />is it in a file, or included somewhere in your own executable image?<br />This will obviously affect the loading method...</div>
    <div class="meta">Posted on 2002-04-11 10:23:24 by f0dder</div>
   </div>
   <div class="post" id="post-33201">
    <div class="subject"><a href="#post-33201">Win32 API - Dynamic Link Library Loading - behind the scenes</a></div>
    <div class="body"><div class="quote"><br />Easy, MikeJ.<br /></div><br /><br />EASY =)<br /><br /><div class="quote"><em>Originally posted by f0dder </em><strong><br />As for using windows APIs to do PE loading... I suppose NT and 9x<br />handle this very differently, <br /></div><br /><br />Certainly they do<br /><br /><div class="quote"><em>Originally posted by f0dder </em><strong><br />and if anything is exported it's probably<br />NT native (undocumented) stuff. <br /></div><br /><br />yep, that's why I asked if anybody has got some<br />lines on that stuff.<br /><br /><br /><br /><div class="quote"><em>Originally posted by f0dder </em><strong><br />And still I doubt it. Just guesses, though.<br /></div><br /><br />ya, I see and think the same<br /><br /><div class="quote"><em>Originally posted by f0dder </em><strong><br />Thing is, there isn't really that much work involved in writing a PE loader (except for some stuff like resources, and perhaps a few of the very rarely used features of the PE format).<br /></div><br /><br />Okay, I see your point - fact is that I was actually<br />looking for the &quot;How is Windows doing it (*exactly*)&quot; and not<br />&quot;how can I do it myself&quot;.<br />I do know that the PE format is quite well documented<br />and you can probably write something useful<br />in a small amount of time. Anyway, due to the lack<br />of details you cannot  epect it to be too compliant.<br />Sure, the DO IT YOURSELF approach would have<br />the advantage  of platform independence amongst<br />windows systems...<br /><br /><br /><br /><div class="quote"><em>Originally posted by f0dder </em><strong><br />If you had started<br />writing code before posting, you'd probably have something running now ;).<br /></div><br /><br />Yes, I see what you mean. But referring to my last<br />posting: way too many smileys to be serious.<br />It was simply the way Fake responds to a posting<br />as if had been knocking on his door for the last two<br />weeks. And his assumptions are likewise expressing  kind of annoyance.<br /><br /><br /><div class="quote"><em>Originally posted by f0dder </em><strong><br />Now, how do you want to load the image?<br /></div><br /><br />In general I was interested in the approach.<br />The DLL itself might be a custom ressource for<br />example.<br /><br /><div class="quote"><em>Originally posted by f0dder </em><strong><br /> I suppose it's a DLL...<br /></div><br /><br />yes<br /><br /><div class="quote"><em>Originally posted by f0dder </em><strong><br />is it in a file, or included somewhere in your own executable image?<br /></div><br /><br />- well rather  the latter. <br /><br /><br /><div class="quote"><em>Originally posted by f0dder </em><strong><br />This will obviously affect the loading method... </div><br /><br />Sure it will.<br />An easy example:<br /><br />1) Load Resource (the DLL)<br />2) Load the DLL that is contained in the Resource<br />3) Make it usable by the system/own process<br />4) Call functions <br />5) Unload DLL</div>
    <div class="meta">Posted on 2002-04-12 02:53:46 by MikeJ</div>
   </div>
   <div class="post" id="post-33253">
    <div class="subject"><a href="#post-33253">Win32 API - Dynamic Link Library Loading - behind the scenes</a></div>
    <div class="body">f0dder, MikeJ got <strong>Mack</strong> <br />Worse than YOU...<span style="font-size:1( as good as )[/SIZE> <br />ok, see ya...Now we talking...</div>
    <div class="meta">Posted on 2002-04-12 12:38:51 by cmax</div>
   </div>
   <div class="post" id="post-33254">
    <div class="subject"><a href="#post-33254">Win32 API - Dynamic Link Library Loading - behind the scenes</a></div>
    <div class="body"><div class="quote">&quot;How is Windows doing it (*exactly*)&quot; and not &quot;how can I do it myself&quot;.</div> <br /><br />Ok at this point I must admit that I am totally confused here so let me see if I have I this correct:<br /><br />You want to know exactly how Windows at the system level goes about loading and making available a DLL but you are not looking for the SoftIce method of figuring this out nor are you looking for someone to give you a fully commented code snippet of a Windows system level debugging session focused on just that.  Also, you are not interested in developing a PE loader of your own.<br /><br />Am I on the right track ?  If I am then here is the point in which I get really lost as the only way that I see for you to get <div class="quote">&quot;How is Windows doing it (*exactly*)&quot; </div>  is for someone to invest the time to look at those &quot;undocumented calls&quot; (either with SoftIce or a static Disassembler) and figure out exactly what they do and why (thusly making them, to a point, no longer undocumented).  <br /><br />:confused:</div>
    <div class="meta">Posted on 2002-04-12 12:39:25 by madprgmr</div>
   </div>
   <div class="post" id="post-33255">
    <div class="subject"><a href="#post-33255">Win32 API - Dynamic Link Library Loading - behind the scenes</a></div>
    <div class="body"><div class="quote"><br /> <br />You want to know exactly how Windows at the system level goes about loading and making available a DLL<br /></div><br /><br />which  subsystem functions are used by<br />LoadLibrary/GetProcAddress.<br /><br /><div class="quote"><br /> <br />but you are not looking for the SoftIce method of figuring this out <br /></div><br /><br />meanwhile I should consider that ;-)<br />Well, actually I expect some documentation<br />to exist. I've already found some good docs<br />on the NT subsystem.<br />A listing of some functions like presented at <a target="_blank" href="http://cn.geocities.com/cntsu00/xpcalllist.htm">http://cn.geocities.com/cntsu00/xpcalllist.htm</a> can be also quite useful. Now  I've found a whole ebook, gonna check that out, though I do consider to do it manually.<br /><br /><div class="quote"><br /> <br />nor are you looking for someone to give you a fully commented code snippet of a Windows system level debugging session focused on just that.  <br /></div><br /><br />Okay, don't get me wrong - if that code/doc<br />exists already I would appreciate somebody to<br />post it here - because I couldn't find much <br />information on the details so far...<br /><br /><br /><div class="quote"><br /> <br />Also, you are not interested in developing a PE loader of your own.<br /></div><br />it's just that such a PE loader would have to be<br />fully Win32 compliant which makes the things more<br />complicated, as already mentioned by f0dder - regarding ressource loading etc.<br /><br /><br /><br /><br /><div class="quote"><br /> <br />Am I on the right track ?  If I am then here is the point in which I get really lost <br /></div><br /><br />lol, people can be so caring<br /><br /><div class="quote"><br /> <br />as the only way that I see for you to get   is for someone to invest the time to look at those &quot;undocumented calls&quot; (either with SoftIce or a static Disassembler) and figure out exactly what they do and why (thusly making them, to a point, no longer undocumented).<br /></div><br /><br />Okay, I see what you mean, but actually<br />I am quite confident that those fu***ing functions<br />are SOMEWHERE documented, concerning the<br />ebook I talked about, I found it at:<br /><a target="_blank" href="http://ftp.selab.org/ebook/NT_Filesys_internals/">http://ftp.selab.org/ebook/NT_Filesys_internals/</a><br />(hope this is no W*_ RE*)<br /><br /><br />Thanks for your suggestions and offers !</div>
    <div class="meta">Posted on 2002-04-12 13:11:58 by MikeJ</div>
   </div>
   <div class="post" id="post-33320">
    <div class="subject"><a href="#post-33320">Win32 API - Dynamic Link Library Loading - behind the scenes</a></div>
    <div class="body">Long time ago i've needed to force a dll to register it, bcoz regsvr32.exe failed. To make a LoadLibrary first u must to 'align' the dll, i mean that all the virtual offsets and raw offsets in the dll must be the same. the easiest solution i've found is:<br />make a mapview of file (of course u cannot map the dll into the image base, so later u must to handle all the relocations),<br />Dmapa is the address that returned the API MapViewOfFileEx of the original dll:<br /><br />the main idea is loop throught all the sections and read the virtual offset and virtual size (in most cases virtual sizes of sections are greater than raw sizes) if virtual size is greater than<br />raw size u must add to the new dll the difference (with garbage or else).<br /><br />CAUTION: those code dont check for errors.<br /><br />	mov ebx,Dmapa<br />	mov ultdir,ebx<br />	add ebx,<br />	xor ecx,ecx<br />	mov cx,<br />	add bx,word ptr<br />	add ebx,20h<br /><br />	mov eax,<br /><br />sigoCreando:<br />	push ecx<br />	invoke WriteFile,puntArchAlt,ultdir,eax,OFFSET escritos,NULL<br />	test eax,eax<br />	jnz @F<br />	invoke MessageBox,NULL,OFFSET msgerrNoEsc,OFFSET msgbarra,MB_OK or MB_ICONERROR<br />	jmp chau<br />	@@:<br />	mov eax,<br />	add eax,Dmapa<br />	mov ultdir,eax<br />	add ebx,28h<br />	mov eax,<br />	sub eax,<br />	pop ecx<br />	loop sigoCreando<br /><br />	mov eax,<br />	invoke WriteFile,puntArchAlt,ultdir,eax,OFFSET escritos,NULL<br />	test eax,eax<br />	jnz @F<br />	invoke MessageBox,NULL,OFFSET msgerrNoEsc,OFFSET msgbarra,MB_OK or MB_ICONERROR<br />	jmp chau<br />	@@:<br /><br />those snipped produce a dll that have the same raw address and virtual address. (like an image of the dll running in memory). Once we have the new dll, we make a new MapViewOfFile. Then we must handle all relocations, and must resolve the imports (thats the worst part, and my code works sometime).<br /><br />Those snipped resolve the relocs.<br />sigo:<br />	add eax,28h<br />	cmp dword ptr,42000040h<br />	je hayreloc<br />	loop sigo<br />	jmp nohayreloc<br />hayreloc:<br /><br />	mov eax,<br />	add eax,Dmapa<br /><br />	mov ebx,Dmapa<br />	sub ebx,edi<br />	mov delta,ebx<br /><br />tablarelocs:<br />	mov ebx,Dmapa<br /><br />	add ebx,<br /><br />	mov ecx,<br />	sub ecx,8<br />	shr ecx,1<br />	<br />	add eax,8<br />relocs:<br />	mov edi,ebx<br />	mov si,word ptr<br />	and si,0FFFh<br />	add di,si<br /><br />	mov esi,<br />	add esi,delta<br />	mov ,esi<br /><br />	inc eax<br />	inc eax<br />	loop relocs	<br /><br />	cmp dword ptr,0<br />	je nohayreloc<br />	jmp tablarelocs</div>
    <div class="meta">Posted on 2002-04-13 10:57:09 by r00t</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=4704&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=4704&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="4704" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=4704&amp;page=2">&gt;</a><a href="../?id=4704&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>