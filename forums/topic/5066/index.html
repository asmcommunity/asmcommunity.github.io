<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>DrawItemStruct.rcItem.right is ZERO! Help! - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=5066" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=5066">DrawItemStruct.rcItem.right is ZERO! Help!</a></p>
   <div class="post" id="post-35587">
    <div class="subject"><a href="#post-35587">DrawItemStruct.rcItem.right is ZERO! Help!</a></div>
    <div class="body">The menuitem, which id is MI_OPENBITMAP, is ower-drawn,<br />When calling OnDraw function, the x, y, right and bottom of DrawItemStruct.rcItem<br />are shown. And i found that the right is zero! So when calling DrawText, no text is being drawn.<br />Do anyone know why the right is zero? and what's the solution?<br /><br />Thanks<br /><br /><pre><code><br />================ Mosaic.rc ================<br />MAINMENU    MENU DISCARDABLE<br />&#123;<br /><br />POPUP   &quot;&amp;File&quot;<br />    	&#123;<br /><br />        MENUITEM &quot;&amp;Open Bitmap &quot;, MI_OPENBITMAP<br />	&#125;<br />&#125;<br /><br />================ Mosaic.asm ================<br />.data<br />buffer byte 256 dup&#40;?&#41;<br /><br />.code<br />WndProc proc	hWnd&#58;DWORD, uMsg&#58;DWORD, wParam&#58;DWORD, lParam&#58;DWORD<br /><br />	.IF 	uMsg==WM_CREATE<br />		invoke OnCreateMenu, hWnd<br />	.ELSEIF uMsg==WM_MEASUREITEM<br />		.if wParam == 0<br />			push edi<br />			mov edi, lParam<br />			invoke OnMeasureItem, hWnd, MEASUREITEMSTRUCT ptr &#91;edi&#93;<br />			pop edi<br />		.endif<br />	.ELSEIF uMsg==WM_DRAWITEM<br />		.if wParam == 0<br />			push edi<br />			mov edi, lParam<br />			invoke OnDrawItem, hWnd, DRAWITEMSTRUCT ptr &#91;edi&#93;<br />			pop edi<br />		.endif<br />	.ELSE<br />		invoke 	DefWindowProc,hWnd,uMsg,wParam,lParam		<br />		ret<br />	.ENDIF<br />ret<br />WndProc endp<br /><br /><br />OnCreateMenu proc hWnd&#58;DWORD<br />	<br />	LOCAL mii &#58; MENUITEMINFO<br />	LOCAL lf &#58; LOGFONT<br />	<br />	invoke GetSubMenu, hMenu, 0<br />	mov hMenu, eax<br />	<br />	mov mii.fMask, MIIM_FTYPE<br />	invoke GetMenuItemInfo, hMenu, MI_OPENBITMAP, FALSE, addr mii<br />	or mii.fType, MFT_OWNERDRAW<br />	<br />	invoke SetMenuItemInfo, hMenu, MI_OPENBITMAP, FALSE, addr mii<br /><br />	ret<br />OnCreateMenu endp<br /><br /><br /><br />OnDrawItem proc hWnd&#58;DWORD, dis&#58;DRAWITEMSTRUCT<br />	LOCAL clrPrevText &#58; COLORREF<br />	LOCAL clrPrevBkgnd &#58; COLORREF<br />	LOCAL hfntPrev &#58; HFONT<br /><br />PrintDec dis.rcItem.left<br />PrintDec dis.rcItem.top<br />PrintDec dis.rcItem.bottom<br />PrintHex dis.rcItem.right<br /><br /><br />	mov eax, dis.itemState<br /><br />	.if eax &amp; ODS_SELECTED<br />		invoke GetSysColor,COLOR_HIGHLIGHTTEXT<br />		mov ebx, eax<br />		invoke SetTextColor, dis.hdc, ebx<br />		mov clrPrevText, eax<br />		invoke GetSysColor, COLOR_HIGHLIGHT<br />		mov ebx, eax<br />		invoke SetBkColor, dis.hdc, ebx<br />		mov clrPrevBkgnd, eax<br />	.elseif<br />		invoke GetSysColor,COLOR_MENUTEXT<br />		mov ebx, eax<br />		invoke SetTextColor, dis.hdc, ebx<br />		mov clrPrevText, eax<br />		invoke GetSysColor, COLOR_MENU<br />		mov ebx, eax<br />		invoke SetBkColor, dis.hdc, ebx<br />		mov clrPrevBkgnd, eax<br />	.endif<br /><br />	mov eax, dis.rcItem.left<br />	mov x, eax<br />	mov eax, dis.rcItem.top<br />	mov y, eax<br /><br />	invoke GetSystemMetrics,SM_CXMENUCHECK<br />	add x, eax<br /><br />	invoke GetMenuString,hMenu,MI_OPENBITMAP,addr buffer,100,MF_BYCOMMAND<br />	invoke DrawText, dis.hdc, addr buffer, -1, addr dis.rcItem, DT_CENTER <br /><br />	invoke SetTextColor, dis.hdc, clrPrevText<br />	invoke SetBkColor, dis.hdc, clrPrevBkgnd<br />	xor eax, eax<br />	inc eax<br />.endif<br />	ret<br /><br />OnDrawItem endp<br /><br /><br />OnMeasureItem proc hWnd&#58;DWORD, mis &#58; MEASUREITEMSTRUCT<br />	LOCAL hdc &#58; HDC<br />	LOCAL hfntOld &#58; HFONT<br />	LOCAL s &#58; _SIZE<br /><br />.if mis.itemID == MI_OPENBITMAP<br /><br />	invoke GetDC, hWnd<br />	mov hdc, eax<br /><br />	invoke GetMenuString,hMenu,MI_OPENBITMAP,addr buffer,100,MF_BYCOMMAND<br />	invoke lstrlen, addr buffer<br />	mov ebx, eax<br />	invoke GetTextExtentPoint32, hdc, addr buffer, ebx, addr s	; give logical unit<br /><br />	mov eax, s.px<br />	mov mis.itemWidth, eax<br />	mov eax, s.py<br />	mov mis.itemHeight, eax<br /><br />	invoke ReleaseDC,hWnd, hdc<br /><br />	xor eax, eax<br />	inc eax<br />.endif<br /><br />	ret<br /><br />OnMeasureItem endp<br /><br /></code></pre></div>
    <div class="meta">Posted on 2002-04-29 11:39:05 by yoursguideline</div>
   </div>
   <div class="post" id="post-35616">
    <div class="subject"><a href="#post-35616">Solution!</a></div>
    <div class="body">The problem occur is due to the second passing argument in OnMeasureItem and OnDrawItem.<br /><br /><strong>Instead of passing MEASUREITEMSTRUCT or DRAWITEMSTRUCT, pass the pointer of these structure as a argument.</strong><br /><br />It works for me!</div>
    <div class="meta">Posted on 2002-04-29 14:01:42 by yoursguideline</div>
   </div>
  </div>
 </body>
</html>