<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Modular IOCP Beta Demo - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=21279" />
    <link rel="next" href="../?id=21279&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=8">Networking</a> &raquo; <a href="../?id=21279">Modular IOCP Beta Demo</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=21279&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=21279&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="21279" /><input type="number" name="page" min="1" max="3" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=21279&amp;page=2">&gt;</a><a href="../?id=21279&amp;page=3">&raquo;</a></form>   <div class="post" id="post-161008">
    <div class="subject"><a href="#post-161008">Modular IOCP Beta Demo</a></div>
    <div class="body">I&#39;ve thrown together a Server which uses IO Completion Ports.<br />It&#39;s strongly based on James Ladd&#39;s FASt Server project, so don&#39;t expect TOO much.<br />(By this I simply mean that it does what James&#39; server does, no more, no less.)<br />It currently operates as an echoserver on port 9080.<br />You can telnet to yourself and try it, but be quick, it shuts down in 30 seconds :)<br /><br />http://homer.ultrano.com/Upload/Server.zip<br /><br />And please guys, how about a little feedback?<br />Anyone interested in the source can perform a musical number right here, or alternatively, message me.<br /><br />James, I liked your approach to Plugin code.. I took that one step further, and implemented the Server itself in a separate DLL.<br />The Server and Protocol plugins are both OOP classes encapsulated in DLL form.<br />The driving executable simply loads the Server DLL and calls its only exported function.<br />This creates an instance of Server object.<br />In turn, within Server&#39;s constructor method, it will load the Protocol plugin from given name, create an instance of the Plugin object, and store its pointer within the Server object.<br />Like you, I don&#39;t actually do anything with the Plugin yet, I haven&#39;t implemented any kind of Collections (arrays, lists, whatever terminology you prefer), it&#39;s basically your published source transliterated to ObjAsm32 oopasm model and shoved in two DLLs instead of one.<br /><br />ps : I took the liberty of making a whole bunch of optimisations, mostly at the register level.<br />I also replaced a bunch of two-line conditional jumps with one-line macro..<br /><pre><code><br />JmpCase macro Condition, Place<br />	.if Condition<br />		jmp Place<br />	.endif<br />endm<br /></code></pre><br />This generates je/jne opcodes, so there&#39;s no cost.. and it makes the source a lot smaller..<br /><pre><code><br />? ? ? ? ? ? mov edx, .XOVERLAPPED.operation<br />? ? ? ? ? ? JmpCase edx==OPERATION_ACCEPTED, main_io_worker_accepted<br />? ? ? ? ? ? JmpCase edx==OPERATION_READ, 	? ? ?main_io_worker_read<br />? ? ? ? ? ? JmpCase edx==OPERATION_WRITTEN,? main_io_worker_written<br /></code></pre><br />Heh.<br /><br />Biterider, the driving executable detects for DebugCenter&#39;s regkey, and warns the user if they haven&#39;t got it, and provides them a URL to the file (on my dump), along with simple instructions (&quot;put it somewhere safe, execute it once, then you&#39;re good to go&quot;).<br /><br /><br /></div>
    <div class="meta">Posted on 2005-06-11 10:55:01 by Homer</div>
   </div>
   <div class="post" id="post-161031">
    <div class="subject"><a href="#post-161031">Re: Modular IOCP Beta Demo</a></div>
    <div class="body">kewl.<br /></div>
    <div class="meta">Posted on 2005-06-12 01:48:31 by James_Ladd</div>
   </div>
   <div class="post" id="post-161032">
    <div class="subject"><a href="#post-161032">Re: Modular IOCP Beta Demo</a></div>
    <div class="body">I&#39;ve made a milestone improvement and re-uploaded the Zip.<br />The server no longer hangs on Accept waiting for atleast one byte of data to be sent by the Client.<br />It now Accepts immediately (&quot;null-bufferlen trick&quot;) which means that I can implement some kind of timed culling of &quot;zombie clients&quot; (those who connect, then never send a single byte).<br />I&#39;m yet to receive any legitimate feedback from you guys :|<br /><br />I&#39;m thinking about implementing the same zombie-cull mechanism as I did in the &quot;Banked&quot; socket model, which is a timed event per Client, such that the Client automatically (and asynchronously) &quot;culls itself&quot; from the Client pool without the need for any polling on my behalf (no &quot;maintenance&quot; cycle in Worker, and no special-purpose Thread).<br />Basically, when a Client is Accepted, we create a Timer object which will fire within say 10 seconds unless it is prevented from doing so. Code in the Recv handler resets the Timer to something more friendly like 2 minutes, so on reception of data, the &quot;zombie cull&quot; mechanism becomes an &quot;idle cull&quot; mechanism, reset each time data is received.<br /><br />OnConnect zombies have yay many seconds to speak up, or bugger off.<br />Connected clients have yay many minutes to speak up, or bugger off.<br /><br />Anyone have a better idea?<br /></div>
    <div class="meta">Posted on 2005-06-12 02:50:58 by Homer</div>
   </div>
   <div class="post" id="post-161056">
    <div class="subject"><a href="#post-161056">Re: Modular IOCP Beta Demo</a></div>
    <div class="body">why giving 2 minutes to connected clients? i think 60 seconds is far more than neccessary? :|&nbsp; also - if the client connects, he may try to send 1 byte of data per 30 seconds, or so. there should be a minimum to send (for example 1 full line of command in HTTP). also - if the clients sends junk, it should be dosconnected, and -if this is repeated for n-times - banned.</div>
    <div class="meta">Posted on 2005-06-12 12:11:38 by ti_mo_n</div>
   </div>
   <div class="post" id="post-161102">
    <div class="subject"><a href="#post-161102">Re: Modular IOCP Beta Demo</a></div>
    <div class="body">The values I gave are subjective examples, and could be altered in realtime.<br />The actual values would depend highly on the protocol being implemented by the server.<br />For example, one minute may be unreasonably low for a chat server.<br />In my particular case, I am implementing a p2p protocol, and as such, two minutes sounds reasonable in theory.. practical values can only be determined by trial and error.<br />Don&#39;t focus so much on the numbers, instead focus on the theory behind them.<br /><br />Has anyone actually bothered to TRY the demo?<br />I do log all hits to my dumpsite, and I see downloads, but no feedback regarding the demo :|<br /></div>
    <div class="meta">Posted on 2005-06-13 10:06:17 by Homer</div>
   </div>
   <div class="post" id="post-161129">
    <div class="subject"><a href="#post-161129">Re: Modular IOCP Beta Demo</a></div>
    <div class="body">I could connect, and everything i sent was displayed in &quot;received&quot; window 1 char per line. So i think it works..? :)<br /><br />About those times -- I thought it was going to stay like that :P<br /><br />Make a configurable .cfg file, like:<br />Port = 80<br />ZombieTimeout = 30<br />ClientTimeout = 120<br /><br />etc.<br /><br />And why the server quits if there is no input for some time (30 seconds?) ? (i assume it is NOT going to stay like that?)</div>
    <div class="meta">Posted on 2005-06-13 20:44:22 by ti_mo_n</div>
   </div>
   <div class="post" id="post-161135">
    <div class="subject"><a href="#post-161135">Re: Modular IOCP Beta Demo</a></div>
    <div class="body">The demo kills itself after 30 second, no matter what happens.<br />The reason is simply that I am lazy, and while debugging and testing, I don&#39;t want to have to kill the server process manually (there&#39;s no window, so there&#39;s no close button to press.. I&#39;d have to terminate the process manually, and that requires effort !!)<br />I can remove the self-destruct very easily once I&#39;m happy that everything is behaving as intended.<br /><br />Thanks for the feedback, that&#39;s exactly what it&#39;s meant to be doing right now.<br />The debug code which prints received data automatically adds linefeeds, so we see each keystroke on a separate line.<br />Just one question - does the server Accept immediately on Connect, or only after the first keystroke (first receive)? The purpose of the most recent modification was to Accept immediately, and not require ANY data be sent..<br />The differences between this code and James&#39; version currently boil down to:<br />A) - The buffer length is set to NULL for calls to AcceptEx (thats the &quot;null bufferlen trick&quot;).<br />B) - On completion of Accept, we queue a Recv instead of a Send, since we are yet to receive any data.<br />C) - I take a little more notice of the &quot;bytes&quot; parameter and don&#39;t assume everything is single-byte IO.<br /><br />You might notice that you cannot currently make more than one client session simultaneously - this is because there is currently no &quot;client pooling&quot; implemented. I&#39;ll be addressing that next.<br />Also, the &quot;plugin protocol DLL&quot; is not currently being employed... that&#39;ll change too :)<br />I&#39;ve written (and posted) a basic Client class as the first step towards a client pooling system.<br />I intend to use the OA32 class called &quot;Collection&quot; to implement pooling.<br />It&#39;s simply a manager class for storing a bunch of arbitrary objects.. it manages an array of pointers, and uses the &quot;pull-down&quot; method to &quot;close holes in the array&quot; created by arbitrary deletions.<br />It&#39;s perfectly suitable for this kind of thing, and already contains code to automatically &quot;sweep&quot; the array and destroy all contained objects when it is itself destroyed..<br /><br />I&#39;m still hoping to hear some more opinions on the proposed zombie culling mechanism ... also, what are your thoughts regarding the Debug support? Personally I was pretty impressed.. this stuff is all standard within the OA32 model :)<br /><br /></div>
    <div class="meta">Posted on 2005-06-14 00:28:52 by Homer</div>
   </div>
   <div class="post" id="post-161142">
    <div class="subject"><a href="#post-161142">Re: Modular IOCP Beta Demo</a></div>
    <div class="body">Another milestone was achieved today (zip updated, same old url as previously).<br />The proposed Client class was implemented : and Client Pooling was implemented via an instance of ObjAsm32&#39;s Collection class :)<br />All the &quot;acceptor&quot; code was moved to Client class.. the Client class constructor method Client.Init contains the code from &quot;InitAcceptors&quot;, and under a new Method called Client.Accept we find the old code from &quot;AcceptAcceptors&quot;.<br />The Client class is essentially a wrapper for XOVERLAPPED, the &quot;Extended Overlapped&quot; structure.<br />Server.acceptors dword data member is now a Pointer to the Client Collection object.<br />The Collection is initialized to hold up to 10 thousand Clients :)<br />I create 500 Clients in the latest beta demo, and have tested that I can create multiple sessions successfully :D Realistic limit for a single-cpu machine is supposed to be 5000 according to the wisdom of C coders, but who&#39;s to say? We&#39;ll find out soon ...<br /><br />Have a nice day :)<br /></div>
    <div class="meta">Posted on 2005-06-14 05:42:20 by Homer</div>
   </div>
   <div class="post" id="post-161143">
    <div class="subject"><a href="#post-161143">Re: Modular IOCP Beta Demo</a></div>
    <div class="body">I&#39;d just like to add that I have since tested with 5,000 and 10,000 clients.<br />The 10,000 limit of Collection was an artificial limit imposed by myself.. I&#39;m not sure what XP&#39;s limit for open socket handles really is, but I do have a bunch of error checking and I&#39;m finding 10,000 succeeds on my (wait for it) 333mhz machine with 48 meg of ram :)<br /></div>
    <div class="meta">Posted on 2005-06-14 06:55:46 by Homer</div>
   </div>
   <div class="post" id="post-161146">
    <div class="subject"><a href="#post-161146">Re: Modular IOCP Beta Demo</a></div>
    <div class="body">Progress Report :<br />Last minute addition of code to recycle Client objects without scavenging them.<br />At first I was trying to recycle the socket handle, until I read on the net that on recv of 0 bytes (client disconnected) that the socket is literally removed from the iocp...<br />I considered destroying the defunct Client object (remember, a Client is a container for the XOverlapped containing the SocketHandle, Buffer, etc). But this would mean using existing code in Collection class to exhaustively search the Collection for the Client, destroy it, deallocate buffer, remove client from collection, then recreate client, reallocate buffer, and put client BACK in the collection.. really, REALLY inefficient.<br />Then I realized I don&#39;t have to.<br />I have created a new Client.CreateSocket method from part of the Client.Init code.<br />Now I can call that to recreate the Client.hSocket and then call Client.Accept again to requeue an Accept job, thus avoiding the scenario mentioned previously.<br />It&#39;s working :D<br /><br />However, that&#39;s not under load .. if there&#39;s &gt;1 io job posted for a given Client at once, then we&#39;ll get &gt;1 null receive and try to destroy the client more than once also.<br />At the moment, the client uses a single overlapped structure.<br />This will have to be replaced with a collection of outstanding io structs, and a counter for them, if I want this thing to not fall over under load, and to be truly asynch..<br /><br />James, I need to pick your brain - I still get the feeling you&#39;ve done this before :)<br /><br /></div>
    <div class="meta">Posted on 2005-06-14 11:17:06 by Homer</div>
   </div>
   <div class="post" id="post-161157">
    <div class="subject"><a href="#post-161157">Re: Modular IOCP Beta Demo</a></div>
    <div class="body">The silence was deafening..</div>
    <div class="meta">Posted on 2005-06-14 19:42:17 by Homer</div>
   </div>
   <div class="post" id="post-161158">
    <div class="subject"><a href="#post-161158">Re: Modular IOCP Beta Demo</a></div>
    <div class="body">EvilHomer,<br />If your example is still based on my early code then you wont have the Send modification that ensures sending doesnt create an overlapped IO.<br />This removed the need for these send completion to be queued. Ill send you some example code soon.<br />Also, if you havent already done so, use Io socket control to turn off the send and receive buffering. IO_SND_BUF or something similar.<br />Again, Ill look this up and let you know.<br /><br />If you want to ask more detailed questions, then go ahead. Ill try to get back to this page twice daily to reply.<br /><br />Rgs, James.<br /><br /></div>
    <div class="meta">Posted on 2005-06-14 21:59:39 by James_Ladd</div>
   </div>
   <div class="post" id="post-161159">
    <div class="subject"><a href="#post-161159">Re: Modular IOCP Beta Demo</a></div>
    <div class="body">My experience with asynchronous stuff is quite limited.<br />I&#39;m not sure what to expect !!<br />Basically I can&#39;t envisage a situation where eg multiple Recvs for a given Client would be a necessity.. however I can appreciate the potential collision of concurrent read/write operations..<br /><br />As for network protocols, I am most comfortable with binary protocols, but in my mind I use the example of a webserver, where eg a client requests a file, the server begins transmitting the file, then the Client unexpectedly requests Some Other File .. probably most asynch webservers would cancel all outstanding IO and then queue the new job.. but I am really guessing at this.<br /><br />Now that I have implemented client pooling (which was a whole 5 minutes work thanks to Biterider&#39;s Collection class) I suppose I should continue and implement IO pooling per Client, ie, a Client object should own a list of outstanding IO jobs in the form of a list of XOVL.. am I on the right track? <br /><br />Regardless, my next move will be to shift the IO event handlers into the Protocol plugin where they belong.. James, I&#39;ve probably learned as much as I could hope to learn from your public code, I admit to not studying your private stock carefully yet.. <br />I will repost the Client object class right now, so you can see what was implemented there.<br />The most important divergences from your project code have been duly noted in previous postings.<br /></div>
    <div class="meta">Posted on 2005-06-14 23:42:45 by Homer</div>
   </div>
   <div class="post" id="post-161161">
    <div class="subject"><a href="#post-161161">Re: Modular IOCP Beta Demo</a></div>
    <div class="body">EvilHomer,<br /><br />The queuing i think your referring too is not necessary for you to implement, this is what the completion ports are for.<br />If your HTTP server is sending pages back to the client, and the client requests another page, then you want to act <br />on that request. Which you would, because it was queued, you got the notification on the completion port and<br />acted upon it.<br /><br />If during that processing several more client requests queue up, you can either peek the completion port queue<br />(I forget the API off hand) or just get around to each request as you dequeue it with GetQueueCompletionStatus.<br /><br />You will need a buffer of Overlapped structures as you will want to issue a read for each read that completes.<br />If you have more than one read outstanding. You dont have to issue another read until one completes, but<br />there could be an advantage in having at least one outstanding read.<br /><br />Depending on how you handle sends, you may also want a buffer of overlapped structures. ie: as you <br />fill a buffer with read data you send it, which queues the send, then read another buffer and queue that send.<br />You can wait for send completion notification but I would not, as its faster for you to just do the sends and<br />not wait to be told the sent happened. All this within reason, as there is no point in flooding the client.<br /><br />I sure hope that I am helping with this response.<br /><br />Rgs, James.<br /></div>
    <div class="meta">Posted on 2005-06-15 00:23:02 by James_Ladd</div>
   </div>
   <div class="post" id="post-161179">
    <div class="subject"><a href="#post-161179">Re: Modular IOCP Beta Demo</a></div>
    <div class="body">James - yes, that helped in that it adds weight to my philosophical leaning (not a typo).<br />I appreciate any and all feedback, and especially yours, since I suspect you have more experience in this arena than I do.<br />I am seriously considering implementing a http plugin, not because I have any real interest in being the guy who kicked the crap out of apache, nor because of commercial viability, but simply because web users are unpredictable, and if I can write my server to expect the unexpected, I see that as a positive :)<br /></div>
    <div class="meta">Posted on 2005-06-16 02:25:03 by Homer</div>
   </div>
   <div class="post" id="post-161180">
    <div class="subject"><a href="#post-161180">Re: Modular IOCP Beta Demo</a></div>
    <div class="body">EvilHomer,<br /><br />If you are in the middle of a request and you receive another, then you cant stop any queued sends, but you could<br />stop further sends if you knew the new requests are for a new page and not pieces of the same page.<br />ie: you sent the html page, but the new requests are for gif images etc of the same page.<br /><br />Im thinking for http you probably never want to terminate a request.<br /><br />Anyways, please consider writing a HTTP plugin for FAStServer so we both can use it.<br />I do plan on being faster than apache and being more widely used. Maybe Im dreaming.<br /><br />Rgs James.</div>
    <div class="meta">Posted on 2005-06-16 02:49:12 by James_Ladd</div>
   </div>
   <div class="post" id="post-161185">
    <div class="subject"><a href="#post-161185">Re: Modular IOCP Beta Demo</a></div>
    <div class="body">Hello James, <br /><br />How&#39;s things going? Need any muscle in any coding?&nbsp; ;) Maybe I can help, you just need to fill me with some details.</div>
    <div class="meta">Posted on 2005-06-16 06:56:54 by roticv</div>
   </div>
   <div class="post" id="post-161197">
    <div class="subject"><a href="#post-161197">Re: Modular IOCP Beta Demo</a></div>
    <div class="body">Wow, thanks for the offer Victor.<br />A new complete version of FAStServer will be published this weekend (its Firday now).<br />When it is id like it if you could write a plugin that does more than an Echo.<br />I dont care what, but suggest HTPP with or without ISAPI support would be popular.<br />Ill contact you directly when the lates version is posted.<br />Rgs, James.</div>
    <div class="meta">Posted on 2005-06-16 19:57:59 by James_Ladd</div>
   </div>
   <div class="post" id="post-161200">
    <div class="subject"><a href="#post-161200">Re: Modular IOCP Beta Demo</a></div>
    <div class="body">James - thanks for your support.<br />I&#39;ve had a couple of quiet days due to a friend of mine is having some dramas and I&#39;ve been cheering him up.. I prefer to count my friends on one hand, and when my mates need me, I prioritize.<br />Since I got home five minutes ago, I manipulated my source such that the parameters for the Client collection are given as parameters of the Server.DLL&#39;s exported Server_Create proc.<br />This means that the end-user&#39;s exe has control of the ambient and maximum Client capacity of the Server component / iocp.<br />By ambient I refer to the number of Accepts pending at all times, and by maximum I refer to the capacity of the Client Collection.<br />The only other thing I did was to split the includes for the Server and Client classes into two files per class - one containing the &quot;classdef&quot;, the other the &quot;codebase&quot; for each.. the reason is that if we include both classdefs before we include the codebases, we can refer to each class from within the other, making &quot;crosscalling&quot; within class methods a straightforward thing.<br />When my beer goggles are on, I&#39;ll see what I can do about adding a perClient XOVL DataCollection ... but my question for today James - can you see any good reason to the support for arrays of WSABUF in single IO operations? If you can, I&#39;ll write a special class for arbitrary struct collections, as DataCollection stores pointers to structs, it&#39;s not a linear array of structs..<br /><br />I&#39;m going to have a few beers and cheer myself up for a while.<br />When my beer goggles are on, I&#39;ll come back and look for a reply :)<br /><br />Vic, I&#39;d like you to see the oop source as well.<br />I have not spent much time on it to be perfectly honest, everything&#39;s&nbsp; crazy at the moment, and I&#39;m sure you would get a kick out of it..<br /><br />Ultrano, GameServer classes soon :)<br /></div>
    <div class="meta">Posted on 2005-06-17 02:33:18 by Homer</div>
   </div>
   <div class="post" id="post-161208">
    <div class="subject"><a href="#post-161208">Re: Modular IOCP Beta Demo</a></div>
    <div class="body">I ended up creating an IOJob class, and an Allocator class which manages Used and Free collections of IOJob objects. Parts of the Client class were moved into IOJob. The Server object creates an instance of Allocator which is accessible to itself, all Client objects, Plugin module, etc.<br />Todo: add a Maintenance function to periodically Shrink the collections, so the Server can scale itself Down when it becomes &quot;less busy than it has been&quot;.<br />Since I&#39;m not done implementing the latest changes yet, I&#39;m not posting a new binary yet.<br />Perhaps later today...<br /></div>
    <div class="meta">Posted on 2005-06-17 16:14:10 by Homer</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=21279&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=21279&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="21279" /><input type="number" name="page" min="1" max="3" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=21279&amp;page=2">&gt;</a><a href="../?id=21279&amp;page=3">&raquo;</a></form>  </div>
 </body>
</html>