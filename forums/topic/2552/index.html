<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Question about obtaining File version info. - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=2552" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=2552">Question about obtaining File version info.</a></p>
   <div class="post" id="post-16153">
    <div class="subject"><a href="#post-16153">Question about obtaining File version info.</a></div>
    <div class="body">Hi! I'm trying to write some code to check and display a programs File version info in a messagebox (like 1.1.103.1)<br /><br />I'm doing it like this, but I can't get it to work, any one have any ideas?<br /><br />-----------------------<br />[...]<br /><br />.data<br />  FileInfo VS_FIXEDFILEINFO &lt;0,0,0,0,0,0,0,0,0,0,0,0,0&gt;	<br />  FileDelimiter db &quot;\&quot;,0<br />  VersionDelimiter db &quot;.&quot;,0<br />  FileName db &quot;file.exe&quot;<br />.data?<br />  InfoSize DWORD ?<br />  FileInfoSize DWORD ?<br />  NotUsed DWORD ?<br />  MajorVer1 DWORD ?<br />  MajorVer2 DWORD ?<br />  MinorVer1 DWORD ?<br />  MinorVer2 DWORD ?<br />  VersionBuffer db 20 dup(?)<br />  VersionMemPtr dd ?<br />  PathBuffer db 1024 dup(?) ; Contains the full path and filename of the file to check.<br /><br />.code<br /><br />[...]<br /><br />INVOKE GetFileVersionInfoSize,OFFSET PathBuffer,OFFSET NotUsed<br />mov InfoSize,eax<br />.IF InfoSize==0<br />  ; Show error message<br />.ELSE<br />  INVOKE GlobalAlloc,GMEM_FIXED,OFFSET InfoSize<br />  mov VersionMemPtr,eax<br />  .IF eax==NULL<br />    ; Show error message<br />  .ELSE<br />    INVOKE GetFileVersionInfo,OFFSET PathBuffer,0,OFFSET InfoSize,OFFSET VersionMemPtr<br />    .IF eax==0<br />      ; Show error message<br />    .ENDIF<br />    INVOKE VerQueryValue,OFFSET VersionMemPtr,OFFSET FileDelimiter,OFFSET FileInfo,OFFSET FileInfoSize<br />    .IF eax==0<br />      ; Show error message<br />    .ENDIF<br />    mov MajorVer1,OFFSET FileInfo.dwProductVersionMS<br />    shr MajorVer1,16<br />    mov MajorVer2,OFFSET FileInfo.dwProductVersionMS<br />    and MajorVer2,0FFFFh<br />    mov MinorVer1,OFFSET FileInfo.dwProductVersionLS<br />    shr MinorVer1,16<br />    mov MinorVer2,OFFSET FileInfo.dwProductVersionLS<br />    and MinorVer2,0FFFFh<br />    INVOKE GlobalFree,OFFSET VersionMemPtr<br />    INVOKE lstrcat,OFFSET VersionBuffer,MajorVer1<br />    INVOKE lstrcat,OFFSET VersionBuffer,OFFSET VersionDelimiter<br />    INVOKE lstrcat,OFFSET VersionBuffer,MajorVer2<br />    INVOKE lstrcat,OFFSET VersionBuffer,OFFSET VersionDelimiter<br />    INVOKE lstrcat,OFFSET VersionBuffer,MinorVer1<br />    INVOKE lstrcat,OFFSET VersionBuffer,OFFSET VersionDelimiter<br />    INVOKE lstrcat,OFFSET VersionBuffer,MinorVer2<br />    INVOKE lstrcat,OFFSET VersionBuffer,InfoSize<br />    INVOKE MessageBox,0,OFFSET VersionBuffer,OFFSET szMessageBoxConfirmationCaption,MB_OK or MB_ICONINFORMATION or MB_SYSTEMMODAL<br />  .ENDIF<br />.ENDIF<br /><br />-------<br /><br />If I have forgotten something it's because I'm dead tired. :) Any help is greatly appreciated. If I do it like this I just get &quot;...&quot; in my messagebox, looks like I'm doing something wrong with the pointer to my VS_FIXEDFILEINFO struct, but I can't figure out what it is.</div>
    <div class="meta">Posted on 2001-12-25 21:32:03 by EvilElvis</div>
   </div>
   <div class="post" id="post-16252">
    <div class="subject"><a href="#post-16252">Question about obtaining File version info.</a></div>
    <div class="body"><pre><code><br />...<br />&#91;b&#93;INVOKE lstrcat,OFFSET VersionBuffer,MajorVer1&#91;/b&#93;<br />INVOKE lstrcat,OFFSET VersionBuffer,OFFSET VersionDelimiter <br />&#91;b&#93;INVOKE lstrcat,OFFSET VersionBuffer,MajorVer2&#91;/b&#93;<br />INVOKE lstrcat,OFFSET VersionBuffer,OFFSET VersionDelimiter <br />&#91;b&#93;INVOKE lstrcat,OFFSET VersionBuffer,MinorVer1 &#91;/b&#93;<br />INVOKE lstrcat,OFFSET VersionBuffer,OFFSET VersionDelimiter <br />...<br /></code></pre><br /><br />These lines are not correct. MajorVer1, 2 etc. are no strings, they are just 32-bit (dword) values. So you can't concatenate them to a string. First, convert the number into a *string* with dwtoa (from the m32library (masm32.lib/.inc)), then use lstrcat to add it to the string.<br />But a better method is to use wsprintf for this (look this function up in your reference or at msdn.microsoft.com). With this function you can specify a string format and use values or other strings to fill it, like this:<br /><br /><pre><code><br />.data<br /> outFormat db &quot;%lu.%lu.%lu&quot;,0<br /> ; %lu stands for 'long &#40;32-bit&#41; unsigned integer'<br />.code<br /> invoke wsprintf, addr outputBuffer, addr outFormat, Version1, Version2, Version3<br /></code></pre><br /><br />Thomas</div>
    <div class="meta">Posted on 2001-12-26 17:03:48 by Thomas</div>
   </div>
   <div class="post" id="post-17088">
    <div class="subject"><a href="#post-17088">Question about obtaining File version info.</a></div>
    <div class="body">Hi Thomas! Thanks for your help, that part works great now, but I still have a problem with this API call: VerQueryValue.<br /><br />This is the spec for this function according to MSDN:<br />BOOL VerQueryValue(<br />  const LPVOID pBlock, // buffer for version resource<br />  LPTSTR lpSubBlock,   // value to retrieve<br />  LPVOID *lplpBuffer,  // buffer for version value pointer<br />  PUINT puLen          // version length<br />);<br /><br /><br />And this is how I call it:<br />INVOKE VerQueryValue,OFFSET VersionMemPtr,OFFSET FileDelimiter,OFFSET FileInfo,OFFSET FileInfoSize<br /><br />I obtain the VersionMemPtr this way:<br />INVOKE GlobalAlloc,GMEM_FIXED,OFFSET InfoSize<br />mov VersionMemPtr,eax<br /><br />and it's declared like this:<br />VersionMemPtr dd ?<br /><br />FileDelimiter is just a variable declared like this:<br />FileDelimiter db &quot;\&quot;,0<br /><br />FileInfoSize is decalred like this:<br />FileInfoSize DWORD ?<br /><br />I think it's the LPVOID *lplpBuffer part that I don't get to work correctly. I declared FileInfo like this:<br />FileInfo VS_FIXEDFILEINFO &lt;0,0,0,0,0,0,0,0,0,0,0,0,0&gt;<br /><br />But after reading more carefully it looks like the function wants a pointer to a variable thats a pointer to a VS_FIXEDFILEINFO. <br /><br />So I guess my question is, how do I achieve that? This is what MSDN has to say about lplpBuffer:<br /><br />lplpBuffer <br /> Pointer to a variable that receives a pointer to the requested version information in the buffer pointed to by pBlock. The memory pointed to by *lplpBuffer is freed when the associated pBlock memory is freed. <br /><br />Any help is greatly appreciated.<br /><br />Thanks again for your help Thomas and a Happy New Year to all of you! :)</div>
    <div class="meta">Posted on 2002-01-01 10:20:53 by EvilElvis</div>
   </div>
   <div class="post" id="post-17137">
    <div class="subject"><a href="#post-17137">Question about obtaining File version info.</a></div>
    <div class="body"><div class="quote">I obtain the VersionMemPtr this way: <br />INVOKE GlobalAlloc,GMEM_FIXED,OFFSET InfoSize <br />mov VersionMemPtr,eax <br /><br />and it's declared like this: <br />VersionMemPtr dd ? <br /></div><br /><br />This should be INVOKE GlobalAlloc,GMEM_FIXED, InfoSize <br />'OFFSET InfoSize' is the address of the InfoSize variable, not the contents of it. (change it in your old code as well)<br /><br />Also, pBlock is an *input* parameter, so giving it an empty memory block has no use. You'll have to call GetFileVersionInfo to fill that new memory block. But you already did that in your previous code so just use the old VersionMemPtr (do not allocate new memory) you already filled in your previous code.<br /><br />Finally, lplpBuffer is a *pointer* to a *dword var* that will receive a *pointer* to the info. So fileinfo has to be:<br /><br />FileInfo dd ?<br /><br />And use 'offset FileInfo' as parameter in the call.<br />On return the value in FileInfo will be a pointer to the information.<br /><br />Thomas</div>
    <div class="meta">Posted on 2002-01-01 14:43:52 by Thomas</div>
   </div>
  </div>
 </body>
</html>