<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>PE DOS stub problem. - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=5703" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=5703">PE DOS stub problem.</a></p>
   <div class="post" id="post-40779">
    <div class="subject"><a href="#post-40779">PE DOS stub problem.</a></div>
    <div class="body">Hi all,<br />Got a bad problem. I tryed to compress with UPX (just for a test) my hand-written PE, but it failed. Afters hours and hours of tracking I found the problem to be not in the PE image, but in the MZ one. Finally, I tracked down the problem being in the .e_cblp and .e_cp fields. I've looked into all the docs I own, and on MSDN, on Usenet, on Google and other search engines.. but no real help. I examinated other executables (both existing and generated by me via an assembler and a linker).. still no definitive clue.<br /><br />What I need to know is how should I set .e_cp and .e_cblp exactly?<br /><br />Thanks,<br />Maverick</div>
    <div class="meta">Posted on 2002-05-31 06:41:34 by Maverick</div>
   </div>
   <div class="post" id="post-40797">
    <div class="subject"><a href="#post-40797">PE DOS stub problem.</a></div>
    <div class="body">Maverick,<br /><br />I know you hate MASM so here is the structure in PowerBASIC,<br /><pre><code><br />TYPE IMAGE_DOS_HEADER<br />  e_magic AS WORD              ' Magic number<br />  e_cblp AS WORD               ' Bytes on last page of file<br />  e_cp AS WORD                 ' Pages in file<br />  e_crlc AS WORD               ' Relocations<br />  e_cparhdr AS WORD            ' Size of header in paragraphs<br />  e_minalloc AS WORD           ' Minimum extra paragraphs needed<br />  e_maxalloc AS WORD           ' Maximum extra paragraphs needed<br />  e_ss AS WORD                 ' Initial &#40;relative&#41; SS value<br />  e_sp AS WORD                 ' Initial SP value<br />  e_csum AS WORD               ' Checksum<br />  e_ip AS WORD                 ' Initial IP value<br />  e_cs AS WORD                 ' Initial &#40;relative&#41; CS value<br />  e_lfarlc AS WORD             ' File address of relocation table<br />  e_ovno AS WORD               ' Overlay number<br />  e_res&#40;0 TO 3&#41; AS WORD        ' Reserved words<br />  e_oemid AS WORD              ' OEM identifier &#40;for e_oeminfo&#41;<br />  e_oeminfo AS WORD            ' OEM information; e_oemid specific<br />  e_res2&#40;0 TO 9&#41; AS WORD       ' Reserved words<br />  e_lfanew AS LONG             ' File address of new exe header<br />END TYPE<br /></code></pre><br />Hope its useful to you.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-05-31 08:33:16 by hutch--</div>
   </div>
   <div class="post" id="post-40799">
    <div class="subject"><a href="#post-40799">PE DOS stub problem.</a></div>
    <div class="body">Argh.. I found it, .e_lfarlc must be set to $40 even if one has no relocations at all.<br /><br />Hutch: thanks for the help anyway. ;)</div>
    <div class="meta">Posted on 2002-05-31 08:40:37 by Maverick</div>
   </div>
   <div class="post" id="post-40885">
    <div class="subject"><a href="#post-40885">PE DOS stub problem.</a></div>
    <div class="body">Maverick,<br /><br />This is actually a fault in UPX that you can modify the IMAGE_DOS_HEADER in a hex editor and UPX will no longer recognise the EXE file as one that it has packed.<br /><br />Change it to 00 and voila, UPX no longer understands it.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-05-31 22:01:41 by hutch--</div>
   </div>
   <div class="post" id="post-40917">
    <div class="subject"><a href="#post-40917">PE DOS stub problem.</a></div>
    <div class="body"><div class="quote"><br />Maverick,<br /><br />This is actually a fault in UPX that you can modify the IMAGE_DOS_HEADER in a hex editor and UPX will no longer recognise the EXE file as one that it has packed.<br /><br />Change it to 00 and voila, UPX no longer understands it.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a> </div>Yup, I deliberately made some experiments on it and noticed that even e.g. just realigning the sections...<br /><br />:)<br /><br />An effective protection only for wannabe crackers, though.. but a nice hint I could then give to a friend.</div>
    <div class="meta">Posted on 2002-06-01 05:41:50 by Maverick</div>
   </div>
  </div>
 </body>
</html>