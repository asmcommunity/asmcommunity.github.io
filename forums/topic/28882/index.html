<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Simple file handling functions - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=28882" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=28882">Simple file handling functions</a></p>
   <div class="post" id="post-204171">
    <div class="subject"><a href="#post-204171">Simple file handling functions</a></div>
    <div class="body">Here are my simple file handling functions coded with Poasm. Masm and Poasm are using the same object file format, so the assembled procedures can be used with Masm.<br /><br />ReadFileToMem :<br /><br /><pre><code>.386<br />.model flat,stdcall<br />option casemap:none<br /><br />include filefunc.inc<br /><br />READFILE_MEMINFO STRUCT<br /><br />&nbsp; &nbsp; hHeap&nbsp; &nbsp; &nbsp;  DWORD&nbsp;  ?<br />&nbsp; &nbsp; hMem&nbsp; &nbsp; &nbsp; &nbsp; DWORD&nbsp;  ?<br />&nbsp; &nbsp; FileSize&nbsp; &nbsp; DWORD&nbsp;  ?<br /><br />READFILE_MEMINFO ENDS&nbsp; &nbsp; <br /><br />PUBLIC&nbsp; ReadFileToMem@8<br /><br />.code<br /><br />;&nbsp;  ReadFileToMem PROC pFileName:DWORD,pMemInfo:DWORD<br /><br />;&nbsp;  pFileName&nbsp; &nbsp; &nbsp;  :&nbsp;  pointer to name of the file<br />;&nbsp;  pMemInfo&nbsp; &nbsp; &nbsp; &nbsp; :&nbsp;  pointer to structure for allocated memory information<br /><br />;&nbsp;  Return values&nbsp;  :&nbsp;  if the function succeeds, eax is NULL. <br />;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  if the function fails, the return value contains the error code&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br /><br /><br />ReadFileToMem@8:<br /><br />&nbsp; &nbsp; sub&nbsp; &nbsp;  esp,2*4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; reserve 8 bytes for the local variables<br />&nbsp; &nbsp; push&nbsp; &nbsp; esi<br />&nbsp; &nbsp; mov&nbsp; &nbsp;  esi,DWORD PTR <br />&nbsp; &nbsp; invoke&nbsp; GetProcessHeap<br />&nbsp; &nbsp; test&nbsp; &nbsp; eax,eax<br />&nbsp; &nbsp; jne&nbsp; &nbsp;  @f<br />&nbsp; &nbsp; mov&nbsp; &nbsp;  eax,1<br />&nbsp; &nbsp; jmp&nbsp; &nbsp;  error<br />@@:<br />&nbsp; &nbsp; mov&nbsp; &nbsp;  READFILE_MEMINFO.hHeap,eax ; save the handle of the process heap<br />&nbsp; &nbsp; invoke&nbsp; CreateFile,DWORD PTR ,GENERIC_READ,0,0,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; OPEN_EXISTING,FILE_ATTRIBUTE_ARCHIVE,0<br />&nbsp; &nbsp; cmp&nbsp; &nbsp;  eax,INVALID_HANDLE_VALUE<br />&nbsp; &nbsp; jne&nbsp; &nbsp;  @f<br />&nbsp; &nbsp; mov&nbsp; &nbsp;  eax,2<br />&nbsp; &nbsp; jmp&nbsp; &nbsp;  error<br />@@:<br />&nbsp; &nbsp; mov&nbsp; &nbsp;  DWORD PTR ,eax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; save the handle of file<br />&nbsp; &nbsp; invoke&nbsp; GetFileSize,eax,0<br />&nbsp; &nbsp; mov&nbsp; &nbsp;  READFILE_MEMINFO.FileSize,eax<br />&nbsp; &nbsp; invoke&nbsp; HeapAlloc,READFILE_MEMINFO.hHeap,HEAP_ZERO_MEMORY,eax<br />&nbsp; &nbsp; mov&nbsp; &nbsp;  READFILE_MEMINFO.hMem,eax&nbsp; &nbsp; &nbsp; ; save the address of the allocated memory<br />&nbsp; &nbsp; lea&nbsp; &nbsp;  ecx,DWORD PTR &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; get the address of number of bytes read <br />&nbsp; &nbsp; invoke&nbsp; ReadFile,DWORD PTR ,eax,READFILE_MEMINFO.FileSize,ecx,0<br />&nbsp; &nbsp; test&nbsp; &nbsp; eax,eax<br />&nbsp; &nbsp; jnz&nbsp; &nbsp;  @f<br />&nbsp; &nbsp; mov&nbsp; &nbsp;  eax,3<br />&nbsp; &nbsp; jmp&nbsp; &nbsp;  error<br />@@:&nbsp; &nbsp; <br />&nbsp; &nbsp; invoke&nbsp; CloseHandle,DWORD PTR <br />&nbsp; &nbsp; xor&nbsp; &nbsp;  eax,eax<br /><br />error:&nbsp; &nbsp; <br />&nbsp; &nbsp; <br />&nbsp; &nbsp; pop&nbsp; &nbsp;  esi<br />&nbsp; &nbsp; add&nbsp; &nbsp;  esp,2*4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; balance the stack<br />&nbsp; &nbsp; ret&nbsp; &nbsp;  2*4<br /><br />;&nbsp;  ENDP ReadFileToMem<br /><br />END</code></pre><br /><br />WriteFileToDisc :<br /><br /><pre><code><br />.386<br />.model flat,stdcall<br />option casemap:none<br /><br />include filefunc.inc<br /><br />PUBLIC&nbsp; WriteFileToDisc@12<br /><br />.code<br /><br />;&nbsp;  WriteFileToDisc PROC pFileName:DWORD,pMemory:DWORD,nSize:DWORD<br /><br />;&nbsp;  pFileName&nbsp; &nbsp; &nbsp;  :&nbsp;  pointer to name of the file<br />;&nbsp;  pMemory&nbsp; &nbsp; &nbsp; &nbsp;  :&nbsp;  address of buffer to write file<br />;&nbsp;  nSize&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  :&nbsp;  number of bytes to write<br /><br />;&nbsp;  Return values&nbsp;  :&nbsp;  if the function succeeds, eax is non-NULL<br />;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  :&nbsp;  if the function fails, the return value is NULL&nbsp; &nbsp; <br /><br /><br />WriteFileToDisc@12:<br /><br />&nbsp; &nbsp; sub&nbsp; &nbsp;  esp,2*4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; reserve 8 bytes for the local variables<br />&nbsp; &nbsp; invoke&nbsp; CreateFile,DWORD PTR ,GENERIC_WRITE,0,0,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CREATE_ALWAYS,FILE_ATTRIBUTE_ARCHIVE,0<br />&nbsp; &nbsp; cmp&nbsp; &nbsp;  eax,INVALID_HANDLE_VALUE<br />&nbsp; &nbsp; jne&nbsp; &nbsp;  @f<br />&nbsp; &nbsp; xor&nbsp; &nbsp;  eax,eax<br />&nbsp; &nbsp; jmp&nbsp; &nbsp;  finish<br />@@:<br />&nbsp; &nbsp; mov&nbsp; &nbsp;  DWORD PTR ,eax&nbsp; &nbsp;  ; save the handle of file<br />&nbsp; &nbsp; lea&nbsp; &nbsp;  ecx,DWORD PTR &nbsp;  ; get the address of number of bytes written<br />&nbsp; &nbsp; invoke&nbsp; WriteFile,eax,DWORD PTR ,DWORD PTR ,ecx,0<br />&nbsp; &nbsp; test&nbsp; &nbsp; eax,eax<br />&nbsp; &nbsp; jz&nbsp; &nbsp; &nbsp; finish<br />&nbsp; &nbsp; invoke&nbsp; CloseHandle,DWORD PTR <br /><br />finish:<br /><br />&nbsp; &nbsp; add&nbsp; &nbsp;  esp,2*4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; balance the stack<br />&nbsp; &nbsp; ret&nbsp; &nbsp;  3*4<br /><br />;&nbsp;  ENDP WriteFileToDisc<br /><br />END</code></pre><br /><br />FreeMemory :<br /><br /><pre><code>.386<br />.model flat,stdcall<br />option casemap:none<br /><br />HeapFree PROTO :DWORD,:DWORD,:DWORD<br /><br />READFILE_MEMINFO STRUCT<br /><br />&nbsp; &nbsp; hHeap&nbsp; &nbsp; &nbsp;  DWORD&nbsp;  ?<br />&nbsp; &nbsp; hMem&nbsp; &nbsp; &nbsp; &nbsp; DWORD&nbsp;  ?<br />&nbsp; &nbsp; FileSize&nbsp; &nbsp; DWORD&nbsp;  ?<br /><br />READFILE_MEMINFO ENDS&nbsp; &nbsp; <br /><br />PUBLIC FreeMemory@4<br /><br />.code<br /><br />;&nbsp;  FreeMemory&nbsp; PROC pMemInfo <br /><br />;&nbsp;  pMemInfo&nbsp; &nbsp; :&nbsp;  pointer to structure for allocated memory information<br /><br />FreeMemory@4:<br /><br />&nbsp; &nbsp; mov&nbsp; &nbsp;  eax,DWORD PTR <br />&nbsp; &nbsp; invoke&nbsp; HeapFree,READFILE_MEMINFO.hHeap,0,READFILE_MEMINFO.hMem<br />&nbsp; &nbsp; ret&nbsp; &nbsp;  4<br /><br />;&nbsp;  ENDP FreeMemory<br /><br />END</code></pre></div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=2526" target="_blank">fileIO22.zip</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2007-12-29 07:55:24 by Vortex</div>
   </div>
   <div class="post" id="post-204181">
    <div class="subject"><a href="#post-204181">Re: Simple file handling functions</a></div>
    <div class="body">A bit of (constructive, hopefully) criticism:<br /><br />EAX is 0, not NULL, on error... you really should only talk about NULL when dealing with pointer values.<br /><br />Why are you using HEAP_ZERO_MEMORY when you&#039;re going to fill the entire allocated memory with data read from file? Waste of CPU cycles :)<br /><br />Why are you using a hHeap when you only support using the process default heap?<br /><br />It&#039;s probably a better idea to do away with the heap and use VirtualAlloc instead, unless most files read this way will be &lt;4kb. And if you&#039;re dealing with a lot of small files, perhaps you should use a separate heap to reduce fragmentation of the main heap...</div>
    <div class="meta">Posted on 2007-12-29 10:14:22 by f0dder</div>
   </div>
   <div class="post" id="post-204198">
    <div class="subject"><a href="#post-204198">Re: Simple file handling functions</a></div>
    <div class="body">Since asm does not support type casting like <span class="mono">((void *)0)</span> - the ANSI definition of <span class="mono">NULL</span>, I assume that <span class="mono">NULL</span> is equal to 0 for <u>practical</u> programming. You can think that it&#039;s a kind of simulation of <span class="mono">NULL</span> pointer. Normally, the <span class="mono">NULL</span> pointer and 0 are not the same thing but this assumption should be a solution to make easier the life. You can think it like this one : engineering calculations are always an approximation as they cannot give exact results like in mathematics.<br /><br />I am accustomed to use <span class="mono">HEAP_ZERO_MEMORY</span>. You are right, I can replace it with <span class="mono">HEAP_GENERATE_EXCEPTIONS</span><br /><br /><span class="mono">hHeap</span> is preserved with the intention to limit the call to <span class="mono">GetProcessHeap</span> to one time. The user would like to use hHeap to allocate another block of memory. My <span class="mono">FreeMemory</span> function also uses this value to release the allocated memory block.<br /><br />It&#039;s in my mind to create another version of <span class="mono">ReadFileToMem</span> using <span class="mono">VirtualAlloc</span>. The heap functions are OK for small files and practical programming.<br /><br /></div>
    <div class="meta">Posted on 2007-12-30 03:48:16 by Vortex</div>
   </div>
   <div class="post" id="post-204201">
    <div class="subject"><a href="#post-204201">Re: Simple file handling functions</a></div>
    <div class="body"><div class="quote"><br />Since asm does not support type casting like <span class="mono">((void *)0)</span> - the ANSI definition of <span class="mono">NULL</span>, I assume that <span class="mono">NULL</span> is equal to 0 for <u>practical</u> programming. You can think that it&#039;s a kind of simulation of <span class="mono">NULL</span> pointer. Normally, the <span class="mono">NULL</span> pointer and 0 are not the same thing but this assumption should be a solution to make easier the life. You can think it like this one : engineering calculations are always an approximation as they cannot give exact results like in mathematics.<br /></div><br />Yes, NULL is equal to 0 (and for ISO C++, actually defined as 0 instead of the ANSI-C pointer type), but you have to consider the <em>semantic value</em> of using NULL - it&#039;s traditionally been used when dealing with pointer values, so when seeing a NULL, most people will expect that the argument is a pointer. Using NULL for zero <strong>integers</strong> is plain confusing.<br /><br />You could also use NULL instead of MB_OK, you could use <span class="mono">POWER_ACTION_CRITICAL</span> instead of <span class="mono">GENERIC_READ</span>, etc... do you catch my drift? :)<br /><br /><div class="quote"><br />I am accustomed to use HEAP_ZERO_MEMORY. You are right, I can replace it with HEAP_GENERATE_EXCEPTIONS<br /></div><br />Just pass a 0 instead, indicating you don&#039;t need any special options. Using HEAP_GENERATE_EXCEPTIONS would require you to set up exception-handling code...<br /><br /><div class="quote"><br /><span class="mono">hHeap</span> is preserved with the intention to limit the call to <span class="mono">GetProcessHeap</span> to one time. The user would like to use hHeap to allocate another block of memory. My <span class="mono">FreeMemory</span> function also uses this value to release the allocated memory block.<br /></div><br />This is pretty much a non-optimization, GetProcessHeap is a very inexpensive call, instead you waste a bit of memory for every open file. Okay, I can&#039;t think of any scenario where the memory would add up enough to be a problem, but as long as you&#039;re only using the default process heap, there isn&#039;t much use in storing hHeap.<br /><br /><div class="quote"><br />It&#039;s in my mind to create another version of <span class="mono">ReadFileToMem</span> using <span class="mono">VirtualAlloc</span>. The heap functions are OK for small files and practical programming.<br /></div><br />Yes, the heap is good for small allocations, that&#039;s what is what meant for. And VirtualAlloc rounds your size allocations up to 4kb, as well as aligning the memory to 64kb boundaries, so it&#039;s only good when you&#039;re dealing with larger allocations... but in that situation, I&#039;d choose it over heap functions any time, any day.<br /><br />Anyway, hope you don&#039;t take this as your code being bashed, it&#039;s a few relatively minor points on the way to perfection :)<br /></div>
    <div class="meta">Posted on 2007-12-30 05:49:50 by f0dder</div>
   </div>
   <div class="post" id="post-204204">
    <div class="subject"><a href="#post-204204">Re: Simple file handling functions</a></div>
    <div class="body"><div class="quote">This is pretty much a non-optimization, GetProcessHeap is a very inexpensive call, instead you waste a bit of memory for every open file. Okay, I can&#039;t think of any scenario where the memory would add up enough to be a problem, but as long as you&#039;re only using the default process heap, there isn&#039;t much use in storing hHeap.</div><br /><br />Storing hHeap should be more faster than calling repeatly <span class="mono">GetProcessHeap</span> Optimizing every line of this routine does not worth much, very few people would be interested in a super-optimized ReadFile function. Anyway, calling GetProcessHeap of stroring the value should not be an issue here.<br /><br />I have no problem with your comments.</div>
    <div class="meta">Posted on 2007-12-30 06:26:31 by Vortex</div>
   </div>
   <div class="post" id="post-204206">
    <div class="subject"><a href="#post-204206">Re: Simple file handling functions</a></div>
    <div class="body"><div class="quote"><br />Storing hHeap should be more faster than calling repeatly <span class="mono">GetProcessHeap</span> Optimizing every line of this routine does not worth much, very few people would be interested in a super-optimized ReadFile function. Anyway, calling GetProcessHeap of stroring the value should not be an issue here.<br /></div><br />Slightly faster, yes, but it&#039;s a micro-optimization that&#039;s pretty pointless; all GetProcessHeap does is giving you a value from the TEB, no ring3&lt;&gt;ring0 stuff going on. For the sake of completeness and considering how simple the function is, I suppose it&#039;s okay to post the disassembly here:<br /><br /><pre><code><br />.text:7D4D8DF9 GetProcessHeap&nbsp; proc near<br />.text:7D4D8DF9&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  mov&nbsp; &nbsp;  eax, large fs:18h<br />.text:7D4D8DFF&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  mov&nbsp; &nbsp;  eax, <br />.text:7D4D8E02&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  mov&nbsp; &nbsp;  eax, <br />.text:7D4D8E05&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  retn<br />.text:7D4D8E05 GetProcessHeap&nbsp; endp<br /></code></pre><br /><br />So sure, it&#039;s slightly faster not calling it, but you&#039;ll have a hard time measuring any performance gain. It&#039;s funny that you say &quot;<em>very few people would be interested in a super-optimized ReadFile function</em>&quot;, but still have applied a micro-optimization like this :)<br /></div>
    <div class="meta">Posted on 2007-12-30 06:46:34 by f0dder</div>
   </div>
  </div>
 </body>
</html>