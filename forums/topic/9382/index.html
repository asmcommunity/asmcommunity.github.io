<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>recv after FD_CLOSE - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=9382" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=8">Networking</a> &raquo; <a href="../?id=9382">recv after FD_CLOSE</a></p>
   <div class="post" id="post-69302">
    <div class="subject"><a href="#post-69302">recv after FD_CLOSE</a></div>
    <div class="body">Hi.<br />I'm new to WinSock, so please, be patient ;)<br /><br />I found a dicrepancy in MSDN considering shutdown() and FD_CLOSE notification (from WSAsyncSelect doc)<br />The sequence from shutdown() doc is<br /><br />1 Call WSAAsyncSelect to register for FD_CLOSE notification. <br />2 Call shutdown with how=SD_SEND. <br />3 When FD_CLOSE received, call recv until zero returned, or SOCKET_ERROR. <br />4 Call closesocket. <br /><br />I'm using message notification sockets. So I'm always catching FD_CLOSE <br />from WSAsyncSelect doc:<br /><br />WSAsyncSelect doc, FD_CLOSE description<br /><br />FD_CLOSE: Only valid on connection-oriented sockets (for example, SOCK_STREAM) <br />1.<br /> when WSAAsyncSelect called, if socket connection has been closed, <br />2. <br />after remote system initiated graceful close, when no data currently available to receive (note: if data has been received and is waiting to be read when the remote system initiates a graceful close, the FD_CLOSE is not delivered until all pending data has been read), <br />3. <br />after local system initiates graceful close with shutdown and remote system has responded with &quot;End of Data&quot; notification (for example, TCP FIN), when no data currently available to receive, <br />4.<br />when remote system terminates connection (for example, sent TCP RST), and lParam will contain WSAECONNRESET error value.<br /><br /><br />It seems, at least for the case #2 there is no need to call recv after<br />receiving FD_CLOSE since all FD_READ message are delivered by this time.<br /><br />I'm not sure for other case, but when I call recv I get 0.<br />So, in which cases is it really necessary to loop with recv (especially when I don't expect anything else from the remote site and have one thread )?</div>
    <div class="meta">Posted on 2002-12-05 17:13:34 by Sergo</div>
   </div>
   <div class="post" id="post-69418">
    <div class="subject"><a href="#post-69418">recv after FD_CLOSE</a></div>
    <div class="body"><div class="quote">It seems, at least for the case #2 there is no need to call recv after<br />receiving FD_CLOSE since all FD_READ message are delivered by this time.</div><br /><br />This is true, no more FD_READ messages will be received and the socket will not accept incomming packets after FD_CLOSE is received. It is pointless to try to receive packets on this socket after receiving an FD_CLOSE message because you will NEVER get anything! (However in the graceful shutdown method using shutdown() you can still send data to the client)<br /><br /><div class="quote">So, in which cases is it really necessary to loop with recv (especially when I don't expect anything else from the remote site and have one thread )?</div><br /><br />Using shutdown initiates a &quot;graceful shutdown&quot;! I recomend you read the microsoft documentation on Graceful shutdowns! If you do not need to implement graceful shutdown routines, then you can use closesocket and it will send the other machine an FD_CLOSE. Although this is not the microsoft recommended way of initiating a shutdown because it is a &quot;forceful&quot; shutdown. The method you implement is completely up to you.<br /><br />NB: In the graceful shutdown method, if you receive an FD_CLOSE message, you can still SEND data to the client who initiated the shutdown, but the client has told the server it won't send any more data so the Server doesn't need to initiate a receive. You don't have use this method if the client won't need anything after it closes the connection.<br /><br />NB: closesocket() sends an FD_CLOSE AND closes the socket so it won't send/receive anymore data! shutdown() sends an FD_CLOSE but DOESN'T close the socket, so you can still RECEIVE data on it. After calling shutdown() you CANNOT SEND anymore data!<br /><br />From the MSDN article: Graceful shutdown, linger options and socket closure<br /><br />Client Side<br />(1) Invoke shutdown(s, SD_SEND) to signal end of session and that client has no more data to send.  <br />_____________Server Side <br />_____________(2) Receive FD_CLOSE, indicating graceful shutdown in progress and that all data has been received. <br />_____________(3) Send any remaining response data. <br />_____________(4) Invoke shutdown(s, SD_SEND) to indicate server has no more data to send. <br />_____________(4') Invoke closesocket <br />(5') Get FD_READ and invoke recv to get any response data sent by server<br />(5) Receive FD_CLOSE indication<br />(6) Invoke closesocket <br /><br />Note The timing sequence is maintained from step (1) to step (6) between the client and the server, except for step (4') and (5') which only has local timing significance in the sense that step (5) follows step (5') on the client side while step (4') follows step (4) on the server side, with no timing relationship with the remote party.</div>
    <div class="meta">Posted on 2002-12-06 01:03:31 by SubEvil</div>
   </div>
   <div class="post" id="post-69595">
    <div class="subject"><a href="#post-69595">grace</a></div>
    <div class="body">Actually when I call recv during processing FD_CLOSE<br />it immediatly return 0 even if the socket is non-blocking, as<br />it's supposed to be , I assume it's an ACK to my FIN when I called shutdown(SB_SEND), and when then I call closesocket() I send final FIN.<br />What MSDN article you were referring to?<br /><br />BTW , there is an example of IOCP socket programming in PSDK.</div>
    <div class="meta">Posted on 2002-12-06 18:33:27 by Sergo</div>
   </div>
   <div class="post" id="post-69955">
    <div class="subject"><a href="#post-69955">recv after FD_CLOSE</a></div>
    <div class="body">I don't think I made myself clear, you are RIGHT, you WON'T recv() ANYTHING in FD_CLOSE, you should take the recv() out of FD_CLOSE you cannot use it there !!!<br />FD_CLOSE indicates that the other machine will NOT send anymore data, so you don't need to call recv()!<br /><br />However, if you initiated a graceful shutdown using shutdown API, you can still send() in FD_CLOSE!<br /><br />So, do not use recv() in FD_CLOSE message, it's pointless! You can only use send() in FD_CLOSE message if you used shutdown() not closesocket()!<br />If FD_CLOSE message was sent using closesocket, then you cannot use send() in FD_CLOSE message!!!<br /><br />To make it more clear ... look on the server side of my last post ...<br />_____________Server Side <br />_____________(2) Receive FD_CLOSE, indicating graceful shutdown in progress and that all data has been received. <br />_____________(3) Send any remaining response data. <br />_____________(4) Invoke shutdown(s, SD_SEND) to indicate server has no more data to send. <br />_____________(4') Invoke closesocket <br />Once the server gets FD_CLOSE ... it doesn't/cannot receive anymore data from the client!<br /><br />MSDN Article = Graceful shutdown, linger options and socket closure<br /><br />BTW, have you looked at the example of IOCP in PSDK ... it's so complicated! I would love some simple examples in ASM :(</div>
    <div class="meta">Posted on 2002-12-09 00:19:33 by SubEvil</div>
   </div>
  </div>
 </body>
</html>