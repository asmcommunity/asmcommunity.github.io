<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>C to asm conversion help - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=3686" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=3686">C to asm conversion help</a></p>
   <div class="post" id="post-24685">
    <div class="subject"><a href="#post-24685">C to asm conversion help</a></div>
    <div class="body">i have this i need converted to asm:<br /><pre><code>RASCONN * lpRasConn;<br />DWORD     lpcb;<br />DWORD     lpcConnections;<br /><br />lpRasConn = &#40;LPRASCONN&#41; GlobalAlloc&#40;GPTR, sizeof&#40;RASCONN&#41;&#41;;<br />lpRasConn-&gt;dwSize = sizeof&#40;RASCONN&#41;;<br />lpcb = sizeof&#40;RASCONN&#41;;<br /> <br />nRet = RasEnumConnections&#40;lpRasConn, &amp;lpcb, &amp;lpcConnections&#41;;<br />if &#40;nRet != 0&#41;<br />&#123;<br />    printf&#40;&quot;RasEnumConnections failed&#58; Error = %d&quot;, nRet&#41;;<br />&#125;<br />else<br />&#123;<br />    printf&#40;&quot;The following RAS connections are currently active\n\n&quot;&#41;;<br />    for &#40;i = 0; i &lt; lpcConnections; i++&#41;<br />    &#123;<br />        printf&#40;&quot;Entry name&#58; %s\n&quot;, lpRasConn-&gt;szEntryName&#41;;<br />        lpRasConn++;<br />    &#125;<br />&#125;</code></pre><br /><br />i converted it to this:<br /><pre><code>.data?<br />ras1 RASCONN &lt;&gt;<br />ras3 DWORD ? <br /><br />.code<br />start&#58;<br /><br />invoke GlobalAlloc,GPTR, sizeof RASCONN<br />mov ras1.dwSize,eax<br />invoke RasEnumConnections,addr ras1,sizeof RASCONN,addr ras3<br />   .if eax == 0<br />      invoke MessageBox,0,0,0,0<br />   .endif<br />   <br />invoke ExitProcess,NULL<br />end start</code></pre><br />on success the RasEnumConnections is suppose to return a 0 and i dont get it so im assuming i made an error in the conversion.</div>
    <div class="meta">Posted on 2002-02-17 12:17:51 by smurf</div>
   </div>
   <div class="post" id="post-24687">
    <div class="subject"><a href="#post-24687">C to asm conversion help</a></div>
    <div class="body">Smurf,<br /><br />If the API wants a pointer, give it a pointer...<br /><br /><strong>nRet = RasEnumConnections(lpRasConn, <u>&amp;lpcb</u>, &amp;lpcConnections);</strong><br /><div class="quote">lpcb<br /><br />Points to a variable that contains the size, in bytes, of the buffer specified by lprasconn. <u>On return, the function sets this variable to the number of bytes required to enumerate the RAS connections</u>. </div><br /><br />If you just give it a number (sizeoff ...), the api will treat that as a pointer, NOT A NUMBER <em>(heheh get it NaN)</em><br /><br />Do what the source has done by declairing a dummy variable (lpcb) and set that variable to the size as well, and in the api, give it that address....<br /><br />I didnt check it, but this *should* get things working..<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-02-17 12:28:55 by NaN</div>
   </div>
   <div class="post" id="post-24691">
    <div class="subject"><a href="#post-24691">C to asm conversion help</a></div>
    <div class="body">Man, on a second look over, there is other mistakes...<br /><br />First, the C++ version <strong>doesnt</strong> declair an entire structure at the begining.. it declairs only a pointer. (DWORD LENGHT)<br /><br /><strong>RASCONN * lpRasConn;</strong>  &lt;-- this is DWORD!<br /><br />The global alloc then *creates* enought memory to be filled as described by the STUCT template.  When created it returns the <strong>POINTER</strong> to the area of memory, which is conveniently stored in the variable-pointer (lpRasConn), described to be regulated by the same stucture (RASCONN).  <br /><br />However, your attempt first allocates this space in the .data? section.  So the need for the global alloc is now redundant, as you <strong>already</strong> have this space provided!<br /><br />All corrections discussed then would make your code to be:<br /><pre><code><br />.data?<br />ras1 RASCONN &lt;&gt;<br />&#91;b&#93;lpRas3&#91;/b&#93; DWORD ?   ; since it will return a pointer &#40;note it!&#41;<br />&#91;b&#93;dummy DWORD ?&#91;/b&#93;<br /><br />.code<br />start&#58;<br /><br />&#91;b&#93;; FORGET THIS  invoke GlobalAlloc,GPTR, sizeof RASCONN&#91;/b&#93;<br />&#91;b&#93;; THIS TOO! mov ras1.dwSize,eax  &#40;EAX != SIZE!&#41;&#91;/b&#93;<br />&#91;b&#93;; ADD THE FOLLOWING&#58;<br /><br />mov ras1.dwSize, SIZEOF RASCONN<br />mov dummy, SIZEOF RASCONN<br /><br />&#91;/b&#93;invoke RasEnumConnections,addr ras1,&#91;b&#93;ADDR dummy&#91;/b&#93;,addr &#91;b&#93;lpRas3&#91;/b&#93;<br />   .if eax == 0<br />      invoke MessageBox,0,0,0,0<br />   .endif<br />   <br />invoke ExitProcess,NULL<br />end start</code></pre><br /><br />If you read the API reference you will see that the DUMMY variable will have some &quot;meaning&quot; or value upon the api working ok.. you should read up on it and see how important this returned info (in dummy) is to your needs.<br /><br />Enjoy..<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-02-17 12:50:22 by NaN</div>
   </div>
   <div class="post" id="post-24693">
    <div class="subject"><a href="#post-24693">C to asm conversion help</a></div>
    <div class="body">hmm.. i assembled the code in your last post and it appears that the function isnt working. i wonder what the heck is going on. maybe it has to do with something on my computer. im networked and i share the modem with another computer.</div>
    <div class="meta">Posted on 2002-02-17 13:02:06 by smurf</div>
   </div>
   <div class="post" id="post-24699">
    <div class="subject"><a href="#post-24699">C to asm conversion help</a></div>
    <div class="body">Well im networkin illiterate, and have no modem, and only one machine on &quot;my&quot; network ~~ So i get a 610 Error when i try it (dunno what it means, the headers dont have the error code in them), but here is my full transcription of the posted C++ version:<br /><br /><pre><code><br />&#91;b&#93;.data&#91;/b&#93;<br />szFormatFail   BYTE &quot;Ras EnumConnections failed&#58; Error %d&quot;,13,10,0<br />szFormatGood   BYTE &quot;Entry name&#58; %s\n, lpRasConn-&gt;szEntryName&#41;&quot;,13,10,0<br /><br />&#91;b&#93;.data?&#91;/b&#93;<br />OutBuffer      BYTE      128 dup&#40;?&#41;<br />Counter        DWORD     ?<br /><br /><br />lpRasConn      DWORD     ?<br />lpcb           DWORD     ?<br />lpcConnections DWORD     ?<br /><br /><br />&#91;b&#93;.code&#91;/b&#93;<br />start&#58;<br /><br />invoke GlobalAlloc, GPTR, SIZEOF RASCONN<br />mov lpRasConn, eax<br /><br />mov edx, lpRasConn<br />mov &#40;RASCONN PTR &#91;edx&#93;&#41;.dwSize, SIZEOF RASCONN<br />mov lpcb, SIZEOF RASCONN<br /><br />invoke RasEnumConnections, lpRasConn, addr lpcb, addr lpcConnections<br />.if&#40; eax != 0 &#41;<br />     invoke wsprintf, addr OutBuffer, addr szFormatFail, eax<br />     invoke MessageBox, NULL, addr OutBuffer, NULL, NULL<br />.else<br />     mov Counter, 0<br />     mov eax, Counter<br />     .while&#40; eax &lt; lpcConnections &#41;<br />       <br />       mov edx, lpRasConn<br />       lea eax, &#40;RASCONN PTR &#91;edx&#93;&#41;.szEntryName<br />       invoke wsprintf, addr OutBuffer, addr szFormatGood, eax<br />       invoke MessageBox, NULL, addr OutBuffer, NULL, NULL<br />       add lpRasConn, SIZEOF RASCONN<br />     <br />     inc Counter<br />     mov eax, Counter<br />     .endw<br />     <br />.endif<br />     invoke GlobalFree, lpRasConn<br />     call ExitProcess<br />&#91;b&#93;end start&#91;/b&#93;</code></pre><br /><br />One of the intersting things I see, is that the C version defines only 1*RASCONN bytes of memory, and fills the dsSize entry accordingly.  Then when you pass this to the API, it *should* return an ARRAY of RASCONN's ie) X * RASCONN, where X is # of entries.  So im assuming that global mem pointer is being free'd by the API, then a new one is put in the old pointer's place, befor returning.  The API doc's dont say too much how this actually works?? But i wrote my code to follow suite (as the C version does).<br /><br />Aslo, on last posibility is that the structure itself is mis-translated.  I noted in the API reference that the reason you are to define just on RASCONN in the first place is to give the API an indication of which *version* your using.  If the translation here is miss represented, this could cause the persistant error.<br /><br />Hope it helps...<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-02-17 13:53:01 by NaN</div>
   </div>
   <div class="post" id="post-24704">
    <div class="subject"><a href="#post-24704">C to asm conversion help</a></div>
    <div class="body">This is what Windows.inc has:<br /><br /><pre><code>RASCONNA STRUCT<br />    dwSize dd ?<br />    hrasconn dd ?<br />    szEntryName db RAS_MaxEntryName + 1 dup&#40;?&#41;<br />    szDeviceType db RAS_MaxDeviceType + 1 dup&#40;?&#41;<br />    szDeviceName db RAS_MaxDeviceName + 1 dup&#40;?&#41;<br />RASCONNA ENDS </code></pre><br /><br />And this is what the C++ definition is:<br /><pre><code>RASCONNA<br />&#123;<br />    DWORD    dwSize;<br />    HRASCONN hrasconn;<br />    CHAR     szEntryName&#91; RAS_MaxEntryName + 1 &#93;;<br /><br />#if &#40;WINVER &gt;= 0x400&#41;<br />    CHAR     szDeviceType&#91; RAS_MaxDeviceType + 1 &#93;;<br />    CHAR     szDeviceName&#91; RAS_MaxDeviceName + 1 &#93;;<br />#endif<br />#if &#40;WINVER &gt;= 0x401&#41;<br />    CHAR     szPhonebook &#91; MAX_PATH &#93;;<br />    DWORD    dwSubEntry;<br />#endif<br />&#125;;</code></pre><br /><br />So as you can see this *might* be a source of probs.  I still cant verify (for above reasons), but i tried the 3 possibilities, and all 3 give me the same error (probably == No Modem).<br /><br />BTW:  The defined ASM version assumes WINVER == 0x400<br /><br />Good Luck... i've done all that i can..<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-02-17 14:12:47 by NaN</div>
   </div>
   <div class="post" id="post-24754">
    <div class="subject"><a href="#post-24754">C to asm conversion help</a></div>
    <div class="body">nan i also got an error but it wasnt the same one you got. i get an error 632.:confused: anyways thank you helping you've cleared alot up for me.</div>
    <div class="meta">Posted on 2002-02-17 18:46:10 by smurf</div>
   </div>
  </div>
 </body>
</html>