<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>If Function Using Nasm - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=30019" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=30019">If Function Using Nasm</a></p>
   <div class="post" id="post-211946">
    <div class="subject"><a href="#post-211946">If Function Using Nasm</a></div>
    <div class="body">Hello,<br /> I want to do a loop using Nasm syntax, but I don&#039;t know even where to start, then I&#039;m asking for help here, but remember that I want resources to learn and try to build it, not just code. ;)<br /><br />Best Regards,<br /> Nathan Paulino Campos</div>
    <div class="meta">Posted on 2010-06-04 09:44:35 by nathanpc</div>
   </div>
   <div class="post" id="post-211948">
    <div class="subject"><a href="#post-211948">Re: Looping Using Nasm</a></div>
    <div class="body"><strong>nathanpc</strong>,<br /><br />To repeat some sequence of instructions one usually use branch instruction to transfer program control back to the start of that sequence. Unless repetition is terminated by other means, some conditional branch instructions are involved. The exact instructions depend on which kind of loop you&#039;re trying to implement: while, do…while/repeat…until, for/for each, etc.</div>
    <div class="meta">Posted on 2010-06-04 09:59:51 by baldr</div>
   </div>
   <div class="post" id="post-211949">
    <div class="subject"><a href="#post-211949">Re: Looping Using Nasm</a></div>
    <div class="body">Oh, sorry for this, I&#039;m already doing a loop like this:<br /><pre><code>loop:<br />&nbsp; &nbsp; mov ah, 00h<br />&nbsp; &nbsp; int 16h<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; mov ah, 0eh&nbsp;  <br />&nbsp; &nbsp; int 10h<br /><br />&nbsp; &nbsp; jmp loop</code></pre><br />What I want is something like a if function for the input, like if the user input the text test and press enter, it will do something like print a char. ;)<br /><br />Best Regards.</div>
    <div class="meta">Posted on 2010-06-04 10:45:37 by nathanpc</div>
   </div>
   <div class="post" id="post-211953">
    <div class="subject"><a href="#post-211953">Re: Looping Using Nasm</a></div>
    <div class="body"><strong>nathanpc</strong>,<br /><br />Store entered characters in some buffer inside loop, check for 13 to exit loop, then compare.</div>
    <div class="meta">Posted on 2010-06-04 16:39:04 by baldr</div>
   </div>
   <div class="post" id="post-211976">
    <div class="subject"><a href="#post-211976">Re: Looping Using Nasm</a></div>
    <div class="body">I like to start with simple things, to complicate them later, then I&#039;ve done this:<br /><pre><code>main:<br /> &nbsp; &nbsp;mov ah, 00h<br /> &nbsp; &nbsp;int 16h<br /> &nbsp; &nbsp;cmp al, &quot;a&quot;<br /> &nbsp; &nbsp;je got<br /><br />got:<br /> &nbsp; &nbsp;mov si, msg<br /> &nbsp; &nbsp;call printf<br /> &nbsp; &nbsp;<br /><br />; +------------+<br />; | Procedures |<br />; +------------+ &nbsp; &nbsp;<br />printf:<br /> &nbsp; &nbsp;mov ah, 0eh<br /> &nbsp; &nbsp;mov bl, 07h<br /><br /> &nbsp; &nbsp;.nextchar<br /> &nbsp; &nbsp; &nbsp; lodsb<br /> &nbsp; &nbsp; &nbsp; or al, al<br /> &nbsp; &nbsp; &nbsp; jz .return<br /> &nbsp; &nbsp; &nbsp; int 10h<br /> &nbsp; &nbsp; &nbsp; jmp .nextchar<br /><br /> &nbsp; &nbsp;.return<br /> &nbsp; &nbsp; &nbsp; ret<br /><br />.data<br />msg db &quot;Hello, World!&quot;, 0ah, 0ah</code></pre><br />When I tried to test this, I got nothing. What is wrong?</div>
    <div class="meta">Posted on 2010-06-06 12:24:48 by nathanpc</div>
   </div>
   <div class="post" id="post-211977">
    <div class="subject"><a href="#post-211977">Re: If Function Using Nasm</a></div>
    <div class="body"><strong>nathanpc</strong>,<br /><br />Is it a complete source? Since there is no <strong>org 100h</strong>, I&#039;ll believe it&#039;s .Exe; then you need to initialize <strong>ds</strong> for <strong>lodsb</strong> to work as expected.<br /><br />Is there anything supposed to be between <strong>je got</strong> and <strong>got:</strong>?<br /><br />Where is the code to return control to OS?</div>
    <div class="meta">Posted on 2010-06-06 13:13:00 by baldr</div>
   </div>
   <div class="post" id="post-211978">
    <div class="subject"><a href="#post-211978">Re: If Function Using Nasm</a></div>
    <div class="body">Sorry, my fault, lots of coffee, sleppy, 1 am, and I forgot the <strong>lodsb</strong> part, also it&#039;s not the complete code, just because I think that just those lines are important now, and there isn&#039;t anything betwen <strong>je got</strong> and the <strong>got</strong> label. Then I&#039;ve corrected all, executed the code, then pressed the <strong>a</strong> character of my keyboard, then I waited about 10 seconds, nothing appeared on the screen, then I&#039;ve pressed the <strong>a</strong> key another time, then the message was displayed, but just this: <strong>ello, World!</strong>, why there isn&#039;t displaying the <strong>H</strong> that starts the variable? Also, the message isn&#039;t displayed if I don&#039;t press the key two times, and also if I press it less than 10 seconds before the first press, I get anything. How could I solve this too?</div>
    <div class="meta">Posted on 2010-06-06 16:06:02 by nathanpc</div>
   </div>
   <div class="post" id="post-211981">
    <div class="subject"><a href="#post-211981">Re: If Function Using Nasm</a></div>
    <div class="body"><strong>nathanpc</strong>,<br /><br />Look, if you&#039;re able to determine which parts of the source are related to the problem, you must&#039;ve been able to solve it yourself. ;-)</div>
    <div class="meta">Posted on 2010-06-07 01:48:34 by baldr</div>
   </div>
   <div class="post" id="post-211982">
    <div class="subject"><a href="#post-211982">Re: If Function Using Nasm</a></div>
    <div class="body">I think that observation might not apply to everyone.<br />It appears that Nathan has little foundation knowledge - this is what allows us to determine solutions after having identified the nature, context and position of the issue at hand.<br />That&#039;s ok !! He can learn stuff as he rams headfirst into it, like we all did.<br />He&#039;s capable of learning, and he seems keen to do so&nbsp; :thumbsup:</div>
    <div class="meta">Posted on 2010-06-07 01:56:03 by Homer</div>
   </div>
   <div class="post" id="post-211987">
    <div class="subject"><a href="#post-211987">Re: If Function Using Nasm</a></div>
    <div class="body">Q: Why doesn&#039;t my program work?<br />A: Because something you believe to be true is not true!<br /><br />I read that in an article about debugging Linux, but I think it applies generally. So what we need to do is figure out what we &quot;believe is true&quot; for every part of the program (this is the hard part!), and then check to make sure it *is* true.<br /><br />You give a mystifying set of symptoms, Nathan! Why would ten seconds be important? I have no idea! Why does it work the second time? We might be able to figure that out, although I don&#039;t see it at the moment...<br /><br />You don&#039;t show the &quot;corrected&quot; code, so I&#039;ll try with what you last posted. Starting with &quot;pre code&quot;, before what you show. As baldr points out, we don&#039;t really know what &quot;kind&quot; of code this is. If it&#039;s a .com file, it needs to start with &quot;org 100h&quot;. &quot;org&quot; sounds like &quot;organization&quot; to me (something I&#039;m very bad at!), but it means &quot;origin&quot; - where (not when) the code begins. Nasm does not know this, and assumes zero unless we tell it otherwise. &quot;Not true&quot; in a .com file! Dos loads a .com file at offset 100h... in a segment of its own choosing (lowest one free, usually). It then sets all our segment registers to this segment. This is &quot;not true&quot; for other file types! So a .com file needs to know &quot;100h&quot;, but we don&#039;t need to initialize segregs.<br /><br />Baldr guesses maybe .exe. I&#039;d expect to see a &quot;..start&quot; label if that were the case. We would need to initialize segment registers in that case. &quot;.data&quot; is not a segment directive (if you &quot;believed this is true&quot;, it isn&#039;t), so your data is in the code segment. I think .exe would be a really bad choice for this, so I&#039;m going to ASSume &quot;not true&quot;. (if I&#039;m wrong, we can come back to it)<br /><br />Last I knew, you were trying to do this in a bootsector. If &quot;true&quot;, bios loads our code to 7C00h. Due to the way &quot;segmented addressing&quot; works, this address could be represented as segment 0, offset 7C00h, or segment 7C0h, offset 0. Exact same address! You don&#039;t show &quot;org 7C00h&quot;, but maybe it&#039;s there. If &quot;true&quot;, you need to initialize segregs to 0. If &quot;not true&quot;, you need to initialize segregs to 7C0h. Either will work. Your bios *may* leave ds and es at 0, but this would be &quot;not true&quot; in other machines.<br /><br />I should mention that much code will run fine without these conditions being &quot;true&quot;. It is not obvious to beginners, but almost all &quot;jmp&quot; varieties, and all conditional jumps, and &quot;call&quot;, use &quot;relative addressing&quot;. We write &quot;jmp target&quot;, and it disassembles as &quot;jmp (address of target)&quot;, but if you look at the bytes actually emitted, you&#039;ll see not &quot;opcode, address of target&quot; but &quot;opcode, distance to target&quot; (distance can be plus or minus). This means that such code will run without knowing what address it&#039;s running at (&quot;position independent code&quot;). It doesn&#039;t need to know what actual address &quot;printf&quot; is at, since it knows the distance, and that&#039;s what the actual operand bytes are. As soon as you do &quot;mov si, msg&quot;, however, it must be &quot;true&quot; that ds:msg points to the correct address! Segment and offset must be &quot;synchronized&quot;.<br /><br />Whew! Now I think we&#039;re ready to discuss the code you show:<br /><br /><pre><code><br />1 main:<br />2&nbsp; &nbsp; mov ah, 00h<br />3&nbsp; &nbsp; int 16h<br />4&nbsp; &nbsp; cmp al, &quot;a&quot;<br />5&nbsp; &nbsp; je got<br />6<br />7 got:<br />8&nbsp; &nbsp; mov si, msg<br />9&nbsp; &nbsp; call printf<br />10&nbsp; &nbsp; <br />11<br />12 ; +------------+<br />13 ; | Procedures |<br />14 ; +------------+&nbsp; &nbsp; <br />15 printf:<br />16&nbsp; &nbsp; mov ah, 0eh<br />17&nbsp; &nbsp; mov bl, 07h<br />18<br />19&nbsp; &nbsp; .nextchar<br />20&nbsp; &nbsp; &nbsp;  lodsb<br />21&nbsp; &nbsp; &nbsp;  or al, al<br />22&nbsp; &nbsp; &nbsp;  jz .return<br />23&nbsp; &nbsp; &nbsp;  int 10h<br />24&nbsp; &nbsp; &nbsp;  jmp .nextchar<br />25<br />26&nbsp; &nbsp; .return<br />27&nbsp; &nbsp; &nbsp;  ret<br />28<br />29 .data<br />30 msg db &quot;Hello, World!&quot;, 0ah, 0ah<br /></code></pre><br /><br />1) IMHO, &quot;main&quot; is a horrible name for an entrypoint that isn&#039;t a real &quot;C-style main&quot; - that is, called by some other code that has done &quot;expected initialization&quot;. I&#039;m assuming this is &quot;not true&quot; here. It doesn&#039;t matter - &quot;main&quot; has no particular meaning in asm, but... you see baldr trying to guess what &quot;kind&quot; of code this is by seeing &quot;org 100h&quot; or not... seeing &quot;main&quot; is liable to give us the wrong idea. Not important, just one of my little rants. :)<br /><br />You&#039;re okay up to about &quot;line 6&quot;, I think. If al is &#039;a&#039;, you jmp to &quot;got:&quot;. Good. What happens if it&#039;s not &#039;a&#039;? Execution continues without taking the jump, and &quot;falls through&quot;...&nbsp; into &quot;got:&quot;. Probably not what you intended. The &quot;if not&quot; probably wants to jump back and get another key. I&#039;d name that label &quot;get_key:&quot; instead of &quot;main:&quot;, and &quot;jmp get_key&quot; here.<br /><br />8) We &quot;believe it is true&quot; that the text &quot;msg&quot; gets translated into the address (the offset part of the address) of our message. We can verify this by looking at a disassembly of our program. &quot;ndisasm myprog[.ext]&quot; will dump a disassembly to the screen. Okay for short programs, but you may want to pipe it into a &quot;pager&quot; - ndisasm myprog | more (you guys still haven&#039;t got &quot;less&quot;?) or redirect output into a file - ndisasm myprog&gt;myprog.dis or so... If you&#039;ve got an unseen &quot;org&quot; in your program, tell ndisasm about it - ndisasm -o 7C00h myprog, or whatever. You should see &quot;mov si, (some number)&quot; - you can identify where the message starts in a disassembly by the sudden appearance of &quot;garbage code&quot; you didn&#039;t write following(? we hope) the code you did write. If the numbers don&#039;t match, there&#039;s the problem. There are, of course, other tools capable of doing this (better?), but I &quot;believe it is true&quot; that if you&#039;ve got nasm, you&#039;ve got ndisasm...<br /><br />10) What happens after printf returns? You &quot;fall through&quot; into printf again! This time, si no longer points to &quot;msg&quot; (if it ever did), but after whatever we&#039;ve just printed (if anything - even encountering a zero would increment si - this may account for why it works &quot;second time&quot;). Also, this time, printf hasn&#039;t been &quot;call&quot;ed, so there&#039;s no return address on the stack. When you get to line 27 - ret - who knows where we go! Since you apparently get a chance to hit &#039;a&#039; again, we apparently get to &quot;get_key:&quot; (nee &quot;main:&quot;) again somehow. Perhaps by such a detoured route that it takes &quot;ten seconds&quot;? Seems unlikely, but &quot;anything can happen&quot;. You need to do something when printf returns, besides fall into it again! Maybe jump back to get_key/main, or maybe this would be a good place for the &quot;return control to OS&quot; code that baldr mentions. If you haven&#039;t got an OS, go into an infinite loop - jumping back to get_key would effectively be an infinite loop - or int 19h will restart your system.<br /><br />17) As I recall, the last video bios I tried it on didn&#039;t care what was in bl or bh - I got white text to video page zero, regardless. But bh is &quot;supposed&quot; to indicate the video page to write to. To be &quot;true&quot; for all machines, I&#039;d use &quot;mov bx, 7&quot; (or another color, if it matters) to make sure bh is set to video page zero (if it matters).<br /><br />20) lodsb loads al from  (and increments si). At this point, we &quot;believe it is true&quot; that ds:si points to our message. Both ds and si need to be &quot;right&quot;. If this is &quot;not true&quot;, the problem &quot;appears&quot; at this point, but was actually &quot;caused&quot; by far-away code where we told Nasm the correct &quot;org&quot; and initialized segregs... or didn&#039;t.<br /><br />29) This does nothing. There are macro files that can be &quot;%include&quot;d that would turn &quot;.code&quot; and &quot;.data&quot; into &quot;section .text&quot; and &quot;section .data&quot;, but I don&#039;t &quot;believe it is true&quot; that you&#039;re using them. Without it, it&#039;s just an unused label. Without a colon, Nasm may complain about it (also lines 19 and 26), but it does no harm.<br /><br />30) Did you really mean &quot;0ah, 0ah&quot; or &quot;0dh, 0ah&quot;. Doesn&#039;t matter, I guess.<br /><br />One more very minor point: way back at line 2. Strictly speaking, 0 is an &quot;old&quot; int 16h function - intended for the AT (80 key?) keyboard. There are a few key combinations on a modern keyboard that it won&#039;t pick up. I was trying to write a &quot;draw&quot; program, and was using &quot;control-up-arrow&quot; (etc.) to &quot;jump 10 pixels&quot;. Worked for control-up, but not for control-down (or the opposite). Drove me crazy trying to figure out what I&#039;d done wrong! The &quot;new&quot; interrupt for the XT (88 key?) keyboard is &quot;mov ah, 10h&quot;. That fixed it. It&#039;ll be a long time before you notice the difference, but I thought I&#039;d mention it...<br /><br />I strongly suspect the reason you&#039;re not seeing the expected output is that ds or si (or both) don&#039;t have the correct values, but you want to fix the &quot;flow&quot; for &quot;if not &#039;al&#039;&quot; and after the return from printf, too. Then it should work... if everything I believe is true is actually true. :)<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2010-06-07 09:06:23 by fbkotler</div>
   </div>
   <div class="post" id="post-211988">
    <div class="subject"><a href="#post-211988">Re: If Function Using Nasm</a></div>
    <div class="body"><strong>Homer</strong>,<br /><br />I understand, but why? This kinda looks like if I come to a car repair workshop and say: &quot;My car has problems with steering and brakes. I brought the steering wheel and the pedal. Can you fix it?&quot;</div>
    <div class="meta">Posted on 2010-06-07 12:31:33 by baldr</div>
   </div>
  </div>
 </body>
</html>