<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>The Asm_CGI Tutorial - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=6745" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=6745">The Asm_CGI Tutorial</a></p>
   <div class="post" id="post-48742">
    <div class="subject"><a href="#post-48742">The Asm_CGI Tutorial</a></div>
    <div class="body">Finally, FAsm has a home at Win32ASM :)<br /><br />Here is the column I wrote for AJP and the CGI Payload<br /><br />The zip file contains this article, and 5 example codes.<br /><br /><br /><pre><code><br />&#58;&#58;/ \&#58;&#58;&#58;&#58;&#58;&#58;.<br />&#58;/___\&#58;&#58;&#58;&#58;&#58;&#58;&#58;.<br />/|    \&#58;&#58;&#58;&#58;&#58;&#58;&#58;&#58;.<br />&#58;|   _/\&#58;&#58;&#58;&#58;&#58;&#58;&#58;&#58;&#58;.<br />&#58;| _|\  \&#58;&#58;&#58;&#58;&#58;&#58;&#58;&#58;&#58;&#58;.<br />&#58;&#58;&#58;\_____\&#58;&#58;&#58;&#58;&#58;&#58;&#58;&#58;&#58;&#58;&#58;...........................................FEATURE.ARTICLE<br />08/23/2001                       Common Gateway Interface using PE console apps<br />05&#58;05&#58;05 AM PST                                          by Michael Pruitt<br />                                                         &#91;email&#93;eet_1024@hotmail.com&#91;/email&#93;<br /><br /><br />CGI&#58; Tutorial 01&#58; Supplying Dynamic Data to a Web Client<br />--------------------------------------------------------<br />In the early '90s the NCSA released HTTPd 1.0 &#40;a web server&#41;, a new concept<br />was included; CGI.  This feature allowed web content to be dynamically gener-<br />ated on the server.  Up-to-date reports of stocks, scores, and weather were<br />possible with CGI.  Other uses include message boards, guest books, or<br />e-stores.<br /><br /><br />Typically a CGI application will interface with a Mosaic type web browser;<br />supplying HTML with the data.  When the server recieves a request targeting a<br />CGI program, it will lauch the application.  Any data from the client will be<br />piped to StdIn.  The app's StdOut will then be sent back to the client.<br /><br /><br />Tools Needed<br />------------<br />This tutorial is written for FAsm &#40;&#91;url&#93;http&#58;//omega.im.uj.edu.pl/~grysztar/&#91;/url&#93;&#41;. If<br />you wish to assemble the program, you will need FAsm 1.13.4 &#40;or later&#41; or you<br />can translate it to an assembler supporting 80x86 PE console.<br /><br />For any CGI testing access to a web server is a must. I recommend Apache 1.3.20<br />&#40;&#91;url&#93;http&#58;//httpd.apache.org/&#91;/url&#93;&#41;. For starting out, you can place your assembled<br />executable into the \Apache\cgi-bin\ directory. For the server name use<br />&quot;localhost&quot; &#40;excluding the quotes&#41;.<br /><br />Knowledge of HTML &#40;HyperText Markup Language&#41; is usefull. The basics of HTML<br />are easy to learn. CSS &#40;Cascading Style Sheets&#41; will prove invaluable if you<br />use a lot of HTML. A list of books is provided at the end of this article.<br /><br />A Win32 platform. My system consist of Win 98 SE on a Celeron 433 w/ 128MB RAM.<br />Win 95 - NT should work without issues. A Linux box running WINE shoud also<br />work for those with a strong stomach.<br /><br />Win32 API<br />---------<br />Since everything a CGI application does is non GUI, the kernal32.dll will<br />suffice for most projects.  Database intensive app's will link to other dll's<br />to better implement designs.<br /><br />To access the Standard I/O, will need to use GetStdHandle.  Under Win32, StdIO<br />is not availiable under predefined handles.  ReadFile and WriteFile is used to<br />move data.  ReadConsole and WriteConsole will not work; file redirection in not<br />availiable.<br /><br /><br />CGI Environment<br />---------------<br />A CGI program is not required to read data, but it is required to send it.<br />Client data is availiable on the StdIn. The length is in the CONTENT_LENGTH<br />environment variable.  Also, 255 bytes of the data is in the QUERY_STRING<br />EnvVar.  All out put must start with &quot;Content-Type&#58;&quot; a space, the type, and<br />two newlines &#40;CrLf&#41;.  Common types include&#58; &quot;text/plain&quot;, &quot;text/html&quot;, or<br />&quot;image/gif&quot;. Example output&#58;<br /><br />      Content-Type&#58; text/plain<br /><br />      Hello World. Example of HTTP 1.1 header and body.<br /><br />If you don't write any data, the web server will report with the error&#58;<br />&quot;Premature end of script headers&quot;.  If you really don't want to supply data,<br />you could just write&#58; &quot;Content-Type&#58; text/plain&quot; and two newlines.<br /><br /><br />The Example Program<br />-------------------<br />The program I've supplied writes HTML containing the current date and time.  It<br />demonstrates use of API's, HTML, data manipulation.<br /><br /><br />~~~~~~~~~~~~~~~~~~~|||-------------------&#91;_code&#93;-------------------|||<br />format PE console<br />entry Start<br /><br />include '\Asm_Win32\Include\_Kernel.inc'<br />include '\Asm_Win32\Include\macro\stdcall.inc'<br />include '\Asm_Win32\Include\macro\import.inc'<br /><br />   Cr    = 0x0D<br />   Lf    = 0x0A<br />;***---------------------------------------------------------------***<br />section '.code' code readable executable<br />Start&#58;<br />    pusha                                        ;Save all of the Registers<br />    stdcall &#91;GetStdHandle&#93;, STD_OUTPUT_HANDLE    ;Retrive the actual handle<br />    mov     &#91;StdOut&#93;, eax<br />    cmp     eax, INVALID_HANDLE_VALUE            ;Error with handle<br />    jz      Exit<br /><br />Get_Time&#58;<br />    stdcall &#91;GetSystemTime&#93;, Time                ;Load SYSTEMTIME with UTC<br />    call    Format_Time                          ;Convert Hex&#40;bin&#41; to ascii<br />                                                 ; and Place into HTML<br />Write&#58;<br />    stdcall &#91;WriteFile&#93;, &#91;StdOut&#93;, HTML, HTML._size, HTML.Len, 0<br />                                                 ;Write the HTML to StdOut<br />Exit&#58;<br />    popa                                         ;Restore all of the Registers<br />    stdcall &#91;ExitProcess&#93;, 0<br /><br />;***-------------------------&#91;Subroutine&#93;--------------------------***<br />Format_Time&#58;<br />    mov     ax, &#91;Time.wYear&#93;                     ;16b Data<br />    mov     edi, HTML.Date_S + 9                 ;Ptr to LAST byte of dest<br />    call    .ascii                               ;Convert and place into HTML<br /><br />    mov     ax, &#91;Time.wDay&#93;<br />    mov     edi, HTML.Date_S + 4<br />    call    .ascii<br /><br />    mov     ax, &#91;Time.wMonth&#93;<br />    mov     edi, HTML.Date_S + 1<br />    call    .ascii<br /><br />    mov     edi, HTML.Day_S                      ;Destination Ptr<br />    mov     esi, Day.Wk                          ;Source Ptr &#40;Array of Days&#41;<br />    xor     eax, eax<br />    mov     ax, &#91;Time.wDayOfWeek&#93;                ;0 &lt;= eax &lt; 7<br />    add     esi, eax                             ;esi =+ eax * 3<br />    add     esi, eax                             ; Indexes the Array<br />    add     esi, eax<br />    mov     ecx, 3                               ;3B per Day String<br />    cld                                          ;Copy Left to Right<br />    rep                                          ;    &#40;esi++, edi++&#41;<br />    movsb<br /><br />    mov     ax, &#91;Time.wHour&#93;<br />    cmp     al, 13                               ;Check for PM<br />    jl      .wHour<br />    sub     al, 12                               ;Correct Hour<br />    mov     &#91;HTML.Time_S + 9&#93;, 'P'               ; AM -&gt; PM<br /><br />.wHour&#58;<br />    mov     edi, HTML.Time_S + 1<br />    call    .ascii<br /><br />    mov     ax, &#91;Time.wMinute&#93;<br />    mov     edi, HTML.Time_S + 4<br />    call    .ascii<br /><br />    mov     ax, &#91;Time.wSecond&#93;<br />    mov     edi, HTML.Time_S + 7<br />    call    .ascii<br />    ret<br /><br />;***&#91;Hex 2 ASCII&#93;***<br /> .ascii&#58;<br />    std                                          ;String OPs Right to Left<br />    cmp     ax, 10                               ;Single Digit?<br />    jl      .onex10<br /><br />    and     ah, ah                               ;Only Two Digits<br />    jz      .twox16<br /><br />    mov     bh, 10                               ;Reduce 3x16 to 2x16<br />    div     bh                                   ;  so that AAM can be used<br />    or      ah, 0x30                             ;BCD -&gt; ASCII<br />    mov     &#91;edi&#93;, ah<br />    dec     edi<br /> .twox16&#58;<br />    aam                                          ; AH / 10 = AH r AL<br />    or      al, 0x30                             ;BCD -&gt; ASCII<br />    stosb<br />    mov     al, ah<br />    cmp     ah, 9<br />    jg      .twox16<br /> .onex10&#58;<br />    or      al, 0x30<br />    stosb                                        ;Copy Last/Only Digit to Mem<br />    ret<br /><br />;***--------------------&#91;Data used by this App&#93;--------------------***<br />section '.data' data readable writeable<br />  StdIn         dd 0                             ;Standard I/O Handles<br />  StdOut        dd 0<br /><br />HTML&#58;<br />db 'Content-type&#58; text/html', Cr, Lf, Cr, Lf<br />db '&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello World&lt;/title&gt;&lt;/head&gt;', Cr, Lf<br />db '&lt;body bgcolor=Black text=Cyan&gt;&lt;h1&gt;Hello World&lt;/h1&gt;', Cr, Lf<br />db '&lt;h2&gt;&lt;font color=Lime&gt;', Cr, Lf<br />db 'This HTML is dynamicly generated by a PE console Application writen in'<br />db '80x86 Assembler&lt;/font&gt;&lt;/h2&gt;', Cr, Lf<br />db '&lt;h2&gt;&lt;font color=Red&gt;It is&#58; &lt;/font&gt;&lt;font color=Blue&gt;'<br />   .Day_S       db 'WkD '<br />   .Date_S      db ' 0/00/0000&lt;/font&gt; &lt;font color=Magenta&gt;'<br />   .Time_S      db ' 0&#58;00&#58;00 AM&lt;/font&gt; &lt;font color=Lime&gt;UTC&lt;/font&gt;&lt;/h2&gt;', Cr, Lf<br />                db '&lt;/body&gt;&lt;/html&gt;', Cr, Lf<br />HTML._size     = $ - HTML - 1<br />HTML.Len        dd 0                             ;Number of bytes actually wrote<br /><br />  Time          SYSTEMTIME<br />  Day.Wk        db 'SunMonTueWedThuFriSat'<br /><br />;***----------------------&#91;Import Table / IAT&#93;---------------------***<br />section '.idata' import data readable writeable<br /><br />library     kernel,             'KERNEL32.DLL'<br /><br />kernel&#58;<br />  import    GetModuleHandle,    'GetModuleHandleA',\<br />            GetCommandLine,     'GetCommandLineA',\<br />            GetSystemTime,      'GetSystemTime',\<br />            GetEnvVar,          'GetEnvironmentVariableA',\<br />            GetStdHandle,       'GetStdHandle',\<br />            CreateFile,         'CreateFileA',\<br />            ReadFile,           'ReadFile',\<br />            WriteFile,          'WriteFile',\<br />            CloseHandle,        'CloseHandle',\<br />            ExitProcess,        'ExitProcess'<br />__________________|||-------------------&#91;/_code&#93;-------------------|||<br /><br /><br /><br />How to Run&#58;<br />-----------<br />You can run this example from the command line since it requires no client<br />data.  You can also pipe the data into an html doc and open with IE&#58;<br />   Main &gt; Text.html<br />For the real CGI, place Main.exe into the cgi-bin directory, launch Apache,<br />and type &quot;localhost/cgi-bin/Main.exe&quot; in the address box of IE.<br /><br />References&#58;<br />-----------<br />   SAMS Teach Yourself CGI in 24 Hours<br />         SAMS 2000                        $24.99US<br />         Rafe Colburn                     ISBN&#58; 0-672-31880-6<br /><br />   CGI by Example<br />         QUE 1996                         $34.99US<br />         Robert Niles &amp; Jeffry Dwight     ISBN&#58; 0-7897-0877-9<br /><br />   HTML in Plain English - 2nd Edition<br />         MIS Press 1998                   $19.95US<br />         Sandra E. Eddy                   ISBN&#58; 1-55828-587-3<br /><br />   Cascading Sytle Sheets - The Definitive Guide<br />         O'Reilly 2000                    $34.95US<br />         Eric A. Meyer                    ISBN&#58; 1-56592-622-6<br /><br />   Win32 Programming Reference &#40;Win32 API Help file&#41;<br />         Microsoft 1990-1995              Free<br />         &#91;url&#93;http&#58;//win32asm.rxsp.com/files/win32api.zip&#91;/url&#93;<br /></code></pre></div>
    <div class="meta">Posted on 2002-07-19 02:12:07 by eet_1024</div>
   </div>
   <div class="post" id="post-48745">
    <div class="subject"><a href="#post-48745">The Asm_CGI Tutorial</a></div>
    <div class="body">Nice!<br /><br />Thanks for sharing! :alright:</div>
    <div class="meta">Posted on 2002-07-19 02:40:26 by bazik</div>
   </div>
   <div class="post" id="post-48750">
    <div class="subject"><a href="#post-48750">The Asm_CGI Tutorial</a></div>
    <div class="body">No problem. Just wish I had the time to improve it.<br /><br />When I finish a utility at work ( If I ever get the time there too) I'll ask if I can release parts of that code ( has static RegEx, dynamic Arrays and Hashs of strings )</div>
    <div class="meta">Posted on 2002-07-19 03:11:48 by eet_1024</div>
   </div>
   <div class="post" id="post-48755">
    <div class="subject"><a href="#post-48755">wow...</a></div>
    <div class="body">That example alone makes me want to use FASM.<br />Looks reather kewl.<br /><br />Regs,</div>
    <div class="meta">Posted on 2002-07-19 03:36:35 by James_Ladd</div>
   </div>
  </div>
 </body>
</html>