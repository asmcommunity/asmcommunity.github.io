<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>P T R - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=5612" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=5612">P T R</a></p>
   <div class="post" id="post-39960">
    <div class="subject"><a href="#post-39960">P T R</a></div>
    <div class="body">Many moon ago in a getto far far away back when i converted from Delphi and founded masm32 i read some information on protecting an executive from cracker and something has always stucked with me.  That hard drive crash a long time ago so i don't know if it was Bill of USA, Hutch, Icz or a link from one of them who said this.<br /><br /><strong>&quot; The best thing anyone can do for an executive is to write an well organized .data? section and avoid using PTR's&quot;.</strong> <br /><br />Do anyone have any ideas on the PTR story because i found a block of code by Qages to zeroes out a range of memory that works perfectly on 95B and may work on all Windows version because it is 100% ASM code.  <br /><br />I don't want to give it up just because of the PTR thing.<br /><br />So could someone explain to me where the hole is or whatever, and how to fight it if it is there, if it is even possible.<br /><br /><strong>Qages </strong> Coding Style:<br /><br />&quot;why dont you try this&quot; <br /><br />cleanbuff proc <br />mov eax, offset logfont <br />xor ebx,ebx <br />mov BYTE PTR ,0 <br />@@: <br />inc ebx <br />mov BYTE PTR ,0 <br />cmp ebx,SIZEOF LOGFONT <br />jne @B <br />ret <br />cleanbuff endp<br /><br />PS: <span style="font-size:9px>Thanks bdjames for the reply at the opcode that zeroes a range of memory post... I am trying to stick with the *traditional registers* and want my program to work will all processor and Window versions. <br /><br />If i move up to the Pentium than i would really have it made.... but i really want to stick to *traditional registers* so when anything come out new in the future i be able to convert code much easier. It might not be the fastest but it will be efficient.</span></div>
    <div class="meta">Posted on 2002-05-25 14:12:22 by cmax</div>
   </div>
   <div class="post" id="post-39962">
    <div class="subject"><a href="#post-39962">P T R</a></div>
    <div class="body">There is no reason not to:<pre><code>cleanbuff proc<br />  xor eax,eax<br />  mov edi, offset logfont<br />  mov ecx,SIZEOF LOGFONT<br />  rep stosb<br />  ret<br />cleanbuff endp</code></pre>You <u>have to use</u> <strong>PTR</strong> because your moving an immediate value to memory - MASM doesn't know what you want - you have to tell it BYTE PTR, or use a byte register, or use a memory location that is defined as a BYTE, or use ASSUME EAX:PTR BYTE.  Somewhere you have to say, &quot;MASM this is a byte value.&quot;</div>
    <div class="meta">Posted on 2002-05-25 14:22:27 by bitRAKE</div>
   </div>
   <div class="post" id="post-39975">
    <div class="subject"><a href="#post-39975">P T R</a></div>
    <div class="body">Thanks bitRAKE,<br /><br />You posted an reply to someone question a few days ago about zeroMem and if this is the same code, i tried it and it did not wipe out the whole line in memory as Qages dose. I will try it again and see what i was doing wrong with-in a few hours this evening for sure.<br /><br /><span style="font-size:9px>I still like to know what he mean about not using PTR any why.  I am going to use it for something anyway but if it is true i just use it for centain things that i don't care about.  ( No easy way to to get to my code from string pointer ) ...I reather at lease give em a hard way to go at the very lease...</span></div>
    <div class="meta">Posted on 2002-05-25 16:20:26 by cmax</div>
   </div>
   <div class="post" id="post-39994">
    <div class="subject"><a href="#post-39994">P T R</a></div>
    <div class="body">not using ptr doesnt mean any thing, that isnt a way to protect from crackers/hackers becuase ... i really dont want to say this becuse of rules and its illegal, but i ...m mmm i modify things in other words i am a (r4xx0r; i only use my skillz to debug my progs, i say this only to help you protect your programs. you should pack your program with a less &quot;known&quot; exe/dll packer. in code dont referance any strings, code by bytes. use stack as much as possable becuase the stack pointer usualy changes every timme you start up ur prog. dont use the .data section. put a lot of junk code if needed to throw them off.</div>
    <div class="meta">Posted on 2002-05-25 18:50:31 by Qages</div>
   </div>
   <div class="post" id="post-39995">
    <div class="subject"><a href="#post-39995">P T R</a></div>
    <div class="body"><strong>bitRAKE,<br /><br />It Works, </strong> <br /><br />My mistake yesterday when i tried it was i was removing a 8 BYTE string and i declared 12 BYTE and it remove part of another string....<br /><br />So, this code has not really declared PTR up-front in the code, am im right....<br /><br />Please allow me to ask this question....<br /><br />bitRAKE,<br />i got an idea about how to keep Macro's from the so-call EXPANDING your Executive doing runtime......... <br /><br />OK, Macros are best to be used doing execution of your program and not to be used too much as your program is running because it EXPAND the SIZE of your program in Memory or something.<br /><br />I read your post about Macro and you laid the law down about what it really do.  You said it is a simple cut and paste operation.  So that lead me to thinking that this is what cause your Executive to EXPAND in the first place,,,,, am im right...<br /><br />So with Hutch new stamp of approval about using macros and If my new founded understanding is correct, <strong>How About This...</strong> <br /><br />At anytime doing while the user is running your program, clicking buttons or whatever that run Macros CODES doing that Procedure ...... After that MACRO has finish it job....Use your *True supper small pure ASM ZeroMemory* to Delete it out of Memory.... The so called Macro Expansion is now Out of Here.....Hey...Hey...Hey one less API gone with a big PLUS.<br /><br />What do you think... If i am right i am on my way to <strong>bitRAKE Heaven...</strong></div>
    <div class="meta">Posted on 2002-05-25 18:51:52 by cmax</div>
   </div>
   <div class="post" id="post-39999">
    <div class="subject"><a href="#post-39999">P T R</a></div>
    <div class="body"><strong>Qages </strong> <br /><br />Your code lead me to seeing what is really happing in mem for sure and i will never forget that.  but bitRAKE surely  have cut the code size down to nearly nothing.<br /><br />If this is true i got another piece of code produced by JimmyClif that will cut my executive nearly in half ... I am sure you are right but can you tell me one MO time that you know nearly for sure ....<br /><br />PTR is ALL Good in Code... One More Yes or No will Do me Fine.<br /><br />And one more thing, my exe is big because i don't use to many proc so it is in-line and supper fast....Now suppose i break down and start using proc and do 10 calls from one button click, will i loss speed and/or security because of it... if not I Will Go There for GOOD. (keep in mind that a few hundred milisecond extra will not be a major problem for me.)<br /><br /><br />Thanks Qages<br /><br />and Thanks again for those great tips, i see can what you mean...</div>
    <div class="meta">Posted on 2002-05-25 19:15:58 by cmax</div>
   </div>
   <div class="post" id="post-40000">
    <div class="subject"><a href="#post-40000">P T R</a></div>
    <div class="body">im pretty sure rep stosb is slower then a jmp one, but dont use it on large strings i know that for sure.<br />also you dont want self contained code, like if ur using that buffer clearer 5 times in yer exe, if the hacker/cracker needs to modify somtin in it,it wont effect the others, however, if its in a proc called 5 times, it will effect all 5, hackers/crackers dont want that.<br />but if speed is better then security, thats ur prerogative.<br />100th post</div>
    <div class="meta">Posted on 2002-05-25 19:33:52 by Qages</div>
   </div>
   <div class="post" id="post-40001">
    <div class="subject"><a href="#post-40001">P T R</a></div>
    <div class="body">rep movsX<br /><br />is 3+n which I can not beat, the best is<br />m+2*n</div>
    <div class="meta">Posted on 2002-05-25 19:56:17 by bdjames</div>
   </div>
   <div class="post" id="post-40023">
    <div class="subject"><a href="#post-40023">P T R</a></div>
    <div class="body"><strong>cmax</strong>, you are learning at a good pace, but what you state can not be with MASM macros - macros are expanded at assemble-time, not at run-time.</div>
    <div class="meta">Posted on 2002-05-26 00:24:57 by bitRAKE</div>
   </div>
   <div class="post" id="post-40029">
    <div class="subject"><a href="#post-40029">P T R</a></div>
    <div class="body">I don't think i am wording things the right way... Give me some time to get my disk organized and i will post or send you the info that lead me to this understanding.  These people are not rookie, but maybe i mis-understood what they were saying. <br /><br />I will have it all line up by or before Tuesday....Believe me searching my hard drive is like searching *5* Win32ASM Community messageboards.  I down loaded everything that i ever saw...It will be a good thing for me to do over this weekend... I will start the minute i wake up... I got to get to the bottom of this because i see the light about the use of marcos. I read the post about API and Macro replacements for some of them...Lest API has always been my goal, that's why i came to ASM anyway.<br /><br />Thanks bitRAKE</div>
    <div class="meta">Posted on 2002-05-26 03:35:47 by cmax</div>
   </div>
   <div class="post" id="post-40237">
    <div class="subject"><a href="#post-40237">P T R</a></div>
    <div class="body"><strong>Hello bitRAKE</strong> <br /><br />This in one more was the tute i founded awhile back about macros, You may have read it already   but this is where i skim through and got some of my ideas about macros usage.  It's may be worth re-reading anyway.<br /><br />Written by Philippe Auphelle<br />Reformatted from TXT to HTML by Stefan Krause Homepage<br /><br />About Macros Go to: <a target="_blank" href="http://win32asmnewbies.cjb.net/">http://win32asmnewbies.cjb.net/</a> and get the win32asm_guide.zip in chapter3.html and chapter5.html he talk seriously about Marco and maybe in other chapters to.<br />...............................................................................................<br />I can't find the 2nd Tutor that got my attention awhile back, but the minute i find it i will let you know.  I will have to stumble across it as i usually do thing, that's the way things comes up for me.<br /><br />In that 2nd Tutor all he was saying is : Bottom line is only at the time when you double click the your executive icon,, at that time while executing than loading it this is the best time that Macros codes to be used.....Once the program has been loaded into Memory,  (DON'T USE ANY MORE MACROS)<br /><br />Now the program is running for the rest of the day or even forever so now is the time not to have Marcos being used through-out using the already running program because Macro will now began to really expand the program in memory or something....<br /><br />Basically this is what he was saying but i really don't know.<br /><br />That's why i said maybe there is a way to do some kind of clean-up after any additional Marcos being used while the program is in operation ( just an idea, may not even be possible because nothing may be there anyway ) i don't know.  But i know you and your Marcos got the power i need to replace a few more API that i don't want to use anymore, so i will be studying how to defeat this problem if it is at all possible.<br /><br /><br /><strong>PS: </strong> I think that is <strong>bit7</strong> Website <br />.................................................<br />.................................................<br /><br /><strong>Qage,</strong> <br /><br />You were more right than you know....<br /><br />I always start out with 96% System Memory ( i always check in with the control panel, system, performance tab to keep an eye on everything i use up.  I am building for someone else machine so i keep track very well ) <br /><br />I just finished my trial hook to run with my app, all the code is inside the app in-line like a monster.... After a 15 minutes or so i only got 45% of System Memory...Windows is really to die.<br /><br />So i took your advice that many said since i got the masm32 v5... but i wanted to do it MY WAY....not so cleaver of me but it paid off to see all of this happen.... <br /><br />I broke all the code up into procedure as they should have been..........<br />UNBELIEVABLE...... 1 GOT 88% of System Memory no mater what i do while doing things with the program....and when it get intensive it goes down to 72% ( i got to fix my dll to beat this one ) But the best thing of it all is when i shut the program  it down it goes back to 95% All System Memory Restored .....BIG TIME..i got to pat myself on the back, M32.lib and the Win32 Community taught me well....I am taking 98kb Program on this one...That's a lot of ASM code to be lined up perfectly and using a Icz MouseHook Style Dll to boot .... And believe me it do a whole lot of stuff all day long, you'll see.<br /><br />Run WordPerfect, IE, or even some Simple Window Folders, you find it will hold up 4 to 8kb of memory even after closing.. Running through them for a a minute or two than shut them all down you be left with only 88% ... They never re-least all the System Memory.<br /><br /><strong>I Belieive the secret in using CALLs is that the OS release the presure or something..Freeing Memory used after each call .... it's really worth it...</strong> <br /><br />I don't like ASM anymoreeee ...  <strong>I LOVE it</strong><br /><br /><strong>Thanks for </strong> Telling it Like it is <strong>Qage,</strong><br /><br /><br /><span style="font-size:9px>PS: i still got a lot of dumb stuff to fix but with JimmyClif code i will shave off at lease 35% in size now that i am not afraid of the PTR thing... I keep your ZeroMem in because it just look good :) Really because of what you said about the jmp compared to stoSB..... I used the hook just as an notification of when certain programs and widows are opened, so if i can get rid of the mouse movement thing or something that dll will have no bearing on the system what so ever i beleive.. All of those messages should not be continuously running just to be notified of these few things....</span></div>
    <div class="meta">Posted on 2002-05-27 15:35:38 by cmax</div>
   </div>
   <div class="post" id="post-40241">
    <div class="subject"><a href="#post-40241">&quot;in code dont reference any strings, code by bytes&quot</a></div>
    <div class="body">One more thing Qage, what do you mean by this.  Could you put together 3 lines or two pieces of code and point to what you mean... I don't really know things by technical definitions.  I usually play it by ear but i don't understand and i don't want to make any more mistaking thinking what it mean is what i come up with.  Look what happen to me already.  Scare of PTR<br /><br /><br /><br />The only idea i got is:<br /><br />mov esi, Buffer1 ........ do this mean not referencing<br />mov edi, Buffer99<br />mov ecx, 24 .............. <br /><br />if buffer1 has 24 letters in it would this way be consided coding by bytes and instead of using SIZEOF....<br /><br />Thanks again</div>
    <div class="meta">Posted on 2002-05-27 16:29:52 by cmax</div>
   </div>
   <div class="post" id="post-40242">
    <div class="subject"><a href="#post-40242">P T R</a></div>
    <div class="body">First, repeat after me: executable, not executive :). <br /><br />Now, what's with the &quot;ptr&quot; stuff? Do you mean the &quot;ptr&quot; override<br />in masm, or the use of pointers? No reason to avoid either, really.<br />Whether you're using static or dynamic buffers, whether they are<br />global (.data, heap, whatever) or local (stack), you still have<br />to take care that buffer overflows will not be possible. In many<br />situations dynamic buffers have the advantage of wasting less<br />memory (allocate and discard as needed). Furthermore, memory locations<br />with dynamic buffers wont be as fixed, so it'll be a bit harder <br />for a cracker to trace consecutive runs.<br /><br />Macros are expanded assemble-time, and are only expanded once (or<br />rather, expanded where they are put - which can of course be<br />multiple places). As for macros taking up more space than procs,<br />well, that's what you get when inlining (except in a few cases<br />where there's more overhead of pushes+call than the actual inlined code).<br /><br />As for inlining and the speed, I wouldn't really worry when dealing<br />with GUI code, and in fact not with most API calls. You're going to<br />be bound to the speed of the windows routines, which is usually slow<br />enough that 'optimizing' your gui for speed is a waste of time and space.<br /><br />As for memory usage... there's a lot of stuff going on in windows. You<br />can't necessarily contribute the &quot;lesser available memory&quot; with leaks,<br />as the cache subsystem also takes fair chunks of your memory. Remember<br />that unused memory is wasted memory - while 88% free ram sounds nice,<br />I'd prefer to have 42% free, have a lot of re-usable files in the cache<br />subsystem, and know that the cache can be discarded if memory is required<br />elsewhere. Of course if memory usage goes down and down and down and<br />down while your app is running, a leak is very likely ;).<br /><br />Most resources are reclaimed after apps terminate, however some of this<br />is done 'lazily' when windows feels there's enough idle-time to do it.<br />Other resources, especially GDI on the cruddy 9x systems, will not always<br />be cleaned up if you don't do cleanup yourself, and leaks can end up fatal<br />(BSOD because a GUI resource is low? Gimme a break...)<br /><br />You need more detailed monitoring tools than eg taskman, it's only good<br />for a very rough overview to give a hint if something is terribly wrong...<br />or if you're bored and need to look at something that moves.<br /><br />Now, what's up with the mousehook? Are you doing it just to avoid the<br />WM_MOUSE* messages, or does your app *require* the hook? If it's just<br />to get rid of the messages, this is not good - it'll end up eating more<br />resources than having WM_MOUSE* processing, take longer (since your code<br />must process events for other applications as well), etc.</div>
    <div class="meta">Posted on 2002-05-27 16:45:03 by f0dder</div>
   </div>
   <div class="post" id="post-40265">
    <div class="subject"><a href="#post-40265">&quot;executable&quot;, cool</a></div>
    <div class="body"><strong>Hey f0dder</strong>,<br /><br />I think i am bad now f0dder, I know where everything is at and what it do any how it do it. I figured.....ABOUT TIME.<br /><br />If  anyone got an app running with the help of an dll at certain time an it is running as many line of code as i did ( OVER 8000 lines of ASM code ) on an Icz MHook.dll and all the Memory is TOTALLY, I mean TOTALLY RELEASED at shut down time....What more can you ask FOR.... Nothing but D**e good coding can do THAT.., I learned well from you guys as far as that much goes...<br /><br />I wrote my app near completed 2 ? years ago in Delphi.  The reason i came to ASM is because i did not want the extra help that Delphi had handed down to me for my app. Extra Junk...<br /><br />So Just like Delphi, i don't want any help from any OS other than what i call for.  So that bring me to another question that Maverick was once concerned about ...........<br /><br /><strong>How do i Flush the CACHE  </strong> for my *executable information ONLY and anything else MAYBE*.  When the user shut down my app i don't want to leave *nothing*  not even it NAME  behind in Windows or the Processor as it Should BE.  I have no problem coming back in lighting SPEED as it is with MY ASM :)  <span style="font-size:9px>i told you cmax bad</span> <br /><br />I will e-mail you some info about a Delphi source code dll that i  am trying to convert to ASM soon, and that is more than a  promise.<br /><br />Thank f0dder</div>
    <div class="meta">Posted on 2002-05-27 23:41:56 by cmax</div>
   </div>
   <div class="post" id="post-40267">
    <div class="subject"><a href="#post-40267">P T R</a></div>
    <div class="body"><strong>cmax</strong>, I would just like to say that you always sound very enthusiastic and postive about programming - I think you have a great outlook on life and keep an open mind.  You have got to be one of the best newbies around here.  Your eagerness is appearant and your always very respectful of those trying to help.<br />It is good having you here. :alright:</div>
    <div class="meta">Posted on 2002-05-28 00:16:57 by bitRAKE</div>
   </div>
   <div class="post" id="post-40268">
    <div class="subject"><a href="#post-40268">P T R</a></div>
    <div class="body">I think any self respectable application need to free all the used memory before exit. It it doesn't, I call it a bug.<br />I also think you got the wrong understanding about macros. They are expanded at assemble time and they don't exist in the exe-file in any form. You seem very interested about programming though!</div>
    <div class="meta">Posted on 2002-05-28 00:35:07 by gliptic</div>
   </div>
   <div class="post" id="post-40293">
    <div class="subject"><a href="#post-40293">P T R</a></div>
    <div class="body">Let's look at the mousehook example again. This is still assuming<br />you're only using it to avoid WM_MOUSE* messages, if you *do* need<br />to intercept mouse messages sent to other programs, you have a valid<br />reason for a mousehook. Now, what are the bad things then? First, a<br />hook dll will use more memory than handling windows messages (since<br />you need additional PE headers, imports, . . .) Next, hook code must<br />be visible to all processes (since it receives messages meant for all<br />processes), which at best means extra page table entries. If you have<br />read/write data in the hook DLL, you'll also have copy-on-write, which<br />is additional memory overhead. Also, your hook will be processing<br />messages for all processes, instead of just your own, which means<br />wasted CPU time. <br /><br /><div class="quote"><br />How do i Flush the CACHE for my *executable information ONLY and<br />anything else MAYBE*. When the user shut down my app i don't want<br />to leave *nothing* not even it NAME behind in Windows or the Processor<br />as it Should BE.<br /></div><br />Well, that isn't as it should be :). The disk cache subsystem is<br />there for a reason. While &quot;cleaning all traces of yourself&quot; might<br />have a &quot;neatness factor&quot;, the practical value is nil, and it would<br />be working against the system. Imo it's better to work *with* the<br />system to get the best performance you can.<br /><br />Also, don't confuse processor and filesystem cache. Processor cache<br />should lose whatever information about your applications rather quickly<br />after it has terminated, as processor cache is a very limited and<br />&quot;local&quot; resource. Filesystem cache... don't worry about this. I'd<br />personally be rather pissed if apps of &quot;considerable size&quot; decided<br />to flush the filesystem cache after they terminate. Yes, I do have the<br />habit of shutting down msdev or photoshop or &lt;whatever&gt; only to open<br />it again a few minutes later - having the app in the FS cache is a<br />really neat thing then.</div>
    <div class="meta">Posted on 2002-05-28 05:13:07 by f0dder</div>
   </div>
   <div class="post" id="post-40294">
    <div class="subject"><a href="#post-40294">P T R</a></div>
    <div class="body">gliptic: Even though it isn't strictly necessary (NT is pretty good at<br />cleaning up most resources itself), I think you're right - an application<br />ought to free any resources it has allocated itself. Cleaner programming<br />imo. But it shouldn't mess with OS-managed resources such as<br />filesystem cache.</div>
    <div class="meta">Posted on 2002-05-28 05:15:08 by f0dder</div>
   </div>
   <div class="post" id="post-40316">
    <div class="subject"><a href="#post-40316">P T R</a></div>
    <div class="body">cmax,<br /><br />Lets try to make sense of you view of what macros are. A number of the guys here have told you what they do but I guess youy did not connect what they have said.<br /><br />A MACRO is run &quot;BEFORE&quot; the code is assembled, once it IS expanded, its ONLY asm code. MACROs are often called PRE-processors because they process parts of the code BEFORE it is assembled.<br /><br />The program that does the assembly also has the MACRO capacity inside it and when it first runs, it reads the MACROs first and expands them up into assembler code which is then assembled into normal binary code.<br /><br />In order,<br /><br />1. MACRO expansion,<br />2. ASSEMBLY of the code<br />3. BINARY code<br /><br />What MACROs really do is give you the capacity to modify code BEFORE its assembled so that you can more accurately tailor it to do what you want. You can have a single line of MACRO code that is expanded up to many lines of assembler code and this allows you to write your code more like a high level language if you design them that way.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-05-28 10:41:01 by hutch--</div>
   </div>
   <div class="post" id="post-40321">
    <div class="subject"><a href="#post-40321">It is Great to know there will be no pro-ben-toes</a></div>
    <div class="body">Thanks everybody,<br /><br />I am glad to hear it straight up, and it do make a lot more since to me now.  I hate to miss out on the Marco thing because i do know it is a really powerful thing to use. I have a habit of reading things an when i find an major negative view, i immedialy say *Well It Out of Here* and turn the page, without even trying to get to the root of why.  These could have been very old doc and maybe i simply mis-understood  ...<br /><br />....and bitRAKE, it is Great to be here.  It took me a long time to figure out what things really mean... From the day The Svin showed me how to do Real Math in code, everything else started kicking in, and now i am so happy about ASM that i don't know What to Do ... I rather scan code than sleep .... Most of ALL i learn how to understand ASM just playing with M32.lib ... it's all The Svin fault.<br /><br />But i still intent to find that last doc ( just in case )</div>
    <div class="meta">Posted on 2002-05-28 12:19:04 by cmax</div>
   </div>
  </div>
 </body>
</html>