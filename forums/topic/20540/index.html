<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Need help size optimizing :) - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=20540" />
    <link rel="next" href="../?id=20540&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=20540">Need help size optimizing :)</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=20540&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=20540&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="20540" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=20540&amp;page=2">&gt;</a><a href="../?id=20540&amp;page=2">&raquo;</a></form>   <div class="post" id="post-156884">
    <div class="subject"><a href="#post-156884">Need help size optimizing :)</a></div>
    <div class="body">Hi all, been a while since I last posted here... Good to see some familiar names still around here :)<br />I'm working on a exe packer (who isn't) based on Jibz' aPlib. So far things are going quite well and I'm pretty sure that when I'm done the exes will get a tiny bit better compression than FSG. If not I won't release it, let me put it that way ;)<br /><br />Anyway, I'm planning to use the shellcode method for loading functions. Using checksums instead of function names. Why store long function names when you can store a dword instead.. Now the only problem is that GetProcAddress obviously doesn't support this so I have to use my own code for getting the addresses. No problem there either, code is actually available everywhere. Now I just need to get it as small as possible :)<br /><br />Here's what I got so far, google for LGetProcAddress and you'll find the original. I'm using a different approach which saves some space. Also I don't do any error checking, if a function is not found you're screwed.<br /><br />Only requirement is that not too many registers may be destroyed. If you can get it a lot smaller eg by passing the args in a different way feel free to do so, this whole function will probably end up inside some loop anyway..<br />For testing, you can find a .inc with hashes <a target="_blank" href="http://instinct.student.utwente.nl/~snq/win32hash.zip">here</a>.<br /><br />Thanks in advance for your help! :)<br /><br /><pre><code>; LGetProcAddress&#40;dwHash, hModule&#41;<br />LGetProcAddress&#58;<br />    pushad<br /><br />    xor     ecx, ecx<br />LMainLoop&#58;<br />    ; All this code must be inside the loop because we destroy EBP later on<br />    ; ... which saves 1 byte ;&#41;<br />    mov     ebp, &#91;esp+20h+8&#93;        ; ebp = base address<br />    mov     eax, &#91;ebp+3Ch&#93;          ; eax = PE header offset<br />    mov     edx, &#91;ebp+eax+78h&#93;      ; edx = export table RVA<br />    mov     ebx, &#91;ebp+edx+1Ch&#93;<br />    mov     edi, &#91;ebp+edx+20h&#93;<br />    add     ebx, ebp                ; ebx = function address table<br />    add     edi, ebp                ; edi = function name table<br />    mov     esi, &#91;edi+4*ecx&#93;<br />    add     esi, ebp                ; esi = function name<br /><br />    ; Calc hash into edx<br />    xor     edx, edx<br />    xor     eax, eax<br />LCalcHash&#58;<br />    lodsb<br />    cmp     al, ah<br />    jz      short LHashDone<br />    ror     edx, 13<br />    add     edx, eax<br />    jmp     short LCalcHash<br />LHashDone&#58;<br />    add     ebp, &#91;ebx+4*ecx&#93;        ; ebp = function address<br />    inc     ecx<br />    cmp     edx, &#91;esp+20h+4&#93;        ; check hash<br />    jne     short LMainLoop<br /><br />LDone&#58;<br />    mov     &#91;esp+1Ch&#93;, ebp<br />    popad<br />    ret     8</code></pre><br /><br />*Edit: Noticed that I wrote &quot;size optimizating&quot;, I love it when I'm too tired to write decent english yet still I feel the need to push around bytes :/</div>
    <div class="meta">Posted on 2005-02-09 19:11:07 by snq</div>
   </div>
   <div class="post" id="post-156885">
    <div class="subject"><a href="#post-156885">Need help size optimizing :)</a></div>
    <div class="body">As usual, I found something 5 mins after posting..<br /><br />Replace<br /><pre><code>LCalcHash&#58;<br />    lodsb<br />    cmp     al, ah<br />    jz      short LHashDone<br />    ror     edx, 13<br />    add     edx, eax<br />    jmp     short LCalcHash<br />LHashDone&#58;</code></pre><br />with<br /><pre><code>LCalcHash&#58;<br />    ror     edx, 13<br />    add     edx, eax<br />    lodsb<br />    cmp     al, ah<br />    jnz     short LCalcHash<br />LHashDone&#58;</code></pre><br />2 bytes gone, 63 to go ;)<br /><br />Also, the xor eax, eax might not be necessary, but it depends on the DLL. If the PE offset is &lt;256 (which it probably is in 99% of all cases) we can remove the xor and save 2 more bytes.. But i'm not sure, dont want to risk crashes on some systems.</div>
    <div class="meta">Posted on 2005-02-09 19:28:27 by snq</div>
   </div>
   <div class="post" id="post-156940">
    <div class="subject"><a href="#post-156940">Re: Need help size optimizing :)</a></div>
    <div class="body">Suggestions:<br />1) replace edi to esi, since edi is used only once.<br />2) then replace ebp to edi, which should save several bytes (EBP opcodes are larger)<br />3) replace cmp al, ah with test al,al, to improve the speed.</div>
    <div class="meta">Posted on 2005-02-11 03:05:38 by MCoder</div>
   </div>
   <div class="post" id="post-156944">
    <div class="subject"><a href="#post-156944">Need help size optimizing :)</a></div>
    <div class="body">remember to support NT forwarded exports...</div>
    <div class="meta">Posted on 2005-02-11 03:57:51 by f0dder</div>
   </div>
   <div class="post" id="post-156952">
    <div class="subject"><a href="#post-156952">Need help size optimizing :)</a></div>
    <div class="body">Here's the current code.. It's not beautiful but it's only supposed to be small and work ;)<br /><br />edi contains the address of my own import table, which is structured like this:<br /><pre><code>db &quot;lib1.dll&quot;, 0<br />    dd hash1<br />    dd hash2<br />    ...<br />    dd hashX<br />    dd 0<br />db &quot;lib2.dll&quot;, 0<br />    dd hash1<br />    dd hash2<br />    ...<br />    dd hashX<br />    dd 0<br />...<br />db 0    ; terminator, no more libraries</code></pre><br /><pre><code>; 83 bytes<br />LibLoop&#58;<br />    push    edi                     ; edi = dll name<br />    apicall LoadLibrary             ; eax = base address<br />    test    eax, eax<br />    jz      short NoMoreLibs<br />    mov     ecx, eax<br />    repnz   scasb                   ; edi = 0 terminated hash array<br />FuncLoop&#58;<br />    mov     ebx, &#91;edi&#93;              ; ebx = name hash<br />    stosd                           ; edi += 4<br /><br />    test    ebx, ebx                ; next lib if hash==0<br />    jz      short LibLoop<br /><br />    xor     ecx, ecx<br />    dec     ecx<br />LMainLoop&#58;<br />    inc     ecx                     ; ecx updated to next function<br />    pushad<br /><br />    mov     edx, &#91;eax+3Ch&#93;          ; edx = PE header offset<br />    mov     edx, &#91;eax+edx+78h&#93;      ; edx = export table RVA<br />    add     edx, eax                ; edx = export table<br /><br />    mov     esi, &#91;edx+20h&#93;<br />    add     esi, eax                ; esi = function name table<br />    mov     esi, &#91;esi+4*ecx&#93;<br />    add     esi, eax                ; esi = function name<br /><br />    mov     ebp, eax                ; ebp = base address<br />    add     eax, &#91;edx+1Ch&#93;          ; eax = function address table<br />    add     ebp, &#91;eax+4*ecx&#93;        ; ebp = function address<br />    mov     &#91;edi-4&#93;, ebp            ; store function address<br /><br />    ; Calc hash into edx<br />    xor     edx, edx<br />    xor     eax, eax<br />LCalcHash&#58;<br />    ror     edx, 13<br />    add     edx, eax<br />    lodsb<br />    test    al, al<br />    jnz     short LCalcHash<br /><br />    cmp     ebx, edx                ; check hash<br />    popad<br />    jne     short LMainLoop         ; try next function<br />    jmp     short FuncLoop<br /><br />NoMoreLibs&#58;</code></pre></div>
    <div class="meta">Posted on 2005-02-11 09:23:05 by snq</div>
   </div>
   <div class="post" id="post-156953">
    <div class="subject"><a href="#post-156953">Need help size optimizing :)</a></div>
    <div class="body"><div class="quote">remember to support NT forwarded exports...</div><br />I haven't really read up on forwarded exports.. But so far I haven't had any problems with this method.<br />For now the idea is to create a compressor with minimal overhead, for use with 64k or 4k intros, not really for business use so to say. I can live with minor incompatabilities, I'm not planning to make it a too serious project :)</div>
    <div class="meta">Posted on 2005-02-11 09:31:03 by snq</div>
   </div>
   <div class="post" id="post-156979">
    <div class="subject"><a href="#post-156979">Need help size optimizing :)</a></div>
    <div class="body"><div class="quote"><br />I haven't really read up on forwarded exports.. But so far I haven't had any problems with this method. <br /></div><br />If the address of an exported function lies within the range defined by PE_DIRENT_EXPORT, it is a forwarded export - rather than pointing to valid code, the export will point to a ASCIZ string like &quot;ntdll.whateverfunction&quot;. This is done a lot on NT, and things like kernel32.heapalloc is forwarded to ntdll.</div>
    <div class="meta">Posted on 2005-02-12 07:24:35 by f0dder</div>
   </div>
   <div class="post" id="post-156999">
    <div class="subject"><a href="#post-156999">Need help size optimizing :)</a></div>
    <div class="body">Hmm.. Thanks for pointing this out, I guess there might be a problem there, if even commonly used functions like HeapAlloc won't work with this method.. I always use GlobalAlloc myself because it requires less code, so I probably wouldn't have discovered it.<br />So I can solve this in 2 ways. Either I check for forwarded imports in the compressor and load in this case HeapAlloc directly from ntdll, or I will have to use GetProcAddress for getting the addresses after all. I might end up doing 2 different loaders, one using hashes and using LGetProcAddress, and one using the actual names and regular GetProcAddress. And then use whichever one results in a smaller executable.</div>
    <div class="meta">Posted on 2005-02-13 06:15:32 by snq</div>
   </div>
   <div class="post" id="post-157002">
    <div class="subject"><a href="#post-157002">Need help size optimizing :)</a></div>
    <div class="body">I just came up with this. It seems a bit too long, though, and only supports alphabetic names. It's 89 bytes. But it lets you forget about forwarded names.<br /><pre><code>mov edi,FuncTable<br />xor eax,eax<br />cdq<br />mov ebp,readbits<br />u2&#58;<br />push edi<br />mov edi,buffer<br />push edi<br />push eax<br />u0&#58;<br />call ebp<br />db 4<br />xchg ecx,eax<br />jecxz next<br />mov bl,64<br />u1&#58;<br />call ebp<br />db 5<br />or al,bl<br />mov bl,96<br />stosb<br />loop u1<br />jmp u0<br />next&#58;<br />mov ebx,__imp__GetProcAddress@8<br />pop ecx<br />loop gpa<br />pop eax<br />push ecx<br />push eax<br />push &#91;esp+16&#93;<br />call &#91;ebx&#93;<br />pop edi<br />stosd<br />jmp u2<br />load&#58;<br />call &#91;ebx+__imp__LoadLibraryA@4-__imp__GetProcAddress@8&#93;<br />pop edi<br />pop ecx<br />push eax<br />call ebp<br />db 6<br />jmp u2<br />readbits&#58;<br />pop esi<br />lodsb<br />push esi<br />push ecx<br />xchg ecx,eax<br />rb0&#58;<br />bt &#91;data&#93;,edx<br />rcl eax,1<br />inc edx<br />loop rb0<br />pop ecx<br />ret</code></pre></div>
    <div class="meta">Posted on 2005-02-13 07:16:24 by Sephiroth3</div>
   </div>
   <div class="post" id="post-157013">
    <div class="subject"><a href="#post-157013">Need help size optimizing :)</a></div>
    <div class="body">Sephiroth3, I'm having a hard time understanding what your code is supposed to do ;) Also yes, it does seem a bit big.<br />I wrote a regular loader now that uses LoadLibrary, it's 46 bytes. The import table is compressed using aplib together with the rest of the original exe, unfortunately the aplib algo doesn't seem to work very good on plain text but I'll have to live with that.<br />Anyway, I just produced my first working exe! :) It's 856 bytes large at the moment and all it does is show &quot;Hello world&quot; and call some more functions just for testing the loader. But so far so good :)</div>
    <div class="meta">Posted on 2005-02-13 18:16:05 by snq</div>
   </div>
   <div class="post" id="post-157014">
    <div class="subject"><a href="#post-157014">Need help size optimizing :)</a></div>
    <div class="body">I got it down to 741 bytes now and still a lot of optimization to do and a lot of unused space.<br />I uploaded the exe <a target="_blank" href="http://www.radeonx.com/packed1.exe">here</a>, if anyone wants to test be my guest :) If it works it'll show a &quot;Hello world&quot; msgbox. It won't work under win9x (yet).<br /><br />*Edit:<br />Just tried compressing the same exe with some other packers.. The original exe has 3 sections, data/code/import, and is 2.5k large.<br />FSG compresses it to 857 bytes which is nice but not as nice as 741 bytes :-D <br />Latest UPX didn't want to compress it, said it was uncompressable.<br />UPX v0.71 did want to compress it after a lot of threatening, but the result was 2173 bytes. I'm pretty sure for larger exes UPX will in most cases give better compression tho.<br />And finally I tested with FRP. Probably nobody has heard of this packer but it's a modified version of UPX that uses aPlib as well, made by <a target="_blank" href="http://www.farb-rausch.com/">farb-rausch</a>. The resulting exe was 1.5k.<br />So, my packer beats em all, at least for ridiculously small and useless exes ;)<br /><br />Edit2: Down to <a target="_blank" href="http://www.radeonx.com/packed2.exe">721 bytes</a> now. One &quot;problem&quot; tho, I still have 48 bytes of wasted space in it.. What to do, what to do.... Any ideas? I guess I should move the start of the section back by 48 bytes, as its not 9x compatible anyway right now..</div>
    <div class="meta">Posted on 2005-02-13 18:42:11 by snq</div>
   </div>
   <div class="post" id="post-157029">
    <div class="subject"><a href="#post-157029">Need help size optimizing :)</a></div>
    <div class="body">Did you compare with the other packers:<br /><br /><a target="_blank" href="http://pect.y11.net/">http://pect.y11.net/</a></div>
    <div class="meta">Posted on 2005-02-14 12:56:15 by MCoder</div>
   </div>
   <div class="post" id="post-157033">
    <div class="subject"><a href="#post-157033">Need help size optimizing :)</a></div>
    <div class="body">No, not yet.<br />I added support now for loading functions by ordinal and tested with another exe, 6.5k containing lots of code and imports. Again it was smaller than all others. I'll do some more extensive testing once I finish the packer.. Right now I have to manually edit adresses and sizes in my loader source for each exe so it's kind of a pain in the ass to test ;)</div>
    <div class="meta">Posted on 2005-02-14 13:45:03 by snq</div>
   </div>
   <div class="post" id="post-157040">
    <div class="subject"><a href="#post-157040">Need help size optimizing :)</a></div>
    <div class="body">I tested now with DemoThread.exe and keygen.exe. DemoThread came up a bit bigger than MEW and FSG, 12100 bytes I think it was. keygen.exe however was 3956 bytes, a #1 placement :)<br />Didn't test the other 2 exes yet because my code isn't ready for those kind of sizes just yet ;)<br /><br />I just keep editing my posts... But after stripping some more useless tables from the exe, I got DemoThread.exe down to 11116 bytes so #1 there as well now ;)</div>
    <div class="meta">Posted on 2005-02-14 21:01:07 by snq</div>
   </div>
   <div class="post" id="post-157043">
    <div class="subject"><a href="#post-157043">Need help size optimizing :)</a></div>
    <div class="body">my apicrc engine + example. it's not aimed for size (it's ~230 bytes), but rather elegance, so don't use it on shellcodes (unless you size-hack it quite a bit ...), posted this awhile back. this will work on all versions of windows, but has yet to support forwarded exports (it shouldn't be anymore than a few lines ... but i'm lazy)<br /><br />http://angrypanda.net/~sfeng1/apicrc.zip<br /><br /><pre><code>module_api&#58; <br />db 'module.dll',0 <br />__api1 dd hash1 <br />__api2 dd hash2 <br />           dd 0</code></pre><br /><br />the 'table' terminates with a dword, for time's sake, and the hashes are subsequently replaced with the addresses of the APIs, which you can use to call with a delta offset. an example is included inside apicrc.asm. use get_crc32 to obtain the crc32 hashes, the string is automatically null-terminated.<br /><br />enjoy.</div>
    <div class="meta">Posted on 2005-02-15 00:16:36 by Drocon</div>
   </div>
   <div class="post" id="post-157055">
    <div class="subject"><a href="#post-157055">Need help size optimizing :)</a></div>
    <div class="body">Thanks for posting that Drocon, always interesting to see other peoples approaches.. But as you said, your code is a bit on the large side ;)<br />I've added back my hash loader, but it's only used for functions where it can be used and where it will save space. So it won't be used for forwarded stuff and imports by ordinal. Furthermore it is only added if it actually saves space. If an exe only has 2 imports it will only cost space so it won't be included and regular names will be used.. But if it has eg 80 imports it will save a lot of space so then it will be included and used :)</div>
    <div class="meta">Posted on 2005-02-15 07:38:40 by snq</div>
   </div>
   <div class="post" id="post-157732">
    <div class="subject"><a href="#post-157732">Need help size optimizing :)</a></div>
    <div class="body">1 byte optimization tip :)<br /><br />(fasm syntax)<br /><br /><pre><code><br />        format PE GUI 4.0<br />        entry start<br /><br />        include &quot;d&#58;\programy\kod\fasm\include\win32a.inc&quot;<br /><br /><br />        section &quot;.code&quot; code readable writeable executable<br /><br /><br />        start&#58;<br /><br />                mov     edi,dll1<br /><br />        ; 82 bytes<br /><br />        LibLoop&#58;<br />                push    edi                     ; edi = dll name<br />                call    &#91;LoadLibraryA&#93;          ; eax = base address<br />                test    eax,eax<br />                jz      NoMoreLibs<br /><br />                mov     ecx,eax<br />                repnz   scasb                   ; edi = 0 terminated hash array<br /><br />        FuncLoop&#58;<br />                mov     ebx,dword &#91;edi&#93;         ; ebx = name hash<br />                stosd                           ; edi += 4<br /><br />                test    ebx,ebx                 ; next lib if hash==0<br />                jz      LibLoop<br /><br />                sub     ecx,ecx<br />                dec     ecx<br /><br />        LMainLoop&#58;<br />                inc     ecx                     ; ecx updated to next function<br />                pushad<br /><br />                mov     edx,dword &#91;eax+0x3c&#93;    ; edx = PE header offset<br />                mov     edx,dword &#91;eax+edx+0x78&#93;; edx = export table RVA<br />                add     edx,eax                 ; edx = export table<br /><br />                mov     esi,dword &#91;edx+0x20&#93;<br />                add     esi,eax                 ; esi = function name table<br />                mov     esi,dword &#91;esi+4*ecx&#93;<br />                add     esi,eax                 ; esi = function name<br /><br />                mov     ebp,eax                 ; ebp = base address<br />                add     eax,dword &#91;edx+0x1c&#93;    ; eax = function address table<br />                add     ebp,dword &#91;eax+4*ecx&#93;   ; ebp = function address<br />                mov     dword &#91;edi-4&#93;,ebp       ; store function address<br /><br />;----------------------------------------<br /><br />                ; Calc hash into edx<br />;                xor     edx, edx<br />;                xor     eax, eax<br /><br />                sub     eax,eax<br />                cdq                             ;edx = 0<br /><br />;----------------------------------------<br /><br />        LCalcHash&#58;<br />                ror     edx,13<br />                add     edx,eax<br />                lodsb<br />                test    al,al<br />                jnz     LCalcHash<br /><br />                cmp     ebx,edx                 ; check hash<br />                popad<br />                jne     LMainLoop               ; try next function<br />                jmp     FuncLoop<br /><br />        NoMoreLibs&#58;<br /><br />                ret<br /><br />        section &quot;.data&quot; data readable writeable executable<br /><br />                dll1    db &quot;kernel32&quot;,0<br />                        dd 0x73E2D87E   ;ExitProcess<br />                        dd 0<br />                dll2    db &quot;user32&quot;,0<br />                        dd 0xCAD36F3B   ;ChangeDisplaySettingsA<br />                        dd 0x84454941   ;CreateWindowExA<br />                        dd 0x2B245A7A   ;GetAsyncKeyState<br />                        dd 0xCC248D43   ;GetDC<br />                        dd 0xBC4F79F4   ;SetCursor<br />                        dd 0<br /><br />                        db 0            ;terminator, no more libraries<br /><br /><br />        section '.idata' import data readable writeable executable<br /><br />        library kernel32,&quot;kernel32&quot;<br /><br />        import  kernel32,\<br />                LoadLibraryA,&quot;LoadLibraryA&quot;<br /></code></pre><br /><br />important: use library`s names without &quot;.dll&quot; extension, it`ll save some bytes, and it`s still compatible under xp. i`m 4k coder too. with my friend,  wrote only xp-compatible noimport code. i suppose, that you know, what is it doing. maybe it`ll help you.<br /><br />(masm syntax)<br /><br /><pre><code><br /><br />      ;noimport.asm &#40;c&#41; Northfox, rambo, reverend<br />      ;49 bytes.<br />      ;&#40;+2 bytes - compatible version&#41;<br /><br />      .386<br />      .model flat,stdcall<br /><br />      salc  macro<br />            db 0d6h<br />      endm<br /><br />      .code<br /><br />      start&#58;<br /><br />            pop   ecx<br />            push  ecx<br /><br />     @@&#58;    cmp   word ptr &#91;ecx-1&#93;,&quot;ZM&quot;<br />            loopnz short @b<br /><br />            mov   ebp,ecx<br /><br />            add   ecx,dword ptr &#91;ecx+60&#93;<br />            mov   eax,dword ptr &#91;ecx+120&#93;<br />            mov   esi,dword ptr &#91;ebp+eax+28&#93;<br />            add   esi,ebp<br />            mov   eax,dword ptr &#91;ebp+eax+32&#93;<br />            mov   edi,dword ptr ds&#58;&#91;ebp+eax&#93;<br />            add   edi,ebp<br /><br />      @@&#58;   salc<br />      @e&#58;   cmp   word ptr &#91;edi&#93;,&quot;Ac&quot;<br />            jz    short @f<br /><br />            scasb<br />            jnz   short @e<br /><br />            lodsd<br />            jmp   short @b<br /><br />     @@&#58;    lodsd<br />            add   eax,ebp<br /><br />            ;eax - GetProcAddress<br />            ;ebp - kernel32.dll<br /><br />            ret <br /><br />      end start<br /></code></pre><br /><br />and what with opengl32 and glu32 hash-table? are you using ordinal importing opengl instead of hash? i think, that it`s better idea, and may be even compatible. the only disadvantage is that breakpoint2005 rules forbid ordinal importing.. :)<br /><br />(fasm syntax)<br /><br /><pre><code><br />		; supported libraries&#58;<br />		;<br />		;  user     | dll version   | first function    | address  |<br />		; ----------+---------------+-------------------+----------+<br />		;  rambo    | 4.0.1379.1    | DllInitialize     | 7d27bbfe |<br />		;  rambo    | 4.0.1381.4    | DllInitialize     | 78a4bf5e |<br />		;  vorg     | 5.0.2160.1    | DllInitialize     | 69408c55 |<br />		;  epsylon  | 5.0.2195.6611 | DllInitialize     | 69408c55 |<br />		; ----------+---------------+-------------------+----------+<br />		;  ninja    | 5.1.2600.0    | GlmfBeginGlsBlock | 5f1a7c8c |<br />		;  rambo    | 5.1.2600.1106 | GlmfBeginGlsBlock | 5f1a7c8c |<br />		;  chebdo   | 5.1.2600.2180 | GlmfBeginGlsBlock | 5f1aa6da |<br />		;  luks     | 5.1.2600.2180 | GlmfBeginGlsBlock | 5ed1a6da |<br />		;  -&gt; strange, but i handle it. &#40;sp2&#41;                      |<br /><br /><br />		mov	ebp,import_strings<br />		mov	edi,import_table+4<br /><br />	@glu&#58;	sub	esi,esi<br />	@@&#58;	inc	esi<br /><br />		push	esi<br />		push	ebp<br />		call	&#91;LoadLibraryA&#93;<br /><br />		push	eax<br />		call	&#91;GetProcAddress&#93;<br /><br />		cmp	byte &#91;ebp&#93;,&quot;g&quot;<br />		jz	@nou<br /><br />		dec	esi<br />		jnz	@not<br /><br />		bswap	eax<br />		sub	al,5eh<br />		jz	@not<br />		dec	al<br />		jz	@not<br />		sub	edi,4<br /><br />	@not&#58;	inc	esi<br />	@nou&#58;	stosd<br /><br />		cmp	si,16fh<br />		jb	@b<br /><br />		add	ebp,9<br />		test	eax,eax<br />		jnz	@glu<br /></code></pre><br /><br />optimizations are welcome! :)</div>
    <div class="meta">Posted on 2005-03-05 18:22:53 by rambo</div>
   </div>
   <div class="post" id="post-157741">
    <div class="subject"><a href="#post-157741">Need help size optimizing :)</a></div>
    <div class="body">Ahh.. An understanding soul :D<br />I already changed the cdq actually but thanks anyway ;)<br /><br />Unfortunately I haven't had any time to get any work done on my packer but I agree the opengl imports are important especially for 4k intros.<br /><br />This is the last version of my code.. I separated the LibLoop and FuncLoop for now so I can easily leave out the hash stuff where it won't save any bytes.<br /><br />I'll probably never have time to code a 4k intro anyway but I want to use my micro softsynth :) Problem is also I live in the very north of Sweden now and there are no demoparties here (and I refuse to travel a couple 1000 km for a party) so even if I make a 4k intro where am I going to release it...<br /><br />Anyway, here's the code. Feel free to use it for whatever you like.<br />imports are now stored in a slightly different format. default is 0-terminated function names, if the first byte of the name is -1, use hash loaded from the next 4 bytes. if the first byte of the name is -2, use ordinal.<br /><pre><code>LoadLibs&#58;<br />        pop     esi<br />    .LibLoop&#58;<br />        push    esi                     ; esi = dll name<br />        call    &#91;ebp+4&#93;                 ; apicall LoadLibrary<br />        test    eax, eax                ; if hmodule = null, no more libs<br />        jz      short .NoMoreLibs<br />        xchg    eax, ebx                ; ebx = hmodule<br />    .SkipDllName&#58;<br />        lodsb<br />        test    al, al<br />        jnz     short .SkipDllName<br />    <br />        lodsd<br />        xchg    eax, edi                ; edi = function table<br />    <br />    .FuncLoop&#58;<br />    ;   cmp     byte &#91;esi&#93;, 255<br />        cmp     byte &#91;esi&#93;, bl          ; bl = 0<br />        pushfd<br />        jge     short .AsString<br />        lodsb<br />        inc     al<br />        lodsd<br />        jz      short LGetProcAddress<br />    .AsOrdinal&#58;<br />        push    eax<br />        jmp     short .FuncLoop2<br />    .AsString&#58;<br />        push    esi                     ; esi = func name<br />    .FuncLoop2&#58;<br />        push    ebx<br />        call    &#91;ebp&#93;                   ; apicall GetProcAddress<br />    .StoreFuncAddress&#58;<br />        stosd                           ; store func address<br />        popfd<br />        jl      short .FuncLoop<br />        test    eax, eax<br />        jz      short .LibLoop<br />    .SkipFuncName&#58;<br />        lodsb<br />        test    al, al<br />        jnz     short .SkipFuncName<br />        jmp     short .FuncLoop<br />    <br />    .NoMoreLibs&#58;<br />    <br />        ret                             ; jmp entrypoint<br />    .End&#58;<br /><br />;----------------------------------------------------------------------------<br /><br />; ebx&#58; base address<br />; eax&#58; hash<br />; edi&#58; dest address table<br />; destoys ecx<br />LGetProcAddress&#58;<br />        xor     ecx, ecx<br />        dec     ecx<br />    .MainLoop&#58;<br />        inc     ecx                     ; ecx updated to next function<br />        pushad<br /><br />        xchg    eax, ebx                ; eax=base ebx=hash<br /><br />        mov     edx, &#91;eax+3Ch&#93;          ; edx = PE header offset<br />        mov     edx, &#91;eax+edx+78h&#93;      ; edx = export table RVA<br />        add     edx, eax                ; edx = export table<br /><br />        push    eax<br />        mov     &#91;edi&#93;, eax<br />        add     eax, &#91;edx+20h&#93;          ; esi = function name table<br />        mov     esi, &#91;eax+4*ecx&#93;<br />        pop     eax<br />        add     esi, eax                ; esi = function name<br />        add     eax, &#91;edx+1Ch&#93;          ; eax = function address table<br />        mov     eax, &#91;eax+4*ecx&#93;        ; ebp = function address<br />        add     &#91;edi&#93;, eax<br /><br />        ; Calc hash into edx<br />        xor     eax, eax<br />        cdq                             ; xor edx, edx<br />    .CalcHash&#58;<br />        ror     edx, 13<br />        add     edx, eax<br />        lodsb<br />        test    al, al<br />        jnz     short .CalcHash<br /><br />        cmp     ebx, edx                ; check hash<br />        popad<br />        jne     short .MainLoop         ; try next function<br />        mov     eax, &#91;edi&#93;<br /><br />        jmp     short LoadLibs.StoreFuncAddress<br />    .End&#58;</code></pre></div>
    <div class="meta">Posted on 2005-03-06 07:50:43 by snq</div>
   </div>
   <div class="post" id="post-157777">
    <div class="subject"><a href="#post-157777">Need help size optimizing :)</a></div>
    <div class="body">i don`t understand one line.. :) :<br /><br /><pre><code><br />    .FuncLoop&#58;<br />    ;   cmp     byte &#91;esi&#93;, 255<br />        cmp     byte &#91;esi&#93;, bl          ; bl = 0<br />        pushfd<br />        jge     short .AsString<br />        lodsb<br />        inc     al<br />        lodsd<br />        jz      short LGetProcAddress<br /></code></pre><br /><br />why are you increasing al? eax is cleared by some value in next line!<br /><br />and about making 4kb without going to the party.. here, in poland i also haven`t near to a GOOD party, but 4k is not only you, there are also musician and probably 3d modeller, if you have some little-tricky 3d format, so making it for their pleasure at party is many much funnier :)</div>
    <div class="meta">Posted on 2005-03-07 02:13:42 by rambo</div>
   </div>
   <div class="post" id="post-157781">
    <div class="subject"><a href="#post-157781">Need help size optimizing :)</a></div>
    <div class="body"><pre><code>inc     al<br />lodsd<br />jz      short LGetProcAddress </code></pre><br />eax is cleared/reassigned yes, but the flags remain in tact after lodsd :) i use inc al to check if al is -1 or -2 (hash or ordinal).<br /><br />Our musician can't code :/ I wrote a softsynth for 64k first that we have never used in an intro yet.. And like 2 years ago I wrote a micro version of it for 4k intros, but we (aardbei) got kinda lazy and inactive :(<br />I still really want to do a good 4k intro tho. Even if it would be my last intro ever. All I want is for it to be as good as PTCT was, thats not too much to ask is it ;)</div>
    <div class="meta">Posted on 2005-03-07 03:11:39 by snq</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=20540&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=20540&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="20540" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=20540&amp;page=2">&gt;</a><a href="../?id=20540&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>