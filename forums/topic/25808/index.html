<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Maverick's Profile usable? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=25808" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=25808">Maverick's Profile usable?</a></p>
   <div class="post" id="post-188265">
    <div class="subject"><a href="#post-188265">Maverick's Profile usable?</a></div>
    <div class="body">Hi all,<br /><br />Being interested in profiling I searched the board for it, and amongst others (like VTune and CodeAnalist) I came across Maverick&#39;s PROFILEr. He also released version 2.0 of it.<br /><br />In the link below (dated 17/18 september 2002, so it&#39;s an old thread) there is a statement by Maverick that Profile v2.0 had some secondary issues to be fixed at that time.<br /><br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=7996.0">http://www.asmcommunity.net/board/index.php?topic=7996.0</a><br /><br />His statement was:<br /><div class="quote">I still haven&#39;t had the time (and expecially the attitude) to fix some secondary issues of v2.. So people may prefer to use the older one.</div><br /><br />I couldn&#39;t find the answers on the following questions:<br />- The secondary issues of v2: Have they been dealt with since?<br />- Can version 2 be used safely at the moment?<br />- If not, can one still use the older version? Are there any drawbacks?<br />- As I saw in the threads regarding the older version of PROFILE: There were problems translating the NASM version into Masm. What is the most reliable MASM translation at the moment? (I hope it is still being used)<br /><br />Can anyone shape some light in the darkness?<br /><br />Friendly regards,<br />mdevries.</div>
    <div class="meta">Posted on 2007-03-01 08:57:05 by mdevries</div>
   </div>
   <div class="post" id="post-188293">
    <div class="subject"><a href="#post-188293">Re: Maverick's Profile usable?</a></div>
    <div class="body"><br />Hi,<br /><br /><div class="quote"><br />Hi all,<br /><br />Being interested in profiling I searched the board for it, and amongst others (like VTune and CodeAnalist) I came across Maverick&#39;s PROFILEr. He also released version 2.0 of it.<br /><br />In the link below (dated 17/18 september 2002, so it&#39;s an old thread) there is a statement by Maverick that Profile v2.0 had some secondary issues to be fixed at that time.<br /><br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=7996.0">http://www.asmcommunity.net/board/index.php?topic=7996.0</a><br /><br />His statement was:<br /><div class="quote">I still haven&#39;t had the time (and expecially the attitude) to fix some secondary issues of v2.. So people may prefer to use the older one.</div><br /><br />I couldn&#39;t find the answers on the following questions:<br />- The secondary issues of v2: Have they been dealt with since?</div><br /><br />It&#39;s been a very long time. No, I don&#39;t think I worked more on it, sorry.<br /><br /><div class="quote"><br />- Can version 2 be used safely at the moment?</div><br /><br />If you test it on your system (CPUs that didn&#39;t exist at the time) and it appears to work correctly (expecially not giving negative results when you profile nothing or maybe a NOP) then I assume it&#39;s safe.<br /><br /><div class="quote"><br />- If not, can one still use the older version? Are there any drawbacks?</div><br /><br />Same as above I think.<br /><br /><div class="quote"><br />- As I saw in the threads regarding the older version of PROFILE: There were problems translating the NASM version into Masm. What is the most reliable MASM translation at the moment? (I hope it is still being used)</div><br /><br />Sorry, I&#39;ve never been a MASM user, and I&#39;m not a NASM user anymore (FASM rocks anytime!).<br /><br /><div class="quote"><br />Can anyone shape some light in the darkness?</div><br /><br />I am very sorry I cannot shed more light than that. It&#39;s been a long time and a lot of bits passed through my systems since then. I haven&#39;t really done much x86 asm since those times by the way.. I moved to other CPUs to get much more fun.<br /><br /><div class="quote"><br />Friendly regards,<br />mdevries.<br /></div><br /><br />Greets,<br />Maverick<br /><br />PS: please do not hate me :)<br /><br /></div>
    <div class="meta">Posted on 2007-03-02 05:54:42 by Maverick</div>
   </div>
   <div class="post" id="post-188296">
    <div class="subject"><a href="#post-188296">Re: Maverick's Profile usable?</a></div>
    <div class="body">Thanks for stepping by and answering, anyway :)<br /><br /></div>
    <div class="meta">Posted on 2007-03-02 09:26:17 by f0dder</div>
   </div>
   <div class="post" id="post-188297">
    <div class="subject"><a href="#post-188297">Re: Maverick's Profile usable?</a></div>
    <div class="body">Are any/all of the versions available ?<br /><br />Multiple searches revealed posts without any attachments.<br /><br />Such as:<br />http://www.asmcommunity.net/board/index.php?topic=7510</div>
    <div class="meta">Posted on 2007-03-02 11:21:35 by dsouza123</div>
   </div>
   <div class="post" id="post-188313">
    <div class="subject"><a href="#post-188313">Re: Maverick's Profile usable?</a></div>
    <div class="body">Hi,<br /><br />Thanks Maverick for your response.<br /><br /><div class="quote">If you test it on your system (CPUs that didn&#39;t exist at the time) and it appears to work correctly (expecially not giving negative results when you profile nothing or maybe a NOP) then I assume it&#39;s safe.</div><br /><br />As you suggested I just tried both versions.<br /><br />I profiled 2 types of functions with the older version of PROFILE.<br />- a function without parameters<br />- a function with 1 parameter<br />The first time the only thing the function contained was a RET.<br />The next time a NOP and a RET.<br />Then 2 NOP&#39;s and a RET,<br />Then 3 NOP&#39;s and a RET, etc.<br /><br />After having done this I profiled the same functions with the newer version of PROFILE. These were the results on my Intel Pentium M notebook, running under Windows XP:<br /><br /><pre><code><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PROFILE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PROFILE v2.0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  0 Param&nbsp;  1 Param&nbsp; &nbsp; &nbsp;  0 Param&nbsp;  1 Param<br /><br /> 0 nop ret&nbsp; &nbsp; &nbsp; &nbsp;  0&nbsp; &nbsp; &nbsp; &nbsp; -1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  0&nbsp; &nbsp; &nbsp; &nbsp;  0<br /> 1 nop ret&nbsp; &nbsp; &nbsp; &nbsp; -4&nbsp; &nbsp; &nbsp; &nbsp;  2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  0&nbsp; &nbsp; &nbsp; &nbsp; -3<br /> 2 nop ret&nbsp; &nbsp; &nbsp; &nbsp; -4&nbsp; &nbsp; &nbsp; &nbsp;  1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  0&nbsp; &nbsp; &nbsp; &nbsp;  2<br /> 3 nop ret&nbsp; &nbsp; &nbsp; &nbsp; -3&nbsp; &nbsp; &nbsp; &nbsp; -2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  0&nbsp; &nbsp; &nbsp; &nbsp;  1<br /> 4 nop ret&nbsp; &nbsp; &nbsp; &nbsp; -5&nbsp; &nbsp; &nbsp; &nbsp;  4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  1&nbsp; &nbsp; &nbsp; &nbsp; -2<br /> 5 nop ret&nbsp; &nbsp; &nbsp; &nbsp;  0&nbsp; &nbsp; &nbsp; &nbsp;  0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  0&nbsp; &nbsp; &nbsp; &nbsp; -3<br /> 6 nop ret&nbsp; &nbsp; &nbsp; &nbsp; -2&nbsp; &nbsp; &nbsp; &nbsp; -2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  0&nbsp; &nbsp; &nbsp; &nbsp;  2<br /> 7 nop ret&nbsp; &nbsp; &nbsp; &nbsp; -8&nbsp; &nbsp; &nbsp; &nbsp;  0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  2&nbsp; &nbsp; &nbsp; &nbsp;  4<br /> 8 nop ret&nbsp; &nbsp; &nbsp; &nbsp; -4&nbsp; &nbsp; &nbsp; &nbsp; -2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  2&nbsp; &nbsp; &nbsp; &nbsp;  3<br /> 9 nop ret&nbsp; &nbsp; &nbsp; &nbsp; -2&nbsp; &nbsp; &nbsp; &nbsp;  4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  1&nbsp; &nbsp; &nbsp; &nbsp;  6<br />10 nop ret&nbsp; &nbsp; &nbsp; &nbsp; -1&nbsp; &nbsp; &nbsp; &nbsp;  3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -3&nbsp; &nbsp; &nbsp; &nbsp;  6<br />11 nop ret&nbsp; &nbsp; &nbsp; &nbsp; -1&nbsp; &nbsp; &nbsp; &nbsp;  2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -2&nbsp; &nbsp; &nbsp; &nbsp;  4<br />12 nop ret&nbsp; &nbsp; &nbsp; &nbsp; -5&nbsp; &nbsp; &nbsp; &nbsp;  5&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  3&nbsp; &nbsp; &nbsp; &nbsp;  3<br />13 nop ret&nbsp; &nbsp; &nbsp; &nbsp; -6&nbsp; &nbsp; &nbsp; &nbsp;  7&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -1&nbsp; &nbsp; &nbsp; &nbsp;  3<br />14 nop ret&nbsp; &nbsp; &nbsp; &nbsp; -1&nbsp; &nbsp; &nbsp; &nbsp;  7&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -1&nbsp; &nbsp; &nbsp; &nbsp;  5<br />15 nop ret&nbsp; &nbsp; &nbsp; &nbsp; -4&nbsp; &nbsp; &nbsp; &nbsp;  7&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  4&nbsp; &nbsp; &nbsp; &nbsp;  5<br />16 nop ret&nbsp; &nbsp; &nbsp; &nbsp;  1&nbsp; &nbsp; &nbsp; &nbsp;  6&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  4&nbsp; &nbsp; &nbsp; &nbsp;  7<br />17 nop ret&nbsp; &nbsp; &nbsp; &nbsp; -4&nbsp; &nbsp; &nbsp; &nbsp;  5&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  5&nbsp; &nbsp; &nbsp; &nbsp;  8<br />18 nop ret&nbsp; &nbsp; &nbsp; &nbsp;  4&nbsp; &nbsp; &nbsp; &nbsp;  7&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  5&nbsp; &nbsp; &nbsp; &nbsp;  9<br />19 nop ret&nbsp; &nbsp; &nbsp; &nbsp;  2&nbsp; &nbsp; &nbsp; &nbsp;  6&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  5&nbsp; &nbsp; &nbsp; &nbsp;  8<br />20 nop ret&nbsp; &nbsp; &nbsp; &nbsp;  3&nbsp; &nbsp; &nbsp; &nbsp;  7&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  7&nbsp; &nbsp; &nbsp; &nbsp;  6<br />21 nop ret&nbsp; &nbsp; &nbsp; &nbsp;  3&nbsp; &nbsp; &nbsp; &nbsp; 10&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  2&nbsp; &nbsp; &nbsp; &nbsp;  8<br />22 nop ret&nbsp; &nbsp; &nbsp; &nbsp;  3&nbsp; &nbsp; &nbsp; &nbsp;  8&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  7&nbsp; &nbsp; &nbsp; &nbsp; 11<br />23 nop ret&nbsp; &nbsp; &nbsp; &nbsp;  4&nbsp; &nbsp; &nbsp; &nbsp;  7&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  8&nbsp; &nbsp; &nbsp; &nbsp; 12<br />24 nop ret&nbsp; &nbsp; &nbsp; &nbsp;  4&nbsp; &nbsp; &nbsp; &nbsp; 15&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  7&nbsp; &nbsp; &nbsp; &nbsp; 12<br /></code></pre><br /><br />There was a stack unbalance after profiling the function with the parameter.<br />ESP before profiling: 0012FFC4h<br />ESP after profiling:&nbsp; 00130000h<br />So, there was a difference of 60 bytes, too much popped off the stack.<br /><br />The stack unbalance doesn&#39;t appear after profiling the function without parameters.<br /><br /><br />This is the code I found and used for the older version of PROFILE. I hope this was the definite MASM version, that solved the alignment problems.<br /><br /><pre><code><br />.686p<br /><br />; ---------------------------------------------------------------------------<br /><br />PROFILE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  MACRO&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ROUTINE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ,ROUTINE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CALL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _PROFILE<br />ENDM<br /><br />; --------------------------------------------------------------------------- <br />PROFILE_ALIGN_CODE MACRO<br />&nbsp; PROFILE_ENDS_CODE MACRO<br />&nbsp; &nbsp; _TEXT$1 ENDS<br />&nbsp; ENDM<br /> _TEXT$1 SEGMENT PAGE READONLY PUBLIC<br />ENDM<br />; --------------------------------------------------------------------------- <br />PROFILE_ALIGN_BSS MACRO<br />&nbsp; PROFILE_ENDS_BSS MACRO<br />&nbsp;  _BSS$1 ENDS<br />&nbsp; ENDM&nbsp; <br /> _BSS$1 SEGMENT PAGE PUBLIC <br />ENDM<br />; --------------------------------------------------------------------------- <br />PROFILE_ALIGN_DATA MACRO<br />&nbsp; PROFILE_ENDS_DATA MACRO<br />&nbsp;  _DATA$1 ENDS<br />&nbsp; ENDM<br /> _DATA$1 SEGMENT PAGE PUBLIC<br />ENDM<br />; --------------------------------------------------------------------------- <br /><br /><br />; -------------------------------------<br /><br />PROFILE_ALIGN_BSS&nbsp;  ; ------------------------------------------------------- <br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ALIGN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  64&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; align to a cache entry on all CPU&#39;s<br />PROFILEROUTINE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br />PROFILECYCLES&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br />_PROFILEEMPTY&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br />_PROFILERETURN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br />_PROFILEINEAX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br />_PROFILEINEBX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br />_PROFILEINECX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br />_PROFILEINEDX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br />_PROFILEINESI&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br />_PROFILEINEDI&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br />_PROFILEINEBP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br />_PROFILEINEFL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br />_PROFILEOUTEAX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br />_PROFILEOUTEBX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br />_PROFILEOUTECX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br />_PROFILEOUTEDX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br />_PROFILEOUTEFL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br />_PROFILERETADDR&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br /><br />PROFILE_ENDS_BSS&nbsp; &nbsp; ; ------------------------------------------------------- <br /><br />; -------------------------------------<br /><br />PROFILE_ALIGN_CODE&nbsp; ; ------------------------------------------------------- <br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ALIGN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  64 ;16&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; align to a cache entry on all CPU&#39;s<br />_PROFILE:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILEINEAX],EAX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; saves INPUT EAX (will be trashed by CPUID)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILEINEBX],EBX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; saves INPUT EBX (will be trashed by CPUID)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILEINECX],ECX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; saves INPUT ECX (will be trashed by CPUID)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILEINEDX],EDX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; saves INPUT EDX (will be trashed by CPUID)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILEINESI],ESI&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; saves INPUT ESI (will be trashed by the routine to be tested, which will be called multiple times)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILEINEDI],EDI&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; saves INPUT EDE (will be trashed by the routine to be tested, which will be called multiple times)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILEINEBP],EBP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; saves INPUT EBP (will be trashed by the routine to be tested, which will be called multiple times)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PUSHFD<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; POP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILEINEFL]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; saves INPUT CPU EFLAGS<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; POP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILERETURN]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; saves return address<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PUSH&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; saves requested PROFILEROUTINE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ,@empty&nbsp; &nbsp; &nbsp; &nbsp;  ; first we&#39;ll profile a simple RET<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILERETADDR],@ret1<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JMP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  @profile&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; make sure it gets cached<br />@ret1:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILERETADDR],@ret2<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JMP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  @profile&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; profile for real (well, let it set up)<br />@ret2:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILERETADDR],@ret3<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JMP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  @profile&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; profile for real (well, let it set up again)<br />@ret3:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILERETADDR],@ret4<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JMP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  @profile&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; profile for real (well, let it set up one final time)<br />@ret4:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILERETADDR],@ret5<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JMP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  @profile&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; profile for real<br />@ret5:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EAX,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EDX,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILEEMPTY+0],EAX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; saves RET cycles count<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILEEMPTY+4],EDX<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; POP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; restores requested PROFILEROUTINE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILERETADDR],@ret6<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JMP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  @profile&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; make sure it gets cached<br />@ret6:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILERETADDR],@ret7<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JMP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  @profile&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; profile for real<br />@ret7:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILERETADDR],@ret8<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JMP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  @profile&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; make sure it gets cached<br />@ret8:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILERETADDR],@ret9<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JMP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  @profile&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; profile for real<br />@ret9:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILERETADDR],@ret10<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JMP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  @profile&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; make sure it gets cached<br />@ret10:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EAX,[_PROFILEEMPTY+0]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; subtracts simple RET overhead<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EDX,[_PROFILEEMPTY+4]<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SUB&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ,EAX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; saves cycles, low 32bit<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SBB&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ,EDX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; saves cycles, high 32bit<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EAX,[_PROFILEOUTEAX]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; gives OUTPUT EAX<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EBX,[_PROFILEOUTEBX]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; gives OUTPUT EBX<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ECX,[_PROFILEOUTECX]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; gives OUTPUT ECX<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EDX,[_PROFILEOUTEDX]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; gives OUTPUT EDX<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PUSH&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [_PROFILEOUTEFL]<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; POPFD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; gives CPU EFLAGS<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JMP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILERETURN]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; returns to caller<br />@profile:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;WBINVD (if you want to test uncached data/code) ; beware, WBINVD is only for ring0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EAX,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; touches caches<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EDX,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EAX,[_PROFILEINEAX]<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EBX,[_PROFILEINEBX]<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ECX,[_PROFILEINECX]<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EDX,[_PROFILEINEDX]<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ESI,[_PROFILEINESI]<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EDI,[_PROFILEINEDI]<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EBP,[_PROFILEINEBP]<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EAX,[_PROFILEINEFL]<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EAX,[_PROFILEOUTEAX]<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EBX,[_PROFILEOUTEBX]<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ECX,[_PROFILEOUTECX]<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EDX,[_PROFILEOUTEDX]<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EAX,[_PROFILEOUTEFL]<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EAX,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ECX,32<br />@@stack:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PUSH&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; EAX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; touches stack<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LOOP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @@stack<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ADD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  esp,128<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XOR&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EAX,EAX<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CPUID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; flush pipelines<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RDTSC<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ,EAX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; saves TSC, low 32bit<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ,EDX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; saves TSC, high 32bit<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XOR&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EAX,EAX<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CPUID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; flush pipelines<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EAX,[_PROFILEINEAX]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; restores INPUT EAX<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EBX,[_PROFILEINEBX]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; restores INPUT EBX<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ECX,[_PROFILEINECX]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; restores INPUT ECX<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EDX,[_PROFILEINEDX]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; restores INPUT EDX<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ESI,[_PROFILEINESI]<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EDI,[_PROFILEINEDI]<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EBP,[_PROFILEINEBP]<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PUSH&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [_PROFILEINEFL]<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; POPFD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; restores CPU EFLAGS<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CALL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; calls routine to be tested<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILEOUTEAX],EAX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; saves OUTPUT EAX<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILEOUTEBX],EBX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; saves OUTPUT EBX<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILEOUTECX],ECX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; saves OUTPUT ECX<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILEOUTEDX],EDX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; saves OUTPUT EDX<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PUSHFD<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; POP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILEOUTEFL]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; saves OUTPUT CPU EFLAGS<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XOR&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  EAX,EAX<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CPUID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; flush pipelines<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RDTSC<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XCHG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ,EAX<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XCHG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ,EDX<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SUB&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ,EAX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; saves TSC, low 32bit<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SBB&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ,EDX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; saves TSC, high 32bit<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JMP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [_PROFILERETADDR]<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ALIGN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  64 ; 16&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; align to a cache entry on all CPU&#39;s<br />@empty:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  RET<br /><br />PROFILE_ENDS_CODE&nbsp;  ; ------------------------------------------------------- <br /></code></pre><br /><br /><br />This is my little test function:<br /><br />Note that PROFILE_ALIGN_CODE and PROFILE_ENDS_CODE are NaN&#39;s macros to start and end a page aligned new code segment.<br />I used the test function for both the older and the newer version of PROFILE.<br /><br /><pre><code><br />PROFILE_ALIGN_CODE<br />align 64<br /><br />testfunc proc ;Param1:dword		;Uncomment Param1 to have 1 parameter<br />&nbsp; &nbsp; &nbsp; &nbsp; nop	;Add more nops here, and restart profiling.<br />&nbsp; &nbsp; &nbsp; &nbsp; ret<br />testfunc endp<br /><br />PROFILE_ENDS_CODE<br /></code></pre><br /><br />This is the way I called the test function, using the older version of PROFILE:<br />I am using BiteRider&#39;s ObjAsm32&#39;s debug system (DebugCenter) to show the results.<br /><br /><pre><code><br />mov eax,esp<br />DbgHex eax,&quot;esp before profiling&quot;<br /><br />mov eax,offset _PROFILE<br />DbgHex eax,&quot;Profile base address&quot;<br /><br />;push eax	;uncomment this to have 1 parameter<br />PROFILE testfunc<br /><br />DbgHex qword ptr , &quot;Cycles after profiling&quot;<br /><br />mov eax,esp<br />DbgHex eax,&quot;esp after profiling&quot;<br /></code></pre><br /><br /><br />Now the code for PROFILE v2.0, partly borrowed from MArtial_Code (January 18, 2003):<br /><br />This is an include file that includes the binary code from the Profile.bin file.<br />The binary code was supplied by Maverick to make PROFILE v2.0 assembler independent:<br /><br /><pre><code><br />PROFILERSIZE equ 660<br />PROFILERINITOFFSET equ 559<br />PROFILERRESULTOFFSET equ 4096<br />PROFILERSTARTOFFSET equ 1<br /><br />_PROF1 segment dword &#39;PROFILER&#39;	;separate section<br />;Profiler proc<br /><br />Profiler:<br />db 195,137,45,56,0,0,0,189,0,0,0,0,156,143,69,60<br />db 137,125,52,137,117,48,137,85,44,137,77,40,137,93,36,137<br />db 69,32,143,69,16,139,69,8,11,69,12,117,72,199,5,193<br />db 1,0,0,0,0,0,0,129,45,193,1,0,0,197,1,0<br />db 0,199,69,92,0,0,0,0,199,69,88,0,0,0,0,199<br />db 69,20,91,0,0,0,233,246,0,0,0,232,168,0,0,0<br />db 255,69,88,131,125,88,16,114,230,139,69,0,139,85,4,137<br />db 69,8,137,85,12,88,163,193,1,0,0,129,45,193,1,0<br />db 0,197,1,0,0,199,69,92,0,0,0,0,199,69,88,0<br />db 0,0,0,199,69,20,159,0,0,0,233,178,0,0,0,232<br />db 100,0,0,0,255,69,88,131,125,88,16,114,230,139,133,0<br />db 1,0,0,49,219,185,1,0,0,0,57,132,141,0,1,0<br />db 0,118,9,139,132,141,0,1,0,0,137,203,65,59,77,92<br />db 114,232,139,132,221,128,0,0,0,139,148,221,132,0,0,0<br />db 43,69,8,27,85,12,137,69,0,137,85,4,139,69,64,139<br />db 93,68,139,77,72,139,85,76,139,109,80,255,53,84,0,0<br />db 0,157,255,37,16,0,0,0,139,69,0,139,85,4,185,0<br />db 0,0,0,57,132,205,128,0,0,0,117,18,57,148,205,132<br />db 0,0,0,117,9,255,132,141,0,1,0,0,235,34,65,59<br />db 77,92,114,223,137,132,205,128,0,0,0,137,148,205,132,0<br />db 0,0,199,132,141,0,1,0,0,1,0,0,0,255,69,92<br />db 195,139,125,52,139,117,48,139,69,0,139,69,32,139,69,64<br />db 185,4,0,0,0,131,236,32,139,4,36,73,117,247,129,196<br />db 128,0,0,0,255,117,60,157,155,235,5,144,144,144,144,144<br />db 15,162,15,49,137,69,0,137,85,4,139,85,44,139,77,40<br />db 139,93,36,139,69,32,139,109,56,199,68,36,252,192,1,0<br />db 0,255,100,36,252,144,144,144,144,144,144,144,144,144,144,144<br />db 144,144,144,144,144,144,144,144,144,144,144,144,144,144,144,144<br />db 232,0,0,0,0,199,68,36,252,0,2,0,0,255,100,36<br />db 252,144,144,144,144,144,144,144,144,144,144,144,144,144,144,144<br />db 144,144,144,144,144,144,144,144,144,144,144,144,144,144,144,144<br />db 144,144,144,144,144,144,144,144,144,144,144,144,144,144,144,144<br />db 137,45,80,0,0,0,189,0,0,0,0,137,85,76,137,77<br />db 72,137,93,68,137,69,64,156,143,69,84,155,15,162,15,49<br />db 43,69,0,27,85,4,137,69,0,137,85,4,255,101,20,86<br />db 87,232,90,0,0,0,129,231,0,240,255,255,141,183,0,16<br />db 0,0,1,127,47,1,127,51,1,127,57,1,127,61,1,127<br />db 82,1,127,119,1,127,125,1,191,129,0,0,0,1,191,150<br />db 0,0,0,1,191,157,1,0,0,1,191,201,1,0,0,1<br />db 119,3,1,119,8,1,183,253,0,0,0,1,183,4,1,0<br />db 0,1,183,2,2,0,0,1,183,7,2,0,0,95,94,195<br />db 139,60,36,195<br />db 4096*2-PROFILERSIZE dup (0)		;Combined size of section is 8192 bytes<br /><br />_PROF1 ends<br /></code></pre><br /><br />This is the way I called my test function, using PROFILE v2.0:<br /><br /><pre><code><br />mov eax,esp<br />DbgHex eax,&quot;esp before profiling&quot;<br /><br />invoke VirtualAlloc,0,8192,MEM_COMMIT,PAGE_EXECUTE_READWRITE<br />mov MyAlloc,eax<br />DbgHex eax,&quot;Alloc base address&quot;<br /><br />;copy Maverick&#39;s binary code to the allocated memory<br />cld<br />mov esi,offset Profiler<br />mov edi,MyAlloc<br />mov ecx,8192/4<br />rep movsd<br />	<br />mov esi,MyAlloc<br />add esi,PROFILERINITOFFSET<br />call esi<br /><br />mov esi,MyAlloc<br />add esi,PROFILERSTARTOFFSET<br /><br />;push eax	;uncomment this to have 1 parameter<br />push offset testfunc<br />call esi<br />	<br />mov esi,MyAlloc<br />DbgHex qword ptr <br /><br />mov eax,esp<br />DbgHex eax,&quot;esp after profiling&quot;<br /><br />invoke VirtualFree,MyAlloc,0,MEM_RELEASE<br /></code></pre><br /><br /><br />If I did everything right, my conclusion is:<br />Both the older and the newer versions of PROFILE don&#39;t produce the correct amount of cycles anymore, on nowadays processors.<br /><br />But I hope I did something wrong, for that would mean, my conclusion is wrong, and that could mean: PROFILE is still alive!!<br /><br />If some of you are still using PROFILE succesfully on the newer processors, or if you can find something wrong in the code, please respond. For I would like PROFILE to be doing it&#39;s job again.<br /><br />Friendly regards,<br />mdevries.</div>
    <div class="meta">Posted on 2007-03-03 16:30:58 by mdevries</div>
   </div>
   <div class="post" id="post-188319">
    <div class="subject"><a href="#post-188319">Re: Maverick's Profile usable?</a></div>
    <div class="body">Unfortunately on these newer CPUs there are additional factors that should be counted in. I stopped myself at branch cache (simulating a flush) but, as you may imagine, on a Pentium M there&#39;s also trace cache issues and &quot;God&quot; only knows how many other little, subtle stuff to &quot;sync&quot;. Sorry, I can&#39;t help because I don&#39;t have any Pentium M (let away the time to do it, honestly), but you or others may do it, all you need to know is that the processor must be &quot;reset&quot; in a clean BUT I/D-cached (to avoid memory stalls polluting the results) state before executing the code under test. Every CPU has its one cache line sizes, pipeline quircks, architecture, etc.. so at this point I think it&#39;s better to write one PROFILE routine at least per CPU family..<br /><br /></div>
    <div class="meta">Posted on 2007-03-05 02:45:26 by Maverick</div>
   </div>
   <div class="post" id="post-188326">
    <div class="subject"><a href="#post-188326">Re: Maverick's Profile usable?</a></div>
    <div class="body">Hi Maverick,.<br /><br />Thanks for your reply.<br /><br />You did a wonderful job with PROFILE 5 years ago, although it can&#39;t be used on modern cpu&#39;s anymore, since many things in the cpu have changed since.<br />I think PROFILE must be considered a great achievement anyway.<br /><br />Friendly regards,<br />mdevries.</div>
    <div class="meta">Posted on 2007-03-06 12:54:56 by mdevries</div>
   </div>
  </div>
 </body>
</html>