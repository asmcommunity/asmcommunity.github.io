<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>fs:[30h] aka PEB - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=14185" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=14185">fs:[30h] aka PEB</a></p>
   <div class="post" id="post-109646">
    <div class="subject"><a href="#post-109646">fs:[30h] aka PEB</a></div>
    <div class="body">HI! <br />I can't find info about Process Environment Block (PEB).  Any links to infoa or structure are welcome!</div>
    <div class="meta">Posted on 2003-07-08 03:55:27 by ionik</div>
   </div>
   <div class="post" id="post-109670">
    <div class="subject"><a href="#post-109670">fs:[30h] aka PEB</a></div>
    <div class="body"><span style="font-size:small><br /><pre><code><br />&#91;b&#93;Windows 2000&#91;/b&#93;<br /><br />; Process Environment Block &#40;PEB&#41;<br />; located at 7FFDF000h &#40;pointed by fs&#58;&#91;30&#93; in user mode&#41;<br /><br />PEB STRUCT                                                  ; sizeof = 1E8h<br />    InheritedAddressSpace             BYTE         ?        ; 0000h<br />    ReadImageFileExecOptions          BYTE         ?        ; 0001h<br />    BeingDebugged                     BYTE         ?        ; 0002h<br />    SpareBool                         BYTE         ?        ; 0003h<br />    Mutant                            PVOID        ?        ; 0004h<br />    ImageBaseAddress                  PVOID        ?        ; 0008h<br />    Ldr                               PVOID        ?        ; 000Ch PTR PEB_LDR_DATA<br />    ProcessParameters                 PVOID        ?        ; 0010h PTR RTL_USER_PROCESS_PARAMETERS<br />    SubSystemData                     PVOID        ?        ; 0014h<br />    ProcessHeap                       PVOID        ?        ; 0018h<br />    FastPebLock                       PVOID        ?        ; 001Ch<br />    FastPebLockRoutine                PVOID        ?        ; 0020h<br />    FastPebUnlockRoutine              PVOID        ?        ; 0024h<br />    EnvironmentUpdateCount            DWORD        ?        ; 0028h<br />    KernelCallbackTable               PVOID        ?        ; 002Ch<br />    SystemReserved                    DWORD     2 dup&#40;?&#41;    ; 0030h<br />    FreeList                          PVOID        ?        ; 0038h PTR PEB_FREE_BLOCK<br />    TlsExpansionCounter               DWORD        ?        ; 003Ch<br />    TlsBitmap                         PVOID        ?        ; 0040h<br />    TlsBitmapBits                     DWORD     2 dup&#40;?&#41;    ; 0044h<br />    ReadOnlySharedMemoryBase          PVOID        ?        ; 004Ch<br />    ReadOnlySharedMemoryHeap          PVOID        ?        ; 0050h<br />    ReadOnlyStaticServerData          PVOID        ?        ; 0054h<br />    AnsiCodePageData                  PVOID        ?        ; 0058h<br />    OemCodePageData                   PVOID        ?        ; 005Ch<br />    UnicodeCaseTableData              PVOID        ?        ; 0060h<br />    NumberOfProcessors                DWORD        ?        ; 0064h<br />    NtGlobalFlag                      DWORD        ?        ; 0068h<br />                                      DWORD        ?        ; 0064h<br />    CriticalSectionTimeout            LARGE_INTEGER    &lt;&gt;   ; 0070h<br />    HeapSegmentReserve                DWORD        ?        ; 0078h<br />    HeapSegmentCommit                 DWORD        ?        ; 007Ch<br />    HeapDeCommitTotalFreeThreshold    DWORD        ?        ; 0080h<br />    HeapDeCommitFreeBlockThreshold    DWORD        ?        ; 0084h<br />    NumberOfHeaps                     DWORD        ?        ; 0088h<br />    MaximumNumberOfHeaps              DWORD        ?        ; 008Ch<br />    ProcessHeaps                      PVOID        ?        ; 0090h<br />    GdiSharedHandleTable              PVOID        ?        ; 0094h<br />    ProcessStarterHelper              PVOID        ?        ; 0098h<br />    GdiDCAttributeList                DWORD        ?        ; 009Ch<br />    LoaderLock                        PVOID        ?        ; 00A0h<br />    OSMajorVersion                    DWORD        ?        ; 00A4h<br />    OSMinorVersion                    DWORD        ?        ; 00A8h<br />    OSBuildNumber                     WORD         ?        ; 00ACh<br />    OSCSDVersion                      WORD         ?        ; 00AEh<br />    OSPlatformId                      DWORD        ?        ; 00B0h<br />    ImageSubsystem                    DWORD        ?        ; 00B4h<br />    ImageSubsystemMajorVersion        DWORD        ?        ; 00B8h<br />    ImageSubsystemMinorVersion        DWORD        ?        ; 00BCh<br />    ImageProcessAffinityMask          DWORD        ?        ; 00C0h<br />    GdiHandleBuffer                   DWORD    34 dup&#40;?&#41;    ; 00C4h<br />    PostProcessInitRoutine            DWORD        ?        ; 014Ch<br />    TlsExpansionBitmap                PVOID        ?        ; 0150h<br />    TlsExpansionBitmapBits            DWORD    32 dup&#40;?&#41;    ; 0154h<br />    SessionId                         DWORD        ?        ; 01D4h<br />    AppCompatInfo                     PVOID        ?        ; 01D8h<br />    CSDVersion                        UNICODE_STRING    &lt;&gt;  ; 01DCh<br />                                      DWORD        ?        ; 01E4h<br />PEB ENDS<br />PPEB typedef PTR PEB<br /><br /><br /><br /><br /><br /><br />&#91;b&#93;Windows XP&#91;/b&#93;<br /><br />; Process Environment Block &#40;PEB&#41;<br />; located at 7FFDF000h &#40;pointed by fs&#58;&#91;30&#93; in user mode&#41;<br /><br />; ...record field names must be unique...<br />; I named it as PEB_BITS<br />PEB_BITS RECORD \<br />    SpareBits&#58;30,            ; bits 2-31<br />    ExecuteOptions&#58;2         ; bits 0-1<br /><br />PEB STRUCT                                                      ; sizeof = 0210h<br />    InheritedAddressSpace                 BYTE         ?        ; 0000h<br />    ReadImageFileExecOptions              BYTE         ?        ; 0001h<br />    BeingDebugged                         BYTE         ?        ; 0002h<br />    SpareBool                             BYTE         ?        ; 0003h<br />    Mutant                                PVOID        ?        ; 0004h<br />    ImageBaseAddress                      PVOID        ?        ; 0008h<br />    Ldr                                   PVOID        ?        ; 000Ch PTR PEB_LDR_DATA<br />    ProcessParameters                     PVOID        ?        ; 0010h PTR RTL_USER_PROCESS_PARAMETERS<br />    SubSystemData                         PVOID        ?        ; 0014h<br />    ProcessHeap                           PVOID        ?        ; 0018h<br />    FastPebLock                           PVOID        ?        ; 001Ch PTR RTL_CRITICAL_SECTION<br />    FastPebLockRoutine                    PVOID        ?        ; 0020h<br />    FastPebUnlockRoutine                  PVOID        ?        ; 0024h<br />    EnvironmentUpdateCount                DWORD        ?        ; 0028h<br />    KernelCallbackTable                   PVOID        ?        ; 002Ch<br />    SystemReserved                        DWORD     1 dup&#40;?&#41;    ; 0030h<br />    PebBits                               PEB_BITS    &lt;&gt;        ; 0034h named by me<br />    FreeList                              PVOID        ?        ; 0038h PTR PEB_FREE_BLOCK<br />    TlsExpansionCounter                   DWORD        ?        ; 003Ch<br />    TlsBitmap                             PVOID        ?        ; 0040h<br />    TlsBitmapBits                         DWORD     2 dup&#40;?&#41;    ; 0044h<br />    ReadOnlySharedMemoryBase              PVOID        ?        ; 004Ch<br />    ReadOnlySharedMemoryHeap              PVOID        ?        ; 0050h<br />    ReadOnlyStaticServerData              PVOID        ?        ; 0054h<br />    AnsiCodePageData                      PVOID        ?        ; 0058h<br />    OemCodePageData                       PVOID        ?        ; 005Ch<br />    UnicodeCaseTableData                  PVOID        ?        ; 0060h<br />    NumberOfProcessors                    DWORD        ?        ; 0064h<br />    NtGlobalFlag                          DWORD        ?        ; 0068h<br />                                          DWORD        ?        ; 0064h padding<br />    CriticalSectionTimeout                LARGE_INTEGER   &lt;&gt;    ; 0070h<br />    HeapSegmentReserve                    DWORD        ?        ; 0078h<br />    HeapSegmentCommit                     DWORD        ?        ; 007Ch<br />    HeapDeCommitTotalFreeThreshold        DWORD        ?        ; 0080h<br />    HeapDeCommitFreeBlockThreshold        DWORD        ?        ; 0084h<br />    NumberOfHeaps                         DWORD        ?        ; 0088h<br />    MaximumNumberOfHeaps                  DWORD        ?        ; 008Ch<br />    ProcessHeaps                          PVOID        ?        ; 0090h<br />    GdiSharedHandleTable                  PVOID        ?        ; 0094h<br />    ProcessStarterHelper                  PVOID        ?        ; 0098h<br />    GdiDCAttributeList                    DWORD        ?        ; 009Ch<br />    LoaderLock                            PVOID        ?        ; 00A0h<br />    OSMajorVersion                        DWORD        ?        ; 00A4h<br />    OSMinorVersion                        DWORD        ?        ; 00A8h<br />    OSBuildNumber                         WORD         ?        ; 00ACh<br />    OSCSDVersion                          WORD         ?        ; 00AEh<br />    OSPlatformId                          DWORD        ?        ; 00B0h<br />    ImageSubsystem                        DWORD        ?        ; 00B4h<br />    ImageSubsystemMajorVersion            DWORD        ?        ; 00B8h<br />    ImageSubsystemMinorVersion            DWORD        ?        ; 00BCh<br />    ImageProcessAffinityMask              DWORD        ?        ; 00C0h<br />    GdiHandleBuffer                       DWORD    34 dup&#40;?&#41;    ; 00C4h<br />    PostProcessInitRoutine                PVOID        ?        ; 014Ch<br />    TlsExpansionBitmap                    PVOID        ?        ; 0150h<br />    TlsExpansionBitmapBits                DWORD    32 dup&#40;?&#41;    ; 0154h<br />    SessionId                             DWORD        ?        ; 01D4h<br />    AppCompatFlags                        ULARGE_INTEGER  &lt;&gt;    ; 01D8h<br />    AppCompatFlagsUser                    ULARGE_INTEGER  &lt;&gt;    ; 01E0h<br />    pShimData                             PVOID        ?        ; 01E8h<br />    AppCompatInfo                         PVOID        ?        ; 01ECh<br />    CSDVersion                            UNICODE_STRING  &lt;&gt;    ; 01F0h<br />    ActivationContextData                 PVOID        ?        ; 01F8h<br />    ProcessAssemblyStorageMap             PVOID        ?        ; 01FCh<br />    SystemDefaultActivationContextData    PVOID        ?        ; 0200h<br />    SystemAssemblyStorageMap              PVOID        ?        ; 0204h<br />    MinimumStackCommit                    DWORD        ?        ; 0208h<br />                                          DWORD        ?        ; 020Ch padding<br />PEB ENDS<br /><br /><br /><br /><br /><br /><br />&#91;b&#93;Windows 2003&#91;/b&#93;<br /><br />; Process Environment Block &#40;PEB&#41;                                                                   <br />; located at 7FFDF000h &#40;pointed by fs&#58;&#91;30&#93; in user mode&#41;                                            <br /><br />; ...record field names must be unique...<br />; I named it as PEB_BITS<br />PEB_BITS RECORD \<br />            SpareBits&#58;30,            ; bits 2-31<br />            ExecuteOptions&#58;2         ; bits 0-1<br /><br />PEB STRUCT                                                      ; sizeof = 0230h<br />    InheritedAddressSpace                 BYTE         ?        ; 0000h<br />    ReadImageFileExecOptions              BYTE         ?        ; 0001h<br />    BeingDebugged                         BYTE         ?        ; 0002h<br />    SpareBool                             BYTE         ?        ; 0003h<br />    Mutant                                PVOID        ?        ; 0004h<br />    ImageBaseAddress                      PVOID        ?        ; 0008h<br />    Ldr                                   PVOID        ?        ; 000Ch PTR PEB_LDR_DATA<br />    ProcessParameters                     PVOID        ?        ; 0010h PTR RTL_USER_PROCESS_PARAMETERS<br />    SubSystemData                         PVOID        ?        ; 0014h<br />    ProcessHeap                           PVOID        ?        ; 0018h<br />    FastPebLock                           PVOID        ?        ; 001Ch PTR RTL_CRITICAL_SECTION<br />    SparePtr1                             PVOID        ?        ; 0020h<br />    SparePtr2                             PVOID        ?        ; 0024h<br />    EnvironmentUpdateCount                DWORD        ?        ; 0028h<br />    KernelCallbackTable                   PVOID        ?        ; 002Ch<br />    SystemReserved                        DWORD     1 dup&#40;?&#41;    ; 0030h<br />    PebBits                               PEB_BITS    &lt;&gt;        ; 0034h named by me<br />    FreeList                              PVOID        ?        ; 0038h PTR PEB_FREE_BLOCK<br />    TlsExpansionCounter                   DWORD        ?        ; 003Ch<br />    TlsBitmap                             PVOID        ?        ; 0040h<br />    TlsBitmapBits                         DWORD     2 dup&#40;?&#41;    ; 0044h<br />    ReadOnlySharedMemoryBase              PVOID        ?        ; 004Ch<br />    ReadOnlySharedMemoryHeap              PVOID        ?        ; 0050h<br />    ReadOnlyStaticServerData              PVOID        ?        ; 0054h<br />    AnsiCodePageData                      PVOID        ?        ; 0058h<br />    OemCodePageData                       PVOID        ?        ; 005Ch<br />    UnicodeCaseTableData                  PVOID        ?        ; 0060h<br />    NumberOfProcessors                    DWORD        ?        ; 0064h<br />    NtGlobalFlag                          DWORD        ?        ; 0068h<br />                                          DWORD        ?        ; 006Ch padding<br />    CriticalSectionTimeout                LARGE_INTEGER   &lt;&gt;    ; 0070h<br />    HeapSegmentReserve                    DWORD        ?        ; 0078h<br />    HeapSegmentCommit                     DWORD        ?        ; 007Ch<br />    HeapDeCommitTotalFreeThreshold        DWORD        ?        ; 0080h<br />    HeapDeCommitFreeBlockThreshold        DWORD        ?        ; 0084h<br />    NumberOfHeaps                         DWORD        ?        ; 0088h<br />    MaximumNumberOfHeaps                  DWORD        ?        ; 008Ch<br />    ProcessHeaps                          PVOID        ?        ; 0090h<br />    GdiSharedHandleTable                  PVOID        ?        ; 0094h<br />    ProcessStarterHelper                  PVOID        ?        ; 0098h<br />    GdiDCAttributeList                    DWORD        ?        ; 009Ch<br />    LoaderLock                            PVOID        ?        ; 00A0h PTR RTL_CRITICAL_SECTION<br />    OSMajorVersion                        DWORD        ?        ; 00A4h<br />    OSMinorVersion                        DWORD        ?        ; 00A8h<br />    OSBuildNumber                         WORD         ?        ; 00ACh<br />    OSCSDVersion                          WORD         ?        ; 00AEh<br />    OSPlatformId                          DWORD        ?        ; 00B0h<br />    ImageSubsystem                        DWORD        ?        ; 00B4h<br />    ImageSubsystemMajorVersion            DWORD        ?        ; 00B8h<br />    ImageSubsystemMinorVersion            DWORD        ?        ; 00BCh<br />    ImageProcessAffinityMask              DWORD        ?        ; 00C0h<br />    GdiHandleBuffer                       DWORD    34 dup&#40;?&#41;    ; 00C4h<br />    PostProcessInitRoutine                PVOID        ?        ; 014Ch<br />    TlsExpansionBitmap                    PVOID        ?        ; 0150h<br />    TlsExpansionBitmapBits                DWORD    32 dup&#40;?&#41;    ; 0154h<br />    SessionId                             DWORD        ?        ; 01D4h<br />    AppCompatFlags                        ULARGE_INTEGER  &lt;&gt;    ; 01D8h<br />    AppCompatFlagsUser                    ULARGE_INTEGER  &lt;&gt;    ; 01E0h<br />    pShimData                             PVOID        ?        ; 01E8h<br />    AppCompatInfo                         PVOID        ?        ; 01ECh<br />    CSDVersion                            UNICODE_STRING  &lt;&gt;    ; 01F0h<br />    ActivationContextData                 PVOID        ?        ; 01F8h PTR ACTIVATION_CONTEXT_DATA<br />    ProcessAssemblyStorageMap             PVOID        ?        ; 01FCh PTR ASSEMBLY_STORAGE_MAP<br />    SystemDefaultActivationContextData    PVOID        ?        ; 0200h PTR ACTIVATION_CONTEXT_DATA<br />    SystemAssemblyStorageMap              PVOID        ?        ; 0204h PTR ASSEMBLY_STORAGE_MAP<br />    MinimumStackCommit                    DWORD        ?        ; 0208h<br />    FlsCallback                           PVOID        ?        ; 020Ch<br />    FlsListHead                           LIST_ENTRY  &lt;&gt;        ; 0210h<br />    FlsBitmap                             PVOID        ?        ; 0218h<br />    FlsBitmapBits                         DWORD     4 dup&#40;?&#41;    ; 021Ch<br />    FlsHighIndex                          DWORD        ?        ; 022Ch<br />PEB ENDS<br /></code></pre><br /></span><br /><br /><br />You can find a bit more in KmdKit.<br /><a target="_blank" href="http://www.masmforum.com/website/tutorials/kmdtute/index.html">http://www.masmforum.com/website/tutorials/kmdtute/index.html</a></div>
    <div class="meta">Posted on 2003-07-08 11:24:48 by Four-F</div>
   </div>
   <div class="post" id="post-109874">
    <div class="subject"><a href="#post-109874">fs:[30h] aka PEB</a></div>
    <div class="body">2 Four-F<br />??????? ?? ????? ??????? ? ?????? :alright: ?????! ???? ???? ??? ????-???? ???????;) ,  ??????? ???? ??? ????????? Thread Information Block (TIB) (? ??? ?????, ??? ??? NT ??? ??????????: &quot;Thread Environment Block (TEB)&quot;) ??? 9? ? NT (??? ????? ??????????).</div>
    <div class="meta">Posted on 2003-07-09 19:11:51 by ionik</div>
   </div>
   <div class="post" id="post-110019">
    <div class="subject"><a href="#post-110019">fs:[30h] aka PEB</a></div>
    <div class="body">?? ?????? ????? ?????????? ?? wasm.ru.<br /><br />The above structures were fetched from *.pdb files. So I'm 100% sure they are correct. At least for w2k+sp2, wxp+sp1 and w2k3 Release Candidate 2 respectively. But the TEB structure is fully undocumented. There is no one even in m$'s *.pdb files. I have about 5 or 6 different definition that i've found around, but neither is 100% correct, IMHO. You can follow this link <a target="_blank" href="http://www.securitybugware.org/NT/5966.html">http://www.securitybugware.org/NT/5966.html</a><br />The definition you'll find there is very very close to reality, at least under w2k. May be it accurate for some different windows version. I don't know. If you'll manage to get some trusty info, please, let me know.<br /><br />The only things i'm sure is below. The sizeof TEB = 0FA4h under Windows 2000.<br /><br /><pre><code><br />&#91;size=9&#93;<br />NT_TIB STRUCT                                    ; sizeof = 1Ch<br />    ExceptionList                  PVOID    ?    ; PTR EXCEPTION_REGISTRATION_RECORD<br />    StackBase                      PVOID    ?    ; 04h<br />    StackLimit                     PVOID    ?    ; 08h<br />    SubSystemTib                   PVOID    ?    ; 0Ch<br />    union<br />        FiberData                  PVOID    ?    ; 10h<br />        Version                    DWORD    ?    ; 10h<br />    ends<br />    ArbitraryUserPointer           PVOID    ?    ; 14h<br />    Self                           PVOID    ?    ; 18h PTR NT_TIB<br />NT_TIB ENDS<br />PNT_TIB typedef PTR NT_TIB<br /><br />TEB STRUCT<br />    Tib                            NT_TIB       &lt;&gt;      ; 000h<br />    EnvironmentPointer             PVOID        ?       ; 01Ch<br />    Cid                            CLIENT_ID    &lt;&gt;      ; 020h<br />    ActiveRpcInfo                  PVOID        ?       ; 028h<br />    ThreadLocalStoragePointer      PVOID        ?       ; 02Ch<br />    Peb                            PVOID        ?       ; 030h PTR PEB<br />    LastErrorValue                 DWORD        ?       ; 034h<br />    . . . .<br />TEB ENDS<br />PTEB typedef PTR TEB<br />&#91;/size&#93;<br /></code></pre></div>
    <div class="meta">Posted on 2003-07-10 17:24:59 by Four-F</div>
   </div>
  </div>
 </body>
</html>