<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>RegCreateKey hook - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=22745" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=22745">RegCreateKey hook</a></p>
   <div class="post" id="post-170325">
    <div class="subject"><a href="#post-170325">RegCreateKey hook</a></div>
    <div class="body">Hi! How can I hook windows RegCreateKey API?<br />I&#39;v found some example on Keyboard hook but I could not adapt it to win API.<br /><br />What I&#39;m really curious about is to PATCH the windows API.<br /><br />Thanks<br />SoftMan</div>
    <div class="meta">Posted on 2006-03-09 01:58:51 by SoftMan</div>
   </div>
   <div class="post" id="post-170328">
    <div class="subject"><a href="#post-170328">Re: RegCreateKey hook</a></div>
    <div class="body">This post is crossing into a touchy subject. We tend not to discuss hooks that deal with important system processes. You should ask your question on some other forum because I doubt it will be answered here.</div>
    <div class="meta">Posted on 2006-03-09 02:58:58 by SpooK</div>
   </div>
   <div class="post" id="post-170343">
    <div class="subject"><a href="#post-170343">Re: RegCreateKey hook</a></div>
    <div class="body">Well i dont know why we shouldnt discuss Hooks in this forum because microsoft has included the program called &quot;Spy++&quot; in its Visual Studio 6 and it installs all sort of hooks on any window. but anyway ...</div>
    <div class="meta">Posted on 2006-03-09 11:56:56 by XCHG</div>
   </div>
   <div class="post" id="post-170351">
    <div class="subject"><a href="#post-170351">Re: RegCreateKey hook</a></div>
    <div class="body">its dodgy because the information that might be given could be used for other &#39;less legal&#39; reasons.<br />the best advice i can give (hopefully without getting in trouble with a mod) would be to checkout a tool called regmon (which most of us should already know about anyway) from www.sysinternals.com which i think has source code which documents how to apply such a hook, albeit from ring0</div>
    <div class="meta">Posted on 2006-03-09 17:16:47 by evlncrn8</div>
   </div>
   <div class="post" id="post-170354">
    <div class="subject"><a href="#post-170354">Re: RegCreateKey hook</a></div>
    <div class="body">I don&#39;t mind Ring-0 hooks, since anyone in administration of a computer should know what they are installing/doing.</div>
    <div class="meta">Posted on 2006-03-09 19:00:48 by SpooK</div>
   </div>
   <div class="post" id="post-170360">
    <div class="subject"><a href="#post-170360">Re: RegCreateKey hook</a></div>
    <div class="body">I agree with you Spook, a good admin user should know what&#39;s going on in their computer.&nbsp; The methods of Ring-0 hooks and other subversive tactics is an almost prerequisite knowledge nowadays in order to protect ones system.<br /><br />Unfortunately I don&#39;t think there are many discussions on the subject that might not violate the principles this board is trying to uphold.&nbsp; Service Descriptor Table hooks and callgates would seem to fall into the same category as patching API&#39;s.&nbsp; There are few &quot;accepted&quot; ways of programming ring0 hooks.<br /><br />Perhap what should be focussed on then are the &#39;supported&#39; ways of programming, when dealing with &#39;dicey&#39; subjects such as system hooking and the like. Most techniques like SSDT hooking will be a thing of the past anyway (PatchGuard on Windows x64), though no doubt new undocumented techniques will be produced.<br /><br /><br />Along those lines, I can think of only a few &#39;accepted&#39; methods of ring0 hooking, since you brought the subject up.. <br /><br />PsSetCreateProcessNotifyRoutine / PsSetCreateThreadNotifyRoutine is one.&nbsp; The other are the Registry Callback functions MS designed specifically for registry &quot;hooking&quot; for Server 2003, Windows x64, and to a lesser degree XP, - CmRegisterCallback and CmUnRegisterCallback.&nbsp; These are what Regmon uses now for the recent OS&#39;s.&nbsp; I get the funny feeling that MS may be directly acknowledging the relevance of Regmon in doing so, if not to its author itself, in allowing this. (Perhaps to a small degree at least).<br /><br />Looking to the future then in terms of programming methods, I thought that referencing this might be useful enough subject matter, documentation on CmRegisterCallback and CmUnRegisterCallback:<br /><br />http://msdn.microsoft.com/library/default.asp?url=/library/en-us/Kernel_r/hh/Kernel_r/k102_ec214e13-1342-48b5-9a31-8c6c9da57cd6.xml.asp<br /><br />http://msdn.microsoft.com/library/default.asp?url=/library/en-us/Kernel_r/hh/Kernel_r/DrvrRtns_988f8f3d-4ee8-4351-8fc0-703a88bd8421.xml.asp<br /><br /><br />Spook, as administrator of this board, take heart through the stupid server attacks and all the other crap you have to go through. This remains an excellent board and service to all, and I think there are few who don&#39;t honestly appreciate it.<br /><br />Regards,<br />Kayaker</div>
    <div class="meta">Posted on 2006-03-09 20:48:05 by Kayaker</div>
   </div>
   <div class="post" id="post-170370">
    <div class="subject"><a href="#post-170370">Re: RegCreateKey hook</a></div>
    <div class="body">Thank you for the links above.<br /><br />The hooking information is needed, for creating an installation logger software, for security reasons. <br />I&#39;m working as a programmer for a carparts wholesale company. And many unwanted softwares are attacking our system. So I wanna create a software, which logs file create, and registry activities in the background, and also will be able to fully uninstall the unwanted files and created registry entries. There are some commercial, and freeware softwares for this purpose, but I&#39;m not really pleased, and I don&#39;t have a feeling, that I have full control over this processes by this softwares.<br /><br />Thank you again<br />SoftMan<br /><br /><br /></div>
    <div class="meta">Posted on 2006-03-10 01:58:45 by SoftMan</div>
   </div>
   <div class="post" id="post-170411">
    <div class="subject"><a href="#post-170411">Re: RegCreateKey hook</a></div>
    <div class="body">Hi<br /><br />Maybe it can be interesting for others, looking for similar information, than a C source code is downloadable&nbsp; from http://www.sysinternals.com/Utilities/AccessEnum.html where RegistryCallback is used.<br /><br />Softman<br /></div>
    <div class="meta">Posted on 2006-03-11 02:03:08 by SoftMan</div>
   </div>
   <div class="post" id="post-178455">
    <div class="subject"><a href="#post-178455">Re: RegCreateKey hook</a></div>
    <div class="body"><div class="quote"><br />The hooking information is needed, for creating an installation logger software, for security reasons. <br />I&#39;m working as a programmer for a carparts wholesale company.&nbsp; So I wanna create a software, which logs file create, and registry activities in the background, and also will be able to fully uninstall the unwanted files and created registry entries. There are some commercial, and freeware softwares for this purpose, but I&#39;m not really pleased, and I don&#39;t have a feeling, that I have full control over this processes by this softwares.<br /></div><br />You are better off using those applications you are &quot;not happy with&quot;. You have no idea how difficult it is to cover all the areas and methods that trojans, spyware and malware exploit. Don&#39;t reinvent the wheel, use something that is already on the market.<br /><br /><div class="quote"><br />And many unwanted softwares are attacking our system.<br /></div>So do things the proper way: install a firewall, restrict permissions and people&#39;s access to the machine, set up a group policy to not allow software to be installed, prevent employees from surfing for pr0n, etc.</div>
    <div class="meta">Posted on 2006-03-18 03:42:24 by sluggy</div>
   </div>
   <div class="post" id="post-178456">
    <div class="subject"><a href="#post-178456">Re: RegCreateKey hook</a></div>
    <div class="body">It is reasonably straight forward on win2k upwards to create restricted user profiles that directly exclude any software from being installed or from any direct internet access that leaves the computer vulnerable. Keep the admin password unknown and the machine is then reasonably safe from most of what you need to protect it from.<br /><br />Keep the customer data on a seperate partition from the boot partition and keep an up to date disk image of the boot partition and even if someone finds a way to do something stupid you can restore the boot partition in about 5 minutes.<br /><br />Something like an active registry monitor is more likely to be useful at the admin profile level where the BIG mistakes can be made but it would be a mistake to allow normal user levels the access to do anything past what the machine is normally used for as you can end up with all sorts of junk on it that should not be there.<br /><br />Regards,<br /><br />hutch at movsd dot com</div>
    <div class="meta">Posted on 2006-03-18 05:11:53 by hutch--</div>
   </div>
  </div>
 </body>
</html>