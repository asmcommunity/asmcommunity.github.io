<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Very Simple TDI Filter Problem (IRQL_NOT_LESS_OR_EQUAL) - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=21515" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=21515">Very Simple TDI Filter Problem (IRQL_NOT_LESS_OR_EQUAL)</a></p>
   <div class="post" id="post-162482">
    <div class="subject"><a href="#post-162482">Very Simple TDI Filter Problem (IRQL_NOT_LESS_OR_EQUAL)</a></div>
    <div class="body">i have a unknow problem with this very simple TDI hook<br />after a few &quot;TDIDeviceDispatch&quot; i get this... (WinXP) <br /><img src="http://img101.imageshack.us/img101/976/17it1.jpg" /><br /><pre><code>#include &quot;test.h&quot;<br />//::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br />DRIVER_OBJECT&nbsp; &nbsp; &nbsp; g_TDI;<br />//::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br />NTSTATUS TDICompletionRoutine(PDEVICE_OBJECT DeviceObject,PIRP Irp,PVOID Context)<br />{<br />&nbsp;  PIO_COMPLETION_ROUTINE RealCompletionRoutine = (PIO_COMPLETION_ROUTINE)Context;<br />&nbsp;  if(Context != NULL)<br />&nbsp;  {<br />&nbsp; &nbsp; &nbsp; return RealCompletionRoutine(DeviceObject,Irp,NULL);<br />&nbsp;  }else{<br />&nbsp; &nbsp; &nbsp; return STATUS_SUCCESS;<br />&nbsp;  }<br />}<br />//::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br />NTSTATUS TDIDeviceDispatch(IN PDEVICE_OBJECT DeviceObject,IN PIRP Irp)<br />{<br />&nbsp;  NTSTATUS&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  Status;<br />&nbsp;  PIO_STACK_LOCATION&nbsp;  StackLocationPtr;<br />&nbsp;  if(Irp == NULL) return STATUS_SUCCESS;<br />&nbsp;  StackLocationPtr = IoGetCurrentIrpStackLocation(Irp);<br />&nbsp;  if(StackLocationPtr-&gt;CompletionRoutine != NULL)<br />&nbsp;  {<br />&nbsp; &nbsp; &nbsp; StackLocationPtr-&gt;Context = StackLocationPtr-&gt;CompletionRoutine;<br />&nbsp;  }else{<br />&nbsp; &nbsp; &nbsp; StackLocationPtr-&gt;Context = NULL;<br />&nbsp;  }<br />&nbsp;  StackLocationPtr-&gt;CompletionRoutine = (PIO_COMPLETION_ROUTINE)TDICompletionRoutine;<br />&nbsp;  StackLocationPtr-&gt;Control = SL_INVOKE_ON_SUCCESS | SL_INVOKE_ON_ERROR | SL_INVOKE_ON_CANCEL;<br />&nbsp;  Status = g_TDI.MajorFunction(DeviceObject,Irp);<br />&nbsp;  DbgPrint(&quot;TDIDeviceDispatch\n&quot;);<br />&nbsp;  return Status;<br />}<br />//::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br />NTSTATUS HookTDI(void)<br />{<br />&nbsp;  NTSTATUS&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  Status;<br />&nbsp;  UNICODE_STRING&nbsp;  usDriverName;<br />&nbsp;  PDRIVER_OBJECT&nbsp;  DriverObjectToHookPtr;<br />&nbsp;  int&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  i;<br />&nbsp;  RtlInitUnicodeString(&amp;usDriverName,L&quot;\\Driver\\Tcpip&quot;);<br />&nbsp;  Status = ObReferenceObjectByName(&amp;usDriverName,OBJ_CASE_INSENSITIVE,NULL,0,IoDriverObjectType,KernelMode,NULL,&amp;DriverObjectToHookPtr);<br />&nbsp;  if(Status != STATUS_SUCCESS) return Status;<br />&nbsp;  for(i = 0;i &lt; IRP_MJ_MAXIMUM_FUNCTION;i++)<br />&nbsp;  {<br />&nbsp; &nbsp; &nbsp; g_TDI.MajorFunction<em> = DriverObjectToHookPtr-&gt;MajorFunction<em>;<br />&nbsp; &nbsp; &nbsp; DriverObjectToHookPtr-&gt;MajorFunction<em> = TDIDeviceDispatch;<br />&nbsp;  }<br />&nbsp;  return STATUS_SUCCESS;<br />}<br />//::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br />NTSTATUS UnHookTDI(void)<br />{<br />&nbsp;  NTSTATUS Status;<br />&nbsp;  UNICODE_STRING usDriverName;<br />&nbsp;  PDRIVER_OBJECT DriverObjectToHookPtr;<br />&nbsp;  int i;<br />&nbsp;  RtlInitUnicodeString(&amp;usDriverName,L&quot;\\Driver\\Tcpip&quot;);<br />&nbsp;  Status = ObReferenceObjectByName(&amp;usDriverName,OBJ_CASE_INSENSITIVE,NULL,0,IoDriverObjectType,KernelMode,NULL,&amp;DriverObjectToHookPtr);<br />&nbsp;  if(Status != STATUS_SUCCESS) return Status;<br />&nbsp;  for(i = 0;i &lt; IRP_MJ_MAXIMUM_FUNCTION;i++)<br />&nbsp; &nbsp; &nbsp; DriverObjectToHookPtr-&gt;MajorFunction<em> = g_TDI.MajorFunction<em>;<br />&nbsp;  return STATUS_SUCCESS;<br />}<br />//::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br />VOID OnUnload(PDRIVER_OBJECT DriverObject)<br />{<br />&nbsp;  UnHookTDI();<br />&nbsp;  DbgPrint(&quot;OnUnload\n&quot;);<br />}<br />//::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br />NTSTATUS ForwardAndForget(PDEVICE_OBJECT DeviceObject,PIRP Irp)<br />{<br />&nbsp;  Irp-&gt;IoStatus.Status = STATUS_SUCCESS;<br />&nbsp;  IoCompleteRequest(Irp, IO_NO_INCREMENT);<br />&nbsp;  return Irp-&gt;IoStatus.Status;<br />}<br />//::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br />NTSTATUS DriverEntry(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)<br />{<br />&nbsp;  int&nbsp;  i;<br />&nbsp;  for (i = 0; i &lt; IRP_MJ_MAXIMUM_FUNCTION; i++)<br />&nbsp; &nbsp; &nbsp; DriverObject-&gt;MajorFunction<em> = ForwardAndForget;<br />&nbsp;  DriverObject-&gt;DriverUnload&nbsp; = OnUnload;<br />&nbsp;  DbgPrint(&quot;DriverEntry\n&quot;);<br />&nbsp;  return HookTDI();<br />}<br />//:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: </code></pre></div>
    <div class="meta">Posted on 2005-07-26 03:38:22 by Criminal2</div>
   </div>
   <div class="post" id="post-162487">
    <div class="subject"><a href="#post-162487">Re: Very Simple TDI Filter Problem (IRQL_NOT_LESS_OR_EQUAL)</a></div>
    <div class="body">Hi!<br /><br />The Bug Check code is 0x0A<br /><br />&quot;The IRQL_NOT_LESS_OR_EQUAL bug check has a value of 0x0000000A. <br />This indicates that Windows or a kernel-mode driver accessed paged memory at <strong><em>DISPATCH_LEVEL or above</em></strong>.<br /><br />Parameters<br />The following parameters are displayed on the blue screen.<br /><br /><span class="mono">---------------------------------------<br />Parameter Description <br />---------------------------------------<br />1&nbsp; -&nbsp; Memory referenced <br />2&nbsp; -&nbsp; IRQL at time of reference <br />3&nbsp; -&nbsp; 0: Read <br />&nbsp; &nbsp; &nbsp; 1: Write<br />4&nbsp; -&nbsp; Address which referenced memory<br />---------------------------------------&quot;</span><br /><br />Use some kernel mode debugger and see what instruction is at 0x804efcdc.<br /><br />And don&#39;t forget to use the <strong>ObDereferenceObject</strong> function if you use the<br /><strong>ObReferenceObjectByName</strong> function.<br /><br /><br />Good luck&nbsp; :D<br /><br />Regards,<br />Opc0de</div>
    <div class="meta">Posted on 2005-07-26 10:26:52 by Opcode</div>
   </div>
   <div class="post" id="post-162488">
    <div class="subject"><a href="#post-162488">Re: Very Simple TDI Filter Problem (IRQL_NOT_LESS_OR_EQUAL)</a></div>
    <div class="body"><div class="quote"><br />And don&#39;t forget to use the <strong>ObDereferenceObject</strong> function if you use the<br /><strong>ObReferenceObjectByName</strong> function.<br />Good luck&nbsp; :D<br /></div><br />i didn&#39;t see that :)<br />Thank you very much</div>
    <div class="meta">Posted on 2005-07-26 13:32:47 by Criminal2</div>
   </div>
  </div>
 </body>
</html>