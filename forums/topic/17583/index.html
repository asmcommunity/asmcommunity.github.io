<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>blasphemous questions about VM's - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=17583" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=17583">blasphemous questions about VM's</a></p>
   <div class="post" id="post-135996">
    <div class="subject"><a href="#post-135996">blasphemous questions about VM's</a></div>
    <div class="body">Alright, I'm considering coding a scripting language - do I want to code a VM, or do I want to have built-in functions which do the same things, and what are the advantages/disadvantages?<br /><br /><br />Here is my design so far (before I get further into a hole with it):<br /><br />R1 thru R15  (15 registers (32-bit), each will be on the stack for manipulation purposes)<br />IP - Instruction Pointer<br />SP - Stack Pointer  (15 dword + = actual location in cpu stack)<br />RL1 thru RL8 (8 floating point registers for use in FPU (REAL4 size))<br />FL1 thru FL8  (8 floating point registers for use in FPU (REAL8 size))<br />eax thru edx (direct access registers (DARs) but using within scripting could be inefficient with all the <br />pushing/popping/stack fixing)<br /><br />simple instructions:<br />push/ad/adq/pop/ad/adq<br />mov<br /><br />1) what are advantages or disadvantages of using a VM vs function calls that do the same thing, I guess if there is no organization the project could blow up into bloatware.<br /><br />2) why not use the cpu's registers and stack - is it to protect the cpu from myself?<br /><br />3) something such as:<br /><br />:LoadBitmap 0,&quot;test1.bmp&quot;;<br /><br />it would call the win32api function LoadBitmap in the function and copy the value from eax to the VM's eax equivalent R1... probably do ten things within this one function, is this the basic idea I want to have?<br /><br />Thanks.</div>
    <div class="meta">Posted on 2004-03-15 12:37:12 by drarem</div>
   </div>
   <div class="post" id="post-136035">
    <div class="subject"><a href="#post-136035">blasphemous questions about VM's</a></div>
    <div class="body">#1.<br /><br />The main advantage of function calls is speed. You avoid the cost of decoding every instruction. Threaded code can give you the flexibility of a VM, but not necessarily in the most compact form. <br /><br />The main advantage of VM is portability and flexibility. You can make the instruction set as simple, complex, or compact as you want. You end up building a new VM interpreter, or a new VM-to-machine-code translator, for every new processor you want running your script.<br /><br />Ease of code generation is generally a highly desirable goal for VMs.<br /><br />#2.<br /><br />If portability is a concern, mixing the CPU and VM stack is not a good idea. The target processor might have a different stack model, or you may need to implement the VM with a high level language on the target platform.<br /><br />Otherwise, it's a matter of how simple or complex you want your stack model to be.<br /><br />#3.<br /><br />For a scripting language, you probably want to emphasize ease of code generation, and the encoding of often-used complex tasks. For example, Perl has embedded within it a regular expression processor and an association table handler. PHP adds security features to that mix. VB hides the message loop and provides an event-oriented interface for windowing applications.</div>
    <div class="meta">Posted on 2004-03-15 18:30:42 by tenkey</div>
   </div>
   <div class="post" id="post-136194">
    <div class="subject"><a href="#post-136194">blasphemous questions about VM's</a></div>
    <div class="body">One more question.. I'm trying to initialize a structure, and I keep getting 'line too long' error - is there a way around this?  I tried enclosing each line in '&lt;&gt;' but it didn't help.  I could make one init function but this would be easier for me to maintain.<br /><br /><pre><code><br />.data<br />VPU struct<br />    X1 dd 0<br />    S1 db 8 dup&#40;0&#41;<br />    V1 dd 0<br />VPU ends<br /><br />VPU CHANKWARE                      &lt;&#123; offset VMmov,    'mov', ID &#125;&gt;,<br />			  &lt;&#123; offset VMlea,    'lea', ID &#125;&gt;,<br />			  &lt;&#123; offset VMpush,   'push', ID &#125;&gt;,<br />			  &lt;&#123; offset VMpop,    'pop', ID &#125;&gt;,<br />			  &lt;&#123; offset VMpushaq, 'pushaq', ID &#125;&gt;,<br />			  &lt;&#123; offset VMpopaq,  'popaq', ID &#125;&gt;,<br />			  &lt;&#123; offset VMjmp, 	 'jmp', ID &#125;&gt;,<br />			  &lt;&#123; offset VMjle, 	 'jle', ID &#125;&gt;,<br />			  &lt;&#123; offset VMjge, 	 'jge', ID &#125;&gt;,<br />			  &lt;&#123; offset VMjl,  	 'jl', ID &#125;&gt;,<br />			  &lt;&#123; offset VMjg,  	 'jg', ID &#125;&gt;,<br />			  &lt;&#123; offset VMje,  	 'je', ID &#125;&gt;, <br />			  &lt;&#123; offset VMrol, 	 'rol', ID &#125;&gt;, <br />			  &lt;&#123; offset VMror, 	 'ror', ID &#125;&gt;, <br />			  &lt;&#123; offset VMshl, 	 'shl', ID &#125;&gt;,<br />			  &lt;&#123; offset VMshr, 	 'shr', ID &#125;&gt;<br /></code></pre></div>
    <div class="meta">Posted on 2004-03-17 08:10:23 by drarem</div>
   </div>
   <div class="post" id="post-136202">
    <div class="subject"><a href="#post-136202">blasphemous questions about VM's</a></div>
    <div class="body">One of MASM's silly limitations... try this:<br /><pre><code><br />CHANKWARE	VPU	&lt;offset VMmov,    'mov', ID&gt;<br />			VPU	&lt; offset VMlea,    'lea', ID &gt;<br />			VPU	&lt; offset VMpush,   'push', ID &gt;<br />			VPU	&lt; offset VMpop,    'pop', ID &gt;<br />...<br /></code></pre></div>
    <div class="meta">Posted on 2004-03-17 09:13:37 by f0dder</div>
   </div>
   <div class="post" id="post-136224">
    <div class="subject"><a href="#post-136224">blasphemous questions about VM's</a></div>
    <div class="body">i would recomend that you study and understand the FORTH VM, it is a little ODD but it has tremendouse power and hase the source code (compared to Java)<br /><br />The VM core is only 3-8  ASM intructions long (but i can take a long time until ou understand how those 8 instructions are working :D<br /><br />The VM only has 3-4 registers max: IP, SP, RP and sometimes a an extra scratch register, but theoretically it can run with only IP and SP . I bet it can be implemented in days/hours on every new CPU.<br /><br />Using the VM core and those 3 registers the first 8-30 instructions have to be primitives (aka they need to be implemented in ASM or native language on target CPU all the rest of FORTH is also written in FORTH (macro) ...<br /><br />So even if i detect some forthish style in your : (collon) definition... you obviousely do not get it right since you want to implement so many registers into your VM.<br /><br />Simplify! because the VM has deepth on its own ... no need to emulate a full CPU or elese you will create a VMvare like emulator and not a Virtual Machine.</div>
    <div class="meta">Posted on 2004-03-17 13:03:11 by BogdanOntanu</div>
   </div>
   <div class="post" id="post-136242">
    <div class="subject"><a href="#post-136242">blasphemous questions about VM's</a></div>
    <div class="body">Ask yourself what you are building and why. A VM for a scripting language - but for what purpose? This will affect the VM itself, but even more the functionality you implement as host code (a &quot;shell utility&quot; scripting language needs different stuff than a 3D game scripting language).<br /><br />Keep it relatively simple. Your current stuff is starting to look a bit like an x86 spinoff... you might consider using DLLs with native code instead, it'll be even more flexible and run faster :) - keep the VM relatively simple, and have a look at some other architectures than x86.<br /><br />Also, decide whether you need a &quot;VM&quot; or a &quot;CPU&quot;. The border between the two is sorta vague, and even stuff that most people certainly see as &quot;pure VM&quot; like java or .net could be implemented as native CPUs.<br /><br />Keeping things simple does <strong>not</strong> necessarily mean a instruction set with very simple instructions. If you want any kind of performance from a virtual machine, you'll want to have it relatively abstract/highlevel, with &quot;longer&quot; functions that can be implemented efficiently on the native machine. This also gives things like JITters a lot more playroom.<br /><br />Ie, it would be more useful to have a strlen &quot;instruction&quot; in the VM and implement it with fast native code, than implementing it with simple VM instructions. This sounds like almost the complete opposite of forth? Anyway, it will keep the VM programs less bloated &amp; faster, at the expense of a larger runtime... but ideally (for a &quot;real life&quot; VM) the combined size of all programs should end up quite larger than runtime size, and if the programs have smaller size and larger performance - well, I can live with a somewhat larger runtime.<br /><br />Ohyeah, you'll also have to consider how you want to program the VM. In VM-assembly, or rather through a highlevel/scripting language that gets compiled to VM bytecode? Would you be familiar with a purely stack-based VM, pure registers, or a mix? And what would be efficient for a compiler?<br /><br /><div class="quote"><br />hase the source code (compared to Java)<br /></div><br />Isn't the full specs available for Java? At least enough to do a java-&gt;bytecode compiler, which should be quite some help when implementing it. Plus opensource java compilers, and what do I know.</div>
    <div class="meta">Posted on 2004-03-17 18:28:28 by f0dder</div>
   </div>
  </div>
 </body>
</html>