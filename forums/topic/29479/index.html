<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Hooking DLLs - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=29479" />
    <link rel="next" href="../?id=29479&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=113">Low Level Concepts</a> &raquo; <a href="../?id=29479">Hooking DLLs</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=29479&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=29479&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="29479" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=29479&amp;page=2">&gt;</a><a href="../?id=29479&amp;page=2">&raquo;</a></form>   <div class="post" id="post-208198">
    <div class="subject"><a href="#post-208198">Hooking DLLs</a></div>
    <div class="body">That got your attention, didn&#039;t it? First post, too.<br /><br />I have a serious, and legitimate reason to be wanting to do this. Please excuse me whilst I evade telling you exactly why I want to do this, except to say it is for a commercial security product that will be on sale to the general public (eventually).<br /><br />I have been tasked with developing a piece of security software. The more recognized and official methods as proscribed by Microsoft themselves seems to be open to easy circumvention/tampering. Not ideal.<br /><br />What I ultimately want to do is write a driver that does this, to make access to it from Userland that bit harder, but as I&#039;m still on a steep learning curve with MASM (I gave up on C++ - just can&#039;t get on with it), I wanted to try the things I need seperately first, to see how they work, and get them working, before I lump them all together.<br /><br />I&#039;ve already been suspected of being a hacker on another forum. I can assure you I am not, and if the site admin wishes further evidence of who I am, and that I am indeed legitimate, they are free to PM me. What I will not do is post such details in public.<br /><br />Now I&#039;ve got that out the way, I wish to also employ other techniques used by viruses/malware/whatever to mask themselves. I would also like to employ anti-debugging techniques, but for now, these are beyond the scope of my capabilities, and I have no interest in them right now.<br /><br />That is where I am, and where I want to head.<br /><br />First up, I would like a bit of help in learning how to write a DLL stub to intercept calls, or inject code into a process to do the same.<br /><br />I appreciate this is heavy for a first post, and that people in the assembly programming world seem reluctant to discuss anything that could be mis-used, but I could say the same thing about the delete key. Perfectly innocent, until pointed at NTLDR.<br /><br />Apologies for the tone of the post, but I need help, and so far I keep being treated like I&#039;m a 13 year old script kiddy. I&#039;m actually a 27 year old programmer and director of a UK company. I&#039;ll say no more about myself than that.<br /><br />Forum rules aside, there are very real laws on hacking etc.. I have no intention of doing that. I want to perform a specific task, but in such a way as to make it very difficult for it to be attacked or circumvented by people far better than I.<br /><br />I tried the gently gently approach on another forum - I&#039;m going direct here. Hopefully I can find the help I&#039;m looking for. :)<br /><br />Thanks in advance.<br />Astro.</div>
    <div class="meta">Posted on 2009-07-17 19:38:41 by Astro</div>
   </div>
   <div class="post" id="post-208199">
    <div class="subject"><a href="#post-208199">Re: Hooking DLLs</a></div>
    <div class="body">I found this which also looks interesting:<br /><br />http://www.codeproject.com/KB/system/soviet_protector.aspx<br /><br />Astro.</div>
    <div class="meta">Posted on 2009-07-17 19:55:49 by Astro</div>
   </div>
   <div class="post" id="post-208200">
    <div class="subject"><a href="#post-208200">Re: Hooking DLLs</a></div>
    <div class="body"><a target="_blank" href="http://www.woodmann.com/forum/">Woodmann&#039;s Forum</a> will probably be a more appropriate place for your endeavors, all around.</div>
    <div class="meta">Posted on 2009-07-17 22:41:24 by SpooK</div>
   </div>
   <div class="post" id="post-208205">
    <div class="subject"><a href="#post-208205">Re: Hooking DLLs</a></div>
    <div class="body">You say you&#039;ve been tasked with writing security software, but have given up on C++ and have a very steep ASM learning curve ahead of you. Sorry if this sounds rude, but are you sure you haven&#039;t bitten off more than you can chew?</div>
    <div class="meta">Posted on 2009-07-18 08:38:12 by f0dder</div>
   </div>
   <div class="post" id="post-208206">
    <div class="subject"><a href="#post-208206">Re: Hooking DLLs</a></div>
    <div class="body">Depends how you look at it.<br /><br />I think no, because I&#039;m the kind of person who will work through problems to a solution. I haven&#039;t been tasked with this and must have results 3 weeks from now. We&#039;re very much in the R&amp;D stage, and this is part of that.<br /><br />I&#039;m not going into this entirely cold; my two big problems are:<br /><br />1) MASM syntax (I&#039;m getting there quite quickly with it - I&#039;ve already created a small Windows UI progmatically which is further than I ever got with C++!!!!)<br />2) Finding my way around Windows from this angle<br /><br />I&#039;ve already written a small piece of code in C++, but I was getting stuck with some of the more advanced stuff. I couldn&#039;t crack USB enumeration for example (3 months later and still no further on). I&#039;m just about there with it in ASM - not bad considering I started on this 6 days ago.<br /><br />So, I&#039;m progresssing really quite quickly I think. :)<br /><br />I&#039;m still researching techniques, but now I&#039;m at a point where I need to start writing some code, and this is where I&#039;m getting a bit stuck.<br /><br />I found a few things here last night that were very helpful in your tutorials section. Great work! &nbsp;8)<br /><br />I also intend to keep learning assembly beyond this project. Whilst it is a not-so-basic project to start off with, it is currently solving a lot of my problems. &nbsp;8) &nbsp;I&#039;m very pleased with progress so far.<br /><br />EDIT: I just had a look at the site you linked to - that is NOT what I want to do thanks. I don&#039;t wish to crack or reverse-engineer anything. The part of Windows I wish to hook is already well documented by MS from the point of view of altering its behavior. I just want to do it slightly non-standard.<br /><br />If I mention MS GINA, I hope you guys won&#039;t run away like they did on the other forum. &nbsp;:sad:<br /><br />MS suggest writing a stub .DLL, adding your own code where desired, and forwarding requests where you&#039;re not interested. They then suggest making 1 alteration to the registry to get Windows to load your stub, and not their GINA, and you&#039;re done, but knowing that makes it sound a little too easy to circumvent. Not what we want really.<br /><br />I&#039;m quite happy with the Win32 API - no probs there - but it&#039;s the &quot;small&quot; details like determining offsets for things - I just can&#039;t quite &quot;see&quot; how it works yet. I keep reading code and get a feel for it, but I feel a bit like trying to use a torch in room painted black at the moment. &nbsp;:) &nbsp;Take for example copying 4 bytes from one memory loocation to a buffer - it would appear you can do this in one instruction, but I can&#039;t quite see how that works.<br /><br />I happy with this for example:<br /><br /><pre><code>.486<br />.model flat,stdcall<br />option casemap:none<br /><br />include \masm32\include\kernel32.inc<br />include \masm32\include\masm32.inc<br /><br />includelib \masm32\lib\kernel32.lib<br />includelib \masm32\lib\masm32.lib<br /><br />.data?<br /><br />t db ?<br />t2 db ?<br />temp dword ?<br /><br />.code<br /><br />s db &quot; : Test1&quot;,10,13,0<br />s2 db &quot; : Test2&quot;,0<br /><br />	start:<br />;===========================================================<br />		lea eax,s						; get address of s<br />		push eax						; push address of s to stack<br /><br />		mov temp,eax					; store address of s in temp<br />		lea eax,t						; get address of t<br />		push eax 						; push address of t - udw2str will write here<br />		push temp 						; push temp to stack<br /><br />		call dw2hex						; convert dword to hex string<br /><br />		lea eax,t 						; get address of t<br />		push eax 						; push to stack<br /><br />		call StdOut 					; print address of s2<br />		call StdOut 					; print s2<br />;===========================================================<br />		lea eax,s2						; get address of s<br />		push eax						; push address of s to stack<br /><br />		mov temp,eax					; store address of s in temp<br />		lea eax,t2						; get address of t<br />		push eax 						; push address of t - udw2str will write here<br />		push temp 						; push temp to stack<br /><br />		call dw2hex						; convert dword to hex string<br /><br />		lea eax,t2 						; get address of t<br />		push eax 						; push to stack<br /><br />		call StdOut 					; print address of s<br />		call StdOut 					; print s<br />;===========================================================<br />		ret<br />	end start<br /></code></pre><br /><br />I wrote that myself to get the address of the strings in memory. The main point of the excercise was to get used to the stack, and that things need to be ordered. I&#039;m also happy with the &quot;balanccing the stack&quot;, too, if I add or remove something then return, I need to update the stack pointer.<br /><br /><div class="quote">but have given up on C++</div><br />Yes. I just can&#039;t get on with it. I had too many questions that weren&#039;t being answered to my satisfaction. Assembler answered them all within about 30 minutes, and it makes a whole lot more sense to me in general. I really wish I got into x86 assembler sooner (years sooner).<br /><br />Astro.</div>
    <div class="meta">Posted on 2009-07-18 09:00:26 by Astro</div>
   </div>
   <div class="post" id="post-208207">
    <div class="subject"><a href="#post-208207">Re: Hooking DLLs</a></div>
    <div class="body">Hi,<br /><br />I think I mis-understood you when you posted your link. Sorry.<br /><br />(Some ;) ) of what is over there is stuff I&#039;ll be interested in eventually, but for now I&#039;m just looking for more basic things. :)<br /><br />Best regards,<br />Astro.</div>
    <div class="meta">Posted on 2009-07-18 13:05:09 by Astro</div>
   </div>
   <div class="post" id="post-208211">
    <div class="subject"><a href="#post-208211">Re: Hooking DLLs</a></div>
    <div class="body"><div class="quote"><br />Hi,<br /><br />I think I mis-understood you when you posted your link. Sorry.<br /><br />(Some ;) ) of what is over there is stuff I&#039;ll be interested in eventually, but for now I&#039;m just looking for more basic things. :)<br /><br />Best regards,<br />Astro.<br /></div><br /><br />Yeah, it was more like &quot;these&quot; people can help you find all the ways of doing &quot;things&quot; so that you are more prepared for the task at hand. Also, you can bounce ideas off of them to and even have them try to circumvent your efforts to see where you really stand.</div>
    <div class="meta">Posted on 2009-07-18 21:20:46 by SpooK</div>
   </div>
   <div class="post" id="post-208220">
    <div class="subject"><a href="#post-208220">Re: Hooking DLLs</a></div>
    <div class="body">My apologies again, and thank you.&nbsp; 8)<br /><br />Best regards,<br />Astro.</div>
    <div class="meta">Posted on 2009-07-19 19:09:39 by Astro</div>
   </div>
   <div class="post" id="post-208245">
    <div class="subject"><a href="#post-208245">Re: Hooking DLLs</a></div>
    <div class="body">&quot;That got your attention, didn&#039;t it? First post, too&quot;<br /><br />I&#039;m all ears... &nbsp; Thanks for the intel Astro.</div>
    <div class="meta">Posted on 2009-07-22 17:17:30 by losser</div>
   </div>
   <div class="post" id="post-208246">
    <div class="subject"><a href="#post-208246">Re: Hooking DLLs</a></div>
    <div class="body">As for a stub dll, take an example c:\windows\system32\url.dll<br /><br />If you wanted to hook this dll with a stub dll you would write a dll with the following functions named exactly and with the following prototypes:<br /><pre><code>AddMIMEFileTypesPS PROTO :DWORD,:DWORD<br />InetIsOffline PROTO :DWORD<br />MIMEAssociationDialogA PROTO :DWORD,:DWORD,:DWORD,:DWORD,:DWORD,:DWORD<br />MIMEAssociationDialog equ &lt;MIMEAssociationDialogA&gt;<br /><br />MIMEAssociationDialogW PROTO :DWORD,:DWORD,:DWORD,:DWORD,:DWORD,:DWORD<br />SetInetOffline PROTO :DWORD<br />TranslateURLA PROTO :DWORD,:DWORD,:DWORD<br />TranslateURL equ &lt;TranslateURLA&gt;<br /><br />TranslateURLW PROTO :DWORD,:DWORD,:DWORD<br />URLAssociationDialogA PROTO :DWORD,:DWORD,:DWORD,:DWORD,:DWORD,:DWORD<br />URLAssociationDialog equ &lt;URLAssociationDialogA&gt;<br /><br />URLAssociationDialogW PROTO :DWORD,:DWORD,:DWORD,:DWORD,:DWORD,:DWORD</code></pre><br /><br />Your dllmain function would call LoadLibrary on the full path to &quot;C:\windows\system32\url.dll&quot; and GetProcAddress on each of the previously named functions and store them into a call table.<br /><br />Then taking TranslateURLA for example:<br /><pre><code>TranslateURL proc pcszURL:DWORD, wInFlags:DWORD, ppszTranslatedURL:DWORD<br />pushad ;save registers<br />;do our code before calling the function<br />popad ;restore registers<br />push ppszTranslatedURL ;pass the same (or changed) variables<br />push wInFlags<br />push pcszURL<br />mov eax, CallTable ;lookup the real functions address<br />call eax ;call the REAL function<br />pushad ;save the registers again<br />;do our code before returning (such as editing the url)<br />popad<br />ret<br />TranslatedURLA endp</code></pre><br /><br />The DLL you create MUST contain EVERY function in the original dll. Even if they are simple wrappers with no pre/post processing. The outputed dll must be named &quot;url.dll&quot; And placed in the same directory as the target program (so it loads first before looking in C:\windows\system32&quot;). As you can see, having to create wrapper dll&#039;s for every dll you want to hook is going to take a long time, and then you would have to either copy all the originals from their original location to your backup folder and keep track of them there, or place your files in every directory... Not a good choice for your rootkit. (I use the term rootkit because just as you assume everyone will think you are a hacker, the term rootkit is not always bad. Any decent anti-virus software is a rootkit.)<br /><br />3 weeks to develop this software is definitely biting off more than you can chew. I would say in 3 weeks, you could start understanding the basics behind win32asm. Another month for figuring out the very basics of driver design. And another year of R&amp;D and crashing computers or emulators testing your driver/ program. This is assuming you work on it full time and are above average with picking up programming. Due to the fact that you have no history with programming concepts, I would say it will take you a bit longer. This is my honest opinion. I like people picking up programming (especially asm) however, large projects always make people new to programming lose interest and give up.</div>
    <div class="meta">Posted on 2009-07-23 02:46:02 by jakor</div>
   </div>
   <div class="post" id="post-208247">
    <div class="subject"><a href="#post-208247">Re: Hooking DLLs</a></div>
    <div class="body"><strong>jakor</strong>: it&#039;s wrong calling something non-malicious a rootkit. It might use rootkit-like <em>techniques</em> to hide/protect itself, but the word rootkit is really loaded with malicious intent.<br /><br />Writing a shimmy DLL is a pretty bad solution, since you need to forward all functions, not just the ones you need... and sometimes additional functions are added to DLLs. A better approach is to use detours or your own hooking library :)</div>
    <div class="meta">Posted on 2009-07-23 03:13:13 by f0dder</div>
   </div>
   <div class="post" id="post-208248">
    <div class="subject"><a href="#post-208248">Re: Hooking DLLs</a></div>
    <div class="body">Sony had no malicious intentions, only protecting their own software...<br />http://en.wikipedia.org/wiki/Sony_BMG_CD_copy_protection_scandal<br /><br />Realistically, a rootkit could be considered anything which adds an artificial intelligence layer between the computer and user filtering  bad output. It&#039;s the filter which would be malicious, not the implementation. (Of course this is how I see it, and I do understand where you are coming from...)<br /><br />And politically correct, hacker != cracker. We only use these terms so that others can understand what we are saying.<br /><br />(since emotion cannot be reflected in text: I do no mean to drag out an arguement over this, I am only explaining my reasoning behind my terms/post)</div>
    <div class="meta">Posted on 2009-07-23 04:36:01 by jakor</div>
   </div>
   <div class="post" id="post-208249">
    <div class="subject"><a href="#post-208249">Re: Hooking DLLs</a></div>
    <div class="body">If this is going to be a commercial security product I suggest freelancing out the design to someone probably better experienced with this kind of work.<br /><br />That being said, almost any hooking mechanisms can be circumvented unless you explicitly hook the routines used for memory modification and insert checks to prevent modifying the hooks code space. Since what you are looking for is REALLY bordering the sites rules, but the LLC board was designed for things which bordered the rules as we used to be a bit ban-happy with these kinds of questions, I&#039;m not going to get too specific with this.<br /><br />If it was me, I wouldn&#039;t take the approach of hooking the system DLLs. Any malware which gets run on the system post installation of your &quot;security product&quot; will be able to hijack your code by either hooking kernel API&#039;s or your code itself. This means to protect your tool you will need to monitor/hook all memory access routines to check for access to your &quot;security product&quot;. So not only are you hooking the API&#039;s you need for your &quot;security product&quot; to work, you&#039;re also having to hook Mm* routines.<br /><br />What I would do is create a custom interrupt which contains all of my routines then patch the windows IDT to forward specific calls to my interrupt, then finally patching the NMI to protect the current state of the IDT table from modification. It would also be a good idea to have a driver check the NMI state to ensure it hasn&#039;t been re-patched by any other software (a lot of viruses will target the NMI). This method is preferred, imho, because the only checkups you will be preforming are done to ensure the NMI doesn&#039;t get modified and the NMI patch which prevents the IDT from being changed. It would also be a pretty decent idea, just as a secondary precaution, to prevent DeviceIoControl from using IOCTL_*_INT and/or hook CreateFile and return error if the the first argument is &quot;\\.\InterruptHook&quot;. IMHO this method is much better than hooking a bunch of memory functions to check for addresses or setting up flimsy EAT/IAT patches of resident DLLs.<br /><br />Downside to this method is that it kills of support for other applications having access to update the IDT, which is popular in things like SoftICE. Though you could always set those applications to be loaded before your &quot;security product&quot;.<br /><br />Coding it won&#039;t be easy, which is why I suggested freelancing the work out to seasoned system software developers. At any rate, there is a big difference between writing a Windows UI &quot;Hello, World&quot; and creating system drivers/modules that patch system critical interfaces. With kernel memory, one miscalculated address or unchecked arithmetic instruction and your user is looking at a blue screen.<br /><br /><div class="quote">3 weeks to develop this software is definitely biting off more than you can chew. I would say in 3 weeks, you could start understanding the basics behind win32asm. Another month for figuring out the very basics of driver design. And another year of R&amp;D and crashing computers or emulators testing your driver/ program. This is assuming you work on it full time and are above average with picking up programming. Due to the fact that you have no history with programming concepts, I would say it will take you a bit longer. This is my honest opinion. I like people picking up programming (especially asm) however, large projects always make people new to programming lose interest and give up.</div><br /><br />I really gotta say I agree with this statement in this context. I helped a young associate of mine, who actually did have past programming experience, learn to develop system software with MASM and it took him about 2 days to work his way up to basic services but 6 months to finally get to where he could write drivers without killing his PC on a regular basis.<br /><br />None-the-less, good luck with your project and I hope you drop back in 3 weeks from now to let us know how it turned out.<br /><br />Regards,<br />Bryant Keller</div>
    <div class="meta">Posted on 2009-07-23 05:14:11 by Synfire</div>
   </div>
   <div class="post" id="post-208250">
    <div class="subject"><a href="#post-208250">Re: Hooking DLLs</a></div>
    <div class="body">Sony installed it&#039;s rootkit not to protect the user, but to protect it&#039;s own interests - without informing the user. Furthermore, their software was badly written and could be exploited by malware. Thus, a lot of people (including me) find their crapware bordering malicious.<br /><br />As for hacker vs. cracker, in these days and times (unless you&#039;re a GPL hippie), a cracker removes software protection and a hacker breaks into other people&#039;s systems.<br /><br />Anyway, enough off-topic from me :)</div>
    <div class="meta">Posted on 2009-07-23 05:15:33 by f0dder</div>
   </div>
   <div class="post" id="post-208251">
    <div class="subject"><a href="#post-208251">Re: Hooking DLLs</a></div>
    <div class="body">Idt/ memorymanager hooking really is the best way to go about setting yourself up from a security (non proof of concept) standpoint. Breaking into the private kernel functions would only offer a slight bit more protection for allowing other security programs to work (until the fu2 scanner is released anyways.)&nbsp; There should be someway to whitelist programs to access the idt (i&#039;d make it a hash plus file length on the image at least) then you could write protect the whitelist.<br /><br />Ah the list of things to accomplish while dealing with kernel-land... I really should mess around with it some more... I gave up my drivers a while ago... always seemed like I made weeks of busy work for the 10 minutes or so of fun code I got to write. :-\</div>
    <div class="meta">Posted on 2009-07-23 07:18:28 by jakor</div>
   </div>
   <div class="post" id="post-208253">
    <div class="subject"><a href="#post-208253">Re: Hooking DLLs</a></div>
    <div class="body"><strong>jakor</strong>: a lot of the kernel-based stuff is pretty useless anyway, imho, because of x64 and patchguard. I find it a bit problematic that MS hasn&#039;t made some official &amp; guarded hook locations, and rather insist on protecting everything.<br /><br />Malware can attempt to subvert patchguard, but that&#039;s not a viable route for legit software.</div>
    <div class="meta">Posted on 2009-07-23 07:48:51 by f0dder</div>
   </div>
   <div class="post" id="post-208255">
    <div class="subject"><a href="#post-208255">Re: Hooking DLLs</a></div>
    <div class="body">Hi,<br /><br />Since I statred this thread, I have this working:<br /><br />Export function redirection.<br /><br />Stub DLL:<br /><br /><pre><code>.386<br />.model flat,stdcall<br /><br />.code<br /><br />DllEntry proc hInstDLL:DWORD, reason:DWORD, reserved1:DWORD<br /> &nbsp; &nbsp; &nbsp; &nbsp;mov eax,1h<br />	ret 0Ch<br />DllEntry endp<br /><br />CheckForDevice proc<br />CheckForDevice endp<br /><br />end DllEntry</code></pre><br /><br />Exports:<br /><br /><pre><code>LIBRARY CheckDevice<br />EXPORTS<br />CheckForDevice=CheckDevice2.#1</code></pre><br /><br />I re-wrote the &quot;real&quot; DLL in asm and exported the functions as ordinals only (NONAME) as a test. Ordinals or function names - either work as re-directors.&nbsp; 8)<br /><br />I&#039;m not a novice - been writing software for years, just not at this level. Because I quit with C++ doesn&#039;t mean I didn&#039;t learn something.<br /><br />I suspect you think I just started out - no. :)<br /><br />I appreciate this kind of question might be very close to breaking forum rules, and it was for this reason they suspect(ed) I&#039;m a hacker over at the other forum. I guess they didn&#039;t consider the other (legitimate) uses for this kind of programming.<br /><br />I tend to do things a bit different anyways.<br /><br />So... with all that said - thanks for the above. I&#039;m getting on really well with assembler, and I&#039;m ready to go intercept a call or two from msgina (in a VM of course) to see where best to put my code.<br /><br />I will want to write a driver, and already looked at the basics, but not yet ready to tackle that yet. In the meantime I&#039;ve yet to research how to enumerate the USB. I thought I had it figured out but kept hitting a brick-wall with C++ which I hope won&#039;t be there when I re-visit it using assembler instead.<br /><br />Best regards,<br />Astro.</div>
    <div class="meta">Posted on 2009-07-23 14:40:21 by Astro</div>
   </div>
   <div class="post" id="post-208256">
    <div class="subject"><a href="#post-208256">Re: Hooking DLLs</a></div>
    <div class="body">Using only export forwarding, I have a working GINA.dll stub. Tested in a VM.<br /><br />Best regards,<br />Astro.</div>
    <div class="meta">Posted on 2009-07-23 17:54:52 by Astro</div>
   </div>
   <div class="post" id="post-208267">
    <div class="subject"><a href="#post-208267">Re: Hooking DLLs</a></div>
    <div class="body"><div class="quote"><br />...<br />Stub DLL:<br /><br /><pre><code>.386<br />.model flat,stdcall<br /><br />.code<br /><br />DllEntry proc hInstDLL:DWORD, reason:DWORD, reserved1:DWORD<br /> &nbsp; &nbsp; &nbsp; &nbsp;mov eax,1h<br />	ret 0Ch<br />DllEntry endp<br /><br />CheckForDevice proc<br />CheckForDevice endp<br /><br />end DllEntry</code></pre><br /><br />Exports:<br /><br /><pre><code>LIBRARY CheckDevice<br />EXPORTS<br />CheckForDevice=CheckDevice2.#1</code></pre><br />...<br />I&#039;m not a novice - been writing software for years, just not at this level. Because I quit with C++ doesn&#039;t mean I didn&#039;t learn something.<br /><br />I suspect you think I just started out - no. :)<br />...<br /></div><br /><br />What languages have you used? Vb?<br /><br />There are things missing such as a return from the checkfordevice call that are needed. What is the purpose of exporting by ordinal in this case? There is also no need for the 0Ch after ret. Export hooking is opening up the pe file and traversing through the structures and tables until you find the address of a function in a table and overwritting that with a pointer to your function loaded into the same address space.<br /><br />You seem to understand some terminology, but writing a dll skeleton with errors doesn&#039;t make you look any less new to programming. Masm come with iczlions tutorials if I were you i&#039;d look up the tutorial of dll&#039;s there is a decent beginners tutorial that would create an acceptable dll skeleton to start off with.<br /><br />As far as driver development, learning userland is tough with the lack of knowlege online(for assembly). Many old topics covering assembly are not relevant but contain good knowlege if you already know assembly basics and can apply the theories to new code. Kernel land however suffers from far less information plenty of restricted rules on what and how to do things. You also need to write a service to talk to and control the driver. Plenty of requirements to use undocumented or slightly documented functions and structures.<br /><br />Hooking dll functions is a very *VERY* simple task compared to 1/4 of you project. If you are serious about learning assembly, you must run through the iczlion tutorials. Even tasks which you think may be unimportant such as reading and writing a file are very basic and necessary for talking to drivers.<br /><br />Unless you are autistic, the ammount of time for things to stick in your head is far more than you have given for your time limit. The only way I can think you could do this is by ripping code from many places and rigging it to work. The flaws and issues you would run into will take more time to track down solutions for than just learning the language first.<br /><br />This is my last plea to just learn assembly (or whatever language you settle on) first and start piecing your project together over a much longer time.</div>
    <div class="meta">Posted on 2009-07-24 14:10:28 by jakor</div>
   </div>
   <div class="post" id="post-208268">
    <div class="subject"><a href="#post-208268">Re: Hooking DLLs</a></div>
    <div class="body">Quite a reply there...<br /><br />I&#039;m not autistic - just smart, and I put in the effort to learn. I also take from experience and my education.<br /><br />Yes, I do have stuff to learn regarding assembler, but I learn it as I go (and I don&#039;t mean a cursory glance). It&#039;s my learning style, and how I pick stuff up so quickly.<br /><br /><div class="quote">There are things missing such as a return from the checkfordevice call that are needed.</div><br />No - it is a forwarding export. &nbsp;:) &nbsp;This function simply acts as a place-holder. It doesn&#039;t &nbsp;actually do anything beyond providing for the entry in the table so it doesn&#039;t throw the linker error &quot;unresolved external reference&quot;. If the code actually did anything (see WlxInitialize below) then the usual rules apply to that specific function in the DLL and the export definition file.<br /><br /><div class="quote">What is the purpose of exporting by ordinal in this case?</div><br />Required for my GINA stub (which is now 100% operational including my intercept of the WlxInitialize function for my own purposes - not a mean feat in itself for someone who appears to be so.......new to programming, less assembler, hmm?). There are 28 functions in msgina.dll that are exported only by ordinal. I need to copy this exactly otherwise my DLL will fail, and with it, Windows. I exported it by ordinal in my code above purely to test it worked, with known code.<br /><br /><div class="quote">There is also no need for the 0Ch after ret.</div><br />After much research, yes there is. In fact, not doing so in my intercept for GINA crashes the system. It is required. My app posted above would leak memory without (to be specific, it would leak stack memory).<br /><br /><div class="quote">Export hooking is opening up the pe file and traversing through the structures and tables until you find the address of a function in a table and overwritting that with a pointer to your function loaded into the same address space.</div><br />Thankyou. I shall research this further.<br /><br /><div class="quote">Masm come with iczlions tutorials if I were you i&#039;d look up the tutorial of dll&#039;s there is a decent beginners tutorial that would create an acceptable dll skeleton to start off with.</div><br />Yes - I&#039;m already going through those. I wrote the above &quot;on my own&quot; as it were as it is only through making mistakes do you learn anything.<br /><br /><div class="quote">Kernel land however suffers from far less information plenty of restricted rules on what and how to do things. ... Plenty of requirements to use undocumented or slightly documented functions and structures.</div><br />Yes - I&#039;m still researching this.<br /><br /><div class="quote">You also need to write a service to talk to and control the driver.</div><br />No problems there. Looks easier in asm than in either C++ OR VB.NET.<br /><br /><div class="quote">If you are serious about learning assembly, you must run through the iczlion tutorials.</div><br />Already doing that.<br /><br /><div class="quote">Even tasks which you think may be unimportant such as reading and writing a file are very basic and necessary for talking to drivers.</div><br />Agreed. I&#039;m still researching...<br /><br /><div class="quote">the ammount of time for things to stick in your head is far more than you have given for your time limit.</div><br />It seems people latched onto my comment about 3 weeks, and missed the word &quot;NOT&quot; that preeceded it. I have several MONTHS to do this (I&#039;ve been a year at this already). My problem now is not so much what I want to do (that is sorted out) but just finding a language I can use to do it with. Assembler is my dream come true. I&#039;m not new to it either - only new to it on the x86. No idea why I didn&#039;t think to try it before, to be honest.<br /><br /><div class="quote">The only way I can think you could do this is by ripping code from many places and rigging it to work.</div><br />I won&#039;t do that - it only hurts me.<br /><br /><div class="quote">The flaws and issues you would run into will take more time to track down solutions for than just learning the language first.</div><br />I completely agree with you there.<br /><br /><div class="quote">This is my last plea to just learn assembly (or whatever language you settle on) first and start piecing your project together over a much longer time.</div><br />I am learning as I go. Unfortunately I don&#039;t have the luxury of unlimited time to learn - I have a contract to fulfill and money to make. I do however have the capacity to do what I&#039;m doing otherwise I would not have taken it on - it does me no good professionally to take something on that I can&#039;t handle.<br /><br />Best regards,<br />Astro.</div>
    <div class="meta">Posted on 2009-07-24 18:15:42 by Astro</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=29479&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=29479&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="29479" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=29479&amp;page=2">&gt;</a><a href="../?id=29479&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>