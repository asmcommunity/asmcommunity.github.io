<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>4-pole lowpass/highpass filter - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=14758" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=14758">4-pole lowpass/highpass filter</a></p>
   <div class="post" id="post-114394">
    <div class="subject"><a href="#post-114394">4-pole lowpass/highpass filter</a></div>
    <div class="body"><pre><code>__forceinline float filter&#40; float input, float fc, float res, int highpass=0 &#41;<br />&#123;<br />    static float _116 = 1.16f;<br />    static float _015 = 0.15f;<br />    static float _035 = 0.35013f;<br />    static float _030 = 0.3f;<br />    static float pIn&#91;5&#93;;<br />    float *pOut = curIns-&gt;filterDataOut; // we need to save the values per instrument<br />    __asm<br />    &#123;<br />        mov     esi, pOut<br />        lea     edi, pIn<br />        push    esi<br />        push    edi<br />        stosd            ;//add        edi, 4<br /><br />        ;// float f = fc * 1.16f;<br />        fld     dword ptr fc<br />        fmul    dword ptr &#91;_116&#93;            ;// f in st0<br /><br />        ;// float fb = res * &#40;1.0f - 0.15f * f * f&#41;;<br />        fld1<br />        fld     st&#40;1&#41;<br />        fmul    st&#40;0&#41;, st&#40;0&#41;<br />        fmul    dword ptr &#91;_015&#93;<br />        fsubp   st&#40;1&#41;, st&#40;0&#41;<br />        fmul    dword ptr res<br /><br />        ;// input -= pOut&#91;4&#93; * fb;<br />        fmul    dword ptr &#91;esi+4*4&#93;<br />        fsubr   dword ptr input<br />        fstp    dword ptr input<br /><br />        ;// input *= 0.35013f * &#40;f*f*f*f&#41;;<br />        fld     st&#40;0&#41;<br />        fmul    st&#40;0&#41;, st&#40;1&#41;<br />        fmul    st&#40;0&#41;, st&#40;1&#41;<br />        fmul    st&#40;0&#41;, st&#40;1&#41;<br />        fmul    dword ptr &#91;_035&#93;<br />        fmul    input<br />        fstp    dword ptr &#91;esi&#93; ;// pOut&#91;0&#93; = input<br /><br />        ;// 1-f<br />        fld1<br />        fsubrp  st&#40;1&#41;, st&#40;0&#41;<br /><br />        xor     ecx, ecx<br />        mov     cl, 4<br /><br />    poleLoop&#58;<br /><br />        ;// pOut&#91;i&#93; = bla;//0.3f * pIn&#91;i&#93; + bla;//invF * pOut&#91;i&#93;;<br />        fld     st&#40;0&#41;<br />        fmul    dword ptr &#91;esi+4&#93;<br /><br />        fld     dword ptr &#91;edi&#93;<br />        fmul    dword ptr &#91;_030&#93;<br /><br />        faddp   st&#40;1&#41;, st&#40;0&#41;<br />        fadd    dword ptr &#91;esi&#93;<br /><br />        fstp    dword ptr &#91;esi+4&#93;<br /><br />        ;// pIn&#91;i&#93; = pOut&#91;i-1&#93;;<br />        ;// and update esi and edi at the same time &#58;&#41;<br />        movsd<br /><br />        loop    short poleLoop<br /><br />        fstp    st&#40;0&#41; ;// we have &#40;1-f&#41; left on fpu stack<br /><br />        pop     edi<br />        pop     esi<br />        fld     dword ptr &#91;esi+16&#93;<br />        cmp     dword ptr &#91;highpass&#93;, 0<br />        je      short noHighPass<br />        fsubr   dword ptr &#91;edi+16&#93;<br />    noHighPass&#58;<br />;//     fstp    &#91;esi&#93;<br />    &#125;<br />;// return *pOut;<br />&#125;</code></pre><br /><br />Anyone got a smaller one? :)<br /><br />Those float values unfortunately are quite sensitive.. Eg if I'd get rid of _030 and use _035 for that as well, it sounds completely different.<br />Sorry about the C++ shit, I'm too lazy right now to convert my whole softsynth to asm :)<br /><br />Attached is a first version of the result.. Note please that I'm not a very musical person.. Once I've got an interface I'll pass it on to someone who's actually good at doing music :grin:<br /><br /><strong>edit:</strong> Updated attachment to latest version..</div>
    <div class="meta">Posted on 2003-08-19 07:36:51 by snq</div>
   </div>
   <div class="post" id="post-114399">
    <div class="subject"><a href="#post-114399">4-pole lowpass/highpass filter</a></div>
    <div class="body">Okay.. just after I posted I saw the first thing:<br /><br />Replace<br /><pre><code>        ;// input -= pOut&#91;4&#93; * fb;<br />        fmul    dword ptr &#91;esi+4*4&#93;<br />        fsubr   dword ptr input<br />        fstp    dword ptr input<br /><br />        ;// input *= 0.35013f * &#40;f*f*f*f&#41;;<br />        fld     st&#40;0&#41;<br />        fmul    st&#40;0&#41;, st&#40;1&#41;<br />        fmul    st&#40;0&#41;, st&#40;1&#41;<br />        fmul    st&#40;0&#41;, st&#40;1&#41;<br />        fmul    dword ptr &#91;_035&#93;<br />        fmul    input<br />        fstp    dword ptr &#91;esi&#93; ;// pOut&#91;0&#93; = input<br /></code></pre><br />with<br /><pre><code>        ;// input -= pOut&#91;4&#93; * fb;<br />        fmul    dword ptr &#91;esi+4*4&#93;<br />        fsubr   dword ptr input<br /><br />        ;// input *= 0.35013f * &#40;f*f*f*f&#41;;<br />        fld     st&#40;1&#41;<br />        fmul    st&#40;0&#41;, st&#40;2&#41;<br />        fmul    st&#40;0&#41;, st&#40;2&#41;<br />        fmul    st&#40;0&#41;, st&#40;2&#41;<br />        fmul    dword ptr &#91;_035&#93;<br />        fmulp   st&#40;1&#41;, st&#40;0&#41;<br />        fstp    dword ptr &#91;esi&#93; ;// pOut&#91;0&#93; = input<br /></code></pre></div>
    <div class="meta">Posted on 2003-08-19 08:32:29 by snq</div>
   </div>
   <div class="post" id="post-114403">
    <div class="subject"><a href="#post-114403">4-pole lowpass/highpass filter</a></div>
    <div class="body">wow! very nice stuph and in only 4kb ... remember that i saw one 4k intro<br />with tunnel effect and synth music, dont remember the name.<br /><br />you can use create an random goa generator using this minisynth :) for<br />non stop tripping experience.<br /><br />... when to expect an interface ;) ? or an asm lib for playing ?</div>
    <div class="meta">Posted on 2003-08-19 09:06:16 by TBD</div>
   </div>
   <div class="post" id="post-114408">
    <div class="subject"><a href="#post-114408">4-pole lowpass/highpass filter</a></div>
    <div class="body">Well it's not really 4k actually ;) All code and data together is a bit over 2k.. Its all the damn headers and alignment and shit that make it 4k :)<br /><br />I might release a public version perhaps even with source when it's all done and when I've at least gotten the chance to use it myself in a 4k intro.. I'm not totally done with it yet. And then comes the interface and then I'll pass it to a musician who will without any doubt come with a lot of requests and demands :)</div>
    <div class="meta">Posted on 2003-08-19 09:33:43 by snq</div>
   </div>
   <div class="post" id="post-114410">
    <div class="subject"><a href="#post-114410">4-pole lowpass/highpass filter</a></div>
    <div class="body">btw, only the original.exe it is working on my XP.<br /><br />when you need ideeas/betatesting/demo songs count me in ;) <br />an open source lib would be nice :rolleyes: <br /><br />keep up the good work</div>
    <div class="meta">Posted on 2003-08-19 09:39:34 by TBD</div>
   </div>
   <div class="post" id="post-114474">
    <div class="subject"><a href="#post-114474">4-pole lowpass/highpass filter</a></div>
    <div class="body">I made a couple harmless changes below (please, let me know if I broke it ;)).  Also, I'd like to mention that <strong>f*f</strong> is used three times and should be preserved on the stack to save a FMUL, and FLD1 can be saved as well by putting <strong>1-f</strong> on the stack early as well.  I could have just made those changes to the source code, but I felt it better to explain because it destroys the continuity of the code and comments. ;)<br /><br />I'll look at it more when I get home from work.<br /><br /> only &quot;original&quot; EXE works on my machine here: WinXP/Athon<br /><pre><code>__forceinline float filter&#40; float input, float fc, float res, int highpass=0 &#41;<br />&#123;<br />    static float _116 = 1.16f;<br />    static float _015 = 0.15f;<br />    static float _035 = 0.35013f;<br />    static float _030 = 0.3f;<br />    static float pIn&#91;5&#93;;<br />    float *pOut = curIns-&gt;filterDataOut; // we need to save the values per instrument<br />    __asm<br />    &#123;<br />        mov     esi, pOut<br />        lea     edi, pIn&#91;b&#93; + 4 ;#&#91;/b&#93;<br />        push    esi<br />        push    edi<br />&#91;b&#93;;# stosd            ;//add        edi, 4&#91;/b&#93;<br /><br />        ;// float f = fc * 1.16f;<br />        fld     dword ptr fc<br />        fmul    dword ptr &#91;_116&#93;            ;// f in st0<br /><br />        ;// float fb = res * &#40;1.0f - 0.15f * f * f&#41;;<br />        fld1<br />        fld     st&#40;1&#41;<br />        fmul    st&#40;0&#41;, st&#40;0&#41;<br />        fmul    dword ptr &#91;_015&#93;<br />        fsubp   st&#40;1&#41;, st&#40;0&#41;<br />        fmul    dword ptr res<br /><br />        ;// input -= pOut&#91;4&#93; * fb;<br />        fmul    dword ptr &#91;esi+4*4&#93;<br />        fsubr   dword ptr input<br /><br />        ;// input *= 0.35013f * &#40;f*f*f*f&#41;;<br />        fld     st&#40;1&#41;<br />        fmul    st&#40;0&#41;, st&#40;2&#41;<br />        fmul    st&#40;0&#41;, st&#40;2&#41;<br />        fmul    st&#40;0&#41;, st&#40;2&#41;<br />        fmul    dword ptr &#91;_035&#93;<br />        fmulp   st&#40;1&#41;, st&#40;0&#41;<br />        fstp    dword ptr &#91;esi&#93; ;// pOut&#91;0&#93; = input<br /><br />        ;// 1-f<br />        fld1<br />        fsubrp  st&#40;1&#41;, st&#40;0&#41;<br /><br />        xor     ecx, ecx<br />        mov     cl, 4<br /><br />    poleLoop&#58;<br /><br />        ;// pOut&#91;i&#93; = bla;//0.3f * pIn&#91;i&#93; + bla;//invF * pOut&#91;i&#93;;<br />        fld     st&#40;0&#41;<br />        fmul    dword ptr &#91;esi+4&#93;<br /><br />        fld     dword ptr &#91;edi&#93;<br />        fmul    dword ptr &#91;_030&#93;<br /><br />        faddp   st&#40;1&#41;, st&#40;0&#41;<br />        fadd    dword ptr &#91;esi&#93;<br />&#91;b&#93;<br />        ;// pIn&#91;i&#93; = pOut&#91;i-1&#93;;<br />        ;// and update esi and edi at the same time <br />        movsd<br /><br />        fstp    dword ptr &#91;esi&#93;<br />&#91;/b&#93;<br />        loop    short poleLoop<br /><br />        fstp    st&#40;0&#41; ;// we have &#40;1-f&#41; left on fpu stack<br /><br />        pop     edi<br />        pop     esi<br />        fld     dword ptr &#91;esi+16&#93;<br />        cmp     dword ptr &#91;highpass&#93;, &#91;b&#93;ecx ;#&#91;/b&#93;<br />        je      short noHighPass<br />        fsubr   dword ptr &#91;edi+16&#93;&#91;b&#93;&#91;-4&#93; ;#&#91;/b&#93;<br />    noHighPass&#58;<br />;//     fstp    &#91;esi&#93;<br />    &#125;<br />;// return *pOut;<br />&#125;</code></pre></div>
    <div class="meta">Posted on 2003-08-19 18:45:05 by bitRAKE</div>
   </div>
   <div class="post" id="post-114495">
    <div class="subject"><a href="#post-114495">4-pole lowpass/highpass filter</a></div>
    <div class="body">Thanks for your tips :)<br />I actually found all of them myself already and changed some other stuff as well. The resonance is now passed in a word instead of a float because it's in the struct as a byte to save some bytes. So perhaps that makes the filter a few bytes bigger but it saves space in the loader and the renderer.. Also the 0.35 actually could be changed to 0.30 without too much difference in the sound. I just had to adjust the resonance value to make it sound correct again.<br /><br />Right. Perhaps I should mention that the final executable is going to be packed using <a target="_blank" href="http://www.ibsensoftware.com">aPack</a>. And I've had a few things where the code would be smaller, but the compressed code would get bigger. For example xor ecx,ecx/mov cl,4 instead of mov ecx,4 got bigger instead of smaller...<br /><br />Here's what I got right now before playing with the f*f and 1-f thing you said:<br /><pre><code><br />__forceinline float filter&#40; float input, float fc, WORD res, BYTE highpass=0 &#41;<br />&#123;<br />    static float _116 = 1.16f;<br />    static float _015 = 0.15f;<br />    static float _030 = 0.3f;<br />//  static float _035 = 0.35013f;<br />    static WORD resDiv = 55;<br />    static float pIn&#91;4&#93;;<br />    float *pOut = curIns-&gt;filterDataOut;<br />    __asm<br />    &#123;<br />        ;// float f = fc * 1.16f;<br />        fld     dword ptr fc<br />        fmul    dword ptr &#91;_116&#93;            ;// f in st0<br /><br />        ;// float fb = res * &#40;1.0f - 0.15f * f * f&#41;;<br />        fld1<br />        fld     st&#40;1&#41;<br />        fmul    st&#40;0&#41;, st&#40;0&#41;<br />        fmul    dword ptr &#91;_015&#93;<br />        fsubp   st&#40;1&#41;, st&#40;0&#41;<br />        fimul   word ptr &#91;res&#93;<br />        fidiv   word ptr &#91;resDiv&#93;<br /><br />        ;// input -= pOut&#91;4&#93; * fb;<br />        mov     esi, pOut<br />        fmul    dword ptr &#91;esi+4*4&#93;<br />        fsubr   dword ptr input<br /><br />        ;// st0=input, st1=f<br /><br />        ;// input *= 0.35013f * &#40;f*f*f*f&#41;;<br />        fld     st&#40;1&#41;<br />        fmul    st&#40;0&#41;, st&#40;2&#41;<br />        fmul    st&#40;0&#41;, st&#40;2&#41;<br />        fmul    st&#40;0&#41;, st&#40;2&#41;<br />        fmul    dword ptr &#91;_030&#93; ;//     fmul    dword ptr &#91;_035&#93;<br />        fmulp   st&#40;1&#41;, st&#40;0&#41;<br />        fstp    dword ptr &#91;esi&#93; ;// pOut&#91;0&#93; = input<br /><br />        ;// 1-f<br />        fld1<br />        fsubrp  st&#40;1&#41;, st&#40;0&#41;<br /><br />;//     mov     ecx, 4 ;// this compresses smaller but uncompressed it's bigger &#58;&#41;<br />        xor     ecx, ecx<br />        mov     cl, 4<br />        lea     edi, pIn; ;//+4 -&gt; no need for the +4 I found out<br /><br />    poleLoop&#58;<br /><br />        ;// pOut&#91;i&#93; = 0.3f * pIn&#91;i&#93; + &#40;1-f&#41; * pOut&#91;i&#93;;<br />        fld     st&#40;0&#41;<br />        fmul    dword ptr &#91;esi+4&#93;<br /><br />        fld     dword ptr &#91;edi&#93;<br />        fmul    dword ptr &#91;_030&#93;<br /><br />        faddp   st&#40;1&#41;, st&#40;0&#41;<br />        fadd    dword ptr &#91;esi&#93;<br /><br />        ;// pIn&#91;i&#93; = pOut&#91;i-1&#93;;<br />        ;// and update esi and edi at the same time &#58;&#41;<br />        movsd<br />        fstp    dword ptr &#91;esi&#93;<br /><br />        loop    short poleLoop<br /><br />        fstp    st&#40;0&#41; ;// we have &#40;1-f&#41; on fpu stack<br /><br />        fld     dword ptr &#91;esi&#93;<br />        cmp     byte ptr &#91;highpass&#93;, cl ;// ecx=0 &#58;&#41;<br />        je      short noHighPass<br />        fsubr   dword ptr &#91;edi-4&#93;<br />    noHighPass&#58;<br />    &#125;<br />&#125;<br /></code></pre></div>
    <div class="meta">Posted on 2003-08-19 20:20:53 by snq</div>
   </div>
   <div class="post" id="post-114497">
    <div class="subject"><a href="#post-114497">4-pole lowpass/highpass filter</a></div>
    <div class="body">Also.. Here's the latest... Managed to get it down to 3.5k now unmodified by tools or packers!<br /><br />Anyway, could someone with XP do me a big favor and test some stuff.. Included 4 versions of the exe in this zip. Please try them and let me know which ones work and which don't. I haven't tested on win98 either so if anyone could confirm which work and which don't, I'd be most thankful :alright:<br /><br />And hereby I also release my PE header optimizer to the public.. CleanPE.exe in the zip! Play around with different settings to get the optimal working result. I haven't really tested it with files that have more than 1 segment or a lot of imports so it's very very beta. And don't try to re-clean exes that are already cleaned :grin:<br />If there's interest I might do a more stable version :)</div>
    <div class="meta">Posted on 2003-08-19 20:27:33 by snq</div>
   </div>
   <div class="post" id="post-114498">
    <div class="subject"><a href="#post-114498">4-pole lowpass/highpass filter</a></div>
    <div class="body">They all seem to work FINE on XP<br /><br />minisynth.importsnotmoved.exe the first time did not seem to work but once i ran the others it seemed to work... not sure if it messed up the first time somehow.<br /><br />minisynth.importsnotoptimized.com<br /><br />creates a MZ.EXE so im guessing it has some sort of loader or something that extracts it or something..</div>
    <div class="meta">Posted on 2003-08-19 20:39:58 by devilsclaw</div>
   </div>
   <div class="post" id="post-114499">
    <div class="subject"><a href="#post-114499">4-pole lowpass/highpass filter</a></div>
    <div class="body"><div class="quote"><em>Originally posted by devilsclaw </em><br />They all seem to work FINE on XP<br />minisynth.importsnotmoved.exe the first time did not seem to work but once i ran the others it seemed to work... not sure if it messed up the first time somehow.<br />minisynth.importsnotoptimized.com<br />creates a MZ.EXE so im guessing it has some sort of loader or something that extracts it or something.. </div><br />Well that's odd :) But know we know... No import string moving on XP :mad:<br />The importsnotoptimized.com indeed dumps a file MZ.exe to disk and executes it. Using a dropper I can compress the headers as well instead of just the code/data :)<br />But that one worked fine as well? (just checking if all really means all here ;)<br /><br />What exactly happened when you ran importsnotmoved.exe for the first time? Did you at least get a console window? Or not even that. Some windows error message perhaps?<br /><br />Thanks for the report!</div>
    <div class="meta">Posted on 2003-08-19 20:47:08 by snq</div>
   </div>
   <div class="post" id="post-114526">
    <div class="subject"><a href="#post-114526">4-pole lowpass/highpass filter</a></div>
    <div class="body"><div class="quote"><em>Originally posted by snq </em><br />Right. Perhaps I should mention that the final executable is going to be packed using <a target="_blank" href="http://www.ibsensoftware.com">aPack</a>. And I've had a few things where the code would be smaller, but the compressed code would get bigger. For example xor ecx,ecx/mov cl,4 instead of mov ecx,4 got bigger instead of smaller...</div>Thanks for the heads up.  Your code is looking really good now! ;)<br />(Have you tried compressing the unrolled loop?)</div>
    <div class="meta">Posted on 2003-08-19 23:37:31 by bitRAKE</div>
   </div>
   <div class="post" id="post-114528">
    <div class="subject"><a href="#post-114528">I think your squeezing out too much air..</a></div>
    <div class="body">I <strong><em>Can't</em></strong> re-link these files..<br /><br />(Win98SE most recient patches &amp; upgrades)</div>
    <div class="meta">Posted on 2003-08-19 23:51:12 by NaN</div>
   </div>
   <div class="post" id="post-114541">
    <div class="subject"><a href="#post-114541">4-pole lowpass/highpass filter</a></div>
    <div class="body">originally the one that did not work just seemed to close like the cleanpe.exe... which i know is not the same program lol.. it opened then closed... at least i thought... but when i went to close down all my windows i think remembering an extra window it may be that it just went to back ground..<br /><br />i will reboot and let you know if it was my mistake...<br /><br />also all the others work just fine for me...</div>
    <div class="meta">Posted on 2003-08-20 02:15:31 by devilsclaw</div>
   </div>
   <div class="post" id="post-114551">
    <div class="subject"><a href="#post-114551">4-pole lowpass/highpass filter</a></div>
    <div class="body"><div class="quote"><br />Thanks for the heads up.  Your code is looking really good now! ;)<br />(Have you tried compressing the unrolled loop?) </div><br />Thanks :)<br /><br />Well one obvious thing that I tried:<br /><pre><code><br />        fld     st&#40;1&#41;<br />        fmul    st&#40;0&#41;, st&#40;2&#41;<br />        fmul    st&#40;0&#41;, st&#40;0&#41;<br /></code></pre>instead of<pre><code><br />        fld     st&#40;1&#41;<br />        fmul    st&#40;0&#41;, st&#40;2&#41;<br />        fmul    st&#40;0&#41;, st&#40;2&#41;<br />        fmul    st&#40;0&#41;, st&#40;2&#41;<br /></code></pre><br />... which makes compressed size 4 bytes bigger :)<br /><br />I also tried saving the f*f from before on the stack.. Same story, just gets bigger while uncompressed gets smaller..<br />Then I tried putting 0.30f on the stack and change the 2 fmuls.. It just gets bigger!! I'm going nuts ;) It seems the more space I save the bigger it gets hehe... I'll put up a test app with src later soon you if you're interested in really pushing it you can at least test and hear if it still works ;)</div>
    <div class="meta">Posted on 2003-08-20 05:13:31 by snq</div>
   </div>
   <div class="post" id="post-114553">
    <div class="subject"><a href="#post-114553">4-pole lowpass/highpass filter</a></div>
    <div class="body">CleanPE with 1k alignment... for win98<br /><br /><strong>edit:</strong> get attachment 3 posts down..</div>
    <div class="meta">Posted on 2003-08-20 05:27:38 by snq</div>
   </div>
   <div class="post" id="post-114612">
    <div class="subject"><a href="#post-114612">4-pole lowpass/highpass filter</a></div>
    <div class="body">&quot;CleanPE with 1k alignment... <strong>for win98</strong>&quot;<br /><br />Are you sure?<br />The section alignment  is 0x400 rather then 0x1000<br />Pls, reread NaN's image<br />I'm wondering why you want &quot;smaller&quot; file size if you use MSVCRT.dll</div>
    <div class="meta">Posted on 2003-08-20 15:02:43 by lingo12</div>
   </div>
   <div class="post" id="post-114613">
    <div class="subject"><a href="#post-114613">4-pole lowpass/highpass filter</a></div>
    <div class="body">is there already a MSVCRT.INC made for MASM because I have not seen it so i been making my own for the stuff i need from it at times..</div>
    <div class="meta">Posted on 2003-08-20 15:07:47 by devilsclaw</div>
   </div>
   <div class="post" id="post-114617">
    <div class="subject"><a href="#post-114617">4-pole lowpass/highpass filter</a></div>
    <div class="body"><div class="quote"><br />&quot;CleanPE with 1k alignment... <strong>for win98</strong>&quot;<br /><br />Are you sure?<br />The section alignment  is 0x400 rather then 0x1000<br /></div><br />My bad.. I should learn to read :eek:<br />Win98 should be forbidden anyway.. Damn stone age technology :)<br /><br />Here then is an untouched version straight from the linker without using any options whatsoever :)</div>
    <div class="meta">Posted on 2003-08-20 15:43:59 by snq</div>
   </div>
   <div class="post" id="post-114680">
    <div class="subject"><a href="#post-114680">4-pole lowpass/highpass filter</a></div>
    <div class="body">Thanks <strong>snq</strong>,<br /><br />&quot;Here then is an untouched version straight from the linker without using any options whatsoever&quot;<br /><br />On my Windows ME:<br />&quot;Error Starting Program<br />The CLEANPE.EXE file is linked to missing export SHEL32.DLL:DtrStrIA&quot;<br /><br /><br />&quot;Win98 should be forbidden anyway.. Damn stone age technology&quot;<br />OK, let's try on the WinXP Pro<br /><br />Here is a part of my working exe (Windows ME and WinXP Pro)<br />with size 28672 bytes(see the attachment):<pre><code><br />00000000&#58;  4D 5A EB 06-01 00 00 00-00 00 BA 21-01 4C EB 08  MZd??     ?!?Ld?<br />00000010&#58;  50 00 00 00-02 01 F0 FF-04 44 B4 09-CD 21 94 EB  P   ??=_?D??-!?d<br />00000020&#58;  FB 43 61 6E-6E 6F 74 20-62 65 20 72-75 6E 20 69  vCannot be run i<br />00000030&#58;  6E 20 44 4F-53 20 6D 6F-64 65 0A 24-40 00 00 00  n DOS mode?$@<br />00000040&#58;  50 45 00 00-4C 01 01 00-16 CA 33 3F-00 00 00 00  PE  L?? ?-3?<br />00000050&#58;  00 00 00 00-E0 00 0F 01-0B 01 07 0A-00 60 00 00      a ?????? `<br />00000060&#58;  00 00 00 00-00 00 00 00-60 10 00 00-00 10 00 00          `?   ?<br /><br />Count of sections                 1  Machine                   Intel386<br />Symbol table  00000000&#91;00000000&#93; <br />Size of optional header        00E0  Magic optional header      010B<br />Linker version                 7.10  OS version                 4.00<br />Image version                  0.00  Subsystem version          4.00<br />Entry point                00001060  Size of code               00006000<br />Size of init data          00000000  Size of uninit data        00000000<br />Size of image              00007000  Size of header             00001000<br />Base of code               00001000  Base of data               00007000<br />Image base                 00400000  Subsystem                  GUI<br />Section alignment          00001000  File alignment             00001000<br />Stack             00100000/00001000  Heap                       00100000/00001000<br />Checksum                          00000000 ? Number of dirs                          16<br /><br /><br />OS - WinXP Pro<br /><br />1. C&#58;\TEMP&gt;cleanpe.exe scandir.exe  -f 0 -z<br />CleanPE by snq/aardbei<br />Fill with 0 &#40;00h&#41;<br />-- user32.dll<br />-- kernel32.dll<br />-- comctl32.dll<br />Moving imports around a bit...<br />Done. Shit written to scandir.exe &#58;&#41;<br />C&#58;\TEMP&gt;<br /><br /><br />size -&gt; the same &#40;28672 bytes&#41;<br /><br />00000000&#58;  4D 5A 46 69-6E 64 46 69-72 73 74 46-69 6C 65 41  MZFindFirstFileA<br />00000010&#58;  00 43 72 65-61 74 65 54-68 72 65 61-64 00 53 65   CreateThread Se<br />00000020&#58;  6E 64 4D 65-73 73 61 67-65 41 00 55-70 64 61 74  ndMessageA Updat<br />00000030&#58;  65 57 69 6E-64 6F 77 00-00 00 00 00-40 00 00 00  eWindow     @<br />00000040&#58;  50 45 00 00-4C 01 01 00-4C 6F 61 64-43 75 72 73  PE  L?? LoadCurs<br />00000050&#58;  6F 72 41 00-E0 00 0F 01-0B 01 46 69-6E 64 4E 65  orA a ????FindNe<br />00000060&#58;  78 74 46 69-6C 65 41 00-60 10 00 00-00 00 00 00  xtFileA `?<br />00000070&#58;  00 00 00 00-00 00 40 00-00 10 00 00-00 10 00 00        @  ?   ?<br />00000080&#58;  00 00 00 00-00 00 00 00-04 00 00 00-00 00 00 00          ?<br />00000090&#58;  00 70 00 00-00 10 00 00-00 00 00 00-02 00 00 00   p   ?      ?<br />000000A0&#58;  00 00 10 00-00 00 10 00-00 00 10 00-00 00 10 00    ?   ?   ?   ?<br />000000B0&#58;  00 00 00 00-10 00 00 00-00 00 00 00-00 00 00 00      ?<br />000000C0&#58;  60 60 00 00-50 00 00 00-52 65 67 69-73 74 65 72  ``  P   Register<br />000000D0&#58;  43 6C 61 73-73 45 78 41-00 54 72 61-6E 73 6C 61  ClassExA Transla<br />000000E0&#58;  74 65 4D 65-73 73 61 67-65 00 43 72-65 61 74 65  teMessage Create<br />000000F0&#58;  57 69 6E 64-6F 77 45 78-41 00 00 00-00 00 00 00  WindowExA<br />00000100&#58;  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00<br />00000110&#58;  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00<br />00000120&#58;  44 69 73 70-61 74 63 68-4D 65 73 73-61 67 65 41  DispatchMessageA<br />00000130&#58;  00 44 65 66-57 69 6E 64-6F 77 50 72-6F 63 41 00   DefWindowProcA<br />00000140&#58;  70 52 00 00-00 10 00 00-00 60 00 00-00 10 00 00  pR   ?   `   ?<br />00000150&#58;  00 00 00 00-00 00 00 00-00 00 00 00-20 00 00 E0                 a<br />00000160&#58;  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00<br /><br /> Count of sections                1 Machine                  Intel386<br /> Symbol table  73727543&#91;0041726F&#93;    <br /> Size of optional header       00E0 Magic optional header        010B<br /> Linker version               70.10 OS version                   0.00<br /> Image version                 0.00 Subsystem version            4.00<br /> Entry point               00001060 Size of code                 654E646E<br /> Size of init data         69467478 Size of uninit data          0041656C<br /> Size of image             00007000 Size of header               00001000<br /> Base of code              00000000 Base of data                 00000000<br /> Image base                00400000 Subsystem                    GUI<br /> Section alignment         00001000 File alignment               00001000<br /> Stack            00100000/00100000 Heap                00100000/00100000<br /> Checksum                  00000000 Number of dirs               16<br /><br />C&#58;\TEMP\scandir&gt;Doesn't work<br />Error message&#58;<br />&quot;Only part of a ReadProcessMemory or<br />WriteProcessMemory request was completed&quot;<br /><br /><br /><br />2. C&#58;\TEMP&gt;cleanpe.exe scandir.exe  -j -i -z<br />CleanPE by snq/aardbei<br />Done. Shit written to scandir.exe &#58;&#41;<br />C&#58;\TEMP&gt;<br /><br />size -&gt; the same &#40;28672 bytes&#41;<br />00000000&#58;  4D 5A 00 00-00 00 00 00-00 00 00 00-00 00 00 00  MZ<br />00000010&#58;  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00<br />00000020&#58;  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00<br />00000030&#58;  00 00 00 00-00 00 00 00-00 00 00 00-40 00 00 00              @<br />00000040&#58;  50 45 00 00-4C 01 01 00-00 00 00 00-00 00 00 00  PE  L??<br />00000050&#58;  00 00 00 00-E0 00 0F 01-0B 01 00 00-00 00 00 00      a ????<br />00000060&#58;  00 00 00 00-00 00 00 00-60 10 00 00-00 00 00 00          `?<br />00000070&#58;  00 00 00 00-00 00 40 00-00 10 00 00-00 10 00 00        @  ?   ?<br />00000080&#58;  00 00 00 00-00 00 00 00-04 00 00 00-00 00 00 00          ?<br />00000090&#58;  00 70 00 00-00 10 00 00-00 00 00 00-02 00 00 00   p   ?      ?<br />000000A0&#58;  00 00 10 00-00 00 10 00-00 00 10 00-00 00 10 00    ?   ?   ?   ?<br />000000B0&#58;  00 00 00 00-10 00 00 00-00 00 00 00-00 00 00 00      ?<br />000000C0&#58;  60 60 00 00-50 00 00 00-00 00 00 00-00 00 00 00  ``  P<br />000000D0&#58;  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00<br /><br />Count of sections              	   1 Machine            Intel386<br />Symbol table  00000000&#91;00000000&#93; <br />Size of optional header     	00E0 Magic optional header  010B<br />Linker version                  0.00 OS version             0.00<br />Image version                   0.00 Subsystem version      4.00<br />Entry point                 00001060 Size of code           00000000<br />Size of init data           00000000 Size of uninit data    00000000<br />Size of image               00007000 Size of header         00001000<br />Base of code                00000000 Base of data           00000000<br />Image base                  00400000 Subsystem              GUI<br />Section alignment           00001000 File alignment         00001000<br />Stack              00100000/00100000 Heap          00100000/00100000<br />Checksum                    00000000 Number of dirs         16<br /><br />C&#58;\TEMP\scandir&gt; this one works but I prefer my DOS stub &#40;see above&#41;<br /><br /><br />3. C&#58;\TEMP&gt;cleanpe.exe scandir.exe  -j -i -z -c<br />CleanPE by snq/aardbei<br />Done. Shit written to scandir.exe.com &#58;&#41;<br />C&#58;\TEMP\&gt;<br /><br />size -&gt; two bytes bigger then mine &#40;28674 bytes&#41;<br />because writes two additional trailing zeroes at the end of the file<br />&#40;imho, it is an error because when you insert two bytes at the beginning<br />E8 07 -&gt; i.e. jmp 09 you must recompute all and if you have two trailing bytes<br />at the end just delete them. I'm wondering what will be if you haven't two<br />trailing zeroes at the end&#41;<br />00006FF0&#58;  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00<br />00007000&#58;  00 00<br /><br />00000000&#58;  EB 07 4D 5A-2E 65 78 65-00 B4 4A B7-10 CD 21 BD  d?MZ.exe ?J+?-!+<br />00000010&#58;  02 01 B4 3C-8B D5 33 C9-CD 21 8B D8-B9 00 70 B4  ???&lt;?+3+-!?+? p?<br />00000020&#58;  40 8B D5 CD-21 B4 3E CD-21 B4 4B 8B-D5 8B DD CD  @?+-!?&gt;-!?K?+??-<br />00000030&#58;  21 32 ED B4-41 8B D5 CD-21 E2 F8 C3-00 00 40 00  !2f?A?+-!G?+  @<br />00000040&#58;  00 00 50 45-00 00 4C 01-01 00 00 00-00 00 00 00    PE  L??<br />00000050&#58;  00 00 00 00-00 00 E0 00-0F 01 0B 01-00 00 00 00        a ????<br />00000060&#58;  00 00 00 00-00 00 00 00-00 00 60 10-00 00 00 00            `?<br />00000070&#58;  00 00 00 00-00 00 00 00-40 00 00 10-00 00 00 10          @  ?   ?<br />00000080&#58;  00 00 00 00-00 00 00 00-00 00 04 00-00 00 00 00            ?<br /><br />C&#58;\TEMP\&gt;scandir.com -&gt; this one works too but doesn't exit properly<br />&#40;doesn't close the DOS screen&#41; and I prefer my DOS stub &#40;see above&#41;<br /><br /><br />4.C&#58;\TEMP&gt;cleanpe.exe scandir.exe  -j -z<br />CleanPE by snq/aardbei<br />-- user32.dll<br />-- kernel32.dll<br />-- comctl32.dll<br />Done. Shit written to scandir.exe &#58;&#41;<br />C&#58;\TEMP&gt;<br /><br />size -&gt; the same &#40;28672 bytes&#41;<br />00000000&#58;  4D 5A 00 00-00 00 00 00-00 00 00 00-00 00 00 00  MZ<br />00000010&#58;  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00<br />00000020&#58;  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00<br />00000030&#58;  00 00 00 00-00 00 00 00-00 00 00 00-40 00 00 00              @<br />00000040&#58;  50 45 00 00-4C 01 01 00-00 00 00 00-00 00 00 00  PE  L??<br />00000050&#58;  00 00 00 00-E0 00 0F 01-0B 01 00 00-00 00 00 00      a ????<br />00000060&#58;  00 00 00 00-00 00 00 00-60 10 00 00-00 00 00 00          `?<br /><br />C&#58;\TEMP\scandir&gt; this one works but I prefer my DOS stub &#40;see above&#41;<br /><br />5. C&#58;\TEMP&gt;cleanpe.exe<br />CleanPE by snq/aardbei<br />Usage&#58; cleanpe bla.exe &#91;options&#93;<br />Options&#58;<br />  -m &#91;XX&#93;  Move PE header to offset XX<br />           XX must be a multiple of 16. Default is don't move at all<br />           With only -m as a param, XX defaults to 64<br />           Note some values under 64 will work, but not all. 12 is the lowest.<br />&#91;B&#93;  -f XX    Fill bullshit header data with ascii code XX. Default&#58; 0 &#91;/B&#93;<br />  -s XX    Specify stub size. Default&#58; 64<br />  -i       Don't optimize import table<br />  -j       Don't move imports to unused header space<br />  -z       Don't remove trailing zeroes from the file<br />  -c       Insert COM stub.. Rules &#58;&#41; Note&#58; max orig EXE size is around 63k!<br />  -o XXX   Output to file XXX<br /><br /><br />C&#58;\TEMP&gt;cleanpe.exe scandir.exe -f 33<br />Program crash<br /><br />C&#58;\TEMP&gt;cleanpe.exe scandir.exe -f stub.exe<br />Program crash<br /><br />C&#58;\TEMP&gt;cleanpe.exe scandir.exe -f c&#58;\temp\stub.exe<br />Program crash<br /><br /><br />I'm wondering how to use this option<br /><br /><br />6.Ok, let's try without trailing zeroes<br />C&#58;\TEMP&gt;cleanpe.exe scandir.exe -i -j<br />CleanPE by snq/aardbei<br />Done. Shit written to scandir.exe &#58;&#41;<br /><br />C\TEMP&gt;scandir.exe<br /><br />Error&#58;<br />&quot;C&#58;\TEMP\SCANDIR.EXE is not a valid Win32 application&quot;<br /><br />From DOS screen&#58;<br />C&#58;\TEMP&gt;scandir.exe<br />Error&#58;<br />Access denied</code></pre><br /><br />Regards,<br />Lingo</div>
    <div class="meta">Posted on 2003-08-20 20:26:52 by lingo12</div>
   </div>
   <div class="post" id="post-114684">
    <div class="subject"><a href="#post-114684">4-pole lowpass/highpass filter</a></div>
    <div class="body"><strong>Lingo12</strong>,<br /><br />Thanks for that report :)<br /><br />First about the StrStri.. I quote from my MSDN:<br /><div class="quote">LPTSTR StrStrI(<br />    LPCTSTR lpFirst,<br />    LPCTSTR lpSrch<br />    );<br />Requirements<br />  Version 4.71 and later of Shlwapi.dll<br />  Windows NT/2000: Requires Windows 2000 (or Windows NT 4.0 with Internet Explorer 4.0 or later). <br />  Windows 95/98: Requires Windows 98 (or Windows 95 with Internet Explorer 4.0 or later). <br />  Header: Declared in shlwapi.h. <br />  Import Library: shlwapi.lib.</div><br />So I don't understand why it wouldn't work unless you don't have IE4 (which I think comes standard with WinME?).<br /><br /><br />I found out earlier today that I'm filling some header space that is ignored in win2k (which I run) but not in winxp. I don't have an XP machine around here so it'll have to wait. The value of the particular thing can be set to 0 but apparently not to whichever value, in xp. Now I just need to find out which one it is :/<br /><br />This is also why the import moving makes things crash on winxp.<br />If don't use -z and -j (or -i), the exe will actually get a bit smaller :)<br />Using the -z switch will never make the exe smaller without help of an exe packer like UPX (or aPack if you use the -c switch)<br /><br />I'll make an option to preserve your own dos stub ;) I actually had it before (the -s XX option) but I seem to have bugged it :)<br /><br />Using the -c switch allows you to compress the file with a dos exe packer. So you compress the whole exe, also the imports. Well everything. So yes it does get 2 bytes bigger but run it though aPack and compare the size with what UPX made of it. This option is actually not that useful if you're not suffering from severe size limits like when coding a 4k intro like I'm doing.. I'm gonna have to fix that stub too I guess.. I got some bytes left tho ;) this version pretty much assumes all registers are 0 on start. On win2k they are but I don't know about other OSs<br /><br />The rest probably resulted in crashes because of that thing with the header being overwritten..<br /><br />As I said it's very very beta and all I care about right now is that it starts working decent with my own exes..<br />But thanks for giving me an other exe to test with and for the effort of testing!</div>
    <div class="meta">Posted on 2003-08-20 21:21:24 by snq</div>
   </div>
  </div>
 </body>
</html>