<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Give me your Opinion. - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=5058" />
    <link rel="next" href="../?id=5058&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=5058">Give me your Opinion.</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=5058&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=5058&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="5058" /><input type="number" name="page" min="1" max="4" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=5058&amp;page=2">&gt;</a><a href="../?id=5058&amp;page=4">&raquo;</a></form>   <div class="post" id="post-35530">
    <div class="subject"><a href="#post-35530">Give me your Opinion.</a></div>
    <div class="body">Im working on a custom edit control now.  Its surprisingly less work then first expected, however, i want to move off my 'Crutch' (a fixed memory buffer for text), and implement a more dynamic memory arangement for the edit control's text.<br /><br />My first guess it to use Heap memory as it is so versitile, and can be expanded (HeapReAlloc).  Even though i have never tired to do so.  Im actually a little confused on the MSDN explaination of this API. It seems like it wants me to create separate new heap, and use HeapReAlloc to *copy* the old heap over.  This to me is not reallocating heap size.. :confused:<br /><br />Anyways, i thought i would put it forward and ask you professionals what you think is the best solution to store text that is dynamically changing in size and content? <br /><ul>[*]Heap / HeapReAlloc<br />[*]Global/Local Alloc (??) <br />[*]Virtual Alloc (??)<br />[*]File Mapping (??)<br />[*]Combination of the above (??)<br /><br /><br />The (??) means i have no clue how it would be effective. :grin:<br /><br />Anyways thanks for any/suggestions help you can provide!<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-04-29 02:23:59 by NaN</div>
   </div>
   <div class="post" id="post-35535">
    <div class="subject"><a href="#post-35535">Give me your Opinion.</a></div>
    <div class="body">I think it's better to cut the memory into pieces and link them together. <br />If you use one big memory block, and remove one character, everything behind it (possibly several MBs) have to be shifted..<br />If you allocate pieces of memory of say 4KB, and you do some simple editting, you only need to change the 4KB memory block, and possibly insert another one before the next one. If you select a big block of text and delete it, you need to figure out which blocks to delete completely, and which partly (2 at most).<br /><br />However if you will be working with large files displayed in the edit control it may not be a good idea to load the complete file into 4KB blocks :). Maybe you can make a combination by adding special blocks that refer to parts of the file while they are untouched, and as soon as you start editting them, cut out a 4KB piece, put it in a memory block and split the previous special block into 2 parts.<br /><br />Thomas</div>
    <div class="meta">Posted on 2002-04-29 02:54:40 by Thomas</div>
   </div>
   <div class="post" id="post-35539">
    <div class="subject"><a href="#post-35539">Give me your Opinion.</a></div>
    <div class="body">Hi NaN<br /><br />Are you making a RichEdit replacement (text only). That would be great. I would be the first one to give up that buggy richedit.<br /><br />KetilO</div>
    <div class="meta">Posted on 2002-04-29 03:41:28 by KetilO</div>
   </div>
   <div class="post" id="post-35541">
    <div class="subject"><a href="#post-35541">Give me your Opinion.</a></div>
    <div class="body">What about OLE string memory? As far as I know, there are no disadvantages using it :confused:</div>
    <div class="meta">Posted on 2002-04-29 03:51:30 by bazik</div>
   </div>
   <div class="post" id="post-35544">
    <div class="subject"><a href="#post-35544">Give me your Opinion.</a></div>
    <div class="body">Thanks Bazik, this is an interesting idea... i will have to look into it!<br /><br /><br />More suggestion are still welcome, cause i still dont have a &quot;game plan&quot; laid out yet :rolleyes: , Im looking into Thomas' sugestion at the moment.<br /><br />Anyways, i have to draw the line and get some sleep.<br />I've been working on the control for about 7 hours, and developed about 300 lines of code in the control.<br /><br />Here is where im currently at.  Please check it out and report its success on your box's.  I'm using no new API's so I dont think there will be any problems.<br /><br />And ya, back to the point, there is only 512 bytes of &quot;type&quot; to enter, after this you'll get a GPF.  So dont get type happy :)<br /><br />Laslty, i know the Curret doesnt follow with word wrap's, and ther still needs to have scroll bars installed. But its at least on its feet :)<br /><br /><strong>  Attachment removed (outdated)</strong><br /><br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-04-29 04:06:31 by NaN</div>
   </div>
   <div class="post" id="post-35547">
    <div class="subject"><a href="#post-35547">Give me your Opinion.</a></div>
    <div class="body">Global/LocalAlloc resolve to the exact same location in<br />kernel32, so it doesn't matter which one you use. Also,<br />it ends up calling HeapAlloc... so you might as well use<br />HeapAlloc (you can always write a wrapper if you don't<br />like the additional parms you need to pass). None of the<br />resize strategies in HeapRealloc is your problem, it's<br />handled on levels that make it 100% transparent to you.<br /><br />VirtualAlloc is not good when you need to realloc, it's<br />good for large &quot;one-time&quot; block allocations.<br /><br />I wouldn't use filemapping for generic memory allocation,<br />it's coupled very tightly with the pagefault handler, the<br />paging file, and is better for allocating shared memory.<br /><br />Now, your memory allocation strategy will all depend on<br />what you are doing. If it's a replacement for the standard<br />edit control, anything but HeapAlloc would be overkill.<br />If you're doing an edit control for, say, source editing,<br />you will have other demands... there's a lot of factors to<br />consider before planning your memory allocation code.</div>
    <div class="meta">Posted on 2002-04-29 04:52:28 by f0dder</div>
   </div>
   <div class="post" id="post-35594">
    <div class="subject"><a href="#post-35594">Give me your Opinion.</a></div>
    <div class="body"><div class="quote"><em>Originally posted by f0dder </em>... None of the<br />resize strategies in HeapRealloc is your problem, it's<br />handled on levels that make it 100% transparent to you.</div><br />Im puzzled.  If im understanding you correctly, The heap size will coninously grow if i write outside the current range??  I dont think this is true, cause the current buffer is in the heap and static at 512 bytes.  If you write beyond this (i have no check code) you *can* write there, but a GPF ends up when you close.  Can you elaborate a bit more on this for me, thanx.<br /><br /><div class="quote">Now, your memory allocation strategy will all depend on<br />what you are doing. If it's a replacement for the standard<br />edit control, anything but HeapAlloc would be overkill.<br />If you're doing an edit control for, say, source editing,<br />you will have other demands... there's a lot of factors to<br />consider before planning your memory allocation code. </div><br />Well, Its first purpose is a rich edit replacement as KeltIO had assumed.  But i will be adding alot of feature i like about Ultra Edit as well, so yes it will be very complex.  Idealy i would like to be able to have one pointer to 'flat' bank of memory in the heap, but incertain if this is possible (but your above statements sound promising).  I dont care if pages get swapped to the HD either, its to be expected for large files, i just dont want to have to make a 'temp' file in the temp dir untill you save (this will a later feature for backup reasons, not operating reasons).<br /><br />( ( And i thought the GDI would be the rough stuff :P ) )<br /><br />Thanx for you advice f0dder ;)<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-04-29 12:40:15 by NaN</div>
   </div>
   <div class="post" id="post-35601">
    <div class="subject"><a href="#post-35601">Give me your Opinion.</a></div>
    <div class="body"><div class="quote"><br />If you write beyond this (i have no check code) you *can* write<br />there, but a GPF ends up when you close. Can you elaborate a bit<br />more on this for me, thanx.<br /></div><br />What I meant was, there's not a great deal of trickery involved<br />from your side - you can HeapRealloc, get a new pointer, and that's<br />it. If the block can grow, it grows. If it has to move, it moves.<br /><br /><div class="quote"><br />Idealy i would like to be able to have one pointer to 'flat' bank<br />of memory in the heap<br /></div><br />And have the whole file as one big block? Eeek. Sure, this would make<br />use of BM scanning or whatever very fast, but that's about the only<br />use a &quot;one big chunk&quot; memory scheme has. Buffer reallocs will be hell<br />and fragment the heap insanely, deleting one char from the middle means<br />moving possibly massive amounts of data around, etc.<br /><br />Allocation strategies will also depend on what you wanna do. Mainly<br />view large files? Or edit &quot;typical sourcecode&quot;? Unless you want to<br />operate on huge files, relatively simple memory allocation can be done.<br />A linked list of lines has worked pretty well for me, and allows for<br />quick copy/paste of multiple lines. On first lineedit, I allocate a<br />buffer a bit longer than required, the typical &quot;delta allocation&quot; (but<br />no need to do that when loading in the file, as typically not all lines<br />in a file will be edited). This approach seems to work pretty well for<br />&quot;normal&quot; textfiles (largest file being the bible, around 4 megs. And yeah,<br />I only have that lying around for test purposes.)</div>
    <div class="meta">Posted on 2002-04-29 12:57:44 by f0dder</div>
   </div>
   <div class="post" id="post-35602">
    <div class="subject"><a href="#post-35602">Give me your Opinion.</a></div>
    <div class="body"><div class="quote">I dont think this is true, cause the current buffer is in the heap and static at 512 bytes. If you write beyond this (i have no check code) you *can* write there, but a GPF ends up when you close</div><br /><br />If you call HeapReAlloc on the buffer and you chose as size bigger then the heap then the heap will be adjusted.</div>
    <div class="meta">Posted on 2002-04-29 12:58:49 by Kudos</div>
   </div>
   <div class="post" id="post-35611">
    <div class="subject"><a href="#post-35611">Give me your Opinion.</a></div>
    <div class="body">Here's the graphical representation of what I had in mind. I would use blocks of 4KB, linked together (a buffer for one line would do too but I think this is more efficient), then don't use all the bytes in the buffer, leaving some padding so it can be editted..<br />To limit the memory usage, add references to the original file. As long as part of the text in the control matches a piece of the file, leave it in the file until the users starts editting it.<br /><br />Thomas</div>
    <div class="meta">Posted on 2002-04-29 13:39:36 by Thomas</div>
   </div>
   <div class="post" id="post-35612">
    <div class="subject"><a href="#post-35612">Give me your Opinion.</a></div>
    <div class="body">Im puzzled again.<br /><br />I thought i would spy on the API called that Ultra edit makes for inspiration, and found out that with *every* key stroke, there is two HeapFree calls.  However, there is NO HeapAlloc, CreateHeap, HeapReAlloc's being called.  <br /><br />To be honest i find this wierd.. :confused:</div>
    <div class="meta">Posted on 2002-04-29 13:41:22 by NaN</div>
   </div>
   <div class="post" id="post-35613">
    <div class="subject"><a href="#post-35613">Give me your Opinion.</a></div>
    <div class="body">Wow Thomas, Thats pretty!! :grin:  (thanx)<br /><br />I dont think 4KB blocks would be the best allocations.  If I change the a letter 'a' -&gt; 'o' , to correct say spelling, and then continue with out saving, i have 4Kb being reserved for one byte. <br /><br />Correct 20 spelling mistakes and you can have up to 80kB in reserved page memory :(<br /><br />I like the line buffer tho, say 256 a line, with a check algo to see if your editing beyond this (where realloc would kick in and give it another 256 block.<br /><br />So far with f0dders thoughts, and your advice, i think this is the best game plan so far.  <br /><br />However, I do want to do this right, so i will hold a bit for anyone elses thoughts before i get coding happy tonight. :)<br /><br />Thanx everyone so far!<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-04-29 13:43:08 by NaN</div>
   </div>
   <div class="post" id="post-35617">
    <div class="subject"><a href="#post-35617">Give me your Opinion.</a></div>
    <div class="body">The way I would do it is have each line buffer start with a struct wich contains the address of the previous and next lines and the line length. Each time the user tries to edit a line is it first copied to a temp buffer say 4k and then when the user moves to a different line the origonal buffer is deleted and a new one of the new size is allocated and it's address is added to it's previous and next line's structs to add it to the linked list, this way you don't over allocate.</div>
    <div class="meta">Posted on 2002-04-29 14:05:16 by Kudos</div>
   </div>
   <div class="post" id="post-35618">
    <div class="subject"><a href="#post-35618">Give me your Opinion.</a></div>
    <div class="body"><div class="quote">I dont think 4KB blocks would be the best allocations. If I change the a letter 'a' -&gt; 'o' , to correct say spelling, and then continue with out saving, i have 4Kb being reserved for one byte. </div><br /><br />That's not what I meant. When you change the a to o, it will allocate a block of 4KB filled (party, so you have some free space to use for editing) with the data from the file at the editting point. You can edit (modify+adding new chars) this piece without allocating new blocks until you've used up all the padding in the block as well.<br /><br />Here's a sample scenario, I hope you can follow it. Because it's an example, I used 128 byte data blocks instead of 4096.<br /><pre><code><br /><br />In file&#58;<br />--------------------------------------<br />This is the first line of text<br />This is the second line of text<br />Another line of text &#40;number 3&#41;<br />4. line<br />and finally the 5th line of text<br />--------------------------------------<br /><br />- Load the file<br />blocks&#58;<br />1. &#91;reference to the full file&#93;<br /><br />- User starts editting the first line.<br />blocks&#58;<br />1. &#91;128 byte data block filled with line 1 &amp; 2, padded with zeroes&#93;<br />&quot;This is the first line of textCRLFThis is the second line of text000000.....&quot;<br />2. &#91;reference to the rest of the file starting at line 3&#93;<br /><br />- User keeps editing the first line<br />This can still be done in the first block, as only ~63 bytes are<br />filled and 128 can be stored. Now the user has exceeded the 128 bytes,<br />a new block is needed. Spread the existing bytes over the original and<br />the new block so you still have some padding&#58;<br />blocks&#58;<br />1. &#91;128 byte data block filled with 64 bytes&#93;<br />&quot;This is the first line of teblaadssadsadsadsssasdasdasdsadsadasd&quot; + 64 zero bytes<br />2. &#91;128 byte data block filled with 64 bytes&#93;<br />&quot;dsadasdjasdjasdasfefefefefefef||This is the second line of text.&quot; + 64 zero bytes<br />&#40;|| is CRLF&#41;<br />3. &#91;reference to the rest of the file starting at line 3&#93;<br /><br />- User edits line 4.<br />new block organization&#58;<br />1. &#91;128 byte data block filled with 64 bytes&#93; &#40;unchanged&#41;<br />2. &#91;128 byte data block filled with 64 bytes&#93; &#40;unchanged&#41;<br />3. &#91;reference to file, line 3 only&#93;<br />4. &#91;128 byte data block filled with line 4 + padding&#93;<br />5. &#91;reference to file, line 5 only&#93;<br /></code></pre><br /><br />Thomas</div>
    <div class="meta">Posted on 2002-04-29 14:14:09 by Thomas</div>
   </div>
   <div class="post" id="post-35655">
    <div class="subject"><a href="#post-35655">Give me your Opinion.</a></div>
    <div class="body">Well i got a linked list going now. And works good.<br /><br />VKim's debug is a god-send!  I wouldnt have gotting it up so fast with out it :)<br /><br />My strategy is more based on Kudos' thoughts.  However, i wrote it such that file mapping that Thomas suggest can be added later. (Which will have to come Somehow when time to load and save memory ~ Still unclear *how* yet).<br /><br />They system is each line gets a link.  And there is a &quot;BUFFER LINE&quot; which is static and never destroyed (until exit), is allocated 4Kb. <br /><br />If you hit 4K on one line, you deserve the warning message box i give you :)<br /><br />I prefer line linked lists as it will be more flexible to some other ideas I want to implement as an edit :grin:<br /><br />So:<ul>[*]- Cursor is *always* in the line buffer<br />[*]- Lines are a linked list (not including the Buffer).  Always starts with line #1, Position 0.<br />[*]- All Text input goes directly into the buffer<br />[*]- Cursor movements (and enter), adjust which link the Buffer will stradle overtop.  It modifies temporarily the list to the buffer for display purposes.  THis means the link it stradles over is actually cut out.  If changes are made, the previous link is destroyed.  When the line changes, a new allocation for the edited line is created specifically to the line size and buffer is copied into it, then the buffer is cleared or loaded with the next link. etc. etc. etc.<br /><br /><br />Well this is what im doing.  Any potential griefs with this?? Feel free to critisize. :)<br /><br />This layout it to hopefully balance memory used, and at the same time limit fragmentation.  Each line is sized to a min of 64 bytes, but can be any length up to 4Kb. (this includes the 16 byte header for each line).<br /><br />Thanx all for your help, thoughts, suggestions.  They are appreciated!<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-04-29 18:28:57 by NaN</div>
   </div>
   <div class="post" id="post-35701">
    <div class="subject"><a href="#post-35701">Give me your Opinion.</a></div>
    <div class="body">I don't know if this is the most efficient way, but this is how I would try it:<br /><br />  1) Use 256 byte segments to store data, saving the last byte as a length byte. 0 length means the segment is free<br />  2) Allocate blocks from VirtualAlloc in 4 kb blocks giving you 16 segments 256 bytes in length. From what I understand, you could reserve a certain size (say 16MB) without actually grabbing physical pages. This would ensure you could grow the blocks in one continuous &quot;heap&quot;<br />  3) Keep a separate table (through HeapAlloc) of words that track what order the segments go together to make up your file. The table needn't be too big at first, but if the file gets too large, use HeapRealloc to make it bigger.<br /><br />  When you go to edit at a certain position, find the segment that contains that position. Then split it into 2 segments, the first being the text *before* the cursor and the second being the text *after* the cursor. Basically, I would grab a free segment (one with a length byte of 0) and copy the text after the edit position to the new segment and set the length byte. With the original segment, just shorten the length byte appropriately.<br />  When typing, just work with the 256 byte segment that is the bytes before the cursor. I doubt this would lead to too much memory thrashing. And if the user types more than will fit in one segment, just grab another one.<br />  If you find that the a little bit of time goes by without typing you could &quot;defrag&quot; it.<br /><br />--Chorus</div>
    <div class="meta">Posted on 2002-04-30 00:23:45 by chorus</div>
   </div>
   <div class="post" id="post-35728">
    <div class="subject"><a href="#post-35728">Give me your Opinion.</a></div>
    <div class="body">Thanx alot chorus, i will think about it as well.  If i find the current plan has problems down the road (and not seen at the moment). I might need to scrap what i have :)<br /><br />As well, here is my two day product.  Again im posting it cause i *really* would like to know if it runs ok on NT box's.  I had some *issues* with resizing and setting the scroll bars tonight.  So i want to make sure they are now sized alright, and the 'dc's on NT machines wont get grumpy. :)<br /><br /><br />I have to say tho, im quite impressed with the project so far.  Its as good a basic edit at the moment (single line).  The .obj is curretly 6Kb.  Which could easily be reduced when optomized.  Im writting *big* to keep the logic more understood.  When it all works, i plan to squeeze the air out. :) <br /><br />Thanx alot.<br />:alright:<br />NaN<br /><br /><strong>: Attachment Removed to save space. See further for next update.</strong></div>
    <div class="meta">Posted on 2002-04-30 04:33:13 by NaN</div>
   </div>
   <div class="post" id="post-35738">
    <div class="subject"><a href="#post-35738">Give me your Opinion.</a></div>
    <div class="body">win2000<br /><br />I bet you already know that enter/tab/scrolling does not work. It would be easier to test with Ctr-v.<br /><br /><img src="http://home.nc.rr.com/bdjames/test.gif" /><br /><br />Notice the space, that is what happened when<br />resizing the window.</div>
    <div class="meta">Posted on 2002-04-30 05:09:27 by bdjames</div>
   </div>
   <div class="post" id="post-35742">
    <div class="subject"><a href="#post-35742">Give me your Opinion.</a></div>
    <div class="body">It's looking great! :alright:<br /><br /><div class="quote"><br />The .obj is curretly 6Kb...<br /></div><br />Don't forget that an object file contains a lot more than just code so the real code size will probably be much less.<br /><br />Thomas</div>
    <div class="meta">Posted on 2002-04-30 05:18:11 by Thomas</div>
   </div>
   <div class="post" id="post-35745">
    <div class="subject"><a href="#post-35745">Give me your Opinion.</a></div>
    <div class="body">NaN,<br />i'm gonna jump in here with a suggestion. If i was you, i would create a private heap for the control to use. The reason for this? As a control, this will often be included into other projects, and those projects may or may not be running inside an IDE and/or debugger. I have experienced lots of GPFs because the IDE i was working with was screwing with the heap of the process, which was making my asm component/dll fall over. As soon as i created a private heap and started using it, the problems disappeared. And nobody will want to use your component if it falls over all the time while debugging :) I thought i would mention this because it is not a problem you are likely to see immediately, as most asm programmers use very basic editor/debugger setups.</div>
    <div class="meta">Posted on 2002-04-30 06:23:04 by sluggy</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=5058&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=5058&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="5058" /><input type="number" name="page" min="1" max="4" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=5058&amp;page=2">&gt;</a><a href="../?id=5058&amp;page=4">&raquo;</a></form>  </div>
 </body>
</html>