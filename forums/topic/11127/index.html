<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Processing data problem - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=11127" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=11127">Processing data problem</a></p>
   <div class="post" id="post-83906">
    <div class="subject"><a href="#post-83906">Processing data problem</a></div>
    <div class="body">A dll is reading data from the commport. The data is sent to another process by WM_COPYDATA. The recieved data is processed in an algorithm (NMEA proc). <br /><br />Sometimes I have seen the correct sentence in memory at pNMEA. After that it craches. Sometimes it craches before the whole sentence is sorted out.<br /><br />I have not been able to find out why it craches. Could the reason be that a new package is arriving before the process of the previous package is finished? Here is a shorted version of my project.<br /><pre><code><br />DllEntry proc<br />	invoke ReadFile,hComm,lpBuffer,lpBToRead,lpBRead,0<br />	invoke SendMessage,hWin,WM_COPYDATA,0,lpBuffer<br />&#91;color=green&#93;;	A read data package is 8 bytes long. A package takes appr <br />;	13 msec to read at 4800 bauds. Packages are continuously <br />;	read for appr 1 sec. Last package could contain less than <br />;	8 bytes. Then there is a pause for appr 1 sec. The reading <br />;	cycle is every 2 sec. Every package is sent as a copydata <br />;	message to the DlgProc. The data is ascii characters.&#91;/color&#93;<br />End DllEntry<br /><br />DlgProc proc hWin&#58;HWND,uMsg&#58;UINT,wParam&#58;WPARAM,lParam&#58;LPARAM<br />	<br />	mov eax,hWin<br />	mov hDlg,eax<br />	mov	eax,uMsg<br />	.if eax==WM_INITDIALOG<br />	.elseif eax==WM_COMMAND<br />	.elseif eax==WM_COPYDATA <br />		mov esi,lParam<br />		invoke lstrlen,lParam<br />		mov nBytes,eax<br />		mov ecx,nBytes<br />		mov edi,pMem<br />		rep movsb &#91;color=green&#93;;Sent data is copied to pMEM&#91;/color&#93;<br />		&#91;color=blue&#93;.if PauseBTN==FALSE <br />			invoke SendMessage,hEdt1,EM_REPLACESEL,FALSE,pMem<br />		.endif&#91;/color&#93;<br />		call NMEA &#91;color=green&#93;;Processing the data&#91;/color&#93;<br />		invoke RtlZeroMemory,pMem,10<br />	.elseif eax==WM_CLOSE<br />	.else<br />	.endif<br />	mov eax,TRUE<br />	ret <br /><br />DlgProc endp<br /><br />NMEA proc &#91;color=blue&#93;uses edi edx&#91;/color&#93;<br />	&#91;color=green&#93;;This algo will sort out a special sentence starting<br />	;with &quot;RMC&quot; and ending with a 0Dh character.<br />	;First thing to do is to seach for &quot;RMC&quot;.<br />	;&quot;RMC&quot; is united with each other but not<br />	;necessarily i the same package. The flaggs<br />	;flRMC, flRM and flR are initially false&#91;/color&#93;<br />	mov edx,pMem<br />	xor ecx,ecx<br />	.if flRMC==TRUE<br />		mov edi,pointer<br />		&#91;color=blue&#93;;dec ecx&#91;/color&#93;<br />		jmp lbl_FoundRMC<br />	.elseif flRM==TRUE<br />		mov edi,pointer<br />		&#91;color=blue&#93;;dec ecx&#91;/color&#93;<br />		jmp lbl_FoundRM<br />	.elseif flR==TRUE <br />		mov edi,pointer<br />		&#91;color=blue&#93;;dec ecx&#91;/color&#93;<br />		jmp lbl_FoundR<br />	.else<br />		mov edi,offset pNMEA<br />@@&#58;<br />		&#91;color=green&#93;;Find R======================================&#91;/color&#93;<br />		cmp byte ptr &#91;edx+ecx&#93;,&quot;R&quot;<br />		je @F<br />		inc ecx &#91;color=green&#93;;Next read byte&#91;/color&#93;<br />		cmp ecx,nBytes<br />		je lbl_NotFound &#91;color=green&#93;;R not found among read bytes.&#91;/color&#93;<br />		jmp @B<br />@@&#58;<br />		&#91;color=green&#93;;R found next should be M====================&#91;/color&#93;<br />		mov flR,TRUE<br />		mov al,byte ptr &#91;edx+ecx&#93;<br />		mov byte ptr &#91;edi&#93;,al &#91;color=green&#93;;Store R in the pNMEA&#91;/color&#93;<br />&#91;color=green&#93;;lbl_FoundR&#58;&#91;/color&#93;<br />		inc ecx &#91;color=green&#93;;Next read byte&#91;/color&#93;<br />&#91;color=blue&#93;lbl_FoundR&#58;&#91;/color&#93;<br />		cmp ecx,nBytes<br />		je lbl_NotFound &#91;color=green&#93;;R was the last byte among read bytes.&#91;/color&#93;<br />		&#91;color=green&#93;;Find M======================================&#91;/color&#93;<br />		cmp byte ptr &#91;edx+ecx&#93;,&quot;M&quot;<br />		jne lbl_NotFoundRM &#91;color=green&#93;;Could not be RMC.&#91;/color&#93;<br />		mov flRM,TRUE &#91;color=green&#93;;M was found&#91;/color&#93;<br />		inc edi &#91;color=green&#93;;increase pointer in pNMEA&#91;/color&#93;<br />		mov al,byte ptr &#91;edx+ecx&#93;<br />		mov byte ptr &#91;edi'#93;,al &#91;color=green&#93;;Store M in 2nd position in the pNMEA&#91;/color&#93;<br />&#91;color=green&#93;;lbl_FoundRM&#58;&#91;/color&#93;<br />		inc ecx &#91;color=green&#93;;Next read byte. Should be C&#91;/color&#93;<br />&#91;color=blue&#93;lbl_FoundRM&#58;&#91;/color&#93;<br />		cmp ecx,nBytes<br />		je lbl_NotFound<br />		&#91;color=green&#93;;Find C======================================&#91;/color&#93;<br />		cmp byte ptr &#91;edx+ecx&#93;,&quot;C&quot;<br />		jne lbl_NotFoundRMC &#91;color=green&#93;;Could not be RMC. Zeroing for new seach&#91;/color&#93;<br />		mov flRMC,TRUE &#91;color=green&#93;;C was found&#91;/color&#93;<br />		inc edi &#91;color=green&#93;;increase pointer in pNMEA&#91;/color&#93;<br />		mov al,byte ptr &#91;edx+ecx&#93;<br />		mov byte ptr &#91;edi&#93;,al &#91;color=green&#93;;Store C in the pNMEA&#91;/color&#93;<br />	.endif <br />@@&#58;<br />&#91;color=green&#93;;lbl_FoundRM&#58;&#91;/color&#93;<br />	&#91;color=green&#93;;Following bytes is to be read <br />	;while byte not is equal to 0Dh&#91;/color&#93;<br />	inc ecx<br />&#91;color=blue&#93;lbl_FoundRMC&#58;&#91;/color&#93;<br />	cmp ecx,nBytes<br />	je lbl_NotFound &#91;color=green&#93;;Retrieve next read bytes to store in pNMEA&#91;/color&#93;<br />	cmp byte ptr &#91;edx+ecx&#93;,0Dh<br />	je @F<br />	inc edi &#91;color=green&#93;;increase pointer in pNMEA&#91;/color&#93;<br />	mov al,byte ptr &#91;edx+ecx&#93; &#91;color=green&#93;;Store in next position in the pNMEA&#91;/color&#93;<br />	mov byte ptr &#91;edi&#93;,al &#91;color=green&#93;;Store in next position in the pNMEA&#91;/color&#93;<br />	jmp @B<br />@@&#58;	<br />	&#91;color=red&#93;invoke SendMessage,hEdt5,WM_SETTEXT,FALSE,&#91;/color&#93;&#91;color=blue&#93;addr pNMEA&#91;/color&#93;<br />	&#91;color=green&#93;;Here is the result. The RMC sentence.&#91;/color&#93;<br />	ret<br />lbl_NotFoundRMC&#58;	<br />	mov flRM,FALSE <br />lbl_NotFoundRM&#58;	<br />	mov flR,FALSE<br />	invoke RtlZeroMemory,&#91;color=blue&#93;addr pNMEA&#91;/color&#93;,100<br />	ret<br />lbl_NotFound&#58;<br />	mov pointer,edi<br />	ret<br /><br />NMEA endp<br /></code></pre><br /><br />If you have the stamina to read and penetrate all this I would be grateful to suggestions why it craches and suggestions on a faster sorting out algo.<br /><br />Regards</div>
    <div class="meta">Posted on 2003-02-26 15:51:05 by minor28</div>
   </div>
   <div class="post" id="post-83939">
    <div class="subject"><a href="#post-83939">Processing data problem</a></div>
    <div class="body">I remember having programs crash when I would use the EDI register without restoring its original value before exiting the code where I was using that register. I can't remember having had similar problems with other registers.<br /><br />(Maybe some internal function expect that EDI register not be tampered with.)<br /><br />You may want to try saving and restoring that register and see if it helps to avoid crashes.<br /><br />Raymond</div>
    <div class="meta">Posted on 2003-02-26 22:38:54 by Raymond</div>
   </div>
   <div class="post" id="post-83941">
    <div class="subject"><a href="#post-83941">Processing data problem</a></div>
    <div class="body"><pre><code>invoke SendMessage,hEdt1,WM_SETTEXT,FALSE, &#91;color=blue&#93;OFFSET pNMEA&#91;/color&#93;</code></pre>remember this is not FASM ;)</div>
    <div class="meta">Posted on 2003-02-26 23:25:47 by arkane</div>
   </div>
   <div class="post" id="post-83988">
    <div class="subject"><a href="#post-83988">Processing data problem</a></div>
    <div class="body">pNMEA is abit misleading, I would assume pNMEA is a pointer, yet it is not.</div>
    <div class="meta">Posted on 2003-02-27 07:00:38 by roticv</div>
   </div>
   <div class="post" id="post-84008">
    <div class="subject"><a href="#post-84008">Processing data problem</a></div>
    <div class="body">this is the code that made me decide that pNMEA is not a pointer<pre><code>mov edi,offset pNMEA</code></pre>:grin:</div>
    <div class="meta">Posted on 2003-02-27 10:14:39 by arkane</div>
   </div>
   <div class="post" id="post-84016">
    <div class="subject"><a href="#post-84016">Processing data problem</a></div>
    <div class="body">I can't say that preserving edi did any improvments, possible edx did. I have edit the code above with blue text. As you can se I can write all characters in Edt1. Occasionally the RMC sentence i written in Edt5. The sentenc starts with a RMC but is not ended as it should, as if the 0Dh character not was found.<br /><br />If I watch the read characters in Edt1 and the &quot;Call NMEA&quot; -line is commented all characters are written correctly. Uncommenting the line and several characters are missing. Occasionally &quot;RMC&quot; turns up.<br /><br />As I am a hobby coder and have neither experience nor education in programming apart from Iczelion's excellent tutorials I would very much appreciate if you could enlighten me in denomination conventions. How should I denominate pNMEA. I know it is the address to a place were the address to the data is hold. What is the conventions in general.<br /><br />P.S.<br />Came to think of &quot;as if the 0Dh character not was found.&quot;. I did forget to restore the flags to false. Now it works. The problem must have been exceeding the limit of pNMEA memory space.<br />(this is an edit of the reply)<br /><br />Regards</div>
    <div class="meta">Posted on 2003-02-27 11:43:11 by minor28</div>
   </div>
  </div>
 </body>
</html>