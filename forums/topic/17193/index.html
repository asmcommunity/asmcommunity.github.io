<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Drawing controles on back buffer - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=17193" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=17193">Drawing controles on back buffer</a></p>
   <div class="post" id="post-133278">
    <div class="subject"><a href="#post-133278">Drawing controles on back buffer</a></div>
    <div class="body">I tried to use back buffer technique on icezilion &quot;paint text&quot; example, to make flicker free window, and it works. However, when I add some control on that window like static control, flicker shows up again but only withing client area of that static. This is esspecialy the true if static has bitmap/icon in it, rather than just text.<br />So how can I make control flicker free? I tried sending WM_PAINT to control, and specifying hdc of main window this works well except that static image is drawn on 0,0 starting point of main window which is not what I want.<br /><br />Any other ideas? Is subclassing way to go?</div>
    <div class="meta">Posted on 2004-02-12 08:27:07 by Mikky</div>
   </div>
   <div class="post" id="post-133304">
    <div class="subject"><a href="#post-133304">Drawing controles on back buffer</a></div>
    <div class="body">Hi Mikky,<br /><br />Getting rid of flicker is a big problem. Alot of the time it is not the WM_PAINT handler but the WM_ERASEBKGND of the main window that is causing the flicker in controls. It depends on where the actual flicker is, inside the client area or on the border of the control. Is there a way you can post an example of a window that is doing this ?</div>
    <div class="meta">Posted on 2004-02-12 14:21:51 by donkey</div>
   </div>
   <div class="post" id="post-133314">
    <div class="subject"><a href="#post-133314">Drawing controles on back buffer</a></div>
    <div class="body">Hey Donkey,<br /><br />I just readed that tutorial from icezilion site about flickering and applied it to icezilion example about painting text<br /><br /><pre><code><br />	.ELSEIF uMsg == WM_ERASEBKGND<br />		mov eax,1<br />		ret<br />	.ELSEIF uMsg==WM_PAINT<br />		INVOKE BeginPaint, hWnd, ADDR ps<br />	<br />		INVOKE PaintScreen,hWnd<br />		<br />		INVOKE EndPaint, hWnd, ADDR ps<br /><br /></code></pre><br /><br />and the PaintScreen proc is<br /><br /><pre><code><br />PaintScreen		proc	hMainWnd&#58;dword<br />	;============================<br />	; LOCAL VARIABLES<br />	;============================<br />	LOCAL	hDC		&#58;DWORD<br />	LOCAL	hMemDC		&#58;DWORD<br />	LOCAL	ScreenRect	&#58;RECT<br />	LOCAL	hBitmap		&#58;DWORD	<br /><br />	;=================================<br />	; Get the client rectangle<br />	;=================================<br />	INVOKE GetClientRect, hMainWnd, ADDR ScreenRect<br /><br />	;============================<br />	; get the DC<br />	;============================<br />	INVOKE GetDC, hMainWnd<br />	MOV	hDC, EAX<br />	<br />	<br />		;============================<br />		; Create a compatible DC<br />		;============================<br />		INVOKE CreateCompatibleDC, hDC<br />		MOV	hMemDC, EAX<br />	<br />		;==============================<br />		; Now create a Bitmap for that<br />		; offscreen DC<br />		;==============================<br />;		MOV	EAX, ScreenRect.right<br />;		SUB	EAX, ScreenRect.left<br />;		MOV	EBX, ScreenRect.bottom<br />;		SUB	EBX, ScreenRect.top<br />		INVOKE CreateCompatibleBitmap, hDC, ScreenRect.right,ScreenRect.bottom;EAX, EBX<br />		MOV	hBitmap, EAX<br />		;=============================<br />		; Select that bitmap into the<br />		; object, preserve old<br />		;=============================<br />		INVOKE SelectObject, hMemDC, hBitmap<br />		PUSH	EAX<br /><br />		;=============================<br />		; Erase the Background<br />		;=============================<br />		INVOKE GetSysColor, COLOR_WINDOW<br />		INVOKE CreateSolidBrush, EAX<br />		PUSH	EAX<br />		INVOKE FillRect, hMemDC, ADDR ScreenRect, EAX<br />		POP	EAX<br />		INVOKE DeleteObject,EAX<br /><br />INVOKE GetClientRect, hMainWnd, ADDR ScreenRect<br />invoke	GetStockObject,BLACK_BRUSH<br /><br />invoke	FillRect,hMemDC,addr ScreenRect,eax<br /><br />invoke DrawText, hMemDC,ADDR OurText,-1, ADDR ScreenRect, DT_SINGLELINE or DT_CENTER or DT_VCENTER<br />	<br /><br />		;===========================<br />		; Copy buffer to actual<br />		;===========================<br />		MOV	EAX, ScreenRect.right<br />		SUB	EAX, ScreenRect.left<br />		MOV	EBX, ScreenRect.bottom<br />		SUB	EBX, ScreenRect.top<br />		INVOKE BitBlt,hDC, ScreenRect.left, ScreenRect.top, EAX, EBX,\<br />				hMemDC, 0, 0, SRCCOPY<br /><br />		;============================<br />		; Select old int hMemDC<br />		;============================<br />		POP	EAX<br />		INVOKE SelectObject, hMemDC, EAX<br /><br />		;============================<br />		; Delete the Compatible DC<br />		;============================<br />		INVOKE DeleteDC, hMemDC<br /><br />		;===============================<br />		; Delete the Compatible Bitmap<br />		;===============================<br />		INVOKE DeleteObject, hBitmap<br /><br />	;================================<br />	; release the device context<br />	;================================<br />	INVOKE ReleaseDC, hMainWnd, hDC<br />		<br />	ret<br /><br />PaintScreen endp<br /></code></pre><br /><br />But this code works just fine, the problem arise when I add static control with CreateWindowEx somewhere on window in which I want to show text/bitmap/icon. Then flicker is visible inside client area of that static control, when I resize main window. I dunno how to solve this, if I could tell static to draw it self on memory Dc and then to copy that DC to its client area, then I think it could solve the problem... What do you think?</div>
    <div class="meta">Posted on 2004-02-12 17:50:06 by Mikky</div>
   </div>
   <div class="post" id="post-133320">
    <div class="subject"><a href="#post-133320">Drawing controles on back buffer</a></div>
    <div class="body">Well, just looking at the routine it has a couple of problems. First off, it should not use EBX without preserving it, it could just as easily use any other register in that place. Second there is no need to get the DC in this case as that is returned in eax from BeginPaint, it should be something like:<br /><br /><pre><code>INVOKE BeginPaint, hWnd, ADDR ps<br />INVOKE PaintScreen,hWnd,eax<br />INVOKE EndPaint, hWnd, ADDR ps<br /><br />PaintScreen		proc	hMainWnd&#58;dword,hDC&#58;DWORD</code></pre><br /><br />Also it is painting the background a couple of times (actually 3 times). There is no need to continually get the client rectangle if you don't change the values in the RECT structure. Also you should use SetTextColor and SetBkMode when painting text or you'll get weird results. There are a few other things. I have included a routine that will replace the static with a bitmap, you can set the offset where the bitmap will be painted to anywhere you like. I tried the code with these modifications and I did not get any flicker.<br /><br /><pre><code>PaintScreen		FRAME	hMainWnd,hDC<br />	;============================<br />	; LOCAL VARIABLES<br />	;============================<br />	LOCAL	hMemDC		&#58;D<br />	LOCAL	ScreenRect	&#58;RECT<br />	LOCAL	hBitmap		&#58;D<br />	LOCAL	hStatMemDC	&#58;D<br /><br />	;=================================<br />	; Get the client rectangle<br />	;=================================<br />	INVOKE GetClientRect, &#91;hMainWnd&#93;, ADDR ScreenRect<br /><br />		;============================<br />		; Create a compatible DC<br />		;============================<br />		INVOKE CreateCompatibleDC, &#91;hDC&#93;<br />		MOV	&#91;hMemDC&#93;, EAX<br />	<br />		;==============================<br />		; Now create a Bitmap for that<br />		; offscreen DC<br />		;==============================<br />		INVOKE CreateCompatibleBitmap, &#91;hDC&#93;, \<br />			&#91;ScreenRect.right&#93;,&#91;ScreenRect.bottom&#93;<br />		MOV	&#91;hBitmap&#93;, EAX<br />		;=============================<br />		; Select that bitmap into the<br />		; object, preserve old<br />		;=============================<br />		INVOKE SelectObject, &#91;hMemDC&#93;, &#91;hBitmap&#93;<br />		PUSH	EAX<br /><br />		;=============================<br />		; Erase the Background<br />		;=============================<br />		INVOKE GetSysColor, COLOR_WINDOW<br />		INVOKE CreateSolidBrush, EAX<br />		PUSH	EAX<br />		INVOKE FillRect, &#91;hMemDC&#93;, ADDR ScreenRect, EAX<br />		POP	EAX<br />		INVOKE DeleteObject,EAX<br /><br />&#91;b&#93;		;=============================<br />		; Paint the bitmap<br />		;=============================<br />		invoke CreateCompatibleDC, &#91;hDC&#93;<br />		mov	&#91;hStatMemDC&#93;,eax<br />		invoke SelectObject, &#91;hStatMemDC&#93;,&#91;hStatBitmap&#93;<br />		push eax<br />		; note 10,10 is the x,y offset of the bitmap<br />		invoke BitBlt,&#91;hMemDC&#93;, 10, 10, 100, 100,\<br />			&#91;hStatMemDC&#93;, 0, 0, SRCCOPY<br />		pop eax<br />		invoke SelectObject,&#91;hStatMemDC&#93;,eax<br />		invoke DeleteDC,&#91;hStatMemDC&#93;&#91;/b&#93;<br /><br />invoke SetTextColor,&#91;hMemDC&#93;,00FFFFh<br />invoke SetBkMode,&#91;hMemDC&#93;,TRANSPARENT<br /><br />invoke DrawText, &#91;hMemDC&#93;,ADDR OurText,-1, ADDR ScreenRect,\<br />	DT_SINGLELINE+DT_CENTER +DT_VCENTER<br /><br />		;===========================<br />		; Copy buffer to actual<br />		;===========================<br />		MOV	EAX, &#91;ScreenRect.right&#93;<br />		SUB	EAX, &#91;ScreenRect.left&#93;<br />		MOV	edx, &#91;ScreenRect.bottom&#93;<br />		SUB	edx, &#91;ScreenRect.top&#93;<br />		INVOKE BitBlt,&#91;hDC&#93;, &#91;ScreenRect.left&#93;, &#91;ScreenRect.top&#93;,\<br />			 EAX, edx,&#91;hMemDC&#93;, 0, 0, SRCCOPY<br /><br />		;============================<br />		; Select old int hMemDC<br />		;============================<br />		POP	EAX<br />		INVOKE SelectObject, &#91;hMemDC&#93;, EAX<br /><br />		;============================<br />		; Delete the Compatible DC<br />		;============================<br />		INVOKE DeleteDC, &#91;hMemDC&#93;<br /><br />		;===============================<br />		; Delete the Compatible Bitmap<br />		;===============================<br />		INVOKE DeleteObject, &#91;hBitmap&#93;<br />		<br />	ret<br /><br />ENDF</code></pre></div>
    <div class="meta">Posted on 2004-02-12 19:51:19 by donkey</div>
   </div>
   <div class="post" id="post-133345">
    <div class="subject"><a href="#post-133345">Drawing controles on back buffer</a></div>
    <div class="body">You need to clip this static control, it's easy. <br />in WindowCreateEx ,....  as &quot;style&quot; set &quot;WS_CLIPCHILDREN&quot;</div>
    <div class="meta">Posted on 2004-02-13 02:33:36 by Ultrano</div>
   </div>
  </div>
 </body>
</html>