<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Icq... - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=4891" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=8">Networking</a> &raquo; <a href="../?id=4891">Icq...</a></p>
   <div class="post" id="post-34270">
    <div class="subject"><a href="#post-34270">Icq...</a></div>
    <div class="body">Hello, i have attached the source code that i have been having some problems with, it is suppose to notify me on icq.....<br /><br />oh wel here is the code:<br /><br />.if eax==IDC_BTN1<br />		 	invoke socket,AF_INET,SOCK_STREAM,0<br />			mov sock,eax			<br />			mov sin.sin_family, AF_INET <br />			invoke htons, Port <br />			mov sin.sin_port,ax<br />			invoke gethostbyname,addr HostName<br />			mov eax,<br />			mov eax,                     <br />			mov eax,   <br />			mov sin.sin_addr,eax<br />			invoke connect,sock,addr sin,sizeof sin<br />			invoke send,sock,addr ctext,sizeof ctext,0<br />			invoke closesocket,sock<br />		.endif<br /><br /><br /><br />where ctext:<br /><br />ctext db 'POST <a target="_blank" href="http://wwp.icq.com/scripts/WWPMsg.dll">http://wwp.icq.com/scripts/WWPMsg.dll</a> HTTP/2.0',13,10<br />      db 'Referer: <a target="_blank" href="http://wwp.mirabilis.com">http://wwp.mirabilis.com</a>',13,10<br />      db 'Connection: Keep-Alive',13,10<br />      db 'Host: wwp.mirabilis.com:80',13,10<br />      db 'Content-type: application/x-www-form-urlencoded',13,10<br />      db 'Content-length:8000',13,10<br />      db 'Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*',13,10,13,10<br />      db 'from=Tsongkie &amp;fromemail=tsongkie@cayamanan.com &amp;fromicq:110206786 &amp;body=Hello &amp;to=118494738&amp;Send=',0<br /><br /><br /><br /><br />I'm trying to translate this code that i found.... Its in Delphi/Pascal, maybe someone else can try....<br /><br />procedure TForm1.Button1Click(Sender: TObject); <br />begin <br />  cSend := 'POST <a target="_blank" href="http://wwp.icq.com/scripts/WWPMsg.dll">http://wwp.icq.com/scripts/WWPMsg.dll</a> HTTP/2.0' + chr(13) + chr(10); <br />  cSend := cSend + 'Referer: <a target="_blank" href="http://wwp.mirabilis.com">http://wwp.mirabilis.com</a>' + chr(13) + chr(10); <br />  cSend := cSend + 'User-Agent: Mozilla/4.06 (Win95; I)' + chr(13) + chr(10); <br />  cSend := cSend + 'Connection: Keep-Alive' + chr(13) + chr(10); <br />  cSend := cSend + 'Host: wwp.mirabilis.com:80' + chr(13) + chr(10); <br />  cSend := cSend + 'Content-type: application/x-www-form-urlencoded' + chr(13) + chr(10); <br />  cSend := cSend + 'Content-length:8000' + chr(13) + chr(10); <br />  cSend := cSend + 'Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*' + <br />    chr(13) + chr(10) + chr(13) + chr(10); <br />  cSend := cSend + 'from=' + edit1.Text + ' &amp;fromemail=' + edit2.Text + <br />    ' &amp;fromicq:110206786' + ' &amp;body=' + memo1.Text + ' &amp;to=' + edit3.Text + '&amp;Send='; <br />  clientsocket1.Active := True; <br />end; <br /><br />procedure TForm1.ClientSocket1Connect(Sender: TObject; <br />  Socket: TCustomWinSocket); <br />begin <br />  clientsocket1.Socket.SendText(csend); <br />  clientsocket1.Active := False; <br />end; <br /><br /><br />Sorry for the long post...</div>
    <div class="meta">Posted on 2002-04-21 10:20:03 by Tsongkie[ii]</div>
   </div>
   <div class="post" id="post-34276">
    <div class="subject"><a href="#post-34276">Icq...</a></div>
    <div class="body">First of all, the sizeof(ctext) will only give you the size of the first line of text. Use this instead:<br /><pre><code><br />string db &quot;gewgwe&quot;<br />     db &quot;wefefwfew&quot;<br />size_string equ $-string<br /></code></pre><br /><br />Secondly, you shouldn't send the 0 byte at the end of the request.<br /><br />Finally, with the above modifications, the data is sent, but not in the right way. You have set content-length to a fixed number, it should be the actual size of the posted data (starting with 'from'). If you specify 8000 the server will wait until you've sent it 8000 bytes. So first calculate the size of the posted data, put that in the header, send the header, and then send the actual data.<br /><br />One last thing: you shouldn't use spaces between the different variables<br />(...from=Tsongkie{no space here}&amp;fromem..).<br /><br />Thomas</div>
    <div class="meta">Posted on 2002-04-21 10:40:12 by Thomas</div>
   </div>
   <div class="post" id="post-34355">
    <div class="subject"><a href="#post-34355">Icq...</a></div>
    <div class="body">Hey thanks for the reply... but when i used:<br /><br />string db &quot;gewgwe&quot;<br />     db &quot;wefefwfew&quot;<br />size_string equ $-string<br /><br />I get an error: error A2025: operands must be in same segment<br /><br />also, i'm pretty new at this stuff so how can i send the data withouth the 0?</div>
    <div class="meta">Posted on 2002-04-21 19:57:59 by Tsongkie[ii]</div>
   </div>
   <div class="post" id="post-35301">
    <div class="subject"><a href="#post-35301">Icq...</a></div>
    <div class="body"><pre><code><br />...<br />ctext db 'POST &#40;...&#41;<br />...<br />db 'from=Tsongkie &amp;fromemail=tsongkie@cayamanan.com &amp;fromicq&#58;110206786 &amp;body=Hello &amp;to=118494738&amp;Send='&#91;B&#93;,0<br /> &#91;/B&#93;size_of_ctext equ $ - ctext<br />...<br /></code></pre><br /><br />remove the text in <strong>bold</strong>.<br />if size_of_ctext gives an error put:<br /><pre><code><br />size_of_ctext equ $ - offset ctext<br /></code></pre><br /><br />dunno if it works.<br /><br />cu<br /><br />Coder7345/ jEAN</div>
    <div class="meta">Posted on 2002-04-27 12:04:33 by coder</div>
   </div>
   <div class="post" id="post-35304">
    <div class="subject"><a href="#post-35304">Icq...</a></div>
    <div class="body">Here is *correct* and working C code, don't use the source you found as it is wrong.<br /><pre><code><br />#define CRLF &quot;\r\n&quot;<br /><br />char requestFormat&#91;&#93; = <br />&#123;<br />    &quot;POST &#91;url&#93;http&#58;//wwp.icq.com/scripts/WWPMsg.dll&#91;/url&#93; HTTP/1.1&quot; CRLF<br />    &quot;Referer&#58; &#91;url&#93;http&#58;//wwp.mirabilis.com&#91;/url&#93;&quot; CRLF<br />    &quot;Connection&#58; Keep-Alive&quot; CRLF<br />    &quot;Host&#58; wwp.mirabilis.com&quot; CRLF<br />    &quot;Content-type&#58; application/x-www-form-urlencoded&quot; CRLF<br />    &quot;Content-length&#58; %lu&quot; CRLF<br />    &quot;Accept&#58; image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*&quot; CRLF<br />    CRLF<br />&#125;;<br /><br />char postFormat&#91;&#93; = <br />&#123;<br />    &quot;from=%s&quot;           //1st = from<br />    &quot;&amp;fromemail=%s&quot;     //2nd = email<br />    &quot;&amp;fromicq=%lu&quot;      //3rd = from icq<br />    &quot;&amp;body=%s&quot;          //4th = body<br />    &quot;&amp;to=%lu&quot;           //5th = to icq<br />    &quot;&amp;Send=&quot;<br />&#125;;<br /><br />#define PORTNR&#40;x&#41; &#40;&#40;x&amp;0xFF&#41;&lt;&lt;8|&#40;x&amp;0xFF00&#41;&gt;&gt;8&#41;<br /><br />int main&#40;int argc, char* argv&#91;&#93;&#41;<br />&#123;<br />    WSADATA wsaData;<br />    WSAStartup&#40;2,&amp;wsaData&#41;;<br />    <br />    char    headerBuf&#91;1024&#93;;<br />    char    postData&#91;2048&#93;;<br /><br />    wsprintf&#40;postData,postFormat,<br />             &quot;Thomas&quot;,<br />             &quot;nobody@invalid.mail&quot;,<br />             12345678,<br />             &quot;This%20is%20a%20test%20message&quot;,<br />             &lt;&lt;your icq here&gt;&gt;&#41;;<br /><br />    wsprintf&#40;headerBuf,requestFormat,<br />             lstrlen&#40;postData&#41;&#41;;<br /><br />    SOCKET hSocket = socket&#40;AF_INET, SOCK_STREAM, 0&#41;;<br /><br />    sockaddr_in sockAddr;<br /><br />    DWORD serverIP = &#40;&#40;long*&#41;gethostbyname&#40;&quot;wwp.icq.com&quot;&#41;-&gt;h_addr_list&#91;0&#93;&#41;&#91;0&#93;;<br /><br />    sockAddr.sin_addr.S_un.S_addr = serverIP;<br />    sockAddr.sin_port = PORTNR&#40;80&#41;;<br />    sockAddr.sin_family = AF_INET;<br />    <br />    connect&#40;hSocket, &#40;sockaddr*&#41;&amp;sockAddr, sizeof&#40;sockAddr&#41;&#41;;<br /><br />    send&#40;hSocket, headerBuf, lstrlen&#40;headerBuf&#41;, 0&#41;;<br />    send&#40;hSocket, postData, lstrlen&#40;postData&#41;, 0&#41;;<br /><br /><br />    closesocket&#40;hSocket&#41;;<br /><br />    WSACleanup&#40;&#41;;<br />    return 0;<br />&#125;<br /></code></pre><br /><br />Thomas</div>
    <div class="meta">Posted on 2002-04-27 12:35:54 by Thomas</div>
   </div>
   <div class="post" id="post-35313">
    <div class="subject"><a href="#post-35313">Icq...</a></div>
    <div class="body">mmm nice :) ... easy to convert 2 assembly. And this code help me to undestand how i do a &quot;raw POST&quot; on a site.<br /><br />cu<br /><br />Coder7345 / jEAN</div>
    <div class="meta">Posted on 2002-04-27 14:27:16 by coder</div>
   </div>
   <div class="post" id="post-35319">
    <div class="subject"><a href="#post-35319">Icq...</a></div>
    <div class="body">Don't forget that all posted data has to be www/url encoded, i.e. special characters (special characters = [^A-Za-z0-9_] to be safe) have to be converted to their hex equivalents %XX.<br /><br />Thomas</div>
    <div class="meta">Posted on 2002-04-27 15:56:37 by Thomas</div>
   </div>
   <div class="post" id="post-35419">
    <div class="subject"><a href="#post-35419">Icq...</a></div>
    <div class="body">actually thomas i was having trouble finding a way to convert a string to hex .. i was making a program to post to an .asp page but it didnt work if the the string had those charactors any help with a sample code or a point iin the right direction?</div>
    <div class="meta">Posted on 2002-04-28 11:53:25 by illwill</div>
   </div>
   <div class="post" id="post-35425">
    <div class="subject"><a href="#post-35425">Icq...</a></div>
    <div class="body">source: esi<br />dest: edi<br /><br /><pre><code><br />    dec     edi<br />_nc&#58;<br />    movzx   eax, byte ptr &#91;esi&#93;<br />    <br />    test    al, al  ; al==0<br />    jz      _done<br />    <br />    inc     edi<br />    inc     esi<br />    <br />    cmp     al, 41h ; al=='A'<br />    mov     cl, al<br />    jb      _lA<br />    <br />    cmp     al, 5Bh ; al=='Z'<br />    jbe     _cpy<br />        <br />    ;al &gt;= A<br />    cmp     al, 5Fh ; al=='_'<br />    je      _cpy<br />    <br />    ;al &gt; _<br />    cmp     al, 61h ; al=='a'<br />    jb      _hex<br />    <br />    ; al &gt;= a<br />    cmp     al, 7Ah ; al=='z'<br />    jbe     _cpy<br /><br />_hex&#58;<br />    ror     ax, 4<br />    mov     byte ptr &#91;edi&#93;, '%'<br />    shr     ah, 4<br />    add     edi, 2<br />    add     al, 30h<br />    cmp     al, 3Ah<br />    jb      @F<br />    add     al, 41h-3Ah<br />    @@&#58;<br />    add     ah, 30h<br />    cmp     ah, 3Ah<br />    jb      @F<br />    add     ah, 41h-3Ah<br />    @@&#58;<br />    mov     word ptr &#91;edi-1&#93;, ax<br />    jmp     _nc<br />    <br />_cpy&#58;<br />    mov     &#91;edi&#93;, al<br />    jmp     _nc<br />    <br />_space&#58;<br />    mov     byte ptr &#91;edi&#93;, '+'<br />    jmp     _nc<br />    <br />_lA&#58;<br />    cmp     al, 20h<br />    je      _space<br />    <br />    sub     cl, 2Dh ; al=='-'<br />    jz      _cpy<br />    dec     cl      ; al=='.'<br />    jz      _cpy<br />    <br />    cmp     al, 30h ; al=='0'<br />    jb      _hex<br />    <br />    ;al &gt;= '0'<br />    cmp     al, 39h ; al=='9'<br />    jbe     _cpy<br />    <br />    jmp     _hex<br />_done&#58;<br />    mov     byte ptr &#91;edi&#93;,0<br /></code></pre><br /><br />output buffer needs to be large enough to hold the converted data, which is 3*source_length in the *worst case*.<br />I think you can build the proc around it yourself :)<br /><br />Thomas</div>
    <div class="meta">Posted on 2002-04-28 12:45:22 by Thomas</div>
   </div>
   <div class="post" id="post-35845">
    <div class="subject"><a href="#post-35845">Icq...</a></div>
    <div class="body">yea i mad it into a process called hexit  thanxfor the help  .. here is the process for other to uses that needed help like me thanx again for the help<br /><br />hexit PROTO :DWORD, :DWORD<br /><br />.data<br />stringsrc db &quot;!@#$%^%^*()~ omg! it's converted to hex!?&quot;,0<br /><br />.data?<br />stringdest byte 255 dup (?)<br /><br /><br />.code<br />start:<br />invoke hexit,addr stringsrc,addr stringdest<br />invoke MessageBox,0,addr stringdest,addr stringsrc,MB_OK<br />invoke ExitProcess,0<br /><br />hexit PROC szSRC:DWORD,szDEST:DWORD<br />   push esi<br />   push edi<br />   mov esi,szSRC<br />   mov edi,szDEST<br />   <br />dec     edi<br />_nc:<br />    movzx   eax, byte ptr <br />    <br />    test    al, al  ; al==0<br />    jz      _done<br />    <br />    inc     edi<br />    inc     esi<br />    <br />    cmp     al, 41h ; al=='A'<br />    mov     cl, al<br />    jb      _lA<br />    <br />    cmp     al, 5Bh ; al=='Z'<br />    jbe     _cpy<br />        <br />    ;al &gt;= A<br />    cmp     al, 5Fh ; al=='_'<br />    je      _cpy<br />    <br />    ;al &gt; _<br />    cmp     al, 61h ; al=='a'<br />    jb      _hex<br />    <br />    ; al &gt;= a<br />    cmp     al, 7Ah ; al=='z'<br />    jbe     _cpy<br /><br />_hex:<br />    ror     ax, 4<br />    mov     byte ptr , '%'<br />    shr     ah, 4<br />    add     edi, 2<br />    add     al, 30h<br />    cmp     al, 3Ah<br />    jb      @F<br />    add     al, 41h-3Ah<br />    @@:<br />    add     ah, 30h<br />    cmp     ah, 3Ah<br />    jb      @F<br />    add     ah, 41h-3Ah<br />    @@:<br />    mov     word ptr , ax<br />    jmp     _nc<br />    <br />_cpy:<br />    mov     , al<br />    jmp     _nc<br />    <br />_space:<br />    mov     byte ptr , '+'<br />    jmp     _nc<br />    <br />_lA:<br />    cmp     al, 20h<br />    je      _space<br />    <br />    sub     cl, 2Dh ; al=='-'<br />    jz      _cpy<br />    dec     cl      ; al=='.'<br />    jz      _cpy<br />    <br />    cmp     al, 30h ; al=='0'<br />    jb      _hex<br />    <br />    ;al &gt;= '0'<br />    cmp     al, 39h ; al=='9'<br />    jbe     _cpy<br />    <br />    jmp     _hex<br />_done:<br />    mov     byte ptr ,0<br />   pop esi<br />   pop edi<br />   ret<br />hexit ENDP<br /><br />end start</div>
    <div class="meta">Posted on 2002-04-30 17:18:26 by illwill</div>
   </div>
   <div class="post" id="post-35850">
    <div class="subject"><a href="#post-35850">Icq...</a></div>
    <div class="body">A procedure, not a process ;).<br />A couple of notes... you don't have to do numeric comparisons, you<br />can do &quot;cmp al, '_'&quot; or &quot;cmp al, 'Z'&quot;.<br /><br />Still looks like there's room for improvement :].</div>
    <div class="meta">Posted on 2002-04-30 17:28:30 by f0dder</div>
   </div>
   <div class="post" id="post-36227">
    <div class="subject"><a href="#post-36227">Icq...</a></div>
    <div class="body">hey, thanks for all the reply, i found out another way using wininet.lib :) Thank you very much, i can attach the source if you want :)</div>
    <div class="meta">Posted on 2002-05-02 17:55:03 by Tsongkie[ii]</div>
   </div>
  </div>
 </body>
</html>