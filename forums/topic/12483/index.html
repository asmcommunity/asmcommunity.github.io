<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>cant get it to receive data properly - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=12483" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=8">Networking</a> &raquo; <a href="../?id=12483">cant get it to receive data properly</a></p>
   <div class="post" id="post-96417">
    <div class="subject"><a href="#post-96417">cant get it to receive data properly</a></div>
    <div class="body">i'm writing a program that connects to a server. heres the breakdown:<br /><br /><pre><code><br />-connect_port _11111 &#91;SYN&#93;<br />-receive_port &#91;SYN, ACK&#93;<br />-send_packet_11111_ &#91;ACK&#93;<br />-send_packet_11111_login &#91;PSH, ACK&#93;<br />-receive_port &#91;ACK&#93;                    ****<br />-receive_port_2 &#91;PSH, ACK&#93;        ****<br />-send_packet_11111 &#91;ACK&#93;        ****<br />-connect_port _11112 &#91;SYN&#93;<br />-receive_port &#91;SYN, ACK&#93;<br />-send_packet_11112 &#91;ACK&#93;<br />-send_packet_11112_login &#91;PSH, ACK&#93;<br />-receive_port &#91;ACK&#93;<br />-receive_port_2 &#91;PSH, ACK&#93;<br />-send_packet_11112 &#91;ACK&#93;<br />-receive_port_11112_main_character &#91;PSH, ACK&#93;<br />-send_packet_11112 &#91;ACK&#93;<br />-receive_port_main_menu &#91;PSH, ACK&#93;<br />-send_packet_11112_commands &#91;ACK&#93;<br /></code></pre><br /><br />i've been reading all these winsock help files, and tuts, and i still have a headache. everything goes fine until you see the asterisks *<br /><br />at this very moment, i am using <em>blocking</em> sockets, in threads--anyhow, its probably best to use non-blocking in thread, with event/msg'n but i'll get there soon enough<br /><br />okay here then...<br /><br /><pre><code><br />.486<br />.model flat,stdcall<br />option casemap&#58;none<br /><br />include \masm32\include\windows.inc<br />include \masm32\macros\macros.asm<br />include \masm32\include\user32.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\masm32.inc<br />include \masm32\include\ws2_32.inc<br /><br />includelib \masm32\lib\user32.lib<br />includelib \masm32\lib\kernel32.lib<br />includelib \masm32\lib\masm32.lib<br />includelib \masm32\lib\ws2_32.lib<br /><br />WinMain proto &#58;DWORD,&#58;DWORD,&#58;DWORD<br /><br /><br />.data?<br />	hInstance     dd ?<br />	hDlg HWND ?<br />	wsaData     WSADATA     &lt;?&gt;<br />	hSocket_11111 dd ?<br />	hSocket_11112 dd ?<br />	sockAddr_11111   sockaddr_in     &lt;?&gt;<br />	sockAddr_11112   sockaddr_in     &lt;?&gt;<br />	 hEditInfo HWND ?<br />	buffer db 256 dup&#40;?&#41;<br />    <br />	ThreadID DWORD ?<br /><br />.data<br />	szIPAddress db &quot;204.176.33.66&quot;,0<br />	AppName db &quot;xClient 0.0.1&quot;,0<br />	ClassName db &quot;DFC_GameClient_Class&quot;,0<br />	MenuName db &quot;DFC_GameClient_Menu&quot;,0<br />	DlgName db &quot;DFC_GameClient_Dialog&quot;,0<br />	ConnectToken db 1Bh, 1Bh, 00h, 73h, 00h, 02h, 00h, 80h, 0FFh, 0F2h<br />	             db 00h, 0Fh, 00h, 1Eh, 01h, 09h, 03h, 69h, 77h, 70h, 34h, 32h, 35h, 00h, 00h, 00h<br />	             db 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h<br />	             db 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h<br />	             db 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 44h, 41h, 52h, 4Bh, 4Eh, 45h, 53h<br />	             db 53h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 72h, 6Fh, 68h<br />	             db 00h, 50h, 39h, 35h, 61h, 72h, 69h, 33h, 36h, 30h, 53h, 00h, 00h, 00h, 00h, 00h<br />	             db 00h, 00h, 00h, 00h, 00h, 0ADh, 9Ah<br /><br />	PacketOut_1 db 1Bh, 1Bh, 00h, 04h, 00h, 03h, 00h, 80h, 0FFh, 0F2h, 00h, 0Bh, 00h, 00h, 00h, 00h<br />			   db 0FBh, 04h<br /><br />	PacketOut_2 db 1Bh, 1Bh, 00h, 04h, 00h, 04h, 00h, 80h, 0FFh, 0F2h, 00h, 0Bh, 00h, 00h, 00h, 00h<br />			   db 0EFh, 0Fh			  <br /><br />.const<br />	IDM_CONNECT equ 3000<br />	IDM_DISCONNECT equ 3001<br />	IDM_EXIT equ 3002<br />	IDC_EDIT_INFO equ 2000<br />	CR  equ 0Dh<br />	LF  equ 0Ah<br /><br />.code<br /><br />ThreadProc PROC<br />	invoke  WSAStartup,0002h, addr wsaData<br />	test    eax,eax<br />	jz      _startupSucceeded<br />	ret<br />	<br />_startupSucceeded&#58;<br />	cmp     byte ptr &#91;wsaData.wVersion&#93;,2<br />	jae     _versionOK<br />	invoke MessageBox,hDlg,SADD&#40;&quot;Initialization failed.&quot;&#41;,addr AppName,MB_OK<br />	jmp _exitThread<br /><br />_versionOK&#58;<br />	invoke  socket,AF_INET,SOCK_STREAM,IPPROTO_TCP<br />	cmp     eax,INVALID_SOCKET<br />	jne     _socket_created_11111<br />	invoke MessageBox,hDlg,SADD&#40;&quot;Error creating socket.&quot;&#41;,addr AppName,MB_OK<br />	jmp _exitThread<br />    <br />_socket_created_11111&#58;<br />	mov     &#91;hSocket_11111&#93;,eax<br />	mov     &#91;sockAddr_11111.sin_family&#93;,AF_INET<br />	invoke  htons,11111<br />	mov     &#91;sockAddr_11111.sin_port&#93;,ax<br />	invoke  inet_addr,addr szIPAddress<br />	mov     &#91;sockAddr_11111.sin_addr&#93;,eax<br />	<br />	invoke  socket,AF_INET,SOCK_STREAM,IPPROTO_TCP<br />	cmp     eax,INVALID_SOCKET<br />	jne     _socket_created_11112<br />	invoke MessageBox,hDlg,SADD&#40;&quot;Error creating socket.&quot;&#41;,addr AppName,MB_OK<br />	jmp _exitThread<br />	<br />_socket_created_11112&#58;<br />	mov hSocket_11112,eax<br />	mov     &#91;sockAddr_11112.sin_family&#93;,AF_INET<br />	invoke  htons,11112<br />	mov     &#91;sockAddr_11112.sin_port&#93;,ax<br />	invoke  inet_addr,addr szIPAddress<br />	mov     &#91;sockAddr_11112.sin_addr&#93;,eax<br />	<br />	invoke  connect,&#91;hSocket_11111&#93;,addr sockAddr_11111,sizeof sockAddr_11111<br />	test    eax,eax<br />	jz      _connectSucceeded<br />	invoke MessageBox,hDlg,SADD&#40;&quot;Connection failed.&quot;&#41;,addr AppName,MB_OK<br />	jmp _exitThread<br />    <br />_connectSucceeded&#58;<br />	invoke MessageBox,hDlg,SADD&#40;&quot;Successfully connected to 11111.&quot;&#41;,addr AppName,MB_OK<br />	invoke send,&#91;hSocket_11111&#93;,addr ConnectToken,113,0<br />	cmp eax,SOCKET_ERROR<br />	jne _sendSucceeded<br />	invoke MessageBox,hDlg,SADD&#40;&quot;Send failed.&quot;&#41;,addr AppName,MB_OK<br />	jmp _exitThread<br />	<br />_sendSucceeded&#58;<br />	invoke  recv,&#91;hSocket_11111&#93;,addr buffer,256,0<br />	test eax,eax<br />	jz _connectionClosed<br />	invoke send,&#91;hSocket_11111&#93;,addr PacketOut_1,18,0<br />	invoke  connect,&#91;hSocket_11112&#93;,addr sockAddr_11112,sizeof sockAddr_11112<br />	test    eax,eax<br />	jz      _connectSucceeded2<br />	jmp     _connectionClosed<br />	<br />_connectSucceeded2&#58;<br />	invoke MessageBox,hDlg,SADD&#40;&quot;Successfully connected to 11112.&quot;&#41;,addr AppName,MB_OK<br />	invoke send,&#91;hSocket_11112&#93;,addr ConnectToken,113,0<br />	cmp eax,SOCKET_ERROR<br />	jne _loop_Receive_11112<br />	jmp _exitThread<br />	<br />_loop_Receive_11111&#58;<br />	invoke  recv,&#91;hSocket_11111&#93;,addr buffer,256,0<br />	test eax,eax<br />	jz _connectionClosed<br />	jmp _loop_Receive_11111<br />	<br />_loop_Receive_11112&#58;<br />	invoke  recv,&#91;hSocket_11112&#93;,addr buffer,256,0<br />	jmp _loop_Receive_11112	<br /><br />_connectionClosed&#58;<br />	invoke MessageBox,hDlg,SADD&#40;&quot;Closing connection '11111'.&quot;&#41;,addr AppName,MB_OK<br />	invoke closesocket,&#91;hSocket_11111&#93;<br />	invoke MessageBox,hDlg,SADD&#40;&quot;Closing connection '11112'.&quot;&#41;,addr AppName,MB_OK<br />	invoke closesocket,&#91;hSocket_11112&#93;<br />	<br />_exitThread&#58;<br />	invoke MessageBox,hDlg,SADD&#40;&quot;Cleaning up sockets.&quot;&#41;,addr AppName,MB_OK<br />	invoke WSACleanup<br />	xor eax,eax<br />	ret<br />	<br />ThreadProc endp<br /><br />start&#58;<br />	invoke GetModuleHandle,NULL<br />	mov    hInstance,eax<br />	invoke WinMain,hInstance,NULL,SW_SHOWDEFAULT<br />	invoke ExitProcess,eax<br />	<br />WinMain proc hInst&#58;HINSTANCE,hPrevInst&#58;HINSTANCE,CmdShow&#58;DWORD<br />	LOCAL wc&#58;WNDCLASSEX<br />	LOCAL msg&#58;MSG<br />	mov   wc.cbSize,SIZEOF WNDCLASSEX<br />	mov   wc.style,CS_HREDRAW or CS_VREDRAW<br />	mov   wc.lpfnWndProc,OFFSET WndProc<br />	mov   wc.cbClsExtra,NULL<br />	mov   wc.cbWndExtra,DLGWINDOWEXTRA<br />	push  hInst<br />	pop   wc.hInstance<br />	mov   wc.hbrBackground,COLOR_BTNFACE+1<br />	mov   wc.lpszMenuName,OFFSET MenuName<br />	mov   wc.lpszClassName,OFFSET ClassName<br />	invoke LoadIcon,hInstance,0 <br />	mov   wc.hIcon,eax<br />	mov   wc.hIconSm,eax<br />	invoke LoadCursor,NULL,IDC_ARROW<br />	mov   wc.hCursor,eax<br />	invoke RegisterClassEx,addr wc<br />	invoke CreateDialogParam,hInstance,addr DlgName,NULL,NULL,NULL<br />	mov   hDlg,eax<br />	invoke ShowWindow,hDlg,SW_SHOWNORMAL<br />	invoke UpdateWindow,hDlg<br />	.WHILE TRUE<br />                invoke GetMessage,addr msg,NULL,0,0<br />                .BREAK .IF &#40;!eax&#41;<br />                invoke IsDialogMessage,hDlg,addr msg<br />                .if eax==FALSE<br />                        invoke TranslateMessage,addr msg<br />                        invoke DispatchMessage,addr msg<br />                .endif<br />	.ENDW<br />	mov     eax,msg.wParam<br />	ret<br />WinMain endp<br />WndProc proc hWnd&#58;HWND,uMsg&#58;UINT,wParam&#58;WPARAM,lParam&#58;LPARAM<br />	.if uMsg==WM_DESTROY<br />		invoke WSACleanup<br />		invoke PostQuitMessage,NULL<br />	.elseif uMsg==WM_CREATE<br />		invoke GetDlgItem,hDlg,IDC_EDIT_INFO<br />		mov hEditInfo,eax<br />	.elseif uMsg==WM_COMMAND<br />		mov eax,wParam<br />		.if ax==IDM_CONNECT<br />			mov eax,OFFSET ThreadProc<br />			invoke CreateThread,NULL,NULL,eax,\<br />								NULL,NORMAL_PRIORITY_CLASS,\<br />								addr ThreadID<br />		.elseif ax==IDM_DISCONNECT<br />			invoke SendMessage,hDlg,WM_DESTROY,0,0<br />		.elseif ax==IDM_EXIT<br />			invoke SendMessage,hDlg,WM_DESTROY,0,0<br />		.endif	<br />	.else<br />		invoke DefWindowProc,hWnd,uMsg,wParam,lParam<br />		ret<br />	.endif<br />	xor    eax,eax<br />	ret<br />WndProc endp<br />end start<br /></code></pre><br /><br />hopefully (i doubt it) if u have gone down this far, i will explain what's going on.<br /><br />1. it sends a connect packet<br />2. it gets confirmation its okay to send<br />3. it sends the login packet<br />4. *** it suppose to read back the packet sent after that, but my program only stops on like the header<br />5. after that, it sends another packet, and the 2nd packet connects on another port<br />6. and theres more other stuff that need to be dealth with ;x</div>
    <div class="meta">Posted on 2003-04-13 22:24:42 by xkardisx</div>
   </div>
   <div class="post" id="post-96418">
    <div class="subject"><a href="#post-96418">cant get it to receive data properly</a></div>
    <div class="body">oih yea im aware there som eproblems near the end, ,with the recvloop but i'll get there l8r</div>
    <div class="meta">Posted on 2003-04-13 22:25:27 by xkardisx</div>
   </div>
   <div class="post" id="post-97407">
    <div class="subject"><a href="#post-97407">cant get it to receive data properly</a></div>
    <div class="body">Straight away, your problem is that winsock version 2 is started using the value 202h .<br />Version 1 - 0101h<br />Version 2 - 0202h<br /><br />It's major and minor versioning for winsock.<br /><br />Heh.</div>
    <div class="meta">Posted on 2003-04-16 23:50:04 by Homer</div>
   </div>
  </div>
 </body>
</html>