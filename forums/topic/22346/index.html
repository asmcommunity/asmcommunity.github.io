<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Drawing a line... In GDI - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=22346" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=22346">Drawing a line... In GDI</a></p>
   <div class="post" id="post-167774">
    <div class="subject"><a href="#post-167774">Drawing a line... In GDI</a></div>
    <div class="body">I&#39;m coding a smal utility that is intended to get the number of pixels of the selected area... For that I wanted something like this: You click your mouse button at a certain point, then a line is created at that point, as you drag your mouse the line goes following your cursor, once you release your mouse button the line size is calculated and showed to the user. I didn&#39;t manage to find any similar code on google... Drawing a static line isn&#39;t a problem, nor is geting the click and realease, I just can&#39;t figure how I would do this &quot;dinamicaly&quot;.<br /><br />By the way I&#39;m using hooks to get the mouse input: mouse click, mouse release and mouse move, all of them has it&#39;s unique message (WM_MCLICK, WM_MUP, WM_MMOVE).</div>
    <div class="meta">Posted on 2005-11-11 20:04:28 by Lenin</div>
   </div>
   <div class="post" id="post-167777">
    <div class="subject"><a href="#post-167777">Re: Drawing a line... In GDI</a></div>
    <div class="body">I&#39;d say WM_LBUTTONDOWN, SetCapture until WM_LBUTTONUP where ReleaseCapture occurs.<br />On WM_MOUSEMOVE (If Capture is ON) count the difference</div>
    <div class="meta">Posted on 2005-11-11 20:56:38 by JimmyClif</div>
   </div>
   <div class="post" id="post-167778">
    <div class="subject"><a href="#post-167778">Re: Drawing a line... In GDI</a></div>
    <div class="body">I had already thought of that method, but I don&#39;t see how it would work if the distance to be measured wan&#39;t horizontal or vertical. I wanted to use gdi because it would let user see the distance and I beleive that there might some way to get it&#39;s size. I really don&#39;t know if there&#39;s a formula I could use or something like that.</div>
    <div class="meta">Posted on 2005-11-11 21:12:30 by Lenin</div>
   </div>
   <div class="post" id="post-167785">
    <div class="subject"><a href="#post-167785">Re: Drawing a line... In GDI</a></div>
    <div class="body">With GDI it will be the same thing - except you will be drawing a line starting from the point when WM_LBUTTONDOWN occured until the current position in WM_MOUSEMOVE. </div>
    <div class="meta">Posted on 2005-11-12 05:16:31 by JimmyClif</div>
   </div>
   <div class="post" id="post-167793">
    <div class="subject"><a href="#post-167793">Re: Drawing a line... In GDI</a></div>
    <div class="body">Pythagora? (x2-x1)^2+(y2-y1)^2=length^2<br />imagine the line as a diagonal of a rectangle</div>
    <div class="meta">Posted on 2005-11-12 09:15:14 by drizz</div>
   </div>
   <div class="post" id="post-167805">
    <div class="subject"><a href="#post-167805">Re: Drawing a line... In GDI</a></div>
    <div class="body">Seems to be a nice idea... But I don&#39;t know how to implement that... My code so far:<br /><br /><pre><code>&nbsp; &nbsp; pStart POINT &lt;?&gt;<br />&nbsp; &nbsp; MCdown dd 0<br />&nbsp; &nbsp; MCup dd 0<br />(...)<br />&nbsp; &nbsp; .elseif uMsg==WM_MCDOWN<br />&nbsp; &nbsp; &nbsp; &nbsp; cmp MCdown, 0<br />&nbsp; &nbsp; &nbsp; &nbsp; jz @F<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov MCdown, FALSE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov MCup, TRUE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push wParam<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop pStart.x<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push lParam<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop pStart.y<br />&nbsp; &nbsp; &nbsp; &nbsp; @@:<br />&nbsp; &nbsp; .elseif uMsg==WM_MCUP<br />&nbsp; &nbsp; &nbsp; &nbsp; cmp MCup, 0<br />&nbsp; &nbsp; &nbsp; &nbsp; jz @F<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov MCup, FALSE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; So now I would use that formula here, but how? I have the WM_MCDOWN cordinates (pStart.x, pStart.y)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; And the MC_UP ones (wParam, lParam)...<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke SetDlgItemText, hWnd, IDC_GETSIZE, CTXT(&quot;Get size&quot;)<br />&nbsp; &nbsp; &nbsp; &nbsp; @@:<br />&nbsp; &nbsp; .elseif uMsg==WM_COMMAND<br />	mov eax, wParam<br />	cmp ax, IDC_GETSIZE<br />	jnz @F<br />	&nbsp; &nbsp; mov MCdown, TRUE<br />	&nbsp; &nbsp; invoke SetDlgItemText, hWnd, IDC_GETSIZE, CTXT(&quot;Click and drag your mouse&quot;)<br />	@@:<br />(...)</code></pre></div>
    <div class="meta">Posted on 2005-11-12 14:08:05 by Lenin</div>
   </div>
   <div class="post" id="post-167817">
    <div class="subject"><a href="#post-167817">Re: Drawing a line... In GDI</a></div>
    <div class="body">Holy crap - You&#39;re right. Sorry... took me to this moment to realize for good why you mentionned horizontal &amp; vertical.<br /><br />Drizz, I&#39;m off probably by far... (and out of school for a damn long time) but shouldn&#39;t it be a triangle and a^2+b^2=c^2 ?<br /><br />If you know the starting position (x1,x2), and the ending position (x3,x4) -  oh I see.... (grin)<br /><br />Pseudo-Code:<br /><pre><code><br />.IF x1 &gt; x2<br />  sub x1, x2<br />  mov a, x1<br />.ELSE<br />  sub x2,x1<br />  mov a, x2<br />.ENDIF<br /><br />.IF x3 &gt; x4<br />  sub x3, x4<br />  mov b, x3<br />.ELSE<br />  sub x4,x3<br />  mov b, x4<br />.ENDIF<br /><br />mul a * a<br />mul b * b<br />add a, b<br />mov c, a<br />sqrt(c) ; lenght of line.<br /></code></pre></div>
    <div class="meta">Posted on 2005-11-12 17:09:59 by JimmyClif</div>
   </div>
   <div class="post" id="post-167820">
    <div class="subject"><a href="#post-167820">Re: Drawing a line... In GDI</a></div>
    <div class="body">there&#39;s no need to find out which one is bigger (or maybe my brain is sleeping).<br /><br />mov eax, x2<br />sub eax, x1<br />mul eax&nbsp;  ;&nbsp; a^2<br />mov ecx, eax<br />mov eax, y2<br />sub eax, y1<br />mul eax&nbsp;  ;&nbsp; b^2<br />add eax, ecx&nbsp; ; a^2 + b^2&nbsp;  ( c^2 )<br /><br />sqrt(eax) :P</div>
    <div class="meta">Posted on 2005-11-12 18:47:37 by ti_mo_n</div>
   </div>
   <div class="post" id="post-167822">
    <div class="subject"><a href="#post-167822">Re: Drawing a line... In GDI</a></div>
    <div class="body">My code is yelding pretty weird results... The weirdest thing is that there&#39;s no relation between the real number of pixels and the outputed one like:<br /><br /><div class="quote">real: 28px, outputed: 626px, direction: horizontal<br />real: 50px, outputed:500px, direction: horizontal<br />real: 45px, outputed:581px, direction: vertical<br />real: 74px, outputed:308px, direction: vertical<br />real: 29px, outputed:250px, direction: diagonal</div><br /><br /><pre><code>&nbsp; &nbsp; .elseif uMsg==WM_MCUP<br />&nbsp; &nbsp; &nbsp; &nbsp; cmp MCup, 0<br />&nbsp; &nbsp; &nbsp; &nbsp; jz @F<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov MCup, FALSE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke SetDlgItemText, hWnd, IDC_GETSIZE, CTXT(&quot;Get size&quot;)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov ecx, pStart.x<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .if ecx &gt; pStart.y<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov eax, pStart.x<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub eax, pStart.y<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .else<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov eax, pStart.y<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub eax, pStart.x<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .endif<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mul eax ; a^2<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov result, eax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov ecx, wParam<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .if ecx &gt; lParam<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov eax, wParam<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub eax, lParam<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .else<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov eax, lParam<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub eax, wParam<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .endif<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mul eax ; b^2<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add result, eax ; c^2<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fild result<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fsqrt<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fist result<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fwait<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke wsprintf, addr buffer, addr template, result<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke MessageBox, hWnd, addr buffer, 0, MB_OK<br />&nbsp; &nbsp; &nbsp; &nbsp; @@:</code></pre><br /><br />Of course that it could be a problem with my method to catch the cordinates, if needed I&#39;ll post the whole code.</div>
    <div class="meta">Posted on 2005-11-12 19:59:11 by Lenin</div>
   </div>
   <div class="post" id="post-167830">
    <div class="subject"><a href="#post-167830">Re: Drawing a line... In GDI</a></div>
    <div class="body">Well, I don&#39;t know your code but regarding the lParam &amp; the wParam&#39;s: Under WM_MOUSEMOVE &amp; LBUTTONDOWN/UP the coordinates for x/y are located in lParamHi &amp; lParamLo respectively. Maybe that&#39;s your error.<br /><br />ti_mo_n: You&#39;re probably right - but shouldn&#39;t we use the abs(x) for each of the substractions to prevent negative numbers?</div>
    <div class="meta">Posted on 2005-11-12 22:39:44 by JimmyClif</div>
   </div>
   <div class="post" id="post-167831">
    <div class="subject"><a href="#post-167831">Re: Drawing a line... In GDI</a></div>
    <div class="body">When you square any real numbers, they become positive.</div>
    <div class="meta">Posted on 2005-11-12 23:04:41 by roticv</div>
   </div>
   <div class="post" id="post-167850">
    <div class="subject"><a href="#post-167850">Re: Drawing a line... In GDI</a></div>
    <div class="body"><div class="quote"><br />Well, I don&#39;t know your code but regarding the lParam &amp; the wParam&#39;s: Under WM_MOUSEMOVE &amp; LBUTTONDOWN/UP the coordinates for x/y are located in lParamHi &amp; lParamLo respectively. Maybe that&#39;s your error.</div><br /><br />I coded my DLL to pass me the x and y cordinates in wParam and lParam:<br /><br /><pre><code>MouseProc proc nCode:DWORD,wParam:DWORD,lParam:DWORD<br />	invoke CallNextHookEx,hHook,nCode,wParam,lParam<br />	mov edx,lParam<br />	assume edx:PTR MOUSEHOOKSTRUCT<br />	.if wParam == WM_LBUTTONDOWN<br />	&nbsp; &nbsp; invoke PostMessage,hWnd,WM_MCDOWN,.pt.x,.pt.y<br />	.elseif wParam == WM_LBUTTONUP<br />	&nbsp; &nbsp; invoke PostMessage,hWnd,WM_MCUP,.pt.x,.pt.y<br />	.else<br />	&nbsp; &nbsp; invoke PostMessage,hWnd,WM_MOUSEMV,.pt.x,.pt.y<br />	.endif<br />	assume edx:nothing<br />	xor eax,eax<br />	ret<br />MouseProc endp</code></pre></div>
    <div class="meta">Posted on 2005-11-13 10:42:23 by Lenin</div>
   </div>
   <div class="post" id="post-167852">
    <div class="subject"><a href="#post-167852">Re: Drawing a line... In GDI</a></div>
    <div class="body">This appears to give me correct lenghts:<br /><br /><pre><code><br />.data?<br />Startx	dd ?<br />Starty	dd ?<br />Endx	dd ?<br />Endy	dd ?<br />dummy	dd	?<br />Capture	dd	?<br />.code<br />WndProc proc uses ebx hwnd:DWORD,uMsg:UINT,wParam:WPARAM,lParam:LPARAM<br />LOCAL rect:RECT<br />LOCAL ps:PAINTSTRUCT<br /><br />    .IF uMsg==WM_CREATE<br />		m2m hWnd, hwnd<br />		;invoke OnCreate<br />	.ELSEIF uMsg==WM_LBUTTONDOWN<br />		invoke SetCapture,hWnd<br />		mov Capture, TRUE<br />		movzx eax, lParamL ; lParamL == WORD PTR <br />		mov Startx, eax&nbsp; &nbsp; &nbsp; ; lParamH == WORD PTR <br />		movzx eax, lParamH<br />		mov Starty, eax<br />	.ELSEIF uMsg==WM_LBUTTONUP<br />		invoke ReleaseCapture<br />		mov Capture, FALSE<br />		;Get line lenght<br />				<br />		mov eax, Startx<br />		mov edx, Endx<br />		sub eax, edx<br />		imul eax, eax<br />		push eax<br />		<br />		mov eax, Starty<br />		mov edx, Endy<br />		sub eax, edx<br />		imul eax, eax<br />		<br />		pop edx<br />		<br />		add eax, edx<br />		<br />		mov dummy, eax<br />		finit<br />		fild dummy<br />		fsqrt <br />		fistp dummy<br />		<br />		PrintDec dummy<br />		<br />	.ELSEIF uMsg==WM_MOUSEMOVE<br />		.IF Capture == TRUE<br />			movzx eax, lParamL<br />			mov Endx, eax <br />			movzx eax, lParamH<br />			mov Endy, eax<br />			invoke InvalidateRect,hWnd,0,TRUE<br />		.ENDIF<br />	.ELSEIF uMsg==WM_PAINT<br />		.IF Capture == TRUE<br />			invoke BeginPaint,hWnd,a$ ps<br />			invoke GetStockObject,BLACK_PEN<br />			push eax<br />			invoke SelectObject,ps.hdc,eax<br />			invoke MoveToEx,ps.hdc,Startx,Starty,NULL<br />			invoke LineTo,ps.hdc,Endx,Endy<br />			invoke EndPaint,hWnd,a$ ps<br />			call DeleteObject<br />		.ENDIF<br />    .ELSEIF uMsg==WM_DESTROY<br />		invoke PostQuitMessage,0<br />	<br />    .ELSE<br />		invoke DefWindowProc,hwnd,uMsg,wParam,lParam<br />		ret<br />    .ENDIF<br />    xor eax,eax<br />    ret<br />WndProc endp<br /></code></pre></div>
    <div class="meta">Posted on 2005-11-13 13:14:43 by JimmyClif</div>
   </div>
   <div class="post" id="post-167858">
    <div class="subject"><a href="#post-167858">Re: Drawing a line... In GDI</a></div>
    <div class="body">Thanks a lot :) For some weird reason after adapting my code (copy and pasting yours) my window became unresponsible... I&#39;m pretty sure that it&#39;s because I&#39;m handling WM_PAINT but I don&#39;t know how to fix it... Here&#39;s the code:<br /><br /><pre><code>.386<br />.model flat, stdcall&nbsp; ;32 bit memory model<br />option casemap :none&nbsp; ;case sensitive<br /><br />include windows.inc<br />include kernel32.inc<br />include user32.inc<br />include gdi32.inc<br />include \masm32\macros\macros.asm<br /><br />includelib AutoClickDll.lib<br />includelib kernel32.lib<br />includelib user32.lib<br />includelib gdi32.lib<br /><br />DlgProc proto :DWORD,:DWORD,:DWORD,:DWORD<br />InstallHook proto :DWORD<br />UninstallHook proto<br />MouseProc proto :DWORD,:DWORD,:DWORD<br /><br />.const<br />&nbsp; &nbsp; IDC_HOOK equ 12<br />&nbsp; &nbsp; IDC_XPOINT equ 10<br />&nbsp; &nbsp; IDC_YPOINT equ 11<br />&nbsp; &nbsp; IDC_COLORBOX equ 12<br />&nbsp; &nbsp; IDC_GETSIZE equ 13<br />&nbsp; &nbsp; WM_MOUSEMV equ WM_USER+6<br />&nbsp; &nbsp; WM_MCUP equ WM_USER+7<br />&nbsp; &nbsp; WM_MCDOWN equ WM_USER+8<br />.data?<br />&nbsp; &nbsp; rect RECT &lt;?&gt;<br />&nbsp; &nbsp; ps PAINTSTRUCT &lt;?&gt;<br />&nbsp; &nbsp; pStart POINT &lt;?&gt;<br />&nbsp; &nbsp; pEnd POINT &lt;?&gt;<br />&nbsp; &nbsp; result dd ?<br />&nbsp; &nbsp; buffer db 50 dup(?)<br />.data<br />&nbsp; &nbsp; template db &quot;There are %lu pixels&quot;,0<br />&nbsp; &nbsp; MCdown dd 0<br />&nbsp; &nbsp; Capture dd 0<br />.code<br />start:<br />	invoke GetModuleHandle, NULL <br />	invoke DialogBoxParam, eax, 1, NULL, addr DlgProc, NULL<br />	invoke ExitProcess, 0<br /><br />DlgProc proc hWnd:HWND,uMsg:UINT,wParam:WPARAM,lParam:LPARAM<br />&nbsp; &nbsp; .if uMsg==WM_PAINT<br />&nbsp; &nbsp; &nbsp; &nbsp; .if Capture<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke BeginPaint,hWnd,addr ps<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke GetStockObject, BLACK_PEN<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push eax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke SelectObject,ps.hdc,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke MoveToEx,ps.hdc,pStart.x,pStart.y,NULL<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke LineTo,ps.hdc,pEnd.x,pEnd.y<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke EndPaint,hWnd,addr ps<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call DeleteObject<br />&nbsp; &nbsp; &nbsp; &nbsp; .endif<br />&nbsp; &nbsp; .elseif uMsg==WM_MOUSEMV<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke SetDlgItemInt, hWnd, IDC_XPOINT, wParam, FALSE<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke SetDlgItemInt, hWnd, IDC_YPOINT, lParam, FALSE<br />&nbsp; &nbsp; &nbsp; &nbsp; .if Capture<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; m2m pEnd.x, wParam<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; m2m pEnd.y, lParam<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke InvalidateRect,hWnd,0,TRUE<br />&nbsp; &nbsp; &nbsp; &nbsp; .endif<br />&nbsp; &nbsp; .elseif uMsg==WM_MCUP<br />&nbsp; &nbsp; &nbsp; &nbsp; mov Capture, FALSE<br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; mov eax, pStart.x<br />&nbsp; &nbsp; &nbsp; &nbsp; mov edx, pEnd.x<br />&nbsp; &nbsp; &nbsp; &nbsp; sub eax, edx<br />&nbsp; &nbsp; &nbsp; &nbsp; imul eax, eax<br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; push eax<br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; mov eax, pStart.y<br />&nbsp; &nbsp; &nbsp; &nbsp; mov edx, pEnd.y<br />&nbsp; &nbsp; &nbsp; &nbsp; sub eax, edx<br />&nbsp; &nbsp; &nbsp; &nbsp; imul eax, eax<br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; pop edx<br />&nbsp; &nbsp; &nbsp; &nbsp; add eax, edx<br />&nbsp; &nbsp; &nbsp; &nbsp; mov result, eax<br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; finit<br />&nbsp; &nbsp; &nbsp; &nbsp; fild result<br />&nbsp; &nbsp; &nbsp; &nbsp; fsqrt<br />&nbsp; &nbsp; &nbsp; &nbsp; fistp result<br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; invoke wsprintf, addr buffer, addr template, result<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke MessageBox, hWnd, addr buffer, 0, MB_OK<br />&nbsp; &nbsp; .elseif uMsg==WM_MCDOWN<br />&nbsp; &nbsp; &nbsp; &nbsp; .if MCdown<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov MCdown, FALSE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov Capture, TRUE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; m2m pStart.x, wParam<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; m2m pStart.y, lParam<br />&nbsp; &nbsp; &nbsp; &nbsp; .endif<br />&nbsp; &nbsp; .elseif uMsg==WM_COMMAND<br />&nbsp; &nbsp; &nbsp; &nbsp; mov eax, wParam<br />&nbsp; &nbsp; &nbsp; &nbsp; .if ax==IDC_GETSIZE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov MCdown, TRUE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke SetDlgItemText, hWnd, IDC_GETSIZE, CTXT(&quot;Click and drag your mouse&quot;)<br />&nbsp; &nbsp; &nbsp; &nbsp; .endif&nbsp; &nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; .elseif uMsg==WM_INITDIALOG<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke GetWindowRect,hWnd,addr rect<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke SetWindowPos,hWnd,HWND_TOPMOST,rect.left,rect.top,rect.right,rect.bottom,SWP_SHOWWINDOW<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; invoke InstallHook, hWnd<br />&nbsp; &nbsp; .elseif uMsg==WM_CLOSE<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke UninstallHook<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke EndDialog,hWnd,0<br />&nbsp; &nbsp; .else<br />&nbsp; &nbsp; &nbsp; &nbsp; mov	eax,FALSE<br />&nbsp; &nbsp; &nbsp; &nbsp; ret<br />	.endif<br />	mov	eax,TRUE<br />	ret<br />DlgProc endp<br /><br />end start</code></pre><br /><br />I took away a few features I had implemented to see if they were causing the errors, but they weren&#39;t.</div>
    <div class="meta">Posted on 2005-11-13 20:03:56 by Lenin</div>
   </div>
   <div class="post" id="post-167859">
    <div class="subject"><a href="#post-167859">Re: Drawing a line... In GDI</a></div>
    <div class="body">Maybe because your forgot the calls to SetCapture &amp; ReleaseCapture. Try that.</div>
    <div class="meta">Posted on 2005-11-13 20:45:29 by JimmyClif</div>
   </div>
   <div class="post" id="post-167860">
    <div class="subject"><a href="#post-167860">Re: Drawing a line... In GDI</a></div>
    <div class="body">Oh I&#39;m using hooks... I tested using SetCapture but it only aplies to my window... Like I can&#39;t detect the mouse events when it&#39;s out of my window.<br /><br />The main purpose of this project is help me to build resource files, so I can open a program , get it&#39;s sizes, controls&#39; sizes etc... I&#39;m also getting it&#39;s colors, just removed that of the code posted here. If I can&#39;t catch mouse events from others windows then my project is just a big waste of my time :P</div>
    <div class="meta">Posted on 2005-11-13 20:58:48 by Lenin</div>
   </div>
   <div class="post" id="post-167889">
    <div class="subject"><a href="#post-167889">Re: Drawing a line... In GDI</a></div>
    <div class="body">How you&#39;re coming along there? All good? If you need to get rid of the WM_PAINT part just kick out the whole WM_PAINT handler and the call to InvalidateRect.<br /><br />On another note, If you do what I think you&#39;re doing... Why not doing an enumeration of the selected window and list all the controls along with their sizes and colors?</div>
    <div class="meta">Posted on 2005-11-14 15:39:37 by JimmyClif</div>
   </div>
   <div class="post" id="post-167927">
    <div class="subject"><a href="#post-167927">Re: Drawing a line... In GDI</a></div>
    <div class="body">I don&#39;t know exactly what you think I&#39;m doing :P<br /><br />I took away the line part as you said and now it&#39;s working, not that precise, but it&#39;s working. Still I will leave the code here hoping that some kind soul might make the line work :)<br /><br />Thanks a lot Jimmy, I didn&#39;t expect some to build the whole code for me.<br /><br /><pre><code>.386<br />.model flat, stdcall&nbsp; ;32 bit memory model<br />option casemap :none&nbsp; ;case sensitive<br /><br />include windows.inc<br />include kernel32.inc<br />include user32.inc<br />include gdi32.inc<br />include \masm32\macros\macros.asm<br /><br />includelib AutoClickDll.lib<br />includelib kernel32.lib<br />includelib user32.lib<br />includelib gdi32.lib<br /><br />DlgProc proto :DWORD,:DWORD,:DWORD,:DWORD<br />InstallHook proto :DWORD<br />UninstallHook proto<br />MouseProc proto :DWORD,:DWORD,:DWORD<br /><br />.const<br />&nbsp; &nbsp; IDC_HOOK equ 12<br />&nbsp; &nbsp; IDC_XPOINT equ 10<br />&nbsp; &nbsp; IDC_YPOINT equ 11<br />&nbsp; &nbsp; IDC_COLORBOX equ 12<br />&nbsp; &nbsp; IDC_GETSIZE equ 13<br />&nbsp; &nbsp; WM_MOUSEMV equ WM_USER+6<br />&nbsp; &nbsp; WM_MCUP equ WM_USER+7<br />&nbsp; &nbsp; WM_MCDOWN equ WM_USER+8<br />.data?<br />&nbsp; &nbsp; BoxColor dd ?<br />&nbsp; &nbsp; ColorBoxHwnd dd ?<br />&nbsp; &nbsp; rect RECT &lt;?&gt;<br />&nbsp; &nbsp; ps PAINTSTRUCT &lt;?&gt;<br />&nbsp; &nbsp; pStart POINT &lt;?&gt;<br />&nbsp; &nbsp; pEnd POINT &lt;?&gt;<br />&nbsp; &nbsp; result dd ?<br />&nbsp; &nbsp; buffer db 50 dup(?)<br />.data<br />&nbsp; &nbsp; template db &quot;There are %lu pixels&quot;,0<br />&nbsp; &nbsp; MCdown dd 0<br />&nbsp; &nbsp; Capture dd 0<br />.code<br />start:<br />	invoke GetModuleHandle, NULL <br />	invoke DialogBoxParam, eax, 1, NULL, addr DlgProc, NULL<br />	invoke ExitProcess, 0<br /><br />DlgProc proc hWnd:HWND,uMsg:UINT,wParam:WPARAM,lParam:LPARAM<br />&nbsp; &nbsp; .if uMsg==WM_MOUSEMV<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke SetDlgItemInt, hWnd, IDC_XPOINT, wParam, FALSE<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke SetDlgItemInt, hWnd, IDC_YPOINT, lParam, FALSE<br /><br />comment * ==========================================<br />&nbsp; &nbsp; &nbsp; &nbsp; .if Capture<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; m2m pEnd.x, wParam<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; m2m pEnd.y, lParam<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke InvalidateRect,hWnd,0,TRUE<br />&nbsp; &nbsp; &nbsp; &nbsp; .endif<br />&nbsp; &nbsp; .elseif uMsg==WM_PAINT<br />&nbsp; &nbsp; &nbsp; &nbsp; .if Capture<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke BeginPaint,hWnd,addr ps<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke GetStockObject, BLACK_PEN<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push eax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke SelectObject,ps.hdc,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke MoveToEx,ps.hdc,pStart.x,pStart.y,NULL<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke LineTo,ps.hdc,pEnd.x,pEnd.y<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke EndPaint,hWnd,addr ps<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call DeleteObject<br />&nbsp; &nbsp; &nbsp; &nbsp; .endif<br />comment * ==========================================<br />&nbsp; &nbsp; .elseif uMsg==WM_MCUP<br />&nbsp; &nbsp; &nbsp; &nbsp; .if Capture<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov Capture, FALSE<br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; m2m pEnd.x, wParam<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; m2m pEnd.y, lParam<br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov eax, pStart.x<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov edx, pEnd.x<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub eax, edx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; imul eax, eax<br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push eax<br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov eax, pStart.y<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov edx, pEnd.y<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub eax, edx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; imul eax, eax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop edx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add eax, edx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov result, eax<br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; finit<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fild result<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fsqrt<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fistp result<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke wsprintf, addr buffer, addr template, result<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke MessageBox, hWnd, addr buffer, 0, MB_OK<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke SetDlgItemText, hWnd, IDC_GETSIZE, CTXT(&quot;Get Size&quot;)<br />&nbsp; &nbsp; &nbsp; &nbsp; .endif<br />&nbsp; &nbsp; .elseif uMsg==WM_MCDOWN<br />&nbsp; &nbsp; &nbsp; &nbsp; .if MCdown<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov MCdown, FALSE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov Capture, TRUE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; m2m pStart.x, wParam<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; m2m pStart.y, lParam<br />&nbsp; &nbsp; &nbsp; &nbsp; .endif<br />&nbsp; &nbsp; .elseif uMsg==WM_COMMAND<br />&nbsp; &nbsp; &nbsp; &nbsp; mov eax, wParam<br />&nbsp; &nbsp; &nbsp; &nbsp; .if ax==IDC_GETSIZE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov MCdown, TRUE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke SetDlgItemText, hWnd, IDC_GETSIZE, CTXT(&quot;Click and drag your mouse&quot;)<br />&nbsp; &nbsp; &nbsp; &nbsp; .endif&nbsp; &nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; .elseif uMsg==WM_INITDIALOG<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke GetWindowRect,hWnd,addr rect<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke SetWindowPos,hWnd,HWND_TOPMOST,rect.left,rect.top,rect.right,rect.bottom,SWP_SHOWWINDOW<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; invoke InstallHook, hWnd<br />&nbsp; &nbsp; .elseif uMsg==WM_CLOSE<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke UninstallHook<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke EndDialog,hWnd,0<br />&nbsp; &nbsp; .else<br />&nbsp; &nbsp; &nbsp; &nbsp; mov	eax,FALSE<br />&nbsp; &nbsp; &nbsp; &nbsp; ret<br />	.endif<br />	mov	eax,TRUE<br />	ret<br />DlgProc endp<br /><br />end start</code></pre></div>
    <div class="meta">Posted on 2005-11-15 17:28:41 by Lenin</div>
   </div>
  </div>
 </body>
</html>