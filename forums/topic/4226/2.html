<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>System level programming problems - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=4226" />
  <link rel="prev" href="../?id=4226&amp;page=1" />   </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=4226">System level programming problems</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=4226&amp;page=1" style="">&laquo;</a><a href="../?id=4226&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="4226" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>   <div class="post" id="post-29789">
    <div class="subject"><a href="#post-29789">System level programming problems</a></div>
    <div class="body">Actually, why all this crap, if we can go to Ring0 (under Win9x it is no big deal) and there intercept our interrupt? :rolleyes:</div>
    <div class="meta">Posted on 2002-03-18 13:11:44 by masquer</div>
   </div>
   <div class="post" id="post-29795">
    <div class="subject"><a href="#post-29795">System level programming problems</a></div>
    <div class="body">Masquer,       <br />To me it just seems easier and more logical to hook it before windows does. Especially if its for a &quot;protection&quot; scheme, as seems likely in this case. Also those ring 0 &quot;hacks&quot; seem very dirty and improper to me. Especially for a commercial product that may need to one day run on a different OS. Those backdoor ring0 thingy's are all OS dependant and even OS version dependant. This way it will work not only under 9x. but also 2k, ,XP and even linux. To Bogdan this may not be the immediate case, but overall it strikes me as a more reasonable solution for whatever his problem may be. Assuming it works. :)</div>
    <div class="meta">Posted on 2002-03-18 13:31:12 by emonk</div>
   </div>
   <div class="post" id="post-29805">
    <div class="subject"><a href="#post-29805">System level programming problems</a></div>
    <div class="body">Interesting, how do you achieve your goal in Win2k (I mean with MBR), for example. Do you really think that modifying MBR is more neaty. I know some protection scheme that work that way and I think this is more perverted than viruses and quite weak, IMHO</div>
    <div class="meta">Posted on 2002-03-18 14:11:00 by masquer</div>
   </div>
   <div class="post" id="post-29820">
    <div class="subject"><a href="#post-29820">System level programming problems</a></div>
    <div class="body">hi,<br /><br />boot virus only can mantain its int13 hook under windows if they delete HSFLOP.PDR, in /win/sys/iosubsys directory.<br /><br />the idea that is better 'infect' the mbr to hook a int, instead of using a 'hack' becoz the machine the application can run someday under a updated OS is a joke. <br /><br />its easier get incompatible by changing the mbr, with all these antivirus, strange OS, somebody else using the mbr for something, large disks schemes et all, than with a hack, that you can put into a seh frame.<br /><br />ancev<br /><br />ps: a program that use a win32 hack have the same chance of running in linux than a boot sector that hook a INT have ;)</div>
    <div class="meta">Posted on 2002-03-18 16:52:55 by ancev</div>
   </div>
   <div class="post" id="post-29821">
    <div class="subject"><a href="#post-29821">System level programming problems</a></div>
    <div class="body">ancev, doesn't that trick only work under 9x? I don't think NT thunks<br />down to bios/v86 code for something as trivial as HD access :).</div>
    <div class="meta">Posted on 2002-03-18 16:57:23 by f0dder</div>
   </div>
   <div class="post" id="post-29884">
    <div class="subject"><a href="#post-29884">System level programming problems</a></div>
    <div class="body">I would agree with f0dder that if the irq routine is located in win32 code it has to be in a dll in &quot;shared memory&quot; (mark ALL sections as shared)</div>
    <div class="meta">Posted on 2002-03-19 02:27:14 by japheth</div>
   </div>
   <div class="post" id="post-29898">
    <div class="subject"><a href="#post-29898">System level programming problems</a></div>
    <div class="body">Ancev or F0dder,<br /> Not to seem like I am arguing the masters :) , ,but could you explain to me then why/how the example I posted works for me on a machine with lilo and linux and win2k all installed? I believe what you say. I would just like to understand the reasoning. have you tried the example? It hooks int 13h so that anything which tries to write or read mbr is returned a &quot;normal&quot; one instead of the bogus one. It did not set off my antivirus (norton 2k). So I assume it works. At least for this authors use. (Norton is supposed to detect changes to MBR.)<br /><br />PS - Here is a link to MSDN showing how to create &quot;safe&quot; int 13h hook under 95/me. Seems to work under 2k/Linux also for me :)<br /><br /><a target="_blank" href="http://msdn.microsoft.com/library/en-us/wmeother/storage_5l6g.asp">http://msdn.microsoft.com/library/en-us/wmeother/storage_5l6g.asp</a></div>
    <div class="meta">Posted on 2002-03-19 06:46:36 by emonk</div>
   </div>
   <div class="post" id="post-30488">
    <div class="subject"><a href="#post-30488">Interesting</a></div>
    <div class="body">I have not been on the net for some days now, and after comming back it is <strong>interesting</strong> how a thread can deviate from my original intentions :(<br /><br />To put a STOP to this: i am not interested in any viri  operation and infesting the MBR is nowhere even remotly near my intention... <br /><br />i just want the hardware IRQ1 (aka keyboard)  to pass to my code, so int13h (that is a software bios int) in not my concern...<br /><br />and i also want to be able to do that dynamically (no reboot) and for a short period of time (while certain phase of a programm is running) and then i want to be able to completly reverse it an leave the system/OS in a very clean and nice state<br /><br />I guess fodder was right and i dont know how was i capable to overlook the <strong> paging stuff</strong>...it must of been one of my <strong> very bad days </strong> or the fact that i do not use paging yet in my OS... :)<br /><br />Japeth: do you think a .DLL (shared) whould work? or i need a VXD?<br /><br />Thx for everybody that tried to help me here ...</div>
    <div class="meta">Posted on 2002-03-23 12:16:52 by BogdanOntanu</div>
   </div>
   <div class="post" id="post-30506">
    <div class="subject"><a href="#post-30506">System level programming problems</a></div>
    <div class="body">I have hooked IDT entries for exceptions 0, 1, 3 and 6 with shared win32 code and it worked well in Win9x. The code should be marked as non-pageable I assume.<br /><br />Other VMs (dos apps) have their own IDT. So you possibly will not get key strokes from these apps. For such purposes a Vxd will be better.<br /><br />japheth.</div>
    <div class="meta">Posted on 2002-03-23 14:29:20 by japheth</div>
   </div>
   <div class="post" id="post-30702">
    <div class="subject"><a href="#post-30702">System level programming problems</a></div>
    <div class="body">Instead a VxD maybe CreateFileMapping / MapViewOfFile are enough to have shared memory on all processes ?</div>
    <div class="meta">Posted on 2002-03-25 02:10:00 by BJZ</div>
   </div>
   <div class="post" id="post-30714">
    <div class="subject"><a href="#post-30714">System level programming problems</a></div>
    <div class="body">I must second Bogdan here, lets keep this crap outa here, its treading very close to the edge of forum rules and our rules are VERY clear about viral techniques.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-03-25 04:36:34 by hutch--</div>
   </div>
   <div class="post" id="post-30738">
    <div class="subject"><a href="#post-30738">System level programming problems</a></div>
    <div class="body">Bogdan,<br /><br />here is my (working code) from a win32 dll:<br /><br /><pre><code><br />intproc proc<br /> push 0		;make room for original vector<br /> pushad<br /> pushfd<br /> push ds<br /> push es<br /> mov eax,ss<br /> mov ds,eax<br /> mov es,eax<br /> mov eax,oldaddr<br /> mov &#91;esp+32+12&#93;,eax<br /> invoke OutputMonoString, addr szKeyEvent<br /> pop es<br /> pop ds<br /> popfd<br /> popad<br /> ret<br />intproc endp<br /></code></pre><br /><br />what should be mentioned<br />- when entering an irq routine all registers (except cs) are undefined<br />- if ring has changed, stack will have been switched. The above routine assumes that ss will always be a flat selector. This should be the case in win9x, but its only a convention.<br />- you will need to initialize ds and es!<br /><br />japheth</div>
    <div class="meta">Posted on 2002-03-25 07:22:11 by japheth</div>
   </div>
   <div class="post" id="post-30905">
    <div class="subject"><a href="#post-30905">System level programming problems</a></div>
    <div class="body">Thx man<br />I will check it out :)<br /><br />Some more  little Q: <br />-how to mark code as non-pageable?<br />-offset stuff will work anymore ?<br />(hehe... i need to make some C++ interfaces for it)<br /><br />Thx again</div>
    <div class="meta">Posted on 2002-03-26 00:16:32 by BogdanOntanu</div>
   </div>
   <div class="post" id="post-30917">
    <div class="subject"><a href="#post-30917">System level programming problems</a></div>
    <div class="body">If I remember correctly you need to kick the cpu <br />after you change the idt/gdt because it is <br />cached.<br /><br />So you can mess with the interrupts in protected <br />code and ring 3?</div>
    <div class="meta">Posted on 2002-03-26 02:03:48 by bdjames</div>
   </div>
   <div class="post" id="post-30930">
    <div class="subject"><a href="#post-30930">System level programming problems</a></div>
    <div class="body">Bogdan,<br /><br />- VirtualLock() will lock a region in memory so it cant paged out.<br />- Im not sure if I understand your second question. The &quot;offset&quot; operator should always work as long as cs,ds,es,ss are flat selectors.</div>
    <div class="meta">Posted on 2002-03-26 02:57:52 by japheth</div>
   </div>
   <div class="post" id="post-31373">
    <div class="subject"><a href="#post-31373">new things</a></div>
    <div class="body">Thx japeth and all<br /><br />I have moved the Ring0 IRQ handler into a VXD LOCKED section. I as using a VXD for other jobs anyway so even if it looks that code could be in a shared DLL also i guess the &quot;all in a VXD&quot; make for more monolithic code, also more &quot;standard&quot;<br /><br />Interesting for the debate now comes a now problem: the VMM :(<br /><br />the VKD driver virtualizes the IRQ1 before i get a chance to do it and because of that i can not use it, so i am back to changeing the IDT. After i do that i get &quot;beeps&quot; on all keys and everything seems to work ok...<br /><br />But it is not: some keys get pass my IRQ handler (and i trap them i a normal VXD keyboard hook routine)... i was puzzeld at start...<br /><br />then i realized that diffrent VM machines have their own IRQ handlers and somewhere/sometimes the VMM sheduler changes the IDT back to its original vector :(<br /><br />I was also trying to place the read keys from my simple IRQ1 handler back into the system keyboard queue using the VKD_API_Force_Key VxDCall but surprise: teere is no include with this call even if it is presented in the 98DDK....hmmmm<br /><br />I then used VKD_Put_Byte inside my IRQ handler....waiting for a crash... ooops there is no crash but no key inserted in the system keyboard queue neither....<br /><br />To sumarize my problems are now changed, but in the same range:<br /><br />1.How to hook ALL VM's IRQ1 handler and not only for some VM's<br /><br />2.After hook how to insert scancodes read via in al,60h back into the system keyboard queue....<br /><br />I am working on that....so any help is welcome...<br /><br />Thx</div>
    <div class="meta">Posted on 2002-03-28 15:09:04 by BogdanOntanu</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=4226&amp;page=1" style="">&laquo;</a><a href="../?id=4226&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="4226" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>  </div>
 </body>
</html>