<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Failure with fade-in-out-loop-code,  please help - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=6452" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=6452">Failure with fade-in-out-loop-code,  please help</a></p>
   <div class="post" id="post-46482">
    <div class="subject"><a href="#post-46482">Failure with fade-in-out-loop-code,  please help</a></div>
    <div class="body">Hi,<br />I have a problem, it this code. It's 6 (realy 7) loops, one for briting up a text and one for darken a text. The problem occurs when running, at first, before &quot;the 7th loop&quot; (red text) was added, the first loop executed alright, but after it faded in the first text the text disapeared in black before appearing again (in full intensity) and fade away. After a few tests I tried to add &quot;the 7th loop&quot;, then the first (and the second text) faded in and out , without the 'black hole syndrome' between them. But, between the 5th and 6th the 'black holw syndrom' apeared.<br /><br />Why?!?!? :confused:<br /><br />BTW I must have done something wrong when push-/poping, sine I had to add the &quot;mov ebp,esp / push ebp&quot; and &quot;pop ebp / mov esp,ebp&quot; to avoid Execption Access Violation.<br /><br />BTW2 Any help optimizing this pice of #######-code would be apriciated<br /><br /><pre><code><br />the_PROC PROC<br /> mov   ebp, esp<br /> push ebp<br /><br />&#91;COLOR=red&#93;<br /> xor ecx, ecx<br /> xor edi, edi<br /> push ecx<br />$zhd&#58; cmp ecx, 255<br /> je	SHORT $zdh<br /> pop	ecx<br /> inc 	ecx<br /> push	ecx<br /> jmp	SHORT $zhd<br />$zdh&#58;	; end for shade<br />$zdg&#58;	cmp	ecx, -127<br />	je	SHORT $zgd<br />	pop	ecx<br />	dec 	ecx<br />	push	ecx<br />	jmp	SHORT $zdg<br />$zgd&#58;	; end for shade<br />	push	2000<br />	call	Sleep<br />&#91;/COLOR&#93;<br /><br />&#91;B&#93;;&#91;LOOP PAIR 1 START&#93;&#91;/B&#93;<br />	xor	ecx, ecx<br />	xor	edi, edi<br />	push	ecx<br />	lea	esi, szCOMP<br />$zhs&#58;	cmp	ecx, 255	;for &#40;shade=0; shade &lt; 256; shade++&#41;<br />	je		SHORT $zsh<br />		; draw text in shades<br />		push	lpddsprimary<br />		add	edi, 00000101h	; increase the &quot;light&quot; of the text.<br />		push	edi<br />		push	240<br />		push	esi<br />		call	lstrlen<br />		mov	ebx, 320<br />		shr	eax, 2<br />		sub	ebx,eax<br />		push	ebx<br />		push	esi<br />		call	Draw_Text_GDIc<br />		push	1<br />		call	Sleep<br />		invoke	GetAsyncKeyState,VK_ESCAPE	; is user trying to bail<br />		shl	ax, 1<br />		jc	$456<br />	pop	ecx<br />	inc 	ecx<br />	push	ecx<br />	jmp	SHORT $zhs<br />$zsh&#58;	; end for shade<br />	push	2000<br />	call	Sleep<br />$zsg&#58;	cmp	ecx, -127		;&lt;- -127 == 255 &#93; for &#40;shade=0; shade &lt; 256; shade++&#41;<br />	je		SHORT $zgs<br />		; draw text in shades<br />		push	lpddsprimary<br />		sub	edi, 00000101h<br />		push	edi<br />		push	240<br />		push	esi<br />		call	lstrlen<br />		mov	ebx, 320<br />		shr	eax, 2<br />		sub	ebx,eax<br />		push	ebx<br />		push	esi<br />		call	Draw_Text_GDIc<br />		push	1<br />		call	Sleep<br />		invoke	GetAsyncKeyState,VK_ESCAPE	; is user trying to bail<br />		shl	ax, 1<br />		jc	$456<br />	pop	ecx<br />	dec 	ecx<br />	push	ecx<br />	jmp	SHORT $zsg<br />$zgs&#58;	; end for shade<br />	push	2000<br />	call	Sleep<br />&#91;B&#93;;&#91;LOOP PAIR 1 END&#93;&#91;/B&#93;<br /><br />&#91;B&#93;;&#91;LOOP PAIR 2 START&#93;&#91;/B&#93;<br />	xor	ecx, ecx<br />	xor	edi, edi<br />	push	ecx<br />	lea	esi, szPRESENTS<br />$zhu&#58;	cmp	ecx, 255	;for &#40;shade=0; shade &lt; 256; shade++&#41;<br />	je		SHORT $zuh<br />		; draw text in shades<br />		push	lpddsprimary<br />		add	edi, 00010001h<br />		push	edi<br />		push	240<br />		push	esi<br />		call	lstrlen<br />		mov	ebx, 320<br />		shr	eax, 2<br />		sub	ebx,eax<br />		push	ebx<br />		push	esi<br />		call	Draw_Text_GDIc<br />		push	1<br />		call	Sleep<br />		invoke	GetAsyncKeyState,VK_ESCAPE	; is user trying to bail<br />		shl	ax, 1<br />		jc	$456<br />	pop	ecx<br />	inc 	ecx<br />	push	ecx<br />	jmp	SHORT $zhu<br />$zuh&#58;	; end for shade<br />	push	2000<br />	call	Sleep<br />$zhg&#58;	cmp	ecx, -127		;&lt;- -127 == 255 &#93; for &#40;shade=0; shade &lt; 256; shade++&#41;<br />	je		SHORT $zgh<br />		; draw text in shades<br />		push	lpddsprimary<br />		sub	edi, 00010001h<br />		push	edi<br />		push	240<br />		push	esi<br />		call	lstrlen<br />		mov	ebx, 320<br />		shr	eax, 2<br />		sub	ebx,eax<br />		push	ebx<br />		push	esi<br />		call	Draw_Text_GDIc<br />		push	1<br />		call	Sleep<br />		invoke	GetAsyncKeyState,VK_ESCAPE	; is user trying to bail<br />		shl	ax, 1<br />		jc	$456<br />	pop	ecx<br />	dec 	ecx<br />	push	ecx<br />	jmp	SHORT $zhg<br />$zgh&#58;	; end for shade<br />	push	2000<br />	call	Sleep<br />&#91;B&#93;;&#91;LOOP PAIR 2 END&#93;&#91;/B&#93;<br /><br />&#91;B&#93;;&#91;LOOP PAIR 3 START&#93;&#91;/B&#93;<br />	xor	ecx, ecx<br />	xor	edi, edi<br />	lea	esi, szGAME<br />$xhu&#58;	cmp	ecx, 255	;for &#40;shade=0; shade &lt; 256; shade++&#41;<br />	je		SHORT $xuh<br />		; draw text in shades<br />		push	lpddsprimary<br />		add	edi, 00010101h<br />		push	edi<br />		push	240<br />		push	esi<br />		call	lstrlen<br />		mov	ebx, 320<br />		shr	eax, 2<br />		sub	ebx,eax<br />		push	ebx<br />		push	esi<br />		call	Draw_Text_GDIc<br />		push	1<br />		call	Sleep<br />		invoke	GetAsyncKeyState,VK_ESCAPE	; is user trying to bail<br />		shl	ax, 1<br />		jc	$456<br />	pop	ecx<br />	inc 	ecx<br />	push	ecx<br />	jmp	SHORT $xhu<br />$xuh&#58;	; end for shade<br />	push	2000<br />	call	Sleep<br />$xhg&#58;	cmp	ecx, -127		;&lt;--127 == 255 &#93; for &#40;shade=0; shade &lt; 256; shade++&#41;<br />	je		SHORT $xgh<br />		; draw text in shades<br />		push	lpddsprimary<br />		sub	edi, 00010101h<br />		push	edi<br />		push	240<br />		push	esi<br />		call	lstrlen<br />		mov	ebx, 320<br />		shr	eax, 2<br />		sub	ebx,eax<br />		push	ebx<br />		push	esi<br />		call	Draw_Text_GDIc<br />		push	1<br />		call	Sleep<br />		invoke	GetAsyncKeyState,VK_ESCAPE	; is user trying to bail<br />		shl	ax, 1<br />		jc	$456<br />	pop	ecx<br />	dec 	ecx<br />	push	ecx<br />	jmp	SHORT $xhg<br />$xgh&#58;	; end for shade<br />	pop	ebp<br />	mov	esp, ebp<br />	push	2000<br />	call	Sleep<br />&#91;B&#93;;&#91;LOOP PAIR 3 END&#93;&#91;/B&#93;<br />	ret<br />$456&#58;	pop	ebp<br />	mov	esp, ebp<br />	ret<br />the_PROC ENDP<br /></code></pre></div>
    <div class="meta">Posted on 2002-07-06 14:40:46 by scientica</div>
   </div>
   <div class="post" id="post-46485">
    <div class="subject"><a href="#post-46485">Failure with fade-in-out-loop-code,  please help</a></div>
    <div class="body">you should push ebp <br />before mov ebp,esp<br /><br /><br />and in the end <br />just pop ebp<br /><br />bye<br /><br />eko</div>
    <div class="meta">Posted on 2002-07-06 15:01:55 by eko</div>
   </div>
   <div class="post" id="post-46488">
    <div class="subject"><a href="#post-46488">Failure with fade-in-out-loop-code,  please help</a></div>
    <div class="body"><div class="quote"><br />you should push ebp <br />before mov ebp,esp<br /><br /><br />and in the end <br />just pop ebp<br /><br />bye<br /><br />eko </div><br /><br />eko, I tried that. But I only got an exception. And the 'black hole syndrome' presists.<br />I must admit I donnot realy understand the stack, just know that it's like a pile of plates &lt;- a push (or pop) wrong and a plate smash.. :(</div>
    <div class="meta">Posted on 2002-07-06 15:15:19 by scientica</div>
   </div>
   <div class="post" id="post-46493">
    <div class="subject"><a href="#post-46493">Failure with fade-in-out-loop-code,  please help</a></div>
    <div class="body">Well, uh, there's no pointing in shoving EBP back and forth, when you don't use EBP. Also, you forgot a &quot;POP ECX&quot; after the &quot;$456:&quot;</div>
    <div class="meta">Posted on 2002-07-06 15:57:19 by Sephiroth3</div>
   </div>
   <div class="post" id="post-46548">
    <div class="subject"><a href="#post-46548">Failure with fade-in-out-loop-code,  please help</a></div>
    <div class="body">I'm not sure, but it looks like an inline C function called 3 times with different string pointers.<br />The function seems to do something like :<br /><br /><pre><code><br />TheProc&#40;sz, lpdd&#41;<br />&#123;<br />for &#40;shade = 0, light = 0; shade &lt; 256; shade++, light += 0x101&#41;<br />&#123;<br />	Draw_Text_GDIc&#40;szMemCOMP, 320-lstrlen<br />&#40;szMemCOMP&#41;/4, 240, light, lpddsprimary, shade&#41;<br />	Sleep&#40;1&#41;;<br />&#125;<br />Sleep&#40;2000&#41;;<br />for &#40;; shade &gt;= 0; shade--, light -= 0x101&#41;<br />&#123;<br />	Draw_Text_GDIc&#40;szMemCOMP, 320-lstrlen<br />&#40;szMemCOMP&#41;/4, 240, light, lpddsprimary, shade&#41;<br />	Sleep&#40;1&#41;;<br />	// test GetAsync...<br />&#125;<br />&#125;<br /></code></pre><br /><br />Some simple optimizations : if Draw_Text doesn't change the<br />string there is no need call lstrlen in each iteration. <br />Also the loops are very similar except for the shade and light<br />increment. The C code could become :<br /><pre><code><br />TheProc&#40;sz, lpdd&#41;<br />&#123;<br />shade = 0;<br />light = 0;<br />delta_light = 0x101;<br />delta_shade = -1;<br />n = 320-lstrlen&#40;szMemCOMP&#41;/4;<br />Loop &#58;<br />do<br />&#123;<br />	Draw_Text_GDIc&#40;szMemCOMP, n, 240, light,<br />lpddsprimary, shade&#41;<br />	Sleep&#40;1&#41;;<br />	// test GetAsync...<br />	light += delta_light;<br />	shade += delta_shade;<br />&#125; while &#40;shade &gt; 0 &amp;&amp; shade &lt; 256&#41;;<br />delta_light = -delta_light;<br />delta_shade = -delta_shade<br />if &#40;delta_light &lt; 0&#41;<br />	goto  Loop<br />&#125;<br /></code></pre><br /><br />It could be translated to :<br /><pre><code><br />Func sz&#58;DWORD, lp&#58;DWORD<br /><br />LOCAL n&#58;DWORD<br />LOCAL shade&#58;DWORD<br /><br />	push	ebx<br />	push	edi<br />	push	esi<br />		<br />	light		TEXTEQU &lt;ebx&gt;<br />	delta_light	TEXTEQU &lt;edi&gt;<br />	delta_shade	TEXTEQU &lt;esi&gt;<br /><br />	;// init value<br />	xor		light, light<br />	mov		delta_light, 0101h	<br />	mov		shade, light<br />	mov		delta_shade, 1		<br /><br />	;// compute n = 320 - lstrlen&#40;sz&#41;/4	<br />	push	sz<br />	call	lstrlen<br />	mov	n, 320<br />	shr	eax, 2<br />	sub	n, eax<br /><br />	;// start brightening loop<br />$zhs&#58;<br /><br />	add	shade, delta_shade<br />	add	light, delta_light<br /><br />	push	shade<br />	push	240<br />	push	lpdd<br />	push	light<br />	push	n<br />	push	sz<br />	call	Draw_Text_GDIc<br />		<br />	push	1<br />	call	Sleep<br />		<br />	invoke	GetAsyncKeyState,VK_ESCAPE	; is user trying to bail<br />	shl	ax, 1<br />	jnz	$456	<br />	<br />	;// exit loop when shade == 256 or -1<br />	test	shade, 0100h<br />	jz	$zhs<br /><br />	push	2000<br />	call	Sleep<br /><br />	;// invert delta_light and delta_shade<br />	neg		delta_shade<br />	neg		delta_light	<br /><br />	;// exit when delta_light becomes positive again<br />	js		$zhs<br /><br />	pop		esi<br />	pop		edi<br />	pop		ebx<br /><br />	ret<br /><br />Func ENDP<br /></code></pre></div>
    <div class="meta">Posted on 2002-07-07 02:06:17 by Dr. Manhattan</div>
   </div>
   <div class="post" id="post-46581">
    <div class="subject"><a href="#post-46581">The Black hole syndrome</a></div>
    <div class="body">I think I know why this syndrom appears, at least I found a cure.<br /><br />My gues is that the 2 sec sleep (push 2000 / call sleep), didn't stop DX from uppdating the screen (I use dubble buffering), so I replaced it with a GetTickCount solution. And now it fades in and out smoothly.</div>
    <div class="meta">Posted on 2002-07-07 12:28:56 by scientica</div>
   </div>
  </div>
 </body>
</html>