<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Loading a bitmap without LoadImage - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=15029" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=15029">Loading a bitmap without LoadImage</a></p>
   <div class="post" id="post-116611">
    <div class="subject"><a href="#post-116611">Loading a bitmap without LoadImage</a></div>
    <div class="body">I recently had to find a way to load an image from resources without using LoadImage as that function is not available in Win9x using the LOAD_LIBRARY_AS_DATAFILE flag of LoadLibraryEx. Here is the code, it requires a module handle (obtained from LoadLibraryEx) a resource identifier, a resource type (RT_BITMAP always) and a pointer to a DWORD buffer to receive the number of colors. It returns a valid DDB bitmap handle:<br /><pre><code>LoadResourceImage proc hModule&#58;DWORD, pResName&#58;DWORD, ResTypeNumber&#58;DWORD, pcColors&#58;DWORD<br />	LOCAL hFindRes		&#58;DWORD<br />	LOCAL hResData		&#58;DWORD<br />	LOCAL pResData		&#58;DWORD<br />	LOCAL hDC		&#58;DWORD<br />	LOCAL cbBits		&#58;DWORD<br /><br />	invoke FindResource, hModule, pResName, ResTypeNumber<br />	mov hFindRes,eax<br />	invoke LoadResource,hModule,hFindRes<br />	mov hResData,eax<br />	invoke LockResource,hResData<br />	mov pResData,eax<br /><br />	mov edi,pResData<br />	movzx ecx,&#91;edi&#93;.BITMAPINFO.bmiHeader.biBitCount<br />	mov cbBits,ecx<br />	.IF pcColors<br />		mov eax,pcColors<br />		mov &#91;eax&#93;,ecx<br />	.ENDIF<br /><br />	invoke GetDC,hDlg<br />	mov hDC,eax<br /><br />	mov ecx,cbBits<br />	mov eax,1<br />	shl eax,cl<br />	mov edx,SIZEOF RGBQUAD<br />	imul edx<br />	.IF cbBits &gt;= 24 ; There is no RGBQUAD array for 24 bit<br />		mov eax,0<br />	.ENDIF<br />	add eax,SIZEOF BITMAPINFOHEADER<br />	add eax,pResData<br /><br />	invoke CreateDIBitmap, hDC, edi, CBM_INIT, eax, edi, DIB_RGB_COLORS<br />	push eax<br />	invoke ReleaseDC,hDlg,hDC<br />	pop eax<br />	ret<br />LoadResourceImage endp</code></pre>EDIT put in some spaces to have the formatting correct.</div>
    <div class="meta">Posted on 2003-09-02 14:45:11 by donkey</div>
   </div>
   <div class="post" id="post-116663">
    <div class="subject"><a href="#post-116663">Loading a bitmap without LoadImage</a></div>
    <div class="body">To continue, you also have to be able to load an icon or a cursor as well. To do this without LoadImage is actually easier than the bitmap method, it requires the same parameters as the bitmap version but uses either RT_CURSOR or RT_ICON as the resource types<pre><code>LoadResourceIcon proc hModule&#58;DWORD, pResName&#58;DWORD, ResTypeNumber&#58;DWORD<br />	LOCAL hFindRes		&#58;DWORD<br />	LOCAL hResData		&#58;DWORD<br />	LOCAL pResData		&#58;DWORD<br />	LOCAL ResSize		&#58;DWORD<br /><br />	invoke FindResource, hModule, pResName, ResTypeNumber<br />	mov hFindRes,eax<br />	invoke SizeofResource,hModule,hFindRes<br />	mov ResSize,eax<br />	invoke LoadResource,hModule,hFindRes<br />	mov hResData,eax<br />	invoke LockResource,hResData<br />	mov pResData,eax<br /><br />	.IF ResTypeNumber == RT_ICON<br />		invoke CreateIconFromResource, pResData, ResSize, TRUE, 030000h<br />	.ELSEIF ResTypeNumber == RT_CURSOR<br />		invoke CreateIconFromResource, pResData, ResSize, FALSE, 030000h<br />	.ELSE<br />		mov eax,INVALID_HANDLE_VALUE<br />	.ENDIF<br />	push eax<br />	invoke FreeResource, hResData<br />	pop eax<br />	ret<br />LoadResourceIcon endp</code></pre></div>
    <div class="meta">Posted on 2003-09-02 20:29:01 by donkey</div>
   </div>
   <div class="post" id="post-116965">
    <div class="subject"><a href="#post-116965">Loading a bitmap without LoadImage</a></div>
    <div class="body">To continue on this subject, this routine will save the resource icon to a previously opened file specified by hFile. You must pass it the identifier to an RT_GROUP_ICON resource.<pre><code>SaveIconResource proc uses edi esi hModule&#58;DWORD, hFile&#58;DWORD, pResName&#58;DWORD<br />	LOCAL hFindRes				&#58;DWORD<br />	LOCAL hResData				&#58;DWORD<br />	LOCAL pResData				&#58;DWORD<br />	LOCAL ResSize				&#58;DWORD<br />	LOCAL iCount				&#58;DWORD<br />	LOCAL pOutput				&#58;DWORD<br />	LOCAL cbWritten				&#58;DWORD<br />	LOCAL cbWrite				&#58;DWORD<br />	LOCAL iResName&#91;16&#93;			&#58;BYTE<br />	LOCAL StrOffset				&#58;DWORD<br /><br />	.IF hFile == INVALID_HANDLE_VALUE<br />		ret<br />	.endif<br />	mov al,&quot;#&quot;<br />	mov iResName,al<br />	invoke FindResource,hModule,pResName,RT_GROUP_ICON<br />	mov hFindRes,eax<br />	invoke SizeofResource,hModule,hFindRes<br />	mov ResSize,eax<br />	invoke LoadResource,hModule,hFindRes<br />	mov hResData,eax<br />	invoke LockResource,hResData<br />	mov pResData,eax<br />	.IF pResData == NULL<br />		ret<br />	.endif<br /><br />	; Calculte the size of the file<br />	mov edi,pResData<br />	xor ecx,ecx<br />	mov cx,&#91;edi&#93;.GRPICONDIR.idCount<br />	mov iCount,ecx<br />	add edi,SIZEOF GRPICONDIR<br />	mov eax,SIZEOF GRPICONDIR<br />	.REPEAT<br />		add eax,&#91;edi&#93;.GRPICONDIRENTRY.dwBytesInRes<br />		add eax,SIZEOF GRPICONDIRENTRY<br />		add edi,SIZEOF GRPICONDIRENTRY<br />	.UNTILCXZ<br />	mov ecx,iCount<br />	shl ecx,1<br />	add eax,ecx<br />	mov cbWrite,eax<br />	invoke GlobalAlloc,GMEM_FIXED,eax<br />	mov pOutput,eax<br /><br />	mov esi,pResData<br />	mov edi,pOutput<br />	; Copy the header &#40;MemCopy,Source,Dest,#Btyes<br />	invoke MemCopy,pResData,pOutput,SIZEOF GRPICONDIR<br />	; Move the pointers up<br />	add esi,SIZEOF GRPICONDIR<br />	add edi,SIZEOF GRPICONDIR<br />	; Copy the array of Icon dir entries<br />	mov ecx,0<br />	.REPEAT<br />		push ecx<br />		; Copy the icon entry<br />		invoke MemCopy,esi,edi,SIZEOF GRPICONDIRENTRY<br />		; mov the pointers up<br />		add esi,SIZEOF GRPICONDIRENTRY<br />		add edi,SIZEOF GRPICONDIRENTRY<br />		; An extra 2 for the destination index<br />		add edi,2<br />		pop ecx<br />		inc ecx<br />	.UNTIL ecx == iCount<br /><br />	mov ecx,0<br />	; reset the source index to the first GRPICONDIRENTRY<br />	mov esi,pResData<br />	add esi,SIZEOF GRPICONDIR<br />	; reset the Destination index to the first ICONDIRENTRY<br />	mov eax,pOutput<br />	add eax,SIZEOF GRPICONDIR<br />	mov StrOffset,eax<br />	.REPEAT<br />		push ecx<br />		; Get the id of the icon<br />		lea ecx,iResName<br />		inc ecx<br />		movzx eax,&#91;esi&#93;.GRPICONDIRENTRY.nID<br />		invoke dwtoa,eax,ecx<br /><br />		; Get a copy of the icon resource<br />		invoke FindResource,hModule,ADDR iResName,RT_ICON<br />		mov hFindRes,eax<br />		invoke SizeofResource,hModule,hFindRes<br />		mov ResSize,eax<br />		invoke LoadResource,hModule,hFindRes<br />		mov hResData,eax<br />		invoke LockResource,hResData<br />		mov pResData,eax<br /><br />		; Copy the icon data to the buffer<br />		invoke MemCopy,pResData,edi,&#91;esi&#93;.GRPICONDIRENTRY.dwBytesInRes<br /><br />		; move the offset of this data to the array<br />		mov ecx,edi<br />		sub ecx,pOutput<br />		mov eax,StrOffset<br />		mov &#91;eax&#93;.ICONDIRENTRY.dwImageOffset,ecx<br />		add StrOffset,SIZEOF ICONDIRENTRY<br /><br />		; Increment the destination pointer<br />		add edi,&#91;esi&#93;.GRPICONDIRENTRY.dwBytesInRes<br /><br />		; Increment the source pointer<br />		add esi,SIZEOF GRPICONDIRENTRY<br />		pop ecx<br />		inc ecx<br />	.UNTIL ecx == iCount<br /><br />	invoke WriteFile,hFile,pOutput,cbWrite,ADDR cbWritten,NULL<br />	invoke GlobalFree,pOutput<br />	ret<br /><br />SaveIconResource endp</code></pre></div>
    <div class="meta">Posted on 2003-09-04 15:26:52 by donkey</div>
   </div>
   <div class="post" id="post-116973">
    <div class="subject"><a href="#post-116973">Loading a bitmap without LoadImage</a></div>
    <div class="body">To use the icon saver you will require the following structures, they are buried deep at MSDN and rather hard to find:<pre><code><br />GRPICONDIR Struct<br />	idReserved		WORD	?;	Reserved &#40;must be 0&#41;<br />	idType			WORD	?;	Resource type &#40;1 for icons&#41;<br />	idCount			WORD	?;	How many images?<br />GRPICONDIR ends<br /><br />GRPICONDIRENTRY struct<br />	bWidth			BYTE	?;	Width, in pixels, of the image<br />	bHeight			BYTE	?;	Height, in pixels, of the image<br />	bColorCount		BYTE	?;	Number of colors in image &#40;0 if &gt;=8bpp&#41;<br />	bReserved		BYTE	?;	Reserved<br />	wPlanes			WORD	?;	Color Planes<br />	wBitCount		WORD	?;	Bits per pixel<br />	dwBytesInRes	DWORD	?;	how many bytes in this resource?<br />	nID				WORD	?;	the ID<br />GRPICONDIRENTRY ends<br /><br />ICONDIR struct<br />	idReserved		WORD	? ; Reserved &#40;must be 0&#41;<br />	idType			WORD	? ;Resource Type &#40;1 for icons&#41;<br />	idCount			WORD	? ;How many images?<br />ICONDIR ENDS<br /><br />ICONDIRENTRY struct<br />	bWidth			BYTE	? ;Width, in pixels, of the image<br />	bHeight			BYTE	?  ;Height, in pixels, of the image<br />	bColorCount		BYTE	? ;Number of colors in image &#40;0 if &gt;=8bpp&#41;<br />	bReserved		BYTE	?  ;Reserved &#40; must be 0&#41;<br />	wPlanes			WORD	? ;Color Planes<br />	wBitCount		WORD	? ;Bits per pixel<br />	dwBytesInRes	DWORD	? ;How many bytes in this resource?<br />	dwImageOffset	DWORD	? ;Where in the file is this image?<br />ICONDIRENTRY ENDS</code></pre>Note the slight difference between GRPICONDIRENTRY and ICONDIRENTRY, the routine could have been much shorter if it wasn't for the missing WORD in GRPICONDIRENTRY (nID is shorter than dwImageOffset)</div>
    <div class="meta">Posted on 2003-09-04 15:39:44 by donkey</div>
   </div>
  </div>
 </body>
</html>