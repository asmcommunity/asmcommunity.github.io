<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>System Process Informations - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=17214" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=17214">System Process Informations</a></p>
   <div class="post" id="post-133386">
    <div class="subject"><a href="#post-133386">System Process Informations</a></div>
    <div class="body"><pre><code><br />PROJECT     &#58; Process Viewer &#40;ProcessView.exe&#41;<br />AUTHOR&#40;S&#41;   &#58; Pegasus, Reverse Engineering Network,&#91;imgmail&#93;http&#58;//www.asmcommunity.net/board/cryptmail.php?tauntspiders=in.your.face@nomail.for.you&amp;id=8df0fe5caf4e4f9837da87f25c1253a8&#91;/imgmail&#93;<br />LANGUAGE    &#58; assembler &#40;MASM V8&#41;<br />VERSION     &#58; 1.05 - 2004-02-13<br />OS          &#58; Windows 95/98/ME/2K/XP/2K3<br /><br />DESCRIPTION &#58; This project is an simple example on how to access system information via<br />              &quot;CreateToolhelp32Snapshot&quot; and displaying it by using a TreeView. <br />              On Windows NT-based operating systems, also additional informations are <br />              displayed for modules, heaps and threads by using &quot;SeDebugPrivilege&quot; and <br />              changing the TokenPrivileges.<br /><br />TIPS        &#58; If you have trouble compiling this project, be sure your &quot;windows.inc&quot;<br />              contains the following line&#58; &#40;THE NEW WINDOWS.INC DIDN'T CONTAIN IT!!&#41;<br />                           TV_INSERTSTRUCT equ &lt;TVINSERTSTRUCTA&gt;<br /><br />              Compilable via RadASM 2.0.4.0 &#40;ProcessView.rap&#41; or commandline &#40;_build.bat&#41;<br /><br />DISCLAIMER  &#58; Usage on own risk. The authors assume no responsibility for errors or<br />              omissions. Neither is an liability assumed for damages resulting from<br />              the use of this application.<br /><br /></code></pre></div>
    <div class="meta">Posted on 2004-02-13 11:32:53 by cu.Pegasus</div>
   </div>
   <div class="post" id="post-133669">
    <div class="subject"><a href="#post-133669">Re: System Process Informations</a></div>
    <div class="body"><div class="quote"><em>Originally posted by cu.Pegasus </em><br /><pre><code><br />PROJECT     &#58; Process Viewer &#40;ProcessView.exe&#41;<br />/snip/<br />OS          &#58; Windows 95/98/ME/&#91;b&#93;NT&#91;/b&#93;/2K/XP/2K3<br /></code></pre></div><br /><br />When I first downloaded it at home and took a quick look at the source, I suspected it is *not* NT-compatible (because you are using ToolHelp API which is not available on WinNT4). I couldn't check it at home, so today at my office I downloaded it again, compiled and tried to run - and I was right. The executable complains about Module32First not being found in kernel32.dll and terminates. So, your ProcessViewer is <strong>not</strong> for WinNT (4 and earlier).</div>
    <div class="meta">Posted on 2004-02-16 04:28:37 by Morris</div>
   </div>
   <div class="post" id="post-133675">
    <div class="subject"><a href="#post-133675">System Process Informations</a></div>
    <div class="body">Hi,<br />as told by Morris, this application wont run with NT4 (and lower). In order to avoid the execution on this OS, add the codeparts between &quot;Insert&quot; and &quot;Insert-End&quot; to your source. The OS is checked by using the entries of ProcessEnvoronmentBlock..<br />... and of course don't forget the data for the MessageBox (szNT4Error &amp; szNT4Caption) ;)<br /><br /><pre><code><br />  ; -- NT-based OS check ;&#41;<br />  assume  fs&#58;nothing                                     ; it's masm, so we need it...<br />  mov     eax,fs&#58;&#91;18h&#93;                                   ; get TEB self pointer<br />  mov     ebx,fs&#58;&#91;30h&#93;                                   ; get pointer to PEB /process data base<br />  .if     eax==7FFDE000h &amp;&amp; ebx==7FFDF000h<br />    <br />;----------- &lt;&lt;INSERT&gt;&gt;<br />    ; -- avoid NT4 and lower execution...<br />    mov     ebx,&#91;ebx+0A4h&#93;                               ; get the major OS version &#40;PEB&#41;<br />    .if     ebx &lt; 5                                      ; lower then Windows 2000<br />      invoke  MessageBox,NULL,addr szNT4Error,addr szNT4Caption,MB_OK<br />      jmp     _leaveApp<br />    .endif<br />;----------- &lt;&lt;INSERT-END&gt;&gt;<br /><br />    ; -- it's NT-based, so we are able to use debug mode!<br />    invoke  GetCurrentProcess                            ; get THIS process handle<br />    mov     _hProcess,eax                                ; and store it<br />    invoke  OpenProcessToken,_hProcess,TOKEN_ADJUST_PRIVILEGES or TOKEN_QUERY,addr _hToken<br />    lea     eax,tkp.Privileges&#91;0&#93;.Luid                   ; needes for AdjustTokenPrivileges<br />    invoke  LookupPrivilegeValue,NULL,offset szString,eax; get the value for &quot;SeDebugPrivilege&quot; <br />    mov     tkp.PrivilegeCount,1                         ; we have one array <br />    mov     tkp.Privileges&#91;0&#93;.Attributes,SE_PRIVILEGE_ENABLED ; enable our privilege<br />    invoke  AdjustTokenPrivileges,_hToken,FALSE,addr tkp, sizeof tkp, NULL, NULL<br />    invoke  CloseHandle,_hToken                          ; close the opened token<br />  .endif                                                 ; -- of NT based check<br /><br />  invoke  InitCommonControls                             ; init treeview usage<br />  invoke  DialogBoxParam,hInstance,IDD_DIALOG,NULL,offset DlgProc,NULL<br /><br />;----------- &lt;&lt;INSERT&gt;&gt;<br />_leaveApp&#58;<br />;----------- &lt;&lt;INSERT-END&gt;&gt;<br /><br />  invoke  ExitProcess,NULL                               ; cleanup and kill process<br /></code></pre><br /><br />I've seen the solution and source code written by Morris for WindowsNT4. Very good, Morris.<br />Maybe you could post it also, so ppl could see the differences?<br /><br />Regards, Pegasus</div>
    <div class="meta">Posted on 2004-02-16 05:20:52 by cu.Pegasus</div>
   </div>
   <div class="post" id="post-133754">
    <div class="subject"><a href="#post-133754">System Process Informations</a></div>
    <div class="body">A C++ class incorporating an easy windows crossplatform port of the ToolHelp32 functions (including NT4) is available here: <a target="_blank" href="http://www.codeproject.com/threads/killprocess.asp?target=toolhelp32%7CNT">How to kill a process given a name</a>. The code is readily translatable to asm.</div>
    <div class="meta">Posted on 2004-02-16 19:35:19 by Poimander</div>
   </div>
   <div class="post" id="post-133766">
    <div class="subject"><a href="#post-133766">System Process Informations</a></div>
    <div class="body"><div class="quote"><em>Originally posted by cu.Pegasus </em><br />Hi,<br />as told by Morris, this application wont run with NT4 (and lower). In order to avoid the execution on this OS, add the codeparts between &quot;Insert&quot; and &quot;Insert-End&quot; to your source. The OS is checked by using the entries of ProcessEnvoronmentBlock...</div><br />Unfortunately, the program will never get there (on WinNT4), because it will be terminated at load-and-resolve-imports stage. Your fix is not enough to termiante the application in a graceful way :) You also have to load the ToolHelp API functions dynamically (ie. GetModuleHandle(kernel32), GetProcAddress(Process32First) and so on).<br /><br /><div class="quote">I've seen the solution and source code written by Morris for WindowsNT4. Very good, Morris.<br />Maybe you could post it also, so ppl could see the differences?</div><br /><br />I've gotta clean it up a bit before I can post it ;)<br /><br />Morris</div>
    <div class="meta">Posted on 2004-02-17 01:01:48 by Morris</div>
   </div>
  </div>
 </body>
</html>