<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Window handle - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=18685" />
    <link rel="next" href="../?id=18685&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=18685">Window handle</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=18685&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=18685&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="18685" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=18685&amp;page=2">&gt;</a><a href="../?id=18685&amp;page=2">&raquo;</a></form>   <div class="post" id="post-144771">
    <div class="subject"><a href="#post-144771">Window handle</a></div>
    <div class="body">This is a code snippet from the fasm examples:<br /><br /><pre><code><br />  start&#58;<br /><br />	invoke	GetModuleHandle,0<br />	mov	&#91;hinstance&#93;,eax<br />	invoke	LoadIcon,0,IDI_APPLICATION<br />	mov	&#91;wc.hIcon&#93;,eax<br />	invoke	LoadCursor,0,IDC_ARROW<br />	mov	&#91;wc.hCursor&#93;,eax<br />	mov	&#91;wc.style&#93;,0<br />	mov	&#91;wc.lpfnWndProc&#93;,WindowProc<br />	mov	&#91;wc.cbClsExtra&#93;,0<br />	mov	&#91;wc.cbWndExtra&#93;,0<br />	mov	eax,&#91;hinstance&#93;<br />	mov	&#91;wc.hInstance&#93;,eax<br />	mov	&#91;wc.hbrBackground&#93;,COLOR_BTNFACE+1<br />	mov	&#91;wc.lpszMenuName&#93;,0<br />	mov	&#91;wc.lpszClassName&#93;,_class<br />	invoke	RegisterClass,wc<br /><br />	invoke	CreateWindowEx,0,_class,_title,&#91;ws&#93;,100,100,256,128,NULL,NULL,&#91;hinstance&#93;,NULL<br /><br />  msg_loop&#58;<br />	invoke	GetMessage,msg,NULL,0,0<br />	or	eax,eax<br />	jz	end_loop<br />	invoke	TranslateMessage,msg<br />	invoke	DispatchMessage,msg<br /><br />	jmp	msg_loop<br /><br />  end_loop&#58;<br />	invoke	ExitProcess,&#91;msg.wParam&#93;<br /><br />proc WindowProc, hwnd,wmsg,wparam,lparam<br />	enter<br />	push	ebx esi edi<br />	cmp	&#91;wmsg&#93;,WM_CREATE<br />	je	wmcreate<br />	cmp	&#91;wmsg&#93;,WM_DESTROY<br />	je	wmdestroy<br />	cmp	&#91;wmsg&#93;,WM_COMMAND<br />	je	wmcommand<br />	cmp	&#91;wmsg&#93;,WM_GETMINMAXINFO<br />	je	wmgetminmaxinfo<br />  defwndproc&#58;<br />	invoke	DefWindowProc,&#91;hwnd&#93;,&#91;wmsg&#93;,&#91;wparam&#93;,&#91;lparam&#93;<br />	jmp	finish<br />  wmcreate&#58;<br />	invoke	CreateWindowEx,0,_button,_ws_sysmenu,WS_VISIBLE+WS_CHILD+BS_AUTOCHECKBOX,16,16,256,16,&#91;hwnd&#93;,ID_SYSMENU,&#91;hinstance&#93;,NULL<br />	invoke	CreateWindowEx,0,_button,_ws_thickframe,WS_VISIBLE+WS_CHILD+BS_AUTOCHECKBOX,16,32,256,16,&#91;hwnd&#93;,ID_THICKFRAME,&#91;hinstance&#93;,NULL<br />	invoke	CreateWindowEx,0,_button,_ws_minimizebox,WS_VISIBLE+WS_CHILD+BS_AUTOCHECKBOX,16,48,256,16,&#91;hwnd&#93;,ID_MINIMIZEBOX,&#91;hinstance&#93;,NULL<br />	invoke	CreateWindowEx,0,_button,_ws_maximizebox,WS_VISIBLE+WS_CHILD+BS_AUTOCHECKBOX,16,64,256,16,&#91;hwnd&#93;,ID_MAXIMIZEBOX,&#91;hinstance&#93;,NULL<br />	xor	eax,eax<br />	jmp	finish<br /></code></pre><br /><br />My questions are:<br /><br />1) Why is an error not generated by the use of hwnd in the WindowProc line since this variable is nowhere declared?<br /><br />2) If hwnd is the window's handle, why was it not necessary to save eax into it immediately ofter the CreateWindowX. (Notice that hwnd is used in subsequent calls as the window handle argument.)<br /><br />I have been getting by for over a year without really understanding the above questions, but would really like to understand. It appears that understanding these points may be the key to my other recent posts involving setting the window background color.<br /><br />Any help appreciated.</div>
    <div class="meta">Posted on 2004-06-24 22:21:58 by msmith</div>
   </div>
   <div class="post" id="post-144772">
    <div class="subject"><a href="#post-144772">Window handle</a></div>
    <div class="body">The hwnd is a stack based variable that is declared as part of the WndProc...<br /><br /><pre><code>proc WindowProc, &#91;b&#93;hwnd&#91;/b&#93;,wmsg,wparam,lparam</code></pre><br /><br />It is not necessary to save it when the window is created because Windows will always pass that handle as the first parameter in callbacks to the WndProc. It is actually part of the MSG structure and DispatchMessageA will push the lParam, wParam, msg and hwnd then call the WndProc. This is true for all windows and controls, for example an edit control's DefWindowProc also has the handle of the edit passed as it's first parameter.</div>
    <div class="meta">Posted on 2004-06-24 22:29:19 by donkey</div>
   </div>
   <div class="post" id="post-144773">
    <div class="subject"><a href="#post-144773">Window handle</a></div>
    <div class="body">You could save it immediately after the Createwindowex and most people do it.. and then if you would you would save it into a global variable.<br /><br />Here the coder just uses the local variable hwnd which is passed by default in the WndProc of the created window<br /><br />proc WindowProc, <strong>hwnd</strong>,wmsg,wparam,lparam<br /><br />It is not necessary to save it immediately in this case as said it is passed on every call to WndProc.<br />---------<br />For setting the WIndow Background color you can just do the following: (Not fasm accurate syntax I suppose)<br /><br />At the beginning:<br />invoke CreateSolidBrush, 0028D754h<br />mov,eax<br /><br />And at the end_loop add following:<br /><br />end_loop:<br />invoke DeleteObject, </div>
    <div class="meta">Posted on 2004-06-24 22:33:23 by JimmyClif</div>
   </div>
   <div class="post" id="post-144775">
    <div class="subject"><a href="#post-144775">Window handle</a></div>
    <div class="body">Thanks for the quick reply guys!<br /><br />I still don't understand all of the details.<br /><br />For example:<br /><br /><pre><code><br />invoke CreateWindowEx,0,!OBMainClass,!title,WS_VISIBLE+WS_OVERLAPPEDWINDOW,0,0,400,300,NULL,NULL,&#91;!hinstance&#93;,!OBMain<br />mov &#91;OBMain&#93;,eax<br />mov dword &#91;!OBMain+44&#93;,eax<br />mov dword &#91;!OBMain+8&#93;,eax<br />invoke SetWindowLong,&#91;OBMain&#93;,GWL_USERDATA,!OBMain<br /><br />!MsgLoop&#58;<br />invoke GetMessage,msg,NULL,0,0<br />or eax,eax<br />jz !EndMsgLoop<br />invoke TranslateMessage,msg<br />invoke DispatchMessage,msg<br />jmp !MsgLoop<br />!EndMsgLoop&#58;<br />invoke ExitProcess,&#91;msg.wParam&#93;<br /><br />proc !WindowProc,hwnd,wmsg,wparam,lparam<br />enter<br />push ebx esi edi<br /></code></pre><br /><br />compiles without error but produces no wind when executed.<br /><br />If I change hwnd to OBMain in the Windoproc, it works.</div>
    <div class="meta">Posted on 2004-06-24 22:49:28 by msmith</div>
   </div>
   <div class="post" id="post-144795">
    <div class="subject"><a href="#post-144795">Window handle</a></div>
    <div class="body">Hm, the code looks a bit weird... You have both OBMain and !OBMain - what is the !OBMain variable? What are those arbitrary +44 and +8 offsets?<br /><br />I can see you pass !OBMain as the lparam to CreateWindowEx, as well as setting it as GWL_USERDATA, so I assume it's some data for the window.<br /><br />As for the wndproc not working, it's a bit hard to tell why, as you haven't shown more of it's content :)</div>
    <div class="meta">Posted on 2004-06-25 05:59:06 by f0dder</div>
   </div>
   <div class="post" id="post-144807">
    <div class="subject"><a href="#post-144807">Window handle</a></div>
    <div class="body">!OBMain is a descriptor table for use by my compiler and should have no bearing on this discussion.<br /><br />In the begining of this post I was asking about the hwnd in the WindowProc.<br /><br />Since hwnd was never declared in that example, I was asking how it worked. The answer had to do with it being a stack variable.<br /><br />Maybe a better way to ask the question is &quot;what effect does the handle arg have on the WindowProc&quot;.</div>
    <div class="meta">Posted on 2004-06-25 09:11:48 by msmith</div>
   </div>
   <div class="post" id="post-144809">
    <div class="subject"><a href="#post-144809">Window handle</a></div>
    <div class="body">Why would it have an effect? It's just the handle of your window passed along for your convenience.<br /><br />Parts of this snippet of code are redundant:<br /><br /><pre><code><br /><br />invoke  CreateWindowEx,0,!OBMainClass,!title,WS_VISIBLE+WS<br /> _OVERLAPPEDWINDOW,0,0,400,300,NULL,NULL,&#91;!hinstanc<br />e&#93;,!OBMain<br />mov &#91;OBMain&#93;,eax<br />mov dword &#91;!OBMain+44&#93;,eax<br />mov dword &#91;!OBMain+8&#93;,eax<br />invoke SetWindowLong,&#91;OBMain&#93;,GWL_USERDATA,!OBMain<br /></code></pre><br /><br />So, you pass a structure OBMain as Userdata in the call to createwindowex in the last argument.<br /><br />Then you save the windows handle in the first, the 11 and the 3rd argument.<br /><br />Next you set the Userdata to OBMain again.<br /><br />Why would you want to save the handle 3 times and set the Userdata twice to the same value.<br /><br />But anyway.. this should work, I don't see no reason why not. Maybe post your WM_CREATE handler including your wndproc for us to see what might be wrong.<br /><br />Just on a sidenote, you can not use the handle of the window you pass in OBMain inside the WindowProc in WM_CREATE or at the DefWindowProc call as the call to CreateWindowEx only returns after WM_CREATE has been called.</div>
    <div class="meta">Posted on 2004-06-25 09:42:04 by JimmyClif</div>
   </div>
   <div class="post" id="post-144816">
    <div class="subject"><a href="#post-144816">Window handle</a></div>
    <div class="body">Hi Jimmy,<br /><br />The !OBMain stuff is the window's descriptor and has absolutely no bearing on this discussion.<br /><br /><div class="quote"><br />Next you set the Userdata to OBMain again<br /></div><br /><br />Not at all, I set the UserData to the address of the descriptor structure.<br /><br />In that structure, the 8 offset is the owner and the 44 offset is the handle.<br /><br />None of this has anything to do with my question(s).</div>
    <div class="meta">Posted on 2004-06-25 11:11:48 by msmith</div>
   </div>
   <div class="post" id="post-144819">
    <div class="subject"><a href="#post-144819">Window handle</a></div>
    <div class="body">First of all: I answered your question.<br /><br />Your question was:<br /><br />&quot;what effect does the handle arg have on the WindowProc&quot;.<br /><br />And my answer was:<br /><br />&quot;None, It's just the handle of your window passed along for your convenience.&quot;<br /><br />All the other stuff I told you was purely because I was nice, even if I was wrong on one point. I was just trying to help.<br /><br /><div class="quote"><br />Not at all, I set the UserData to the address of the descriptor structure.<br /></div><br /><br />You are right, I confused the lParam of the CreateWindowEx call with UserData. <br /><br /><div class="quote">In that structure, the 8 offset is the owner and the 44 offset is the handle.</div><br /><br />Call it what you want, I call it storing the same handle into three different places. How many main windows do you have running through that WndProc to be needing such a structure? One? ;)<br /><br /><div class="quote">None of this has anything to do with my question(s).</div><br /><br />Lets try that again. You ask clear to the point questions and we try to answer them. Well I won't but someone else might.<br /><br />Have a nice day.</div>
    <div class="meta">Posted on 2004-06-25 12:03:42 by JimmyClif</div>
   </div>
   <div class="post" id="post-144822">
    <div class="subject"><a href="#post-144822">Window handle</a></div>
    <div class="body">Hi Jimmy,<br /><br /><div class="quote"><br />All the other stuff I told you was purely because I was nice, even if I was wrong on one point. I was just trying to help.<br /></div><br /><br />I'm very sorry if you think I did'nt/don't appreciate your help and efforts. It is very appreciated. I'm not sure what I said to offend you, but if you look at my posts and reponses over the last couple years you will see that I always appreciate the help of others and often express thanks.<br /><br />You may have sensed my frustration with the subject matter.<br /><br />I will try to find a simpler example (if possible) to show the problem I am having. I was easier and more accurate to show the example I did because it is the one causing my problem (ie not hypothetical)<br /><br />For you and one other respondent (and probably others), it is clear that some of the compiler housekeeping is a distraction to the case in point.<br /><br />In any event thank you very much for your help now, in the past, and in the future.<br /><br />Perhaps I will be able to help you sometime.<br /><br />BTW I was looking at your sort problem last night, but it was getting late. I will check to see if someone helped you. If not I will.<br /><br />Mike</div>
    <div class="meta">Posted on 2004-06-25 15:45:37 by msmith</div>
   </div>
   <div class="post" id="post-144843">
    <div class="subject"><a href="#post-144843">Window handle</a></div>
    <div class="body">Hi Mike,<br /><br />I am afraid I am not familiar enough with FASM syntax to be specific.<br /><br />The stack variable hWnd (or whatever) in the WndProc is filled by Windows and is not affected by anything you do in your program. The actual value is written to the WNDCLASSEX structure maintained internally by Windows when you call CreateWindowEx. That handle is passed as the first parameter to the WndProc specified in the WNDCLASSEX structure and is completely independant of your code. Whether you save the handle or not does not effect it, in creating the Window that handle value is also created, you cannot change nor effect it in any way.<br /><br />You have said that your window is not appearing in some circumstances, what was the value in EAX when this happened ? What error code did GetLastError report ? This information is critical to diagnosing the problem.</div>
    <div class="meta">Posted on 2004-06-25 21:08:18 by donkey</div>
   </div>
   <div class="post" id="post-144845">
    <div class="subject"><a href="#post-144845">Window handle</a></div>
    <div class="body">Hi Donkey,<br /><br />Always good to hear from you.<br /><br />I'm too tired to work on it tonight, but I'll try to provide you the info by tomorrow night.<br /><br />I also have some tests I want to perform in the form of variations to the basic fasm example.<br /><br />Some of the compiler generated stuff seems to distract people from the actual question I'm am asking. I can appreciate that.<br /><br />Anyway, I'll be back tomorrow hopefully with answers and better examples.<br /><br />Thanks,<br /><br />Mike</div>
    <div class="meta">Posted on 2004-06-25 21:28:05 by msmith</div>
   </div>
   <div class="post" id="post-144945">
    <div class="subject"><a href="#post-144945">Window handle</a></div>
    <div class="body">Ah, finally I have duplicated the situation using only the fasm example shown earlier in the post.<br /><br />The example below differs from the original in only the following ways:<br /><br />1) It has the necessesary includes and library defs to allow coloring the window<br /><br />2) It has saved the handle explicitly from the CreateWindowEx<br /><br />3) It has used this handle in all references.<br /><br /><pre><code><br /><br />; Caption styles manipulation - Win32 example program<br /><br />format PE GUI 4.0<br />entry start<br /><br />include 'includekernel.inc'<br />include 'includeuser.inc'<br />include 'includegdi.inc'<br /><br />include 'includemacrostdcall.inc'<br />include 'includemacroimport.inc'<br /><br />section '.data' data readable writeable<br /><br />  hinstance dd 0<br />  OBMain rd 1 <br /><br />  msg MSG<br />  wc WNDCLASS<br /><br />  ws dd WS_VISIBLE+WS_CAPTION<br /><br />  _class db 'FCAPTION',0<br />  _button db 'BUTTON',0<br /><br />  _title db 'Caption styles',0<br />  _ws_sysmenu db 'WS_SYSMENU',0<br />  _ws_thickframe db 'WS_THICKFRAME',0<br />  _ws_minimizebox db 'WS_MINIMIZEBOX',0<br />  _ws_maximizebox db 'WS_MAXIMIZEBOX',0<br /><br />  virtual at 0<br />  minmaxinfo MINMAXINFO<br />  end virtual<br /><br />  ID_SYSMENU	 = 101<br />  ID_THICKFRAME  = 102<br />  ID_MINIMIZEBOX = 103<br />  ID_MAXIMIZEBOX = 104<br /><br />section '.code' code readable executable<br /><br />  start&#58;<br /><br />	invoke	GetModuleHandle,0<br />	mov	&#91;hinstance&#93;,eax<br />	invoke	LoadIcon,0,IDI_APPLICATION<br />	mov	&#91;wc.hIcon&#93;,eax<br />	invoke	LoadCursor,0,IDC_ARROW<br />	mov	&#91;wc.hCursor&#93;,eax<br />	mov	&#91;wc.style&#93;,0<br />	mov	&#91;wc.lpfnWndProc&#93;,WindowProc<br />	mov	&#91;wc.cbClsExtra&#93;,0<br />	mov	&#91;wc.cbWndExtra&#93;,0<br />	mov	eax,&#91;hinstance&#93;<br />	mov	&#91;wc.hInstance&#93;,eax<br />	mov	&#91;wc.hbrBackground&#93;,COLOR_BTNFACE+1<br />	mov	&#91;wc.lpszMenuName&#93;,0<br />	mov	&#91;wc.lpszClassName&#93;,_class<br />	invoke	RegisterClass,wc<br /><br />	invoke	CreateWindowEx,0,_class,_title,&#91;ws&#93;,100,100,256,128,NULL,NULL,&#91;hinstance&#93;,NULL<br />	mov &#91;OBMain&#93;,eax<br /><br />  msg_loop&#58;<br />	invoke	GetMessage,msg,NULL,0,0<br />	or	eax,eax<br />	jz	end_loop<br />	invoke	TranslateMessage,msg<br />	invoke	DispatchMessage,msg<br /><br />	jmp	msg_loop<br /><br />  end_loop&#58;<br />	invoke	ExitProcess,&#91;msg.wParam&#93;<br /><br />proc WindowProc, hwnd,wmsg,wparam,lparam<br />	enter<br />	push	ebx esi edi<br />	cmp	&#91;wmsg&#93;,WM_CREATE<br />	je	wmcreate<br />	cmp	&#91;wmsg&#93;,WM_DESTROY<br />	je	wmdestroy<br />	cmp	&#91;wmsg&#93;,WM_COMMAND<br />	je	wmcommand<br />	cmp	&#91;wmsg&#93;,WM_GETMINMAXINFO<br />	je	wmgetminmaxinfo<br />  defwndproc&#58;<br />	invoke	DefWindowProc,&#91;OBMain&#93;,&#91;wmsg&#93;,&#91;wparam&#93;,&#91;lparam&#93;<br />	jmp	finish<br />  wmcreate&#58;<br />	invoke	CreateWindowEx,0,_button,_ws_sysmenu,WS_VISIBLE+WS_CHILD+BS_AUTOCHECKBOX,16,16,256,16,&#91;OBMain&#93;,ID_SYSMENU,&#91;hinstance&#93;,NULL<br />	invoke	CreateWindowEx,0,_button,_ws_thickframe,WS_VISIBLE+WS_CHILD+BS_AUTOCHECKBOX,16,32,256,16,&#91;OBMain&#93;,ID_THICKFRAME,&#91;hinstance&#93;,NULL<br />	invoke	CreateWindowEx,0,_button,_ws_minimizebox,WS_VISIBLE+WS_CHILD+BS_AUTOCHECKBOX,16,48,256,16,&#91;OBMain&#93;,ID_MINIMIZEBOX,&#91;hinstance&#93;,NULL<br />	invoke	CreateWindowEx,0,_button,_ws_maximizebox,WS_VISIBLE+WS_CHILD+BS_AUTOCHECKBOX,16,64,256,16,&#91;OBMain&#93;,ID_MAXIMIZEBOX,&#91;hinstance&#93;,NULL<br />	xor	eax,eax<br />	jmp	finish<br />  wmcommand&#58;<br />	cmp	&#91;wparam&#93;,BN_CLICKED shl 16 + ID_SYSMENU<br />	je	switch_sysmenu<br />	cmp	&#91;wparam&#93;,BN_CLICKED shl 16 + ID_THICKFRAME<br />	je	switch_thickframe<br />	cmp	&#91;wparam&#93;,BN_CLICKED shl 16 + ID_MINIMIZEBOX<br />	je	switch_minimizebox<br />	cmp	&#91;wparam&#93;,BN_CLICKED shl 16 + ID_MAXIMIZEBOX<br />	je	switch_maximizebox<br />	jmp	defwndproc<br />      switch_sysmenu&#58;<br />invoke CreateSolidBrush,0080FFFFh<br />invoke SetClassLong,&#91;OBMain&#93;,GCL_HBRBACKGROUND,eax<br />invoke InvalidateRect,&#91;OBMain&#93;,NULL,TRUE<br />invoke UpdateWindow,&#91;OBMain&#93;<br />	mov	ebx,WS_SYSMENU<br />	jmp	set_flag<br /><br />      switch_thickframe&#58;<br />	mov	ebx,WS_THICKFRAME<br />	jmp	set_flag<br />      switch_minimizebox&#58;<br />	mov	ebx,WS_MINIMIZEBOX<br />	jmp	set_flag<br />      switch_maximizebox&#58;<br />	mov	ebx,WS_MAXIMIZEBOX<br />      set_flag&#58;<br />	invoke	SendMessage,&#91;lparam&#93;,BM_GETCHECK,0,0<br />	or	eax,eax<br />	jz	clear_flag<br />	or	&#91;ws&#93;,ebx<br />	jmp	update_style<br />      clear_flag&#58;<br />	not	ebx<br />	and	&#91;ws&#93;,ebx<br />      update_style&#58;<br />	invoke	SetWindowLong,&#91;OBMain&#93;,GWL_STYLE,&#91;ws&#93;<br />	invoke	RedrawWindow,&#91;OBMain&#93;,0,0,RDW_FRAME+RDW_INVALIDATE+RDW_UPDATENOW<br />	xor	eax,eax<br />	jmp	finish<br />  wmgetminmaxinfo&#58;<br />	mov	ebx,&#91;lparam&#93;<br />	mov	&#91;ebx+minmaxinfo.ptMinTrackSize.x&#93;,192<br />	mov	&#91;ebx+minmaxinfo.ptMinTrackSize.y&#93;,128<br />	xor	eax,eax<br />	jmp	finish<br />  wmdestroy&#58;<br />	invoke	PostQuitMessage,0<br />	xor	eax,eax<br />  finish&#58;<br />	pop	edi esi ebx<br />	return<br /><br />section '.idata' import data readable writeable<br /><br />  library kernel,'KERNEL32.DLL',<br />	  user,'USER32.DLL',<br />	  gdi,'GDI32.DLL'<br /><br />  kernel&#58;<br />  import GetModuleHandle,'GetModuleHandleA',<br />	 ExitProcess,'ExitProcess'<br /><br />  user&#58;<br />  import RegisterClass,'RegisterClassA',<br />	 CreateWindowEx,'CreateWindowExA',<br />	 DefWindowProc,'DefWindowProcA',<br />	 SetWindowLong,'SetWindowLongA',<br />	 SetClassLong,'SetClassLongA',<br />	 RedrawWindow,'RedrawWindow',<br />	 GetMessage,'GetMessageA',<br />	 TranslateMessage,'TranslateMessage',<br />	 DispatchMessage,'DispatchMessageA',<br />	 SendMessage,'SendMessageA',<br />	 InvalidateRect,'InvalidateRect',<br />	 UpdateWindow,'UpdateWindow',<br />	 LoadCursor,'LoadCursorA',<br />	 LoadIcon,'LoadIconA',<br />	 PostQuitMessage,'PostQuitMessage'<br /><br />  gdi&#58;<br />  import CreateFontIndirect,'CreateFontIndirectA',<br />    	 CreateSolidBrush,'CreateSolidBrush'<br /><br /></code></pre><br /><br />The way the program is given, it will compile without error, but when executed, will return showing no window.<br /><br />If I change the line:<br /><br /><pre><code><br />proc WindowProc, hwnd,wmsg,wparam,lparam<br /></code></pre><br /><br />to:<br /><br /><pre><code><br />proc WindowProc,OBMain,wmsg,wparam,lparam<br /></code></pre><br /><br />all is well.<br /><br />Since I have explicitly saved the handle after the CreateWindowEx and used this handle everywhere else in the program, AND Windows is simply offering me a convenience by giving me the handle in the WindowProc line the why does this program only work when the handle specified in this line is used?</div>
    <div class="meta">Posted on 2004-06-27 11:24:32 by msmith</div>
   </div>
   <div class="post" id="post-144950">
    <div class="subject"><a href="#post-144950">Window handle</a></div>
    <div class="body">Hi Mike,<br /><br />Well, I do not have FASM installed and as I said I am not familiar with the syntax but everything looks fine. I would attack the problem by leaving the hwnd in place and verfiying that a WM_CREATE is sent. At that point check the handle value of OBMain and hwnd. I beleive that CreateWindowExA returns *after* it sends the WM_CREATE message so since you are using OBMain in that handler it will be null when WM_CREATE is received. You can ofcourse always assign the value to OBMain in the WM_CREATE handler or use  in it's place. In practice I always use  in the WndProc and never a global handle...<br /><br /><span style="font-size:9px><pre><code>proc WindowProc, hwnd,wmsg,wparam,lparam<br />	enter<br />	push	ebx esi edi<br />	cmp	&#91;wmsg&#93;,WM_CREATE<br />	je	wmcreate<br />	cmp	&#91;wmsg&#93;,WM_DESTROY<br />	je	wmdestroy<br />	cmp	&#91;wmsg&#93;,WM_COMMAND<br />	je	wmcommand<br />	cmp	&#91;wmsg&#93;,WM_GETMINMAXINFO<br />	je	wmgetminmaxinfo<br />  defwndproc&#58;<br /> 	invoke	DefWindowProc,&#91;hwnd&#93;, &#91;wmsg&#93;, &#91;wparam&#93;, &#91;lparam&#93;<br />	jmp	finish<br />  wmcreate&#58;<br /> 	invoke CreateWindowEx, 0, _button, _ws_sysmenu, WS_VISIBLE+WS_CHILD+BS_AUTOCHECKBOX, 16, 16, 256, 16, &#91;hwnd&#93;, ID_SYSMENU, &#91;hinstance&#93;, NULL<br /> 	invoke CreateWindowEx, 0, _button, _ws_thickframe, WS_VISIBLE+WS_CHILD+BS_AUTOCHECKBOX, 16, 32, 256, 16, &#91;hwnd&#93;, ID_THICKFRAME, &#91;hinstance&#93;, NULL<br /> 	invoke CreateWindowEx, 0, _button,_ws_minimizebox, WS_VISIBLE+WS_CHILD+BS_AUTOCHECKBOX,16, 48, 256, 16, &#91;hwnd&#93;, ID_MINIMIZEBOX, &#91;hinstance&#93;, NULL<br /> 	invoke CreateWindowEx, 0, _button,_ws_maximizebox, WS_VISIBLE+WS_CHILD+BS_AUTOCHECKBOX,16, 64, 256, 16, &#91;hwnd&#93;, ID_MAXIMIZEBOX, &#91;hinstance&#93;, NULL<br />	xor	eax,eax<br />	jmp	finish<br />  wmcommand&#58;<br />	cmp	&#91;wparam&#93;,BN_CLICKED shl 16 + ID_SYSMENU<br />	je	switch_sysmenu<br />	cmp	&#91;wparam&#93;,BN_CLICKED shl 16 + ID_THICKFRAME<br />	je	switch_thickframe<br />	cmp	&#91;wparam&#93;,BN_CLICKED shl 16 + ID_MINIMIZEBOX<br />	je	switch_minimizebox<br />	cmp	&#91;wparam&#93;,BN_CLICKED shl 16 + ID_MAXIMIZEBOX<br />	je	switch_maximizebox<br />	jmp	defwndproc<br />      switch_sysmenu&#58;<br />invoke CreateSolidBrush,0080FFFFh<br />invoke SetClassLong,&#91;hwnd&#93;,GCL_HBRBACKGROUND,eax<br />invoke InvalidateRect,&#91;hwnd&#93;,NULL,TRUE<br />invoke UpdateWindow,&#91;hwnd&#93;<br />	mov	ebx,WS_SYSMENU<br />	jmp	set_flag<br /><br />      switch_thickframe&#58;<br />	mov	ebx,WS_THICKFRAME<br />	jmp	set_flag<br />      switch_minimizebox&#58;<br />	mov	ebx,WS_MINIMIZEBOX<br />	jmp	set_flag<br />      switch_maximizebox&#58;<br />	mov	ebx,WS_MAXIMIZEBOX<br />      set_flag&#58;<br />	invoke	SendMessage,&#91;lparam&#93;,BM_GETCHECK,0,0<br />	or	eax,eax<br />	jz	clear_flag<br />	or	&#91;ws&#93;,ebx<br />	jmp	update_style<br />      clear_flag&#58;<br />	not	ebx<br />	and	&#91;ws&#93;,ebx<br />      update_style&#58;<br />	invoke	SetWindowLong, &#91;hwnd&#93;, GWL_STYLE, &#91;ws&#93;<br /> 	invoke	RedrawWindow, &#91;hwnd&#93;, 0, 0, RDW_FRAME + RDW_INVALIDATE +RDW_UPDATENOW<br />	xor	eax,eax<br />	jmp	finish<br />  wmgetminmaxinfo&#58;<br />	mov	ebx,&#91;lparam&#93;<br />	mov	&#91;ebx+minmaxinfo.ptMinTrackSize.x&#93;,192<br />	mov	&#91;ebx+minmaxinfo.ptMinTrackSize.y&#93;,128<br />	xor	eax,eax<br />	jmp	finish<br />  wmdestroy&#58;<br />	invoke	PostQuitMessage,0<br />	xor	eax,eax<br />  finish&#58;<br />	pop	edi esi ebx<br />	return</code></pre></span></div>
    <div class="meta">Posted on 2004-06-27 13:36:54 by donkey</div>
   </div>
   <div class="post" id="post-144952">
    <div class="subject"><a href="#post-144952">Window handle</a></div>
    <div class="body">Hi Donkey,<br /><br />Thanks for your help.<br /><br />It looks like the problem is that, like you said, the CreateWindowEx returns AFTER a WM_CREATE is sent.<br /><br />In fact, the docs say:<br /><br /><div class="quote"><br />The WM_CREATE message is sent when an application requests that a window be created by calling the CreateWindowEx or CreateWindow function. (The message is sent before the function returns.) The window procedure of the new window receives this message after the window is created, but before the window becomes visible. <br /></div><br /><br />This renders the concept of saving the handle following the CreateWindowEx line to be completely meaningless.<br /><br />I'll do some more tests, but I think you are correct.<br /><br />BTW, In a compiler of the type that I am writing, there are a number of occasions where the global handle is needed.<br /><br />Knowing now what seems to be true about all of this, I think I can code around the situation.<br /><br />If I always have a separate WindowProc for each window, it seems that I should be able to use the hwnd stack var to set my structure's handle member and that that window should receive only one WM_CREATE msg. Does this sound right to you?<br /><br />Thanks,<br /><br />Mike</div>
    <div class="meta">Posted on 2004-06-27 14:18:05 by msmith</div>
   </div>
   <div class="post" id="post-144957">
    <div class="subject"><a href="#post-144957">Window handle</a></div>
    <div class="body">Hi Donkey,<br /><br />It just keeps getting stranger!<br /><br />I put the following code at the start of the WM_CREATE event.<br /><br /><pre><code><br />	mov eax,&#91;!hwnd&#93;<br />	mov &#91;!OBMain+44&#93;,eax<br /></code></pre><br /><br />(I am using !OBMain+44 as an arg to all of the places where I need the window's handle.)<br /><br />It does not work.<br /><br />I remove this code from the WM_CREATE code and put it at the start of the default window proc code and it works fine.<br /><br />The only way I can see this happening is that there is a WM_COMMAND event PRIOR to the WM_CREATE event because the only dispatch to this code is unprocessed command events.<br />This problem has been bothering me for about a year and a half and I have been working with work-a-rounds all this time.<br /><br />Jimmy noticed I was setting 3 vars to the same value in an earlier post. This was part of the work-a-round.<br /><br />I'll do some more testing, but I think I have it now.<br /><br />Whole code that now works:<br /><br /><pre><code><br /><br />; Caption styles manipulation - Win32 example program<br /><br />format PE GUI 4.0<br />entry start<br /><br />include 'includekernel.inc'<br />include 'includeuser.inc'<br />include 'includegdi.inc'<br /><br />include 'includemacrostdcall.inc'<br />include 'includemacroimport.inc'<br /><br />section '.data' data readable writeable<br /><br />  hinstance dd 0<br />  !OBMain rd 500<br /><br />  msg MSG<br />  wc WNDCLASS<br /><br />  ws dd WS_VISIBLE+WS_CAPTION<br /><br />  _class db 'FCAPTION',0<br />  _button db 'BUTTON',0<br /><br />  _title db 'Caption styles',0<br />  _ws_sysmenu db 'WS_SYSMENU',0<br />  _ws_thickframe db 'WS_THICKFRAME',0<br />  _ws_minimizebox db 'WS_MINIMIZEBOX',0<br />  _ws_maximizebox db 'WS_MAXIMIZEBOX',0<br /><br />  virtual at 0<br />  minmaxinfo MINMAXINFO<br />  end virtual<br /><br />  ID_SYSMENU	 = 101<br />  ID_THICKFRAME  = 102<br />  ID_MINIMIZEBOX = 103<br />  ID_MAXIMIZEBOX = 104<br /><br />section '.code' code readable executable<br /><br />  start&#58;<br /><br />	invoke	GetModuleHandle,0<br />	mov	&#91;hinstance&#93;,eax<br />	invoke	LoadIcon,0,IDI_APPLICATION<br />	mov	&#91;wc.hIcon&#93;,eax<br />	invoke	LoadCursor,0,IDC_ARROW<br />	mov	&#91;wc.hCursor&#93;,eax<br />	mov	&#91;wc.style&#93;,0<br />	mov	&#91;wc.lpfnWndProc&#93;,WindowProc<br />	mov	&#91;wc.cbClsExtra&#93;,0<br />	mov	&#91;wc.cbWndExtra&#93;,0<br />	mov	eax,&#91;hinstance&#93;<br />	mov	&#91;wc.hInstance&#93;,eax<br />	mov	&#91;wc.hbrBackground&#93;,COLOR_BTNFACE+1<br />	mov	&#91;wc.lpszMenuName&#93;,0<br />	mov	&#91;wc.lpszClassName&#93;,_class<br />	invoke	RegisterClass,wc<br /><br />	invoke	CreateWindowEx,0,_class,_title,&#91;ws&#93;,100,100,256,128,NULL,NULL,&#91;hinstance&#93;,NULL<br /><br />  msg_loop&#58;<br />	invoke	GetMessage,msg,NULL,0,0<br />	or	eax,eax<br />	jz	end_loop<br />	invoke	TranslateMessage,msg<br />	invoke	DispatchMessage,msg<br /><br />	jmp	msg_loop<br /><br />  end_loop&#58;<br />	invoke	ExitProcess,&#91;msg.wParam&#93;<br /><br />proc WindowProc, !hwnd,wmsg,wparam,lparam<br />	enter<br />	push	ebx esi edi<br />	cmp	&#91;wmsg&#93;,WM_CREATE<br />	je	wmcreate<br />	cmp	&#91;wmsg&#93;,WM_DESTROY<br />	je	wmdestroy<br />	cmp	&#91;wmsg&#93;,WM_COMMAND<br />	je	wmcommand<br />	cmp	&#91;wmsg&#93;,WM_GETMINMAXINFO<br />	je	wmgetminmaxinfo<br />  defwndproc&#58;<br />	mov eax,&#91;!hwnd&#93;<br />	mov &#91;!OBMain+44&#93;,eax<br />	invoke	DefWindowProc,&#91;!OBMain+44&#93;,&#91;wmsg&#93;,&#91;wparam&#93;,&#91;lparam&#93;<br />	jmp	finish<br />  wmcreate&#58;<br />	invoke	CreateWindowEx,0,_button,_ws_sysmenu,WS_VISIBLE+WS_CHILD+BS_AUTOCHECKBOX,16,16,256,16,&#91;!OBMain+44&#93;,ID_SYSMENU,&#91;hinstance&#93;,NULL<br />	invoke	CreateWindowEx,0,_button,_ws_thickframe,WS_VISIBLE+WS_CHILD+BS_AUTOCHECKBOX,16,32,256,16,&#91;!OBMain+44&#93;,ID_THICKFRAME,&#91;hinstance&#93;,NULL<br />	invoke	CreateWindowEx,0,_button,_ws_minimizebox,WS_VISIBLE+WS_CHILD+BS_AUTOCHECKBOX,16,48,256,16,&#91;!OBMain+44&#93;,ID_MINIMIZEBOX,&#91;hinstance&#93;,NULL<br />	invoke	CreateWindowEx,0,_button,_ws_maximizebox,WS_VISIBLE+WS_CHILD+BS_AUTOCHECKBOX,16,64,256,16,&#91;!OBMain+44&#93;,ID_MAXIMIZEBOX,&#91;hinstance&#93;,NULL<br />	xor	eax,eax<br />	jmp	finish<br />  wmcommand&#58;<br />	cmp	&#91;wparam&#93;,BN_CLICKED shl 16 + ID_SYSMENU<br />	je	switch_sysmenu<br />	cmp	&#91;wparam&#93;,BN_CLICKED shl 16 + ID_THICKFRAME<br />	je	switch_thickframe<br />	cmp	&#91;wparam&#93;,BN_CLICKED shl 16 + ID_MINIMIZEBOX<br />	je	switch_minimizebox<br />	cmp	&#91;wparam&#93;,BN_CLICKED shl 16 + ID_MAXIMIZEBOX<br />	je	switch_maximizebox<br />	jmp	defwndproc<br />      switch_sysmenu&#58;<br />invoke CreateSolidBrush,0080FFFFh<br />invoke SetClassLong,&#91;!OBMain+44&#93;,GCL_HBRBACKGROUND,eax<br />invoke InvalidateRect,&#91;!OBMain+44&#93;,NULL,TRUE<br />invoke UpdateWindow,&#91;!OBMain+44&#93;<br />	mov	ebx,WS_SYSMENU<br />	jmp	set_flag<br /><br />      switch_thickframe&#58;<br />	mov	ebx,WS_THICKFRAME<br />	jmp	set_flag<br />      switch_minimizebox&#58;<br />	mov	ebx,WS_MINIMIZEBOX<br />	jmp	set_flag<br />      switch_maximizebox&#58;<br />	mov	ebx,WS_MAXIMIZEBOX<br />      set_flag&#58;<br />	invoke	SendMessage,&#91;lparam&#93;,BM_GETCHECK,0,0<br />	or	eax,eax<br />	jz	clear_flag<br />	or	&#91;ws&#93;,ebx<br />	jmp	update_style<br />      clear_flag&#58;<br />	not	ebx<br />	and	&#91;ws&#93;,ebx<br />      update_style&#58;<br />	invoke	SetWindowLong,&#91;!OBMain+44&#93;,GWL_STYLE,&#91;ws&#93;<br />	invoke	RedrawWindow,&#91;!OBMain+44&#93;,0,0,RDW_FRAME+RDW_INVALIDATE+RDW_UPDATENOW<br />	xor	eax,eax<br />	jmp	finish<br />  wmgetminmaxinfo&#58;<br />	mov	ebx,&#91;lparam&#93;<br />	mov	&#91;ebx+minmaxinfo.ptMinTrackSize.x&#93;,192<br />	mov	&#91;ebx+minmaxinfo.ptMinTrackSize.y&#93;,128<br />	xor	eax,eax<br />	jmp	finish<br />  wmdestroy&#58;<br />	invoke	PostQuitMessage,0<br />	xor	eax,eax<br />  finish&#58;<br />	pop	edi esi ebx<br />	return<br /><br />section '.idata' import data readable writeable<br /><br />  library kernel,'KERNEL32.DLL',<br />	  user,'USER32.DLL',<br />	  gdi,'GDI32.DLL'<br /><br />  kernel&#58;<br />  import GetModuleHandle,'GetModuleHandleA',<br />	 ExitProcess,'ExitProcess'<br /><br />  user&#58;<br />  import RegisterClass,'RegisterClassA',<br />	 CreateWindowEx,'CreateWindowExA',<br />	 DefWindowProc,'DefWindowProcA',<br />	 SetWindowLong,'SetWindowLongA',<br />	 SetClassLong,'SetClassLongA',<br />	 RedrawWindow,'RedrawWindow',<br />	 GetMessage,'GetMessageA',<br />	 TranslateMessage,'TranslateMessage',<br />	 DispatchMessage,'DispatchMessageA',<br />	 SendMessage,'SendMessageA',<br />	 InvalidateRect,'InvalidateRect',<br />	 UpdateWindow,'UpdateWindow',<br />	 LoadCursor,'LoadCursorA',<br />	 LoadIcon,'LoadIconA',<br />	 PostQuitMessage,'PostQuitMessage'<br /><br />  gdi&#58;<br />  import CreateFontIndirect,'CreateFontIndirectA',<br />    	 CreateSolidBrush,'CreateSolidBrush'<br /></code></pre></div>
    <div class="meta">Posted on 2004-06-27 15:07:37 by msmith</div>
   </div>
   <div class="post" id="post-144958">
    <div class="subject"><a href="#post-144958">Window handle</a></div>
    <div class="body">WM_CREATE is not the first message sent to the window. From MSDN:<br /><br /><div class="quote">For overlapped, pop-up, and child windows, CreateWindow sends WM_CREATE, WM_GETMINMAXINFO, and WM_NCCREATE messages to the window</div><br /><br />Apparently, it sends WM_GETMINMAXINFO, then WM_NCCREATE and then WM_CREATE (I could be wrong though).<br />Obviously, you shouldn't rely on your global handle copy in your WndProc.<br />Outside of your WndProc, you can use the global handle copy. Since it is returned by the window creation function, this shouldn't be a problem.</div>
    <div class="meta">Posted on 2004-06-27 15:31:54 by death</div>
   </div>
   <div class="post" id="post-144961">
    <div class="subject"><a href="#post-144961">Window handle</a></div>
    <div class="body">Hi  death<br /><br />Actually it sends an NC_CALCSIZE not a WM_GETMINMAXINFO.<br /><br />Hi Mike,<br /><br />I will download and install FASM later tonight to test your code as I am not sure what's up with it. I am almost absolutely sure that you *must* use the  parameter of the WndProc in the DefWindowProc call otherwise it will lead to problems. I remember having a similar problem once and that was the solution.</div>
    <div class="meta">Posted on 2004-06-27 15:44:54 by donkey</div>
   </div>
   <div class="post" id="post-144977">
    <div class="subject"><a href="#post-144977">Window handle</a></div>
    <div class="body">Hi donkey,<br />I believe you mean WM_NCCALCSIZE. It might send this message as well, but the first message I got when I created a window was WM_GETMINMAXINFO, and MSDN clearly states that it is being sent.</div>
    <div class="meta">Posted on 2004-06-27 20:20:23 by death</div>
   </div>
   <div class="post" id="post-144981">
    <div class="subject"><a href="#post-144981">Window handle</a></div>
    <div class="body">Hi death,<br /><br />Yeah, WM_NCCALCSIZE, no, MSDN does not say that it is sent before CreateWindowEx returns, the quote you posted is not accurate. However, the WMGETMINMAXINFO is sent if you do not handle the WM_NCCALCSIZE message I believe. The actual page says...<br /><br /><div class="quote">The CreateWindowEx function sends WM_NCCREATE, WM_NCCALCSIZE, and WM_CREATE messages to the window being created.</div><br /><br /><a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/winui/winui/windowsuserinterface/windowing/windows/windowreference/windowfunctions/createwindowex.asp">CreateWindowEx</a></div>
    <div class="meta">Posted on 2004-06-27 20:39:20 by donkey</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=18685&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=18685&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="18685" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=18685&amp;page=2">&gt;</a><a href="../?id=18685&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>