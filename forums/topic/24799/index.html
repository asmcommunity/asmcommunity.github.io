<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Trying to understand more about the Stack. - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=24799" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=24799">Trying to understand more about the Stack.</a></p>
   <div class="post" id="post-181200">
    <div class="subject"><a href="#post-181200">Trying to understand more about the Stack.</a></div>
    <div class="body">Hey guys I&#39;ve been reading alot lately on how the stack works.<br />I understand the basics on how it grows and shrinks with push, and pop.<br /><br />Anyways I wrote this code and Im&#39; not sure why it will only print 44 bytes in my messagebox.<br /><br /><pre><code><br />;NASM Win32 monitor off<br />;<br />;compile with:<br />;NASM.EXE -fobj stack.asm<br />;link with:<br />;ALINK.EXE stack.obj -c -oPE<br /><br />%include &quot;e:\nasm\include\windows.inc&quot;<br /><br />EXTERN ExitProcess<br />IMPORT ExitProcess kernel32.dll<br />EXTERN MessageBoxA<br />IMPORT MessageBoxA user32.dll<br /><br />;segment .data USE32<br /><br />segment .code USE32 <br /><br />..start<br /><br />sub esp,64<br />lea edi, <br /><br /><br />mov , byte &quot;F&quot; ;1st byte<br />mov , byte &quot;D&quot;<br />mov , byte &quot;C&quot;<br />mov , byte &quot;B&quot;<br />mov , byte &quot;A&quot;<br />mov , byte &quot;9&quot;<br />mov , byte &quot;8&quot;<br />mov , byte &quot;7&quot;<br />mov , byte &quot;6&quot;<br />mov , byte &quot;5&quot;<br />mov , byte &quot;4&quot;<br />mov , byte &quot;3&quot;<br />mov , byte &quot;2&quot;<br />mov , byte &quot;1&quot;<br />mov , byte &quot;9&quot;<br />mov , byte &quot;8&quot;<br />mov , byte &quot;7&quot;<br />mov , byte &quot;6&quot;<br />mov , byte &quot;5&quot;<br />mov , byte &quot;4&quot;<br />mov , byte &quot;3&quot;<br />mov , byte &quot;2&quot;<br />mov , byte &quot;1&quot;<br />mov , byte &quot;F&quot; <br />mov , byte &quot;D&quot;<br />mov , byte &quot;C&quot;<br />mov , byte &quot;B&quot;<br />mov , byte &quot;A&quot;<br />mov , byte &quot;9&quot;<br />mov , byte &quot;8&quot;<br />mov , byte &quot;7&quot;<br />mov , byte &quot;6&quot;<br />mov , byte &quot;5&quot;<br />mov , byte &quot;4&quot;<br />mov , byte &quot;3&quot;<br />mov , byte &quot;2&quot;<br />mov , byte &quot;1&quot;<br />mov , byte &quot;0&quot;<br />mov , byte &quot;F&quot; <br />mov , byte &quot;D&quot;<br />mov , byte &quot;C&quot;<br />mov , byte &quot;B&quot;<br />mov , byte &quot;A&quot;<br />mov , byte &quot;9&quot;<br />mov , byte &quot;8&quot; ;STOPS HERE AT 44 BYTES WHY?<br />mov , byte &quot;7&quot;<br />mov , byte &quot;6&quot;<br />mov , byte &quot;5&quot;<br />mov , byte &quot;4&quot;<br />mov , byte &quot;3&quot;<br />mov , byte &quot;2&quot;<br />mov , byte &quot;1&quot;<br />mov , byte &quot;0&quot;<br />mov , byte &quot;F&quot;<br />mov , byte &quot;D&quot;<br />mov , byte &quot;C&quot;<br />mov , byte &quot;B&quot;<br />mov , byte &quot;A&quot;<br />mov , byte &quot;9&quot;<br />mov , byte &quot;8&quot;<br />mov , byte &quot;7&quot;<br />mov , byte &quot;6&quot;<br />mov , byte &quot;5&quot;<br />mov , byte &quot;4&quot;<br />;mov , byte &quot;3&quot;<br /> <br />sub edi,44&nbsp; &nbsp; &nbsp; &nbsp; ;if i increase this number it prints garbage.<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;44 is the max number without printing garbage.<br />push dword MB_OK<br />push dword 0<br />push edi&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;this holds the pointer to my string of bytes<br />push dword 0<br />call <br /><br />push dword 0<br />call <br /></code></pre> </div>
    <div class="meta">Posted on 2006-05-30 09:19:39 by gavin_</div>
   </div>
   <div class="post" id="post-181201">
    <div class="subject"><a href="#post-181201">Re: Trying to understand more about the Stack.</a></div>
    <div class="body">Several errors.<br /><br />1- With your <strong>sub esp,64</strong>, you reserve that part of the stack between the current &quot;ESP-0&quot; to &quot;ESP-64&quot;. No program other than yours would be able to modify that area of the stack memory. That is the area which you must use yourself (as opposed to ESP-64 to ESP-1xx).<br /><br />2- You use EBP as a pointer for filling memory but you have NOT set up the content of that register. (You only set up the content of EDI but you don&#39;t use that register until later on.)<br /><br />3- The memory address you later pass to the MessageBoxA function is outside the area you had &quot;reserved&quot; on the stack. The 1st parameter you push for that function will effectively subtract 4 from the current ESP (which would be ESP-68 if we consider your original ESP before reserving stack space), and will thus overwrite the dword (4 bytes) at that location. Your other parameters would also overwrite more dwords on the stack. Finally the return address for the call would overwrite more of the data you had filled in. Then the MessageBoxA function would most probably overwrite another portion with its own required data before using your supplied address to display your message. By that time, none of the data you had filled in may have remained intact.<br /><br />By going over once more what you have read on how the stack works, you will most probably understand it a bit more. Don&#39;t give up. Failure is not an option! ;)<br /><br />BTW the MessageBoxA function expects your message to have a terminating 0.<br /><br />Raymond<br /></div>
    <div class="meta">Posted on 2006-05-30 10:13:15 by Raymond</div>
   </div>
   <div class="post" id="post-181205">
    <div class="subject"><a href="#post-181205">Re: Trying to understand more about the Stack.</a></div>
    <div class="body">Hi Raymond.<br /><br />I&#39;ve made the changes and it works, but I&#39;m sure I&#39;m still not doing it the correct or easier way.<br /><br /><br />Any guidence would be great.<br />Thanks alot.<br /><br /><br /><br /><pre><code><br />segment .code USE32 <br /><br />..start<br /><br />sub esp,64<br />lea edi, <br /></code></pre><br />xor eax,eax<br /><br />;right to left /first in last out <br />mov ,&nbsp; eax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;the zero<br /><pre><code><br />mov , byte &quot;D&quot;<br />mov , byte &quot;C&quot;<br />mov , byte &quot;B&quot;<br />mov , byte &quot;A&quot;<br />;continued--- etc etc &gt;&gt;&gt;<br />mov , byte &quot;4&quot;<br />mov , byte &quot;3&quot;<br /></code></pre><br />sub edi,64&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;pointer for the first byte<br />sub esp, 20&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;make room for msgbox arguments<br /><pre><code><br />push dword MB_OK ;4 bytes<br />push dword 0&nbsp; &nbsp;  ;4 bytes<br />push edi&nbsp; &nbsp; &nbsp; &nbsp;  ;4 bytes&nbsp; &nbsp; <br />push dword 0&nbsp; &nbsp;  ;4 bytes<br />call  ;4 bytes for this aswell???<br /><br />push dword 0<br />call <br /><br /></code></pre></div>
    <div class="meta">Posted on 2006-05-30 12:30:47 by gavin_</div>
   </div>
   <div class="post" id="post-181210">
    <div class="subject"><a href="#post-181210">Re: Trying to understand more about the Stack.</a></div>
    <div class="body">A correct way is (masm syntax):<br /><pre><code><br />sub esp,64 ; reserve 64 bytes<br />	mov edx,esp<br />	mov byte ptr,&#39;A&#39;<br />	mov byte ptr,&#39;B&#39;<br />	mov byte ptr,&#39;C&#39;<br />	mov byte ptr,&#39;D&#39;<br />	mov byte ptr,&#39;E&#39;<br />	mov byte ptr,&#39;F&#39;<br />	mov byte ptr,&#39;G&#39;<br />	mov byte ptr,&#39;H&#39;<br />	mov byte ptr,&#39;I&#39;<br />	mov byte ptr,&#39;J&#39;<br />	mov byte ptr,&#39;A&#39;<br />	mov byte ptr,&#39;B&#39;<br />	mov byte ptr,&#39;C&#39;<br />	mov byte ptr,&#39;D&#39;<br />	mov byte ptr,&#39;E&#39;<br />	mov byte ptr,&#39;F&#39;<br />	mov byte ptr,&#39;G&#39;<br />	mov byte ptr,&#39;H&#39;<br />	mov byte ptr,&#39;I&#39;<br />	mov byte ptr,&#39;J&#39;<br />	mov byte ptr,&#39;A&#39;<br />	mov byte ptr,&#39;B&#39;<br />	mov byte ptr,&#39;C&#39;<br />	mov byte ptr,&#39;D&#39;<br />	mov byte ptr,&#39;E&#39;<br />	mov byte ptr,&#39;F&#39;<br />	mov byte ptr,&#39;G&#39;<br />	mov byte ptr,&#39;H&#39;<br />	mov byte ptr,&#39;I&#39;<br />	mov byte ptr,&#39;J&#39;<br />	mov byte ptr,&#39;A&#39;<br />	mov byte ptr,&#39;B&#39;<br />	mov byte ptr,&#39;C&#39;<br />	mov byte ptr,&#39;D&#39;<br />	mov byte ptr,&#39;E&#39;<br />	mov byte ptr,&#39;F&#39;<br />	mov byte ptr,&#39;G&#39;<br />	mov byte ptr,&#39;H&#39;<br />	mov byte ptr,&#39;I&#39;<br />	mov byte ptr,&#39;J&#39;<br />	mov byte ptr,&#39;A&#39;<br />	mov byte ptr,&#39;B&#39;<br />	mov byte ptr,&#39;C&#39;<br />	mov byte ptr,&#39;D&#39;<br />	mov byte ptr,&#39;E&#39;<br />	mov byte ptr,&#39;F&#39;<br />	mov byte ptr,&#39;G&#39;<br />	mov byte ptr,&#39;H&#39;<br />	mov byte ptr,&#39;I&#39;<br />	mov byte ptr,&#39;J&#39;	<br />	mov byte ptr,&#39;A&#39;<br />	mov byte ptr,&#39;B&#39;<br />	mov byte ptr,&#39;C&#39;<br />	mov byte ptr,&#39;D&#39;<br />	mov byte ptr,&#39;E&#39;<br />	mov byte ptr,&#39;F&#39;<br />	mov byte ptr,&#39;G&#39;<br />	mov byte ptr,&#39;H&#39;<br />	mov byte ptr,&#39;I&#39;<br />	mov byte ptr,&#39;J&#39;<br />	mov byte ptr,&#39;A&#39;<br />	mov byte ptr,&#39;B&#39;<br />	mov byte ptr,&#39;X&#39;<br />	mov byte ptr,0<br />	<br />	<br />	invoke MessageBox,0,edx,edx,0<br />	add esp,64 ; free the 64 bytes<br /></code></pre><br /><br />you can/should use EBP instead of EDX, though ^^&quot;.<br />Note that at address , is the last DWORD pushed onto stack, before executing this code. And this DWORD usually would be the return address for the &quot;ret&quot; instruction. <br /><br />Just a quick tute on push/pop:<br /><br />&quot;PUSH EAX&quot; works like these 2 lines:<br />sub esp,4<br />mov ,eax<br /><br /><br />&quot;POP EAX&quot; works like these 2 lines:<br />mov eax,<br />add esp,4</div>
    <div class="meta">Posted on 2006-05-30 16:04:10 by Ultrano</div>
   </div>
   <div class="post" id="post-181219">
    <div class="subject"><a href="#post-181219">Re: Trying to understand more about the Stack.</a></div>
    <div class="body">Ultrano<br /><br />Thanks for the help&nbsp; ,the push pop info is good ;)<br /><br />I have a question tho.<br /><br />First why should i release the stack i allocated?<br /><br />Oh and here is my code now I&#39;m still not sure if this is the best way to do it?<br /><br /><br /><pre><code><br />segment .code USE32 <br /><br />..start<br /><br />push ebp<br />mov ebp,esp<br />sub esp,8<br /><br />lea edi, <br /><br />mov ,&nbsp; byte 0 ;bottum of stack&nbsp; &nbsp; &nbsp; &nbsp; <br />mov ,&nbsp; byte 0<br />mov , byte &quot;a&quot;<br />mov , byte &quot;y&quot;<br />mov , byte &quot;i&quot;<br />mov , byte &quot;H&quot;<br />mov , byte &quot;)&quot;<br />mov , byte &quot;:&quot; ;top of stack<br /><br />push dword MB_OK ;4 bytes<br />push edi&nbsp; &nbsp; &nbsp; &nbsp;  ;4 bytes<br />push edi&nbsp; &nbsp; &nbsp; &nbsp;  ;4 bytes&nbsp; &nbsp; <br />push dword 0&nbsp; &nbsp;  ;4 bytes<br />call  ;4 bytes<br /><br />push dword 0<br />call <br /></code></pre><br /><br /></div>
    <div class="meta">Posted on 2006-05-30 23:17:10 by gavin_</div>
   </div>
   <div class="post" id="post-181221">
    <div class="subject"><a href="#post-181221">Re: Trying to understand more about the Stack.</a></div>
    <div class="body"><div class="quote"><br />First why should i release the stack i allocated?<br /></div><br /><br />Most problems from applications that seem to &quot;hog&quot; lots of memory stems from improper memory management. Releasing the stack after the call is complete ensures the stack space that was just used, is free once again to be used by some other call/procedure.<br /><br />Without this release, your ESP keeps incrementing and your stack grows huge... and eventually it stops growing as you run out of memory.</div>
    <div class="meta">Posted on 2006-05-30 23:37:09 by SpooK</div>
   </div>
   <div class="post" id="post-181246">
    <div class="subject"><a href="#post-181246">Re: Trying to understand more about the Stack.</a></div>
    <div class="body">A note on the stack&#39;s growing:<br />Windows initially reserves several 4k pages for your stack. <br />In a nutshell;<br />When your stack has grown beyond these pages (and you read/write there), you get an internal GPF. But Windows sees it&#39;s near the stack (at a bit lower address), allocates memory for those pages, and resumes your thread. <br /><em> <br /><br />And when the OS can&#39;t allocate more for the stack, your app crashes :)<br /><br />Now for some &quot;fun&quot;<br />But what happens if Win32 doesn&#39;t recognize you&#39;re accessing just a bit too far from the stack? The proximity-to-stack threshold is 8-12kB (2-3 pages). Your app gets killed with no warning of GPF ^^.&nbsp; Try this:<br /><pre><code><br />main proc<br />	local par1<br />	local big_one[4080]:DWORD<br />	local par2<br />	mov par1,1<br />	mov par2,2<br />	<br />	print &quot;hello stack&quot;<br />	<br />	<br />	ret<br />main endp<br /></code></pre><br />It&#39;ll never print &quot;hello stack&quot; :)<br /><br /><br /> The memory-hogging, mentioned by SpooK, could be a result of their code going through a long chain of procs, that hog lots of stack-space. (do a recursive proc that has many local variables, and you get the idea) . In HLL, generally you can&#39;t know of this detail. <br />I haven&#39;t studied if there&#39;s a mechanism in the OS for shrinking your stack, so I could be misinforming ^^&quot; . </div>
    <div class="meta">Posted on 2006-05-31 18:06:56 by Ultrano</div>
   </div>
   <div class="post" id="post-181304">
    <div class="subject"><a href="#post-181304">Re: Trying to understand more about the Stack.</a></div>
    <div class="body"><div class="quote"><br />First why should i release the stack i allocated?<br /></div><br /><br />This becomes important when you are writing subroutines. The subroutine instructions CALL and RET won&#39;t work together if the stack pointer is not correctly set.</div>
    <div class="meta">Posted on 2006-06-02 15:31:14 by tenkey</div>
   </div>
   <div class="post" id="post-181315">
    <div class="subject"><a href="#post-181315">Re: Trying to understand more about the Stack.</a></div>
    <div class="body">Guys your posts where very helpful I will definetly be writing software that doesn&#39;t hog the stack now. :)<br /><br />Thanks again. ;)</div>
    <div class="meta">Posted on 2006-06-02 19:13:32 by gavin_</div>
   </div>
  </div>
 </body>
</html>