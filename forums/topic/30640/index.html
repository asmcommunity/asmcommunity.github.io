<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Understanding PowerPC Assembler Function with bit rotate - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=30640" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=30640">Understanding PowerPC Assembler Function with bit rotate</a></p>
   <div class="post" id="post-214888">
    <div class="subject"><a href="#post-214888">Understanding PowerPC Assembler Function with bit rotate</a></div>
    <div class="body">Im trying to port a legacy app which has some basic bit shifting to decrypt a buffer, but im lost with this powerpc code - i tried my best to understand it and added comments and created a pseudo c function however something is obviously not right.<br /><br />This is the PPC function, it has one argument i think the buffer (params are: void *,int)<br /><br /><pre><code><br />.set var_30, -0x30<br />.set var_2C, -0x2C<br />.set var_20, -0x20<br />.set arg_8,&nbsp; 8<br />.set arg_1C,&nbsp; 0x1C<br />cryptLower%r29 = %r29<br />cryptUpper%r30 = %r30<br />data%r31 = %r31<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mflr&nbsp; &nbsp; &nbsp; r0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stmw&nbsp; &nbsp; &nbsp; r24, var_20(r1) # function arg data to r24<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mr&nbsp; &nbsp; &nbsp; &nbsp; r24, r3<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lwz&nbsp; &nbsp; &nbsp;  r3, crypt <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mr&nbsp; &nbsp; &nbsp; &nbsp; r31, r24&nbsp; &nbsp; &nbsp; # copy r24 data to r31<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; li&nbsp; &nbsp; &nbsp; &nbsp; r28, 0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; srwi&nbsp; &nbsp; &nbsp; r27, r4, 3&nbsp; &nbsp; # r27 = r4 &gt;&gt; 3<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stw&nbsp; &nbsp; &nbsp;  r0, arg_8(r1)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stwu&nbsp; &nbsp; &nbsp; r1, -0x70(r1)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stw&nbsp; &nbsp; &nbsp;  r4, 0x70+arg_1C(r1)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lwz&nbsp; &nbsp; &nbsp;  r29, 0(r3)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lwz&nbsp; &nbsp; &nbsp;  r30, 4(r3)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b&nbsp; &nbsp; &nbsp; &nbsp;  loc_22F1F4<br /># ---------------------------------------------------------------------------<br /> <br />loc_22F134:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  # <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lwz&nbsp; &nbsp; &nbsp;  r0, 0(r31)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addi&nbsp; &nbsp; &nbsp; r3, r1, 0x70+var_30<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lwz&nbsp; &nbsp; &nbsp;  r4, 4(r31)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stw&nbsp; &nbsp; &nbsp;  r4, 0x70+var_2C(r1)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stw&nbsp; &nbsp; &nbsp;  r0, 0x70+var_30(r1)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bl&nbsp; &nbsp; &nbsp; &nbsp; .SwapDouble__FPv # SwapDouble(void *)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lwz&nbsp; &nbsp; &nbsp;  r3, 0x70+var_2C(r1)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lis&nbsp; &nbsp; &nbsp;  r7, -0x6593 # 0x9A6C9A19<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lwz&nbsp; &nbsp; &nbsp;  r0, 0x70+var_30(r1)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lis&nbsp; &nbsp; &nbsp;  r5, -0x6593 # 0x9A6C9A19<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addc&nbsp; &nbsp; &nbsp; r10, r3, r30<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; li&nbsp; &nbsp; &nbsp; &nbsp; r3, 0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; adde&nbsp; &nbsp; &nbsp; r0, r0, r29<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addi&nbsp; &nbsp; &nbsp; r7, r7, -0x65E7 # 0x9A6C9A19<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rotrwi&nbsp; &nbsp; r11, r10, 14&nbsp; # r11 = (r10 &lt;&lt; 18) | (r10 &gt;&gt; 14)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mr&nbsp; &nbsp; &nbsp; &nbsp; r9, r10<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slwi&nbsp; &nbsp; &nbsp; r10, r9, 18&nbsp;  # r10 = r9 &lt;&lt; 18<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; li&nbsp; &nbsp; &nbsp; &nbsp; r8, -1<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; insrwi&nbsp; &nbsp; r11, r0, 14,0 # r11 = r0 &lt;&lt; 18<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; li&nbsp; &nbsp; &nbsp; &nbsp; r6, 0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; or&nbsp; &nbsp; &nbsp; &nbsp; r9, r11, r3<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inslwi&nbsp; &nbsp; r10, r0, 18,14 # r10 = r0 &gt;&gt; 14<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addc&nbsp; &nbsp; &nbsp; r7, r9, r7<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addi&nbsp; &nbsp; &nbsp; r5, r5, -0x65E7 # 0x9A6C9A19<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; adde&nbsp; &nbsp; &nbsp; r9, r10, r8<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; li&nbsp; &nbsp; &nbsp; &nbsp; r4, -1<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rotlwi&nbsp; &nbsp; r8, r7, 3&nbsp; &nbsp;  # r8 = (r7 &lt;&lt; 3) | (r7 &gt;&gt; 29)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mr&nbsp; &nbsp; &nbsp; &nbsp; r0, r7<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slwi&nbsp; &nbsp; &nbsp; r7, r0, 3&nbsp; &nbsp;  # r7 = r0 &lt;&lt; 3<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addi&nbsp; &nbsp; &nbsp; r3, r1, 0x70+var_30<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; insrwi&nbsp; &nbsp; r8, r9, 29,0&nbsp; # r8 = r9 &lt;&lt; 3<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; or&nbsp; &nbsp; &nbsp; &nbsp; r0, r8, r6<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inslwi&nbsp; &nbsp; r7, r9, 3,29&nbsp; # r7 = r9 &gt;&gt; 29<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addc&nbsp; &nbsp; &nbsp; r6, r30, r0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stw&nbsp; &nbsp; &nbsp;  r0, 0x70+var_2C(r1)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; adde&nbsp; &nbsp; &nbsp; r0, r29, r7<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addc&nbsp; &nbsp; &nbsp; r30, r6, r5<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stw&nbsp; &nbsp; &nbsp;  r7, 0x70+var_30(r1)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; adde&nbsp; &nbsp; &nbsp; r29, r0, r4<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bl&nbsp; &nbsp; &nbsp; &nbsp; .SwapDouble__FPv # SwapDouble(void *)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lwz&nbsp; &nbsp; &nbsp;  r0, 0x70+var_30(r1)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addi&nbsp; &nbsp; &nbsp; r3, r1, 0x70+var_30<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lwz&nbsp; &nbsp; &nbsp;  r4, 0x70+var_2C(r1)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stw&nbsp; &nbsp; &nbsp;  r4, 4(r31)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stw&nbsp; &nbsp; &nbsp;  r0, 0(r31)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bl&nbsp; &nbsp; &nbsp; &nbsp; .SwapDouble__FPv # SwapDouble(void *)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addi&nbsp; &nbsp; &nbsp; r31, r31, 8<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addi&nbsp; &nbsp; &nbsp; r28, r28, 1<br /> <br />loc_22F1F4:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmpw&nbsp; &nbsp; &nbsp; r28, r27<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; blt&nbsp; &nbsp; &nbsp;  loc_22F134<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; srwi&nbsp; &nbsp; &nbsp; r0, r27, 31&nbsp;  # r0 = r27 &gt;&gt; 31<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mr&nbsp; &nbsp; &nbsp; &nbsp; r31, r24<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add&nbsp; &nbsp; &nbsp;  r3, r0, r27<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; srwi&nbsp; &nbsp; &nbsp; r0, r27, 31&nbsp;  # r0 = r27 &gt;&gt; 31<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; srawi&nbsp; &nbsp;  r3, r3, 1<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lwz&nbsp; &nbsp; &nbsp;  r25, 0(r24)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slwi&nbsp; &nbsp; &nbsp; r3, r3, 3&nbsp; &nbsp;  # r3 = r3 &lt;&lt; 3<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add&nbsp; &nbsp; &nbsp;  r0, r0, r27<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add&nbsp; &nbsp; &nbsp;  r6, r31, r3<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lwz&nbsp; &nbsp; &nbsp;  r26, 4(r24)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lwz&nbsp; &nbsp; &nbsp;  r5, 0(r6)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; srawi&nbsp; &nbsp;  r0, r0, 1<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lwz&nbsp; &nbsp; &nbsp;  r6, 4(r6)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slwi&nbsp; &nbsp; &nbsp; r0, r0, 3&nbsp; &nbsp;  # r0 = r0 &lt;&lt; 3<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add&nbsp; &nbsp; &nbsp;  r4, r31, r0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; li&nbsp; &nbsp; &nbsp; &nbsp; r3, 1<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stw&nbsp; &nbsp; &nbsp;  r6, 4(r24)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stw&nbsp; &nbsp; &nbsp;  r5, 0(r24)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stw&nbsp; &nbsp; &nbsp;  r26, 4(r4)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stw&nbsp; &nbsp; &nbsp;  r25, 0(r4)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lwz&nbsp; &nbsp; &nbsp;  r0, 0x70+arg_8(r1)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addi&nbsp; &nbsp; &nbsp; r1, r1, 0x70<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mtlr&nbsp; &nbsp; &nbsp; r0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lmw&nbsp; &nbsp; &nbsp;  r24, var_20(r1)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; blr<br /></code></pre><br /><br />this is as far as my pseudo c has advanced:<br /><br /><pre><code><br />unsigned long long* data=(unsigned long long*)pBuffer; // file data<br />unsigned long long crypt = 0x0000;<br />unsigned long long next_crypt;<br />unsigned int len = size &gt;&gt; 3;<br /><br />for(unsigned int i=0; i&lt;len;i++) {<br />&nbsp; &nbsp; next_crypt = crypt+data<em>-0x9A6C9A19;&nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; data<em> = ((data<em>&lt;&lt;0x18)|(data<em>&gt;&gt;0x14))+0x9A6C9A19;<br />&nbsp; &nbsp; data<em> =&nbsp; (data<em>&lt;&lt;0x3)|(data<em>&gt;&gt;0x29);<br />&nbsp; &nbsp; data<em> = data<em> - crypt;<br />&nbsp; &nbsp; crypt = next_crypt;&nbsp; &nbsp;  <br />}<br /></code></pre><br /><br />I dont even know why is crypt split into two registers r29 &amp; r30<br /><br />Any assistance would be greatly appreciated.</div>
    <div class="meta">Posted on 2011-08-18 16:25:59 by Majin</div>
   </div>
  </div>
 </body>
</html>