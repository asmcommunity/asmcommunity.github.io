<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Using Icon file in explorer view + in window titles - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=25091" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=25091">Using Icon file in explorer view + in window titles</a></p>
   <div class="post" id="post-183743">
    <div class="subject"><a href="#post-183743">Using Icon file in explorer view + in window titles</a></div>
    <div class="body">I have my executable using an icon file. However, I am trying to get the executable to use the icon in the tray and in the window title bar. This isnt&#39; working. Here is my resource file ... If I can do it through code in my assembly file, or through the resource file, I don&#39;t care which way it is done, I guess that learning both would be nice? Ok, here is the resource file ...<br /><br /><pre><code><br />1 ICON MOVEABLE PURE DISCARDABLE &quot;html.ico&quot;<br />2 ICON MOVEABLE PURE DISCARDABLE &quot;html.ico&quot;<br /></code></pre><br /><br />The second icon would be the icon for the tray, window title etc ...<br /><br />Here is my assembly file:<br /><br /><pre><code><br /><br /><br />; httpd.asm<br /><br />.586 <br />.model flat, stdcall <br /><br />; Case sensitive<br />option casemap :none<br /><br />include kernel32.inc<br />include windows.inc<br />include user32.inc<br />include wsock32.inc<br />include ole32.inc<br />include shlwapi.inc<br />include wininet.inc<br />include advapi32.inc<br />include urlmon.inc<br />include shell32.inc<br />include gdi32.inc<br />include masm32.inc<br /><br /><br />includelib masm32.lib<br />includelib kernel32.lib<br />includelib user32.lib<br />includelib wsock32.lib<br />includelib ole32.lib<br />includelib shlwapi.lib<br />includelib wininet.lib<br />includelib advapi32.lib<br />includelib urlmon.lib<br />includelib shell32.lib<br />includelib gdi32.lib<br /><br />WM_SHELLNOTIFY	EQU 	WM_USER+5<br />IDI_TRAY		EQU 	0<br />IDM_RESTORE		EQU 	1000<br />IDM_EXIT		EQU 	1010<br /><br />WinMain PROTO :DWORD,:DWORD,:DWORD,:DWORD<br /><br /><br />.CONST<br /><br /><br />; Message box for server initialization<br />MsgBoxCaption	DB	&quot;HTTP Server&quot;,0 <br />MsgBoxText		DB	&quot;HTTP Server Successfully Started&quot;,0 <br /><br /><br />.DATA<br /><br /><br />; Window/Icon Labels<br />ClassName		DB &quot;TrayIconWinClass&quot;,0<br />AppName&nbsp; 		DB &quot;HTTPD Settings&quot;,0<br />RestoreString	DB &quot;&amp;Restore&quot;,0<br />SettingsString	DB &quot;Settings&quot;,0<br />ExitString	 	DB &quot;E&amp;xit Program&quot;,0<br /><br /><br />; Registry Autokey Information<br />run_subkey		DB	&quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Run&quot;,0<br />run_name		DB	&quot;Portable HTTP Server&quot;,0<br />run_path		DB	&quot;C:\httpd.exe&quot;,0<br /><br /><br />.DATA?<br /><br /><br />hTemp		DD ?<br />hInstance	DD ?<br />hPopupMenu	DD ?<br /><br />note NOTIFYICONDATA &lt;&gt;<br /><br /><br />.CODE<br /><br /><br />; Notify user that the server has been initialized<br />httpd_started PROC<br />	INVOKE MessageBox, NULL, ADDR MsgBoxText, ADDR MsgBoxCaption, MB_OK <br />	RET<br />httpd_started ENDP<br /><br /><br />; Add Registry Entries for Autorun<br />WriteAutoStart PROC<br />	INVOKE&nbsp; RegCreateKeyEx, HKEY_CURRENT_USER, ADDR run_subkey, 0, 0, 0, KEY_WRITE, 0, ADDR hTemp, 0<br />	CMP&nbsp; &nbsp;  EAX, ERROR_SUCCESS<br />	JNE&nbsp; &nbsp;  @F<br />	INVOKE&nbsp; RegSetValueEx, , ADDR run_name, 0, REG_SZ, ADDR run_path, SIZEOF run_path<br />	INVOKE&nbsp; RegCloseKey, <br />	@@:<br />	RET<br />WriteAutoStart ENDP<br /><br /><br />; Settings Window<br />WinMain proc hInst:HINSTANCE,hPrevInst:HINSTANCE,CmdLine:LPSTR,CmdShow:DWORD<br />	LOCAL wc:WNDCLASSEX<br />	LOCAL msg:MSG<br />	LOCAL hwnd:HWND<br />	MOV&nbsp;  wc.cbSize,SIZEOF WNDCLASSEX<br />	MOV&nbsp;  wc.style, CS_HREDRAW or CS_VREDRAW or CS_DBLCLKS<br />	MOV&nbsp;  wc.lpfnWndProc, OFFSET WndProc<br />	MOV&nbsp;  wc.cbClsExtra,NULL<br />	MOV&nbsp;  wc.cbWndExtra,NULL<br />	PUSH&nbsp; hInst<br />	POP&nbsp;  wc.hInstance<br />	MOV&nbsp;  wc.hbrBackground,COLOR_APPWORKSPACE<br />	MOV&nbsp;  wc.lpszMenuName,NULL<br />	MOV&nbsp;  wc.lpszClassName,OFFSET ClassName<br />	INVOKE LoadIcon,NULL,IDI_APPLICATION<br />	MOV&nbsp;  wc.hIcon,eax<br />	MOV&nbsp;  wc.hIconSm,eax<br />	INVOKE LoadCursor,NULL,IDC_ARROW<br />	MOV&nbsp;  wc.hCursor,eax<br />	INVOKE RegisterClassEx, addr wc<br />	INVOKE CreateWindowEx,<br />		WS_EX_CLIENTEDGE,<br />		ADDR ClassName,ADDR AppName,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  WS_OVERLAPPED+WS_CAPTION+WS_SYSMENU+WS_MINIMIZEBOX+WS_MAXIMIZEBOX+WS_VISIBLE,CW_USEDEFAULT,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  CW_USEDEFAULT,350,200,NULL,NULL,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  hInst,NULL<br />	MOV&nbsp;  hwnd,eax<br />	.while TRUE<br />		INVOKE GetMessage, ADDR msg,NULL,0,0<br />		.BREAK .IF (!eax)<br />		INVOKE TranslateMessage, ADDR msg<br />		INVOKE DispatchMessage, ADDR msg<br />	.endw<br />	MOV eax,msg.wParam<br />	RET<br />WinMain endp<br /><br />WndProc proc hWnd:HWND, uMsg:UINT, wParam:WPARAM, lParam:LPARAM<br />	; Set Icon File<br />	.if uMsg==WM_INITDIALOG<br />		INVOKE LoadIcon, hInstance, 2<br />		INVOKE SendMessage, hWin, WM_SETICON, ICON_BIG or ICON_SMALL, eax<br />	.endif<br />	LOCAL pt:POINT<br />	LOCAL rect:RECT<br />	.if uMsg==WM_CREATE<br />		INVOKE CreatePopupMenu<br />		MOV hPopupMenu,eax<br />		INVOKE AppendMenu,hPopupMenu,MF_STRING,IDM_RESTORE,addr RestoreString<br />		INVOKE AppendMenu,hPopupMenu,MF_STRING,IDM_EXIT,addr ExitString<br />	.elseif uMsg==WM_DESTROY<br />		INVOKE DestroyMenu,hPopupMenu<br />		INVOKE PostQuitMessage,NULL<br />	.elseif uMsg==WM_SIZE<br />		.if wParam==SIZE_MINIMIZED<br />			MOV note.cbSize,sizeof NOTIFYICONDATA<br />			PUSH hWnd<br />			POP note.hwnd<br />			MOV note.uID,IDI_TRAY<br />			MOV note.uFlags,NIF_ICON+NIF_MESSAGE+NIF_TIP<br />			MOV note.uCallbackMessage,WM_SHELLNOTIFY<br />			INVOKE LoadIcon,NULL,IDI_WINLOGO<br />			MOV note.hIcon,eax<br />			INVOKE lstrcpy,addr note.szTip,addr AppName<br />			INVOKE ShowWindow,hWnd,SW_HIDE<br />			INVOKE Shell_NotifyIcon,NIM_ADD,addr note<br />		.endif<br />	.elseif uMsg==WM_COMMAND<br />		.if lParam==0<br />			INVOKE Shell_NotifyIcon,NIM_DELETE,addr note<br />			MOV eax,wParam<br />			.if ax==IDM_RESTORE<br />				INVOKE ShowWindow,hWnd,SW_RESTORE<br />			.else<br />				INVOKE DestroyWindow,hWnd<br />			.endif<br />		.endif<br />	.elseif uMsg==WM_SHELLNOTIFY<br />		.if wParam==IDI_TRAY<br />			.if lParam==WM_RBUTTONDOWN<br />				INVOKE GetCursorPos,addr pt<br />				INVOKE SetForegroundWindow,hWnd<br />				INVOKE TrackPopupMenu,hPopupMenu,TPM_RIGHTALIGN or TPM_RIGHTBUTTON,pt.x,pt.y,NULL,hWnd,NULL<br />				INVOKE PostMessage,hWnd,WM_NULL,0,0<br />			.elseif lParam==WM_LBUTTONDBLCLK<br />				INVOKE SendMessage,hWnd,WM_COMMAND,IDM_RESTORE,0<br />			.endif<br />		.endif<br />	.else<br />		INVOKE DefWindowProc,hWnd,uMsg,wParam,lParam		<br />		RET<br />	.endif<br />	XOR eax,eax<br />	RET<br />WndProc endp<br /><br />execute:<br />	CALL WriteAutoStart<br />	CALL httpd_started<br />	INVOKE GetModuleHandle, NULL<br />	MOV&nbsp; &nbsp; hInstance, EAX<br />	INVOKE WinMain, hInstance, NULL, NULL, SW_SHOWDEFAULT<br />	INVOKE ExitProcess, EAX<br />END execute<br /><br /></code></pre><br /><br />Here are my errors:<br /><br /><div class="quote"><br /><br /> Assembling: httpd.asm<br />httpd.asm(144) : error A2006: undefined symbol : hWin<br />httpd.asm(144) : error A2114: INVOKE argument type mismatch : argument : 1<br />httpd.asm(146) : error A2012: PROC, MACRO, or macro repeat directive must preced<br />e LOCAL<br />httpd.asm(147) : error A2012: PROC, MACRO, or macro repeat directive must preced<br />e LOCAL<br />httpd.asm(183) : error A2006: undefined symbol : pt<br />httpd.asm(183) : error A2114: INVOKE argument type mismatch : argument : 1<br />httpd.asm(185) : error A2006: undefined symbol : pt<br />httpd.asm(185) : error A2114: INVOKE argument type mismatch : argument : 4<br />httpd.asm(185) : error A2114: INVOKE argument type mismatch : argument : 3<br />POLINK: fatal error: File not found: &#39;httpd.obj&#39;.<br /><br /></div><br /><br />Thanks in advance, I know that it is a lot of code, but I figured to include all of it just incase something that I have no clue about affects something else ...<br /><br />Regards,<br /><br />p0wder.</div>
    <div class="meta">Posted on 2006-07-19 15:48:28 by p0wder</div>
   </div>
   <div class="post" id="post-183744">
    <div class="subject"><a href="#post-183744">Re: Using Icon file in explorer view + in window titles</a></div>
    <div class="body">icons:<br /><br /><pre><code>invoke LoadIcon, hInstance, 1<br />mov wc.hIcon, eax<br />mov wc.hIconSm, eax</code></pre><br /><br />Also you don&#39;t need to include the same icon resource twice. <br /><br />As for the errors (which are pretty self explanatory btw): <br /><br />hWin should be hWnd and all occurrences of Local variables should precede any instructions in the procedure (make &quot;Local..&quot; to be the first thing in the procedure). <br /><br /></div>
    <div class="meta">Posted on 2006-07-19 16:23:42 by arafel</div>
   </div>
   <div class="post" id="post-183773">
    <div class="subject"><a href="#post-183773">Re: Using Icon file in explorer view + in window titles</a></div>
    <div class="body">That still does not cause the tray icon to load. Only the window title icon. </div>
    <div class="meta">Posted on 2006-07-20 07:48:13 by p0wder</div>
   </div>
   <div class="post" id="post-183774">
    <div class="subject"><a href="#post-183774">Re: Using Icon file in explorer view + in window titles</a></div>
    <div class="body">Did you minimize your app? The trayicon does not show unless you minimize the application.</div>
    <div class="meta">Posted on 2006-07-20 09:00:57 by JimmyClif</div>
   </div>
   <div class="post" id="post-183784">
    <div class="subject"><a href="#post-183784">Re: Using Icon file in explorer view + in window titles</a></div>
    <div class="body">No I forgot to minimize and ended up looking at the imaginary icon file in the tray :P///<br />Yea, I minimized and all that I see is the generic .exe icon sitting in the tray.</div>
    <div class="meta">Posted on 2006-07-20 17:24:41 by p0wder</div>
   </div>
   <div class="post" id="post-183787">
    <div class="subject"><a href="#post-183787">Re: Using Icon file in explorer view + in window titles</a></div>
    <div class="body">p0wder,<br /><br />Use something like this at WM_CREATE&nbsp; to make TrayIcon to appear.<br /><br /><pre><code><br />		mov		TrayIcon.cbSize, sizeof NOTIFYICONDATA<br />		push	hWnd<br />		pop		TrayIcon.hwnd<br />		mov		TrayIcon.uID, 0<br />		mov		TrayIcon.uFlags, NIF_ICON + NIF_TIP<br />		invoke	LoadIcon, hInstance, IDI_ICON1<br />		mov		TrayIcon.hIcon, eax<br />		invoke	lstrcpy, ADDR TrayIcon.szTip, CTEXT(&quot;InfoTip text here&quot;)<br />		invoke	Shell_NotifyIcon, NIM_ADD, ADDR TrayIcon<br /></code></pre><br /><br />And put this to WM_DESTROY<br /><br /><pre><code><br />		invoke	Shell_NotifyIcon, NIM_DELETE, ADDR TrayIcon<br /></code></pre></div>
    <div class="meta">Posted on 2006-07-20 17:37:46 by SamiP</div>
   </div>
   <div class="post" id="post-183826">
    <div class="subject"><a href="#post-183826">Re: Using Icon file in explorer view + in window titles</a></div>
    <div class="body">Works great, thanks!</div>
    <div class="meta">Posted on 2006-07-21 11:08:59 by p0wder</div>
   </div>
  </div>
 </body>
</html>