<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title> simple dll hook doesnt work - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=30044" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=30044"> simple dll hook doesnt work</a></p>
   <div class="post" id="post-212113">
    <div class="subject"><a href="#post-212113"> simple dll hook doesnt work</a></div>
    <div class="body">Hi,<br />I have a simple dll hook problem,will appreciate help.<br />Idea: appl inserts a menu item to Notepad &amp; choosing this item a DB appears.<br />WM_CLOSE and any other messages work but WM_COMMAND doesnt.<br />Thanx in advance.<br /><br /><pre><code><br />!!!.asm<br />--------<br />include !!!.inc<br /><br />_InsertMenuItem PROTO<br />_SetHook&nbsp; &nbsp; &nbsp; &nbsp; PROTO<br />_Unhook&nbsp; &nbsp; &nbsp; &nbsp;  PROTO<br /><br /><br />WinMain proto :DWORD,:DWORD,:DWORD,:DWORD<br /><br />.DATA&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br /><br />AppName db &quot;Our First Window&quot;,0 <br />szIconName	db	&quot;1.ico&quot;,0<br /><br />.DATA?&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />hInstance HINSTANCE ?&nbsp;  <br />CommandLine LPSTR ?<br /><br />.CODE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />start:<br />invoke GetModuleHandle, NULL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />mov hInstance,eax<br />invoke GetCommandLine&nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />mov CommandLine,eax<br />invoke WinMain, hInstance,NULL,CommandLine, SW_SHOWDEFAULT&nbsp; <br />invoke ExitProcess, eax <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br /><br />WinMain proc&nbsp; hInst:HINSTANCE,hPrevInst:HINSTANCE,CmdLine:LPSTR,CmdShow:DWORD<br />&nbsp; &nbsp; LOCAL wc:WNDCLASSEX&nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; LOCAL msg:MSG<br />&nbsp; &nbsp; LOCAL hwnd:HWND<br /><br /><br />&nbsp; &nbsp; mov&nbsp;  wc.cbSize,SIZEOF WNDCLASSEX&nbsp;  <br />&nbsp; &nbsp; mov&nbsp;  wc.style, CS_HREDRAW or CS_VREDRAW<br />&nbsp; &nbsp; mov&nbsp;  wc.lpfnWndProc, OFFSET WndProc<br />&nbsp; &nbsp; mov&nbsp;  wc.cbClsExtra,NULL<br /><br />&nbsp; &nbsp; mov&nbsp;  wc.cbWndExtra,NULL<br />&nbsp; &nbsp; push&nbsp; hInstance<br />&nbsp; &nbsp; pop&nbsp;  wc.hInstance<br />&nbsp; &nbsp; mov&nbsp;  wc.hbrBackground,COLOR_WINDOW+1<br /><br />&nbsp; &nbsp; mov&nbsp;  wc.lpszMenuName,OFFSET AppName&nbsp; <br />&nbsp; &nbsp; mov&nbsp;  wc.lpszClassName,OFFSET AppName<br />&nbsp; &nbsp; invoke LoadImage,hInstance,addr szIconName,IMAGE_ICON,0,0,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LR_LOADFROMFILE or LR_DEFAULTSIZE<br />&nbsp; &nbsp; mov&nbsp;  wc.hIcon,eax<br />&nbsp; &nbsp; mov&nbsp;  wc.hIconSm,eax<br />&nbsp; &nbsp; invoke LoadCursor,NULL,IDC_ARROW<br />&nbsp; &nbsp; mov&nbsp;  wc.hCursor,eax<br />&nbsp; &nbsp; invoke RegisterClassEx, addr wc&nbsp; <br />&nbsp; &nbsp; invoke CreateWindowEx,0,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ADDR AppName,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr AppName,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WS_OVERLAPPEDWINDOW,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CW_USEDEFAULT,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CW_USEDEFAULT,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CW_USEDEFAULT,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CW_USEDEFAULT,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NULL,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NULL,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hInst,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NULL<br />&nbsp; &nbsp; mov&nbsp;  hwnd,eax<br /><br />&nbsp; &nbsp; invoke ShowWindow, hwnd,CmdShow <br />&nbsp; &nbsp; invoke UpdateWindow, hwnd <br /><br />&nbsp; &nbsp; .WHILE TRUE&nbsp;  ; Enter message loop<br />&nbsp; &nbsp; &nbsp;  invoke GetMessage, ADDR msg,NULL,0,0<br />&nbsp; &nbsp; .BREAK .IF (!eax)<br />&nbsp; &nbsp; &nbsp;  invoke TranslateMessage, ADDR msg<br />&nbsp; &nbsp; &nbsp;  invoke DispatchMessage, ADDR msg<br />&nbsp; &nbsp; .ENDW<br />&nbsp; &nbsp;  mov&nbsp; &nbsp;  eax,msg.wParam <br />&nbsp; &nbsp;  ret<br /><br />WinMain endp<br /><br />WndProc proc hWnd:HWND, uMsg:UINT, wParam:WPARAM, lParam:LPARAM<br /><br />&nbsp; &nbsp; .IF uMsg==WM_CREATE&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; INVOKE	 _InsertMenuItem&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; INVOKE	 _SetHook&nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; .ELSEIF uMsg==WM_DESTROY <br />&nbsp; &nbsp; &nbsp; &nbsp; INVOKE	 _Unhook<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke PostQuitMessage,NULL <br />&nbsp; &nbsp; .ELSE<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke DefWindowProc,hWnd,uMsg,wParam,lParam <br />&nbsp; &nbsp; &nbsp; &nbsp; ret<br />&nbsp; &nbsp; .ENDIF<br />&nbsp; &nbsp; xor eax,eax<br /><br />&nbsp; &nbsp; ret<br />WndProc endp<br /><br />end start<br /><br />---------------------------<br />!MyDLL.asm<br />--------------<br /><br />;<br />;---------------------------------------------------------<br />include !!!.inc<br /><br />IDM_MINE&nbsp; &nbsp; EQU&nbsp; 1000h<br /><br /><br />.data <br /><br />NotepadWndClassName db&nbsp; &quot;NotePad&quot;,0<br />MyMenuElement&nbsp; &nbsp; &nbsp;  db&nbsp; &quot;MyMenuItem&quot;,0<br />lpCallWndProc&nbsp; &nbsp; &nbsp;  BYTE	&quot;CallWndProc&quot;,0<br /><br />hNotePadWnd HWND&nbsp; &nbsp; 0<br />hMenu HMENU&nbsp; &nbsp; &nbsp; &nbsp;  0<br />hPopupMenu HMENU&nbsp; &nbsp; 0<br /><br />hDll&nbsp; &nbsp; &nbsp; &nbsp; DWORD	&nbsp; &nbsp; &nbsp; 0<br />dThreadID&nbsp;  DWORD	&nbsp; &nbsp; &nbsp; 0<br />dCallWndProcAdr&nbsp; &nbsp;  DWORD	&nbsp; &nbsp; &nbsp; 0<br />hHook&nbsp; &nbsp; &nbsp;  DWORD	&nbsp; &nbsp; &nbsp; 0<br /><br /><br />.data? <br /><br />dSaveID&nbsp; &nbsp;  DWORD	?<br /><br />.code <br />start: <br />;---------------------------------------<br /><br />DllEntry proc hInstDLL:HINSTANCE, reason:DWORD, reserved1:DWORD <br /><br /> .if reason==DLL_PROCESS_ATTACH <br /><br />push hInstDLL<br />pop&nbsp; hDll<br /><br /> .endif&nbsp; &nbsp; &nbsp;  <br />&nbsp; <br />&nbsp; &nbsp; mov&nbsp; eax,TRUE <br />&nbsp; &nbsp; ret <br /><br />DllEntry ENDP<br /><br />;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br /><br />CallWndProc proc nCode:DWORD,wParam:DWORD,lParam:DWORD<br /><br />INVOKE	CallNextHookEx,hHook,nCode,wParam,lParam&nbsp; <br /><br /><br />assume ESI:PTR CWPSTRUCT<br />MOV	ESI,lParam<br /><br />MOV	edx,hNotePadWnd<br /><br />;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; start ;;;;;;;;;;;;;;;;;;<br /><br />.if .hwnd == edx&nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; .if .message == WM_COMMAND&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 	<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .if word ptr.wParam == IDM_MINE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MsgBox &quot;At last!&quot;,0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .endif<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; .elseif .message == WM_CLOSE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MsgBox &quot;WM_CLOSE&quot;,0&nbsp; &nbsp; &nbsp;  <br /><br />&nbsp; &nbsp; &nbsp; &nbsp; .endif<br /><br />.endif&nbsp;  <br /><br /> assume esi:nothing <br /> xor eax,eax&nbsp; &nbsp; <br /> <br />ret<br />CallWndProc endp<br />;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br /><br />_InsertMenuItem PROC <br /><br />invoke FindWindowEx,0,0,addr NotepadWndClassName,0&nbsp;  <br />mov hNotePadWnd,eax<br /><br />push hNotePadWnd<br />call GetMenu&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />mov hMenu,eax<br /><br />invoke GetSubMenu,hMenu,0&nbsp;  <br />mov hPopupMenu,eax<br /><br />invoke InsertMenu,hPopupMenu,0FFFFFFFFh,MF_BYPOSITION,IDM_MINE, OFFSET MyMenuElement&nbsp; &nbsp;  <br />invoke DrawMenuBar,hNotePadWnd&nbsp; &nbsp; &nbsp; &nbsp; <br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />RET<br />_InsertMenuItem ENDP<br /><br />;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br /><br />_SetHook PROC<br /><br />INVOKE	 GetProcAddress, hDll,ADDR	lpCallWndProc<br /> MOV	dCallWndProcAdr,EAX<br /><br />INVOKE	 GetWindowThreadProcessId,hNotePadWnd,0<br />MOV	dThreadID,EAX<br /><br />INVOKE	 SetWindowsHookEx,WH_CALLWNDPROC,dCallWndProcAdr,hDll,dThreadID<br />MOV	hHook,EAX&nbsp; &nbsp; &nbsp; <br /><br />&nbsp; <br />RET<br />_SetHook ENDP<br /><br />;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br /><br />_Unhook PROC <br /><br />INVOKE	 UnhookWindowsHookEx,hHook<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />RET<br />_Unhook&nbsp; ENDP<br /><br /><br />End DllEntry <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /></code></pre></div>
    <div class="meta">Posted on 2010-06-20 01:53:17 by ZapLeston</div>
   </div>
   <div class="post" id="post-212124">
    <div class="subject"><a href="#post-212124">Re:  simple dll hook doesnt work</a></div>
    <div class="body">I &quot;don&#039;t do Windows&quot;, so I dunno. I read in an article about debugging Linux:<br /><br /><div class="quote"><br />Why doesn&#039;t my program work?<br /></div><br /><br /><div class="quote"><br />Because something you believe to be true is not true.<br /></div><br /><br />Should work for Windows, too! I&#039;d start by checking the return values from your API calls, probably starting with SetWindowsHookEx and working backwards... Good luck with it!<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2010-06-21 09:39:51 by fbkotler</div>
   </div>
  </div>
 </body>
</html>