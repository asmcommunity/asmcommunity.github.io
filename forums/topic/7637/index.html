<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Hook question for advanced coders - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=7637" />
    <link rel="next" href="../?id=7637&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=7637">Hook question for advanced coders</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=7637&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=7637&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="7637" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=7637&amp;page=2">&gt;</a><a href="../?id=7637&amp;page=2">&raquo;</a></form>   <div class="post" id="post-55580">
    <div class="subject"><a href="#post-55580">Hook question for advanced coders</a></div>
    <div class="body">Why i can't hook API function FindFirstFileA in kernel32.dll. To test this prog use any filemanager, because hook doesn't work with explorer(why?)?.</div>
    <div class="meta">Posted on 2002-08-30 23:12:06 by vhasm</div>
   </div>
   <div class="post" id="post-55591">
    <div class="subject"><a href="#post-55591">Hook question for advanced coders</a></div>
    <div class="body">You can't change access right with VirtualProtect in system space.<br />It always returns NULL if you try to touch system.<br /><br />Go here:<br /><a target="_blank" href="http://mitglied.lycos.de/yoda2k/codesnippets.htm">http://mitglied.lycos.de/yoda2k/codesnippets.htm</a> <br /><br />and download DumpShield.zip (masm32)<br /><a target="_blank" href="http://mitglied.lycos.de/yoda2k/snippets/DumpShield.zip">http://mitglied.lycos.de/yoda2k/snippets/DumpShield.zip</a> <br /><br />It hooks ReadProcessMemory from ring0, but win9x only.<br />You can simply adapt it to your need.<br /><br />Then go:<br /><a target="_blank" href="http://www.anticracking.sk/EliCZ/export.htm">http://www.anticracking.sk/EliCZ/export.htm</a> <br /><br />And download ApiHooks:<br /><a target="_blank" href="http://www.anticracking.sk/EliCZ/export/AH56.ZIP">http://www.anticracking.sk/EliCZ/export/AH56.ZIP</a> <br /><br />You'll find there all you want and much more.</div>
    <div class="meta">Posted on 2002-08-31 04:36:19 by Four-F</div>
   </div>
   <div class="post" id="post-55623">
    <div class="subject"><a href="#post-55623">Hook question for advanced coders</a></div>
    <div class="body">But VirtualProtect returns TRUE (my OS-XP Home Edition), and filemanager shows an error=&gt;hook works, but with any error!!!<br />Check my example, plz.</div>
    <div class="meta">Posted on 2002-08-31 10:14:21 by vhasm</div>
   </div>
   <div class="post" id="post-55630">
    <div class="subject"><a href="#post-55630">Hook question for advanced coders</a></div>
    <div class="body">vhasm,<br /><br />i checked your code. the problem seens to be in VirtualProtect() - you cant de-protect a system dll memory.<br /><br />the stosb, at line 58 of svhv1.asm, should cause a protection error.<br /><br />as your code is for w2k, i dont know the solution. i coded, some years ago, a similar code for w98 - its in iczelion's or in my page, and its called hideproc.zip<br /><br />ancev</div>
    <div class="meta">Posted on 2002-08-31 11:58:29 by ancev</div>
   </div>
   <div class="post" id="post-55692">
    <div class="subject"><a href="#post-55692">Hook question for advanced coders</a></div>
    <div class="body"><div class="quote"><em>But VirtualProtect returns TRUE</em></div><br /><br />Are you <strong>100%</strong> shure?<br />I mean are you really sure that page you try to make writeable really gets writeable?<br />I guess it can't be true.<br />And your code inside dll should cause GPF, as ancev mentioned above.<br /><br />You'll find something interesting on topic at links below:<br /><br /><a target="_blank" href="http://www.asmcommunity.net/board/showthread.php?threadid=1470&amp;highlight=Intercept+a+windows">Intercept a windows API function</a> <br /><br /><a target="_blank" href="http://wasm.ru/article.php?article=1021007">??????? ????????? ??????? API ????????? Win32</a> <br /><br /><a target="_blank" href="http://www.internals.com/articles/apispy/apispy.htm">API Spying Techniques for Windows 9x, NT and 2000 </a> <br /><br /><a target="_blank" href="http://help.madshi.net/ApiHookingMethods.htm">API Hooking Methods</a> <br /><br />And i strongly suggest you take a look at ApiHooks by EliCZ (see link in my previous post above).<br />It offers universal hooking method. Works os-wide. Unfortunatelly it goes without source.<br />The source code (masm btw) was available till version 2.2b.<br />I hope you will be able to find it. If not, mail me, i'll send it to you.</div>
    <div class="meta">Posted on 2002-09-01 05:22:57 by Four-F</div>
   </div>
   <div class="post" id="post-55694">
    <div class="subject"><a href="#post-55694">Hook question for advanced coders</a></div>
    <div class="body">Hi, ancev!<br /><br /><div class="quote"><em>...a similar code for w98 - its in iczelion's or in my page...</em></div><br /><br />And where is your home page?</div>
    <div class="meta">Posted on 2002-09-01 05:43:31 by Four-F</div>
   </div>
   <div class="post" id="post-55771">
    <div class="subject"><a href="#post-55771">Hook question for advanced coders</a></div>
    <div class="body">vhasm, i've tested you code under XP.<br />Should say that I was mistaken. It works.<br /><br />And all that I spoke above correctly only for 9x clone.<br />Had no hooking experience on NT clone before ;-(<br /><br />Your problem i think is that you install not system-wide hook.<br />And your hook works only in your process.<br /><br />I hope you already has read all info about hooks<br />and could find something usefull for you.<br />If still have problems mail me.</div>
    <div class="meta">Posted on 2002-09-02 03:32:58 by Four-F</div>
   </div>
   <div class="post" id="post-55782">
    <div class="subject"><a href="#post-55782">Hook question for advanced coders</a></div>
    <div class="body">WRONG, Four-F. My hook is system-wide.<br />Your links helps me, thanks. But...i partially misunderstood...<br />See my second example, plz.</div>
    <div class="meta">Posted on 2002-09-02 06:13:20 by vhasm</div>
   </div>
   <div class="post" id="post-55783">
    <div class="subject"><a href="#post-55783">Hook question for advanced coders</a></div>
    <div class="body">P. S.<br />Apihook2 uses MessageBoxIndirectA in user32.dll and here is no an error! Why? 1 argument?</div>
    <div class="meta">Posted on 2002-09-02 06:18:14 by vhasm</div>
   </div>
   <div class="post" id="post-55807">
    <div class="subject"><a href="#post-55807">Hook question for advanced coders</a></div>
    <div class="body"><div class="quote"><br />P. S.<br />Apihook2 uses MessageBoxIndirectA in user32.dll and here is no an error! Why? 1 argument? </div><br /><br />I think it's because User32 is not considered as a &quot;system protected&quot; dll. To deprotect such system dll in NT your app would require the &quot;SeDebugPrivilege&quot;.</div>
    <div class="meta">Posted on 2002-09-02 11:37:00 by Axial</div>
   </div>
   <div class="post" id="post-55828">
    <div class="subject"><a href="#post-55828">Hook question for advanced coders</a></div>
    <div class="body">guys,<br /><br />in none of these cases you are changing the DLL systemwide... you are just changing the DLL in your process<br /><br />ancev</div>
    <div class="meta">Posted on 2002-09-02 15:40:14 by ancev</div>
   </div>
   <div class="post" id="post-55885">
    <div class="subject"><a href="#post-55885">Hook question for advanced coders</a></div>
    <div class="body">I had a closer view of your svhv1.dll.<br />But under w2k. Have currently no access to XP.<br />You were right again. Your api-hook is system-wide:<br />invoke SetWindowsHookEx, WH_GETMESSAGE, addr HP, hInstance, <strong>NULL </strong><br /><br />I changed hook to DeleteFileW and added some lines to have comfortable log in vkdebug window.<br />If you haven't any i added it to attachment with changed svhv1.asm. It' simple to use.<br /><br />i've added loging code in three places.<br />1. where hook is installed<br />2. where hook is uninstalled<br />3. where hook works<br /><br />I've ran mhook.exe and installed hook,<br />then switched to Explorer and cleared my C:\Documents and Settings\none\Recent folder.<br />Below is log from vkdebug.<br /><br />eax = API hook DeleteFileW installed in mhook.exe<br />eax = API hook DeleteFileW installed in Explorer.EXE<br />eax = API hook DeleteFileW installed in dbgwin.exe<br />eax = Deleting (169 1 1 1).wav.lnk by process Explorer.EXE<br />eax = Deleting 1.htm.lnk by process Explorer.EXE<br /> . . . . . . . . . . . . .  s k i p p e d . . . . . . . . . . <br />eax = Deleting ToDo.txt.lnk by process Explorer.EXE<br />eax = Deleting Win32.hlp (2).lnk by process Explorer.EXE<br />eax = API hook DeleteFileW uninstalled in dbgwin.exe<br />eax = API hook DeleteFileW uninstalled in Explorer.EXE<br />eax = API hook DeleteFileW uninstalled in mhook.exe<br /><br />As you can see it works. At least for me under w2k.<br /><br />And now i completely misunderstand what we are talking about ;) <br />Your first problem was <em>&quot;...hook doesn't work with explorer(why?)?.&quot;</em><br />As i can see it works.<br />Second. <em>&quot;VirtualProtect returns TRUE under NT.&quot;</em><br />OK. It's true.<br />Third. <em>&quot;WRONG, Four-F. My hook is system-wide.&quot;</em><br />OK. It's system-wide.<br />And now <em>&quot;Apihook2 uses MessageBoxIndirectA in user32.dll and here is no an error! Why? 1 argument?&quot;</em><br />Here i misunderstand a bit what you mean.<br />1. Your hook works with functions from user32.dll, but doesn't work with kernel32.dll?<br />2. You get error trying to hook kernel32.dll, and no error hooking user32.dll?<br />3. You can hook functions only with one param?<br />So, explain your current problem.<br /><br />And last. As i said, i tested it only under w2k.<br />If you have troubles only under XP or can't test under w2k, let me know.<br />I'll test it under XP tomorrow.</div>
    <div class="meta">Posted on 2002-09-03 05:07:09 by Four-F</div>
   </div>
   <div class="post" id="post-55891">
    <div class="subject"><a href="#post-55891">Hook question for advanced coders</a></div>
    <div class="body">Forgot to add some notes.<br />Your hooking method is not safe.<br /><br />To install/uninstall hook you need two assembler instructions<br />and your thread can be interrupted at any time in between -&gt; crash.<br />When your hook works it has temporary to restore original function to have possibility to call it.<br />At this point your thread also can be interrupted and you miss some hooked function calls.<br /><br />AFAIK, at the moment the best system-wide hooking method under NT, at least for Native API in NTDLL,  is to trap int 2E.<br />From ring0 of course. Offered by Russinovich &amp; Cogswell.<br /><a target="_blank" href="http://www.sysinternals.com/">http://www.sysinternals.com/</a> <br />&quot;Windows NT System Call Hooking,&quot;  by Mark Russinovich and Bryce Cogswell, Dr.  Dobb's Journal, January 1997 <br /><br />This method was improved by Sven Schreiber.<br /><a target="_blank" href="http://www.orgon.com/w2k_internals/index.html">http://www.orgon.com/w2k_internals/index.html</a> <br />You can find there complete source code.<br /><a target="_blank" href="http://www.orgon.com/w2k_internals/cd.html">http://www.orgon.com/w2k_internals/cd.html</a></div>
    <div class="meta">Posted on 2002-09-03 06:49:45 by Four-F</div>
   </div>
   <div class="post" id="post-56003">
    <div class="subject"><a href="#post-56003">Hook question for advanced coders</a></div>
    <div class="body">Four-F,<br />i have seen your APIHOOK_2+.zip. It works on my XP. But...<br />Try to hook FindFirstFileA. There are 2 problems:<br />1) Why explorer shows directory's contents-it doesn't use FindFileFirstA? Which function uses here?<br />2) Use standart MASM32v7's example to call FindFirstFileA - it doesn't work!!! I think because more than 1 argument.</div>
    <div class="meta">Posted on 2002-09-04 06:19:19 by vhasm</div>
   </div>
   <div class="post" id="post-56021">
    <div class="subject"><a href="#post-56021">Hook question for advanced coders</a></div>
    <div class="body">OK. Now i understand. Your problem is that you don't know that NT uses <strong>UNICODE</strong> everywhere!<br />So, system itself doesn't call Xxxxxxxxxx<strong>A</strong> functions.<br />Sorry, i didn't see it with half an eye. My mistake.<br /><br />Explorer uses FindFirstFileW/FindFirstFileExW, FindNextFileW to show directory contents.<br /><br />I'll try to hook it, but only tomorrow. Have no time now.<br />Also i have some more to say. See you tomorrow.</div>
    <div class="meta">Posted on 2002-09-04 08:14:09 by Four-F</div>
   </div>
   <div class="post" id="post-56041">
    <div class="subject"><a href="#post-56041">Hook question for advanced coders</a></div>
    <div class="body"><div class="quote"><em>1) Why explorer shows directory's contents-it doesn't use FindFileFirstA? Which function uses here?</em></div><br />Misunderstood a bit. explorer is a process, listview.exe is another process.<br />When listview.exe fills directory list there is no relationship with explorer.<br />Explorer itself doesn't call Xxxxxxxxxx<strong>A</strong> functions, so if you try hook FindFirstFileA in explorer itself it will not work.<br />If you want to hook FindFirstFileA form process that calls it, and you know it for shure, it should work.<br /><br /><div class="quote"><em>2) Use standart MASM32v7's example to call FindFirstFileA - it doesn't work!!! I think because more than 1 argument.</em></div><br />i've took a look at listview.zip and <strong>it works</strong> with your very first apihook.<br />I can see MesageBox when i choose GetDirectory from menu of LISTVIEW.EXE.<br />It appears two times.<br /><br />Anyway i'll take closer look at all this stuff tomorrow.</div>
    <div class="meta">Posted on 2002-09-04 09:11:24 by Four-F</div>
   </div>
   <div class="post" id="post-56137">
    <div class="subject"><a href="#post-56137">Hook question for advanced coders</a></div>
    <div class="body">Hey, vhasm! We could avoid all that flame if you has not mixed parameters passed to FindFirstFileA! :grin: <br /><br /><pre><code>H_FFFA proc &#91;B&#93;&#91;color=red&#93;P0&#91;/color&#93;&#91;/B&#93;&#58;DWORD,&#91;B&#93;&#91;color=red&#93;P1&#91;/color&#93;&#91;/B&#93;&#58;DWORD<br />. . .<br />    push &#91;B&#93;&#91;color=red&#93;P0&#91;/color&#93;&#91;/B&#93;		; should be P1<br />    push &#91;B&#93;&#91;color=red&#93;P1&#91;/color&#93;&#91;/B&#93;		; should be P0<br />    call FUNCTIONADDR_FINDFIRSTFILEA<br />. . .<br />H_FFFA endp</code></pre></div>
    <div class="meta">Posted on 2002-09-05 00:36:16 by Four-F</div>
   </div>
   <div class="post" id="post-56378">
    <div class="subject"><a href="#post-56378">Hook question for advanced coders</a></div>
    <div class="body">YESSS!!!! Four-F, THANKS!!!!!!!!!!!!! This is STUPID error!!!!!!!!</div>
    <div class="meta">Posted on 2002-09-06 10:21:45 by vhasm</div>
   </div>
   <div class="post" id="post-123763">
    <div class="subject"><a href="#post-123763">Hook question for advanced coders</a></div>
    <div class="body">wow, old thread<br /><br /><br />bringing back some questions:<br /><br />wouldn't this method only work on processes that uses messages? like wndprocs, etc., since the hook is a WH_GETMESSAGE hook?<br /><br />Best Regards,<br /><br />Drocon</div>
    <div class="meta">Posted on 2003-11-07 22:37:18 by Drocon</div>
   </div>
   <div class="post" id="post-123795">
    <div class="subject"><a href="#post-123795">Hook question for advanced coders</a></div>
    <div class="body">Hi, Drocon.<br />I haven't been following this thread, but it appears to be about API hooks, not message hooks. It is an entirely different matter. (Unless of course I got it all wrong, or they're using message hooks as a way to inject a dll into the target's memory space. In that case you would be 100% right since it's impossible to install a message hook on a thread that has no message queue).</div>
    <div class="meta">Posted on 2003-11-08 08:14:16 by QvasiModo</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=7637&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=7637&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="7637" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=7637&amp;page=2">&gt;</a><a href="../?id=7637&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>