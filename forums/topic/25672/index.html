<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>First 16-bit kernel. - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=25672" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=25672">First 16-bit kernel.</a></p>
   <div class="post" id="post-187326">
    <div class="subject"><a href="#post-187326">First 16-bit kernel.</a></div>
    <div class="body">Okay so this should be funny for some of you but its my first shot at writing a kernel so...<br /><br />This is the boot loader which works fine doing these:<br /><br />1) nasm -f bin Boot.asm -o Boot.o<br />2) partcopy 0 200 -f0<br /><br /><pre><span style="font-size:2><br /><br />&nbsp; XOR&nbsp; &nbsp;  AX , AX<br />&nbsp; MOV&nbsp; &nbsp;  DS , AX<br /><br />&nbsp; MOV&nbsp; &nbsp;  SI , Message<br />&nbsp; CALL&nbsp; &nbsp; BIOS_PRINT<br />&nbsp; <br />&nbsp; MOV&nbsp; &nbsp;  AX , 02000h<br />&nbsp; MOV&nbsp; &nbsp;  ES , AX<br />&nbsp; XOR&nbsp; &nbsp;  BX , BX<br />&nbsp; MOV&nbsp; &nbsp;  AH , 02h<br />&nbsp; MOV&nbsp; &nbsp;  AL , 01h<br />&nbsp; MOV&nbsp; &nbsp;  CH , 00h<br />&nbsp; MOV&nbsp; &nbsp;  CL , 02h<br />&nbsp; XOR&nbsp; &nbsp;  DX , DX<br />ReadAgain:<br />&nbsp; INT&nbsp; &nbsp;  13h<br />&nbsp; JC&nbsp; &nbsp; &nbsp; ReadAgain<br />&nbsp; <br />&nbsp; MOV&nbsp; &nbsp;  AX , 02000h<br />&nbsp; MOV&nbsp; &nbsp;  DS , AX<br />&nbsp; JMP&nbsp; &nbsp;  02000:0000h<br /><br />hang:<br />&nbsp;  JMP $<br /><br />Message DB &#39;Boot Loader 0.1&#39;, 0Dh, 0Ah,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &#39;Loading the kernel...&#39;, 0Dh, 0Ah, 0<br /><br />BIOS_PRINT:<br />&nbsp; LODSB<br />&nbsp; OR&nbsp; &nbsp; &nbsp; AL , AL<br />&nbsp; JZ&nbsp; &nbsp; &nbsp; DONE<br />&nbsp; MOV&nbsp; &nbsp;  AH , 0EH<br />&nbsp; INT&nbsp; &nbsp;  10H<br />&nbsp; JMP&nbsp; &nbsp;  BIOS_PRINT<br />DONE:<br />&nbsp; RET<br /><br />&nbsp; TIMES 510-($-$$) DB 0<br />&nbsp; DB 0x55<br />&nbsp; DB 0xAA</span></pre><br /><br />And this is the kernel which I compile and then copy to the floppy disk in this way:<br /><br />1) nasm -f bin Kernel.asm -o Kernel.o<br />2) partcopy Kernel.o 0 200 -f0 200<br /><br /><pre><span style="font-size:2><br /><br />&nbsp; MOV&nbsp; &nbsp;  SI , Message<br />&nbsp; CALL&nbsp; &nbsp; BIOS_PRINT<br />&nbsp; <br /><br />hang:<br />&nbsp;  JMP $<br /><br />Message DB &#39;Kernel: Loaded.&#39;, 0Dh, 0Ah, 0<br /><br />BIOS_PRINT:<br />&nbsp; LODSB<br />&nbsp; OR&nbsp; &nbsp; &nbsp; AL , AL<br />&nbsp; JZ&nbsp; &nbsp; &nbsp; DONE<br />&nbsp; MOV&nbsp; &nbsp;  AH , 0EH<br />&nbsp; INT&nbsp; &nbsp;  10H<br />&nbsp; JMP&nbsp; &nbsp;  BIOS_PRINT<br />DONE:<br />&nbsp; RET<br /><br />&nbsp; TIMES 512-($-$$) DB 0</span></pre><br /><br />The problem is that the boot loader works fine but when it is supposed to load the kernel from the disk nothing happens except that the floppy disk indicator light stays lit. Can anybody tell me what I am doing wrong, please?</div>
    <div class="meta">Posted on 2007-01-04 02:40:28 by XCHG</div>
   </div>
   <div class="post" id="post-187343">
    <div class="subject"><a href="#post-187343">Re: First 16-bit kernel.</a></div>
    <div class="body">At first glance, I don&#39;t see any problems with your code, except the &quot;read again&quot; label, which should be placed <strong>before</strong> the place where you initialize the parameters for int13h. Here&#39;s how I load stuff in my bootloader code:<br /><br /><pre><code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; 0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _ALIGN 4, 090h, main ; align to 4 with 90s (NOP), relative to &#39;main&#39; label.<br />nxtldtry:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov&nbsp; &nbsp; &nbsp;ax, cs<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;cx, 2<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;bx, ORIG+200h<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;es, ax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor&nbsp; &nbsp; &nbsp;dx, dx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;ax, 0207h<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int&nbsp; &nbsp; &nbsp;13h<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop&nbsp; &nbsp; &nbsp;ax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jnc&nbsp; &nbsp; &nbsp;_boot2&nbsp; ; load ok. contunue execution at &#39;_boot2&#39;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp&nbsp; &nbsp; &nbsp;ax, 7&nbsp; &nbsp;; max number of load retries<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jae&nbsp; &nbsp; &nbsp;load_error<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inc&nbsp; &nbsp; &nbsp;ax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; ax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp&nbsp; &nbsp; &nbsp;ax, 4&nbsp; &nbsp;; load retry after which the drive should be reset<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jnz&nbsp; &nbsp; &nbsp;nxtldtry<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor&nbsp; &nbsp; &nbsp;ax, ax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor&nbsp; &nbsp; &nbsp;dx, dx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int&nbsp; &nbsp; &nbsp;13h<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jmp&nbsp; &nbsp; &nbsp;nxtldtry</code></pre><br />This code tries to load 7 sectors (2-8) to location &quot;cs:ORIG+200h&quot;. It performs 7 retries. After 4th try, it performs a &#39;drive reset&#39;.<br /><br />ORIG is set to 07c00h, and cs is 0, so it tries to load at 07e00h.<br /><br />PS: I hope that this &#39;16-bit kernel&#39; is just a temporary code to test your bootloader and that you plan to write 32/64-bit kernel ^^</div>
    <div class="meta">Posted on 2007-01-04 06:57:38 by ti_mo_n</div>
   </div>
   <div class="post" id="post-187379">
    <div class="subject"><a href="#post-187379">Re: First 16-bit kernel.</a></div>
    <div class="body">Ok the problem was with the code segment I reckon. I changed the kernel&#39;s source and it worked okay:<br /><br /><pre><span style="font-size:2><br />ORIGIN EQU 07C00h + 200h<br /><br />&nbsp; MOV&nbsp; &nbsp;  AX , ORIGIN<br />&nbsp; MOV&nbsp; &nbsp;  DS , AX<br />&nbsp; MOV&nbsp; &nbsp;  AX , Message<br />&nbsp; CALL&nbsp; &nbsp; PrintMessage<br /><br />HANG:<br />&nbsp;  JMP $<br /><br />Message DB &#39;Kernel: Loaded.&#39;, 0Dh, 0Ah, 0<br /><br />PrintMessage:<br />&nbsp; MOV&nbsp; &nbsp;  BX , AX<br />&nbsp; MOV&nbsp; &nbsp;  AH , 0Eh<br />&nbsp; @@__PrintMessageL:<br />&nbsp; &nbsp; MOV&nbsp; &nbsp;  AL , <br />&nbsp; &nbsp; TEST&nbsp; &nbsp; AL , AL<br />&nbsp; &nbsp; JE&nbsp; &nbsp; &nbsp; @@__PrintMessageEP<br />&nbsp; &nbsp; DW&nbsp; &nbsp; &nbsp; 10CDh<br />&nbsp; &nbsp; INC&nbsp; &nbsp;  BX<br />&nbsp; &nbsp; JMP&nbsp; &nbsp;  @@__PrintMessageL<br />&nbsp; @@__PrintMessageEP:<br />&nbsp; &nbsp; RET<br />&nbsp; TIMES 512-($-$$) DB 0</span></pre><br /><br />About the 16-bit kernel, oh god yeah it is just a test. I promise I will make it 32-bit but I just did change it to 32-bit today and nothing worked lol. Have to learn a lot of new things about protected mode I guess. Thank you so much for the information. I appreciate it.</div>
    <div class="meta">Posted on 2007-01-05 10:33:04 by XCHG</div>
   </div>
  </div>
 </body>
</html>