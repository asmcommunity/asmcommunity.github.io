<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Saving bitmaps - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=14686" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=14686">Saving bitmaps</a></p>
   <div class="post" id="post-113833">
    <div class="subject"><a href="#post-113833">Saving bitmaps</a></div>
    <div class="body">This routine will save a bitmap in a DC to a file. Pass the name of the destination file and a handle to the device context. It will create a 24 bit DIB section and copy the image into it then save the image. It can be adapted to pass a bitmap handle directly.<br /><br /><pre><code><br />.data<br />	; For some reason these *must* be globally defined<br />	lpBITMAPFILEHEADER	BITMAPFILEHEADER	&lt;0&gt;<br />	lpBITMAPINFOHEADER	BITMAPINFOHEADER	&lt;0&gt;<br /><br />.code<br />WriteBitmapToFile proc pszFile&#58;DWORD,hTransDC&#58;DWORD<br />	LOCAL	hTempDC		&#58;DWORD<br />	LOCAL	hMemBmp		&#58;DWORD<br />	LOCAL	hFile		&#58;DWORD<br />	LOCAL	cbWrite		&#58;DWORD<br />	LOCAL	hTempBmp	&#58;DWORD<br />	LOCAL	ppvBits 	&#58;DWORD<br />	LOCAL	bmp		&#58;BITMAP<br />	LOCAL	DataSize	&#58;DWORD<br />	LOCAL	bmi		&#58;BITMAPINFO<br /><br />	invoke GetCurrentObject,hTransDC,OBJ_BITMAP<br />	mov hTempBmp,eax<br />	invoke GetObject,hTempBmp,SIZEOF BITMAP,ADDR bmp<br /><br />	invoke CreateCompatibleDC,NULL<br />	mov hTempDC,eax<br /><br />	mov bmi.bmiHeader.biSize,SIZEOF bmi.bmiHeader<br />	mov eax,bmp.bmWidth<br />	mov bmi.bmiHeader.biWidth,eax<br />	mov eax,bmp.bmHeight<br />	mov bmi.bmiHeader.biHeight,eax<br />	mov bmi.bmiHeader.biPlanes,1<br />	mov bmi.bmiHeader.biBitCount,24<br />	mov bmi.bmiHeader.biCompression,BI_RGB<br />	invoke CreateDIBSection,hTempDC,ADDR bmi,DIB_RGB_COLORS,ADDR ppvBits ,0,0<br />	mov hMemBmp,eax<br />	invoke SelectObject,hTempDC,hMemBmp<br />	invoke GetObject,hMemBmp,SIZEOF BITMAP,ADDR bmp<br />	invoke BitBlt,hTempDC,0,0,bmp.bmWidth,bmp.bmHeight,hTransDC,0,0,SRCCOPY<br /><br />	invoke RtlZeroMemory,ADDR lpBITMAPFILEHEADER,SIZEOF BITMAPFILEHEADER<br />	invoke RtlZeroMemory,ADDR lpBITMAPINFOHEADER,SIZEOF BITMAPINFOHEADER<br />	mov lpBITMAPFILEHEADER.bfType,&quot;MB&quot;<br /><br />	mov eax,bmp.bmWidthBytes<br />	imul bmp.bmHeight<br />	mov DataSize,eax<br /><br />	add eax,54<br />	mov lpBITMAPFILEHEADER.bfSize,eax<br />	mov lpBITMAPFILEHEADER.bfReserved1,0<br />	mov lpBITMAPFILEHEADER.bfReserved2,0<br />	mov lpBITMAPFILEHEADER.bfOffBits,54<br />	mov lpBITMAPINFOHEADER.biSize,40<br />	mov eax,bmp.bmWidth<br />	mov lpBITMAPINFOHEADER.biWidth,eax<br />	mov eax,bmp.bmHeight<br />	mov lpBITMAPINFOHEADER.biHeight,eax<br />	mov lpBITMAPINFOHEADER.biPlanes,1<br />	mov lpBITMAPINFOHEADER.biBitCount,24<br />	mov lpBITMAPINFOHEADER.biCompression,0 ;BI_RGB<br />	mov lpBITMAPINFOHEADER.biClrImportant,0<br />	mov lpBITMAPINFOHEADER.biXPelsPerMeter,0<br />	mov lpBITMAPINFOHEADER.biYPelsPerMeter,0<br />	mov lpBITMAPINFOHEADER.biClrUsed,0<br />	mov eax,DataSize<br />	mov lpBITMAPINFOHEADER.biSizeImage,eax<br /><br />	invoke CreateFile, pszFile, GENERIC_WRITE, FILE_SHARE_WRITE,<br />			NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_ARCHIVE, NULL<br />	mov hFile,eax<br /><br />	invoke WriteFile,hFile,OFFSET lpBITMAPFILEHEADER,<br />		SIZEOF BITMAPINFOHEADER + SIZEOF BITMAPFILEHEADER,<br />		ADDR cbWrite,NULL<br /><br />	invoke WriteFile,hFile,ppvBits,DataSize,ADDR cbWrite,NULL<br /><br />	invoke CloseHandle,hFile<br />	invoke DeleteDC,hTempDC<br />	invoke DeleteObject,hMemBmp<br /><br />	ret<br />WriteBitmapToFile endp</code></pre></div>
    <div class="meta">Posted on 2003-08-13 10:24:47 by donkey</div>
   </div>
   <div class="post" id="post-114621">
    <div class="subject"><a href="#post-114621">Saving bitmaps</a></div>
    <div class="body">Well, the first attempt above had some fundamental flaws. It did not translate the colors properly in some cases. This version will save as 4,8 or 24 bit.<br /><br />There is no longer a need to have the BITMAPFILEHEADER or BITMAPINFOHEADER structures at all.<br /><br />Syntax:<br /><br />invoke WriteIMLtoFile, hIml, cClrBits, hFile<br /><br />hIml = Handle to the image list<br />cClrBits = Number of bits of color depth (4,8,24)<br />hFile = the handle to an open file used to save the imagelist<br /><br /><pre><code>WriteIMLtoFile Proc hIml&#58;DWORD,cClrBits&#58;DWORD,hFile&#58;DWORD<br />	LOCAL cbWrite				&#58;DWORD<br />	LOCAL bmp				&#58;BITMAP<br />	LOCAL dwNumColors			&#58;DWORD<br />	LOCAL hDC				&#58;DWORD<br />	LOCAL hDC_DIB				&#58;DWORD<br />	LOCAL nImages				&#58;DWORD<br />	LOCAL ImageWidth			&#58;DWORD<br />	LOCAL pBMI				&#58;DWORD<br />	LOCAL RGBQuadSize			&#58;DWORD<br />	LOCAL DataSize				&#58;DWORD<br />	LOCAL OldObject				&#58;DWORD<br />	LOCAL pBFH				&#58;DWORD<br />	LOCAL hBmp				&#58;DWORD<br />	LOCAL pData				&#58;DWORD<br />	LOCAL pRGBQuad				&#58;DWORD<br />	LOCAL imgX				&#58;DWORD<br />	LOCAL imgY				&#58;DWORD<br /><br />	invoke ImageList_GetIconSize,hIml,ADDR imgX,ADDR imgY<br /><br />	invoke ImageList_GetImageCount,hIml<br />	mov nImages,eax<br />	imul imgX<br />	mov ImageWidth,eax<br /><br />	.IF nImages &lt; 1<br />		invoke MessageBox,hDlg,OFFSET NoImages,OFFSET GenTitle,MB_OK<br />		ret<br />	.endif<br /><br />	; Calculate Data size<br />	mov eax,ImageWidth<br />	imul imgX<br />	imul cClrBits<br />	shr eax,3<br />	mov DataSize,eax<br /><br />	; Calculate size of RGBQUAD array<br />	mov ecx,cClrBits<br />	mov eax,1<br />	shl eax,cl<br />	mov dwNumColors,eax<br />	mov edx,SIZEOF RGBQUAD<br />	imul edx<br />	mov RGBQuadSize,eax<br /><br />	; Create a memory buffer<br />	.IF cClrBits == 24 ; There is no RGBQUAD array for 24 bit<br />		mov RGBQuadSize,0<br />		mov eax,0<br />	.ENDIF<br />	add eax,SIZEOF BITMAPINFOHEADER<br />	add eax,SIZEOF BITMAPFILEHEADER<br />	add eax,DataSize<br />	invoke GlobalAlloc,GMEM_FIXED,eax<br /><br />	mov pBFH,eax<br />	add eax,SIZEOF BITMAPFILEHEADER<br />	mov pBMI,eax<br />	add eax,SIZEOF BITMAPINFOHEADER<br />	mov pRGBQuad,eax<br />	add eax,RGBQuadSize<br />	mov pData,eax<br /><br />	invoke GetDC,hDlg<br />	mov hDC,eax<br />	invoke CreateCompatibleDC,hDC<br />	mov hDC_DIB,eax<br />	invoke CreateCompatibleBitmap,hDC,ImageWidth,imgY<br />	mov hBmp,eax<br />	invoke ReleaseDC,hDlg,hDC<br /><br />	invoke SelectObject,hDC_DIB,hBmp<br />	mov OldObject,eax<br /><br />	mov edi,0<br />	mov esi,0<br />	.REPEAT<br />		invoke ImageList_Draw, hIml, edi, hDC_DIB, esi, 0, ILD_NORMAL<br />		inc edi<br />		add esi,imgX<br />	.UNTIL edi == nImages<br /><br />	invoke SelectObject,hDC_DIB,OldObject<br /><br />	invoke GdiFlush<br /><br />	invoke GetObject,hBmp,SIZEOF BITMAP,ADDR bmp<br /><br />	mov edi,pBMI<br />	mov &#91;edi&#93;.BITMAPINFO.bmiHeader.biXPelsPerMeter,0<br />	mov &#91;edi&#93;.BITMAPINFO.bmiHeader.biYPelsPerMeter,0<br />	mov eax,dwNumColors<br />	mov &#91;edi&#93;.BITMAPINFO.bmiHeader.biClrUsed,eax<br />	mov &#91;edi&#93;.BITMAPINFO.bmiHeader.biClrImportant,0<br /><br />	mov &#91;edi&#93;.BITMAPINFO.bmiHeader.biSize,SIZEOF BITMAPINFOHEADER<br />	mov eax,bmp.bmWidth<br />	mov &#91;edi&#93;.BITMAPINFO.bmiHeader.biWidth,eax<br />	mov eax,bmp.bmHeight<br />	mov &#91;edi&#93;.BITMAPINFO.bmiHeader.biHeight,eax<br />	mov &#91;edi&#93;.BITMAPINFO.bmiHeader.biPlanes,1<br />	mov &#91;edi&#93;.BITMAPINFO.bmiHeader.biCompression,BI_RGB<br />	mov eax,cClrBits<br />	mov &#91;edi&#93;.BITMAPINFO.bmiHeader.biBitCount,ax<br />	mov eax,DataSize<br />	mov &#91;edi&#93;.BITMAPINFO.bmiHeader.biSizeImage,eax<br /><br />	invoke GetDIBits, hDC_DIB, hBmp, 0, imgY, pData, pBMI, DIB_RGB_COLORS<br /><br />	mov esi,pBFH<br />	mov &#91;esi&#93;.BITMAPFILEHEADER.bfType,&quot;MB&quot;<br />	mov eax,RGBQuadSize<br />	add eax,DataSize<br />	add eax,SIZEOF BITMAPINFOHEADER + SIZEOF BITMAPFILEHEADER<br />	mov &#91;esi&#93;.BITMAPFILEHEADER.bfSize,eax<br />	mov &#91;esi&#93;.BITMAPFILEHEADER.bfReserved1,0<br />	mov &#91;esi&#93;.BITMAPFILEHEADER.bfReserved2,0<br />	mov eax,RGBQuadSize<br />	add eax,sizeof BITMAPFILEHEADER<br />	add eax,sizeof BITMAPINFOHEADER	<br />	mov &#91;esi&#93;.BITMAPFILEHEADER.bfOffBits,eax<br /><br />	invoke GlobalSize,pBFH<br />	mov ecx,eax<br />	invoke WriteFile,hFile,pBFH,ecx,ADDR cbWrite,NULL<br /><br />	invoke DeleteDC,hDC_DIB<br />	invoke GlobalFree,pBFH<br />	invoke DeleteObject,hBmp<br /><br />	invoke SetForegroundWindow,hDlg<br /><br />	ret<br />WriteIMLtoFile endp</code></pre></div>
    <div class="meta">Posted on 2003-08-20 15:51:32 by donkey</div>
   </div>
  </div>
 </body>
</html>