<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Thread problem - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=20963" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=20963">Thread problem</a></p>
   <div class="post" id="post-159017">
    <div class="subject"><a href="#post-159017">Thread problem</a></div>
    <div class="body">I&#39;m running into an access violation that leads to a pretty clean crash of my program. Now i&#39;m passing all the info properly to create thread except i&#39;m leaving everything null/0 and then i specify the offset of the function that will become threaded and the offset to a dword for the threadid. I then close the handle that&#39;s returned. The problem shows up right when I use SendMessage in the threads function. So i threw it into ollydbg and before it crashes i get a access violation. What I&#39;m wondering is if there&#39;s some security attributes or something else that I need to specify for my thread to beable to use sendmessage and not die.</div>
    <div class="meta">Posted on 2005-04-14 16:38:32 by lst</div>
   </div>
   <div class="post" id="post-159019">
    <div class="subject"><a href="#post-159019">Re: Thread problem</a></div>
    <div class="body">What are you using SendMessage for?&nbsp; SendMessage needs a handle, how is your thread getting this handle?&nbsp; Are you passing it as a parameter?</div>
    <div class="meta">Posted on 2005-04-14 17:27:43 by gorshing</div>
   </div>
   <div class="post" id="post-159020">
    <div class="subject"><a href="#post-159020">Re: Thread problem</a></div>
    <div class="body">First i tried storing the handle in a global dword, then i tried passing it as the parameter. Both methods failed for me.</div>
    <div class="meta">Posted on 2005-04-14 17:48:19 by lst</div>
   </div>
   <div class="post" id="post-159022">
    <div class="subject"><a href="#post-159022">Re: Thread problem</a></div>
    <div class="body">This is an example that works. I did it using a template (fast mode). Copy, paste, and build all. It will work. Check it with your code.<br /><br /><pre><code><br />.486&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; create 32 bit code<br />.model flat, stdcall&nbsp; &nbsp; &nbsp; ; 32 bit memory model<br />option casemap :none&nbsp; &nbsp; &nbsp; ; case sensitive<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; include \masm32\include\windows.inc<br />&nbsp; &nbsp; include \masm32\include\user32.inc<br />&nbsp; &nbsp; include \masm32\include\kernel32.inc<br />&nbsp; &nbsp; include \masm32\include\debug.inc<br />&nbsp; &nbsp; include \masm32\include\comdlg32.inc<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; includelib \masm32\lib\user32.lib<br />&nbsp; &nbsp; includelib \masm32\lib\kernel32.lib<br />&nbsp; &nbsp; includelib \masm32\lib\debug.lib<br />&nbsp; &nbsp; includelib \masm32\lib\comdlg32.lib<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; include \masm32\macros\macros.asm<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; FUNC MACRO parameters:VARARG<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke parameters<br />&nbsp; &nbsp; &nbsp; &nbsp; EXITM &lt;eax&gt;<br />&nbsp; &nbsp; ENDM<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; include \masm32\include\dialogs.inc<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; dlgproc&nbsp; &nbsp; &nbsp;  PROTO :DWORD,:DWORD,:DWORD,:DWORD<br />&nbsp; &nbsp; ThreadProc&nbsp; &nbsp; PROTO :DWORD<br />&nbsp; &nbsp; <br />.const<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; ; message sended by thread (to window) when it is starting<br />&nbsp; &nbsp; WM_THREAD_START equ WM_USER + 0100h<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; ; message sended by thread (to window) when it is ending<br />&nbsp; &nbsp; WM_THREAD_STOP&nbsp; equ WM_USER + 0101h<br />&nbsp; &nbsp; &nbsp; &nbsp; <br />.data?<br />&nbsp; &nbsp; hInstance&nbsp;  dd ?<br />&nbsp; &nbsp; hThread&nbsp; &nbsp;  dd ?<br />&nbsp; &nbsp; <br />.code<br />&nbsp; &nbsp; <br />start:<br />&nbsp; &nbsp; mov hInstance, FUNC(GetModuleHandle,NULL)<br />&nbsp; &nbsp; call main<br />&nbsp; &nbsp; invoke ExitProcess,eax<br />; ------------------------------------------------------------------------------<br />; Main procedure (creates main window (dialog))<br />; ------------------------------------------------------------------------------<br />main proc<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; Dialog&nbsp; &quot;Bare Bones Dialog&quot;, \&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; caption<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;MS Sans Serif&quot;,10, \&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; font,pointsize<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WS_OVERLAPPED or \&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; styles for<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WS_SYSMENU or DS_CENTER, \&nbsp; &nbsp; &nbsp; ; dialog window<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2, \&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; number of controls<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 50,50,150,80, \&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; x y co-ordinates<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1024&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; memory buffer size<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; DlgButton &quot;Cancel&quot;,WS_TABSTOP,48,40,50,15,IDCANCEL<br />&nbsp; &nbsp; DlgStatic &quot;Bare Bones Dialog Written In MASM32&quot;, \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SS_CENTER,2,20,140,9,100<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; CallModalDialog hInstance,0,dlgproc,NULL<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; ret<br />&nbsp; &nbsp; <br />main endp<br /><br />; ------------------------------------------------------------------------------<br />; Dialog procedure (that controls the main dialog window)<br />; ------------------------------------------------------------------------------<br />dlgproc proc hWin:DWORD, uMsg:DWORD, wParam:DWORD, lParam:DWORD<br />&nbsp; &nbsp; local tmp:dword<br /><br />&nbsp; &nbsp; .if uMsg == WM_INITDIALOG<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke LoadIcon, NULL, IDI_ASTERISK<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke SendMessage, hWin, WM_SETICON, 1, eax<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; ; -----------------<br />&nbsp; &nbsp; &nbsp; &nbsp; ; create our thread<br />&nbsp; &nbsp; &nbsp; &nbsp; ; -----------------<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke CreateThread, NULL, 0, addr ThreadProc, hWin, NULL, addr tmp<br />&nbsp; &nbsp; &nbsp; &nbsp; mov hThread, eax<br />&nbsp; &nbsp; &nbsp; &nbsp; .if eax == NULL<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PrintError<br />&nbsp; &nbsp; &nbsp; &nbsp; .else<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; thread handle will be not used, so close it<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke CloseHandle, hThread<br />&nbsp; &nbsp; &nbsp; &nbsp; .endif&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; <br />&nbsp; &nbsp; .elseif uMsg == WM_THREAD_START<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke MessageBox, hWin, CADD(&quot;Starting...&quot;), CADD(&quot;Thread message&quot;), MB_OK<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; .elseif uMsg == WM_THREAD_STOP<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke MessageBox, hWin, CADD(&quot;Stoping...&quot;), CADD(&quot;Thread message&quot;), MB_OK<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; <br />&nbsp; &nbsp; .elseif uMsg == WM_COMMAND<br />&nbsp; &nbsp; &nbsp; &nbsp; .if wParam == IDCANCEL<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jmp quit_dialog<br />&nbsp; &nbsp; &nbsp; &nbsp; .endif<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; .elseif uMsg == WM_CLOSE<br /><br />&nbsp; quit_dialog:<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; invoke EndDialog,hWin,0<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; .endif<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; xor eax, eax<br />&nbsp; &nbsp; ret<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; dlgproc endp<br />&nbsp; &nbsp; <br />; ------------------------------------------------------------------------------&nbsp; &nbsp; <br />; The thread procedure created by the main dialog window<br />; param: window handle that will be used with SendMessage<br />; ------------------------------------------------------------------------------&nbsp; &nbsp; <br />ThreadProc proc param:dword<br /><br />&nbsp; &nbsp; invoke SendMessage, param, WM_THREAD_START, 0, 0&nbsp; &nbsp; ; starting<br />&nbsp; &nbsp; invoke SendMessage, param, WM_THREAD_STOP, 0, 0&nbsp; &nbsp;  ; ending<br /><br />;&nbsp; &nbsp; Using PostMessage() instead of SendMessage() will no block the thread<br />;&nbsp; &nbsp; invoke PostMessage, param, WM_THREAD_START, 0, 0&nbsp; &nbsp; ; started<br />;&nbsp; &nbsp; invoke PostMessage, param, WM_THREAD_STOP, 0, 0&nbsp; &nbsp;  ; stopped<br /><br />&nbsp; &nbsp; ret<br />ThreadProc endp<br /><br />end start<br />&nbsp; &nbsp; <br /></code></pre><br /><br />Hope it help.<br /><br />Kecol.-<br /><br />PS: there are another ways for communicating threads.</div>
    <div class="meta">Posted on 2005-04-14 18:56:05 by Kecol</div>
   </div>
   <div class="post" id="post-159023">
    <div class="subject"><a href="#post-159023">Re: Thread problem</a></div>
    <div class="body">Thanks for the code sample i&#39;ve debugged my code a bit more and it appears that it is crashing when something modifies the stack, so i&#39;m going to just change the buffers and dwords to global rather than local. <br /><br />edit: Ok i looked into it deeper and it definately a stack issue with my thread i made it larger than the default and the loop ran fine. I guess i&#39;ll have to move away from using the stack like that for local shit and instead start allocating my own memory. </div>
    <div class="meta">Posted on 2005-04-14 19:26:16 by lst</div>
   </div>
   <div class="post" id="post-159039">
    <div class="subject"><a href="#post-159039">Re: Thread problem</a></div>
    <div class="body">It could be a guard page problem - if you&#39;re going to use a large amount of stack memory, you should pre-touch the pages...</div>
    <div class="meta">Posted on 2005-04-15 03:02:11 by f0dder</div>
   </div>
  </div>
 </body>
</html>