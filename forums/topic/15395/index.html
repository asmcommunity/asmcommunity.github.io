<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>FILE SYSTEM HOOK..Help needed - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=15395" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=15395">FILE SYSTEM HOOK..Help needed</a></p>
   <div class="post" id="post-119626">
    <div class="subject"><a href="#post-119626">FILE SYSTEM HOOK..Help needed</a></div>
    <div class="body">I Set a  hook on the FileSystem from a VxD, using(Win98 DDK). <br />Whenever an attempt to OPEN a file, i tried to show a Message box.But, it just sucks <br />with the Blue Screen saying that Some fault there in VMM   selector 28:XXXXXXX.<br />SOFTICE would take control, when i set 'Faults ON'.It asks 'C' for to continue &amp; 'R' for  <br />Return.But a Return would again sucks.I had only limited knowledge in BSOD catching <br />and I am eager to know more about it and how to track it.<br /><pre><code><br />After the Successful Hooks,and re-direction to  function&#91; FS_Monitor&#93; ,In the code <br />below, where i tried to show the message box, when an OPEN attempt fires. &#40;In <br />between the Hash ###############' below&#41;<br />causes this Fault.. <br /><br />BeginProc  FS_Monitor<br />        ;Using C calling conventions<br />        push ebp<br />        mov ebp,esp<br />        sub esp,20h<br /><br />        ; Parameters into stack&#58;<br /><br />        ; ebp+00h -&gt; saved EBP value.<br />        ; ebp+04h -&gt; return address.<br />        ; ebp+08h -&gt; supplies the address of the FSD function that<br />        ; is to be called for this API.<br />        ; ebp+0Ch -&gt; supplies the function that is being performed.<br />        ; ebp+10h -&gt; supplies the 1-based drive the operation is being<br />        ; performed on &#40;-1 if UNC&#41;.<br />        ; ebp+14h -&gt; supplies the kind of resource the operation is being<br />        ; performed on.<br />        ; ebp+18h -&gt; supplies the codepage that the user string was<br />        ; passed in on.<br />        ; ebp+1Ch -&gt; supplies pointer to IOREQ structure.<br /><br />        ;            Total 20h bytes<br /><br />        ; Check if we are trying to process our own IFS calls<br /><br />        cmp dword ptr &#91;our_own_call&#93;,&quot;BUSY&quot;<br />        je exit_FS_hook<br /><br />        ; Check for OPEN<br />        ; This function is called also before execution...<br /><br />        cmp dword ptr &#91;ebp+0Ch&#93;,IFSFN_OPEN<br />        je OPEN_FILE<br /><br />exit_FS_hook&#58;<br /><br />        ; Prepare parameters for calling previous FS API hook<br /><br />        mov eax,dword ptr &#91;ebp+1Ch&#93;<br />        push eax<br />        mov eax,dword ptr &#91;ebp+18h&#93;<br />        push eax<br />        mov eax,dword ptr &#91;ebp+14h&#93;<br />        push eax<br />        mov eax,dword ptr &#91;ebp+10h&#93;<br />        push eax<br />        mov eax,dword ptr &#91;ebp+0Ch&#93;<br />        push eax<br />        mov eax,dword ptr &#91;ebp+08h&#93;<br />        push eax<br /><br />        ; Call previous hook<br /><br />        mov eax,dword ptr &#91;Prev_IFS_Hook&#93;<br />        call dword ptr &#91;eax&#93;<br /><br />        ; IFS hooker needs to fix the stack before return to caller<br /><br />        add esp,00000018h<br />     	 leave		 ; Back to caller<br />      	 ret		    <br />;----------------------------------------------------------------------------<br />; Open file/create a file                                                  <br />;----------------------------------------------------------------------------<br /><br />OPEN_FILE&#58;<br /><br />        ; Save regs<br />        pushfd<br />        pushad<br />           	mov dword ptr &#91;our_own_call&#93;,&quot;BUSY&quot;	  ; Set IFS busy flag<br /><br />;###################################################<br /> ;HERE I TRIED TO DISPLAY A  MESSAGEBOX, &#40;Here is the page fault culprit .&#41;<br />	popad		;Push the previous Reg Values.<br />	popfd		;pushes previous.flags.<br />	mov ecx,OFFSET32 Loaded     	;just Display a message &#40;Loaded=A String&#41;<br />      	jmp CommonCode	;&#40;CommonCode&#41; contains,VxDCall SHELL_Message&amp;  all clearing stuffs like &#40;clc &amp; ret&#41;.<br />	pushfd		;Resore the earlier Values.<br />	pushad<br />;###################################################<br />          	<br />        ; Reset IFS busy field<br />        mov dword ptr &#91;our_own_call&#93;,&quot;FREE&quot;<br /><br />        ; Get regs back<br /><br />        popad<br />        popfd<br />        jmp exit_FS_hook                             <br />         <br />EndProc  FS_Monitor<br /></code></pre></div>
    <div class="meta">Posted on 2003-09-26 12:49:39 by zakham</div>
   </div>
   <div class="post" id="post-119643">
    <div class="subject"><a href="#post-119643">FILE SYSTEM HOOK..Help needed</a></div>
    <div class="body">You may have meant to write:<br />pushad<br />pushfd<br />call CommonCode<br />popfd<br />popad<br /><br />Also the code after exit_FS_hook can be replaced with:<br />mov eax,<br />leave<br />jmp <br /><br />And the mov eax,dword ptr , push eax etc can be replaced with:<br />push byte 6<br />pop ecx<br />loop1:<br />push dword ptr <br />loop loop1<br /><br />You might as well leave out the stack frame, since you're not using it.</div>
    <div class="meta">Posted on 2003-09-26 17:11:14 by Sephiroth3</div>
   </div>
  </div>
 </body>
</html>