<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>ReportEvent  - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=30465" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=12">The Heap</a> &raquo; <a href="../?id=30465">ReportEvent </a></p>
   <div class="post" id="post-214000">
    <div class="subject"><a href="#post-214000">ReportEvent </a></div>
    <div class="body">I am converting this C code to asm.<br /><br />I will need some help starting with void wmain(void).<br /><br />I made a required DLL as well as a required register subkey.<br /><br /><pre><code>// Example shows how to use the ReportEvent function to write the events defined<br />// in the above message text file.<br /><br />#define UNICODE<br />#include &lt;windows.h&gt;<br />#include &lt;stdio.h&gt;<br />#include &quot;MyEventProvider.h&quot;<br /><br />#pragma comment(lib, &quot;advapi32.lib&quot;)<br /><br />;#define PROVIDER_NAME L&quot;MyEventProvider&quot;<br />Provider_Name&nbsp; dw&nbsp; &quot;MyEventProvider&quot;,0<br />// Hardcoded insert string for the event messages.<br /><br />CONST LPWSTR pBadCommand = L&quot;The command that was not valid&quot;;<br />pBadCommand WORD &quot;T&quot;,&quot;h&quot;,&quot;e&quot;,&quot; &quot;,&quot;c&quot;,&quot;o&quot;,&quot;m&quot;,&quot;m&quot;,&quot;a&quot;,&quot;n&quot;,&quot;d&quot;,&quot; &quot;,&quot;t&quot;,&quot;h&quot;,&quot;a&quot;,&quot;t&quot;,&quot; &quot;,&quot;w&quot;,&quot;a&quot;,&quot;s&quot;,&quot; &quot;,&quot;n&quot;,&quot;o&quot;,&quot;t&quot;,&quot; &quot;,&quot;v&quot;,&quot;a&quot;,&quot;l&quot;,&quot;i&quot;,&quot;d&quot;,&quot;.&quot;,0<br /><br />CONST LPWSTR pFilename = L&quot;c:\\masm32\source\\Events_Log.txt&quot;;<br />pFilename		WORD &quot;c&quot;,&quot;:&quot;,&quot;\&quot;,&quot;\&quot;,&quot;m&quot;,&quot;a&quot;,&quot;s&quot;,&quot;m&quot;,&quot;3&quot;,&quot;2&quot;,&quot;\&quot;,&quot;s&quot;,&quot;o&quot;,&quot;u&quot;,&quot;r&quot;,&quot;c&quot;,&quot;e&quot;,&quot;\&quot;,&quot;\&quot;,&quot;E&quot;,&quot;v&quot;,&quot;e&quot;,&quot;n&quot;,&quot;t&quot;,&quot;s&quot;,&quot;_&quot;,&quot;L&quot;,&quot;o&quot;,&quot;g&quot;,&quot;.&quot;,&quot;t&quot;,&quot;x&quot;,&quot;t&quot;,0<br /><br />CONST LPWSTR pNumberOfRetries = L&quot;3&quot;;<br /><br /><br />CONST LPWSTR pSuccessfulRetries = L&quot;0&quot;;<br /><br /><br />CONST LPWSTR pQuarts = L&quot;8&quot;;<br /><br /><br />CONST LPWSTR pGallons = L&quot;2&quot;;<br /><br />void wmain(void)<br />{<br />&nbsp; &nbsp; HANDLE hEventLog = NULL;<br />&nbsp; &nbsp; LPWSTR pInsertStrings[2] = {NULL, NULL};<br />&nbsp; &nbsp; DWORD dwEventDataSize = 0;<br /><br />&nbsp; &nbsp; // The source name (provider) must exist as a subkey of Application.<br />&nbsp; &nbsp; hEventLog = RegisterEventSource(NULL, PROVIDER_NAME);<br />&nbsp; &nbsp; if (NULL == hEventLog)<br />&nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; wprintf(L&quot;RegisterEventSource failed with 0x%x.\n&quot;, GetLastError());<br />&nbsp; &nbsp; &nbsp; &nbsp; goto cleanup;<br />&nbsp; &nbsp; }<br /><br />&nbsp; &nbsp; // This event includes user-defined data as part of the event. The event message<br />&nbsp; &nbsp; // does not use insert strings.<br />&nbsp; &nbsp; dwEventDataSize = (wcslen(pBadCommand) + 1) * sizeof(WCHAR);<br />&nbsp; &nbsp; if (!ReportEvent(hEventLog, EVENTLOG_ERROR_TYPE, UI_CATEGORY, MSG_INVALID_COMMAND, NULL, 0, dwEventDataSize, NULL, pBadCommand))<br />&nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; wprintf(L&quot;ReportEvent failed with 0x%x for event 0x%x.\n&quot;, GetLastError(), MSG_INVALID_COMMAND);<br />&nbsp; &nbsp; &nbsp; &nbsp; goto cleanup;<br />&nbsp; &nbsp; }<br /><br />&nbsp; &nbsp; // This event uses insert strings.<br />&nbsp; &nbsp; pInsertStrings[0] = pFilename;<br />&nbsp; &nbsp; if (!ReportEvent(hEventLog, EVENTLOG_ERROR_TYPE, DATABASE_CATEGORY, MSG_BAD_FILE_CONTENTS, NULL, 1, 0, (LPCWSTR*)pInsertStrings, NULL))<br />&nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; wprintf(L&quot;ReportEvent failed with 0x%x for event 0x%x.\n&quot;, GetLastError(), MSG_BAD_FILE_CONTENTS);<br />&nbsp; &nbsp; &nbsp; &nbsp; goto cleanup;<br />&nbsp; &nbsp; }<br /><br />&nbsp; &nbsp; // This event uses insert strings.<br />&nbsp; &nbsp; pInsertStrings[0] = pNumberOfRetries;<br />&nbsp; &nbsp; pInsertStrings[1] = pSuccessfulRetries;<br />&nbsp; &nbsp; if (!ReportEvent(hEventLog, EVENTLOG_WARNING_TYPE, NETWORK_CATEGORY, MSG_RETRIES, NULL, 2, 0, (LPCWSTR*)pInsertStrings, NULL))<br />&nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; wprintf(L&quot;ReportEvent failed with 0x%x for event 0x%x.\n&quot;, GetLastError(), MSG_RETRIES);<br />&nbsp; &nbsp; &nbsp; &nbsp; goto cleanup;<br />&nbsp; &nbsp; }<br /><br />&nbsp; &nbsp; // This event uses insert strings.<br />&nbsp; &nbsp; pInsertStrings[0] = pQuarts;<br />&nbsp; &nbsp; pInsertStrings[1] = pGallons;<br />&nbsp; &nbsp; if (!ReportEvent(hEventLog, EVENTLOG_INFORMATION_TYPE, UI_CATEGORY, MSG_COMPUTE_CONVERSION, NULL, 2, 0, (LPCWSTR*)pInsertStrings, NULL))<br />&nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; wprintf(L&quot;ReportEvent failed with 0x%x for event 0x%x.\n&quot;, GetLastError(), MSG_COMPUTE_CONVERSION);<br />&nbsp; &nbsp; &nbsp; &nbsp; goto cleanup;<br />&nbsp; &nbsp; }<br /><br />&nbsp; &nbsp; wprintf(L&quot;All events successfully reported.\n&quot;);<br /><br />cleanup:<br /><br />&nbsp; &nbsp; if (hEventLog)<br />&nbsp; &nbsp; &nbsp; &nbsp; DeregisterEventSource(hEventLog);<br /></code></pre></div>
    <div class="meta">Posted on 2011-02-01 10:06:44 by skywalker</div>
   </div>
   <div class="post" id="post-214009">
    <div class="subject"><a href="#post-214009">Re: ReportEvent </a></div>
    <div class="body">Provider_Name&nbsp; dw&nbsp; &quot;MyEventProvider&quot;,0<br /><br />doesnt look right...<br /><br />also tried formatting the code.. it messed up, but is readable.. so bleh... i aint doing everything ;p<br /><br />and wstr usage might be wrong too.. anyway, its mostly there, so small fixes to do...you can do that i&#039;m sure<br /><br /><pre><code><br /><br />.data<br /><br />; use the WSTR macro from the masm32\include\ucmacros.asm to do unicode stuff easily<br /><br />Provider_Name 		WSTR &quot;MyEventProvider&quot;					; #define PROVIDER_NAME L&quot;MyEventProvider&quot;<br />pBadCommand 		WSTR &quot;The command that was not valid&quot;			; CONST LPWSTR pBadCommand = L&quot;The command that was not valid&quot;;<br />pFilename		WSTR &quot;C:\masm32\source\Events_Log.txt&quot;			; pFilename = L&quot;c:\\masm32\source\\Events_Log.txt&quot;; ; &lt;&lt; check your typing \\ is an escape code, its only one \ when compiled in c...you&#039;ve mixed them<br />pNumberOfRetries	WSTR &quot;3&quot;						; CONST LPWSTR pNumberOfRetries = L&quot;3&quot;;<br />pSuccessfulRetries	WSTR &quot;0&quot;						; CONST LPWSTR pSuccessfulRetries = L&quot;0&quot;;<br />pQuarts			WSTR &quot;8&quot;						; CONST LPWSTR pQuarts = L&quot;8&quot;;<br />pGallons		WSTR &quot;2&quot;						; CONST LPWSTR pGallons = L&quot;2&quot;;<br /><br /><br />.code<br /><br />wmainproc proc uses ebx ecx edx esi edi<br /><br />&nbsp; &nbsp; LOCAL 	hEventLog:HANDLE<br />&nbsp; &nbsp; LOCAL 	dwEventDataSize:DWORD<br />&nbsp; &nbsp; LOCAL	pInsertStrings[2]:LPVOID<br /><br />&nbsp; &nbsp; mov 	, NULL				; HANDLE hEventLog = NULL;<br />&nbsp; &nbsp; mov 	, NULL				; DWORD dwEventDataSize = 0;<br />&nbsp; &nbsp; mov		], NULL			; first part of LPWSTR pInsertStrings[2] = {NULL, NULL};<br />&nbsp; &nbsp; mov		], NULL			; second part of LPWSTR pInsertStrings[2] = {NULL, NULL};<br /><br />&nbsp; &nbsp; push 	offset Provider_name<br />&nbsp; &nbsp; push 	NULL<br />&nbsp; &nbsp; Call 	RegisterEventSource				; hEventLog = RegisterEventSource(NULL, PROVIDER_NAME);<br /><br />&nbsp; &nbsp; mov 	, eax<br /><br />&nbsp; &nbsp; cmp 	, NULL<br />&nbsp; &nbsp; jne 	outofthisroutine<br /><br />&nbsp; &nbsp; ; register event failed.. getlasterror, do some logging<br /><br />&nbsp; &nbsp; jmp 	outofthisroutine<br /><br />gotahandle:<br /><br />&nbsp; &nbsp; ; push&nbsp; &nbsp;  offset pBadCommand<br />&nbsp; &nbsp; ; call&nbsp; &nbsp;  wcslen						; dwEventDataSize = (wcslen(pBadCommand) + 1) * sizeof(WCHAR);<br /><br />&nbsp; &nbsp; ; lea&nbsp; &nbsp;  eax, <br /><br />&nbsp; &nbsp; ; mov&nbsp; &nbsp;  , eax<br /><br />&nbsp; &nbsp; ; actually, that code isnt needed, we can get the compiler to do the work for us.. whee i optimised it ;p<br /><br />&nbsp; &nbsp; mov 	, (sizeof pBadCommand)		; or maybe lengthof.. can&#039;t remember.. experiment ;p<br /><br />&nbsp; &nbsp; push	offset pBadCommand<br />&nbsp; &nbsp; push	NULL<br />&nbsp; &nbsp; push					; could be optimised to push (sizeof pBadCommand) ; thus not needing the dwEventDataSize local at all..<br />&nbsp; &nbsp; push	NULL<br />&nbsp; &nbsp; push	MSG_INVALID_COMMAND				; will be in some header somewhere..<br />&nbsp; &nbsp; push	UI_CATEGORY<br />&nbsp; &nbsp; push	EVENTLOG_ERROR_TYPE<br />&nbsp; &nbsp; push	<br />&nbsp; &nbsp; call	ReportEvent<br /><br />&nbsp; &nbsp; cmp	&nbsp; &nbsp; &nbsp; &nbsp; eax, FALSE<br />&nbsp; &nbsp; jne	&nbsp; &nbsp; &nbsp; &nbsp; reporteventworked<br /><br />&nbsp; &nbsp; ; reportevent failed.. do some logging<br /><br />closehandleandgetout:<br /><br />&nbsp; &nbsp; push	<br />&nbsp; &nbsp; call	DeregisterEventSource			; DeregisterEventSource(hEventLog);<br /><br />&nbsp; &nbsp; ; close the handle too (probably needed.. you can test this)<br /><br />&nbsp; &nbsp; push	<br />&nbsp; &nbsp; call	CloseHandle<br /><br />&nbsp; &nbsp; mov		, NULL<br /><br />&nbsp; &nbsp; jmp		outofthisroutine<br /><br />reporteventworked:<br /><br />&nbsp; &nbsp; mov		], offset pFileName		; pInsertStrings[0] = pFilename;<br /><br />&nbsp; &nbsp; lea		eax, pInsertStrings[0]<br /><br />&nbsp; &nbsp; push	NULL<br />&nbsp; &nbsp; push	eax<br />&nbsp; &nbsp; push	NULL<br />&nbsp; &nbsp; push	1<br />&nbsp; &nbsp; push	NULL<br />&nbsp; &nbsp; push	MSG_BAD_FILE_CONTENTS<br />&nbsp; &nbsp; push	DATABASE_CATEGORY<br />&nbsp; &nbsp; push	EVENTLOG_ERROR_TYPE<br />&nbsp; &nbsp; push	<br />&nbsp; &nbsp; call	ReportEvent<br /><br />&nbsp; &nbsp; cmp		eax, FALSE<br />&nbsp; &nbsp; jne		reporteventworked2<br /><br />&nbsp; &nbsp; ; reportevent failed.. do some logging<br /><br />&nbsp; &nbsp; jmp		closehandleandgetout<br /><br />reporteventworked2:<br /><br />&nbsp; &nbsp; mov		], offset pNumberOfRetries	;&nbsp; &nbsp; pInsertStrings[0] = pNumberOfRetries;<br />&nbsp; &nbsp; mov		], offset pSuccessfulRetries	;&nbsp; &nbsp; pInsertStrings[1] = pSuccessfulRetries;<br /><br />&nbsp; &nbsp; lea		eax, pInsertStrings[0]<br /><br />&nbsp; &nbsp; push	NULL<br />&nbsp; &nbsp; push	eax<br />&nbsp; &nbsp; push	NULL<br />&nbsp; &nbsp; push	2<br />&nbsp; &nbsp; push	NULL<br />&nbsp; &nbsp; push	MSG_RETRIES<br />&nbsp; &nbsp; push	NETWORK_CATEGORY<br />&nbsp; &nbsp; push	EVENTLOG_WARNING_TYPE<br />&nbsp; &nbsp; push	<br />&nbsp; &nbsp; call	ReportEvent<br /><br />&nbsp; &nbsp; cmp		eax, FALSE<br />&nbsp; &nbsp; jne		reporteventworked3<br /><br />&nbsp; &nbsp; ; reportevent failed.. do some logging<br /><br />&nbsp; &nbsp; jmp		closehandleandgetout<br /><br />reporteventworked3:<br /><br />&nbsp; &nbsp; mov		], offset pQuarts		;&nbsp; &nbsp; pInsertStrings[0] = pQuarts;<br />&nbsp; &nbsp; mov		], offset pGallons	&nbsp; &nbsp; &nbsp; &nbsp; ;&nbsp; &nbsp; pInsertStrings[1] = pGallons;<br /><br />&nbsp; &nbsp; lea		eax, pInsertStrings[0]<br /><br />&nbsp; &nbsp; push	NULL<br />&nbsp; &nbsp; push	eax<br />&nbsp; &nbsp; push	NULL<br />&nbsp; &nbsp; push	2<br />&nbsp; &nbsp; push	MSG_COMPUTE_CONVERSION<br />&nbsp; &nbsp; push	UI_CATEGORY<br />&nbsp; &nbsp; push	EVENTLOG_INFORMATION_TYPE<br />&nbsp; &nbsp; push	<br />&nbsp; &nbsp; call	ReportEvent<br /><br />&nbsp; &nbsp; cmp		eax, FALSE<br />&nbsp; &nbsp; je		wearealldoneithink<br /><br />&nbsp; &nbsp; ; reportevent failed.. do some logging<br /><br />&nbsp; &nbsp; jmp		closehandleandgetout<br /><br />wearealldoneithink:<br /><br />&nbsp; &nbsp; ; more?<br /><br />&nbsp; &nbsp; jmp		closehandleandgetout<br /><br />outofthisroutine:<br /><br />&nbsp; &nbsp; ; DONE...<br /><br />&nbsp; &nbsp; ret<br /><br />wmainproc endp<br /><br /></code></pre><br /><br />hopefully you&#039;ll learn a bit from this and be able to do the next bit yourself...<br /><br />i left some of the c code still in as comments, so you can perhaps understand them a bit better...<br /><br />dont know if the code compiles, but im sure you can fix any of the asm errors that might crop up...<br /></div>
    <div class="meta">Posted on 2011-02-02 07:58:01 by evlncrn8</div>
   </div>
   <div class="post" id="post-214024">
    <div class="subject"><a href="#post-214024">Re: ReportEvent </a></div>
    <div class="body">I need help converting this header file entry to <br />something that would work in an include file.<br /><br />#define MSG_INVALID_COMMAND&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ((DWORD)0xC0020100L)<br /><br />This didn&#039;t work.<br /><br />MSG_INVALID_COMMAND equ ((DWORD)0xC0020100L)</div>
    <div class="meta">Posted on 2011-02-06 17:19:52 by skywalker</div>
   </div>
   <div class="post" id="post-214025">
    <div class="subject"><a href="#post-214025">Re: ReportEvent </a></div>
    <div class="body">MSG_INVALID_COMMAND equ 0C0020100H<br />?</div>
    <div class="meta">Posted on 2011-02-06 17:34:45 by Gunner</div>
   </div>
   <div class="post" id="post-214026">
    <div class="subject"><a href="#post-214026">Re: ReportEvent </a></div>
    <div class="body">Got this with the code below it.<br /><br />I don&#039;t know what&#039;s up with the symbol redefinition errors, I see only one instance of&nbsp; FACILITY_IO_ERROR_CODE.<br /><br />\masm32\source\provider.inc(39) : error A2005: symbol redefinition : FACILITY_IO_ERROR_CODE<br />\masm32\source\provider.inc(45) : error A2005: symbol redefinition : STATUS_SEVERITY_WARNING<br />\masm32\source\provider.inc(46) : error A2005: symbol redefinition : STATUS_SEVERITY_SUCCESS<br />\masm32\source\provider.inc(47) : error A2005: symbol redefinition : STATUS_SEVERITY_INFORMATIONAL<br />\masm32\source\provider.inc(48) : error A2005: symbol redefinition : STATUS_SEVERITY_ERROR<br />C:\masm32\SOURCE\WSTR.asm(111) : error A2206: missing operator in expression<br />C:\masm32\SOURCE\WSTR.asm(137) : error A2006: undefined symbol : pFileName<br />C:\masm32\SOURCE\WSTR.asm(146) : error A2206: missing operator in expression<br />C:\masm32\SOURCE\WSTR.asm(147) : error A2206: missing operator in expression<br />C:\masm32\SOURCE\WSTR.asm(161) : error A2006: undefined symbol : pNumberOfRetries<br />C:\masm32\SOURCE\WSTR.asm(162) : error A2006: undefined symbol : pSuccessfulRetries<br />C:\masm32\SOURCE\WSTR.asm(171) : error A2206: missing operator in expression<br />C:\masm32\SOURCE\WSTR.asm(172) : error A2206: missing operator in expression<br />C:\masm32\SOURCE\WSTR.asm(186) : error A2006: undefined symbol : pQuarts<br />C:\masm32\SOURCE\WSTR.asm(187) : error A2006: undefined symbol : pGallons<br />C:\masm32\SOURCE\WSTR.asm(195) : error A2206: missing operator in expression<br />C:\masm32\SOURCE\WSTR.asm(196) : error A2206: missing operator in expression<br /><br /><ul><br /><li> ; WSTR.asm Contributors: evlncrn8,R. Russel,<br />;<br />.686&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />.model flat, stdcall&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />option casemap :none&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br /><br />include \masm32\include\windows.inc&nbsp; &nbsp; <br />include \masm32\include\masm32.inc&nbsp; &nbsp;  <br /><br />include \masm32\include\gdi32.inc<br />include \masm32\include\user32.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\Comctl32.inc<br />include \masm32\include\comdlg32.inc<br />include \masm32\include\shell32.inc<br />include \masm32\include\oleaut32.inc<br />include \masm32\include\ole32.inc<br />include \masm32\include\msvcrt.inc<br />include \masm32\include\advapi32.inc<br /><br />;include \masm32\source\MyEventProvider.h<br />include \masm32\source\provider.inc<br /><br />include \masm32\include\dialogs.inc&nbsp; &nbsp; <br />include \masm32\macros\macros.asm&nbsp; &nbsp; &nbsp; <br /><br />includelib \masm32\lib\masm32.lib&nbsp; &nbsp; &nbsp; <br /><br />includelib \masm32\lib\gdi32.lib<br />includelib \masm32\lib\user32.lib<br />includelib \masm32\lib\kernel32.lib<br />includelib \masm32\lib\Comctl32.lib<br />includelib \masm32\lib\comdlg32.lib<br />includelib \masm32\lib\shell32.lib<br />includelib \masm32\lib\oleaut32.lib<br />includelib \masm32\lib\ole32.lib<br />includelib \masm32\lib\msvcrt.lib<br />includelib \masm32\lib\advapi32.lib<br /><br />.data<br /><br />RESOURCE_DLL&nbsp;  db&nbsp; &quot;c:\masm32\source\MyEventProvider.dll&quot;,0<br />Provider_Name&nbsp; db&nbsp; &quot;MyEventProvider&quot;,0 <br />pBadCommand&nbsp; &nbsp; WORD &quot;T&quot;,&quot;h&quot;,&quot;e&quot;,&quot; &quot;,&quot;c&quot;,&quot;o&quot;,&quot;m&quot;,&quot;m&quot;,&quot;a&quot;,&quot;n&quot;,&quot;d&quot;,&quot; &quot;,&quot;t&quot;,&quot;h&quot;,&quot;a&quot;,&quot;t&quot;,&quot; &quot;,&quot;w&quot;,&quot;a&quot;,&quot;s&quot;,&quot; &quot;,&quot;n&quot;,&quot;o&quot;,&quot;t&quot;,&quot; &quot;,&quot;v&quot;,&quot;a&quot;,&quot;l&quot;,&quot;i&quot;,&quot;d&quot;,&quot;.&quot;,0<br /><br />; use the WSTR macro from the masm32\include\ucmacros.asm to do unicode stuff easily<br /><br />;Provider_Name WSTR &quot;MyEventProvider&quot; <br />;pBadCommand WSTR &quot;The command that was not valid&quot; <br /> ; pFilename WSTR &quot;C:\masm32\source\Events_Log.txt&quot; <br />&nbsp; ;pNumberOfRetries WSTR &quot;3&quot; <br />&nbsp; ;pSuccessfulRetries WSTR &quot;0&quot; <br />&nbsp; ;pQuarts WSTR &quot;8&quot; <br />&nbsp; ;pGallons WSTR &quot;2&quot; <br /><br />.code<br /><br />start:<br /><br />wmainproc proc uses ebx ecx edx esi edi<br /><br />&nbsp; &nbsp; LOCAL hEventLog:HANDLE<br />&nbsp; &nbsp; LOCAL dwEventDataSize:DWORD<br />&nbsp; &nbsp; LOCAL pInsertStrings[2]:LPVOID<br /><br />&nbsp; &nbsp; mov , NULL ; HANDLE hEventLog = NULL;<br />&nbsp; &nbsp; mov , NULL ; DWORD dwEventDataSize = 0;<br />&nbsp; &nbsp; mov ], NULL ; first part of LPWSTR pInsertStrings[2] = {NULL, NULL};<br />&nbsp; &nbsp; mov ], NULL ; second part of LPWSTR pInsertStrings[2] = {NULL, NULL};<br /><br />&nbsp; &nbsp; push offset Provider_Name<br />&nbsp; &nbsp; push NULL<br />&nbsp; &nbsp; Call RegisterEventSource ; hEventLog = RegisterEventSource(NULL, PROVIDER_NAME);<br /><br />&nbsp; &nbsp; mov , eax<br /><br />&nbsp; &nbsp; cmp , NULL<br />&nbsp; &nbsp; jne outofthisroutine<br /><br />&nbsp; &nbsp; ; register event failed.. getlasterror, do some logging<br /><br />outofthisroutine:<br /><br />&nbsp; &nbsp; ; DONE...<br /><br />&nbsp;  invoke ExitProcess,0<br /><br />;end start<br /><br />;jmp outofthisroutine<br /><br />gotahandle:<br /><br />&nbsp; &nbsp; ; push&nbsp; &nbsp;  offset pBadCommand<br />&nbsp; &nbsp; ; call&nbsp; &nbsp;  wcslen ; dwEventDataSize = (wcslen(pBadCommand) + 1) * sizeof(WCHAR);<br /><br />&nbsp; &nbsp; ; lea&nbsp; &nbsp;  eax, <br /><br />&nbsp; &nbsp; ; mov&nbsp; &nbsp;  , eax<br /><br />&nbsp; &nbsp; ; actually, that code isnt needed, we can get the compiler to do the work for us.. whee i optimised it ;p<br /><br />&nbsp; &nbsp; mov , (sizeof pBadCommand) ; or maybe lengthof.. can&#039;t remember.. experiment ;p<br /><br />&nbsp; &nbsp; push offset pBadCommand<br />&nbsp; &nbsp; push NULL<br />&nbsp; &nbsp; push  ; could be optimised to push (sizeof pBadCommand) ; thus not needing the dwEventDataSize local at all..<br />&nbsp; &nbsp; push NULL<br />&nbsp; &nbsp; push MSG_INVALID_COMMAND ; will be in some header somewhere..<br />&nbsp; &nbsp; push UI_CATEGORY<br />&nbsp; &nbsp; push EVENTLOG_ERROR_TYPE<br />&nbsp; &nbsp; push <br />&nbsp; &nbsp; call ReportEvent<br /><br />&nbsp; &nbsp; cmp&nbsp; &nbsp; &nbsp; &nbsp;  eax, FALSE<br />&nbsp; &nbsp; jne&nbsp; &nbsp; &nbsp; &nbsp;  reporteventworked<br /><br />&nbsp; &nbsp; ; reportevent failed.. do some logging<br /><br />closehandleandgetout:<br /><br />&nbsp; &nbsp; push <br />&nbsp; &nbsp; call DeregisterEventSource ; DeregisterEventSource(hEventLog);<br /><br />&nbsp; &nbsp; ; close the handle too (probably needed.. you can test this)<br /><br />&nbsp; &nbsp; push <br />&nbsp; &nbsp; call CloseHandle<br /><br />&nbsp; &nbsp; mov , NULL<br /><br />&nbsp; &nbsp; jmp outofthisroutine<br /><br />reporteventworked:<br /><br />&nbsp; &nbsp; mov ], offset pFileName ; pInsertStrings[0] = pFilename;<br /><br />&nbsp; &nbsp; lea eax, pInsertStrings[0]<br /><br />&nbsp; &nbsp; push NULL<br />&nbsp; &nbsp; push eax<br />&nbsp; &nbsp; push NULL<br />&nbsp; &nbsp; push 1<br />&nbsp; &nbsp; push NULL<br />&nbsp; &nbsp; push MSG_BAD_FILE_CONTENTS<br />&nbsp; &nbsp; push DATABASE_CATEGORY<br />&nbsp; &nbsp; push EVENTLOG_ERROR_TYPE<br />&nbsp; &nbsp; push <br />&nbsp; &nbsp; call ReportEvent<br /><br />&nbsp; &nbsp; cmp eax, FALSE<br />&nbsp; &nbsp; jne reporteventworked2<br /><br />&nbsp; &nbsp; ; reportevent failed.. do some logging<br /><br />&nbsp; &nbsp; jmp closehandleandgetout<br /><br />reporteventworked2:<br /><br />&nbsp; &nbsp; mov ], offset pNumberOfRetries ;&nbsp; &nbsp; pInsertStrings[0] = pNumberOfRetries;<br />&nbsp; &nbsp; mov ], offset pSuccessfulRetries ;&nbsp; &nbsp; pInsertStrings[1] = pSuccessfulRetries;<br /><br />&nbsp; &nbsp; lea eax, pInsertStrings[0]<br /><br />&nbsp; &nbsp; push NULL<br />&nbsp; &nbsp; push eax<br />&nbsp; &nbsp; push NULL<br />&nbsp; &nbsp; push 2<br />&nbsp; &nbsp; push NULL<br />&nbsp; &nbsp; push MSG_RETRIES<br />&nbsp; &nbsp; push NETWORK_CATEGORY<br />&nbsp; &nbsp; push EVENTLOG_WARNING_TYPE<br />&nbsp; &nbsp; push <br />&nbsp; &nbsp; call ReportEvent<br /><br />&nbsp; &nbsp; cmp eax, FALSE<br />&nbsp; &nbsp; jne reporteventworked3<br /><br />&nbsp; &nbsp; ; reportevent failed.. do some logging<br /><br />&nbsp; &nbsp; jmp closehandleandgetout<br /><br />reporteventworked3:<br /><br />&nbsp; &nbsp; mov ], offset pQuarts ;&nbsp; &nbsp; pInsertStrings[0] = pQuarts;<br />&nbsp; &nbsp; mov ], offset pGallons&nbsp; &nbsp; &nbsp; &nbsp;  ;&nbsp; &nbsp; pInsertStrings[1] = pGallons;<br /><br />&nbsp; &nbsp; lea eax, pInsertStrings[0]<br /><br />&nbsp; &nbsp; push NULL<br />&nbsp; &nbsp; push eax<br />&nbsp; &nbsp; push NULL<br />&nbsp; &nbsp; push 2<br />&nbsp; &nbsp; push MSG_COMPUTE_CONVERSION<br />&nbsp; &nbsp; push UI_CATEGORY<br />&nbsp; &nbsp; push EVENTLOG_INFORMATION_TYPE<br />&nbsp; &nbsp; push <br />&nbsp; &nbsp; call ReportEvent<br /><br />&nbsp; &nbsp; cmp eax, FALSE<br />&nbsp; &nbsp; je wearealldoneithink<br /><br />&nbsp; &nbsp; ; reportevent failed.. do some logging<br /><br />&nbsp; &nbsp; jmp closehandleandgetout<br /><br />wearealldoneithink:<br /><br />&nbsp; &nbsp; ; more?<br /><br />&nbsp; &nbsp; jmp closehandleandgetout<br />&nbsp; &nbsp; &nbsp; <br />wmainproc endp<br /><br />end start</li><br /><li></li><br /></ul></div>
    <div class="meta">Posted on 2011-02-06 18:02:58 by skywalker</div>
   </div>
  </div>
 </body>
</html>