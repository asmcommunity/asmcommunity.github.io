<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>New Control - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=4935" />
    <link rel="next" href="../?id=4935&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=4935">New Control</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=4935&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=4935&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="4935" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=4935&amp;page=2">&gt;</a><a href="../?id=4935&amp;page=2">&raquo;</a></form>   <div class="post" id="post-34609">
    <div class="subject"><a href="#post-34609">New Control</a></div>
    <div class="body">Well im done :grin:<br /><br />My MenuButton control is finished and well pollished, so in the next comming days im going to make my attempt at writting a tutorial out of it. <br /><br />However, for those who do not care for tutorials, here is the control up front and ready.  There is a good amount of commenting as already, so most should not have any problems reading it.<br /><br />As well, i make use of a new 'lib' entry to the masm32.inc lib.  Its a function to copy bitmaps to a DC with a transparency mask.  I make use of it in the control, and thus it is needed if you wish to link the control to any future projects.  I have added it into the package under &quot;MASM32&quot;.  You need to manually copy it to M32LIB and follow two simple steps outlined in the README to recompile your masm32.lib.<br /><br />I also have a basic example of how the controls are used.   In the readme.txt there is also a breakdown of suported messages to send to the control.  Its realy simple so i cant see anyone getting confused here.<br /><br />Anywho.. There it is.. Make use of it and have fun... and Feedback is welcome!<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-04-23 05:02:19 by NaN</div>
   </div>
   <div class="post" id="post-34613">
    <div class="subject"><a href="#post-34613">New Control</a></div>
    <div class="body">Hi NaN<br /><br />Great control. :alright: <br /><br />Seem to have a little bug.<br />On my XP the button displays garbage text if no text is set (I guess).<br /><br />KetilO</div>
    <div class="meta">Posted on 2002-04-23 05:58:56 by KetilO</div>
   </div>
   <div class="post" id="post-34622">
    <div class="subject"><a href="#post-34622">New Control</a></div>
    <div class="body">Nan,<br /><br />This works fine on my win95b, library module looks interesting and I am sure many people will like it.<br /><br />Make sure I get the final version so i can add it to the next service pack.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-04-23 07:06:39 by hutch--</div>
   </div>
   <div class="post" id="post-34627">
    <div class="subject"><a href="#post-34627">New Control</a></div>
    <div class="body">good work<br />thanks for sharing nan</div>
    <div class="meta">Posted on 2002-04-23 07:48:52 by adapix</div>
   </div>
   <div class="post" id="post-34635">
    <div class="subject"><a href="#post-34635">New Control</a></div>
    <div class="body"><div class="quote"><em>Originally posted by KetilO </em><strong><br />Seem to have a little bug.<br />On my XP the button displays garbage text if no text is set (I guess).<br /></div><br /><br />As well as under NT5/W2K - the same behaviour.</div>
    <div class="meta">Posted on 2002-04-23 08:43:44 by MikeJ</div>
   </div>
   <div class="post" id="post-34637">
    <div class="subject"><a href="#post-34637">New Control</a></div>
    <div class="body">Good stuff NaN, i like the links on the button 3 menu.</div>
    <div class="meta">Posted on 2002-04-23 08:48:03 by sluggy</div>
   </div>
   <div class="post" id="post-34645">
    <div class="subject"><a href="#post-34645">New Control</a></div>
    <div class="body">Here's how it looks on win2k...<br />other than that, I have one little more gripe :). It would be nice if<br />the buttons acted a bit more like &quot;standard buttons&quot; in the sense<br />that if you click the button, keep the mousebutton pressed, and<br />drag the mouse off the button, two things should happen. First,<br />the button should go to its unpressed state, and secondly no click<br />should be generated when mouse is released.<br /><br />Oh, do you have the CS_DBLCLKS style on?<br /><br />Other than that, good work.</div>
    <div class="meta">Posted on 2002-04-23 10:13:41 by f0dder</div>
   </div>
   <div class="post" id="post-34646">
    <div class="subject"><a href="#post-34646">New Control</a></div>
    <div class="body">great, forgot to attach as always.<br />:stupid:</div>
    <div class="meta">Posted on 2002-04-23 10:14:30 by f0dder</div>
   </div>
   <div class="post" id="post-34647">
    <div class="subject"><a href="#post-34647">New Control</a></div>
    <div class="body">I don't know what to say: this is a great control, very great.<br />GOOD JOB !!:alright: :alright: <br /><br />Thomas.<br />PS:just a small bug: you know, when you click on a button and you stay clicked, and then you move out from the button, you can press up the button then the function is not executed. (hope you understand, I don't explain very good!!),<br /><br />but here in your control, once we have press the mouse button down, the function cannot be prevented. (just have a look at IE button--&gt; back)<br /><br />after reading what I've just written, I see that it does not look so clear, but I hope everybody will understand...<br /><br /><br />--&gt; works great on Win98SE (French)</div>
    <div class="meta">Posted on 2002-04-23 10:22:38 by Vom-bonjour:-()</div>
   </div>
   <div class="post" id="post-34648">
    <div class="subject"><a href="#post-34648">New Control</a></div>
    <div class="body"><div class="quote"><br />just a small bug: you know, when you click on a button and you stay clicked, and then you move out from the button, you can press up the button then the function is not executed. (hope you understand, I don't explain very good!!), <br /></div><br /><br />thats what fodder pointed out already... <br /><br />i printed out the source and stumbled over it... this <br />DrawFrameControl API was new to me, seems to be very<br />usefull for custom controls... nan, are you really going<br />to write a gdi tutorial? this would be very cool because<br />i never saw a good one for asm programming... if you<br />do i bet there are a bunch of people on this board ready<br />to help you (including myself)...<br /><br />good work...</div>
    <div class="meta">Posted on 2002-04-23 10:40:11 by mob</div>
   </div>
   <div class="post" id="post-34654">
    <div class="subject"><a href="#post-34654">New Control</a></div>
    <div class="body">well, I'm sorry, maybe I've not read all, well, I don't really understand why I've not seen what f0dder said.<br /><br />sorry for that.<br /><br /><br />Thomas.<br />:stupid:</div>
    <div class="meta">Posted on 2002-04-23 11:00:57 by Vom-bonjour:-()</div>
   </div>
   <div class="post" id="post-34666">
    <div class="subject"><a href="#post-34666">New Control</a></div>
    <div class="body">Thanx all:<br /><br />So there is two major things to work out:<br /><ul>[*]Fix the text on any form of NT box.  Hmm, this will be slow (as i dont have an NT OS anywhere), if i can email proto's to someone this would rock.  However i will look up the MSDN and see why the 'DrawTextEx' API if failing.  I suspect its due to NT's obsesion with unicode strings :grin: .<br />[*] Make mouse clicks specific when the mouse is still over the control.  I will give it a whirl, but to be honest, this was one area that was challenging.  Its hard to get the right messages sent to you on this, i debugged alot of sceenarios to get it to work this well.  Its really a juggle of where the best place to evaluated state variables are.  I will give it a try.<br /><br /><br />However im glad you like it.  And also glad to see that the 'DrawTransparentBitmap' method works on all platforms :)<br /><br />I will hack out a revision very soon..<br />Thanx for the feedback, and let me know if other 'quirks' pop up.<br /><br />:alright:<br />NaN<br /><br />PS: Mob,  ya It was kinda an upset learning about this api, I stumbled upon it by accident using the &quot;group&quot; lists in the API reference .hlp file.   It kinda annoyed me at first, as i had at that point written gdi functions to do the exact same thing! (so there was alot of wasted time here).  The upside from the API is i no longer needed to build an arsenal of pens and brushes, and manage them with the DC's ( real savings here! ).  I actually printed that page off the API help, as it has alot of neat things in it.  Definitely a source for any other control development!!.</div>
    <div class="meta">Posted on 2002-04-23 13:27:50 by NaN</div>
   </div>
   <div class="post" id="post-34668">
    <div class="subject"><a href="#post-34668">New Control</a></div>
    <div class="body">NaN, sounds very unlikely that unicode should be the problem,<br />the 'A' versions of the APIs still exist on NT (though they do ansi-&gt;uni<br />conversion and call the 'W' version of the API). It's probably something else.<br /><br />As for the mouse stuff, you should probably look at SetCapture.</div>
    <div class="meta">Posted on 2002-04-23 13:35:24 by f0dder</div>
   </div>
   <div class="post" id="post-34680">
    <div class="subject"><a href="#post-34680">New Control</a></div>
    <div class="body">Thanx, i am using SetCapture.  As for the text i've looked it up on the MSDN and it says it suports it, however i have a hunch if I drop the 'ex' it will work fine.<br /><br />Im just finishing a test program to get some info back..<br /><br />Thanx.<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-04-23 14:20:06 by NaN</div>
   </div>
   <div class="post" id="post-34682">
    <div class="subject"><a href="#post-34682">New Control</a></div>
    <div class="body">Can XP,NT,2000 users please download this test file and tell me if you see lines A, B, C, D.   (Cant hurt for 9x users as well).<br /><br /> <strong>Removed Test program... No need to waste space</strong></div>
    <div class="meta">Posted on 2002-04-23 14:33:19 by NaN</div>
   </div>
   <div class="post" id="post-34683">
    <div class="subject"><a href="#post-34683">New Control</a></div>
    <div class="body">Can you read this ANSI DrawText A<br />Can you Read this ANSI DrawTextEx B<br />C<br />C</div>
    <div class="meta">Posted on 2002-04-23 14:37:52 by f0dder</div>
   </div>
   <div class="post" id="post-34684">
    <div class="subject"><a href="#post-34684">New Control</a></div>
    <div class="body">Looks like this (WinXP):</div>
    <div class="meta">Posted on 2002-04-23 14:39:33 by bazik</div>
   </div>
   <div class="post" id="post-34686">
    <div class="subject"><a href="#post-34686">New Control</a></div>
    <div class="body">Ok, Now im completely stumped!!<br /><br />Both work fine on NT.  So what am i doing wrong?<br /><br />For inerested helpers: <ul><br />[*]The Back buffer DC is created on lines 147-153.  I build a compatible DC as the thead's own DC.<br />[*]I use DrawTextEx on line 242, for noraml siuations (button unclicked).  The text pointer is stored in lpText. -1 is cause i dont need to specify length (as i did in the above test demo). The rect is ok (as you see *something* at the bottom), and the style if POP'ed off the stack from previous evals.  NULL is cause i dont care about other *special* features.<br />[*]The text is drawn on the Back buffer to prevent flicker.  However, the only difference betwwen the control, and the above test, is that in the above test, i draw directly to PS.hdc provided by begin paint.  (Could this be a factor somehow?)<br />[*]Lastly, i bitblt it to the PS.hdc in one go and im done.<br /><br /><br />I guess the only *logical* solution is somehow the PS.hdc has proper font info, and the back buffer doesnt?? (This make sense?).  Nowhere in the control do i create a pen for drawing.  Im useing the default pen that comes on the private DC.  Is it possible in NT machines there is some differene here? <br /><br />Any sugestions?  Pehaps i should try 'GetStockObject' and select a default textfont/pen and select it into the backbuffer dc???<br /><br />Thoughts welcome! (I dont want to flood the board with 'test' revisions of the control if i dont have to).<br /><br /><strong>Can you NT guys run the original program again and click the first button's drop menu (upper left corner), and select the last menu option (set menu buton 1 font).  See if it fix's the font on this button.  I use GetStockObject here for a default system font, and select it into the DC. This will help determine if these guesses are correct.</strong><br /><br /><em>PS: This is the only remaining problem, i got the button clicking fixed up the first try ;) .  Should have thought of it sooner.</em><br /><br />Thanx alot <strong>fodder</strong> and <strong>bazik</strong> for you help so far!<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-04-23 14:52:53 by NaN</div>
   </div>
   <div class="post" id="post-34708">
    <div class="subject"><a href="#post-34708">New Control</a></div>
    <div class="body">Hm...<br /><br />By trial and Error with a budy on ICQ, i've determined that its <strong>NOT</strong> in the GDI at all!!!<br /><br />Some how on NT machines only, the rules are being broken, and the lpText pointer vaiable on the heap is being corrupted.  However, on 9x machines the pointer is not being violated.<br /><br />Bizzarre!!!!!<br /><br />Still hacking at it.. but its soooooo slow when you dont have NT.<br /><br />:NaN:</div>
    <div class="meta">Posted on 2002-04-23 17:58:55 by NaN</div>
   </div>
   <div class="post" id="post-34717">
    <div class="subject"><a href="#post-34717">New Control</a></div>
    <div class="body">Ok.. no promises.. cause everything *works* on 9x anyways.  <br /><br />But here is what i think is happening:<br /><br />On WM_CREATE, the lParam == addr CREATESTRUCT.  I use this struct to get info that you specify in the CreateWindowEx.  While all other info menu, size, etc. is being recieved and and stored the *lpName* (I think is not).<br /><br />Before i simply copied the pointer to the string that was to be the caption name.  Now, I've added a buffer on the heap, and am directly copying the contents into the heap (copying the caption string).<br /><br />By trial and error, i found that if i povided a 'hard coded' string handle, the text will display fine on NT.<br /><br />By deduction, im <strong>Guessing</strong> that on NT machines, the <strong>CREATESTRUCT.lpName</strong> is not the actual pointer to the sting passed in CreateWindowEx, but a pointer to a copy in the OS's memory.  So I would then save the pointer to OS memory. Later the OS destroys this data.  So when it comes time to paint, the pointer points to crap (that was once the string).  This is also proven by doing the followin with the original example (for NT people):  Click on the second button, select the AddMenu to 3 option, goto the third button and select the first menu option (Set Text).  In this option I reset the text by passing a <strong>NEW</strong> string pointer using SendMessage.  (before the pointers came by CreateWindowEx).  When you do this on a NT machine you will see that the text becomes corrected and readable.<br /><br />This is my best guess.  As on 98SE, and using softice, i see that the pointer given in the CREATESTRUCT is the actual address the text, and not copied by the OS.<br /><br /><strong>So again, this version has a buffer, and it copies the data as soon as it gets it.  Hopefully this is the fix needed for NT machines.</strong><br /><br />Please Download this and Try it and let me know if it works!<br />Thanx alot!<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-04-23 19:07:30 by NaN</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=4935&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=4935&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="4935" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=4935&amp;page=2">&gt;</a><a href="../?id=4935&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>