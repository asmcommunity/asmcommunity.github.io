<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>CMesh - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=16538" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=38">Object Oriented Programming</a> &raquo; <a href="../?id=16538">CMesh</a></p>
   <div class="post" id="post-128595">
    <div class="subject"><a href="#post-128595">CMesh</a></div>
    <div class="body">This one written for use with Ultrano's oop wrapper..<br />Code has been tested and is working.<br />Written for use in ParticleSystem demo, for loading and rending a mesh used as a full SkySphere (Night and Day SkyDomes)...<br />Note that since we can't use params in the Constructor Method, a secondary Constructor (the Load Method) was required. This must be manually called after instancing the class object. Sorry about the messy coding :tongue:<br />Note also, you must set the FVF in your Render proc before calling this Render Method.<br /><br />;This simple Class contains functionality for Loading and Rendering a Mesh<br /><br />MESH_D3DFVF_CUSTOMVERTEX equ D3DFVF_XYZ or D3DFVF_NORMAL or D3DFVF_TEX1<br /><br />class CMesh<br />        virtual $CMesh<br />        virtual Load<br />        virtual Render<br />        long pMesh<br />        long pMeshMaterials<br />        long pMeshTextures<br />        long dwNumMaterials<br />endclass<br /><br />CMesh_CMesh proc<br />        return ecx<br />CMesh_CMesh endp<br /><br />CMesh_$CMesh proc<br />local i:DWORD<br />local pTextures:DWORD<br />local me:DWORD<br />    mov me,ecx<br />    free .CMesh.pMeshMaterials<br />    .if .CMesh.pMeshTextures != NULL   <br />        m2m pTextures,.CMesh.pMeshTextures<br />        xor eax,eax<br />        mov i,eax<br />        .while eax &lt; .CMesh.dwNumMaterials        <br />            mov ebx,i<br />            shl ebx,2<br />            .if pTextures<br />                mcall pTextures,IUnknown_Release<br />            .endif<br />            inc i<br />            mov ecx,me<br />            mov eax,i<br />        .endw<br />    .endif<br />    free .CMesh.pMeshTextures<br />    mcall .CMesh.pMesh,IUnknown_Release,<br />    Debug CTEXT(&quot;Mesh destroyed OK&quot;,13,10)<br />    ret<br />CMesh_$CMesh endp<br /><br />CMesh_Load proc pD3DDevice, pFilename<br /> local pMaterialsBuffer:LPD3DXBUFFER<br /> local pMesh :LPD3DXMESH<br /> local pmatMaterials:ptr D3DXMATERIAL<br /> local me:DWORD<br /> local i:DWORD<br /> local ErrBuf[256]:BYTE<br />        mov me,ecx              ;Preserve pThis<br /><br />        mov pMesh,NULL<br />        mov pMaterialsBuffer,0<br />        invoke D3DXLoadMeshFromX,pFilename, D3DXMESH_SYSTEMMEM, pD3DDevice, NULL, addr pMaterialsBuffer, addr .CMesh.dwNumMaterials, addr pMesh<br />        .if eax!=D3D_OK <br />                invoke MessageBox,0,CTEXT(&quot;grrrr&quot;),CTEXT(&quot;grrrr&quot;),MB_OK<br />                mov ecx,me<br />                mov eax,NULL<br />                mov .CMesh.pMesh , eax<br />                mov .CMesh.pMeshMaterials ,eax<br />                mov .CMesh.pMeshTextures ,eax<br />                DebugValue addr ErrBuf, CTEXT(&quot;Mesh '%s' failed to load&quot;,13,10), pFilename<br />                ret<br />        .endif<br />        DebugValue addr ErrBuf,CTEXT(&quot;pMeshMaterials=%lX&quot;,13,10),.CMesh.pMeshMaterials<br />        DebugValue addr ErrBuf,CTEXT(&quot;pMeshTextures =%lX&quot;,13,10),.CMesh.pMeshTextures <br /><br />        mcall pMaterialsBuffer,ID3DXBuffer_GetBufferPointer<br />        mov pmatMaterials,eax<br />        <br />    <br />   ; //Create two arrays. One to hold the materials and only to hold the textures<br />        mov ecx,me<br />        mov eax, .CMesh.dwNumMaterials<br />        imul eax,sizeof D3DMATERIAL8<br />        mov .CMesh.pMeshMaterials , malloc (eax)<br />        mov eax, .CMesh.dwNumMaterials<br />        shl eax,2<br />        mov .CMesh.pMeshTextures,malloc (eax)<br /><br />        xor eax,eax<br />        mov i,eax<br />        .while eax &lt; .CMesh.dwNumMaterials<br />                mov ecx,me<br />                mov ebx,.CMesh.pMeshMaterials<br />                mov eax,i<br />                imul eax,sizeof D3DMATERIAL8<br />                add ebx,eax<br />                mov ecx,pmatMaterials        <br />                invoke RtlMoveMemory,ebx,ecx,sizeof D3DMATERIAL8              ;           //Copy the material<br /><br /> ;               //Set the ambient color for the material (D3DX does not do this)<br />                mov ecx,me<br />                mov ebx,.CMesh.pMeshMaterials<br />                mov eax,i<br />                imul eax,sizeof D3DMATERIAL8<br />                add ebx,eax<br />                invoke RtlMoveMemory,addr .D3DMATERIAL8.Ambient  ,addr .D3DMATERIAL8.Diffuse,sizeof D3DMATERIAL8.Diffuse<br />        <br />;                //Create the texture<br />                mov ebx,pmatMaterials<br />                mov ecx,me<br />                mov ecx, .CMesh.pMeshTextures<br />                mov eax,i<br />                shl eax,2<br />                add ecx,eax<br />                invoke D3DXCreateTextureFromFile,pD3DDevice,  .D3DXMATERIAL.pTextureFilename, ecx<br />                .if eax!=D3D_OK          <br />                    mov ecx,me<br />                    mov ecx, .CMesh.pMeshTextures<br />                    mov eax,i<br />                    shl eax,2<br />                    add ecx,eax      <br />                    mov dword ptr,NULL<br />                    DebugValue addr ErrBuf, CTEXT(&quot;Texture '%s' Failed to Load&quot;,13,10),  .D3DXMATERIAL.pTextureFilename<br />                .endif<br />                add pmatMaterials,sizeof D3DXMATERIAL       <br />                inc i<br />                mov ecx,me<br />                mov eax,i<br />        .endw<br /><br />;    //We've finished with the material buffer, so release it<br />    mcall pMaterialsBuffer,IUnknown_Release<br />    <br />;    //Make sure that the normals are setup for our mesh<br />    mov ecx,me<br />    mcall pMesh, ID3DXMesh_CloneMeshFVF,D3DXMESH_MANAGED, MESH_D3DFVF_CUSTOMVERTEX, pD3DDevice, addr .CMesh.pMesh<br />    mcall pMesh,IUnknown_Release<br />    mov ecx,me<br />    invoke D3DXComputeNormals,.CMesh.pMesh, NULL<br />    DebugValue addr ErrBuf, CTEXT(&quot;Mesh '%s' loaded OK&quot;,13,10), pFilename<br />    return S_OK<br />CMesh_Load endp<br /><br />CMesh_Render proc pd3dDevice:DWORD<br />local me:DWORD<br />local i:DWORD<br />local ErrBuf[256]:BYTE<br />local pMaterials:DWORD<br />local pTextures:DWORD<br />local dwNumMaterials:DWORD<br /><br />    mov me,ecx    <br />    assume ecx:nothing<br />    .if .CMesh.pMesh != NULL<br />        xor eax,eax<br />        mov i,eax<br />        m2m pMaterials,.CMesh.pMeshMaterials<br />        m2m pTextures,.CMesh.pMeshTextures <br />        m2m dwNumMaterials,.CMesh.dwNumMaterials<br />        .while eax &lt; dwNumMaterials<br />            mcall pd3dDevice,IDirect3DDevice8_SetMaterial, pMaterials<br />            mov ecx,me<br />            mov eax,i<br />            shl eax,2<br />            mov eax, pTextures<br />            mcall pd3dDevice,IDirect3DDevice8_SetTexture,0, dword ptr    <br />            mov ecx,me<br />            mcall .CMesh.pMesh,ID3DXMesh_DrawSubset,i<br />            add pMaterials,sizeof D3DMATERIAL8<br />            add pTextures,4<br />            inc i<br />            mov eax,i<br />            mov ecx,me<br />        .endw<br />     ;   mcall .CMesh.pMesh,ID3DXMesh_GetNumFaces<br />        ret<br />    .endif<br />    return NULL<br />CMesh_Render endp</div>
    <div class="meta">Posted on 2003-12-21 22:32:08 by Homer</div>
   </div>
  </div>
 </body>
</html>