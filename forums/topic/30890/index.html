<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>TRying to make a loop with invoke printf but it dose not work need help - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=30890" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=115">DOS &amp; BIOS</a> &raquo; <a href="../?id=30890">TRying to make a loop with invoke printf but it dose not work need help</a></p>
   <div class="post" id="post-216036">
    <div class="subject"><a href="#post-216036">TRying to make a loop with invoke printf but it dose not work need help</a></div>
    <div class="body"><pre><code><br />.386<br />.model flat,c<br />.stack 100h<br /><br />includelib msvcrt <br /><br />.data<br />printf proto arg1:ptr byte<br /><br />pointBuffer byte &quot;Welcome&quot;,0<br />pointBuffer2 byte 12 dup(?),0<br />.code<br />public main<br /><br />main proc<br />&nbsp;  <br />&nbsp;  mov ecx,8<br />&nbsp;  mov esi,offset pointBuffer<br />&nbsp;  mov edi,offset pointBuffer2<br />&nbsp;  <br />while1: cmp ecx,0<br />&nbsp; &nbsp; &nbsp; &nbsp; je endloop<br />	mov al,<br />	mov ,al<br />	<br />	inc edi<br />	inc esi<br />	dec ecx<br />	cmp ecx,4<br />	jge takepath1<br />&nbsp; &nbsp; &nbsp; &nbsp; jmp while1<br />endloop: nop<br />takepath1:&nbsp; invoke printf,addr pointBuffer2<br />	jmp while1<br />	ret<br />main endp<br /><br />end main<br /></code></pre><br /><br />im trying to do something so simple and i dont see why i cant have a invoke printf in a loop while having an if statment to execute it and jump back into loop<br /><br /><span style="font-size:8pt><em>Edit by SpooK: added code block</em></span></div>
    <div class="meta">Posted on 2012-06-15 20:57:04 by hellfix</div>
   </div>
   <div class="post" id="post-216037">
    <div class="subject"><a href="#post-216037">Re: TRying to make a loop with invoke printf but it dose not work need help</a></div>
    <div class="body">eax, ecx and edx are volatile registers, and are probably being overwritten by the call to printf, breaking your loop.</div>
    <div class="meta">Posted on 2012-06-16 02:10:19 by Scali</div>
   </div>
   <div class="post" id="post-216038">
    <div class="subject"><a href="#post-216038">Re: TRying to make a loop with invoke printf but it dose not work need help</a></div>
    <div class="body">Right. And, in contrast, esi, edi, and ebx are &quot;non-volatile&quot; (esp and ebp too, but we&#039;re not concerned with them right now). They need to be &quot;preserved&quot;. Hutch didn&#039;t like the term &quot;preserved&quot;. Let&#039;s say: if you alter &#039;em, you have to put &#039;em back the way they were, before your function returns. Failure to do so may cause a crash! Might not, but we&#039;re &quot;supposed&quot; to do it. (the &quot;proc&quot; and &quot;endproc&quot; macros may do this for you?) Since you&#039;re using esi and edi, your choice for a loop counter is pretty obvious. If you have an &quot;abnormal termination&quot;, &quot;preserve&quot; &#039;em!<br /><br />An alternative would be to push and pop ecx around the call to printf.<br /><br />Is &quot;.stack 100h&quot; correct in this context?<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2012-06-16 05:53:16 by fbkotler</div>
   </div>
   <div class="post" id="post-216039">
    <div class="subject"><a href="#post-216039">Re: TRying to make a loop with invoke printf but it dose not work need help</a></div>
    <div class="body"><div class="quote"><br />(the &quot;proc&quot; and &quot;endproc&quot; macros may do this for you?)</div><br /><br />Well, yes and no. I believe you have to explicitly specify the registers to save in the &#039;uses&#039; clause (which depending on your point-of-view is another macro).<br /><br /><div class="quote"><br />Is &quot;.stack 100h&quot; correct in this context?</div><br /><br />I don&#039;t think it does anything. Normally it would create a .stack segment with the given size. But for 32-bit Windows binaries, the PE loader creates the stack for you. So I&#039;m not sure what will happen. Perhaps the assembler will ignore it... or the assembler will emit a .stack section in the obj file, and the linker ignores it. Or perhaps the linker will link it into the PE file, and the PE loader ignores it...<br />At any rate, it is not required.</div>
    <div class="meta">Posted on 2012-06-17 16:19:34 by Scali</div>
   </div>
   <div class="post" id="post-216040">
    <div class="subject"><a href="#post-216040">Re: TRying to make a loop with invoke printf but it dose not work need help</a></div>
    <div class="body">Thanks, Scali! Having any luck, Hellfix?<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2012-06-18 08:07:32 by fbkotler</div>
   </div>
   <div class="post" id="post-216041">
    <div class="subject"><a href="#post-216041">Re: TRying to make a loop with invoke printf but it dose not work need help</a></div>
    <div class="body">can anyone give me some sample code im still having trouble saving the registers and making a call to printf</div>
    <div class="meta">Posted on 2012-06-18 15:20:51 by hellfix</div>
   </div>
   <div class="post" id="post-216042">
    <div class="subject"><a href="#post-216042">Re: TRying to make a loop with invoke printf but it dose not work need help</a></div>
    <div class="body">Easiest way, probably...<br /><pre><code><br />endloop: nop<br />takepath1:<br />&nbsp; &nbsp; &nbsp; &nbsp; push ecx<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke printf,addr pointBuffer2<br />&nbsp; &nbsp; &nbsp; &nbsp; pop ecx<br />	jmp while1<br />; need a label here to jump to when ecx=0?<br />	ret&nbsp; ; never reached?<br /></code></pre><br /><br />That should clear up the problem that the call to printf is trashing your ecx. You still don&#039;t seem to have an exit condition to your loop.<br /><br />Does calling your entrypoint &quot;main&quot; imply that this is called by C startup code? If not, &quot;ret&quot; may not provide a clean &quot;ExitProcess&quot;. If so, you may still need to &quot;preserve&quot; (push/pop) esi and edi. This appears to be 32-bit code. Why is it in the dos/bios section? I may be confused about what you&#039;re trying to do...<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2012-06-18 15:57:31 by fbkotler</div>
   </div>
   <div class="post" id="post-216043">
    <div class="subject"><a href="#post-216043">Re: TRying to make a loop with invoke printf but it dose not work need help</a></div>
    <div class="body">im trying to print half of string being processed by the program then print a final message of the copied string heres what i came up with<br /><br />.386<br />.model flat,c<br />.stack 100h<br /><br />includelib msvcrt <br /><br />.data<br />printf proto arg1:ptr byte<br /><br />pointBuffer byte &quot;Welcome&quot;,0<br />pointBuffer2 byte 12 dup(?),0<br /><br />.code<br />public main<br /><br />main proc<br />&nbsp;  <br />&nbsp;  mov ebx,0<br />&nbsp;  mov esi,offset pointBuffer<br />&nbsp;  mov edi,offset pointBuffer2<br />&nbsp;  <br />while1: cmp ebx,8<br />&nbsp; &nbsp; &nbsp; &nbsp; jge endloop<br />	mov al,<br />	mov ,al<br />	<br />	inc edi<br />	inc esi<br />	inc ebx<br /><br />	cmp ebx,4<br />	je printOnce<br />	<br />&nbsp; &nbsp; &nbsp; &nbsp; jmp while1<br /><br />printOnce: push offset pointBuffer2<br />	call printf<br />	<br />	cmp ebx,4<br />	jbe while1<br />	<br />endloop: nop	<br />	push offset pointBuffer2<br />	call printf<br />	ret<br />main endp<br />end main</div>
    <div class="meta">Posted on 2012-06-18 16:26:33 by hellfix</div>
   </div>
   <div class="post" id="post-216044">
    <div class="subject"><a href="#post-216044">Re: TRying to make a loop with invoke printf but it dose not work need help</a></div>
    <div class="body">First things first... &quot;code tags&quot;. Put the word &quot;code&quot; between &#039;&#91;]&#039;s at the beginning of your code and &quot;/code&quot; between &#039;&#91;]&#039;s at the end of your code. The management thanks you. :)<br /><br /><pre><code><br />.386<br />.model flat,c<br />.stack 100h<br /><br />includelib msvcrt<br /><br />.data<br />printf proto arg1:ptr byte<br /><br />pointBuffer byte &quot;Welcome&quot;,0<br />pointBuffer2 byte 12 dup(?),0<br /><br />.code<br />public main<br /><br />main proc<br /></code></pre><br />I think you&#039;ll want that &quot;uses ebx, esi, edi&quot; here. I&#039;m not sure what the syntax is - right after the &quot;proc&quot; or on a separate line? Try it until Masm doesn&#039;t complain. :) (or RTFM)<br /><pre><code><br />&nbsp;  mov ebx,0<br />&nbsp;  mov esi,offset pointBuffer<br />&nbsp;  mov edi,offset pointBuffer2<br />&nbsp;  <br />while1: cmp ebx,8<br />&nbsp; &nbsp; &nbsp; &nbsp; jge endloop<br /></code></pre><br />Strictly speaking, &quot;jge&quot; is for signed comparisons, &quot;jae&quot; is for unsigned. Won&#039;t hurt.<br /><pre><code><br />&nbsp;  mov al,<br />&nbsp;  mov ,al<br />&nbsp;  <br />&nbsp;  inc edi<br />&nbsp;  inc esi<br />&nbsp;  inc ebx<br /><br />&nbsp;  cmp ebx,4<br />&nbsp;  je printOnce<br /></code></pre><br />Okay... you&#039;ve copied 3 characters - ebx incremented afterwards, remember. Might want 5 here?<br /><pre><code><br />&nbsp; &nbsp; &nbsp; &nbsp; jmp while1<br /><br />printOnce: push offset pointBuffer2<br />&nbsp;  call printf<br /></code></pre><br />Caller&#039;s responsibility to clean up stack!<br /><pre><code><br />&nbsp;  add esp, 4<br />&nbsp;  cmp ebx,4<br />&nbsp;  jbe while1<br /></code></pre><br />We kinda knew it was 4 (or 5) or we wouldn&#039;t be here! An unconditional &quot;jmp&quot; should do here.<br /><pre><code><br />endloop: nop&nbsp;  <br />&nbsp;  push offset pointBuffer2<br />&nbsp;  call printf<br />&nbsp;  add esp, 4 ; clean up stack!<br />&nbsp;  ret<br />main endp<br />end main<br /></code></pre><br />Outside of not &quot;cleaning up the stack&quot; (removing the parameter) after the call to printf, this doesn&#039;t look too bad. Another way to do this would be to &quot;pop&quot; a dummy register (ecx would do, since printf trashes it anyway). Also, I think you want to &quot;preserve&quot; ebx, esi, and edi. &quot;Calling convention&quot;! I think Agner Fog&#039;s got a document on it:<br /><br />http://www.agner.org/optimize/<br /><br />I&#039;m not able to test this. There may be things I don&#039;t see, but I think it&#039;ll work. I think it&#039;ll print &quot;WelWelcome&quot; - might look better with a newline in there...<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2012-06-18 17:31:20 by fbkotler</div>
   </div>
   <div class="post" id="post-216045">
    <div class="subject"><a href="#post-216045">Re: TRying to make a loop with invoke printf but it dose not work need help</a></div>
    <div class="body">This should help<br /><pre><code><br />.386<br />.model flat,c<br /><br />includelib msvcrt <br />printf proto arg1:ptr byte<br /><br />.data<br /><br />pointBuffer&nbsp; &nbsp;  byte&nbsp; &nbsp; &quot;Welcome&quot;,0<br />szNewLine&nbsp; &nbsp; &nbsp;  byte&nbsp; &nbsp; 13, 10 ,0<br />STRLEN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; equ $ - pointBuffer<br /><br />.data?<br />pointBuffer2&nbsp; &nbsp; byte&nbsp; &nbsp; 12 dup(?)<br /><br />.code<br />public main<br /><br />main: <br />&nbsp; &nbsp; push&nbsp; &nbsp; esi<br />&nbsp; &nbsp; push&nbsp; &nbsp; edi<br />&nbsp; &nbsp; push&nbsp; &nbsp; ebx<br />&nbsp; &nbsp; push&nbsp; &nbsp; ebp<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; mov&nbsp; &nbsp;  esi, offset pointBuffer<br />&nbsp; &nbsp; mov&nbsp; &nbsp;  edi, offset pointBuffer2<br />	<br />&nbsp; &nbsp; xor&nbsp; &nbsp;  ebx, ebx<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; mov&nbsp; &nbsp;  ebp, STRLEN<br />&nbsp; &nbsp; shr&nbsp; &nbsp;  ebp, 2<br />while1: <br />&nbsp; &nbsp; mov&nbsp; &nbsp;  al, <br />&nbsp; &nbsp; test&nbsp; &nbsp; al, al<br />&nbsp; &nbsp; jz&nbsp; &nbsp; &nbsp; endloop<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; mov&nbsp; &nbsp;  , al<br />&nbsp; &nbsp; cmp&nbsp; &nbsp;  ebx, ebp<br />&nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; printOnce<br />&nbsp; &nbsp; inc&nbsp; &nbsp;  ebx<br />&nbsp; &nbsp; jmp&nbsp; &nbsp;  while1<br /><br />printOnce: <br />&nbsp; &nbsp; push&nbsp; &nbsp; edi <br />&nbsp; &nbsp; call&nbsp; &nbsp; printf<br />&nbsp; &nbsp; add&nbsp; &nbsp;  esp, 4 * 1<br />&nbsp; &nbsp; inc&nbsp; &nbsp;  ebx<br />&nbsp; &nbsp; jmp&nbsp; &nbsp;  while1<br />&nbsp;  <br />endloop: <br />&nbsp; &nbsp; push&nbsp; &nbsp; offset szNewLine<br />&nbsp; &nbsp; call&nbsp; &nbsp; printf<br />&nbsp; &nbsp; add&nbsp; &nbsp;  esp, 4 * 1<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; push&nbsp; &nbsp; edi<br />&nbsp; &nbsp; call&nbsp; &nbsp; printf<br />&nbsp; &nbsp; add&nbsp; &nbsp;  esp, 4 * 1<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; pop&nbsp; &nbsp;  ebp<br />&nbsp; &nbsp; pop&nbsp; &nbsp;  ebx<br />&nbsp; &nbsp; pop&nbsp; &nbsp;  edi<br />&nbsp; &nbsp; pop&nbsp; &nbsp;  esi<br />&nbsp; &nbsp; ret<br />end main</code></pre></div>
    <div class="meta">Posted on 2012-06-18 20:42:27 by Gunner</div>
   </div>
  </div>
 </body>
</html>