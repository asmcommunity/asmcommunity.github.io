<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>possibly VC7 bug? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=18758" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=18758">possibly VC7 bug?</a></p>
   <div class="post" id="post-145238">
    <div class="subject"><a href="#post-145238">possibly VC7 bug?</a></div>
    <div class="body">i was working forever trying to get the bug out of my MMX effect, however i realised it was  based on bad data entering the effect..<br />so here is the code i used to generate 2 64 bit MMX variables<br />	__m64 lowkey;<br />                __m64 highkey;<br />                <br />                short redlow = (short) m_fRedLow;<br />	short redhigh = (short) m_fRedHigh;<br />	short greenlow = (short) m_fGreenLow;<br />	short greenhigh = (short) m_fGreenHigh;<br />	short bluelow = (short) m_fBlueLow;<br />	short bluehigh = (short)m_fBlueHigh;<br />                lowkey = _mm_set_pi16(-1,redlow,greenlow,bluelow);<br />	highkey = _mm_set_pi16(256,redhigh,greenhigh,bluehigh);<br /><br />HOWEVER it just wouldn't work as it should.. but strangely if i inserted code between assigning the shorts (i.e some debug code to test that those shorts arewhat they should be, or even unrelated code) it would 'magically' work<br />perplexed me soo much. so i compiled to assembly to see what would happen. it seemed if i had the code as above VC optomised it without using shorts to store it converting from the float point on the fly the same like:<br /><br />                lowkey = _mm_set_pi16(-1,(short) m_fRedLow,(short)m_fGreenLow,(short) m_fBlueLow);<br /><br />and apparenty the intrinsic is buggy like this..<br />however if i put code in between, it first converts teh floating points to shorts , stores them on teh stack, and when the instrict is being run, its just getting the already shortened (pun) shorts and works perfectly..<br /><br /><br />Here is an assembler snippet WITHOUT something in between<br /><br />; 226  : 		lowkey = _mm_set_pi16(-1,redlow,greenlow,bluelow);<br /><br />	fld	DWORD PTR <br />	imul	eax, DWORD PTR <br />	push	edi<br />	mov	DWORD PTR _numpixels$, eax<br />	call	__ftol2<br />	mov	WORD PTR tv235, ax<br />	fld	DWORD PTR <br />	call	__ftol2<br />	fld	DWORD PTR <br />	mov	WORD PTR tv235, ax<br />	call	__ftol2<br />	mov	WORD PTR tv235, ax<br />	mov	WORD PTR tv235, -1<br />	movq	mm0, MMWORD PTR tv235<br />	movq	MMWORD PTR _lowkey$, mm0<br /><br />; 227  : 	    highkey = _mm_set_pi16(256,redhigh,greenhigh,bluehigh);<br /><br />	fld	DWORD PTR <br />	call	__ftol2<br />	fld	DWORD PTR <br />	mov	WORD PTR tv219, ax<br />	call	__ftol2<br />	fld	DWORD PTR <br />	mov	WORD PTR tv219, ax<br />	call	__ftol2<br /><br />acutally there is more here i forgot to paste in , how however its the same as 226's one which ends in 227.. so you can just see<br />how 226 is buggy <br /><br />and here is the snippet if i put something in between (this is the one which works as it should) <br />where this is the C++ code that is put in between <br />                DWORD* pDest ;<br />	DWORD* pSource1, *pSource2;<br />	pSource1 = (DWORD*)ppInput[0]-&gt;GetBuffer();	<br />	pSource2 = (DWORD*)ppInput[1]-&gt;GetBuffer();	<br />	<br />and here is the assembler<br /><br />; 186  : 	short redlow = (short) m_fRedLow;<br /><br />	fld	DWORD PTR <br />	imul	eax, DWORD PTR <br />	push	edi<br />	mov	DWORD PTR _numpixels$, eax<br />	call	__ftol2<br /><br />; 187  : 	short redhigh = (short) m_fRedHigh;<br /><br />	fld	DWORD PTR <br />	mov	edi, eax<br />	call	__ftol2<br /><br />; 188  : 	short greenlow = (short) m_fGreenLow;<br /><br />	fld	DWORD PTR <br />	mov	DWORD PTR _redhigh$, eax<br />	call	__ftol2<br /><br />; 189  : 	short greenhigh = (short) m_fGreenHigh;<br /><br />	fld	DWORD PTR <br />	mov	DWORD PTR _greenlow$, eax<br />	call	__ftol2<br /><br />; 190  : 	short bluelow = (short) m_fBlueLow;<br /><br />	fld	DWORD PTR <br />	mov	DWORD PTR _greenhigh$, eax<br />	call	__ftol2<br /><br />; 191  : 	short bluehigh = (short)m_fBlueHigh;<br /><br />	fld	DWORD PTR <br />	mov	DWORD PTR _bluelow$, eax<br />	call	__ftol2<br />; 223  : 	DWORD* pDest ;<br />; 224  : 	DWORD* pSource1, *pSource2;<br />; 225  : 	pSource1 = (DWORD*)ppInput[0]-&gt;GetBuffer();	<br /><br />	mov	ecx, DWORD PTR _ppInput$<br />	mov	ecx, DWORD PTR <br />	mov	edx, DWORD PTR <br />	mov	esi, eax<br />	call	DWORD PTR <br />	mov	DWORD PTR _pSource1$, eax<br /><br />; 226  : 	pSource2 = (DWORD*)ppInput[1]-&gt;GetBuffer();	<br /><br />	mov	eax, DWORD PTR _ppInput$<br />	mov	ecx, DWORD PTR <br />	mov	edx, DWORD PTR <br />	call	DWORD PTR <br /><br />; 231  : 		lowkey = _mm_set_pi16(-1,redlow,greenlow,bluelow);<br /><br />	mov	cx, WORD PTR _greenlow$<br /><br />; 232  : 	    highkey = _mm_set_pi16(256,redhigh,greenhigh,bluehigh);<br /><br />	mov	dx, WORD PTR _greenhigh$<br />	mov	DWORD PTR _pSource2$, eax<br />	movzx	eax, WORD PTR _bluelow$<br />	mov	WORD PTR tv184, ax<br />	movzx	eax, WORD PTR _redhigh$<br />	mov	WORD PTR tv184, cx<br /><br />; 233  : <br />; 234  : 	<br />; 235  : 	<br />; 236  : 	pDest = (DWORD*)pOutput-&gt;GetBuffer();		<br /><br />	mov	ecx, DWORD PTR _pOutput$<br />	mov	WORD PTR tv184, di<br />	mov	WORD PTR tv184, -1<br />	movq	mm0, MMWORD PTR tv184<br />	mov	WORD PTR tv179, dx<br />	mov	edx, DWORD PTR <br />	mov	WORD PTR tv179, ax<br />	movq	MMWORD PTR _lowkey$, mm0<br />	mov	WORD PTR tv179, si<br />	mov	WORD PTR tv179, 256		; 00000100H<br />	movq	mm0, MMWORD PTR tv179<br />	movq	MMWORD PTR _highkey$, mm0<br /><br />..<br />you can definately see the difference<br />i don'treally know the asm floating point instructions so maybe somebody who knows can work out what vc7 is doing wrong in the first example<br />and maybe somebody can tell me how i submit a bug to microsoft?<br /><br />Cheers,<br /><br />karl</div>
    <div class="meta">Posted on 2004-07-01 20:37:24 by klumsy</div>
   </div>
   <div class="post" id="post-145245">
    <div class="subject"><a href="#post-145245">possibly VC7 bug?</a></div>
    <div class="body">somebody on #coders narrowed down the problem for me..<br /><br />silly msvc++ optomises its instrict, mixing in floating point code.. thus MMX and floating point code in the same place before EMMS...<br />not a nice situation.<br /><br />anybody know how i can report this to microsoft?</div>
    <div class="meta">Posted on 2004-07-01 21:56:30 by klumsy</div>
   </div>
   <div class="post" id="post-145304">
    <div class="subject"><a href="#post-145304">possibly VC7 bug?</a></div>
    <div class="body"><a target="_blank" href="http://support.microsoft.com/">http://support.microsoft.com/</a></div>
    <div class="meta">Posted on 2004-07-02 19:59:24 by comrade</div>
   </div>
  </div>
 </body>
</html>