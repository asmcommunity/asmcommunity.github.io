<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Saving Custom CLI to memory and retrieving - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=29674" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=29674">Saving Custom CLI to memory and retrieving</a></p>
   <div class="post" id="post-209518">
    <div class="subject"><a href="#post-209518">Saving Custom CLI to memory and retrieving</a></div>
    <div class="body">ok this is test code.. what I am trying to do is have 8 command line buffers so that when i press up or down arrow it will load the appropriate command line. but I&#039;m having trouble saving them and retrieving them. I&#039;m pretty sure address 0x9400:0x0000 is safe, but i could be wrong. This is in stage two, real mode. Each buffer is 64 bytes long. total of 512 bytes for the buffer, and an additional 16 bytes for other temporary data. (will be 4MiB for protected mode... don&#039;t ask). I&#039;ve tried various ways of doing this and thought I had this memory issue working with another problem i had before. Everything goes fine until I add the code below the dashes. Not sure exactly what I&#039;m doing wrong. Still waiting on books...&nbsp; :sad:<br /><br />i have chosen not to echo the inputs... yet. I would think it would still work.. a far as saving the values in memory. I then will print out the value in memory after I know it&#039;s saving. but as far as I can tell it&#039;s not getting to the ret... my very next call is to a function i know that works and continues to work if I omit this function entirely... but maybe I&#039;m not pushing or popping right. Any help would be appreciated... if you need other code segments let me know.<br /><br /><br /><pre><code>keyboard_buffers_segment&nbsp; &nbsp;  dw 0x9400<br /><br />getc:<br />mov&nbsp;  AH, 00h<br />int&nbsp;  16h<br />ret<br /><br />get_command:<br />&nbsp; call&nbsp; getc<br />&nbsp; cmp&nbsp;  AL, 00h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Is this a special funtion?<br />&nbsp; jz&nbsp; &nbsp; get_command&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;If it is ignore and continue<br />&nbsp; cmp&nbsp;  AL, 0Dh&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Enter Key Pressed<br />;-----------------------------------------------------------------------------<br />&nbsp; mov&nbsp;  SI, 0x00&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; set SI to 0x00<br />&nbsp; mov&nbsp;  DS, &nbsp; &nbsp; &nbsp; &nbsp; ;set Data Segment to 0x9400<br />&nbsp; mov&nbsp;  , AL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;write AL to <br />&nbsp; inc&nbsp; SI&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;increment SI so we write to next position<br />&nbsp; jne&nbsp;  get_command&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Continue if enter not pressed<br />&nbsp; ret</code></pre>	</div>
    <div class="meta">Posted on 2009-11-06 19:28:10 by Goose007</div>
   </div>
   <div class="post" id="post-209519">
    <div class="subject"><a href="#post-209519">Re: Saving Custom CLI to memory and retrieving</a></div>
    <div class="body">Progress????<br /><br />much to my dismay i looked elsewhere and could find anything helpful that worked. I even tried the following code. it kinda works... except I still can&#039;t tell if it&#039;s going to the right place... is there a surefire way to print out an address in memory before and after to see if I&#039;m at least changing it?&nbsp; notice I commented out the putc call<br /><br /><pre><code>get_command:<br />	<br />	xor	CL, CL<br /> 	mov	AX, <br /> 	mov	ES, AX<br /> 	xor	AX, AX<br />&nbsp; 	mov	DI, AX<br />	.loop:<br />		call getc<br /> 		<br /> 		cmp al, 0x08				; backspace pressed?<br />&nbsp;  		je .backspace				; yes, handle it<br /> <br />&nbsp;  		cmp al, 0x0D				; enter pressed?<br />&nbsp;  		je .done					; yes, we&#039;re done<br /> <br />		cmp cl, 0x3F&nbsp; 				; 63 chars inputted?<br />&nbsp;  		je .loop					; yes, only let in backspace, enter or delete<br /> <br />;		call putc&nbsp;  			; print out character<br /> <br />		stosb&nbsp; 					; put character in buffer<br />		inc cl<br />		jmp .loop<br /> <br />		.backspace:<br />			cmp cl, 0				; beginning of string?<br />&nbsp;  			je .loop				; yes, ignore the key<br /> <br />			dec di<br />			mov byte , 0		; delete character<br />			dec cl				; decrement counter as well<br /> <br />			mov ah, 0x0E<br />			mov al, 0x08<br />			int 10h				; backspace on the screen<br /> <br />			mov al, &#039; &#039;<br />			int 10h				; blank character out<br /> <br />			mov al, 0x08<br />			int 10h				; backspace again<br /> <br />		jmp .loop					; go to the main loop<br /> <br />		.done:<br />			mov al, 0				; null terminator<br />			stosb<br /> <br />			mov	ah, 0x0E<br />			mov	al, 0x0D<br />			int	0x10<br />			mov	al, 0x0A<br />			int	0x10				; newline<br /> 		ret</code></pre></div>
    <div class="meta">Posted on 2009-11-06 22:10:00 by Goose007</div>
   </div>
   <div class="post" id="post-209522">
    <div class="subject"><a href="#post-209522">Re: Saving Custom CLI to memory and retrieving</a></div>
    <div class="body">Well... the most obvious problem with your first attempt is that you were setting si to zero every time through the loop. You increment it after saving the character, but then set it back to zero next time through, so everything was being saved to 9400h:0!<br /><br />Your second attempt proves you know how to handle backspace, at least. :) It looks like it should work... for one command, at least. For a &quot;command line history&quot;, you probably want to pass the buffer address as a parameter to &quot;get_command&quot;, rather than explicitly set di within the routine. You may want to pass the segment as a parameter, too(?). It might be simpler to get it working with everything in one segment - I find that 64k is a &quot;lot&quot; of room. If you&#039;re going to put your buffers in a separate segment, you may want to put ds/es back the way they were before returning from the routine(?).<br /><br />You didn&#039;t write &quot;gets()&quot; - you check to see that a character will fit in the buffer before saving it. Excellent! (&quot;gets()&quot; needs to be &quot;terminated with extreme predjudice&quot;... and its head mounted on a pike!) The way you&#039;re doing it, the buffer may not be zero-terminated. I think the way I dealt with that was to zero-terminate the buffer after every character was added, whether I was &quot;done&quot; or not (but, of course, making sure there was room in the buffer first!). It gets quite complicated - especially when you get to handling &quot;insert&quot; (if you&#039;re going to). Making sure you&#039;re not at the beginning of the buffer before doing &quot;backspace&quot; is a good start!<br /><br />I started out with a simple &quot;get string&quot; (respecting the buffer length, of course!), and started adding features... right and left arrow keys, overwrite/insert (toggled with the insert key... with a changed cursor to indicate current mode). To implement &quot;command line history&quot;, I wanted to be able to display a &quot;default string&quot; (editable), and handle up and down arrows. But I didn&#039;t want to always handle up/down, so I used a zero-terminated array of &quot;extra keys to cause early termination&quot;, besides the usual 0Dh... It has gotten horribly convoluted!<br /><br />As far as &quot;writing what you saved&quot; (or not)... the bytes do get saved (unless there&#039;s a CPU bug), but the question is &quot;where?&quot;. The same question arises when you go to print it - &quot;mov al, &quot; and int 10h/0Eh will print something from somewhere. If you&#039;re storing it with &quot;stosb&quot;, you might want &quot;mov al, &quot;... But if you make the same mistake both times, it might appear to work, but might not be storing where you intend. The main rule would be &quot;pay attention to your segment registers&quot;, I guess.<br /><br />If you temorarily replaced &quot;putc&quot; with a special routine that independently printed &quot;where you expect this stuff to be&quot;, it might help(?).<br /><br />call get_command<br /><br />push ds<br />mov ax, <br />mov ds, ax<br />xor si, si<br />mov ah, 0Eh<br />mov bx, 7<br />.top:<br />lodsb<br />cmp al, 0<br />jz .done<br />int 10h<br />jmp short .top<br />.done<br />pop ds<br />...<br /><br />Or so...<br /><br />Might as well put &quot;putc&quot; back, since you&#039;re printing something for &quot;backspace&quot; and a CR/LF at the end...<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2009-11-07 05:02:04 by fbkotler</div>
   </div>
  </div>
 </body>
</html>