<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>ALIGN Directive - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=10109" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=10109">ALIGN Directive</a></p>
   <div class="post" id="post-75702">
    <div class="subject"><a href="#post-75702">ALIGN Directive</a></div>
    <div class="body">Since FASM doesn't support an ALIGN directive directly, I used the macro example<br />given in the manual, i.e.,<br /><br />		macro align value { rb (value-1)-($+value-1) mod value }<br /><br />However, when I compile some code that invokes this macro, I wind up<br />getting the following error:<br /><br />flat assembler  version 1.43<br />t.consts.inc [2] align [0]:<br />                align   4<br />error: invalid use of symbol.<br /><br />Here's the relevant code:<br /><br />t.asm:<br /><br />		format	MS COFF<br /><br /><br />offset32	equ	 <br />ptr	equ	 <br />		macro align value { rb (value-1)-($+value-1) mod value }<br /><br />ExceptionPtr__hla_	equ	dword <br /><br />		include	't.extpub.inc'<br /><br /><br /><br /><br />		section	'data' data readable writeable executable<br />		include	't.data.inc'<br /><br />		section	'data' data readable writeable executable<br />		include	't.bss.inc'<br /><br />		section	'code' code readable executable<br />		include	't.consts.inc'<br /><br />		section	'code' code readable executable<br />		include	't.ro.inc'<br /><br />		section	'code' code readable executable<br /><br /><br /><br />t.consts.inc:<br /><br /><br />		align	4        ;;;;This is the line the assembler complains about!<br />		label	L857_len__hla_ dword<br />		dd	0dh<br />		dd	0dh<br />		label	L857_str__hla_ byte<br />		db	&quot;Hello World&quot;,00dh,00ah,0<br />		db	0<br />		db	0<br /><br /><br />Any idea what FASM is complaining about here?<br />BTW, as a future enhancement, I'd recommend the inclusion of a true ALIGN<br />directive in the assembler.  Relying on the macro may create problems.  Further,<br />I don't know if ALIGN works properly in STRUCTs, but clearly a directive built into<br />the assembler could work there as well.</div>
    <div class="meta">Posted on 2003-01-11 16:54:46 by rhyde</div>
   </div>
   <div class="post" id="post-75709">
    <div class="subject"><a href="#post-75709">ALIGN Directive</a></div>
    <div class="body">This is because in COFF format addresses are not absolute, and therefore you can only align relatively to the beginning of section. You can put the following two macros at the beginning of your code to get such result:<br /><pre><code><br />macro section params<br /> &#123; section params<br />   align_origin = $ &#125;<br />macro align value &#123; rb &#40;value-1&#41;-&#40;$-align_origin+value-1&#41; mod value &#125;<br /></code></pre><br />I've done it this way, because I think that the programmer should decide in what way he want to align, on his own responsibility, because only the programmer truly knows (at least should know) in what way his code will be loaded into memory.</div>
    <div class="meta">Posted on 2003-01-11 17:07:19 by Tomasz Grysztar</div>
   </div>
   <div class="post" id="post-75832">
    <div class="subject"><a href="#post-75832">ALIGN Directive</a></div>
    <div class="body">Originally posted by Privalov:<br /><br />This is because in COFF format addresses are not absolute, and therefore you can only align relatively to the beginning of section. <br />You can put the following two macros at the beginning of your code to get such result:<br /><pre><code><br />macro section params<br /> &#123; section params<br />   align_origin = $ &#125;<br />macro align value &#123; rb &#40;value-1&#41;-&#40;$-align_origin+value-1&#41; mod value &#125;<br /></code></pre><br />I've done it this way, because I think that the programmer should decide in what way he want to align, on his own responsibility, because only the programmer truly knows (at least should know) in what way his code will be loaded into memory.<br />&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;<br /><br />I'm not 100% convince that this works in all cases.<br />It works great if you have only one instance of each named section,<br />but FASM still complains if you do something like the following:<br /><br />          section '.data' data readable writeable<br />data_origin = $<br /><br />          section '.text' code readable executeable<br />code_origin = $<br /><br />          section '.data' data readable writeable<br />          rb         3 - ($-data_origin+3) mod 4<br /><br />(it returns the same error as before)<br /><br />On further reflection, I'm not sure how this could work anyway.<br />After all, data_origin is not guaranteed to be at offset zero within<br />the section (i.e., I could link with another module that also has<br />a '.data' section and the placement of &quot;data_origin&quot; would be at the<br />mercy of the linker).  The *best* this could do is align whatever follows<br />the &quot;rb&quot; directive relative to the beginning of this particular portion<br />of the section;  of course, that's not the intent, the intent is to ensure<br />that the following object is dword aligned in memory.  Should the<br />linker choose to relocate this portion of the (overall) section at an<br />odd address, the &quot;rb&quot; statement above would leave it at an odd address.<br /><br />Since MASM does this for OMF and COFF files, TASM does this for OMF,<br />and Gas does it for a whole variety of file formats (including ELF), I would<br />assume that it's perfectly possible for FASM to do this as well.<br />Expecting the end programmer to understand object module formats and<br />their ramifications for something as commonly used as an ALIGN directive<br />is probably expecting too much from your audience.  One of the main reasons<br />for using an assembler in the first place is to abstract this kind of stuff away.<br />It seems to me that the vast majority of programmers don't care and don't<br />want to know the low-level details of how their code is loaded into memory.<br />Forcing them to figure this out for something as common as the need to align<br />some object on a given boundary is problematic at best.<br /><br />I'm working with the output of a compiler and I've got more latitude than<br />most with respect to what I'm willing to do (since I generally have to do it<br />only once), but what's needed here is a general solution that doesn't change<br />just because you reassemble the code for a different object module format.<br /><br />As I said, I'm willing to play some games with the output of my compiler,<br />but the current solution doesn't seem to work.  Any other suggestions?<br />Randy Hyde</div>
    <div class="meta">Posted on 2003-01-12 10:34:39 by rhyde</div>
   </div>
   <div class="post" id="post-75846">
    <div class="subject"><a href="#post-75846">ALIGN Directive</a></div>
    <div class="body">You have misunderstood me. Your code:<br /><pre><code><br />section '.data' data readable writeable<br />data_origin = $<br /><br />section '.text' code readable executeable<br />code_origin = $<br /><br />section '.data' data readable writeable<br />rb 3 - &#40;$-data_origin+3&#41; mod 4<br /></code></pre><br />is different from a solution I've proposed. I you use that two macros I've posted, this code:<br /><pre><code><br />section '.data' data readable writeable<br /> ; ...<br />section '.text' code readable executeable<br /> ; ...<br />section '.data' data readable writeable<br /> ; ...<br /> align 4<br /> ; ...<br /></code></pre><br />will become:<br /><pre><code><br />section '.data' data readable writeable<br />align_origin = $<br /> ; ...<br />section '.text' code readable executeable<br />align_origin = $<br /> ; ...<br />section '.data' data readable writeable<br />align_origin = $<br /> ; ...<br /> rb &#40;4-1&#41;-&#40;$-align_origin+4-1&#41; mod 4<br /> ; ...<br /></code></pre><br />And this is working correctly<br /><div class="quote"><br />After all, data_origin is not guaranteed to be at offset zero within<br />the section (i.e., I could link with another module that also has<br />a '.data' section and the placement of &quot;data_origin&quot; would be at the<br />mercy of the linker). <br /></div><br />And that's exactly what I had meant when I said it's programmers responsibility to make alignment macros suitable for your appliance.</div>
    <div class="meta">Posted on 2003-01-12 11:43:39 by Tomasz Grysztar</div>
   </div>
   <div class="post" id="post-76002">
    <div class="subject"><a href="#post-76002">ALIGN Directive</a></div>
    <div class="body"><span style="font-size:9px>Originally posted by Randall Hyde</span> <br /><div class="quote">It seems to me that the vast majority of programmers don't care and don't<br />want to know the low-level details of how their code is loaded into memory.</div> <br /><br />With all the respect Mr. Hyde, I think you are wrong on this point. I prefer FASM to MASM exactly for this reason. I do not want the assembler taking decisions in my name.;)<br /><br />MASM is good in *helping* the programmers and it is free, so there is no sense in clonning it. <br /><br />Best Regards,</div>
    <div class="meta">Posted on 2003-01-13 05:58:55 by pelaillo</div>
   </div>
   <div class="post" id="post-76009">
    <div class="subject"><a href="#post-76009">ALIGN Directive</a></div>
    <div class="body"><div class="quote"><br /><span style="font-size:9px>Originally posted by Randall Hyde</span> <br /> <br /><br />With all the respect Mr. Hyde, I think you are wrong on this point. I prefer FASM to MASM exactly for this reason. I do not want the assembler taking decisions in my name.;)<br /><br />MASM is good in *helping* the programmers and it is free, so there is no sense in clonning it. <br /><br />Best Regards, </div><br /><br /><br />I fully agree if pelaillo.</div>
    <div class="meta">Posted on 2003-01-13 06:52:32 by bazik</div>
   </div>
   <div class="post" id="post-76019">
    <div class="subject"><a href="#post-76019">ALIGN Directive</a></div>
    <div class="body"><strong></strong><br />Me too, fully.. although I think FASM should have a built-in ALIGN directive. Then it's up to the programmer to provide a true alignment correspondent to at least the maximum alignment specified in any ALIGN used in the source.<br /><br />Also, I think it should have true nestable block comments.. but I'm not saying nothing new. :)</div>
    <div class="meta">Posted on 2003-01-13 07:17:58 by Maverick</div>
   </div>
   <div class="post" id="post-76141">
    <div class="subject"><a href="#post-76141">ALIGN Directive</a></div>
    <div class="body"><div class="quote"><br /><span style="font-size:9px>Originally posted by Randall Hyde</span> <br /> <br /><br />With all the respect Mr. Hyde, I think you are wrong on this point. I prefer FASM to MASM exactly for this reason. I do not want the assembler taking decisions in my name.;)<br /><br />MASM is good in *helping* the programmers and it is free, so there is no sense in clonning it. <br /><br />Best Regards, </div><br /><br /><br />Just a few comments:<br /><br />(1) MASM is not free.  In the sense that I cannot include it with a CD-ROM accompanying<br />a book that teaches assembly via HLA.  FASM looks like a possible solution assuming<br />I can get this ALIGN issue resolved.<br /><br />(2) There are political reasons why people don't want to use MASM.  I don't particularly<br />agree with those reasons, but I don't want that to be an impediment against the use<br />of HLA;  again, I'm looking for an alternate to MASM in the Win32 world (and Gas just<br />isn't it;  NASM still isn't quite ready for use as an HLA intermediate processor).<br /><br />(3) Adding an ALIGN directive would no more be cloning MASM than adding the MOV<br />instruction :-).  Considering that *most* people use assembly (or think they use<br />assembly) in order to write fast code, it's hard to believe that FASM doesn't support<br />a built-in ALIGN directive since aligning data and code is a common operation.<br /><br />Personally, I wouldn't want to work on a MASM clone either (though I could definitely<br />argue that creating a free, open-source, MASM/TASM clone would be popular project, given<br />the large amount of MASM/TASM source code out there).  But MASM did get a couple of<br />things right (like EXTERNDEF) and a wise designer considers the success and failures<br />of competing products.  ALIGN, in its final form in MASM, is a very *good* thing.<br /><br />I fail to see how the assembler is making any decisions for you when you tell it you<br />want the following object aligned on a given boundary.  Indeed, I would argue<br />(from the original NASM point of view) that FASM already makes a lot of decisions<br />for you (such as whether to use the short or long form for displacements in an<br />instruction; another *very* good thing).  FASM has to choose the appropriate opcode<br />for ambiguous instructions (e.g., MOV EAX, ECX).  Deciding *how* to pad memory in<br />order to align a data or code object is really no different on the scale of decisions the<br />assembler has to make for you.<br /><br />Randy Hyde</div>
    <div class="meta">Posted on 2003-01-13 21:18:24 by rhyde</div>
   </div>
   <div class="post" id="post-76147">
    <div class="subject"><a href="#post-76147">ALIGN Directive</a></div>
    <div class="body">I always wanted a directive like ALIGN, but more... for example, I need to align code on an 16 + 4 boundary. Some silly code works best that way, or is it the silly processor? :)</div>
    <div class="meta">Posted on 2003-01-13 21:32:57 by bitRAKE</div>
   </div>
   <div class="post" id="post-76153">
    <div class="subject"><a href="#post-76153">ALIGN Directive</a></div>
    <div class="body"><div class="quote"><br />You have misunderstood me. Your code:<br /><pre><code><br />section '.data' data readable writeable<br />data_origin = $<br /><br />section '.text' code readable executeable<br />code_origin = $<br /><br />section '.data' data readable writeable<br />rb 3 - &#40;$-data_origin+3&#41; mod 4<br /></code></pre><br />is different from a solution I've proposed. I you use that two macros I've posted, this code:<br /><pre><code><br />section '.data' data readable writeable<br /> ; ...<br />section '.text' code readable executeable<br /> ; ...<br />section '.data' data readable writeable<br /> ; ...<br /> align 4<br /> ; ...<br /></code></pre><br />will become:<br /><pre><code><br />section '.data' data readable writeable<br />align_origin = $<br /> ; ...<br />section '.text' code readable executeable<br />align_origin = $<br /> ; ...<br />section '.data' data readable writeable<br />align_origin = $<br /> ; ...<br /> rb &#40;4-1&#41;-&#40;$-align_origin+4-1&#41; mod 4<br /> ; ...<br /></code></pre><br />And this is working correctly<br /><br />And that's exactly what I had meant when I said it's programmers responsibility to make alignment macros suitable for your appliance. </div><br /><br /><br />Well, you'll have to excuse my misunderstanding of how the underlying MS COFF<br />format works.  Never before have I needed to know the relocatable object code<br />format an assembler produces in order to use that assembler :-)<br /><br />I'm still having problems with your code.<br />consider the following FASM example:<br /><br /><br /><br />		format	MS COFF<br /><br /><br />		section	'.data' data readable writeable<br />align_origin = $<br /><br />var1		db	?<br />var2		dw	?<br />			rb (4-1)-($-align_origin+4-1) mod 4<br />var4		dd	?<br />var1_2		db	?<br /> <br /><br />		section	'.text' code readable executable<br />align_origin = $<br /><br />                                ; Junk added just to change the code PC:<br /><br />		mov		eax, ebx<br />		nop<br />		<br />		section	'.data' data readable writeable<br />align_origin = $<br />                                ;Okay, let's align var4_2 on a 64-byte boundary:<br /><br />		rb (40h-1)-($-align_origin+40h-1) mod 40h<br />var4_2		dd	?<br /> <br /><br />		section	'.text' code readable executable<br />		public	rtnadrs4<br /><br />; Quick function that returns the address of Var4 so I can display it:<br /><br />rtnadrs4:<br />		lea	eax, <br />		ret<br />		<br />		public	rtnadrs42<br /><br />; Quick function for displaying the address of var4_2 so I can display it.<br /><br />rtnadrs42:<br />		lea	eax, <br />		ret		<br />		<br />		public	aorigin<br /><br />; This function returns the last value of align_origin (to compare with var4_2's address):<br /><br />aorigin:<br />		mov	eax, align_origin<br />		ret<br /><br /><br /><br /><br /><br /><br />I called the three functions above from the following HLA code:<br /><br /><br />program t;<br />#include( &quot;stdlib.hhf&quot; )<br /><br />procedure rtnadrs4; @external;<br />procedure rtnadrs42; @external;<br />procedure aorigin; @external;<br /><br />begin t;<br /><br />	call rtnadrs4;<br />	stdout.put( &quot;adrs1=&quot;, eax, nl );<br />	call rtnadrs42;<br />	stdout.put( &quot;adrs2=&quot;, eax, nl );<br />	call aorigin;<br />	stdout.put( &quot;origin=&quot;, eax, nl );<br />			<br />end t;<br />	       <br /><br />Here's the output I got:<br /><br />adrs1=0400_2004<br />adrs2=0400_2010<br />origin=0400_2010<br /><br />The address for var4 (adrs1 output) is reasonable and expected.<br />The address for var4_2 (adrs2 output) is unexpected and not at all what I intended<br />(it should be 0400_2040 if I've understood what your code is supposed to be doing and<br />I've adapted it correctly).<br /><br />The final value for align_origin (origin output) is also unexpected.<br />Intuition suggests that this should have the value 0400_2009 (unless the linker<br />just happened to find and sneak in some other .data section that was exactly seven<br />bytes long, possible, but I doubt this occurred).  Does FASM automatically align each<br />new section on a 16-byte boundary? (shades of DOS segments!)<br /><br />Now I believe I've followed your directions (I could have screwed up somewhere, though),<br />yet I'm still unable to align an object on a desired boundary.<br /><br />Again, I don't consider myself to be a beginner at this sort of stuff (though I will gladly<br />admit that I don't know the in's and out's of COFF, even though I have looked at it in<br />the past).  If *I'm* having problems getting stuff like this to work, imagine the problems<br />that others are going to have.  I argue that this speaks *volumes* about the need for<br />an ALIGN directive within FASM.  It's not like aligning data and code is an uncommon<br />operation in assembly language :-)<br /><br />In the meantime, this is the only impediment I've encountered thus far that is<br />preventing me from generating FASM code from HLA;  so a workable solution that<br />lets me align objects to a boundary (actually, I limit it to a power of two in HLA IIRC)<br />would be great.  Given that COFF sections are aligned on 4096 byte page boundaries<br />in memory, one should be able to align to any boundary up to that limit.<br /><br />Thanks for any help you can provide,<br />Randy Hyde</div>
    <div class="meta">Posted on 2003-01-13 22:00:32 by rhyde</div>
   </div>
   <div class="post" id="post-76194">
    <div class="subject"><a href="#post-76194">ALIGN Directive</a></div>
    <div class="body"><div class="quote"><br />align_origin = $<br />;Okay, let's align var4_2 on a 64-byte boundary:<br /><br />rb (40h-1)-($-align_origin+40h-1) mod 40h<br /></div><br />This actually does nothing, because $ is already 0, which is aligned to every possible value.<br /><br /><div class="quote"><br />Does FASM automatically align each<br />new section on a 16-byte boundary?<br /></div><br />In object formats like COFF sections are not yet aligned. So it's a matter of linker (I can't guarantee anything about linker).<br />And if FASM aligns sections to any boundary in executable formats, it's exactly said in the documentation, what is the value of that boundary.</div>
    <div class="meta">Posted on 2003-01-14 02:33:20 by Tomasz Grysztar</div>
   </div>
   <div class="post" id="post-76207">
    <div class="subject"><a href="#post-76207">ALIGN Directive</a></div>
    <div class="body"><div class="quote"><br />I always wanted a directive like ALIGN, but more... for example, I need to align code on an 16 + 4 boundary. Some silly code works best that way, or is it the silly processor? :) </div>Did you see my align (with alignment and alignmentoffset) NASM and FAsm macros? :)<br />It was in some thread.. I'm not at home now, if you don't find it, I'll just send them when I'm back.</div>
    <div class="meta">Posted on 2003-01-14 03:45:33 by Maverick</div>
   </div>
   <div class="post" id="post-76230">
    <div class="subject"><a href="#post-76230">ALIGN Directive</a></div>
    <div class="body"><strong></strong><br />For FASM:<br /><br /><pre><code><br />; Offset must be &gt; -Alignment and &lt; Alignment. You can omit the Offset parameter &#40;i.e. = 0&#41;.<br />MACRO                           ALIGN           Alignment,Offset &#123;<br />   IF &lt;Offset&gt; EQ &lt;&gt;<br />   REPEAT &#40;Alignment-1&#41;-&#40;&#40;$+Alignment-1&#41; mod Alignment&#41;<br />                                NOP            ; DB 0 if you prefer<br />   END REPEAT<br />   ELSE<br />   REPEAT &#40;Alignment-1&#41;-&#40;&#40;$+Alignment-Offset-1&#41; mod Alignment&#41;<br />                                NOP            ; DB 0 if you prefer<br />   END REPEAT<br />   END IF<br />&#125;<br /></code></pre><br />When I get some time there's definitely something I must finish to develop for my compiler's x86 back-end: a full-blown ALIGN statement.<br />That is, besides alignment and alignment offset, it has to produce ASM instructions other than NOP, to fill the required gap.<br /><br />Just to make some examples:<br /><pre><code><br />1 byte&#58;<br />$90 - NOP<br /><br />2 bytes&#58;<br />$8B $C0 - MOV EAX,EAX<br />$8B $DB - MOV EBX,EBX<br />$8B $C9 - MOV ECX,ECX<br />$8B $D2 - MOV EDX,EDX<br /><br />3 bytes&#58;<br />$8D $40 $00 - LEA EAX,&#91;EAX+$00&#93;<br />$8D $52 $00 - LEA EDX,&#91;EDX+$00&#93;<br /><br />4 bytes&#58;<br />$8D $44 $20 $00 - LEA EDX,&#91;EDX+$00&#93;<br />$8D $54 $22 $00 - LEA EDX,&#91;EDX+$00&#93;<br /><br />5 bytes&#58;<br />$66 $8D $54 $22 $00 - LEA DX,&#91;EDX+$00&#93;<br /><br />6 bytes&#58;<br />$8D 80 00 00 00 00 - LEA EAX,&#91;EAX+$00000000&#93;<br />$8D 92 00 00 00 00 - LEA EDX,&#91;EDX+$00000000&#93;<br /><br />7 bytes&#58;<br />$8D $04 $05 $00 $00 $00 $00 - LEA EAX,&#91;EAX*1+0x00000000&#93;<br /><br />8 bytes&#58;<br />$66 $8D $04 $05 $00 $00 $00 $00 - LEA AX,&#91;EAX*1+0x00000000&#93;<br /></code></pre><br />The LEA 16bit,[..] instructions ain't good on Athlons, because they are decoded as Vector ones.<br />The reasons why in my above examples I listed register variants is to avoid dependancies. My back-end has no problem choosing the right variant, since it has a track of previously executed instructions. I suppose this would be harder to implement in a assembler, since normally those don't analyze the code.<br /><br />Of course each CPU model has to have its own code generator.<br />Moreover, there's a certain pad threshold where jmp short becomes faster.<br /><br />I've already wrote such a generator.. but it's in the beta stage, and only for my Athlon.<br /><br />I wish I could freeze time for 10 years, finish all my crap, and restart time.. to use it instead of having a lot of development to finish before.</div>
    <div class="meta">Posted on 2003-01-14 06:20:15 by Maverick</div>
   </div>
   <div class="post" id="post-76378">
    <div class="subject"><a href="#post-76378">ALIGN Directive</a></div>
    <div class="body"><div class="quote"><br />I always wanted a directive like ALIGN, but more... for example, I need to align code on an 16 + 4 boundary. Some silly code works best that way, or is it the silly processor? :) </div><br /><br />       align 16<br />       rb      4<br /><br />is the general way to do it (assuming you don't need to actually execute this<br />block of bytes, in which case you'd probably want to fill it with appropriate<br />four-byte NOPs.<br /><br />Ditto for alignment to some value that's not a power of two -- not too difficult to<br />synthesize if you've got an alignment to an address that is a power of two.<br />It's getting the alignment to the appropriate power of two boundary in the first<br />place that's difficult to achieve.<br />Randy Hyde</div>
    <div class="meta">Posted on 2003-01-14 21:54:07 by rhyde</div>
   </div>
   <div class="post" id="post-76379">
    <div class="subject"><a href="#post-76379">ALIGN Directive</a></div>
    <div class="body"><div class="quote"><br /><strong></strong><br />For FASM:<br /><br /><pre><code><br />; Offset must be &gt; -Alignment and &lt; Alignment. You can omit the Offset parameter &#40;i.e. = 0&#41;.<br />MACRO                           ALIGN           Alignment,Offset &#123;<br />   IF &lt;Offset&gt; EQ &lt;&gt;<br />   REPEAT &#40;Alignment-1&#41;-&#40;&#40;$+Alignment-1&#41; mod Alignment&#41;<br />                                NOP            ; DB 0 if you prefer<br />   END REPEAT<br />   ELSE<br />   REPEAT &#40;Alignment-1&#41;-&#40;&#40;$+Alignment-Offset-1&#41; mod Alignment&#41;<br />                                NOP            ; DB 0 if you prefer<br />   END REPEAT<br />   END IF<br />&#125;<br /></code></pre><br /></div><br /><br /><br />Hmmm...<br />Are you using multiple sections in your code?<br />I tried the following and still I got the error:<br /><br />flat assembler  version 1.43<br />ft.asm [24] ALIGN [6]:<br />                        ALIGN 4, 0<br />error: invalid use of symbol.<br /><br /><br /><br />		format	MS COFF<br /><br />; Offset must be &gt; -Alignment and &lt; Alignment. You can omit the Offset parameter (i.e. = 0).<br />MACRO ALIGN  Alignment,Offset <br />{<br />   IF &lt;Offset&gt; EQ &lt;&gt;<br />   REPEAT (Alignment-1)-(($+Alignment-1) mod Alignment)<br />      NOP  ; DB 0 if you prefer<br />   END REPEAT<br />   ELSE<br />   REPEAT (Alignment-1)-(($+Alignment-Offset-1) mod Alignment)<br />      NOP  ; DB 0 if you prefer<br />   END REPEAT<br />   END IF<br />}<br /><br /><br />		section	'.data' data readable writeable<br />align_origin = $<br /><br />var1		db	?<br />var2		dw	?<br />			;rb (4-1)-($-align_origin+4-1) mod 4<br />			ALIGN 4, 0<br />var4		dd	?<br />var1_2		db	?</div>
    <div class="meta">Posted on 2003-01-14 22:09:12 by rhyde</div>
   </div>
   <div class="post" id="post-76384">
    <div class="subject"><a href="#post-76384">ALIGN Directive</a></div>
    <div class="body"><div class="quote"><br /><br />In object formats like COFF sections are not yet aligned. So it's a matter of linker (I can't guarantee anything about linker).<br />And if FASM aligns sections to any boundary in executable formats, it's exactly said in the documentation, what is the value of that boundary. </div><br /><br />COFF section objects specify a require alignment value (IIRC).<br />You specify the alignment that the entire section must be aligned upon<br />and it is upto the linker to ensure that it creates a combined module with that<br />portion of the section so aligned.<br /><br />So, for example, were I to stick a directive like &quot;ALIGN 40H&quot; within a section,<br />and that was the largest ALIGNment in the section, then the entire section<br />would have to be aligned on a 40H boundary.  COFF sections have to be<br />aligned on some power of two boundary, which is why most assemblers<br />enforce this.<br /><br />Does FASM combine all the sections with the same name and attributes into<br />a single section for the linker?  Or will it output multiple sections with the<br />same names and attributes as separate sections? (I'm assuming the latter,<br />based on FASM philosophy.)  In any case, doing an ALIGN under COFF is<br />not that difficult.  Just keep track of the largest ALIGN value in a given section<br />and make sure that the entire section is specified to be aligned on that<br />particular boundary.  Then the little macro you've supplied would work perfectly<br />for alignment since we know each section begins on a reasonable boundary.<br /><br />It doesn't look that hard to do, but I suspect that this is something the assembler<br />will have to do for me unless FASM provides a way to specify the section alignment<br />value in a SECTION statement.<br />Randy Hyde</div>
    <div class="meta">Posted on 2003-01-14 22:38:24 by rhyde</div>
   </div>
   <div class="post" id="post-76408">
    <div class="subject"><a href="#post-76408">ALIGN Directive</a></div>
    <div class="body"><div class="quote">Hmmm...<br />Are you using multiple sections in your code?<br />I tried the following and still I got the error:</div><br />Try this one:<br /><pre><code><br />;Offset must be &gt; -Alignment and &lt; Alignment<br />MACRO                           ALIGN           Alignment,Offset &#123;<br />   IF &lt;Offset&gt; EQ &lt;&gt;<br />   REPEAT &#40;Alignment-1&#41;-&#40;&#40;$-SECTION_START+Alignment-1&#41; mod Alignment&#41;<br />                                NOP<br />   END REPEAT<br />   ELSE<br />   REPEAT &#40;Alignment-1&#41;-&#40;&#40;$-SECTION_START+Alignment-Offset-1&#41; mod Alignment&#41;<br />                                NOP<br />   END REPEAT<br />   END IF<br />&#125;<br /></code></pre><br />You've to define SECTION_START.</div>
    <div class="meta">Posted on 2003-01-15 03:20:31 by Maverick</div>
   </div>
   <div class="post" id="post-76428">
    <div class="subject"><a href="#post-76428">align for bios code</a></div>
    <div class="body">I agree with Privalov, the programmer should be able to control the way an align should work.  For example, my particular variant on ALIGN uses $FF as the fill byte - I'm designing a new BIOS and a blank on an EPROM/FLASH is $FF - not $00 or NOP...<br /><br />On the otherhand - ALIGN with a couple of parameters to fill most peoples needs may work okay...<br /><br />-Anthony</div>
    <div class="meta">Posted on 2003-01-15 06:59:06 by DoubleDutchDesigns</div>
   </div>
   <div class="post" id="post-76431">
    <div class="subject"><a href="#post-76431">ALIGN Directive</a></div>
    <div class="body"><div class="quote">I agree with Privalov, the programmer should be able to control the way an align should work. For example, my particular variant on ALIGN uses $FF as the fill byte - I'm designing a new BIOS and a blank on an EPROM/FLASH is $FF - not <div class="quote">I agree with Privalov, the programmer should be able to control the way an align should work. For example, my particular variant on ALIGN uses $FF as the fill byte - I'm designing a new BIOS and a blank on an EPROM/FLASH is $FF - not $00 or NOP...</div>Agreed.<br /><div class="quote">On the otherhand - ALIGN with a couple of parameters to fill most peoples needs may work okay...</div> or NOP...</div>Agreed.<br /><div class="quote">On the otherhand - ALIGN with a couple of parameters to fill most peoples needs may work okay...</div>Not agreed.. &quot;most&quot; means already limiting for some, which is frustrating.<br /><br />Since the MACRO solution has some problems, here's what I can propose (as ALIGN design), which in my experience would fullfill *all* needs:<br /><br />Provide ALIGN as a stand-alone assembler statement.<br /><br />ALIGN alignment<br />alignes to alignment<br /><br />ALIGN alignment,offset<br />alignes to alignment plus offset<br /><br />ALIGN alignment,offset,reference_label<br />as above but takes as &quot;starting point&quot; reference the label<br /><br />alternatively the reference_label can be expressed by means like:<br />ALIGNREF=...<br />which sets the reference label of ALIGN (I'd prefer all in one statement, anyway).<br /><br />Moreover, later, make ALIGN generate not only NOP, but also MOV/LEA or JMP statements to provide better padding code than just NOPs. This can't easily (or at all) be done with MACROs.<br /><br />Finally, add a preprocessor variable that holds the maximum alignment required.. so that can then be used to know what will have to be the whole section's alignment on load.<br /><br />This all should say the definitive word on the ALIGN problem..</div>
    <div class="meta">Posted on 2003-01-15 07:07:02 by Maverick</div>
   </div>
   <div class="post" id="post-76443">
    <div class="subject"><a href="#post-76443">ALIGN Directive</a></div>
    <div class="body"><div class="quote"><br /><em>Randall Hyde:</em><br />COFF section objects specify a require alignment value (IIRC).<br /></div><br />No, the don't. ELF sections do (and fasm currently by default sets it to 4, as &quot;as&quot; does, but I'll probably make it customizable in future), but COFF section headers don't containt any &quot;alignment&quot; field. I can send you some more information (PDFs) about these object formats if you need to check.<br /><br /><div class="quote"><br /><em>Randall Hyde:</em><br />Does FASM combine all the sections with the same name and attributes into<br />a single section for the linker?<br /></div><br />As I said it before, fasm creates the section in exactly the count and order you've specified. I recommend checking it with some hex viewer, you'll see the things better that with my explanations.<br /><br /><div class="quote"><br /><em>Maverick:</em><br />Moreover, later, make ALIGN generate not only NOP, but also MOV/LEA or JMP statements to provide better padding code than just NOPs. This can't easily (or at all) be done with MACROs.<br /></div><br /><br />Yes, it can:<br /><pre><code><br />macro codealign value<br /> &#123;<br />   ..align_size = &#40;value-1&#41;-&#40;$-align_origin+value-1&#41; mod value<br />   times ..align_size/8 db , D, , , &#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />COFF section objects specify a require alignment value &#40;IIRC&#41;.<br />&#91;/QUOTE&#93;<br />No, the don't. ELF sections do &#40;and fasm currently by default sets it to 4, as &quot;as&quot; does, but I'll probably make it customizable in future&#41;, but COFF section headers don't containt any &quot;alignment&quot; field. I can send you some more information &#40;PDFs&#41; about these object formats if you need to check.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />Does FASM combine all the sections with the same name and attributes into<br />a single section for the linker?<br />&#91;/QUOTE&#93;<br />As I said it before, fasm creates the section in exactly the count and order you've specified. I recommend checking it with some hex viewer, you'll see the things better that with my explanations.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />Moreover, later, make ALIGN generate not only NOP, but also MOV/LEA or JMP statements to provide better padding code than just NOPs. This can't easily &#40;or at all&#41; be done with MACROs.<br />&#91;/QUOTE&#93;<br /><br />Yes, it can&#58;<br />&#91;code&#93;<br />macro codealign value<br /> &#123;<br />   ..align_size = &#40;value-1&#41;-&#40;$-align_origin+value-1&#41; mod value<br />   times ..align_size/8 db $66, $8D, $04, $05, $00, $00, $00, $00<br />   ..align_size = ..align_size mod 8<br />   if ..align_size = 7<br />    db $8D, $04, $05, $00, $00, $00, $00<br />   else if ..align_size = 6<br />    db $8D, $80, $00, $00, $00, $00<br />   else if ..align_size = 5<br />    db $66, $8D, $54, $22, $00<br />   else if ..align_size = 4<br />    db $8D, $44, $20, $00<br />   else if ..align_size = 3<br />    db $8D, $40, $00<br />   else if ..align_size = 2<br />    db $8B, $C0<br />   else if ..align_size = 1<br />    db 90h<br />   end if<br /> &#125;<br />&#91;/code&#93;<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />This all should say the definitive word on the ALIGN problem..<br />&#91;/QUOTE&#93;, &#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />COFF section objects specify a require alignment value &#40;IIRC&#41;.<br />&#91;/QUOTE&#93;<br />No, the don't. ELF sections do &#40;and fasm currently by default sets it to 4, as &quot;as&quot; does, but I'll probably make it customizable in future&#41;, but COFF section headers don't containt any &quot;alignment&quot; field. I can send you some more information &#40;PDFs&#41; about these object formats if you need to check.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />Does FASM combine all the sections with the same name and attributes into<br />a single section for the linker?<br />&#91;/QUOTE&#93;<br />As I said it before, fasm creates the section in exactly the count and order you've specified. I recommend checking it with some hex viewer, you'll see the things better that with my explanations.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />Moreover, later, make ALIGN generate not only NOP, but also MOV/LEA or JMP statements to provide better padding code than just NOPs. This can't easily &#40;or at all&#41; be done with MACROs.<br />&#91;/QUOTE&#93;<br /><br />Yes, it can&#58;<br />&#91;code&#93;<br />macro codealign value<br /> &#123;<br />   ..align_size = &#40;value-1&#41;-&#40;$-align_origin+value-1&#41; mod value<br />   times ..align_size/8 db $66, $8D, $04, $05, $00, $00, $00, $00<br />   ..align_size = ..align_size mod 8<br />   if ..align_size = 7<br />    db $8D, $04, $05, $00, $00, $00, $00<br />   else if ..align_size = 6<br />    db $8D, $80, $00, $00, $00, $00<br />   else if ..align_size = 5<br />    db $66, $8D, $54, $22, $00<br />   else if ..align_size = 4<br />    db $8D, $44, $20, $00<br />   else if ..align_size = 3<br />    db $8D, $40, $00<br />   else if ..align_size = 2<br />    db $8B, $C0<br />   else if ..align_size = 1<br />    db 90h<br />   end if<br /> &#125;<br />&#91;/code&#93;<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />This all should say the definitive word on the ALIGN problem..<br />&#91;/QUOTE&#93;, &#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />COFF section objects specify a require alignment value &#40;IIRC&#41;.<br />&#91;/QUOTE&#93;<br />No, the don't. ELF sections do &#40;and fasm currently by default sets it to 4, as &quot;as&quot; does, but I'll probably make it customizable in future&#41;, but COFF section headers don't containt any &quot;alignment&quot; field. I can send you some more information &#40;PDFs&#41; about these object formats if you need to check.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />Does FASM combine all the sections with the same name and attributes into<br />a single section for the linker?<br />&#91;/QUOTE&#93;<br />As I said it before, fasm creates the section in exactly the count and order you've specified. I recommend checking it with some hex viewer, you'll see the things better that with my explanations.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />Moreover, later, make ALIGN generate not only NOP, but also MOV/LEA or JMP statements to provide better padding code than just NOPs. This can't easily &#40;or at all&#41; be done with MACROs.<br />&#91;/QUOTE&#93;<br /><br />Yes, it can&#58;<br />&#91;code&#93;<br />macro codealign value<br /> &#123;<br />   ..align_size = &#40;value-1&#41;-&#40;$-align_origin+value-1&#41; mod value<br />   times ..align_size/8 db $66, $8D, $04, $05, $00, $00, $00, $00<br />   ..align_size = ..align_size mod 8<br />   if ..align_size = 7<br />    db $8D, $04, $05, $00, $00, $00, $00<br />   else if ..align_size = 6<br />    db $8D, $80, $00, $00, $00, $00<br />   else if ..align_size = 5<br />    db $66, $8D, $54, $22, $00<br />   else if ..align_size = 4<br />    db $8D, $44, $20, $00<br />   else if ..align_size = 3<br />    db $8D, $40, $00<br />   else if ..align_size = 2<br />    db $8B, $C0<br />   else if ..align_size = 1<br />    db 90h<br />   end if<br /> &#125;<br />&#91;/code&#93;<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />This all should say the definitive word on the ALIGN problem..<br />&#91;/QUOTE&#93;, &#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />COFF section objects specify a require alignment value &#40;IIRC&#41;.<br />&#91;/QUOTE&#93;<br />No, the don't. ELF sections do &#40;and fasm currently by default sets it to 4, as &quot;as&quot; does, but I'll probably make it customizable in future&#41;, but COFF section headers don't containt any &quot;alignment&quot; field. I can send you some more information &#40;PDFs&#41; about these object formats if you need to check.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />Does FASM combine all the sections with the same name and attributes into<br />a single section for the linker?<br />&#91;/QUOTE&#93;<br />As I said it before, fasm creates the section in exactly the count and order you've specified. I recommend checking it with some hex viewer, you'll see the things better that with my explanations.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />Moreover, later, make ALIGN generate not only NOP, but also MOV/LEA or JMP statements to provide better padding code than just NOPs. This can't easily &#40;or at all&#41; be done with MACROs.<br />&#91;/QUOTE&#93;<br /><br />Yes, it can&#58;<br />&#91;code&#93;<br />macro codealign value<br /> &#123;<br />   ..align_size = &#40;value-1&#41;-&#40;$-align_origin+value-1&#41; mod value<br />   times ..align_size/8 db $66, $8D, $04, $05, $00, $00, $00, $00<br />   ..align_size = ..align_size mod 8<br />   if ..align_size = 7<br />    db $8D, $04, $05, $00, $00, $00, $00<br />   else if ..align_size = 6<br />    db $8D, $80, $00, $00, $00, $00<br />   else if ..align_size = 5<br />    db $66, $8D, $54, $22, $00<br />   else if ..align_size = 4<br />    db $8D, $44, $20, $00<br />   else if ..align_size = 3<br />    db $8D, $40, $00<br />   else if ..align_size = 2<br />    db $8B, $C0<br />   else if ..align_size = 1<br />    db 90h<br />   end if<br /> &#125;<br />&#91;/code&#93;<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />This all should say the definitive word on the ALIGN problem..<br />&#91;/QUOTE&#93;<br />   ..align_size = ..align_size mod 8<br />   if ..align_size = 7<br />    db D, , , &#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />COFF section objects specify a require alignment value &#40;IIRC&#41;.<br />&#91;/QUOTE&#93;<br />No, the don't. ELF sections do &#40;and fasm currently by default sets it to 4, as &quot;as&quot; does, but I'll probably make it customizable in future&#41;, but COFF section headers don't containt any &quot;alignment&quot; field. I can send you some more information &#40;PDFs&#41; about these object formats if you need to check.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />Does FASM combine all the sections with the same name and attributes into<br />a single section for the linker?<br />&#91;/QUOTE&#93;<br />As I said it before, fasm creates the section in exactly the count and order you've specified. I recommend checking it with some hex viewer, you'll see the things better that with my explanations.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />Moreover, later, make ALIGN generate not only NOP, but also MOV/LEA or JMP statements to provide better padding code than just NOPs. This can't easily &#40;or at all&#41; be done with MACROs.<br />&#91;/QUOTE&#93;<br /><br />Yes, it can&#58;<br />&#91;code&#93;<br />macro codealign value<br /> &#123;<br />   ..align_size = &#40;value-1&#41;-&#40;$-align_origin+value-1&#41; mod value<br />   times ..align_size/8 db $66, $8D, $04, $05, $00, $00, $00, $00<br />   ..align_size = ..align_size mod 8<br />   if ..align_size = 7<br />    db $8D, $04, $05, $00, $00, $00, $00<br />   else if ..align_size = 6<br />    db $8D, $80, $00, $00, $00, $00<br />   else if ..align_size = 5<br />    db $66, $8D, $54, $22, $00<br />   else if ..align_size = 4<br />    db $8D, $44, $20, $00<br />   else if ..align_size = 3<br />    db $8D, $40, $00<br />   else if ..align_size = 2<br />    db $8B, $C0<br />   else if ..align_size = 1<br />    db 90h<br />   end if<br /> &#125;<br />&#91;/code&#93;<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />This all should say the definitive word on the ALIGN problem..<br />&#91;/QUOTE&#93;, &#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />COFF section objects specify a require alignment value &#40;IIRC&#41;.<br />&#91;/QUOTE&#93;<br />No, the don't. ELF sections do &#40;and fasm currently by default sets it to 4, as &quot;as&quot; does, but I'll probably make it customizable in future&#41;, but COFF section headers don't containt any &quot;alignment&quot; field. I can send you some more information &#40;PDFs&#41; about these object formats if you need to check.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />Does FASM combine all the sections with the same name and attributes into<br />a single section for the linker?<br />&#91;/QUOTE&#93;<br />As I said it before, fasm creates the section in exactly the count and order you've specified. I recommend checking it with some hex viewer, you'll see the things better that with my explanations.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />Moreover, later, make ALIGN generate not only NOP, but also MOV/LEA or JMP statements to provide better padding code than just NOPs. This can't easily &#40;or at all&#41; be done with MACROs.<br />&#91;/QUOTE&#93;<br /><br />Yes, it can&#58;<br />&#91;code&#93;<br />macro codealign value<br /> &#123;<br />   ..align_size = &#40;value-1&#41;-&#40;$-align_origin+value-1&#41; mod value<br />   times ..align_size/8 db $66, $8D, $04, $05, $00, $00, $00, $00<br />   ..align_size = ..align_size mod 8<br />   if ..align_size = 7<br />    db $8D, $04, $05, $00, $00, $00, $00<br />   else if ..align_size = 6<br />    db $8D, $80, $00, $00, $00, $00<br />   else if ..align_size = 5<br />    db $66, $8D, $54, $22, $00<br />   else if ..align_size = 4<br />    db $8D, $44, $20, $00<br />   else if ..align_size = 3<br />    db $8D, $40, $00<br />   else if ..align_size = 2<br />    db $8B, $C0<br />   else if ..align_size = 1<br />    db 90h<br />   end if<br /> &#125;<br />&#91;/code&#93;<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />This all should say the definitive word on the ALIGN problem..<br />&#91;/QUOTE&#93;, &#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />COFF section objects specify a require alignment value &#40;IIRC&#41;.<br />&#91;/QUOTE&#93;<br />No, the don't. ELF sections do &#40;and fasm currently by default sets it to 4, as &quot;as&quot; does, but I'll probably make it customizable in future&#41;, but COFF section headers don't containt any &quot;alignment&quot; field. I can send you some more information &#40;PDFs&#41; about these object formats if you need to check.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />Does FASM combine all the sections with the same name and attributes into<br />a single section for the linker?<br />&#91;/QUOTE&#93;<br />As I said it before, fasm creates the section in exactly the count and order you've specified. I recommend checking it with some hex viewer, you'll see the things better that with my explanations.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />Moreover, later, make ALIGN generate not only NOP, but also MOV/LEA or JMP statements to provide better padding code than just NOPs. This can't easily &#40;or at all&#41; be done with MACROs.<br />&#91;/QUOTE&#93;<br /><br />Yes, it can&#58;<br />&#91;code&#93;<br />macro codealign value<br /> &#123;<br />   ..align_size = &#40;value-1&#41;-&#40;$-align_origin+value-1&#41; mod value<br />   times ..align_size/8 db $66, $8D, $04, $05, $00, $00, $00, $00<br />   ..align_size = ..align_size mod 8<br />   if ..align_size = 7<br />    db $8D, $04, $05, $00, $00, $00, $00<br />   else if ..align_size = 6<br />    db $8D, $80, $00, $00, $00, $00<br />   else if ..align_size = 5<br />    db $66, $8D, $54, $22, $00<br />   else if ..align_size = 4<br />    db $8D, $44, $20, $00<br />   else if ..align_size = 3<br />    db $8D, $40, $00<br />   else if ..align_size = 2<br />    db $8B, $C0<br />   else if ..align_size = 1<br />    db 90h<br />   end if<br /> &#125;<br />&#91;/code&#93;<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />This all should say the definitive word on the ALIGN problem..<br />&#91;/QUOTE&#93;, &#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />COFF section objects specify a require alignment value &#40;IIRC&#41;.<br />&#91;/QUOTE&#93;<br />No, the don't. ELF sections do &#40;and fasm currently by default sets it to 4, as &quot;as&quot; does, but I'll probably make it customizable in future&#41;, but COFF section headers don't containt any &quot;alignment&quot; field. I can send you some more information &#40;PDFs&#41; about these object formats if you need to check.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />Does FASM combine all the sections with the same name and attributes into<br />a single section for the linker?<br />&#91;/QUOTE&#93;<br />As I said it before, fasm creates the section in exactly the count and order you've specified. I recommend checking it with some hex viewer, you'll see the things better that with my explanations.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />Moreover, later, make ALIGN generate not only NOP, but also MOV/LEA or JMP statements to provide better padding code than just NOPs. This can't easily &#40;or at all&#41; be done with MACROs.<br />&#91;/QUOTE&#93;<br /><br />Yes, it can&#58;<br />&#91;code&#93;<br />macro codealign value<br /> &#123;<br />   ..align_size = &#40;value-1&#41;-&#40;$-align_origin+value-1&#41; mod value<br />   times ..align_size/8 db $66, $8D, $04, $05, $00, $00, $00, $00<br />   ..align_size = ..align_size mod 8<br />   if ..align_size = 7<br />    db $8D, $04, $05, $00, $00, $00, $00<br />   else if ..align_size = 6<br />    db $8D, $80, $00, $00, $00, $00<br />   else if ..align_size = 5<br />    db $66, $8D, $54, $22, $00<br />   else if ..align_size = 4<br />    db $8D, $44, $20, $00<br />   else if ..align_size = 3<br />    db $8D, $40, $00<br />   else if ..align_size = 2<br />    db $8B, $C0<br />   else if ..align_size = 1<br />    db 90h<br />   end if<br /> &#125;<br />&#91;/code&#93;<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />This all should say the definitive word on the ALIGN problem..<br />&#91;/QUOTE&#93;<br />   else if ..align_size = 6<br />    db D, , &#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />COFF section objects specify a require alignment value &#40;IIRC&#41;.<br />&#91;/QUOTE&#93;<br />No, the don't. ELF sections do &#40;and fasm currently by default sets it to 4, as &quot;as&quot; does, but I'll probably make it customizable in future&#41;, but COFF section headers don't containt any &quot;alignment&quot; field. I can send you some more information &#40;PDFs&#41; about these object formats if you need to check.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />Does FASM combine all the sections with the same name and attributes into<br />a single section for the linker?<br />&#91;/QUOTE&#93;<br />As I said it before, fasm creates the section in exactly the count and order you've specified. I recommend checking it with some hex viewer, you'll see the things better that with my explanations.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />Moreover, later, make ALIGN generate not only NOP, but also MOV/LEA or JMP statements to provide better padding code than just NOPs. This can't easily &#40;or at all&#41; be done with MACROs.<br />&#91;/QUOTE&#93;<br /><br />Yes, it can&#58;<br />&#91;code&#93;<br />macro codealign value<br /> &#123;<br />   ..align_size = &#40;value-1&#41;-&#40;$-align_origin+value-1&#41; mod value<br />   times ..align_size/8 db $66, $8D, $04, $05, $00, $00, $00, $00<br />   ..align_size = ..align_size mod 8<br />   if ..align_size = 7<br />    db $8D, $04, $05, $00, $00, $00, $00<br />   else if ..align_size = 6<br />    db $8D, $80, $00, $00, $00, $00<br />   else if ..align_size = 5<br />    db $66, $8D, $54, $22, $00<br />   else if ..align_size = 4<br />    db $8D, $44, $20, $00<br />   else if ..align_size = 3<br />    db $8D, $40, $00<br />   else if ..align_size = 2<br />    db $8B, $C0<br />   else if ..align_size = 1<br />    db 90h<br />   end if<br /> &#125;<br />&#91;/code&#93;<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />This all should say the definitive word on the ALIGN problem..<br />&#91;/QUOTE&#93;, &#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />COFF section objects specify a require alignment value &#40;IIRC&#41;.<br />&#91;/QUOTE&#93;<br />No, the don't. ELF sections do &#40;and fasm currently by default sets it to 4, as &quot;as&quot; does, but I'll probably make it customizable in future&#41;, but COFF section headers don't containt any &quot;alignment&quot; field. I can send you some more information &#40;PDFs&#41; about these object formats if you need to check.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />Does FASM combine all the sections with the same name and attributes into<br />a single section for the linker?<br />&#91;/QUOTE&#93;<br />As I said it before, fasm creates the section in exactly the count and order you've specified. I recommend checking it with some hex viewer, you'll see the things better that with my explanations.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />Moreover, later, make ALIGN generate not only NOP, but also MOV/LEA or JMP statements to provide better padding code than just NOPs. This can't easily &#40;or at all&#41; be done with MACROs.<br />&#91;/QUOTE&#93;<br /><br />Yes, it can&#58;<br />&#91;code&#93;<br />macro codealign value<br /> &#123;<br />   ..align_size = &#40;value-1&#41;-&#40;$-align_origin+value-1&#41; mod value<br />   times ..align_size/8 db $66, $8D, $04, $05, $00, $00, $00, $00<br />   ..align_size = ..align_size mod 8<br />   if ..align_size = 7<br />    db $8D, $04, $05, $00, $00, $00, $00<br />   else if ..align_size = 6<br />    db $8D, $80, $00, $00, $00, $00<br />   else if ..align_size = 5<br />    db $66, $8D, $54, $22, $00<br />   else if ..align_size = 4<br />    db $8D, $44, $20, $00<br />   else if ..align_size = 3<br />    db $8D, $40, $00<br />   else if ..align_size = 2<br />    db $8B, $C0<br />   else if ..align_size = 1<br />    db 90h<br />   end if<br /> &#125;<br />&#91;/code&#93;<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />This all should say the definitive word on the ALIGN problem..<br />&#91;/QUOTE&#93;, &#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />COFF section objects specify a require alignment value &#40;IIRC&#41;.<br />&#91;/QUOTE&#93;<br />No, the don't. ELF sections do &#40;and fasm currently by default sets it to 4, as &quot;as&quot; does, but I'll probably make it customizable in future&#41;, but COFF section headers don't containt any &quot;alignment&quot; field. I can send you some more information &#40;PDFs&#41; about these object formats if you need to check.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />Does FASM combine all the sections with the same name and attributes into<br />a single section for the linker?<br />&#91;/QUOTE&#93;<br />As I said it before, fasm creates the section in exactly the count and order you've specified. I recommend checking it with some hex viewer, you'll see the things better that with my explanations.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />Moreover, later, make ALIGN generate not only NOP, but also MOV/LEA or JMP statements to provide better padding code than just NOPs. This can't easily &#40;or at all&#41; be done with MACROs.<br />&#91;/QUOTE&#93;<br /><br />Yes, it can&#58;<br />&#91;code&#93;<br />macro codealign value<br /> &#123;<br />   ..align_size = &#40;value-1&#41;-&#40;$-align_origin+value-1&#41; mod value<br />   times ..align_size/8 db $66, $8D, $04, $05, $00, $00, $00, $00<br />   ..align_size = ..align_size mod 8<br />   if ..align_size = 7<br />    db $8D, $04, $05, $00, $00, $00, $00<br />   else if ..align_size = 6<br />    db $8D, $80, $00, $00, $00, $00<br />   else if ..align_size = 5<br />    db $66, $8D, $54, $22, $00<br />   else if ..align_size = 4<br />    db $8D, $44, $20, $00<br />   else if ..align_size = 3<br />    db $8D, $40, $00<br />   else if ..align_size = 2<br />    db $8B, $C0<br />   else if ..align_size = 1<br />    db 90h<br />   end if<br /> &#125;<br />&#91;/code&#93;<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />This all should say the definitive word on the ALIGN problem..<br />&#91;/QUOTE&#93;, &#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />COFF section objects specify a require alignment value &#40;IIRC&#41;.<br />&#91;/QUOTE&#93;<br />No, the don't. ELF sections do &#40;and fasm currently by default sets it to 4, as &quot;as&quot; does, but I'll probably make it customizable in future&#41;, but COFF section headers don't containt any &quot;alignment&quot; field. I can send you some more information &#40;PDFs&#41; about these object formats if you need to check.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />Does FASM combine all the sections with the same name and attributes into<br />a single section for the linker?<br />&#91;/QUOTE&#93;<br />As I said it before, fasm creates the section in exactly the count and order you've specified. I recommend checking it with some hex viewer, you'll see the things better that with my explanations.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />Moreover, later, make ALIGN generate not only NOP, but also MOV/LEA or JMP statements to provide better padding code than just NOPs. This can't easily &#40;or at all&#41; be done with MACROs.<br />&#91;/QUOTE&#93;<br /><br />Yes, it can&#58;<br />&#91;code&#93;<br />macro codealign value<br /> &#123;<br />   ..align_size = &#40;value-1&#41;-&#40;$-align_origin+value-1&#41; mod value<br />   times ..align_size/8 db $66, $8D, $04, $05, $00, $00, $00, $00<br />   ..align_size = ..align_size mod 8<br />   if ..align_size = 7<br />    db $8D, $04, $05, $00, $00, $00, $00<br />   else if ..align_size = 6<br />    db $8D, $80, $00, $00, $00, $00<br />   else if ..align_size = 5<br />    db $66, $8D, $54, $22, $00<br />   else if ..align_size = 4<br />    db $8D, $44, $20, $00<br />   else if ..align_size = 3<br />    db $8D, $40, $00<br />   else if ..align_size = 2<br />    db $8B, $C0<br />   else if ..align_size = 1<br />    db 90h<br />   end if<br /> &#125;<br />&#91;/code&#93;<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />This all should say the definitive word on the ALIGN problem..<br />&#91;/QUOTE&#93;<br />   else if ..align_size = 5<br />    db , D, , , &#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />COFF section objects specify a require alignment value &#40;IIRC&#41;.<br />&#91;/QUOTE&#93;<br />No, the don't. ELF sections do &#40;and fasm currently by default sets it to 4, as &quot;as&quot; does, but I'll probably make it customizable in future&#41;, but COFF section headers don't containt any &quot;alignment&quot; field. I can send you some more information &#40;PDFs&#41; about these object formats if you need to check.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />Does FASM combine all the sections with the same name and attributes into<br />a single section for the linker?<br />&#91;/QUOTE&#93;<br />As I said it before, fasm creates the section in exactly the count and order you've specified. I recommend checking it with some hex viewer, you'll see the things better that with my explanations.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />Moreover, later, make ALIGN generate not only NOP, but also MOV/LEA or JMP statements to provide better padding code than just NOPs. This can't easily &#40;or at all&#41; be done with MACROs.<br />&#91;/QUOTE&#93;<br /><br />Yes, it can&#58;<br />&#91;code&#93;<br />macro codealign value<br /> &#123;<br />   ..align_size = &#40;value-1&#41;-&#40;$-align_origin+value-1&#41; mod value<br />   times ..align_size/8 db $66, $8D, $04, $05, $00, $00, $00, $00<br />   ..align_size = ..align_size mod 8<br />   if ..align_size = 7<br />    db $8D, $04, $05, $00, $00, $00, $00<br />   else if ..align_size = 6<br />    db $8D, $80, $00, $00, $00, $00<br />   else if ..align_size = 5<br />    db $66, $8D, $54, $22, $00<br />   else if ..align_size = 4<br />    db $8D, $44, $20, $00<br />   else if ..align_size = 3<br />    db $8D, $40, $00<br />   else if ..align_size = 2<br />    db $8B, $C0<br />   else if ..align_size = 1<br />    db 90h<br />   end if<br /> &#125;<br />&#91;/code&#93;<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />This all should say the definitive word on the ALIGN problem..<br />&#91;/QUOTE&#93;<br />   else if ..align_size = 4<br />    db D, , , &#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />COFF section objects specify a require alignment value &#40;IIRC&#41;.<br />&#91;/QUOTE&#93;<br />No, the don't. ELF sections do &#40;and fasm currently by default sets it to 4, as &quot;as&quot; does, but I'll probably make it customizable in future&#41;, but COFF section headers don't containt any &quot;alignment&quot; field. I can send you some more information &#40;PDFs&#41; about these object formats if you need to check.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />Does FASM combine all the sections with the same name and attributes into<br />a single section for the linker?<br />&#91;/QUOTE&#93;<br />As I said it before, fasm creates the section in exactly the count and order you've specified. I recommend checking it with some hex viewer, you'll see the things better that with my explanations.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />Moreover, later, make ALIGN generate not only NOP, but also MOV/LEA or JMP statements to provide better padding code than just NOPs. This can't easily &#40;or at all&#41; be done with MACROs.<br />&#91;/QUOTE&#93;<br /><br />Yes, it can&#58;<br />&#91;code&#93;<br />macro codealign value<br /> &#123;<br />   ..align_size = &#40;value-1&#41;-&#40;$-align_origin+value-1&#41; mod value<br />   times ..align_size/8 db $66, $8D, $04, $05, $00, $00, $00, $00<br />   ..align_size = ..align_size mod 8<br />   if ..align_size = 7<br />    db $8D, $04, $05, $00, $00, $00, $00<br />   else if ..align_size = 6<br />    db $8D, $80, $00, $00, $00, $00<br />   else if ..align_size = 5<br />    db $66, $8D, $54, $22, $00<br />   else if ..align_size = 4<br />    db $8D, $44, $20, $00<br />   else if ..align_size = 3<br />    db $8D, $40, $00<br />   else if ..align_size = 2<br />    db $8B, $C0<br />   else if ..align_size = 1<br />    db 90h<br />   end if<br /> &#125;<br />&#91;/code&#93;<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />This all should say the definitive word on the ALIGN problem..<br />&#91;/QUOTE&#93;<br />   else if ..align_size = 3<br />    db D, , &#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />COFF section objects specify a require alignment value &#40;IIRC&#41;.<br />&#91;/QUOTE&#93;<br />No, the don't. ELF sections do &#40;and fasm currently by default sets it to 4, as &quot;as&quot; does, but I'll probably make it customizable in future&#41;, but COFF section headers don't containt any &quot;alignment&quot; field. I can send you some more information &#40;PDFs&#41; about these object formats if you need to check.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Randall Hyde&#58;&#91;/I&#93;<br />Does FASM combine all the sections with the same name and attributes into<br />a single section for the linker?<br />&#91;/QUOTE&#93;<br />As I said it before, fasm creates the section in exactly the count and order you've specified. I recommend checking it with some hex viewer, you'll see the things better that with my explanations.<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />Moreover, later, make ALIGN generate not only NOP, but also MOV/LEA or JMP statements to provide better padding code than just NOPs. This can't easily &#40;or at all&#41; be done with MACROs.<br />&#91;/QUOTE&#93;<br /><br />Yes, it can&#58;<br />&#91;code&#93;<br />macro codealign value<br /> &#123;<br />   ..align_size = &#40;value-1&#41;-&#40;$-align_origin+value-1&#41; mod value<br />   times ..align_size/8 db $66, $8D, $04, $05, $00, $00, $00, $00<br />   ..align_size = ..align_size mod 8<br />   if ..align_size = 7<br />    db $8D, $04, $05, $00, $00, $00, $00<br />   else if ..align_size = 6<br />    db $8D, $80, $00, $00, $00, $00<br />   else if ..align_size = 5<br />    db $66, $8D, $54, $22, $00<br />   else if ..align_size = 4<br />    db $8D, $44, $20, $00<br />   else if ..align_size = 3<br />    db $8D, $40, $00<br />   else if ..align_size = 2<br />    db $8B, $C0<br />   else if ..align_size = 1<br />    db 90h<br />   end if<br /> &#125;<br />&#91;/code&#93;<br /><br />&#91;QUOTE&#93;<br />&#91;I&#93;Maverick&#58;&#91;/I&#93;<br />This all should say the definitive word on the ALIGN problem..<br />&#91;/QUOTE&#93;<br />   else if ..align_size = 2<br />    db B, $C0<br />   else if ..align_size = 1<br />    db 90h<br />   end if<br /> &#125;<br /></code></pre><br /><br /><div class="quote"><br /><em>Maverick:</em><br />This all should say the definitive word on the ALIGN problem..<br /></div><br />IMHO there is no any real problem. And I think it's good to force programmer to think about what he's really doing - I was designing fasm in the way that it shouldn't do anything if it's not absolutely sure it is correct.<br /><br />I'm sorry if you find some of my answers a bit unpolite or icomprehensible, but I'm a bit tired now... Please understand.</div>
    <div class="meta">Posted on 2003-01-15 08:13:54 by Tomasz Grysztar</div>
   </div>
  </div>
 </body>
</html>