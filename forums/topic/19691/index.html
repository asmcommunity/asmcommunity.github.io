<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>TCP SYN scanning - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=19691" />
    <link rel="next" href="../?id=19691&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=8">Networking</a> &raquo; <a href="../?id=19691">TCP SYN scanning</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=19691&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=19691&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="19691" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=19691&amp;page=2">&gt;</a><a href="../?id=19691&amp;page=2">&raquo;</a></form>   <div class="post" id="post-151434">
    <div class="subject"><a href="#post-151434">TCP SYN scanning</a></div>
    <div class="body">I try to write a TCP SYN port scanner. What is wrong in my code? please tell me.<br /><br />tcp_hdr STRUCT<br />    tcp_sourc_port WORD ?<br />    tcp_dest_port WORD ?<br />    tcp_seq DWORD ?<br />    tcp_ack DWORD ?<br />    tcp_len BYTE ?<br />    tcp_flag BYTE ?<br />    tcp_win WORD ?<br />    tcp_cksum WORD ?<br />    tcp_urgent WORD ?<br />tcp_hdr ENDS<br /><br /><br />pseudo_hdr STRUCT <br />    src_address DWORD ?<br />    dest_address DWORD ?<br />    placeholder BYTE ?<br />    protocol BYTE ?<br />    tcp_length WORD ?<br />    tcp tcp_hdr &lt;?&gt;<br />pseudo_hdr ENDS<br /><br />*************************************<br /> mov ax, SourcePort<br />    MOV tcp_header. tcp_sourc_port, ax<br />    mov ax, DestPort<br />    MOV tcp_header.tcp_dest_port, ax<br />    MOV tcp_header.tcp_seq, 15B9184Ah<br />    MOV tcp_header.tcp_ack, 5D720008h<br />    MOV tcp_header.tcp_len, 50<br />    MOV tcp_header.tcp_flag, 11h<br />    MOV tcp_header.tcp_win, 2000h<br />    MOV tcp_header.tcp_cksum, 0 	<br />    MOV tcp_header.tcp_urgent, 0<br /><br />    mov eax, SrcAddr<br />    mov pseudo_header.src_address, eax<br />    mov eax, DestAddr<br />    mov pseudo_header.dest_address, eax<br />    mov pseudo_header.placeholder, 0<br />    mov pseudo_header.protocol, IPPROTO_TCP<br />    mov pseudo_header.tcp_length, sizeof tcp_header<br /><br />    invoke memcpy, ADDR pseudo_header.tcp, ADDR tcp_header, sizeof tcp_header<br /><br /><br />    invoke CheckSum, ADDR pseudo_header, sizeof pseudo_header<br />    MOV tcp_header.tcp_cksum, ax<br />       <br />    Mov socketaddr.sin_family, AF_INET<br />    mov ax, DestPort<br />    Mov socketaddr.sin_port, ax<br />    mov eax, DestAddr <br />    Mov socketaddr.sin_addr, eax<br />    mov socketaddr_len, SIZEOF socketaddr<br /><br /><br />    <br />    invoke sendto, TCPSock, ADDR tcp_header, 20, 0, ADDR socketaddr,\ socketaddr_len<br />    .if eax != 20<br />        invoke dwtoa, eax, ADDR intbuff<br />        invoke Write2ListRet, ADDR intbuff<br />    .endif   <br /><br />*************************************************<br />CheckSum PROC buffer:DWORD, dwSize:DWORD <br />    LOCAL cksum : DWORD <br />    <br />    mov cksum, 0 <br />    @@: <br />    cmp dwSize, 1 <br />    jle @F <br />    mov eax, buffer <br />    xor ecx, ecx <br />    mov cx,  <br />    mov edx, cksum <br />    add edx, ecx <br />    mov cksum, edx <br />    mov eax, buffer <br />    add eax, 2 <br />    mov buffer, eax <br />    mov ecx, dwSize <br />    sub ecx, 2 <br />    mov dwSize, ecx <br />    jmp @b <br />    @@: <br />    cmp dwSize, 0 <br />    jz @f <br />    mov edx, buffer <br />    xor eax, eax <br />    mov al,  <br />    mov ecx, cksum <br />    add ecx, eax <br />    mov cksum, ecx <br />    @@: <br />    mov edx, cksum <br />    shr edx, 10h <br />    mov eax, cksum <br />    and eax, 0FFFFh <br />    add edx, eax <br />    mov cksum, edx <br />    mov ecx, cksum <br />    shr ecx, 10h <br />    mov edx, cksum <br />    add edx, ecx <br />    mov cksum, edx <br />    mov eax, cksum <br />    not eax <br />    ret <br /><br />CheckSum ENDP</div>
    <div class="meta">Posted on 2004-10-18 13:04:54 by veria</div>
   </div>
   <div class="post" id="post-151439">
    <div class="subject"><a href="#post-151439">TCP SYN scanning</a></div>
    <div class="body">Although I'm not too good in raw socket stuff I really like it.<br />What about the tcp header's checksum!?<br /><br />MOV tcp_header.tcp_cksum, 0 <br /><br />I think it does not work because tcp packets with an invalid checksum are simply ignored by the remote system. I don't know if it helps, but this is the best raw socket tut i know: http://bsrf.org.uk/tutorials/part3.html<br />Dominik</div>
    <div class="meta">Posted on 2004-10-18 13:31:19 by Dom</div>
   </div>
   <div class="post" id="post-151443">
    <div class="subject"><a href="#post-151443">TCP SYN scanning</a></div>
    <div class="body">invoke CheckSum, ADDR pseudo_header, sizeof pseudo_header <br />MOV tcp_header.tcp_cksum, ax <br /><br />In this two line ,checksum is calculated.<br /><br />Thank you Dominik,<br />But I think, error is another thing. :?<br /><br />May be my CheckSum function is not a true manner to calculate checksum. What about this?</div>
    <div class="meta">Posted on 2004-10-18 14:40:16 by veria</div>
   </div>
   <div class="post" id="post-151447">
    <div class="subject"><a href="#post-151447">TCP SYN scanning</a></div>
    <div class="body">ok will have a lokk at your code tomorrow... :)<br />here is the checksum func.<br />USHORT checksum(USHORT *buffer, int size)<br />{<br />    unsigned long cksum=0;<br />    while (size &gt; 1)<br />    {<br />        cksum += *buffer++;<br />        size  -= sizeof(USHORT);   <br />    }<br />    if (size)<br />    {<br />        cksum += *(UCHAR*)buffer;   <br />    }<br />    cksum = (cksum &gt;&gt; 16) + (cksum &amp; 0xffff);<br />    cksum += (cksum &gt;&gt;16); <br />    return (USHORT)(~cksum); <br />}</div>
    <div class="meta">Posted on 2004-10-18 15:14:28 by Dom</div>
   </div>
   <div class="post" id="post-151466">
    <div class="subject"><a href="#post-151466">TCP SYN scanning</a></div>
    <div class="body">Your Header defs look okay. Defineatly use something like Etherreal to verify your checksums are okay. It'll also help you with any other errors in your packet.  Remember to switch hi and lo bytes in ax for port numbers (intel stores in little endian, net-byte order is big-endian). You set your TCP len to 50, it should be 50h (hi nibble is length in dwords, lo nibble is always 0). Your flag is set to ACK/FIN.  If your looking for a host listening for a tcp connection, you need to send a SYN which is 02h. A listening host will reply with an ACK/SYN (12h).  You'll also have to advertise MSS (max segment size) with your SYN packet to get a host to reply. Check out TCP options in the RFC, it should be of some help there. <br /><br />Is TCPSock a raw socket? <br /><br />Please let me know how you make out. I had problems with Winsock blocking  my hand carved TCP packets, had to do it with WinPacketCapture API instead. Thought maybe it was a 'security feature' in WinSock2.</div>
    <div class="meta">Posted on 2004-10-18 19:42:28 by The Dude of Dudes</div>
   </div>
   <div class="post" id="post-151560">
    <div class="subject"><a href="#post-151560">TCP SYN scanning</a></div>
    <div class="body">tcp_hdr STRUCT<br />    tcp_sourc_port WORD ?<br />    tcp_dest_port WORD ?<br />    tcp_seq DWORD ?<br />    tcp_ack DWORD ?<br />    tcp_len BYTE ?<br />    tcp_flag BYTE ?<br />    tcp_win WORD ?<br />    tcp_cksum WORD ?<br />    tcp_urgent WORD ?<br />tcp_hdr ENDS<br />                    <br /><br />RecvTCPPacket STRUCT<br />    IPH         ip_hdr    &lt;?&gt;<br />    TCPH        tcp_hdr   &lt;?&gt;<br />    RecvData    db 65535 DUP (?)<br />RecvTCPPacket ENDS <br /><br />SendTCPPacket STRUCT<br />    ip_header         ip_hdr    &lt;?&gt;<br />    tcp_header        tcp_hdr   &lt;?&gt;<br />SendTCPPacket ENDS<br />      <br />pseudo_hdr STRUCT <br />    src_address DWORD ?<br />    dest_address DWORD ?<br />    placeholder BYTE ?<br />    protocol BYTE ?<br />    tcp_length WORD ?<br />    tcp tcp_hdr &lt;?&gt;<br />pseudo_hdr ENDS<br />*****************************<br />invoke socket, AF_INET, SOCK_RAW, IPPROTO_RAW<br />mov TCPSock, eax <br /><br /> mov BytesRecv, 0<br /> mov SourcePort, 999<br /><br />    mov SendPacket.ip_header.ip_hlv, 45h<br />    mov SendPacket.ip_header.ip_tos, 0<br />    mov SendPacket.ip_header.ip_len, sizeof ip_hdr<br />    mov SendPacket.ip_header.ip_id, 1<br />    mov SendPacket.ip_header.ip_off, 0<br />    mov SendPacket.ip_header.ip_ttl, 255<br />    mov SendPacket.ip_header.ip_p, 6<br />    mov SendPacket.ip_header.ip_cksum, 0<br />    mov eax, SrcAddr<br />    mov SendPacket.ip_header.ip_src, eax<br />    mov eax, DestAddr<br />    mov SendPacket.ip_header.ip_dest, eax    <br />    <br />    mov ax, SourcePort<br />    MOV SendPacket.tcp_header. tcp_sourc_port, ax<br />    mov ax, DestPort<br />    MOV SendPacket.tcp_header.tcp_dest_port, ax<br />    MOV SendPacket.tcp_header.tcp_seq, 15B9184Ah<br />    MOV SendPacket.tcp_header.tcp_ack, 5D720008h<br />    MOV SendPacket.tcp_header.tcp_len, 50h<br />    MOV SendPacket.tcp_header.tcp_flag, 2h<br />    MOV SendPacket.tcp_header.tcp_win, 2000h<br />    MOV SendPacket.tcp_header.tcp_cksum, 0 	<br />    MOV SendPacket.tcp_header.tcp_urgent, 0<br /><br />    mov eax, SrcAddr<br />    mov pseudo_header.src_address, eax<br />    mov eax, DestAddr<br />    mov pseudo_header.dest_address, eax<br />    mov pseudo_header.placeholder, 0<br />    mov pseudo_header.protocol, IPPROTO_TCP<br />    mov pseudo_header.tcp_length, sizeof tcp_hdr<br /><br />    invoke memcpy, ADDR pseudo_header.tcp, ADDR  SendPacket.tcp_header, sizeof tcp_hdr<br /><br /><br />    invoke CheckSum, ADDR pseudo_header, sizeof pseudo_header<br />    MOV SendPacket.tcp_header.tcp_cksum, ax<br />    invoke CheckSum, ADDR SendPacket.ip_header, sizeof ip_hdr<br />    mov SendPacket.ip_header.ip_cksum, ax<br />       <br />    Mov socketaddr.sin_family, AF_INET<br />    mov ax, DestPort<br />    Mov socketaddr.sin_port, ax<br />    mov eax, DestAddr <br />    Mov socketaddr.sin_addr, eax<br />    mov socketaddr_len, SIZEOF socketaddr<br />    <br />    invoke sendto, TCPSock, ADDR SendPacket, sizeof SendPacket, 0, ADDR socketaddr, socketaddr_len<br />    mov ebx, sizeof SendPacket<br />    .if eax != ebx<br />         invoke Write2ListRet, ADDR szError<br />    .endif    <br /><br />    invoke recv, TCPSock, ADDR RecvPacket, sizeof RecvPacket, 0<br />    mov ebx, sizeof SendPacket<br />    .if eax != ebx<br />        invoke dwtoa, eax, ADDR intbuff<br />        invoke Write2ListRet, ADDR intbuff<br />    .endif    <br />*********************************<br />This is my new code to do Scanning. When I test it, sendto function successfully send 40 bytes of data, but recv function receive 60 byte of data with &quot;2 same ip_hdr&quot; &amp; &quot;1 tcp_hdr (with zero fields)&quot;.<br />ip_hdr+ip_hdr+tcp_hdr&lt;0&gt;<br /><br />What about setsockopt function? <br />invoke setsockopt, TCPSock, IPPROTO_IP, IP_HDRINCL, ADDR bOpt, sizeof bOpt<br /> <br />If anyone has a code that work properly, thank him if he attache it to this froum.</div>
    <div class="meta">Posted on 2004-10-19 19:57:35 by veria</div>
   </div>
   <div class="post" id="post-151565">
    <div class="subject"><a href="#post-151565">TCP SYN scanning</a></div>
    <div class="body">Go Here:<br /><br />www.ethereal.com<br /><br />and download Ethereal. It's free and will help you solve your problem. Start capturing in Ethereal then run your code. It'll show exactly what is being sent and recieved over the wire with a detailed description of each protocol field.</div>
    <div class="meta">Posted on 2004-10-19 20:59:53 by The Dude of Dudes</div>
   </div>
   <div class="post" id="post-151566">
    <div class="subject"><a href="#post-151566">TCP SYN scanning</a></div>
    <div class="body">Thank you Dude,<br />I know what's sending &amp; receiving, but I don't know why?</div>
    <div class="meta">Posted on 2004-10-19 21:04:57 by veria</div>
   </div>
   <div class="post" id="post-151584">
    <div class="subject"><a href="#post-151584">TCP SYN scanning</a></div>
    <div class="body">Black Sun Research Facility - Raw Sockets Tutorial:<br /><br /><div class="quote"><br />The setsockopt() function is very important in raw sockets, its here<br />that we tell the winsock that we want to use our own headers for this<br />packet and for it to not add its own to ours.<br />...<br />setsockopt(myraw, IPPROTO_IP, IP_HDRINCL, (char *)&amp;bOpt, sizeof(bOpt)<br /></div><br /><br />might help....besides, doesn't the ip header contains the length of the whole packet?<br /><div class="quote"><br /> mov SendPacket.ip_header.ip_len, sizeof ip_hdr <br /></div><br /><br />And try to understand the bsrf tut I quoted off (the complete tut is linked in some above post). It says that the checksum for the tcp header is calculated using a pseudo header.<br /><br />Dominik</div>
    <div class="meta">Posted on 2004-10-20 06:23:56 by Dom</div>
   </div>
   <div class="post" id="post-151607">
    <div class="subject"><a href="#post-151607">TCP SYN scanning</a></div>
    <div class="body">Thank you, Dominic<br /><br />You say right. <br />mov SendPacket.ip_header.ip_len, sizeof ip_hdr + sizeof tcp_hdr + sizeof data<br /><br />But...<br />In the following function <br />setsockopt(myraw, IPPROTO_IP, IP_HDRINCL, (char *)&amp;bOpt, sizeof(bOpt)<br />I must define IP_HDRINCL, because this constant didn't define in the masm32 inc files. but i don't know its amount.<br />IP_HDRINCL equ ? <br />You know?</div>
    <div class="meta">Posted on 2004-10-20 16:59:58 by veria</div>
   </div>
   <div class="post" id="post-151611">
    <div class="subject"><a href="#post-151611">TCP SYN scanning</a></div>
    <div class="body">noprob: #define IP_HDRINCL 2<br /><br />By the way, did you already implement the pseudo header for calculating the checksum!?<br /> <br />As we all know this should be the fastest way of scanning a machine. Actually, does it work already? In order to improve needed time I would recommend to work with several threads later on....let me know if it works.<br /><br />Dominik</div>
    <div class="meta">Posted on 2004-10-20 18:35:26 by Dom</div>
   </div>
   <div class="post" id="post-151612">
    <div class="subject"><a href="#post-151612">TCP SYN scanning</a></div>
    <div class="body"><div class="quote">noprob: #define IP_HDRINCL 2<br /><br />By the way, did you already implement the pseudo header for calculating the checksum!?<br /> <br /></div><br /><br />Yes I do;<br />and you say right, when my code do one thread scanning I try to write multithread version of it.<br /><br />But for now, when I define IP_HDRINCL equ 2, and:<br />bOpt                    byte        1<br />TCPSock                 SOCKET      0<br />***********************************<br />invoke socket, AF_INET, SOCK_RAW, IPPROTO_RAW<br />mov TCPSock, eax<br /><br />invoke setsockopt, TCPSock, IPPROTO_IP, IP_HDRINCL, ADDR bOpt, sizeof bOpt<br />.if eax == SOCKET_ERROR<br />        invoke WSAGetLastError<br />        invoke dwtoa, eax, ADDR intbuff<br />        invoke Write2ListRet, ADDR intbuff<br />        ret<br />.endif<br />************************************<br />In this way, an error(10014) recieve.<br /><br />**WSAEFAULT (10014)<br />Bad address<br />The system detected an invalid pointer address in attempting to use a pointer argument of a call. This error occurs if an application passes an invalid pointer value, or if the length of the buffer is too small. For instance, if the length of an argument which is a struct sockaddr is smaller than sizeof(struct sockaddr).**<br /><br />What's wrong in my code Dominik?</div>
    <div class="meta">Posted on 2004-10-20 19:28:36 by veria</div>
   </div>
   <div class="post" id="post-151613">
    <div class="subject"><a href="#post-151613">TCP SYN scanning</a></div>
    <div class="body">I'm sorry that I skipped the pseudo header part of your code :)<br /><br />As windows likes 32-bit more than optimization I got it to work like this:<br /><br /><pre><code><br />LOCAL bOpt&#58;DWORD<br />mov bOpt, TRUE<br />invoke setsockopt, hsock, IPPROTO_IP, IP_HDRINCL, addr bOpt, 4d<br /></code></pre><br /><br /><br />Dominik</div>
    <div class="meta">Posted on 2004-10-20 20:14:45 by Dom</div>
   </div>
   <div class="post" id="post-151615">
    <div class="subject"><a href="#post-151615">TCP SYN scanning</a></div>
    <div class="body">Thank you Dominik, for your replys,<br />I do this changes, but still error(10014) is been.</div>
    <div class="meta">Posted on 2004-10-20 20:25:35 by veria</div>
   </div>
   <div class="post" id="post-151617">
    <div class="subject"><a href="#post-151617">TCP SYN scanning</a></div>
    <div class="body">When I change position of calling setsockopt function, the 10014 error was disapear, but came back again in this line:<br /><br />invoke sendto, TCPSock, ADDR SendPacket, sizeof SendPacket, 0, ADDR socketaddr, socketaddr_len<br />mov ebx, sizeof SendPacket<br />.if eax != ebx<br />        invoke WSAGetLastError<br />        invoke dwtoa, eax, ADDR intbuff<br />        invoke Write2ListRet, ADDR intbuff<br />.endif</div>
    <div class="meta">Posted on 2004-10-20 21:48:53 by veria</div>
   </div>
   <div class="post" id="post-151635">
    <div class="subject"><a href="#post-151635">TCP SYN scanning</a></div>
    <div class="body">You can use this macro in order to get the winsock error msg.<br /><br /><pre><code><br />WSAShowLastError macro<br />.data<br />errc dd ?<br />pmsg dd ?<br />.code<br />invoke WSAGetLastError<br />mov errc, eax<br />invoke FormatMessage, FORMAT_MESSAGE_ALLOCATE_BUFFER or FORMAT_MESSAGE_FROM_SYSTEM, 0h, errc, 0h, addr pmsg, 0h, 0h<br />invoke MessageBox, 0h, pmsg, S&#40;'WSA Error Notification'&#41;, MB_ICONERROR<br />invoke LocalFree, pmsg<br />endm<br /><br /><br />S macro data&#58;VARARG<br />LOCAL Buff<br />.data<br />Buff db data, 0h<br />.code<br />exitm &lt;addr Buff&gt;<br />endm<br /></code></pre><br /><br />I think your 10014 err is the following: &quot;The System detected an invalid pointer address in attempting to use a pointer argument in a call.&quot;<br />Dominik</div>
    <div class="meta">Posted on 2004-10-21 06:28:40 by Dom</div>
   </div>
   <div class="post" id="post-151656">
    <div class="subject"><a href="#post-151656">TCP SYN scanning</a></div>
    <div class="body">Thank you Dominik,<br />But I can't understand, what's wrong in my code. My mind is conflicted.<br />I post my last attempt to do this. If you will can do it at any time, thank you for sending me your expriments.<br /><pre><code><br />    sockaddrlen             DWORD       0<br />    bOpt                    byte       TRUE<br />    <br />    SendPacket              SendTCPPacket &lt;&gt;<br />    socketaddr              sockaddr_in &lt;&gt;<br />    TCPSock                 SOCKET      0 <br />    szlocalhost             db &quot;127.0.0.1&quot;, 0   <br />    pPacket                 dd          0<br /><br />*******************************************<br />                 invoke socket, AF_INET, SOCK_RAW, IPPROTO_RAW<br />                 .if eax == SOCKET_ERROR<br />                    invoke WSAGetLastError<br />                    invoke dwtoa, eax, ADDR intbuff<br />                    invoke Write2ListRet, ADDR intbuff<br />                    ret<br />                .endif            <br />                mov TCPSock, eax<br />                invoke setsockopt, TCPSock, IPPROTO_IP, IP_HDRINCL,      ADDR bOpt, sizeof bOpt<br />                .if eax == SOCKET_ERROR<br />                    invoke WSAGetLastError<br />                    invoke dwtoa, eax, ADDR intbuff<br />                    invoke Write2ListRet, ADDR intbuff<br />                    ret<br />                .endif<br />    <br />                 invoke inet_addr, ADDR szlocalhost<br />                .if eax==INADDR_NONE<br />                    invoke gethostbyname, ADDR szlocalhost<br />                    mov eax,&#91;eax+12&#93;<br />                    mov eax,&#91;eax&#93;<br />                    mov eax,&#91;eax&#93;<br />                    mov DestinationAddr,eax<br />                .else<br />                    mov DestinationAddr,eax<br />                .endif<br />                invoke GetLocalIPAddress<br />                mov eax, IPAddress<br />                mov SourceAddr, eax<br />                mov i, 1<br />                invoke htons, i<br />                mov port, ax<br />                mov SourcePort, 999      <br />   <br />    invoke GlobalAlloc, 0, 40<br />    mov pPacket, eax <br />    invoke memset, pPacket, 0, 40<br />    mov ebx, pPacket<br />    mov &#40;ip_hdr ptr &#91;ebx&#93;&#41;.ip_hlv, 45h<br />    mov &#40;ip_hdr ptr &#91;ebx&#93;&#41;.ip_tos, 0<br />    mov &#40;ip_hdr ptr &#91;ebx&#93;&#41;.ip_len, sizeof ip_hdr + sizeof tcp_hdr<br />    mov &#40;ip_hdr ptr &#91;ebx&#93;&#41;.ip_id, 1<br />    mov &#40;ip_hdr ptr &#91;ebx&#93;&#41;.ip_off, 0<br />    mov &#40;ip_hdr ptr &#91;ebx&#93;&#41;.ip_ttl, 128<br />    mov &#40;ip_hdr ptr &#91;ebx&#93;&#41;.ip_p, 6<br />    mov &#40;ip_hdr ptr &#91;ebx&#93;&#41;.ip_cksum, 0<br />    mov eax, SourceAddr<br />    mov &#40;ip_hdr ptr &#91;ebx&#93;&#41;.ip_src, eax<br />    mov eax, DestinationAddr<br />    mov &#40;ip_hdr ptr &#91;ebx&#93;&#41;.ip_dest, eax    <br />    xor eax, eax<br />    mov al, &#40;ip_hdr ptr &#91;ebx&#93;&#41;.ip_ttl<br />    invoke dwtoa, eax, ADDR intbuff<br />    invoke Write2ListRet, ADDR intbuff<br /><br />    add ebx, 20<br />    invoke htons, SourcePort<br />    MOV &#40;tcp_hdr ptr &#91;ebx&#93;&#41;.tcp_sourc_port, ax<br />    mov ax, port<br />    MOV &#40;tcp_hdr ptr &#91;ebx&#93;&#41;.tcp_dest_port, ax<br />    MOV &#40;tcp_hdr ptr &#91;ebx&#93;&#41;.tcp_seq, 15B9184Ah<br />    MOV &#40;tcp_hdr ptr &#91;ebx&#93;&#41;.tcp_ack, 5D720008h<br />    MOV &#40;tcp_hdr ptr &#91;ebx&#93;&#41;.tcp_len, 50h<br />    MOV &#40;tcp_hdr ptr &#91;ebx&#93;&#41;.tcp_flag, 2<br />    invoke htons, 65535<br />    MOV &#40;tcp_hdr ptr &#91;ebx&#93;&#41;.tcp_win, ax<br />    MOV &#40;tcp_hdr ptr &#91;ebx&#93;&#41;.tcp_cksum, 0 	<br />    MOV &#40;tcp_hdr ptr &#91;ebx&#93;&#41;.tcp_urgent, 0<br /><br />    mov eax, SourceAddr<br />    mov pseudo_header.src_address, eax<br />    mov eax, DestinationAddr<br />    mov pseudo_header.dest_address, eax<br />    mov pseudo_header.placeholder, 0<br />    mov pseudo_header.protocol, IPPROTO_TCP<br />    invoke htons, sizeof tcp_hdr <br />    mov pseudo_header.tcp_length, ax <br /><br />    invoke memcpy, ebx, ADDR pseudo_header.tcp, sizeof tcp_hdr<br /><br />    invoke CheckSum, ADDR pseudo_header, sizeof pseudo_header<br />    MOV &#40;tcp_hdr ptr &#91;ebx&#93;&#41;.tcp_cksum, ax<br />    sub ebx, 20<br />    invoke CheckSum, ebx, sizeof ip_hdr<br />    mov &#40;ip_hdr ptr &#91;ebx&#93;&#41;.ip_cksum, ax<br />       <br />    Mov socketaddr.sin_family, AF_INET<br />    mov ax, port<br />    Mov socketaddr.sin_port, ax<br />    mov eax, DestinationAddr <br />    Mov socketaddr.sin_addr, eax<br />    mov socketaddr_len, SIZEOF sockaddr_in     <br /><br />    <br />    invoke sendto, TCPSock, pPacket, 40, 0, ADDR socketaddr, socketaddr_len<br />    .if eax == SOCKET_ERROR<br />        invoke WSAGetLastError<br />        invoke dwtoa, eax, ADDR intbuff<br />        invoke Write2ListRet, ADDR intbuff        <br />    .endif    <br /><br />    invoke recv, TCPSock, ADDR RecvPacket, sizeof RecvPacket, 0<br />    mov ebx, sizeof SendPacket<br />    .if eax != ebx<br />        invoke ntohs, eax<br />        invoke dwtoa, eax, ADDR intbuff<br />        invoke Write2ListRet, ADDR intbuff<br />    .endif    <br /></code></pre></div>
    <div class="meta">Posted on 2004-10-21 17:13:21 by veria</div>
   </div>
   <div class="post" id="post-151723">
    <div class="subject"><a href="#post-151723">TCP SYN scanning</a></div>
    <div class="body">Veria,<br /><br /><br />Change your flag size in setsockopt. You have bOpt defined as a byte, change it to a dword.</div>
    <div class="meta">Posted on 2004-10-23 10:36:08 by The Dude of Dudes</div>
   </div>
   <div class="post" id="post-151725">
    <div class="subject"><a href="#post-151725">TCP SYN scanning</a></div>
    <div class="body">Hi,<br />   Are you using win2k? I use win98 so I had the same prob and abadoned the idea :(  . IP_HDRINCL works only on Win2k and above ( I think XP too). Hope this helps!!<br /><br />Thomas Antony</div>
    <div class="meta">Posted on 2004-10-23 11:03:58 by thomasantony</div>
   </div>
   <div class="post" id="post-151736">
    <div class="subject"><a href="#post-151736">TCP SYN scanning</a></div>
    <div class="body">The Dude of Dudes,<br />I use the DWORD type for it, previously, but nothing was change.<br /><br />Thomas Antony,<br />I use WinXP.</div>
    <div class="meta">Posted on 2004-10-23 14:22:33 by veria</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=19691&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=19691&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="19691" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=19691&amp;page=2">&gt;</a><a href="../?id=19691&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>