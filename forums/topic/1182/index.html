<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>new versions of qw2a - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=1182" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=1182">new versions of qw2a</a></p>
   <div class="post" id="post-7765">
    <div class="subject"><a href="#post-7765">new versions of qw2a</a></div>
    <div class="body">It's again about 64x bit integer to dec ASCIIZ convertion.<br />In these two versions you can see MMX commands and bsr logic<br />calculation.<br />They run faster (last is fastest though biggest) but mostly disign for new processors like PIII, 'cause bsr is designed in different way there and run much faster than in old arch. procs(~3 clocks).<br /><br />For those who a really want to become programmers I recommend to look at the second proc - there is some new logic you can you in different tasks.<br />I don't want to spoil surprise :)<br />So you should figure out the logic yourself - I promise this homework worth it.<br /><br />64mmx:<br /><pre><code><br />.586<br />.MMX<br />.model flat,stdcall<br />option casemap&#58;none<br />include C&#58;\masm32\include\windows.inc<br />include C&#58;\masm32\include\user32.inc<br />include C&#58;\masm32\include\kernel32.inc<br />includelib kernel32.lib<br />includelib user32.lib<br />.data<br />mmxb0F dq 0F0F0F0F0F0F0F0Fh<br />mmxb30 dq 3030303030303030h<br />num dq 12345678901234567890<br />.data?<br />buffer db 24 dup &#40;?&#41;<br />.code<br />start&#58;<br />	mov edx,dword ptr num+4<br />	mov eax,dword ptr num<br />	mov edi, offset buffer<br />	call QtoA<br />	invoke MessageBox,0,offset buffer,0,0<br />	call ExitProcess<br />N19H EQU 00DE0B6B3H<br />N19L EQU 0A7640000H<br />N20H EQU 08AC72304H<br />N20L EQU 089E80000H<br /><br />QtoA&#58;<br />	sub esp,12<br />	xor ecx,ecx<br />	cmp edx,N19H<br />	jb     @@nm18<br />	jne   @@cp20<br />	cmp eax,N19L<br />	jb     @@nm18<br />@@cp20&#58;<br />	cmp edx,N20H<br />	jb     @@do19<br />	jne   @@do20<br />	cmp eax,N20L<br />	jb     @@do19<br />@@do20&#58;<br />	mov cl,10h-1<br />	sub  eax,N20L<br />	sbb edx,N20H<br />@@lp19&#58;<br />	inc ecx<br />@@do19&#58;<br />	sub eax,N19L<br />	sbb edx,N19H<br />	jae  @@lp19<br />	add eax,N19L<br />	adc edx,N19H<br />@@nm18&#58;<br />	push edx<br />	push eax<br />	fild qword ptr &#91;esp&#93;<br />	fbstp &#91;esp&#93;<br />	mov &#91;esp+9&#93;,ecx<br /><br />	mov edx,2<br />	cmp dword ptr &#91;esp+8&#93;,0<br />	jne @@dg16<br />	cmp dword ptr &#91;esp+4&#93;,1<br />	sbb edx,1<br />@@dg16&#58;<br />	bsr ecx,&#91;esp+edx*4&#93;<br />	je @@zero<br />	shr ecx,3<br />	lea eax,&#91;ecx+4*edx&#93;<br />	lea edx,&#91;eax+eax&#93;<br />	cmp byte ptr &#91;esp&#93;&#91;eax&#93;,10h<br />	sbb edx,-1<br /><br />	movq mm&#40;7&#41;,mmxb0F<br />	movq mm&#40;6&#41;,mmxb30<br />	movq mm&#40;0&#41;,&#91;esp&#93;<br />	movq mm&#40;4&#41;,&#91;esp+8&#93;<br />	movq mm&#40;1&#41;,mm&#40;0&#41;<br />	psrlq mm&#40;1&#41;,4<br />	pand mm&#40;0&#41;,mm&#40;7&#41;<br />	por    mm&#40;0&#41;,mm&#40;6&#41;<br />	pand mm&#40;1&#41;,mm&#40;7&#41;<br />	por mm&#40;1&#41;,mm&#40;6&#41;<br />	movq mm&#40;2&#41;,mm&#40;0&#41;<br />	punpcklbw mm&#40;0&#41;,mm&#40;1&#41;<br />	movq &#91;esp&#93;,mm&#40;0&#41;<br />	punpckhbw mm&#40;2&#41;,mm&#40;1&#41;<br />	movq &#91;esp+8&#93;,mm&#40;2&#41;<br />	movq mm&#40;5&#41;,mm&#40;4&#41;<br />	psrlq mm&#40;5&#41;,4<br />	pand mm&#40;4&#41;,mm&#40;7&#41;<br />	por mm&#40;4&#41;,mm&#40;6&#41;<br />	pand mm&#40;5&#41;,mm&#40;7&#41;<br />	por mm&#40;5&#41;,mm&#40;6&#41;<br />	punpcklbw mm&#40;4&#41;,mm&#40;5&#41;<br />	movd &#91;esp+16&#93;,mm&#40;4&#41;<br />	emms<br />@@lpS&#58;<br />	mov eax,&#91;esp+edx-3&#93;<br />	bswap eax<br />	mov &#91;edi&#93;,eax<br />	add edi,4<br />	sub edx,4<br />	jns  @@lpS<br />	mov byte ptr &#91;edi&#93;&#91;edx&#93;&#91;1&#93;,0<br />	add esp,20<br />	ret<br />@@zero&#58;<br />	mov dword ptr &#91;edi&#93;,'0'<br />	add esp,20<br />	ret<br /><br />	end start<br />;64mmx2<br /><br />.586<br />.MMX<br />.model flat,stdcall<br />option casemap&#58;none<br />include C&#58;\masm32\include\windows.inc<br />include C&#58;\masm32\include\user32.inc<br />include C&#58;\masm32\include\kernel32.inc<br />includelib kernel32.lib<br />includelib user32.lib<br />.data<br />mmxb0F dq 0F0F0F0F0F0F0F0Fh<br />mmxb30 dq 3030303030303030h<br />num dq 12345678901234567890<br />.data?<br />buffer db 24 dup &#40;?&#41;<br />.code<br />start&#58;<br />	mov edx,dword ptr num+4<br />	mov eax,dword ptr num<br />	mov edi, offset buffer<br />	call QtoA<br />	invoke MessageBox,0,offset buffer,0,0<br />	call ExitProcess<br />;N19H EQU 00DE0B6B3H<br />;N19L EQU 0A7640000H<br />;N20H EQU 08AC72304H<br />;N20L EQU 089E80000H<br /><br />D05H	equ 045639182h<br />D05L	equ 044F40000h<br />D04H	equ 03782DACEh<br />D04L	equ 09D900000h<br />D01H	equ 00DE0B6B3h<br />D01L	equ 0A7640000h<br />QtoA&#58;<br />	sub esp,12<br />	xor ecx,ecx<br />	sub eax,D01L<br />	sbb edx,D01H<br />	jb    @@a01f<br />	sub eax,D04L<br />	sbb edx,D04H<br />	jb    @@a05<br />	mov cl,05h<br />	sub eax,D05L<br />	sbb edx,D05H<br />	jb    @@a05<br />	mov cl,15h<br />	sub eax,D05L<br />	sbb edx,D05H<br />	jae  @@l01<br />	mov cl,10h<br />@@a05&#58;<br />	add eax,D05L<br />	adc edx,D05H<br />@@l01&#58;	inc ecx<br />	sub eax,D01L<br />	sbb edx,D01H<br />	jae  @@l01<br />	dec ecx<br />@@a01f&#58;<br />	add eax,D01L<br />	adc edx,D01H<br /><br />	push edx<br />	push eax<br />	fild qword ptr &#91;esp&#93;<br />	fbstp &#91;esp&#93;<br />	mov &#91;esp+9&#93;,ecx<br /><br />	mov edx,2<br />	cmp dword ptr &#91;esp+8&#93;,0<br />	jne @@dg16<br />	cmp dword ptr &#91;esp+4&#93;,1<br />	sbb edx,1<br />@@dg16&#58;<br />	bsr ecx,&#91;esp+edx*4&#93;<br />	je @@zero<br />	shr ecx,3<br />	lea eax,&#91;ecx+4*edx&#93;<br />	lea edx,&#91;eax+eax&#93;<br />	cmp byte ptr &#91;esp&#93;&#91;eax&#93;,10h<br />	sbb edx,-1<br /><br />	movq mm&#40;7&#41;,mmxb0F<br />	movq mm&#40;6&#41;,mmxb30<br />	movq mm&#40;0&#41;,&#91;esp&#93;<br />	movq mm&#40;4&#41;,&#91;esp+8&#93;<br />	movq mm&#40;1&#41;,mm&#40;0&#41;<br />	psrlq mm&#40;1&#41;,4<br />	pand mm&#40;0&#41;,mm&#40;7&#41;<br />	por    mm&#40;0&#41;,mm&#40;6&#41;<br />	pand mm&#40;1&#41;,mm&#40;7&#41;<br />	por mm&#40;1&#41;,mm&#40;6&#41;<br />	movq mm&#40;2&#41;,mm&#40;0&#41;<br />	punpcklbw mm&#40;0&#41;,mm&#40;1&#41;<br />	movq &#91;esp&#93;,mm&#40;0&#41;<br />	punpckhbw mm&#40;2&#41;,mm&#40;1&#41;<br />	movq &#91;esp+8&#93;,mm&#40;2&#41;<br />	movq mm&#40;5&#41;,mm&#40;4&#41;<br />	psrlq mm&#40;5&#41;,4<br />	pand mm&#40;4&#41;,mm&#40;7&#41;<br />	por mm&#40;4&#41;,mm&#40;6&#41;<br />	pand mm&#40;5&#41;,mm&#40;7&#41;<br />	por mm&#40;5&#41;,mm&#40;6&#41;<br />	punpcklbw mm&#40;4&#41;,mm&#40;5&#41;<br />	movd &#91;esp+16&#93;,mm&#40;4&#41;<br />	emms<br /><br />@@lpS&#58;<br />	mov eax,&#91;esp+edx-3&#93;<br />	bswap eax<br />	mov &#91;edi&#93;,eax<br />	add edi,4<br />	sub edx,4<br />	jns  @@lpS<br />	mov byte ptr &#91;edi&#93;&#91;edx&#93;&#91;1&#93;,0<br />	add esp,20<br />	ret<br />@@zero&#58;<br />	mov dword ptr &#91;edi&#93;,'0'<br />	add esp,20<br />	ret<br /><br />	end start<br /></code></pre></div>
    <div class="meta">Posted on 2001-09-22 11:41:18 by The Svin</div>
   </div>
  </div>
 </body>
</html>