<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Another Bootsector Problem - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=29563" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=29563">Another Bootsector Problem</a></p>
   <div class="post" id="post-208777">
    <div class="subject"><a href="#post-208777">Another Bootsector Problem</a></div>
    <div class="body">Thanks to all who helped me with my last problem. &nbsp;I have another one which I just can&#039;t seem to wrap my mind around. Here is my source in NASM syntax:<br /><br />;XIX System 19 BootSector - Version pre-Alpha<br />;this will eventually be able to boot the kernel of XIX<br />;some time in the future, implement the ability to boot<br />;multiple systems, and allow debugging messages<br /><br />	;assembler directive for 16-bit code<br />	;assembler directive to set origin to 0x7C00<br /><br />;main function for booting up and setting up the kernel through the bootsector<br />boot:<br />	mov , dl	;save the boot drive number to bootdrv, (0x00 = floppy)<br /><br />	lea si, 	;loadeffectiveaddress of sysmess into StringIndex<br />	call prnt		;call the prnt function<br /><br />	call stkset		;call the stkset function<br />	call prnt		;call the prnt function<br /><br />	call a20en		;call the a20en function<br />	call prnt		;call the prnt function<br /><br />	call gdtset		;call the gdtset function<br />	call prnt		;call the prnt function<br /><br />	hlt			;REMOVE AFTER TEST	<br /><br /><br />;sub-function for printing the loaded string<br />prnt:<br />	mov ah, 0x0E		;load teletype character (we want to print something)<br />	mov bh, 0x00		;tell to print on page 1<br />	mov bl, 0x07		;black background, white text, non-flashing<br /><br />	.nextchar		;label to jump to for repeating until finished<br />	lodsb			;loads SI into AL for printing<br />	or al, al		;set zero flag if AL = nullchar &#039;0&#039; (set at end of message)<br /><br />	jz .end			;if zero flag set, go to end of sub-function<br /><br />	int 0x10		;run BIOS video interrupt to prin message<br />	jmp .nextchar		;jump and repeat<br /><br />	.end<br />ret<br /><br />;sub-function for setting up the stack<br />stkset:<br />	mov ax, cs		;setup the ds register indirectly<br />	mov ds, ax<br />	mov es, ax<br />	mov fs, ax<br /><br />	mov ax, 0x1D0		;setup stack at 0x1D00<br />	mov ss, ax		;align stack<br />	mov sp, 0x200		;set StackPointer to denote 512 byte stack<br /><br />	mov ax, 0xb800		;setup video segment<br />	mov gs, ax<br /><br />	lea si, 	;loadeffectiveaddress of stkmess into StringIndex<br />ret<br /><br />;sub-function for setting up a20<br />a20en:<br />	in al, 0x92<br />	or al, 2<br />	out 0x92, al<br />	<br />	lea si, 	;loadeffectiveaddress of a20mess into StringIndex<br />ret<br /><br />;sub-function for setting up the Global Descriptor Table<br />gdtset:<br />	xor ax, ax		;moving GDT to 0x500<br />	mov ds, ax<br />	mov es, ax<br />	<br />	mov si, gdt		;move from <br />	mov di, 	;move to <br />	mov cx, 	;size of GDT<br />	<br />	cld			;clear the direction flag<br /><br />	rep movsb		;move the GDT<br />	lea si, <br />ret<br /><br /><br />;variables for data and strings<br />bootdrv	db 0		;will be set to the boot drive number (hopefully 0x00)<br /><br /><br />sysmess	db &#039;XIX System 19 BootSector - Version pre-Alpha&#039;,13,10,10,0	;string to print<br />									;13 - character return<br />									;10 - new line<br />									;0 - null character<br /><br />stkmess db &#039;Memory Stack Successfully Setup&#039;,13,10,10,0	;tell that Memory Stack has been setup<br /><br />a20mess db &#039;A20 Successfully Enabled&#039;,13,10,10,0	;tell that A20 has been enabled<br /><br />gdtmess db &#039;GDT Successfully Setup&#039;,13,10,10,0		;tell that GDT has been setup<br /><br /><br />gdtr:			;really basic GDT table<br />	gdtsize dw gdtend-gdt-1	;size of GDT<br />	gdtbase dd 0x500	;where the GDT starts, at 0x500 in memory<br /><br />gdt:<br />	nullsel	equ $-gdt	;null descriptor is a must (64-bit per entry)<br />		dd 0x00<br />		dd 0x00<br /><br />	codesel equ $-gdt	;code selector is 4GB with max 0xFFFFF limit<br />		dw 0xFFFF	;limit(2) of selector - 0xFFFFF<br />		dw 0x0		;base(3) of selector - 0x0<br />		db 0x0		;base(2) of selector - 0x0<br />		db 0x9A		;type of selector - present,ring0,code,exec/read/accessed (10011000)<br />		db 0xCF		;limit(1) of selector - 0xF 4KB 32bit (11001111)<br />		db 0x0		;base(1) of selector - 0x0<br /><br />	datasel	equ $-gdt	;code selector is 4GB with max 0xFFFFF limit<br />		dw 0xFFFF	;limit(2) of selector - 0xFFFFF<br />		dw 0x0		;base(3) of selector - 0x0<br />		db 0x0		;base(2) of selector -0x0<br />		db 0x92		;type of selector - present,ring0,data/stack,read/write (10010010)<br />		db 0xCF		;limit(1) of selector - 0xF 4KB 32bit (11001111)<br />		db 0x0		;base (1) of selector - 0x0<br /><br />gdtend:			;just an empty function for end of GDT	<br /><br /><br />;appendages for bootloader<br />times 510-($-$$) db 0		;fill unused space upto 510 bytes with 0<br />signature dw 0xAA55		;set bootloader signature<br />	<br /><br /><br />Pretty much, I have isolated it to the line in the stkset function:<br /> mov ax, 0x1D0		;setup stack at 0x1D00<br /><br />the thing is, it works when i put it in the main section of the program, but not where it currently is now.<br /><br />I WOULD take and put it where I know it works, but I need an answer WHY this doesn&#039;t work.<br /><br />Any help would be greatly appreciated.</div>
    <div class="meta">Posted on 2009-09-14 15:34:06 by XeonX369</div>
   </div>
   <div class="post" id="post-208778">
    <div class="subject"><a href="#post-208778">Re: Another Bootsector Problem</a></div>
    <div class="body">CALL pushes the return address onto the stack. RET pops the return address from the stack.</div>
    <div class="meta">Posted on 2009-09-14 16:04:15 by SpooK</div>
   </div>
  </div>
 </body>
</html>