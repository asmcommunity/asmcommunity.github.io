<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>XCB - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=29995" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=10">Graphics &amp; Game Development</a> &raquo; <a href="../?id=29995">XCB</a></p>
   <div class="post" id="post-211748">
    <div class="subject"><a href="#post-211748">XCB</a></div>
    <div class="body">okay, I&#039;m not entirely sure what to say first, my thoughts seem to be in need of a defragment..<br /><br />XCB is rated faster than xlib in the tutorial. I think some toolkits have switched to using it for the x protocol instead of xlib. you can read more about it on xcb.freedesktop.org - specifically, the xcb tutorial. Also, it&#039;s been ported to win32 - might even make some nice examples for the nasmx project..<br /><br />fbkotler and I have been trying to get some xcb examples up and running on the yahoo nasm group. Turns out to be a fairly complicated task..<br /><br />Attached to this post is the latest progress we&#039;ve (mostly Kotler!) made toward a working example. I think the hardest part of it is understanding the structures behind it. What we tried is to compile an example from the XCB site and try to translate it to NASM syntax.<br /><br />I think the .inc files are a bit broke - used h2inc and then poked around with them a bit.<br /><br />The working example is in prog5.asm. my main.asm segfaults on in the program as I never cleaned up the stack. main.asm seems to be a good start especailly at comprehending what&#039;s going on, but it needs work.<br /><br />the main thing throwing us a curve ball in main.asm is the same as prog5.asm - I *think* it has to do with the calling convention of passing a structure. The odd thing is how it takes two paramiters. xcb_setup_roots_iterator takes ebp-24h (frank has a %define for iter_dest) which is somewhere on the stack. It has to do with this one line of C code &quot;s = xcb_setup_roots_iterator( xcb_get_setup(c) ).data;&quot; I get the feeling I&#039;m going to need to pass it the same way in main.asm if I&#039;m to make an progress. I think xcb_generic_iterator_t has to do with it as it&#039;s a .data section.<br /><br />I&#039;ve been told the way structures on passed on linux in x86 has to do with &quot;i386-ABI&quot; and if they are so many bytes then they are passed through the stack<br /><br />I might add more to this post in the morning, that&#039;s all I can think of right now. Love to hear anyone&#039;s thoughts on this - seems to have some potential. It&#039;s just parts of it are slightly over my head right now - particularly translating C code to asm in order to just get an understanding of whats going on. I think the &quot;xstruc&quot; macros may even help.</div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=3140" target="_blank">post.zip</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2010-05-17 01:36:40 by Brainiac</div>
   </div>
   <div class="post" id="post-211767">
    <div class="subject"><a href="#post-211767">Re: XCB</a></div>
    <div class="body">First off, maybe we should specify that libxcb is an alternative to libXlib. Supposed to be &quot;lighter weight&quot;, and faster...<br /><br />May be worth duplicating, in part, my last message on the subject to the !Yahoo! list. *My* confusion is more from the &quot;secret parameter&quot; than with structures...<br /><br /><div class="quote"><br />Back to XCB... it&#039;s really throwing me a curve ball! I&#039;ve got a<br />&quot;working&quot; (for me) example, with .inc files and &quot;nice&quot;(?) names and<br />all... but I don&#039;t comprehend what I&#039;m doing! Started off<br />straightforward enough...<br /><br />push ebp<br />mov ebp, esp<br />sub esp, 120<br /><br />; of all that, this is all we use?<br />%define iter_dest ebp-24h<br /><br />; connect to display<br />push 0 ; screen<br />push 0 ; display<br />call xcb_connect<br />lea esp, <br /><br />mov dword , eax<br /><br />; check for error (lacking the wit to return an error)<br />push dword <br />call xcb_connection_has_error<br />lea esp, <br /><br />test eax, eax<br />jz good_conn<br /><br />; scream and die<br />push err_msg<br />call puts<br />lea esp, <br />push 1<br />call exit<br /><br />good_conn:<br />push dword <br />call xcb_get_setup<br />lea esp, <br /><br />But now, although you&#039;d never guess it from the C source,<br />xcb_setup_roots_iterator appears to take two parameters (a &quot;source&quot; and<br />a &quot;destination&quot;?). The one that shows is the return from get_setup - a<br />pointer to an xcb_setup_t structure, I believe. The other - a mysterious<br />location on the stack - appears to be an instance of an<br />xcb_generic_iterator_t structure... I think...<br /><br />push eax<br />; secret parameter?<br />lea edx, <br />push edx<br />call xcb_setup_roots_iterator<br />; note that the secret parameter is removed by callee!<br />lea esp, <br /><br />Looking at the direct disassembly of the C code, I was mystified by...<br /><br />lea edx, <br />mov dword , eax<br />mov dword , edx<br />call xcb_setup_roots_iterator<br />sub esp, 4 ; ???<br /><br />What&#039;s the &quot;sub esp, 4&quot; for??? One advantage of doing it &quot;this way&quot; is<br />that mov is faster than push. The other is that we don&#039;t have to clean<br />up stack after every call. After subtracting a bunch from the stack to<br />begin with, we&#039;re subtracting 4 more after every call... no, after<br />&quot;certain calls&quot;... Apparently, xcb_setup_roots_iterator ends in &quot;ret 4&quot;,<br />adding 4 to the stack to get rid of that &quot;secret&quot; parameter, and we have<br />to subtract it again to get back to where we wanted to be...<br /><br /><br /><br />So we&#039;ve called xcb_setup_roots_iterator with the address of a memory<br />area as a &quot;bonus&quot; parameter. This memory gets filled in with an<br />xcb_???_iterator_t structure - different names for &quot;???&quot; seem to be all<br />the same structure - &quot;generic&quot; may not be right. The first element,<br />&quot;.data&quot; points to... well, I&#039;d have said an &quot;xcb_setup_t&quot; structure, but<br />it seems to be a &quot;screen&quot;. Other elements are, at offset 4, &quot;.rem&quot;<br />(count of remaining???), which we don&#039;t seem to use, and at offset 8,<br />&quot;.index&quot;... which we use as a &quot;secret parameter&quot; to other calls later. I<br />may be misinterpreting this.<br /><br />; &quot;first screen&quot;<br />mov eax, dword <br />mov dword , eax<br /><br />This seems to be a pointer to an xcb_screen_t structure - we use some of<br />its elements as &quot;normal&quot; parameters to later calls...<br /><br />I guess it goes along pretty self-explanatory...<br /><br />...<br />; set up some data for our window<br />mov dword , XCB_CW_BACK_PIXEL | XCB_CW_EVENT_MASK<br /><br />mov eax, dword <br />mov eax, dword <br />mov dword , eax<br />mov dword , XCB_EVENT_MASK_EXPOSURE\<br />| XCB_EVENT_MASK_KEY_PRESS<br /><br />This might be worth pointing out. Unlike Windows, we are notified of<br />events only if we ask for &#039;em. In a &quot;real&quot; program, this would be a much<br />longer list (thus Nasm&#039;s line-continuation character &#039;\&#039;). Each of these<br />constants has one bit set, and we &quot;or&quot; &#039;em together to tell X which<br />events we want to see.<br /><br />Note that when I get to the end, I don&#039;t bother cleaning up the stack,<br />since I&#039;m exiting with &quot;exit()&quot; instead of &quot;ret&quot;. Since the &quot;_start:&quot;<br />label isn&#039;t called, we can&#039;t &quot;ret&quot;. If you wanted to change this back to<br />an entrypoint of &quot;main:&quot;, and end with &quot;ret&quot;... you&#039;d have to fix<br />that... and preserve ebx, esi, edi...<br /><br />I do it this way - calling C library functions without linking in C<br />startup code - just to see if it&#039;ll work again. I&#039;ve been told that, &quot;Of<br />course you need the startup code if you expect the libraries to work<br />correctly!&quot; Makes sense to me. But I find that I *don&#039;t* need it. So<br />far, everything I&#039;ve tried has worked without it. I don&#039;t particularly<br />recommend it, but I keep tryin&#039; it, and it keeps workin&#039;...<br /><br />The .inc files, xcb.inc and xproto.inc are buggy, no doubt. The parts<br />I&#039;m actually using seem to be correct. I made a copy of the .h files,<br />and search-and-replaced the &quot;modern&quot; C syntax that h2incn seems to have<br />trouble with - uint8_t -&gt; char, etc. There are still a bunch of &quot;size<br />unknown&quot;s. Some of &#039;em may be nested structures, as you suggested.<br />Nasm&#039;s built-in &quot;struc&quot; macro doesn&#039;t handle nested structures well. We<br />can do something like:<br /><br />struc inner<br />.x resd 1<br />.y resd 1<br />.z resd 1<br />endstruc<br /><br />struc outer<br />.a resd 1<br />.b resd 1<br />.inner resb inner_size<br />.c resd 1<br />endstruc<br /><br />myinstance istruc outer<br />endi<br /><br />and then to access it...<br /><br />mov eax, <br /><br />Not pretty. Supposedly, the &quot;xstruc&quot; package available in the<br />&quot;contributions&quot; section at SourceForge handle nested structures. I&#039;ve<br />never gotten around to looking at it. Maybe it&#039;s time...<br /><br />Anyway... I don&#039;t know what to make of the &quot;secret parameter&quot;. A C++ism?<br />OOP? (the &quot;this&quot; pointer?) More to the point, I don&#039;t know how to tell<br />if I need it or not! Gcc seems to know... What am I missing? How is an<br />&quot;invoke&quot;-style macro going to handle this?<br /><br />Well, we&#039;ll be discussing this more, I&#039;m sure. Maybe time to &quot;kick it<br />upstairs&quot; to the Nasm forum and/or the AsmCommunity forum. There are<br />some &quot;advanced&quot; guys that hang out at AsmCommunity, especially. You&#039;ve<br />noticed that I answer a lot of questions, but I&#039;m better at beginner<br />questions - which this is turning out not to be! :)<br /></div><br /><br />Any of you guys familiar with this &quot;extra parameter&quot; beyond what shows in the C code being passed? In particular, how do we know which functions need it and which don&#039;t?<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2010-05-18 18:49:46 by fbkotler</div>
   </div>
   <div class="post" id="post-211803">
    <div class="subject"><a href="#post-211803">Re: XCB</a></div>
    <div class="body">Been quite awhile and no replies, which is fine but I just wanted to add if anyone is having trouble compiling then just say so. it&#039;s probably possible to get it to compile if your under windows with the cygwin project since xcb has been ported. I&#039;m on Linux and I think you&#039;ll need the libx11-xcb-dev package and *probably* the build-essential package, but I think it&#039;s basically just a bunch of sub-packages like gcc , nasm, etc.<br /><br />I&#039;m not expecting a *solve all our asm problems for us* but that particular parameter is really confusing, and I&#039;m hoping someone could explain it or point us in the right direction.</div>
    <div class="meta">Posted on 2010-05-22 12:24:26 by Brainiac</div>
   </div>
   <div class="post" id="post-211809">
    <div class="subject"><a href="#post-211809">Re: XCB</a></div>
    <div class="body">Hey, we&#039;re up to six downloads! :)<br /><br />The fact is, there are few people who are interested in accessing Xwindows from assembly language, whether by using Xlib, or this alternative, &quot;XCB&quot;, or even (my favorite) no library at all. For practical purposes, you want a much higher level library to deal with Xwindows... and there isn&#039;t much advantage to doing it from asm (unless you like to)...<br /><br />Perhaps the &quot;mystery parameter&quot; question should be re-phrased in terms independent of this particular library. It&#039;s the only example I can point to, though... :(<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2010-05-22 22:51:37 by fbkotler</div>
   </div>
  </div>
 </body>
</html>