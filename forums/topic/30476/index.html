<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Help with fgets - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=30476" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=117">Unix</a> &raquo; <a href="../?id=30476">Help with fgets</a></p>
   <div class="post" id="post-214080">
    <div class="subject"><a href="#post-214080">Help with fgets</a></div>
    <div class="body">Hey Guys, this is my first post and I am a beginner with this language.&nbsp; I hope you can help me!<br />Before, some background<br /><br /><strong>Compiler: gcc<br />Assembler: gas<br />objective: open a file, copy the text that is inside, and paste it in a new file.<br />Problem:&nbsp;  function fgets<br />Error: Segmentation Fault<br /></strong><br />code where the error appears: <br /><pre><code><br />processingfiles:&nbsp; &nbsp;  pushl %ebp&nbsp; &nbsp; &nbsp; &nbsp; #prologue<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  movl %esp, %ebp&nbsp;  #prologue<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  pushl $mode2&nbsp; &nbsp; &nbsp; #read only<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  pushl $sourcefilepath <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  call fopen<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  addl $8, %esp&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  mov %eax, fp # fp=file pointer<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  cmpl $0, fp # if fp==NULL (0) error!<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  je errors<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  pushl $sourcefilepath<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  pushl $10&nbsp;  #amount of data to be pasted<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  pushl $file&nbsp; #name of the file where the data will be pasted<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  call fgets&nbsp; #here de problem!<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  jmp fin<br />errors:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pushl error<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  call printf<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  addl $4, %esp<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  jmp fin<br /><br />fin:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  leave<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ret<br /><br /></code></pre><br />Do you know what the problem is? what am I missing?<br />thanks in advance<br /></div>
    <div class="meta">Posted on 2011-02-17 12:40:22 by massem</div>
   </div>
   <div class="post" id="post-214082">
    <div class="subject"><a href="#post-214082">Re: Help with fgets</a></div>
    <div class="body">I believe you&#039;re using the wrong parameters for fgets:<br /><br /><pre><code><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  pushl $sourcefilepath<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  pushl $10&nbsp;  #amount of data to be pasted<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  pushl $file&nbsp; #name of the file where the data will be pasted<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  call fgets&nbsp; #here de problem!<br /></code></pre><br /><br />In order pushed (opposite order listed in C source), you want file descriptor, size, buffer. You appear to be reusing the filename as a buffer(?). Or is &quot;file&quot; supposed to be the buffer? In any case, I think what you want is:<br /><br /><pre><code><br />&nbsp; &nbsp; pushl fp&nbsp; # no &#039;$&#039;! - as returned from fopen<br />&nbsp; &nbsp; pushl $10<br />&nbsp; &nbsp; pushl $buffer&nbsp; # call it what you like<br />&nbsp; &nbsp; call fgets<br /></code></pre><br /><br />Also, you don&#039;t &quot;addl $12, %esp&quot; to remove the parameters. In addition, you seem to be unconditionally jumping over the &quot;error&quot; section. I could be wrong about this - not very familiar with (G)as syntax, nor with the C library&#039;s &quot;high level&quot; (buffered) fopen, etc. I&#039;m pretty sure fgets doesn&#039;t want any &quot;names&quot;, but the &quot;FILE *&quot; returned from fopen (I guess it should be called &quot;stream&quot;, not &quot;file descriptor&quot;?). Give it a try and see if it helps.<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2011-02-17 13:50:23 by fbkotler</div>
   </div>
   <div class="post" id="post-214087">
    <div class="subject"><a href="#post-214087">Re: Help with fgets</a></div>
    <div class="body">Just taking a glance, your biggest problem (not including what fbkotler pointed out) is exactly what you&#039;re comments state.<br /><pre><code>&nbsp; &nbsp; call fgets&nbsp; #here de problem!<br />&nbsp; &nbsp; jmp fin</code></pre><br /><br />Yep! You&#039;re right, there is a problem there. You were so diligent about cleaning up after printf and fopen, but you forgot to do the same with fgets!<br /><br /><pre><code>&nbsp; &nbsp; .data<br /><br />strModeRead:<br />&nbsp; &nbsp; .ascii &quot;r\0&quot;<br /><br />strInputFile:<br />&nbsp; &nbsp; .ascii &quot;demo.txt\0&quot;<br /><br />strFileError:<br />&nbsp; &nbsp; .ascii &quot;error: could not open file.\n\0&quot;<br /><br />&nbsp; &nbsp; .bss<br /><br />fd:<br />&nbsp; &nbsp; .space 4<br /><br />strBuffer:<br />&nbsp; &nbsp; .space 1025<br /><br />&nbsp; &nbsp; .text<br /><br />.globl print_file_out<br />print_file_out:<br />&nbsp; &nbsp; enter $0, $0<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; pushl $strModeRead<br />&nbsp; &nbsp; &nbsp; &nbsp; pushl $strInputFile<br />&nbsp; &nbsp; &nbsp; &nbsp; call fopen<br />&nbsp; &nbsp; &nbsp; &nbsp; addl $0x08, %esp<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; cmpl $0x00, %eax<br />&nbsp; &nbsp; &nbsp; &nbsp; je _opn_err<br />&nbsp; &nbsp; &nbsp; &nbsp; movl %eax, (fd)<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; pushl %eax # Pointer to File for fgets()<br />&nbsp; &nbsp; &nbsp; &nbsp; pushl $1024 # Maximum size of buffer.<br />&nbsp; &nbsp; &nbsp; &nbsp; pushl $strBuffer # Storage buffer.<br />&nbsp; &nbsp; &nbsp; &nbsp; call fgets<br />&nbsp; &nbsp; &nbsp; &nbsp; addl $0x0B, %esp<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; pushl (fd)<br />&nbsp; &nbsp; &nbsp; &nbsp; call fclose<br />&nbsp; &nbsp; &nbsp; &nbsp; addl $0x04, %esp<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; mov $strBuffer, %eax # Return pointer to buffer on success&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; jmp _ovr_err<br /><br />_opn_err:<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; pushl $strFileError<br />&nbsp; &nbsp; &nbsp; &nbsp; call printf<br />&nbsp; &nbsp; &nbsp; &nbsp; addl $0x04, %ebp<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; xorl %eax, %eax # Return zero on error<br /><br />_ovr_err:<br /><br />&nbsp; &nbsp; leave<br />&nbsp; &nbsp; ret</code></pre><br /><br />Also remember that fgets() reads a line at a time, so this will print out the first line from &quot;demo.txt&quot; and you shouldn&#039;t leave any hanging pointers out there, so make sure you call fclose() on any fopen()&#039;d descriptor.<br /><br />P.S. Writing this has reminded me why I hate AT&amp;T Syntax.</div>
    <div class="meta">Posted on 2011-02-17 19:54:19 by Synfire</div>
   </div>
   <div class="post" id="post-214091">
    <div class="subject"><a href="#post-214091">Re: Help with fgets</a></div>
    <div class="body">Hi Guys, I really appreciate your answers. You were right,&nbsp; my mistakes were:<br /><pre><code><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  pushl&nbsp;  $sourcefilepath&nbsp;  ---------&gt;&nbsp;  instead of $sourcefilepath I should have&nbsp; written the file descriptor.... <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  pushl $10&nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  pushl $file&nbsp; --------------&gt;instead of the filename&nbsp;  I should have written a string buffer to save data<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  call&nbsp;  fgets&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addl $12, %esp<br /><br /></code></pre><br />I finish my program copying stringbuffer into a new text file... like that<br /><pre><code><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  pushl&nbsp; $mode1&nbsp; #write mode<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  pushl $file&nbsp;  #file name<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  call fopen&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  addl $8, %esp<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  movl %eax, fp<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  pushl $strBuffer<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  pushl fp<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  call fprintf<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  addl $8, %esp<br /><br /></code></pre><br />and it worked!&nbsp; <br />thank you so much for helping me, I am new in assembly language<br />marcela<br /><br /></div>
    <div class="meta">Posted on 2011-02-18 12:50:27 by massem</div>
   </div>
  </div>
 </body>
</html>