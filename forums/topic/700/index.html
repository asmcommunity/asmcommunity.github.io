<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>how to hook WM_COMMAND of a DialogBox? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=700" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=700">how to hook WM_COMMAND of a DialogBox?</a></p>
   <div class="post" id="post-4200">
    <div class="subject"><a href="#post-4200">how to hook WM_COMMAND of a DialogBox?</a></div>
    <div class="body">Does anyone knpow how to hook a wm-command of a DialogBox, created with DialogBoxParam?<br />I tried to use WH_SYSMSGFILTER to hook it, but it doesn't work to good.</div>
    <div class="meta">Posted on 2001-08-20 03:40:58 by Belkot</div>
   </div>
   <div class="post" id="post-4209">
    <div class="subject"><a href="#post-4209">how to hook WM_COMMAND of a DialogBox?</a></div>
    <div class="body">To install the hook :<br /><br />InstallHook proc hwnd:DWORD<br />push hwnd<br />pop hWnd<br />invoke FindWindowEx,0,0, ADDR ClassName, 0<br />invoke GetWindowThreadProcessId, eax, 0<br />invoke SetWindowsHookEx,WH_GETMESSAGE,ADDR GetMsgProc,hInstance,eax<br />mov hHook,eax<br />ret <br />InstallHook endp<br /><br />hook proc :<br /><br />GetMsgProc proc nCode:DWORD,wParam:DWORD,lParam:DWORD<br />mov edx,lParam<br />assume edx:PTR MSG<br />cmp .message, WM_COMMAND<br />jne fini<br />cmp .wParam, WMESSAGE<br />jne fini<br />cmp .lParam, LMESSAGE<br />je ca_va<br />cmp .lParam, 0<br />jne fini<br />ca_va:<br />mov .message, WM_MOUSEMOVE<br />mov .wParam,  0<br />mov .lParam,  0<br />invoke PostMessage,hWnd,WM_HOOK,0,lParam<br />assume edx:nothing<br />fini:<br />invoke CallNextHookEx,hHook,nCode,wParam,lParam<br />ret<br />GetMsgProc endp<br /><br />This prog hook WM_COMMAND message, and if it is the good msg (i check wParam and lParam, i pass to the prog a fake WM_MOUSEMOVE msg)<br /><br />hope this can help u<br /><br />(s)</div>
    <div class="meta">Posted on 2001-08-20 06:19:16 by (scalp)</div>
   </div>
   <div class="post" id="post-4269">
    <div class="subject"><a href="#post-4269">how to hook WM_COMMAND of a DialogBox?</a></div>
    <div class="body">i tried your sugestion but it still dosent work, when i run HookLoader.exe and a DialogBox.exe is execute and when i tried to send a message to this dialogbox (moving a mouse over or somthing) all i get is a message from windows saing DalogBox.exe has cause ane error in USER32.DLL IP 0177:bff53c87.<br /><br />here are the sources:<br /><br />----DialogBox.Asm----<br />.386p<br />.MODEL FLAT,STDCall<br />OPTION CASEMAP:NONE<br /><br />INCLUDE \MASM32\INCLUDE\WINDOWS.INC<br />INCLUDE \MASM32\INCLUDE\USER32.INC<br />INCLUDE \MASM32\INCLUDE\KERNEL32.INC<br />INCLUDE \MASM32\INCLUDE\MASM32.INC<br /><br />INCLUDELIB \MASM32\LIB\USER32.LIB<br />INCLUDELIB \MASM32\LIB\KERNEL32.LIB<br />INCLUDELIB \MASM32\LIB\MASM32.LIB<br /><br />; #########################################################################<br />WinMain proto :DWORD,:DWORD,:DWORD,:DWORD<br />DlgProc proto :DWORD,:DWORD,:DWORD,:DWORD<br /><br /><br />; #########################################################################<br />.DATA<br />DlgName         DB &quot;MyDialog&quot;, 0<br /><br />; #########################################################################<br />.DATA?<br /><br />; #########################################################################<br />;.CONST<br /><br />; #########################################################################<br />.CODE<br /><br />START:<br />        Invoke GetModuleHandle, 0<br />        Invoke DialogBoxParam, Eax, ADDR DlgName, 0, ADDR DlgProc, 0<br /><br />        Invoke ExitProcess, 0<br /><br /><br />; #########################################################################<br />;                                 Procedury<br />; #########################################################################<br /><br />DlgProc Proc hWnd   :DWORD,<br />             uMsg   :DWORD,<br />             wParam :DWORD,<br />             lParam :DWORD<br /><br />  ; -----------------------------<br />  ; Process control messages here<br />  ; -----------------------------<br /><br />    .If uMsg == WM_INITDIALOG<br /><br />    .ElseIf uMsg == WM_CLOSE<br />        Invoke EndDialog, hWnd, 0<br /><br />    .Else<br />        Mov Eax, FALSE<br />        Ret<br /><br />    .EndIf<br /><br />    Mov Eax, TRUE<br />    Ret<br /><br />DlgProc EndP<br /><br />END START                                           ;Koniec KODU<br />----DialogBox.Asm----<br /><br />----HookDLL.ASM----<br />.486p<br />.MODEL FLAT,STDCall<br />OPTION CASEMAP:NONE<br /><br />INCLUDE \MASM32\INCLUDE\WINDOWS.INC<br />INCLUDE \MASM32\INCLUDE\USER32.INC<br />INCLUDE \MASM32\INCLUDE\KERNEL32.INC<br /><br />INCLUDELIB \MASM32\LIB\USER32.LIB<br />INCLUDELIB \MASM32\LIB\KERNEL32.LIB<br /><br />; #########################################################################<br />DllEntry Proto hInst:DWORD, reason:DWORD, reserved1:DWORD<br /><br />InstallHook Proto hwnd:DWORD<br />UninstallHook Proto<br />GetMsgProc Proto nCode:DWORD, wParam:DWORD, lParam:DWORD<br /><br />; #########################################################################<br />WM_REVMSGHOOK = WM_USER + 100<br /><br />; #########################################################################<br />.DATA<br />hInstance           DD 0<br /><br />RevClassName        DB &quot;#32770&quot;, 0<br />RevTitleText        DB &quot;DialogBox&quot;, 0<br /><br /><br />; #########################################################################<br />.DATA?<br />hHook               DD ?<br />hWnd                DD ?<br />RevhWnd             DD ?<br /><br />; #########################################################################<br />;.CONST<br /><br />; #########################################################################<br />.CODE<br /><br />DllEntry Proc hInst:DWORD, reason:DWORD, reserved1:DWORD<br />    Push hInst<br />    Pop hInstance<br />    Mov  Eax, TRUE<br />    Ret<br /><br />DllEntry Endp<br /><br />InstallHook Proc hwnd:DWORD<br />    Push hwnd<br />    Pop hWnd<br /><br />    Invoke FindWindow, ADDR RevClassName, ADDR RevTitleText<br />    Mov RevhWnd, Eax<br />    Invoke GetWindowThreadProcessId, RevhWnd, 0<br />    Invoke SetWindowsHookEx, WH_GETMESSAGE, ADDR GetMsgProc, hInstance, Eax<br />    Mov hHook, Eax<br />    Ret <br /><br />InstallHook EndP<br /><br />UninstallHook Proc<br />    Invoke UnhookWindowsHookEx, hHook<br />    Ret<br /><br />UninstallHook EndP<br /><br />GetMsgProc Proc nCode:DWORD, wParam:DWORD, lParam:DWORD<br />        Mov Edx, lParam<br />        ASSUME Edx:PTR MSG<br /><br />        Mov Ebx, RevhWnd<br />        .If .hwnd == Ebx<br />            .If .message == WM_COMMAND<br />                .If .wParam == 900 || .wParam == 901<br />                    Mov .message, WM_MOUSEMOVE<br />                    Mov .lParam, 0<br />                    Mov .wParam, 0<br />                    Invoke PostMessage, hWnd, WM_REVMSGHOOK, 0, 0<br /><br />                .EndIf<br /><br />            .ElseIf .message == WM_CLOSE<br />                Mov .message, WM_MOUSEMOVE<br />                Mov .lParam, 0<br />                Mov .wParam, 0<br />                Invoke PostMessage, hWnd, WM_DESTROY, 0, 0<br /><br />            .EndIf<br /><br />        .EndIf<br /><br />    ASSUME Edx: NOTHING<br />    Invoke CallNextHookEx, hHook, nCode, wParam, lParam<br />    Ret<br /><br />GetMsgProc EndP<br /><br />END DllEntry                                           ;Koniec KODU<br />----HookDLL.ASM----<br /><br />----HookLoader.ASM----<br />.486p<br />.MODEL FLAT,STDCall<br />OPTION CASEMAP:NONE<br /><br />INCLUDE \MASM32\INCLUDE\WINDOWS.INC<br />INCLUDE \MASM32\INCLUDE\USER32.INC<br />INCLUDE \MASM32\INCLUDE\KERNEL32.INC<br />INCLUDE \MASM32\INCLUDE\MASM32.INC<br /><br />INCLUDELIB \MASM32\LIB\USER32.LIB<br />INCLUDELIB \MASM32\LIB\KERNEL32.LIB<br />INCLUDELIB \MASM32\LIB\MASM32.LIB<br />INCLUDELIB HOOKDLL.LIB<br /><br />; #########################################################################<br />WinMain proto hInst:DWORD, hPrevInst:DWORD, CmdLine:DWORD, CmdShow:DWORD<br />WndProc proto hWnd:DWORD, uMsg:DWORD, wParam:DWORD, lParam:DWORD<br /><br />InstallHook Proto hwnd:DWORD<br />UninstallHook Proto<br />GetMsgProc Proto nCode:DWORD, wParam:DWORD, lParam:DWORD<br /><br />; #########################################################################<br />WM_REVMSGHOOK = WM_USER + 100<br /><br />; #########################################################################<br />; Tu zaczynaj? si? nasze DANE<br />.DATA<br />ClassName       DB &quot;HookLoader_Class&quot;, 0<br />AppName         DB &quot;HookLoader&quot;,0<br /><br />AppPathRev1     DB &quot;DialogBox.exe&quot;, 0<br /><br />txt             DB &quot;It worked!!!&quot;, 0<br /><br />; #########################################################################<br />.DATA?<br />hInstance           DD ?<br />hInstanceRev1       DD ?<br /><br />CommandLine         DD ?<br /><br />RevhWnd             DD ?<br /><br />; #########################################################################<br />;.CONST<br /><br />; #########################################################################<br />; a tu nasz KOD<br />.CODE<br /><br />START:<br />        Invoke GetModuleHandle, 0<br />        Mov hInstance, Eax<br />        Invoke GetCommandLine<br />        Mov CommandLine, Eax<br />        Invoke WinMain, hInstance, 0, Eax, SW_HIDE<br />        Invoke ExitProcess, Eax<br /><br /><br />; #########################################################################<br /><br /><br />WinMain Proc hInst:DWORD, hPrevInst:DWORD, CmdLine:DWORD, CmdShow:DWORD<br />	  LOCAL wc:WNDCLASSEX<br />	  LOCAL msg:MSG<br />	  LOCAL hwnd:HWND<br /><br />	  Mov wc.cbSize, SIZEOF WNDCLASSEX<br />        Mov wc.style, CS_HREDRAW + CS_VREDRAW<br />	  Mov wc.lpfnWndProc, OFFSET WndProc<br />	  Mov wc.cbClsExtra, 0<br />	  Mov wc.cbWndExtra, 0<br />	  Push hInstance<br />	  Pop wc.hInstance<br />	  Mov wc.hbrBackground, COLOR_WINDOW + 1<br />	  Mov wc.lpszMenuName, 0<br />        Mov wc.lpszClassName, OFFSET ClassName<br />        Invoke LoadIcon, NULL, IDI_APPLICATION<br />        Mov wc.hIcon, Eax<br />        Mov wc.hIconSm, Eax<br />        Invoke LoadCursor, 0, IDC_ARROW<br />        Mov wc.hCursor, Eax<br /><br />        Invoke RegisterClassEx, ADDR wc<br />        Invoke CreateWindowEx, 0, ADDR ClassName, ADDR AppName,\<br />            WS_OVERLAPPEDWINDOW, CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, 0, 0, hInst, 0<br />	  Mov hwnd, Eax<br /><br />	  Invoke ShowWindow, hwnd, CmdShow<br />	  Invoke UpdateWindow, hwnd<br /><br />        .While TRUE<br />            Invoke GetMessage, ADDR msg, 0, 0, 0<br />		.Break .If (!Eax)<br />		Invoke TranslateMessage, ADDR msg<br />		Invoke DispatchMessage, ADDR msg<br />        .EndW<br />        Mov Eax, msg.wParam<br />        Ret<br /><br />WinMain EndP<br /><br />WndProc Proc hWnd:DWORD, uMsg:DWORD, wParam:DWORD, lParam:DWORD<br /><br />        .If uMsg == WM_DESTROY<br />            Invoke UninstallHook<br />            Invoke PostQuitMessage, 0<br /><br />        .ElseIf uMsg == WM_CREATE<br />            Invoke WinExec, ADDR AppPathRev1, SW_SHOW<br />            Invoke InstallHook, hWnd<br /><br />        .ElseIf uMsg == WM_REVMSGHOOK<br />            Invoke MessageBox, 0, ADDR txt, ADDR txt, 0<br /><br />        .Else<br />            Invoke DefWindowProc,hWnd,uMsg,wParam,lParam<br />		Ret<br /><br />        .EndIf<br />        Xor Eax, Eax<br />        Ret<br /><br />WndProc EndP<br /><br />END START                                           ;Koniec KODU<br />----HookLoader.ASM----<br /><br />Maybe u'll find some bug in it or somthing</div>
    <div class="meta">Posted on 2001-08-20 19:07:22 by Belkot</div>
   </div>
   <div class="post" id="post-4283">
    <div class="subject"><a href="#post-4283">how to hook WM_COMMAND of a DialogBox?</a></div>
    <div class="body">I think that the problem is in the class name.<br />With a dialog box, the class name change every time you start it,<br />so the class you search (&quot;#32770&quot;) is probably wrong !<br />Search only for the title, it should work.<br /><br />(s)</div>
    <div class="meta">Posted on 2001-08-21 04:07:41 by (scalp)</div>
   </div>
   <div class="post" id="post-4289">
    <div class="subject"><a href="#post-4289">how to hook WM_COMMAND of a DialogBox?</a></div>
    <div class="body">i think you R wrong, run exemple from Iczelion's Tutorial 24: Windows Hooks, and when U push Hook button u can get a class name of window on which pointer of a mouse is.:grin: <br />i checked few dialogboexes (i.e. Start/Run...) and the class name is ever time &quot;#32770&quot; :alright:</div>
    <div class="meta">Posted on 2001-08-21 05:32:53 by NEMO</div>
   </div>
   <div class="post" id="post-4292">
    <div class="subject"><a href="#post-4292">how to hook WM_COMMAND of a DialogBox?</a></div>
    <div class="body">For all dialog boxes, even after reboot ?<br />Damn, i didn't know that !<br />Thanx<br /><br />(s)</div>
    <div class="meta">Posted on 2001-08-21 05:59:54 by (scalp)</div>
   </div>
   <div class="post" id="post-4307">
    <div class="subject"><a href="#post-4307">how to hook WM_COMMAND of a DialogBox?</a></div>
    <div class="body">all dialogboxes that are created with DialogBoxParam function</div>
    <div class="meta">Posted on 2001-08-21 07:19:47 by NEMO</div>
   </div>
  </div>
 </body>
</html>