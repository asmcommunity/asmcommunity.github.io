<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>very slow code, any suggestions - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=16233" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=16233">very slow code, any suggestions</a></p>
   <div class="post" id="post-126037">
    <div class="subject"><a href="#post-126037">very slow code, any suggestions</a></div>
    <div class="body">Hello everybody,<br /><br />I wrote the following proc to enumerate all the keys\subkeys under HKEY_LOCAL_MACHINE  for examle.  It works and displays thousands of keys in a listview window.  Problem is it takes 8 minutes to do it on my 350 MHZ machine using Windows 98.  Is there a faster method? Also machine seems sluggish after running code a few times.  Maybe overflowing stack.  I think all handles are closed.<br /><br />            mov lvi.imask,LVIF_TEXT+LVIF_PARAM<br />            push row<br />            pop lvi.iItem	<br />            mov lvi.iSubItem,0<br /><br />            mov dwIndex,00h<br />            invoke lstrcpy,ADDR szKeyPath,ADDR szKeyName<br />            invoke RegOpenKeyEx,HKEY_LOCAL_MACHINE,NULL,NULL,\<br />                             KEY_ENUMERATE_SUB_KEYS,ADDR hKey<br />      <br />                .if eax!=ERROR_SUCCESS<br />                    ret                     <br />                .endif<br /><br />            push dwIndex<br />            push hKey                                          ;save handle<br />                                         <br />           @@:                <br />            mov dwSize,0ffh            <br />            invoke RegEnumKeyEx,hKey,dwIndex,ADDR szSubKey,\<br />                             ADDR dwSize,NULL,NULL,\<br />                             NULL,NULL<br />         <br />                .if eax==ERROR_NO_MORE_ITEMS<br />                    invoke RegCloseKey,hKey<br /><br />               ;***********************<br />               ;remove last subkey from full path<br />               ;by replacing last backspace with NULL character<br />               ;***********************<br />               <br />                    push edi<br />                    xor eax,eax<br />                    lea edi,szKeyPath<br />                    cld               <br />                    mov ecx,-1<br />                    xor eax,eax<br />                    repne scasb       ;set edi point end string<br />                    not ecx               ;string length<br />                    mov al,5ch<br />                    std                      ;search back until first backspace character <br />                    repne scasb        ;not searching past start string<br />                    add edi,01h<br /><br />                    mov al,<br />                        .if al!=5ch<br />                 ;****************<br />                 ;normal proc exit point<br />                 ;****************<br />                           pop eax                                ;used to balance stack<br />                           invoke RegCloseKey,hKey<br />                           ret<br />                 <br />                        .endif<br /><br />                    xor eax,eax<br />                    stosb                              ;replace backspace with NULL character<br />                    cld<br />                    pop edi<br /><br />                    pop hKey<br />                    pop dwIndex<br /><br />                 ;****************<br />                 ;open old key<br />                 ;****************<br />                    invoke RegOpenKeyEx,hKey,NULL,NULL,\<br />                                     KEY_ENUMERATE_SUB_KEYS,ADDR hKey<br /><br />                        .if eax!=ERROR_SUCCESS<br />                            invoke RegCloseKey,hKey                                 <br />                 ;****************<br />                 ;an error occured<br />                 ;****************<br />                            ret<br />                             <br />                        .endif<br />                        <br />                    jmp @b<br /><br />                .else<br />                    inc dwIndex<br />                    invoke lstrcat,ADDR szKeyPath,ADDR szBackSlash<br />                    invoke lstrcat,ADDR szKeyPath,ADDR szSubKey<br />      <br />                ;*****************<br />                ;filter output, display, etc.<br />                ;*****************<br />                   <br />                ;*****************<br />                ;dislpay keys\subkeys<br />                ;in listview<br />                ;*****************<br />                    lea eax,szKeyPath<br />                    mov lvi.pszText,eax<br />                    push row<br />                    pop lvi.lParam<br />                    invoke SendMessage,hList,LVM_INSERTITEM,0,addr lvi<br /><br />                    push dwIndex       ;save index<br />                    push hKey             ;save handle<br />                 ;****************<br />                 ;open new key<br />                 ;****************<br />                    invoke RegOpenKeyEx,hKey,ADDR szSubKey,NULL,\<br />                                     KEY_ENUMERATE_SUB_KEYS,ADDR hKey<br /><br />                        .if eax!=ERROR_SUCCESS<br />                            invoke RegCloseKey,hKey<br />                 ;****************<br />                 ;an error occured<br />                 ;****************<br />                            ret<br />                             <br />                        .endif <br />                                     <br />                    mov dwIndex,00h<br />                    jmp @b<br /><br />                .endif             <br /><br />     .endif<br /><br />If you know of a better way to do this or faster, please let me know.<br /><br />best regards,<br /><br />czDrillard</div>
    <div class="meta">Posted on 2003-11-30 16:45:05 by czDrillard</div>
   </div>
   <div class="post" id="post-126058">
    <div class="subject"><a href="#post-126058">very slow code, any suggestions</a></div>
    <div class="body">well, does regedit take 8 minutes as well? if not, its quite likely you have a bug somewhere.. but where it is i have no idea, i'll have a look later when i wake up ;)</div>
    <div class="meta">Posted on 2003-11-30 20:02:26 by evlncrn8</div>
   </div>
  </div>
 </body>
</html>