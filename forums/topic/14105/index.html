<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>HLA for linux - code generation bug - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=14105" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=14105">HLA for linux - code generation bug</a></p>
   <div class="post" id="post-109014">
    <div class="subject"><a href="#post-109014">HLA for linux - code generation bug</a></div>
    <div class="body">While porting zlib.h to HLA i've met the following problem (both 1.43 and 1.51 linux versions are buggy):<br /><br />the procedure is declared like this:<br /><span style="font-size:9px><pre><code>&#91;B&#93;procedure&#91;/B&#93; inflateInit_<br />    &#40;<br />        &#91;B&#93;var&#91;/B&#93; strm    &#58; zstream;<br />        _version    &#58; &#91;COLOR=blue&#93;string&#91;/COLOR&#93;;<br />        stream_size &#58; &#91;COLOR=blue&#93;dword&#91;/COLOR&#93;<br />    &#41;;<br />        &#91;B&#93;@cdecl&#91;/B&#93;;<br />        &#91;B&#93;@returns&#91;/B&#93;&#40; &quot;eax&quot; &#41;;<br />&#91;B&#93;        #if&#91;/B&#93;&#40; os.linux &#41; &#91;B&#93;@external&#91;/B&#93;;&#91;B&#93; #else @external&#91;/B&#93;&#40; &quot;_inflateInit_&quot; &#41;;&#91;B&#93; #endif&#91;/B&#93;<br /></code></pre></span>then it is called somewhere:<br /><span style="font-size:9px><pre><code>    inflateInit_&#40; zstrm, &quot;1.1.4&quot;, &#91;B&#93;@size&#91;/B&#93;&#40; zstream &#41;&#41;;<br /></code></pre></span>here's the code generated by windows version of HLA (1.47):<br /><span style="font-size:9px><pre><code>pushd	038h<br />push	offset32 L17_str__hla_<br />push	eax<br />push	eax<br />lea	eax, &#91;ebp-60&#93;	;/* zstrm */<br />mov	dword ptr &#91;esp+4&#93;, eax<br />pop	eax<br />call	_inflateInit_	; inflateInit_<br /></code></pre></span>and code generated by linux versions:<br /><span style="font-size:9px><pre><code>pushd	0x38<br />push	offset L19_str__hla_<br />push	eax<br />push	eax<br />lea	eax, &#91;ebp-60&#93;	;/* zstrm */<br />mov	dword ptr &#91;esp+4&#93;, eax<br /><br />call	inflateInit_	/* inflateInit_ */ <br /></code></pre></span>(I've left a blank line where `pop eax' was supposed to be.)</div>
    <div class="meta">Posted on 2003-07-02 07:55:30 by clone-d</div>
   </div>
   <div class="post" id="post-109020">
    <div class="subject"><a href="#post-109020">deeper exploration shows...</a></div>
    <div class="body">The bug is even worse, the code is actually being emitted (I suppose) and then it is stripped;<br />Following code should be workaround for the above problem<span style="font-size:9px><pre><code>inflateInit_&#40; &#91;B&#93;#&#123;&#91;/B&#93;&#91;B&#93;lea&#91;/B&#93;&#40;&#91;B&#93;eax&#91;/B&#93;,zstrm&#41;;&#91;B&#93;push&#91;/B&#93;&#40;&#91;B&#93;eax&#91;/B&#93;&#41;;&#91;B&#93;&#125;#&#91;/B&#93;, &#91;COLOR=darkred&#93;&quot;1.1.4&quot;&#91;/COLOR&#93;, &#91;B&#93;@size&#91;/B&#93;&#40; zstream &#41;&#41;;</code></pre></span>but look at the assmbly generated by linux HLA:<span style="font-size:9px><pre><code>pushd	0x38<br />push	offset L19_str__hla_<br />lea	eax, &#91;ebp-60&#93;	;/* zstrm */<br />call	inflateInit_	/* inflateInit_ */ </code></pre></span>explicit push(eax) disappeared!!!<br />You better fix it, Randy ;)<br /><br />--<br />clone-d.</div>
    <div class="meta">Posted on 2003-07-02 08:58:29 by clone-d</div>
   </div>
   <div class="post" id="post-109025">
    <div class="subject"><a href="#post-109025">Re: deeper exploration shows...</a></div>
    <div class="body"><div class="quote"><br />The bug is even worse, the code is actually being emitted (I suppose) and then it is stripped;<br />Following code should be workaround for the above problem<span style="font-size:9px><pre><code>inflateInit_&#40; &#91;B&#93;#&#123;&#91;/B&#93;&#91;B&#93;lea&#91;/B&#93;&#40;&#91;B&#93;eax&#91;/B&#93;,zstrm&#41;;&#91;B&#93;push&#91;/B&#93;&#40;&#91;B&#93;eax&#91;/B&#93;&#41;;&#91;B&#93;&#125;#&#91;/B&#93;, &#91;COLOR=darkred&#93;&quot;1.1.4&quot;&#91;/COLOR&#93;, &#91;B&#93;@size&#91;/B&#93;&#40; zstream &#41;&#41;;</code></pre></span>but look at the assmbly generated by linux HLA:<span style="font-size:9px><pre><code>pushd	0x38<br />push	offset L19_str__hla_<br />lea	eax, &#91;ebp-60&#93;	;/* zstrm */<br />call	inflateInit_	/* inflateInit_ */ </code></pre></span>explicit push(eax) disappeared!!!<br />You better fix it, Randy ;)<br /><br />--<br />clone-d. </div><br /><br />Oh, I will!<br />This is an artifact of the @cdecl parameter passing code.<br />The way HLA handles this has always been problematic under Linux (this is due to the cr/lf vs lf line endings between the two OSes).<br /><br />In the very short term, the workaround I'll offer is to manually push the parameters here and then call the function directly (using the CALL instruction).<br /><br />Cheers,<br />Randy Hyde</div>
    <div class="meta">Posted on 2003-07-02 10:16:58 by rhyde</div>
   </div>
   <div class="post" id="post-109340">
    <div class="subject"><a href="#post-109340">Problem corrected in HLA v1.52</a></div>
    <div class="body">The code generation problems and the fileio.close<br />problem (Linux) have been corrected in HLA v1.52<br />which is now up on Webster.  See the v1.52 announcement<br />for details.<br />Cheers,<br />Randy Hyde</div>
    <div class="meta">Posted on 2003-07-05 14:35:15 by rhyde</div>
   </div>
  </div>
 </body>
</html>