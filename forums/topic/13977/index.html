<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Faster strcat - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=13977" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=13977">Faster strcat</a></p>
   <div class="post" id="post-108032">
    <div class="subject"><a href="#post-108032">Faster strcat</a></div>
    <div class="body">&quot;I am wondering if someone could produce one version which is faster..&quot; by roticv<br /><pre><code><br />;Usage&#58; <br />;       push 0                     ; always 0 !!!<br />;       push offset szString2      ; address of second string<br />;       push offset szString1      ; address of first string<br />;       push offset szTargetBuffer ; address of target buffer<br />;       call CatStrA               ;<br />; or                               ;<br />; invoke CatStrA, addr szTargetBuffer, addr szString1, addr szString2, 0<br />;<br />;&#91;B&#93;Note&#58;&#91;/B&#93; If you want to use more Strings for instance 4 <br />;      just redefine the proc as&#58;<br />;      CatStrA proto lpTarget&#58;DWORD, lpSource1&#58;DWORD, lpSource2&#58;DWORD,<br />;                                    lpSource3&#58;DWORD, lpSource4&#58;DWORD,<br />;                                    nZero&#58;DWORD<br />;      and modify&#58; <br />;      ret  2*4+&#91;B&#93;2*4&#91;/B&#93;  to  ret 2*4+&#91;B&#93;4*4&#91;/B&#93; ; !!!<br />;      Now  you can use it as&#58;  <br />;      invoke CatStrA, addr szTargetBuffer,  addr szString1, <br />;                      addr szString2, addr szString3, addr szString4, 0<br />;<br />;      and next&#58;<br />;      if you have 2 Strings&#58;<br />;      invoke CatStrA, addr szTargetBuffer,  addr szString1, <br />;                      addr szString2, &#91;B&#93;0, 0,&#91;/B&#93; 0<br />;      if you have 3 Strings&#58;<br />;      invoke CatStrA, addr szTargetBuffer,  addr szString1, <br />;                      addr szString2, addr szString3, &#91;B&#93;0&#91;/B&#93;, 0<br />;<br />;       szTargetBuffer, szString1, szString2, szString3 and szString4<br />;       should be aligned to 4 !!!<br />;  <br />OPTION PROLOGUE&#58;NONE               ; turn it off<br />OPTION EPILOGUE&#58;NONE               ;<br />Align 16                           ; Align 16 before the proc<br />CatStrA proc lpTarget&#58;DWORD, lpSource1&#58;DWORD, lpSource2&#58;DWORD, nZero&#58;DWORD<br />        mov  edx, &#91;esp+1*4&#93;        ; edx-&gt;lpTarget<br />        lea  ecx, &#91;esp+3*4&#93;        ; ecx-&gt;stack address of lpSource2<br />        mov  &#91;esp+1*4&#93;, edi        ; save edi<br />        mov  edi, &#91;esp+2*4&#93;        ; edi-&gt;lpSource1..2..3..n<br />LoopDwords&#58;                        ;<br />        mov  eax, &#91;edi&#93;            ; edi-&gt;lpSource1..2..3..n<br />        add  edx, 4                ;<br />        add  edi, 4                ;<br />        mov  &#91;edx-4&#93;, eax          ; edx-&gt;lpTarget<br />        add  eax, 0FEFEFEFFh       ;<br />        test eax, 80808080h        ;<br />        je   LoopDwords            ; 1 loop-&gt;3 clocks per 4 bytes<br />        cmp  byte ptr &#91;edi-4&#93;, 0   ;<br />        je   M6_minus4             ;<br />        cmp  byte ptr &#91;edi-4+1&#93;, 0 ;<br />        je   M6_minus3             ;<br />        cmp  byte ptr &#91;edi-4+2&#93;, 0 ;<br />        je   M6_minus2             ;<br />        cmp  byte ptr &#91;edi-4+3&#93;, 0 ;<br />        jne  LoopDwords            ; if not zeroes loop again<br />        dec  edx                   ;<br />GetNextStr&#58;                        ;<br />        mov  edi, &#91;ecx&#93;            ; edi-&gt;lpSource1..2..3..n<br />        add  ecx, 4                ; ecx-&gt; stack address<br />        mov  eax, edx	           ;<br />        test edi, edi              ; is it last string address?<br />        je   ExitCatStr            ;<br />        and  eax, 3                ; is it aligned by 4?<br />        je   LoopDwords            ;<br />LoopByte&#58;			   ;<br />        mov  al, &#91;edi&#93;             ; edi-&gt;lpSource1..2..3 <br />        inc  edi                   ; <br />        mov  &#91;edx&#93;, al             ; edx-&gt;lpTarget<br />        add  edx, 1                ;<br />        test al, al                ; is it end of string?<br />        jne  LoopByte              ;<br />        dec  edx                   ;<br />	jno  GetNextStr            ;<br />        nop                        ;<br />M6_minus4&#58;                         ;<br />        add  edx, -4               ;<br />        jno  GetNextStr            ;<br />M6_minus3&#58;                         ;<br />        add  edx, -3               ;<br />        jno  GetNextStr            ;<br />M6_minus2&#58;                         ;<br />        add  edx, -2               ;<br />        jno  GetNextStr            ;<br />        nop                        ;<br />ExitCatStr&#58;                        ;<br />        mov  edi, &#91;esp+1*4&#93;        ; restore edi<br />        ret  2*4+&#91;B&#93;2*4&#91;/B&#93;               ; Modify here&#40;If you have more parameters&#41;!!!<br />CatStrA endp                       ;<br />OPTION PROLOGUE&#58;PROLOGUEDEF        ; turn back on the defaults<br />OPTION EPILOGUE&#58;EPILOGUEDEF        ;</code></pre><br /><br />Regards,<br />Lingo</div>
    <div class="meta">Posted on 2003-06-23 17:41:36 by lingo12</div>
   </div>
   <div class="post" id="post-108126">
    <div class="subject"><a href="#post-108126">Faster strcat</a></div>
    <div class="body">quality :alright:<br /><br />perhaps it would be useful to have a varargs version, just by making it cdecl- is there any speed difference between cdecl and stdcall?</div>
    <div class="meta">Posted on 2003-06-24 12:24:25 by stormix</div>
   </div>
   <div class="post" id="post-108164">
    <div class="subject"><a href="#post-108164">Faster strcat</a></div>
    <div class="body">Really cool <strong>lingo12</strong>! Do you have profile data as well?<br />I think it would be interesting to set up a test rig.</div>
    <div class="meta">Posted on 2003-06-24 17:04:48 by Poimander</div>
   </div>
   <div class="post" id="post-108166">
    <div class="subject"><a href="#post-108166">Faster strcat</a></div>
    <div class="body">Thanks guys,<br />And my smallest version:<pre><code><br />OPTION PROLOGUE&#58;NONE          ; turn it off<br />OPTION EPILOGUE&#58;NONE          ;<br />CatStrAS proc lpTarget&#58;DWORD, lpSource1&#58;DWORD, lpSource2&#58;DWORD, nZero&#58;DWORD	<br />         push  esi<br />         push  edi<br />         cld<br />         lea   esi, &#91;esp+3*4&#93;<br />         lodsd<br />         xchg  edi, eax<br />LStack&#58;  lodsd<br />         xchg  ecx, eax	<br />         jecxz ExitAS<br />         xchg  esi, ecx<br />LoopAS&#58;  lodsb<br />         stosb<br />         test  al, al<br />         jnz   LoopAS<br />         dec   edi<br />         mov   esi, ecx<br />         jno   LStack<br />ExitAS&#58;  pop   edi<br />         pop   esi<br />         ret   2*4+2*4          ; Modify here &#40;If you have more  parameters&#41; !!!<br />CatStrAS endp                   ; 30 bytes<br />OPTION PROLOGUE&#58;PROLOGUEDEF     ; turn back on the defaults<br />OPTION EPILOGUE&#58;EPILOGUEDEF     ;</code></pre><br />Regards,<br />Lingo</div>
    <div class="meta">Posted on 2003-06-24 18:17:55 by lingo12</div>
   </div>
   <div class="post" id="post-108293">
    <div class="subject"><a href="#post-108293">Faster strcat</a></div>
    <div class="body">stormix's suggestion is quite true.<br /><br />It would be much better like the following and let the caller clear the stack themselves.<br /><pre><code><br />OPTION PROLOGUE&#58;NONE          ; turn it off<br />OPTION EPILOGUE&#58;NONE          ;<br />CatStrAS proc lpTarget&#58;DWORD, &#58;VARARG	<br />         push  esi<br />         push  edi<br />         cld<br />         lea   esi, &#91;esp+3*4&#93;<br />         lodsd<br />         xchg  edi, eax<br />LStack&#58;  lodsd<br />         xchg  ecx, eax	 <br />         jecxz ExitAS    <br />         xchg  esi, ecx  <br />LoopAS&#58;  lodsb<br />         stosb<br />         test  al, al<br />         jnz   LoopAS<br />         dec   edi<br />         mov   esi, ecx<br />         jno   LStack<br />ExitAS&#58;  pop   edi<br />         pop   esi<br />         retn<br />CatStrAS endp                   <br />OPTION PROLOGUE&#58;PROLOGUEDEF     ; turn back on the defaults<br />OPTION EPILOGUE&#58;EPILOGUEDEF     ;<br /></code></pre></div>
    <div class="meta">Posted on 2003-06-26 06:07:23 by roticv</div>
   </div>
   <div class="post" id="post-108442">
    <div class="subject"><a href="#post-108442">Faster strcat</a></div>
    <div class="body"><pre><code>   pop edx<br />   pop edi<br />   pop esi<br />_0&#58;lodsb<br />   stosb<br />   test al,al<br />   jne _0<br />   pop esi<br />   dec edi<br />   test esi,esi<br />   jne _0<br />   jmp edx</code></pre>Can someone trim a byte?  I would like it to be 16 bytes, please.</div>
    <div class="meta">Posted on 2003-06-27 09:31:00 by bitRAKE</div>
   </div>
   <div class="post" id="post-108465">
    <div class="subject"><a href="#post-108465">Faster strcat</a></div>
    <div class="body">12 bytes - strcat1<br /><br />strcat is unstable unless we want to modify the code at runtime everytime it's used..., use strcat1 instead and don't forget to change the labels that were being used. *maybe a macro to facilitate would be nice* :grin:. The 3rd parameter being pushed  is a constant.<pre><code>.386<br />.model flat, stdcall<br />option casemap &#58;none ; case sensitive<br /><br />include c&#58;\masm32\include\windows.inc<br />INCLUDE C&#58;\masm32\include\kernel32.inc<br />INCLUDELIB C&#58;\masm32\lib\kernel32.lib<br />INCLUDE C&#58;\masm32\include\user32.inc<br />INCLUDELIB C&#58;\masm32\lib\user32.lib<br /><br />.DATA<br /><br />    x DB &quot;1&quot;, 0<br />    y DB &quot;2881&quot;, 0<br /><br />.DATA?<br /><br />    buffer db 16 dup&#40;?&#41;<br /><br />.code<br /><br />strcat&#58;<br />    pop edi<br />    __cat&#58;<br />    pop esi<br />    __lp1&#58;<br />    lodsb<br />    stosb<br />    test al,al<br />    jne __lp1<br />    dec edi<br />    mov WORD PTR &#91;$-1&#93;, 0AEBh<br />    jmp __cat<br /><br />strcat1&#58;<br />    pop edi<br />    __cat1&#58;<br />    pop esi<br />    pop edx<br />    __lp3&#58;<br />    lodsb<br />    stosb<br />    test al,al<br />    jne __lp3<br />    dec edi<br />    jmp edx<br /><br />start&#58;<br /><br />    push    __exit_strcat<br />    push    OFFSET x<br />    push    OFFSET buffer<br />    push    OFFSET buffer<br />    jmp     strcat<br />    __exit_strcat&#58;<br /><br />    invoke  MessageBox, 0, OFFSET buffer, 0, 0<br /><br />    push    __exit_strcat1<br />    push    OFFSET y<br />    push    __cat1<br />    push    OFFSET buffer<br />    push    OFFSET buffer<br />    jmp     strcat1<br />    __exit_strcat1&#58;<br /><br />    invoke  MessageBox, 0, OFFSET buffer, 0, 0<br />    invoke  ExitProcess, 0<br /><br />end start</code></pre>is this cheating??? :grin:</div>
    <div class="meta">Posted on 2003-06-27 15:16:09 by arkane</div>
   </div>
   <div class="post" id="post-108487">
    <div class="subject"><a href="#post-108487">Faster strcat</a></div>
    <div class="body">Small strcat:<br /><br /><pre><code>&#91;size=12&#93;invoke lstrcat, string1, string2&#91;/size&#93;</code></pre><br /><br />;)</div>
    <div class="meta">Posted on 2003-06-27 20:03:03 by iblis</div>
   </div>
   <div class="post" id="post-108493">
    <div class="subject"><a href="#post-108493">Faster strcat</a></div>
    <div class="body">20 bytes<pre><code>strcat2&#58;<br />    pop edx<br />    pop edi<br />    mov esi, edi<br />    __catfs&#58;<br />    lodsb<br />    stosb<br />    test al,al<br />    jne __catfs<br />    dec edi<br />    pop esi<br />    __catss&#58;<br />    lodsb<br />    stosb<br />    test al,al<br />    jne __catss<br />    jmp edx<br /><br /><br />...<br /><br />    push    OFFSET y<br />    push    OFFSET buffer<br />    call    strcat2<br />    <br />    push    OFFSET x<br />    push    OFFSET buffer<br />    call    strcat2</code></pre>same usage as lstrcat... :grin:</div>
    <div class="meta">Posted on 2003-06-27 21:11:17 by arkane</div>
   </div>
   <div class="post" id="post-108496">
    <div class="subject"><a href="#post-108496">Faster strcat</a></div>
    <div class="body">I wasn't reading the thread, so I missed on the idea of having arbitrary parameters - 15 bytes<pre><code>strcat3&#58;<br />   pop edi<br />   pop esi<br />_0&#58;lodsb<br />   stosb<br />   test al,al<br />   jne _0<br />   pop esi<br />   dec edi<br />   test esi,esi<br />   jne _0<br />   ret<br /><br />start&#58;<br /><br />    push    __exit_strcat3<br />    push    0<br />    push    OFFSET x<br />    push    OFFSET y<br />    push    OFFSET buffer<br />    jmp     strcat3<br />    __exit_strcat3&#58;</code></pre>modified version of bitrake's algo</div>
    <div class="meta">Posted on 2003-06-27 21:29:10 by arkane</div>
   </div>
  </div>
 </body>
</html>