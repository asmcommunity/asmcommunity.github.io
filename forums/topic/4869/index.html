<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Where would one start? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=4869" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=4869">Where would one start?</a></p>
   <div class="post" id="post-34143">
    <div class="subject"><a href="#post-34143">Where would one start?</a></div>
    <div class="body">I'd love to learn about Winsock and TCP but I really don't know where to start. Basically I want to jump right into the deep end and write a program, but I doubt I'd get too far with that so hopefully someone could point me in the right direction.<br /><br />I've done some searching, so far the best code I can find is Iczelion's program which downloads files through http (I believe). However its a big enough program so it's awkard enough to follow. Practically everyting else I've found doesn't use pure winsock api but rather works inside c++ oop or something else and so is very hard to follow.<br /><br />I imagine programs that work over the net have to be very robust to account for evrything that can and does tend to go wrong, but that make them hard for a beginner to the field.<br /><br />Would anyone have or know of some completely stripped down examples or good tutorials which I could study first.<br /><br />Thank you :)</div>
    <div class="meta">Posted on 2002-04-20 12:27:27 by E贸in</div>
   </div>
   <div class="post" id="post-34176">
    <div class="subject"><a href="#post-34176">Re: Where would one start?</a></div>
    <div class="body"><div class="quote">I've done some searching, so far the best code I can find is Iczelion's program which downloads files through http (I believe). However its a big enough program so it's awkard enough to follow. Practically everyting else I've found doesn't use pure winsock api but rather works inside c++ oop or something else and so is very hard to follow.</div><br /><br />You can read the winsock 2 reference, it's available at my site. Or if you have the PSDK, read the latest docs.<br />Another very good resource is the winsock programmer's FAQ here:<br /><a target="_blank" href="http://tangentsoft.net/wskfaq/">http://tangentsoft.net/wskfaq/</a><br /><br />The most common questions are answered here.<br /><br /><div class="quote"><br />I imagine programs that work over the net have to be very robust to account for evrything that can and does tend to go wrong, but that make them hard for a beginner to the field.<br /></div><br /><br />This is certainly true. When you program an application that uses the internet (or any network), you should assume the data you receive can be *anything*. <br /><br /><div class="quote"><br />Would anyone have or know of some completely stripped down examples or good tutorials which I could study first.<br /></div><br />There have been some examples at this board in the networking section. I can send you the source of the my first HTTP file transfer program but it's one of my first programs and not very well written so it might not be a good example.<br /><br />Thomas</div>
    <div class="meta">Posted on 2002-04-20 17:14:25 by Thomas</div>
   </div>
   <div class="post" id="post-34184">
    <div class="subject"><a href="#post-34184">Networking::Where would one start?</a></div>
    <div class="body">Thank you for that link, it's very helpful. I had already found the reference on your site (a great site by the way), but on its own it was a bit complicated.<br /><br />However with some more searching I've come across what seem to be two nice guides. If anyone is intrersted they are <a target="_blank" href="">http://www.hal-pc.org/~johnnie2/winsock.html</a> and <a target="_blank" href="">http://world.std.com/~jimf/papers/sockets/winsock.html</a>. I'm going to try and work from them for the moment.<br /><br />Thanks for offering to send me your source code, but it's unlikely I'd be able to make heads nor tails of it at this stage so I'll pass for the moment. If the offer stays open I'll email you.<br /><br />Thanks agian.</div>
    <div class="meta">Posted on 2002-04-20 18:15:31 by E贸in</div>
   </div>
   <div class="post" id="post-34199">
    <div class="subject"><a href="#post-34199">Networking::Where would one start?</a></div>
    <div class="body">Hmm, I've run into some problems early on. Maybe someone might know what I'm doing wrong. I'm trying to follow the guides I mentioned above, but I can't see what I'm doing different here.<br /><br />I call gethostbyname with something like &quot;www.google.com&quot;. That returns a valid pointer to a hostent structre and I can read the values in it. So then I call socket with AF_INET, SOCK_STREAM &amp; IPPROTO_TCP as parameters. This returns what I imagine is a proper value, ie not 0 or -1 but rather something around 1800 usually.<br /><br />So then I proceed to fill out a FONT=courier new]sock_addr struct. Now I've run into a bit of inconsistity with the actaul deffinition of this structre, the one I used was <pre><code>struc sockaddr_in &#123;<br />.sin_family dw ?<br />.sin_port dw ?<br />.sin_addr dd ?<br />.sin_zero rb 8<br />&#125;</code></pre> which is 16 bytes long.<br /><br />I set <br />sin_family to AF_INET,  (This matches the value in the h_addrtype element of the hostent structre returned by gethostname.<br /><br />sin_port to the valuse returned by htons called with 80. <br /><br />sin_addr to the value at the h_addr_list element of the hostent struct.<br /><br />Then I tried calling connect but it returns -1 ie SOCKET_ERROR. Unfortunatly a subsequent call to WSAGetLastError returns 0 which is no help.<br /><br />Here is the Fasm code, the red is the values displayed.<br /><br /><br />invoke gethostbyname,hostname<br />mov ,eax<br />mov eax,<br />invoke SetDlgItemInt,,1002,eax,1  639844<br /><br />invoke socket,AF_INET,SOCK_STREAM,IPPROTO_TCP<br />mov ,eax<br />invoke SetDlgItemInt,,1003,eax,0  1892<br /><br />mov ,AF_INET<br />mov eax,<br />mov eax,<br />mov ,eax<br />invoke SetDlgItemInt,,1004,dword ,1  639844<br /><br />invoke htons,word 80<br />mov ,ax<br />movzx eax, <br />invoke SetDlgItemInt,,1005,eax,1  2<br /><br />invoke connect,,sain,16<br />invoke SetDlgItemInt,,1006,eax,-1 -1<br /><br />invoke WSAGetLastError<br />invoke SetDlgItemInt,,1007,eax,-1 0<br />-1<br /><br />Hopefully I've made sense, if anyone has any ideas I'd be very grateful. Thanks</div>
    <div class="meta">Posted on 2002-04-20 20:11:33 by E贸in</div>
   </div>
   <div class="post" id="post-34208">
    <div class="subject"><a href="#post-34208">Networking::Where would one start?</a></div>
    <div class="body">Have you been to Iczelion's winsock page?:<a target="_blank" href="http://spiff.tripnet.se/~iczelion/asmsockguide.html">http://spiff.tripnet.se/~iczelion/asmsockguide.html</a><br /><br />I am having problems with gethostbyname too.<br /><br />Here is some of my code, maybe it can help:<br /><pre><code><br /><br />                        mov                      eax, dword ptr &#91;portServer&#93;                       ;<br />                        mov                      ecx, dword ptr &#91;portServer+1&#93;                     ;<br />                        and                      eax, 0FFh                                         ;<br />                        and                      ecx, 0FFh                                         ;<br />                        jne                      _Con                                              ;<br />                        sub                      eax, 30h                                          ;<br />                        jmp                      @F                                                ;<br />_Con&#58;                   lea                      eax, &#91;4*eax&#93;&#91;eax&#93;                                 ; <br />                        lea                      eax, &#91;2*eax + ecx - 210h&#93;                         ;<br />                        mov                      ecx, dword ptr &#91;portServer+2&#93;                     ;<br />                        and                      ecx, 0FFh                                         ;<br />                        je                       @F                                                ;<br />                        lea                      eax, &#91;4*eax&#93;&#91;eax&#93;                                 ;<br />                        lea                      eax, &#91;2*eax + ecx - 30h&#93;                          ;<br />                        mov                      ecx, dword ptr &#91;portServer+3&#93;                     ;<br />                        and                      ecx, 0FFh                                         ;<br />                        je                       @F                                                ;<br />                        lea                      eax, &#91;4*eax&#93;&#91;eax&#93;                                 ;<br />                        lea                      eax, &#91;2*eax + ecx - 30h&#93;                          ;<br />                        mov                      ecx, dword ptr &#91;portServer+4&#93;                     ;<br />                        and                      ecx, 0FFh                                         ;<br />                        je                       @F                                                ;<br />                        lea                      eax, &#91;4*eax&#93;&#91;eax&#93;                                 ;<br />                        lea                      eax, &#91;2*eax + ecx - 30h&#93;                          ;<br />@@&#58;                     bswap                    eax                                               ;<br />                        shr                      eax, 16                                           ;<br />                        mov                      socketAddress.sin_port, ax                        ;<br />                        mov                      socketAddress.sin_family, AF_INET                 ;<br />                                                                                                   ;<br /><br />                                                                                                   ;<br />                        push                      offset server                                    ;<br />                        call                      inet_addr                                        ;<br />                        cmp                       eax, INADDR_NONE                                 ;<br />                        jne                       @F                                               ;<br />                        push                      offset server                                    ;<br />                        call                      gethostbyname                                    ;<br />                        test                      eax, eax                                         ;<br />                        je                        @F                                               ;<br />                        mov                       eax, dword ptr &#91;eax + 12&#93;                        ;<br />                        mov                       eax, dword ptr &#91;eax&#93;                             ;<br />                        mov                       eax, dword ptr &#91;eax&#93;                             ;<br />@@&#58;                     mov                       socketAddress.sin_addr, eax                      ;<br />                                                                                                   ;<br /><br />                                                                                                   ;<br />GetWinsock&#58;             lea                      ecx, wsaData                                      ;<br />                        push                     ecx                                               ;<br />                        push                     WINSOCK11                                         ;<br />                        call                     WSAStartup                                        ;<br />                                                                                                   ;<br /><br />                                                                                                   ;<br />WinsockSuccess&#58;         push                     IPPROTO_IP                                        ;<br />                        push                     SOCK_STREAM                                       ;<br />                        push                     AF_INET                                           ;<br />                        call                     socket                                            ;<br />                        mov                      dword ptr &#91;hSocket&#93;, eax                          ;<br />                                                                                                   ;<br /><br />                                                                                                   ;<br />ServerConnect&#58;          lea                      ecx, socketAddress                                ;<br />                        push                     sizeof sockaddr_in                                ;<br />                        push                     ecx                                               ;<br />                        push                     eax                                               ;<br />                        call                     connect                                           ;<br />                        test                     eax, eax                                          ;<br />                        jne                      Done                                              ;<br />                                                                                                   ;<br /></code></pre></div>
    <div class="meta">Posted on 2002-04-20 22:49:23 by bdjames</div>
   </div>
   <div class="post" id="post-34244">
    <div class="subject"><a href="#post-34244">Networking::Where would one start?</a></div>
    <div class="body">Thanks for that link bdjames, it was a great help and I believe I've solved my problem, actually there were two things wrong. <br /><br />First I was directly moving the h_addr_list value in the hostent structre directly into the sock_addr struct. But that value is a pointer to a pointer to the value I was suppose to be putting into the sock_addr. That explains why the c code for that was so hard to follow.<br /><br />Secondly, and stupidly I was going by the winsock help says you pass a word value to hotns, actually I should have know you pass a dword.</div>
    <div class="meta">Posted on 2002-04-21 07:05:41 by E贸in</div>
   </div>
   <div class="post" id="post-34247">
    <div class="subject"><a href="#post-34247">Networking::Where would one start?</a></div>
    <div class="body"><strong>E?in</strong>: htons and htonl basically just swap the bytes in a word or dword. A bswap or ror ax,8 will do as well. <br />If you are using constant values (eg port 80) you can use these macros as well:<br /><br /><a target="_blank" href="http://www.madwizard.org/snippets/viewSnippet.php?s_ID=4">http://www.madwizard.org/snippets/viewSnippet.php?s_ID=4</a><br /><br />Thomas</div>
    <div class="meta">Posted on 2002-04-21 07:10:57 by Thomas</div>
   </div>
  </div>
 </body>
</html>