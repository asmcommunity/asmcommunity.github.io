<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>error:STATUS_DATATYPE_MISALIGNMENT - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=10197" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=10197">error:STATUS_DATATYPE_MISALIGNMENT</a></p>
   <div class="post" id="post-76468">
    <div class="subject"><a href="#post-76468">error:STATUS_DATATYPE_MISALIGNMENT</a></div>
    <div class="body">Converting the following code from the following code to asm is really hard for me<br />.....................................................<br /><br />//ntdef.h<br /><br />typedef struct _UNICODE_STRING <br />{<br />    USHORT Length;<br />    USHORT MaximumLength;<br />    PWSTR  Buffer;<br />} UNICODE_STRING;<br />typedef UNICODE_STRING *PUNICODE_STRING;<br />typedef const UNICODE_STRING *PCUNICODE_STRING;<br />#define UNICODE_NULL ((WCHAR)0) // winnt<br /><br />//<br />// Object Attributes structure<br />//<br /><br />typedef struct _OBJECT_ATTRIBUTES {<br />    ULONG Length;<br />    HANDLE RootDirectory;<br />    PUNICODE_STRING ObjectName;<br />    ULONG Attributes;<br />    PVOID SecurityDescriptor;        // Points to type SECURITY_DESCRIPTOR<br />    PVOID SecurityQualityOfService;  // Points to type SECURITY_QUALITY_OF_SERVICE<br />} OBJECT_ATTRIBUTES;<br />typedef OBJECT_ATTRIBUTES *POBJECT_ATTRIBUTES;<br /><br />.....................................................  <br />//************My c++ code here************<br /><br />VOID SomeFunction()<br />{<br />  <br />   HANDLE   hSection=NULL;<br />   NTSTATUS status;<br />   OBJECT_ATTRIBUTES        objectAttributes;<br />   UNICODE_STRING objName;<br />   CALLGATE_DESCRIPTOR *cg;<br /><br />   status = STATUS_SUCCESS;<br />   <br />   RtlInitUnicodeString(&amp;objName,L&quot;\\Device\\PhysicalMemory&quot;);<br /><br />   InitializeObjectAttributes(&amp;objectAttributes,<br />                              &amp;objName,<br />                              OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,<br />                              NULL,<br />                             (PSECURITY_DESCRIPTOR) NULL);<br /><br />   status = ZwOpenSection(&amp;hSection,SECTION_MAP_READ|SECTION_MAP_WRITE,&amp;objectAttributes);<br />   .......................................................................................<br />   .......................................................................................<br />   .......................................................................................<br /><br />}<br />_____________________________________________<br /><br />I defined the following structs in asm. <br /><br />UNICODE_STRING	STRUCT<br />    Leng		dw		?<br />    MaximumLength	dw 		?<br />    Buffer		dd		?<br />UNICODE_STRING	ENDS	<br /><br />OBJECT_ATTRIBUTES	STRUCT<br />    Leng		dd		?<br />    RootDirectory	dd		?<br />    ObjectName	dd		?<br />    Attributes	dd		?<br />    SecurityDescriptor		dd		? <br />    SecurityQualityOfService	                dd		? <br />OBJECT_ATTRIBUTES	ENDS<br /><br />;**********My asm code here**************<br />.data<br />ObjName	UNICODE_STRING		&lt;&gt;<br />ObjAtt	OBJECT_ATTRIBUTES	&lt;&gt;<br />AnObjName	db	&quot;\\Device\\PhysicalMemory&quot;,0<br />UnObjName	dw	50 dup (0)<br /><br /><br />.code<br />Go:<br />	invoke  MultiByteToWideChar,0,0,addr AnObjName,-1,addr UnObjName,50<br /> <br />               ;****InitializeObjName*****<br />	<br />                invoke	RtlInitUnicodeString,addr ObjName,addr UnObjName<br /><br />                ;****InitializeObjectAttributes*****<br /><br />	mov  ObjAtt.Leng,sizeof OBJECT_ATTRIBUTES<br />     	mov  ObjAtt.RootDirectory,NULL<br />	mov  eax,OBJ_CASE_INSENSITIVE<br />	or   eax,OBJ_KERNEL_HANDLE<br />	mov  ObjAtt.Attributes ,eax<br />    	mov  ObjAtt.ObjectName,offset ObjName<br />    	mov  ObjAtt.SecurityDescriptor,NULL<br />                mov  ObjAtt.SecurityQualityOfService ,NULL<br />	<br /> 	invoke ZwOpenSection,addr hSection,SECTION_MAP_READ or SECTION_MAP_WRITE,addr ObjAtt<br /><br />....................................<br />end         go<br /><br />All things work well before i run the  exe, I find the returned value of ZwOpenSection is 0x80000002 (=STATUS_DATATYPE_MISALIGNMENT), I wonder how this happened.</div>
    <div class="meta">Posted on 2003-01-15 12:31:39 by cnambiman</div>
   </div>
  </div>
 </body>
</html>