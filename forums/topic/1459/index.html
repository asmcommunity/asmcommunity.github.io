<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>why crash this app after 15 second's ? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=1459" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=1459">why crash this app after 15 second's ?</a></p>
   <div class="post" id="post-9412">
    <div class="subject"><a href="#post-9412">why crash this app after 15 second's ?</a></div>
    <div class="body">hi !<br />I have written a little app, but when the key engine (run's in a thread) is start it crash's after 15 seconds.<br />I use a PIII 667 mhz / 256MB - Win98 SE<br /><br />what do the app:<br />read a encoded key (string) from the registry ( is the key not pressent it use a default one).the key is a product from the software 'WinControl99' used a simple algo to encode the password. a random char routine (not finnish now) calculat's password's and encode the password used the algo from WinControl99, then compare the coded one with the one from the registry. if the strings are equal the routine stop. i think the problem is the thread but im not sure. the not finished random char call is ok,<br />when I run the app without this routine (used a fixed string) I have the same result.<br /><br />can any one help my ?<br />thanks for all help<br />sorr for my poor english and all mistakes!<br /><br />the code :<br /><br />.386P <br />.model flat,stdCALL <br />option casemap:none <br />DlgProc    PROTO :DWORD,:DWORD,:DWORD,:DWORD <br />include \masm32\include\windows.inc <br />include \masm32\include\user32.inc <br />include \masm32\include\kernel32.inc <br />include \masm32\include\masm32.inc<br />include \masm32\include\advapi32.inc<br />includelib \masm32\lib\advapi32.lib<br />includelib \masm32\lib\user32.lib <br />includelib \masm32\lib\kernel32.lib <br />includelib \masm32\lib\masm32.lib<br /><br /><br />.const<br />TIMERID          equ      1<br />ICONA            equ    100 <br />IDE_PERMIN       equ   1000<br />IDE_PASSW        equ   1001<br />IDE_KEY          equ   1002<br />IDE_KEYS         equ   1003<br />IDC_RUNE         equ   2000<br />IDC_STOPE        equ   2001<br />IDC_EXIT         equ   2003<br /><br /><br />.data<br />count_          dd 0<br />stop_flag       dd 0<br />DlgName         db &quot;KEY&quot;,0<br />hkey            dd 80000002h<br />wico99          db &quot;Software\Salfeld&quot;,0<br />pass_w          db &quot;ID&quot;,0<br />valuetyp        dd 1<br />space           db &quot; &quot;,0<br />slash_          db &quot;/&quot;,0<br />minus           db &quot;-&quot;,0<br />fmat_s          db &quot;%lu&quot;,0<br />qkey_len        dd sizeof qkey_<br />def_key         db &quot;265-78/26456&quot;,0              ; default coded password &quot;Win32&quot;<br /><br /><br />.data?<br />hthread         dd                         ?<br />hWnd_           dd                         ?<br />hInstance       dd                         ?<br />ethread         dd                         ?<br />keynumber       dd                         ?<br />hkey_           dd                         ?<br />hpassw          dd                         ?<br />hicon           dd                         ?<br />pKey            dd                         ?<br />Disp            dd                         ?<br />random_size     dd                         ?  <br />summ_           dd                         ?<br />calc_keys       db 10           DUP       (?)<br />qkey_           db 60           DUP       (?)  <br />space_1         db 20           DUP       (?)<br />space_2         db 20           DUP       (?)<br />space_3         db 20           DUP       (?)<br />space_4         db 20           DUP       (?)<br />space_5         db 20           DUP       (?)<br />space_6         db 20           DUP       (?)<br />end_str         db 20           DUP       (?)<br />output_k        db 35           DUP       (?)<br />random_string   db 35           DUP       (?)   <br />stime           SYSTEMTIME                &lt;?&gt;<br /><br /><br />.code <br />start:                                         <br />    push 0<br />    CALL GetModuleHandle  <br />    mov  hInstance,eax <br />  <br />    push   0<br />    push   offset DlgProc<br />    push   0<br />    push   offset DlgName<br />    push   hInstance<br />    CALL   DialogBoxParam<br /><br />    ret<br /><br />   <br />;######################################################################################<br /><br />DlgProc proc hWnd:HWND, uMsg:UINT, wParam:WPARAM, lParam:LPARAM <br />      push  hWnd<br />      pop   hWnd_      <br />      cmp uMsg,WM_CLOSE<br />      je  wmdestroy<br />      cmp uMsg,WM_COMMAND<br />      je  wmcommand<br />      cmp uMsg,WM_INITDIALOG<br />      je  initdig<br />      cmp uMsg,WM_TIMER<br />      je  check_number<br />      xor eax,eax<br />      ret<br /><br /><br /><br /><br />wmcommand:                                          <br />      cmp wParam,IDC_EXIT                                              <br />      je  wmdestroy<br />      cmp wParam,IDC_STOPE<br />      je  stopkey<br />      cmp wParam,IDC_RUNE<br />      je  startkey<br />      xor eax,eax<br />      ret<br /><br /><br /><br /><br />check_number:                      ; all 10 second's<br />      mov     eax,keynumber        <br />      push    eax<br />      xor     eax,eax<br />      mov     keynumber,eax      <br />      push    offset fmat_s                  <br />      push    offset calc_keys<br />      CALL    wsprintf            <br /><br />      push    offset calc_keys<br />      push    IDE_PERMIN<br />      push    hWnd<br />      CALL    SetDlgItemText      <br />      <br />      xor     eax,eax<br />      ret<br /><br /><br /><br /><br /><br />stopkey:<br />      inc  stop_flag              <br /><br />      push   IDC_STOPE<br />      push   hWnd<br />      CALL   GetDlgItem<br />      push   0<br />      push   eax<br />      CALL   EnableWindow         <br /><br />      push   IDC_RUNE<br />      push   hWnd<br />      CALL   GetDlgItem<br />      push   1<br />      push   eax<br />      CALL   EnableWindow        <br />      xor  eax,eax<br />      ret<br /><br /><br /><br /><br />wmdestroy:    <br />      push 0<br />      CALL ExitProcess          <br />      xor  eax,eax<br />      ret<br /><br /><br /><br /><br />initdig: <br />      push   ICONA<br />      push   hInstance<br />      CALL   LoadIcon<br />      mov    hicon,eax<br /><br />      push   eax<br />      push   ICONA<br />      push   WM_SETICON<br />      push   hWnd<br />      CALL   SendMessage<br />    <br />      push   offset Disp<br />      push   offset pKey<br />      push   0<br />      push   KEY_ALL_ACCESS<br />      push   0<br />      push   0<br />      push   0<br />      push   offset wico99<br />      push   hkey<br />      CALL   RegCreateKeyEx         <br /><br />      push   offset qkey_len<br />      push   offset qkey_<br />      push   offset valuetyp<br />      push   0<br />      push   offset pass_w<br />      push   pKey<br />      CALL   RegQueryValueEx           ; passwort from registry !<br />   <br />      push   pKey<br />      CALL   RegCloseKey<br /><br />      lea    eax,qkey_<br />      cmp    dword ptr,0<br />      je     not_installed             ; not installed ? default key<br /><br />      push   offset qkey_<br />      push   IDE_KEYS<br />      push   hWnd<br />      CALL   SetDlgItemText<br />      jmp    install_ok<br />     <br />not_installed:<br />      push   offset def_key             ; default key &quot;Win32&quot;<br />      push   IDE_KEYS<br />      push   hWnd<br />      CALL   SetDlgItemText<br />      <br />install_ok:<br />      push   IDE_KEY<br />      push   hWnd<br />      CALL   GetDlgItem                <br />      mov    hkey_,eax<br /><br />      push   IDE_PASSW<br />      push   hWnd<br />      CALL   GetDlgItem                <br />      mov    hpassw,eax<br /><br />      mov    random_size,5              <br />      xor    eax,eax<br />      ret<br /><br /><br /><br /><br /><br />startkey:                                 ; start key engine<br />      push  IDC_RUNE<br />      push  hWnd_<br />      CALL  GetDlgItem<br />      push  0<br />      push  eax<br />      CALL  EnableWindow               <br /><br />      push   IDC_STOPE<br />      push   hWnd<br />      CALL   GetDlgItem<br />      push   1<br />      push   eax<br />      CALL   EnableWindow             <br /><br />      lea   eax,keythread<br />      push  offset hthread<br />      push  0<br />      push  0<br />      push  eax<br />      push  0<br />      push  0<br />      CALL  CreateThread               <br /><br />      push  hthread<br />      push  offset ethread<br />      CALL  GetExitCodeThread                ; save threads exit code<br />      xor   eax,eax<br />      ret<br /><br /><br />      ret<br />DlgProc endP<br /><br /><br />;##############################################################################################<br /><br />keythread proc                             <br /><br />      push  0<br />      push  10000 <br />      push  TIMERID<br />      push  hWnd_<br />      CALL  SetTimer               <br /><br />calc_:<br />      inc    keynumber<br />      cmp    stop_flag,0                <br />      je     ok_go_<br />      mov    stop_flag,0                <br /><br />      push   TIMERID                    <br />      push   hWnd_<br />      CALL   KillTimer                  <br />      <br />      push   ethread<br />      CALL   ExitThread                 <br />      xor    eax,eax<br />      mov    keynumber,eax            <br />      ret       <br />      <br />ok_go_:<br />      CALL   rand_char                  <br />      <br />      lea    esi,random_string      <br />      mov    ecx,random_size            <br />      xor    eax,eax                    <br />      mov    summ_,eax                    <br />      <br />generate:                                 ; decode the random passwort<br />      mov    edx,summ_                   <br />      lodsb                              <br />      add    edx,eax                     <br />      imul   edx,3                      <br />      mov    summ_,edx                  <br />      dec    ecx                        <br />      cmp    ecx,0                      <br />      jne    generate                   <br /><br />      imul   edx,4                      <br />      imul   edx,2                     <br />      mov    summ_,edx                   <br />      sub    edx,1234                    <br />      <br />      push   edx                         <br />      push   offset fmat_s<br />      push   offset space_2<br />      CALL   wsprintf                   <br /><br />      lea    esi,space_2                 <br />      lea    edi,end_str                 <br />      mov    ecx,5                       <br />      rep    movsb                       <br /><br />      push   summ_    <br />      push   offset fmat_s<br />      push   offset space_6<br />      CALL   wsprintf                   <br /><br />      lea    esi,space_6<br />      lea    edi,space_3<br />      movsb<br />      movsb<br />      movsb                              <br />      <br />      push   offset minus<br />      push   offset space_3<br />      CALL   lstrcat                   <br /><br />      push   offset space_3<br />      CALL   lstrlen                    <br /><br />      lea    edi,space_3                   <br />      add    edi,eax<br />      push   edi                        <br /><br />      lea    esi,space_3<br />      lea    edi,space_4<br />      movsb<br />      movsb                             <br /><br />      push   offset space_4             <br />      CALL   atodw                      <br />      imul   eax,3                     <br />      pop    edi                       <br />      <br />      push   eax <br />      push   offset fmat_s<br />      push   edi<br />      CALL   wsprintf                 <br />                                         <br />      push   offset slash_           <br />      push   offset space_3             <br />      CALL   lstrcat                     <br /><br />      push   offset space_3<br />      push   offset output_k<br />      CALL   lstrcat                     <br />      <br />      push   offset end_str<br />      push   offset output_k<br />      CALL   lstrcat                    <br /><br />      push   offset output_k<br />      push   0<br />      push   WM_SETTEXT<br />      push   hkey_<br />      CALL   SendMessage<br />      <br />      push   offset random_string<br />      push   0<br />      push   WM_SETTEXT<br />      push   hpassw<br />      CALL   SendMessage<br /><br />      push   offset output_k<br />      push   offset qkey_<br />      CALL   lstrcmp                                   <br />      cmp    eax,0<br />      jne    clear_buffers<br />      mov    stop_flag,1                   <br /><br />clear_buffers:                              ; clear all buffer's <br />      lea    edi,space_1                <br />      mov    ecx,210<br />      xor     al,al<br />      rep    stosb                       <br /><br />      jmp    calc_                      <br /><br />keythread endp<br /><br /><br />;#########################################################################################<br /><br />; the routine is not finish, now return's only a string between 3 and 10 bytes length filled with <br />; chars from 'a' - 'z' <br />; I have the app testet without this call, used a fixed string eg. 'win32asm' but it crash's to ! <br /><br />rand_char  proc<br /><br />   .if      random_size==10<br />     mov  ecx,9<br />   .elseif  random_size==9<br />     mov  ecx,8<br />   .elseif  random_size==8<br />     mov  ecx,7<br />   .elseif  random_size==7<br />     mov  ecx,6<br />   .elseif  random_size==6<br />     mov  ecx,5<br />   .elseif  random_size==5<br />     mov  ecx,4<br />   .elseif  random_size==4<br />     mov  ecx,3<br />   .elseif  random_size==3<br />     mov  ecx,10<br />   .endif<br /><br />    mov  random_size,ecx<br />    mov  count_,ecx<br />    lea  edi,random_string<br />    <br /><br />@@1:<br />    push offset stime<br />    CALL GetLocalTime<br />    mov  ax,stime.wMilliseconds<br />@@2:    <br />  <br />   .if al&gt;=97 &amp;&amp; al&lt;=122<br />    stosb<br />    dec  count_<br />   .elseif al&gt;=122<br />    sub  al,27<br />    jmp @@2<br />   .elseif al&lt;=97<br />    add  al,19<br />    jmp @@2<br />   .endif<br /><br />    cmp count_,0<br />    jne @@1<br />    ret<br />rand_char  endp<br /><br />END start<br /><br /><br /><br />rsrc.rc:<br /><br />#include &quot;\masm32\include\resource.h&quot;<br />ICONA   ICON                                           &quot;key.ICO&quot;<br />#define IDC_STATIC         -1<br />#define ICONA             100 <br />#define IDE_PERMIN       1000<br />#define IDE_PASSW        1001<br />#define IDE_KEY          1002<br />#define IDE_KEYS         1003<br />#define IDC_RUNE         2000<br />#define IDC_STOPE        2001<br />#define IDC_EXIT         2003<br /><br /><br /><br /><br /><br />KEY DIALOGEX 0, 0, 199, 120<br />STYLE DS_ABSALIGN | DS_MODALFRAME | DS_SETFOREGROUND | DS_3DLOOK | DS_CENTER | <br />    WS_POPUP | WS_VISIBLE | WS_CAPTION | WS_SYSMENU<br />EXSTYLE WS_EX_CLIENTEDGE | WS_EX_STATICEDGE<br />CAPTION &quot;key&quot;<br />FONT 8, &quot;MS Sans Serif&quot;<br />BEGIN<br />    PUSHBUTTON      &quot;Stop Engine&quot;,IDC_STOPE,126,35,58,12<br />    PUSHBUTTON      &quot;Exit&quot;,IDC_EXIT,126,51,58,12<br />    EDITTEXT        IDE_PASSW,12,89,86,14,ES_CENTER | ES_READONLY<br />    GROUPBOX        &quot;Passwort&quot;,IDC_STATIC,6,78,100,30<br />    GROUPBOX        &quot;Calculated key...&quot;,IDC_STATIC,6,42,100,30<br />    EDITTEXT        IDE_KEY,12,53,86,14,ES_CENTER | ES_READONLY<br />    PUSHBUTTON      &quot;Start Engine&quot;,IDC_RUNE,126,19,58,12<br />    EDITTEXT        IDE_KEYS,12,17,86,14,ES_CENTER | ES_READONLY<br />    GROUPBOX        &quot;Wico99 coded key...&quot;,IDC_STATIC,6,6,100,30<br />    GROUPBOX        &quot;Calculated key's (10sec)&quot;,IDC_STATIC,112,78,84,31<br />    EDITTEXT        IDE_PERMIN,127,89,47,12,ES_AUTOHSCROLL | ES_READONLY<br />END</div>
    <div class="meta">Posted on 2001-10-14 15:57:40 by Marcello</div>
   </div>
   <div class="post" id="post-9424">
    <div class="subject"><a href="#post-9424">You forgot to restore ESP.</a></div>
    <div class="body">wsprintf uses 'C' calling convention.<br />(All any other Win32 API functions use 'STDCALL' calling convention except wsprintf.)<br /><br />So, you should restore stack frame pointer value.<br />Try this:<br /><br />push  ???<br />push  ???<br />push  ???<br />call  wsprintf<br />add  esp,(4*x)  'x' is the number of pushed arguments.<br /><br />But, If you use 'INVOKE',<br />This is done by your MASM assembler. (Very easy!)</div>
    <div class="meta">Posted on 2001-10-14 19:35:49 by nyam</div>
   </div>
   <div class="post" id="post-9444">
    <div class="subject"><a href="#post-9444">thank's nyam !</a></div>
    <div class="body">hi nyam !<br /><br />I have restored the stack after all wsprintf calls, and now it work's fine !<br /><br />thank's for your help !<br />marcello.</div>
    <div class="meta">Posted on 2001-10-15 05:15:40 by Marcello</div>
   </div>
   <div class="post" id="post-9460">
    <div class="subject"><a href="#post-9460">why crash this app after 15 second's ?</a></div>
    <div class="body">marcello, why are you using manual pushes and call instead of the<br />nice feature of masm, invoke? It looks cleaner, it takes up less code<br />lines, you don't have to worry about pushing in reverse order...<br />and you avoid stupid bugs and mistakes like the one you just had.</div>
    <div class="meta">Posted on 2001-10-15 13:25:28 by f0dder</div>
   </div>
   <div class="post" id="post-9467">
    <div class="subject"><a href="#post-9467">why crash this app after 15 second's ?</a></div>
    <div class="body">happy birthday f0dder !<br /><br />ok using invoke it's the better way, but the old method is in my brain ;-)<br />for my next work i use invoke !<br /><br />marcello.</div>
    <div class="meta">Posted on 2001-10-15 15:59:47 by Marcello</div>
   </div>
  </div>
 </body>
</html>