<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Unicode Dialog - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=21725" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=21725">Unicode Dialog</a></p>
   <div class="post" id="post-163917">
    <div class="subject"><a href="#post-163917">Unicode Dialog</a></div>
    <div class="body">G&#39;day All,<br /><br />I&#39;m trying to display a dialog with Unicode/wide charactersets.<br /><br />The dialog works OK in normal mode (DialogBoxParam), but does not display the<br />wide (Cyrillic-Russian) characters correctly in wide mode (DialogBoxParamW).<br /><br />The wide (Cyrillic-Russian) characters do display correctly in a test message box<br />(MessageBoxW).<br /><br />Also the dialog title in Cyrillic-Russian (SendMessageW) is also displayed correctly.<br /><br />The problem is with the Edit and Combo controls in wide mode. These<br />controls display garbage in wide mode :(<br /><br />Can anyone see what I am doing wrong?<br /><br />Thanks<br />dorf<br /><br />Setup:<br />Win2K<br />Masm32 v.8.2 SP2a<br />RadASM v.2.2.0.3<br /><br />Dialog resource - RadSM generated:<br /><pre><code><br />#define IDD_UNIDLG 4000<br />#define IDC_UNIEDTCTL 4002<br />#define IDC_UNIEDTLBL 4001<br />#define IDC_UNICBOLBL 4003<br />#define IDC_UNICBOCTL 4004<br />IDD_UNIDLG DIALOGEX 6,6,248,134<br />CAPTION &quot;My Dialog&quot;<br />FONT 8,&quot;MS Sans Serif&quot;,400,0<br />STYLE 0x10CF0000<br />EXSTYLE 0x00000000<br />BEGIN<br />&nbsp; CONTROL &quot;&quot;,IDC_UNIEDTCTL,&quot;Edit&quot;,0x50010000,122,24,116,11,0x00000200<br />&nbsp; CONTROL &quot;My Edit&quot;,IDC_UNIEDTLBL,&quot;Static&quot;,0x50000000,6,24,96,11,0x00000000<br />&nbsp; CONTROL &quot;My Combo&quot;,IDC_UNICBOLBL,&quot;Static&quot;,0x50000000,6,59,100,11,0x00000000<br />&nbsp; CONTROL &quot;&quot;,IDC_UNICBOCTL,&quot;ComboBox&quot;,0x50010002,122,59,112,62,0x00000080<br />END<br /></code></pre><br /><br /><br />.code<br /><pre><code><br />invoke IsWindowsNT<br />.if(eax)<br />	invoke DialogBoxParamW, hInstance, IDD_UNIDLG, hWndMain, offset SciUniDialogProc, FALSE<br />.else<br />	; Not WinNT or Win2000<br />	invoke DialogBoxParam, hInstance, DD_UNIDLG, hWndMain, offset SciUniDialogProc, FALSE<br />.endif<br /><br /><br />SciUniDialogProc proc uses ebx esi edi, hDlg:HWND, uMsg:UINT, wParam:WPARAM, lParam:LPARAM<br />	LOCAL codePage:dword<br />	LOCAL	uniStr[128]:word<br />	LOCAL hCtlEdit:dword<br />	LOCAL hCtlCombo:dword<br /><br />	mov eax, uMsg<br />	.if eax==WM_INITDIALOG<br />		mov eax, hDlg<br />		mov hFindReplace, eax<br />		; Set the codepage to Cyrillic-Russian<br />		mov codePage, 1251<br /><br />		invoke GetDlgItem, hFindReplace, IDC_UNIEDTCTL<br />		mov hCtlEdit, eax<br />		invoke GetDlgItem, hFindReplace, IDC_UNICBOCTL<br />		mov hCtlCombo, eax<br /><br />		invoke IsWindowUnicode, hDlg<br />		.if(eax)<br />			invoke Beep, 100, 100<br />			; Get the buffer length (in wide characters)<br />			invoke MultiByteToWideChar, codePage, 0, addr sciTEBase.findWhat, \<br />												-1, addr uniStr, 0<br />			; Map the character string to a wide-character (Unicode) string.<br />			invoke MultiByteToWideChar, codePage, 0, addr sciTEBase.findWhat, \<br />												-1, addr uniStr, eax<br />		<br />			; Messagebox (wide) displays the Cyrillic text 	&lt;&lt;&lt; OK<br />			invoke MessageBoxW,0, addr uniStr, CStr(&#39;Cyrillic Characters:&#39;), MB_OK<br />			<br />			; Set the dialog title									&lt;&lt;&lt; OK<br />			invoke SendMessageW, hDlg, WM_SETTEXT, 0, addr uniStr<br />			<br />			; Set the dialog Edit control:						&lt;&lt;&lt; Garbage<br />			invoke SetDlgItemTextW, hDlg, IDC_UNIEDTLBL, addr uniStr<br />			invoke SetDlgItemTextW, hDlg, IDC_UNIEDTCTL, addr uniStr<br />		<br />			; Set the dialog Combo control:						&lt;&lt;&lt; Garbage<br />			invoke SetDlgItemTextW, hDlg, IDC_UNICBOLBL, addr uniStr<br />			invoke SendMessageW, hCtlCombo, WM_SETTEXT, 0, addr uniStr<br />			invoke SendMessageW, hCtlCombo, CB_ADDSTRING, 0, addr uniStr<br />		<br />		.else<br />			; ASCII 8-Bit - ALL OK<br />			; Set the dialog title - OK<br />			invoke SendMessage, hDlg, WM_SETTEXT, 0, CStr(&#39;Cyrillic Dialog&#39;)<br />		<br />			; Set the dialog Edit control:<br />			invoke SetDlgItemText, hDlg, IDC_UNIEDTLBL, CStr(&#39;Cyrillic Edit Control:&#39;)<br />			invoke SetDlgItemText, hDlg, IDC_UNIEDTCTL, CStr(&#39;Cyrillic Edit Control:&#39;)<br />		<br />			; Set the dialog Combo control:<br />			invoke SetDlgItemText, hDlg, IDC_UNICBOLBL, CStr(&#39;Cyrillic Combo Control:&#39;)<br />			invoke SendMessage, hCtlCombo, WM_SETTEXT, 0, CStr(&#39;Cyrillic Combo Control:&#39;)<br />			invoke SendMessage, hCtlCombo, CB_ADDSTRING, 0, CStr(&#39;Cyrillic Item 1&#39;)<br />		.endif<br /><br />		return TRUE<br /><br />	.elseif eax==WM_COMMAND<br />		; ...<br />	;.elseif eax==WM_ACTIVATE<br />		; ...<br />	.elseif eax==WM_CLOSE<br />		; ...Sci<br />	.else<br />		return FALSE<br />	.endif<br /><br />	return TRUE<br /><br />SciUniDialogProc endp<br /></code></pre><br /></div>
    <div class="meta">Posted on 2005-08-28 22:08:11 by dorf</div>
   </div>
   <div class="post" id="post-163931">
    <div class="subject"><a href="#post-163931">Re: Unicode Dialog</a></div>
    <div class="body">when i had a lang problem i&#39;v put this line in start of &lt;project&gt;.rc file.<br />LANGUAGE LANG_CROATIAN, SUBLANG_NEUTRAL<br /><br />default is<br />LANGUAGE LANG_ENGLISH, SUBLANG_ENGLISH_US<br /></div>
    <div class="meta">Posted on 2005-08-29 07:05:49 by drizz</div>
   </div>
   <div class="post" id="post-163933">
    <div class="subject"><a href="#post-163933">Re: Unicode Dialog</a></div>
    <div class="body">You can also try setting the code page using project options.<br /><br />This example sets codepage 1250:<br /><br />4,O,$B\RC.EXE /c1250 /v,1<br /><br />KetilO</div>
    <div class="meta">Posted on 2005-08-29 07:20:23 by KetilO</div>
   </div>
   <div class="post" id="post-163934">
    <div class="subject"><a href="#post-163934">Re: Unicode Dialog</a></div>
    <div class="body">i think you can try add manifest in you resource file , it useful with me on winxp .</div>
    <div class="meta">Posted on 2005-08-29 08:17:09 by secmask</div>
   </div>
   <div class="post" id="post-163935">
    <div class="subject"><a href="#post-163935">Re: Unicode Dialog</a></div>
    <div class="body"><div class="quote">2.1.0.2<br />- Added LANGUAGE settings to resources.</div><br /><br /><strong>OMG</strong> i just noticed that i didn&#39;t update my radasm.ini file with this section.<br /><br />KetilO: do i need to manually add &quot;#include &lt;Res\xxxxxxLng.rc&gt;&quot; to project.rc or ?</div>
    <div class="meta">Posted on 2005-08-29 08:33:04 by drizz</div>
   </div>
   <div class="post" id="post-163938">
    <div class="subject"><a href="#post-163938">Re: Unicode Dialog</a></div>
    <div class="body">Thanks guys<br /><br />I should have also mentioned that I have to change codepage and<br />chararacter sets on-the-fly (user selectable).<br /><br />KetilO:<br />4,O,$B\RC.EXE /c1251 /v,1<br />Sorry :( didn&#39;t work<br /><br />drizz:<br />Do you mean something like below:<br />This will not compile for me :(<br />But I found an interesting link on MS relating to LANGUAGE definition:<br />http://www.microsoft.com/globaldev/handson/dev/muiapp.mspx<br />I&#39;ll check it out, but I don&#39;t think it is quite what I need. I need to<br />change CP/CS on-the-fly.<br /><br /><pre><code><br />IDD_UNIDLG DIALOGEX 6,6,251,134<br />CAPTION &quot;My Dialog&quot;<br />FONT 8,&quot;MS Sans Serif&quot;,400,0<br />STYLE 0x10CF0000<br />LANGUAGE LANG_CROATIAN, SUBLANG_NEUTRAL<br />EXSTYLE 0x00000000<br />BEGIN<br />&nbsp; CONTROL &quot;&quot;,IDC_UNIEDTCTL,&quot;Edit&quot;,0x50010000,122,24,116,11,0x00000200<br />&nbsp; CONTROL &quot;My Edit&quot;,IDC_UNIEDTLBL,&quot;Static&quot;,0x50000000,6,24,96,11,0x00000000<br />&nbsp; CONTROL &quot;My Combo&quot;,IDC_UNICBOLBL,&quot;Static&quot;,0x50000000,6,59,100,11,0x00000000<br />&nbsp; CONTROL &quot;&quot;,IDC_UNICBOCTL,&quot;ComboBox&quot;,0x50010002,122,59,112,62,0x00000080<br />END<br /></code></pre><br /><br />secmask:<br />Can you please post a small example of how to do this. I don&#39;t think this is what<br />I need here, but am interested in how to do it anyway.<br /><br /><br />About the original concept. The Scintilla guys gave got this to work<br />well (in C++). SciTE can switch CP/CS on-the-fly. I&#39;m trying to port the dialog <br />to masm32.<br /><br />Ref:<br />A free source code editing component for Win32 and GTK+<br />www.scintilla.org<br />Download Scintilla and SciTE<br />http://scintilla.sourceforge.net/SciTEDownload.html<br /><br />Here is the original dialog from the SciTE source:<br />Their setup procedure is much as I mine above.<br /><pre><code><br />IDD_FIND DIALOG 30, 73, 275, 84<br />STYLE DS_MODALFRAME | DS_3DLOOK | WS_POPUP | WS_CAPTION | WS_SYSMENU<br />CAPTION &quot;Find&quot;<br />FONT 8, &quot;MS Shell Dlg&quot;<br />BEGIN<br />	LTEXT&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &quot;Fi&amp;nd what:&quot;,-1,5,7,45,8<br />	COMBOBOX&nbsp; &nbsp; &nbsp; &nbsp; IDFINDWHAT,50,5,145,50, WS_TABSTOP | CBS_DROPDOWN | CBS_AUTOHSCROLL<br />	AUTOCHECKBOX&nbsp; &nbsp; &quot;Match &amp;whole word only&quot;, IDWHOLEWORD,5,22,120,10, WS_GROUP | WS_TABSTOP<br />	AUTOCHECKBOX&nbsp; &nbsp; &quot;Match &amp;case&quot;, IDMATCHCASE,5,34,130,10, WS_GROUP | WS_TABSTOP<br />	AUTOCHECKBOX&nbsp; &nbsp; &quot;Regular &amp;expression&quot;, IDREGEXP,5,46,120,10, WS_GROUP | WS_TABSTOP<br />	AUTOCHECKBOX&nbsp; &nbsp; &quot;Wrap aroun&amp;d&quot;, IDWRAP,5,58,120,10, WS_GROUP | WS_TABSTOP<br />	AUTOCHECKBOX&nbsp; &nbsp; &quot;Transform &amp;backslash expressions&quot;, IDUNSLASH,5,70,160,10, WS_GROUP | WS_TABSTOP<br />	GROUPBOX&nbsp; &nbsp; &nbsp; &nbsp; &quot;Direction&quot;, -1, 135,22,60,34,WS_GROUP<br />	AUTORADIOBUTTON &quot;&amp;Up&quot;,IDDIRECTIONUP,140,30,45,12, WS_GROUP<br />	AUTORADIOBUTTON &quot;&amp;Down&quot;,IDDIRECTIONDOWN,140,42,45,12<br />	DEFPUSHBUTTON&nbsp;  &quot;&amp;Find Next&quot;,IDOK,205,5,65,14,WS_GROUP<br />	PUSHBUTTON&nbsp; &nbsp; &nbsp; &quot;&amp;Mark All&quot;,IDMARKALL,205,23,65,14<br />	PUSHBUTTON&nbsp; &nbsp; &nbsp; &quot;Cancel&quot;,IDCANCEL,205,41,65,14<br />END<br /></code></pre><br /><br />Thanks <br />dorf<br /></div>
    <div class="meta">Posted on 2005-08-29 09:10:34 by dorf</div>
   </div>
   <div class="post" id="post-163949">
    <div class="subject"><a href="#post-163949">Re: Unicode Dialog</a></div>
    <div class="body"><strong>dorf</strong>: check if this works for you, i have never written anything multilingual.<br /><pre><code><br />#define LANG_RUSSIAN 0x19<br />#define SUBLANG_NEUTRAL 0x00<br />#define LANG_CROATIAN 0x1A<br />#define SUBLANG_CROATIAN_CROATIA 0x01<br />LANGUAGE LANG_RUSSIAN,SUBLANG_NEUTRAL<br />100 DIALOGEX 6,6,251,134<br />CAPTION &quot;?????????&quot;<br />FONT 8,&quot;MS Sans Serif&quot;,400,0<br />STYLE 0x10CF0000<br />BEGIN<br />END<br />LANGUAGE LANG_CROATIAN,SUBLANG_CROATIAN_CROATIA<br />100 DIALOGEX 6,6,251,134<br />CAPTION &quot;Hrvatski&quot;<br />FONT 8,&quot;MS Sans Serif&quot;,400,0<br />STYLE 0x10CF0000<br />BEGIN<br />END<br /></code></pre><br /><pre><code><br />	MAKELANGID macro p,s<br />	;#define MAKELANGID(p, s) ((((WORD  )(s)) &lt;&lt; 10) | (WORD  )(p))<br />	exitm %((s shl 10) or p)<br />	endm<br />	.if Lang == LANG_RUSSIAN<br />		mov eax,MAKELANGID(LANG_RUSSIAN,0)<br />	.elseif Lang == LANG_CROATIAN<br />		mov eax,MAKELANGID(LANG_CROATIAN,1)<br />	.endif<br />	invoke FindResourceEx,hInstance,RT_DIALOG,100,eax<br />	.if eax<br />		mov eax,.IMAGE_RESOURCE_DATA_ENTRY.OffsetToData<br />		add eax,hInstance<br />		invoke DialogBoxIndirectParam,hInstance,eax,0,offset DlgProc,0<br />	.endif<br /></code></pre><br />btw setthreadlocale won&#39;t work on 2k/XP</div>
    <div class="meta">Posted on 2005-08-29 19:51:03 by drizz</div>
   </div>
   <div class="post" id="post-163952">
    <div class="subject"><a href="#post-163952">Re: Unicode Dialog</a></div>
    <div class="body"><strong>drizz:</strong><br />I got your RUSSIAN/CROATIAN dialogs to display OK<br />The CROATIAN text displays correctly<br />The RUSSIAN text is still broken :sad:<br /><br />But that leads to more interesting research:<br />http://msdn.microsoft.com/library/default.asp?url=/library/en-us/wceinternational5/html/wce50lrfmakelangid.asp<br />MAKELANGID macro<br />Language Identifiers and Locales<br />http://msdn.microsoft.com/library/default.asp?url=/library/en-us/wceinternational5/html/wce50conlanguageidentifiersandlocales.asp<br /><br />This multilingual subject is certainly a head-banger&nbsp; :)<br /><br />Thanks <br />dorf</div>
    <div class="meta">Posted on 2005-08-29 21:58:08 by dorf</div>
   </div>
   <div class="post" id="post-163992">
    <div class="subject"><a href="#post-163992">Re: Unicode Dialog</a></div>
    <div class="body">Got it figured&nbsp;  :D<br /><br />Here&#39;s how I figured it out:<br />I actually gave up on this for now. So I thought I would have a browse for a few minutes. <br /><br />The &quot;program breaks&quot; topic by czDrillard looks interesting, so I had a quick browse through <br />the posts. The link &quot;exception handling - Jeremy Gordon&quot; by donkey in looks good so I&#39;ll check <br />it out.<br /><br />After reading the &quot;exception handling&quot; page I&#39;ll check out what else Jeremy <br />Gordon has on his site (http://www.jorgon.freeserve.co.uk/). Ahhh some stuff <br />on Unicode!<br /><br />Taking a look at &quot;Hello Unicode 1 A simple program with a Unicode UTF-8&quot; under<br />the Advanced heading, see:<br />---<br />; If you see question marks instead of Russian in the MS-DOS (Command prompt) <br />; window (console) right click on the title bar and change font to Lucida Console.<br />; That font is capable of drawing Unicode characters to the console.<br />---<br /><br />That looks something like the problem!<br /><br />Try changing the font of the dialog to &quot;Arial&quot; (in RadASM project-&gt;dialog-&gt;Font) and <br />re-build! Bingo ... thats it :))<br /><br />So - here is what the dialog definition should look like (Using a font that can do<br />the Unicode character set on a particular system):<br /><br /><pre><code><br />#define IDD_UNIDLG 4000<br />#define IDC_UNIEDTCTL 4002<br />#define IDC_UNIEDTLBL 4001<br />#define IDC_UNICBOLBL 4003<br />#define IDC_UNICBOCTL 4004<br />IDD_UNIDLG DIALOGEX 5,5,218,118<br />CAPTION &quot;My Dialog&quot;<br />FONT 9,&quot;Arial&quot;,400,0<br />STYLE 0x10CF0000<br />EXSTYLE 0x00000000<br />BEGIN<br />&nbsp; CONTROL &quot;&quot;,IDC_UNIEDTCTL,&quot;Edit&quot;,0x50010000,105,21,100,10,0x00000200<br />&nbsp; CONTROL &quot;My Edit&quot;,IDC_UNIEDTLBL,&quot;Static&quot;,0x50000000,5,21,82,9,0x00000000<br />&nbsp; CONTROL &quot;My Combo&quot;,IDC_UNICBOLBL,&quot;Static&quot;,0x50000000,5,51,85,9,0x00000000<br />&nbsp; CONTROL &quot;&quot;,IDC_UNICBOCTL,&quot;ComboBox&quot;,0x50010002,105,51,96,54,0x00000080<br />END <br /></code></pre><br /><br /><br />Heres a bit on Unicode/fonts if anyone is interested:<br /><br /><strong>Unicode Fonts</strong><br /><a target="_blank" href="http://www.jorgon.freeserve.co.uk/GoasmHelp/Unicode.htm">http://www.jorgon.freeserve.co.uk/GoasmHelp/Unicode.htm</a><br /><br />--- cut ---<br />The trick is to find the correct font and character set to draw the characters <br />which need to be drawn. <br /><br />Not all fonts and character sets will be installed on all machines. What fonts <br />and character sets are loaded on installation will depend on which version of <br />Windows is being used, whether it is an English or other language version, and <br />what applications are loaded (they can come with their own fonts). <br /><br />Every Windows machine will have installed Courier New, Arial, Times New Roman, <br />Symbol, Wingdings, MS Serif, MS Sans Serif and (on later versions) Tahoma. <br />Depending on the Windows version, between them these fonts can handle at least <br />Western and Central European, Hebrew, Arabic, Greek, Turkish, Baltic, Cyrillic and <br />Vietnamese scripts. <br /><br />You can see what fonts are loaded on your machine by looking in the Windows\fonts <br />folder or at &quot;Control Panel, fonts&quot;.<br />--- cut ---<br /><br />Regards<br />dorf<br /><br /></div>
    <div class="meta">Posted on 2005-08-30 22:42:23 by dorf</div>
   </div>
   <div class="post" id="post-164056">
    <div class="subject"><a href="#post-164056">Re: Unicode Dialog</a></div>
    <div class="body">A good site for people developing International software:<br /><br /><strong>Michael Kaplan&#39;s - Sorting It All Out Blog</strong><br /><a target="_blank" href="http://blogs.msdn.com/michkap/">http://blogs.msdn.com/michkap/</a><br /><br />Lot of indepth Localization / character encoding discussion and security issues<br /><br />Here&#39;s some security (buffer overflow) issues to watch for when using encoding<br /><br /><strong>Encoding APIs and Security Concerns</strong><br /><a target="_blank" href="http://blogs.msdn.com/michkap/archive/category/8717.aspx">http://blogs.msdn.com/michkap/archive/category/8717.aspx</a><br />---cut---<br />A few of the gotchas of WideCharToMultiByte and A few of the gotchas of MultiByteToWideChar.<br /><br />Both API topics (MultiByteToWideChar and WideCharToMultiByte) include &quot;Security Alert&quot; warnings <br />to which developers should pay heed:<br /><br />	security note Security Alert&nbsp;  Using the WideCharToMultiByte function incorrectly can compromise <br />	the security of your application. Calling the WideCharToMultiByte function can easily cause a <br />	buffer overrun because the size of the In buffer equals the number of WCHARs in the string, <br />	while the size of the Out buffer equals the number of bytes. To avoid a buffer overrun, be sure <br />	to specify a buffer size appropriate for the data type the buffer receives. For more information, <br />	see Security Considerations: International Features.<br /><br />	security note Security Alert&nbsp;  Using the MultiByteToWideChar function incorrectly can compromise <br />	the security of your application. Calling the MultiByteToWideChar function can easily cause a buffer <br />	overrun because the size of the In buffer equals the number of bytes in the string, while the size <br />	of the Out buffer equals the number of WCHARS. To avoid a buffer overrun, be sure to specify a <br />	buffer size appropriate for the data type the buffer receives. For more information, see Security <br />	Considerations: International Features.<br /><br />It seems obvious from the parameter names (cbMultiByte vs. cchWideChar) that one parameter is a <br />count of bytes and the other is a count of characters. But if you mess it up then it is easy to cause <br />a buffer overrun as the alerts indicate, which is obviously bad. Another problem that can happen is <br />that the call could fail due to insufficient buffer size.<br /><br />Now historically people seem to like calling these APIs without checking the return value. Or alternately <br />they call with a NULL target buffer to get the size, allocate a target buffer based on that size, and then <br />call the API again without checking the return value. Obviously both of the possible problems can be bad<br />...<br />--- cut ---<br /><br />dorf<br /><br /></div>
    <div class="meta">Posted on 2005-09-01 17:50:58 by dorf</div>
   </div>
   <div class="post" id="post-164177">
    <div class="subject"><a href="#post-164177">Re: Unicode Dialog</a></div>
    <div class="body">oh , i don&#39;t think add manifest resource is new .people add this to resource to has XP look control . but when i try to type some unicode text , it won&#39;t look as unicode character if i didn&#39;t add this resource . if you aren&#39;t family with this you can see Radasm box , there are some easy way to add manifest resource there . good luck.</div>
    <div class="meta">Posted on 2005-09-04 09:01:00 by secmask</div>
   </div>
  </div>
 </body>
</html>