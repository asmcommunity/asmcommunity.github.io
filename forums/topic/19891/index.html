<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Replacing Variables....Ran Out of Registers....Ready to Cry - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=19891" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=19891">Replacing Variables....Ran Out of Registers....Ready to Cry</a></p>
   <div class="post" id="post-152742">
    <div class="subject"><a href="#post-152742">Replacing Variables....Ran Out of Registers....Ready to Cry</a></div>
    <div class="body">I am re-doing parts of my program to make it more portable. It's a lame debugger/memory dump type thing.<br /><pre><code><br />hexBPrint proc<br />		push ebp<br />		mov ebp, esp<br />		mov eax, &#91;ebp+8&#93;<br />		mov BYTE PTR &#91;ebp-4&#93;, 0<br /><br />            lea    ebx,hexOut+1     ; address for last character<br />            mov    ecx,2            ; number of characters<br />forCount&#58;   mov    edx,eax          ; copy pattern<br />            and    edx,0fh   	    ; zero all but last hex digit<br />            cmp    edx,9            ; digit?<br />            jnle   elseLetter       ; letter if not<br />            or     edx,30h          ; convert to character<br />            jmp    endifDigit<br />elseLetter&#58; add    edx,'A'-10       ; convert to letter<br />endifDigit&#58;<br />	    cmp BYTE PTR &#91;ebp-4&#93;, 1<br />	    jne firstdigit<br />	    mov BYTE PTR &#91;ebp-8&#93;,dl<br /><br />firstdigit&#58; inc BYTE PTR &#91;ebp-4&#93;	<br />            mov    BYTE PTR &#91;ebx&#93;,dl ; copy character to memory<br />            dec    ebx              ; point at next character<br />            shr    eax,4            ; shift one hex digit right<br />            loop   forCount         ; repeat<br /><br />output BYTE PTR &#91;ebp-8&#93;<br />		<br />	pop ebp<br />	ret<br />hexBPrint endp<br /></code></pre><br /><br />Here's a little info about it. An address is pushed. This proc is supposed to take a byte, convert to hex, and return. It can do that, using the variable hexOut, but that's all hexOut is used for. I want this more self-contained. Let's say in memory, there was the letter d. It would return 64. I need to move that into a BYTE variable (the only one I want) in another proc, so I need each digit seperate. I will do a mov buffer[31], 6 and mov buffer[32], 4. If I could return the 64 in a register, I can divide by 10 to get each number or if I could just return each number seperate, that would be fine, too.<br /><br />The problem is, I ran out of registers to store stuff. I tried using  and  for extra space, but I run into the problem that the number gets stored in dl, a byte. When I output , I get (_c and not 6. I tried pushing dl in the loop, then after, popping them back out, but it doesn't like the push dl. I tried taking the first number and multiplying it by 10, then adding dl to it to get the number in eax instead of hexOut, but then I use eax, which is already in use.</div>
    <div class="meta">Posted on 2004-11-11 16:57:41 by sjaguar13</div>
   </div>
   <div class="post" id="post-152743">
    <div class="subject"><a href="#post-152743">Replacing Variables....Ran Out of Registers....Ready to Cry</a></div>
    <div class="body">use the stack then<br /><br />hexBPrint proc<br /><br />      local my_little_buffer [256]:byte<br /><br />      push ebp<br />      mov ebp, esp<br />      mov eax, <br />      mov BYTE PTR , 0 <br /><br />........................<br /><br />now u have a 256 byte buffer on the stack easily accessable like<br /><br />lea edi,my_little_buffer<br /><br />sets edi to the start of the buffer, then simple indexing to store the values u need<br />mov byte ptr ,al <br /><br />etc.. obviously requires to rewrite your code a bit<br /><br />alternatively... your code is a bit bloated<br />using the  is pointless, considering you dont actually act on it<br />(ecx = loop counter)<br /><br /><pre><code><br /><br /><br />hexBPrint proc uses eax ebx ,value&#58;dword<br /><br />         mov      eax,value<br />         mov      ebx, offset hexout+1<br />         mov      ah,al<br />         and       eax,0f00fh<br /><br />         rol        ah,4<br /><br />donextdigitthen&#58;<br /><br />         cmp      al,9<br />         ja  short  hexadjustmentchar<br /><br />         add       al,'0'<br /><br />         jmp short storecharacter<br /><br />hexadjustmentchar&#58;<br /><br />         add      al,'A'-10<br /><br />storecharacter&#58;<br /><br />         mov     byte ptr  &#91;ebx&#93;,al<br />         dec      ebx<br /><br />         mov     al,ah<br /><br />         cmp     ebx,offset hexout<br />         jnb      donextdigitthen<br /><br />         ret<br /><br />hexBPrint endp<br /><br />eg&#58;<br /><br />push 0f0h<br />call hexBPrint<br /><br />etc<br /><br /><br /></code></pre></div>
    <div class="meta">Posted on 2004-11-11 17:31:38 by evlncrn8</div>
   </div>
   <div class="post" id="post-152744">
    <div class="subject"><a href="#post-152744">Replacing Variables....Ran Out of Registers....Ready to Cry</a></div>
    <div class="body">I see what you mean about the ebp-4 being pointless. I was just trying stuff to see if I could actually get it to work on my own...I couldn't. The proc that calls this one does something with the numbers, and the address that is pushed into this proc doesn't have all the bytes that are going into the buffer. All I would need is a buffer that is 2 bytes big. If I make a local buffer, though, isn't that going away when when it's done with the proc?</div>
    <div class="meta">Posted on 2004-11-11 18:00:53 by sjaguar13</div>
   </div>
   <div class="post" id="post-152747">
    <div class="subject"><a href="#post-152747">Re: Replacing Variables....Ran Out of Registers....Ready to</a></div>
    <div class="body">You can also free up some registers so that you don't have to use local stack space.  There are a few different ways to do it, I am just going to show you one.  I am going to swap what ECX and EBP are used for.  EBP will now be the loop variable, and CL and CH or ECX will be EBP-4 and EBP-8 respectively.  I am commenting out the lines you don't need anymore.<br /><br /><pre><code><br />hexBPrint proc<br />		push ebp<br />;		mov ebp, esp<br />		mov eax, &#91;ebp+8&#93;<br />;		mov BYTE PTR &#91;ebp-4&#93;, 0<br />                 xor ecx,ecx             ;zero EBP-4<br /><br />            lea    ebx,hexOut+1     ; address for last character<br />;            mov    ecx,2            ; number of characters<br />            mov    ebp,2            ; number of characters<br />forCount&#58;   mov    edx,eax          ; copy pattern<br />            and    edx,0fh   	    ; zero all but last hex digit<br />            cmp    edx,9            ; digit?<br />            jnle   elseLetter       ; letter if not<br />            or     edx,30h          ; convert to character<br />            jmp    endifDigit<br />elseLetter&#58; add    edx,'A'-10       ; convert to letter<br />endifDigit&#58;<br />;	    cmp BYTE PTR &#91;ebp-4&#93;, 1<br />	    cmp cl, 1<br />	    jne firstdigit<br />;	    mov BYTE PTR &#91;ebp-8&#93;,dl<br />	    mov ch,dl<br /><br />firstdigit&#58;<br />;            inc BYTE PTR &#91;ebp-4&#93;	<br />            inc cl<br />            mov    BYTE PTR &#91;ebx&#93;,dl ; copy character to memory<br />            dec    ebx              ; point at next character<br />            shr    eax,4            ; shift one hex digit right<br /><br />;            loop   forCount         ; repeat<br />            dec    ebp                  ;decrement loop variable<br />            jnz     forCount           ;not zero? jump to forCount<br /><br />output ch<br />		<br />	pop ebp<br />	ret<br />hexBPrint endp<br /></code></pre><br /><br />  In your original code ou can also unroll the loop twice and free up ECX that way, and then never push/pop EBP.<br /><br />  You can also shuffle other registers around to free up registers.</div>
    <div class="meta">Posted on 2004-11-11 20:18:32 by mark_larson</div>
   </div>
   <div class="post" id="post-152748">
    <div class="subject"><a href="#post-152748">Replacing Variables....Ran Out of Registers....Ready to Cry</a></div>
    <div class="body">sjaguar13,<br /><br />There is a magic rule when you first lay out an algorithm, always start with the required number of local variables, get the code going reliably and THEN start replacing variables with registers. If you need to you can remove the stack frame to get EBP and if you are into living dangerously and understand what you are doing, you can use ESP as well.<br /><br />You tend to do this style of code well along the development path once you have the algo up and going. Doing an algorithm in this order allows you to target the parts that will see the best speed increases by using registers and not waste them on variables where the speed does not matter.</div>
    <div class="meta">Posted on 2004-11-11 20:54:54 by hutch--</div>
   </div>
  </div>
 </body>
</html>