<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Calling C libraries in gas - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=30688" />
  <link rel="prev" href="../?id=30688&amp;page=1" />   </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=30688">Calling C libraries in gas</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=30688&amp;page=1" style="">&laquo;</a><a href="../?id=30688&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="30688" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>   <div class="post" id="post-215163">
    <div class="subject"><a href="#post-215163">Re: Calling C libraries in gas</a></div>
    <div class="body">Ah! Thanks, Rob!<br /><br />Not all that easy to edit winsock.inc, since it un-tars as readonly, so had to chmod +w first. I didn&#039;t put it back to readonly - probably should have so it doesn&#039;t get modified accidentally...<br /><br />Then, my &quot;fakeapi&quot; no longer works - apparently because &quot;new NASMX&quot; uses a different linker than &quot;old NASMX&quot;. I solved it by &quot;%define&quot;ing the &quot;true names&quot; back to the &quot;short names&quot;. Would have been easier if I&#039;d done it that way in the first place! That finally got it to work (in Linux).<br /><br />But this is merely a distraction from the project at hand - getting my IP from http://www.whatismyip.com . Going back to my &quot;plain&quot; version, if I deliberately butcher the &quot;request&quot;, I get back &quot;400 bad request&quot;. This indicates that my socket/connect/write/read are all working (doesn&#039;t it?). Yet if I write a &quot;correct&quot; (as nearly as I can determine) request, I get nothing at all back - the &quot;read&quot; just hangs...<br /><br />At the moment, I&#039;m stumped!<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2011-10-08 08:56:40 by fbkotler</div>
   </div>
   <div class="post" id="post-215167">
    <div class="subject"><a href="#post-215167">Re: Calling C libraries in gas</a></div>
    <div class="body"><div class="quote"><br />Ah! Thanks, Rob!<br /><br />Not all that easy to edit winsock.inc, since it un-tars as readonly, so had to chmod +w first. I didn&#039;t put it back to readonly - probably should have so it doesn&#039;t get modified accidentally...<br /><br />Then, my &quot;fakeapi&quot; no longer works - apparently because &quot;new NASMX&quot; uses a different linker than &quot;old NASMX&quot;. I solved it by &quot;%define&quot;ing the &quot;true names&quot; back to the &quot;short names&quot;. Would have been easier if I&#039;d done it that way in the first place! That finally got it to work (in Linux).<br /></div><br /><br />hmmm...GoLink has been in use for quite some time ( ie: even before my involvement ).&nbsp; This may be another issue altogether.<br /><br /><div class="quote"><br />But this is merely a distraction from the project at hand - getting my IP from http://www.whatismyip.com . Going back to my &quot;plain&quot; version, if I deliberately butcher the &quot;request&quot;, I get back &quot;400 bad request&quot;. This indicates that my socket/connect/write/read are all working (doesn&#039;t it?). <br /></div><br /><br />Yes, at least as far as initial connection and request transmission.<br /><br /><div class="quote"><br />Yet if I write a &quot;correct&quot; (as nearly as I can determine) request, I get nothing at all back - the &quot;read&quot; just hangs...<br /><br />At the moment, I&#039;m stumped!<br /><br />Best,<br />Frank<br /></div><br /><br />In the request header you are specifying:<br /><pre><code><br />&nbsp; &nbsp; db &quot;Host: clax.inspiretomorrow.net&quot; ,13 ,10<br /></code></pre><br /><br />This returns 96.9.162.227 as the IP address when I ping it.<br />However, you are specifying 75.126.1.55 for your connection which appears to be resolving to some host at softlayer.com.<br />This appears to be a simple mismatch, thus the server is possibly dropping the request for the unknown host.<br /></div>
    <div class="meta">Posted on 2011-10-08 20:34:05 by p1ranha</div>
   </div>
   <div class="post" id="post-215168">
    <div class="subject"><a href="#post-215168">Re: Calling C libraries in gas</a></div>
    <div class="body">Ah ha! That&#039;s a good clue. In the &quot;plain&quot; version, I&#039;m using www.whatismyip.com for the host, or sometimes automation.whatismyip.com - which appears to be the same IP, but &quot;reversed&quot; 72.233.89.198 vs 198.89.233.72. I may well be butchering the conversion of the &quot;dotted quad&quot; to a big-endian dword, as well.<br /><br />I distinctly remember writting some code that converted something in the form &quot;72.233.89.198&quot; to a big-endian dword (&quot;long&quot; in Gas), but I can&#039;t find it. As I remember, I wasn&#039;t too happy with it anyway...<br /><br />Lemme rework some of that from &quot;square one&quot; (or &quot;square zero&quot; in assembly :) ), and see if that provides any enlightenment...<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2011-10-08 21:02:42 by fbkotler</div>
   </div>
   <div class="post" id="post-215204">
    <div class="subject"><a href="#post-215204">Re: Calling C libraries in gas</a></div>
    <div class="body">Well, Here I am again.<br />I could create the socket, connect it and send the http request.<br />Now the problem is in receive all the information<br /><br />this is my code<br /><pre><code><br />.section .data<br />Errorsocket: .asciz&quot;socket() failed \n&quot;<br />Econnect: .asciz&quot;error connecting socket \n&quot;<br />request: .ascii&nbsp; &quot;GET /index.html HTTP/1.1 Host: www.whatismyip.com User-Agent: assembly language Connection: close&quot;<br /><br />.equ length, request<br />.section .bss<br />buffer: .space 100<br />.section .text<br /><br />.globl _start<br />_start:<br />&nbsp; &nbsp; &nbsp;  #Creating a reliable, stream socket&nbsp; TCP<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; movl $2, (%esp) #af_inet<br />&nbsp; &nbsp; &nbsp; &nbsp; movl $1, 4(%esp) #sock-stream<br />&nbsp; &nbsp; &nbsp; &nbsp; movl $0, 8(%esp) #ipprotocp<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; movl $102,%eax #socketcall<br />&nbsp; &nbsp; &nbsp; &nbsp; movl $1,%ebx&nbsp;  #socketcall_socket<br />&nbsp; &nbsp; &nbsp; &nbsp; movl %esp,%ecx #<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  int&nbsp; $0x80<br />&nbsp; &nbsp; &nbsp; &nbsp; cmpl $0, %eax<br />&nbsp; &nbsp; &nbsp; &nbsp; jl error<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; #Establish a connection to the server<br />&nbsp; &nbsp; &nbsp; &nbsp; # connect (int fd, struct sockaddr *uservaddr, int addrlen)&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; #parameters sent to esp<br />	 movl %eax, (%esp) #fd<br />&nbsp; &nbsp; &nbsp; &nbsp; #struct sockaddrr *uservaddr <br />&nbsp; &nbsp; &nbsp; &nbsp; movw $2, 12(%esp) #af_inet<br />&nbsp; &nbsp; &nbsp; &nbsp; movw $0x5000, 14(%esp) #port<br />&nbsp; &nbsp; &nbsp; &nbsp; movl $0xc559e948, 16(%esp) # ip<br /><br />&nbsp; &nbsp; &nbsp; &nbsp;  #connect()<br />&nbsp; &nbsp; &nbsp; &nbsp;  leal 12(%esp), %ebx #loading sockaddr *uservaddr pointer. <br />&nbsp; &nbsp; &nbsp; &nbsp;  movl %ebx, 4(%esp) #we move the pointer after fd, that is to say 4<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $16, 8(%esp)&nbsp; #size&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;  movl&nbsp; &nbsp; $102,%eax&nbsp; &nbsp;  #socketcall<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl&nbsp; &nbsp; $3, %ebx&nbsp; &nbsp;  #connect<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl %esp, %ecx<br />&nbsp; &nbsp; &nbsp; &nbsp;  int&nbsp; &nbsp; $0x80<br />&nbsp; &nbsp; &nbsp; &nbsp;  cmpl $0, %eax<br />&nbsp; &nbsp; &nbsp; &nbsp;  jne error2<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #send()<br />&nbsp; &nbsp; &nbsp; &nbsp;  leal request, %eax<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl %eax, 8(%esp)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $length, 12(%esp)<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $0, 16(%esp)<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $102, %eax<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $9, %ebx&nbsp; #send system call&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;  movl %esp, %ecx<br />&nbsp; &nbsp; &nbsp; &nbsp;  int $0x80<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp;  #receive()<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $buffer, 8(%esp)<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $99, 12(%esp)<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $0, 16(%esp)<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $102, %eax<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $10, %ebx<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl %esp, %ecx<br />&nbsp; &nbsp; &nbsp; &nbsp;  int $0x80<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jmp endprogram<br />error:&nbsp;  pushl $Errorsocket<br />&nbsp; &nbsp; &nbsp; &nbsp;  call printf<br />&nbsp; &nbsp; &nbsp; &nbsp;  jmp&nbsp; endprogram<br /><br />error2:&nbsp; pushl %eax<br />&nbsp; &nbsp; &nbsp; &nbsp;  pushl $Econnect<br />&nbsp; &nbsp; &nbsp; &nbsp;  call printf <br />&nbsp; &nbsp; &nbsp; &nbsp;  jmp endprogram<br />endprogram:&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; movl $1, %eax<br /> 	movl $0, %ebx<br /> 	int $0x80 <br /></code></pre><br />It returns me in %eax: -22. So, it is clear that there is a problem.<br />Before that, I would like to clear up some doubts that I have.<br />In send() function, it returns me: 2736. The number of bytes sent if successful. So, it sent 2736 bytes...&nbsp;  how I realised that the quantity bytes sent are correct?<br />Then, according to <br />recv(int s, void *buf, size_t len, int flags);<br />I have to send the buffer pointer. My question is: how many bytes do I have to set to the buffer var? I set up 100 but because I had no idea what i had to write there.<br /><br />And finally, why it returned me this error?<br /><br />thanks!!!<br /><br /><br /><br /><br /></div>
    <div class="meta">Posted on 2011-10-13 15:46:30 by massem</div>
   </div>
   <div class="post" id="post-215206">
    <div class="subject"><a href="#post-215206">Re: Calling C libraries in gas</a></div>
    <div class="body"><div class="quote"><br />Well, Here I am again.<br />I could create the socket, connect it and send the http request.<br />Now the problem is in receive all the information<br /></div><br /><br />No, your initial problem is still in the send().&nbsp; There may be more but I don&#039;t have the time to debug it.<br /><br />The HTTP protocol uses CR/LF delimited headers in the request with a separate CR/LF at the end.<br /><br />You originally wrote:<br /><br /><div class="quote"><br /><pre><code><br />request: .ascii&nbsp; &quot;GET /index.html HTTP/1.1 Host: www.whatismyip.com User-Agent: assembly language Connection: close&quot;<br /></code></pre><br /></div><br /><br />But you need this (note that this is Nasm syntax):<br /><br /><pre><code><br />msg db &quot;GET /index.html HTTP/1.1&quot;, 13, 10<br />&nbsp; &nbsp; db &quot;Host: www.whatismyip.com&quot; ,13 ,10<br />&nbsp; &nbsp; db &quot;User-Agent: assembly language&quot;, 13, 10<br />&nbsp; &nbsp; db &quot;Connection: close&quot;, 13, 10<br />&nbsp; &nbsp; db 13, 10<br />msg_len equ $ - msg<br /></code></pre><br /><br />The <strong>13,10</strong> characters are the Carraige Return and Line Feed characters (CR/LF) you are missing.<br />You need to understand the protocol first in order to properly submit requests and receive replys.<br /></div>
    <div class="meta">Posted on 2011-10-13 17:39:05 by p1ranha</div>
   </div>
   <div class="post" id="post-215207">
    <div class="subject"><a href="#post-215207">Re: Calling C libraries in gas</a></div>
    <div class="body">Well, I tried p1ranha&#039;s advice regarding the &quot;correct&quot; IP for &quot;Nathan&#039;s server&quot;. Getting &quot;Network Unreachable&quot;! I haven&#039;t gotten back to that one...<br /><br />Trying this minor tweak to Marce&#039;s code, I get 404! That&#039;s the closest I&#039;ve come yet!<br /><br /><pre><code><br />.section .data<br />Errorsocket: .asciz&quot;socket() failed \n&quot;<br />Econnect: .asciz&quot;error connecting socket \n&quot;<br />request: .ascii&nbsp; &quot;GET /index.html HTTP/1.1\r\nHost: www.whatismyip.com\r\nUser-Agent: assembly language\r\nConnection: close\r\n\r\n&quot;<br /><br />.equ length, . - request<br />.section .bss<br />buffer: .space 100<br />sockdesc: .long 0<br />.section .text<br /><br />.globl _start<br />_start:<br />&nbsp; &nbsp; &nbsp;  #Creating a reliable, stream socket&nbsp; TCP<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; movl $2, (%esp) #af_inet<br />&nbsp; &nbsp; &nbsp; &nbsp; movl $1, 4(%esp) #sock-stream<br />&nbsp; &nbsp; &nbsp; &nbsp; movl $0, 8(%esp) #ipprotocp<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; movl $102,%eax #socketcall<br />&nbsp; &nbsp; &nbsp; &nbsp; movl $1,%ebx&nbsp;  #socketcall_socket<br />&nbsp; &nbsp; &nbsp; &nbsp; movl %esp,%ecx #<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  int&nbsp; $0x80<br />&nbsp; &nbsp; &nbsp; &nbsp; cmpl $0, %eax<br />&nbsp; &nbsp; &nbsp; &nbsp; jl error<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; #Establish a connection to the server<br />&nbsp; &nbsp; &nbsp; &nbsp; # connect (int fd, struct sockaddr *uservaddr, int addrlen)&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; #parameters sent to esp<br />	 movl %eax, (%esp) #fd<br />&nbsp; &nbsp; &nbsp; &nbsp; #struct sockaddrr *uservaddr <br />&nbsp; &nbsp; &nbsp; &nbsp; movw $2, 12(%esp) #af_inet<br />&nbsp; &nbsp; &nbsp; &nbsp; movw $0x5000, 14(%esp) #port<br />&nbsp; &nbsp; &nbsp; &nbsp; movl $0xc559e948, 16(%esp) # ip<br /><br />&nbsp; &nbsp; &nbsp; &nbsp;  #connect()<br />&nbsp; &nbsp; &nbsp; &nbsp;  leal 12(%esp), %ebx #loading sockaddr *uservaddr pointer. <br />&nbsp; &nbsp; &nbsp; &nbsp;  movl %ebx, 4(%esp) #we move the pointer after fd, that is to say 4<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $16, 8(%esp)&nbsp; #size&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;  movl&nbsp; &nbsp; $102,%eax&nbsp; &nbsp;  #socketcall<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl&nbsp; &nbsp; $3, %ebx&nbsp; &nbsp;  #connect<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl %esp, %ecx<br />&nbsp; &nbsp; &nbsp; &nbsp;  int&nbsp; &nbsp; $0x80<br />&nbsp; &nbsp; &nbsp; &nbsp;  cmpl $0, %eax<br />&nbsp; &nbsp; &nbsp; &nbsp;  jne error2<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #send()<br />&nbsp; &nbsp; &nbsp; &nbsp;  leal request, %eax<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl %eax, 4(%esp) # buf <br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $length, 8(%esp) #length<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $0, 12(%esp) #flags<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $102, %eax<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $9, %ebx&nbsp; #send system call&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;  movl %esp, %ecx<br />&nbsp; &nbsp; &nbsp; &nbsp;  int $0x80<br /><br />	 testl %eax, %eax<br />	 jns goodsend<br />	 call report_error<br />&nbsp; &nbsp; &nbsp; &nbsp;  jmp&nbsp; endprogram<br />goodsend:	 <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp;  #receive()<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $buffer, 4(%esp)<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $99, 8(%esp)<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $0, 12(%esp)<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $102, %eax<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $10, %ebx<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl %esp, %ecx<br />&nbsp; &nbsp; &nbsp; &nbsp;  int $0x80<br />	 testl %eax, %eax<br />	 jns goodrecv<br />	 call report_error<br />&nbsp; &nbsp; &nbsp; &nbsp;  jmp&nbsp; endprogram<br />goodrecv:<br />	pushl $buffer<br />	call printf<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jmp endprogram<br />error:&nbsp;  pushl $Errorsocket<br />&nbsp; &nbsp; &nbsp; &nbsp;  call printf<br />&nbsp; &nbsp; &nbsp; &nbsp;  jmp&nbsp; endprogram<br /><br />error2:&nbsp; pushl %eax<br />&nbsp; &nbsp; &nbsp; &nbsp;  pushl $Econnect<br />&nbsp; &nbsp; &nbsp; &nbsp;  call printf <br />&nbsp; &nbsp; &nbsp; &nbsp;  jmp endprogram<br />endprogram:&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; movl $1, %eax<br /> 	movl $0, %ebx<br /> 	int $0x80 <br /></code></pre><br /><br />As you see, I call my &quot;report_error&quot;, so you&#039;ll have to link against &quot;rpterror.o&quot;... or dump that...<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2011-10-13 21:01:08 by fbkotler</div>
   </div>
   <div class="post" id="post-215208">
    <div class="subject"><a href="#post-215208">Re: Calling C libraries in gas</a></div>
    <div class="body">Bingo!<br /><br /><pre><code><br />.section .data<br />Errorsocket: .asciz&quot;socket() failed \n&quot;<br />Econnect: .asciz&quot;error connecting socket \n&quot;<br />request: .ascii&nbsp; &quot;GET / HTTP/1.1\r\nHost: www.whatismyip.com\r\nUser-Agent: assembly language\r\nConnection: close\r\n\r\n&quot;<br /><br />.equ length, . - request<br /><br />.section .bss<br />buffer: .space 0x1000<br /><br />.section .text<br /><br />.globl _start<br />_start:<br />&nbsp; &nbsp; &nbsp;  #Creating a reliable, stream socket&nbsp; TCP<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; movl $2, (%esp) #af_inet<br />&nbsp; &nbsp; &nbsp; &nbsp; movl $1, 4(%esp) #sock-stream<br />&nbsp; &nbsp; &nbsp; &nbsp; movl $0, 8(%esp) #ipprotocp<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; movl $102,%eax #socketcall<br />&nbsp; &nbsp; &nbsp; &nbsp; movl $1,%ebx&nbsp;  #socketcall_socket<br />&nbsp; &nbsp; &nbsp; &nbsp; movl %esp,%ecx #<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  int&nbsp; $0x80<br />&nbsp; &nbsp; &nbsp; &nbsp; cmpl $0, %eax<br />&nbsp; &nbsp; &nbsp; &nbsp; jl error<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; #Establish a connection to the server<br />&nbsp; &nbsp; &nbsp; &nbsp; # connect (int fd, struct sockaddr *uservaddr, int addrlen)&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; #parameters sent to esp<br />	 movl %eax, (%esp) #fd<br />&nbsp; &nbsp; &nbsp; &nbsp; #struct sockaddrr *uservaddr <br />&nbsp; &nbsp; &nbsp; &nbsp; movw $2, 12(%esp) #af_inet<br />&nbsp; &nbsp; &nbsp; &nbsp; movw $0x5000, 14(%esp) #port<br />&nbsp; &nbsp; &nbsp; &nbsp; movl $0xc559e948, 16(%esp) # ip<br /><br />&nbsp; &nbsp; &nbsp; &nbsp;  #connect()<br />&nbsp; &nbsp; &nbsp; &nbsp;  leal 12(%esp), %ebx #loading sockaddr *uservaddr pointer. <br />&nbsp; &nbsp; &nbsp; &nbsp;  movl %ebx, 4(%esp) #we move the pointer after fd, that is to say 4<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $16, 8(%esp)&nbsp; #size&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;  movl&nbsp; &nbsp; $102,%eax&nbsp; &nbsp;  #socketcall<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl&nbsp; &nbsp; $3, %ebx&nbsp; &nbsp;  #connect<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl %esp, %ecx<br />&nbsp; &nbsp; &nbsp; &nbsp;  int&nbsp; &nbsp; $0x80<br />&nbsp; &nbsp; &nbsp; &nbsp;  cmpl $0, %eax<br />&nbsp; &nbsp; &nbsp; &nbsp;  jne error2<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #send()<br />&nbsp; &nbsp; &nbsp; &nbsp;  leal request, %eax<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl %eax, 4(%esp) # buf <br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $length, 8(%esp) #length<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $0, 12(%esp) #flags<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $102, %eax<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $9, %ebx&nbsp; #send system call&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;  movl %esp, %ecx<br />&nbsp; &nbsp; &nbsp; &nbsp;  int $0x80<br /><br />	 testl %eax, %eax<br />	 jns goodsend<br />	 call report_error<br />&nbsp; &nbsp; &nbsp; &nbsp;  jmp&nbsp; endprogram<br />goodsend:	 <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp;  #receive()<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $buffer, 4(%esp)<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $0x1000, 8(%esp)<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $0, 12(%esp)<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $102, %eax<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $10, %ebx<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl %esp, %ecx<br />&nbsp; &nbsp; &nbsp; &nbsp;  int $0x80<br />	 testl %eax, %eax<br />	 jns goodrecv<br />	 call report_error<br />&nbsp; &nbsp; &nbsp; &nbsp;  jmp&nbsp; endprogram<br />goodrecv:<br />	pushl $buffer<br />	call printf<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jmp endprogram<br />error:&nbsp;  pushl $Errorsocket<br />&nbsp; &nbsp; &nbsp; &nbsp;  call printf<br />&nbsp; &nbsp; &nbsp; &nbsp;  jmp&nbsp; endprogram<br /><br />error2:&nbsp; pushl %eax<br />&nbsp; &nbsp; &nbsp; &nbsp;  pushl $Econnect<br />&nbsp; &nbsp; &nbsp; &nbsp;  call printf <br />&nbsp; &nbsp; &nbsp; &nbsp;  jmp endprogram<br />endprogram:&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; movl $1, %eax<br /> 	movl $0, %ebx<br /> 	int $0x80 <br /></code></pre><br /><br />P1ranha&#039;s tips were especially helpful! That &quot;extra CRLF&quot; at the end helped my version, too.<br /><br />Making a request for just &quot;/&quot; rather than &quot;/index.html&quot; got rid of the 404!<br />I made your buffer a little bigger, and re-arranged some of the parameters - at first, I didn&#039;t &quot;get&quot; that you were putting the file descriptor at (%esp) and leaving it there. Okay, but then you were putting remaining parameters at 8(%esp) and up - should have been at 4(%esp) and up (I think). Anyway, this &quot;seems to work&quot;.<br /><br />Best,<br />Frank<br /></div>
    <div class="meta">Posted on 2011-10-14 00:33:00 by fbkotler</div>
   </div>
   <div class="post" id="post-215209">
    <div class="subject"><a href="#post-215209">Re: Calling C libraries in gas</a></div>
    <div class="body">Mmmm... well, that doesn&#039;t get quite the whole page. There&#039;s quite a lot of it - almost 19k. What I&#039;ve done in my Nasm version is to make the buffer bigger still, at which point I ran into a problem I know can occur with sockets: you don&#039;t always get the whole thing in one read. I&#039;m using sys_read/sys_write instead of send/recv. So I put the read in a loop, until it returned zero. I think now I&#039;m getting the whole &quot;index.html&quot; (although it apparently isn&#039;t named that). The &quot;relevant&nbsp; portion&quot;, I think, goes like this:<br /><div class="quote"><br />Your IP Address Is: &lt;span id=&quot;184&quot;&gt;&#38;#55;&lt;/span&gt;&lt;label id=&quot;125&quot;&gt;<br />2&lt;/label&gt;&lt;label id=&quot;237&quot;&gt;&#38;#46;&lt;/label&gt;&#38;#55;&#38;#49;&#38;#46;<br />&lt;!--Do not scrape your IP from here, go to<br />www.whatismyip.com/faq/automation.asp for more information<br />on our automation rules.--&gt;&#38;#50;&lt;label class=&quot;116&quot;&gt;1&lt;/label&gt;<br />&lt;span id=&quot;125&quot;&gt;&#38;#50;&lt;/span&gt;&lt;span class=&quot;73&quot;&gt;&#38;#46;&lt;/span&gt;&#38;#56;&lt;br /&gt;<br /></div><br /><br />I don&#039;t see how to parse my IP out of that mess, and they seem to be asking us not to do it. I guess that leaves us with their automation page. Can we just &quot;GET&quot; an .asp file? I don&#039;t even know what an .asp file is!<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2011-10-14 02:47:54 by fbkotler</div>
   </div>
   <div class="post" id="post-215213">
    <div class="subject"><a href="#post-215213">Re: Calling C libraries in gas</a></div>
    <div class="body">well as p1ranha adviced me, I am reading http protocol to understand it.<br /><br />Anyway, I&#039;m happy for you Frank, you are so close!<br />In regarding your doubts:<br /><div class="quote">I didn&#039;t &quot;get&quot; that you were putting the file descriptor at (%esp) and leaving it there</div><br />I left the fd at (%esp) which is saved there from its creation .. isn&#039;t it?<br /><br /><div class="quote">you were putting remaining parameters at 8(%esp) and up - should have been at 4(%esp) and up (I think).</div><br />mmm I started putting parameters at 4(%esp), look this:<br /><pre><code><br />leal request, %eax&nbsp; #Loading the request address in %eax<br />movl %eax, 4(%esp) # Loading the mention address in 4(%esp)&nbsp; <br />movl $length, 8(%esp) #Loading its length<br />movl $0, 12(%esp) #flags <br /></code></pre>		 <br /><br />Maybe we have to specify this address GET /n09230945.asp&nbsp; HTTP/1.1<br />instead of www.whatismyip.com at GET<br /><br />What do u think, guys?<br /></div>
    <div class="meta">Posted on 2011-10-14 08:28:39 by massem</div>
   </div>
   <div class="post" id="post-215214">
    <div class="subject"><a href="#post-215214">Re: Calling C libraries in gas</a></div>
    <div class="body">The request <strong>GET / HTTP/1.1</strong> returns the default page of the site being visited.&nbsp; For most web sites this is the file <strong>index.html</strong>.&nbsp; Note that Windows servers ( and oddly configured Linux servers ) may expect <strong>default.htm</strong> or some other named file.&nbsp;  Thus specifically requesting the file <strong>index.html</strong> from those servers may fail or will return a code to redirect the &quot;browser&quot; to the site&#039;s true home page.</div>
    <div class="meta">Posted on 2011-10-14 09:17:14 by p1ranha</div>
   </div>
   <div class="post" id="post-215215">
    <div class="subject"><a href="#post-215215">Re: Calling C libraries in gas</a></div>
    <div class="body">what about this?<br />GET /automation/n09230945.asp HTTP/1.0<br />Host: www.whatismyip.com</div>
    <div class="meta">Posted on 2011-10-14 10:19:49 by massem</div>
   </div>
   <div class="post" id="post-215216">
    <div class="subject"><a href="#post-215216">Re: Calling C libraries in gas</a></div>
    <div class="body">That gets me a page telling me that the automation file has moved. Going where it says gets me the &quot;rules&quot; file (they don&#039;t want us to hit it more often than every five minutes). The actual n09230945.asp file is apparently at automation.whatismyip.com rather than www.whatismyip.com. I dunno...<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2011-10-14 11:33:58 by fbkotler</div>
   </div>
   <div class="post" id="post-215218">
    <div class="subject"><a href="#post-215218">Re: Calling C libraries in gas</a></div>
    <div class="body">HTTP/1.1 200 OK !!!!!!!!!!!<br /><br />I made it.<br />Check this out:<br />request:&nbsp; .ascii &quot;GET /n09230945.asp HTTP/1.1\r\nHost: automation.whatismyip.com\r\nUser-Agent: assembly language\r\nConnection: close\r\n\r\n&quot;<br /><br />but I got<br />HTTP/1.1 200 OK<br />Connection: close<br />Date: Fri, 14 Oct 2011 19:12:06 GMT<br />Server: Microsoft-IIS/6.0<br />X-Powered-By: ASP.NET<br />Content-Length: 14<br />Content-Type: text/html<br />Set-Cookie: ASPSESSIONIDCQQTRQCA=IIHPGABANHDNNAAIKJJGMJML; path=/<br />Cache-control: private<br /><br />I guess due to the fact that it could be possible that the bytes sent by a call to send() on one<br />end of a connection may not all be returned by a single call to recv() on the other end. I need to repeatedly receive bytes until I have received as many as we sent.<br /><br />Is it ok ?<br /><br /><br /><br /><br /><br /><br /></div>
    <div class="meta">Posted on 2011-10-14 13:51:21 by massem</div>
   </div>
   <div class="post" id="post-215221">
    <div class="subject"><a href="#post-215221">Re: Calling C libraries in gas</a></div>
    <div class="body">I think you&#039;ve found the combination! I don&#039;t know how I missed that in all the things I&#039;ve tried, but I did.<br /><br />Your posted output ends at &quot;Cache-control: private&quot;. Right after that is the text we&#039;re looking for: &quot;my&quot; IP. I don&#039;t think you need to read &quot;as many as sent&quot;, but you need to read until &quot;sys_recv&quot; returns zero. At least, I read until &quot;sys_read&quot; returns zero. I haven&#039;t actually implemented it with &quot;sys_recv&quot; so it&#039;ll be a little bit different, but...<br /><br />if %eax is negative, quit with an error<br />if %eax is positive<br />&nbsp; subtract %eax from &quot;bytes to read&quot;<br />&nbsp; &nbsp; &nbsp; if negative, quit - out of buffer space<br />&nbsp; add %eax to buffer position<br />&nbsp; read/recv more<br />if %eax is zero, all done - print it or whatever...<br /><br />It may be a regular thing to read/recv once, up to &quot;Cache-control: private&quot;, and the second read/recv is the &quot;text we want&quot;... or maybe that&#039;s coincidence? I haven&#039;t tested it much. Since they ask you to not hit it more often than every five minutes, I don&#039;t want to pound on it too much. Have a cup of that good Italian coffee between trials, or something. I think you&#039;ve got it! Congratulations!<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2011-10-14 16:32:45 by fbkotler</div>
   </div>
   <div class="post" id="post-215222">
    <div class="subject"><a href="#post-215222">Re: Calling C libraries in gas</a></div>
    <div class="body">The Cache-Control reply header is used by both Proxy servers and your browser to determine the length of time that a page is valid.&nbsp; It helps reduce network congestion by having the Proxy maintain a local copy of the page which it can subsequently serve up to the specified length of time.&nbsp; It may also be used by a browser to reduce the number of server requests such that the browser does not have to resend the request for that particular resource again.<br />FYI: If not evident by my prior posts, then yes, I&#039;ve spent many years writing commercial http and https apps, mostly in C/C++ but assembly is so underground that it appeals to me! :)<br /></div>
    <div class="meta">Posted on 2011-10-14 19:44:31 by p1ranha</div>
   </div>
   <div class="post" id="post-215223">
    <div class="subject"><a href="#post-215223">Re: Calling C libraries in gas</a></div>
    <div class="body">Also, just a quick note:&nbsp; The User-Agent request header may be used by the server to determine the capabilities of the browser, and thus the returned response code and content based upon it may vary.&nbsp; For example, not specifying a Windows Internet Exporer or Mozilla compatible browser may not give you the identical results.&nbsp; This is something to consider when attempting various requests...<br />Most developers I know capture the request/reply communications ( using WireShark or tcpdump for example ) and emulate the browser of choice...</div>
    <div class="meta">Posted on 2011-10-14 20:01:14 by p1ranha</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=30688&amp;page=1" style="">&laquo;</a><a href="../?id=30688&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="30688" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>  </div>
 </body>
</html>