<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Calling C libraries in gas - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=30688" />
    <link rel="next" href="../?id=30688&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=30688">Calling C libraries in gas</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=30688&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=30688&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="30688" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=30688&amp;page=2">&gt;</a><a href="../?id=30688&amp;page=2">&raquo;</a></form>   <div class="post" id="post-215106">
    <div class="subject"><a href="#post-215106">Calling C libraries in gas</a></div>
    <div class="body">Hi guys, how r u? I need your help. I am trying to write a program in gnu assembler in which I need to use the &quot;wget&quot; function.&nbsp; I think that its library in c language is: #include &lt;stdio.h&gt;, so I tried this in my code: <br /><pre><code><br />.include stdio.h<br />.section .data<br />.section .text<br />.globl _start<br />_start:<br />&nbsp; &nbsp; &nbsp; call wget<br />&nbsp; &nbsp; &nbsp;  movl $1, %eax<br />&nbsp; &nbsp; &nbsp; movl $0, %ebx<br />int $0x80<br /></code></pre><br />obviously, it returns to me this error<br /><br /><em>iplog.s: Assembler messages:<br />iplog.s:1: Error: missing string</em></span><br /><br />Any ideas? <br />thanks in advance!</div>
    <div class="meta">Posted on 2011-09-29 15:08:24 by massem</div>
   </div>
   <div class="post" id="post-215107">
    <div class="subject"><a href="#post-215107">Re: Calling C libraries in gas</a></div>
    <div class="body">wget is a linux program that you can execute from the shell.&nbsp; Are you trying to call it from your source???</div>
    <div class="meta">Posted on 2011-09-29 18:34:59 by p1ranha</div>
   </div>
   <div class="post" id="post-215108">
    <div class="subject"><a href="#post-215108">Re: Calling C libraries in gas</a></div>
    <div class="body">Hi Marce,<br /><br />I don&#039;t think wget is a &quot;function&quot; in a C library that you could &quot;call&quot; like that. I could be wrong. As P1ranha says, it&#039;s an executable. You could execute it from your program with sys_execve. That doesn&#039;t return, so if you wanted to have your program keep running after wget exited, you&#039;d have to sys_fork first, and then execve wget in the &quot;child&quot;. Probably better off to execve bash (or other shell), giving wget on the command line to bash. The C library provides system() that would do that.<br /><br />Or you could &quot;do it yourself&quot; with socket(), connect(), send(), revc(), etc. If you want to do that with sys_calls, there&#039;s only one - sys_socketcall - and the various &quot;commands&quot; go in %ebx (pointer to an arguments structure in %ecx)...<br /><br />You can get rid of the immediate &quot;missing string&quot; error by putting quotes around &quot;stdio.h&quot;... but then it&#039;s &quot;not found&quot;. There are several versions of &quot;stdio.h&quot;. &quot;/usr/include/stdio.h&quot; is apparently not the right one, as it generates a whole pantload of errors. I haven&#039;t tried anything beyond that, &#039;cause I&#039;m not sure that &quot;stdio.h&quot; is what you want anyway...<br /><br />I do have a &quot;wget-like&quot; program, written by Nathan Baker, using P1ranha&#039;s NASMX package(!). It is for Windows, and uses Windows APIs, but I&#039;ve got a &quot;fakeapi.asm&quot; which I assemble to &quot;fakeapi.o&quot; and link against Nathan&#039;s Windows program, allowing it to run in Linux. Pretty cool... as far as it goes. I don&#039;t have a &quot;sys_calls only&quot; equivalent to gethostbyname(), so the IP has to be hard-coded in... which limits its usefulness considerably! :(<br /><br />There&#039;s a &quot;wget&quot; in Konstantin&#039;s &quot;asmutils&quot; package, too. None of this is in (G)as syntax, but could be &quot;translated&quot; without &quot;too&quot; much trouble.<br /><br />Easiest thing might be to run &quot;wget&quot; from the command line, and then process the resulting file(s) with your asm program. Depends on what you&#039;re trying to do...<br /><br />In the more general case of calling C libraries from (G)as... we might be able to come up with an example...<br /><br />Glad to see you&#039;re still doing assembly language!<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2011-09-30 08:02:50 by fbkotler</div>
   </div>
   <div class="post" id="post-215111">
    <div class="subject"><a href="#post-215111">Re: Calling C libraries in gas</a></div>
    <div class="body">Frank, first of all, i&#039;m not doing assembly language, I am struggling with it! But, to be honest, I love it! it&#039;s so hard that I love it! it&#039;s so low level that I love it. I know it does not have any sense haah. <br />My idea of learning this language is developing several little programs. This one has the objective of checking computer&#039;s ip in www.whatismyip.com and save the new ip in some file called &quot;iplog&quot;. It would be like carrying out an&nbsp; &quot;ip log&quot;.<br />Well, your answer was very complete and now you cleared me up the idea. What do you think if I try to solve that with sockets...? Will be very difficult? I have developed socket with c once, but I think I have to revise the theory. You named &quot;sys_socketcall &quot;.. is there any documentation that you can recommend me? (meanwhile I&#039;m searching on the Internet).<br />About the other suggestions, I am trying to learn GnuAssembler in Linux obviously.<br />well, thank you so much for your answer, <br />thank P1ranha as well ! <br /><br />Best, <br />Marce<br /></div>
    <div class="meta">Posted on 2011-09-30 13:20:22 by massem</div>
   </div>
   <div class="post" id="post-215113">
    <div class="subject"><a href="#post-215113">Re: Calling C libraries in gas</a></div>
    <div class="body">Ahhh... documentation... For an overview of what we&#039;re trying to do, &quot;Beej&#039;s Guide to Network Programming&quot; is good...<br /><br />http://beej.us/guide/bgnet/<br /><br />... not really directed at assembly language...<br /><br />To get more specific, you could do &quot;man 2 socketcall&quot;. That doesn&#039;t really tell us much. &quot;man 2 socket&quot;, man 2 connect&quot;, etc. give more information. Not really aimed at asm either, of course...<br /><br />I&#039;m still at the earliest stages of figuring out what we want to do. If I use the &quot;regular wget&quot;:<br /><pre><code><br />wget www.whatsmyip.com<br /></code></pre><br />I end up with &quot;index.html&quot;, which includes the IP we&#039;re looking for... and a lot of other stuff which isn&#039;t really helpful. Their page mentions another page for &quot;automation&quot;:<br />http://automation.whatismyip.com/n09230945.asp<br />When I try &quot;wget&quot; on that, I get &quot;ERROR 403: Forbidden&quot;. If I just &quot;click on it&quot;, I get my IP without any surrounding cruft. I think that page may be &quot;interesting&quot;, but I&#039;m not sure how we want to use it...<br /><br />The general idea, I think, will be sys_socket (or socket() if you like C libraries), sys_connect (or connect()). At this point, we&#039;ll need to know the IP for whatismyip.com or their automation page. gethostbyname() should do it. What I usually do is &quot;ping thename&quot; and copy down the &quot;dotted quad&quot; that it tells me. :) The actual parameter&nbsp; wants to be bigendian(!). Then we may need to send something - sys_socketcall with &quot;send&quot; as an argument, or just sys_write will work. Or maybe, if we hit that &quot;automation&quot; page, it&#039;ll send what we want without asking (we should be so lucky), and we can just &quot;recv&quot; (sys_socketcall with &quot;recv&quot; in ebx) or sys_read... Have to try it to see what happens...<br /><br />I haven&#039;t written any code yet. If I can stay &quot;focused&quot;, I will. I&#039;ll be doing it in Nasm, probably - first, to get it working, at least. Then I&#039;ll &quot;translate&quot; to (G)as - &quot;objdump -d myprog&quot; presents AT&amp;T syntax, which will help...<br /><br />I don&#039;t think it&#039;ll be too difficult, but I&#039;m short of ambition lately (I&#039;ve always been short of ambition, but it&#039;s getting worse!), so don&#039;t wait for me! Try out anything you can think of!<br /><br />Later,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2011-10-01 07:20:12 by fbkotler</div>
   </div>
   <div class="post" id="post-215116">
    <div class="subject"><a href="#post-215116">Re: Calling C libraries in gas</a></div>
    <div class="body">Frank, thank you for the documentation!!!<br />Regarding to: <br /><div class="quote">I end up with &quot;index.html&quot;, which includes the IP we&#039;re looking for... and a lot of other stuff which isn&#039;t really helpful. Their page mentions another page for &quot;automation&quot;:<br />http://automation.whatismyip.com/n09230945.asp</div><br />yes I knew that! I realised yesterday haha<br /><div class="quote">The general idea, I think, will be sys_socket (or socket() if you like C libraries), sys_connect (or connect())</div><br />I did that, without libraries and with syscalls&nbsp; :)<br /><br /><pre><code><br /> movl $2,(%esp) #af_inet<br /> movl $1,4(%esp) #sock-stream<br /> movl $6,8(%esp) #ipprotocp<br /> movl $102,%eax #socketcall<br /> movl $1,%ebx&nbsp;  #socketcall_socket<br /> movl %esp,%ecx<br /> int&nbsp; $0x80<br /></code></pre> <br />Now, I&#039;m trying to figure out the &quot;connect&quot; function.&nbsp; We have int sys_connect(int fd, struct sockaddr *uservaddr, int addrlen). I have to &quot;translate&quot; the parameters&nbsp; into assembly.... (a challenge for me). After this, I&#039;m going to follow your recommendations:<br /><div class="quote">gethostbyname() should do it. What I usually do is &quot;ping thename&quot; and copy down the &quot;dotted quad&quot; that it tells me. :) The actual parameter&nbsp; wants to be bigendian(!). Then we may need to send something - sys_socketcall with &quot;send&quot; as an argument, or just sys_write will work. Or maybe, if we hit that &quot;automation&quot; page, it&#039;ll send what we want without asking (we should be so lucky), and we can just &quot;recv&quot; (sys_socketcall with &quot;recv&quot; in ebx) or sys_read... Have to try it to see what happens...</div><br /><br />Thank u so much!!!!! ;) <br /><br />p.s: I&#039;m reading <em>tcp/ip sockets in c second edition practical guide for programmers</em> by Morgan Kaufman<br /></div>
    <div class="meta">Posted on 2011-10-01 18:47:39 by massem</div>
   </div>
   <div class="post" id="post-215117">
    <div class="subject"><a href="#post-215117">Re: Calling C libraries in gas</a></div>
    <div class="body">Good start! I&#039;ve got something similar - I&#039;ve got 0 where you&#039;ve got 6 - IPv4 vs IPv6, I suspect(?). Trying a similar idea with &quot;connect&quot; - arguments on the stack. I&#039;m getting a plausible descriptor from &quot;socket&quot; and 0 from &quot;connect&quot;, but &quot;broken pipe&quot; if I try to read/write. Just woke up from a nap realizing, &quot;Wait a minute, &#039;port 80&#039; is decimal!&quot; I&#039;ve been using 80 hex. :( Duh!<br /><br />I really may have to RTFM on this. (it puts me to sleep, but if I can&#039;t stay awake anyway, might as well...) :)<br /><br />Coffee first, then I&#039;ll get back into it...<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2011-10-02 00:09:17 by fbkotler</div>
   </div>
   <div class="post" id="post-215118">
    <div class="subject"><a href="#post-215118">Re: Calling C libraries in gas</a></div>
    <div class="body">Hi Frank, yes I&#039;ve got 6,&nbsp; I&#039;m using IPv4.&nbsp; I have searched on the Internet some examples about &quot;connect&quot; function and I have some doubts.&nbsp; This is the code:<br /><br /><pre><code><br /> movl $102 %eax&nbsp; #socketcall<br /> movw $2, 12(%esp) #af_inet<br /> movw $80, 14(%esp) #port<br /> movl $0x48e959c7, 16(%esp) # ip<br /> movl %eax, (%esp) #fd<br />...<br />..<br /></code></pre><br />The questions are:<br />why do we move only a <strong>word</strong> in af_inet and port? I remember that in &quot;socketcall function&quot; I did that:<br /><pre><code><br />&nbsp; movl $2,(%esp) #af_inet<br /></code></pre><br />I moved a double word. I would like to understand in which occasion do we have to send 32 bits or&nbsp; 16 bits.<br /><br />Besides I really don&#039;t know how can I calculate the size of the sock address. In the example I could see that<br /><pre><code><br />leal&nbsp; &nbsp; 12(%esp),%ebx<br />movl&nbsp; &nbsp; %ebx,0x4(%esp)<br /></code></pre><br />I follow the code to understand what it was looking for in 12(%esp).<br /><pre><code><br /> movw $2, 12(%esp)#af_inet<br /> </code></pre><br />It was looking for the af_inet. So, I concluded that it calculates the size through the address family, IPv4.&nbsp; However, I don&#039;t think that this represents the size&nbsp; the sock address at all.<br />what&#039;s your opinion?<br />Thanx in advance! <br />try italian coffee! ;) it&#039;s the best<br /></div>
    <div class="meta">Posted on 2011-10-02 19:13:17 by massem</div>
   </div>
   <div class="post" id="post-215119">
    <div class="subject"><a href="#post-215119">Re: Calling C libraries in gas</a></div>
    <div class="body">I should have had the Italian coffee! Instant with a bit of cocoa-mix, a spinkle of cinnamon, hot water from the tap, is quick, but didn&#039;t seem to do the trick. Changing &quot;port&quot; to 80 decimal didn&#039;t help. What I actually did was:<br /><pre><code><br />push 25000h<br /></code></pre><br />Supposed to be a word af_inet and a word (big-endian) port. Still got &quot;broken pipe&quot;. So I backed up to something a little less &quot;minimal&quot; and used a static structure...<br /><pre><code><br />struc sockaddr_in<br />&nbsp; &nbsp; .sin_family resw 1<br />&nbsp; &nbsp; .sin_port resw 1<br />&nbsp; &nbsp; .sin_addr resd 1<br />&nbsp; &nbsp; .sin_zero resb 8<br />endstruc<br /></code></pre><br />That&#039;s Nasm syntax, but I think you can see that &quot;family&quot; and &quot;port&quot; are words... and then there&#039;s some padding at the end, which makes the &quot;size&quot; 16 bytes. I think that&#039;s what we want to pass to &quot;connect&quot;. It&#039;s supposed to be (the &quot;original&quot; structure) in &quot;sys/socket.h&quot; (which includes &quot;bits/socket.h&quot;) but I can&#039;t find anything just like that...<br /><br />I didn&#039;t actually use the Nasm &quot;struc&quot;, since I don&#039;t know how to translate it to (G)as. Here&#039;s my code, so far. Note that this DOES NOT WORK:<br /><pre><code><br />global _start<br /><br />; Convert numbers (constants!) to network byte order<br />%define hton(x) ((x &amp; 0xFF000000) &gt;&gt; 24) | ((x &amp; 0x00FF0000) &gt;&gt;&nbsp; 8) | ((x &amp; 0x0000FF00) &lt;&lt;&nbsp; 8) | ((x &amp; 0x000000FF) &lt;&lt; 24)<br />%define htons(x) ((x &gt;&gt; 8) &amp; 0xFF) | ((x &amp; 0xFF) &lt;&lt; 8)<br /><br /><br />section .data<br />&nbsp; &nbsp; iptext db &quot;72.233.89.198&quot;, 0 ; www.whatismyip.com<br />;&nbsp; &nbsp; iptext db &quot;198.89.233.72&quot;, 0 ; automation.whatismyip.com<br />&nbsp; &nbsp; iplittle dd 48E959C6h<br />&nbsp; &nbsp; ipbig dd 0C659E948h<br />;&nbsp; &nbsp; ipbig dd 48E959C6h<br /><br />; copied from Nathan&#039;s (working) program<br />&nbsp; &nbsp; msg db&quot;GET /index.html HTTP/1.1&quot;, 13, 10<br />&nbsp; &nbsp; &nbsp; &nbsp; db &quot;Host: www.whatismyip.com&quot;, 13, 10<br />	db &quot;Connection: close&quot;, 13, 10<br />	db &quot;User-Agent: assembly language&quot;, 13, 10<br />&nbsp; &nbsp; msg_len equ $ - msg<br /><br />sa:<br />&nbsp; &nbsp; dw 2 ; family<br />&nbsp; &nbsp; dw htons (80) ; port (big endian)<br />&nbsp; &nbsp; dd 0C659E948h ; address (big-endian)<br />&nbsp; &nbsp; dd 0, 0 ; zero<br />sa_size equ $ - sa<br /><br />; first of these wants to be socket descriptor<br />; we fill it in later...<br />connect_args dd 0, sa, sa_size<br /><br />section .bss<br />%define BUFSIZ 80h<br />&nbsp; &nbsp; buf resb BUFSIZ<br />&nbsp; &nbsp; sock_fd resd 1<br /><br />section .text<br />_start:<br />&nbsp; &nbsp; nop<br />; socket<br />&nbsp; &nbsp; push 0<br />&nbsp; &nbsp; push 1<br />&nbsp; &nbsp; push 2<br />&nbsp; &nbsp; mov ecx, esp<br />&nbsp; &nbsp; mov ebx, 1<br />&nbsp; &nbsp; mov eax, 102<br />&nbsp; &nbsp; int 80h<br />&nbsp; &nbsp; add esp, 12<br />&nbsp; &nbsp; test eax, eax<br />&nbsp; &nbsp; js exit<br />&nbsp; &nbsp; mov , eax<br />&nbsp; &nbsp; mov , eax<br />&nbsp; &nbsp; <br />; connect<br />&nbsp; &nbsp; mov ecx, connect_args<br />&nbsp; &nbsp; mov ebx, 3 ; connect<br />&nbsp; &nbsp; mov eax, 102<br />&nbsp; &nbsp; int 80h<br />&nbsp; &nbsp; add esp, 28<br />&nbsp; &nbsp; test eax, eax<br />&nbsp; &nbsp; js exit<br /><br />; write<br />&nbsp; &nbsp; mov edx, msg_len<br />&nbsp; &nbsp; mov ecx, msg<br />&nbsp; &nbsp; mov ebx, <br />&nbsp; &nbsp; mov eax, 4<br />&nbsp; &nbsp; int 80h<br />&nbsp; &nbsp; test eax, eax<br />&nbsp; &nbsp; js exit<br /><br />; read<br />&nbsp; &nbsp; mov edx, BUFSIZ<br />&nbsp; &nbsp; mov ecx, buf<br />&nbsp; &nbsp; mov ebx, <br />&nbsp; &nbsp; mov eax, 3<br />&nbsp; &nbsp; int 80h<br />&nbsp; &nbsp; test eax, eax<br />&nbsp; &nbsp; js exit<br /><br />; write to stdout<br />&nbsp; &nbsp; mov edx, eax ; length from read<br />&nbsp; &nbsp; mov ecx, buf<br />&nbsp; &nbsp; mov ebx, 1<br />&nbsp; &nbsp; mov eax, 4<br />&nbsp; &nbsp; int 80h<br />&nbsp; &nbsp; <br />exit:<br />&nbsp; &nbsp; mov ebx, eax<br />&nbsp; &nbsp; test ebx, ebx<br />&nbsp; &nbsp; jns goodexit<br />&nbsp; &nbsp; neg ebx<br />goodexit:<br />&nbsp; &nbsp; mov eax, 1<br />&nbsp; &nbsp; int 80h<br /></code></pre><br /><br />That gets me as far as writing the &quot;GET&quot; message (apparently successfully(?), but the &quot;read&quot; doesn&#039;t read anything, just hangs there. Apparently I said something to offend the server...<br /><br />I don&#039;t know what to try next. RTFM, if all else fails, I guess... :)<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2011-10-02 23:07:50 by fbkotler</div>
   </div>
   <div class="post" id="post-215122">
    <div class="subject"><a href="#post-215122">Re: Calling C libraries in gas</a></div>
    <div class="body">Copied incorrectly(!) from Nathan&#039;s code...<br /><pre><code><br />&nbsp; msg db&quot;GET /index.html HTTP/1.1&quot;, 13, 10<br /></code></pre><br />Supposed to be a space between &quot;HTTP&quot; and &quot;/&quot;. This gets me to &quot;Bad Request&quot;. Progress, of a sort...<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2011-10-03 05:14:41 by fbkotler</div>
   </div>
   <div class="post" id="post-215139">
    <div class="subject"><a href="#post-215139">Re: Calling C libraries in gas</a></div>
    <div class="body">Hi Frank, I understood everything but in connect() function something seems to be wrong. In eax register i found 0xffffff2. An error. And I don&#039;t know what&nbsp; it means.<br /><br /><pre><code><br />.section .data<br />ErrorMsg: .asciz&quot;socket() failed\n&quot;<br />.section .text<br />.globl _start<br />_start:<br />&nbsp; &nbsp; &nbsp;  #Creating a reliable, stream socket&nbsp; TCP<br />&nbsp; &nbsp; &nbsp;  #parameters<br />&nbsp; &nbsp; &nbsp; &nbsp; movl $2, (%esp) #af_inet<br />&nbsp; &nbsp; &nbsp; &nbsp; movl $1, 4(%esp) #sock-stream<br />&nbsp; &nbsp; &nbsp; &nbsp; movl $6, 8(%esp) #ipprotocp<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; movl $102,%eax #socketcall<br />&nbsp; &nbsp; &nbsp; &nbsp; movl $1,%ebx&nbsp;  #socketcall_socket<br />&nbsp; &nbsp; &nbsp; &nbsp; movl %esp,%ecx #A pointer to the syscall args is stored in %ecx.<br />&nbsp; &nbsp; &nbsp; &nbsp; int&nbsp; $0x80<br />&nbsp; &nbsp; &nbsp; &nbsp; cmpl $0, %eax<br />&nbsp; &nbsp; &nbsp; &nbsp; jl error<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; #Establish a connection to the server<br />&nbsp; &nbsp; &nbsp; &nbsp; # int fd, struct sockaddr *uservaddr, int addrlen&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;  movl&nbsp; %eax, (%esp)&nbsp; #fd<br />&nbsp; &nbsp; &nbsp; &nbsp;  movw $2, 12(%esp) #af_inet<br />&nbsp; &nbsp; &nbsp; &nbsp; movw $80, 14(%esp) #port<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $48E959C6, 16(%esp) # ip 72.233.89.198 whatismyip<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl&nbsp; &nbsp; $16,8(%esp)&nbsp; # size<br />	&nbsp;  movl&nbsp; &nbsp; $102,%eax&nbsp; &nbsp; &nbsp; #socketcall<br />	 movl&nbsp; &nbsp; $3, %ebx&nbsp; &nbsp; #socketcall_connect<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl %esp, %ecx pointer to the syscall args is stored in %ecx.<br />&nbsp; &nbsp; &nbsp; &nbsp;  int&nbsp; &nbsp; $0x80<br />&nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; cmpl $0, %eax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jl error<br /> <br />&nbsp; &nbsp; &nbsp; &nbsp;  jmp endprogram<br />error:&nbsp;  pushl $ErrorMsg<br />&nbsp; &nbsp; &nbsp; &nbsp;  call printf<br />&nbsp; &nbsp; &nbsp; &nbsp;  jmp&nbsp; endprogram<br /><br />endprogram:&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; movl $1, %eax<br /> 	movl $0, %ebx<br /> 	int $0x80 <br /><br /></code></pre><br /><br />Debugging I could see that in %eax register there is a&nbsp; 0xffffff2 number. It&#039;s a negative number, hence there is a problem.&nbsp; <br />I searched on the Internet what&nbsp; it could be, I did not get nothing.<br />ANY IDEAS?<br />Thanx in advance<br /><br /></div>
    <div class="meta">Posted on 2011-10-06 15:01:38 by massem</div>
   </div>
   <div class="post" id="post-215140">
    <div class="subject"><a href="#post-215140">Re: Calling C libraries in gas</a></div>
    <div class="body">I&#039;m fast running out of ideas!<br /><br />0xfffffff2, according to my half-fast arithmetic, should be -EFAULT (&quot;bad address&quot;). These parameters to &quot;connect&quot; are confusing! We want the address (and length) of this &quot;sockaddr&quot; structure... as a part of the &quot;parameter structure&quot; we put in %ecx. I made the following changes to your code, in order to attempt to do this...<br /><pre><code><br />.section .data<br />ErrorMsg: .asciz&quot;socket() failed\n&quot;<br />.section .text<br />.globl _start<br />_start:<br />&nbsp; &nbsp; &nbsp;  #Creating a reliable, stream socket&nbsp; TCP<br />&nbsp; &nbsp; &nbsp;  #parameters<br />&nbsp; &nbsp; &nbsp; &nbsp; movl $2, (%esp) #af_inet<br />&nbsp; &nbsp; &nbsp; &nbsp; movl $1, 4(%esp) #sock-stream<br /><br /># no help either way, here!<br />#&nbsp; &nbsp; &nbsp; &nbsp; movl $6, 8(%esp) #ipprotocp<br />&nbsp; &nbsp; &nbsp; &nbsp; movl $0, 8(%esp) #ipprotocp<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; movl $102,%eax #socketcall<br />&nbsp; &nbsp; &nbsp; &nbsp; movl $1,%ebx&nbsp;  #socketcall_socket<br />&nbsp; &nbsp; &nbsp; &nbsp; movl %esp,%ecx #A pointer to the syscall args is stored in %ecx.<br />&nbsp; &nbsp; &nbsp; &nbsp; int&nbsp; $0x80<br />&nbsp; &nbsp; &nbsp; &nbsp; cmpl $0, %eax<br />&nbsp; &nbsp; &nbsp; &nbsp; jl error<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; #Establish a connection to the server<br />&nbsp; &nbsp; &nbsp; &nbsp; # int fd, struct sockaddr *uservaddr, int addrlen&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;  movl&nbsp; %eax, (%esp)&nbsp; #fd<br />&nbsp; &nbsp; &nbsp; &nbsp;  movw $2, 12(%esp) #af_inet<br /># attempt to do 80, big-endian<br />&nbsp; &nbsp; &nbsp; &nbsp; movw $0x5000, 14(%esp) #port<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl $0x48E959C6, 16(%esp) # ip 72.233.89.198 whatismyip<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl&nbsp; &nbsp; $16,8(%esp)&nbsp; # size<br />	 leal 8(%esp), %ecx # &lt;-- addr of sockaddr<br />	 movl %ecx, 4(%esp) # &lt;--<br />	&nbsp;  movl&nbsp; &nbsp; $102,%eax&nbsp; &nbsp; &nbsp; #socketcall<br />	 movl&nbsp; &nbsp; $3, %ebx&nbsp; &nbsp; #socketcall_connect<br />&nbsp; &nbsp; &nbsp; &nbsp;  movl %esp, %ecx # pointer to the syscall args is stored in %ecx.<br />&nbsp; &nbsp; &nbsp; &nbsp;  int&nbsp; &nbsp; $0x80<br />&nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; cmpl $0, %eax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jl error<br /> <br />&nbsp; &nbsp; &nbsp; &nbsp;  jmp endprogram<br />error:&nbsp;  pushl $ErrorMsg<br />&nbsp; &nbsp; &nbsp; &nbsp;  call printf<br />&nbsp; &nbsp; &nbsp; &nbsp;  jmp&nbsp; endprogram<br /><br />endprogram:&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; movl $1, %eax<br /> 	movl $0, %ebx<br /> 	int $0x80 <br /></code></pre><br />This changes the error return (in %eax) to 0xffffff9f, which I decrypt as -97 or -EAFNOSUPPORT - &quot;address family not supported by protocol&quot;.<br /><br />I was getting this same error from my code when I was attempting to put all the parameters (the &quot;sockaddr&quot; structure, and the pointer/size to it... plus the fd) on the stack. When I changed this to a &quot;static&quot; sockaddr structure (as shown in the last code I posted above... in Nasm syntax), &quot;connect&quot; returned zero, as I understand it&#039;s supposed to do. However, when I attempted to &quot;write&quot; a &quot;request&quot; and &quot;read&quot; back the reply, either the &quot;read&quot; hangs and doesn&#039;t get anything, or if I change the &quot;request&quot; I&#039;m writing I &quot;read&quot; back &quot;ERROR 400: Bad Request...&quot;.<br /><br />My &quot;request&quot;:<br /><pre><code><br />&nbsp; &nbsp; msg db&quot;GET /index.html HTTP/1.1&quot;, 13, 10<br />&nbsp; &nbsp; &nbsp; &nbsp; db &quot;Host: www.whatismyip.com&quot;, 13, 10<br />	db &quot;Connection: close&quot;, 13, 10<br />	db &quot;User-Agent: assembly language&quot;, 13, 10<br />&nbsp; &nbsp; msg_len equ $ - msg<br /></code></pre><br /><br />As nearly as I can get from the RFC (2616? I forget the number), there isn&#039;t supposed to be a space in &quot;HTTP(space?)/1.1&quot;. Without the space, the &quot;read&quot; hangs, and with the space, &quot;bad request&quot;. Dunno what to try next.<br /><br />I have some code which attempts to put those negative numbers into text (just the comments in errno.h). Sort of like &quot;perror()&quot;? I just cut-and-paste it into my code. I should attempt to assemble it into a freestanding .o file which could be linked with... your code, my code, anything. Haven&#039;t done so yet. It might help you with error returns from &quot;connect&quot;, but it isn&#039;t any help with &quot;bad request&quot;!<br /><br />I use it in a macro:<br /><pre><code><br />int 80h<br />checkerror &quot;we are here&quot;, exit<br /></code></pre><br />Where, if there&#039;s an error, it prints the text &quot;we are here&quot;, then the text from errno.h and jumps to the second parameter - could be &quot;retry&quot; or something instead of &quot;exit&quot;...<br /><br />I think this code has &quot;promise&quot;, but it isn&#039;t really &quot;finished&quot; yet. I&#039;ll try to post it, in some form, soon(ish). It will/would be a PITA to translate to AT&amp;T syntax, so might not be much help to you.<br /><br />Other than that... no, I don&#039;t have any ideas...<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2011-10-06 17:04:15 by fbkotler</div>
   </div>
   <div class="post" id="post-215143">
    <div class="subject"><a href="#post-215143">Re: Calling C libraries in gas</a></div>
    <div class="body">See if this will work for you...<br /><br />In Nasm, we&#039;d have to declare &quot;extern report_error&quot;, but Gas seems to assume that, so just call it.<br /><pre><code><br />as -o iplog2.o iplog2.s<br />ld -o iplog2 iplog2.o rpterror.o<br /></code></pre><br />Since we&#039;re not calling printf anymore, the rest of the &quot;ld cruft&quot; is no longer required! Ain&#039;t that nice? :)<br /><br />If it doesn&#039;t work, give a holler and we&#039;ll see if we can sort it out. (warning: unzips to current directory)<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=3341" target="_blank">rpterror.zip</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2011-10-06 17:45:51 by fbkotler</div>
   </div>
   <div class="post" id="post-215145">
    <div class="subject"><a href="#post-215145">Re: Calling C libraries in gas</a></div>
    <div class="body">The following C code shows how to set up sockaddr prior to successfully calling connect():<br /><pre><code><br />&nbsp; struct sockaddr_in sockAddr;&nbsp; /* socket address structure */<br /><br />&nbsp; sockAddr.sin_family = AF_INET;<br />&nbsp; sockAddr.sin_port = htons(nProtocolPort);<br />&nbsp; sockAddr.sin_addr.s_addr = inet_addr(szHost);<br /></code></pre><br /><br />They key piece is the htons() macro which converts host endianess to network endianess.&nbsp; If you&#039;re writing an app on a PC the host endianess is little endian.&nbsp; Network endian is big endian.<br /><br />Also, this is the correct command: GET /index.html HTTP/1.1<br /><br /></div>
    <div class="meta">Posted on 2011-10-06 20:46:25 by p1ranha</div>
   </div>
   <div class="post" id="post-215146">
    <div class="subject"><a href="#post-215146">Re: Calling C libraries in gas</a></div>
    <div class="body">Well... it&#039;s a million miles from &quot;calling C libraries in Gas&quot;, but here&#039;s a NASMX program that works...<br /><br /><pre><code><br />; wget-like thingy<br />; author: Nathan Baker<br />; written for Windows<br />; modified for Linux, too: fbk<br />;<br />; nasm -f win32 nbget -i path to NASMX\<br />; link &quot;as usual&quot;<br />;<br />; for Linux<br />; nasm -f elf nbget.asm -i path to NASMX/<br />; nasm -f elf fakeapi.asm<br />; ld -o get nbget.o get4lin.o -e main<br /><br />; swap backslashes to slashes<br />; I *think* Windows will accept slashes, too(?)<br /><br />%ifidni __OUTPUT_FORMAT__, elf<br />%include &#039;/inc/nasmx.inc&#039;<br />%include &#039;/inc/win32/windows.inc&#039;<br />%include &#039;/inc/win32/kernel32.inc&#039;<br />%include &#039;/inc/win32/user32.inc&#039;<br />%include &#039;/inc/win32/wsock32.inc&#039;<br /><br />%else<br />%include &#039;inc\nasmx.inc&#039;<br />%include &#039;inc\win32\windows.inc&#039;<br />%include &#039;inc\win32\kernel32.inc&#039;<br />%include &#039;inc\win32\user32.inc&#039;<br />%include &#039;inc\win32\wsock32.inc&#039;<br />%endif<br /><br />entry&nbsp; &nbsp; demo1<br /><br />; Convert numbers (constants!) to network byte order<br />%define hton(x) ((x &amp; 0xFF000000) &gt;&gt; 24) | ((x &amp; 0x00FF0000) &gt;&gt;&nbsp; 8) | ((x &amp; 0x0000FF00) &lt;&lt;&nbsp; 8) | ((x &amp; 0x000000FF) &lt;&lt; 24)<br />%define htons(x) ((x &gt;&gt; 8) &amp; 0xFF) | ((x &amp; 0xFF) &lt;&lt; 8)<br /><br />; Nathan&#039;s server<br />;&nbsp; &nbsp; urltext db &quot;75.126.1.55&quot;, 0<br />_popip equ 4B7E0137h<br /><br />POPIP equ hton(_popip)<br />POPPORT equ htons(80)<br />BUFFSIZE equ 4096<br /><br />section .bss<br />&nbsp; &nbsp; wsadata resb 398<br />&nbsp; &nbsp; hsock resd 1<br />&nbsp; &nbsp; resp resb BUFFSIZE<br />&nbsp; &nbsp; numb resd 1<br />&nbsp; &nbsp; remain resd 1<br />&nbsp; &nbsp; realsize resd 1<br /><br />section .data<br />pop_sa istruc sockaddr_in<br />&nbsp; &nbsp; at sockaddr_in.sin_family, dw 2<br />&nbsp; &nbsp; at sockaddr_in.sin_port, dw POPPORT<br />&nbsp; &nbsp; at sockaddr_in.sin_addr, dd POPIP<br />&nbsp; &nbsp; at sockaddr_in.sin_zero, dd 0, 0<br />iend<br /><br />msg db &quot;GET / HTTP/1.1&quot;, 13, 10<br />&nbsp; &nbsp; db &quot;Host: clax.inspiretomorrow.net&quot; ,13 ,10<br />&nbsp; &nbsp; db &quot;Connection: close&quot;, 13, 10<br />&nbsp; &nbsp; db &quot;User-Agent: ASM&quot;, 13, 10, 13, 10<br />msg_len equ $ - msg<br /><br /><br />proc&nbsp; &nbsp;  demo1<br />	xor eax, eax<br />	mov , eax<br />	invoke	WSAStartup, 0x101, wsadata<br />	invoke	socket,	dword 2, dword 1, dword 0<br />	mov , eax<br />	invoke	connect, eax, pop_sa, 16<br />	invoke	send, , msg, msg_len, 0<br />	mov ecx, BUFFSIZE<br />	mov , ecx<br />	mov ebx, resp<br />back:<br />	invoke	recv, , ebx, , 0<br />	cmp eax, 0<br />	jz cont<br />	mov ebx, resp<br />	add ebx, eax<br />	add , eax<br />	sub , eax<br />	jmp back<br />cont:	<br />	invoke	closesocket, <br />	invoke	WSACleanup<br />	invoke	GetStdHandle, dword -11<br />	invoke	WriteFile, eax, dword resp, , dword numb, 0<br />&nbsp; &nbsp; invoke&nbsp; &nbsp; ExitProcess, dword NULL<br />&nbsp; &nbsp; ret<br /><br />endproc<br /></code></pre><br /><br />Actually, with the latest version of NASMX-1.0rc1, it throws a couple of errors. Works with an earlier version...<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2011-10-07 01:00:39 by fbkotler</div>
   </div>
   <div class="post" id="post-215147">
    <div class="subject"><a href="#post-215147">Re: Calling C libraries in gas</a></div>
    <div class="body">Frank,<br />Please try again with the official NASMX-1.0 release.<br />Let me know if you are successful or what errors you receive and I&#039;ll look into it further.<br />Thank you.<br /></div>
    <div class="meta">Posted on 2011-10-07 06:08:23 by p1ranha</div>
   </div>
   <div class="post" id="post-215150">
    <div class="subject"><a href="#post-215150">Re: Calling C libraries in gas</a></div>
    <div class="body">Hi Rob,<br /><br />line 60 - non-constant argument to TIMES (iend)<br />line 72 - fatal: (INVOKE: 9) missing locals directive (invoke WSAstartup...)<br /><br />Same as rc1, FWIW. I don&#039;t know whether the errors are in the source, or in one of the include files - I suspect the former, the source &quot;looks okay&quot; to me... but I&#039;m not very familiar with NASMX...<br /><br />As I think you know, I prefer &quot;very low level&quot; asm myself, but I think NASMX is a &quot;good idea... if you wanna do it that way&quot;. If I get hit with an unexpected stroke of ambition, I&#039;ll contribute something to the Linux branch.<br /><br />One of these days, I&#039;ve gotta get organized! :)<br /><br />Best,<br />Frank<br /><br />P.S. I suppose I should attach that &quot;fakeapi.asm&quot; in case anyone wants it...<br /><br />P.P.S. This may deserve a new topic, if we&#039;re going to persue it...<br /><br /></div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=3342" target="_blank">fakeapi.asm</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2011-10-07 09:41:06 by fbkotler</div>
   </div>
   <div class="post" id="post-215155">
    <div class="subject"><a href="#post-215155">Re: Calling C libraries in gas</a></div>
    <div class="body">This one&#039;s easy: a <strong>proc</strong> always requires a <strong>locals</strong> macro to immediately follow.<br /><br /><pre><code><br />proc demo1<br />locals none<br />&nbsp;  .<br />&nbsp;  . your code<br />&nbsp;  .<br />endproc<br /></code></pre><br /><br />The <strong>invoke</strong> macro fatals if <strong>locals</strong> is not specified since it&#039;s locals job to ensure the procedure stack frame prologue is set up properly.&nbsp; It has to be done this way as NASMX has to work within the Nasm macro capabilities while accounting for all calling conventions on all supported operating systems.<br /><br /></div>
    <div class="meta">Posted on 2011-10-07 13:00:08 by p1ranha</div>
   </div>
   <div class="post" id="post-215157">
    <div class="subject"><a href="#post-215157">Re: Calling C libraries in gas</a></div>
    <div class="body">Okay, that fixes that one, thanks!<br /><br />I&#039;ve still got a problem with &quot;iend&quot;. I thought to try it with &quot;-f win32&quot; to see if that made any difference. Of course, that (re)enabled backslashes, so it wouldn&#039;t open the include file(s). Commented out that cruft (can you confirm that Windows still copes with slashes?), and another error cropped up. Probably a typo on my part, that one.<br /><br />Any insight into the &quot;iend&quot; problem? As expected, adding the &quot;-e&quot; switch doesn&#039;t help much, but indicates a possible problem at line 358-360 - size_t not (yet) defined(?). I think this is probably an artifact of the &quot;-e&quot; switch only doing one pass(?)...<br /><br />Thanks for your help with this!<br /><br />Best,<br />Frank<br />Here&#039;s the &quot;current&quot; version, just for reference:<br /><pre><code><br />; wget-like thingy<br />; author; Nathan Baker<br />; written for Windows<br />; modified for Linux, too: fbk<br />;<br />; nasm -f win32 nbget -i path to NASMX\<br />; link &quot;as usual&quot;<br />;<br />; for Linux<br />; nasm -f elf nbget.asm -i path to NASMX/<br />; nasm -f elf fakeapi.asm<br />; ld -o get nbget.o get4lin.o -e main<br /><br />; swap backslashes to slashes<br />; I *think* Windows will accept shashes, too(?)<br /><br />; %ifidni __OUTPUT_FORMAT__, elf<br />%include &#039;/inc/nasmx.inc&#039;<br />%include &#039;/inc/win32/windows.inc&#039;<br />%include &#039;/inc/win32/kernel32.inc&#039;<br />%include &#039;/inc/win32/user32.inc&#039;<br />%include &#039;/inc/win32/wsock32.inc&#039;<br /><br />;%else<br />;%include &#039;inc\nasmx.inc&#039;<br />;%include &#039;inc\win32\windows.inc&#039;<br />;%include &#039;inc\win32\kernel32.inc&#039;<br />;%include &#039;inc\win32\user32.inc&#039;<br />;%include &#039;inc\win32\wsock32.inc&#039;<br />;%endif<br /><br />entry&nbsp; &nbsp; demo1<br /><br />; Convert numbers (constants!) to network byte order<br />%define hton(x) ((x &amp; 0xFF000000) &gt;&gt; 24) | ((x &amp; 0x00FF0000) &gt;&gt;&nbsp; 8) | ((x &amp; 0x0000FF00) &lt;&lt;&nbsp; 8) | ((x &amp; 0x000000FF) &lt;&lt; 24)<br />%define htons(x) ((x &gt;&gt; 8) &amp; 0xFF) | ((x &amp; 0xFF) &lt;&lt; 8)<br /><br />; Nathan&#039;s server<br />;&nbsp; &nbsp; urltext db &quot;75.126.1.55&quot;, 0<br />_popip equ 4B7E0137h<br /><br />POPIP equ hton(_popip)<br />POPPORT equ htons(80)<br />BUFFSIZE equ 4096<br /><br />section .bss<br />&nbsp; &nbsp; wsadata resb 398<br />&nbsp; &nbsp; hsock resd 1<br />&nbsp; &nbsp; resp resb BUFFSIZE<br />&nbsp; &nbsp; numb resd 1<br />&nbsp; &nbsp; remain resd 1<br />&nbsp; &nbsp; realsize resd 1<br /><br />section .data<br />pop_sa istruc sockaddr_in<br />&nbsp; &nbsp; at sockaddr_in.sin_family, dw 2<br />&nbsp; &nbsp; at sockaddr_in.sin_port, dw POPPORT<br />&nbsp; &nbsp; at sockaddr_in.sin_addr, dd POPIP<br />&nbsp; &nbsp; at sockaddr_in.sin_zero, dd 0, 0<br />iend<br /><br />msg db &quot;GET / HTTP/1.1&quot;, 13, 10<br />&nbsp; &nbsp; db &quot;Host: clax.inspiretomorrow.net&quot; ,13 ,10<br />&nbsp; &nbsp; db &quot;Connection: close&quot;, 13, 10<br />&nbsp; &nbsp; db &quot;User-Agent: ASM&quot;, 13, 10, 13, 10<br />msg_len equ $ - msg<br /><br /><br />proc&nbsp; &nbsp;  demo1<br />locals none<br />	xor eax, eax<br />	mov , eax<br />	invoke	WSAStartup, 0x101, wsadata<br />	invoke	socket,	dword 2, dword 1, dword 0<br />	mov , eax<br />	invoke	connect, eax, pop_sa, 16<br />	invoke	send, , msg, msg_len, 0<br />	mov ecx, BUFFSIZE<br />	mov , ecx<br />	mov ebx, resp<br />back:<br />	invoke	recv, , ebx, , 0<br />	cmp eax, 0<br />	jz cont<br />	mov ebx, resp<br />	add ebx, eax<br />	add , eax<br />	sub , eax<br />	jmp back<br />cont:	<br />	invoke	closesocket, <br />	invoke	WSACleanup<br />	invoke	GetStdHandle, dword -11<br />	invoke	WriteFile, eax, dword resp, , dword numb, 0<br />&nbsp; &nbsp; invoke&nbsp; &nbsp; ExitProcess, dword NULL<br />&nbsp; &nbsp; ret<br /><br />endproc<br /></code></pre><br /><br /></div>
    <div class="meta">Posted on 2011-10-07 14:04:56 by fbkotler</div>
   </div>
   <div class="post" id="post-215159">
    <div class="subject"><a href="#post-215159">Re: Calling C libraries in gas</a></div>
    <div class="body">Here&#039;s modified source that assembles without error.<br />Please see my comments marked as RN:<br />Note that I did not have time to debug this,<br />I only nasmxified it :)<br /><br /><pre><code><br />; wget-like thingy<br />; author; Nathan Baker<br />; written for Windows<br />; modified for Linux, too: fbk<br />;<br />; nasm -f win32 nbget -i path to NASMX\<br />; link &quot;as usual&quot;<br />;<br />; for Linux<br />; nasm -f elf nbget.asm -i path to NASMX/<br />; nasm -f elf fakeapi.asm<br />; ld -o get nbget.o get4lin.o -e main<br /><br />; swap backslashes to slashes<br />; I *think* Windows will accept shashes, too(?)<br /><br />; RN: Nasm accepts either for %include in your source<br />;&nbsp; &nbsp;  at least with recent versions of Nasm.&nbsp; However,<br />;&nbsp; &nbsp;  anything that reads/writes to disk must use the<br />;&nbsp; &nbsp;  backslash in the path.&nbsp; It&#039;s best to simply<br />;&nbsp; &nbsp;  always follow the host convention.<br /><br />; RN: assuming you&#039;ve set environment:<br />;&nbsp; &nbsp;  Windows: set NASMENV=-IC:\path\to\nasmx\inc\<br />;&nbsp; &nbsp;  Linux: export NASMENV=-I/path/to/nasm/inc/<br /><br />%ifidni __OUTPUT_FORMAT__, elf<br /><br />%include &#039;nasmx.inc&#039;<br />%include &#039;win32/windows.inc&#039;<br />%include &#039;win32/kernel32.inc&#039;<br />%include &#039;win32/user32.inc&#039;<br />%include &#039;win32/winsock.inc&#039;<br />%include &#039;win32/wsock32.inc&#039;<br /><br />%else<br /><br />%include &#039;nasmx.inc&#039;<br />%include &#039;win32\windows.inc&#039;<br />%include &#039;win32\kernel32.inc&#039;<br />%include &#039;win32\user32.inc&#039;<br />;<br />; RN: There is an easily corrected bug in winsock.inc<br />;&nbsp; &nbsp;  find the line containing<br />;&nbsp; &nbsp; &nbsp; &nbsp;  typedef SOCKET, size_t<br />;&nbsp; &nbsp;  and replace with<br />;&nbsp; &nbsp; &nbsp; &nbsp;  %xdefine SOCKET size_t<br />;<br />%include &#039;win32\winsock.inc&#039;<br />%include &#039;win32\wsock32.inc&#039;<br />%endif<br /><br />entry&nbsp; &nbsp; demo1<br /><br />;<br />; RN: Windows exposes htons as a function,<br />;&nbsp; &nbsp;  thus to use your own hton macros you must<br />;&nbsp; &nbsp;  comment out the htonl and htons imports in wsock32.inc<br />;<br />; Convert numbers (constants!) to network byte order<br />%define hton(x) ((x &amp; 0xFF000000) &gt;&gt; 24) | ((x &amp; 0x00FF0000) &gt;&gt;&nbsp; 8) | ((x &amp; 0x0000FF00) &lt;&lt;&nbsp; 8) | ((x &amp; 0x000000FF) &lt;&lt; 24)<br />%define htons(x) ((x &gt;&gt; 8) &amp; 0xFF) | ((x &amp; 0xFF) &lt;&lt; 8)<br /><br />; Nathan&#039;s server<br />;&nbsp; &nbsp; urltext db &quot;75.126.1.55&quot;, 0<br />_popip equ 4B7E0137h<br /><br />POPIP equ hton(_popip)<br />POPPORT equ htons(80)<br />BUFFSIZE equ 4096<br /><br />section .bss<br />&nbsp; &nbsp; wsadata resb 398<br />&nbsp; &nbsp; hsock resd 1<br />&nbsp; &nbsp; resp resb BUFFSIZE<br />&nbsp; &nbsp; numb resd 1<br />&nbsp; &nbsp; remain resd 1<br />&nbsp; &nbsp; realsize resd 1<br /><br />section .data<br />;pop_sa istruc sockaddr_in<br />;&nbsp; &nbsp; at sockaddr_in.sin_family, dw 2<br />;&nbsp; &nbsp; at sockaddr_in.sin_port, dw POPPORT<br />;&nbsp; &nbsp; at sockaddr_in.sin_addr, dd POPIP<br />;&nbsp; &nbsp; at sockaddr_in.sin_zero, dd 0, 0<br />;iend<br /><br />; RN: Yes, it&#039;s ugly but it permits access<br />;&nbsp; &nbsp;  to nested strucs and unions<br />NASMX_ISTRUC pop_sa, SOCKADDR_IN<br />&nbsp; &nbsp; NASMX_AT sin_family, AF_INET<br />&nbsp; &nbsp; NASMX_AT sin_port,&nbsp;  POPPORT<br />&nbsp; &nbsp; NASMX_ISTRUC sin_addr, IN_ADDR<br />&nbsp; &nbsp; &nbsp; &nbsp; NASMX_AT S_un.S_addr, POPIP<br />&nbsp; &nbsp; NASMX_IENDSTRUC<br />NASMX_IENDSTRUC<br /><br />msg db &quot;GET / HTTP/1.1&quot;, 13, 10<br />&nbsp; &nbsp; db &quot;Host: clax.inspiretomorrow.net&quot; ,13 ,10<br />&nbsp; &nbsp; db &quot;Connection: close&quot;, 13, 10<br />&nbsp; &nbsp; db &quot;User-Agent: ASM&quot;, 13, 10, 13, 10<br />msg_len equ $ - msg<br /><br /><br /><br />proc&nbsp;  demo1<br />locals none<br />	 xor eax, eax<br />	 mov dword , eax<br />	 invoke	 WSAStartup, 0x101, wsadata<br />	 invoke	 socket, 2, 1, 0<br />	 mov size_t , eax<br />	 invoke	 connect, eax, pop_sa, 16<br />	 invoke	 send, size_t , msg, msg_len, 0<br />	 mov ecx, BUFFSIZE<br />	 mov dword , ecx<br />	 mov ebx, resp<br />back:<br />	 invoke	 recv, size_t , ebx, dword , 0<br />	 cmp eax, 0<br />	 jz cont<br />	 mov ebx, resp<br />	 add ebx, eax<br />	 add , eax<br />	 sub , eax<br />	 jmp back<br />cont:	<br />	 invoke	 closesocket, size_t <br />	 invoke	 WSACleanup<br />	 invoke	 GetStdHandle, dword -11<br />	 invoke	 WriteFile, eax, dword resp, dword , dword numb, 0<br />&nbsp; &nbsp;  invoke&nbsp; &nbsp; ExitProcess, dword NULL<br />endproc<br /></code></pre><br /><br />And the makefile I used for a Windows build:<br />(Note I named the source file above &quot;wgetx.asm&quot;)<br /><br /><pre><code><br />##### Makefile #####<br />NAME=wgetx<br />AS=nasm<br />AFLAGS=-f win32<br />#AFLAGS=-f win32 -dUNICODE=1<br />LD=GoLink<br />LDFLAGS		=/entry _main<br />LIBS		=kernel32.dll user32.dll wsock32.dll<br /><br /># [ Suffixes ]<br /># Change the suffixes to match your system environment<br />O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  = .obj<br />X&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  = .exe<br />ASM&nbsp; &nbsp; &nbsp; &nbsp;  = .asm<br />INC&nbsp; &nbsp; &nbsp; &nbsp;  = .inc<br />LST&nbsp; &nbsp; &nbsp; &nbsp;  = .lst<br /><br /># rules<br />all: $(NAME)$(X)<br /><br />$(NAME): $(NAME)$(X)<br /><br />$(NAME)$(X): $(NAME)$(O)<br />	$(LD) $(LDFLAGS) $(NAME)$(O) $(LIBS)<br /><br />$(NAME)$(O): $(NAME)$(ASM)<br />	$(AS) $(AFLAGS) $(NAME)$(ASM) -o $(NAME)$(O) -l $(NAME)$(LST)<br /><br />clean:<br />	-del /f *.obj<br />	-del /f *.lst<br /><br />cleaner:<br />	-del /f *.bak<br />	-del /f *.lst<br />	-del /f *.obj<br />	-del /f *.exe<br /><br />##### End Makefile #####<br /></code></pre><br /></div>
    <div class="meta">Posted on 2011-10-07 21:53:22 by p1ranha</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=30688&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=30688&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="30688" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=30688&amp;page=2">&gt;</a><a href="../?id=30688&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>