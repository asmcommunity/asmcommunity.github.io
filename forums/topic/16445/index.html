<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>networking a dos app - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=16445" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=8">Networking</a> &raquo; <a href="../?id=16445">networking a dos app</a></p>
   <div class="post" id="post-127872">
    <div class="subject"><a href="#post-127872">networking a dos app</a></div>
    <div class="body">Maybe OT (wrong forum, wrong board and probably a stupidly wrong idea as well)... sorry.<br /><br />To keep it short i need to make a dos app available from the network and because of bandwith limitation i cannot use vnc or similar crap.<br />The very 1st idea was redirecting standard i/o to a network pipe (e.g. nc.exe -e 16bit_dos_proggie.exe)... but this didnt work because 16bit_dos_proggie.exe directly writes to video memory. To get what i mean just try piping output from command.com and edit.com to a file.<br /><br />So i wrote a very small tsr to poll video memory changes and transmit them to stdout...<br />What it basically do is:<br />- hooking int 1c to install the polling routine<br />- launching the proggie<br />- waiting for it to quit<br />- unhooking int 1c<br /><br />This now somewhat works: invoking &quot;launcher &gt; FILE&quot; fills FILE with the position, char and color of every character modified since last poll. Only problem is the whole thingy crashes as soon as 16bit_dos_proggie.exe calls int21 ah=4c... :(<br /><br />Well i spent half a day trying to figure whats wrong but my asm16 knoweledge is somewhat rusty... and i got nowhere...<br />So here is the code... id be glad if someone could either point me to the mistake or suggest a better/cleaner way to do what i need... Cheers!!!<br /><br /><pre><code><br />.model tiny<br />.code<br />.486<br />TsrBase&#58;<br />org     100h<br />Proggie&#58;<br />jmp     Loader<br /><br />; This is the int 1c hook<br />MyIntHanlder&#58;<br /><br />; Call real int 1c<br />        cli<br />        pushf<br />        call    dword ptr cs&#58;oldintl<br /><br />; Save some regs<br />        push    ds<br />        push    es<br /><br />        pusha<br />        pushf<br /><br />;Monitor Video Ram for changes &#40;1st page starts @c000&#58;b800&#41;<br />        mov     ax, 0b800h<br />        push    ax<br />        pop     ds<br />        xor     si, si<br />        push    cs<br />        pop     es<br />        mov     di, offset buffer<br />        cld<br />        mov     cx, 80*24<br />PollLoop&#58;<br />        repe<br />        cmpsw<br />        test    cx, cx<br />        je      NothingNew<br /><br />; If im here some memory changed<br />        dec     si<br />        dec     si<br />        dec     di<br />        dec     di<br /><br />; Save segment+offset<br />        mov     cs&#58;&#91;send&#93;, si<br />        lodsw<br />        stosw<br />        mov     cs&#58;&#91;thiscrap&#93;, ax<br /><br />; Output lo-offset to stdout using int 21 ah=2<br />        mov     ah, 2<br />        mov     dl, byte ptr cs&#58;&#91;send&#93;<br />        cli<br />        pushf<br />        call    dword ptr cs&#58;oldint21l<br /><br />; Output  hi-offset to stdout using int 21 ah=2<br />        mov     ah, 2<br />        mov     dl, byte ptr cs&#58;&#91;send+1&#93;<br />        cli<br />        pushf<br />        call    dword ptr cs&#58;oldint21l<br /><br />; Output char to stdout using int 21 ah=2<br />        mov     ah, 2<br />        mov     dl, byte ptr cs&#58;&#91;thiscrap&#93;<br />        cli<br />        pushf<br />        call    dword ptr cs&#58;oldint21l<br /><br />; Output color to stdout using int 21 ah=2<br />        mov     ah, 2<br />        mov     dl, byte ptr cs&#58;&#91;thiscrap+1&#93;<br />        cli<br />        pushf<br />        call    dword ptr cs&#58;oldint21l<br /><br />        jmp     PollLoop<br /><br />NothingNew&#58;<br />; Restore all the registries<br />        popf<br />        popa<br /><br />        pop     es<br />        pop     ds<br /><br />; Return to the caller<br />        sti<br />        iret<br /><br /><br />; Various data<br />oldintl dw      0acabh<br />oldinth dw      0acabh<br /><br />oldint21l       dw      0acabh<br />oldint21h       dw      0acabh<br /><br />send            dw      0<br />thiscrap                dw      0<br /><br />buffer  dw      &#40;80*24&#41; dup &#40;0&#41;<br />dummy           db      20 dup &#40;0&#41;<br />tail            db      0,0dh<br /><br />child           db      'C&#58;\WINDOWS\COMMAND\EDIT.COM',0<br />;child          db      'C&#58;\WINDOWS\SYSTEM32\EDIT.COM',0<br /><br />block           dw      0<br />                dw      tail<br />segc            dw      0<br />                dw      offset dummy<br />sega            dw      0<br />                dw      offset dummy<br />segb            dw      0<br /><br /><br />ThatsAll db      'END_$'<br /><br /><br />; Loader code<br /><br />Loader&#58;<br />;int 3<br />; Fill the buffer w/ current data<br />        mov     ax, 0b800h<br />        push    ax<br />        pop     ds<br />        push    cs<br />        pop     es<br />        xor     si, si<br />        cld<br />        mov     di, offset buffer<br />        mov     cx, 80*24<br />        repe<br />        movsw<br /><br />; Get int21 vector<br />        mov     ax, 3521h<br />        int     21h<br />        mov     word ptr cs&#58;&#91;oldint21h&#93;, es<br />        mov     word ptr cs&#58;&#91;oldint21l&#93;, bx<br /><br />; Get int1c vector<br />        mov     ax, 351ch<br />        int     21h<br />        mov     word ptr cs&#58;&#91;oldinth&#93;, es<br />        mov     word ptr cs&#58;&#91;oldintl&#93;, bx<br /><br />; Hook int1c<br />        push    cs<br />        pop     ds<br />        mov     dx, offset MyIntHanlder<br />        mov     ax, 251ch<br />        int     21h<br /><br /><br />; Shrink allocated mem<br />        mov     bx, &#40;offset top_mem&#41;<br />        shr     bx, 4<br />        inc     bx<br />        push    cs<br />        pop     es<br />        mov     ah, 4ah<br />        int     21h<br /><br />; Setup the struct...<br />        push    cs<br />        pop     ds<br />        push    cs<br />        pop     es<br />        push    cs<br />        pop     word ptr &#91;sega&#93;<br />        push    cs<br />        pop     word ptr &#91;segb&#93;<br />        push    cs<br />        pop     word ptr &#91;segc&#93;<br /><br />; ...and fire the proggie<br />        mov     dx, offset child<br />        mov     bx, offset block<br />        mov     ax, 4b00h<br />        int     21h<br /><br />; Revert old int1c vector<br />        push    word ptr cs&#58;&#91;oldinth&#93;<br />        pop     ds<br />        mov     dx, word ptr cs&#58;&#91;oldintl&#93;<br />        mov     ax, 251ch<br />        int     21h<br /><br />; This is the end<br />        push    cs<br />        pop     ds<br />        mov     dx, offset ThatsAll<br />        mov     ah, 09<br />        int     21h<br /><br />; Quit<br />        mov     ax, 4c00h<br />        int     21h<br /><br />end     Proggie<br /></code></pre></div>
    <div class="meta">Posted on 2003-12-15 09:30:26 by acab</div>
   </div>
   <div class="post" id="post-128029">
    <div class="subject"><a href="#post-128029">networking a dos app</a></div>
    <div class="body">Hi,<br /><br />if I remember correctly Int 1C is called by int 08, a irq routine. in such a routine you must be careful to call dos interrupt 21h because it isnt reentrant.<br />You should possibly check indosflag and if it is set, save SDA before your calls and restore them later.<br /><br />Japheth</div>
    <div class="meta">Posted on 2003-12-16 12:33:11 by japheth</div>
   </div>
   <div class="post" id="post-128172">
    <div class="subject"><a href="#post-128172">networking a dos app</a></div>
    <div class="body">Ty a lot japheth!<br />i really forgot bout that....<br />I also figured out what made it crash: resizing the memory leaving ss:sp pointing outside the allocated memory is defently a stupid idea :(<br />Now it works... but still not as expected!<br />Under win9x, in fact, piped stdout gets buffered and actually only flushed on program termination.<br />But i guess that's a live with...<br />Everything works decently enough under NT-like's<br /><br />Cheers!</div>
    <div class="meta">Posted on 2003-12-17 13:40:12 by acab</div>
   </div>
  </div>
 </body>
</html>