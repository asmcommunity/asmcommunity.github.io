<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>How to write Assembly for C - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=28706" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=28706">How to write Assembly for C</a></p>
   <div class="post" id="post-202797">
    <div class="subject"><a href="#post-202797">How to write Assembly for C</a></div>
    <div class="body">Hello.<br /><br />I have been wondering if there were any guidelines I could go by if someone were to ask me to write an Assembly program for their C/C+/C++ program or whatever. I&#039;m not sure what is accepted and rejected and would like to know what I can and can&#039;t do should I attempt to write an assembly program for someone who programs in C but doesn&#039;t know a thing about assembly. <br /><br />Thanks, <br /><br />keantoken</div>
    <div class="meta">Posted on 2007-08-31 19:06:14 by keantoken</div>
   </div>
   <div class="post" id="post-202799">
    <div class="subject"><a href="#post-202799">Re: How to write Assembly for C</a></div>
    <div class="body">Typically, the only way for the C programmer to understand ASM, is for them to know it already or go to someone who does know it for interpretation.<br /><br />However, to answer your question, you generally have two routes to take. Inline Assembly and modules.<br /><br />The first, Inline Assembly, is supported in all the major C compilers. However, the (default) syntax can differ based on the compiler you are using. It also can get quite annoying having ASM syntax spread out through your high-level source code... especially when it breaks the compiler&#039;s process of streamline optimization.<br /><br />The second, modules, are simply done by linking your C object files with your ASM object files... making note to properly decorate and address GLOBAL and EXTERNAL variables/functions. This is probably the better way as you can keep to one ASM syntax, that you do like, and still get everything to work. Moreover, you could provide a basic &quot;include&quot; file with said GLOBALS and EXTERNS, the same concept as a C header and even a C programmer should understand... throw in some comments about how the functions/variables work and you&#039;re good to go.</div>
    <div class="meta">Posted on 2007-08-31 19:40:06 by SpooK</div>
   </div>
   <div class="post" id="post-202800">
    <div class="subject"><a href="#post-202800">Re: How to write Assembly for C</a></div>
    <div class="body">keantoken,<br /><br />I think you are trying to ask &quot;How might I go about writing a funtion to which a C program may call?&quot;.<br /><br />If that&#039;s the case, here&#039;s a few tips to point you in the right direction...<br /><br />The C Calling Convention stipulates that these registers must be preserved: EBX, ESP, EBP, ESI, and EDI. They can be used, but you must restore their original values before your procedure returns to C. Any 32-bit or smaller return value is returned in EAX. A 64-bit return value is returned in EAX:EDX, EAX has the low-order 32-bit, and EDX has the high-order ones. Parameters to your procedure will be pushed on to the stack in reverse order, and it is your callers responsibility to pop them.<br /><br />The Standard Calling Convention, the one Win32 uses, is essentially the same, except your procedure would remove the parameters, rather than it&#039;s caller.<br /><br />I&#039;m not a 100% sure on this one, but I think for C to be able to call your procedures, they must begin with an underscore, as in _MyAssemblyProc.<br /><br />So, keeping all this in mind, this is how your procedure might look for standard C:<br /><br />_MyAssemblyProc:<br /><br /> &nbsp; &nbsp;push ebp ; save callers stack frame<br /> &nbsp; &nbsp;mov ebp, esp ; your stack frame is in ebp<br /> &nbsp; &nbsp;push ebx &nbsp; ; save critical registers<br /> &nbsp; &nbsp;push esi<br /> &nbsp; &nbsp;push edi<br /><br /> &nbsp; &nbsp;; you could sub, esp &lt;num&gt; for locals here<br /><br /> &nbsp; &nbsp;; do your procedure&#039;s stuff here<br /><br /> &nbsp; &nbsp;pop edi &nbsp;; restore critical registers<br /> &nbsp; &nbsp;pop esi<br /> &nbsp; &nbsp;pop ebx<br /> &nbsp; &nbsp;mov esp, ebp ; no need to add, esp &lt;num&gt; to discard locals<br /> &nbsp; &nbsp;pop ebp &nbsp;; restore callers stack frame<br /> &nbsp; &nbsp;ret &nbsp;; caller takes care of params<br /><br />This is how your procedure might look for Windows calling:<br /><br />_MyAssemblyProc:<br /><br /> &nbsp; &nbsp;push ebp<br /> &nbsp; &nbsp;mov ebp, esp<br /> &nbsp; &nbsp;push ebx<br /> &nbsp; &nbsp;push esi<br /> &nbsp; &nbsp;push edi<br /><br /> &nbsp; &nbsp;; do your procedure&#039;s stuff here<br /><br /> &nbsp; &nbsp;pop edi<br /> &nbsp; &nbsp;pop esi<br /> &nbsp; &nbsp;pop ebx<br /> &nbsp; &nbsp;mov esp, ebp<br /> &nbsp; &nbsp;pop ebp<br /> &nbsp; &nbsp;ret 8 &nbsp; ; return and pop 2 params off the stack</div>
    <div class="meta">Posted on 2007-08-31 19:40:55 by TheAbysmal</div>
   </div>
   <div class="post" id="post-202805">
    <div class="subject"><a href="#post-202805">Re: How to write Assembly for C</a></div>
    <div class="body">Ah, thanks!<br /><br />So EAX is for a return status (fail, ERRR, etc.) and/or can be used as a variable? Or is it just for return status? Sorry, I know <span class="strike">second to</span> nothing about C.<br /><br />Can the stack also be used to transport variables?<br /><br />So how do you go about declaring global and external functions and what&#039;s the difference between them?<br /><br />Sorry if I&#039;m asking a lot of questions, but if I can figure this out then I can write a tutorial for Assembly programmers who don&#039;t want to bother learning C just yet. Plus I&#039;ll be able to do a whole lot more and I can show the community what I&#039;m good for.<br /><br /> - keantoken</div>
    <div class="meta">Posted on 2007-08-31 22:51:30 by keantoken</div>
   </div>
   <div class="post" id="post-202807">
    <div class="subject"><a href="#post-202807">Re: How to write Assembly for C</a></div>
    <div class="body"><div class="quote">I&#039;m not a 100% sure on this one, but I think for C to be able to call your procedures, they must begin with an underscore, as in _MyAssemblyProc.</div><br /><br />I don&#039;t believe they <em>have</em> to start with an underscore, it&#039;s just common practice to identify globals from normal functions at a glance. I do know that certain versions of LibC have an _ and others don&#039;t, which is why the LibC.mac for NASM32 had an _UNDERSCORE_ switch. Depending on what version of libc you were required to add -D_UNDERSCORE_ to the command line to build sources. But other versions of libc didn&#039;t have a beginning _ to their functions like printf, puts, and the rest. So it&#039;s most certainly not forced on you, it&#039;s probably a style thing.<br /><br /><div class="quote">So EAX is for a return status (fail, ERRR, etc.) and/or can be used as a variable? Or is it just for return status? Sorry, I know second to nothing about C.</div><br /><br />C programmers will expect you to return either an error code or the result of your processing.<br /><br /><div class="quote">Can the stack also be used to transport variables?</div><br /><br />That&#039;s primarily what programmers use it for.<br /><br /><div class="quote">So how do you go about declaring global and external functions and what&#039;s the difference between them?</div><br /><br />That depends solely on what assembler you are using. Different assemblers have different directives for declaring global procedures.<br /><br /><div class="quote">Sorry if I&#039;m asking a lot of questions, but if I can figure this out then I can write a tutorial for Assembly programmers who don&#039;t want to bother learning C just yet. Plus I&#039;ll be able to do a whole lot more and I can show the community what I&#039;m good for.</div><br /><br />Good luck with that! :D<br /><br />Regards,<br />Bryant Keller</div>
    <div class="meta">Posted on 2007-09-01 00:59:01 by Synfire</div>
   </div>
   <div class="post" id="post-202809">
    <div class="subject"><a href="#post-202809">Re: How to write Assembly for C</a></div>
    <div class="body">The underscore has to do with name mangling - standard C symbols in .obj files are prepended with an underscore (which means the _reserved names in your platform end up as __reservered). There&#039;s also STDCALL calling convention (the default used in windows) which has different name mangling, nameling name@parmsize , where parmsize is the byte count of parameters.<br /><br />MASM&#039;s PROC statement, supporting calling convention declaration, does the name mangling automatically; for FASM/NASM/YASM/etc you have to do it manually, or find/make some macro.<br /><br />Forget about inline assembly, it tends to inhibit some optimizations in some compilers, the syntax is compiler dependent, and it&#039;s largely unavailable for 64bit compilers (well, for MSVC x64 anyway :)). Anything worth writing in assembly is worth writing as an external assembly module.<br /></div>
    <div class="meta">Posted on 2007-09-01 03:17:53 by f0dder</div>
   </div>
  </div>
 </body>
</html>