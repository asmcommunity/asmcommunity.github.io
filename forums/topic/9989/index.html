<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>fp optimisation help - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=9989" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=9989">fp optimisation help</a></p>
   <div class="post" id="post-74647">
    <div class="subject"><a href="#post-74647">fp optimisation help</a></div>
    <div class="body">Heya.<br />I'm living back in the Dark Ages. I don't know a lot of new-fangled instructions.<br />Would anyone be willing to help optimize these two short functions?<br />I want to either make no assumptions about the cpu, or have cases optimized for various cpu's.<br /><br />;===============================================<br />;Some helper functions I had to code myself :(<br />;Badly need optimizing !!!<br /><br />ColorLerp PROC pC1:DWORD, pC2:DWORD, F:FLOAT, pOut:DWORD<br /><br />fld  .D3DXCOLOR.r           ;    pOut-&gt;r = pC1-&gt;r + s * (pC2-&gt;r - pC1-&gt;r);<br />fsub .D3DXCOLOR.r<br />fmul F<br />fadd .D3DXCOLOR.r<br />fstp .D3DXCOLOR.r<br /><br />fld  .D3DXCOLOR.g           ;    pOut-&gt;g = pC1-&gt;g + s * (pC2-&gt;g - pC1-&gt;g);<br />fsub .D3DXCOLOR.g<br />fmul F<br />fadd .D3DXCOLOR.g<br />fstp .D3DXCOLOR.g<br /><br />fld  .D3DXCOLOR.b           ;    pOut-&gt;b = pC1-&gt;b + s * (pC2-&gt;b - pC1-&gt;b);<br />fsub .D3DXCOLOR.b<br />fmul F<br />fadd .D3DXCOLOR.b<br />fstp .D3DXCOLOR.b<br /><br />fld  .D3DXCOLOR.a           ;    pOut-&gt;a = pC1-&gt;a + s * (pC2-&gt;a - pC1-&gt;a);<br />fsub .D3DXCOLOR.a<br />fmul F<br />fadd .D3DXCOLOR.a<br />fstp .D3DXCOLOR.a<br /><br />ret<br />ColorLerp ENDP<br /><br />;=====================================<br />;Convert D3DXColor into ARGB dword<br />DXColorToDW PROC pIn:DWORD<br />local btemp:DWORD<br />fld pIn.D3DXCOLOR.a<br />fistp btemp<br />mov ebx,btemp<br />mov al,bl<br />shl eax,8<br />fld pIn.D3DXCOLOR.r<br />fistp btemp<br />mov ebx,btemp<br />mov al,bl<br />shl eax,8<br />fld pIn.D3DXCOLOR.g<br />fistp btemp<br />mov ebx,btemp<br />mov al,bl<br />shl eax,8<br />fld pIn.D3DXCOLOR.b<br />fistp btemp<br />mov ebx,btemp<br />mov al,bl<br />ret<br />DXColorToDW ENDP<br /><br />Well, there they are, in all their gory.<br />They simply suck. I guess I do too.<br />Thanks in advance to anyone who takes pity on me, I was a dab hand when I knew all the opcodes :(</div>
    <div class="meta">Posted on 2003-01-06 12:43:15 by Homer</div>
   </div>
   <div class="post" id="post-74671">
    <div class="subject"><a href="#post-74671">fp optimisation help</a></div>
    <div class="body">ColorLerp seems to be optimized and I'm too lazy to create sumthin to test the codes but this &quot;might&quot; work on DXColorToDW...<br /><br />not tested.<br /><br />DXColorToDW PROC pIn:DWORD<br />local btemp:DWORD<br />fld pIn.D3DXCOLOR.a<br />fistp btemp<br />mov ebx,btemp<br />mozx eax, bl<br />shl eax,8<br /><br />fld pIn.D3DXCOLOR.r<br />fistp btemp<br />mov ebx,btemp<br />shl ebx, 24<br />shr ebx, 24<br />or eax, ebx<br />shl eax,8<br /><br />fld pIn.D3DXCOLOR.g<br />fistp btemp<br />mov ebx,btemp<br />shl ebx, 24<br />shr ebx, 24<br />or eax, ebx<br />shl eax,8<br /><br />fld pIn.D3DXCOLOR.b<br />fistp btemp<br />mov ebx,btemp<br />shl ebx, 24<br />shr ebx, 24<br />or eax, ebx<br />ret<br />DXColorToDW ENDP<br /><br />I don't know if this is faster or if it works but hey there's no harm in trying... :grin:<br /><br />but the thing here is that I'm using full registers which may be slow if your using 32 bit then using 8 bit ... blah! blah! :grin:</div>
    <div class="meta">Posted on 2003-01-06 15:16:48 by arkane</div>
   </div>
   <div class="post" id="post-74674">
    <div class="subject"><a href="#post-74674">Re: fp optimisation help</a></div>
    <div class="body"><div class="quote"><em>Originally posted by EvilHomer2k </em><br />fld  .D3DXCOLOR.r           ;    pOut-&gt;r = pC1-&gt;r + s * (pC2-&gt;r - pC1-&gt;r);<br /></div><br />How will this work? If pC2 is a pointer to a D3DXCOLOR struct you first have to dereference it before adding the '.r' offset to it (like mov eax,  / fld ). Have you tested if your code works? I don't think it would work this way, this code would just load the pointer as a floating point value :)<br /><br /><div class="quote">Well, there they are, in all their gory.<br />They simply suck. I guess I do too.<br />Thanks in advance to anyone who takes pity on me, I was a dab hand when I knew all the opcodes :(</div><br />Don't be so negative :) Just try, measure the time your code takes and try to improve it. It's the only way you'll learn it.<br /><br />Thomas</div>
    <div class="meta">Posted on 2003-01-06 15:21:54 by Thomas</div>
   </div>
   <div class="post" id="post-74731">
    <div class="subject"><a href="#post-74731">fp optimisation help</a></div>
    <div class="body">Two problems I see with your code, one major the other one minor. Nothing to do however with optimization.<br /><br />Major: RGBa is the little-endian representation of a 32-bit color. Which means that the &quot;red&quot; component must be in the least significant byte of the dword. Your code loads the blue component in the least significant byte.<br /><br />Minor: If there ever is a possibility of the calculated color intensity being higher than 255.5, the FPU would return a value of 256 when the FPU is in the default mode. Which means that the color intensity effectively used in such a case would be &quot;0&quot;. Either you set the FPU for truncation before storing fp's as integers, or you must check each stored value for the possibility of the 100h value. (I must assume that there is no possibility of values &gt;=256 from your calculations.)<br /><br />Have fun<br /><br />Raymond</div>
    <div class="meta">Posted on 2003-01-06 19:56:20 by Raymond</div>
   </div>
   <div class="post" id="post-74813">
    <div class="subject"><a href="#post-74813">fp optimisation help</a></div>
    <div class="body">Heya.<br /><br />Thanks for the feedback on those.<br />Here is the (tested) revised version of those functions.<br />Anyone wanna have a go at an SSE2 version ?<br /><br /><br />Some helper functions I had to code myself :(<br />;Badly need optimizing !!!<br /><br />ColorLerp PROC pC1:LPD3DXCOLOR, pC2:LPD3DXCOLOR, F:FLOAT, pOut:LPD3DXCOLOR<br />push esi<br />push edi<br />push ecx<br />mov esi,pC1<br />mov edi,pOut<br />mov ecx,pC2<br /><br />fld  .D3DXCOLOR.r           ;pOut-&gt;r = pC1-&gt;r + s * (pC2-&gt;r - pC1-&gt;r);<br />fsub .D3DXCOLOR.r<br />fmul F<br />fadd .D3DXCOLOR.r<br />fstp .D3DXCOLOR.r<br /><br />fld  .D3DXCOLOR.g           ;    pOut-&gt;g = pC1-&gt;g + s * (pC2-&gt;g - pC1-&gt;g);<br />fsub .D3DXCOLOR.g<br />fmul F<br />fadd .D3DXCOLOR.g<br />fstp .D3DXCOLOR.g<br /><br />fld  .D3DXCOLOR.b           ;    pOut-&gt;b = pC1-&gt;b + s * (pC2-&gt;b - pC1-&gt;b);<br />fsub .D3DXCOLOR.b<br />fmul F<br />fadd .D3DXCOLOR.b<br />fstp .D3DXCOLOR.b<br /><br />fld  .D3DXCOLOR.a           ;    pOut-&gt;a = pC1-&gt;a + s * (pC2-&gt;a - pC1-&gt;a);<br />fsub .D3DXCOLOR.a<br />fmul F<br />fadd .D3DXCOLOR.a<br />fstp .D3DXCOLOR.a<br /><br />pop ecx<br />pop edi<br />pop esi<br />ret<br />ColorLerp ENDP<br /><br />;=====================================================================================<br />;Convert D3DXColor(RGBA floats) into ARGB dword in ass-about format<br />;floats truncated at 255 (saturated byte)<br /><br />DXColorToDW PROC pIn:LPD3DXCOLOR<br />local btemp:DWORD<br />push esi<br />mov esi,pIn<br />fld .D3DXCOLOR.b<br />fistp btemp<br />mov ebx,btemp<br />.if ebx&gt;255<br />    mov ebx,255<br />.endif<br />mov al,bl<br />shl eax,8<br />fld .D3DXCOLOR.g<br />fistp btemp<br />mov ebx,btemp<br />.if ebx&gt;255<br />    mov ebx,255<br />.endif<br />mov al,bl<br />shl eax,8<br />fld .D3DXCOLOR.r<br />fistp btemp<br />mov ebx,btemp<br />.if ebx&gt;255<br />    mov ebx,255<br />.endif<br />mov al,bl<br />shl eax,8<br />fld .D3DXCOLOR.a<br />fistp btemp<br />mov ebx,btemp<br />.if ebx&gt;255<br />    mov ebx,255<br />.endif<br />mov al,bl<br />pop esi<br />ret<br />DXColorToDW ENDP</div>
    <div class="meta">Posted on 2003-01-07 06:56:10 by Homer</div>
   </div>
   <div class="post" id="post-74836">
    <div class="subject"><a href="#post-74836">fp optimisation help</a></div>
    <div class="body">for ColorLerp - assuming everthing is in float size<pre><code>#include&lt;stdio.h&gt;<br /><br />typedef struct<br />&#123;<br />    float r;<br />    float g;<br />    float b;<br />    float a;<br />&#125; D3DXCOLOR;<br /><br />int main&#40;void&#41;<br />&#123;<br />    D3DXCOLOR d1 = &#123;3.5f, 3.5f, 3.5f, 3.5f&#125;;<br />    D3DXCOLOR d2 = &#123;1.5f, 1.5f, 1.5f, 1.5f&#125;;<br />    D3DXCOLOR f = &#123;2.0f, 2.0f, 2.0f, 2.0f&#125;;<br />    D3DXCOLOR output;<br /><br />    &#91;color=blue&#93;__asm<br />    &#123;<br />        movaps  xmm0, d1<br />        movaps  xmm1, d2<br />        movaps  xmm2, f<br />        subps   xmm0, xmm1<br />        mulps   xmm0, xmm2<br />        addps   xmm0, xmm1<br />        movaps  output, xmm0<br />    &#125;&#91;/color&#93;<br /><br />    printf&#40;&quot;%f\n&quot;, output.r&#41;;<br />    printf&#40;&quot;%f\n&quot;, output.g&#41;;<br />    printf&#40;&quot;%f\n&quot;, output.b&#41;;<br />    printf&#40;&quot;%f\n&quot;, output.a&#41;;<br />    return 0;<br />&#125;</code></pre>:grin: C he! he! :)<br /><br />Just in case your wondering about D3DXCOLOR f - I did that for parallel processing whatever the value of f is, just plug it in to the whole structure fields of D3DXCOLOR. We don't care on what field it is on as long as all fields have the same values. :)<br /><br />pc1 == d1<br />pc2 == d2<br /><br />for DXColorToDW - Not tested again :)<pre><code>DXColorToDW PROC pIn&#58;DWORD<br />    local btemp&#58;DWORD<br />    fld     pIn.D3DXCOLOR.b<br />    fistp   btemp<br />    mov     ebx,btemp<br />    cmp     ebx, 255<br />    cmova   ebx, 255<br />    movzx   eax, bl<br />    shl     eax,8<br /><br />    fld     pIn.D3DXCOLOR.g<br />    fistp   btemp<br />    mov     ebx,btemp<br />    cmp     ebx, 255<br />    cmova   ebx, 255<br />    shl     ebx, 24<br />    shr     ebx, 24<br />    or      eax, ebx<br />    shl     eax,8<br /><br />    fld     pIn.D3DXCOLOR.r<br />    fistp   btemp<br />    mov     ebx,btemp<br />    cmp     ebx, 255<br />    cmova   ebx, 255<br />    shl     ebx, 24<br />    shr     ebx, 24<br />    or      eax, ebx<br />    shl     eax,8<br /><br />    fld     pIn.D3DXCOLOR.a<br />    fistp   btemp<br />    mov     ebx,btemp<br />    cmp     ebx, 255<br />    cmova   ebx, 255<br />    shl     ebx, 24<br />    shr     ebx, 24<br />    or      eax, ebx<br />    ret<br />DXColorToDW ENDP</code></pre><br /><br /><br /><br />btw, I think you have to change the use of register ebx to ecx/edx ... so you don't have to push ebx on entry at the procedure and pop it afterwards.<br /><br /><br /><br />don't forget 16 bit alignment(align 16) of memory operands when coding in assembly... movaps requires this alignment.<br /><br /><br /><br />changed DXColorToDW structure fields order of operation, I was still following the old code which was A, R G, B not B, G, R, A. :)<br /><br />I think you can eliminate shl ebx, 24 and shr ebx, 24 if you already have a conditional move since that prevents bits going off the 8 bit limit.<br /><br />I don't know since I'm too lazy to test anything... :grin:</div>
    <div class="meta">Posted on 2003-01-07 10:11:04 by arkane</div>
   </div>
   <div class="post" id="post-74898">
    <div class="subject"><a href="#post-74898">fp optimisation help</a></div>
    <div class="body">Maybe something tricky that a compiler couldn't dream up:<pre><code>_PUSHAD STRUCT<br />	_EDI DWORD ?<br />	_ESI DWORD ?<br />	_EBP DWORD ?<br />	_ESP DWORD ?	; not used when POPAD<br />	_EBX DWORD ?<br />	_EDX DWORD ?<br />	_ECX DWORD ?<br />	_EAX DWORD ?<br />_PUSHAD ENDS<br /><br />DXColorToDW&#58;<br />	mov	edx, &#91;esp+4&#93;<br />	pushad<br /><br />	fld	&#91;edx&#93;.D3DXCOLOR.a<br />	fld	&#91;edx&#93;.D3DXCOLOR.r<br />	fld	&#91;edx&#93;.D3DXCOLOR.g<br />	fld	&#91;edx&#93;.D3DXCOLOR.b<br /><br />	fistp	&#91;esp&#93;._PUSHAD._ESP ; &#58;&#41;<br />	fistp	&#91;esp&#93;._PUSHAD._EAX<br />	fistp	&#91;esp&#93;._PUSHAD._EDX<br />	fistp	&#91;esp&#93;._PUSHAD._ECX<br /><br />	mov	eax, &#91;esp&#93;._PUSHAD._ESP<br />	mov	ebx, &#91;esp&#93;._PUSHAD._EAX<br />	mov	ecx, &#91;esp&#93;._PUSHAD._EDX<br />	mov	edx, &#91;esp&#93;._PUSHAD._ECX<br /><br />	sub	eax, 255<br />	sbb	esi, esi<br />	sub	ebx, 255<br />	sbb	edi, edi<br />	sub	ecx, 255<br />	sbb	ebp, ebp<br /><br />	and	eax, esi<br />	and	ebx, edi<br />	and	ecx, ebp<br /><br />	sub	edx, 255<br />	sbb	esi, esi<br />	and	edx, esi<br /><br />	add	eax, 255<br />	add	ebx, 255<br />	add	ecx, 255<br />	add	edx, 255<br /><br />	shl	eax, 24<br />	shl	ebx, 12<br />	shl	ecx, 8<br /><br />	or	eax, edx<br />	or	ecx, ebx<br /><br />	or	eax, ecx<br /><br />	mov	&#91;esp&#93;._PUSHAD._EAX, eax<br />	popad<br />	ret 4</code></pre>Conditional moves are not much better than conditional jump instructions - better to do without them all together.  This code is good for processors without SSE/K3D/SSE2.</div>
    <div class="meta">Posted on 2003-01-07 15:59:25 by bitRAKE</div>
   </div>
   <div class="post" id="post-74903">
    <div class="subject"><a href="#post-74903">fp optimisation help</a></div>
    <div class="body">final :) - optimizations welcome :)<pre><code>#include&lt;stdio.h&gt;<br /><br />typedef struct<br />&#123;<br />    float r;<br />    float g;<br />    float b;<br />    float a;<br />&#125; D3DXCOLOR;<br /><br />typedef struct<br />&#123;<br />    unsigned char r;<br />    unsigned char g;<br />    unsigned char b;<br />    unsigned char a;<br />&#125; BYTEVIEWER;<br /><br />BYTEVIEWER finaloutput;<br /><br />int main&#40;void&#41;<br />&#123;<br />    D3DXCOLOR d1 = &#123;3.5f, 3.5f, 3.5f, 3.5f&#125;;<br />    D3DXCOLOR d2 = &#123;1.5f, 1.5f, 1.5f, 1.5f&#125;;<br />    D3DXCOLOR f = &#123;2.0f, 2.0f, 2.0f, 2.0f&#125;;<br />    D3DXCOLOR dxcolor2dw = &#123;1.5f, 300.59f, 259.0f, 240.0f&#125;;<br />    D3DXCOLOR output;<br /><br />    &#91;color=blue&#93;__asm<br />    &#123;<br />        movaps  xmm0, d1<br />        movaps  xmm1, d2<br />        movaps  xmm2, f<br />        subps   xmm0, xmm1<br />        mulps   xmm0, xmm2<br />        addps   xmm0, xmm1<br />        movaps  output, xmm0<br />    &#125;&#91;/color&#93;<br /><br />    printf&#40;&quot;%f\n&quot;, output.r&#41;;<br />    printf&#40;&quot;%f\n&quot;, output.g&#41;;<br />    printf&#40;&quot;%f\n&quot;, output.b&#41;;<br />    printf&#40;&quot;%f\n&quot;, output.a&#41;;<br /><br />    &#91;color=blue&#93;__asm<br />    &#123;<br />        movaps      xmm0, dxcolor2dw<br />        movaps      xmm1, xmm0<br />        cvtps2pi    mm0, xmm0<br />        shufps      xmm1, xmm0, 0Eh<br />        cvtps2pi    mm1, xmm1<br />        packssdw    mm0, mm1<br />        packuswb    mm0, mm0<br />        movq        mm1, mm0<br />        psllq       mm0, 16<br />        psrlq       mm0, 16<br />        psllq       mm1, 48<br />        por         mm0, mm1<br />        movd        eax, mm0<br />        mov         finaloutput, eax<br />        emms<br />    &#125;&#91;/color&#93;<br /><br />    printf&#40;&quot;%d\n&quot;, finaloutput.r&#41;;<br />    printf&#40;&quot;%d\n&quot;, finaloutput.g&#41;;<br />    printf&#40;&quot;%d\n&quot;, finaloutput.b&#41;;<br />    printf&#40;&quot;%d\n&quot;, finaloutput.a&#41;;<br /><br />    return 0;<br />&#125;</code></pre>I could have exploited some SSE2 instructions but since I don't have a p4... only a p3, so, I have to limit to SSE instructions only.<br /><br />The second set of code is for DXColorToDW... I use the BYTEVIEWER structure to see if the results exceeds 255.<br /><br />Just in case anyone will forget that rounding here applies since we're converting from float to integer.<br /><br />:)</div>
    <div class="meta">Posted on 2003-01-07 16:17:48 by arkane</div>
   </div>
   <div class="post" id="post-74971">
    <div class="subject"><a href="#post-74971">fp optimisation help</a></div>
    <div class="body">much better... dunno why I was thinking of shifts and ors. :grin:<pre><code>movaps		xmm0, dxcolor2dw<br />movaps		xmm1, xmm0<br />cvtps2pi	mm0, xmm0<br />shufps		xmm1, xmm0, 0Eh<br />cvtps2pi	mm1, xmm1<br />packssdw	mm0, mm1<br />packuswb	mm0, mm0<br />movd		eax, mm0<br /><br />;Not Needed<br /><br />mov		finaloutput, eax</code></pre></div>
    <div class="meta">Posted on 2003-01-07 22:43:52 by arkane</div>
   </div>
   <div class="post" id="post-75039">
    <div class="subject"><a href="#post-75039">fp optimisation help</a></div>
    <div class="body">awww shucks :)<br /><br />I don't know what to say except THANKS :alright: <br />I'll try the SSE version of the functions as soon as I get my example working lol.<br />The ones I coded are tested and working, but the example which uses them needs more work :(<br />I will benchmark on a few machines and submit my findings.<br />Anyone coded non-naive fpu case code before?<br />Did u simply flag the chip and call the appropriate function?<br />Or did u compile for various chips?</div>
    <div class="meta">Posted on 2003-01-08 05:49:04 by Homer</div>
   </div>
  </div>
 </body>
</html>