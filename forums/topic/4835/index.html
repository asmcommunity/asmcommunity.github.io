<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Bored? helpme optimize this code for speed - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=4835" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=4835">Bored? helpme optimize this code for speed</a></p>
   <div class="post" id="post-33898">
    <div class="subject"><a href="#post-33898">Bored? helpme optimize this code for speed</a></div>
    <div class="body"><pre><code><br />.data<br />	Dtotal REAL8 4294967296.0<br />		Dfree REAL8 10000.0<br />	NU8 REAL8 8.0<br />	NU100 REAL8 100.0<br />	NU1024 REAL8 1024.0<br />.code<br /><br />getallspaces Proc,pcdrivePTR&#58;DWORD,ppTOTAL&#58;DWORD,pFREE&#58;DWORD,pUSED&#58;DWORD,pTOTALBITS&#58;DWORD,pTOTALGB&#58;DWORD, <br />pTOTAL8GB&#58;DWORD,pFREEBITS&#58;DWORD,pFREEGB&#58;DWORD,pFREE8GB&#58;DWORD,pUSEDBITS&#58;DWORD,pUSED8GB&#58;DWORD,pUSEDGB&#58;DWORD,<br />pFREEPERCENT&#58;DWORD,pUSEDPERCENT&#58;DWORD<br /><br /><br />Local LdTotaltemp2&#58;REAL8<br />Local LdTotaltemp3&#58;REAL8<br />Local LdTotaltemp4&#58;REAL8<br />Local LdTotaltemp5&#58;REAL8<br />Local LdTotaltemp1&#58;REAL8<br />Local Dpptotal&#58;QWORD<br />Local Dppfree&#58;QWORD<br />Invoke GetDiskFreeSpaceEx, pcdrivePTR, Addr Dppfree, Addr Dpptotal,NULL<br /><br />fild Dpptotal ;convert from init to dec         ;<br />fstp LdTotaltemp2 ; store into the double       ;<br />fild Dppfree;convert from init to dec           ;<br />fstp LdTotaltemp1 ; store into the double       ;<br />mov eax, ppTOTAL ;load into regester            ;<br />fld LdTotaltemp2 ; load total                   ;<br />fstp QWORD PTR &#91;eax&#93; ; store into imput         ;<br />mov eax, pFREE ;load into regester              ;<br />fld LdTotaltemp1  ;load free                    ;<br />fstp QWORD PTR &#91;eax&#93;; store into imput          ;<br />mov eax, pUSED ;load into regester              ;<br />fld LdTotaltemp2 ; load total on #1             ;<br />fld LdTotaltemp1 ; load free on #2              ;<br />fsub ; sub #2 from #1                           ;<br />fstp QWORD PTR &#91;eax&#93; ; store in imput           ;<br />;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br />mov eax, pTOTALBITS         ;8x bit total<br />fld LdTotaltemp2            ;<br />fld NU8<br />fmul<br />fstp QWORD PTR &#91;eax&#93;<br /><br />fld QWORD PTR &#91;eax&#93;<br />mov eax, pTOTAL8GB<br />fld NU1024<br />fdiv<br />fstp LdTotaltemp3<br />fld LdTotaltemp3 <br />fld NU1024<br />fdiv<br />fstp LdTotaltemp3<br />fld LdTotaltemp3 <br />fld NU1024<br />fdiv<br />fstp QWORD PTR &#91;eax&#93;<br />fld QWORD PTR &#91;eax&#93;<br />fld NU8<br />fdiv<br />mov eax, pTOTALGB<br />fstp QWORD PTR &#91;eax&#93;<br />;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br />fild Dppfree;convert from init to dec           ;<br />fstp LdTotaltemp1 ; store into the double       ;<br /><br />mov eax, pFREEBITS         ;8x bit total<br />fld LdTotaltemp1            ;<br />fld NU8<br />fmul<br />fstp QWORD PTR &#91;eax&#93;<br /><br />fld QWORD PTR &#91;eax&#93; <br />mov eax, pFREE8GB<br />fld NU1024<br />fdiv<br />fstp LdTotaltemp4<br />fld LdTotaltemp4 <br />fld NU1024<br />fdiv<br />fstp LdTotaltemp4<br />fld LdTotaltemp4 <br />fld NU1024<br />fdiv<br />fstp QWORD PTR &#91;eax&#93;<br /><br />fld QWORD PTR &#91;eax&#93;<br />fld NU8<br />fdiv<br />mov eax, pFREEGB<br />fstp QWORD PTR &#91;eax&#93;<br /><br />;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br /><br />mov eax, pUSED<br />fld QWORD PTR &#91;eax&#93;<br />fstp LdTotaltemp5<br /><br />mov eax, pUSEDBITS         ;8x bit total<br />fld LdTotaltemp5            ;<br />fld NU8<br />fmul<br />fstp QWORD PTR &#91;eax&#93;<br /><br />fld QWORD PTR &#91;eax&#93; <br />mov eax, pUSED8GB<br />fld NU1024<br />fdiv<br />fstp LdTotaltemp4<br />fld LdTotaltemp4 <br />fld NU1024<br />fdiv<br />fstp LdTotaltemp4<br />fld LdTotaltemp4 <br />fld NU1024<br />fdiv<br />fstp QWORD PTR &#91;eax&#93;<br /><br />fld QWORD PTR &#91;eax&#93;<br />fld NU8<br />fdiv<br />mov eax, pUSEDGB<br />fstp QWORD PTR &#91;eax&#93;<br />;;;;;;;;;;;;;;;;;;;;;;;;<br />mov eax, pFREE<br />fld  QWORD PTR &#91;eax&#93;<br />mov eax, pUSED<br />fld  QWORD PTR &#91;eax&#93;<br />fdiv<br />mov eax, pFREEPERCENT<br />fstp QWORD PTR &#91;eax&#93;<br />fld QWORD PTR &#91;eax&#93;<br />fld NU100<br />fmul<br />fstp  QWORD PTR &#91;eax&#93;<br /><br />mov eax, ppTOTAL<br />fld  QWORD PTR &#91;eax&#93;<br />mov eax, pUSED<br />fld  QWORD PTR &#91;eax&#93;<br />fdivr<br />mov eax, pUSEDPERCENT<br />fstp QWORD PTR &#91;eax&#93;<br />fld QWORD PTR &#91;eax&#93;<br />fld NU100<br />fmul<br />fstp  QWORD PTR &#91;eax&#93;<br /><br />mov eax,1; put 1 into return&#40;true&#41;<br />ret ; clean stack and return<br />getallspaces EndP<br /></code></pre></div>
    <div class="meta">Posted on 2002-04-17 20:36:06 by Qages</div>
   </div>
   <div class="post" id="post-33918">
    <div class="subject"><a href="#post-33918">Bored? helpme optimize this code for speed</a></div>
    <div class="body">There is PLENTY of room for improvement here, I tried at work just now, but I kept getting lost (turning from proper work to this &amp; back was very confusing :( ).<br /><br />I will look at it properly tonight, but first off you can save so much time &amp; space using fst rather than fstp/fld the same data again. Why take data off the stack, then put it back on again?<br /><br />Mirno</div>
    <div class="meta">Posted on 2002-04-18 05:29:15 by Mirno</div>
   </div>
   <div class="post" id="post-33962">
    <div class="subject"><a href="#post-33962">Bored? helpme optimize this code for speed</a></div>
    <div class="body">I think, that here it is better to use integer arithmetic. It is necessary to replace divisions on shifts.</div>
    <div class="meta">Posted on 2002-04-18 14:06:14 by Nexo</div>
   </div>
   <div class="post" id="post-33965">
    <div class="subject"><a href="#post-33965">Bored? helpme optimize this code for speed</a></div>
    <div class="body">How often is this going to be called, and is the overhead of your code<br />noticeable compared to the etDiskFreeSpaceEx call?</div>
    <div class="meta">Posted on 2002-04-18 14:45:46 by f0dder</div>
   </div>
   <div class="post" id="post-33968">
    <div class="subject"><a href="#post-33968">Re: Bored? helpme optimize this code for speed</a></div>
    <div class="body">change <br /><br /><pre><code><br />mov eax,1; put 1 into return&#40;true&#41;<br /></code></pre> <br /><br />to<br /><br /><pre><code><br />xor eax, eax<br />inc eax<br /></code></pre> <br /><br />:grin: :stupid:</div>
    <div class="meta">Posted on 2002-04-18 14:58:40 by bazik</div>
   </div>
   <div class="post" id="post-33972">
    <div class="subject"><a href="#post-33972">Bored? helpme optimize this code for speed</a></div>
    <div class="body">it will prob be called every 250ms, defalut to 500ms, i dont know how fast it takes to execute it, and how would i use fst???<br /><br />hmm seems to execute this code very fast, turns up as 0 ms in asm, even in vb when calling gettickcount, i need a more pricise mesurement, any api for this???</div>
    <div class="meta">Posted on 2002-04-18 15:54:21 by Qages</div>
   </div>
   <div class="post" id="post-33975">
    <div class="subject"><a href="#post-33975">Bored? helpme optimize this code for speed</a></div>
    <div class="body">What I'm trying to say is... this code doesn't really look like anything<br />speedcritical, so it's really a waste optimizing it. Of course optimizing<br />can be fun, and you can learn something even from optimizing this,<br />but there's better areas to optimize :).<br /><br />There's roughly 112 instructions between the API call and the ret. Let's<br />just for fun assume that each instruction takes 100 clock cycles, this<br />would total in 11200 cycles for the code (should be quite less in practice ;)).<br />Even a lowly 166mhz has ~166000000 cycles/second, so it would be able to<br />execute your code roughly 14800 times per second. These figures should of<br />course be taken with a grain of salt, as there's a LOT of stuff going on<br />in a multitasking operating system, processors aren't totally straightforward,<br />I haven't slept quite enough last night (et cetera). Point is, your code<br />should be quite fast enough.<br /><br />I wonder how many cycles the API call will take. I guess it involves some<br />ioctls which involve kernel transitions which are quite expensive. Wouldn't<br />be surprised if it takes quite an amount of cycles more than your calc code.<br />Again, doesn't really matter for this code.<br /><br />So, what's the point of this post? Not to keep you from optimizing - but to<br />remind you of &quot;the bigger picture&quot;. It's easy to get lost and want to optimize<br />every little piece of your programs and possibly end up never getting any<br />work done. Imo, it's about just as important knowing what to spend your time<br />on and what to &quot;get done&quot; as it is to be good at squeezing clock cycles.</div>
    <div class="meta">Posted on 2002-04-18 17:05:37 by f0dder</div>
   </div>
   <div class="post" id="post-33987">
    <div class="subject"><a href="#post-33987">Bored? helpme optimize this code for speed</a></div>
    <div class="body">Let's not qeustion in this section if speed is matter, please.<br />It's section for training of creation effective code. Even assuming that there might be sence in your words from general point of view, disscussion of speed problem in given example is one good material to exchange ideas and train your brain.<br />If we every time when we need to learn of implementing algo we<br />disscuss if we need to do it in the first place while here is some API we would never learn to make algos.<br />This section for creation and understanding, that all I have to say.</div>
    <div class="meta">Posted on 2002-04-18 17:40:45 by The Svin</div>
   </div>
   <div class="post" id="post-34016">
    <div class="subject"><a href="#post-34016">Bored? helpme optimize this code for speed</a></div>
    <div class="body">I go with Alex here, we have an algo section so that people can tweak or improve algorithms for whatever use they may have for it. f0dder has a good point that some code may not be worth the effort in terms of the bigger picture but if the author want it faster for some reason, I guess they have made their decisions about what matters in the bigger picture and need the extra speed.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-04-19 02:28:08 by hutch--</div>
   </div>
   <div class="post" id="post-34020">
    <div class="subject"><a href="#post-34020">Bored? helpme optimize this code for speed</a></div>
    <div class="body"><strong>Qages</strong> fst is a floating point store, fstp is store and pop.<br /><br />fst X &lt;- stores ST(0) in X, ST(0) stays the same.<br />fstp x &lt;- stores ST(0) in X, but ST(0) is removed from the floating point stack.<br /><br />By not doing the pop, you don't have to reload it again!<br /><br />So you can replace:<br /><pre><code><br />  fld QWORD PTR &#91;eax&#93;<br />  mov eax, pTOTAL8GB<br />  fld NU1024<br />  fdiv<br />  fstp LdTotaltemp3<br />  fld LdTotaltemp3 <br />  fld NU1024<br />  fdiv<br />  fstp LdTotaltemp3<br />  fld LdTotaltemp3 <br />  fld NU1024<br />  fdiv<br />  fstp QWORD PTR &#91;eax&#93;<br />  fld QWORD PTR &#91;eax&#93;<br />  fld NU8<br />  fdiv<br />  mov eax, pTOTALGB<br />  fstp QWORD PTR &#91;eax&#93;<br /></code></pre><br /><br />with:<br /><pre><code><br />  fld QWORD PTR &#91;eax&#93;<br />  mov eax, pTOTAL8GB<br />  fld NU1024<br />  fdiv<br />  fld NU1024<br />  fdiv<br />  fld NU1024<br />  fdiv<br />  fst QWORD PTR &#91;eax&#93;<br />  fld NU8<br />  fdiv<br />  mov eax, pTOTALGB<br />  fstp QWORD PTR &#91;eax&#93;<br /></code></pre><br />And they are identical.<br /><br />This should give a pretty big saving in both speed and code size<br /><br />Mirno<br /><br />Mirno</div>
    <div class="meta">Posted on 2002-04-19 03:30:01 by Mirno</div>
   </div>
   <div class="post" id="post-34030">
    <div class="subject"><a href="#post-34030">Bored? helpme optimize this code for speed</a></div>
    <div class="body">Did I say he shouldn't optimize it? No. I just said look at the bigger<br />picture. Why? Because, judging by previous posts, Qages is a beginner<br />(nothing bad in that, we've all been there). If Svin would care to<br />re-read my post, it says:<br /><div class="quote"><br />Of course optimizing can be fun, and you can learn something<br />even from optimizing this<br /></div></div>
    <div class="meta">Posted on 2002-04-19 07:28:32 by f0dder</div>
   </div>
   <div class="post" id="post-34042">
    <div class="subject"><a href="#post-34042">Bored? helpme optimize this code for speed</a></div>
    <div class="body">OK f0dder,<br />forget it :)</div>
    <div class="meta">Posted on 2002-04-19 09:54:31 by The Svin</div>
   </div>
   <div class="post" id="post-34050">
    <div class="subject"><a href="#post-34050">Bored? helpme optimize this code for speed</a></div>
    <div class="body"><pre><code><br />align 8<br />NU2p30r		real8 1.0/1024/1024/1024<br />NU8m2p30r	real8 1.0/8/1024/1024/1024<br />NU8		real4 8.0<br />NU100		real4 100.0<br /><br />	fild &#91;Dppfree&#93;<br />	fild &#91;Dpptotal&#93;<br />	fld st&#40;1&#41;<br />	mov eax,&#91;pFREE&#93;<br />	fst &#91;real8 eax&#93;<br />	fld st&#40;1&#41;<br />	mov eax,&#91;pTOTAL&#93;<br />	fst &#91;real8 eax&#93;<br />	fsubr<br />	mov eax,&#91;pUSED&#93;<br />	fstp &#91;real8 eax&#93;<br /><br />macro Calc val,pFree,pTotal,pUsed<br />	fld st&#40;1&#41;<br />	fld st&#40;1&#41;<br />	fld &#91;val&#93;<br />	fmul st&#40;2&#41;,st<br />	fmul<br />	mov eax,&#91;pFree&#93;<br />	fst &#91;real8 eax&#93;<br />	fxch st&#40;1&#41;<br />	mov eax,&#91;pTotal&#93;<br />	fst &#91;real8 eax&#93;<br />	fsub<br />	mov eax,&#91;pUsed&#93;<br />	fstp &#91;real8 eax&#93;<br />endm<br />	Calc NU8,pFREEBITS,pTOTALBITS,pUSEDBITS<br />	Calc NU2p30r,pFREE8GB,pTOTAL8GB,pUSED8GB<br />	Calc NU8m2p30r,pFREEGB,pTOTALGB,pUSEDGB<br /><br />	fdiv<br />	fld &#91;NU100&#93;<br />	fmul st&#40;1&#41;,st<br />	fsub st,st&#40;1&#41;<br />	mov eax,&#91;pUSEDPERCENT&#93;<br />	fstp &#91;real8 eax&#93;<br />	mov eax,&#91;pFREEPERCENT&#93;<br />	fstp &#91;real8 eax&#93;<br /></code></pre><br /><br />Care of such quantities of parameters it is better to use one pointer on structure.</div>
    <div class="meta">Posted on 2002-04-19 12:17:42 by Nexo</div>
   </div>
   <div class="post" id="post-34057">
    <div class="subject"><a href="#post-34057">Bored? helpme optimize this code for speed</a></div>
    <div class="body">this is what i have so far<br /><br /><pre><code><br />getallspaces Proc,pcdrivePTR&#58;DWORD,ppTOTAL&#58;DWORD,pFREE&#58;DWORD,pUSED&#58;DWORD,pTOTALBITS&#58;DWORD,pTOTALGB&#58;DWORD, <br />pTOTAL8GB&#58;DWORD,pFREEBITS&#58;DWORD,pFREEGB&#58;DWORD,pFREE8GB&#58;DWORD,pUSEDBITS&#58;DWORD,pUSED8GB&#58;DWORD,pUSEDGB&#58;DWORD,<br />pFREEPERCENT&#58;DWORD,pUSEDPERCENT&#58;DWORD<br /><br /><br />Local LdTotaltemp2&#58;REAL8<br />Local LdTotaltemp3&#58;REAL8<br />Local LdTotaltemp4&#58;REAL8<br />Local LdTotaltemp5&#58;REAL8<br />Local LdTotaltemp1&#58;REAL8<br />Local Dpptotal&#58;QWORD<br />Local Dppfree&#58;QWORD<br />Invoke GetDiskFreeSpaceEx, pcdrivePTR, Addr Dppfree, Addr Dpptotal,NULL <br />mov eax, ppTOTAL <br />mov ecx, pFREE	 <br />mov ebx, pUSED <br />fild Dpptotal <br />fst QWORD PTR &#91;eax&#93; <br />fstp LdTotaltemp2 <br />fild Dppfree<br />fst QWORD PTR &#91;ecx&#93;<br />fst LdTotaltemp1 <br />fld LdTotaltemp2 <br />fsubr<br />fstp QWORD PTR &#91;ebx&#93;<br />fld LdTotaltemp2      <br />fld NU8<br />fmul<br />mov eax, pTOTALBITS<br />fst QWORD PTR &#91;eax&#93;<br />fld NU1024<br />fdiv<br />fld NU1024<br />fdiv<br />fld NU1024<br />fdiv<br />mov eax, pTOTAL8GB<br />fst QWORD PTR &#91;eax&#93;<br />fld NU8<br />fdiv<br />mov eax, pTOTALGB<br />fstp QWORD PTR &#91;eax&#93;<br />fld LdTotaltemp1   <br />fld NU8<br />fmul<br />mov eax, pFREEBITS      <br />fst QWORD PTR &#91;eax&#93;<br />fld NU1024<br />fdiv<br />fld NU1024<br />fdiv<br />fld NU1024<br />fdiv<br />mov eax, pFREE8GB<br />fst QWORD PTR &#91;eax&#93;<br />fld NU8<br />fdiv<br />mov eax, pFREEGB<br />fstp QWORD PTR &#91;eax&#93;<br />fld QWORD PTR &#91;ebx&#93;<br />fld NU8<br />fmul<br />mov eax, pUSEDBITS<br />fst QWORD PTR &#91;eax&#93; <br />fld NU1024<br />fdiv<br />fld NU1024<br />fdiv<br />fld NU1024<br />fdiv<br />mov eax, pUSED8GB<br />fst QWORD PTR &#91;eax&#93;<br />fld NU8<br />fdiv<br />mov eax, pUSEDGB<br />fstp QWORD PTR &#91;eax&#93;<br />fld  QWORD PTR &#91;ecx&#93;<br />fld  QWORD PTR &#91;ebx&#93;<br />fdiv<br />mov eax, pFREEPERCENT<br />fld NU100<br />fmul<br />fstp  QWORD PTR &#91;eax&#93;<br />mov eax, ppTOTAL<br />fld  QWORD PTR &#91;eax&#93;<br />fld  QWORD PTR &#91;ebx&#93;<br />fdivr<br />mov eax, pUSEDPERCENT<br />fld NU100<br />fmul<br />fstp  QWORD PTR &#91;eax&#93;<br />xor eax, eax<br />inc eax<br />ret ; clean stack and return<br />getallspaces EndP<br /></code></pre></div>
    <div class="meta">Posted on 2002-04-19 15:23:59 by Qages</div>
   </div>
  </div>
 </body>
</html>