<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>WM_MOUSEMOVE handling brings down my PC - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=9422" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=9422">WM_MOUSEMOVE handling brings down my PC</a></p>
   <div class="post" id="post-69758">
    <div class="subject"><a href="#post-69758">WM_MOUSEMOVE handling brings down my PC</a></div>
    <div class="body">I have this problem, this code crashes as soon as it gets mouse focus, the crash occurs when I process the WM_MOUSEMOVE, if I remove the &quot;Bug Code&quot; the program runns ok (no crash).<br />I can't figure out why it crashes (except it has something to do with  and edi), it only now it crashes when I try to read the value of  to edi and the window has the mouseover it.<br /><br />The red code is an attempt to mov  to edi, via eax. When I used this instead of the first blue code line the computer crashed hard (Black Screen of Death with a dark stripe on the top of the screen). I tried to run it twice and the same crash occured...<br /><br /><pre><code>&#91;size=9&#93;&#91;COLOR=#404040&#93;...&#91;/COLOR&#93;<br />proc WndProc, hWnd,uMsg,wParam,lParam<br />    hdc dd ?<br />    ps PAINTSTRUCT<br />    hfont dd ?<br />        enter<br />        mov     eax, &#91;uMsg&#93;<br />        cmp     eax, WM_DESTROY<br />        jne     @F<br />                &#91;COLOR=#404040&#93;...&#91;/COLOR&#93;<br />        jmp     WndProcEnd<br />@@&#58;     cmp     eax, WM_PAINT<br />        jne     @F<br />                &#91;COLOR=#404040&#93;...&#91;/COLOR&#93;<br />        jmp     WndProcEnd<br />@@&#58; <br />; &lt;!&gt; Bug Code Starts Here &lt;!&gt;<br />       cmp     eax, WM_MOUSEMOVE<br />        jne     @F<br />                ;xPos = LOWORD&#40;lParam&#41;;  // horizontal position of cursor<br />                ;yPos = HIWORD&#40;lParam&#41;;  // vertical position of cursor<br />                mov     eax, &#91;lParam&#93;<br />                movzx   ebx, ax         ; ebx = Xpos<br />                shr     eax, 16         ; eax = Ypos<br /><br /><br />&#91;COLOR=red&#93;&#91;b&#93;; These lines must never ever be uncommented!!!<br />; my PC crashed twice when I tried to run those two lines&#58;<br />;...........xchg    eax, edi<br />;...........mov     eax, &#91;Ypos&#93;<br />;...........xchg    eax, edi&#91;/B&#93;&#91;/COLOR&#93;<br /><br />&#91;COLOR=blue&#93;<br />                mov     edi, &#91;Ypos&#93;   ; &lt;-- OllyDbg says it's here it crashes when uncommented, and it just crashes here<br />                mov     esi, &#91;Xpos&#93;<br />                mov     &#91;Ypos&#93;, eax<br />                mov     &#91;Xpos&#93;, ebx<br />&#91;/COLOR&#93;<br />                invoke  GetDC,&#91;hWnd&#93;<br />                mov     ebx, eax<br /><br />                ;mov     dword &#91;hDCCC&#93;, eax<br />                ;call    DrawArrow ; call an arrow-drawing function<br /><br />                invoke  ReleaseDC, &#91;hWnd&#93;, ebx<br /><br />                mov     &#91;Ypos&#93;, edi<br />                mov     &#91;Xpos&#93;, esi<br /><br />        jmp     WndProcEnd<br />; &lt;!&gt; Bug Code Ends Here &lt;!&gt;<br />@@&#58;     ;     .else<br />                invoke  DefWindowProc, &#91;hWnd&#93;,&#91;uMsg&#93;,&#91;wParam&#93;,&#91;lParam&#93;<br />                return<br />WndProcEnd&#58;   ;     .endif<br />        xor    eax,eax<br />        return<br />;------------------------------------------------------------------------<br />section '.data' data readable writeable<br />Xpos    dd 50+75<br />Ypos    dd 50+50-1          <br />&#91;COLOR=#404040&#93;...&#91;/COLOR&#93;                    <br />&#91;/SIZE&#93;</code></pre></div>
    <div class="meta">Posted on 2002-12-07 14:05:04 by scientica</div>
   </div>
   <div class="post" id="post-69759">
    <div class="subject"><a href="#post-69759">WM_MOUSEMOVE handling brings down my PC</a></div>
    <div class="body">You have to preserve <strong>ebx esi edi</strong>:<br /><pre><code>...<br />proc WndProc, hWnd,uMsg,wParam,lParam<br />    hdc dd ?<br />    ps PAINTSTRUCT<br />    hfont dd ?<br />        enter<br />        mov     eax, &#91;uMsg&#93;<br />        cmp     eax, WM_DESTROY<br />        jne     @F<br />                ...<br />        jmp     WndProcEnd<br />@@&#58;     cmp     eax, WM_PAINT<br />        jne     @F<br />                ...<br />        jmp     WndProcEnd<br />@@&#58;<br />; &lt;!&gt; Bug Code Starts Here &lt;!&gt;<br />       cmp     eax, WM_MOUSEMOVE<br />        jne     @F<br />                push ebx<br />                push esi<br />                push edi<br />                ;xPos = LOWORD&#40;lParam&#41;;  // horizontal position of cursor<br />                ;yPos = HIWORD&#40;lParam&#41;;  // vertical position of cursor<br />                mov     eax, &#91;lParam&#93;<br />                movzx   ebx, ax         ; ebx = Xpos<br />                shr     eax, 16         ; eax = Ypos<br /><br /><br />; These lines must never ever be uncommented!!!<br />; my PC crashed twice when I tried to run those two lines&#58;<br />;...........xchg    eax, edi<br />;...........mov     eax, &#91;Ypos&#93;<br />;...........xchg    eax, edi<br /><br /><br />                mov     edi, &#91;Ypos&#93;   ; &lt;-- OllyDbg says it's here it crashes when uncommented, and it just crashes here<br />                mov     esi, &#91;Xpos&#93;<br />                mov     &#91;Ypos&#93;, eax<br />                mov     &#91;Xpos&#93;, ebx<br /><br />                invoke  GetDC,&#91;hWnd&#93;<br />                mov     ebx, eax<br /><br />                ;mov     dword &#91;hDCCC&#93;, eax<br />                ;call    DrawArrow ; call an arrow-drawing function<br /><br />                invoke  ReleaseDC, &#91;hWnd&#93;, ebx<br /><br />                mov     &#91;Ypos&#93;, edi<br />                mov     &#91;Xpos&#93;, esi<br />                pop edi<br />                pop esi<br />                pop ebx<br />        jmp     WndProcEnd<br />; &lt;!&gt; Bug Code Ends Here &lt;!&gt;<br />@@&#58;     ;     .else<br />                invoke  DefWindowProc, &#91;hWnd&#93;,&#91;uMsg&#93;,&#91;wParam&#93;,&#91;lParam&#93;<br />                return<br />WndProcEnd&#58;   ;     .endif<br />        xor    eax,eax<br />        return<br />;------------------------------------------------------------------------<br />section '.data' data readable writeable<br />Xpos    dd 50+75<br />Ypos    dd 50+50-1<br />...</code></pre></div>
    <div class="meta">Posted on 2002-12-07 14:28:25 by comrade</div>
   </div>
   <div class="post" id="post-69815">
    <div class="subject"><a href="#post-69815">WM_MOUSEMOVE handling brings down my PC</a></div>
    <div class="body">Ok, that solved it. Thaks comrade!<br /><br />Why didn't I see that? :o :stupid:</div>
    <div class="meta">Posted on 2002-12-08 05:52:18 by scientica</div>
   </div>
  </div>
 </body>
</html>