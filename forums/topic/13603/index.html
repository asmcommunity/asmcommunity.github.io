<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>W32 debug API - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=13603" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=13603">W32 debug API</a></p>
   <div class="post" id="post-105398">
    <div class="subject"><a href="#post-105398">W32 debug API</a></div>
    <div class="body">I have make a small test with the Iczelion's tutorial 28 and there is a problem. The aim is that, I would like to transform it on a procedure. I call twice the same procedure which using the Win32 Debug API. And the second time, that does not work. It seems that the resources stay in memory (I think). Can you help me, Please ?<br /><br /><br /><br />include \masm32\include\comdlg32.inc <br />include \masm32\include\user32.inc <br />includelib \masm32\lib\kernel32.lib <br />includelib \masm32\lib\comdlg32.lib <br />includelib \masm32\lib\user32.lib <br />.data <br />AppName db &quot;Win32 Debug Example no.1&quot;,0 <br />ofn OPENFILENAME &lt;&gt; <br />FilterString db &quot;Executable Files&quot;,0,&quot;*.exe&quot;,0 <br />             db &quot;All Files&quot;,0,&quot;*.*&quot;,0,0 <br />ExitProc db &quot;The debuggee exits&quot;,0 <br />NewThread db &quot;A new thread is created&quot;,0 <br />EndThread db &quot;A thread is destroyed&quot;,0 <br />ProcessInfo db &quot;File Handle: %lx &quot;,0dh,0Ah <br />            db &quot;Process Handle: %lx&quot;,0Dh,0Ah <br />            db &quot;Thread Handle: %lx&quot;,0Dh,0Ah <br />            db &quot;Image Base: %lx&quot;,0Dh,0Ah <br />            db &quot;Start Address: %lx&quot;,0 <br />.data? <br />buffer db 512 dup(?) <br />startinfo STARTUPINFO &lt;&gt; <br />pi PROCESS_INFORMATION &lt;&gt; <br />DBEvent DEBUG_EVENT &lt;&gt; <br />.code <br />start:<br />call DebugProc			; I call it twice<br />call DebugProc			; but nothing run here<br />invoke ExitProcess, 0<br /><br /><br /><br />DebugProc PROC near<br />  mov ofn.lStructSize,sizeof ofn <br />  mov ofn.lpstrFilter, offset FilterString <br />  mov ofn.lpstrFile, offset buffer <br />  mov ofn.nMaxFile,512 <br />  mov ofn.Flags, OFN_FILEMUSTEXIST or OFN_PATHMUSTEXIST or OFN_LONGNAMES or OFN_EXPLORER or OFN_HIDEREADONLY <br />  invoke GetOpenFileName, ADDR ofn <br />  .if eax==TRUE <br />  invoke GetStartupInfo,addr startinfo <br />  invoke CreateProcess, addr buffer, NULL, NULL, NULL, FALSE, DEBUG_PROCESS+ DEBUG_ONLY_THIS_PROCESS, NULL, NULL, addr startinfo, addr pi <br />  .while TRUE <br />     invoke WaitForDebugEvent, addr DBEvent, INFINITE <br />     .if DBEvent.dwDebugEventCode==EXIT_PROCESS_DEBUG_EVENT <br />         invoke MessageBox, 0, addr ExitProc, addr AppName, MB_OK+MB_ICONINFORMATION <br />         .break <br />     .elseif DBEvent.dwDebugEventCode==CREATE_PROCESS_DEBUG_EVENT <br />         invoke wsprintf, addr buffer, addr ProcessInfo, DBEvent.u.CreateProcessInfo.hFile, DBEvent.u.CreateProcessInfo.hProcess, DBEvent.u.CreateProcessInfo.hThread, DBEvent.u.CreateProcessInfo.lpBaseOfImage, DBEvent.u.CreateProcessInfo.lpStartAddress <br />         invoke MessageBox,0, addr buffer, addr AppName, MB_OK+MB_ICONINFORMATION    <br />     .elseif DBEvent.dwDebugEventCode==EXCEPTION_DEBUG_EVENT <br />         .if DBEvent.u.Exception.pExceptionRecord.ExceptionCode==EXCEPTION_BREAKPOINT <br />            invoke ContinueDebugEvent, DBEvent.dwProcessId, DBEvent.dwThreadId, DBG_CONTINUE <br />           .continue <br />         .endif <br />     .elseif DBEvent.dwDebugEventCode==CREATE_THREAD_DEBUG_EVENT <br />         invoke MessageBox,0, addr NewThread, addr AppName, MB_OK+MB_ICONINFORMATION <br />     .elseif DBEvent.dwDebugEventCode==EXIT_THREAD_DEBUG_EVENT <br />         invoke MessageBox,0, addr EndThread, addr AppName, MB_OK+MB_ICONINFORMATION <br />     .endif <br />     invoke ContinueDebugEvent, DBEvent.dwProcessId, DBEvent.dwThreadId, DBG_EXCEPTION_NOT_HANDLED <br />  .endw<br />     ;invoke TerminateThread, pi.hThread, NULL<br />     ;invoke TerminateProcess, pi.hProcess, NULL<br />  invoke CloseHandle,pi.hProcess <br />  invoke CloseHandle,pi.hThread <br />  .endif <br />ret<br />DebugProc ENDP<br /><br /><br />end start<br /></div>
    <div class="meta">Posted on 2003-05-30 07:41:39 by Morg@tte</div>
   </div>
  </div>
 </body>
</html>