<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Macro function problem - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=1418" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=1418">Macro function problem</a></p>
   <div class="post" id="post-9100">
    <div class="subject"><a href="#post-9100">Macro function problem</a></div>
    <div class="body">Hi, people!<br />I try to write macro function to simplify the call like this (C style):<br /><br /><pre><code><br />SetViewportOrgEx &#40;hdc, cxClient / 2, cyClient / 2, NULL&#41; ;<br /></code></pre><br /><br />The simplest version (actually it's much more complex) of my macro function is:<br /><br /><pre><code><br />$DIV MACRO Dividend&#58;REQ, Divisor&#58;REQ<br /><br />  IF &#40;OPATTR &#40;Divisor&#41;&#41; AND 00000100y<br />    ;; Divisor is an immediate value<br />    IF Divisor EQ 2<br />      shr Dividend, 1<br />    ENDIF<br />  ENDIF<br /><br />  EXITM &lt;eax&gt;<br />ENDM<br /></code></pre><br /><br /><br />Then i call SetViewportOrgEx to times this way:<br /><br /><pre><code><br />push NULL<br />push $DIV&#40;cyClient, 2&#41;<br />push $DIV&#40;cxClient, 2&#41;<br />push hdc<br />call SetViewportOrgEx<br /><br />invoke  SetViewportOrgEx, hdc, $DIV&#40;cxClient, 2&#41;, $DIV&#40;cyClient, 2&#41;, NULL<br /></code></pre><br /><br />The first call assembles to this, and this is exactly what might be expected:<br /><pre><code><br />.text&#58;0040115E                 push    NULL<br />.text&#58;00401160                 mov     eax, cyClient<br />.text&#58;00401165                 shr     eax, 1<br />.text&#58;00401167                 push    eax<br />.text&#58;00401168                 mov     eax, cxClient<br />.text&#58;0040116D                 shr     eax, 1<br />.text&#58;0040116F                 push    eax<br />.text&#58;00401170                 push    &#91;ebp+hdc&#93;<br />.text&#58;00401173                 call    SetViewportOrgEx<br /></code></pre><br /><br />But the second one assembles to this :-(<br /><pre><code><br />.text&#58;00401179                 mov     eax, cxClient<br />.text&#58;0040117E                 shr     eax, 1<br />.text&#58;00401180                 mov     eax, cyClient<br />.text&#58;00401185                 shr     eax, 1<br />.text&#58;00401187                 push    NULL<br />.text&#58;00401189                 push    eax<br />.text&#58;0040118A                 push    eax<br />.text&#58;0040118B                 push    &#91;ebp+hdc&#93;<br />.text&#58;0040118E                 call    SetViewportOrgEx<br /></code></pre><br /><br />My question is:<br /><span style="font-size:24px><strong>What i have to do to make this macro expand in proper way?</strong></span><br /><br /><br />Any ideas, please.<br />Thnx.</div>
    <div class="meta">Posted on 2001-10-10 10:09:06 by MacroFan</div>
   </div>
   <div class="post" id="post-9101">
    <div class="subject"><a href="#post-9101">Macro function problem</a></div>
    <div class="body">Oops, sorry.<br />The macro is:<br /><br /><pre><code><br />$DIV MACRO Dividend&#58;REQ, Divisor&#58;REQ<br /><br />  IF &#40;OPATTR &#40;Divisor&#41;&#41; AND 00000100y<br />    ;; Divisor is an immediate value<br />    IF Divisor EQ 2<br />      mov eax, Dividend<br />      shr eax, 1<br />    ENDIF<br />  ENDIF<br /><br />  EXITM &lt;eax&gt;<br />ENDM<br /></code></pre></div>
    <div class="meta">Posted on 2001-10-10 10:13:09 by MacroFan</div>
   </div>
   <div class="post" id="post-9113">
    <div class="subject"><a href="#post-9113">Macro function problem</a></div>
    <div class="body">would be a very nice feature but is impossible with the build in invoke macro. But you can write your own &quot;invoke&quot;.<br /><br />japheth</div>
    <div class="meta">Posted on 2001-10-10 11:19:52 by japheth</div>
   </div>
   <div class="post" id="post-9119">
    <div class="subject"><a href="#post-9119">Macro function problem</a></div>
    <div class="body">Hmm... May be you are right, but how about this.<br /><br />My custom macro without INVOKE:<br /><pre><code><br />_CALL MACRO arglist&#58;VARARG<br /><br />local n, arg<br /><br />  n TEXTEQU @ArgCount&#40; &lt;arglist&gt; &#41;<br />  % FOR arg, @ArgRev&#40; &lt;arglist&gt; &#41;<br />    n TEXTEQU %&#40;n - 1&#41;<br />    IF n EQ 0<br />      call arg<br />    ELSE<br />      push arg<br />    ENDIF<br />  ENDM<br />ENDM<br /></code></pre><br /><br /><br />And this call,<br /><pre><code><br />_CALL  SetViewportOrgEx, hdc, $DIV&#40;g_cxClient, 2&#41;, $DIV&#40;g_cyClient, 2&#41;, NULL<br /></code></pre><br /><br /><br />assembles to this:<br /><pre><code><br />.text&#58;00401197                 mov     eax, cyClient<br />.text&#58;0040119C                 shr     eax, 1<br />.text&#58;0040119E                 mov     eax, cxClient<br />.text&#58;004011A3                 shr     eax, 1<br />.text&#58;004011A5                 push    NULL<br />.text&#58;004011A7                 push    eax<br />.text&#58;004011A8                 push    eax<br />.text&#58;004011A9                 push    &#91;ebp+hdc&#93;<br />.text&#58;004011AC                 call    SetViewportOrgEx<br /></code></pre><br /><br /><br />Exactly the same as with invoke, but <strong>there is no invoke at all</strong>.</div>
    <div class="meta">Posted on 2001-10-10 12:19:41 by MacroFan</div>
   </div>
   <div class="post" id="post-9124">
    <div class="subject"><a href="#post-9124">Macro function problem</a></div>
    <div class="body">If you place &lt;ECHO arglist&gt; at the begining of the _CALL,<br />you'll see that MASM passes arglist to the _CALL this way:<br /><br /><pre><code><br />SetViewportOrgEx,hdc,eax,eax,NULL<br /></code></pre><br /><br />It means that two $DIV macros are already expanded.<br />So, the sequence is:<br /><pre><code><br />Expand $DIV<br />Expand $DIV<br />Expand _CALL<br /></code></pre><br /><br />My goal to enforce MASM do it this way:<br /><pre><code><br />Expand _CALL<br />&#123;<br />  Expand $DIV<br />  Expand $DIV<br />&#125;<br /></code></pre><br /><br />My guess that i can achieve my goal, only if i'll pass arglist to _CALL as one text argument.<br />Something like this:<br /><pre><code><br />_CALL &quot;SetViewportOrgEx, hdc, $DIV&#40;cxClient, 2&#41;, $DIV&#40;cyClient, 2&#41;, NULL&quot;<br /></code></pre><br /><br />But if i'll do so, i'll have to handle all parameters manually, character by character.<br />And i want avoid this. So, may be there is other simple method?</div>
    <div class="meta">Posted on 2001-10-10 13:00:53 by MacroFan</div>
   </div>
   <div class="post" id="post-9140">
    <div class="subject"><a href="#post-9140">Macro function problem</a></div>
    <div class="body">Another option might be to pass a register to the macro as the destination:<pre><code>invoke  SetViewportOrgEx, hdc, $DIV&#40;ecx, cxClient, 2&#41;, $DIV&#40;edx, cyClient, 2&#41;, NULL</code></pre><br />This makes the macro flexible enough to work around your problem.  Other uses present themselves: :)<pre><code>mov dxClient, $DIV&#40;ecx, cxClient, 2&#41;<br />mov dyClient, $DIV&#40;eax, cyClient, 2&#41;<br />mul ecx<br />mov cArea, eax</code></pre></div>
    <div class="meta">Posted on 2001-10-10 17:23:23 by bitRAKE</div>
   </div>
   <div class="post" id="post-9167">
    <div class="subject"><a href="#post-9167">Macro function problem</a></div>
    <div class="body">MacroFan,<br /><br />your _CALL macro is not bad, but to work correctly you must prevent MASM from evaluating the arguments before &quot;executing&quot; the macro. So instead of<br /><br /><pre><code><br />_CALL  SetViewportOrgEx, hdc, $DIV&#40;g_cxClient, 2&#41;, $DIV&#40;g_cyClient, 2&#41;, NULL<br /></code></pre><br /><br />code<br /><br /><pre><code><br />_CALL  SetViewportOrgEx, hdc, &lt;$DIV&#40;g_cxClient, 2&#41;&gt;,&lt; $DIV&#40;g_cyClient, 2&#41;&gt;, NULL<br /></code></pre><br /><br />japheth</div>
    <div class="meta">Posted on 2001-10-11 03:31:53 by japheth</div>
   </div>
   <div class="post" id="post-9168">
    <div class="subject"><a href="#post-9168">Macro function problem</a></div>
    <div class="body"><strong>2 bitRAKE</strong><br /><div class="quote">Another option might be to pass a register to the macro as the destination</div><br /><br />Not my goal. I don't want take care about destination registers.<br />Furthermore, there are too few of them. And what about this?<br /><br /><pre><code><br />_CALL StretchBlt, hdcDest,<br />			$ADD&#40;nXOriginDest, 100&#41;,<br />			$ADD&#40;nYOriginDest, 50&#41;,<br />			$DIV&#40;nWidthDest, 2&#41;,<br />			$DIV&#40;nHeightDest, 2&#41;,<br />			hdcSrc,<br />			$SUB&#40;nXOriginSrc, 20&#41;,<br />			$SUB&#40;nYOriginSrc, 80&#41;,<br />			$MUL&#40;nWidthSrc, 4&#41;,<br />			$MUL&#40;nHeightSrc, 4&#41;,<br />			SRCCOPY<br /></code></pre><br /><br />I want use only eax as destination,<br />and after each ($ADD, $DIV, $SUB, $MUL) macro evaluating push result on stack.<br /><br /><br /><br /><br /><strong>2 japheth</strong><br /><div class="quote">...you must prevent MASM from evaluating the arguments before &quot;executing&quot; the macro</div><br />Right, but does not work for me.<br />And this macro call <br /><pre><code><br />_CALL  SetViewportOrgEx, hdc, &lt;$DIV&#40;cxClient, 2&#41;&gt;, &lt;$DIV&#40;cyClient, 2&#41;&gt;, NULL<br /></code></pre><br />leads to this strange result :-(((<br /><pre><code><br />.text&#58;00401145                 mov     eax, cxClient<br />.text&#58;0040114A                 shr     eax, 1<br />.text&#58;0040114C                 mov     eax, cyClient<br />.text&#58;00401151                 shr     eax, 1<br />.text&#58;00401153                 mov     eax, cxClient<br />.text&#58;00401158                 shr     eax, 1<br />.text&#58;0040115A                 mov     eax, cyClient<br />.text&#58;0040115F                 shr     eax, 1<br />.text&#58;00401161                 mov     eax, cxClient<br />.text&#58;00401166                 shr     eax, 1<br />.text&#58;00401168                 mov     eax, cyClient<br />.text&#58;0040116D                 shr     eax, 1<br />.text&#58;0040116F                 push    NULL<br />.text&#58;00401171                 push    eax<br />.text&#58;00401172                 push    eax<br />.text&#58;00401173                 push    &#91;ebp+hdc&#93;<br />.text&#58;00401176                 call    SetViewportOrgEx<br /></code></pre></div>
    <div class="meta">Posted on 2001-10-11 04:06:42 by MacroFan</div>
   </div>
   <div class="post" id="post-9171">
    <div class="subject"><a href="#post-9171">Macro function problem</a></div>
    <div class="body">MacroFan,<br /><br />when using @ArgCount/@ArgRef, you are evaluating the parameters and this evaluation always generates code. When using this simple version of _CALL:<br /><br /><pre><code><br />	_CALL MACRO arg0&#58;REQ, arg1, arg2, arg3, arg4, arg5<br /><br />	  ifnb &lt;arg5&gt;<br />	    push arg5<br />	  endif<br />	  ifnb &lt;arg4&gt;<br />	    push arg4<br />	  endif<br />	  ifnb &lt;arg3&gt;<br />	    push arg3<br />	  endif<br />	  ifnb &lt;arg2&gt;<br />	    push arg2<br />	  endif<br />	  ifnb &lt;arg1&gt;<br />	    push arg1<br />	  endif<br /><br />	  call arg0<br />	ENDM<br /></code></pre><br /><br />all works fine.<br /><br />So just investigate a bit how to use VARARGS without evaluating the parms and you are done. Please post us your working solution!<br /><br />japheth</div>
    <div class="meta">Posted on 2001-10-11 05:22:02 by japheth</div>
   </div>
   <div class="post" id="post-9178">
    <div class="subject"><a href="#post-9178">Macro function problem</a></div>
    <div class="body">May be these macros will help You.<br /><br /><pre><code><br />@add macro v1&#58; REQ, v2&#58; REQ<br />    local res<br />    .data<br />    res dword ?<br />    .code<br />    push eax<br />    mov eax, v1<br />    add eax, v2<br />    mov res, eax<br />    pop eax<br />    exitm &lt;&amp;res&gt;<br />endm<br /><br />@div macro v1&#58; REQ, v2&#58; REQ<br />    local res<br />    .data<br />    res dword ?<br />    .code<br />    push edx<br />    push eax<br />    xor edx, edx<br />    mov eax, v1<br />    push v2<br />    pop res<br />    div res<br />    mov res, eax<br />    pop eax<br />    pop edx<br />    exitm &lt;&amp;res&gt;<br />endm<br /></code></pre></div>
    <div class="meta">Posted on 2001-10-11 06:34:31 by vkim</div>
   </div>
   <div class="post" id="post-9182">
    <div class="subject"><a href="#post-9182">Macro function problem</a></div>
    <div class="body"><strong>2 japheth</strong><br /><div class="quote">when using @ArgCount/@ArgRef, you are evaluating the parameters and this evaluation always generates code</div><br /><br />These are my @ArgCount and @ArgRev<br /><pre><code><br />@ArgCount MACRO arglist&#58;VARARG<br />    LOCAL count, arg, t<br />    count = 0<br />    FOR arg, &lt;arglist&gt;<br />        count = count + 1<br /><br />		;; t e s t<br />		t TEXTEQU %count<br />		% ECHO t<br />		;; t e s t<br /><br /><br />    ENDM  <br />    EXITM %count<br />ENDM<br /><br /><br />@ArgRev MACRO arglist<br />    LOCAL txt, arg<br />    txt TEXTEQU &lt;&gt;<br />%   FOR arg, &lt;arglist&gt;<br />        txt CATSTR &lt;arg&gt;, &lt;!,&gt;, txt<br />        <br />		;; t e s t<br />		% ECHO txt    <br />		;; t e s t<br />        <br />    ENDM<br /><br />    txt SUBSTR  txt, 1, @SizeStr&#40; %txt &#41; - 1<br />    txt CATSTR  &lt;!&lt;&gt;, txt, &lt;!&gt;&gt;<br />    EXITM txt<br />ENDM<br /></code></pre><br /><br />Lines labeled &quot;;; t e s t&quot; temporary added for test.<br />_CALL SetViewportOrgEx, hdc, &lt;$DIV(cxClient, 2)&gt;, &lt;$DIV(cyClient, 2)&gt;, NULL<br />echoes this:<br /><br /><br />ECHO from @ArgCount<br />1<br />2<br />3<br />4<br />5<br /><br />ECHO from @ArgRev<br />SetViewportOrgEx,<br />hdc,SetViewportOrgEx,<br />eax,hdc,SetViewportOrgEx,<br />eax,eax,hdc,SetViewportOrgEx,<br />NULL,eax,eax,hdc,SetViewportOrgEx,<br /><br /><br />I can see that parameters passed to @ArgRev are already evaluated.<br />May be i'm wrong, but in my oppinion that avaluation occurs not because of @ArgCount or @ArgRev.<br /><br /><br /><div class="quote">When using this simple version of _CALL all works fine.</div><br /><br />??? May be i'm beef-witted man, or you did't understand something, or something else.<br />But i renamed your version of macro to _CALL2 and assembled this three lines.<br /><br /><pre><code><br />invoke  SetViewportOrgEx, hdc, $DIV&#40;cxClient, 2&#41;, $DIV&#40;cyClient, 2&#41;, NULL<br />_CALL  SetViewportOrgEx, hdc, $DIV&#40;cxClient, 2&#41;, $DIV&#40;cyClient, 2&#41;, NULL<br />_CALL2  SetViewportOrgEx, hdc, $DIV&#40;cxClient, 2&#41;, $DIV&#40;cyClient, 2&#41;, NULL<br /></code></pre><br /><br />Below the result:<br /><pre><code><br />.text&#58;00401002                 mov     eax, cyClient<br />.text&#58;00401007                 shr     eax, 1<br />.text&#58;00401009                 mov     eax, cxClient<br />.text&#58;0040100E                 shr     eax, 1<br />.text&#58;00401010                 push    NULL<br />.text&#58;00401012                 push    eax<br />.text&#58;00401013                 push    eax<br />.text&#58;00401014                 push    hdc<br />.text&#58;0040101A                 call    SetViewportOrgEx<br />.text&#58;0040101F                 mov     eax, cyClient<br />.text&#58;00401024                 shr     eax, 1<br />.text&#58;00401026                 mov     eax, cxClient<br />.text&#58;0040102B                 shr     eax, 1<br />.text&#58;0040102D                 push    NULL<br />.text&#58;0040102F                 push    eax<br />.text&#58;00401030                 push    eax<br />.text&#58;00401031                 push    hdc<br />.text&#58;00401037                 call    SetViewportOrgEx<br />.text&#58;0040103C                 mov     eax, cyClient<br />.text&#58;00401041                 shr     eax, 1<br />.text&#58;00401043                 mov     eax, cxClient<br />.text&#58;00401048                 shr     eax, 1<br />.text&#58;0040104A                 push    NULL<br />.text&#58;0040104C                 push    eax<br />.text&#58;0040104D                 push    eax<br />.text&#58;0040104E                 push    hdc<br />.text&#58;00401054                 call    SetViewportOrgEx<br /></code></pre><br /><br /><strong>Can you see any difference?</strong> I can't.<br />Did you try to assemble it with your _CALL or it's only theoretical.<br />If it assembles for you as expected (with my $DIV of course), please let me know.<br /><br /><strong>2  vkim</strong><br />I'll try.</div>
    <div class="meta">Posted on 2001-10-11 07:28:42 by MacroFan</div>
   </div>
   <div class="post" id="post-9190">
    <div class="subject"><a href="#post-9190">Macro function problem</a></div>
    <div class="body">Spasibo, vkim! But though<br /><pre><code><br />_CALL  SetViewportOrgEx, hdc, @add&#40;cxClient, 2&#41;, @add&#40;cyClient, 4&#41;, NULL<br /></code></pre><br />assembles as expected<br /><pre><code><br />.text&#58;00401002             push eax<br />.text&#58;00401003             mov eax, cxClient<br />.text&#58;00401008             add eax, 2<br />.text&#58;0040100B             mov X, eax            ; mov X, @add&#40;cxClient, 2&#41;<br />.text&#58;00401010             pop eax<br />.text&#58;00401011             push eax<br />.text&#58;00401012             mov eax, cyClient<br />.text&#58;00401017             add eax, 4<br />.text&#58;0040101A             mov Y, eax            ; mov Y, @add&#40;cyClient, 4&#41;<br />.text&#58;0040101F             pop eax<br />.text&#58;00401020             push NULL<br />.text&#58;00401022             push Y<br />.text&#58;00401028             push X<br />.text&#58;0040102E             push hdc<br />.text&#58;00401034             call SetViewportOrgEx<br /></code></pre><br /><br />your macros didn't help me of course. Because of:<br /><strong><br />push eax<br />pop eax<br />push eax<br />pop eax<br />and two DWORD in .data section<br /></strong><br /><br />Too much for one simple call. Isn't it!?</div>
    <div class="meta">Posted on 2001-10-11 08:40:21 by MacroFan</div>
   </div>
   <div class="post" id="post-9195">
    <div class="subject"><a href="#post-9195">Macro function problem</a></div>
    <div class="body">MacroFan,<br /><br />itr wasnt theoretically. Heres an excerpt from my listing file:<br /><br /><pre><code><br />                    _CALL MACRO arg0&#58;REQ, arg1, arg2, arg3, arg4, arg5<br /><br />                      ifnb &lt;arg5&gt;<br />                        push arg5<br />                      endif<br />                      ifnb &lt;arg4&gt;<br />                        push arg4<br />                      endif<br />                      ifnb &lt;arg3&gt;<br />                        push arg3<br />                      endif<br />                      ifnb &lt;arg2&gt;<br />                        push arg2<br />                      endif<br />                      ifnb &lt;arg1&gt;<br />                        push arg1<br />                      endif<br /><br />                      call arg0<br />                    ENDM<br /><br />                $DIV MACRO Dividend&#58;REQ, Divisor&#58;REQ<br /><br />                  IF &#40;OPATTR &#40;Divisor&#41;&#41; AND 00000100y<br />                    <br />; Divisor is an immediate value<br />                    IF Divisor EQ 2<br />                      mov eax,Dividend<br />                      shr eax, 1<br />                    ENDIF<br />                  ENDIF<br /><br />                  EXITM &lt;eax&gt;<br />                ENDM<br /><br />                ;invoke  SetViewportOrgEx, hdc, $DIV&#40;cxClient, 2&#41;, $DIV&#40;cyClient, 2&#41;, NULL<br />                    _CALL  SetViewportOrgEx, hdc, &lt;$DIV&#40;cxClient, 2&#41;&gt;, &lt;$DIV&#40;cyClient, 2&#41;&gt;, NULL<br /> 00000000  6A 00         1          push NULL<br /> 00000002  A1 00000004 R     2        mov eax,cyClient<br /> 00000007  D1 E8         2        shr eax, 1<br /> 00000009  50            1          push $DIV&#40;cyClient, 2&#41;<br /> 0000000A  A1 00000000 R     2        mov eax,cxClient<br /> 0000000F  D1 E8         2        shr eax, 1<br /> 00000011  50            1          push $DIV&#40;cxClient, 2&#41;<br /> 00000012  FF 35 00000008 R  1          push hdc<br /> 00000018  FF 15 00000000 E  1        call SetViewportOrgEx<br /></code></pre><br /><br />In my eyes it looks correct. Dont forget the brackets.<br /><br />japheth</div>
    <div class="meta">Posted on 2001-10-11 10:02:39 by japheth</div>
   </div>
   <div class="post" id="post-9218">
    <div class="subject"><a href="#post-9218">Macro function problem</a></div>
    <div class="body"><strong>japheth</strong>, very nice!  Will be of use to me. :)  Yes, I see that you changed the point of evaluation by not using VARARG - clever!</div>
    <div class="meta">Posted on 2001-10-11 17:16:07 by bitRAKE</div>
   </div>
   <div class="post" id="post-9242">
    <div class="subject"><a href="#post-9242">Macro function problem</a></div>
    <div class="body">Hi, MacroFan!<br />I'm pleasently surprised with Your Russian! :)<br />Yes, my previous macros required too much resources. Ok, look at this:<br /><pre><code><br />.386<br />.model flat, stdcall<br />option casemap&#58; none<br /><br />include \masm32\include\windows.inc<br />include \masm32\include\oleaut32.inc<br />include \masm32\include\masm32.inc<br />include \masm32\include\user32.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\debug.inc<br /><br />includelib \masm32\lib\debug.lib<br />includelib \masm32\lib\oleaut32.lib<br />includelib \masm32\lib\user32.lib<br />includelib \masm32\lib\masm32.lib<br />includelib \masm32\lib\kernel32.lib<br /><br />i = 0<br /><br />TestFunc proto &#58;dword, &#58;dword, &#58;dword, &#58;dword<br /><br />@add macro v1&#58; REQ, v2&#58; REQ<br />    local idx<br />    i = i + 1<br />    if i eq 1<br />        mov eax, esp<br />    endif<br />    sub esp, 8<br />    idx = i * 4<br />    mov dword ptr &#91;esp+idx&#93;, v1<br />    add dword ptr &#91;esp+idx&#93;, v2<br />    exitm &lt;dword ptr &#91;eax-&amp;idx&#93;&gt;<br />endm<br /><br /><br />$call macro function&#58; REQ, args&#58; VARARG<br />    invoke function, args<br />    if i ne 0<br />        i = i * 8<br />        add esp, i<br />        i = 0<br />    endif<br />endm<br /><br />.data<br /><br />.code<br />start&#58;<br />    xor edx, edx<br />    $call TestFunc, @add&#40;edx, 1&#41;, @add&#40;edx, 2&#41;, @add&#40;edx, 3&#41;, @add&#40;edx, 4&#41;<br />    mov edx, 10<br />    $call TestFunc, @add&#40;edx, 1&#41;, @add&#40;edx, 2&#41;, @add&#40;edx, 3&#41;, @add&#40;edx, 4&#41;<br />    ret<br /><br />TestFunc proc a1&#58; dword, a2&#58; dword, a3&#58; dword, a4&#58; dword<br />    PrintDword a1 ;PrintDword is my macro to check value<br />    PrintDword a2<br />    PrintDword a3<br />    PrintDword a4<br />    PrintLine<br />    ret<br />TestFunc endp<br /><br />end start<br /></code></pre><br />Below is result:<br /><pre><code><br />00050     $call TestFunc, @add&#40;edx, 1&#41;, @add&#40;edx, 2&#41;, @add&#40;edx, 3&#41;, @add&#40;edx, 4&#41;<br />0167&#58;00401012  mov       eax,esp                                                <br />0167&#58;00401014  sub       esp,08                                                 <br />0167&#58;00401017  mov       &#91;esp+04&#93;,edx                                           <br />0167&#58;0040101b  add       dword ptr &#91;esp+04&#93;,01                                  <br />0167&#58;00401020  sub       esp,08                                                 <br />0167&#58;00401023  mov       &#91;esp+08&#93;,edx                                           <br />0167&#58;00401027  add       dword ptr &#91;esp+08&#93;,02                                  <br />0167&#58;0040102c  sub       esp,08                                                 <br />0167&#58;0040102f  mov       &#91;esp+0c&#93;,edx                                           <br />0167&#58;00401033  add       dword ptr &#91;esp+0c&#93;,03                                  <br />0167&#58;00401038  sub       esp,08                                                 <br />0167&#58;0040103b  mov       &#91;esp+10&#93;,edx                                           <br />0167&#58;0040103f  add       dword ptr &#91;esp+10&#93;,04                                  <br />0167&#58;00401044  push      dword ptr &#91;eax-10&#93;                                     <br />0167&#58;00401047  push      dword ptr &#91;eax-0c&#93;                                     <br />0167&#58;0040104a  push      dword ptr &#91;eax-08&#93;                                     <br />0167&#58;0040104d  push      dword ptr &#91;eax-04&#93;                                     <br />0167&#58;00401050  call      TestFunc                                               <br />0167&#58;00401055  add       esp,20                                                 <br /></code></pre></div>
    <div class="meta">Posted on 2001-10-11 23:27:30 by vkim</div>
   </div>
   <div class="post" id="post-9267">
    <div class="subject"><a href="#post-9267">Macro function problem</a></div>
    <div class="body"><strong>2 japheth?</strong><br /><div class="quote">In my eyes it looks correct. Dont forget the brackets</div><br />Opps...My mistake. Hab' vergessen &lt;&gt;. Now it's OK. Thnx.<br /><br /><strong>2 vkim</strong><br /><div class="quote">I'm pleasently surprised with Your Russian!</div><br />Nichigo udivitel'nogo. Mama v detstve uchila ;-)<br /><div class="quote">Yes, my previous macros required too much resources. Ok, look at this:</div><br />Hmm... Much better. But too many code. (i mean size of code in .text section)<br />And you gave me good idea - to form stack manually without using of push.<br />BTW, I don't have close look at your macro yet.<br />But at first glance the four push are not necessary.<br />Because you can form stack with <em>mov dword ptr , param</em>,<br />then point esp to apropriate value and call.<br />In the case of four parameters it should be something like this:<br /><pre><code><br />mov &#91;esp-04&#93;, edx             ; a4<br />add dword ptr &#91;esp-04&#93;, 1<br />mov &#91;esp-08&#93;, edx             ; a3<br />add dword ptr &#91;esp-08&#93;, 2<br />mov &#91;esp-0Ch&#93;, edx            ; a2<br />add dword ptr &#91;esp-0Ch&#93;, 3<br />mov &#91;esp-10h&#93;, edx            ; a1<br />add dword ptr &#91;esp-10h&#93;, 4<br />sub esp, 10h<br />call TestFunc                                               <br />; add esp,10h                  ; not necessary because of stdcall<br /></code></pre><br /><br />So, people, my main problem is solved now.<br />Vielen Dank! <strong>japheth</strong><br />Bol'shoe spasibo! <strong>vkim</strong><br />Thank you, very much! <strong>bitRAKE</strong><br />Now i have to do my homework by myself.</div>
    <div class="meta">Posted on 2001-10-12 07:26:39 by MacroFan</div>
   </div>
  </div>
 </body>
</html>