<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Help with PrintDlg - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=29762" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=29762">Help with PrintDlg</a></p>
   <div class="post" id="post-210225">
    <div class="subject"><a href="#post-210225">Help with PrintDlg</a></div>
    <div class="body">Hello!<br />New in this assambler world, and i&#039;m having some troubles callling the printer dialog. i&#039;m making tests calling it from a button in a simple window, i have added the comdlg32.inc and lib, it solved me some troubles and it compiles fine, but when i execute it, the button does nothing.<br />This is the code i&#039;m using, i apreciate any clue please. <br /><br /><pre><code><br />.Const<br /><br />.Data?<br /><br />.Data<br /><br />.Code<br /><br />Window1Procedure Proc Private hWnd:HWND, uMsg:ULONG, wParam:WPARAM, lParam:LPARAM<br /><br />	Local pd:PRINTDLG<br />	.If uMsg == WM_CREATE<br /><br />	.ElseIf uMsg == WM_COMMAND<br /><br />			LoWord wParam<br />			.If Eax == IDC_WINDOW1_PRNT<br />				HiWord wParam<br />					.ElseIf Ax == BN_CLICKED<br />						Invoke PrintDlgEx, Addr pd ; here is the problem!!!!!<br /><br />						;Mov Ax, pd.nToPage<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 			;Movzx Ecx, Ax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 			;Invoke dw2a, Ecx, Addr buffer1<br /><br />					.EndIf<br /><br />	.ElseIf uMsg == WM_CLOSE<br />		Invoke IsModal, hWnd<br />		.If Eax<br />			Invoke EndModal, hWnd, IDCANCEL<br />			Return TRUE<br />		.EndIf<br />	.EndIf<br />	Return FALSE<br /><br />Window1Procedure EndP<br /><br /><br /></code></pre><br /><br />by the way, im working win easy code.<br /><br />thanks</div>
    <div class="meta">Posted on 2010-01-15 00:46:19 by smurillo9</div>
   </div>
   <div class="post" id="post-210227">
    <div class="subject"><a href="#post-210227">Re: Help with PrintDlg</a></div>
    <div class="body"><strong>smurillo9</strong>,<br /><br />Without proper <strong>pd</strong> initialization (correct <strong>pd.lStructSize</strong>, for example) <strong>PrintDlgEx()</strong> probably fails (<strong>E_INVALIDARG</strong> status?).</div>
    <div class="meta">Posted on 2010-01-15 14:35:49 by baldr</div>
   </div>
   <div class="post" id="post-210251">
    <div class="subject"><a href="#post-210251">Re: Help with PrintDlg</a></div>
    <div class="body">thanks baldr, i`ll chek and let you know...</div>
    <div class="meta">Posted on 2010-01-18 14:29:24 by smurillo9</div>
   </div>
   <div class="post" id="post-210256">
    <div class="subject"><a href="#post-210256">Re: Help with PrintDlg</a></div>
    <div class="body">Hello again!<br />Well checking in some examples (Genesys text editor from the examples), I found what you told, so here is the new code, but it still doesn&#039;t work, like the other program, it compiles and executes fine, but my button does nothing&nbsp; :mad:<br /><pre><code><br />.Const<br /><br />.Data?<br />hInstance	DD	?<br /><br />.Data<br />cnt	DD	0<br /><br />.Code<br /><br />Window1Procedure Proc Private hWnd:HWND, uMsg:ULONG, wParam:WPARAM, lParam:LPARAM<br /><br />	Local pd:PRINTDLG<br />	.If uMsg == WM_CREATE<br /><br />	.ElseIf uMsg == WM_COMMAND<br /><br />			LoWord wParam<br />			.If Eax == IDC_WINDOW1_PRNT<br />				HiWord wParam<br />					.ElseIf Ax == BN_CLICKED<br /><br />						Mov cnt, 0<br />&nbsp; &nbsp; &nbsp; &nbsp; 				Mov pd.lStructSize, SizeOf pd<br />				&nbsp; &nbsp; &nbsp; &nbsp; Mov Eax, hWnd<br />				&nbsp; &nbsp; &nbsp; &nbsp; Mov pd.hwndOwner, Eax<br />				&nbsp; &nbsp; &nbsp; &nbsp; Mov Eax, hInstance<br />				&nbsp; &nbsp; &nbsp; &nbsp; Mov pd.hInstance, Eax<br />				&nbsp; &nbsp; &nbsp; &nbsp; Mov pd.Flags, PD_RETURNDC<br /><br />						Invoke PrintDlg, Addr pd<br />						Mov Ax, pd.nToPage<br />						<br />				&nbsp; &nbsp; &nbsp; &nbsp; Mov Eax, pd.Flags<br />				&nbsp; &nbsp; &nbsp; &nbsp; Mov Ebx, Eax<br />				&nbsp; &nbsp; &nbsp; &nbsp; And Ebx, 000000FFH<br /><br />				&nbsp; &nbsp; &nbsp; &nbsp; <br /><br />					.EndIf<br /><br />	.ElseIf uMsg == WM_CLOSE<br />		Invoke IsModal, hWnd<br />		.If Eax<br />			Invoke EndModal, hWnd, IDCANCEL<br />			Return TRUE<br />		.EndIf<br />	.EndIf<br />	Return FALSE<br /><br />Window1Procedure EndP<br /><br /></code></pre><br /><br />but the button in that code doesn&#039;t work either... <br /><br />thanks for your help</div>
    <div class="meta">Posted on 2010-01-18 17:13:27 by smurillo9</div>
   </div>
   <div class="post" id="post-210257">
    <div class="subject"><a href="#post-210257">Re: Help with PrintDlg</a></div>
    <div class="body"><strong>smurillo9</strong>,<br /><br />OK, you&#039;ve initialized 4 members of <strong>pd</strong>… How about the rest?<br /><br />For example, non-NULL <strong>hDevMode</strong> should be valid handle for GlobalAlloc&#039;d moveable memory that contains <strong>DEVMODE</strong> structure, the same for <strong>hDevNames</strong>/<strong>DEVNAMES</strong>; certain OS will fail if <strong>nFromPage</strong> is not in range [<strong>nMinPage</strong>…<strong>nMaxPage</strong>] and so on. Check the Win32 reference.<br /><br />Good practice is to zero-fill the structure beforehand (most members accept 0 as default/don&#039;t care value). It is allocated on stack and contains garbage.</div>
    <div class="meta">Posted on 2010-01-18 17:52:17 by baldr</div>
   </div>
   <div class="post" id="post-210260">
    <div class="subject"><a href="#post-210260">Re: Help with PrintDlg</a></div>
    <div class="body">hello! <br /><br />i check for some examples and th only members of the struct initialized are trhe ones i post in this version, compilation and execution runs, but the dialog doesn&#039;t apear. iv&#039;e included comctl32, comdlg32 kernel32 shell32 and user32 libs and incs...<br /><br />other thing is that hDC, HWND flags and struct size don&#039;t need to be initialized, but hinstance, an the other uncommented throw errors if they are not!<br /> :sad:<br /><br />again, thanks for the help you coud give!<br /><pre><code><br />.Const<br /><br />.Data?<br />hInstance	DD		?<br />hREd		HWND	?	; Handle<br /><br />;lStructSize DWord	?<br />;hwndOwner 	HWND	?<br />hDevMode	HGLOBAL ?<br />hDevNames	HGLOBAL	?<br />;hDC			HDC 	?<br />;Flags		DWord	?<br />nFromPage 	Word 	?<br />nToPage		Word 	?<br />nMinPage	Word 	?<br />nMaxPage	Word 	?<br />nCopies		Word 	?<br /><br />;lCustData	LPARAM 	?<br /><br />;lpfnPrintHook	LPPRINTHOOKPROC	?<br />;lpfnSetupHook	LPSETUPHOOKPROC	?<br /><br />;lpPrintTemplateName	LPCTSTR 	?<br />;lpSetupTemplateName	LPCTSTR 	?<br />;hPrintTemplate		HANDLE 	?<br />;hSetupTemplate		HANDLE 	?<br /><br />cr			CHARRANGE	&lt;?&gt;	;Character range<br /><br />.Data<br />cnt	DD	0<br />Sel	DD&nbsp; 0&nbsp; ; Flags a &#039;Range&#039; type print job, currently unused<br /><br />.Code<br /><br />Window1Procedure Proc Private hWnd:HWND, uMsg:ULONG, wParam:WPARAM, lParam:LPARAM<br /><br />	Local pd:PRINTDLG<br />	.If uMsg == WM_CREATE<br /><br />	.ElseIf uMsg == WM_COMMAND<br /><br />			LoWord wParam<br />			.If Eax == IDC_WINDOW1_PRNT<br />				HiWord wParam<br />					.ElseIf Ax == BN_CLICKED<br /><br />						Mov cnt, 0<br />						Mov Eax, 0<br />&nbsp; &nbsp; &nbsp; &nbsp; 				Mov pd.lStructSize, SizeOf pd<br />					<br /><br />					;-----------------------------------------------------<br />					; inicializa miembros del struct<br /><br />				&nbsp; &nbsp; &nbsp; &nbsp; Mov Eax, hWnd<br />				&nbsp; &nbsp; &nbsp; &nbsp; Mov pd.hwndOwner, Eax<br /><br />				&nbsp; &nbsp; &nbsp; &nbsp; ;Mov Eax, hInstance<br />				&nbsp; &nbsp; &nbsp; &nbsp; Mov pd.hInstance, 0<br />				&nbsp; &nbsp; &nbsp; &nbsp; ;Mov Eax, hDevMode<br />				&nbsp; &nbsp; &nbsp; &nbsp; Mov pd.hDevMode, NULL<br />				&nbsp; &nbsp; &nbsp; &nbsp; Mov pd.hDevNames, NULL<br />				&nbsp; &nbsp; &nbsp; &nbsp; Mov pd.hDC, NULL<br />				&nbsp; &nbsp; &nbsp; &nbsp; ;Mov Eax, hDevNames<br /><br />				&nbsp; &nbsp; &nbsp; &nbsp; ;Mov Ax, nCopies<br />				&nbsp; &nbsp; &nbsp; &nbsp; ;Mov pd.nCopies, Ax<br />				&nbsp; &nbsp; &nbsp; &nbsp; ;Mov Ax, nFromPage<br />				&nbsp; &nbsp; &nbsp; &nbsp; ;Mov pd.nFromPage, Ax<br />				&nbsp; &nbsp; &nbsp; &nbsp; ;Mov Ax, nMinPage<br />				&nbsp; &nbsp; &nbsp; &nbsp; Mov pd.nMinPage, 1<br />				&nbsp; &nbsp; &nbsp; &nbsp; ;Mov Ax, nMaxPage<br />				&nbsp; &nbsp; &nbsp; &nbsp; Mov pd.nMaxPage, 100<br />				&nbsp; &nbsp; &nbsp; &nbsp; Mov pd.lpPrintTemplateName, NULL<br /><br />					;-----------------------------------------------------<br />				&nbsp; &nbsp; &nbsp; &nbsp; Mov pd.Flags, PD_RETURNDC<br /><br />						Invoke PrintDlg, Addr pd<br />						;Mov Ax, pd.nToPage<br /><br />						;Cmp Eax, FALSE<br />				&nbsp; &nbsp; &nbsp; &nbsp; ;Je PrtRet<br />				&nbsp; &nbsp; &nbsp; &nbsp; Mov Eax, pd.Flags<br />				&nbsp; &nbsp; &nbsp; &nbsp; Mov Ebx, Eax<br />				&nbsp; &nbsp; &nbsp; &nbsp; And Ebx, 000000FFH<br />				&nbsp; &nbsp; &nbsp; &nbsp; ;Mov Sel, Ebx<br />				&nbsp; &nbsp; &nbsp; &nbsp; <br />;PrtRet:<br />					.EndIf<br /><br />	.ElseIf uMsg == WM_CLOSE<br />		Invoke IsModal, hWnd<br />		.If Eax<br />			Invoke EndModal, hWnd, IDCANCEL<br />			Return TRUE<br />		.EndIf<br />	.EndIf<br />	Return FALSE<br /><br />Window1Procedure EndP<br /><br /><br /><br /></code></pre></div>
    <div class="meta">Posted on 2010-01-19 00:50:10 by smurillo9</div>
   </div>
   <div class="post" id="post-210268">
    <div class="subject"><a href="#post-210268">Re: Help with PrintDlg</a></div>
    <div class="body"><strong>smurillo9</strong>,<br /><br />I&#039;ve successfully compiled and run the following code:<br /><pre><code><br />	.386<br />	.MODEL	FLAT, STDCALL<br />	OPTION	CASEMAP:NONE<br />	INCLUDE	WINDOWS.INC<br />	INCLUDE	KERNEL32.INC<br />ZeroMemory EQU RtlZeroMemory<br />	INCLUDE	COMDLG32.INC<br />	INCLUDELIB KERNEL32.LIB<br />	INCLUDELIB COMDLG32.LIB<br /><br />	.DATA?<br />pd	PRINTDLG &lt;&gt;<br /><br />	.CODE<br />ShowPrintDlg:<br />	INVOKE	ZeroMemory, ADDR pd, SIZEOF pd; just to be sure<br />	mov	pd.lStructSize, SIZEOF pd<br />	INVOKE	GetModuleHandle, NULL<br />	mov	pd.hInstance, eax<br />	mov	pd.hwndOwner, HWND_DESKTOP<br />	mov	pd.Flags, PD_RETURNDC<br />	INVOKE	PrintDlg, ADDR pd<br />	ret<br />	<br />	END	ShowPrintDlg<br /></code></pre><br /><br />It shows print dialog, though I didn&#039;t check any of the return values. Probably you should run your code under debugger and check that it behaves correctly (if you attach something compilable, I&#039;ll check that myself).</div>
    <div class="meta">Posted on 2010-01-19 07:58:58 by baldr</div>
   </div>
   <div class="post" id="post-210277">
    <div class="subject"><a href="#post-210277">Re: Help with PrintDlg</a></div>
    <div class="body">all codes i&#039;ve posted are compilable, they are implemented in easy code. the GUI is a simple button named prnt and when is clicked it calls printproc where i initialize the strct and call printdlg<br /><pre><code><br />.Const<br /><br />.Data?<br />hInstance	DD		?<br />hREd		HWND	?	; Handle<br /><br />;lStructSize DWord	?<br />hwndOwner 	HWND	?<br />hDevMode	HGLOBAL ?<br />hDevNames	HGLOBAL	?<br />;hDC			HDC 	?<br />;Flags		DWord	?<br />;nFromPage 	Word 	?<br />;nToPage		Word 	?<br />;nMinPage	Word 	?<br />;nMaxPage	Word 	?<br />nCopies		Word 	?<br /><br />;lCustData	LPARAM 	?<br /><br />;lpfnPrintHook	LPPRINTHOOKPROC	?<br />;lpfnSetupHook	LPSETUPHOOKPROC	?<br /><br />;lpPrintTemplateName	LPCTSTR 	?<br />;lpSetupTemplateName	LPCTSTR 	?<br />;hPrintTemplate		HANDLE 	?<br />;hSetupTemplate		HANDLE 	?<br /><br />.Data<br /><br />.Code<br /><br />Window1Procedure Proc Private hWnd:HWND, uMsg:ULONG, wParam:WPARAM, lParam:LPARAM<br /><br />	.If uMsg == WM_CREATE<br /><br />	.ElseIf uMsg == WM_COMMAND<br /><br />		LoWord wParam<br />		.If Eax == IDC_WINDOW1_PRNT<br />			HiWord wParam<br />			.ElseIf Ax == BN_CLICKED<br /><br />			Call printProc<br /><br />			.EndIf<br /><br />	.ElseIf uMsg == WM_CLOSE<br />		Invoke IsModal, hWnd<br />		.If Eax<br />			Invoke EndModal, hWnd, IDCANCEL<br />			Return TRUE<br />		.EndIf<br />	.EndIf<br />	Return FALSE<br /><br />Window1Procedure EndP<br /><br />printProc Proc hWnd:HWND<br />	Local pd:PRINTDLG<br /><br />	;Mov cnt, 0<br />	;Mov Eax, 0<br />;-----------------------------------------------------<br />	; inicializa miembros del struct<br /><br />	Mov pd.lStructSize, SizeOf pd<br />	Invoke GetModuleHandle, NULL<br /><br />	Mov Eax, hWnd<br />	Mov pd.hInstance, Eax<br />	Mov pd.hwndOwner, HWND_DESKTOP<br />	Mov pd.Flags, PD_RETURNDC ;Or PD_COLLATE<br />	Mov pd.hDevMode, NULL<br />	Mov pd.hDevNames, NULL<br />	Mov pd.hDC, NULL<br />;	Mov pd.nMinPage, 1<br />;	Mov pd.nMaxPage, 100<br />	Mov pd.lpPrintTemplateName, NULL<br /><br />	Invoke PrintDlgA, Addr pd<br />	<br />	;-----------------------------------------------------<br /><br />	Ret<br />printProc EndP<br /><br /><br /></code></pre><br /><br />the problem is that the code compiles fine and when i click on execute the window appears, but the button doesn&#039;t invoke the print dialog<br /></div>
    <div class="meta">Posted on 2010-01-19 19:16:18 by smurillo9</div>
   </div>
   <div class="post" id="post-210280">
    <div class="subject"><a href="#post-210280">Re: Help with PrintDlg</a></div>
    <div class="body"><strong>smurillo9</strong>,<br /><br />Something compilable to .Exe, that&#039;s what I meant. Your samples definitely lack initialization (entry point and such things as <strong>CreateWindow()</strong> call).<br /><br />I was focused on <strong>PrintDlg()</strong> behavior and overlooked this:<br /><pre><code><br />	.ElseIf uMsg == WM_COMMAND<br /><br />		LoWord wParam<br />		.If Eax == IDC_WINDOW1_PRNT<br />			HiWord wParam<br />			.ElseIf Ax == BN_CLICKED<br /><br />			Call printProc<br /><br />			.EndIf<br /></code></pre><br /><br />This reads as &quot;call printProc if uMsg==WM_COMMAND and <strong>LoWord(wParam)==BN_CLICKED</strong>&quot; (that is, notification from control with id==0 (BN_CLICKED)). Indentation is ignored by MASM, <strong>.ElseIf</strong> is an <em>alternate</em> branch of previous <strong>.If</strong> (not a nested <strong>.If</strong> within it).</div>
    <div class="meta">Posted on 2010-01-20 00:37:44 by baldr</div>
   </div>
   <div class="post" id="post-210293">
    <div class="subject"><a href="#post-210293">Re: Help with PrintDlg</a></div>
    <div class="body">good news at last, it seems that the printdgl was the problem, but i implemented the invoke with the printdialog and using the 3 parameters instead the lonely addr pd, and it worked fine!<br /><br />Thanks for your help&nbsp; :P <br /><br /></div>
    <div class="meta">Posted on 2010-01-20 12:03:13 by smurillo9</div>
   </div>
   <div class="post" id="post-210299">
    <div class="subject"><a href="#post-210299">Re: Help with PrintDlg</a></div>
    <div class="body"><div class="quote">For example, non-NULL <strong>hDevMode</strong> should be valid handle for GlobalAlloc&#039;d moveable memory that contains <strong>DEVMODE</strong> structure, the same for <strong>hDevNames</strong>/<strong>DEVNAMES</strong>;</div>Interesting, just checked MSDN - it&#039;s slightly vague, just mentioning &quot;movable global memory&quot;... when that&#039;s expected, it usually explicitly mentions GlobalAlloc(). Good catch :)</div>
    <div class="meta">Posted on 2010-01-20 18:10:55 by f0dder</div>
   </div>
  </div>
 </body>
</html>