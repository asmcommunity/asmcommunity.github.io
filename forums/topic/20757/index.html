<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>winsock recv to writefile - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=20757" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=8">Networking</a> &raquo; <a href="../?id=20757">winsock recv to writefile</a></p>
   <div class="post" id="post-157986">
    <div class="subject"><a href="#post-157986">winsock recv to writefile</a></div>
    <div class="body">having a problem writing the received data to file<br />if you compile and execute<br />blah.exe 66.94.234.13 index.html <br />(ip is yahoo.com)<br />it&#39;ll scroll the source of index.html into console but the file does writeout properly<br />yea i know i should change the host from 0.0.0.0<br />but for now im only concerned about the data writing to file<br /><br /><br /><pre><code><br />.386<br />.model flat, stdcall<br />option casemap: none<br /><br />include \masm32\include\windows.inc <br />include \masm32\include\user32.inc <br />include \masm32\include\kernel32.inc <br />include \masm32\include\shell32.inc<br />include \masm32\include\wsock32.inc<br />include \masm32\include\masm32.inc<br />includelib \masm32\lib\shell32.lib<br />includelib \masm32\lib\user32.lib <br />includelib \masm32\lib\kernel32.lib <br />includelib \masm32\lib\wsock32.lib<br />includelib \masm32\lib\masm32.lib<br /><br /><br />.data<br />usage&nbsp; &nbsp; &nbsp;  db &quot;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  Assembly WebGetter&quot;,13,10,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &quot;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; by: illwill &quot;,13,10,13,10,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &quot;Usage: webget.exe &lt;ip&gt; &lt;filename&gt;&quot;,13,10,\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &quot;Example: webget 10.0.0.2 index.html&quot;,13,10,0<br /> szHost&nbsp; &nbsp; &nbsp; db &quot;Cannot connect to %s.&quot;,0<br /> GetTemplate db &quot;GET /%s HTTP/1.0&quot;,0dh,0ah<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  db &quot;User-Agent: ASM-WEB-GET&quot;,0Dh,0Ah<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  db &quot;Host: 0.0.0.0:0&quot;,0Dh,0Ah<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  db &quot;Connection: Keep-Alive&quot;,0Dh,0Ah<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  db &quot;Accept: */*&quot;,0Dh,0Ah,0dh,0ah,0&nbsp; <br /> 	RcvError&nbsp;  db	&quot;Socket Error When Receiving Data.&quot;,0Dh,0Ah,0&nbsp; &nbsp; &nbsp; &nbsp;  <br />.data?<br /> IPAddress&nbsp;  db 32 dup(?)<br /> szFile&nbsp; &nbsp; &nbsp; db 128 dup(?)<br /> Getbuffer&nbsp;  db 512 dup(?)<br /> buffer&nbsp; &nbsp; &nbsp; db 64 dup(?)&nbsp;  <br /> sock&nbsp; &nbsp; &nbsp; &nbsp; dd ?<br /> sin&nbsp; &nbsp; &nbsp; &nbsp;  sockaddr_in &lt;;?&gt;<br /> wsadata&nbsp; &nbsp;  WSADATA &lt;;?&gt; <br /> buff_sock&nbsp;  db 128 dup (?)<br /> hFile&nbsp; &nbsp; &nbsp;  dd ?<br /> fwritten&nbsp; dd ?<br />.code<br />start:&nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;  invoke GetCL, 1, addr IPAddress <br />&nbsp; &nbsp; &nbsp; &nbsp;  invoke lstrlen,addr IPAddress<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .IF eax&gt;;500<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  invoke ExitProcess,1<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .ELSEIF eax==0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke StdOut,addr usage<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  invoke ExitProcess,0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .ENDIF<br />&nbsp; &nbsp; &nbsp; &nbsp;  invoke GetCL, 2, addr szFile<br /> invoke WSAStartup, 101h, offset wsadata<br />&nbsp; &nbsp; cmp eax, 0<br />&nbsp; &nbsp; jne start<br /> invoke socket,AF_INET,SOCK_STREAM,0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; mov sock,eax<br />&nbsp; &nbsp; &nbsp; mov sin.sin_family, AF_INET<br />&nbsp; &nbsp; &nbsp; invoke htons, 80&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; mov sin.sin_port,ax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; invoke inet_addr, addr IPAddress <br />&nbsp; &nbsp; &nbsp; mov sin.sin_addr,eax<br />&nbsp; &nbsp; &nbsp; invoke connect,sock,addr sin,sizeof sin<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .if eax==SOCKET_ERROR&nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  invoke wsprintf,addr buffer,addr szHost,addr IPAddress<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  invoke	StdOut,addr buffer<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  jmp Err<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .else<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke wsprintf,addr Getbuffer,addr GetTemplate,addr szFile<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke lstrlen,addr Getbuffer<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke send,sock,addr Getbuffer,eax,0&nbsp; &nbsp; &nbsp;  ; Send GET command to the web server <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke	StdOut, addr Getbuffer<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke CreateFile,addr szFile, GENERIC_WRITE, FILE_SHARE_READ, 0, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, 0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov hFile, eax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _recvLoop:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; recv, , addr buff_sock, sizeof buff_sock, 0<br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  test	eax, eax<br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov		ecx, offset RcvError<br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jz		Err<br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp		eax, SOCKET_ERROR<br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  je		_error<br />		&nbsp; &nbsp; &nbsp;  		mov		, 0<br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke	StdOut, addr buff_sock<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke WriteFile, hFile, addr buff_sock, sizeof buff_sock, addr fwritten, 0<br />	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jmp		_recvLoop<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .endif<br /><br />Err:<br />&nbsp;  invoke CloseHandle, hFile<br />&nbsp;  invoke WSACleanup <br />&nbsp;  invoke ExitProcess,0<br /><br />_error:<br />	invoke	StdOut, ecx<br />&nbsp; xor		ebx, ebx<br />&nbsp; jmp Err&nbsp; <br />end start<br /></code></pre></div>
    <div class="meta">Posted on 2005-03-16 01:06:22 by illwill</div>
   </div>
   <div class="post" id="post-158079">
    <div class="subject"><a href="#post-158079">Re: winsock recv to writefile</a></div>
    <div class="body">You should check how many bytes are in the rec buffer before you write to file.<br />Apart from that, if you only want to fetch files from web, may as well use wininet.<br />Much more simple to code and quick results, with less control over the transfer.<br />The choice is yours, it depends on what your motivation is.<br /></div>
    <div class="meta">Posted on 2005-03-17 16:22:44 by Homer</div>
   </div>
   <div class="post" id="post-158111">
    <div class="subject"><a href="#post-158111">Re: winsock recv to writefile</a></div>
    <div class="body">well using <br />mov&nbsp; , 0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke StdOut, addr buff_sock<br /><br />stdout shows the html output no problem but the writefile isnt writing it<br />i figure this is a good way to learn winsock stuff.. urldownloadtofile is just as simple but i like the harder way</div>
    <div class="meta">Posted on 2005-03-18 23:11:27 by illwill</div>
   </div>
   <div class="post" id="post-158143">
    <div class="subject"><a href="#post-158143">Re: winsock recv to writefile</a></div>
    <div class="body">I&#39;m glad you like the harder way.<br />My suggestion is to include the ATC macros and my FStream incluide.<br />Ask me for my most recent version.<br />It has a Put method which is basically a proc with two params: ptr to data and sizeof data.<br />It wraps all the disk access stuff to make life a breeze.<br />FStream is a blend of the IFStream and OFStream classes.<br />Using oop can be easy and fun, and make asm feel like vb, if you want it to :)<br /></div>
    <div class="meta">Posted on 2005-03-20 07:57:31 by Homer</div>
   </div>
   <div class="post" id="post-158488">
    <div class="subject"><a href="#post-158488">Re: winsock recv to writefile</a></div>
    <div class="body">Hi,<br />&nbsp; Like Iczleion says in his tut, use ioctlsocket with the option as FIONREAD to query the no. of bytes to be read. Then use this value to alloc mem using GlobalAlloc,LocalAlloc whatever. Then Write this buffer to file and free this buffer.<br /><br />Thomas Antony :P</div>
    <div class="meta">Posted on 2005-03-28 04:27:56 by thomasantony</div>
   </div>
  </div>
 </body>
</html>