<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Does this XTEA implementation give correct results? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=24747" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=24747">Does this XTEA implementation give correct results?</a></p>
   <div class="post" id="post-180759">
    <div class="subject"><a href="#post-180759">Does this XTEA implementation give correct results?</a></div>
    <div class="body">Hi,<br /><br />I found this XTEA (m)asm implementation from http://www.simonshepherd.supanet.com/tea.htm and I have added some code&nbsp; to make it run (basicly the main proc). Now i&#39;m wondering if somebody could confirm me that the algo is really providing&nbsp; correct results?<br /><br />Best regards,<br />Sami<br /><br /><pre><code>.486<br />.MODEL		FLAT, STDCALL<br />option		casemap:none<br /><br />include		d:\masm32\include\windows.inc<br />include		d:\masm32\include\kernel32.inc<br />include		d:\masm32\include\advapi32.inc<br />include		d:\masm32\include\user32.inc<br />include		d:\masm32\include\masm32.inc<br />includelib	d:\masm32\lib\kernel32.lib<br />includelib	d:\masm32\lib\advapi32.lib<br />includelib	d:\masm32\lib\user32.lib<br />includelib	d:\masm32\lib\masm32.lib<br /><br /><br />Main						PROTO<br />XTEA_Encipher				PROTO<br />XTEA_Decipher				PROTO<br /><br />CTEXT MACRO text:VARARG<br />&nbsp; &nbsp; LOCAL TxtName<br />&nbsp; &nbsp; .data<br />&nbsp; &nbsp;  TxtName BYTE text,0<br />&nbsp; &nbsp; .code<br />&nbsp; EXITM &lt;ADDR TxtName&gt;<br />ENDM<br /><br />.const<br />Delta	equ		09E3779B9h		; Delta<br />DIS		equ		0C6EF3720h		; Initial value of sum in decipher routine<br />N		equ		32				; n (number of iterations)<br /><br />.data<br /><br />v		dd 0, 0<br />w		dd ?, ?					; Results<br />k		dd 0,0,0,0	; Key<br />Password	db &quot;1234567890123456&quot;<br /><br />PlainText	db &quot;aaaaaaaa&quot;, 0<br /><br />.data?<br />.code<br />Start:<br />	invoke	Main<br />	invoke	ExitProcess, eax<br />	<br />Main proc<br />LOCAL szTmp[1024] :BYTE<br />LOCAL szHex1[12] :BYTE<br />LOCAL szHex2[12] :BYTE<br /><br />	invoke	StdOut, CTEXT(&quot;XTEA Test&quot;, 13, 10)<br /><br />;	invoke	MemCopy, ADDR Password, ADDR k, 16<br />	<br />	invoke	MemCopy, ADDR PlainText, ADDR v, 8<br /><br />	invoke	XTEA_Encipher<br />	invoke	dw2hex, DWORD PTR , ADDR szHex1<br />	invoke	dw2hex, DWORD PTR  + 4, ADDR szHex2<br />	invoke	wsprintf, ADDR szTmp, CTEXT(&quot;%s %s&quot;), ADDR szHex1, ADDR szHex2<br />	invoke	StdOut, ADDR szTmp<br />	xor		eax, eax<br /><br />Exitus:<br />	ret<br />Main endp<br /><br />XTEA_Encipher	proc<br /><br />		PUSHAD					; Save registers<br /><br />		MOV	EAX, v[0 * 4]		; EAX -&gt; y<br />		MOV	EBX, v[1 * 4]		; EBX -&gt; z<br />		MOV	ECX, N				; ECX -&gt; n<br />		XOR	EDX, EDX			; EDX -&gt; sum<br /><br />		EnStart:<br /><br />		MOV	ESI, EBX<br />		MOV	EDI, ESI<br /><br />		SHL	ESI, 4				; z &lt;&lt; 4<br />		SHR	EDI, 5				; z &gt;&gt; 5<br />		XOR	EDI, ESI			; z &lt;&lt; 4 ^ z &gt;&gt; 5<br />		ADD	EDI, EBX			; (z &lt;&lt; 4 ^ z &gt;&gt; 5) + z<br /><br />		MOV	ESI, EDX<br />		AND	ESI, 3				; sum &amp; 3<br />		MOV	ESI, k		; k<br />		ADD	ESI, EDX			; sum + k<br />		XOR	ESI, EDI			; (z &lt;&lt; 4 ^ z &gt;&gt; 5) + z ^ sum + k<br />		ADD	EAX, ESI			; y += (z &lt;&lt; 4 ^ z &gt;&gt; 5) + z ^ sum + k<br /><br />		ADD	EDX, Delta			; sum += delta<br /><br />		MOV	ESI, EAX<br />		MOV	EDI, ESI<br /><br />		SHL	ESI, 4				; y &lt;&lt; 4<br />		SHR	EDI, 5				; y &gt;&gt; 5<br />		XOR	EDI, ESI			; y &lt;&lt; 4 ^ y &gt;&gt; 5<br />		ADD	EDI, EAX			; (y &lt;&lt; 4 ^ y &gt;&gt; 5) + y<br /><br />		MOV	ESI, EDX<br />		SHR	ESI, 11				; sum &gt;&gt; 11<br />		AND	ESI, 3				; sum &gt;&gt; 11 &amp; 3<br />		MOV	ESI, k		; k<br />		ADD	ESI, EDX			; sum + k<br />		XOR	ESI, EDI			; (y &lt;&lt; 4 ^ y &gt;&gt; 5) + y ^ sum + k;<br />		ADD	EBX, ESI			; z += (y &lt;&lt; 4 ^ y &gt;&gt; 5) + y ^ sum + k;<br /><br />		LOOP	EnStart<br /><br />		MOV	w[0 * 4], EAX<br />		MOV	w[1 * 4], EBX<br /><br />		POPAD					; Restore registers<br />		RET<br /><br />XTEA_Encipher	endp<br /><br />XTEA_Decipher	proc<br /><br />		PUSHAD					; Save registers<br /><br />		MOV	EAX, v[0 * 4]		; EAX -&gt; y<br />		MOV	EBX, v[1 * 4]		; EBX -&gt; z<br />		MOV	ECX, N				; ECX -&gt; n<br />		MOV	EDX, DIS			; EDX -&gt; sum<br /><br />		DeStart:<br /><br />		MOV	ESI, EAX<br />		MOV	EDI, ESI<br /><br />		SHL	ESI, 4				; y &lt;&lt; 4<br />		SHR	EDI, 5				; y &gt;&gt; 5<br />		XOR	EDI, ESI			; y &lt;&lt; 4 ^ y &gt;&gt; 5<br />		ADD	EDI, EAX			; (y &lt;&lt; 4 ^ y &gt;&gt; 5) + y<br /><br />		MOV	ESI, EDX<br />		SHR	ESI, 11				; sum &gt;&gt; 11<br />		AND	ESI, 3				; sum &gt;&gt; 11 &amp; 3<br />		MOV	ESI, k		; k<br />		ADD	ESI, EDX			; sum + k<br />		XOR	ESI, EDI			; (y &lt;&lt; 4 ^ y &gt;&gt; 5) + y ^ sum + k<br />		SUB	EBX, ESI			; z -= (y &lt;&lt; 4 ^ y &gt;&gt; 5) + y ^ sum + k<br /><br />		SUB	EDX, Delta			; sum -= delta<br /><br />		MOV	ESI, EBX<br />		MOV	EDI, ESI<br /><br />		SHL	ESI, 4				; z &lt;&lt; 4<br />		SHR	EDI, 5				; z &gt;&gt; 5<br />		XOR	EDI, ESI			; z &lt;&lt; 4 ^ z &gt;&gt; 5<br />		ADD	EDI, EBX			; (z &lt;&lt; 4 ^ z &gt;&gt; 5) + z<br /><br />		MOV	ESI, EDX<br />		AND	ESI, 3				; sum &amp; 3<br />		MOV	ESI, k		; k<br />		ADD	ESI, EDX			; sum + k<br />		XOR	ESI, EDI			; (z &lt;&lt; 4 ^ z &gt;&gt; 5) + z ^ sum + k<br />		SUB	EAX, ESI			; y -= (z &lt;&lt; 4 ^ z &gt;&gt; 5) + z ^ sum + k<br /><br />		LOOP	DeStart<br /><br />		MOV	w[0 * 4], EAX<br />		MOV	w[1 * 4], EBX<br /><br />		POPAD					; Restore registers<br />		RET<br /><br />XTEA_Decipher	endp<br /><br />end Start</code></pre></div>
    <div class="meta">Posted on 2006-05-18 14:06:57 by SamiP</div>
   </div>
   <div class="post" id="post-180762">
    <div class="subject"><a href="#post-180762">Re: Does this XTEA implementation give correct results?</a></div>
    <div class="body">Assuming that <a target="_blank" href="http://www.cix.co.uk/~klockstone/teavect.htm">this page</a> has correct test vectors, you could test against those :)<br /></div>
    <div class="meta">Posted on 2006-05-19 05:00:56 by f0dder</div>
   </div>
   <div class="post" id="post-180776">
    <div class="subject"><a href="#post-180776">Re: Does this XTEA implementation give correct results?</a></div>
    <div class="body">Thank you f0dder, you are a life saver!<br /><br />I spent countles of hours googling around without founding how can I verify that this algo gives correct results and now it&#39;s proven.</div>
    <div class="meta">Posted on 2006-05-20 15:23:43 by SamiP</div>
   </div>
  </div>
 </body>
</html>