<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>the 4e(search) function of the 21h interrupt - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=4859" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=4859">the 4e(search) function of the 21h interrupt</a></p>
   <div class="post" id="post-34084">
    <div class="subject"><a href="#post-34084">the 4e(search) function of the 21h interrupt</a></div>
    <div class="body">ok i dunno where to post this so i'm just gonna post it in here. ok how do i go about using this. because i'm reading AoA and its not telling me how i go about searching for files and stuff myself. can anyone help me plz. this seems to be the only thign i have problems with.</div>
    <div class="meta">Posted on 2002-04-19 22:15:43 by Guy on ASM</div>
   </div>
   <div class="post" id="post-34090">
    <div class="subject"><a href="#post-34090">stop reading the book if you finished chapter 9</a></div>
    <div class="body">In which chapter you are and which version of the book you have?<br />there are two versions (the old one for dos and the new one supporting win32 but using a special HLA syntax) ...<br />and what exactly do you mean by (searching files by yourself) ... I was reading the same book but I stopped and began reading win32asm tutorials ... you don't have to read the whole book ( Infact I think its better not to read the whole book so you don't get used to stuff that won't be so usefull later ) ... its enough to get the basics of assembly and masm from this book to get you started in win32asm world ...<br />good luck Guy ...:alright:</div>
    <div class="meta">Posted on 2002-04-20 00:03:16 by code1101</div>
   </div>
   <div class="post" id="post-34093">
    <div class="subject"><a href="#post-34093">aha</a></div>
    <div class="body">sorry ...didn't pay attention to the subject ... your taking about interrupts ....hmmm ...<br />god I'm jelous of you man .... your very fast compared to me ... ( actually I never reached the interrupts ) ....:tongue:</div>
    <div class="meta">Posted on 2002-04-20 00:27:33 by code1101</div>
   </div>
   <div class="post" id="post-34123">
    <div class="subject"><a href="#post-34123">the 4e(search) function of the 21h interrupt</a></div>
    <div class="body">Well, I will try to explain this. In fact I've never used this function, I've just a complete help file where all the functions and interrupts are explained but this is all in French...<br /><br />in:<br />AH 	= 4Eh<br />CX 	= File attribute<br />DX 	= Address of the buffer where there is the name of the file<br /><br />out:<br />Flag Carry =0 : All right<br />Flag Carry =1 : Error<br />	ax=2: path not found<br />	ax=18:no file found with this specified attribute</div>
    <div class="meta">Posted on 2002-04-20 09:38:43 by Vom-bonjour:-()</div>
   </div>
   <div class="post" id="post-34127">
    <div class="subject"><a href="#post-34127">the 4e(search) function of the 21h interrupt</a></div>
    <div class="body">yes i have that part. but where does the name of the file found come up at. i need too know where i can find that at so i can finish up this program i'm making. does anyone know. and thanks man. i didn't know about those carries.<br /><br />ack i have to edit this to make it more clear. ok when i search for the first file. and i find a file. where does the name of this file appear at. i don't think it comes up in any of the general purpose registers...</div>
    <div class="meta">Posted on 2002-04-20 10:16:28 by Guy on ASM</div>
   </div>
   <div class="post" id="post-34131">
    <div class="subject"><a href="#post-34131">the 4e(search) function of the 21h interrupt</a></div>
    <div class="body">Guy on Asm,<br />        I'm assuming your targeting a dos platform, but one could theoretically use the int 21 service in a console program, or in a problem designed for wdosx, though these would be a great deal more complicated.<br />       The basic approach behind using 21h services 4eh and 4fh is simple.  4eh is used to find the first file in the current or specified directory that matches particular attributes and file name specs.  After 4eh call been issued, if it suceeds, then 4fh is used to find the next file in the directory that also matched. 4fh can be called repeatedly until no matching files remain.<br />       For instance, lets say you wanted to obtain a list of all the files in the current directory with the extention .asm.<br /><br />We begin by finding the first match by calling service 4eh.<br />    <br />       mov cx, 0  ;set search attribute to normal files, no subdirs<br />       mov dx, FileSpecs ; offset to a null terminated string<br />                                    ; containing &quot;*.asm&quot; <br />                                    ; ds must contain the segment <br />                                    ; from which the offset is relative<br />                                    ; but I will assume this is already so<br />       mov ah, 4eh         ; find first file<br />       int 21h<br />       jc error                 ;if carry flag set, jump to error <br />                                   ;ax hold the error code<br />Now, if no file matches &quot;*.asm&quot;, the interupt with return with the<br />carry flag set, else it will store file information in the DTA(disk <br />tranfer area) By default, the DTA for your program is at offset<br />80h from your programs PSP segment.  Under most circumstances<br />the PSP begins 100h (512) bytes before your program in memory,<br />but you can also obtain this segment with service 51h.  This returns the PSP address in the BX register.<br /><br />So at this point our DTA contains file info about the first file in the directory that matches our search parameters.  Of interest to us at the moment is field 1Eh bytes into the DTA which contains the filename (DOS file name, not long file name) terminated with the null character (ascii 0).  So the file name is at (PSPsegment:80h+1eh) or in other words (PSPsegment:9Eh)<br />So we can save the file name somewhere.<br /><br />            mov cx, 12 ; the file name will never be larger than 12<br />                               ; bytes<br />            mov di, Filename ; address to a 12 byte buffer<br />            mov si, 9eh <br />            mov ax, ; assuming we saved it previously<br />             push ds ; save the data segment<br />             push ds ;load es with ds<br />             pop es   ;like so<br />             mov ds, ax ; set to PSP segment<br />             cld          ; clear direction flag<br />             rep movsb ; copy 12 bytes<br />             pop ds ;restore ds <br /><br /><br />             To find the next file that matches *.asm, all we need to do is issue int 21h service 4fh.  This will copy the info for the next file into the DTA.  We can continue to do so until service 4fh sets the carry flag to indicate an error  (usually ax = 12h to indicate no<br />more files match wild card.)<br />            mov ah, 4fh<br />            int 21h<br />            jc Nomorefiles  ;if carry, jump to Nomorefiles<br /><br />            Now, don't try a bit of that code under a protected mode operating system unless you really know what your doing, but under dos, thats the gist of searching for files.        <br /><br />Now, a lot of people will tell you that interupts and segments are a thing of thing of the past.  The truth is that vacuum tubes are still used in our microwaves and interrupts are still integral to how our PCs work.  Preemptive multitasking works through interrupts.  Virtual memory relies on the Page fault exception, which is just a glorified interrupt.  DPMI uses a software interrupt interface, so it can't hurt to get used to this stuff, so keep on reading AOA.  Both of em, because there's good stuff in there.</div>
    <div class="meta">Posted on 2002-04-20 10:34:36 by Canite</div>
   </div>
   <div class="post" id="post-34140">
    <div class="subject"><a href="#post-34140">the 4e(search) function of the 21h interrupt</a></div>
    <div class="body"><div class="quote">.model tiny<br />.stack 100h<br />.data<br />Error db &quot;NO files found.$&quot;<br />problem db &quot;Unable to open file.$&quot;<br />Beginning db &quot;Searching for .txt files...&quot;,13,10,&quot;$&quot;<br />SearchLine db &quot;*.txt&quot;,0<br />fhandle dw ?<br />FileName db ?<br />Daniel db &quot;Daniel Millington$&quot;<br />.code<br />Start:<br />mov ax,@data<br />mov ds,ax<br />mov es,ax<br /> jmp Begin<br />NoFiles:<br /> mov ah,09h<br /> mov dx,offset Error<br /> int 21h<br /> jmp Quit<br />_Problem:<br /> mov ah,09h<br /> mov dx,offset problem<br /> int 21h<br /> jmp Quit<br />Begin:<br /> mov ah,09h<br /> lea dx,Beginning<br /> int 21h<br />Searching:<br /> mov ah,4eh<br /> lea dx,SearchLine<br /> int 21h<br /> cmp ax,18<br /> je NoFiles<br />Found:                             ;&lt;==== heres my problem right here<br /> mov ah,3dh                    ;&lt;=== i dunno how to get the file name<br /> mov al,1                         ;&lt;=== that is in the psp. =(<br /> int 21h<br /> jc _Problem<br /> xchg bx,ax<br /> mov fhandle,ax<br />Write:<br /> mov ah,40h<br /> mov cx,17<br /> mov dx,offset Daniel<br /> int 21h<br />Close:<br /> mov ah,4ch<br /> int 21h<br />Quit:<br /> mov ah,4ch<br /> int 21h<br />end Start </div> <br />could someoen plz help me :confused:</div>
    <div class="meta">Posted on 2002-04-20 12:00:04 by Guy on ASM</div>
   </div>
   <div class="post" id="post-34195">
    <div class="subject"><a href="#post-34195">DTA</a></div>
    <div class="body">hi,<br /><br /> First set DTA addr to new addr. Fn 4e stores filename, attr, and other data to DTA adress.<br /><br /> Like this:<br /> <br /><br /><pre><code><br /><br />;.386<br />seg_a		segment byte public<br />		assume cs&#58;seg_a;ds&#58;seg_a<br /><br />		org 	100h<br />start&#58;<br />		jmp	basla<br /><br />;This DTA start----------------------------------<br />dta		db 15h dup &#40;0&#41;<br />attr		db 00<br />ftime		dw 00<br />fdate		dw 00<br />filename	                db 13 dup&#40;0&#41;<br />;DTA end-----------------------------------------	<br /><br />wildcard	                db '*.*',00<br />crlf		db 0dh,0ah,'$'<br /><br />currdir		db 'Listenen surucu ve yol &#58; '<br />drive		db 00<br />		db '&#58;\'<br />path		db 64 dup &#40;00&#41;,0dh,0ah<br /><br /><br />dosyaadi	                db 8 dup &#40;' '&#41;<br />aralik		db 4 dup &#40;' '&#41;<br />dosyaadi2	db 3 dup &#40;' '&#41;<br /><br /><br />basla&#58;<br />	push	cs<br />	push	cs<br />	pop	ds<br />	pop	es<br />	<br />	mov ah,19h   ; Get Current Driver<br />	int 21h<br />	mov dl,al<br />	add al,'A'       <br />	mov byte ptr &#91;drive&#93;,al<br />	inc  dl<br />	mov ax,4700h<br />	lea si,path<br />	int 21h<br />	mov ah,40h<br />	mov cx,60<br />	xor bx,bx<br />	lea dx,currdir<br />	int 21h<br />	call procrlf<br /><br />	mov ax,1a00h  ; al=0 Set, al=1 Get DTA address<br />	lea dx,dta        ; New DTA<br />	int 21h<br />dir1&#58;	<br />	mov ax,4e00h<br /> 	lea dx,wildcard ; wildcard<br />	mov cx,00h       ; listed attribt<br />	int 21h<br /><br />	call convert    ; convert any<br /><br />	mov ah,4fh    ; search next file <br />	lea dx,dta      ; DTA <br />	int 21h<br />	cmp al,12h     ;error code 12 = file empty<br />	jnz dir1<br /><br />convert&#58;<br />	mov ah,40h<br />	mov bx,0<br />	mov cx,13<br />	lea dx,dta+1eh<br />	int 21h<br />	call procrlf<br />	ret	<br /><br />procrlf&#58;<br />	lea dx,crlf<br />	mov ah,09<br />	int 21h<br />	ret<br />		<br />	<br />cikis&#58;	int	20h<br /><br />		<br />seg_a		ends<br />		end	start<br /></code></pre><br /><br /><br /> have nice days,</div>
    <div class="meta">Posted on 2002-04-20 19:53:43 by CYDONIA</div>
   </div>
   <div class="post" id="post-34203">
    <div class="subject"><a href="#post-34203">the 4e(search) function of the 21h interrupt</a></div>
    <div class="body">thank u. dunno how i can do all these other functions  but not  search. well thank u. i'll have more question dealing with win32 pretty soon =)</div>
    <div class="meta">Posted on 2002-04-20 21:40:16 by Guy on ASM</div>
   </div>
  </div>
 </body>
</html>