<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>CreateProcess and OpenSSL - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=24629" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=24629">CreateProcess and OpenSSL</a></p>
   <div class="post" id="post-179794">
    <div class="subject"><a href="#post-179794">CreateProcess and OpenSSL</a></div>
    <div class="body">I got these codes from one of my program where I call console with the program name (.exe) and a command line (like: myprog.exe -d)<br />and then at the prompt I send the words that i want myprog.exe to decode, this is working perfectly. Now I use these same codes with OpenSSL<br />and it&#39;s not working at all. The call to CreateProcess works fine but the call to SSLUser and the other calls do not execute on the <br />command line.<br /><br />When I open cmd.exe and fill it with SSLOpen, SSLUser, SSLPass and TopRetrSSL it works just fine.<br /><br />Can you tell me what I do wrong?<br /><br /><br />Thank you<br /><br /><br /><br /><br /><pre><code>.data<br />SSLOpen?&nbsp; ?&nbsp; db &quot;openssl s_client -connect pop.ipname.ca -quiet&quot;,0<br />SSLUser?&nbsp; ?&nbsp; db &quot;user myemail@ipname.ca&quot;,13,10,0?&nbsp; ; my email address<br />SSLPass?&nbsp; ?&nbsp; db &quot;pass mypassword&quot;,13,10,0<br /><br />;after calling SSLPass I get the number of email(s) that I received <br /><br /><br />TopRetrSSL db?&nbsp; &quot;retr 1&quot;,13,10,0?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp;;retreiving email 1 if any<br /><br /><br />SSLQuit db &quot;Quit&quot;,13,10,0<br /><br /><br />SSLOpenproc?&nbsp; ?&nbsp;proc<br /><br />LOCAL hChildStdinRd :DWORD, hChildStdinWr, hChildStdinWrDup, hChildStdoutRd, hChildStdoutWr, hChildStdoutRdDup, hStdout,hGetP, dwRead<br />LOCAL bWritten :DWORD<br /><br /><br /><br />mov sat.nLength,sizeof SECURITY_ATTRIBUTES<br />mov sat.lpSecurityDescriptor,NULL<br />mov sat.bInheritHandle,TRUE<br /><br />invoke CreatePipe,addr hChildStdoutRd,addr hChildStdoutWr,addr sat,NULL<br />.if eax==NULL<br />invoke MessageBox,0,addr PipeFailed,0,0<br />.endif<br />?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; <br />invoke GetCurrentProcess<br />mov hGetP,eax<br /><br />invoke DuplicateHandle,hGetP,hChildStdoutRd,hGetP,addr hChildStdoutRdDup,0,FALSE,DUPLICATE_SAME_ACCESS<br />.if eax == NULL<br />invoke MessageBox,0,addr DuplicateHandleFailed,0,0<br />.endif<br />invoke CloseHandle,hChildStdoutRd<br /><br />invoke CreatePipe,addr hChildStdinRd,addr hChildStdinWr,addr sat,0<br />.if eax==NULL<br />invoke MessageBox,0,addr PipeFailed,0,0<br />.endif<br /><br />invoke GetCurrentProcess<br />mov hGetP,eax<br /><br />invoke DuplicateHandle,hGetP,hChildStdinWr,hGetP,addr hChildStdinWrDup,0,FALSE,DUPLICATE_SAME_ACCESS<br />.if eax == NULL<br />invoke MessageBox,0,addr DuplicateHandleFailed,0,0<br />.endif<br />invoke CloseHandle,hChildStdinWr<br /><br /><br />mov stinfo.cb,sizeof STARTUPINFO<br />invoke GetStartupInfo,addr stinfo<br />mov eax,hChildStdoutWr<br />mov stinfo.hStdOutput,eax<br />mov stinfo.hStdError,eax<br />mov eax,hChildStdinRd<br />mov stinfo.hStdInput,eax<br />mov stinfo.dwFlags,STARTF_USESHOWWINDOW+STARTF_USESTDHANDLES<br />mov stinfo.wShowWindow,SW_HIDE<br /><br /><br />invoke CreateProcess,NULL,addr SSLOpen,NULL,NULL,TRUE,0,NULL,NULL,addr stinfo,addr pinfo<br />.if eax==NULL<br />invoke MessageBox,0,ProcessFailed,0,0<br />.endif<br /><br />invoke WaitForSingleObject,pinfo.hProcess,2000<br /><br />invoke CloseHandle,pinfo.hProcess<br />invoke CloseHandle,pinfo.hThread<br /><br /><br />invoke lstrlen,addr SSLUser<br />mov dwRead,eax<br />invoke WriteFile,hChildStdinWrDup,addr SSLUser,dwRead,addr dwWritten,NULL ; <br /><br />invoke lstrlen,addr SSLPass<br />mov dwRead,eax<br />invoke WriteFile,hChildStdinWrDup,addr SSLPass,dwRead,addr dwWritten,NULL <br /><br />;after the above call I shoud get the number of email(s) I received, if any<br /><br /><br />invoke lstrlen,addr TopRetrSSL						?&nbsp; ?&nbsp; ;this should retreived the first email<br />mov dwRead,eax<br />invoke WriteFile,hChildStdinWrDup,addr TopRetrSSL,dwRead,addr dwWritten,NULL ;I did not try it yet<br /><br /><br />invoke CloseHandle,hChildStdinWrDup?&nbsp; ?&nbsp;<br />invoke CloseHandle,hChildStdoutWr<br /><br /><br />invoke ReadFile,hChildStdoutRdDup,addr szBuffer,5000,addr dwRead,NULL?&nbsp; ?&nbsp; ; if there&#39;s 1 email I should be able to <br />invoke WriteFile,hStdout,addr szBuffer,dwRead,addr dwWritten,NULL?&nbsp; ?&nbsp; ?&nbsp; ?&nbsp; ; read it in szBuffer.<br /><br /><br /><br />invoke lstrlen,addr SSLQuit<br />mov dwRead,eax<br />invoke WriteFile,hChildStdinWrDup,addr SSLQuit,dwRead,addr dwWritten,NULL<br /><br /><br /><br />ret<br />SSLOpenproc?&nbsp; ?&nbsp; ?&nbsp;endp</code></pre><br /><br /><span style="font-size:8pt>EDIT: Added code tags - Donkey</span><br /><br /><br /></div>
    <div class="meta">Posted on 2006-04-18 13:47:45 by Guy</div>
   </div>
   <div class="post" id="post-179799">
    <div class="subject"><a href="#post-179799">Re: CreateProcess and OpenSSL</a></div>
    <div class="body">Ugh, that&#39;s a lot of code to look through... Have you tried localizing the problem?<br /><br />I&#39;d suggest you to step through your program line by line in OllyDbg, checking return values from API calls to see if you&#39;re getting problems.<br /><br />Pretty interesting way of going about this btw., I&#39;d personally prefer using the OpenSSL libraries from my code, but this does seem simpler :)</div>
    <div class="meta">Posted on 2006-04-18 14:10:41 by f0dder</div>
   </div>
  </div>
 </body>
</html>