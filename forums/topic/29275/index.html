<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Short brief about stack frame, push(ad/fd), pop(ad/fd), call, leave, ret - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=29275" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=29275">Short brief about stack frame, push(ad/fd), pop(ad/fd), call, leave, ret</a></p>
   <div class="post" id="post-206779">
    <div class="subject"><a href="#post-206779">Short brief about stack frame, push(ad/fd), pop(ad/fd), call, leave, ret</a></div>
    <div class="body"><span class="text-center"><em>Any suggestions, examples and error reports are accepted</em></span><br /><br />As the subject says, this is just a short brief about common directives which I refer sometimes when I guess something is missing...<br /><br /><hr /><br /><br /><table><br /><tr><td><strong>THE STACK</strong> (common usage):</td></tr><br /><tr><td>&nbsp; &nbsp; - is used to store and cast data</td></tr><br /><tr><td>&nbsp; &nbsp; - should be aligned to DWORD (32 bits, 4 bytes)</td></tr><br /><tr><td>&nbsp; &nbsp; - ESP and EBP registers are used to move through the stack</td></tr><br /><tr><td>&nbsp; &nbsp; - ESP is the stack pointer and EBP is the base pointer used by functions</td></tr><br /><tr><td>&nbsp; &nbsp; - invoke a function means store one return address and parameters (if any) to the stack</td></tr><br /><tr><td>&nbsp; &nbsp; - declare local variables means create a stack frame subtracting a specified number of bytes to ESP</td></tr><br /><tr><td>&nbsp; &nbsp; - local variables differ from any else stored to the stack in the fact that they have a negative displacement from EBP</td></tr><br /></table><br /><br /><table><br /><tr><td><strong>STACK RELATED DIRECTIVES</strong> (common usage):</td></tr><br /><tr><td>&nbsp; &nbsp; - <em>PUSH </em>: stores temporary data to the stack subtracting 4 bytes to ESP</td></tr><br /><tr><td>&nbsp; &nbsp; - <em>PUSHAD</em>: pushes all the registers in the sequence EAX, ECX, EDX, EBX, ESP, EBP, ESI, EDI</td></tr><br /><tr><td>&nbsp; &nbsp; - <em>PUSHFD</em>: pushes the flag registers (EFLAGS)</td></tr><br /><tr><td>&nbsp; &nbsp; - <em>POP </em>: casts data from the stack adding 4 bytes to ESP, commonly used to balance PUSH</td></tr><br /><tr><td>&nbsp; &nbsp; - <em>POPAD</em>: pops 32 bytes to the registers in the sequence EDI, ESI, EBP, ESP, EBX, EDX, ECX, EAX</td></tr><br /><tr><td>&nbsp; &nbsp; - <em>POPFD</em>: pops 4 bytes to the flag registers (EFLAGS)</td></tr><br /><tr><td>&nbsp; &nbsp; - <em>CALL </em>: pushes the address after itself and jumps to the direct/indirect address</td></tr><br /><tr><td>&nbsp; &nbsp; - <em>LEAVE</em>: removes the stack frame restoring ESP and EBP back to their condition before the stack frame is initialized</td></tr><br /><tr><td>&nbsp; &nbsp; - <em>RET </em>: jumps to the address at ESP adding 4 bytes to ESP plus the parameters size in bytes</td></tr><br /><tr><td></td></tr><br /><tr><td>&nbsp; &nbsp; NOTES:</td></tr><br /><tr><td>&nbsp; &nbsp; - <em>RET </em> is the <u>STDCALL calling convention</u>, while <u>C calling convention</u> do only RET leaving the caller to adjust ESP</td></tr><br /></table><br /><br /><hr /><br /><pre><br /><strong>Example_Function proc var1:DWORD,var2:DWORD</strong><br /><br />******************************************************************************<br />*&nbsp; &nbsp;BEFORE COMPILING&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AFTER COMPILING&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*<br />******************************************************************************<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PUSH EBP (current value of ebp)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV EBP,ESP (sets the base pointer)<br /><br />&nbsp; &nbsp; local new_var:DWORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ADD ESP,-4 (creates the stack frame)<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NOTES:&nbsp; /\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  has the local variable<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  has the pushed value of ebp<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  has the address where return to<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  has the first parameter<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  has the second parameter<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/<br /><br />&nbsp; &nbsp; mov edx,new_var&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MOV EDX,DWORD PTR SS:<br /><br />&nbsp; &nbsp; mov eax,var1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV EAX,DWORD PTR SS:<br />&nbsp; &nbsp; mov ecx,var2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV ECX,DWORD PTR SS:<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LEAVE (restores esp and ebp)<br />&nbsp; &nbsp; Ret&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;RET 8 (&quot;pops&quot; the EIP &quot;releasing&quot; 8 bytes)<br /><br />******************************************************************************<br /><br /><strong>Example_Function endp</strong><br /></pre><br /><hr /><br /><pre><br /><strong>PUSH EAX</strong> acts like: mov dword ptr ss:,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add esp,-4<br /><br /><em>PUSH directive: first moves the given value to the 32 bits wide address before the stack pointer ESP,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; and second adjusts the register ESP.</em><br /><br /><u>The correct conceptual maneuver of PUSH ESP</u> is &quot;first moves..., and second adjusts...&quot;: mov dword ptr ss:,esp<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add esp,-4<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV DWORD PTR SS:,ESP<br />-------------------------------------&nbsp; &nbsp; &nbsp;--------------------------------------<br />|&nbsp; &nbsp;ESP - 4&nbsp; &nbsp;0012FFBC&nbsp; &nbsp;11111111&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp;|&nbsp; &nbsp;ESP - 4&nbsp; &nbsp;0012FFBC&nbsp; &nbsp;0012FFC0&nbsp; &nbsp; |<br />| &gt; ESP&nbsp; &nbsp; &nbsp; &nbsp;0012FFC0&nbsp; &nbsp;FFFFFFFF&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp;| &gt; ESP&nbsp; &nbsp; &nbsp; &nbsp;0012FFC0&nbsp; &nbsp;FFFFFFFF&nbsp; &nbsp; |<br />|&nbsp; &nbsp;ESP + 4&nbsp; &nbsp;0012FFC4&nbsp; &nbsp;00000000&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp;|&nbsp; &nbsp;ESP + 4&nbsp; &nbsp;0012FFC4&nbsp; &nbsp;00000000&nbsp; &nbsp; |<br />|&nbsp; &nbsp;ESP + 8&nbsp; &nbsp;0012FFC8&nbsp; &nbsp;00000000&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp;|&nbsp; &nbsp;ESP + 8&nbsp; &nbsp;0012FFC8&nbsp; &nbsp;00000000&nbsp; &nbsp; |<br />-------------------------------------&nbsp; &nbsp; &nbsp;--------------------------------------<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ADD ESP,-4<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -------------------------------------<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &gt; ESP&nbsp; &nbsp; &nbsp; &nbsp;0012FFBC&nbsp; &nbsp;0012FFC0&nbsp; &nbsp;|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp; &nbsp;ESP + 4&nbsp; &nbsp;0012FFC0&nbsp; &nbsp;FFFFFFFF&nbsp; &nbsp;|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp; &nbsp;ESP + 8&nbsp; &nbsp;0012FFC4&nbsp; &nbsp;00000000&nbsp; &nbsp;|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp; &nbsp;ESP + C&nbsp; &nbsp;0012FFC8&nbsp; &nbsp;00000000&nbsp; &nbsp;|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -------------------------------------<br /><br /><u>The wrong conceptual maneuver of PUSH ESP</u> is &quot;first adjusts..., and second moves...&quot;: add esp,-4<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov dword ptr ss:,esp<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ADD ESP,-4<br />-------------------------------------&nbsp; &nbsp; &nbsp;--------------------------------------<br />|&nbsp; &nbsp;ESP - 4&nbsp; &nbsp;0012FFBC&nbsp; &nbsp;11111111&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp;| &gt; ESP&nbsp; &nbsp; &nbsp; &nbsp;0012FFBC&nbsp; &nbsp;11111111&nbsp; &nbsp; |<br />| &gt; ESP&nbsp; &nbsp; &nbsp; &nbsp;0012FFC0&nbsp; &nbsp;FFFFFFFF&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp;|&nbsp; &nbsp;ESP + 4&nbsp; &nbsp;0012FFC0&nbsp; &nbsp;FFFFFFFF&nbsp; &nbsp; |<br />|&nbsp; &nbsp;ESP + 4&nbsp; &nbsp;0012FFC4&nbsp; &nbsp;00000000&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp;|&nbsp; &nbsp;ESP + 8&nbsp; &nbsp;0012FFC4&nbsp; &nbsp;00000000&nbsp; &nbsp; |<br />|&nbsp; &nbsp;ESP + 8&nbsp; &nbsp;0012FFC8&nbsp; &nbsp;00000000&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp;|&nbsp; &nbsp;ESP + C&nbsp; &nbsp;0012FFC8&nbsp; &nbsp;00000000&nbsp; &nbsp; |<br />-------------------------------------&nbsp; &nbsp; &nbsp;--------------------------------------<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV DWORD PTR SS:,ESP<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -------------------------------------<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &gt; ESP&nbsp; &nbsp; &nbsp; &nbsp;0012FFBC&nbsp; &nbsp;0012FFBC&nbsp; &nbsp;|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp; &nbsp;ESP + 4&nbsp; &nbsp;0012FFC0&nbsp; &nbsp;FFFFFFFF&nbsp; &nbsp;|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp; &nbsp;ESP + 8&nbsp; &nbsp;0012FFC4&nbsp; &nbsp;00000000&nbsp; &nbsp;|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp; &nbsp;ESP + C&nbsp; &nbsp;0012FFC8&nbsp; &nbsp;00000000&nbsp; &nbsp;|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -------------------------------------<br /><br /><br /><br /><strong>POP EAX</strong> acts like: add esp,4<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov eax,dword ptr ss:<br /><br /><em>POP directive: first adjusts the register ESP,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;and second moves the value from the 32 bits wide address before the stack pointer ESP.</em><br /><br /><u>The correct conceptual maneuver of POP ESP</u> is &quot;first adjusts..., and second moves...&quot;: add esp,4<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov esp,dword ptr ss:<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ADD ESP,4<br />-------------------------------------&nbsp; &nbsp; &nbsp;--------------------------------------<br />| &gt; ESP&nbsp; &nbsp; &nbsp; &nbsp;0012FFBC&nbsp; &nbsp;0012FFC0&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp;|&nbsp; &nbsp;ESP - 4&nbsp; &nbsp;0012FFBC&nbsp; &nbsp;0012FFC0&nbsp; &nbsp; |<br />|&nbsp; &nbsp;ESP + 4&nbsp; &nbsp;0012FFC0&nbsp; &nbsp;FFFFFFFF&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp;| &gt; ESP&nbsp; &nbsp; &nbsp; &nbsp;0012FFC0&nbsp; &nbsp;FFFFFFFF&nbsp; &nbsp; |<br />|&nbsp; &nbsp;ESP + 8&nbsp; &nbsp;0012FFC4&nbsp; &nbsp;00000000&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp;|&nbsp; &nbsp;ESP + 4&nbsp; &nbsp;0012FFC4&nbsp; &nbsp;00000000&nbsp; &nbsp; |<br />|&nbsp; &nbsp;ESP + C&nbsp; &nbsp;0012FFC8&nbsp; &nbsp;00000000&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp;|&nbsp; &nbsp;ESP + 8&nbsp; &nbsp;0012FFC8&nbsp; &nbsp;00000000&nbsp; &nbsp; |<br />-------------------------------------&nbsp; &nbsp; &nbsp;--------------------------------------<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV ESP,DWORD PTR SS:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -------------------------------------<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp; &nbsp;ESP - 4&nbsp; &nbsp;0012FFBC&nbsp; &nbsp;0012FFC0&nbsp; &nbsp;|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &gt; ESP&nbsp; &nbsp; &nbsp; &nbsp;0012FFC0&nbsp; &nbsp;FFFFFFFF&nbsp; &nbsp;|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp; &nbsp;ESP + 4&nbsp; &nbsp;0012FFC4&nbsp; &nbsp;00000000&nbsp; &nbsp;|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp; &nbsp;ESP + 8&nbsp; &nbsp;0012FFC8&nbsp; &nbsp;00000000&nbsp; &nbsp;|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -------------------------------------<br /><br /><u>The wrong conceptual maneuver of POP ESP</u> is &quot;first moves..., and second adjusts...&quot;: mov esp,dword ptr ss:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;add esp,4<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MOV ESP,DWORD PTR SS:<br />-------------------------------------&nbsp; &nbsp; &nbsp;-------------------------------------<br />| &gt; ESP&nbsp; &nbsp; &nbsp; &nbsp;0012FFBC&nbsp; &nbsp;0012FFC0&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp;|&nbsp; &nbsp;ESP - 4&nbsp; &nbsp;0012FFBC&nbsp; &nbsp;0012FFC0&nbsp; &nbsp;|<br />|&nbsp; &nbsp;ESP + 4&nbsp; &nbsp;0012FFC0&nbsp; &nbsp;FFFFFFFF&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp;| &gt; ESP&nbsp; &nbsp; &nbsp; &nbsp;0012FFC0&nbsp; &nbsp;FFFFFFFF&nbsp; &nbsp;|<br />|&nbsp; &nbsp;ESP + 8&nbsp; &nbsp;0012FFC4&nbsp; &nbsp;00000000&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp;|&nbsp; &nbsp;ESP + 4&nbsp; &nbsp;0012FFC4&nbsp; &nbsp;00000000&nbsp; &nbsp;|<br />|&nbsp; &nbsp;ESP + C&nbsp; &nbsp;0012FFC8&nbsp; &nbsp;00000000&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp;|&nbsp; &nbsp;ESP + 8&nbsp; &nbsp;0012FFC8&nbsp; &nbsp;00000000&nbsp; &nbsp;|<br />-------------------------------------&nbsp; &nbsp; &nbsp;-------------------------------------<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ADD ESP,4<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -------------------------------------<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp; &nbsp;ESP - 8&nbsp; &nbsp;0012FFBC&nbsp; &nbsp;0012FFC0&nbsp; &nbsp;|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp; &nbsp;ESP - 4&nbsp; &nbsp;0012FFC0&nbsp; &nbsp;FFFFFFFF&nbsp; &nbsp;|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &gt; ESP&nbsp; &nbsp; &nbsp; &nbsp;0012FFC4&nbsp; &nbsp;00000000&nbsp; &nbsp;|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp; &nbsp;ESP + 4&nbsp; &nbsp;0012FFC8&nbsp; &nbsp;00000000&nbsp; &nbsp;|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -------------------------------------<br /><br /><br /><br /><strong>LEAVE</strong> acts like: mov esp,ebp<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pop ebp<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- or -<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov esp,ebp<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;add esp,4<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov ebp,dword ptr ss:<br /><br /><br /><br /><strong>RET </strong> acts like: jmp dword ptr ss:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;add esp,4+<br /></pre><br /><hr /><br /><span class="text-left">Boomerang</span><br /><span class="text-right">Monday, February 02, 2009</span><br /></div>
    <div class="meta">Posted on 2009-02-01 23:02:53 by Boomerang</div>
   </div>
   <div class="post" id="post-206781">
    <div class="subject"><a href="#post-206781">Re: Short brief about stack frame, push(ad/fd), pop(ad/fd), call, leave, ret</a></div>
    <div class="body"> - is used to store and cast data <br />cast data? What is this?<br /><br /> - should be aligned to DWORD (32 bits, 4 bytes) <br />unless you&#039;re programming for 64-bit windows (fair enough, you&#039;re talking 32-bit)<br /><br /> - ESP and EBP registers are used to move through the stack <br />you can use ESP by itself, or any register not just EBP<br /><br /> - ESP is the stack pointer and EBP is the base pointer used by functions <br />EBP is usually used in masm when you have parameters or locals on the stack to access.<br />If you can keep track of ESP, you can use stuff like &quot;push &quot;, but debugging can be a bitch.<br />Just use &quot;option prologue:none&quot; and then there&#039;s no messing around with EBP, means you can use it at will.<br /><br />I am biased though - I hate macros and generally avoid using &#039;invoke&#039;.<br />When you need to push each parameter it makes you think (instead of &#039;invoke dword,dword,dword...)</div>
    <div class="meta">Posted on 2009-02-02 00:16:25 by sinsi</div>
   </div>
   <div class="post" id="post-206791">
    <div class="subject"><a href="#post-206791">Re: Short brief about stack frame, push(ad/fd), pop(ad/fd), call, leave, ret</a></div>
    <div class="body"><div class="quote"><br /> - is used to store and cast data <br />cast data? What is this?<br /><br /> - should be aligned to DWORD (32 bits, 4 bytes) <br />unless you&#039;re programming for 64-bit windows (fair enough, you&#039;re talking 32-bit)<br /><br /> - ESP and EBP registers are used to move through the stack <br />you can use ESP by itself, or any register not just EBP<br /><br /> - ESP is the stack pointer and EBP is the base pointer used by functions <br />EBP is usually used in masm when you have parameters or locals on the stack to access.<br />If you can keep track of ESP, you can use stuff like &quot;push &quot;, but debugging can be a bitch.<br />Just use &quot;option prologue:none&quot; and then there&#039;s no messing around with EBP, means you can use it at will.<br /><br />I am biased though - I hate macros and generally avoid using &#039;invoke&#039;.<br />When you need to push each parameter it makes you think (instead of &#039;invoke dword,dword,dword...)<br /></div><br /><br />- <em>to cast:</em> ...to throw out...<br />&nbsp; There are really many uses of this verb. I used it just to give an idea of what happens.<br />&nbsp; Obviously when you &quot;throw out&quot; something from the stack it remains in the stack, even with a POP.<br />&nbsp; Maybe the use of a debugger is the best solution to see how the stack works - <em>&quot;I know it when I see it&quot;</em><br />&nbsp; Another solution could be give some visual examples (tables, images, preformatted text) which can give an idea of some basic concepts.<br /><br />- <em>32 bits / 64 bits</em><br />&nbsp; I you have any good example about 64 bits registers (push, pop, etc...), please post it<br /><br />- <em>ESP and EBP</em><br />&nbsp; The solutions to use the stack could be a lot...<br />&nbsp; ESP is the stack pointer of choice used to move through the stack.<br />&nbsp; Usually (<em>common usage</em>) EBP is the base pointer used by functions.<br /><br />- <em>OPTION PROLOGUE:NONE, OPTION EPILOGUE:NONE, OPTION PROLOGUE:PROLOGUEDEF, OPTION EPILOGUE:EPILOGUEDEF</em><br />&nbsp; This could be a good idea to post an example, something like: BEFORE COMPILING / AFTER COMPILING<br /><br /><br />At last, an example about <strong>invoke</strong> and <strong>call</strong>.<br /><pre><br />***********************************************************************************<br />*&nbsp; &nbsp;BEFORE COMPILING&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;  AFTER COMPILING&nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;  *<br />***********************************************************************************<br /><br />&nbsp; &nbsp; invoke Example_Function,eax,ecx&nbsp; &nbsp; &nbsp; &nbsp;  PUSH ECX<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PUSH EAX<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CALL 00456379 (address of the function)<br /><br />&nbsp; &nbsp; push ecx&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PUSH ECX<br />&nbsp; &nbsp; push eax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PUSH EAX<br />&nbsp; &nbsp; call Example_Function&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  CALL 00456379 (address of the function)<br /><br />***********************************************************************************<br /></pre></div>
    <div class="meta">Posted on 2009-02-02 11:52:04 by Boomerang</div>
   </div>
  </div>
 </body>
</html>