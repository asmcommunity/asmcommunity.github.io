<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>midi - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=14453" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=14453">midi</a></p>
   <div class="post" id="post-111753">
    <div class="subject"><a href="#post-111753">midi</a></div>
    <div class="body">Eventually I want to write many notes of varing durations.<br />Can't figure out how to include the time variations  from<br />note to note.<br /><br />Below is the code to write 1 Note using Midi.<br />Needless to say it doesn't work...<br /><br />include \masm32\include\winmm.inc<br />includelib \masm32\lib\winmm.lib<br /><br />notes  dd  00403e90h  ; note D4<br /><br />376   push MIDI_MAPPER<br />377  pop <br /><br />378  invoke midiOutOpen, offset lphmo, , NULL, 0 CALLBACK_NULL<br />         (Why would I need a CallBack function)????<br />379  invoke MidiOutShortMsg, hmo, dword ptr  ; D4<br />380  invoke midiOutReset, hmo<br />381  invoke midiOutClose, hmo<br /><br />Errors generated:<br />     <br />378   error A2006: undefined symbol : uDeviceID<br />378   error A2114: invoke argument type mismatch: argument : 2<br />378   error A2006: undefined symbol : lphmo<br />378   error A2114: invoke argument type mismatch: argument: 1<br />379   error A2006: undefined symbol: hmo<br />379   error A2114: invoke argument type mismatch; argument: 1<br />380   error A2006: undefined symbol: hmo<br />380   error A2114: invoke argument type mismatch: argument: 1<br />381   error A2006: undefined symbol: hmo<br />381   error A2114: invoke argument type mismatch: argument: 1<br />377   error A2006: undefined symbol: MIDI_MAPPER<br /><br />Thanks for any help...</div>
    <div class="meta">Posted on 2003-07-24 15:55:19 by shankle</div>
   </div>
   <div class="post" id="post-111815">
    <div class="subject"><a href="#post-111815">midi</a></div>
    <div class="body">Hi Shankle,<br /><br />Notice the pointer to receive the handle to the open MIDI device, <em>offset lphmo</em>, you need to declare it as lphmo in the subsequent calls, not hmo.  A couple other points, undefined symbol: MIDI_MAPPER , this should be defined in windows.inc, I'm surprised you got the error. As for the other variables you should declare them like this:<br /><br />lphmo     HANDLE ?<br />uDeviceID	DWORD ?<br /><br />I meant to mention about the callback in my earlier post, you don't really need it, only if you want to intercept messages when the midi device is opened (MM_MOM_OPEN), finished playing (may be important for timing purposes), or closed. You can simply call it like this, where -1 is the default MIDI_MAPPER device.<br /><br />invoke midiOutOpen, offset lphmo, -1, 0,0,0	; Open default MIDI Out device<br /><br /><br />You might use a callback if you're trying to send System Exclusive messages, which can be used to send specific controlling messages to specific midi devices (i.e. Roland), but then you'd probably be handling real midi keyboard input and midiIn (MIM_*) messages as well.<br /><br />What's interesting is that, in theory at least, you can also send raw midi streams which include note durations and other musical information, using midiOutLongMsg and filling a MIDIHDR structure.  I believe this would avoid using messy timers and a bunch of midiOutShortMsg calls to try to play a sequence of notes to resemble something remotely musical!<br /><br />I haven't written any code to send a raw midi dump yet, though the information seems to be around.  What I did with the code was to create a virtual midi keyboard, mapped to the PC keyboard, as well as to buttons resembling a two octave piano keyboard.  Add a few effects sliders, knobs and buttons to twiddle with and it was kind of fun, but the project has been gathering dust recently. <br /><br />If you do want to try stringing together a bunch of notes/chords (I figured the opening line of Fur Elise might be good) using midiOutShortMsg, careful control of the note durations with a high res timer would be necessary. I may have a paper or two on high res timers if you want them.  I think you can forget about using the midiStream* API's to send a buffer of midi data, according to the newsgroups this was apparently an experiment of MicroSnort's they stopped developing, might have worked on Win95, I couldn't get them working in 98SE.<br /><br /><br />Here's a bit of code for sending a SysEx message (the Master Volume message is an example from some text and the code is only test code plus you'd have to specify the Device Control).<br /><pre><code>&#91;size=12&#93;<br />; Master Volume - This adjusts a device's master volume.<br />; Remember that in a multitimbral device, the Volume controller<br />; messages are used to control the volumes of the individual Parts.<br />; So, we need some message to control Master Volume. Here it is. <br /><br />;    0xF0  SysEx<br />;    0x7F  Realtime<br />;    0x7F  The SysEx channel. Could be from 0x00 to 0x7F.<br />;          Here we set it to &quot;disregard channel&quot;.<br />;    0x04  Sub-ID -- Device Control<br />;    0x01  Sub-ID2 -- Master Volume<br />;    0xLL  Bits 0 to 6 of a 14-bit volume<br />;    0xMM  Bits 7 to 13 of a 14-bit volume<br />;    0xF7  End of SysEx<br />	<br />SysExMessage1 	db 0F0h, 7Fh, 7Fh, 04h, 01h, 7Fh, 7Fh, 0F7h       <br /><br />...<br /><br />;-----------------------<br />; Prepare Header<br />;-----------------------<br /><br />push offset SysExMessage1<br />pop midiHdr.lpData ; Pointer to MIDI data<br /><br />mov midiHdr.dwFlags, 0<br />mov midiHdr.dwBufferiLength, 4*2<br />mov midiHdr.dwBytesRecorded, 4*2	<br /><br />invoke midiOutPrepareHeader, lphmo, offset midiHdr, SIZEOF midiHdr<br />invoke midiOutLongMsg, lphmo, offset midiHdr, SIZEOF midiHdr<br /><br />invoke Sleep, 10	; <br /><br />invoke midiOutUnprepareHeader, lphmo, offset midiHdr, SIZEOF midiHdr<br />invoke midiOutReset, lphmo<br />invoke midiOutClose, lphmo<br />&#91;/SIZE&#93; </code></pre><br /><br />And here's a Callback proc skeleton:<br /><pre><code>&#91;size=12&#93;<br />;======MidiOut_Callback proc======<br />MidiOut_Callback PROC hwnd&#58;DWORD, wmsg&#58;DWORD, inst&#58;DWORD,\<br />                     wparam&#58;DWORD, lparam&#58;DWORD<br /><br />.IF wmsg == MOM_OPEN <br />     ; sent to a window when a MIDI output device is opened<br />     mov eax, wparam	; Handle to the MIDI output device<br /><br />.ELSEIF wmsg == MOM_DONE<br />     ; sent to a window when the specified MIDI<br />     ; system-exclusive or stream buffer has been played<br />     ; and is being returned to the application.<br /><br />     mov eax, wparam<br />     ; Handle to the MIDI output device that played the buffer<br />     mov eax, lparam<br />     ; Pointer to a MIDIHDR structure identifying the buffer<br /><br />.ELSEIF wmsg == MOM_CLOSE <br /><br />.ENDIF<br />ret<br />MidiOut_Callback endp<br />;======End MidiOut_Callback proc======<br />&#91;/SIZE&#93; </code></pre><br /><br />Kayaker</div>
    <div class="meta">Posted on 2003-07-25 00:24:45 by Kayaker</div>
   </div>
   <div class="post" id="post-111843">
    <div class="subject"><a href="#post-111843">midi</a></div>
    <div class="body">Hi Kayaker,<br />Thanks so much for your help. Am in the process of checking out<br />your latest message. Will probably have more questions as soon<br />as I can make the necessary corrections.<br />The web sight you gave in another message helped a lot but I<br />have a long way to go with midi. <br /><br />Jack</div>
    <div class="meta">Posted on 2003-07-25 05:52:06 by shankle</div>
   </div>
   <div class="post" id="post-111863">
    <div class="subject"><a href="#post-111863">midi</a></div>
    <div class="body">A test code I used a few months ago:<br /><br /><pre><code><br />MIDIpack macro channel,command,a,b<br />	exitm &lt;&#40;command*16&#41;+channel+&#40;a*256&#41;+&#40;b*65536&#41;&gt;<br />endm<br />.data<br />	hMIDIout dd 0<br />.code<br />CreateMIDIout proc uses eax ebx ecx edx<br />	invoke midiOutOpen,addr hMIDIout,MIDI_MAPPER,0,hinst,CALLBACK_NULL <br />	invoke Sleep,100<br />	invoke midiOutShortMsg,hMIDIout,MIDIpack&#40;192,0,1,0&#41;<br />	invoke midiOutShortMsg,hMIDIout,MIDIpack&#40;144,0,67,127&#41;<br />	ret<br />CreateMIDIout endp<br /></code></pre><br /><br />MIDI is <strong>a lot easier</strong> than it seems! I created a complete sequencer in 20 days, as before that I didn't know MIDI file format and messages. You can see the sequencer at the demo version of Dreamer (my proggie) that is at my site (button below) ;)   <br />maybe I can give a few ideas, too :grin:</div>
    <div class="meta">Posted on 2003-07-25 12:05:21 by Ultrano</div>
   </div>
   <div class="post" id="post-111910">
    <div class="subject"><a href="#post-111910">midi</a></div>
    <div class="body">I have included an attachment with a snipit of MIDI code that WORKS...<br />HOWEVER, the sound (which I think is controlled by 07fh) is 33 to 50%<br />to soft..... Don't know what to do about that!<br /><br />162 = a 16th note<br />325 = an 8th note<br />650 = a quarter note<br /><br />Don't know how to represent a rest.<br /><br />Thanks for any help</div>
    <div class="meta">Posted on 2003-07-25 20:26:48 by shankle</div>
   </div>
   <div class="post" id="post-111947">
    <div class="subject"><a href="#post-111947">midi</a></div>
    <div class="body">before each note_on you reset the MIDI device :confused:  . I think this is your mistake. I can't test it myself now, but I think you have to replace all 'reset'-s  to &quot;note_off&quot; . Maybe the resetting at your soundcard leads also to setting the midi synth's master volume to 0, and restoring it to 100% in several hundred milliseconds. Thus, your first note will sound as if it has attack=100% , which , really produces 'soft' notes. Sending a note_off doesn't need the second parameter to be the same as it was in note_on ;)</div>
    <div class="meta">Posted on 2003-07-26 02:19:11 by Ultrano</div>
   </div>
   <div class="post" id="post-111956">
    <div class="subject"><a href="#post-111956">midi</a></div>
    <div class="body">I have included a revised snipit of the midi code.<br />I added code for the midi header from Kayaker which he said was<br />untested. I ran it and the sound stayed the same(you have to remember<br />I don't know what I am doing) He said I would have to make some change<br />to &quot;DEVICE CONTROL&quot; in the header but that completely loses me.<br /><br />Thanks for any help...</div>
    <div class="meta">Posted on 2003-07-26 08:22:16 by shankle</div>
   </div>
   <div class="post" id="post-111977">
    <div class="subject"><a href="#post-111977">midi</a></div>
    <div class="body">Ultrano has a point about the master midi volume may be reset by your code, I noticed a similar effect at times, check your mixer controls where I found you should have the Midi volume set fairly high for testing.  To use Note Off instead of the midiOutReset calls, just replace the 7Fh volume byte with 00h and send another midiOutShortMsg with it after your Sleep interval. <br /><br />You may get better sound as well if you choose another midi device over the Midi Mapper.  To get a list of the MIDI devices and their capabilities you can use midiOutGetNumDevs and midiOutGetDevCaps, there is a MIDIOUTCAPS structure that gives the name of the midi device as well as the wMid (Manufacturer ID) and wPid (Product Identifier).  I *think* one of these is what is required by the SysEx message Device Control identifier, but don't quote me on it, heheh.  Manufacturer and Product IDs are discussed in the SDK under the MIDIOUTCAPS description.  <br /><br />It's up to the midi device to interpret what you send it, garbage will be ignored, so you generally have no feedback from the SysEx messages as to whether they 'worked' or not unless you really know what you're sending.  There are several utilities around specifically designed for sending SysEx messages you can experiment with sometime.<br /><br />Note that midiOutGetNumDevs returns the number of MIDI output devices, which also happens to coincide with the value of , i.e. if you<br />push 3<br />pop <br />you'll choose the 3rd midi device listed to receive the midiOutShortMsg, chances are you only have a few other midi devices provided by your sound card, so you can try them all just by changing  to 0,1,2,...<br /><br />You should watch the copy/pasting as well, you need to invoke midiOutUnprepareHeader after midiOutLongMsg, not a second call to midiOutPrepareHeader.<br /><br />Kayaker</div>
    <div class="meta">Posted on 2003-07-26 13:51:10 by Kayaker</div>
   </div>
   <div class="post" id="post-111979">
    <div class="subject"><a href="#post-111979">midi</a></div>
    <div class="body">:grin:   I got my previous code wrong. Maybe I had modified it after I stopped using it. This works fine:<br /><pre><code><br />.data<br />	hMIDIout dd 0<br />.code<br />MIDIpack macro channel,command,a,b<br />	exitm &lt;&#40;channel*16&#41;+command+&#40;a*256&#41;+&#40;b*65536&#41;&gt; <br />endm   ; had swapped places of channel and command<br />	<br />	<br />TestBakaMIDI proc<br />	local hinst,i<br />	invoke GetModuleHandle,0<br />	mov hinst,eax<br />	invoke midiOutOpen,addr hMIDIout,\<br />		MIDI_MAPPER,0,hinst,CALLBACK_NULL <br />	invoke Sleep,200<br />	mov i,50<br />	.while i&lt;60<br />	mov eax,i<br />	shl eax,8<br />	add eax,MIDIpack&#40;9,0,0,127&#41;<br />	invoke midiOutShortMsg,hMIDIout,eax<br />	invoke Sleep,260<br />	mov eax,i<br />	shl eax,8<br />	add eax,MIDIpack&#40;8,0,0,127&#41;<br />	invoke midiOutShortMsg,hMIDIout,eax<br />	inc i<br />	.endw<br />	invoke midiOutClose,hMIDIout<br />	;print 'ok'<br />	ret<br />TestBakaMIDI endp<br /></code></pre><br /><br />I also tested with the NoteOff replaced by Reset. On my YMF724 I get glitches from Reset, but I don't get the notes softer. Synth is different, so I can't help with that. <br />btw, why don't you replace all the lines of code for sending different notes into an automated task - supply an array or two, and its size.</div>
    <div class="meta">Posted on 2003-07-26 14:30:22 by Ultrano</div>
   </div>
   <div class="post" id="post-111980">
    <div class="subject"><a href="#post-111980">midi</a></div>
    <div class="body">:grin:  <strong>nice melody</strong> :alright:<br /><br />I decided to help with making the function I mentioned above. Have fun:<br /><pre><code><br />.data<br />	D5  equ 4ah  ;pitches<br />	F4  equ 41h<br />	A4  equ 45h<br />	G4  equ 43h<br />	C5  equ 48h<br />	b4  equ 46h  ; this is Bb4<br />	<br />	L1  equ 0 ;162  ;durations<br />	L2  equ 1 ;325<br />	L3  equ 2 ;650<br />	<br />	notes 		db F4,A4,A4,F4,A4,G4,F4,C5,b4,G4,A4,b4,A4,C5,A4,C5,A4,G4,A4,b4,F4<br />	durations	db L2,L2,L2,L2,L1,L1,L2,L3,L2,L2,L2,L2,L1,L1,L2,L3,L2,L2,L2,L2,L1<br />	notes_num equ &#40;$-notes&#41;/2<br />.code<br />	<br />PlayMahNotes proc<br />	xor ecx,ecx<br />	.while ecx&lt;notes_num<br />	push ecx<br />	movzx eax,notes&#91;ecx&#93;<br />	shl eax,8<br />	add eax,MIDIpack&#40;9,0,0,127&#41; ; note_on, velocity is 127<br />	invoke midiOutShortMsg,hMIDIout,eax<br />	pop ecx<br />	push ecx<br />	mov eax,162<br />	movzx ecx,durations&#91;ecx&#93;<br />	shl eax,cl<br />	invoke Sleep,eax<br />	pop ecx<br />	push ecx<br />	movzx eax,notes&#91;ecx&#93;<br />	shl eax,8<br />	add eax,MIDIpack&#40;8,0,0,0&#41; ; note off<br />	invoke midiOutShortMsg,hMIDIout,eax<br />	<br />	pop ecx<br />	inc ecx<br />	.endw<br />	<br />	<br />	ret<br />PlayMahNotes endp<br /></code></pre></div>
    <div class="meta">Posted on 2003-07-26 14:46:57 by Ultrano</div>
   </div>
  </div>
 </body>
</html>