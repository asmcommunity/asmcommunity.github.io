<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>New problems with exagone's giflib... - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=2499" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=2499">New problems with exagone's giflib...</a></p>
   <div class="post" id="post-15765">
    <div class="subject"><a href="#post-15765">New problems with exagone's giflib...</a></div>
    <div class="body">i want to Blt a welcome bitmap at the beginning of my snake game. this bitmap would be very big, so i decided to use exagone's giflib to load the welcome image as a gif. i created a procedure to do that job. but the problem is, that no matter how much gifs i load, and no matter which i want to display on the screen, there is ALWAYS displayed the one that i loaded first. i don't know if i forgot to clean something up or anything else. Following you have the Gif-loading-procedure and the other necessary procedures.<br /><br /><pre><code><br />LoadAGIF proc uses edi esi ebx edx gifnr&#58;DWORD,ptr_Bitmapinfo&#58;DWORD,ptr_Surface&#58;DWORD,bmpwidth&#58;DWORD,bmpheight&#58;DWORD<br />      <br />      invoke	GIFLoadResource, ADDR logogif, hInstance,gifnr<br />	invoke	GIFLoadHeader, ADDR logogif<br />	invoke	GIFInitalizeDecoder, ADDR logogif<br />      invoke	GIFGetMinimumColorType, ADDR logogif	<br />	mov		logogif.dwImageFormat, eax				<br />	invoke	GIFFillBitmapInfoStruct, ADDR logogif, ADDR BitmapInfo<br />	invoke	GIFGetColorTable, ADDR logogif, ADDR ColorTable<br />	<br />    <br />        <br />	  _ZeroMemory ddsd,sizeof&#40;DDSURFACEDESC2&#41;<br />	  mov ddsd.dwSize,sizeof&#40;DDSURFACEDESC2&#41;<br />	  mov ddsd.dwFlags,DDSD_CAPS OR DDSD_HEIGHT OR DDSD_WIDTH<br />	  mov ddsd.ddsCaps.dwCaps,DDSCAPS_OFFSCREENPLAIN <br />	  mov eax,bmpwidth<br />	  mov ddsd.dwWidth,eax<br />	  mov eax,bmpheight<br />	  mov ddsd.dwHeight,eax<br />        mcall &#91;LPDD&#93;,IDirectDraw7_CreateSurface,addr ddsd,ptr_Surface,NULL<br />	  .if eax==DD_OK<br />		  ; Load bitmap to surface<br />              mov edi,&#91;ptr_Surface&#93;<br />              assume edi&#58;ptr LPDIRECTDRAWSURFACE7<br />		  mcall &#91;&#91;edi&#93;&#93;,IDirectDrawSurface7_GetDC,addr hdc<br />              .if eax!=DD_OK<br />                FATAL &quot;GetDC failed!&quot;<br />              .endif<br />		  invoke CreateCompatibleDC,hdc<br />		  mov hbmpdc,eax<br />              invoke	CreateDIBSection, hdc, ADDR BitmapInfo, DIB_RGB_COLORS,\<br />				 addr bitptr, NULL, NULL<br />	        mov	hbitmap, eax<br />	        push	bitptr<br />	        pop	logogif.lpImageData<br />	        invoke	GIFDecompress, ADDR logogif<br />	        invoke  GIFCleanup, addr logogif<br /><br />		  invoke SelectObject,hbmpdc,hbitmap<br />            invoke GetObject,hbitmap,sizeof&#40;BITMAP&#41;,ptr_Bitmapinfo<br /><br />		  invoke BitBlt,hdc,0,0,bmpwidth,bmpheight,hbmpdc,0,0,SRCCOPY<br />              .if eax==0<br />                FATAL &quot;BitBlt failed!&quot;<br />              .endif<br />		  invoke DeleteDC,hbmpdc<br />		  mcall &#91;&#91;edi&#93;&#93;,IDirectDrawSurface7_ReleaseDC,hdc<br />           <br />              assume edi&#58;nothing<br />              xor eax,eax<br />              ret	<br />	 .endif<br />       <br />       mov eax,-1<br />       ret<br />        <br />LoadAGIF endp<br /></code></pre><br /><br />here is the call to that procedure:<br /><br /><pre><code><br />invoke LoadAGIF,2011,addr bmp_welcomemask_info,offset surface_welcomemask,480,300<br />invoke LoadAGIF,2012,addr bmp_welcomesprite_info,offset surface_welcomesprite,480,300<br /></code></pre><br /><br />and although i loaded &quot;welcomesprite&quot; too, the following call paints the &quot;welcomemask&quot;:<br /><br /><pre><code><br />invoke DrawSimpleBitmap,50,50,offset surface_welcomesprite,offset bmp_welcomesprite_info<br /></code></pre><br /><br />here is the &quot;DrawSimpleBitmap&quot; procedure:<br /><pre><code><br />DrawSimpleBitmap proc uses edi esi x&#58;DWORD,y&#58;DWORD,ptr_surface&#58;DWORD,ptr_Bitmapinfo&#58;DWORD<br />      LOCAL rc &#58; RECT<br />      mov esi,&#91;ptr_Bitmapinfo&#93;<br />	assume esi&#58;ptr BITMAP<br />	mov eax,x<br />	mov rc.left,eax<br />	mov rc.right,eax<br />	mov eax,y<br />	mov rc.top,eax<br />	mov rc.bottom,eax<br />	mov eax,&#91;esi&#93;.bmWidth<br />	add rc.right,eax<br />      mov eax,&#91;esi&#93;.bmHeight<br />	add rc.bottom,eax<br />	invoke RtlZeroMemory,addr ddbltfx,sizeof&#40;DDBLTFX&#41;<br />	mov ddbltfx.dwSize,sizeof&#40;DDBLTFX&#41;<br />      assume esi&#58;nothing<br />      mov esi,&#91;ptr_surface&#93;<br />      assume esi&#58;ptr LPDIRECTDRAWSURFACE7<br />	mcall &#91;dds_back&#93;,IDirectDrawSurface7_Blt,addr rc,&#91;esi&#93;,NULL,DDBLT_WAIT,addr ddbltfx<br />      assume esi&#58;nothing<br />      .if eax!=DD_OK<br />        FATAL &quot;Bliting the bitmap failed!&quot;<br />      .endif<br />      <br /><br />	ret<br />DrawSimpleBitmap endp<br /></code></pre><br /><br />and here you have my rc-file:<br /><pre><code><br />2008 BITMAP &quot;Bitmaps\body2_sprite.bmp&quot;<br />2009 BITMAP &quot;Bitmaps\snakefood_mask.bmp&quot;<br />2010 BITMAP &quot;Bitmaps\snakefood_sprite.bmp&quot;<br />2011 RCDATA &quot;Bitmaps\welcome_mask.gif&quot;<br />2012 RCDATA &quot;Bitmaps\welcome_sprite.gif&quot;<br />2013 RCDATA &quot;Bitmaps\welcome.gif&quot;<br /></code></pre><br /><br />i would be very glad if i could load the gifs without any problems, cause there is a big difference between loading a 500KB bitmap and a 13KB GIF.....<br /><br />thanks,<br /><br />  nop</div>
    <div class="meta">Posted on 2001-12-22 06:28:19 by NOP-erator</div>
   </div>
   <div class="post" id="post-15789">
    <div class="subject"><a href="#post-15789">Didn't look at the code but...</a></div>
    <div class="body"><div class="quote">i want to Blt a welcome bitmap at the beginning of my snake game</div><br />If this is something like a SplashScreen, you may take a look at my SplashScreenLib (uploaded in the Algorithm section): with only 1 instruction you may add the SplashScreen to your Snake Game.<br /><br />Sincerely,<br />   Daniel<br /><br />P.S.<br />The image must be stored ad as a Bitmap in the resources: this may enlarge you executable. Use an exe compressor (maybe UPX?) to shrink it again.</div>
    <div class="meta">Posted on 2001-12-22 12:22:43 by dguzz</div>
   </div>
   <div class="post" id="post-15857">
    <div class="subject"><a href="#post-15857">ok</a></div>
    <div class="body">yeah, that would be probably ok, but it would be big in memory after unpacking, know what i mean? that's not that bad, but.....it doesn't solve my real problem.<br /><br />Thomas/exagone, i thought that you could perhaps help me with that?<br /><br />thanks,<br />   nop</div>
    <div class="meta">Posted on 2001-12-23 03:24:35 by NOP-erator</div>
   </div>
   <div class="post" id="post-15861">
    <div class="subject"><a href="#post-15861">New problems with exagone's giflib...</a></div>
    <div class="body">Hmm...<br />I'm not sure of just a thing: are resources loaded in memory when the application starts or only when they're explicitally loaded by the application?<br />If they're loaded only when used, my SplashScreen Load the Bitmap and then Destroy it.<br /><br />Moreover, if your SplshScreen is not very big (300 x 200) and uses only 256 colors, the memory occupied is 60kb. I do not think this is a big memory occupation, working with actual PC where the minimum amount of memory is 64Mb or 128Mb and 256Mb are now common.<br /><br />Sincerely,<br />   Daniel</div>
    <div class="meta">Posted on 2001-12-23 04:59:19 by dguzz</div>
   </div>
   <div class="post" id="post-15863">
    <div class="subject"><a href="#post-15863">New problems with exagone's giflib...</a></div>
    <div class="body">NOP-erator: I don't see any problems with the GIFlib code, you are using it correctly..<br />Try blitting to some window instead of the directx surface DC, to see if the GIF code works...<br /><br />I think the gif is loaded correctly though. The only other thing I noticed is that the temporary DC (hdc) is destroyed without releasing the bitmap from it.<br /><br />It should be this:<br /><pre><code><br />invoke  CreateCompatibleDC,hdc<br />mov     hbmpdc,eax<br />invoke  CreateDIBSection, hdc, ADDR BitmapInfo, DIB_RGB_COLORS,\<br />            addr bitptr, NULL, NULL<br />mov     hbitmap, eax<br />push    bitptr<br />pop     logogif.lpImageData<br />invoke  GIFDecompress, ADDR logogif<br />invoke  GIFCleanup, addr logogif<br /><br />invoke  SelectObject,hbmpdc,hbitmap<br />push    eax     ;save old bitmap selected in hbmpdc<br />invoke  GetObject,hbitmap,sizeof&#40;BITMAP&#41;,ptr_Bitmapinfo<br /><br />invoke  BitBlt,hdc,0,0,bmpwidth,bmpheight,hbmpdc,0,0,SRCCOPY<br />pop     ecx<br />.if eax==0<br />    FATAL &quot;BitBlt failed!&quot;<br />.endif<br /><br />invoke  SelectObject, hbmpdc, ecx<br />invoke  DeleteObject, hbitmap   ;don't forget to destroy the bitmap as well<br />invoke  DeleteDC, hbmpdc<br /></code></pre><br /><br />Maybe this causes it.<br /><br />Thomas</div>
    <div class="meta">Posted on 2001-12-23 05:25:34 by Thomas</div>
   </div>
   <div class="post" id="post-15888">
    <div class="subject"><a href="#post-15888">strange......</a></div>
    <div class="body">hi,<br /><br />i tried your code without bliting on a dx surface, just on a normal window. then it works.......strange.......i think i have to test some things. is it possible to Blt a GDI-DC to a DX-DC?<br /><br />nop</div>
    <div class="meta">Posted on 2001-12-23 11:16:01 by NOP-erator</div>
   </div>
   <div class="post" id="post-15899">
    <div class="subject"><a href="#post-15899">ok, i have the bug now.....!</a></div>
    <div class="body">hi thomas,<br /><br />as i told you, this deleting of the bitmap was NOT the problem. I tried all things i could to get it to work. i changed the variables for every call of the LoadAGif procedure, i changed the order of the code, i tried everything. finally i decided to use GIFLoadFile instead of GIFLoadResource, and........IT WORKS!!! <br /><br />conclusion: there is something....no, there MUST be something wrong with your GIFLoadResource procedure. remember another game from me? this monopoly stuff? i had the same problem there, but there it appeared after my .data section became incredibly big. <br /><br />could you have a look over your GIFLoadResource procedure again, please? i think this is evidence enough that there must be the bug.....<br /><br />nop</div>
    <div class="meta">Posted on 2001-12-23 12:09:53 by NOP-erator</div>
   </div>
   <div class="post" id="post-15903">
    <div class="subject"><a href="#post-15903">New problems with exagone's giflib...</a></div>
    <div class="body">Hmm really strange.. the GIFLoadResource function is pretty straight forward:<br /><pre><code><br />;===============================================================================<br />;   GIFLoadResource<br />;===============================================================================<br />; Loads gif data from a resource &#40;of type RT_RCDATA&#41;<br />; lpName&#58;pointer to a resource name OR resource ID<br />GIFLoadResource proc uses esi edi lpGifInfo&#58;DWORD, hInst&#58;DWORD, lpName&#58;DWORD<br />    mov     esi, lpGifInfo<br />    assume  esi&#58;PTR GIF_INFO<br />    <br />    invoke  FindResource, hInst, lpName, RT_RCDATA<br />    .IF     eax==0<br />        ret<br />    .ENDIF<br />    push    eax<br />    invoke  LoadResource, hInst, eax<br />    .IF     eax==0<br />        pop     ecx<br />        ret<br />    .ENDIF<br />    mov     &#91;esi&#93;.lpGIFData, eax<br />    pop     eax<br />    invoke  SizeofResource, hInst, eax<br />    .IF     eax==0<br />        ret<br />    .ENDIF<br />    mov     &#91;esi&#93;.dwGIFDataSize, eax<br />    assume  esi&#58;nothing<br />xor     eax, eax<br />inc     eax<br />ret<br />GIFLoadResource endp<br /></code></pre><br /><br />I don't see anything that can go wrong here? What value does it return?<br />You can also load the gif resource yourself with the code above, and see where it goes wrong.<br /><br />Thomas</div>
    <div class="meta">Posted on 2001-12-23 12:19:03 by Thomas</div>
   </div>
   <div class="post" id="post-15907">
    <div class="subject"><a href="#post-15907">idea?</a></div>
    <div class="body">i perhaps have an good idea: how about loading the resource the same way as you do with the file? why don't you get a pointer to the resource data (you can also get the size easily), and then copy this resource to allocated memory (GlobalAlloc).<br /><br />i don't know how to do that, cause i don't know how to copy the resource to the memory location.......perhaps you can do that?<br /><br />bye,<br /><br /> nop</div>
    <div class="meta">Posted on 2001-12-23 12:42:40 by NOP-erator</div>
   </div>
   <div class="post" id="post-15909">
    <div class="subject"><a href="#post-15909">New problems with exagone's giflib...</a></div>
    <div class="body">I don't see any reason to do so but here you go:<br /><pre><code><br />invoke  GIFLoadResource, ADDR logogif, hInstance,gifnr<br />invoke  GlobalAlloc, GMEM_FIXED, logogif.dwGIFDataSize<br />mov     ecx, logogif.lpGIFData<br />mov     logogif.lpGIFData, eax<br />invoke  MemCopy, eax, ecx, logogif.dwGIFDataSize<br /></code></pre><br />(untested code)<br /><br />Memory should be freeed with GlobalFree too (There is a bug in the file demo, I didn't cleanup memory allocated to load the file. It's in the documentation though).<br /><br />Thomas</div>
    <div class="meta">Posted on 2001-12-23 12:57:47 by Thomas</div>
   </div>
   <div class="post" id="post-15910">
    <div class="subject"><a href="#post-15910">New problems with exagone's giflib...</a></div>
    <div class="body">If this doesn't work, rename the procedure I posted (the GIFLoadResource one) to something else, and use that one instead of GIFLoadResource. Add some breakpoints or debug code and tell me if some function fails.<br /><br />Thomas</div>
    <div class="meta">Posted on 2001-12-23 12:59:40 by Thomas</div>
   </div>
   <div class="post" id="post-15947">
    <div class="subject"><a href="#post-15947">hmmm</a></div>
    <div class="body">ok, my idea did not work. the same result. this is what i found out:<br /><br />- if i use your GIFLoadResource and try to display the second GIF (welcomesprite), it shows me the first GIF (welcomemask)<br /><br />- if i insert the code for your GIFLoadResource manually, and then try to display the second gif, i just get a black bitmap.<br /><br /><pre><code><br />lea esi, logogif<br />assume	esi&#58;PTR GIF_INFO<br />invoke	FindResource,hInstance,gifnr,RT_RCDATA<br />push eax<br />invoke	LoadResource,hInstance,eax<br />mov	&#91;esi&#93;.lpGIFData, eax<br />pop eax<br />invoke	SizeofResource,hInstance,eax<br />mov          &#91;esi&#93;.dwGIFDataSize, eax<br />assume	esi&#58;nothing<br /></code></pre><br /><br />- your code that you postet last, makes the WHOLE screen black, and nothing happens. i changed the code a bit, but the second gif wasn't displayed properly, too. one half was welcomemask, and the other half of black. <br /><br />- i started debugging the second point (loading the resource manually), and found out, that FindResource returns zero after calling the procedure the second time to load welcomesprite. I used GetLastError to find out which error it is exactly, and got error 56 - The parameter is not correct!<br /><br />but what does that mean? what parameter is not correct? the resource number of the gif was ok, the hInstance was ok, and RT_RCDATA is a constant, everything was the same, but the resource number (but it was ok, too).  <br /><br />really strange. There is also another strange thing: when i load the two gifs in a &quot;normal&quot; program and Blit them on a &quot;normal&quot; window, it works. reeeeally strange. but why didn't work with my monopoly game? hmm, my monopoly game had a big data section, but......... I'm confused :confused: <br /><br />nop</div>
    <div class="meta">Posted on 2001-12-24 04:25:27 by NOP-erator</div>
   </div>
   <div class="post" id="post-15949">
    <div class="subject"><a href="#post-15949">New problems with exagone's giflib...</a></div>
    <div class="body"><div class="quote"><br />- i started debugging the second point (loading the resource manually), and found out, that FindResource returns zero after calling the procedure the second time to load welcomesprite. I used GetLastError to find out which error it is exactly, and got error 56 - The parameter is not correct! <br /></div><br /><br />Well one of these has to be incorrect:<br />1. hInstance: although unlikely, you didn't forget to initialize hInstance?<br />2. resID: should be okay<br />3. RT_RCDATA: this is the only thing I can think of, what value does this constant have in your include file? Its 10 (dec) for me. If it's wrong in your version that would explain why it didn't work for the monopoly game either.<br /><br />If all these are correct, is the resource file linked correctly?<br /><br />Thomas</div>
    <div class="meta">Posted on 2001-12-24 04:54:42 by Thomas</div>
   </div>
   <div class="post" id="post-15951">
    <div class="subject"><a href="#post-15951">it works now!!</a></div>
    <div class="body">ok, it works now. you know what i did? i first tried to get a valid handle to all the resources when i use LoadResource one after the other. it worked. then i changed my code into this:<br /><br /><pre><code><br />invoke	FindResource,hInstance,2011,RT_RCDATA<br />                                   mov gifarray&#91;0&#93;,eax<br />                                   invoke FindResource,hInstance,2012,RT_RCDATA<br />                                   mov gifarray&#91;4&#93;,eax<br />                                   invoke LoadAGIF,gifarray&#91;0&#93;,addr bmp_welcomemask_info,offset surface_welcomemask,480,300,hWin<br />                                   invoke LoadAGIF,gifarray&#91;4&#93;,addr bmp_welcomesprite_info,offset surface_welcomesprite,480,300,hWin<br /><br />-----------------------<br />;this is the gifloading procedure&#58;<br />lea		esi, logogif<br />	assume	esi&#58;PTR GIF_INFO<br />      invoke	LoadResource,hInstance,gifnr<br />      mov		&#91;esi&#93;.lpGIFData, eax<br />      invoke	SizeofResource,hInstance,gifnr<br />	mov		&#91;esi&#93;.dwGIFDataSize, eax<br />      assume	esi&#58;nothing<br /><br /></code></pre><br /><br />that's all. don't ask me, why i don't get a valid handle to the resources, when i don't load them one after the other.....<br /><br />thanks for your effort,<br /><br />nop</div>
    <div class="meta">Posted on 2001-12-24 05:41:13 by NOP-erator</div>
   </div>
   <div class="post" id="post-15973">
    <div class="subject"><a href="#post-15973">New problems with exagone's giflib...</a></div>
    <div class="body">Hmm really strange.. I've never had problems with loading multiple gifs sequentially, but I'm glad it works now.<br /><br />Thomas</div>
    <div class="meta">Posted on 2001-12-24 09:41:23 by Thomas</div>
   </div>
  </div>
 </body>
</html>