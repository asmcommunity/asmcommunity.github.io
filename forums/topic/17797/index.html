<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Oh No, 16 bit code has returned - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=17797" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=12">The Heap</a> &raquo; <a href="../?id=17797">Oh No, 16 bit code has returned</a></p>
   <div class="post" id="post-137374">
    <div class="subject"><a href="#post-137374">Oh No, 16 bit code has returned</a></div>
    <div class="body">I would like to change this to your typical program with data declarations first then code so I don't have to have all those code segment overrides. I am adding more code later, this just checks if there has been any<br />modifications.<br /><br />Thanks.<br /><br />; chksum.asm  Masm code<br />;             Checksum this file up to stored_value(4 bytes)<br />;             Use checksum.exe to calculate the stored_value <br />; Autodin-II CRC-32 algorithmn<br />; Much help from Jeff<br />;<br /><br />CODE SEGMENT<br />.586<br /><br />sseg  segment para stack use16 'STACK'<br />      dw      128 dup(?)        ; reserve 256 bytes<br />sseg  ends<br /><br />assume cs:code<br /><br />Start: <br />        call    setFree                         ; free unused DOS memory<br />  <br />        mov     ax, (32 * 1024) / 16            ; now request 32k of memory<br />        call    memAlloc                        ; for file buffer<br />        mov     cs:, ax             ; save segment to variable<br />        push    cs<br />        pop     ds<br /><br /><br />        lea     dx, filename<br />        mov     ax, 03D00h                      ; Open for read.<br />        int     21h <br /><br />        push    cs <br />        pop     ds <br />        jnc     fileOk<br />        jmp     error2                          ; file open error?<br /><br />fileok:<br />        mov     word ptr cs:, ax<br /><br />; DOS 2+ - &quot;LSEEK&quot; - SET CURRENT FILE POSITION<br />;	AH = 42h<br />;	AL = origin of move<br />;	    00h start of file<br />;	    01h current file position<br />;	    02h end of file<br />;	BX = file handle<br />;	CX:DX = (signed) offset from origin of new file position<br />;Return: CF clear if successful<br />;	    DX:AX = new file position in bytes from start of file<br />;	CF set on error<br />;	    AX = error code (01h,06h) (see #01680 at AH=59h/BX=0000h)<br />       <br /><br /> ; find the size of the file we want to CRC<br /><br />        xor     cx, cx                          ; Read length of file<br />        xor     dx, dx                          ;<br />        mov     bx, cs:                   ; get file handle<br />        mov     ax, 4202h                       ; move to end of file<br />        int     21h                             ; dx:ax has file size<br />                                                ; dx has # of 64k chunks<br />                                                ; we need # 32k chunks<br />        shl     dx, 1                           ; so double it.<br />        mov     cs:, dx                 ; save counter<br />        inc     cs:                     ; make counter 1 based<br /><br />        sub     ax, 4                           ; don't do last 4 bytes<br /><br />        cmp     ax, 32 * 1024                   ; is leftover &gt; 32k?<br />        jb      sizeOK                          ; add 1 to chunk counter<br />        inc     cs:                     ; and remove 32k from size<br />        sub     ax, 32 * 1024<br /><br />sizeOK:<br />        <br />        mov     cs:, ax              ; save # of leftovers<br />        <br />        xor     cx, cx                          ; pos file back to start<br />        xor     dx, dx<br />        mov     bx, cs:<br />        mov     ax, 4200h<br />        int     21h<br /><br />read:<br />        mov     cx, 32 * 1024                   ; read 32k<br />        cmp     cs:, 1                  ; is this the last 32k chunk?<br />        jnz     notLast                         ; yes,<br />        mov     cx, cs:              ; then read the remainder<br />notLast:<br /><br />        mov     ah, 03Fh                        ; read function<br />        mov     bx, word ptr cs:          ; get file handle<br />        mov     dx, cs:             ; point DS:DX to file buffer<br />        mov     ds, dx                          ;<br />        xor     dx, dx                          ; <br />        int     21h                             ; read bytes into memory<br />        jc      error3                          ; ax=# of bytes read<br /><br />        xor     si, si                          ; point DS:SI to buffer<br />        call    updateCRC32                     ; do calculation<br />        dec     cs:                     ; decrement chunk counter<br />        jnz     read                            ; not finished? loop again<br /><br />        ; complete file has been read<br />        <br />        push    cs                              ; set segments back to code<br />        pop     ds<br /><br />        xor     word ptr cs:, 0FFFFh   ; Finish CRC calculation. <br />        xor     word ptr cs:, 0FFFFh <br />close: <br />        mov     bx, word ptr cs: <br />        mov     ah, 3Eh                         ; close file. <br />        int     21h <br /><br />; See if this file has been modified by<br />; doing a checksum and comparing to a stored checksum value<br /><br />compare:<br />        mov     eax,cs:<br />        mov     ebx,cs:<br />        cmp     eax,ebx<br />        jnz     mod_made<br /><br />exit:   ;Instead of exiting, continue on with code for program<br /><br />        mov     ah, 4Ch                        ; exit with errorlevel <br />        int     21h <br /><br />mod_made:<br />       mov      ah,9<br />       lea      dx,tamper<br />       int      21h<br />       mov      al,1<br />       jmp      exit<br /><br />error2: <br /><br />        mov     ah, 09h <br />        lea     dx, errmsg2 <br />        int     21h <br />        mov     al, 2h                          ; Exit errorlevel 2. <br />        jmp     exit <br /><br />error3: <br /><br />        mov     ah, 09h <br />        lea     dx, errmsg3 <br />        int     21h <br />        mov     al, 3h                          ; Exit errorlevel 3. <br />        jmp     exit <br /><br />; UpdateCRC32 takes an initial CRC value and updates it from <br />; data in file buffer. The updated CRC is then stored in InitCRC. <br />; input: DS:SI points to buffer to calculate<br />;        AX=number of bytes to process<br /><br />UpdateCRC32 proc near<br />        mov     cx, ax <br />        jcxz    bye <br />        les     ax, cs: <br />        mov     dx, ES <br />lo2: <br />        xor     bh, bh <br />        mov     bl, al <br />        lodsb <br />        xor     bl, al <br />        mov     al, ah <br />        mov     ah, dl <br />        mov     dl, dh <br />        xor     dh, dh <br />        shl     bx, 1 <br />        shl     bx, 1 <br />        les     bx, cs: <br />        xor     ax, bx <br />        mov     bx, ES <br />        xor     dx, bx <br />        loop    lo2 <br />        mov     word ptr cs:, ax ; Store result in InitCRC <br />        mov     word ptr cs:, dx <br />bye: <br />        ret <br />UpdateCRC32 endp <br /><br />;-- SETFREE: Release memory not used  ----------------<br />;-- Input    : ES = address of PSP<br />;-- Output   : none<br />;-- Register : AX, BX, CL and FLAGS are changed <br />;-- Info     : Since the stack-segment is always the last segment in an <br />;              EXE-file, ES:0000 points to the beginning and SS:SP<br />;              to the end of the program in memory. Through this the<br />;              length of the program can be calculated <br />; call this routine once at the beginning of the program to free up memory<br />; assigned to it by DOS.<br /><br />setfree   proc near<br /><br />          mov  bx,ss              ;first subtract the two segment addresses<br />          mov  ax,es              ;from each other. The result is<br />          sub  bx,ax              ;number of paragraphs from PSP<br />                                  ;to the beginning of the stack<br />          mov  ax,sp              ;since the stackpointer is at the end of<br />          mov  cl,4               ;the stack segment, its content indicates<br />          shr  ax,cl              ;the length of the stack<br />          add  bx,ax              ;add to current length<br />          inc  bx                 ;as precaution add another paragraph<br /><br />          mov  ah,4ah             ;pass new length to DOS<br />          int  21h<br />          ret                     ;back to caller<br /><br />setfree   endp<br /><br /><br />memalloc	proc<br /><br />; input: AX = # of paragraphs required<br />; output: AX = segment of block to use<br />	push	bx<br />	mov	bx, ax<br />	mov	ah, 48h<br />	int	21h<br />	pop	bx<br />	ret<br />memalloc	endp<br /><br />; 32 bit reverse crc table for polynomial EDB88320h (Zmodem,PKZip) <br />; X^32+X^26+X^23+X^22+X^16+X^12+X^11+X^10+X^8+X^7+X^5+X^4+X^2+X^1+X^0 <br /><br />crc32tab dd 000000000h, 077073096h, 0ee0e612ch, 0990951bah, 0076dc419h <br />dd 0706af48fh, 0e963a535h, 09e6495a3h, 00edb8832h, 079dcb8a4h <br />dd 0e0d5e91eh, 097d2d988h, 009b64c2bh, 07eb17cbdh, 0e7b82d07h <br />dd 090bf1d91h, 01db71064h, 06ab020f2h, 0f3b97148h, 084be41deh <br />dd 01adad47dh, 06ddde4ebh, 0f4d4b551h, 083d385c7h, 0136c9856h <br />dd 0646ba8c0h, 0fd62f97ah, 08a65c9ech, 014015c4fh, 063066cd9h <br />dd 0fa0f3d63h, 08d080df5h, 03b6e20c8h, 04c69105eh, 0d56041e4h <br />dd 0a2677172h, 03c03e4d1h, 04b04d447h, 0d20d85fdh, 0a50ab56bh <br />dd 035b5a8fah, 042b2986ch, 0dbbbc9d6h, 0acbcf940h, 032d86ce3h <br />dd 045df5c75h, 0dcd60dcfh, 0abd13d59h, 026d930ach, 051de003ah <br />dd 0c8d75180h, 0bfd06116h, 021b4f4b5h, 056b3c423h, 0cfba9599h <br />dd 0b8bda50fh, 02802b89eh, 05f058808h, 0c60cd9b2h, 0b10be924h <br />dd 02f6f7c87h, 058684c11h, 0c1611dabh, 0b6662d3dh, 076dc4190h <br />dd 001db7106h, 098d220bch, 0efd5102ah, 071b18589h, 006b6b51fh <br />dd 09fbfe4a5h, 0e8b8d433h, 07807c9a2h, 00f00f934h, 09609a88eh <br />dd 0e10e9818h, 07f6a0dbbh, 0086d3d2dh, 091646c97h, 0e6635c01h <br />dd 06b6b51f4h, 01c6c6162h, 0856530d8h, 0f262004eh, 06c0695edh <br />dd 01b01a57bh, 08208f4c1h, 0f50fc457h, 065b0d9c6h, 012b7e950h <br />dd 08bbeb8eah, 0fcb9887ch, 062dd1ddfh, 015da2d49h, 08cd37cf3h <br />dd 0fbd44c65h, 04db26158h, 03ab551ceh, 0a3bc0074h, 0d4bb30e2h <br />dd 04adfa541h, 03dd895d7h, 0a4d1c46dh, 0d3d6f4fbh, 04369e96ah <br />dd 0346ed9fch, 0ad678846h, 0da60b8d0h, 044042d73h, 033031de5h <br />dd 0aa0a4c5fh, 0dd0d7cc9h, 05005713ch, 0270241aah, 0be0b1010h <br />dd 0c90c2086h, 05768b525h, 0206f85b3h, 0b966d409h, 0ce61e49fh <br />dd 05edef90eh, 029d9c998h, 0b0d09822h, 0c7d7a8b4h, 059b33d17h <br />dd 02eb40d81h, 0b7bd5c3bh, 0c0ba6cadh, 0edb88320h, 09abfb3b6h <br />dd 003b6e20ch, 074b1d29ah, 0ead54739h, 09dd277afh, 004db2615h <br />dd 073dc1683h, 0e3630b12h, 094643b84h, 00d6d6a3eh, 07a6a5aa8h <br />dd 0e40ecf0bh, 09309ff9dh, 00a00ae27h, 07d079eb1h, 0f00f9344h <br />dd 08708a3d2h, 01e01f268h, 06906c2feh, 0f762575dh, 0806567cbh <br />dd 0196c3671h, 06e6b06e7h, 0fed41b76h, 089d32be0h, 010da7a5ah <br />dd 067dd4acch, 0f9b9df6fh, 08ebeeff9h, 017b7be43h, 060b08ed5h <br />dd 0d6d6a3e8h, 0a1d1937eh, 038d8c2c4h, 04fdff252h, 0d1bb67f1h <br />dd 0a6bc5767h, 03fb506ddh, 048b2364bh, 0d80d2bdah, 0af0a1b4ch <br />dd 036034af6h, 041047a60h, 0df60efc3h, 0a867df55h, 0316e8eefh <br />dd 04669be79h, 0cb61b38ch, 0bc66831ah, 0256fd2a0h, 05268e236h <br />dd 0cc0c7795h, 0bb0b4703h, 0220216b9h, 05505262fh, 0c5ba3bbeh <br />dd 0b2bd0b28h, 02bb45a92h, 05cb36a04h, 0c2d7ffa7h, 0b5d0cf31h <br />dd 02cd99e8bh, 05bdeae1dh, 09b64c2b0h, 0ec63f226h, 0756aa39ch <br />dd 0026d930ah, 09c0906a9h, 0eb0e363fh, 072076785h, 005005713h <br />dd 095bf4a82h, 0e2b87a14h, 07bb12baeh, 00cb61b38h, 092d28e9bh <br />dd 0e5d5be0dh, 07cdcefb7h, 00bdbdf21h, 086d3d2d4h, 0f1d4e242h <br />dd 068ddb3f8h, 01fda836eh, 081be16cdh, 0f6b9265bh, 06fb077e1h <br />dd 018b74777h, 088085ae6h, 0ff0f6a70h, 066063bcah, 011010b5ch <br />dd 08f659effh, 0f862ae69h, 0616bffd3h, 0166ccf45h, 0a00ae278h <br />dd 0d70dd2eeh, 04e048354h, 03903b3c2h, 0a7672661h, 0d06016f7h <br />dd 04969474dh, 03e6e77dbh, 0aed16a4ah, 0d9d65adch, 040df0b66h <br />dd 037d83bf0h, 0a9bcae53h, 0debb9ec5h, 047b2cf7fh, 030b5ffe9h <br />dd 0bdbdf21ch, 0cabac28ah, 053b39330h, 024b4a3a6h, 0bad03605h <br />dd 0cdd70693h, 054de5729h, 023d967bfh, 0b3667a2eh, 0c4614ab8h <br />dd 05d681b02h, 02a6f2b94h, 0b40bbe37h, 0c30c8ea1h, 05a05df1bh <br />dd 02d02ef8dh <br /><br />initcrc dd 0FFFFFFFFh ;Initial CRC value <br /><br />errmsg2 db 'Error 2, cannot open file.',0Dh,0Ah,24h <br />errmsg3 db 'Error 3, cannot read file.',0Dh,0Ah,24h <br />tamper  db 'File has been altered !!'<br /><br />crlf            db      0Dh,0Ah,24h<br />fileBufSeg      dw      0                       ; storage for file buffer seg<br />hndl            dw      0                       ; File handle storage. <br />chunks          dw      0                       ; # of 32k chunks in file<br />remainder       dw      0                       ; # of bytes leftover<br />filename        db      &quot;chksum.exe&quot;,0<br /><br />; checksum is done on file up to here<br />stored_value    dd      0203605DEh<br />                                                <br />CODE ENDS <br />End Start</div>
    <div class="meta">Posted on 2004-03-30 06:54:17 by skywalker</div>
   </div>
   <div class="post" id="post-137376">
    <div class="subject"><a href="#post-137376">Oh No, 16 bit code has returned</a></div>
    <div class="body">hihihi ...<br /><br />Call exorcism()<br /><br />just joking ...</div>
    <div class="meta">Posted on 2004-03-30 07:36:15 by BogdanOntanu</div>
   </div>
   <div class="post" id="post-137496">
    <div class="subject"><a href="#post-137496">Oh No, 16 bit code has returned</a></div>
    <div class="body">You are already setting DS equal to CS. All DOS file functions return with DS unchanged, so you only have to set it once at the beginning and once after you read form the file. You can do away with the CS: prefixes and it will work fine.<br />Btw, I sense some bloat in the code, like setting DX equal to  and then not using it. And I suggest you change the code right after the call to get the file size to the following:<pre><code>sub ax,4<br />sbb dx,-1<br />add ax,ax<br />rcl dx,1<br />shr ax,1<br />mov &#91;chunks&#93;,dx<br />mov &#91;remainder&#93;,ax</code></pre>This ensures that it won't pick up the prison soap when the low byte of the file size is less than 4.<br />You might also want to rearrange the reading loop somewhat and make the counter 0 based.</div>
    <div class="meta">Posted on 2004-03-31 11:49:40 by Sephiroth3</div>
   </div>
   <div class="post" id="post-137497">
    <div class="subject"><a href="#post-137497">Oh No, 16 bit code has returned</a></div>
    <div class="body">You could also generate the CRC32 table at program startup, instead of hardcoding the large table in your app.</div>
    <div class="meta">Posted on 2004-03-31 11:50:42 by f0dder</div>
   </div>
   <div class="post" id="post-137504">
    <div class="subject"><a href="#post-137504">Generate CRC 32 table</a></div>
    <div class="body"><div class="quote"><br />You could also generate the CRC32 table at program startup, instead of hardcoding the large table in your app. </div><br /><br />Could you help me with that. It sounds like it would save some bytes.<br /><br />Thanks.</div>
    <div class="meta">Posted on 2004-03-31 13:27:19 by skywalker</div>
   </div>
   <div class="post" id="post-137505">
    <div class="subject"><a href="#post-137505">Oh No, 16 bit code has returned</a></div>
    <div class="body">A little board search and googling turned up this:<br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=17782&amp;highlight=crc32">http://www.asmcommunity.net/board/index.php?topic=17782&amp;highlight=crc32</a> - 32bit asm CRC32 &amp; tableinit<br /><a target="_blank" href="http://search.cpan.org/src/PMQS/Compress-Zlib-1.33/zlib-src/crc32.c">http://search.cpan.org/src/PMQS/Compress-Zlib-1.33/zlib-src/crc32.c</a> - C CRC32 &amp; tableinit<br /><a target="_blank" href="http://www.bsdg.org/swag/CRC/0010.PAS.html">http://www.bsdg.org/swag/CRC/0010.PAS.html</a> - pascal CRC32 &amp; tableinit<br /><br />There's bound to be a LOT of code around, and probably ready-to-use 16bit tableinit as well, but google is your friend there - I only returned some quick hits :)</div>
    <div class="meta">Posted on 2004-03-31 13:45:59 by f0dder</div>
   </div>
   <div class="post" id="post-137710">
    <div class="subject"><a href="#post-137710">Oh No, 16 bit code has returned</a></div>
    <div class="body">Since you are interested in 16-bit coding, I suggest you to try the linker from Digital Mars. It creates MZ signed executables with smaller file header.<br /><br /><a target="_blank" href="http://www.digitalmars.com">http://www.digitalmars.com</a></div>
    <div class="meta">Posted on 2004-04-02 04:16:56 by Vortex</div>
   </div>
   <div class="post" id="post-137719">
    <div class="subject"><a href="#post-137719">Oh No, 16 bit code has returned</a></div>
    <div class="body"><div class="quote"><br />Since you are interested in 16-bit coding, I suggest you to try the linker from Digital Mars. It creates MZ signed executables with smaller file header.<br /><br /><a target="_blank" href="http://www.digitalmars.com">http://www.digitalmars.com</a> </div><br /><br />I found a C and C++ compiler but no separate linker. How much smaller a file header is it capable of.<br /><br />Thanks.</div>
    <div class="meta">Posted on 2004-04-02 06:36:55 by skywalker</div>
   </div>
   <div class="post" id="post-137724">
    <div class="subject"><a href="#post-137724">Oh No, 16 bit code has returned</a></div>
    <div class="body">Vortex, does the DM linker support 16bit execytables, though?</div>
    <div class="meta">Posted on 2004-04-02 07:00:52 by f0dder</div>
   </div>
   <div class="post" id="post-137789">
    <div class="subject"><a href="#post-137789">Oh No, 16 bit code has returned</a></div>
    <div class="body">f0dder,<br /><br />Yes, the DM linker supports 16-bit executables, you can check the attachment.<br /><br />skywalker,<br /><br />You can download the C/C++ compiler package including the linker from:<br /><br /><a target="_blank" href="ftp://ftp.digitalmars.com/Digital_Mars_C++/Patch/dm840c.zip">ftp://ftp.digitalmars.com/Digital_Mars_C++/Patch/dm840c.zip</a><br /><br />A simple hello world application linked with DM linker : 79 bytes<br />                                                          MS 16-bit linker :  543 bytes</div>
    <div class="meta">Posted on 2004-04-03 02:53:33 by Vortex</div>
   </div>
  </div>
 </body>
</html>