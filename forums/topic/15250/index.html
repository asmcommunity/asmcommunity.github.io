<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Creating a Working Desktop - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=15250" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=15250">Creating a Working Desktop</a></p>
   <div class="post" id="post-118481">
    <div class="subject"><a href="#post-118481">Creating a Working Desktop</a></div>
    <div class="body">This will create a desktop.... then it will make a working Dialog... right now im having one problem that i will have to do a system wide hook i think unless you guys know another way to tell a program to use a diff desktop...<br /><br />right now all i know is that i have to tell the problem to use my desktop with this api SetThreadDesktop<br /><br />EDIT: I Removed the CreateWrokStation is not needed<br /><br /><pre><code><br />; #########################################################################<br /><br />      .386<br />      .model flat, stdcall<br />      option casemap &#58;none   ; case sensitive<br /><br />; #########################################################################<br /><br />      include \masm32\include\windows.inc<br />      include \masm32\include\user32.inc<br />      include \masm32\include\kernel32.inc<br />      include \masm32\include\comdlg32.inc<br /><br />      includelib \masm32\lib\user32.lib<br />      includelib \masm32\lib\kernel32.lib<br />      includelib \masm32\lib\comdlg32.lib<br />; #########################################################################<br /><br />      ;=============<br />      ; Local macros<br />      ;=============<br /><br />      szText MACRO Name, Text&#58;VARARG<br />        LOCAL lbl<br />          jmp lbl<br />            Name db Text,0<br />          lbl&#58;<br />        ENDM<br /><br />      m2m MACRO M1, M2<br />        push M2<br />        pop  M1<br />      ENDM<br /><br />      return MACRO arg<br />        mov eax, arg<br />        ret<br />      ENDM<br /><br />        ;=================<br />        ; Local prototypes<br />        ;=================<br />        EnumWindowsProc proto &#58;DWORD,&#58;DWORD<br />        WinMain PROTO &#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD<br />        WndProc PROTO &#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD<br />        TopXY PROTO   &#58;DWORD,&#58;DWORD<br />        ListBox PROTO &#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD<br />        EditBox PROTO &#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD<br />        ButtonBox PROTO &#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD<br />        ListBoxProc PROTO &#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD<br />        ReadPffFileInside PROTO &#58;DWORD<br />        Extract PROTO &#58;DWORD<br />;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br /><br />    .const<br /><br />    .data<br />        DesktopName db &quot;Desktop2&quot;,0<br />        DesktopName1 db &quot;Desktop1&quot;,0<br />        szND1TXT db &quot;Input Desktop Not Found&quot;,0<br />        szND1CAP db &quot;Error 1&quot;,0<br />        szND2TXT db &quot;Error Creating New WorkStation&quot;,0<br />        szND2CAP db &quot;Error 2&quot;,0<br />        szND3TXT db &quot;Error Setting Access To New WorkStation&quot;,0<br />        szND3CAP db &quot;Error 3&quot;,0<br />        szND4TXT db &quot;Error Creating New Desktop&quot;,0<br />        szND4CAP db &quot;Error 4&quot;,0<br />        szND5TXT db &quot;Error Switching To New Desktop&quot;,0<br />        szND5CAP db &quot;Error 5&quot;,0<br />        szND6TXT db &quot;Error SetThreadDesktop&quot;,0<br />        szND6CAP db &quot;Error 6&quot;,0<br />        Run_Buffer db &quot;progman.exe&quot;,0<br />        ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br />        szDisplayName db &quot;Testing&quot;,00<br />        <br />   .data?<br />        Blank dd ?<br />        Blank1 dd ?<br />        Blank2 dd ?<br />        Sec SECURITY_ATTRIBUTES &lt;&gt;<br />        Sec2 SECURITY_ATTRIBUTES &lt;&gt;<br />        hDesktop dd ?<br />        hNDeskTop dd ?<br />        OldDesk dd ?<br />        pvInfo USEROBJECTFLAGS &lt;&gt;<br />        pvSize dd ?<br />        ProcessInfo  PROCESS_INFORMATION &lt;&gt;<br />        StartupInfo  STARTUPINFO &lt;&gt;<br />        lParam2 dd ?<br />        lpfn dd ?<br />        ;lParam dd ?<br />        ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br />        CommandLine dd ?<br />        hWnd dd ?<br />        hInstance dd ?<br />.code<br />;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br /><br />start&#58;<br />invoke OpenInputDesktop,DF_ALLOWOTHERACCOUNTHOOK,TRUE,DESKTOP_CREATEMENU or DESKTOP_CREATEWINDOW\<br />                       or DESKTOP_ENUMERATE or DESKTOP_HOOKCONTROL or DESKTOP_JOURNALPLAYBACK\<br />                       or DESKTOP_JOURNALRECORD or DESKTOP_READOBJECTS or DESKTOP_SWITCHDESKTOP\<br />                       or DESKTOP_WRITEOBJECTS<br />mov OldDesk,eax<br />cmp eax,NULL<br />je NoDesk1<br /><br />mov Sec2.nLength,0Ch<br />mov Sec2.lpSecurityDescriptor,NULL<br />mov Sec2.bInheritHandle,TRUE<br />invoke CreateDesktop,offset DesktopName1,Blank1,Blank2,DF_ALLOWOTHERACCOUNTHOOK,DESKTOP_CREATEMENU\<br />                       or DESKTOP_CREATEWINDOW or DESKTOP_ENUMERATE or DESKTOP_HOOKCONTROL\<br />                       or DESKTOP_JOURNALPLAYBACK or DESKTOP_JOURNALRECORD or DESKTOP_READOBJECTS\<br />                       or DESKTOP_SWITCHDESKTOP or DESKTOP_WRITEOBJECTS,offset Sec2<br /><br />mov hNDeskTop,eax<br />cmp eax,NULL<br />je NoDesk4<br /><br />invoke SetThreadDesktop,hNDeskTop<br />cmp eax,NULL<br />je NoDesk6<br /><br />invoke SwitchDesktop,hNDeskTop<br />cmp eax,NULL<br />je NoDesk5<br /><br />;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br />        invoke GetModuleHandle, NULL<br />        mov hInstance, eax<br /><br />        invoke GetCommandLine<br />        mov CommandLine, eax<br /><br />        invoke WinMain,hInstance,NULL,CommandLine,SW_SHOWDEFAULT<br />        invoke CloseDesktop,hNDeskTop<br />        invoke ExitProcess,eax<br /><br />; #########################################################################<br /><br />WinMain proc hInst     &#58;DWORD,<br />             hPrevInst &#58;DWORD,<br />             CmdLine   &#58;DWORD,<br />             CmdShow   &#58;DWORD<br /><br />        ;====================<br />        ; Put LOCALs on stack<br />        ;====================<br /><br />        LOCAL wc   &#58;WNDCLASSEX<br />        LOCAL msg  &#58;MSG<br /><br />        LOCAL Wwd  &#58;DWORD<br />        LOCAL Wht  &#58;DWORD<br />        LOCAL Wtx  &#58;DWORD<br />        LOCAL Wty  &#58;DWORD<br /><br />        ;==================================================<br />        ; Fill WNDCLASSEX structure with required variables<br />        ;==================================================<br /><br />        mov wc.cbSize,         sizeof WNDCLASSEX<br />        mov wc.style,          CS_BYTEALIGNWINDOW<br />        mov wc.lpfnWndProc,    offset WndProc<br />        mov wc.cbClsExtra,     NULL<br />        mov wc.cbWndExtra,     NULL<br />        m2m wc.hInstance,      hInst   ;&lt;&lt; NOTE&#58; macro not mnemonic<br />        mov wc.hbrBackground,  COLOR_BTNFACE+1<br />        mov wc.lpszMenuName,   NULL<br />        mov wc.lpszClassName,  offset szClassName<br />        <br />        invoke LoadIcon,hInst,500    ; icon ID<br /><br />        mov wc.hIcon,          eax<br /><br />        invoke LoadCursor,NULL,IDC_ARROW<br /><br />        mov wc.hCursor,        eax<br />        mov wc.hIconSm,        0<br /><br />        invoke RegisterClassEx, ADDR wc<br /><br />        ;================================<br />        ; Centre window at following size<br />        ;================================<br /><br />        mov Wwd, 250<br />        mov Wht, 680<br />        mov Wtx, 0<br />        mov Wty, 0<br /><br />        szText szClassName,&quot;Template_Class&quot;<br /><br />        invoke CreateWindowEx,WS_EX_CONTROLPARENT or WS_EX_CLIENTEDGE,<br />                              ADDR szClassName,<br />                              ADDR szDisplayName,<br />                              WS_SYSMENU or WS_MINIMIZEBOX or WS_CAPTION,<br />                              Wtx,Wty,Wwd,Wht,<br />                              NULL,NULL,<br />                              hInst,NULL<br />        mov   hWnd,eax<br /><br />        invoke LoadMenu,hInst,600  ; menu ID<br />        invoke SetMenu,hWnd,eax<br /><br />        invoke ShowWindow,hWnd,SW_SHOWNORMAL<br />        invoke UpdateWindow,hWnd<br /><br />      ;===================================<br />      ; Loop until PostQuitMessage is sent<br />      ;===================================<br /><br />    StartLoop&#58;<br />      invoke GetMessage,ADDR msg,NULL,0,0<br />      cmp eax, 0<br />          je ExitLoop<br />      invoke TranslateMessage, ADDR msg<br />      invoke DispatchMessage,  ADDR msg<br />          jmp StartLoop<br /><br />    ExitLoop&#58;<br /><br />      return msg.wParam<br /><br />WinMain endp<br /><br />; #########################################################################<br /><br />WndProc proc hWin   &#58;DWORD,<br />             uMsg   &#58;DWORD,<br />             wParam &#58;DWORD,<br />             lParam &#58;DWORD<br /><br />    .if uMsg == WM_COMMAND<br />    ;======== menu commands ========<br />        .if wParam == 1000<br />        .elseif wParam == 1001<br />            invoke SendMessage,hWin,WM_SYSCOMMAND,SC_CLOSE,NULL<br />        .elseif wParam == 3000<br />        .elseif wParam == 3001<br />        .elseif wParam == 1900<br />        .elseif wParam == 503<br />        .elseif wParam == 2000<br />        .endif<br />    ;====== end menu commands ======<br /><br />    .elseif uMsg == WM_CREATE<br />    .elseif uMsg == WM_CLOSE<br />    .elseif uMsg == WM_DESTROY<br />        invoke PostQuitMessage,NULL<br />        return 0<br />    .endif<br /><br />    invoke DefWindowProc,hWin,uMsg,wParam,lParam<br /><br />    ret<br /><br />WndProc endp<br /><br />NoDesk1&#58;<br />invoke MessageBoxA,NULL,offset szND1TXT,offset szND1CAP,MB_OK<br />jmp Exit<br /><br />NoDesk2&#58;<br />invoke MessageBoxA,NULL,offset szND2TXT,offset szND2CAP,MB_OK<br />jmp Exit<br /><br />NoDesk3&#58;<br />;int 3<br />invoke MessageBoxA,NULL,offset szND3TXT,offset szND3CAP,MB_OK<br />jmp Exit<br /><br />NoDesk4&#58;<br />invoke MessageBoxA,NULL,offset szND4TXT,offset szND4CAP,MB_OK<br />jmp Exit<br /><br />NoDesk5&#58;<br />invoke MessageBoxA,NULL,offset szND5TXT,offset szND5CAP,MB_OK<br />jmp Exit<br /><br />NoDesk6&#58;<br />invoke MessageBoxA,NULL,offset szND6TXT,offset szND6CAP,MB_OK<br /><br />Exit&#58;<br />invoke CloseDesktop,hNDeskTop<br />invoke ExitProcess,NULL<br /><br />end start<br /></code></pre></div>
    <div class="meta">Posted on 2003-09-17 18:21:43 by devilsclaw</div>
   </div>
   <div class="post" id="post-118493">
    <div class="subject"><a href="#post-118493">Creating a Working Desktop</a></div>
    <div class="body">I found out why Creating a Window Station of my own does not work the way i wanted... there was no need for it anyway but i just wanted to see how much i could do...<br /><br />The interactive window station, Winsta0, is the only window station that can display a user interface or receive user input. It is assigned to the logon session of the interactive user, and contains the keyboard, mouse, and display device. All other window stations are noninteractive, which means they cannot display a user interface or receive user input. Running services under a different account prevents them from accessing the interactive window station. For more information, see</div>
    <div class="meta">Posted on 2003-09-17 20:10:09 by devilsclaw</div>
   </div>
  </div>
 </body>
</html>