<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>need help with factorial function - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=14994" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=14994">need help with factorial function</a></p>
   <div class="post" id="post-116388">
    <div class="subject"><a href="#post-116388">need help with factorial function</a></div>
    <div class="body">i am trying to write a factorial function,but the fpu stack<br />is driving me nuts.<br />let's say that St(0)=x<br />                 ecx=x<br />how do you write a procedure such that we keep the partial factorial in<br />the fpu stack and also the cummulative x=x-1 and have the final factorial in St(0)?<br />any help is appreciated.</div>
    <div class="meta">Posted on 2003-08-31 19:16:30 by jack</div>
   </div>
   <div class="post" id="post-116394">
    <div class="subject"><a href="#post-116394">need help with factorial function</a></div>
    <div class="body">this works, is there a better way?<br /><pre><code><br /> fld1<br /> cmp ecx,0<br /> je fac3<br /> sub ecx,1<br /> jz fac3<br />fac2&#58;<br /> fmul st0,st1<br /> fld st1<br /> fld1<br /> fsubp st1,st0 <br /> fstp st2<br /> sub ecx,1<br /> jnz fac2<br />fac3&#58;<br /> fstp st1<br /> fstp st1<br /></code></pre></div>
    <div class="meta">Posted on 2003-08-31 20:15:04 by jack</div>
   </div>
   <div class="post" id="post-116395">
    <div class="subject"><a href="#post-116395">need help with factorial function</a></div>
    <div class="body"><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=4978&amp;highlight=factorial">HERE</a> is an integer table method - could be converted to FPU.</div>
    <div class="meta">Posted on 2003-08-31 20:28:51 by bitRAKE</div>
   </div>
   <div class="post" id="post-116398">
    <div class="subject"><a href="#post-116398">need help with factorial function</a></div>
    <div class="body">a table lookup is a good idea.<br />i wrote a function for the gamma function that works quite well for positive arguments,<br />you loose some precision for negative arguments.<br />it's written in fasm style.<br /><pre><code><br />;fasm style<br /><br />; gamma&#40;x + 1&#41; = &#40;x + Y + 1/2&#41;^&#40;x + 1/2&#41;*exp&#40;-&#40;x + Y + 1/2&#41;&#41;<br />; *sqrt&#40;2*Pi&#41;*&#40;C0 + C1/&#40;x + 1&#41; + C2/&#40;x + 2&#41; +...+ CN/&#40;x + N&#41;&#41;<br />; <br />; for more information visit &#91;url&#93;http&#58;//home.att.net/~numericana/answer/info/godfrey.htm&#91;/url&#93;<br />; ebx holds the address of 'x'<br /><br />  fld tword &#91;ebx&#93;         ;load x<br />  fld tword &#91;120+gamma&#93;   ; 9.5 <br />  faddp st1,st0           ;x + 9.5<br />  fld st0                 ;make copy<br />  fld tword &#91;ebx&#93;         ;load x again<br />  fld tword &#91;rx_half&#93;     ;load .5<br />  faddp st1,st0           ;x + .5<br />  fxch                    ;exchange st0 and st1&#58; st0 = x + 9.5, st1 = x + .5<br />  FYL2X                   ;st0 = st0 ^ st1<br />  FLD st0                 ; &quot;<br />  FRNDINT                 ; &quot;<br />  FSUB st1, st0           ; &quot;<br />  FLD1                    ; &quot;<br />  FSCALE                  ; &quot;<br />  FXCH                    ; &quot;<br />  FXCH st2                ; &quot;<br />  F2XM1                   ; &quot;<br />  FLD1                    ; &quot;<br />  FADDP st1, st0          ; &quot;<br />  FMULP st1, st0          ; &quot;<br />  fstp st1                ; clean up fpu stack, result in st0<br />  fxch                    ;exchange st0 and st1&#58; st0 = x + 9.5, st1 = &#40;x + 9.5&#41; ^ &#40;x + .5&#41;<br />  fchs                    ;st0 = - st0 = -&#40;x + 9.5&#41;<br />  fld tword &#91;rx_e&#93;        ;st0 = exp&#40;st0&#41;<br />  FYL2X                   ; &quot;<br />  FLD st0                 ; &quot;<br />  FRNDINT                 ; &quot;<br />  FSUB st1, st0           ; &quot;<br />  FLD1                    ; &quot;<br />  FSCALE                  ; &quot;<br />  FXCH                    ; &quot;<br />  FXCH st2                ; &quot;<br />  F2XM1                   ; &quot;<br />  FLD1                    ; &quot;<br />  FADDP st1, st0          ; &quot;<br />  FMULP st1, st0          ; &quot;<br />  fstp st1                ; clean up fpu stack, result in st0<br />  fmulp st1,st0           ;st0 = &#40;x + 9.5&#41; ^ &#40;x + .5&#41; * exp&#40;-&#40;x + 9.5&#41;&#41;<br />  fld tword &#91;gamma&#93;       ; 2.50662827463100050  ; Sqrt&#40;2*Pi&#41;<br />  fmulp st1,st0           ;st0 = &#40;x + 9.5&#41; ^ &#40;x + .5&#41; * exp&#40;-&#40;x + 9.5&#41;&#41; * Sqrt&#40;2*Pi&#41;<br />  fld tword &#91;gamma+10&#93;    ;1.00000000000000017<br />  fld tword &#91;ebx&#93;         ;load x again<br />  fiadd dword &#91;ten&#93;       ;st0 = x + 10<br />  fld tword &#91;110+gamma&#93;   ;-4.02353314126823637e-9 <br />  fdiv st0,st1            ;st0 = -4.02353314126823637e-9 / &#40;x + 10&#41;<br />  faddp st2,st0<br />  fld1<br />  fsubp st1,st0           ;st0 = x + 9<br />  fld tword &#91;100+gamma&#93;   ; 5.38413643250956406e-8<br />  fdiv st0,st1<br />  faddp st2,st0<br />  fld1<br />  fsubp st1,st0           ;st0 = x + 8<br />  fld tword &#91;90+gamma&#93;    ;-7.42345251020141615e-3<br />  fdiv st0,st1<br />  faddp st2,st0<br />  fld1<br />  fsubp st1,st0           ;st0 = x + 7<br />  fld tword &#91;80+gamma&#93;    ; 2.60569650561175583<br />  fdiv st0,st1<br />  faddp st2,st0<br />  fld1<br />  fsubp st1,st0           ;st0 = x + 6<br />  fld tword &#91;70+gamma&#93;    ;-108.176705351436963<br />  fdiv st0,st1<br />  faddp st2,st0<br />  fld1<br />  fsubp st1,st0           ;st0 = x + 5<br />  fld tword &#91;60+gamma&#93;    ; 1301.60828605832187<br />  fdiv st0,st1<br />  faddp st2,st0<br />  fld1<br />  fsubp st1,st0           ;st0 = x + 4<br />  fld tword &#91;50+gamma&#93;    ;-6348.16021764145881<br />  fdiv st0,st1<br />  faddp st2,st0<br />  fld1<br />  fsubp st1,st0           ;st0 = x + 3<br />  fld tword &#91;40+gamma&#93;    ; 14291.4927765747855<br />  fdiv st0,st1<br />  faddp st2,st0<br />  fld1<br />  fsubp st1,st0           ;st0 = x + 2<br />  fld tword &#91;30+gamma&#93;    ;-14815.3042676841391<br />  fdiv st0,st1<br />  faddp st2,st0<br />  fld1<br />  fsubp st1,st0           ;st0 = x + 1<br />  fld tword &#91;20+gamma&#93;    ; 5716.40018827434138<br />  fdivrp st1,st0<br />  faddp  st1,st0<br />  fmulp st1,st0<br />  fstp st1<br />;st0 = gamma&#40;x + 1&#41;<br /><br />  gamma&#58;     <br />;N=10,Y=9<br />  dw $2CB2,$B138,$98FF,$A06C,$4000    ;   2.50662827463100050  ; Sqrt&#40;2*Pi&#41;  ;    gamma<br />  dw $064A,$0000,$0000,$8000,$3FFF    ;   1.00000000000000017 ______________ ; 10+gamma<br />  dw $4FAA,$E8F4,$3395,$B2A3,$400B    ;   5716.40018827434138 ______________ ; 20+gamma<br />  dw $6D9E,$F2A2,$3791,$E77D,$C00C    ;  -14815.3042676841391 ______________ ; 30+gamma<br />  dw $C153,$6C23,$F89A,$DF4D,$400C    ;   14291.4927765747855 ______________ ; 40+gamma<br />  dw $767D,$2FD2,$4820,$C661,$C00B    ;  -6348.16021764145881 ______________ ; 50+gamma<br />  dw $5DC8,$52E3,$7714,$A2B3,$4009    ;   1301.60828605832187 ______________ ; 60+gamma<br />  dw $5F26,$B2E6,$791F,$D85A,$C005    ;  -108.176705351436963 ______________ ; 70+gamma<br />  dw $AC57,$B9DA,$BB46,$A6C3,$4000    ;   2.60569650561175583 ______________ ; 80+gamma<br />  dw $5E13,$9ACD,$6EE0,$F340,$BFF7    ;  -7.42345251020141615e-3 ___________ ; 90+gamma<br />  dw $16EB,$FC65,$34C4,$E73F,$3FE6    ;   5.38413643250956406e-8 ___________ ;100+gamma<br />  dw $B1AB,$8882,$5F2D,$8A3F,$BFE3    ;  -4.02353314126823637e-9 ___________ ;110+gamma<br />  dw $0000,$0000,$0000,$9800,$4002    ;   9.5 ______________________________ ;120+gamma<br />rx_half&#58;<br />  dw $0000,$0000,$0000,$8000,$3FFE<br />rx_e&#58;<br />  dw $4A9B,$A2BB,$5458,$ADF8,$4000<br />ten&#58; dd 10<br /></code></pre><br />i must admit, i get lost with the fpu stack.</div>
    <div class="meta">Posted on 2003-08-31 21:09:37 by jack</div>
   </div>
   <div class="post" id="post-116412">
    <div class="subject"><a href="#post-116412">need help with factorial function</a></div>
    <div class="body">When you have a complex computation such as your gamma example, you simply have to do a lot of pre-planning to define the sequence in which you will perform the various operations. If it seems impossible to keep all intermediate results on the stack, then you have to keep some in memory.<br /><br />Then, you should always keep track of which data is in which register whenever you load or pop data.<br /><br />As for your factorial function, you only need 3 registers. That should thus be easy.<br /><br />Assuming the FPU has already been initialized with the FINIT instruction, it will perform all computations in REAL10 mode (if you don't initialize it, Windows would have set it up for REAL8 mode). Also assuming that the FPU is &quot;clean&quot; and that ECX holds a valid &quot;n&quot; for n!,<br /><pre><code><br />   push ecx             ;will be used to load &quot;n&quot; in FPU<br />   fld1                 ;st=1<br />   or   ecx,ecx<br />   jz   finish          ;by convention, 0!=1<br />   fld  st              ;st=1, st1=1<br />   fild dword ptr&#91;esp&#93;  ;st=n, st1=1, st2=1<br />                        ;st2 will be used for the running n!<br />                        ;st1 will be used to decrement &quot;n&quot;<br />@@&#58;<br />   dec  ecx             ;decrement counter<br />   jz   clean_up<br />   fmul st&#40;2&#41;,st<br />   fsub st,st&#40;1&#41;        ;decrement the &quot;n&quot;<br />   jmp  @B<br /><br />clean_up&#58;<br />   fcompp               ;pops both the &quot;n&quot; and the &quot;1&quot; constant<br />                        ;leaving only n! on FPU<br /><br />finish&#58;<br />   pop  ecx             ;clean up the CPU stack<br />                        ;returns answer in FPU top register<br /></code></pre><br />When I look at your code, you would discard the result and cause an invalid operation when ECX=0. You are also loading and discarding the &quot;1&quot; constant in each loop.<br /><br />Raymond</div>
    <div class="meta">Posted on 2003-08-31 23:41:07 by Raymond</div>
   </div>
   <div class="post" id="post-116416">
    <div class="subject"><a href="#post-116416">need help with factorial function</a></div>
    <div class="body">Maybe,<pre><code>	push	ecx		; will be used to load &quot;n&quot; in FPU<br />	fld1			; st=1<br />	fld1			; st=1, st1=1<br />	fild	dword ptr &#91;esp&#93;	; st=n, st1=1, st2=1<br />	; st2 will be used for the running n!<br />	; st1 will be used to decrement &quot;n&quot;<br /><br />	jmp	_2<br /><br />align 8<br /><br />_1&#58;	fmul	st&#40;2&#41;, st<br />	fsub	st, st&#40;1&#41;	; decrement the &quot;n&quot;<br />_2&#58;	dec	ecx		; decrement counter<br />	jnle	_1<br /><br />	fcompp			; pops both the &quot;n&quot; and the &quot;1&quot; constant<br />				; leaving only n! on FPU<br />	pop	ecx		; clean up the CPU stack<br />				; returns answer in FPU top register</code></pre>No need to multiply by one and all jumps predicated except one. :)<br /><br />Can you imagine someone trying to copywrite such a logical solution?</div>
    <div class="meta">Posted on 2003-09-01 00:10:45 by bitRAKE</div>
   </div>
   <div class="post" id="post-116444">
    <div class="subject"><a href="#post-116444">need help with factorial function</a></div>
    <div class="body">i like your solution bitRAKE:alright:</div>
    <div class="meta">Posted on 2003-09-01 06:42:36 by jack</div>
   </div>
  </div>
 </body>
</html>