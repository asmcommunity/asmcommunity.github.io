<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Opinoin: Best Approach (Memory Allocation) - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=19087" />
    <link rel="next" href="../?id=19087&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=19087">Opinoin: Best Approach (Memory Allocation)</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=19087&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=19087&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="19087" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=19087&amp;page=2">&gt;</a><a href="../?id=19087&amp;page=2">&raquo;</a></form>   <div class="post" id="post-147572">
    <div class="subject"><a href="#post-147572">Opinoin: Best Approach (Memory Allocation)</a></div>
    <div class="body">hey guys...<br /><br />I would just like to know what would be the best approach to allocate an uncertain ammount of memmory objects, each being 6100 bytes in size. Heap functions allows you up to 4MB and you can realocate it - but i will need more than this. VirtualAlloc give me a larger range but i can't reallocate this value (or can i?). File Mapping seems to be great but same problem as VirtualAlloc.<br /><br />(most cases the required size will be about 6MB but it might also be 16MB in the next case)<br /><br />Thank you,<br />Black iCE</div>
    <div class="meta">Posted on 2004-08-06 19:51:29 by Black iCE</div>
   </div>
   <div class="post" id="post-147574">
    <div class="subject"><a href="#post-147574">Opinoin: Best Approach (Memory Allocation)</a></div>
    <div class="body">Memory allocated with VirtualAlloc is expanded by passing the top of the buffer as the base address :<br /><pre><code>; Let the system decide where to put it the first time, allocate 1MB<br />invoke VirtualAlloc, NULL, 0100000h, MEM_COMMIT, PAGE_READWRITE<br />mov &#91;pArray&#93;,eax<br />add eax,0100000h<br />mov &#91;MaxPTR&#93;,eax<br /><br />; Now every time you want more memory you can expand it<br />; just be sure to verify that it was available<br />invoke VirtualAlloc, &#91;MaxPTR&#93;, 0100000h, MEM_COMMIT, PAGE_READWRITE<br />add &#91;MaxPTR&#93;,0100000h</code></pre></div>
    <div class="meta">Posted on 2004-08-06 20:13:03 by donkey</div>
   </div>
   <div class="post" id="post-147576">
    <div class="subject"><a href="#post-147576">Opinoin: Best Approach (Memory Allocation)</a></div>
    <div class="body">Once again <strong>saved by donkey</strong>:alright: <br /><br />Thank you - i got it. It works according to a range {max,min} and so you move the {max} on and on when you need more memory.<br /><br />Thank you!<br />Black iCE</div>
    <div class="meta">Posted on 2004-08-06 20:22:33 by Black iCE</div>
   </div>
   <div class="post" id="post-147603">
    <div class="subject"><a href="#post-147603">Opinoin: Best Approach (Memory Allocation)</a></div>
    <div class="body">Ice, I think you might be a bit confused about HeapAlloc. You can easily allocate huge blocks if you want, the &quot;4 megabyte&quot; thing is just a recommendation (not a hard limit) for 9x - and it's for individual blocks, not total allocation.<br /><br />So for 6100-byte sized objects, HeapAlloc should be just fine, unless you have some specific requirements (speed, fragmentation, ...). If you go for VirtualAlloc, remember to implement an allocation system. If you use VirtualAlloc calls for each 6100 byte objects, you'll waste a lot of memory - each size is rounded up to 4kb, and are allocated at 64kb-aligned addresses by default...</div>
    <div class="meta">Posted on 2004-08-07 03:38:39 by f0dder</div>
   </div>
   <div class="post" id="post-147626">
    <div class="subject"><a href="#post-147626">Opinoin: Best Approach (Memory Allocation)</a></div>
    <div class="body">F0dder, thank you for the info - as i still need to learn a great deal of things. I suppose that - yes, speed is my consirn. BTW i try alloc chunks and not for each 6100-byte object. But truly - thank you for clearing that up (heap-limit) for me. MSDN seems to say things very vaguely</div>
    <div class="meta">Posted on 2004-08-07 15:48:15 by Black iCE</div>
   </div>
   <div class="post" id="post-147627">
    <div class="subject"><a href="#post-147627">Opinoin: Best Approach (Memory Allocation)</a></div>
    <div class="body">If speed is a big concern, then allocating bigger chunks and managing those chunks yourself is a good idea - it should be possible to come up with a specific strategy that's better than the generic one in windows, especially when you have fixed-size objects.</div>
    <div class="meta">Posted on 2004-08-07 16:38:27 by f0dder</div>
   </div>
   <div class="post" id="post-147628">
    <div class="subject"><a href="#post-147628">Opinoin: Best Approach (Memory Allocation)</a></div>
    <div class="body">F0dder - well i then would like to ask you about the proposed way you would do it. Just an exaple to show me past those generic windows routines. Can you please just give me a hint. :alright: <br /><br />Procudo (spelling) will be gr8.<br /><br />Black iCE</div>
    <div class="meta">Posted on 2004-08-07 16:50:23 by Black iCE</div>
   </div>
   <div class="post" id="post-147632">
    <div class="subject"><a href="#post-147632">Opinoin: Best Approach (Memory Allocation)</a></div>
    <div class="body"><div class="quote"><br />F0dder - well i then would like to ask you about the proposed way you would do it. Just an exaple to show me past those generic windows routines. Can you please just give me a hint. :alright: <br /><br />Procudo (spelling) will be gr8.<br /><br />Black iCE </div><br /><br />This isn't the most efficient method by any means but it will get you started into think about more ways.<br /><br />Let's say you have &quot;chucks&quot; of 6100 bytes each and you know you won't need more then 64 of these at any given time.  We'll actually allocate 6144 per chuck to keep it aligned nicely.<br /><br />So, allocate a buffer of 6144 * 64 + (? * 64).   The ? is some index type into which &quot;sections&quot; are available to use or already in use.   ? = bits, bytes, etc.<br /><br />Use the last section (the ? * 64) to keep track of what &quot;chucks&quot; are in use.  The rest of the buffer is your usable space that you return pointers to.  Make sure you keep your indexes of used sections at then end so you can keep your buffer segments aligned nicely.<br /><br />This type is what I use on one of my programs.  I use a BYTE to keep track if it is in use or not and then do a fast &quot;strlen&quot; type search to find the first available spot to use. <br /><br />Hopefully, this will get you thinking or at the least, other people to suggest other ways.<br /><br />Relvinian</div>
    <div class="meta">Posted on 2004-08-07 22:54:07 by Relvinian</div>
   </div>
   <div class="post" id="post-147633">
    <div class="subject"><a href="#post-147633">Hi Relvinian</a></div>
    <div class="body">Nice to see that you are looking though the board.<br /><br />i would like to clarify, that the item's that i enumerate is shellobjects - and so i have no idea of the ammount of files/directories/regitems that would be in one specified directory. I think the max in fat32 or ntfs would be about 0xffffffff. So then using a non-windows approach makes me somewhot quezy. Just cause you replayed saying about if you know... well i don't.<br /><br />The size of the object is infact a custom struct that keeps the info that i will use about each item in the memmory. So insead of having one thread i have made two witch both will help me in my implementation. But - by the looks of it i'll stick to virtual listviews. (i see you have replayed there too).<br /><br />I just wanted to see what the ASM way is of alloc memmory (dynamically) and from there i'll use it. Don;t want to be spoon fed but i'll apriciate a shove in the right direction. Coming from a HLL background.<br /><br />Kindly,<br />Black iCE</div>
    <div class="meta">Posted on 2004-08-07 23:02:59 by Black iCE</div>
   </div>
   <div class="post" id="post-147634">
    <div class="subject"><a href="#post-147634">Re: Hi Relvinian</a></div>
    <div class="body"><div class="quote"><br />Nice to see that you are looking though the board.<br /><br />i would like to clarify, that the item's that i enumerate is shellobjects - and so i have no idea of the ammount of files/directories/regitems that would be in one specified directory. I think the max in fat32 or ntfs would be about 0xffffffff. So then using a non-windows approach makes me somewhot quezy. Just cause you replayed saying about if you know... well i don't.<br /><br />The size of the object is infact a custom struct that keeps the info that i will use about each item in the memmory. So insead of having one thread i have made two witch both will help me in my implementation. But - by the looks of it i'll stick to virtual listviews. (i see you have replayed there too).<br /><br />I just wanted to see what the ASM way is of alloc memmory (dynamically) and from there i'll use it. Don;t want to be spoon fed but i'll apriciate a shove in the right direction. Coming from a HLL background.<br /><br />Kindly,<br />Black iCE </div><br /><br /><br />Even if you don't know, as long as you keep your &quot;counters&quot; at some easy place to get to (like at the end), you can always use HeapReAlloc to allocate the memory for more space and then &quot;move&quot; the counters to the new end.  Of course, make sure you lock the memory while doing something like this for thread safety.  :)<br /><br />But anyway you come up with will work.  :)<br /><br />Relvinian.</div>
    <div class="meta">Posted on 2004-08-07 23:06:17 by Relvinian</div>
   </div>
   <div class="post" id="post-147635">
    <div class="subject"><a href="#post-147635">Opinoin: Best Approach (Memory Allocation)</a></div>
    <div class="body">Rereading your post - well, i get the just of it and i appricate your help - and it is what i ask for so thank you.</div>
    <div class="meta">Posted on 2004-08-07 23:06:27 by Black iCE</div>
   </div>
   <div class="post" id="post-147636">
    <div class="subject"><a href="#post-147636">Opinoin: Best Approach (Memory Allocation)</a></div>
    <div class="body">What interisted me was F0dder saying about non-window approach and that <strong>got my interist</strong> and so i'll am just wandering about the way to do this.... given the first post senario. That is why i as for the <u>shove in the right direction</u>.<br />:grin:<br /><br />Black iCE</div>
    <div class="meta">Posted on 2004-08-07 23:09:28 by Black iCE</div>
   </div>
   <div class="post" id="post-147654">
    <div class="subject"><a href="#post-147654">Opinoin: Best Approach (Memory Allocation)</a></div>
    <div class="body">6100 bytes? use the stack, fast and dynamic (within reason of course), and much smaller than the rest.<br /><br /><pre><code>sub esp,6100<br />mov &#91;mem&#93;,esp<br /><br />or<br /><br />mov reg32,esp<br /></code></pre><br /><br />:)</div>
    <div class="meta">Posted on 2004-08-08 10:43:56 by Drocon</div>
   </div>
   <div class="post" id="post-147656">
    <div class="subject"><a href="#post-147656">Opinoin: Best Approach (Memory Allocation)</a></div>
    <div class="body">Stack probably isn't a very good option here - iCE needs to allocate multiple 6100-byte items. There might also be some object lifetime/scope things that make stack unsuitable.<br /><br />Okay, so you're dealing with shell objects... for files? This means you have to have a dynamic scheme without hard limits (you probably COULD get away with hard limits, but it's a bad idea.) It also means you will usually have a &quot;relatively small&quot; amount of objects, and that you're probably so I/O bound that allocation speed won't matter too much.<br /><br />If I've understood you correctly (ie, shell objects for filesystem files), I would probably go for a &quot;delta-growing array&quot; approach... keep two DWORDs for current and maximum items in the array. When you add an entry, check if current==maximum. If so, increase maximum by your &quot;delta&quot;, or multiply maximum by a &quot;magic constant&quot;.<br /><br />You'll want to grow the array enough that you avoid heap fragmentation, but not so much that you waste big amounts of memory. You're probably not going to do a lot of bulk data processing of the shell objects, so using alignment as relvinian suggested will probably just be wasteful in this example.<br /><br />If you expect between 6-16 megabyte, wasting a megabyte or two won't be too bad, and better than heap fragmentation anyway... so a delta value of 350 wouldn't be too bad.<br /><br />And of course you could use VirtualAlloc instead of HeapAlloc, this would avoid heap fragmentation and it isn't that much more bother to implement.<br /><br />There are other things to consider, too - like whether you should ever shrink the allocated memory block... what's the typical scenario where you need this memory allocation? A file browser, or something that builds a list of all files on the harddrive, or something completely different which means I've totally misunderstood what you're doing? :-)<br /><br /><br />Donkey's approach with VirtualAlloc is probably the simplest, as you don't need to worry about heap fragmentation and such... however, if you need multiple parallel allocations, or use libraries that depend on VirtualAlloc, you can no longer be guaranteed contiguous memory, and suddenly things become somewhat complicated :)</div>
    <div class="meta">Posted on 2004-08-08 12:14:36 by f0dder</div>
   </div>
   <div class="post" id="post-147662">
    <div class="subject"><a href="#post-147662">Opinoin: Best Approach (Memory Allocation)</a></div>
    <div class="body">hey f0dder,<br /><br />Yes - i need it for a file browser. So the lifetime of the object can vary (did think about that thanks for pointing this out to me). ShellObjects well general term i use when i also include non-filesystem objects like the contents of My Computer, they are a group of registry items acting as file-objects to the windows user. (But i assume you know that :)).<br /><br />&quot;delta-growing array&quot; growing approach - but isn't that what VirtualAlloc is capabil of (looking at donkey's post).<br /><div class="quote"><br />&quot;If you expect between 6-16 megabyte, wasting a megabyte or two won't be too bad, and better than heap fragmentation anyway... so a delta value of 350 wouldn't be too bad.&quot; - f0dder<br /></div><br />i always assume the worst, but yes i agree it wouldn't be bad, but....<br /><div class="quote"><br />&quot;here are other things to consider, too - like whether you should ever shrink the allocated memory block..&quot; - f0dder<br /></div><br />Yes i will need to shrink this memory block... so &quot;house cleaning&quot; is something that i try to do most of the time. Plus i am considering allowing a couple of threads to browse into the subfolders to get a count of the shellobject so that i can calculate the required memory without having to re-allocate it all the time. Also with the use of IShellIcon methods of icon extraction but then there is always the slow SHGetFileInfo that i could use but as i said that speed is somewhot critical at the moment. A test directory is the windows xp install (i386) or the System32 that takes normally about 12 seconds to show in the non-virtual listview. (so that is extremly slow and i am trying to speed it up... not using a virtual-listview so that is the way i have gone now and <u>implemented a virtual listview</u> and now <strong>this question had crept up on me</strong>).<br /><br />Kindly,<br />Black iCE</div>
    <div class="meta">Posted on 2004-08-08 12:39:33 by Black iCE</div>
   </div>
   <div class="post" id="post-147664">
    <div class="subject"><a href="#post-147664">Opinoin: Best Approach (Memory Allocation)</a></div>
    <div class="body">Another problem that is encountered is when IShellIcon methods can't retrieve the icon and then i must use IExtractIcon... i have used it before... not coded up to there yet but the issue is ofcourse the fact that when i take a look in TaskManager the memory used can just grow and grow to HUGE ammounts and once the opertaion is compelted it is all released. So if there are any other alternatives to extract an icon from exe etc relativly fast without huge memory allocation in once case the cpu usage was 100% and the pagefile grew a 100mb :(. Is it such a task in windows? I suppose that when i finnally get there i'll just extract what is visible the the listview and then ask the listview to keep it internally.... not sure about that either.</div>
    <div class="meta">Posted on 2004-08-08 13:15:41 by Black iCE</div>
   </div>
   <div class="post" id="post-147667">
    <div class="subject"><a href="#post-147667">Opinoin: Best Approach (Memory Allocation)</a></div>
    <div class="body"><div class="quote"><br />&quot;delta-growing array&quot; growing approach - but isn't that what VirtualAlloc is capabil of (looking at donkey's post).<br /></div><br />Sure is :) - it can be implemented with both VirtualAlloc and HeapAlloc. The advantage of HeapAlloc is that you're always guaranteed that the array can grow (by moving memory around if necessary), with VirtualAlloc you'd have to add &quot;a bunch of extra code&quot; to handle this.<br /><br /><div class="quote"><br />i always assume the worst, but yes i agree it wouldn't be bad, but...<br /></div><br />Allocating &quot;some amount&quot; too much is often better than a fragmented heap. In <strong>extreme</strong> cases, heap fragmentation _could_ to you not being able to allocate a new block...<br /><br /><div class="quote"><br />Yes i will need to shrink this memory block... so &quot;house cleaning&quot; is something that i try to do most of the time.<br /></div><br />It might be more efficient not to shrink the block sometimes - or to never shrink it below &quot;some amount of entries&quot;... again, to avoid unnecessary alloc/dealloc calls, and heap fragmentation. But it would also be bad to have allocated memory for, say, 10.000 objects if you only have a couple hundred most of the time.<br /><br /><div class="quote"><br />Plus i am considering allowing a couple of threads to browse into the subfolders to get a count of the shellobject so that i can calculate the required memory without having to re-allocate it all the time.<br /></div><br />Could be a good idea - remember to adjust the priority of these threads to something lower than your main thread(s).<br /><br /><div class="quote"><br />Also with the use of IShellIcon methods of icon extraction but then there is always the slow SHGetFileInfo that i could use but as i said that speed is somewhot critical at the moment.<br /></div><br />Do it the way Explorer does it - run in a background thread, update icons as they become available, and use a &quot;default icon&quot; until then. Gives the illusion of being faster, while it will actually be a tiny bit faster. Works well in practice. Also, you could keep a caching scheme... (even though windows already has icon cache).</div>
    <div class="meta">Posted on 2004-08-08 13:53:41 by f0dder</div>
   </div>
   <div class="post" id="post-147669">
    <div class="subject"><a href="#post-147669">Opinoin: Best Approach (Memory Allocation)</a></div>
    <div class="body">Thank you f0dder, you have addressed some issues that will help me a great deal. I am really greatful for your help. Thank you :)<br /><br />- so i'll use Icon extraction on failed attempts with IShellIcon in a background thread to retrive the propper icons :)<br />- start browser in My Computer cause a minimal # of objects are ensured there.<br />- Thread out into subfolders to predict memory allocation and requirements<br />- HeapAlloc the memory chunks<br /><br />- *anything else i missed* :D<br /><br /> added list and fixed a spelling mistake<br /><br />Black iCE</div>
    <div class="meta">Posted on 2004-08-08 14:02:32 by Black iCE</div>
   </div>
   <div class="post" id="post-147677">
    <div class="subject"><a href="#post-147677">Opinoin: Best Approach (Memory Allocation)</a></div>
    <div class="body">Black Ice,<br /><br />Since you are saying that it takes for ever to insert items into your ListCtrl, I decided to do a test and see how long it would take to insert my C:WindowsSystem32 directory (which is an XP system).  The count of files for that directory is: 6299 files, 211 folders.<br /><br />Here's the stats for a very quick and dirty c++ code using VC++ 6.0 on a P4 2.53ghz machine to insert the file and folder names into a ListCtrl (non-virtual style)<br /><br />CBrowserView::OnInitialUpdate():   6.400ms  <br />CBrowserView::OnInitalUpdate() + any child functions:  143.222ms<br /><br />Here's the code:<br /><pre><code><br />void CBrowserView&#58;&#58;OnInitialUpdate&#40;&#41;<br />&#123;<br />	CListView&#58;&#58;OnInitialUpdate&#40;&#41;;<br /><br /><br />	// TODO&#58; You may populate your ListView with items by directly accessing<br />	//  its list control through a call to GetListCtrl&#40;&#41;.<br />	WIN32_FIND_DATA FileInfo;<br /><br />	CListCtrl&amp; theCtrl = GetListCtrl&#40;&#41;;<br />	HANDLE hFind = &#58;&#58;FindFirstFile&#40;_T&#40;&quot;c&#58;\windows\system32\*.*&quot;&#41;, &amp;FileInfo&#41;;<br />	if &#40;hFind != INVALID_HANDLE_VALUE&#41;<br />	&#123;<br />		int idx = 0;<br /><br />		theCtrl.SetRedraw&#40;FALSE&#41;;<br />		do<br />		&#123;<br />			theCtrl.InsertItem&#40;idx++, FileInfo.cFileName&#41;;<br />		&#125; while &#40;&#58;&#58;FindNextFile&#40;hFind, &amp;FileInfo&#41;&#41;;<br />		theCtrl.SetRedraw&#40;&#41;;<br /><br />		&#58;&#58;FindClose&#40;hFind&#41;;<br />	&#125;<br />&#125;<br /></code></pre><br /><br />As you can see,  I just do a findfirst/findnext for every file (including directory names) and insert them into the ListCtrl (non-virtual style).   I do turn off redrawing while I'm inserting them though and turn the drawing back on afterwards.<br /><br />So, with that in mind, you said in one of your messages that it takes 12 second to process your system32 directory.  A couple things come to mind on this:<br /><br /><br />1)  How are you implementing the findfirst/findlast to populate your listctrl.<br />2)  What other items are you processing other then just putting the name of the file/folder into the listctrl that could be done in background threads?<br />3)  How fast is your CPU and harddrive?<br /><br />Relvinian</div>
    <div class="meta">Posted on 2004-08-08 15:53:32 by Relvinian</div>
   </div>
   <div class="post" id="post-147680">
    <div class="subject"><a href="#post-147680">Opinoin: Best Approach (Memory Allocation)</a></div>
    <div class="body">I use Shell COM methods - IShellFolder::EnumObjects, Also i admit that yes i havn't done the WM_SETREDRAW. OK the CPU is a 500 MHz that i tested this on. I am using a diffrent pc at the moment and i was recalling some of my problems that i have encountered while trying to do it last year. As i am attempting to do the same now - i reconed that i might ask before i stuffup again. Secondly you look to be using MFC, well honestly i neva graspt it and so i am stuck with SDK although i played around with ATL. Note this test was run in debuggin' mode so yes i guess the value is somewhot inapropiate (found out later with another app that there is a diffrence).<br /><br />::Other things done<br />- i am obtaining the icons of the shell objects through Shell COM. (use IExtractIcon when IShellIcon failes)<br />- i am using the LPARAM to keep the values returned of each individual item from IShellFolder::GetAttributesOf to use for icon display and capability checks.<br />- Sorting the items after the IShellFolder::EnumObjects is returned. (i must admit that i didn't first cache them and that i know it my greatest mistake cause i could sort them in memory or rather add them to the listview in the order that suits me.)<strong> this is where i had the most time spent on </strong><br /><br />So i was getting rather fedup after doing this for the 4th time that i though i'll rather ask then be diapointed again.<br /><br />PS - everything that i know of programming is what i have picked up from here or there...<br /><br />Using Shell COM Methods to make a seemless transaction from the desktop to the disk and viseversa.<br /><br />{comapring that value to what explorer gets...}<br /><br />Well thank you.<br />Black iCE</div>
    <div class="meta">Posted on 2004-08-08 16:28:43 by Black iCE</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=19087&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=19087&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="19087" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=19087&amp;page=2">&gt;</a><a href="../?id=19087&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>