<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Exception handling in HLA - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=16155" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=16155">Exception handling in HLA</a></p>
   <div class="post" id="post-125285">
    <div class="subject"><a href="#post-125285">Exception handling in HLA</a></div>
    <div class="body">I have one question and one suggestion on exception handling.<br />1) The question is: <br />    for what purpose in stack frame included the third dword?<br />    try statement assembles like following:<br />	push	offset32 L1395_exception__hla_<br />	push	ebp<br />	mov	ebp, <br />	push	dword ptr     // &lt;&lt;----------------------------------- what purpose of this?<br />	mov	ebp,             <br />	push	offset32 HWexcept__hla_<br />	push	dword ptr <br />	mov	dword ptr , esp<br />   i debug some examples and did not found any usage of this dword in stack.<br /><br />also if HardwareException__hla_ procedure can not handle exception it executes such a code:<br />               add         esp,4<br />               mov         eax,1<br />               ret<br />in my Windows 2000 Prof construction like<br />              try<br />                 w.RaiseException($1024,w.EXCEPTION_CONTINUABLE,0,NULL);<br />              anyexception<br />              endtry<br />this last ret in HardwareException__hla_  returns to something bad and raises hardwhere access violation<br />that anyexception -- endtry block handles<br /><br />2) the suggestion is:<br />    to enhance exception handling mechanism with delphi-like<br />    try -- finally -- endtry block<br />    i think that it can be very useful construction</div>
    <div class="meta">Posted on 2003-11-24 05:52:19 by Elohim Meth</div>
   </div>
   <div class="post" id="post-125377">
    <div class="subject"><a href="#post-125377">Re: Exception handling in HLA</a></div>
    <div class="body"><div class="quote"><em>Originally posted by Elohim Meth </em><br />I have one question and one suggestion on exception handling.<br />1) The question is: <br />    for what purpose in stack frame included the third dword?<br />    try statement assembles like following:<br />	push	offset32 L1395_exception__hla_<br />	push	ebp<br />	mov	ebp, <br />	push	dword ptr     // &lt;&lt;----------------------------------- what purpose of this?<br />	mov	ebp,             <br />	push	offset32 HWexcept__hla_<br />	push	dword ptr <br />	mov	dword ptr , esp<br />   i debug some examples and did not found any usage of this dword in stack.<br /><br /></div><br /><br />This is for unwinding nested exceptions. It is a pointer to the last stack<br />frame containing a SEH record. <br /><br /><div class="quote"><br />also if HardwareException__hla_ procedure can not handle exception it executes such a code:<br />               add         esp,4<br />               mov         eax,1<br />               ret<br /></div><br />Yes, this is the standard Windows policy for exceptions an SEH doesn't handle.<br /><br /><div class="quote"><br />in my Windows 2000 Prof construction like<br />              try<br />                 w.RaiseException(24,w.EXCEPTION_CONTINUABLE,0,NULL);<br />              anyexception<br />              endtry<br />this last ret in HardwareException__hla_  returns to something bad and raises hardwhere access violation<br />that anyexception -- endtry block handles<br /></div><br /><br />Ouch!<br />Try..Endtry does not handle system exceptions other than the hardware exceptions.<br />If you're going to use RaiseException to raise a non-standard Windows exception,<br />then you've got to provide your own SEH exception handler for it. (or else modify<br />the hwExcepts.masm file in the HLA Standard Library sources to handle the exception<br />you've raised with this API call).<br /><br />For user-defined exceptions, you should use the HLA &quot;raise&quot; statement, e.g.,<br /><br />raise( 24 );<br /><br />Note that HLA adds some additional information to the SEH frame in order to allow the HLA run-time system to determine if an SEH frame was created by HLA or not. Other than the predefined &quot;hardware&quot; exceptions, HLA tends to ignore other exceptions in the system. So if you've got code raising an exception outside of HLA, you may need to provide your own version of the hwExcepts library routine to deal with it.<br /><br /><br /><div class="quote"><br />2) the suggestion is:<br />    to enhance exception handling mechanism with delphi-like<br />    try -- finally -- endtry block<br />    i think that it can be very useful construction </div><br /><br />Yeah it would. <br /><br />In the meantime, you can use this:<br /><br />try<br />    &lt;&lt;protected code&gt;&gt;<br />anyexception<br />endtry<br />&lt;&lt; code that would go in the finally section&gt;&gt;<br /><br />Cheers,<br />Randy Hyde</div>
    <div class="meta">Posted on 2003-11-24 17:58:21 by rhyde</div>
   </div>
   <div class="post" id="post-125441">
    <div class="subject"><a href="#post-125441">Exception handling in HLA</a></div>
    <div class="body">Thanks for reply,Mr Randall!<br /><br />--------------------------------------------<br />try<br />&lt;&lt;protected code&gt;&gt;<br />anyexception<br />endtry<br />&lt;&lt; code that would go in the finally section&gt;&gt;<br />--------------------------------------------<br />this is not the same as try--finally-end because this construction handles all exceptions and<br />does not passes them any further.<br /><br />i wrote and tested in some cases one macro that simulates try--finally-end construction in Delphi.<br />It may be of some use:<br /><br />#macro guard:<br />	lbl_Handler;<br />	pushd(&amp;lbl_Handler);<br />	#asm<br />		push ebp<br />		push 0<br />		push OFFSET HWexcept__hla_<br />		push DWORD PTR fs:[0]<br />		mov DWORD PTR fs:[0],esp<br />	#endasm<br /><br />#keyword unprotect;<br />	#asm<br />		mov esp,DWORD PTR fs:[0]<br />		pop DWORD PTR fs:[0]<br />		add esp,8<br />		pop ebp<br />		add esp,4<br />	#endasm<br />		<br />#keyword finally;<br />lbl_Handler:<br />	sub(4,esp);<br />	push(eax);<br />	<br />#terminator endguard:<br />	lbl_NoExcept;<br />	pop(eax);<br />	cmp((type dword ),&amp;lbl_Handler);<br />	jne lbl_NoExcept;<br />	raise(eax);<br />lbl_NoExcept:<br />	unprotect<br />#endmacro;</div>
    <div class="meta">Posted on 2003-11-25 10:19:13 by Elohim Meth</div>
   </div>
  </div>
 </body>
</html>