<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Variants &amp; Safearrays - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=14389" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=116">Windows</a> &raquo; <a href="../?id=14389">Variants &amp; Safearrays</a></p>
   <div class="post" id="post-111262">
    <div class="subject"><a href="#post-111262">Variants &amp; Safearrays</a></div>
    <div class="body">I have the following code for testing Autocad automation, it should draw a circle in model space.<br /><br /><br /><pre><code>F3DPOINT STRUCT<br />X real8 ?<br />Y real8 ?<br />Z real8 ?<br />F3DPOINT ENDS</code></pre><br /><pre><code><br />InitAcad proc<br />LOCAL pIAcadDocument&#58;dword<br />LOCAL pIModelSpace&#58;dword<br />LOCAL pICircle&#58;dword<br />LOCAL AcadPnt&#58;VARIANT<br />LOCAL AcadXYZ&#58;SAFEARRAY <br />LOCAL Radius&#58;REAL8<br />LOCAL XYZ&#58;F3DPOINT<br />LOCAL OwID&#58;dword	<br /><br />finit<br />fld1;just for testing X=Y=Z=Radius=1<br />fst Radius<br />fst XYZ.X<br />fst XYZ.Y<br />fstp XYZ.Z<br /><br />mov AcadXYZ.cDims,1<br />mov AcadXYZ.fFeatures,1<br />mov AcadXYZ.cbElements,8<br />mov AcadXYZ.cLocks,0<br />lea eax,XYZ<br />mov AcadXYZ.pvData,eax<br />mov AcadXYZ.rgsabound.lLbound,0<br />mov AcadXYZ.rgsabound.cElements,3<br /><br /><br />mov AcadPnt.vt,VT_R8 or VT_ARRAY<br />mov AcadPnt.wReserved1,0<br />mov AcadPnt.wReserved2,0<br />mov AcadPnt.wReserved3,0<br />lea eax,AcadXYZ<br />mov AcadPnt.parray,eax<br /><br /><br /><br />invoke CoInitialize, NULL     <br />invoke CoCreateInstance, ADDR CLSID_AcadApplication, NULL, CLSCTX_ALL,\<br />                      addr IID_IAcadApplication, addr pIAcadApplication<br />PrintHex eax,&quot;ACAD CoCreateInstance ret value&quot;<br />invoke  vf&#40;pIAcadApplication, IAcadApplication, put_Visible&#41;, TRUE<br />PrintHex pIAcadDocument<br />invoke  vf&#40;pIAcadApplication, IAcadApplication, get_ActiveDocument&#41;, addr pIAcadDocument<br />PrintHex pIAcadDocument<br />PrintHex pIModelSpace<br />invoke  dm&#40;pIAcadDocument, IAcadDocument, get_ModelSpace&#41;, addr pIModelSpace<br />PrintHex pIModelSpace<br />PrintHex OwID	<br />invoke dm&#40;pIModelSpace, IAcadModelSpace, get_OwnerID&#41;, addr OwID ;this seems to work <br />PrintHex OwID			<br /><br />invoke dm&#40;pIModelSpace, IAcadModelSpace, AddCircle&#41;, addr pICircle,AcadPnt,Radius<br /><br /><br />invoke CoUninitialize<br />ret<br /><br />InitAcad endp</code></pre><br /><br /><br />This wont assemble unless i comment out the actual drawing function<br /><br />invoke dm(pIModelSpace,IAcadModelSpace,AddCircle),addr pICircle,AcadPnt,Radius<br /><br />If not commented out, i get the errors regarding the above line: <br /><br /><pre><code>error A2114&#58; INVOKE argument type mismatch &#58; argument &#58; 5<br />error A2114&#58; INVOKE argument type mismatch &#58; argument &#58; 4<br />error A2114&#58; INVOKE argument type mismatch &#58; argument &#58; 3</code></pre><br /><br />in autocadc.inc there is<br /><br /><pre><code>DEFINE_DISPMETHOD IAcadModelSpace , AddCircle, 060Ah, METHOD, VT_BYREF OR VT_USERDEFINED, VT_VARIANT,VT_R8</code></pre><br /><br />so i don't get it. Where's the mismatch?<br /><br />Does the SAFEARRAY / VARIANT init look right, i'm not too sure about them? Anyway, even if they are not correct, that should not affect assembling?<br /><br /><strong>.:EDIT: by NaN to add 'CODE' blocks.  Janne, edit your post to learn what I did ;)</strong></div>
    <div class="meta">Posted on 2003-07-20 07:39:15 by Janne</div>
   </div>
   <div class="post" id="post-111280">
    <div class="subject"><a href="#post-111280">Variants &amp; Safearrays</a></div>
    <div class="body">changed <br /><br /><pre><code>invoke dm&#40;pIModelSpace, IAcadModelSpace, AddCircle&#41;, addr pICircle, AcadPnt, Radius</code></pre><br /><br />to<br /><br /><pre><code>invoke dm&#40;pIModelSpace, IAcadModelSpace, AddCircle&#41;, AcadPnt, Radius, addr pICircle</code></pre><br /><br />,now the damn thing works.<br /><br />I thought that i can see the order of the parameters from <br /><br /><pre><code>DEFINE_DISPMETHOD IAcadModelSpace , AddCircle, 060Ah, METHOD, VT_BYREF OR VT_USERDEFINED, VT_VARIANT,VT_R8</code></pre><br /><br />but apparently not?</div>
    <div class="meta">Posted on 2003-07-20 12:02:05 by Janne</div>
   </div>
   <div class="post" id="post-111290">
    <div class="subject"><a href="#post-111290">Variants &amp; Safearrays</a></div>
    <div class="body">1)  I hope you dont mind, but I edited you posts such that i can better read and understand your source and problem.  Basically i added &quot;code&quot; blocks.<br /><br />2) I find you problem odd.  And not really sure why, but i suspect that it has alot to do with the dm() macro and sustaining source for it.  A while back, burried somewhere in this forum, Japheth and I had a very long discussion on the eventual need and development of the dm() macro.  However, at the end of the day, Japheth had his own views on how it should run (code wise), and I had my own.  Im not saying his is wrong, but I dont *know* it, because i dont use it. <br /><br />My version is close to his, but different in how it sets up the arguments to methods, and then calls the invoke method.  I have a source file called &quot;Disphelp.inc&quot; does alot of the dirty work of dealing with variants for Invoke methods.  I have attached the DispHelp.inc file that i use with his COMView outputs, use it if you like.<br /><br />It will generate the variants for you, all you need to do is call the first &quot;MakeInvokeString&quot; to specify the arguments a method may have (number, flowed by the VT_* types for each argument).  Then in the dm() invoke call, the first two arguments are the return type, and return value pointer (they can be NULL if ther is no return).  All other arguments are the values to stuff into the variant's, as prescribed in the above &quot;MakeInvokeString&quot; call.  My function here will use the stack to allocated a bunch of variants as needed and fill them with your arguments, and type befor calling the Invoke method.<br /><br />With this source included into a project here is how i would have done your source:<pre><code>F3DPOINT STRUCT<br />   X real8 ?<br />   Y real8 ?<br />   Z real8 ?<br />F3DPOINT ENDS       <br />    <br />.data<br />   AcadXYZ  F3DPOINT &lt;1.0, 2.0, 3.0&gt;<br /><br />.code<br />    <br /><br />; Build a SAFEARRAY of R8 numbers       <br />invoke SafeArrayCreateVector, VT_R8, 0, 3<br />mov hSafeArray, eax<br /><br />xor eax, eax<br />mov counter, eax<br />&#91;b&#93;lea eax, AcadXYZ&#91;/b&#93;<br />mov countdata, eax<br />.while &#40;counter != 3&#41;<br />   invoke SafeArrayPutElement, hSafeArray, addr counter, countdata<br />inc counter<br />add countdata, 8<br />.endw<br /><br />; Your source transcribed...<br />invoke CoInitialize, NULL     <br />invoke CoCreateInstance, ADDR CLSID_AcadApplication, NULL, CLSCTX_ALL,\<br />                         addr IID_IAcadApplication, addr pIAcadApplication<br /><br />invoke  vf&#40;pIAcadApplication, IAcadApplication, put_Visible&#41;, TRUE<br /><br />invoke  vf&#40;pIAcadApplication, IAcadApplication, get_ActiveDocument&#41;, addr pIAcadDocument<br /><br /><br />;OLD&#58; invoke  dm&#40;pIAcadDocument, IAcadDocument, get_ModelSpace&#41;, addr pIModelSpace<br />invoke MakeInvokeString, 0<br />invoke dm&#40;pIAcadDocument, IAcadDocument, get_ModelSpace&#41;, VT_DISPATCH, addr pIModelSpace<br /><br /><br />;OLD&#58; invoke dm&#40;pIModelSpace, IAcadModelSpace, get_OwnerID&#41;, addr OwID <br />invoke MakeInvokeString, 0<br />invoke dm&#40;pIModelSpace, IAcadModelSpace, get_OwnerID&#41;, VT_DISPATCH, addr OwID <br /><br /><br />;OLD&#58; invoke dm&#40;pIModelSpace, IAcadModelSpace, AddCircle&#41;, addr pICircle,AcadPnt,Radius<br />;DEFINE_DISPMETHOD	IAcadModelSpace , AddCircle, 060Ah, METHOD, VT_BYREF OR VT_USERDEFINED, <br />invoke MakeInvokeString, 2, VT_ARRAY or VT_R8, VT_R8<br />invoke dm&#40;pIModelSpace, IAcadModelSpace, get_OwnerID&#41;, VT_DISPATCH, addr pICircle, &#91;b&#93;hSafeArray&#91;/b&#93;, Radius<br /><br />&#91;b&#93;invoke SafeArrayDestroy, hSafeArray&#91;/b&#93;<br /><br />invoke CoUninitialize</code></pre><br /><br />As well it shows you how to use the SafeArrays ;)<br /><br />Hope this is some help to you!<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-07-20 13:15:33 by NaN</div>
   </div>
   <div class="post" id="post-111303">
    <div class="subject"><a href="#post-111303">Variants &amp; Safearrays</a></div>
    <div class="body">Oops, for got to post the source ;)</div>
    <div class="meta">Posted on 2003-07-20 14:22:16 by NaN</div>
   </div>
   <div class="post" id="post-111306">
    <div class="subject"><a href="#post-111306">Variants &amp; Safearrays</a></div>
    <div class="body">NaN, thanks a lot for all the info.</div>
    <div class="meta">Posted on 2003-07-20 14:44:34 by Janne</div>
   </div>
   <div class="post" id="post-111315">
    <div class="subject"><a href="#post-111315">Variants &amp; Safearrays</a></div>
    <div class="body">Hi guys,<br /><br />let me mention my view as well. This problem is not an error in macro dm(), it's due to some misunderstanding.<br /><br />Janne, this DEFINE_DISPMETHOD macro has following parameters:<br /><br /><pre><code><br />DEFINE_DISPMETHOD Interfacename, Methodname, DISPID, InvokeKind, return type, parameter1 type, parameter2 type,...<br /></code></pre><br /><br />If you look in typeinfo for IDispatch interface IAcadModelSpace you will see method AddCircle defined as<br /><br />[] Ptr IAcadCircle  AddCircle (   Center:Variant,   Radius:R8 )<br /><br />So DEFINE_DISPMETHOD is correct in my eyes.<br /><br />macro dm() in fact expects parameters in standard COM format, that is<br /><br />1. the method itself does return a HResult (in eax)<br />2. &quot;return type&quot; from IDispatch interface will be last parameter and converted to a pointer to this type<br /><br />There exists a typeinfo (somewhat hidden in comview, but you may find it) with type TKIND_INTERFACE (not TKIND_DISPATCH), where this parameter structure could be seen:<br /><br />[] HResult  AddCircle (   Center:Variant,    Radius:R8,    pCircle:Ptr Ptr IAcadCircle )<br /><br />And this parameter structure is used for the call, that is, this function has in fact 3 parameters (+ &quot;this&quot;),<br />and returntype comes last.<br /><br />Japheth</div>
    <div class="meta">Posted on 2003-07-20 15:42:27 by japheth</div>
   </div>
   <div class="post" id="post-111323">
    <div class="subject"><a href="#post-111323">Variants &amp; Safearrays</a></div>
    <div class="body">Japheth, im sorry if I offended you. It was not my goal.  I only ment to explain that what i can provide *is* going to be different from what you have provided for the dm() macro. Hopefully no offense to you, but i choose to use my stack based calling proceedure instead of your alternate (forget how it works at this point, sorry).  <br /><br />:NaN:</div>
    <div class="meta">Posted on 2003-07-20 20:42:24 by NaN</div>
   </div>
   <div class="post" id="post-111342">
    <div class="subject"><a href="#post-111342">Variants &amp; Safearrays</a></div>
    <div class="body">NaN, its ok, I didnt feel insulted<br /><br />Japheth</div>
    <div class="meta">Posted on 2003-07-20 23:58:22 by japheth</div>
   </div>
  </div>
 </body>
</html>