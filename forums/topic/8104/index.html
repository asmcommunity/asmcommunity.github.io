<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Source code problem - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=8104" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=8104">Source code problem</a></p>
   <div class="post" id="post-59322">
    <div class="subject"><a href="#post-59322">Source code problem</a></div>
    <div class="body">I wrote the next source code, but when i run it doesnt work. Every time i received error 610. I read MSDN but i don't see why it doesnt work.<br /><br />;-------------------------------------------------------------------------<br />GetDialUp   PROC<br />MAX_ENTRIES EQU 100 <br />LOCAL   RASMemoryBuffer:DWORD<br />LOCAL   dwEntryInfoSize:DWORD<br /><br />    INVOKE  RasGetEntryProperties, 0, 0, 0, ADDR dwEntryInfoSize, 0, 0<br />    m2m     lpcb, dwEntryInfoSize<br /><br />    INVOKE  GlobalAlloc,GMEM_FIXED OR GMEM_ZEROINIT,dwEntryInfoSize<br />    .IF eax == -1<br />        mov eax, 0<br />        RET        <br />    .ENDIF<br />    mov     RASMemoryBuffer,eax<br />    mov     edi, RASMemoryBuffer<br />    assume  edi:PTR RASENTRYNAME<br />    mov     .dwSize, SIZEOF(RASENTRYNAME)<br />    INVOKE  RasEnumEntries, 0, 0, edi, ADDR lpcb, ADDR lpcEntries<br />    INVOKE  PrintEAX, eax<br />    cmp     eax, 0          ;eax = ERROR_BUFFER_INVALID (code 610)<br />    je      lab3190     <br />    szText  Str2, &quot;RasEnumEntries error?&quot;<br />    INVOKE  MessageBox,NULL,ADDR Str2,ADDR AppName,MB_OK<br />    jmp     lab3208<br />lab3190:<br /><br />...........<br /><br />lab3208:<br />    assume  edi:nothing<br /><br />    INVOKE  GlobalFree, RASMemoryBuffer       <br />    RET<br />GetDialUp   ENDP<br />;-------------------------------------------------------------------------<br /><br /><br />Please help me</div>
    <div class="meta">Posted on 2002-09-23 16:53:44 by martidim</div>
   </div>
   <div class="post" id="post-59330">
    <div class="subject"><a href="#post-59330">Source code problem</a></div>
    <div class="body">Wild guess (can't try it right now):<br /><br />Change<br /> INVOKE RasEnumEntries, 0, 0, edi, ADDR lpcb, ADDR lpcEntries<br /><br />to<br /><br /> INVOKE RasEnumEntries, 0, 0, , ADDR lpcb, ADDR lpcEntries<br /><br />And better dont use EDI, because it might get changed by the API call.</div>
    <div class="meta">Posted on 2002-09-23 17:13:08 by bazik</div>
   </div>
   <div class="post" id="post-59371">
    <div class="subject"><a href="#post-59371">Source code problem</a></div>
    <div class="body">Interesting. All seems to be workable, but...<br /><br />I traced inside RasEnumEntries and discovered that it expects <strong>108h</strong> in first dword of buffer pointed by lprasentryname. It's size of RASENTRYNAME structure as it should be.<br />But currently RASENTRYNAME defined like this:<pre><code>RAS_MaxEntryName equ 256<br /><br />RASENTRYNAMEA STRUCT<br />    dwSize dd ?<br />    szEntryName db RAS_MaxEntryName + 1 dup&#40;?&#41;<br />RASENTRYNAMEA ENDS</code></pre><br /><br />And its size is 105h.<br /><br />It's correct, IMHO, because in M$'s res.h RASENTRYNAMEA is also defined like this:<pre><code>#define RAS_MaxEntryName      256<br /><br />#define RASENTRYNAMEA struct tagRASENTRYNAMEA<br />RASENTRYNAMEA<br />&#123;<br />    DWORD dwSize;<br />    CHAR  szEntryName&#91; RAS_MaxEntryName + 1 &#93;;<br /><br />#if &#40;WINVER &gt;= 0x500&#41;<br />    DWORD dwFlags;<br />    CHAR  szPhonebookPath&#91;MAX_PATH + 1&#93;;<br />#endif<br /><br />&#125;;</code></pre><br /><br />I have currently no c compiler, but, anyway,<br />all this means that 3-bytes padding should be added at the end of RASENTRYNAMEA.<br />And actually it should be defined like this:<br /><pre><code><br />RASENTRYNAMEA STRUCT<br />    dwSize dd ?<br />    szEntryName db RAS_MaxEntryName + 1 dup&#40;?&#41;<br />    &#91;color=red&#93;db 3 dup&#40;?&#41;&#91;/color&#93;	; add this line<br />RASENTRYNAMEA ENDS</code></pre><br /><br />That was first problem.<br />The next one. RasEnumEntries wants buffer which size is larger than RasGetEntryProperties returns.<br />So first time you call RasEnumEntries, it returns ERROR_BUFFER_TOO_SMALL and sets cb to the number of bytes required. So, you have to realloc more memory and call it again.<br />Below is workable ex:<pre><code>.386<br />.model flat, stdcall<br />option casemap&#58;none<br /><br />include \masm32\include\windows.inc<br />include \masm32\include\user32.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\rasapi32.inc<br /><br />includelib \masm32\lib\user32.lib<br />includelib \masm32\lib\kernel32.lib<br />includelib \masm32\lib\rasapi32.lib<br /><br />.data<br />Str2		db &quot;RasEnumEntries error?&quot;, 0<br />cb		UINT	0<br />cEntries	UINT	0<br />szEmpty		db 0<br />.code<br /><br />GetDialUp proc uses edi<br />MAX_ENTRIES EQU 100 <br />LOCAL RASMemoryBuffer&#58;DWORD<br />LOCAL dwEntryInfoSize&#58;DWORD<br />LOCAL hHeap&#58;HANDLE<br /><br />and dwEntryInfoSize, 0<br /><br />INVOKE RasGetEntryProperties, 0, 0, 0, ADDR dwEntryInfoSize, 0, 0<br />push dwEntryInfoSize<br />pop cb<br /><br />invoke GetProcessHeap<br />mov hHeap, eax<br />invoke HeapAlloc, hHeap, HEAP_ZERO_MEMORY, dwEntryInfoSize<br />mov edi, eax<br /><br />mov RASMemoryBuffer,eax<br />mov edi, eax<br />assume edi&#58;PTR RASENTRYNAME<br />mov &#91;edi&#93;.dwSize, SIZEOF&#40;RASENTRYNAME&#41;<br /><br />INVOKE RasEnumEntries, 0, 0, edi, ADDR cb, ADDR cEntries<br />.if eax == ERROR_BUFFER_TOO_SMALL<br />	invoke HeapReAlloc, hHeap, HEAP_ZERO_MEMORY, edi, cb<br />	invoke RasEnumEntries, 0, 0, edi, ADDR cb, ADDR cEntries<br />.endif<br /><br />;INVOKE PrintEAX, eax<br />cmp eax, 0 ;eax = ERROR_BUFFER_INVALID &#40;code 610&#41;<br />je lab3190 <br /><br />INVOKE MessageBox, NULL, ADDR Str2, NULL, MB_OK<br />jmp lab3208<br />lab3190&#58;<br /><br />;...........<br /><br />lab3208&#58;<br />assume edi&#58;nothing<br /><br />invoke HeapFree, hHeap, 0, edi<br /><br />;INVOKE GlobalFree, RASMemoryBuffer <br />RET<br />GetDialUp ENDP<br /><br />start&#58;<br /><br />invoke GetDialUp<br />invoke ExitProcess, 0<br />ret<br />end start</code></pre><br /><br />PS: Don't forget add padding to RASENTRYNAMEA definition, otherwise you can't correctly access its members.<br /><br /><strong>Edited:</strong> I've tested it uder w98 only. As for w2k/xp, other members (dwFlags and szPhonebookPath) should be added, i guess, because its version &gt;= 5.0.</div>
    <div class="meta">Posted on 2002-09-24 02:37:47 by Four-F</div>
   </div>
   <div class="post" id="post-59531">
    <div class="subject"><a href="#post-59531">Source code problem</a></div>
    <div class="body">I've just compiled some ex on msvc6 and satisfied myself that 3-padding is really added.<br />So...<br /><br /><strong>w9x RASENTRYNAMEA</strong><br /><br /><pre><code>RASENTRYNAMEA STRUCT<br />    dwSize		dd	?<br />    szEntryName 	db	RAS_MaxEntryName + 1 dup&#40;?&#41;<br />		db	3 dup&#40;?&#41;<br />RASENTRYNAMEA ENDS</code></pre><br /><br /><strong>w2k, + RASENTRYNAMEA</strong><br /><br /><pre><code>RASENTRYNAMEA STRUCT<br />    dwSize		dd	?<br />    szEntryName 	db	RAS_MaxEntryName + 1 dup&#40;?&#41;<br />		db	3 dup&#40;?&#41;<br />    dwFlags	dd	?<br />    szPhonebookPath db	MAX_PATH + 1 dup&#40;?&#41;<br />    		db	3 dup&#40;?&#41;<br />RASENTRYNAMEA ENDS</code></pre><br /><br />==================================================<br /><br />Example for w2k:<br /><pre><code>.386<br />.model flat, stdcall<br />option casemap&#58;none<br /><br />include \masm32\include\windows.inc<br />include \masm32\include\user32.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\rasapi32.inc<br /><br />includelib \masm32\lib\user32.lib<br />includelib \masm32\lib\kernel32.lib<br />includelib \masm32\lib\rasapi32.lib<br /><br />MAX_ENTRYES equ 20<br /><br />RASENTRYNAMEA_ STRUCT<br />    dwSize		dd	?<br />    szEntryName 	db	RAS_MaxEntryName + 1 dup&#40;?&#41;<br />    		db	3 dup&#40;?&#41;<br />    dwFlags	dd	?<br />    szPhonebookPath db	MAX_PATH + 1 dup&#40;?&#41;<br />		db	3 dup&#40;?&#41;<br />RASENTRYNAMEA_ ENDS<br /><br />.data<br />szCaption	db &quot;Remote access phone book&quot;, 0<br />NewLine		db 10, 13, 0<br /><br />.data?<br />buffer	CHAR	MAX_ENTRYES*256	dup&#40;?&#41;<br /><br />.code<br /><br />PhoneBook proc uses esi edi<br /><br />LOCAL dwEntryInfoSize&#58;DWORD<br />LOCAL hHeap&#58;HANDLE<br />LOCAL cEntries&#58;UINT<br /><br />	and dwEntryInfoSize, 0<br />	invoke RasGetEntryProperties, 0, 0, 0, addr dwEntryInfoSize, 0, 0<br /><br />	invoke GetProcessHeap<br />	mov hHeap, eax<br />	invoke HeapAlloc, hHeap, HEAP_ZERO_MEMORY, dwEntryInfoSize<br />	mov edi, eax<br />	assume edi&#58;PTR RASENTRYNAMEA_<br />	mov &#91;edi&#93;.dwSize, sizeof RASENTRYNAMEA_<br /><br />	invoke RasEnumEntries, 0, 0, edi, addr dwEntryInfoSize, addr cEntries<br />	.if eax == ERROR_BUFFER_TOO_SMALL<br />		invoke HeapReAlloc, hHeap, HEAP_ZERO_MEMORY, edi, dwEntryInfoSize<br />		invoke RasEnumEntries, 0, 0, edi, addr dwEntryInfoSize, addr cEntries<br />	.endif<br /><br />	.if eax == 0<br />		xor esi, esi<br />		.while esi &lt; sizeof buffer<br />			.break .if &#91;edi&#93;&#91;esi&#93;.dwSize != sizeof RASENTRYNAMEA_<br />			invoke lstrcat, addr buffer, addr &#91;edi&#93;&#91;esi&#93;.szEntryName<br />			invoke lstrcat, addr buffer, addr NewLine<br />			add esi, sizeof RASENTRYNAMEA_<br />		.endw<br />		invoke MessageBox, NULL, addr buffer, addr szCaption, MB_OK<br />	.endif<br /><br />	assume edi&#58;nothing<br /><br />	invoke HeapFree, hHeap, 0, edi<br /><br />	ret<br /><br />PhoneBook ENDP<br /><br />start&#58;<br />invoke PhoneBook<br />invoke ExitProcess, 0<br />ret<br />end start</code></pre></div>
    <div class="meta">Posted on 2002-09-25 05:16:12 by Four-F</div>
   </div>
   <div class="post" id="post-59593">
    <div class="subject"><a href="#post-59593">Source code problem</a></div>
    <div class="body">???? ??????? Four-F<br />It is a very detailed answer<br />Thank you very much !</div>
    <div class="meta">Posted on 2002-09-25 18:05:33 by martidim</div>
   </div>
   <div class="post" id="post-59616">
    <div class="subject"><a href="#post-59616">Source code problem</a></div>
    <div class="body">??????????.<br /><br />PS: &quot;???? ???????&quot; shoulb be &quot;??????? ???????&quot; :)</div>
    <div class="meta">Posted on 2002-09-26 02:39:57 by Four-F</div>
   </div>
   <div class="post" id="post-59648">
    <div class="subject"><a href="#post-59648">Source code problem</a></div>
    <div class="body">The #pragma directives in the .H files force DWORD alignment on Win32.</div>
    <div class="meta">Posted on 2002-09-26 08:44:25 by bitRAKE</div>
   </div>
   <div class="post" id="post-59733">
    <div class="subject"><a href="#post-59733">Source code problem</a></div>
    <div class="body">Now clear.</div>
    <div class="meta">Posted on 2002-09-27 03:29:39 by Four-F</div>
   </div>
  </div>
 </body>
</html>