<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Find my Error - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=21657" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=21657">Find my Error</a></p>
   <div class="post" id="post-163431">
    <div class="subject"><a href="#post-163431">Find my Error</a></div>
    <div class="body">Hello,ALL<br /><br />here is an Error Handle code written by Comrade. i modified a little to find my code error. but the code can&#39;t show more information.<br />I need to show follow:<br /><br />1. Exception style<br />2. ALL registers<br /><br />(ContextFlags? DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ? ?0h<br />? iDr0? ? ? ? ? DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ? ?4h<br />? iDr1? ? ? ? ? DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ? ?8h<br />? iDr2? ? ? ? ? DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ? 0Ch<br />? iDr3? ? ? ? ? DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ? 10h<br />? iDr6? ? ? ? ? DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ? 14h<br />? iDr7? ? ? ? ? DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ? 18h<br />? FloatSave? ? ?FLOATING_SAVE_AREA &lt;&gt;? ? ? ?;offset? ? 1Ch <br />? ? ? ?;(sizeof FLOATING_SAVE_AREA = 70h)<br />? regGs? ? ? ? ?DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ? 8Ch (1Ch + 70h)<br />? regFs? ? ? ? ?DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ? 90h<br />? regEs? ? ? ? ?DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ? 94h<br />? regDs? ? ? ? ?DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ? 98h<br />? regEdi? ? ? ? DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ? 9Ch<br />? regEsi? ? ? ? DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ?0A0h<br />? regEbx? ? ? ? DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ?0A4h<br />? regEdx? ? ? ? DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ?0A8h<br />? regEcx? ? ? ? DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ?0ACh<br />? regEax? ? ? ? DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ?0B0h<br />? regEbp? ? ? ? DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ?0B4h<br />? regEip? ? ? ? DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ?0B8h<br />? regCs? ? ? ? ?DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ?0BCh<br />? regFlag? ? ? ?DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ?0D0h<br />? regEsp? ? ? ? DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ?0D4h<br />? regSs? ? ? ? ?DWORD? ? ? ?? ? ? ? ? ? ? ? ;offset? ?0D8h<br />)<br /><br />3. All Segment registers<br />4. Stack.<br />;=========================================<br />;@echo off<br />;goto make<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.386<br />.model flat, stdcall<br />option casemap:none<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />include \masm32\include\windows.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\user32.inc<br /><br />includelib \masm32\lib\kernel32.lib<br />includelib \masm32\lib\user32.lib<br /><br />include \masm32\macros\macros.asm<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />m2m MACRO M1, M2<br />	push M2<br />	pop M1<br />ENDM<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />ErrorHandler	PROTO C	:DWORD,:DWORD,:DWORD,:DWORD<br />ExceptionFilter	PROTO	:DWORD<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.const<br />	szErrorThread	db 13, 10, &quot;Error at %08Xh&quot;, 13, 10, &quot;Registers:&quot;, 13, 10, &quot;eax = %08Xh ebx = %08Xh ecx = %08Xh&quot;, 13, 10, &quot;edx = %08Xh esp = %08Xh ebp = %08Xh&quot;, 13, 10, &quot;esi = %08Xh edi = %08Xh&quot;, 13, 10, 13, 10, &quot;Recovering...&quot;, 13, 10,0<br />	szErrorFinal	db 13, 10, &quot;Error at %08Xh&quot;, 13, 10, &quot;Quitting...&quot;, 13, 10, 0<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.data<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.data?<br />	szMessage	db 256 dup (?)<br />	seh		dd 6 dup (?)<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.code<br />start:<br />	invoke GetModuleHandle,NULL<br />	invoke SetUnhandledExceptionFilter, ADDR ExceptionFilter<br />	; install the SEH-frame<br />	assume	fs:nothing<br />	push	OFFSET ErrorHandler<br />	push	FS:[0]<br />	mov	, esp<br />	mov	, ebp<br />	mov	, ebx<br />	mov	, esi<br />	mov	, edi<br />	mov	, OFFSET @@safe<br />	mov	FS:[0], esp<br />	; critical code<br />	; zero uninitialized data<br />;==============================================================================<br />; here is your code<br />	int 3<br />	;mov eax,0<br />	;mov ecx,2<br />	;div ecx<br />;==============================================================================<br />	push	edi<br />	push	esi<br />	push	ebx<br />@@exit:	<br />	pop	ebx<br />	pop	esi<br />	pop	edi<br />@@safe:	<br />	pop	FS:[0]<br />	jmp	ExitProcess<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />ErrorHandler proc C lpExcept:DWORD, lpFrame:DWORD, lpContext:DWORD, lpDispatch:DWORD<br />	mov	eax, lpExcept<br />	mov	ecx, lpContext<br />	invoke	wsprintf, ADDR szMessage, ADDR szErrorThread, ,\<br />		, , , ,\<br />		, , , <br />	invoke MessageBox,NULL,	ADDR szMessage,	SADD(&quot;1_Error Occured&quot;),MB_ICONEXCLAMATION<br /><br />	mov	eax, lpContext<br />	m2m	, <br />	m2m	, <br />	m2m	, <br />	m2m	, <br />	m2m	, <br />	m2m	, <br /><br />	xor	eax, eax	; continue execution<br />	ret<br />ErrorHandler endp<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />ExceptionFilter proc lpExcept:DWORD<br />	mov eax, lpExcept<br />	invoke wsprintf, ADDR szMessage, ADDR szErrorFinal, <br />	invoke MessageBox,NULL,	ADDR szMessage,	SADD(&quot;2_Error Occured&quot;),MB_ICONEXCLAMATION<br />	invoke ExitProcess, 0<br />	xor	eax, eax<br />	inc	eax		; EXCEPTION_EXECUTE_HANDLER<br />	ret<br />ExceptionFilter endp<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br /><br />end start<br /><br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />:make<br />set name=ErrorHandle_1<br /><br />? ? \masm32\bin\ml /c /coff %name%.bat<br />? ? \masm32\bin\Link /subsystem:windows %name%.obj <br />? ? <br />? ? if exist *.bak del *.bak<br />? ? if exist *.obj del *.obj<br />echo.<br />;=========================================<br />regards<br /></div>
    <div class="meta">Posted on 2005-08-18 09:40:07 by dcskm4200</div>
   </div>
   <div class="post" id="post-163433">
    <div class="subject"><a href="#post-163433">Re: Find my Error</a></div>
    <div class="body">I don&#39;t understand. What error did you encounter? the int3 is placed in the code to generate an exception btw.</div>
    <div class="meta">Posted on 2005-08-18 10:47:51 by roticv</div>
   </div>
   <div class="post" id="post-163451">
    <div class="subject"><a href="#post-163451">Re: Find my Error</a></div>
    <div class="body">Hello, roticv <br /><br />Thanks you for response.<br />of course, the code didn&#39;t exist in Error. my means is to help me for boosting up the function.<br /><br />regards.<br /></div>
    <div class="meta">Posted on 2005-08-18 19:41:31 by dcskm4200</div>
   </div>
   <div class="post" id="post-163479">
    <div class="subject"><a href="#post-163479">Re: Find my Error</a></div>
    <div class="body">Hello,<br /><br />Okay I see that I misread your post.<br /><br />1. You just need to extract the registers values in the context structure passed by the value in ecx and modifying the below code so that the register values would be displayed in your MessageBox.<br /><br /><pre><code><br />&nbsp;  invoke&nbsp;  wsprintf, ADDR szMessage, ADDR szErrorThread, ,\<br />&nbsp; &nbsp; &nbsp; , , , ,\<br />&nbsp; &nbsp; &nbsp; , , , <br /></code></pre><br /><br />2. You can extract the exception code from lpexcept. Take a look at http://www.jorgon.freeserve.co.uk/TestbugHelp/Exceptions.htm</div>
    <div class="meta">Posted on 2005-08-19 06:41:12 by roticv</div>
   </div>
   <div class="post" id="post-163482">
    <div class="subject"><a href="#post-163482">Re: Find my Error</a></div>
    <div class="body">Hello, roticv <br /><br />Thanks you for help.<br /><br />it is helpful to improve the code. I need more times to read the article carefully.<br /><br />regards.<br /></div>
    <div class="meta">Posted on 2005-08-19 08:10:47 by dcskm4200</div>
   </div>
  </div>
 </body>
</html>