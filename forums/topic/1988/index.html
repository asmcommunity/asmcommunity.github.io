<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>System down, why???? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=1988" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=1988">System down, why????</a></p>
   <div class="post" id="post-12758">
    <div class="subject"><a href="#post-12758">System down, why????</a></div>
    <div class="body">Hi,<br /><br />I found Ctrl2cap.vxd from sysinternal. If I placed it in [386enh] it run well, but if i want to active it by W32DeviceIoControl it made my system down.<br /><br />Need some explain!<br /><br />here my code:<br />====================<br />.386p<br /><br />include vmm.inc<br />include vwin32.inc<br />include vkd.inc<br /><br />DECLARE_VIRTUAL_DEVICE MSPICKPR, 1, 0, MSPICKPR_Control, UNDEFINED_DEVICE_ID, UNDEFINED_INIT_ORDER <br /><br />; scancode definitions<br />SCANESCAPE	equ	0E0h<br />CAPSLOCK	equ	3Ah<br />LEFTCTRL	equ	1Dh<br />ACCENTGRAVE	equ	1Eh<br />ESCAPEKEY	equ	01h<br />LEFTSHIFT	equ	2Ah<br />RIGHTSHIFT	equ	36h<br />PRINTSCREEN	equ	2Ah<br />PRINTSCREEN1	equ	37h<br /><br />; up/down bit value<br />UP		equ	0<br />DOWN		equ	1<br /><br />;============================================================================<br />; 			  P U B L I C   D A T A<br />;============================================================================<br /><br />VXD_LOCKED_DATA_SEG<br /><br />; Previous routine on keyboard hook<br />Keyboard_Proc		dd	0<br /><br />; what should the print-key be mapped to? (0 means no swap)<br />SwtchPrnKey		dd	0<br /><br />; should escape and accent grave be switched?<br />SwtchEscapeAccent	dd	0<br /><br />; what is the shift state?<br />LeftShiftState		dd	0<br />RightShiftState		dd	0<br /><br />; what is the printscreen state?<br />PrintScreenState	dd	0<br /><br />; precode data for force-key<br />ForcePreByte		db	0E0h, 0<br /><br />; have we gotten a precode, yet?<br />PreCode			db 	0<br /><br />VXD_LOCKED_DATA_ENDS<br /><br /><br />Begin_control_dispatch MSPICKPR<br />	Control_Dispatch W32_DeviceIoControl, OnDeviceIoControl<br />End_control_dispatch MSPICKPR<br /><br /><br />VxD_PAGEABLE_CODE_SEG<br />BeginProc MyHook, Hook_Proc Keyboard_Proc<br /><br />	; get the scancode<br /><br />        mov     dl, cl<br />        and     dl, 7Fh<br /><br />;	Trace_Out &quot;Key: #CL&quot;<br /><br />	;----------------------------------------------------------------------<br />	; <br />	; PRINTSCREEN HANDLER<br />	;<br />	;----------------------------------------------------------------------<br />	; first, see if we even care<br />	<br />	cmp	SwtchPrnKey, 0<br />	jz	checklshift<br /><br />	; have we received the pre-scan code (0xE0)?<br /><br />	cmp	PreCode, 0<br />	jz	checkprecode<br />	mov	PreCode, 0<br /><br />	; is this key a printscreen?<br /><br />	cmp	dl, PRINTSCREEN<br />	jnz	checkprintkey1<br /><br />	; got a printscreen, so swap it<br />	<br />	and	cl, 80h<br />	or	cl, byte ptr SwtchPrnKey<br />	test	cl, 80h<br />	jz	printscreendown<br />	mov	PrintScreenState, UP<br />	jmp	chain<br /><br />printscreendown:<br />	mov	PrintScreenState, DOWN<br />	jmp	chain<br /><br />	; we didn't get a printscreen, but see if this is the secondary<br />	; scancode generated by printscreen, which we must swallow if we<br />	; are swapping<br /><br />checkprintkey1:<br /><br />	; if printscreen is down, we have to squash secondary print-screen<br />	<br />	cmp	PrintScreenState, DOWN<br />	jnz	forceprecode<br /><br />	; is it the secondary printscreen key?<br />	<br />	cmp	dl, PRINTSCREEN1<br />	jnz	forceprecode<br /><br />	; yep, swallow it<br /><br />	stc<br />	ret<br /><br />	; okay, its another two-byte scancode that we should send in<br /><br />forceprecode:<br />	push	ecx<br />	push	esi<br />	mov	ecx, 1<br />	lea	esi, ForcePreByte<br />	VxDCall	VKD_Force_Keys<br />	pop	esi<br />	pop	ecx<br />	jmp	chain<br />	<br />	; see if this is the precode byte<br /><br />checkprecode:<br />	cmp	cl, SCANESCAPE	<br />	jnz	checklshift<br />	mov	PreCode, 1<br />	stc				; swallow it so system ignores it until<br />	ret				; we figure out what to do with it<br /><br />	;----------------------------------------------------------------------<br />	;<br />	; CODE TO KEEP TRACK OF SHIFT KEY STATE<br />	;<br />	;----------------------------------------------------------------------<br />	; is the left-shift status changing?<br /><br />checklshift:	<br />	cmp	dl, LEFTSHIFT<br />	jnz	checkrshift<br />	test	cl, 80h<br />	jz	leftshiftdown<br />	mov	LeftShiftState, UP<br />	jmp	chain<br /><br />leftshiftdown:<br />	mov	LeftShiftState, DOWN<br />	jmp	chain<br />	<br />	; is the right-shift status changing?<br /><br />checkrshift:<br />	cmp	dl, RIGHTSHIFT<br />	jnz	cap2ctrl<br />	test	cl, 80h	<br />	jz	rightshiftdown<br />	mov	RightShiftState, UP<br />	jmp	chain<br /><br />rightshiftdown:<br />	mov	RightShiftState, DOWN<br />	jmp	chain<br /><br />	;----------------------------------------------------------------------<br />	;<br />	; CAP2CTRL CODE<br />	;<br />	;----------------------------------------------------------------------<br />	; switch caps-lock to control<br /><br />cap2ctrl:<br />	cmp	dl, CAPSLOCK<br />	jnz	esc2accent<br />	and	cl, 80h<br />	or	cl, LEFTCTRL<br />	jmp	chain<br /><br />	;----------------------------------------------------------------------<br />	;<br />	; ESCAPE 2 ACCENT GRAVE CODE<br />	;<br />	;----------------------------------------------------------------------<br />	; is the escape-accent grave switch option turned on?<br /><br />esc2accent:<br />	cmp	SwtchEscapeAccent, 0<br />	jz	chain<br /><br />	; yes, see if the escape key has been pressed<br /><br />escape:<br />	cmp	dl, ESCAPEKEY<br />	jnz	accent<br />	cmp	LeftShiftState, UP	; is shift key down?<br />	jnz	chain			; yep, don't switch tilde<br />	cmp	RightShiftState, UP<br />	jnz	chain<br />	and	cl, 80h<br />	or	cl, ACCENTGRAVE<br />	jmp	chain<br /><br />	; see if the accent key has been pressed (needs shift up)<br /><br />accent:<br />	cmp	dl, ACCENTGRAVE<br />	jnz	chain<br />	cmp	LeftShiftState, UP	; is a shift key down?<br />	jnz	chain			; yep, they want tilde - no switch<br />	cmp	RightShiftState, UP	<br />	jnz	chain<br />	and	cl, 80h<br />	or	cl, ESCAPEKEY<br />	jmp	chain<br /><br />	;----------------------------------------------------------------------<br />	;<br />	; FALL THROUGH TO PREVIOUS HANDLER<br />	;<br />	;----------------------------------------------------------------------<br />	; call the previous hooker<br />chain:<br />;	Trace_Out &quot;---&gt; #CL&quot;<br />	call	Keyboard_Proc<br />	clc				; let the key through<br />	ret<br /><br />EndProc MyHook<br /><br />BeginProc OnDeviceIoControl<br />    	assume esi:ptr DIOCParams<br />    	.if .dwIoControlCode==DIOC_Open<br />	    	xor eax,eax<br />	.elseif .dwIoControlCode==1<br />		GetVxDServiceOrdinal eax, VKD_Filter_Keyboard_Input<br />		mov esi, offset32 MyHook<br />		VMMCall Hook_Device_Service<br />		mov Keyboard_Proc, esi<br />		clc<br />	.elseif .dwIoControlCode==2<br />		GetVxDServiceOrdinal eax, VKD_Filter_Keyboard_Input<br />		mov esi, offset32 MyHook<br />		VMMCall UnHook_Device_Service<br />		clc<br />	.endif<br />	ret<br />EndProc OnDeviceIoControl<br /><br />VxD_PAGEABLE_CODE_ENDS<br /><br />end<br /><br />====================<br /><br />I want to use this code to disable some key like Ctrl, Alt, Shift, F1, or some combine key like Alt-Z. If you have any ideas, please show it for me!<br /><br />Thank you, <br />Bung</div>
    <div class="meta">Posted on 2001-11-21 21:19:42 by bung</div>
   </div>
  </div>
 </body>
</html>