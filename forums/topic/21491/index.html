<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Always restarting - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=21491" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=34">OS Development</a> &raquo; <a href="../?id=21491">Always restarting</a></p>
   <div class="post" id="post-162193">
    <div class="subject"><a href="#post-162193">Always restarting</a></div>
    <div class="body">Please help me!I don&#39;t know where error in!It always restart! :sad: :sad: :sad:<br /> <br />;----------------------------------------------------------------------<br />; Processor Initialization<br />;----------------------------------------------------------------------<br />bits 16<br />org 0x7c00<br />;----------------------------------------------------------------------<br />GDT_CodeSegment_Selector&nbsp; &nbsp; equ 0x08<br />Processor_Interrupt_Procedure_Sector_Total&nbsp; equ 10<br />Processor_Interrupt_Procedure_Sector_Situation&nbsp; equ 8<br />Processor_Interrupt_Procedure_Memory_Location&nbsp; equ 0x100000<br />Processor_Interrupt_Procedure_Sector_Word_Total&nbsp; equ Processor_Interrupt_Procedure_Sector_Total*256<br />;----------------------------------------------------------------------<br /> jmp Initializate_Processor<br /> <br />GDT_Tables:<br />&nbsp;  GDT_Null:<br /> Null_Discriptor1 dd 0x00<br /> Null_Discriptor2 dd 0x00<br /> <br />&nbsp;  GDT_CodeSegment_Address equ $-GDT_Tables<br />&nbsp;  GDT_CodeSegment:<br />&nbsp; dw 0xffff<br />&nbsp; dw 0x0000<br />&nbsp; db 0x00<br />&nbsp; db 10011010b;0x9a <br />&nbsp; db 11001111b;0xcf<br />&nbsp; db 0x00<br /> <br />&nbsp;  GDT_DataSegment_Address equ $-GDT_Tables<br />&nbsp;  GDT_DataSegment:<br />&nbsp; dw 0xffff<br />&nbsp; dw 0x0000<br />&nbsp; db 0x00<br />&nbsp; db 10010010b;0x92<br />&nbsp; db 11001111b<br />&nbsp; db 0x00<br /> <br />&nbsp;  GDT64_CodeSegment_Address equ $-GDT_Tables<br />&nbsp;  GDT64_CodeSegment:<br />&nbsp; dd 0x0000<br />&nbsp; db 0x00<br />&nbsp; db 10000000b;10011000b<br />&nbsp; dw 0<br /> <br /> GDT_End:<br /> GDT_Address:<br />&nbsp; dw GDT_End-GDT_Tables-1<br />&nbsp; dd GDT_Tables<br />;----------------------------------------------------------------------<br />IDT_Address:<br />IDT_Address_Limit dw IDT_End-IDT_Tables-1<br />IDT_Address_Base&nbsp; dd IDT_Tables<br /> <br />IDT_Tables:<br /> <br />IDT_Discriptor_00:<br />Target_Code_Segment_Offset1_00&nbsp; dw 0x0000 ;Low bit<br />Target_Code_Segment_Selector_00 dw GDT_CodeSegment_Selector<br />Attribute_00&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_00 dw 0x0010 ;High bit<br /> <br />IDT_Discriptor_01:<br />Target_Code_Segment_Offset1_01&nbsp; dw 0x0100<br />Target_Code_Segment_Selector_01 dw GDT_CodeSegment_Selector<br />Attribute_01&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_01 dw 0x0010<br /> <br />IDT_Discriptor_02:<br />Target_Code_Segment_Offset1_02&nbsp; dw 0x0200<br />Target_Code_Segment_Selector_02 dw GDT_CodeSegment_Selector<br />Attribute_02&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_02 dw 0x0010<br /> <br />IDT_Discriptor_03:<br />Target_Code_Segment_Offset1_03&nbsp; dw 0x0300<br />Target_Code_Segment_Selector_03 dw GDT_CodeSegment_Selector<br />Attribute_03&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_03 dw 0x0010<br /> <br />IDT_Discriptor_04:<br />Target_Code_Segment_Offset1_04&nbsp; dw 0x0400<br />Target_Code_Segment_Selector_04 dw GDT_CodeSegment_Selector<br />Attribute_04&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_04 dw 0x0010<br /> <br />IDT_Discriptor_05:<br />Target_Code_Segment_Offset1_05&nbsp; dw 0x0500<br />Target_Code_Segment_Selector_05 dw GDT_CodeSegment_Selector<br />Attribute_05&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_05 dw 0x0010<br /> <br />IDT_Discriptor_06:<br />Target_Code_Segment_Offset1_06&nbsp; dw 0x0600<br />Target_Code_Segment_Selector_06 dw GDT_CodeSegment_Selector<br />Attribute_06&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_06 dw 0x0010<br /> <br />IDT_Discriptor_07:<br />Target_Code_Segment_Offset1_07&nbsp; dw 0x0700<br />Target_Code_Segment_Selector_07 dw GDT_CodeSegment_Selector<br />Attribute_07&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_07 dw 0x0010<br /> <br />IDT_Discriptor_08:<br />Target_Code_Segment_Offset1_08&nbsp; dw 0x0800<br />Target_Code_Segment_Selector_08 dw GDT_CodeSegment_Selector<br />Attribute_08&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_08 dw 0x0010<br /> <br />IDT_Discriptor_09:<br />Target_Code_Segment_Offset1_09&nbsp; dw 0x0900<br />Target_Code_Segment_Selector_09 dw GDT_CodeSegment_Selector<br />Attribute_09&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_09 dw 0x0010<br /> <br />IDT_Discriptor_10:<br />Target_Code_Segment_Offset1_10&nbsp; dw 0x0a00<br />Target_Code_Segment_Selector_10 dw GDT_CodeSegment_Selector<br />Attribute_10&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_10 dw 0x0010<br /> <br />IDT_Discriptor_11:<br />Target_Code_Segment_Offset1_11&nbsp; dw 0x0b00<br />Target_Code_Segment_Selector_11 dw GDT_CodeSegment_Selector<br />Attribute_11&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_11 dw 0x0010<br /> <br />IDT_Discriptor_12:<br />Target_Code_Segment_Offset1_12&nbsp; dw 0x0c00<br />Target_Code_Segment_Selector_12 dw GDT_CodeSegment_Selector<br />Attribute_12&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_12 dw 0x0010<br /> <br />IDT_Discriptor_13:<br />Target_Code_Segment_Offset1_13&nbsp; dw 0x0d00<br />Target_Code_Segment_Selector_13 dw GDT_CodeSegment_Selector<br />Attribute_13&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_13 dw 0x0010<br /> <br />IDT_Discriptor_14:<br />Target_Code_Segment_Offset1_14&nbsp; dw 0x0e00<br />Target_Code_Segment_Selector_14 dw GDT_CodeSegment_Selector<br />Attribute_14&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_14 dw 0x0010<br /> <br />IDT_Discriptor_15:<br />Target_Code_Segment_Offset1_15&nbsp; dw 0x0f00<br />Target_Code_Segment_Selector_15 dw GDT_CodeSegment_Selector<br />Attribute_15&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_15 dw 0x0010<br /> <br />IDT_Discriptor_16:<br />Target_Code_Segment_Offset1_16&nbsp; dw 0x1000<br />Target_Code_Segment_Selector_16 dw GDT_CodeSegment_Selector<br />Attribute_16&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_16 dw 0x0010<br /> <br />IDT_Discriptor_17:<br />Target_Code_Segment_Offset1_17&nbsp; dw 0x1100<br />Target_Code_Segment_Selector_17 dw GDT_CodeSegment_Selector<br />Attribute_17&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_17 dw 0x0010<br /> <br />IDT_Discriptor_18:<br />Target_Code_Segment_Offset1_18&nbsp; dw 0x1200<br />Target_Code_Segment_Selector_18 dw GDT_CodeSegment_Selector<br />Attribute_18&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_18 dw 0x0010<br /> <br />IDT_Discriptor_19:<br />Target_Code_Segment_Offset1_19&nbsp; dw 0x1300<br />Target_Code_Segment_Selector_19 dw GDT_CodeSegment_Selector<br />Attribute_19&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_19 dw 0x0010<br /> <br />IDT_Discriptor_20:<br />Target_Code_Segment_Offset1_20&nbsp; dw 0x1400<br />Target_Code_Segment_Selector_20 dw GDT_CodeSegment_Selector<br />Attribute_20&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_20 dw 0x0010<br /> <br />IDT_Discriptor_21:<br />Target_Code_Segment_Offset1_21&nbsp; dw 0x1500<br />Target_Code_Segment_Selector_21 dw GDT_CodeSegment_Selector<br />Attribute_21&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_21 dw 0x0010<br /> <br />IDT_Discriptor_22:<br />Target_Code_Segment_Offset1_22&nbsp; dw 0x1600<br />Target_Code_Segment_Selector_22 dw GDT_CodeSegment_Selector<br />Attribute_22&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_22 dw 0x0010<br /> <br />IDT_Discriptor_23:<br />Target_Code_Segment_Offset1_23&nbsp; dw 0x1700<br />Target_Code_Segment_Selector_23 dw GDT_CodeSegment_Selector<br />Attribute_23&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_23 dw 0x0010<br /> <br />IDT_Discriptor_24:<br />Target_Code_Segment_Offset1_24&nbsp; dw 0x1800<br />Target_Code_Segment_Selector_24 dw GDT_CodeSegment_Selector<br />Attribute_24&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_24 dw 0x0010<br /> <br />IDT_Discriptor_25:<br />Target_Code_Segment_Offset1_25&nbsp; dw 0x1900<br />Target_Code_Segment_Selector_25 dw GDT_CodeSegment_Selector<br />Attribute_25&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_25 dw 0x0010<br /> <br />IDT_Discriptor_26:<br />Target_Code_Segment_Offset1_26&nbsp; dw 0x1a00<br />Target_Code_Segment_Selector_26 dw GDT_CodeSegment_Selector<br />Attribute_26&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_26 dw 0x0010<br /> <br />IDT_Discriptor_27:<br />Target_Code_Segment_Offset1_27&nbsp; dw 0x1b00<br />Target_Code_Segment_Selector_27 dw GDT_CodeSegment_Selector<br />Attribute_27&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_27 dw 0x0010<br /> <br />IDT_Discriptor_28:<br />Target_Code_Segment_Offset1_28&nbsp; dw 0x1c00<br />Target_Code_Segment_Selector_28 dw GDT_CodeSegment_Selector<br />Attribute_28&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_28 dw 0x0010<br /> <br />IDT_Discriptor_29:<br />Target_Code_Segment_Offset1_29&nbsp; dw 0x1d00<br />Target_Code_Segment_Selector_29 dw GDT_CodeSegment_Selector<br />Attribute_29&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_29 dw 0x0010<br /> <br />IDT_Discriptor_30:<br />Target_Code_Segment_Offset1_30&nbsp; dw 0x1e00<br />Target_Code_Segment_Selector_30 dw GDT_CodeSegment_Selector<br />Attribute_30&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_30 dw 0x0010<br /> <br />IDT_Discriptor_31:<br />Target_Code_Segment_Offset1_31&nbsp; dw 0x1f00<br />Target_Code_Segment_Selector_31 dw GDT_CodeSegment_Selector<br />Attribute_31&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_31 dw 0x0010<br /> <br />IDT_Discriptor_32:<br />Target_Code_Segment_Offset1_32&nbsp; dw 0x2000<br />Target_Code_Segment_Selector_32 dw GDT_CodeSegment_Selector<br />Attribute_32&nbsp;  dw 0x8e00<br />Target_Code_Segment_Offset2_32 dw 0x0010<br /> <br />IDT_End:<br />; --------------------------------------------------------------------------------------<br /> <br />Initializate_Processor:<br /> <br />Mask_All_IRQ:<br /> mov al,255<br /> out 0xa1,al<br /> out 0x21,al<br /> <br />Enable_A20:<br /> <br /> Enable_A20_First:<br />&nbsp; in al,0x64<br />&nbsp; test al,2<br />&nbsp; jnz Enable_A20_First<br />&nbsp; mov al,0xd1<br />&nbsp; out 0x64,al<br /> Enable_A20_Second:<br />&nbsp; in al,0x64<br />&nbsp; test al,2<br />&nbsp; jnz Enable_A20_Second<br />&nbsp; mov al,0xdf<br />&nbsp; out 0x60,al<br /> <br />Disable_Interrupt:<br /> cli<br /> <br />Load_GDT:&nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; lgdt <br /> ;lidt <br /> <br />Enable_ProtectedMode:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br /> mov eax,0x11&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; mov cr0,eax&nbsp; &nbsp; <br /> <br />&nbsp; &nbsp; &nbsp; &nbsp; jmp GDT_CodeSegment_Address:Code_32&nbsp; <br /> <br />Bits 32<br />Code_32:<br /> <br /> mov ax,GDT_DataSegment_Address<br /> mov ds,ax<br /> mov es,ax<br /> mov ss,ax <br /> mov fs,ax <br /> mov gs,ax<br /> mov esp,0xffff&nbsp; <br /> <br />Load_Processor_Interrupt_Procedure:<br /> mov dx,0x1f6<br /> mov al,0xa0<br /> out dx,al<br /> <br /> mov dx,0x1f2<br /> mov al,Processor_Interrupt_Procedure_Sector_Total&nbsp; ;Read sector count=10<br /> out dx,al<br /> <br /> mov dx,0x1f3<br /> mov al,Processor_Interrupt_Procedure_Sector_Situation<br /> out dx,al<br /> <br /> mov dx,0x1f4<br /> mov al,0<br /> out dx,al<br /> <br /> mov dx,0x1f5<br /> mov al,0<br /> out dx,al<br /> <br /> mov dx,0x1f7<br /> mov al,0x20<br /> out dx,al<br /> <br /> Load_Processor_Interrupt_Procedure_Test_DRQ:<br />&nbsp; in&nbsp;  al,dx<br />&nbsp; test al,8<br />&nbsp; jz&nbsp;  Load_Processor_Interrupt_Procedure_Test_DRQ<br /> Load_Processor_Interrupt_Procedure_Read_Sector:<br />&nbsp; mov dx,0x1f0<br />&nbsp; mov edi,Processor_Interrupt_Procedure_Memory_Location<br />&nbsp; mov ecx,Processor_Interrupt_Procedure_Sector_Word_Total<br />&nbsp; rep insw<br /> <br /><br />PAE:<br />&nbsp; mov edi,0x600000<br /> mov eax,0x610000<br /> add eax,0x01<br /> stosd<br /> <br /> mov edi,0x610000<br /> mov eax,0x620000<br /> add eax,0x01<br /> stosd<br /> <br /> mov edi,0x620000<br /> mov eax,0x630000<br /> add eax,0x01<br /> stosd<br /> <br /> mov edi,0x630000<br /> mov eax,0x000001<br /> mov ecx,0x200<br />STOSE_PTE:<br /> stosd<br /> add eax,0x1000<br /> add edi,4<br /> loop STOSE_PTE<br /> <br /> mov eax,cr4<br /> bts eax,5<br /> mov cr4,eax<br /> <br />&nbsp; &nbsp; &nbsp;  mov&nbsp;  eax,0x600000&nbsp; &nbsp; &nbsp; &nbsp;  ; page directory location<br />&nbsp; &nbsp; &nbsp;  mov&nbsp;  cr3,eax<br />&nbsp; &nbsp; &nbsp;  mov&nbsp;  eax,cr0<br /> <br />mov ecx,0xc0000080<br />rdmsr<br />bts eax,8<br />wrmsr<br /> <br />mov al,0x34<br />mov [0xb8000],al<br /> <br />mov eax,cr0<br />bts eax,31<br />mov cr0,eax<br /> <br />mov al,0x37<br />mov [0xb8000],al<br /> <br /> db 0x66<br /> db 0xea<br /> dd Start64<br /> dw 0x18<br />bits 64<br />Start64:<br /> <br /><br />jmp $ </div>
    <div class="meta">Posted on 2005-07-19 02:05:07 by Wei.Jian</div>
   </div>
   <div class="post" id="post-162196">
    <div class="subject"><a href="#post-162196">Re: (AMD)OS for x86-64</a></div>
    <div class="body">Hi Wei Jian<br /><br />Do u know how many days I spent debugging such a program ? I do not remember... too much probably.<br /><br />What helped me is : TINY steps. Make as many steps as u can. The smallest as u can.<br /><br />I would suggest, as part of my experience:<br /><br />- enter PM 32-bit from DOS, come back to DOS. DOS... is it a joke ? No. Write your program below 0a0000, handle its useful tool &quot;debug&quot;<br /><br />- write basic routines for displaying hexa/decimal values to 0b8000h. <br /><br />- target a simple 32-bit IDT that works. It is great for avoiding 90 % or more of those insane &quot;triple fault&quot; that reboot your test machine. When your program comes back to DOS with an error code and its location, you are in the right way.<br /><br />=&gt; write a 32-bit IDT, test it with the kbd and/or timer and/or monitor. Alexei Frounze&#39;s tutorial helped me to do so. It won&#39;t be long and difficult to convert your 32-bit IDT to 64-bit IDT.<br /><br />- check your PDE/PTE... compare with others&#39; code, is it different and in what way ? What is really in memory ?<br /><br />- the real nightmare is the jump from one mode to another: mimic other&#39;s code, and try and fully understand how the processor should behave... &quot;fully&quot; is quite a challenge. Many tries and errors help checking your assumptions.<br /><br />- backup, backup, backup. Get the docs, understand them. Do inline debugging. With that kind of development: nothing&#39;s slower than rushing<br /><br />Hope it helps...<br /><br />Regards<br />valy<br /></div>
    <div class="meta">Posted on 2005-07-19 04:05:57 by valy</div>
   </div>
  </div>
 </body>
</html>