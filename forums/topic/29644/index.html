<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Checksum for files - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=29644" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=29644">Checksum for files</a></p>
   <div class="post" id="post-209308">
    <div class="subject"><a href="#post-209308">Checksum for files</a></div>
    <div class="body">I would like to make a program that will do a CRC32 checksum of files.<br />I have some 16 bit code, but it does not work on large files.<br /><br />Can this code be used to do that?<br /><br />Would I need to calculate the file size with my code and then be able to use this?<br /><br />Thanks.<br /><br /><br /><pre><code><br />;Courtesy of http://source.winehq.org/source/dlls/ntdll/rtl.c<br /><br />.386<br />.model flat, stdcall&nbsp; ;32 bit memory model<br />option casemap :none&nbsp; ;case sensitive<br /><br />include windows.inc<br /><br />.const<br />;CRC polynomial 0edb88320h<br />CRCTable	dd	000000000h,077073096h,0ee0e612ch,0990951bah,0076dc419h,0706af48fh,0e963a535h,09e6495a3h<br />		dd	00edb8832h,079dcb8a4h,0e0d5e91eh,097d2d988h,009b64c2bh,07eb17cbdh,0e7b82d07h,090bf1d91h<br />		dd	01db71064h,06ab020f2h,0f3b97148h,084be41deh,01adad47dh,06ddde4ebh,0f4d4b551h,083d385c7h<br />		dd	0136c9856h,0646ba8c0h,0fd62f97ah,08a65c9ech,014015c4fh,063066cd9h,0fa0f3d63h,08d080df5h<br />		dd	03b6e20c8h,04c69105eh,0d56041e4h,0a2677172h,03c03e4d1h,04b04d447h,0d20d85fdh,0a50ab56bh<br />		dd	035b5a8fah,042b2986ch,0dbbbc9d6h,0acbcf940h,032d86ce3h,045df5c75h,0dcd60dcfh,0abd13d59h<br />		dd	026d930ach,051de003ah,0c8d75180h,0bfd06116h,021b4f4b5h,056b3c423h,0cfba9599h,0b8bda50fh<br />		dd	02802b89eh,05f058808h,0c60cd9b2h,0b10be924h,02f6f7c87h,058684c11h,0c1611dabh,0b6662d3dh<br />		dd	076dc4190h,001db7106h,098d220bch,0efd5102ah,071b18589h,006b6b51fh,09fbfe4a5h,0e8b8d433h<br />		dd	07807c9a2h,00f00f934h,09609a88eh,0e10e9818h,07f6a0dbbh,0086d3d2dh,091646c97h,0e6635c01h<br />		dd	06b6b51f4h,01c6c6162h,0856530d8h,0f262004eh,06c0695edh,01b01a57bh,08208f4c1h,0f50fc457h<br />		dd	065b0d9c6h,012b7e950h,08bbeb8eah,0fcb9887ch,062dd1ddfh,015da2d49h,08cd37cf3h,0fbd44c65h<br />		dd	04db26158h,03ab551ceh,0a3bc0074h,0d4bb30e2h,04adfa541h,03dd895d7h,0a4d1c46dh,0d3d6f4fbh<br />		dd	04369e96ah,0346ed9fch,0ad678846h,0da60b8d0h,044042d73h,033031de5h,0aa0a4c5fh,0dd0d7cc9h<br />		dd	05005713ch,0270241aah,0be0b1010h,0c90c2086h,05768b525h,0206f85b3h,0b966d409h,0ce61e49fh<br />		dd	05edef90eh,029d9c998h,0b0d09822h,0c7d7a8b4h,059b33d17h,02eb40d81h,0b7bd5c3bh,0c0ba6cadh<br />		dd	0edb88320h,09abfb3b6h,003b6e20ch,074b1d29ah,0ead54739h,09dd277afh,004db2615h,073dc1683h<br />		dd	0e3630b12h,094643b84h,00d6d6a3eh,07a6a5aa8h,0e40ecf0bh,09309ff9dh,00a00ae27h,07d079eb1h<br />		dd	0f00f9344h,08708a3d2h,01e01f268h,06906c2feh,0f762575dh,0806567cbh,0196c3671h,06e6b06e7h<br />		dd	0fed41b76h,089d32be0h,010da7a5ah,067dd4acch,0f9b9df6fh,08ebeeff9h,017b7be43h,060b08ed5h<br />		dd	0d6d6a3e8h,0a1d1937eh,038d8c2c4h,04fdff252h,0d1bb67f1h,0a6bc5767h,03fb506ddh,048b2364bh<br />		dd	0d80d2bdah,0af0a1b4ch,036034af6h,041047a60h,0df60efc3h,0a867df55h,0316e8eefh,04669be79h<br />		dd	0cb61b38ch,0bc66831ah,0256fd2a0h,05268e236h,0cc0c7795h,0bb0b4703h,0220216b9h,05505262fh<br />		dd	0c5ba3bbeh,0b2bd0b28h,02bb45a92h,05cb36a04h,0c2d7ffa7h,0b5d0cf31h,02cd99e8bh,05bdeae1dh<br />		dd	09b64c2b0h,0ec63f226h,0756aa39ch,0026d930ah,09c0906a9h,0eb0e363fh,072076785h,005005713h<br />		dd	095bf4a82h,0e2b87a14h,07bb12baeh,00cb61b38h,092d28e9bh,0e5d5be0dh,07cdcefb7h,00bdbdf21h<br />		dd	086d3d2d4h,0f1d4e242h,068ddb3f8h,01fda836eh,081be16cdh,0f6b9265bh,06fb077e1h,018b74777h<br />		dd	088085ae6h,0ff0f6a70h,066063bcah,011010b5ch,08f659effh,0f862ae69h,0616bffd3h,0166ccf45h<br />		dd	0a00ae278h,0d70dd2eeh,04e048354h,03903b3c2h,0a7672661h,0d06016f7h,04969474dh,03e6e77dbh<br />		dd	0aed16a4ah,0d9d65adch,040df0b66h,037d83bf0h,0a9bcae53h,0debb9ec5h,047b2cf7fh,030b5ffe9h<br />		dd	0bdbdf21ch,0cabac28ah,053b39330h,024b4a3a6h,0bad03605h,0cdd70693h,054de5729h,023d967bfh<br />		dd	0b3667a2eh,0c4614ab8h,05d681b02h,02a6f2b94h,0b40bbe37h,0c30c8ea1h,05a05df1bh,02d02ef8dh<br /><br />.code<br /><br />CRC32_Calculate	proc	dwInitial:DWORD, pData:PBYTE, iLen:SDWORD<br />	LOCAL	dwCRC:DWORD<br />	<br />	push	esi<br />	push	ebx<br />	push	ecx<br />	<br />	mov	eax, dwInitial<br />	not	eax<br />	mov	dwCRC, eax<br />	<br />	mov	esi, pData<br />	mov	ecx, iLen<br />	.while	ecx &gt; 0<br />		push	ecx<br />		<br />		;crc = CRC_table[(crc ^ *pData) &amp; 0xff] ^ (crc &gt;&gt; 8);<br />		mov	eax, dwCRC<br />		mov	ebx, eax	;for the next step...<br />		shr	eax, 8<br />		<br />		xor	ebx, 	;...next step is here :)<br />		and	ebx, 0ffh<br />		<br />		mov	ebx, 		;4 == sizeof(DWORD)<br />		<br />		xor	ebx, eax<br />		<br />		mov	dwCRC, ebx<br />		<br />		inc	esi<br />		<br />		pop	ecx<br />		dec	ecx<br />	.endw<br />	<br />	pop	ecx<br />	pop	ebx<br />	pop	esi<br />	<br />	mov	eax, dwCRC<br />	not	eax<br />	<br />	ret<br />CRC32_Calculate	endp<br /><br />end<br /><br /><br /></code></pre></div>
    <div class="meta">Posted on 2009-10-25 10:29:39 by skywalker</div>
   </div>
   <div class="post" id="post-209309">
    <div class="subject"><a href="#post-209309">Re: Checksum for files</a></div>
    <div class="body">If you want just _A_ hash function, use Windows&#039; Cryptography API (if you don&#039;t mind lack of portability). It&#039;s quite fast and quite easy to use (you call 3-4 functions and get MD5 or SHA). Unfortunately I&#039;m not sure if it supports CRC32.</div>
    <div class="meta">Posted on 2009-10-25 11:27:11 by ti_mo_n</div>
   </div>
   <div class="post" id="post-209312">
    <div class="subject"><a href="#post-209312">Re: Checksum for files</a></div>
    <div class="body">Windows claims a CRC32 but it isn&#039;t.<br /><br />I found some C source code but didn&#039;t feel like converting it&#039;s 26K into assembly.<br />I may get a C compiler and do so.<br /><br />Take care,<br /><br />Andy</div>
    <div class="meta">Posted on 2009-10-25 14:58:55 by skywalker</div>
   </div>
   <div class="post" id="post-209320">
    <div class="subject"><a href="#post-209320">Re: Checksum for files</a></div>
    <div class="body">How can your 16-bit code fail to work? You port it to 32-bit correctly, right? Then you can feed data to it even bytewise.<br /><br />The snippet you&#039;ve quoted seems to be OK. Some slack can be cut, though.<br /><br />You may as well write your own bit-wise version, or use Intel&#039;s slice-by-X approach. It&#039;s size vs. speed tradeoff.<br /><br />Once you understand the idea of CRC, implementations are not hard to come by. Simple dword-byte-bit-wise solution can be:<br /><br /><pre><code><br />CRC_POLYNOMIAL equ 0EDB88320h<br /><br />PBYTE	TYPEDEF	PTR BYTE<br /><br />Update_CRC32	PROC	USES ebx, CRC32:DWORD, pBuffer:PBYTE, cbBuffer:DWORD<br />		mov	eax, CRC32<br />		not	eax<br />		mov	edx, pBuffer<br />		mov	ecx, cbBuffer<br />		shr	ecx, 2<br />		jz	byte_wise<br />;;; by dword<br />.REPEAT<br />		xor	eax, <br />		add	edx, 4<br />		mov	bl, 32<br />	.REPEAT<br />		shr	eax, 1<br />		.IF CARRY?<br />			xor	eax, CRC_POLYNOMIAL<br />		.ENDIF<br />		dec	bl<br />	.UNTIL	ZERO?<br />.UNTILCXZ<br />byte_wise:	mov	ecx, cbBuffer<br />		and	ecx, 3<br />		jz	done<br />;;; by byte<br />.REPEAT<br />		xor	al, <br />		inc	edx<br />		mov	bl, 8<br />	.REPEAT<br />		shr	eax, 1<br />		.IF CARRY?<br />			xor	eax, CRC_POLYNOMIAL<br />		.ENDIF<br />		dec	bl<br />	.UNTIL ZERO?<br />.UNTILCXZ<br />done:		not	eax<br />		ret<br />Update_CRC32	ENDP<br /></code></pre><br /><br />Polynomials over GF(2) are simple if you catch the essentials. After that you can slice&#039;n&#039;dice them the way you like it.</div>
    <div class="meta">Posted on 2009-10-26 06:27:40 by baldr</div>
   </div>
   <div class="post" id="post-209321">
    <div class="subject"><a href="#post-209321">Re: Checksum for files</a></div>
    <div class="body">Thanks.<br /><br />This is my first attempt to convert the 16 bit code to 32 bit.<br />It isn&#039;t working.<br /><br />I figured it&#039;s because going to 32 bit registers is going to require some changes.<br />I read up on les but could not figure out what it&#039;s doing in this code.<br /><br />Andy<br /><br /><br /><pre><code><br />; crc.asm - Performs a CRC on files specified in the command line.<br />;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />.MODEL&nbsp; &nbsp; &nbsp;  SMALL&nbsp; &nbsp; &nbsp;  <br />.486<br />.stack&nbsp; &nbsp; &nbsp;  200h<br /><br /><br />.data<br /><br /> initcrc dd 0FFFFFFFFh&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Initial CRC value<br /> filename db &quot;intel.txt&quot;,0<br /> crlf&nbsp; &nbsp; db 0Dh,0Ah,24h<br /> hndl&nbsp; &nbsp; dw 0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;File handle storage.<br /> buf&nbsp; &nbsp;  dd 0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Dynamic storage. Do not move!<br /><br />;*****************************************************<br />; 32 bit reverse crc table for polynomial EDB88320h&nbsp; (Zmodem,PKZip)<br />; X^32+X^26+X^23+X^22+X^16+X^12+X^11+X^10+X^8+X^7+X^5+X^4+X^2+X^1+X^0<br /><br />crc32tab&nbsp; dd&nbsp; &nbsp; 000000000h, 077073096h, 0ee0e612ch, 0990951bah, 0076dc419h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0706af48fh, 0e963a535h, 09e6495a3h, 00edb8832h, 079dcb8a4h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0e0d5e91eh, 097d2d988h, 009b64c2bh, 07eb17cbdh, 0e7b82d07h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 090bf1d91h, 01db71064h, 06ab020f2h, 0f3b97148h, 084be41deh<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 01adad47dh, 06ddde4ebh, 0f4d4b551h, 083d385c7h, 0136c9856h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0646ba8c0h, 0fd62f97ah, 08a65c9ech, 014015c4fh, 063066cd9h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0fa0f3d63h, 08d080df5h, 03b6e20c8h, 04c69105eh, 0d56041e4h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0a2677172h, 03c03e4d1h, 04b04d447h, 0d20d85fdh, 0a50ab56bh<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 035b5a8fah, 042b2986ch, 0dbbbc9d6h, 0acbcf940h, 032d86ce3h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 045df5c75h, 0dcd60dcfh, 0abd13d59h, 026d930ach, 051de003ah<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0c8d75180h, 0bfd06116h, 021b4f4b5h, 056b3c423h, 0cfba9599h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0b8bda50fh, 02802b89eh, 05f058808h, 0c60cd9b2h, 0b10be924h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 02f6f7c87h, 058684c11h, 0c1611dabh, 0b6662d3dh, 076dc4190h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 001db7106h, 098d220bch, 0efd5102ah, 071b18589h, 006b6b51fh<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 09fbfe4a5h, 0e8b8d433h, 07807c9a2h, 00f00f934h, 09609a88eh<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0e10e9818h, 07f6a0dbbh, 0086d3d2dh, 091646c97h, 0e6635c01h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 06b6b51f4h, 01c6c6162h, 0856530d8h, 0f262004eh, 06c0695edh<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 01b01a57bh, 08208f4c1h, 0f50fc457h, 065b0d9c6h, 012b7e950h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 08bbeb8eah, 0fcb9887ch, 062dd1ddfh, 015da2d49h, 08cd37cf3h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0fbd44c65h, 04db26158h, 03ab551ceh, 0a3bc0074h, 0d4bb30e2h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 04adfa541h, 03dd895d7h, 0a4d1c46dh, 0d3d6f4fbh, 04369e96ah<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0346ed9fch, 0ad678846h, 0da60b8d0h, 044042d73h, 033031de5h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0aa0a4c5fh, 0dd0d7cc9h, 05005713ch, 0270241aah, 0be0b1010h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0c90c2086h, 05768b525h, 0206f85b3h, 0b966d409h, 0ce61e49fh<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 05edef90eh, 029d9c998h, 0b0d09822h, 0c7d7a8b4h, 059b33d17h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 02eb40d81h, 0b7bd5c3bh, 0c0ba6cadh, 0edb88320h, 09abfb3b6h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 003b6e20ch, 074b1d29ah, 0ead54739h, 09dd277afh, 004db2615h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 073dc1683h, 0e3630b12h, 094643b84h, 00d6d6a3eh, 07a6a5aa8h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0e40ecf0bh, 09309ff9dh, 00a00ae27h, 07d079eb1h, 0f00f9344h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 08708a3d2h, 01e01f268h, 06906c2feh, 0f762575dh, 0806567cbh<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0196c3671h, 06e6b06e7h, 0fed41b76h, 089d32be0h, 010da7a5ah<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 067dd4acch, 0f9b9df6fh, 08ebeeff9h, 017b7be43h, 060b08ed5h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0d6d6a3e8h, 0a1d1937eh, 038d8c2c4h, 04fdff252h, 0d1bb67f1h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0a6bc5767h, 03fb506ddh, 048b2364bh, 0d80d2bdah, 0af0a1b4ch<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 036034af6h, 041047a60h, 0df60efc3h, 0a867df55h, 0316e8eefh<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 04669be79h, 0cb61b38ch, 0bc66831ah, 0256fd2a0h, 05268e236h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0cc0c7795h, 0bb0b4703h, 0220216b9h, 05505262fh, 0c5ba3bbeh<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0b2bd0b28h, 02bb45a92h, 05cb36a04h, 0c2d7ffa7h, 0b5d0cf31h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 02cd99e8bh, 05bdeae1dh, 09b64c2b0h, 0ec63f226h, 0756aa39ch<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0026d930ah, 09c0906a9h, 0eb0e363fh, 072076785h, 005005713h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 095bf4a82h, 0e2b87a14h, 07bb12baeh, 00cb61b38h, 092d28e9bh<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0e5d5be0dh, 07cdcefb7h, 00bdbdf21h, 086d3d2d4h, 0f1d4e242h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 068ddb3f8h, 01fda836eh, 081be16cdh, 0f6b9265bh, 06fb077e1h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 018b74777h, 088085ae6h, 0ff0f6a70h, 066063bcah, 011010b5ch<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 08f659effh, 0f862ae69h, 0616bffd3h, 0166ccf45h, 0a00ae278h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0d70dd2eeh, 04e048354h, 03903b3c2h, 0a7672661h, 0d06016f7h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 04969474dh, 03e6e77dbh, 0aed16a4ah, 0d9d65adch, 040df0b66h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 037d83bf0h, 0a9bcae53h, 0debb9ec5h, 047b2cf7fh, 030b5ffe9h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0bdbdf21ch, 0cabac28ah, 053b39330h, 024b4a3a6h, 0bad03605h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 0cdd70693h, 054de5729h, 023d967bfh, 0b3667a2eh, 0c4614ab8h<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 05d681b02h, 02a6f2b94h, 0b40bbe37h, 0c30c8ea1h, 05a05df1bh<br />&nbsp; &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; 02d02ef8dh<br /><br />.code<br /><br />begin:<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ax,@data<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ds,ax<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ax,03D00h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Open for read.<br />&nbsp; &nbsp; &nbsp; &nbsp; lea&nbsp; &nbsp;  dx,filename&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Filename in default DTA (PSP)<br />&nbsp; &nbsp; &nbsp; &nbsp; int&nbsp; &nbsp;  21h<br />&nbsp; &nbsp; &nbsp; &nbsp; ;jc&nbsp; &nbsp; &nbsp; error2<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  word ptr ,ax<br />read:<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ah,03Fh<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  bx,word ptr <br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  edx,offset buf<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ecx,0FFFFFFFFh&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Leave room in buffer for stack.<br />&nbsp; &nbsp; &nbsp; &nbsp; sub&nbsp; &nbsp;  ecx,edx&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Maximum buffer size.<br />&nbsp; &nbsp; &nbsp; &nbsp; int&nbsp; &nbsp;  21h<br />&nbsp; &nbsp; &nbsp; &nbsp; ;jc&nbsp; &nbsp; &nbsp; error3<br />&nbsp; &nbsp; &nbsp; &nbsp; ; File size is in eax<br />&nbsp; &nbsp; &nbsp; &nbsp; or&nbsp; &nbsp; &nbsp; eax,eax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;End of file?<br />&nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; exit<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; call&nbsp; &nbsp; UpdateCRC32&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;calculate CRC.<br />&nbsp; &nbsp; &nbsp; &nbsp; jmp&nbsp; &nbsp;  read<br />exit:<br />&nbsp; &nbsp; &nbsp; &nbsp; xor&nbsp; &nbsp;  word ptr ,0FFFFh&nbsp; ;Finish CRC calculation.<br />&nbsp; &nbsp; &nbsp; &nbsp; xor&nbsp; &nbsp;  word ptr ,0FFFFh<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  eax,dword ptr <br />&nbsp; &nbsp; &nbsp; &nbsp; call&nbsp; &nbsp; bin2hex&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Print CRC to screen.<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  eax,dword ptr <br />&nbsp; &nbsp; &nbsp; &nbsp; call&nbsp; &nbsp; bin2hex<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ax,0FFFFh<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  dword ptr,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  dword ptr,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  dx,offset CRLF&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;linefeed<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ah,09h<br />&nbsp; &nbsp; &nbsp; &nbsp; int&nbsp; &nbsp;  21h<br />close:<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  bx,word ptr <br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ah,3Eh&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;close file.<br />&nbsp; &nbsp; &nbsp; &nbsp; int&nbsp; &nbsp;  21h<br /> ; <br /> ;&nbsp; &nbsp; &nbsp; &nbsp;  mov&nbsp; &nbsp;  ah,4Fh&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Do more files.<br /> ;&nbsp; &nbsp; &nbsp; &nbsp;  int&nbsp; &nbsp;  21h<br /> ;&nbsp; &nbsp; &nbsp; &nbsp;  jc&nbsp; &nbsp; &nbsp; toDOS<br /> ;&nbsp; &nbsp; &nbsp; &nbsp;  jmp&nbsp; &nbsp;  findnext<br />toDOS:<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ax,04C00h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Normal exit to DOS.<br />&nbsp; &nbsp; &nbsp; &nbsp; int&nbsp; &nbsp;  21h<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />bin2hex&nbsp; proc&nbsp; &nbsp; near<br /><br />;Convert AX to HEX ASCII output<br /><br />bin2he: mov&nbsp; &nbsp;  cx,4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;4 hex digits<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  bx,10h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;divisor<br />bin2h1: xor&nbsp; &nbsp;  dx,dx&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;zero DX for 16 bit divide<br />&nbsp; &nbsp; &nbsp; &nbsp; div&nbsp; &nbsp;  bx&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;leaves quotient in AX<br />&nbsp; &nbsp; &nbsp; &nbsp; add&nbsp; &nbsp;  dl,&#039;0&#039;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;convert remainder to ASCII<br />&nbsp; &nbsp; &nbsp; &nbsp; cmp&nbsp; &nbsp;  dl,&#039;9&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; jna&nbsp; &nbsp;  bin2h2<br />&nbsp; &nbsp; &nbsp; &nbsp; add&nbsp; &nbsp;  dl,&#039;A&#039;-&#039;9&#039;-1<br />bin2h2: push&nbsp; &nbsp; dx&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;put on stack<br />&nbsp; &nbsp; &nbsp; &nbsp; loop&nbsp; &nbsp; bin2h1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;repeat<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  cx,4<br />bin2h3: pop&nbsp; &nbsp;  ax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;pop most significant digit first<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  dl,al<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ah,02h<br />&nbsp; &nbsp; &nbsp; &nbsp; int&nbsp; &nbsp;  21h<br />&nbsp; &nbsp; &nbsp; &nbsp; loop&nbsp; &nbsp; bin2h3<br />&nbsp; &nbsp; &nbsp; &nbsp; ret<br />bin2hex endp<br /><br />UpdateCRC32&nbsp; &nbsp;  proc&nbsp; &nbsp; near<br /><br />; UpdateCRC32 takes an initial CRC value and updates it from<br />; data in &#039;buf&#039;. The updated CRC is then stored in InitCRC.<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  si,offset buf<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  cx,ax<br />&nbsp; &nbsp; &nbsp; &nbsp; jcxz&nbsp; &nbsp; bye<br />&nbsp; &nbsp; &nbsp; &nbsp; les&nbsp; &nbsp;  ax,<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  dx,ES<br />lo2:<br />&nbsp; &nbsp; &nbsp; &nbsp; xor&nbsp; &nbsp;  bh,bh<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  bl,al<br />&nbsp; &nbsp; &nbsp; &nbsp; lodsb<br />&nbsp; &nbsp; &nbsp; &nbsp; xor&nbsp; &nbsp;  bl,al<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  al,ah<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ah,dl<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  dl,dh<br />&nbsp; &nbsp; &nbsp; &nbsp; xor&nbsp; &nbsp;  dh,dh<br />&nbsp; &nbsp; &nbsp; &nbsp; shl&nbsp; &nbsp;  bx,1<br />&nbsp; &nbsp; &nbsp; &nbsp; shl&nbsp; &nbsp;  bx,1<br />&nbsp; &nbsp; &nbsp; &nbsp; les&nbsp; &nbsp;  bx,<br />&nbsp; &nbsp; &nbsp; &nbsp; xor&nbsp; &nbsp;  ax,bx<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  bx,ES<br />&nbsp; &nbsp; &nbsp; &nbsp; xor&nbsp; &nbsp;  dx,bx<br />&nbsp; &nbsp; &nbsp; &nbsp; loop&nbsp; &nbsp; lo2<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ,eax&nbsp;  ; Store result in InitCRC<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ,edx<br />bye:<br />&nbsp; &nbsp; &nbsp; &nbsp; ret<br />UpdateCRC32&nbsp; &nbsp;  endp<br /><br />end begin<br /></code></pre></div>
    <div class="meta">Posted on 2009-10-26 10:28:11 by skywalker</div>
   </div>
   <div class="post" id="post-209326">
    <div class="subject"><a href="#post-209326">Re: Checksum for files</a></div>
    <div class="body"><em>&quot;When in doubt, RTFM&quot;</em>.<br /><br /><strong>LES</strong> does exactly what Intel manual says about it: loads far pointer (16:16 into es:bx in your case). Segment register hardly can be useful in this context.<br /><br />Are you using DOS extender? Which one? Most of them use <strong>flat</strong> model, not <strong>small</strong>.<br /><br />You&#039;re calling int21/3F DOS service with ds:edx pointing to <u>single dword</u> read buffer, <strong>buf</strong> (<strong>crc32tab</strong> immediately follows it), yet passing <strong>0FFFFFFFFh-offset buf</strong> (not much less than 4GiB) as it&#039;s size. Comments about dynamic storage will not allocate it automagically. Even if DOS service successfully reads from that file, it will overwrite <strong>crc32tab</strong> and, possibly, your code.<br /><br />What <u>exactly</u> are you trying to do? For example: write real-mode program with some 32-bit registers usage; write 32-bit flat-mode program for some DOS-extender; etc.</div>
    <div class="meta">Posted on 2009-10-26 12:06:10 by baldr</div>
   </div>
   <div class="post" id="post-209327">
    <div class="subject"><a href="#post-209327">Re: Checksum for files</a></div>
    <div class="body"><div class="quote"><br /><em>&quot;When in doubt, RTFM&quot;</em>.<br /><br /><strong>LES</strong> does exactly what Intel manual says about it: loads far pointer (16:16 into es:bx in your case). Segment register hardly can be useful in this context.<br /><br />Are you using DOS extender? Which one? Most of them use <strong>flat</strong> model, not <strong>small</strong>.<br /><br />You&#039;re calling int21/3F DOS service with ds:edx pointing to <u>single dword</u> read buffer, <strong>buf</strong> (<strong>crc32tab</strong> immediately follows it), yet passing <strong>0FFFFFFFFh-offset buf</strong> (not much less than 4GiB) as it&#039;s size. Comments about dynamic storage will not allocate it automagically. Even if DOS service successfully reads from that file, it will overwrite <strong>crc32tab</strong> and, possibly, your code.<br /><br />What <u>exactly</u> are you trying to do? For example: write real-mode program with some 32-bit registers usage; write 32-bit flat-mode program for some DOS-extender; etc.<br /></div><br /><br />This should be in the heap as it is 16 bit code. I&#039;ll post a reply there.<br /><br />Andy</div>
    <div class="meta">Posted on 2009-10-26 13:18:12 by skywalker</div>
   </div>
  </div>
 </body>
</html>