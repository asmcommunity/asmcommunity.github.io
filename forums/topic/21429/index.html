<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>memory mapping as IPC - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=21429" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=21429">memory mapping as IPC</a></p>
   <div class="post" id="post-161826">
    <div class="subject"><a href="#post-161826">memory mapping as IPC</a></div>
    <div class="body">Question on memory mapping under windows 2000, SP4. This is more of a generic programming question, but I am doing the development in MASM to try and learn a thing or two :)<br /><br />I&#39;m attempting to use a memory mapped file as IPC between a windows service (running ring3 under local system account) and a client interface (also ring3, from a normal unprivileged &quot;user&quot; account). <br /><br />From the client side, I&#39;ve been able to create a memory map with a well-known known name successfully, however using the same name, the service cannot seem to open it. When I make the call to OpenFileMapping from the windows service, it fails. If I try opening it from the service using CreateFileMapping, and test for ERROR_ALREADY_EXISTS, I see it&#39;s creating a new file map.<br /><br />Is file mapping limited to &quot;in-session&quot; processes? Assuming the windows service is running in its own session, that would explain the failure.<br />Or perhaps is this a security issue I have to somehow grant access to the memory map by modifying some kind of a process security descriptor?<br /><br />Maybe I should be using a different form of IPC?? :)<br /><br /><br />------- client code<br /><pre><code>	.if reason==DLL_PROCESS_ATTACH<br />		invoke CreateFileMapping, INVALID_HANDLE_VALUE, NULL, PAGE_READWRITE, 0, 1, offset mmapOutName? ; whopping 1 byte map<br />		.IF eax == NULL<br />			invoke GetLastError<br />			mov ebx, eax<br />			invoke FormatMessage, FORMAT_MESSAGE_FROM_SYSTEM+FORMAT_MESSAGE_MAX_WIDTH_MASK, \<br />				NULL, ebx, NULL, addr tempBuf, SIZEOF tempBuf, NULL<br />			invoke MessageBox, 0, addr tempBuf, $CTA0(&quot;CreateFileMapping Error&quot;), 0<br />		.ELSE<br />			mov hMemoryMap, eax<br />			<br />			invoke GetLastError<br />			.IF eax==ERROR_ALREADY_EXISTS<br />				invoke MessageBox,0,$CTA0(&quot;FYI: a memory map of same name already exists&quot;),0,0<br />			.ELSE<br />				invoke MessageBox,0,$CTA0(&quot;FYI: a memory map doesnt exist with this name&quot;),0,0<br />			.ENDIF<br />			<br />			invoke MapViewOfFile, hMemoryMap, FILE_MAP_WRITE, 0, 0, 0 ; map whole thing into the view window, starting at 0<br />			.IF eax!= NULL<br />				mov pOutgoingMessageMapView, eax<br />				invoke MessageBox, 0, $CTA0(&quot;map successful&quot;), 0, 0<br />			.ELSE<br />				invoke MessageBox, 0, $CTA0(&quot;cant map view of file&quot;), 0, 0<br />			.ENDIF<br /><br />		.ENDIF<br />	.elseif reason==DLL_PROCESS_DETACH<br />		invoke UnmapViewOfFile, pOutgoingMessageMapView<br />		invoke CloseHandle, hMemoryMap<br />	.endif</code></pre><br /><br /><br /><br />----------------- server code:<br /><pre><code>	;invoke OpenFileMapping, FILE_MAP_READ, 0, addr mmapOutName? ? ? ? ; tried this, but failed<br />	invoke CreateFileMapping, INVALID_HANDLE_VALUE, NULL, PAGE_READ, 0, 1, addr mmapOutName? ? ; seems to create new map... mmapOutName is same!<br />	.IF eax == NULL<br />		invoke OutputDebugString, $CTA0(&quot;OpenFileMapping failure&quot;)<br />	.ELSE<br />		mov hMmapFromFromPlugins, eax<br />		invoke GetLastError<br />		.IF eax==ERROR_ALREADY_EXISTS<br />			invoke OutputDebugString, $CTA0(&quot;Existing memory map used&quot;)<br />		.ELSE<br />		invoke OutputDebugString, $CTA0(&quot;New memory map used&quot;)<br />		.ENDIF		<br />	.ENDIF<br />	<br />	invoke MapViewOfFile, hMmapFromFromPlugins, FILE_MAP_READ, 0, 0, 0 ; map the whole thing, starting from 0<br />	.IF eax == NULL<br />		invoke OutputDebugString, $CTA0(&quot;Can&#39;t map view of mmap for plugin&quot;)<br />	.ELSE<br />		mov pMsgFromPluginsBuf, eax<br />	.ENDIF</code></pre><br /><br /><br />Sorry if this is an easy question, but I wan&#39;t able to find anything searching the forums, or via google :p<br /><br />Thanks,<br /><br />Jerome</div>
    <div class="meta">Posted on 2005-07-08 15:27:45 by jackal651</div>
   </div>
   <div class="post" id="post-161827">
    <div class="subject"><a href="#post-161827">Re: memory mapping as IPC</a></div>
    <div class="body">Hmmm, are you creating the filemapping in the client, then trying to access it from the server? It should be the other way around. And you probably need to play with security descriptors, since you want communication between privileged and unprivileged processes.<br /><br />I would use sockets or named pipes instead, since they&#39;re properly synchronized, and probably a bit easier to deal with correctly.<br /></div>
    <div class="meta">Posted on 2005-07-08 15:57:27 by f0dder</div>
   </div>
   <div class="post" id="post-161828">
    <div class="subject"><a href="#post-161828">Re: memory mapping as IPC</a></div>
    <div class="body">Thanks for the quick reply f0dder!<br /><br />I did try creating the memory map from the service first, but then the client ends up creating its own memory map as well. So it doesn&#39;t seem like it&#39;s seeing across the &quot;current user&quot; and &quot;local system&quot; windows sessions. Humm.<br /><br />I&#39;ve also tried experimenting with prefixing the memory map name with &quot;Global\&quot; and &quot;Local\&quot; but it didn&#39;t seem to change the behaviour.<br /><br />Your advice for looking into using sockets will probably be tried next, because it seems that using memory mapping in this way is a dead end. The point of this project is to build a client-server interface that lets a user do some &quot;empowered&quot; tasks as a non-administrator, such as add printers, etc. I&#39;ve already been able to do this with scripts, but coding a more &quot;elegant&quot; solution is not as easy as I&#39;d hoped!<br /><br />damn memory mapping!? ;)<br /><br />-Jerome<br /><br /></div>
    <div class="meta">Posted on 2005-07-08 16:28:55 by jackal651</div>
   </div>
   <div class="post" id="post-161829">
    <div class="subject"><a href="#post-161829">Re: memory mapping as IPC</a></div>
    <div class="body">Well, it ought to be possible to create a filemap in the service (probably requiring some playing around with <strong>lpAttributes</strong>), and then use OpenFileMapping in the client... I almost feel like playing around a bit myself, because it&#39;s weird if it&#39;s not possible :)<br /><br />But well, consider sockets or pipes - detecting when a command has been &quot;sent&quot;, and proper synchronization, would be somewhat hard with filemapping.<br /><br />Perhaps using mailslots is an even better option? I&#39;ve never played with them myself, but the advantage seems to be that, client-side, mailslots work even on 9x systems.<br /></div>
    <div class="meta">Posted on 2005-07-08 16:39:31 by f0dder</div>
   </div>
   <div class="post" id="post-161830">
    <div class="subject"><a href="#post-161830">Re: memory mapping as IPC</a></div>
    <div class="body">what is the error when you try to OpenFileMapping?<br /><br />I have successfully used memory mapped files in conjunction with events for inter-process communication, but both processes were running under the same user. Maybe you really do have to adjust security tokens on the object</div>
    <div class="meta">Posted on 2005-07-08 16:42:09 by comrade</div>
   </div>
   <div class="post" id="post-161833">
    <div class="subject"><a href="#post-161833">Re: memory mapping as IPC</a></div>
    <div class="body">When creating the memory map from the client with readwrite, then trying openfilemapping as read only from the service, FormatMessage returns a &quot;The system cannot find the file specified&quot; error.<br /><br />It&#39;s like it doesn&#39;t even see the memory map exists from within the service. I dont think it would have anything to do with the fact that the client-side code memory map is being created from from a loaded dll... since it shares the same heap space as my main client program, it should make no difference if it&#39;s in a dll or not.<br /><br />I&#39;ll have to play with this more next week... out of time and it&#39;s Friday. Thanks for the dialog on this. It&#39;s good to keep the old brain moving with a fresh perspective!<br /><br />-Jerome<br /></div>
    <div class="meta">Posted on 2005-07-08 17:23:42 by jackal651</div>
   </div>
   <div class="post" id="post-161837">
    <div class="subject"><a href="#post-161837">Re: memory mapping as IPC</a></div>
    <div class="body">Jack,<br /><br />With memory mapped files set as a memory block from the system paging file, you actually write duplicate code in both server and client apps as the memory mapped file system allows for this. You must make sure the naming is the same between both apps so that both can read and/or write to the memory.<br /><br />As far as triggering a response from the other ap, either client or server, you have a number of options, there is the techniques that f0dder mentioned and you can also creeate and send private messages using the HWND_BROADCAST handle so that the other app can respond to it.<br /><br />A memory mapped file is probably faster for data transfer but you would need to experiment to see which communication technique best suited your task when it comes to triggering a response from either app that uses the memory mapped file.</div>
    <div class="meta">Posted on 2005-07-08 21:28:30 by hutch--</div>
   </div>
   <div class="post" id="post-161850">
    <div class="subject"><a href="#post-161850">Re: memory mapping as IPC</a></div>
    <div class="body">A memory mapped file would be a good approach if you need to communicate a lot of data between client/server, as you avoid a lot of copying-around overhead. I would still use sockets, pipes or perhaps events in the MMF memory (that&#39;s what you did, comrade?) to do the sync communication, since HWND_BROADCAST sends traffic to all windows, and the other methods are more &quot;focused&quot;.<br /><br />I&#39;ll play around a bit with this stuff later today when the gf leaves, and see what I can come up with.<br /></div>
    <div class="meta">Posted on 2005-07-09 07:32:51 by f0dder</div>
   </div>
   <div class="post" id="post-161955">
    <div class="subject"><a href="#post-161955">Re: memory mapping as IPC</a></div>
    <div class="body">Interesting update:<br /><br />I wrote simple client/server exes to open a memory mapped file. I run the server first to create the section as READWRITE. I leave it running with the success messagebox open, then run the client with OpenFileMapping for WRITE access - success!<br /><br />However if I recompile the client to open it with READ-ONLY access - failure with &quot;Access is Denied.&quot;<br /><br />The reason for this is that I was aiming to create two separate memory maps for IPC. Only the creating process has write access, and any others read... like a one-way conduit.<br /><br />I can&#39;t imagine the security descriptor for the memory map has to be changed if I can successfully open with write access.<br /><br />Maybe it&#39;s not possible to open a memory map as read-only??<br /><br />Code is attached if any are interested to try this themselves!<br /><br /><br />Server Code:<br /><pre><code>.386<br />.model flat,stdcall<br />option casemap:none<br /><br />include \masm32\include\windows.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\user32.inc<br />include \masm32\macros\Strings.mac<br />includelib \masm32\lib\kernel32.lib<br />includelib \masm32\lib\user32.lib<br /><br />.data<br />tempBuf	BYTE 1024 dup(?)<br />hMemoryMap HANDLE ?<br />pOutgoingMessageMapView DWORD ?<br />blahblah BYTE &quot;BLAHBLAH&quot;,0<br /><br />.code<br />start:<br />	invoke CreateFileMapping, INVALID_HANDLE_VALUE, NULL, PAGE_READWRITE, 0, 1, offset blahblah<br />	.IF eax == NULL<br />		invoke GetLastError<br />		invoke FormatMessage, FORMAT_MESSAGE_FROM_SYSTEM+FORMAT_MESSAGE_MAX_WIDTH_MASK, \<br />			NULL, eax, NULL, offset tempBuf, SIZEOF tempBuf, NULL<br />		invoke MessageBox, 0, offset tempBuf, $CTA0(&quot;CreateFileMapping Error&quot;), 0<br />	.ELSE<br />		mov hMemoryMap, eax<br />		invoke GetLastError<br />		.IF eax==ERROR_ALREADY_EXISTS<br />			invoke MessageBox,0,$CTA0(&quot;FYI: a memory map of same name already exists&quot;),0,0<br />		.ELSE<br />			invoke MessageBox,0,$CTA0(&quot;FYI: a memory map doesnt exist with this name&quot;),0,0<br />		.ENDIF<br />		invoke MapViewOfFile, hMemoryMap, FILE_MAP_WRITE, 0, 0, 0 ; map whole thing into the view window, starting at 0<br />		.IF eax!= NULL<br />			mov pOutgoingMessageMapView, eax<br />			invoke MessageBox, 0, $CTA0(&quot;map is open, start client&quot;), 0, 0<br />		.ELSE<br />			invoke MessageBox, 0, $CTA0(&quot;cant map view of file&quot;), 0, 0<br />		.ENDIF<br />		.ENDIF<br />	<br />	invoke UnmapViewOfFile, pOutgoingMessageMapView<br />	invoke CloseHandle, hMemoryMap<br /><br />invoke ExitProcess, 0<br />end start</code></pre><br /><br />Client Code:<br /><pre><code>.386<br />.model flat,stdcall<br />option casemap:none<br />include \masm32\include\windows.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\user32.inc<br />include \masm32\macros\Strings.mac<br />includelib \masm32\lib\kernel32.lib<br />includelib \masm32\lib\user32.lib<br /><br />.data<br />tempBuf	BYTE 1024 dup(?)<br />hMemoryMap HANDLE ?<br />pIncomingMessageMapView DWORD ?<br />blahblah BYTE &quot;BLAHBLAH&quot;,0<br /><br />.code<br />start:<br />	invoke OpenFileMapping, FILE_MAP_WRITE, FALSE, offset blahblah ; works ok. equ to 02h.<br />	;invoke OpenFileMapping, FILE_MAP_READ, FALSE, offset blahblah ; read only doesn&#39;t work? equ to 04h.<br />	.IF eax == NULL<br />		invoke GetLastError<br />		invoke FormatMessage, FORMAT_MESSAGE_FROM_SYSTEM+FORMAT_MESSAGE_MAX_WIDTH_MASK, \<br />			NULL, eax, NULL, offset tempBuf, SIZEOF tempBuf, NULL<br />		invoke MessageBox, 0, offset tempBuf, $CTA0(&quot;CreateFileMapping Error&quot;), 0<br />	.ELSE<br />		mov hMemoryMap, eax<br />		invoke MapViewOfFile, hMemoryMap, FILE_MAP_WRITE, 0, 0, 0 ; map whole thing into the view window, starting at 0<br />		.IF eax!= NULL<br />			mov pIncomingMessageMapView, eax<br />			invoke MessageBox, 0, $CTA0(&quot;map successful&quot;), 0, 0<br />		.ELSE<br />			invoke GetLastError<br />			invoke FormatMessage, FORMAT_MESSAGE_FROM_SYSTEM+FORMAT_MESSAGE_MAX_WIDTH_MASK, \<br />				NULL, eax, NULL, offset tempBuf, SIZEOF tempBuf, NULL<br />			invoke MessageBox, 0, offset tempBuf, $CTA0(&quot;cant map view of file&quot;), 0<br />		.ENDIF<br />		.ENDIF<br />	invoke UnmapViewOfFile, pIncomingMessageMapView<br />	invoke CloseHandle, hMemoryMap<br />invoke ExitProcess, 0<br />end start</code></pre></div>
    <div class="meta">Posted on 2005-07-11 12:31:33 by jackal651</div>
   </div>
   <div class="post" id="post-161957">
    <div class="subject"><a href="#post-161957">Re: memory mapping as IPC</a></div>
    <div class="body">How weird :-s</div>
    <div class="meta">Posted on 2005-07-11 12:40:40 by f0dder</div>
   </div>
  </div>
 </body>
</html>