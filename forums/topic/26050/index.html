<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>ACM/TruSpeech query - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=26050" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=12">The Heap</a> &raquo; <a href="../?id=26050">ACM/TruSpeech query</a></p>
   <div class="post" id="post-189775">
    <div class="subject"><a href="#post-189775">ACM/TruSpeech query</a></div>
    <div class="body"><br />I have a problem regarding conversion of PCM wav audio-&gt;TruSpeech-&gt;PCM.<br /><br />Compression doesn&#39;t appear to be a problem - its the decompression.<br />The decompressed size is less than the original uncompressed size, and curiously, the number of bytes that are missing is exactly equal to whatever the Compressed size was.<br /><br />I expected that if I compressed 4kb, and then decompressed it, I would have 4kb.<br />Note that I am working with buffers of fixed size, and that I have experimented with the Flags.<br /><br />Backtracking the problem, I found that when I used acmStreamSize to suggest buffer sizes for both the compression and decompression streams, I saw the same thing.<br />If I asked what size Compressed buffer should be for input of 4kb, I am told 256 bytes, and if I ask what size Decompressed buffer should be for 256 bytes, I am told (4kb - 256) bytes.<br /><br />Can someone please kick some sense into me, and/or verify this issue?<br />I&#39;d be happy to provide more information such as the format specifications etc.<br /><br /></div>
    <div class="meta">Posted on 2007-07-08 08:13:13 by Homer</div>
   </div>
   <div class="post" id="post-189776">
    <div class="subject"><a href="#post-189776">Re: ACM/TruSpeech query</a></div>
    <div class="body">Tried compress-&gt;decompress and comparing source and decompressed wave files in an audio editor? Or are things *way* off so this doesn&#39;t even make sense?<br /></div>
    <div class="meta">Posted on 2007-07-08 11:56:14 by f0dder</div>
   </div>
   <div class="post" id="post-189778">
    <div class="subject"><a href="#post-189778">Re: ACM/TruSpeech query</a></div>
    <div class="body">No I have not, I am not aware of any audio editor that allows me to select arbitrary audio codecs.<br />There&#39;s plenty of tools that perform conversions with specific codecs, such as wav-mp3-wav converters, sure enough.. but one that enumerates all installed codecs and their format specs?<br />If you can suggest such a tool, I&#39;ll give it a go, out of sheer curiosity.<br /><br /></div>
    <div class="meta">Posted on 2007-07-09 05:24:11 by Homer</div>
   </div>
   <div class="post" id="post-189779">
    <div class="subject"><a href="#post-189779">Re: ACM/TruSpeech query</a></div>
    <div class="body">GoldWave<br /><br />acmFormatChoose helps... <br /><br />Why not talk in terms of &quot;samples&quot; for the PCM ?<br />Compare the original and resulting PCM (compressed then decompressed) - to see if there&#39;s a delay of 128 samples. </div>
    <div class="meta">Posted on 2007-07-09 08:22:17 by Ultrano</div>
   </div>
   <div class="post" id="post-189808">
    <div class="subject"><a href="#post-189808">Re: ACM/TruSpeech query</a></div>
    <div class="body">I did not try &#39;GoldWave&#39; yet.<br />But I did try acmChooseFormat, and verified that my PCM wave format was legit, and was supported natively by my audio hardware.<br />Debugging the returned WAVEFORMATEX fields, I noticed that this API forgets to set the cbStruct field, which I found amusing.<br /><br />Anyway, I&#39;m no closer to an answer, I am recording / playing audio as PCM 16 bit, 8khz, and wish to convert (compress) it under TruSpeech single-bit format.<br />My code contained a hardcoded version of the PCM format, and obtained a suitable TruSpeech format via enumeration.. both these formats are used together in various sourcecodes other than my own, and their fields all look ok to me, so in theory I could have hardcoded both wav format structs.<br /><br />Note that I&#39;m using DirectSound to perform the capture and playback, in order to benefit from its Buffer Notification system.<br /><br />What seems most odd to me right now is what I said about acmStreamSize.<br />I said that the suggested sizes of the buffers for input and output of the two conversion streams differ.<br />The fact that they differ by the size of one truespeech compressed frame may be a coincidence.<br /><br />This is driving me crazy.<br />Would you like to see the wav formats being used to create the two conversion streams?<br /></div>
    <div class="meta">Posted on 2007-07-12 01:26:00 by Homer</div>
   </div>
   <div class="post" id="post-189822">
    <div class="subject"><a href="#post-189822">Re: ACM/TruSpeech query</a></div>
    <div class="body">Guys, I threw together a simple demo to prove my point.<br />Given a hardcoded pcm wave format, this demo pokes around for an appropriate TrueSpeech format, then fires up two streams for conversion to and from TrueSpeech, and then queries for appropriate buffer sizes, and finally reports the sizes for raw input frame, compressed frame, and decompressed frame.<br />You can clearly see that there&#39;s an issue.<br />Please feel free to slap me, if you can see what&#39;s wrong here, as this code is quite similar to what I&#39;m using, I&#39;ve only &#39;de-oopified&#39; since a lotta you guys don&#39;t like looking at such code..<br /><br />If you can spot any issues, please tell me !!!<br /><pre><code><br /><br />.486<br />.model flat, stdcall<br />option casemap:none<br /><br />include c:\masm32\include\windows.inc<br />include c:\masm32\include\kernel32.inc<br />include c:\masm32\include\user32.inc<br />include c:\masm32\include\ACM.inc<br />include c:\masm32\include\winmm.inc<br />includelib c:\masm32\lib\kernel32.lib<br />includelib c:\masm32\lib\user32.lib<br />includelib c:\masm32\lib\msacm32.lib<br />ACM_DRIVERENUMF_DISABLED equ 080000000h<br />WAVE_FORMAT_UNKNOWN	equ 00h<br /><br /><br />m2m macro dst,src<br />push src<br />pop dst<br />endm<br /><br />.data<br />OurHadId dd 0<br />OurHad	 dd 0<br />hCompressor&nbsp;  dd 0<br />hDecompressor dd 0<br />RawFormat 		WAVEFORMATEX &lt;&gt;<br />VendorExtensionR db 32 dup (?)<br />CompressedFmt	WAVEFORMATEX &lt;&gt;<br />VendorExtensionW db 32 dup (?)<br /><br />szerr db &quot;ERROR&quot;,0<br />szok db &quot;OK&quot;,0<br />szerr1 db &quot;Failed to find appropriate driver and/or format&quot;,0<br />szerr2 db &quot;Failed to Open a Driver during enum&quot;,0<br />szlu db &quot;Input 4000 - Packed %lu - Unpacked %lu&quot;,0<br /><br />.code<br />FormatEnumProc proc hadid, pafd:ptr ACMFORMATDETAILS,&nbsp; dwTagWeWant,&nbsp; fdwSupport<br />	.if dwTagWeWant!=0<br />		mov ebx,pafd<br />		mov eax,.ACMFORMATDETAILS.dwFormatTag<br />		.if eax==dwTagWeWant<br />			;Note the format handle<br />			m2m OurHadId ,hadid<br />			mov eax, FALSE&nbsp; ;&nbsp;  stop enumerating now<br />		.endif<br />	.else<br />		mov eax,TRUE		 ;&nbsp; Continue enumerating.<br />	.endif<br />&nbsp; &nbsp; ret<br />FormatEnumProc endp<br /><br />DriverEnumProc proc hadid, dwTagWeWant, fdwSupport<br />LOCAL fd:ACMFORMATDETAILS<br />LOCAL had, dwVendor<br />&nbsp;  ; Open the driver.<br />&nbsp; &nbsp; invoke acmDriverOpen,addr had, hadid, 0<br />&nbsp; &nbsp; .if eax!=0<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke MessageBox,0,addr szerr,addr szerr2,MB_OK+MB_ICONERROR<br />&nbsp; &nbsp; .else<br />&nbsp; &nbsp; &nbsp; &nbsp; mov dwVendor,0<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke acmMetrics,had, ACM_METRIC_MAX_SIZE_FORMAT, addr dwVendor<br />&nbsp; &nbsp; &nbsp; &nbsp; .if dwVendor &lt; sizeof(WAVEFORMATEX) <br />&nbsp; &nbsp; &nbsp; &nbsp; 	mov dwVendor , sizeof(WAVEFORMATEX)	;&nbsp; for MS-PCM<br />&nbsp; &nbsp; &nbsp; &nbsp; .endif&nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; invoke RtlZeroMemory,addr fd,sizeof fd<br />&nbsp; &nbsp; &nbsp; &nbsp; mov fd.cbStruct , sizeof fd<br />&nbsp; &nbsp; &nbsp; &nbsp; mov fd.pwfx , 	&nbsp; offset CompressedFmt<br />&nbsp; &nbsp; &nbsp; &nbsp; m2m fd.cbwfx , 		dwVendor<br />&nbsp; &nbsp; &nbsp; &nbsp; mov fd.dwFormatTag , WAVE_FORMAT_PCM<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke acmFormatEnum,had, addr fd, FormatEnumProc, dwTagWeWant, 0<br />&nbsp;  	&nbsp; .if eax!=0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  invoke MessageBox,0,addr szerr,addr szerr,MB_OK+MB_ICONERROR<br />	&nbsp;  .endif<br />&nbsp; &nbsp; &nbsp; &nbsp; invoke acmDriverClose,had, 0<br />&nbsp; &nbsp; .endif<br />&nbsp; &nbsp; .if OurHadId!=0<br />&nbsp; &nbsp; 	&nbsp; mov eax, FALSE ;stop enumerating now<br />&nbsp; &nbsp; .else<br />&nbsp; &nbsp; &nbsp;  mov eax,TRUE ; Continue enumeration.<br />&nbsp; &nbsp; .endif<br />&nbsp; &nbsp; ret <br />DriverEnumProc endp&nbsp;  <br /><br /><br />SetupStreams proc<br />LOCAL dPacked,dUnpacked<br />local buf[256]:BYTE<br />	;In this simplified demo, I have hardcoded my desired pcm wave format<br />	mov RawFormat.cbSize,0<br />	mov RawFormat.wFormatTag,WAVE_FORMAT_PCM	;Pulse-Coded Modulation<br />	mov RawFormat.nChannels,1					;mono, cuz stereo costs too much<br />	mov RawFormat.nSamplesPerSec,8000			;8 kilohertz sample rate<br />	mov RawFormat.wBitsPerSample,16				;* 16 bits per sample<br />	mov RawFormat.nBlockAlign,2					;#chans	* bitspersample / 8<br />	mov RawFormat.nAvgBytesPerSec,16000			;samplesperSec * blockalign&nbsp; &nbsp; <br />	<br />	;This is what the TrueSpeech compressed format WILL look like<br />;	mov CompressedFmt.wFormatTag , 34<br />;	mov CompressedFmt.nChannels , 1<br />;	mov CompressedFmt.nSamplesPerSec , 8000<br />;	mov CompressedFmt.nAvgBytesPerSec , 1067<br />;	mov CompressedFmt.nBlockAlign , 32<br />;	mov CompressedFmt.wBitsPerSample , 1<br />;	mov CompressedFmt.cbSize , 32<br />	<br />	invoke acmDriverEnum,addr DriverEnumProc, 34, 0<br />	.if eax!=0 || OurHadId==0<br />&nbsp; &nbsp; &nbsp; &nbsp;  invoke MessageBox,0,addr szerr1,addr szerr,MB_OK+MB_ICONERROR<br />&nbsp; &nbsp; &nbsp; .else<br />	&nbsp; &nbsp; mov OurHad,0<br />	&nbsp; &nbsp; invoke acmDriverOpen,addr OurHad, OurHadId, 0<br />	&nbsp; &nbsp; .if eax!=0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  invoke MessageBox,0,addr szerr,addr szerr,MB_OK+MB_ICONERROR<br />	&nbsp; &nbsp; .else<br />			; Open the Compression stream..	&nbsp; &nbsp; <br />		&nbsp; &nbsp; invoke acmStreamOpen,addr hCompressor,\<br />		&nbsp; &nbsp; 				&nbsp; &nbsp; OurHad,\			; Driver handle<br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr RawFormat,\	; Source format<br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr CompressedFmt,\; Destination format<br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NULL,\ 				; No filter<br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NULL,\				; No callback<br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0,\					; Instance data (not used)<br />		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACM_STREAMOPENF_NONREALTIME;&nbsp; Flags&nbsp; 	&nbsp; <br />		&nbsp; &nbsp; .if eax==0<br />				; Open the Decompression stream..<br />			&nbsp; &nbsp; invoke acmStreamOpen,addr hDecompressor,\<br />			&nbsp; &nbsp; 				&nbsp; &nbsp; OurHad,\			; Driver handle<br />			&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr CompressedFmt,\; Source format<br />			&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr RawFormat,\	; Destination format<br />			&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NULL,\ 				; No filter<br />			&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NULL,\				; No callback<br />			&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0,\					; Instance data (not used)<br />			&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACM_STREAMOPENF_NONREALTIME;&nbsp; Flags&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />			&nbsp; &nbsp; .if eax==0	<br />			&nbsp; &nbsp; 	invoke acmStreamSize,hCompressor,4000,addr dPacked,ACM_STREAMSIZEF_SOURCE<br />			&nbsp; &nbsp; 	.if eax==0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;The commented line is an alternative , its returning the same value anyhoo<br />&nbsp; &nbsp; 			&nbsp; &nbsp; 	&nbsp; &nbsp; ;invoke acmStreamSize,hDecompressor,dPacked,addr dUnpacked,ACM_STREAMSIZEF_SOURCE<br />			&nbsp; &nbsp; 	&nbsp; &nbsp; invoke acmStreamSize,hCompressor,dPacked,addr dUnpacked,ACM_STREAMSIZEF_DESTINATION		&nbsp; &nbsp; 	<br />			&nbsp; &nbsp; 	&nbsp; &nbsp; .if eax==0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke wsprintf,addr buf,addr szlu,dPacked,dUnpacked<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke MessageBox,0,addr buf,addr szok,MB_OK+MB_ICONERROR<br />			&nbsp; &nbsp; 	&nbsp; &nbsp; .endif	&nbsp; <br />			&nbsp; &nbsp; 	&nbsp; &nbsp; invoke acmStreamClose,hDecompressor,0			&nbsp; &nbsp; 	 <br />		&nbsp; &nbsp; &nbsp; &nbsp;  .endif<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .endif<br />		&nbsp; &nbsp; 	invoke acmStreamClose,hCompressor,0		&nbsp; &nbsp; 		<br />		&nbsp; &nbsp; .endif <br />		&nbsp; &nbsp; invoke acmDriverClose,OurHad,0<br />		.endif<br />	.endif<br />&nbsp;  	ret<br />SetupStreams endp<br /><br />start:	call SetupStreams<br />		invoke ExitProcess,0<br /><br />end start<br /></code></pre><br /></div>
    <div class="meta">Posted on 2007-07-14 02:09:29 by Homer</div>
   </div>
   <div class="post" id="post-189823">
    <div class="subject"><a href="#post-189823">Re: ACM/TruSpeech query</a></div>
    <div class="body">Maybe there is something wrong with my setup (I just installed MASM32 v9 to compile your code), but:<br /><br /><span class="mono">fatal error A1000: cannot open file : c:\masm32\include\ACM.inc</span><br /><br />What happens if you replace<br /><br /><pre><code>invoke acmStreamSize,hCompressor,4000,addr dPacked,ACM_STREAMSIZEF_SOURCE</code></pre><br />by<br /><pre><code>invoke acmStreamSize,hCompressor,4096,addr dPacked,ACM_STREAMSIZEF_SOURCE</code></pre><br />?</div>
    <div class="meta">Posted on 2007-07-14 04:14:29 by Frank</div>
   </div>
   <div class="post" id="post-189826">
    <div class="subject"><a href="#post-189826">Re: ACM/TruSpeech query</a></div>
    <div class="body">Whatever size frame you specify is not relevant, the output frame is smaller than the input frame, thats the point.<br /><br />I can understand that one page is a neater value, I chose 4000 because its an even segment of a 16000 byte buffer, the pcm wave format I&#39;m using is 8000 samples per second, at 16 bits (two bytes per sample), giving 16000 bytes per second, so 4000 is one quarter of my one second buffer, thats why I used that, but its not important, this demo has no actual buffers, I am only showing that the codec is suggesting that the output buffer for decompressed data is smaller than the input buffer for uncompressed data, and this is in terms of pcm wave data, where size is critical to the rate it plays at, so you&#39;re effectively losing data, losing time... this is not acceptable , it seems quite odd to me, I can understand a loss of QUALITY but not of QUANTITY...<br /></div>
    <div class="meta">Posted on 2007-07-14 14:51:15 by Homer</div>
   </div>
  </div>
 </body>
</html>