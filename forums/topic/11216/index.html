<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>General SEH - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=11216" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=11216">General SEH</a></p>
   <div class="post" id="post-84549">
    <div class="subject"><a href="#post-84549">General SEH</a></div>
    <div class="body">I am trying to make a simple handler and this is my code. If excution can be continued, after calling user defined cleanup procedure I try to resume execution by restoring ebp, esp and setting new offset but it doesn't seam to work.<br /><br />What is wrong with this code:<br /><br /><pre><code><br />SEHFinalHandler	PROC ExceptionPointers	&#58;DWORD<br />	call lpUserFinalHandler<br />	test eax, eax<br />	jz @F<br />		mov eax, ExceptionPointers<br />		mov eax, &#91;eax&#93;.EXCEPTION_POINTERS.pExceptionRecord<br />		mov eax, &#91;eax&#93;.EXCEPTION_RECORD.ExceptionFlags<br />		test eax, eax<br />		jnz @F<br />			mov eax, ExceptionPointers<br />			mov eax, &#91;eax&#93;.EXCEPTION_POINTERS.ContextRecord<br />			mov ecx, SEHSavedData._ebp<br />			mov &#91;eax+0B4h&#93;, ecx<br />			mov ecx, SEHSavedData._esp<br />			mov &#91;eax+0C4h&#93;, ecx<br />			mov ecx, SEHSavedData._offset<br />			mov &#91;eax+0D8h&#93;, ecx<br />			xor eax, eax<br />			dec eax<br />			ret<br />	@@&#58;<br />	invoke MessageBox, NULL, offset szExceptionAutoGeneratedErrorMessage, NULL, MB_ICONEXCLAMATION or MB_SYSTEMMODAL<br />	xor eax, eax<br />	inc eax<br />	ret<br /><br />SEHFinalHandler	ENDP<br /></code></pre></div>
    <div class="meta">Posted on 2003-03-02 16:00:23 by Milos</div>
   </div>
   <div class="post" id="post-84724">
    <div class="subject"><a href="#post-84724">General SEH</a></div>
    <div class="body">Hello guys, wake up :) I know some SEH discussions have been made here before but I can't find anything relevant to what I'm trying to achieve. Well actually I'm posting just to bring the question back on the top of the stack :alright:</div>
    <div class="meta">Posted on 2003-03-03 11:44:38 by Milos</div>
   </div>
   <div class="post" id="post-84784">
    <div class="subject"><a href="#post-84784">Re: General SEH</a></div>
    <div class="body"><div class="quote"><br /><pre><code><br />mov ecx, SEHSavedData._offset<br />mov &#91;eax+0D8h&#93;, ecx<br /></code></pre> </div><br /><br />CONTEXT.regEip is at <strong>B8h</strong>, not <strong>D8h</strong>.</div>
    <div class="meta">Posted on 2003-03-03 16:29:01 by comrade</div>
   </div>
   <div class="post" id="post-84802">
    <div class="subject"><a href="#post-84802">General SEH</a></div>
    <div class="body">Spasiba prijatelu :) <br /><br />Works like a charm now!</div>
    <div class="meta">Posted on 2003-03-03 16:49:29 by Milos</div>
   </div>
  </div>
 </body>
</html>