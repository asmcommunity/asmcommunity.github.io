<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Calling macro from thread - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=950" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=950">Calling macro from thread</a></p>
   <div class="post" id="post-6158">
    <div class="subject"><a href="#post-6158">Calling macro from thread</a></div>
    <div class="body">fOdder has just given me some advice about using global variables in a thread........&quot;not a good idea&quot;<br /><br />So i was wondering if it is a bad idea to call a macro from a thread that also uses Global Variables.<br /><br />The problem i have is i want to let a bitmap scroll across the top of my window several times by a call to a thread.<br /><br />Here is the code for my thread...i'm a newbie so feel free to critisize it to death but give me some suggestions also if you have any. All variables not defined local are global.<br />___________________________________________________<br /><br /> ThreadProc PROC USES ebx Param:DWORD<br /><br />LOCAL var3:DWORD,var2:DWORD,var1:DWORD<br /><br />    mov var3, 0<br />invoke LoadBitmap,hInstance,35<br />mov hBitmap,eax<br />invoke SelectObject,cdc,hBitmap<br />mov obitmap,eax<br />    .while var3 &lt; 10     ;loop ten times<br /><br />      mov var1, 0<br />      .while var1 &lt; 290 ;&lt;&lt;  Bitmap width<br />        invoke BitBlt,hdc,XPOS,YPOS,BMW,BMH,cdc,var1,0,SRCCOPY<br />        invoke GetTickCount<br />        mov var2, eax<br />        add var2, 5    ; delay<br /><br />        .while eax &lt; var2<br />          invoke GetTickCount<br />        .endw<br /><br />        add var1,3<br />      .endw<br /><br />    inc var3<br />    .endw <br />        <br />ret 0<br />ThreadProc END</div>
    <div class="meta">Posted on 2001-09-04 15:33:45 by titan</div>
   </div>
   <div class="post" id="post-6161">
    <div class="subject"><a href="#post-6161">Well</a></div>
    <div class="body">Threads should not end...<br />unless a global variable tolds them to do so<br /><br />1.Threads are first setup<br />2.Threads are started<br />3.Eventually threads are stopped (terminated)<br /><br />The ThreadProc is a CALLBack kind of...windows will call it whenever it likes and Windows will get you out from it anywhere it so likes (i mean at any code line) ...so general CallBack register preservations apply here  but you must take a lot of other precautions<br /><br />You can use any global variables in a thread but you get into problems when the same variables are used by another thread for read/write. If you use only one atomic opeartion to read/write them then its safe<br /><br />And your main win32 application is another thread ;)<br /><br />So RET at the end is useless, you should jump back to the start<br />I am also unsure if the local variables are usefully to something as they just unbalance the threads stack ;)<br /><br /><br />Here is an example from our simple MOUSE THREAD (you dont want to see the complicated PAINT THREAD  ;) )<br /><br />sorry but TASM style<br /><br /><pre><code><br />;*******************************************<br />;	THREAD FLIP OPERATIONS<br />;<br />;	This is done for only one reason&#58;<br />;	-faster/constant mouse redraw even if poor<br />;	render speed<br />;*******************************************<br /><br /><br />.data<br />	ALIGN	4<br />;<br />	lp_thread_id		dd	0<br />	thread_handle		dd	0<br />	thread_counter		dd	0<br />.code<br /><br /><br />Thread_Flip_Setup&#58;<br /><br />	mov	eax,offset lp_thread_id<br />	push	eax<br /><br />	mov	eax,0		;creation flags<br />	push	eax		<br /><br />	mov	eax,0		;lparam<br />	push	eax		<br /><br />	mov	eax,offset Thread_Flip_CallBack<br />	push	eax<br /><br />	mov	eax,0		;stack size<br />	push	eax<br /><br />	mov	eax,0		;security attributes<br />	push	eax		; i wonder if this is ok for Win2K ?<br /><br />	call	CreateThread<br /><br />	mov	&#91;thread_handle&#93;,eax<br /><br />;==========================================<br />;	set priority level<br />;	this will be realtime but it will sleep a lot<br />;	after its job is done<br />;==========================================<br />	call	SetThreadPriority,&#91;thread_handle&#93;,THREAD_BASE_PRIORITY_MAX<br /><br />ret<br /><br /><br /><br /><br /><br /><br />;*********************************************<br />;	THREAD CALLBACK<br />;*********************************************<br />.data<br />	ALIGN	4<br />;<br />	thread_can_flip		dd	0<br />	thread_dies_now		dd	0<br />.code<br /><br />ALIGN 4<br /><br />Thread_Flip_CallBack proc uses ecx , param01&#58;DWORD<br /><br />loop_thread&#58;<br />	mov	eax,offset csection_flip<br />	push	eax<br />	Call	EnterCriticalSection<br /><br />	mov	eax,&#91;thread_dies_now&#93;<br />	cmp	eax,0<br />	jz	thread_goes_on<br /><br />	xor	eax,eax<br />	ret<br /><br /><br />thread_goes_on&#58;<br /><br />	mov	eax,&#91;thread_can_flip&#93;<br />	cmp	eax,0<br />	jz	thread_flip_sleep<br /><br />;=======================================<br />; Our Only actions on this thread are here<br />;=======================================<br /><br />;==========================================<br />; read the mouse and cache values for latter read<br />; this is also esential for the Thread_paint<br />;==========================================<br />	call	Read_Mouse_Flip<br /><br />	call	paint_back_video_to_back<br /><br />	call	paint_mouse<br /><br />	call 	FlipBuffers		; flip back/primary surfaces<br /><br /><br /><br />thread_flip_sleep&#58;<br /><br />;===========================================<br />; prepare to sleep but <br />; first end critical section<br />;===========================================<br />	mov	eax,offset csection_flip<br />	push	eax<br />	Call	LeaveCriticalSection<br /><br />;=========================================<br />; this regulates the mouse speed<br />; mouse will go better / game slower if smaller then 35 ?<br />;=========================================<br /><br />;	mov eax,16<br />;	mov eax,25<br />	mov eax,16<br /><br />	call Sleep,eax<br />;=========================================<br /><br />	jmp	loop_thread<br /><br />;------------------------------<br />; we never reach here<br />;------------------------------<br />	ret<br />Thread_Flip_CallBack endp<br /><br /></code></pre></div>
    <div class="meta">Posted on 2001-09-04 16:01:00 by BogdanOntanu</div>
   </div>
  </div>
 </body>
</html>