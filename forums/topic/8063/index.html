<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Console Program only crashes - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=8063" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=8063">Console Program only crashes</a></p>
   <div class="post" id="post-59025">
    <div class="subject"><a href="#post-59025">Console Program only crashes</a></div>
    <div class="body">Why does this pice of code crash?<br />When I try to call anything (a procedure for instance :tounge: ) it crashes (it may bee Main, ExitProcess or any other same crash), I have to have those dword in front of the calls else FASM makes a fuss (don'y know why :( ).<br /><br /><pre><code><br />; Win32 console program<br />format PE console<br />entry start<br />use32<br /><br />include '\fasm\include\kernel.inc'<br /><br />section '.code' code readable executable<br />start&#58;<br />	call	dword &#91;Main&#93;<br /><br />	push	dword 0<br />	call	&#91;ExitProcess&#93;<br />; ########################################<br /><br />Main&#58;<br />	push	ebp<br />	mov	ebp, esp<br />	sub	esp, 2+4<br /><br />	push	STD_OUTPUT_HANDLE<br />	call	&#91;GetStdHandle&#93;<br />	mov	&#91;hStdOut&#93;, eax<br /><br />	push	STD_INPUT_HANDLE<br />	call	&#91;GetStdHandle&#93;<br />	mov	&#91;hStdIn&#93;, eax<br /><br />	mov	edx, 32<br />	xor	ebx,ebx<br />	push	edx<br />	push	ebx<br />	push	ebx	; 0,0<br />	call	dword &#91;ClearScreenEx&#93;<br /><br />	mov	esp, ebp<br />	pop	ebp<br />	retn<br />;Main endp<br />;-----------------------------------------------------------<br />ClearScreenEx&#58;<br />	push	ebp<br />	mov	ebp, esp<br />	sub	esp, 12<br /><br />	; some for now irrelevant code is here, thus cut out...<br /><br />	mov	esp, ebp<br />	pop	ebp<br />	retn<br />;ClearScreenEx endp<br />;-----------------------------------------------------------------------<br />StdOut&#58;	;proc lpszText&#58;DWORD<br />	push	ebp<br />	mov	ebp, esp<br />	sub	esp, 12<br /><br />	; some for now irrelevant code is here, thus cut out...<br /><br />	mov	esp, ebp<br />	pop	ebp<br />	ret<br />;StdOut endp<br /><br /><br />	crlf	equ	13,10<br />section '.data' data readable writeable<br />	; .data section<br />	szMMXTT	 	db &quot;&lt;TEXT&gt;&quot;,crlf,0<br />s_szMMXTT = &#40;$+1&#41;-szMMXTT<br />	szPureAsm		db &quot;-=&#91;&lt;TEXT&gt;&#93;=-&quot;,crlf,0<br /><br />	Msg1		db &quot;&lt;TEXT&gt; &quot;,0<br />	Msg2		db &quot;&lt;EVEN MORE TEXT&gt;&quot;,0<br /><br />	szMMXs		db &quot;&lt;TEXT&gt;&quot;,0<br />	szMMXns		db &quot;&lt;TEXT&gt;,0<br /><br />section '.bss' readable writeable<br />	; .data? section<br />	hStdOut		rd	1<br />	hStdIn		rd	1<br /><br />	sTick		rd	1<br />	STick		rd	1<br /><br />	databuf		rb	256	; 256 byte<br />	InputBuffer	rb	128	; 128 byte<br /><br />	dummyDD		rd	1<br /><br />macro library &#91;label,string&#93;<br /> &#123; forward<br />    local _label<br />    dd 0,0,0,RVA _label,RVA label<br />   common<br />    dd 0,0,0,0,0<br />   forward<br />    _label db string,0 &#125;<br /><br />macro import &#91;label,string&#93;<br /> &#123; forward<br />    local _label<br />    label dd RVA _label<br />   common<br />    dd 0<br />   forward<br />    _label dw 0<br />	   db string,0 &#125;<br /><br /><br />section '.idata' import data readable writeable<br />	; import section<br />	library	kernel,	'KERNEL32.DLL' ;,\<br /><br />kernel&#58;<br />	import	ExitProcess, 'ExitProcess',\<br />	    	FillConsoleOutputCharacter, 'FillConsoleOutputCharacterA',\<br />		GetConsoleScreenBufferInfo, 'GetConsoleScreenBufferInfo',\<br />		GetModuleHandle, 'GetModuleHandleA',\<br />		GetStdHandle, 'GetStdHandle',\<br />		SetConsoleCursorPosition, 'SetConsoleCursorPosition',\<br />		Sleep, 'Sleep',\<br />		WriteFile, 'WriteFile'<br /><br />section '.reloc' fixups data readable discardable</code></pre></div>
    <div class="meta">Posted on 2002-09-21 13:32:15 by scientica</div>
   </div>
   <div class="post" id="post-59089">
    <div class="subject"><a href="#post-59089">Console Program only crashes</a></div>
    <div class="body">Change<pre><code>   call  dword &#91;Main&#93;</code></pre><br />to call Main<br />and <pre><code>call  dword &#91;ClearScreenEx&#93;</code></pre><br />to call ClearScreenEx<br /><br /><br />Finally,<br /><br />Use the provided <strong>stdcall</strong> and <strong>invoke</strong> macros.  Their is a difference.<br /><br />p.s. Download OllyDbg</div>
    <div class="meta">Posted on 2002-09-22 04:02:18 by eet_1024</div>
   </div>
   <div class="post" id="post-59128">
    <div class="subject"><a href="#post-59128">Console Program only crashes</a></div>
    <div class="body">Ok, I've downloaded OllyDbg.<br /><br />&quot;Wow! I never knew you could use a debugger&quot;, well the truth is, the last time I tried to use an debugger was in the long-time-ago-C++-programming-time and that did scare me off (the debugger only showed an very uggly pice of disassembly of my exe, never HLL again, never ever... :) ).<br />Any way, I've located the source of the error:<br /><br /><pre><code><br />&#91;COLOR=darkblue&#93;<br />format PE GUI<br />entry start<br />use32<br /><br />include '\fasm\include\kernel.inc'<br />include '\fasm\include\macro\stdcall.inc'<br /><br />section '.code' code readable executable&#91;/COLOR&#93; <br />start&#58;<br />	invoke	GetModuleHandle, NULL<br />	mov	&#91;hInstance&#93;, eax<br /><br />	invoke	GetCommandLine<br />	mov	&#91;lpszCommandline&#93;,eax<br /><br />	invoke	AllocConsole	&#91;COLOR=green&#93;; get the app a console window&#91;/COLOR&#93; <br /><br />	invoke 	GetStdHandle,STD_OUTPUT_HANDLE<br />	mov	&#91;hStdOut&#93;, eax<br />	invoke	GetStdHandle,STD_INPUT_HANDLE<br />	mov	&#91;hStdIn&#93;, eax<br />	invoke	GetStdHandle,STD_ERROR_HANDLE<br />	mov	&#91;hStdErr&#93;, eax<br /><br />	invoke	SetConsoleTitle, szPTA<br /><br />	call	Main<br /><br />	invoke	FreeConsole		&#91;COLOR=green&#93;; Destroy the console&#91;/COLOR&#93;<br />	invoke	ExitProcess,0<br />&#91;COLOR=green&#93;; ###################################&#91;/COLOR&#93;<br />Main&#58;<br />	push	ebp<br />	mov	ebp, esp<br />	sub	esp, 2+4<br /><br />	mov	edx, 32<br />	xor	ebx,ebx<br />	push	edx<br />	push	ebx<br />	push	ebx	&#91;COLOR=green&#93;; 0,0&#91;/COLOR&#93;<br />	call	ClearScreenEx<br /><br />mov	esp, ebp<br />pop	ebp<br />retn<br /><br />&#91;COLOR=green&#93;;---------------------------------------------------------------------------------------------&#91;/COLOR&#93;<br />ClearScreenEx&#58;<br />	push	ebp<br />	mov	ebp, esp<br />	sub	esp, 12<br /><br />	char	equ DWORD &#91;ebp+16&#93;<br />	endPos	equ DWORD &#91;ebp+12&#93;<br />	startPos	equ DWORD &#91;ebp+8&#93;<br />		sbi_dwSize			equ DWORD &#91;ebp-30&#93;	&#91;COLOR=green&#93;;sbi.dwSize			COORD &#40;dd&#41;&#91;/COLOR&#93;<br />			sbi_dwSize_X		equ WORD &#91;ebp-30&#93;<br />			sbi_dwSize_Y		equ WORD &#91;ebp-28&#93;<br />		sbi_dwCursorPosition		equ DWORD &#91;ebp-26&#93;	&#91;COLOR=green&#93;;sbi.dwCursorPosition	COORD &#40;dd&#41;&#91;/COLOR&#93;<br />			sbi_dwCursorPosition_X	equ WORD &#91;ebp-26&#93;<br />			sbi_dwCursorPosition_Y	equ WORD &#91;ebp-24&#93;<br />		sbi_wAttributes			equ DWORD &#91;ebp-22&#93;	&#91;COLOR=green&#93;;sbi.wAttributes		WORD	&#40;dw&#41;&#91;/COLOR&#93;<br />		sbi_srWindow			equ DWORD &#91;ebp-20&#93;	&#91;COLOR=green&#93;;sbi.srWindow			SMALL_RECT &#40;4*dw&#41;&#91;/COLOR&#93;<br />			sbi_srWindow_Left	equ WORD &#91;ebp-20&#93;<br />			sbi_srWindow_Top	equ WORD &#91;ebp-18&#93;<br />			sbi_srWindow_Right	equ WORD &#91;ebp-16&#93;<br />			sbi_srWindow_Bottom	equ WORD &#91;ebp-14&#93;<br />		sbi_dwMaximumWindowSize	equ DWORD &#91;ebp-12&#93;	&#91;COLOR=green&#93;;sbi.dwMaximumWindowSize	COORD &#40;dd&#41;&#91;/COLOR&#93;<br />	CharsOnScreen	equ DWORD &#91;ebp-8&#93;<br />	noc			equ DWORD &#91;ebp-4&#93;<br /><br />	lea	esi, &#91;ebp-30&#93;<br />	mov	edi, &#91;hStdOut&#93;<br />	invoke	GetConsoleScreenBufferInfo, edi, esi	&#91;COLOR=red&#93;; this is the Crash point, the return value is ERROR_NOACCESS&#91;/COLOR&#93; <br />... &#91;COLOR=green&#93;; I haven't forgotten the ret &#40;nor forgotten balance the plate pile&#41;...&#91;/COLOR&#93;<br /></code></pre> <br /><br />Why? Doesn't my hStdOut have GENERIC_READ access? (Or have I made something wrong with the the locals?)</div>
    <div class="meta">Posted on 2002-09-22 09:25:37 by scientica</div>
   </div>
   <div class="post" id="post-59166">
    <div class="subject"><a href="#post-59166">Console Program only crashes</a></div>
    <div class="body">A few more suggestions.<br /><br />Since you're created a Win32 Console app, you don't have to call AllocConsole<br /><br />The StdCall.inc file also has proc, enter, and return macros:<pre><code><br />proc MyFunc, Param1, Param2<br />.Local1   rd 1<br />.Local2   rd 1<br />enter<br />   mov      &#91;.Local1&#93;, 0x6789ABCD<br />   mov      eax, &#91;Param1&#93;<br />   invoke   SomeAPI, &#91;hStdOut&#93;, &#91;Param1&#93;, &#91;.Local1&#93;<br />return</code></pre><br />The Import.inc has the library, and import macros.<br /><br />By using the macros, you don't have to do the ebp calculations yourself, thereby preventing errors.</div>
    <div class="meta">Posted on 2002-09-22 17:33:42 by eet_1024</div>
   </div>
   <div class="post" id="post-59182">
    <div class="subject"><a href="#post-59182">Console Program only crashes</a></div>
    <div class="body">More tips/suggestions...<br /><br />1. <strong>format PE GUI</strong> should be <strong>format PE CONSOLE</strong> - not the same with the first post.<br />2. Register preservation <strong>ebx, esi, edi</strong> ???<br />3. with <strong>sub esp, 12</strong> you're allocating <strong>12 bytes</strong> on the stack but you are reading past the allocated memory with <strong>lea esi,  </strong>and writing past the allocated memory with the GetConsoleScreenBufferInfo API.<pre><code>typedef struct _CONSOLE_SCREEN_BUFFER_INFO &#123; <br />  COORD      dwSize; <br />  COORD      dwCursorPosition; <br />  WORD       wAttributes; <br />  SMALL_RECT srWindow; <br />  COORD      dwMaximumWindowSize; <br />&#125; CONSOLE_SCREEN_BUFFER_INFO ; </code></pre>COORD is DWORD size(2 words), SMALL_RECT is QUADWORD size(4 words)<br /><br />COORD + COORD + WORD +SMALL_RECT + COORD == x<br />4 + 4 + 2 + 8 + 4 = 22<br /><br />???<br /><br />try changing to sub esp, 22 and lea <em>reg32</em>, <br /><br />4. It would be nice to .zip the whole project and attached it, so we can see it ourselves but if it's big or confidential/private, don't bother. :)</div>
    <div class="meta">Posted on 2002-09-22 20:32:03 by stryker</div>
   </div>
   <div class="post" id="post-59276">
    <div class="subject"><a href="#post-59276">Console Program only crashes</a></div>
    <div class="body">Ok, now it doesn't crash. I'm far from an expert on the stack, thats why I'd like to avoid macros (since I don't know what I do then).<br />I did some changes and forgot to check if I allocated enough on the stack, thanks for pointing it out.<br />I tried to change &quot;format PE console&quot; to &quot;format PR GUI&quot;, and allocate the console and console window; I tried too much when I couldn't find out why I got &quot;ERROR_NOACCESS&quot; from GetConsoleScreenBufferInfo, after some more debuging with Olly, I somehow got a out of memory error; that must have been due to I only allocated 12 byte on the stack.<br /><br />Register preservation, well, I usually do this (I preserve all registers I use, exept from eax). But I just didn't push 'n' pop 'em, don't know why. :o<br /><br />Well, if I would post a zip file with the project. First I'd have top clear up the code (It's full of comments, and commented out code, and who knows what more). For the second, I don't know if I'll complete this project (or push it on to the stack of unfinished prjects). :)<br /><br />eet_1024, as I said previously, I'd like to avoid macros when I code in fasm. Since I want to learn what I'm doing and why, macros is something I might utilize when I have learnt what they do for me and why.<br /> Well there are exceptions, the import and library macros are for now a must. But some day I'll learn why I use them (in the deph, I know without them the PE will not be able to call teh APIs) and what they do (exactly), but now I'm focusing on learing to write windows apps in fasm.<br /><br />Now the final question for the stack-gurus:<br />Is this right, or have I reversed teh order of the structure mebers (It's supposed to be an CONSOLE_SCREEN_BUFFER_INFO struct on the stack)?<br /><pre><code><br />sub	esp, 22<br />sbi_dwSize			equ DWORD &#91;ebp-22&#93;	;COORD<br />	sbi_dwSize_X		equ WORD &#91;ebp-22&#93;<br />	sbi_dwSize_Y		equ WORD &#91;ebp-20&#93;<br />sbi_dwCursorPosition		equ DWORD &#91;ebp-18&#93;	;COORD<br />	sbi_dwCursorPosition_X	equ WORD &#91;ebp-18&#93;<br />	sbi_dwCursorPosition_Y	equ WORD &#91;ebp-16&#93;<br />sbi_wAttributes			equ DWORD &#91;ebp-14&#93;	;WORD<br />sbi_srWindow			equ DWORD &#91;ebp-12&#93;	;SMALL_RECT<br />	sbi_srWindow_Left	equ WORD &#91;ebp-12&#93;<br />	sbi_srWindow_Top	equ WORD &#91;ebp-10&#93;<br />	sbi_srWindow_Right	equ WORD &#91;ebp-8&#93;<br />	sbi_srWindow_Bottom	equ WORD &#91;ebp-6&#93;<br />sbi_dwMaximumWindowSize		equ DWORD &#91;ebp-4&#93;	;COORD<br /></code></pre></div>
    <div class="meta">Posted on 2002-09-23 11:17:12 by scientica</div>
   </div>
   <div class="post" id="post-59280">
    <div class="subject"><a href="#post-59280">Console Program only crashes</a></div>
    <div class="body">I am not a stack guru but I do know the answer. Yes, that is the correct order.</div>
    <div class="meta">Posted on 2002-09-23 11:50:47 by stryker</div>
   </div>
   <div class="post" id="post-59281">
    <div class="subject"><a href="#post-59281">Console Program only crashes</a></div>
    <div class="body">No, you're right it should be qword, since the sbi_srWindow is a RECT.<br />Yoppie! :) (my selfconfidece rises when I do something hard right, this is one such thing)</div>
    <div class="meta">Posted on 2002-09-23 12:07:18 by scientica</div>
   </div>
   <div class="post" id="post-59282">
    <div class="subject"><a href="#post-59282">Console Program only crashes</a></div>
    <div class="body">btw, I deleted some of the original text above because I thought it doesn't make any sense and would probably render it useless(using QUADWORD) when were using 32bit registers unless with MMX/SSE... Anyway here's my solution instead of using QUADWORD.<pre><code>sbi_srWindow_1 equ DWORD &#91;ebp-12&#93;  ;1st DWORD&#40;1st and 2nd fields&#41;<br />sbi_srWindow_2 equ DWORD &#91;ebp-8&#93;   ;2nd DWORD&#40;3rd and 4th fields&#41;</code></pre>as long as you got the correct sequence of all the structure fields, this doesn't matter. :)</div>
    <div class="meta">Posted on 2002-09-23 12:10:14 by stryker</div>
   </div>
   <div class="post" id="post-59367">
    <div class="subject"><a href="#post-59367">Console Program only crashes</a></div>
    <div class="body">Scientica,<br /><br />You already know what the macros do.<br /><br />The enter macro allows you to replace  with a label. It uses the enter instruction which does the same as <pre><code>	push	ebp<br />	mov	ebp, esp<br />	sub	esp, 12</code></pre><br />The only downside of the enter macro is that It's for Function Level 0 only.<br /><br /><br />The return macro uses leave and ret n, effectively undoing the enter instruction.</div>
    <div class="meta">Posted on 2002-09-24 02:08:46 by eet_1024</div>
   </div>
   <div class="post" id="post-59558">
    <div class="subject"><a href="#post-59558">Console Program only crashes</a></div>
    <div class="body">Function Level 0? :confused: <br /><br />BTW, aren't enter and leave s-l-o-w instructins (enter: 10 tick (push ebp/mov ebp,esp/sub esp,x: 3 tick), 3 tick (mov esp,ebp/pop ebp: 2 tick)). I think I prefer the long way, at least for the enter. :rolleyes:</div>
    <div class="meta">Posted on 2002-09-25 09:49:15 by scientica</div>
   </div>
   <div class="post" id="post-59610">
    <div class="subject"><a href="#post-59610">Console Program only crashes</a></div>
    <div class="body">Yeah, there much slower. But if you can change the macros to your liking.<br /><br />Level 1 Functions cat access the parameters of the calling function.  I haven't looked into it yet.<br /><br />As for speed, the app I'm working on calls an external compiler multiple times. So the few hundred clock cycles I've burned up are insignificant; that and I'm too lazy to change the macros.</div>
    <div class="meta">Posted on 2002-09-26 01:02:46 by eet_1024</div>
   </div>
  </div>
 </body>
</html>