<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>wsprintf again - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=21467" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=21467">wsprintf again</a></p>
   <div class="post" id="post-162124">
    <div class="subject"><a href="#post-162124">wsprintf again</a></div>
    <div class="body">Hi, i found a lot of wsprintf topics on the forum and read a few but none of them covered my problem so i opened a new thread and hope thats ok.<br /><br />Here we go:<br /><br />I wrote a little program which uses wsprintf and used C calling convention (.model Flat,C)<br /><br />Thats what the linker gave me <br /><br />Scrnsize.obj : error LNK2001: unresolved external symbol _ExitProcess<br />Scrnsize.obj : error LNK2001: unresolved external symbol _GetCommandLineA<br />Scrnsize.obj : error LNK2001: unresolved external symbol _GetModuleHandleA<br />Scrnsize.obj : error LNK2001: unresolved external symbol _GetSystemMetrics<br />Scrnsize.obj : error LNK2001: unresolved external symbol _MessageBoxA<br /><br />I dont know much about C but it seems to me as if the compiler created some links to several c specific functions, right? (because of the _ infront of the API function names)<br /><br />After that i tried stdcall instead of c and it works fine now but i dont understand why. <br /><br />I&#39;m a beginner and i learned that wsprintf has no way to find out how many parameters it gets passed so it can&#39;t do the stack handling. Thats why i should use c calling convention which sounds logic but why does it work anyway and what errors do i have to expect in the future if i keep using it with stdcall?<br /></div>
    <div class="meta">Posted on 2005-07-16 14:55:35 by LittleEndian</div>
   </div>
   <div class="post" id="post-162126">
    <div class="subject"><a href="#post-162126">Re: wsprintf again</a></div>
    <div class="body">The MASM32 includes are written in the assumption that you use STDCALL calling convention, and won&#39;t work otherwise. It&#39;s a simple fix to make the includes work in other calling conventions, but as usual the fix won&#39;t be made. So, use the STDCALL calling convention, and if you need C calling convention some places, add &quot;C&quot; to the function prototype... Or, go through all the MASM32 includes, and add &quot;STDCALL&quot; :)<br /></div>
    <div class="meta">Posted on 2005-07-16 15:22:29 by f0dder</div>
   </div>
   <div class="post" id="post-162128">
    <div class="subject"><a href="#post-162128">Re: wsprintf again</a></div>
    <div class="body"><div class="quote"><br />[...] if you need C calling convention some places, add &quot;C&quot; to the function prototype... [...]<br /></div><br /><br />You mean like: <br /><br />MyFunction PROTO C :DWORD,:DWORD,...? ? <br /><br />Does that work? The compiler doesnt just regard &quot;C&quot; as a parameter of DWORD type?<br /><br />If that works, thx for the advice :)<br /><br />If i missunderstood something then correct me please.<br /><br /><br />Why does wsprintf work without any C calling convention set? Is the only problem that the parameters given to wsprintf remain on the stack if no1 handles the stackframe and if so why do i have to set C calling convention at all? (in that particular case)? Cant i just handle the stackframe on my own without setting C calling convention? I mean if wsprintf cant handle the stack but the compiler compiles it anyway so it seems to me as if the parameters on the stack just remain unhandled after the function returned and if i set the BP manually back it should be fine, shouldnt it?</div>
    <div class="meta">Posted on 2005-07-16 16:04:03 by LittleEndian</div>
   </div>
   <div class="post" id="post-162129">
    <div class="subject"><a href="#post-162129">Re: wsprintf again</a></div>
    <div class="body"><div class="quote"><br />MyFunction PROTO C :DWORD,:DWORD,...&nbsp; ? <br /><br />Does that work? The compiler doesnt just regard &quot;C&quot; as a parameter of DWORD type?<br /></div><br />It should - I can&#39;t remember the exact syntax (been a while since I used masm, there are other assemblers around), but it seems right. It&#39;s something very similar anyway :)<br /><br />wsprintf is one of the few functions in the MASM32 includes that has it&#39;s calling convention set explicitly (because it differs from stdcall), so that should always work. But yes, if it was set to behave as stdcall, you shouldn&#39;t have problems unless you do manual push/pop.<br /><br />Btw, open up windows.inc in your masm32 folder and remove the wsprintf prototype present there, it is in user32.inc and should only be there - otherwise you&#39;ll always include user32.dll in your exe no matter if you use it or not.<br /></div>
    <div class="meta">Posted on 2005-07-16 17:39:12 by f0dder</div>
   </div>
   <div class="post" id="post-162130">
    <div class="subject"><a href="#post-162130">Re: wsprintf again</a></div>
    <div class="body">LittleEndian,<br /><br />The 5 functions you have listed are STDCALL so calling them using a C or pascal calling convention will not work properly. A C calling convention performs a name change with the leading underscore and does a stack correction after the call, both of which are incorrect under STDCALL.<br /><br />Now to f0dder who appears to be warming up for another round of personal attacks and abuse, he should in fact know better than to mislead a member of this forum on something as basic as the difference in calling conventione between Windows API calls and a function that has a C calling convention. The MASM32 project correctly prototypes windows API calls as STDCALL with the exception of wsprintfA which is C. It also prototypes the MSVCRT C functions as C calling convention.<br /><br />If you take incorrect advice from f0dder and modify the include files from MASM32, you can garrantee that your code will not work. Use the standard include files and place the following directive block at the start of your MASM code.<br /><br /><span class="mono"><br />&nbsp; &nbsp; &nbsp; .486&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; create 32 bit code<br />&nbsp; &nbsp; &nbsp; .model flat, stdcall&nbsp; &nbsp; &nbsp; ; 32 bit memory model<br />&nbsp; &nbsp; &nbsp; option casemap :none&nbsp; &nbsp; &nbsp; ; case sensitive<br /></span><br /><br />Regarding the problem of f0dder and what will be his following responses, this is a matter for the forum moderators.<br /><br />Regards,<br /><br />hutch at movsd dot com</div>
    <div class="meta">Posted on 2005-07-16 17:46:32 by hutch--</div>
   </div>
   <div class="post" id="post-162131">
    <div class="subject"><a href="#post-162131">Re: wsprintf again</a></div>
    <div class="body">(*sigh*)<br /><br /><div class="quote"><br />MASM32 project correctly prototypes windows API calls as STDCALL with the exception of wsprintfA which is C. It also prototypes the MSVCRT C functions as C calling convention.<br /></div><br />The MASM32 includes don&#39;t prototype the functions, they use the globally defined calling convention, whatever that might be. Not everyone wants to use STDCALL as the global calling convention, and those can&#39;t use the includes as-is.<br /><br /><div class="quote"><br />If you take incorrect advice from f0dder and modify the include files from MASM32, you can garrantee that your code will not work. Use the standard include files and place the following directive block at the start of your MASM code.<br /></div><br />It might break a few examples that are written with wrong assumptions, but any properly written source code will still build - and you&#39;ll get rid of linker warnings as well as a superfluous user32.dll reference.<br /><br /></div>
    <div class="meta">Posted on 2005-07-16 17:56:06 by f0dder</div>
   </div>
   <div class="post" id="post-162132">
    <div class="subject"><a href="#post-162132">Re: wsprintf again</a></div>
    <div class="body">I actually expect better from you with such a simple difference. You well know that a C calling convention and a STDCALL calling convention handle the name and the stack differently and they don&#39;t mix. STDCALL balances the stack at the end of the procedure BEFORE it returns to the caller where a C calling convention procedure simply does a RET and the CALLER balances the stack AFTER the procedure has returned.<br /><br />With a procedure that has no parameters you can do a direct CALL but with an API call with many arguments like CreateWindowEx() or CreateFont() mixing the calling conventions leaves the application with a serious stack imbalance that can crash the application.<br /><br />Now as I know where a discussion of this type will end, I ask that the moderators resolve the issue to spare members the usual nonsense.</div>
    <div class="meta">Posted on 2005-07-16 18:05:13 by hutch--</div>
   </div>
   <div class="post" id="post-162134">
    <div class="subject"><a href="#post-162134">Re: wsprintf again</a></div>
    <div class="body">hutch-, I&#39;m well aware of the differences between C, STDCALL, SYSCALL et cetera - and I know that you are as well, and that you know that I am.<br /><br />The thing is that the MASM32 includes don&#39;t specify any calling convention. Thus, they use whatever calling convention set by the &quot;.model&quot; directive. If a user has chosen &quot;.model flat, C&quot; that would be the default model, and it breaks the masm32 includes. All that is needed is to add the &quot;STDCALL&quot; keyword, and the inculdes would work no matter what.<br /><br />It&#39;s the same reason you have to specify &quot;C&quot; calling convention for wsprintf. It would be better to be explicit and specify the calling convention everywhere, to avoid problems.<br /></div>
    <div class="meta">Posted on 2005-07-16 19:31:16 by f0dder</div>
   </div>
   <div class="post" id="post-162135">
    <div class="subject"><a href="#post-162135">Re: wsprintf again</a></div>
    <div class="body">There is no problem when you use a system as it is designed, almost exclusively Windows in 32 bit uses STDCALL so it is correct to set a win32 application to,<br /><br /><span class="mono"><br />.model flat, stdcall<br /></span><br /><br />Now if someone else wishes to produce their own set of win32 include files for masm, they can do what they like but the complete set of include files that have worked reliably for years require this system and that will never change. Rather than try and modify a very reliable system, simply use it as it was designed. The user who specifies,<br /><br /><span class="mono"><br />.model flat, C<br /></span><br /><br />has one default function that will work correctly and will break the rest. At a ratio of over 12000 to 1, there is good reason to set the default to STDCALL and not C.<br /><br />Now since you are obviously out of date with the current files in MASM32, the 6 bytes that were used with wsprintfA call in the lookup table if that format was used has long since been solved by a conditional assembly block.<br /><br /><span class="mono"><br />IFNDEF _wininc_<br />&nbsp; wsprintfA PROTO C :DWORD,:VARARG<br />&nbsp; wsprintf equ &lt;wsprintfA&gt;<br />ENDIF<br /></span><br /><br />Under no circumstances should a learner programmer start deleting bits of the WINDOWS.INC file. Giving a learner programmer this type of advice leads to the &quot;error count exceeds 100&quot; problem.</div>
    <div class="meta">Posted on 2005-07-16 20:12:40 by hutch--</div>
   </div>
   <div class="post" id="post-162136">
    <div class="subject"><a href="#post-162136">Re: wsprintf again</a></div>
    <div class="body"><div class="quote"><br />Now if someone else wishes to produce their own set of win32 include files for masm, they can do what they like but the complete set of include files that have worked reliably for years require this system and that will never change. Rather than try and modify a very reliable system, simply use it as it was designed.<br /></div><br />What exactly would explicit calling convention specifiers break?<br /><br /><div class="quote"><br />Now since you are obviously out of date with the current files in MASM32, the 6 bytes that were used with wsprintfA call in the lookup table if that format was used has long since been solved by a conditional assembly block.<br /></div><br />*shrug* - I just downloaded what seemed like the latest version from the first available mirror. (www.nasn32.com -&gt; download section -&gt; canada nirror of n32v82r.zip). Sorry if that&#39;s not recent enough. But good to see you&#39;re at least finally doing something to solve the problem :alright:<br /><br /><div class="quote"><br />Under no circumstances should a learner programmer start deleting bits of the WINDOWS.INC file. Giving a learner programmer this type of advice leads to the &quot;error count exceeds 100&quot; problem.<br /></div><br />It would solve things that people are asking about here and other places from time to time, and I&#39;m available to help with problems the fix would cause to broken .asm files.<br /></div>
    <div class="meta">Posted on 2005-07-16 20:28:44 by f0dder</div>
   </div>
   <div class="post" id="post-162137">
    <div class="subject"><a href="#post-162137">Re: wsprintf again</a></div>
    <div class="body"><div class="quote"><br /><div class="quote"><br />Now if someone else wishes to produce their own set of win32 include files for masm, they can do what they like but the complete set of include files that have worked reliably for years require this system and that will never change. Rather than try and modify a very reliable system, simply use it as it was designed.<br /></div><br />What exactly would explicit calling convention specifiers break?<br /><br /><div class="quote"><br />Now since you are obviously out of date with the current files in MASM32, the 6 bytes that were used with wsprintfA call in the lookup table if that format was used has long since been solved by a conditional assembly block.<br /></div><br />*shrug* - I just downloaded what seemed like the latest version from the first available mirror. (www.masm32.com -&gt; download section -&gt; canada nirror of m32v82r.zip). Sorry if that&#39;s not recent enough. But good to see you&#39;re at least finally doing something to solve the problem :alright:<br /><br /><div class="quote"><br />Under no circumstances should a learner programmer start deleting bits of the WINDOWS.INC file. Giving a learner programmer this type of advice leads to the &quot;error count exceeds 100&quot; problem.<br /></div><br />It would solve things that people are asking about here and other places from time to time, and I&#39;m available to help with problems the fix would cause to broken .asm files.<br /></div><br /><br />&lt;edit&gt; - darn those &quot;natural keyboard&quot; are alien when you&#39;re not used to them! - hope I caught all the typos </div>
    <div class="meta">Posted on 2005-07-16 20:29:54 by f0dder</div>
   </div>
   <div class="post" id="post-162139">
    <div class="subject"><a href="#post-162139">Re: wsprintf again</a></div>
    <div class="body">Yeah,<br /><br />I wondered what had happened with the duplicate quote.<br /><br />Here is a quick sample of the consequences of a learner taking your advice and willy nilly changing the design of the system. the system is designed for the standard windows calling convention (STDCALL), change it to C and you get this.<br /><br /><span class="mono"><br />appath.obj : error LNK2001: unresolved external symbol _dwtoa<br />appath.obj : error LNK2001: unresolved external symbol _WordCount<br />appath.obj : error LNK2001: unresolved external symbol _szLen<br />appath.obj : error LNK2001: unresolved external symbol _szLower<br />appath.obj : error LNK2001: unresolved external symbol _szRemove<br />appath.obj : error LNK2001: unresolved external symbol _GetAppPath<br />appath.obj : error LNK2001: unresolved external symbol _GetStockObject<br />appath.obj : error LNK2001: unresolved external symbol _BeginPaint<br />appath.obj : error LNK2001: unresolved external symbol _DialogBoxIndirectParamA<br />appath.obj : error LNK2001: unresolved external symbol _DrawEdge<br />appath.obj : error LNK2001: unresolved external symbol _EndDialog<br />appath.obj : error LNK2001: unresolved external symbol _EndPaint<br />appath.obj : error LNK2001: unresolved external symbol _GetActiveWindow<br />appath.obj : error LNK2001: unresolved external symbol _GetClientRect<br />appath.obj : error LNK2001: unresolved external symbol _GetDlgItem<br />appath.obj : error LNK2001: unresolved external symbol _GetWindowRect<br />appath.obj : error LNK2001: unresolved external symbol _LoadIconA<br />appath.obj : error LNK2001: unresolved external symbol _MessageBoxA<br />appath.obj : error LNK2001: unresolved external symbol _SendMessageA<br />appath.obj : error LNK2001: unresolved external symbol _SetWindowTextA<br />appath.obj : error LNK2001: unresolved external symbol _ExitProcess<br />appath.obj : error LNK2001: unresolved external symbol _GetModuleHandleA<br />appath.obj : error LNK2001: unresolved external symbol _GlobalAlloc<br />appath.obj : error LNK2001: unresolved external symbol _GlobalFree<br />appath.obj : error LNK2001: unresolved external symbol _MultiByteToWideChar<br />appath.obj : error LNK2001: unresolved external symbol _InitCommonControls<br />appath.exe : fatal error LNK1120: 26 unresolved externals<br /></span><br /><br />Mess around with the include files and windows.inc and you risk,<br /><br /><span class="mono"><br />fatal error A1012: error count exceeds 100; stopping assembly<br /></span><br /><br />Now with a ratio in excess of 12000 to 1, is there some point in explicitly setting every STDCALL prototype to STDCALL when the standard notation,<br /><br /><span class="mono"><br />.model flat, stdcall<br /></span><br /><br />Automatically sets the calling convention to the windows standard. Even if you add the 730 MSVCRT functions to the list, its still greater than 10 to 1 so there is no point in placing C calling convention procedures on the same level as system based STDCALL.<br /><br />Now if someone want to do so, there is nothing stopping them from creating their own set of include files but I will not support alternative systems in the MASM32 project and anyone who wants to use such alternatives will need to get their support from the author of such an alternative.<br /><br /><div class="quote"><br />It would solve things that people are asking about here and other places from time to time, and I&#39;m available to help with problems the fix would cause to broken .asm files.<br /></div><br /><br />The simplest response is to give them the right advice in the first place, not mislead them. Set up the source file according to the existing system as follows.<br /><br /><span class="mono"><br />&nbsp; &nbsp; &nbsp; .486&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; create 32 bit code<br />&nbsp; &nbsp; &nbsp; .model flat, stdcall&nbsp; &nbsp; &nbsp; ; 32 bit memory model<br />&nbsp; &nbsp; &nbsp; option casemap :none&nbsp; &nbsp; &nbsp; ; case sensitive<br /></span><br /><br />There is no common method in building these files in MASM, use a different system, get your support somewhere else.<br /><br />I don&#39;t see that this discussion will lead to anything else than it always has and I see that the members should be spared nonsense of this type.<br /><br />This is a matter where the forum moderators should step in to prevent members from being mislead.</div>
    <div class="meta">Posted on 2005-07-16 20:47:23 by hutch--</div>
   </div>
   <div class="post" id="post-162141">
    <div class="subject"><a href="#post-162141">Re: wsprintf again</a></div>
    <div class="body"><div class="quote"><br />the system is designed for the standard windows calling convention (STDCALL), change it to C and you get this.<br /></div><br />Which is the problem of the origina poster, and what I commented on. The solution is to change all the prototypes in the include files to include the STDCALL specifier where necessary, so you remove the dependency on the .model specifiet.<br /><br /><div class="quote"><br />Mess around with the include files and windows.inc and you risk,<br /></div><br />Adding STDCALL to the protos will rid you of problems when people have another default calling convention, and removing the wsprintf proto from windows.inc will remove a linker warning as well as a an unnecessary dll file inclusion (but if your header inclusion guard fixes it, more power to that).<br /><br /><div class="quote"><br />Now with a ratio in excess of 12000 to 1, is there some point in explicitly setting every STDCALL prototype to STDCALL when the standard notation,<br /></div><br />Or fix the MASM32 includes. I know what outrage it would cause if microsoft hadn&#39;t specified calling convention or parameter types for their APIs :)<br /><br />Sure, fixing the masm32 includes would make the files a bit larger - but it wouldn&#39;t be a problem for distribution size (solid compression and/or a inc-file-generator would fix that), and as for compile speed, Randall Hyde has already demonstrated that masm is more than fast enough.<br /><br /><div class="quote"><br />This is a matter where the forum moderators should step in to prevent members from being mislead.<br /></div><br />That&#39;s up for the forum moderators to decide. If you&#39;re not happy with them, moderate your own forum.<br /> <br /> <br /> <br /> <br /></div>
    <div class="meta">Posted on 2005-07-16 21:37:45 by f0dder</div>
   </div>
   <div class="post" id="post-162154">
    <div class="subject"><a href="#post-162154">Re: wsprintf again</a></div>
    <div class="body">Hutch,<br /><br />I stand by f0dder&#39;s argument. It sound to me, but I guess you don&#39;t see the validity of his argument and refuses to follow his advice. But it is wrong for you to claim that he mislead people because he clearly did not do so. <br /><br />All I have seen through out these years is that you have been provoking f0dder like for instance asking him to publish his own library and so on. These are not appropriate behaviour. <br /><br />To Everyone:<br />I&#39;m sick of seeing these kind of threads on this forum so I&#39;m locking it. </div>
    <div class="meta">Posted on 2005-07-17 10:57:14 by roticv</div>
   </div>
  </div>
 </body>
</html>