<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>CreateRemoteThread probleom - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=13280" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=13280">CreateRemoteThread probleom</a></p>
   <div class="post" id="post-102967">
    <div class="subject"><a href="#post-102967">CreateRemoteThread probleom</a></div>
    <div class="body">Hi,all<br />I am a beginner here . Now I have a probleom in win32 asm programming . Here is :<br />--------------------------------------------------------------------------------------------------------------<br /><strong>I need to create a remote thread in other programm ( such as Program Manager ) , and just show a MessageBox in the thread . Compiled is OK but run error ,which made Program Manager shutdown . :(<br />The related code is here :<br /><br />code in main.asm :</strong><br />==================<br />	invoke	GetModuleHandle,addr szDllKernel<br />	mov		ebx,eax<br />	invoke	GetProcAddress,ebx,offset szLoadLibrary<br />	mov		lpLoadLibrary,eax<br />	invoke	GetProcAddress,ebx,offset szGetProcAddress<br />	mov		lpGetProcAddress,eax<br />	invoke	GetProcAddress,ebx,offset szGetModuleHandle<br />	mov		lpGetModuleHandle,eax<br />;********************************************************************<br />	invoke	FindWindow,addr szDesktopClass,addr szDesktopWindow<br />	invoke	GetWindowThreadProcessId,eax,offset dwProcessID<br />	mov	dwThreadID,eax<br />	invoke	OpenProcess,PROCESS_CREATE_THREAD or PROCESS_VM_OPERATION or \<br />		PROCESS_VM_WRITE,FALSE,dwProcessID<br />	.if	eax<br />		mov	hProcess,eax<br />;********************************************************************<br />		invoke	VirtualAllocEx,hProcess,NULL,REMOTE_CODE_LENGTH,MEM_COMMIT,PAGE_EXECUTE_READWRITE<br />			.if	eax<br />				mov	lpRemoteCode,eax<br />				invoke	WriteProcessMemory,hProcess,lpRemoteCode,\<br />					offset REMOTE_CODE_START,REMOTE_CODE_LENGTH,NULL<br />				invoke	WriteProcessMemory,hProcess,lpRemoteCode,\<br />					offset lpLoadLibrary,sizeof dword * 3,NULL<br />				mov	eax,lpRemoteCode<br />				add	eax,offset _RemoteThread - offset REMOTE_CODE_START<br />				invoke	CreateRemoteThread,hProcess,NULL,0,eax,0,0,NULL<br />				invoke	CloseHandle,eax<br />			.endif<br />			invoke	CloseHandle,hProcess<br />======== end part of main=========<br /><strong>code in _remote.asm</strong><br />==================<br />REMOTE_CODE_START	equ this byte<br /><br />_lpLoadLibrary		dd	?	<br />_lpGetProcAddress	dd	?<br />_lpGetModuleHandle	dd	?<br /><br />_lpDestroyWindow	dd	?<br />_lpPostQuitMessage	dd	?<br />_lpMessageBox		dd	?<br />_lpMessageBox		dd	?<br />_lpDispatchMessage	dd	?<br /><br />_szDestroyWindow	db	'DestroyWindow',0<br />_szPostQuitMessage	db	'PostQuitMessage',0<br />_szMessageBox		db	'MessageBox',0<br />_szDispatchMessage	db	'DispatchMessageA',0,0<br /><br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />_RemoteThread	proc	uses ebx edi esi lParam<br />				local	@dvMessage<br />		call	@F<br />		@@:<br />		pop	ebx<br />		sub	ebx,offset @B<br />;********************************************************************<br />		lea		eax,<br />		mov		@dvMessage,eax<br />		_invoke	,NULL,@dvMessage,NULL,MB_OK <br /><br />		ret <br /><br />_RemoteThread	endp<br />;**********************************************************************<br />REMOTE_CODE_END		equ this byte<br />REMOTE_CODE_LENGTH	equ offset REMOTE_CODE_END - offset REMOTE_CODE_START<br />========end =========<br /><br /><strong>the _invoke is defined here :</strong><br /><br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />reverseArgs	macro	arglist:VARARG<br />		local	txt,count<br />    <br />	txt	TEXTEQU	&lt;&gt;<br />	count	= 0<br />	for	i,&lt;arglist&gt;<br />	        count	= count + 1<br />	        txt	TEXTEQU @CatStr(i,&lt;!,&gt;,&lt;%txt&gt;)<br />	endm<br />	if	count GT 0<br />	        txt	SUBSTR  txt,1,@SizeStr(%txt)-1<br />	endif<br />	exitm	txt<br />endm<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />; <strong>macro for invoke</strong><br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />_invoke		macro	_Proc,args:VARARG<br />		local	count<br />    <br />	count	= 0<br />%	for	i,&lt; reverseArgs( args ) &gt;<br />		count	= count + 1<br />		push	i<br />	endm<br />	call	dword ptr _Proc    <br />    <br />endm<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</div>
    <div class="meta">Posted on 2003-05-14 01:09:54 by reichtiger</div>
   </div>
  </div>
 </body>
</html>