<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Implementing application smart crash system - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=17523" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=17523">Implementing application smart crash system</a></p>
   <div class="post" id="post-135590">
    <div class="subject"><a href="#post-135590">Implementing application smart crash system</a></div>
    <div class="body">Ok I've developed an app and sent it to you to check out, but unfortunatelly it crashes on your system while on mine works great... familiar situation?<br />Well pretty familiar to me, I want program to report where exactly it crashed and to log all valuable information for me so I can track down the bug and fix it. I know this has to be done via SEH-ing, and donkey has some example but I didn't have time to check it out thoroughly, which will I do as soon as I catch some time.<br /><br />I have one question though, not rarely, error occurs when you pass bad parameter to some API (eg, passing NULL to lstrcpy), this will produce crash withing Windows system code instead of my program code. So how can I track this bug down? Can I somehow log values on stack that represent return addresses of the code which executed API?<br /><br />Btw can someone make a list of all information that need to be gathered when crash occurs, like:<br />1. Operating system<br />2. Address of instruction that caused crash<br />3. </div>
    <div class="meta">Posted on 2004-03-10 19:51:46 by Mikky</div>
   </div>
   <div class="post" id="post-135593">
    <div class="subject"><a href="#post-135593">Implementing application smart crash system</a></div>
    <div class="body">Hi,<br /><br />You can look at my graceful exit example on my web site, it gives critical information about the exception and the system state at the time of the exception. You will find it in the GoAsm projects at the bottom of the page. Also though it does not specify the OS version in the output it does check it to verify whether PSAPI or ToolHelp should be used so the info is already available.<br /><br />Also you can check out Jeremy's SEH tutorial on his website...<br /><br /><a target="_blank" href="http://www.jorgon.freeserve.co.uk/Except/Except.htm">http://www.jorgon.freeserve.co.uk/Except/Except.htm</a></div>
    <div class="meta">Posted on 2004-03-10 20:14:42 by donkey</div>
   </div>
   <div class="post" id="post-135698">
    <div class="subject"><a href="#post-135698">Implementing application smart crash system</a></div>
    <div class="body">Hi Mikky,<br /><br />You never said whether the code sample on my site solved your problem but I have expanded it a bit to include the Windows OS version and some other information in case of an exception:<br /><br />This is a sample output:<br /><br /><pre><code>Module name&#58; Except.exe<br />Windows 2000 Service Pack 4<br />Exception code&#58; C0000094h<br />EXCEPTION_INT_DIVIDE_BY_ZERO<br />Instruction pointer&#58; 00401016h<br /><br />Registers&#58;<br />eax=0000000Ah ebx=7FFDF000h ecx=00000000h<br />edx=000A0000h esi=00000005h edi=C0000000h<br />ebp=0012FFF0h esp=0012FFC4h eip=00401016h<br /><br />Segment registers&#58;<br />CS=001Bh DS=0023h SS=0023h<br />ES=0023h FS=0038h GS=0000h<br /><br />Flags&#58; PF ZF IF<br /><br />Stack&#58;<br />7C5987E7 C0000000 00000005 7FFDF000<br />C0000094 0012FFC8 0012FC18 FFFFFFFF<br />7C5C1BB4 7C572B00 00000000 00000000<br />00000000 00401000 00000000 000000C8</code></pre><br /><br />As before it has a hyperlink to allow the user to email the exception information directly to you and it copies it to the clipboard on exit.</div>
    <div class="meta">Posted on 2004-03-12 04:35:19 by donkey</div>
   </div>
   <div class="post" id="post-135701">
    <div class="subject"><a href="#post-135701">Implementing application smart crash system</a></div>
    <div class="body">i dunno if this could be use full for you or not <br />but windows default debugger creates a dump file of every crash that happens <br />with the help of drwatson.exe<br /><br />you can locte this file most probably in allusers/applicationdata/drwatson<br /><br />its named drwatson.log and drwatson.dmp<br /><br />it has the info in this format<br /><br />it is also used by microsoft report tool i think in some administrative options<br /><br />may be find some way to harvest this info once it crashed in some remote computer or asking him to send this info explicitly may help to search for faulting location<br /><br /><br /><br />and some links on where and what about these files on ossses<br />hxxp://www.hotcomm.com/FAQ/FAQ_drwatson.asp<br /><br />===========================================<br /><br />Application exception occurred:<br />        App: D:\Program Files\Lavasoft\Ad-aware 6\Ad-aware.exe (pid=1952)<br />        When: 2/19/2004 @ 18:06:54.503<br />        Exception number: c00000fd (stack overflow)<br /><br />*----&gt; System Information &lt;----*<br />        Computer Name: USER5-XP<br />        User Name: Admin<br />        Terminal Session Id: 0<br />        Number of Processors: 1<br />        Processor Type: x86 Family 6 Model 8 Stepping 10<br />        Windows Version: 5.1<br />        Current Build: 2600<br />        Service Pack: 1<br />        Current Type: Uniprocessor Free<br />        Registered Organization: really do you want to know this ?? <br />        Registered Owner: demon of death<br /><br />*----&gt; Task List &lt;----*<br />   0 System Process<br />   4 Error 0xD0000022<br /> 476 Error 0xD0000022<br /> 532 Error 0xD0000022<br /> 556 Error 0xD0000022<br /> 600 Error 0xD0000022<br /> 612 Error 0xD0000022<br /> 784 Error 0xD0000022<br /> 848 Error 0xD0000022<br /> 972 Error 0xD0000022<br />1032 Error 0xD0000022<br />1140 Error 0xD0000022<br />1336 Error 0xD0000022<br />1504 Error 0xD0000022<br />1588 Explorer.EXE<br /> 684 Ad-watch.exe<br />1952 Ad-aware.exe<br />1272 drwtsn32.exe<br /><br />*----&gt; Module List &lt;----*<br />(0000000000350000 - 0000000000368000: D:\Program Files\Lavasoft\Ad-aware 6\AAWHELPER.DLL<br />(0000000000400000 - 0000000000616000: D:\Program Files\Lavasoft\Ad-aware 6\Ad-aware.exe<br />********<br />********<br />(0000000077e60000 - 0000000077f46000: D:\WINDOWS\system32\kernel32.dll<br />(0000000077f50000 - 0000000077ff7000: D:\WINDOWS\System32\ntdll.dll<br />(0000000078000000 - 0000000078086000: D:\WINDOWS\system32\RPCRT4.dll<br /><br />*----&gt; State Dump for Thread Id 0x4f4 &lt;----*<br /><br />eax=00000500 ebx=00000000 ecx=00403960 edx=77f79bb8 esi=00000000 edi=00000000<br />eip=77e7a2f9 esp=00032d8c ebp=0003329c iopl=0         nv up ei pl nz na pe nc<br />cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010202<br /><br />*** ERROR: Symbol file could not be found.  Defaulted to export symbols for D:\WINDOWS\system32\kernel32.dll - <br />function: kernel32!GetTickCount<br />        77e7a2d3 8bc1             mov     eax,ecx<br />        77e7a2d5 c20800           ret     0x8<br />        77e7a2d8 680948e977       push    0x77e94809<br />        77e7a2dd 64a100000000     mov     eax,fs:[00000000]<br />        77e7a2e3 50               push    eax<br />        77e7a2e4 64892500000000   mov     fs:[00000000],esp<br />        77e7a2eb 8b442410         mov     eax,<br />        77e7a2ef 896c2410         mov     ,ebp<br />        77e7a2f3 8d6c2410         lea     ebp,<br />        77e7a2f7 2be0             sub     esp,eax<br />FAULT -&gt;77e7a2f9 53               push    ebx     <strong>&lt;---- it faulted here  and so stack over flowed  i dunno this is an example paste </strong><br />        77e7a2fa 56               push    esi<br />        77e7a2fb 57               push    edi<br />        77e7a2fc 8b45f8           mov     eax,<br />        77e7a2ff 8965e8           mov     ,esp<br />        77e7a302 50               push    eax<br />        77e7a303 8b45fc           mov     eax,<br />        77e7a306 c745fcffffffff   mov     dword ptr ,0xffffffff<br />        77e7a30d 8945f8           mov     ,eax<br />        77e7a310 c3               ret<br />        77e7a311 8d45d4           lea     eax,<br /><br />*----&gt; Stack Back Trace &lt;----*<br />*** ERROR: Module load completed but symbols could not be loaded for D:\Program Files\Lavasoft\Ad-aware 6\Ad-aware.exe<br />WARNING: Stack unwind information not available. Following frames may be wrong.<br />*** ERROR: Symbol file could not be found.  Defaulted to export symbols for D:\WINDOWS\System32\ntdll.dll - <br />ChildEBP RetAddr  Args to Child              <br />****<br />****<br />====================================================</div>
    <div class="meta">Posted on 2004-03-12 06:12:54 by bluffer</div>
   </div>
   <div class="post" id="post-135709">
    <div class="subject"><a href="#post-135709">Implementing application smart crash system</a></div>
    <div class="body">If you just want DrWatson, which may or may not be enabled on the system depending on what the JIT debugger settings are. Also you have to have the user configure it properly and get the error at the right time because they are overwritten depending on the setup. Anyway I started to write a DrWatson log viewer but gave up and decided to do my own exception handling :</div>
    <div class="meta">Posted on 2004-03-12 10:18:35 by donkey</div>
   </div>
   <div class="post" id="post-135754">
    <div class="subject"><a href="#post-135754">Implementing application smart crash system</a></div>
    <div class="body">when is drwatson activated after the app raises UnhandledExceptionFilter api <br />or before it<br /><br />coz if it is activated after unhandled then that means the seh handler cannot harvest the info coz it need to return it as handled ??? i cant phrase my question <br />properly <br /><br />assume i use <br />xor eax,eax<br />mov eax,<br /><br />its sure to create c000005 (access violation)<br />now my handler will get a chance to deal with <br /><br />i can modify all the context even change eip etc etc<br /><br />but i thought ill use CreateFile(drwatson.log,**,**,**)<br />search for recent log<br />read file <br />copy content to some where <br />close handle<br />ask user if he wants to send this info to the author and send it<br />or write file (dump of recent crash.txt ,**,**,) so that he can send it after editing if he likes<br />return back to zwContinue after changing eip or exit without crashing<br /><br />but i dont think dr watso would have the info when my handler is handling the exception <br /><br />any ideas or comments please</div>
    <div class="meta">Posted on 2004-03-13 04:26:49 by bluffer</div>
   </div>
   <div class="post" id="post-135796">
    <div class="subject"><a href="#post-135796">Implementing application smart crash system</a></div>
    <div class="body">DrWatson is set up in the AeDebug registry entry as the JIT debugger, you will find it in the JIT debug key, so it is passed the exception after the standard exception handlers and the final handler. If you use SetUnhandledExceptionFilter and return EXCEPTION_EXECUTE_HANDLER you will effectively disable it. If you wish to have the exception passed to DrWatson anyway you can return EXCEPTION_CONTINUE_SEARCH from your final handler.<br /><br />HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AeDebug\Debugger</div>
    <div class="meta">Posted on 2004-03-13 10:43:36 by donkey</div>
   </div>
  </div>
 </body>
</html>