<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>im getting crazy of this code, HELP - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=5578" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=5578">im getting crazy of this code, HELP</a></p>
   <div class="post" id="post-39694">
    <div class="subject"><a href="#post-39694">im getting crazy of this code, HELP</a></div>
    <div class="body">Hi, there<br /><br />by some reason i need to find all the files in subdirectories and then index them. But so far i programmed the part of finding all files in subdirectories. here below it is. BUT i never read somewhere that you have to preserve the esi register in your winprocedure. I don't now why but somehow user32 is putting the dword value 00000001 in where ever esi points at, look below if you don't push and pop the esi you CRASH, this was an afternoon of searching the bug i can't get it, if someone can explain i like to know but here it is you can use this algo and make it better, BTW i need expertise on sorting lists of strings please reply if you know it well:<br /><br /><pre><code>.386<br />.model flat,stdcall<br />option casemap&#58;none<br />WinMain proto &#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD<br /><br />include \masm32\include\windows.inc<br />include \masm32\include\user32.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\comdlg32.inc<br />include \masm32\include\shell32.inc<br />include \masm32\include\ole32.inc<br />include \masm32\include\masm32.inc<br />include \masm32\include\gdi32.inc<br /><br />includelib \masm32\lib\user32.lib<br />includelib \masm32\lib\kernel32.lib<br />includelib \masm32\lib\comdlg32.lib<br />includelib \masm32\lib\shell32.lib<br />includelib \masm32\lib\ole32.lib<br />includelib \masm32\lib\masm32.lib<br />includelib \masm32\lib\gdi32.lib<br /><br />.const<br />IDM_OPEN equ 1<br />IDM_EXIT equ 2<br /><br />.data<br />ClassName	db &quot;SimpleWinClass&quot;,0<br />AppName		db &quot;Our Main Window&quot;,0<br />MenuName	db &quot;FirstMenu&quot;,0<br />OurTitle	db &quot;kies data&#58;&quot;,0<br />wCard		db &quot;*.*&quot;,0<br />buffer2		db &quot;files.txt&quot;,0<br />text		db &quot; files found.&quot;,0<br /><br />.data?<br />WorkDir		byte MAX_PATH dup&#40;?&#41;<br />buffer		byte MAX_PATH dup&#40;?&#41;<br />bufferhtm	byte MAX_PATH dup&#40;?&#41;<br />OutputDir	byte MAX_PATH dup&#40;?&#41;<br />text1		byte 10 dup&#40;?&#41;<br />text2		byte 20 dup&#40;?&#41;<br />hInstance HINSTANCE ?<br />CommandLine LPSTR ?<br />filegrootte DWORD ?<br />BInfo       BROWSEINFO &lt;&gt; <br />wfd 	WIN32_FIND_DATA &lt;&gt;<br />hSearch DWORD ?<br />pMem DWORD ?<br />pMemory DWORD ?<br />pMemoryhtm DWORD ?<br />mijnMem DWORD ?<br />hMem HANDLE ?<br />hFileWrite HANDLE ?<br />hFileRead HANDLE ?<br />hFileReadhtm HANDLE ?<br />hMapFile HANDLE ?<br />hMapFilehtm HANDLE ?<br />SizeWritten DWORD ?<br />diep DWORD ?<br />einde DWORD ?<br />aantalfiles DWORD ?<br />.code<br />start&#58;<br />	<br />	invoke GetModuleHandle, NULL<br />	mov    hInstance,eax<br />	invoke GetCommandLine<br />	invoke WinMain, hInstance,NULL,CommandLine, SW_SHOWDEFAULT<br />	invoke ExitProcess,eax<br />WinMain proc hInst&#58;HINSTANCE,hPrevInst&#58;HINSTANCE,CmdLine&#58;LPSTR,CmdShow&#58;DWORD<br />	LOCAL wc&#58;WNDCLASSEX<br />	LOCAL msg&#58;MSG<br />	LOCAL hwnd&#58;HWND<br />	mov   wc.cbSize,SIZEOF WNDCLASSEX<br />	mov   wc.style, CS_HREDRAW or CS_VREDRAW<br />	mov   wc.lpfnWndProc, OFFSET WndProc<br />	mov   wc.cbClsExtra,NULL<br />	mov   wc.cbWndExtra,NULL<br />	push  hInst<br />	pop   wc.hInstance<br />	mov   wc.hbrBackground,COLOR_WINDOW+1<br />	mov   wc.lpszMenuName,OFFSET MenuName<br />	mov   wc.lpszClassName,OFFSET ClassName<br />	invoke LoadIcon,NULL,IDI_APPLICATION<br />	mov   wc.hIcon,eax<br />	mov   wc.hIconSm,eax<br />	invoke LoadCursor,NULL,IDC_ARROW<br />	mov   wc.hCursor,eax<br />	invoke RegisterClassEx, addr wc<br />	INVOKE CreateWindowEx,WS_EX_CLIENTEDGE,ADDR ClassName,ADDR AppName,\<br />           WS_OVERLAPPEDWINDOW,CW_USEDEFAULT,\<br />           CW_USEDEFAULT,300,200,NULL,NULL,\<br />           hInst,NULL<br />	mov   hwnd,eax<br />	INVOKE ShowWindow, hwnd,SW_SHOWNORMAL<br />	INVOKE UpdateWindow, hwnd<br />	.WHILE TRUE<br />		    INVOKE GetMessage, ADDR msg,NULL,0,0<br />                .BREAK .IF &#40;!eax&#41;<br />                INVOKE TranslateMessage, ADDR msg<br />                INVOKE DispatchMessage, ADDR msg<br />	.ENDW<br />	mov     eax,msg.wParam<br />	ret<br />WinMain endp<br />WndProc proc hWnd&#58;HWND, uMsg&#58;UINT, wParam&#58;WPARAM, lParam&#58;LPARAM<br />	LOCAL hdc&#58;HDC <br />   	 LOCAL ps&#58;PAINTSTRUCT <br />	.IF uMsg==WM_DESTROY<br />		invoke PostQuitMessage,NULL<br />	.ELSEIF uMsg==WM_COMMAND<br />		mov eax,wParam<br />		.if ax==IDM_OPEN<br />			push esi ; &lt;------this is what i mean<br />			invoke GlobalAlloc,GMEM_MOVEABLE or GMEM_ZEROINIT,10485759<br />			mov  hMem,eax<br />			invoke GlobalLock,hMem<br />			mov  pMem,eax<br />			mov mijnMem,eax<br />			<br />			<br />			<br />			<br />			<br />			<br />			<br />			mov     eax,hWnd<br />			mov     BInfo.hwndOwner,eax<br />                	mov     BInfo.pidlRoot,0<br />	                mov     BInfo.lpszTitle,OFFSET OurTitle<br />	                mov     BInfo.ulFlags,BIF_RETURNONLYFSDIRS<br />	                mov     BInfo.lpfn,0<br />	                mov     BInfo.lParam,0<br />	                mov     BInfo.iImage,0<br />	                invoke  SHBrowseForFolder,ADDR BInfo<br />			.if eax != 0                       <br />				push    eax                <br />				invoke  SHGetPathFromIDList,eax,ADDR WorkDir<br />				call    CoTaskMemFree <br />			.endif<br />			lea esi,WorkDir<br />			lea edi,OutputDir<br />@@&#58;			lodsb<br />			stosb<br />			cmp al, 0<br />			jne @B<br />			<br />			mov &#91;aantalfiles&#93;,0<br />			mov &#91;diep&#93;,1<br />opnieuw&#58;		invoke SetCurrentDirectory,ADDR WorkDir<br />			invoke FindFirstFile,ADDR wCard,ADDR wfd<br />			mov hSearch,eax<br />			push eax<br />			invoke FindNextFile,hSearch,ADDR wfd<br />volgende&#58;		invoke FindNextFile,hSearch,ADDR wfd<br />			.IF eax!=0<br />				mov eax,&#91;wfd.dwFileAttributes&#93;<br />				and eax,FILE_ATTRIBUTE_DIRECTORY<br />				.if eax==FILE_ATTRIBUTE_DIRECTORY<br />					inc &#91;diep&#93;<br />					cld<br />					lea edi,WorkDir<br />					mov ecx,-1<br />					mov al,0<br />					repnz scasb<br />					not ecx<br />					dec ecx<br />					lea edi, WorkDir<br />					add edi,ecx<br />					mov byte ptr &#91;edi&#93;,'\'<br />					inc edi<br />					lea esi, wfd.cFileName<br />@@&#58;					lodsb<br />					stosb<br />					cmp al, 0<br />					jne @B<br />					mov &#91;einde&#93;,edi<br />					jmp opnieuw				<br />				.else<br />					mov edi,mijnMem<br />					lea esi,WorkDir<br />@@&#58;					lodsb<br />					stosb<br />					cmp al,0<br />					jne @B<br />					dec edi<br />					mov byte ptr &#91;edi&#93;,'\'<br />					inc edi<br />					lea esi,wfd.cFileName<br />@@&#58;					lodsb<br />					stosb<br />					cmp al,0<br />					jne @B<br />					dec edi<br />					mov byte ptr &#91;edi&#93;,13<br />					inc edi<br />					mov byte ptr &#91;edi&#93;,10<br />					inc edi<br />					mov mijnMem,edi<br />					inc &#91;aantalfiles&#93;<br />					jmp volgende<br />				.endif<br />			.else<br />				dec &#91;diep&#93;<br />				pop hSearch<br />				invoke FindClose,hSearch<br />				.IF &#91;diep&#93;==0<br />					jmp klaar<br />				.ELSE<br />					pop hSearch<br />					push hSearch<br />					std<br />					mov al,'\'<br />					mov edi,&#91;einde&#93;<br />					repnz scasb<br />					inc edi<br />					mov byte ptr &#91;edi&#93;,0<br />					cld<br />					jmp volgende<br />				.ENDIF<br />			.endif<br />klaar&#58;			mov eax,mijnMem<br />			sub eax,pMem<br />			mov filegrootte,eax<br />			invoke InvalidateRect, hWnd,NULL,TRUE <br /><br />			invoke SetCurrentDirectory,ADDR OutputDir<br />			invoke CreateFile,ADDR buffer2,GENERIC_WRITE ,FILE_SHARE_READ or FILE_SHARE_WRITE,NULL,CREATE_ALWAYS,FILE_ATTRIBUTE_ARCHIVE,NULL<br />			mov hFileWrite,eax<br /><br />			invoke WriteFile,hFileWrite,pMem,filegrootte,ADDR SizeWritten,NULL<br />			<br />			invoke CloseHandle,hFileWrite<br />; #######################indexeren####################################################<br />			lea esi,OutputDir<br />			lea edi,buffer<br />@@&#58;			lodsb<br />			stosb<br />			cmp al,0<br />			jne @B<br />			dec edi<br />			mov byte ptr &#91;edi&#93;,'\'<br />			inc edi<br />			lea esi,buffer2<br />@@&#58;			lodsb<br />			stosb<br />			cmp al,0<br />			jne @B<br /><br />			invoke CreateFile,ADDR buffer,GENERIC_READ ,0,NULL,OPEN_EXISTING,FILE_ATTRIBUTE_ARCHIVE,NULL<br />			mov hFileRead,eax<br />			invoke CreateFileMapping,hFileRead,NULL,PAGE_READONLY,0,0,NULL<br />			mov  hMapFile,eax<br />			invoke MapViewOfFile,hMapFile,FILE_MAP_READ,0,0,0<br />			mov pMemory,eax<br /><br />			mov esi,pMemory<br />			lea edi,bufferhtm<br />@@&#58;			lodsb<br />			stosb<br />			cmp al,10<br />			jne @B<br />			dec edi<br />			dec edi<br />			mov byte ptr &#91;edi&#93;,0<br />			invoke CreateFile,ADDR bufferhtm,GENERIC_READ ,0,NULL,OPEN_EXISTING,FILE_ATTRIBUTE_ARCHIVE,NULL<br />			mov hFileReadhtm,eax<br />			invoke CreateFileMapping,hFileReadhtm,NULL,PAGE_READONLY,0,0,NULL<br />			mov  hMapFilehtm,eax<br />			invoke MapViewOfFile,hMapFilehtm,FILE_MAP_READ,0,0,0<br />			mov pMemoryhtm,eax<br />			<br />			mov eax,pMem<br />			mov mijnMem,eax<br />			<br />			mov esi,pMemoryhtm<br />			mov edi,mijnMem<br />			<br />luss&#58;			lodsb<br />			.if al=='&lt;'<br />@@&#58;				lodsb<br />				cmp al,'&gt;'<br />				jne @B<br />				jmp luss<br />			.elseif al==13<br />				inc esi<br />				jmp luss<br />			.endif<br />			invoke UnmapViewOfFile,pMemoryhtm<br />			invoke CloseHandle,hMapFilehtm<br />			mov    hMapFilehtm,0<br />			invoke CloseHandle,hFileReadhtm<br /><br />			invoke UnmapViewOfFile,pMemory<br />			invoke CloseHandle,hMapFile<br />			mov    hMapFile,0<br />			invoke CloseHandle,hFileRead<br />			<br />			invoke GlobalUnlock,pMem<br />			invoke GlobalFree,hMem<br />			pop esi ; &lt;------this is what i mean<br />			<br />		.else<br />			invoke DestroyWindow, hWnd<br />		.endif<br />	.ELSEIF uMsg==WM_PAINT <br />		        <br />		        invoke BeginPaint,hWnd, ADDR ps <br />		        mov    hdc,eax <br />		        <br />		        <br />		        invoke dwtoa,aantalfiles,addr text1<br />		        lea edi,text2<br />		        lea esi,text1<br />@@&#58;			lodsb<br />			stosb<br />			cmp al,0<br />			jne @B<br />			dec edi<br />			lea esi,text<br />@@&#58;			lodsb<br />			stosb<br />			cmp al,0<br />			jne @B<br />			dec edi<br />			lea eax,text2<br />			sub edi,eax		<br />		        invoke TextOut,hdc,0,0,ADDR text2,edi<br />		        <br />		        invoke EndPaint,hWnd, ADDR ps <br />		        <br />	.ELSE<br />		invoke DefWindowProc,hWnd,uMsg,wParam,lParam<br />		ret<br />	.ENDIF<br />	xor    eax,eax<br />	ret<br />WndProc endp<br /><br />end start<br /><br /><br /><br />// Constants for menu rsrc.rc<br />#define IDM_OPEN 1<br />#define IDM_EXIT 2<br /><br />FirstMenu MENU<br />&#123;<br /> POPUP &quot;&amp;File&quot;<br />        &#123;<br />         MENUITEM &quot;&amp;Open&quot;,IDM_OPEN<br />         MENUITEM SEPARATOR<br />         MENUITEM &quot;E&amp;xit&quot;,IDM_EXIT<br />        &#125;<br />&#125;</code></pre><br /><br /><br />I think it's a bug in module user....<br /><br />See ya:)<br /><br /><span style="font-size:9px><strong>Code Blocks added by NaN</strong></span></div>
    <div class="meta">Posted on 2002-05-24 09:50:27 by eisodur</div>
   </div>
   <div class="post" id="post-39878">
    <div class="subject"><a href="#post-39878">im getting crazy of this code, HELP</a></div>
    <div class="body">Yes, you do need to preserve ESI (and EDI and EBX) in a window procedure. If you search for &quot;calling conventions&quot; or &quot;register conventions&quot;, you'll find a number of articles, some of which will explain the register saving convention.</div>
    <div class="meta">Posted on 2002-05-25 03:03:32 by tenkey</div>
   </div>
   <div class="post" id="post-39889">
    <div class="subject"><a href="#post-39889">im getting crazy of this code, HELP</a></div>
    <div class="body">There is a piece of folklore with the previous suggestion that it only applies to WndProc style procedures where in fact the Windows convention is that you must preserve EBX ESI and EDI in ANY procedure that uses them.<br /><br />If a WndProc does NOT use these 3 registers, it does NOT need to preserve them. The only place where you can bypass this convention is if you make a call from within a proc that has already preserved EBX ESI and EDI and the call that can be made under these conditions cannot interact with any OS functions while executing code.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-05-25 05:21:06 by hutch--</div>
   </div>
   <div class="post" id="post-39920">
    <div class="subject"><a href="#post-39920">im getting crazy of this code, HELP</a></div>
    <div class="body">I had the same prob some time ago and i found a very simple method u could use (but i still think u should use a WIN32_FIND).<br /><br />      szText MACRO Name, Text:VARARG<br />        LOCAL lbl<br />          jmp lbl<br />            Name db Text,0<br />          lbl:<br />        ENDM<br /><br />ListBox proc a:DWORD,b:DWORD,wd:DWORD,ht:DWORD,hParent:DWORD,ID:DWORD<br /><br />    szText lstBox,&quot;LISTBOX&quot;<br /><br />    invoke CreateWindowEx,WS_EX_CLIENTEDGE,ADDR lstBox,0,<br />              WS_VSCROLL or WS_VISIBLE or \<br />              WS_BORDER or WS_CHILD or \<br />              LBS_HASSTRINGS or LBS_NOINTEGRALHEIGHT or \<br />              LBS_DISABLENOSCROLL,<br />              a,b,wd,ht,hParent,ID,hInstance,NULL<br /><br />    ret<br /><br />ListBox endp<br /><br />...................<br /><br />invoke ListBox,20,40,420,200,hWin,500<br />mov hList1, eax<br />szText Patn,&quot;c:\*.*&quot;<br />invoke SendMessage,hList1,LB_DIR,DDL_ARCHIVE or DDL_DRIVES or \<br />DDL_DIRECTORY or DDL_HIDDEN or DDL_READONLY or \<br />DDL_READWRITE or DDL_SYSTEM,ADDR Patn<br /><br />Hope u realised that &lt;Patn&gt; is the path ( \*.* required) &amp; &lt;hList1&gt; is a listbox.</div>
    <div class="meta">Posted on 2002-05-25 09:28:33 by ViperV`</div>
   </div>
   <div class="post" id="post-40210">
    <div class="subject"><a href="#post-40210">im getting crazy of this code, HELP</a></div>
    <div class="body">First of all thank you all for helping me out!!<br /><br />The result you can download from the attached file.<br /><br />The prog expects taht the data dir is containing .htm files and puts all words on the stack and then move's to the nextone.<br /><br />I have to find some way to sort this stack or perhaps use a linked list, what do you suggest? But here are some problems to.<br /><br />Anyway here's the code for the subdirectory search and index htm</div>
    <div class="meta">Posted on 2002-05-27 10:28:36 by eisodur</div>
   </div>
   <div class="post" id="post-48030">
    <div class="subject"><a href="#post-48030">I Think</a></div>
    <div class="body">invoke GetModuleHandle, NULL<br />	mov    hInstance,eax<br />	invoke GetCommandLine<br />	invoke WinMain, hInstance,NULL,CommandLine, SW_SHOWDEFAULT<br /><br />i think there is something wrong here.. you invoke GetCommandLine sure but you don't move it no where for storage and in invoke WinMain you use CommandLine... mov the data into CommandLine before you invoke something that is not there.. im not sure if thats the problem but i hope i helped..</div>
    <div class="meta">Posted on 2002-07-17 01:26:24 by SpawNRuleR</div>
   </div>
  </div>
 </body>
</html>