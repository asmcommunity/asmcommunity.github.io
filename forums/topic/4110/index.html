<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>The real KMP? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=4110" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=4110">The real KMP?</a></p>
   <div class="post" id="post-28071">
    <div class="subject"><a href="#post-28071">The real KMP?</a></div>
    <div class="body">Ok, is this the real KMP? I just want to know before I do some optimizin' and put it into a real application.<br /><br /><pre><code><br /><br />&#91;size=9&#93;<br />KMP PROC USES ebx esi edi StringSource&#58;DWORD, SourceLength&#58;DWORD, StringPattern&#58;DWORD, PatternLength&#58;DWORD, ShiftTable&#58;DWORD<br /><br />    ;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=<br />    ;Generate a shift table<br />    ;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=<br />    <br />    ;Initialization before generating shift table<br />        <br />    xor     ecx, ecx<br />    mov     ebx, PatternLength<br />    mov     eax, -1<br />    mov     esi, StringPattern<br />    mov     edi, ShiftTable<br />    mov     DWORD PTR &#91;edi&#93;, eax<br />    <br />    ;Start generating<br />    <br />    @@GENERATE_TABLE&#58;<br />    <br />        cmp     ecx, ebx<br />        je      @@TABLE_FINISHED<br />        <br />    @@INNER_TABLE_LOOP&#58;<br />    <br />        test    eax, eax<br />        js      @@CONTINUE_TABLE<br />        mov     dl, BYTE PTR &#91;esi+ecx&#93;<br />        cmp     dl, BYTE PTR &#91;esi+eax&#93;<br />        je      @@CONTINUE_TABLE<br />        mov     eax, DWORD PTR &#91;edi+eax*4&#93;<br />        jmp     @@INNER_TABLE_LOOP<br />        <br />    @@CONTINUE_TABLE&#58;<br />    <br />        inc     ecx<br />        inc     eax<br />        mov     dl, BYTE PTR &#91;esi+ecx&#93;<br />        cmp     dl, BYTE PTR &#91;esi+eax&#93;<br />        jne     @@SHIFTTABLE_VALUE_IS_EAX<br />        mov     edx, DWORD PTR &#91;edi+eax*4&#93;<br />        mov     DWORD PTR &#91;edi+ecx*4&#93;, edx<br />        jmp     @@GENERATE_TABLE<br />        <br />    @@SHIFTTABLE_VALUE_IS_EAX&#58;<br />    <br />        mov     DWORD PTR &#91;edi+ecx*4&#93;, eax<br />        jmp     @@GENERATE_TABLE<br />        <br />    @@TABLE_FINISHED&#58;<br />    <br />        ;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=<br />        ; Displays the shift table<br />        ;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=<br />        ;<br />        ;xor     ecx, ecx<br />        ; <br />        ;@@&#58;<br />        ;    <br />        ;    cmp     ecx, ebx<br />        ;    ja      @f<br />        ;    push    ecx<br />        ;    push    ebx<br />        ;    push    edi<br />        ;    invoke  dwtoa, DWORD PTR &#91;edi+ecx*4&#93;, OFFSET gbGBuffer<br />        ;    invoke  MessageBox, 0, OFFSET gbGBuffer, 0, 0<br />        ;    pop     edi<br />        ;    pop     ebx<br />        ;    pop     ecx<br />        ;    inc     ecx<br />        ;    jmp     @b<br />        ;<br />        ;@@&#58;<br />        ;<br />        ;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=<br />    <br />    ;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=<br />    ;KMP routine<br />    ;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=<br />    <br />    ;Initialization before KMP search<br />    <br />    push    ebx<br />    mov     eax, SourceLength<br />    push    eax<br />    <br />    xor     eax, eax<br />    xor     ecx, ecx<br />    xor     edx, edx<br />    mov     ebx, ShiftTable<br />    mov     esi, StringSource<br />    mov     edi, StringPattern<br />    <br />    ;Start KMP<br /><br />    @@KMP_SEARCH&#58;<br />    <br />        cmp     ecx, DWORD PTR &#91;esp&#93;<br />        je      @@KMP_END<br />        cmp     eax, DWORD PTR &#91;esp+4&#93;<br />        je      @@KMP_END<br />        <br />    @@INNER_KMP&#58;<br />    <br />        test    eax, eax<br />        js      @@KMP_CONTINUE<br />        mov     dl, BYTE PTR &#91;esi+ecx&#93;<br />        cmp     dl, BYTE PTR &#91;edi+eax&#93;<br />        je      @@KMP_CONTINUE<br />        mov     eax, &#91;ebx&#93;&#91;eax*4&#93;<br />        jmp     @@INNER_KMP<br />        <br />    @@KMP_CONTINUE&#58;<br />        <br />        inc     eax<br />        inc     ecx<br />        jmp     @@KMP_SEARCH<br />            <br />    @@KMP_END&#58;<br />    <br />        pop     edx<br />        pop     edx<br />    <br />        cmp     eax, edx<br />        jne     @@STRING_NOT_FOUND<br />        <br />        sub     ecx, edx<br />        mov     eax, ecx<br />        ret<br />        <br />    @@STRING_NOT_FOUND&#58;<br />    <br />        mov     eax, -1<br />        ret<br /><br />KMP ENDP<br />&#91;/size&#93;<br /><br /></code></pre><br /><br />Return Value: EAX<br /><br />If the string is not found, it will return -1 else it will return the position of the string.<br /><br />The ShiftTable parameter is a dynamically allocated dword size array with the number of elements based on the pattern length. I tested this one on almost any string combo I can think of, and everything works perfectly. I just want to know If I did it right this time.<br /><br />Thanks!!! :)<br /><br />P.S. It would be much better If I move this post to a new thread to reduce the confusion between hybrid and the real KMP.  Also the thread &quot;Hybrid KMP&quot; I so convoluted with codes and would make it a little perplexing for readers which is the right or wrong KMP string search algorithm.</div>
    <div class="meta">Posted on 2002-03-09 15:37:12 by stryker</div>
   </div>
   <div class="post" id="post-28102">
    <div class="subject"><a href="#post-28102">The real KMP?</a></div>
    <div class="body">I updated it quite a bit, this is a little bit optimized than the first one. Here's the code.<br /><br /><pre><code><br /><br />&#91;size=9&#93;<br />KMP PROC USES ebx esi edi StringSource&#58;DWORD, SourceLength&#58;DWORD, StringPattern&#58;DWORD, PatternLength&#58;DWORD, ShiftTable&#58;DWORD<br />    <br />    mov     eax, PatternLength<br />    push    eax<br />    mov     eax, SourceLength<br />    push    eax<br />    mov     eax, -1<br />    mov     ebx, ShiftTable<br />    xor     ecx, ecx<br />    mov     &#91;ebx&#93;&#91;ecx*4&#93;, eax<br />    mov     esi, StringSource<br />    mov     edi, StringPattern<br />    <br />    @@GENERATE_TABLE&#58;<br />    <br />        cmp     ecx, DWORD PTR &#91;esp+4&#93;<br />        je      @@TABLE_FINISHED<br />        <br />    @@INNER_TABLE_LOOP&#58;<br />    <br />        test    eax, eax<br />        js      @@CONTINUE_TABLE<br />        mov     dl, BYTE PTR &#91;edi+ecx&#93;<br />        cmp     dl, BYTE PTR &#91;edi+eax&#93;<br />        je      @@CONTINUE_TABLE<br />        mov     eax, &#91;ebx&#93;&#91;eax*4&#93;<br />        jmp     @@INNER_TABLE_LOOP<br />        <br />    @@CONTINUE_TABLE&#58;<br />    <br />        inc     ecx<br />        inc     eax<br />        mov     dl, BYTE PTR &#91;edi+ecx&#93;<br />        cmp     dl, BYTE PTR &#91;edi+eax&#93;<br />        jne     @@SHIFTTABLE_VALUE_IS_EAX<br />        mov     edx, &#91;ebx&#93;&#91;eax*4&#93;<br />        mov     &#91;ebx&#93;&#91;ecx*4&#93;, edx<br />        jmp     @@GENERATE_TABLE<br />        <br />    @@SHIFTTABLE_VALUE_IS_EAX&#58;<br />    <br />        mov     &#91;ebx&#93;&#91;ecx*4&#93;, eax<br />        jmp     @@GENERATE_TABLE<br />        <br />    @@TABLE_FINISHED&#58;<br />    <br />    xor     eax, eax<br />    xor     ecx, ecx<br />    <br />    @@KMP_SEARCH&#58;<br />    <br />        cmp     eax, DWORD PTR &#91;esp&#93;<br />        je      @@KMP_END<br />        cmp     ecx, DWORD PTR &#91;esp+4&#93;<br />        je      @@KMP_END<br />        <br />    @@INNER_KMP&#58;<br />    <br />        test    ecx, ecx<br />        js      @@KMP_CONTINUE<br />        mov     dl, BYTE PTR &#91;esi+eax&#93;<br />        cmp     dl, BYTE PTR &#91;edi+ecx&#93;<br />        je      @@KMP_CONTINUE<br />        mov     ecx, &#91;ebx&#93;&#91;ecx*4&#93;<br />        jmp     @@INNER_KMP<br />        <br />    @@KMP_CONTINUE&#58;<br />        <br />        inc     eax<br />        inc     ecx<br />        jmp     @@KMP_SEARCH<br />            <br />    @@KMP_END&#58;<br />    <br />        pop     edx<br />        pop     edx<br />    <br />        cmp     ecx, edx<br />        jne     @@STRING_NOT_FOUND<br />        <br />        sub     eax, edx<br />        ret<br />        <br />    @@STRING_NOT_FOUND&#58;<br />    <br />        mov     eax, -1<br />        ret<br /><br />KMP ENDP<br />&#91;/size&#93;<br /><br /></code></pre><br />Hmm, seems like no one is objecting to the code. :) So this must be the real KMP. :)<br /><br />One question though: Is it slow to compare from the stack? I mean like cmp eax, DWORD PTR ...?</div>
    <div class="meta">Posted on 2002-03-09 23:07:06 by stryker</div>
   </div>
   <div class="post" id="post-28105">
    <div class="subject"><a href="#post-28105">The real KMP?</a></div>
    <div class="body"><strong>stryker</strong>, looks really good.  Notice how the preprocessing phase is like the search phase?  Here is the code I'm using for the preprocessing.  Maybe it can help in optimizing?<pre><code>;     char_x  -  pointer to string to find<br />;      int_m  -  length of string<br />; int_kmpNext - pointer to FSM buffer &#40;int_m * 4 bytes&#41;<br />preKMP MACRO char_x&#58;REQ, int_m&#58;REQ, int_kmpNext&#58;REQ<br />	LOCAL preLoop, _0, _1<br /><br />	xor int_i, int_i<br />	or DWORD PTR &#91;int_kmpNext&#93;, -1<br />preLoop&#58;<br />	mov int_j, &#91;int_kmpNext + int_i*4&#93;<br />	inc int_i<br />	inc int_j<br />	mov al, &#91;char_x + int_i - 1&#93;<br />	mov &#91;int_kmpNext + int_i*4&#93;, int_j<br />_0&#58;	dec int_j<br />	js _1<br />	cmp al, &#91;char_x + int_j&#93;<br />	je _1<br />	mov int_j, &#91;int_kmpNext + int_j*4&#93;<br />	inc int_j<br />	mov &#91;int_kmpNext + int_i*4&#93;, int_j<br />	jmp _0<br />_1&#58;	cmp int_i, int_m<br />	jne preLoop<br />ENDM</code></pre>The parameters to the macro are all registers:<pre><code>int_i TEXTEQU &lt;edx&gt; ; scratch registers<br />int_j TEXTEQU &lt;ecx&gt;<br /><br />preKMP esi, edi, ebx</code></pre></div>
    <div class="meta">Posted on 2002-03-09 23:36:59 by bitRAKE</div>
   </div>
   <div class="post" id="post-28106">
    <div class="subject"><a href="#post-28106">The real KMP?</a></div>
    <div class="body">Yeah, there are some similarities. Thanks for the code, I'll look into that macro.</div>
    <div class="meta">Posted on 2002-03-09 23:42:20 by stryker</div>
   </div>
   <div class="post" id="post-28598">
    <div class="subject"><a href="#post-28598">The real KMP?</a></div>
    <div class="body">Here's a proggy that performs the routine above.<br /><br />Controls:<br /><br />FIND - Always search at the first instance at the beginning of the string.<br />FIND NEXT - Continues to find the text what FIND has started.<br /><br />Place your search terms on the small edit box and the source string on the other.<br /><br />I'll leave more optimizations to those who wants to use it. I'll no longer be updating or optimizing this one because I have another project in mind.<br /><br />Yay!!! we now have an ASM version of the KMP algo. :)<br /><br />I'll release soon my own string search algo: ssrch :) -&gt; this is the naive algorithm with skipping inner iteration feature, this would solve the preprocessing stage problem of the BM and KMP.<br /><br /><br />BitRAKE,<br /><br />I wasn't able to look at your code closely, cause I was busy :)<br /><br /><br />run the .bat file to produce the exe :)</div>
    <div class="meta">Posted on 2002-03-12 12:02:44 by stryker</div>
   </div>
   <div class="post" id="post-28625">
    <div class="subject"><a href="#post-28625">The real KMP?</a></div>
    <div class="body">Ooops, I forgot the documentation. I'll just crudely paste this here. If it's OK for everybody. :)<br /><br /><pre><code><br />&#91;b&#93;Name Of Procedure&#58;&#91;/b&#93; KMP<br />&#91;b&#93;Parameters&#58;&#91;/b&#93;<br /><br />  StringSource - A pointer to a null terminated string<br />  SourceLength - length of the string source<br />  StringPattern - A pointer to a null terminated string<br />  PatternLength - length of the string pattern<br />  ShiftTable - A pointer to an array of dwords.<br /><br />&#91;b&#93;Note&#58;&#91;/b&#93;<br /><br />  ShiftTable is best suited to be a dynamically allocated<br />  dword size array. The number of bytes to allocate is<br />  calculated using this mathematical equation&#58;<br /><br />  # of bytes to allocate = &#40;PatternLength+1&#41;*4<br /><br />&#91;b&#93;Prototype&#58;&#91;/b&#93; KMP PROTO &#58;DWORD, &#58;DWORD, &#58;DWORD, &#58;DWORD, &#58;DWORD<br /><br />&#91;b&#93;Return Values&#58;&#91;/b&#93;<br /><br />  -1       String not found<br />  N &gt;= 0   Position of the string.<br /><br /></code></pre><br /><br /><br />I found a bug, just add this code after the @@BTN_FINDNEXT: label<br /><br /><pre><code><br />cmp     FlagFind, 0h<br />je      @@STRING_NOT_FOUND<br /></code></pre><br /><br />You'll get an error if you haven't had clicked the FIND button. This only happens if you haven't started a search yet. :) But it's no big deal, just small squirmy bugs...</div>
    <div class="meta">Posted on 2002-03-12 14:10:09 by stryker</div>
   </div>
  </div>
 </body>
</html>