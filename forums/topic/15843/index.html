<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>POP3, retrieving messages - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=15843" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=8">Networking</a> &raquo; <a href="../?id=15843">POP3, retrieving messages</a></p>
   <div class="post" id="post-122761">
    <div class="subject"><a href="#post-122761">POP3, retrieving messages</a></div>
    <div class="body">hi all,<br /> i'm getting a little trouble on getting messages trough POP3 protocol:<br /><br />Actually the way i'm retrieving messages is:<br /><br />1) AUTENTICATION<br />2) STAT -&gt; i get total size to do GLobalAlloc (total size)<br />3) RETR 1<br /><br />After RETR command, i perform a cycle to receive the entire message, block by block. I check on ev ery block the last 5 char, if they correspond to the termination octet CRLF.CRLF<br />But the problem is that i receive messages that are always greater then the value i get after RETR:<br /><br /><br /><pre><code><br /><br />RETR 1     +OK 2357  octets     2421<br />RETR 2     +OK 10992 octets     11298<br />RETR 3     +OK 699  octets     710<br /><br /></code></pre><br /><br />so i always get a value greater then the one i've estimated. In this way i go over the limit of memory i allocate getting exception in writing memory.<br /><br />I really appreciate any suggestion about the correct way to proceed on downloading.</div>
    <div class="meta">Posted on 2003-10-29 01:50:01 by Bit7</div>
   </div>
   <div class="post" id="post-122778">
    <div class="subject"><a href="#post-122778">POP3, retrieving messages</a></div>
    <div class="body">Show us your source, it's probably a silly assumption in your program.</div>
    <div class="meta">Posted on 2003-10-29 03:27:55 by Homer</div>
   </div>
   <div class="post" id="post-122811">
    <div class="subject"><a href="#post-122811">POP3, retrieving messages</a></div>
    <div class="body">thx evil, <br /><br />follow the routine that download messages<br /><br /><pre><code><br />; ?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?<br />proc		ReceiveMessages  uses    ebx esi edi, hDlg&#58;dword<br /><br />                LOCAL           BYTESTOREAD     &#58;DWORD<br /><br />		; &#40;00&#41; preparo message counter<br />		<br />                xor     ebx, ebx<br />                mov	edi, &#91;m_msgStartOffset&#93;<br /><br />  @@nextMsgDwn&#58; inc	ebx<br />  <br />  		; &#40;01&#41; update message number, preparo el &quot;RETR&quot; command &#40;retrieve&#41;<br /> 		<br /> 		call	WriteBinToEdit, &#91;hDlg&#93;, IDC_LOG_MD, ebx<br />		<br />                call    AngeloZeroMem, offset m_pop3_RETR + 5, 12<br />                call    _wsprintfA, offset m_pop3_RETR + 5, offset g_szFormat2, ebx<br />                add     esp, 12<br />                call	AppendCRLF, offset m_pop3_RETR<br /><br />                call	AngeloFindByte,  offset m_pop3_RETR, 0<br />                call    send, &#91;g_skt&#93;, offset m_pop3_RETR, ecx, NULL<br />                <br />                call	AngeloZeroMem, offset g_szTemporary, 32<br />                call    recv, &#91;g_skt&#93;, offset g_szTemporary, XD_NET_SIZETOREAD, NULL<br />                <br />                ; &#40;02&#41; ricevo e estrapolo el &quot;message size&quot;<br />                <br />                mov     esi, offset g_szTemporary<br />                add     esi, 4<br />                call    AngeloFindByte, esi, SD_VAL_SPACE<br />                <br />                call    AngeloStrToNum, esi, ecx<br />                mov     &#91;BYTESTOREAD&#93;, eax<br />                <br />                shl	eax, 16<br />                call	SendDlgItemMessageA, &#91;hDlg&#93;, IDC_LOG_PROGRESS1, PBM_SETRANGE, 0, eax<br />                <br />                call	SendDlgItemMessageA, &#91;hDlg&#93;, IDC_LOG_PROGRESS1, PBM_SETPOS, 0, 0<br />                <br />                ; &#40;03&#41; preparo e salvo el message header<br />                <br />                mov	eax, &#91;BYTESTOREAD&#93;<br />                mov	&#91;msgHdr.msgsize&#93;, eax<br />		mov	&#91;msgHdr.state&#93;, 'U'			<br />		call	AngeloCopyMem0, offset g_szInBox, offset msgHdr.folder<br /><br />                call	AngeloCopyMem, offset msgHdr, edi, size MSGHEADER<br />                add	edi, size MSGHEADER<br />                <br />                ; &#40;04&#41; scarigo el messaggio e lo metto in memoria<br />                <br />                call	WriteBinToEdit, &#91;hDlg&#93;, IDC_LOG_MBT, &#91;msgHdr.msgsize&#93;<br /><br />		xor	esi, esi<br />  @@nxtPart&#58;	call    recv, &#91;g_skt&#93;, edi, &#91;msgHdr.msgsize&#93;, NULL<br />  		add	edi, eax <br />  		add	esi, eax<br />  		<br />                ;  .. updating message progress<br />                <br />                call	WriteBinToEdit, &#91;hDlg&#93;, IDC_LOG_MBD, esi<br />                call	SendDlgItemMessageA, &#91;hDlg&#93;, IDC_LOG_PROGRESS1, PBM_SETPOS, esi, 0<br />                <br />                ; looking for &quot;CRLF.CRLF&quot;<br />                <br />  		mov	eax, edi<br />  		sub	eax, 5<br />  		call	AngeloCmpString, eax, offset m_szEOM, 5<br />  		cmp	ecx, 0<br />  		jne	@@nxtPart<br />                <br />  @@msgRcvd&#58;    ; &#40;05&#41; cancello o no ?<br />                <br />                cmp	&#91;g_delMsgFromServ&#93;, 1<br />                jne	@@goOnNext<br />                call    AngeloZeroMem, offset m_pop3_DELE + 5, 12<br />                call    _wsprintfA, offset m_pop3_DELE + 5, offset g_szFormat2, ebx<br />                add     esp, 12<br />                call	AppendCRLF, offset m_pop3_DELE<br />                <br />                call	AngeloFindByte, offset m_pop3_DELE, 0<br />                call    send, &#91;g_skt&#93;, offset m_pop3_DELE, ecx, NULL<br />                <br />                call    recv, &#91;g_skt&#93;, offset g_szTemporary, XD_NET_SIZETOREAD, NULL<br />                <br />                call	SendDlgItemMessageA, &#91;hDlg&#93;, IDC_LOG_PROGRESS2, PBM_SETPOS, ebx, 0<br />                <br />                ; &#40;06&#41; check for end of messages, and return<br />                <br /> @@goOnNext&#58;    cmp     ebx, &#91;dInfo.totMessages&#93;<br />                jl      @@nextMsgDwn<br /><br />                ret<br /><br />endp            ReceiveMessages<br /><br /></code></pre><br /><br />In these routine i receive the messages,<br /> by before colling this routin i allocate memory after a STAT command, once for all the messages<br /><br /><pre><code><br /><br />; &#40;2&#41; STAT   --- how many message to receive and total size...<br />                <br />                call	SendCommandAndLog, &#91;hRichEditLog&#93;, offset m_pop3_STAT, offset m_szSendingStat<br />                call	ReceiveAndLog, &#91;hDlg&#93;, &#91;hRichEditLog&#93;, &#91;recvBuff&#93;<br />                <br />                mov	esi, offset dInfo<br />                call	GetDownloadInfo, esi, &#91;recvBuff&#93;<br />                cmp	&#91;dInfo.totMessages&#93;, 0<br />                je	@@quit<br /><br />; ?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?<br />proc		PrepareMemoryForMessages<br />		 <br />                ; preparo lo spazio che me servi&#58; tot bytes to write + message headers<br />                <br />                mov	ecx, &#91;dInfo.totBytes&#93;<br />                mov	eax, size msgHdr<br />                add	eax, 35<br />                mov	ebx, &#91;dInfo.totMessages&#93;<br />                mul	ebx<br />                add	ecx, eax <br />                mov	&#91;m_newMessagesSize&#93;, ecx<br />                <br />                call	GlobalAlloc, GMEM_FIXED, &#91;m_newMessagesSize&#93;<br />                <br />                mov	&#91;m_msgStartOffset&#93;, eax<br /><br />		ret<br /><br />endp		PrepareMemoryForMessages<br /><br />; ?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?=?<br />proc		GetDownloadInfo	   uses esi, downloadInfo&#58;dword, statBuff&#58;dword<br /><br />		mov	ebx, &#91;downloadInfo&#93;<br /><br />		call	AngeloFindByte, &#91;statBuff&#93;, 32<br />		inc	ecx<br />		add	&#91;statBuff&#93;, ecx<br />		<br />		call	StatFindAndConvert, &#91;statBuff&#93;, SD_VAL_SPACE<br />		<br />		mov	&#91;&#40;DWNINFO ebx&#41;.totMessages&#93;, eax	<br />		<br />		inc	esi<br />		add	&#91;statBuff&#93;, esi<br />		call	StatFindAndConvert, &#91;statBuff&#93;, 0Dh<br />		<br />		mov	&#91;&#40;DWNINFO ebx&#41;.totBytes&#93;, eax	<br /><br />		ret<br />		<br />endp		GetDownloadInfo<br /><br /></code></pre><br /><br />Hope you'll understand my method.<br />Thanks  B7</div>
    <div class="meta">Posted on 2003-10-29 12:45:22 by Bit7</div>
   </div>
   <div class="post" id="post-122874">
    <div class="subject"><a href="#post-122874">POP3, retrieving messages</a></div>
    <div class="body">anyway, i've read some posts on various forums:<br />Th issue seems to be that the size of every message i receive from the pop3 server after a RETR command is always wrong:<br /><br /><pre><code><br />RETR 1  +OK 12090 octets  i get 12424<br />RETR 2  + OK 6679  octrts  i get 6857<br />RETR 3  + OK 24335 octets  i get 25043 <br /> </code></pre><br /><br />An article i've found says, to be sure to have enough space, to allocate always 1500bytes more than the size initially received.<br />So, for this reason propably is better i allocate memory before every message, then receiving, saving on file and free memory (now i was allocating all the messages total space).</div>
    <div class="meta">Posted on 2003-10-30 01:21:02 by Bit7</div>
   </div>
   <div class="post" id="post-123037">
    <div class="subject"><a href="#post-123037">POP3, retrieving messages</a></div>
    <div class="body">Hello, you really should not make assumptions - always check return values from api functions !!<br /><br />For example, here's what micro$oft have to say about calling RECV...<br /><br />Return Values<br />If no error occurs, recv returns the number of bytes received. If the connection has been gracefully closed, the return value is zero. Otherwise, a value of SOCKET_ERROR is returned, and a specific error code can be retrieved by calling WSAGetLastError.<br /><br />Even though you told it to receive N bytes, it could return a different amount, and it is the actual amount you are interested in, not the perceived amount...<br />A suggestion here is to always call ioctlsocket,hSock,FIONREAD,addr cbRead<br />before you call RECV - this will return the actual #bytes that are waiting in the network stack to be read - then hand the value in cbRead now to RECV - much safer !!<br /><br /><br />In conclusion, I suggest that you should ALWAYS check return values of api functions and never blindly assume anything...<br /><br />Have a nice day :)</div>
    <div class="meta">Posted on 2003-10-31 07:52:26 by Homer</div>
   </div>
   <div class="post" id="post-123120">
    <div class="subject"><a href="#post-123120">POP3, retrieving messages</a></div>
    <div class="body">thanks again evil,<br /><br />the ioctlsocket function should be very useful, i could allocate space for every block i receive and save it directly to file. It's just an idea. Anyway i really would like the relation between octest declared from POP3 and the greater size that i receive... i've read RFC, it says that on multiline response it append a CRLF at the end of every line. Could it be the CRLF's that increment the size ?</div>
    <div class="meta">Posted on 2003-11-01 03:45:48 by Bit7</div>
   </div>
   <div class="post" id="post-123265">
    <div class="subject"><a href="#post-123265">POP3, retrieving messages</a></div>
    <div class="body">I can't give you a definitive answer for why the packet sizes are larger than the purported payload, but that sounds very likely to me.<br />Yes, I use ioctlsocket in the way you describe - I allocate the block after calling ioctlsocket, read into the allocated block, and then generally I keep a list of pointers to allocated blocks, and create another thread whose ONLY job is to process and then release the blocks in the same order they are encountered.<br />This is called a &quot;forked receiver&quot;, but it's just one possible way to do it.<br />Have fun, play around with a few different ideas, see what works best for you in your situation, experiment, and if it's not fun, don't do it !! :)</div>
    <div class="meta">Posted on 2003-11-02 17:52:00 by Homer</div>
   </div>
   <div class="post" id="post-123384">
    <div class="subject"><a href="#post-123384">POP3, retrieving messages</a></div>
    <div class="body">thanks again,<br /><br />yes the dynamic allocation method seems the most correct... for now i leave the 1500bytes more allocation for every message, seems wark fine now, just to test the rest of the program.<br /><br />Thx B7</div>
    <div class="meta">Posted on 2003-11-04 02:22:26 by Bit7</div>
   </div>
   <div class="post" id="post-123749">
    <div class="subject"><a href="#post-123749">POP3, retrieving messages</a></div>
    <div class="body">actually i've improoved the easiest and hope safest solution.. also if not the best one:<br /><br />I allocate for every message the POP3 declared size * 2<br /><br />These becouse the server seems don't count CRLF as 2 chars, but as one, so if i have a message completely just full of CRLF i should receive it correctly... i will try :)</div>
    <div class="meta">Posted on 2003-11-07 16:16:50 by Bit7</div>
   </div>
  </div>
 </body>
</html>