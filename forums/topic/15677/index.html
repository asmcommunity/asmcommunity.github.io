<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>dd7 - mouse runs sluggish - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=15677" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=10">Graphics &amp; Game Development</a> &raquo; <a href="../?id=15677">dd7 - mouse runs sluggish</a></p>
   <div class="post" id="post-121500">
    <div class="subject"><a href="#post-121500">dd7 - mouse runs sluggish</a></div>
    <div class="body">hello,<br /><br />here you can find a game I'm working on (i disabled the game actually, the menu screen is the only important thing atm):  (~500kb)<br /><br /><a target="_blank" href="http://www.uni-koblenz.de/~tenshi/nopsnake.zip">http://www.uni-koblenz.de/~tenshi/nopsnake.zip</a> <br /><br />1. a friend of mine has no TFT, that means a s?mple monitor. he says the background (the brown one) is distorted at the left and right border in the middle. i'm not sure if this is a monitor problem or a problem with my application. would be nice if you could report anything weird in the menu screen. <br /><br />2. hiroshimator pointed me on the mouse running sluggish. it's true, if you move the mouse a bit too fast it jumps and isn't shown fluently. i don't know where the problem is, here's the mouse code:<br /><br />initialisation:<br /><pre><code><br />DIINVOKE CreateDevice, lpdi, ADDR GUID_SysMouse, ADDR lpdimouse, 0<br />    .if eax!=DI_OK<br />        FATAL &quot;DI&#58; Creating mouse device failed!&quot;<br />    .endif<br />    DIDEVINVOKE SetCooperativeLevel, lpdimouse, hWin,DISCL_NONEXCLUSIVE or DISCL_BACKGROUND<br />    .if eax!=DI_OK<br />        FATAL &quot;DI&#58; SetCooperativeLevel &#40;MOUSE&#41; failed!&quot;<br />    .endif<br />    DIDEVINVOKE SetDataFormat, lpdimouse, ADDR c_dfDIMouse<br />    .if eax!=DI_OK<br />        FATAL &quot;DI&#58; SetDataFormat &#40;MOUSE&#41; failed!&quot;<br />    .endif<br />    ;-----------------------------------------------------------<br />    ;set axis data to relative/absolute<br />    ;-------------------------------------------<br />    mov my_DIPROPDWORD.diph.dwSize,sizeof&#40;DIPROPDWORD&#41;<br />    mov my_DIPROPDWORD.diph.dwHeaderSize,sizeof&#40;DIPROPHEADER&#41;<br />    mov my_DIPROPDWORD.diph.dwObj,0<br />    mov my_DIPROPDWORD.diph.dwHow,DIPH_DEVICE<br />    mov my_DIPROPDWORD.dwData,DIPROPAXISMODE_REL<br />    DIDEVINVOKE SetProperty,lpdimouse,DIPROP_AXISMODE,addr my_DIPROPDWORD.diph<br />    .if eax!=DI_OK<br />        FATAL &quot;Property could not be set!&quot;<br />    .endif<br />    DIDEVINVOKE Acquire, lpdimouse<br />    .if eax!=DI_OK<br />        FATAL &quot;DI&#58;Acquire mouse failed!&quot;<br />    .endif<br /></code></pre><br /><br />reading mouse data:<br /><pre><code><br />ReadMouse proc<br />    .if lpdimouse!= NULL<br />        DIDEVINVOKE GetDeviceState,lpdimouse,sizeof&#40;DIMOUSESTATE&#41;,addr mouse_state<br />        .if eax!=DI_OK<br />            FATAL &quot;Could not read mouse!&quot;<br />        .endif<br />        mov eax,mouse_state.lX<br />        add mp.x,eax<br />        mov eax,mouse_state.lY<br />        add mp.y,eax<br />            .else<br />        DIINITSTRUCT ADDR mouse_state,sizeof&#40;DIMOUSESTATE&#41;<br />    .endif<br />    ret<br />ReadMouse endp<br /></code></pre><br /><br />my messageloop:<br /><pre><code><br />    StartLoop&#58;<br />      cmp app_flag,1<br />      jne _nonactive<br />      <br />      invoke PeekMessage, addr msg, NULL, 0, 0, PM_REMOVE <br />            and eax, eax <br />            jz IdleTime <br />            cmp &#91;msg.message&#93;, WM_QUIT <br />            je ExitLoop <br />            invoke TranslateMessage, ADDR msg <br />            invoke DispatchMessage, ADDR msg <br />            jmp StartLoop <br /><br />IdleTime&#58; <br />            .if gameruns==0<br />                .if gameoverf==1<br />                    mov gameovermode,1<br />                    <br />                    invoke CheckForHighscore<br />                    mcall &#91;dds_back&#93;,IDirectDrawSurface7_GetDC,addr backdc<br />                    invoke SelectObject, backdc, fonthandle2<br />                    mov oldfont,eax<br />                    invoke SetTextColor,backdc,000000h<br />                    RGB 0CCh,0CCh,0CCh<br />                    invoke SetBkColor,backdc,eax<br />                    invoke SetBkMode,backdc,OPAQUE      ;TRANSPARENT<br />                    invoke DrawMyText,addr gameovermsg,225,190<br />                    invoke SetTextColor,backdc,000000h<br />                    invoke DrawMyText,addr gameover2,210,215<br />                    invoke SelectObject,backdc,oldfont<br />                    mcall &#91;dds_back&#93;,IDirectDrawSurface7_ReleaseDC,backdc<br />                    invoke UpdateScreen<br />                    mov gameoverf,0<br />                .endif<br />              <br />                invoke ReadKeyboard<br />                .if keyboard_state&#91;DIK_DOWN&#93;<br />                    mov key_old,DIK_DOWN<br />                    ;invoke RepaintScreen<br />                    mov app_flag,0<br />                    invoke StartNewGame<br />                    mov gameruns,1<br />                .endif<br />                ;--- actually not needed??!!! -----<br />                .if repainted==0<br />                    invoke RepaintScreen<br />                    mov repainted,1<br />                .endif<br />            .endif<br />           <br />           invoke snakemainproc<br />           jmp StartLoop <br /><br />_nonactive&#58;<br />     <br />        &#91;b&#93;invoke ReadMouse&#91;/b&#93;<br />        .if menuid==MENU_MAIN<br />            invoke RepaintMenu<br />        .elseif menuid==MENU_OPTIONS<br />            invoke RepaintOptions<br />        .elseif menuid == MENU_HIGHSCORE<br />            invoke RepaintHighscore<br />        .elseif menuid == MENU_INSTRUCT<br />            invoke RepaintInstruct<br />        .elseif menuid == MENU_CREDITS<br />            invoke RepaintCredits<br />        .elseif menuid == MENU_NETGAME<br />            invoke RepaintNetgame<br />        .endif<br /><br />       <br /><br />       invoke GetMessage,ADDR msg,NULL,0,0 <br />            and eax, eax <br />            jz ExitLoop <br />            invoke TranslateMessage, ADDR msg <br />            invoke DispatchMessage, ADDR msg <br />            jmp StartLoop <br />ExitLoop&#58;<br /></code></pre><br /><br />mouse cursor drawing in the menu loop procedure:<br /><pre><code><br />invoke BlitBitmap,mp.x,mp.y,0,0,0,0,offset surface_mycursorsprite,offset bmp_mycursorsprite_info,0FFFFFFh,1<br />invoke UpdateScreen<br /></code></pre><br /><br />i really have no idea where the problem is, perhaps it's the message loop? <br /><br />thank you! <br /><br />  NOP</div>
    <div class="meta">Posted on 2003-10-16 15:42:34 by NOP-erator</div>
   </div>
   <div class="post" id="post-121503">
    <div class="subject"><a href="#post-121503">dd7 - mouse runs sluggish</a></div>
    <div class="body">Your friends monitor sounds like it may have a pin cushion problem, you can usually find an adjustment labelled PCC either in back or on the PCB for the monitor (usually near the flyback) it will allow you to adjust the pin cushioning.</div>
    <div class="meta">Posted on 2003-10-16 18:10:22 by donkey</div>
   </div>
   <div class="post" id="post-121504">
    <div class="subject"><a href="#post-121504">dd7 - mouse runs sluggish</a></div>
    <div class="body">Hi <br /><br />You could try to read the mouse <strong>buffered</strong>to avoid losing mouse moves.<br /><br />Eugen</div>
    <div class="meta">Posted on 2003-10-16 18:25:11 by Eugen</div>
   </div>
   <div class="post" id="post-121521">
    <div class="subject"><a href="#post-121521">dd7 - mouse runs sluggish</a></div>
    <div class="body">i already guessed it's a message loop problem!!  from the beginning i wondered about the weird structure, i changed it to that now, and it works fine:<br /><br /><pre><code><br />    StartLoop&#58;<br />      <br />      <br />      invoke PeekMessage, addr msg, NULL, 0, 0, PM_REMOVE <br />            and eax, eax <br />            jz IdleTime <br />            cmp &#91;msg.message&#93;, WM_QUIT <br />            je ExitLoop <br />            invoke TranslateMessage, ADDR msg <br />            invoke DispatchMessage, ADDR msg <br />            jmp StartLoop <br /><br />IdleTime&#58; <br />        cmp app_flag,1<br />        jne _nonactive<br />            .if gameruns==0<br />                .if gameoverf==1<br />                    mov gameovermode,1<br />                    <br />                    invoke CheckForHighscore<br />                    mcall &#91;dds_back&#93;,IDirectDrawSurface7_GetDC,addr backdc<br />                    invoke SelectObject, backdc, fonthandle2<br />                    mov oldfont,eax<br />                    invoke SetTextColor,backdc,000000h<br />                    RGB 0CCh,0CCh,0CCh<br />                    invoke SetBkColor,backdc,eax<br />                    invoke SetBkMode,backdc,OPAQUE      ;TRANSPARENT<br />                    invoke DrawMyText,addr gameovermsg,225,190<br />                    invoke SetTextColor,backdc,000000h<br />                    invoke DrawMyText,addr gameover2,210,215<br />                    invoke SelectObject,backdc,oldfont<br />                    mcall &#91;dds_back&#93;,IDirectDrawSurface7_ReleaseDC,backdc<br />                    invoke UpdateScreen<br />                    mov gameoverf,0<br />                .endif<br />              <br />                invoke ReadKeyboard<br />                .if keyboard_state&#91;DIK_DOWN&#93;<br />                    mov key_old,DIK_DOWN<br />                    ;invoke RepaintScreen<br />                    mov app_flag,0<br />                    invoke StartNewGame<br />                    mov gameruns,1<br />                .endif<br />                ;--- actually not needed??!!! -----<br />                .if repainted==0<br />                    invoke RepaintScreen<br />                    mov repainted,1<br />                .endif<br />            .endif<br />           <br />           invoke snakemainproc<br />           jmp StartLoop <br /><br />_nonactive&#58;<br />     <br />        invoke ReadMouse<br />        .if menuid==MENU_MAIN<br />            invoke RepaintMenu<br />        .elseif menuid==MENU_OPTIONS<br />            invoke RepaintOptions<br />        .elseif menuid == MENU_HIGHSCORE<br />            invoke RepaintHighscore<br />        .elseif menuid == MENU_INSTRUCT<br />            invoke RepaintInstruct<br />        .elseif menuid == MENU_CREDITS<br />            invoke RepaintCredits<br />        .elseif menuid == MENU_NETGAME<br />            invoke RepaintNetgame<br />        .endif<br />        jmp StartLoop<br /><br />       comment ~<br /><br />       invoke GetMessage,ADDR msg,NULL,0,0 <br />            and eax, eax <br />            jz ExitLoop <br />            invoke TranslateMessage, ADDR msg <br />            invoke DispatchMessage, ADDR msg <br />            jmp StartLoop <br />            ~<br />ExitLoop&#58;<br /><br />      return msg.wParam<br /><br /></code></pre></div>
    <div class="meta">Posted on 2003-10-17 01:43:25 by NOP-erator</div>
   </div>
   <div class="post" id="post-121619">
    <div class="subject"><a href="#post-121619">dd7 - mouse runs sluggish</a></div>
    <div class="body">You could probably lose the secondary MessagePeek, Translate and Dispatch and just jump backwards to the beginning of your MessagePump...</div>
    <div class="meta">Posted on 2003-10-18 00:10:52 by Homer</div>
   </div>
  </div>
 </body>
</html>