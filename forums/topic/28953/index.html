<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>assembly code for an ignition system - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=28953" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=28953">assembly code for an ignition system</a></p>
   <div class="post" id="post-204716">
    <div class="subject"><a href="#post-204716">assembly code for an ignition system</a></div>
    <div class="body">Hi everyone,<br /><br />&nbsp; &nbsp;  I want to write a software on an ignition system for a 125cc four stroke engine.The purpose of my program is to produce a variable time delay for spark to occur in the ignition system. As the engine starts, pulses from the alternator assembly via the pulser coil(positioned at 36degree BTDC) will be collected. The time from the 1st and 2nd pulse will determined the speed of the engine. By using the speed of the engine, the program will call a suitable delay value for spark to occur. This means that spark will only be produce after the 2nd pulse and one spark is wasted.<br /><br />&nbsp; &nbsp;  Its been 2 weeks since ive started the project, learning about the ignition system and how to program a PIC using c or assembly. Ive decided to program PIC16F84 with Wiz-C by using assembly language because it is quite easy to understand. So far i was able to do simple task such as flashing LED with a push button.<br /><br /><br />*** some back ground on the ignition system<br />Ideally a mixture of air and fuel needs to be burn exactly at the top dead centre(TDC) of the combustion chamber. In reality, a fixed quantity of air and fuel needs a particular time to combust. Although this can be solve by allowing the spark to occur before TDC say at 36 degrees before TDC, the engine however have a range of operating speed. Thus there needs to be a&nbsp; variable delay system(depends on the speed of the engine) where combustion occur before TDC.&nbsp;  <br /><br />*** Information about my program<br /><br />Assume that the engine can run up to 8000rpm.<br />At engine speed of 1200 RPM;<br /><br />1200 / 60 = 20 revs per second<br />1 / 20 = 50mS per rev<br /> 1 rev = 360 degrees<br /><br />36 degrees at 1200 RPM = (36 / 360) X 50 = 5mS<br /><br />So&nbsp; at max rpm, delay = 0. <br />&nbsp; &nbsp;  at min rpm( 0-1200rpm), delay should be lower than 5mS say 4mS<br /><br />The program have 8 set of delay values.<br />8000rpm= 0mS<br />7000rpm=0.5mS<br />6000rpm=1mS<br />5000rpm=0.5mS<br />4000rpm=2mS<br />3000rpm=2.5mS<br />2000rpm=3mS<br />1200rpm or lower =fixed at 4mS<br /><br /><br />&nbsp; &nbsp; &nbsp;  I came across a website that has an assembly code which is similar to the one that i want. I cant really follow the logic of the code and was wondering if someone can give me a simple example plus explanation on how to use timers to calculate rpm and use data tables to retrieve corresponding delay output using assembly language. I know this is too much but i really appreciate all the help that i can get.<br /><br /><span class="text-left"></span><br /> <br /><a target="_blank" href="http://&quot;www.transmic.net&quot;">www.transmic.net</a><br /></div>
    <div class="meta">Posted on 2008-02-05 20:16:17 by eddy123456</div>
   </div>
   <div class="post" id="post-204731">
    <div class="subject"><a href="#post-204731">Re: assembly code for an ignition system</a></div>
    <div class="body">This will all depend on what chipset you use with which modules. They should offer documentation with whatever ecu you use. Megasquirt would be *the* way to go IMHO. http://www.megasquirt.info/ they have a whole forum section where you can discuss this. Since this is more firmware, it may have better results if a mod moved it to the low level section, but the megasquirt forum would be the best place to start.</div>
    <div class="meta">Posted on 2008-02-06 22:31:14 by jakor</div>
   </div>
   <div class="post" id="post-204749">
    <div class="subject"><a href="#post-204749">Re: assembly code for an ignition system</a></div>
    <div class="body">The 16F84 is quite limited, so the author of that ignition system had to inline everything and he chose not use interrupts (because he&#039;d have to do silly things to get a 16-bit timer out of the clobbered single 8-bit timer). <br /><br />Could you explain why at 8000rpm the delay is 0ms? And why do you divide by 10 (I know, 36 degrees,.. but the timing...). <br /><br />Actually, like in the image I&#039;ve attached, could you graphically represent:<br />*assuming that when the rotor rotates, the angle increases, like in 0 degrees, 1 degrees, 2 degrees, 3 degrees.... 359 degrees, 0 degrees,...&quot;<br />- when the rotor is at 0 degrees<br />- when the 36-degree (or is it -36 degrees? ) signal is pulsed. <br />- when we must spark. <br />- when we must stop the spark<br /><br />I&#039;m eager to help, it&#039;s just that I don&#039;t know the timing. (no time to research :P )<br />I have much more experience with the newer PICs, that cost just as much - yet have much more facilities (internal 16-bit timers, robust interrupts, 10x faster). But I think I can help with writing the code for that F84, or at least outlining what should be written. <br /><br />Btw, using only 8 values of delay is quite limiting and probably will waste fuel, right? It&#039;s just as easy to implement ~200 values of delay, imho. </div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=2546" target="_blank">rpm1.png</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2008-02-08 11:53:02 by Ultrano</div>
   </div>
   <div class="post" id="post-204760">
    <div class="subject"><a href="#post-204760">Re: assembly code for an ignition system</a></div>
    <div class="body">Im glad you guys replied because i am still stuck with the programming stuff.<br /><br />1) Jakor, im planning to write a program and build a basic electronic ignition system of a small motorcycle engine(no ecu, just a CDI) by using PIC16f84. Megasquirt seems too complicated for me. <br /><br />2) Ultrano, the image that i uploaded basically sums up what im trying to do.<br /><br />Assuming that the engine is constantly running at 1000RPM, pulses from pulser coil is collected.The time between each pulse is:<br /><br />1000RPM = 1000/60 = 16.667 Revolution per seconds<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  1/16.67=0.06S=60mS<br /><br />The pulser coil is located at 36 degree before TDC and it moving anticlockwise (towards TDC:36,35,34...........2,1,0,359,358.....38,37,36), Maximum Delay for spark from the moment pulse is collected must not exceed :<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  60m*(36)/360&nbsp; &nbsp; =&nbsp;  6mS <br /> <br />So basically there will be a range of delays from 0 to &lt;6mS. Note that,if there is no ignition control then the position of pulser coil is fixed at maximum (36 degree BTDC, not optimised for whole range of speed, only good for higher RPM.typically at low RPM &lt;1000, spark will occur at 10degree before TDC). <br /><br /><br /><br />***i need to correct something about my last post.I just realize that the spark will only occur after/at the instant the third pulses have been collected( only at the power/compression stroke,not the exhaust/intake stroke). Ive looked through Transmic and i am not sure if the program actually sends spark everytime the piston is near TDC.&nbsp;  <br /><br />The program that im working on will:<br />-Calculate RPM and find a suitable delay values.<br />-No delay at high RPM,spark will occur at 36 degree BTDC<br />-Fixed delay for RPM lower than 1000, say at 10 degree.<br />-Spark occur for a limited amount of time,1mS<br /><br /><br /><br />As i said before, im a noob in PIC programming, thats the real reason why im using PIC16F84(theres a lot of resources,tutorials available). Youre right about the tables,i did 8 values of delay just because i want things to be simple at first and move on with other complicated stuff(i hope). So far, ive learned how to use call table instruction(example : 8 LEDs that flashes from side to side) but im not sure about rpm calc..&nbsp; <br /><br /></div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=2551" target="_blank">kjhkhhjk.PNG</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2008-02-10 02:11:54 by eddy123456</div>
   </div>
   <div class="post" id="post-204762">
    <div class="subject"><a href="#post-204762">Re: assembly code for an ignition system</a></div>
    <div class="body">Do you think the following HLL outline will work? Especially about CurPhase, I don&#039;t see a way to determine which phase the engine is in. <br /><br /><pre><code><br />// Assume 8MHz clock, so 2 million instructions per second<br /><br /><br />#define TICK_CYCLES 20 // how many cycles the &quot;tick&quot; loop takes, including the branching<br /><br />/*	<br />	1 tick = 10us,&nbsp; 100 ticks=1ms<br />	1000 RPM = 60ms per revolution	= 6000 ticks<br />	2000 RPM = 30ms per revolution	= 3000 ticks<br />	4000 RPM = 15ms per revolution&nbsp; = 1500 ticks<br />	8000 RPM = 7.5ms per revolution =&nbsp; 750 ticks<br />*/<br /><br /><br /><br />unsigned short TimeBetweenCoilPulses = 0xFFFF;<br /><br />unsigned short CurTickCount=0;<br />unsigned short PrevTickCount=0x8000;<br /><br />unsigned short Time_TillSpark=0;<br />unsigned short Time_TillUnspark=0;<br /><br /><br />void ON_RB0_INTERRUPT(){	<br />	TimeBetweenCoilPulses = CurTickCount-PrevTickCount;<br />	PrevTickCount = CurTickCount;<br />	_outSparkPin = 0;<br />	<br />	static byte CurPhase=0; // how do we KNOW when we&#039;re being pulsed about which phase?! In 50% of the startups, we&#039;d be out of phase!<br />	CurPhase++;<br />	if(!(CurPhase&amp;1))return;<br />	<br />	<br />	<br />	if(TimeBetweenCoilPulses&lt;=750){ // 8000+ RPM<br />		Time_TillSpark = 0;<br />		_outSparkPin = 1;<br />	}else if(TimeBetweenCoilPulses&gt;6000){ // less than 1000 RPM<br />		Time_TillSpark = 525;<br />	}else{ // 1000-8000 RPM, TimeBetwCP is [750;6000]<br />		Time_TillSpark = TimeBetweenCoilPulses/10 - 75;<br />	}<br />	Time_TillUnspark = Time_TillSpark+100;<br />	<br />}<br /><br /><br /><br />void main(){<br />	SetupInterrupt();<br />	_outSparkPin = 0;<br />	<br />	for(;;){ //--------[ this is the &quot;tick&quot; loop ! ]--------[<br />		DisableGlobalInterrupt();<br />		if(Time_TillSpark){<br />			Time_TillSpark--;<br />			if(Time_TillSpark==0) _outSparkPin = 1;<br />		}<br />		if(Time_TillUnspark){<br />			Time_TillUnspark--;<br />			if(Time_TillUnspark==0) _outSparkPin = 0;<br />		}<br />		EnableGlobalInterrupt();<br />		NOP; // filler-in. If an interrupt happened in the last ~20 cycles, we&#039;ll be interrupted now<br />		<br />		<br />		CurTickCount++;<br />	}<br />	//-------------------------------------------------------/<br />}<br /></code></pre></div>
    <div class="meta">Posted on 2008-02-10 04:30:11 by Ultrano</div>
   </div>
   <div class="post" id="post-204776">
    <div class="subject"><a href="#post-204776">Re: assembly code for an ignition system</a></div>
    <div class="body">Im sorry about the last post, it was really confusing. I misunderstood the concept of &quot;wasted spark&quot;. I thought it was mainly about wasting the 1st spark(which corresponds to the 1st pulse) in order to calculate RPM as you start up the engine (i need to give it a new name, &quot;nofirstsparkwhenyoustart&quot;&nbsp; :lol:). since theres no way you can calculate RPM using only the first pulse. The actual concept of &#039;&#039;wasted spark&#039;&#039; refers to the spark which occurs at exhaust/intake stroke(rather than than compression/power, this happens when we provide spark at every pulse which solves the phase problem). This &quot;wasted spark&quot; is use to burn excess fuel.<br /> <br />Thanks a lot for the hll code, i am not familiar with the codings but ill try to learn it this week but I guess the CurPhase can be neglected? <br /></div>
    <div class="meta">Posted on 2008-02-11 09:37:33 by eddy123456</div>
   </div>
   <div class="post" id="post-204778">
    <div class="subject"><a href="#post-204778">Re: assembly code for an ignition system</a></div>
    <div class="body">:shock:<br /><br />Wouldn&#039;t you simply get pinking or detonation?<br /><br />Maybe a two-stroke would be a safer bet....at least to start with.</div>
    <div class="meta">Posted on 2008-02-11 19:53:30 by eek</div>
   </div>
   <div class="post" id="post-204779">
    <div class="subject"><a href="#post-204779">Re: assembly code for an ignition system</a></div>
    <div class="body">Your distributer should already have all these gadgets, except nowadays its put together in an <strong>electronic</strong> ignition system that uses sensors.<br /><br /><br />The distributor also houses the centrifugal advance unit: a set of hinged weights attached to the distributor shaft, that cause the breaker points mounting plate to slightly rotate and advance the spark timing with higher engine rpm. In addition, the distributor has a vacuum advance unit that advances the timing even further as a function of the vacuum in the inlet manifold. Usually there is also a capacitor attached to the distributor. The capacitor is connected parallel to the breaker points, to suppress sparking and prevent wear of the points.<br />http://en.wikipedia.org/wiki/Distributor<br /><br /><br />Anyway. Best of luck.<br /><br /><br />------------------------------------------------<br />Plus you need to take account of the engine load, not simply the speed, which is done via the inlet manifold vacuum pressure.<br /><br />Torque <br /><br />Torque is the ability of the engine to continue to twist (rotate) the rear wheel with great force. Torque has nothing to do with speed. Maximum torque is not to be found at the highest revs but somewhere below that - perhaps as much as 25%. Because lower revs are involved, the rear wheel is less inclined to spin and loose traction - an important issue when riding your bike up a steep gravel road.<br /><br />Horsepower <br /><br />Horsepower is the ability of your engine to move your bike forward at a certain speed - the higher the speed, the shorter the time taken, the greater the horsepower needed.<br />Every engine has its own characteristics of torque and horsepower - something you as the rider can only learn with experience and hopefully, not too much trial and error! In the example specs given below the engine develops the most torque at 4000 rpm before it starts to drop again. By contrast the horsepower available increases steadily all the way to 5000 rpm.<br /><br />http://www.flamesonmytank.co.za/Articles/torque.htm</div>
    <div class="meta">Posted on 2008-02-11 20:14:23 by eek</div>
   </div>
   <div class="post" id="post-204780">
    <div class="subject"><a href="#post-204780">Re: assembly code for an ignition system</a></div>
    <div class="body">What Happens When the Timing Is Advanced&nbsp; :shock:<br /><br />http://www.miata.net/garage/KnowYourCar/S10_Timing.html</div>
    <div class="meta">Posted on 2008-02-11 21:12:04 by eek</div>
   </div>
   <div class="post" id="post-204781">
    <div class="subject"><a href="#post-204781">Re: assembly code for an ignition system</a></div>
    <div class="body">hehe<br />The whole ballgame must be different for a 125 single.<br /><br />If the pulser is fixed at 36 degrees BTDC then that would destroy an ordinary engine, which needs about 10 degrees at lower revs.<br /><br />And yet a standard 125 can idle with a fixed BTDC of 36 degrees.... :shock:</div>
    <div class="meta">Posted on 2008-02-11 21:40:18 by eek</div>
   </div>
   <div class="post" id="post-204782">
    <div class="subject"><a href="#post-204782">Re: assembly code for an ignition system</a></div>
    <div class="body">Hi eek,<br /><br />From what ive read (googled wasted spark), wasted spark wont lead to detonation and pinging since in exhaust stroke, air and fuel is not compressed but the extra spark lowers the lifespan of the spark plug(but i stand to be corrected).The engine that im working on uses CDI type of ignition, where in lower revs sparks occur 13 degree BTDC, 38 degree at Higher RPM. The main purpose of what im doing is to emulate this system by using PIC, so that if i want to use a fuel with higher octane, i can just pug in the timing curve (if it is provided).</div>
    <div class="meta">Posted on 2008-02-11 23:13:30 by eddy123456</div>
   </div>
   <div class="post" id="post-204785">
    <div class="subject"><a href="#post-204785">Re: assembly code for an ignition system</a></div>
    <div class="body">At 36 dbtdc, ur asking for a broken crank, I rebuild veteran single cylinder engines, 36 is too much even for a lightweight single piston engine, your crank ends up doing all the work not absorbed by the con rod.<br />Sure, it CAN idle at 36, but SHOULD it?<br />Luckily for me, the engines I work on support manual advance and retard, so changing the timing is easy, and I have control...</div>
    <div class="meta">Posted on 2008-02-12 03:00:37 by Homer</div>
   </div>
   <div class="post" id="post-204786">
    <div class="subject"><a href="#post-204786">Re: assembly code for an ignition system</a></div>
    <div class="body">Your wasted spark is fine.<br />I used to have a 2CV 652cc with electronic ignition, which was a flat twin and a sensor on the flywheel would set off the coil and it would ignite one on the power cycle while the opposite cylinder was on the exhaust stroke, which saved bothering with a distributer.<br /><br />--------------------------------------<br />Visa Special - Club (two cylinder) 1978-1988<br /><br />From the start in September 1978 until the end in 1988, the Visa was available with a two cylinder aircooled engine. This engine is similar to the engines which have been used on other two-cylinder Citroën models (like the 2CV) for many years. The principal differences are that its capacity has been increased to 652cc and that it is equipped with an electronic ignition system, controlled by a computer.<br />The Club is the more luxurious model of the two with some extras like adjustable seats, parcel shelf, side overriding strips, a grille with chrome accents and stainless steel wheel covers. The two cylinder models do not have a rear spoiler.<br />http://www.citroenvisa.net/visa3.htm<br />----------------------------------------------------<br /><br />The computer was for timing advance and engine loading purposes.<br /><br />What I find unusual about your wee 125 is it seems to NOT have any timing advance system as standard.<br /><br />From these 125cc examples it looks like about 20 degrees BTDC is the norm.<br /><br />http://www.jmp.fi/dmcs/English.htm<br /><br /></div>
    <div class="meta">Posted on 2008-02-12 05:05:14 by eek</div>
   </div>
   <div class="post" id="post-204787">
    <div class="subject"><a href="#post-204787">Re: assembly code for an ignition system</a></div>
    <div class="body">oops...missed your 13/36 post sorry.<br /><br />Higher octane fuel will help you take advantage of anything you can write yourself, I see what you&#039;re aiming for here, because higher octane fuel is more timing predictable.<br /><br />Okay. I&#039;ll leave you in the hands of the ASM experts.<br /><br />Good luck dude.<br /></div>
    <div class="meta">Posted on 2008-02-12 05:12:44 by eek</div>
   </div>
  </div>
 </body>
</html>