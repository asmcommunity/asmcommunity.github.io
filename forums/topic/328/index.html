<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>StrLen proc. need help - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=328" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=328">StrLen proc. need help</a></p>
   <div class="post" id="post-1787">
    <div class="subject"><a href="#post-1787">StrLen proc. need help</a></div>
    <div class="body"><pre><code><br />  .386<br />  .model  flat, stdcall<br />   option casemap&#58;none<br /><br />  .data<br />   target db &quot;DISEASE&quot;, 0<br />   ;              ^<br /><br />  .code<br />   start&#58;<br />    lea   esi, target<br />    xor   ecx, ecx<br />    xor   ebx, ebx<br /><br />  @@&#58;<br />    mov   eax, &#91;esi&#93;<br />    test  al, al<br />    je    @F<br />    add   esi, 4<br />    inc   ecx<br />    jmp   @B<br /> @@&#58;<br />    mov   eax, &#91;esi-4&#93;<br />    rol   eax, 24<br />    cmp   al, 0 ; NULL<br />    jne   @F<br />    inc   ebx<br /> @@&#58;<br />    cmp   ah, 0 ; NULL<br />    jne   @F<br />    inc   ebx<br /><br /> @@&#58;lea   ecx, &#91;ecx*4&#93;<br />    sub   ecx, ebx<br /><br /> end start<br /></code></pre><br /><br />there's one little glitch here. DISEASE = 7 char. DISEASE_ = 8 char. the problem i'm having is that it return 7 when there's 8. i've tried my best and now out of brain-cell. please don't give me the optimized verson of  yours. i just want the logic of calculating the length of a string. (keep it as simple as possible, cause i want to do the optimizing myself - i like &quot;Do it yourself!&quot;). let me explain my logic behind this in case you're confused by the code...<br /><br />first of all, i can do this by  byte ptr with no problem. but it's slow! so i go for dword ptr. for example: (assume that esi = offset of target and we're searching for NULL and increase ecx by 1 if NULL doesn't exist. wait, you think adding 1 to the result gives correct answer? no! i wouldn't be posting this if it was that simple. :) )<br /><br /><pre><code><br />        +---+---+---+---+---+---+---+---+---+---+---+<br /> target | D | I | S | E | A | S | E | . |   |   |   |<br />        +---+---+---+---+---+---+---+---+---+---+---+<br />                          ^           |NULL<br /><br />@@&#58;<br />   mov  eax, &#91;esi&#93;  ; eax = ESID &#40;backward&#41;<br />   test al, al      ; does al = NULL? &#40;al=D in this case&#41;<br />   je   @F          ; jump if al = NULL<br />   add  esi, 4      ; next 4 letter<br />   inc  ecx         ; increase ecx 1 by so we can times it by<br />                    ; 4 later on.<br />   jmp  @B<br /><br />@@&#58;<br />  ; it's hard for me to explain from this<br />   mov  eax, &#91;esi-4&#93;  ; point on... cause it requires alot of typing!<br />   rol  eax, 24     ; anyway, i hope you understand...<br />   cmp  al, 0<br />   jne  @F<br />   inc  ebx<br />@@&#58;<br />   cmp  ah, 0<br />   jne  @F<br />   inc  ebx<br />@@&#58;<br />   lea  ecx, &#91;ecx*4&#93;<br />   sub  ecx, ebx<br /></code></pre><br /><br />try not to come up with another way. i want to stick with this logic and study it. (trashing the logic that you cannot solve is not learning).</div>
    <div class="meta">Posted on 2001-07-23 11:26:09 by disease_2000</div>
   </div>
   <div class="post" id="post-1792">
    <div class="subject"><a href="#post-1792">StrLen proc. need help</a></div>
    <div class="body">Despiting the fact that i consider all these optimisations<br />at code level, in Assembler, particulary stupid, ... here is it:<br /><br /><br /><br /><br />mov esi String, ecx 0<br />    <br />L0: <br />add esi 4 | inc ecx | cmp B?esi 0 | jne L0&lt;<br />shl ecx 2<br />    <br />L0: <br />dec ecx | dec esi | cmp B?esi 0 | je L0&lt;<br />inc ecx<br /><br />hexprint ecx                    ; Says 9.<br /><br /><br />I can swear you that your application, if not fast enough,<br />will never run much quicker, (just a little bit) because of<br />tricks like this.<br /><br /><br />Betov.</div>
    <div class="meta">Posted on 2001-07-23 11:59:18 by Betov</div>
   </div>
   <div class="post" id="post-1793">
    <div class="subject"><a href="#post-1793">StrLen proc. need help</a></div>
    <div class="body">disease_2000 <br /> <br /> <br />hi <br /><br />it took me a few min but i understand your algorithm  <br /><br />the problem seems to be in <br /><br /><br />the first section count the number of dword that the string have <br />for an example we have here two dword <br /><br />00403000    44 49  53 45 | 41  53 45 00   DISEASE.<br /><br />this section will count the zero(null) bytes ( its a little hard to <br />explain and my english is not very good )<br /><br /><br />esi-4 becuase the null bytes can be only in the last dword <br /><br /> mov   eax,  ; <br /> rol   eax, 24 ; i think this is the problem u need to rotate two bytes so 16 , not 24 <br />    cmp   al, 0 ; NULL<br />    jne   @F<br />    inc   ebx<br /> @@:<br />    cmp   ah, 0 ; NULL<br />    jne   @F<br />    inc   ebx<br /><br />the last section will sub between them <br /><br /><br />i notice that it will an error if the string will be something lile<br /><br />db 's',0,'t','r',0<br />becuase it will count the 1 dword <br />ecx = 4<br />and ebx =0 because it check the lowers bytes and there arnt zero<br /><br />you may want to do this check with words and not dwords, but anyway you got nice idea <br /><br />eko:alright:</div>
    <div class="meta">Posted on 2001-07-23 12:52:36 by eko</div>
   </div>
   <div class="post" id="post-1798">
    <div class="subject"><a href="#post-1798">StrLen proc. need help</a></div>
    <div class="body">betov, that's not may goal. :) i want to understand the problem i'm facing.<br /><br />eko, &quot;this section will count the zero(null) bytes ( its a little hard to <br />explain and my english is not very good ) <br />&quot;<br />i understand what you mean. that's why i couldn't explain it on my original post. :)<br /><br />and thank for the tip. i'll look forward for that. (i'm surprise that it only took you a few mintue... i thought that it would take you more than 15 minute!)<br /><br /><br />back to betov: i don't sit and write 32bit app. i'm more into algo study now. plus, trying to understand logic from different view.<br /><br />have a great day!<br /><br />-----edit msg:<br /><br /><strong>eko</strong>, just check it, wow... rol eax, 24 is the problem... the reason i rotate 24 is because i only want to check middle 2 char (the last is always NULL. and there's no point of checking the first cause ....well, it's very hard to explain, but i'm sure you know what i mean!) things are fixed now thank alot!</div>
    <div class="meta">Posted on 2001-07-23 13:58:47 by disease_2000</div>
   </div>
   <div class="post" id="post-1799">
    <div class="subject"><a href="#post-1799">StrLen proc. need help</a></div>
    <div class="body">No, Eko, the problem is in .<br />There is no zero there (unless we are out, before...).<br /><br />Anyway the real life way is:<br /><br />mov edi String, ecx 0-1, al 0<br />repne scasb<br />sub ecx 0-2 | neg ecx<br /><br /><br />Much fast enough, and everybody can read this. If not fast<br />enough, the Application has to be rewritten. The better<br />optimisation is in the code we *do not* write (not a joke).<br /><br />betov.</div>
    <div class="meta">Posted on 2001-07-23 14:03:47 by Betov</div>
   </div>
   <div class="post" id="post-1801">
    <div class="subject"><a href="#post-1801">StrLen proc. need help</a></div>
    <div class="body">betov, i understand what you mean. repnz scasb can check for the length. but i'm not interest in that. my main focus is on the problem i'm having. i know that my algo is not fast. (if you want superman speed, then don't write any algo. :) ) but it's part of my study. :alright:<br /><br /><br />edit:------------------<br />i could have use lstrlen instead which save me alot of bytes. but that's another story.</div>
    <div class="meta">Posted on 2001-07-23 14:10:21 by disease_2000</div>
   </div>
   <div class="post" id="post-1805">
    <div class="subject"><a href="#post-1805">StrLen proc. need help</a></div>
    <div class="body">Well, i see you point Desease. If it is just an intellectual<br />learning game, ok.<br /><br />Again, there is a problem at first ; &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;<br />where you prepare testing an area where there is no zero.<br />Should be: mov eax,  (and no use because eax already<br />holds this.<br /><br /><br />    lea   esi, target<br />    xor   ecx, ecx<br />    xor   ebx, ebx<br />  @@:<br />    mov   eax, <br />    test  al, al<br />    je    @F<br />    add   esi, 4<br />    inc   ecx<br />    jmp   @B<br /> @@:<br />    mov   eax,   ; &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;<br />    rol   eax, 24<br />    cmp   al, 0<br />    jne   @F<br />    inc   ebx           ; &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;<br /> @@:<br />    cmp   ah, 0<br />    jne   @<br />    inc   ebx           ; &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;<br /> @@:lea   ecx, <br />    sub   ecx, ebx<br />    <br />    <br />Also, as you can see your ebx can only be 0, 1, 2 (no 3).<br />A neighbour solution could be:<br /><br /><br />mov esi, Target<br />xor ecx, ecx<br />xor ebx, ebx<br />mov ebx 3<br />L1:<br />mov eax <br />test al, al<br />jz L2&gt;<br />add esi, 4<br />inc ecx<br />jmp L1&lt;<br />L2:<br />test eax eax | jz L9&gt;<br />dec ebx<br />test ah ah | jz L9&gt;<br />dec ebx<br />shl eax 16 | jmp L2&lt;<br />L9: <br />lea ecx <br />sub ecx, ebx<br /><br /><br />though i would prefer 'mov ecx 0' instead of the stupid<br />'xor ecx ecx' and 'shl ecx 2' instead of 'lea ecx '.<br /><br />Note (i am unsure if you got it or not...), when you load in eax<br />a string like:<br /><br />String DB 'abc', 0<br /><br />inside eax, al holds 'a', ah 'b',...  i suppose you know.<br /><br /><br />Bye, Betov.</div>
    <div class="meta">Posted on 2001-07-23 15:28:46 by Betov</div>
   </div>
   <div class="post" id="post-1810">
    <div class="subject"><a href="#post-1810">StrLen proc. need help</a></div>
    <div class="body">betov, my code is not in optimize state. :) the reason why i have lea ecx,  instead of shl ecx, 2 was because i had problem with the logic half way coding this algo.<br /><br /><pre><code><br /> lea ecx, &#91;ecx*4+1&#93;, lea ecx, &#91;ecx*4-1&#93; &lt;-- which was for debugging<br /> purposes &#40;just to make life easier while i'm coding. but once finish -<br /> and  you're right, it should be SHL ECX, 2. which i didn't thought<br />of it at first until you point out &#41;<br /></code></pre><br /><br />and about mov ecx, 0 : why?<br /><br /><pre><code><br />33C9        xor  ecx,ecx<br />B900000000  mov  ecx,0<br /></code></pre><br /><br /><strong>eko</strong>, lstrlen returns 1 if you have something like:<br /><pre><code><br /> target db &quot;d&quot;, 0, &quot;i&quot;, 0, &quot;s&quot; ect...<br /><br /> the code i posted above, you can change the NULL to 0FFh or any<br /> other char. and it will work. &#40;problem will araise if  you have&#58;<br /> target db &quot;d&quot;, 0ffh, &quot;i&quot; and so on...&#41;<br /></code></pre><br /><br /><br />edit:-----------<br />betov, i am aware of that. things will mess up if target contains only 2 char.... my code is still not perfect.</div>
    <div class="meta">Posted on 2001-07-23 16:26:14 by disease_2000</div>
   </div>
  </div>
 </body>
</html>