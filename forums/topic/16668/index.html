<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>different behaviour for same code - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=16668" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=16668">different behaviour for same code</a></p>
   <div class="post" id="post-129506">
    <div class="subject"><a href="#post-129506">different behaviour for same code</a></div>
    <div class="body">===========================================<br />this snippet is from iczelions tut 8-01 pasted from a debugger<br />===========================================<br />00401119  CMP     DWORD PTR SS:, 111<br />00401120  JNZ     SHORT MENU.00401180<br />00401122  MOV     EAX, DWORD PTR SS:<br />00401125  CMP     AX, 1            <br />00401129  JNZ     SHORT MENU.00401140<br />========================================================<br />this snippet is from my code tut 8-01 pasted from a debugger<br />========================================================<br />00401432  CMP     DWORD PTR SS:, 111<br />00401439  JNZ     v2237028.00401517<br />0040143F  MOV     EAX, DWORD PTR SS:<br />00401442  CMP     AX, 1<br />00401446  JNZ     SHORT v2237028.0040145B<br />======================================================<br /><br />the first icz app does not ever break if i put a break point on <br />00401125  CMP     AX, 1 and keep on hitting enter __|  (VK_ENTER OR VK_RETURN)<br /><br />the second mycode ALWAYS BREAKS if i put a break point on <br />00401125  CMP     AX, 1 and hit enter __|  (VK_ENTER OR VK_RETURN)<br />=======================================================<br />my code in masm<br />IDM_EXIT equ 1<br />.ELSEIF uMsg==WM_COMMAND<br />            mov eax,wParam<br />            .IF ax==IDM_EXIT<br />                    invoke SendMessage,hWnd,WM_CLOSE,0,0<br />            .ELSEIF ax==IDM_ABOUT<br /><br />so my proggie terminates if i hit enter when my proggie is in focus<br />and also my proggie breaks when i press esc too VK_ESCAPE<br /><br />iczelions code<br />IDM_TEST equ 1<br />.ELSEIF uMsg==WM_COMMAND<br />		mov eax,wParam<br />		.IF ax==IDM_TEST<br />			invoke MessageBox,NULL,ADDR Test<br /><br />his does not terminate<br /><br />what can cause this different behaviour for same code <br />both tested in w2k with ollydbg as the debugger<br /><br /><br />:(</div>
    <div class="meta">Posted on 2004-01-01 08:07:19 by bluffer</div>
   </div>
   <div class="post" id="post-129511">
    <div class="subject"><a href="#post-129511">different behaviour for same code</a></div>
    <div class="body">The compare test is always jumping - PAST - the point where you are placing the breakpoint. The breakpoint is not being encountered, and thus the break is not occuring. The fact that your own code DOES break indicates that the compare test of uMsg is failing, possibly due to corruption of the stack, since thats where uMsg is, as it is a local to the procedure, its kept in the procedure stack frame.<br /><br />Have a nice day :)</div>
    <div class="meta">Posted on 2004-01-01 09:12:16 by Homer</div>
   </div>
   <div class="post" id="post-129721">
    <div class="subject"><a href="#post-129721">different behaviour for same code</a></div>
    <div class="body">i cant find out where iam CORRUPTING THE stack <br /><br />can some one look into my code and say why this is processing enter and escape<br /><br />iam also attaching the exe (i dunno if i can attach if i cant i will rename it to txt or jpeg or what ever and attach it rename it to exe and can try it out)<br /><br />oops it is written there i cant attache exes so i have zipped it and attached<br /><pre><code><br />.386<br />.model flat,stdcall<br />option casemap&#58;none<br /><br />include \masm32\include\windows.inc<br />include \masm32\include\user32.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\gdi32.inc<br />includelib \masm32\lib\user32.lib<br />includelib \masm32\lib\kernel32.lib<br />includelib \masm32\lib\gdi32.lib<br /><br />szText MACRO Name, Text&#58;VARARG<br />LOCAL lbl<br />  jmp lbl<br />    Name db Text,0<br />  lbl&#58;<br />ENDM<br /><br />WinMain PROTO &#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD<br />TopEditBox PROTO &#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD<br />PushButton PROTO &#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD<br /><br />.data<br />ClassName db &quot;BLAH&quot;,0<br />AppName   db &quot;BLAH&quot;,0<br />MenuName  db &quot;FirstMenu&quot;,0<br />szBtnText db &quot;BLAH&quot;,0<br /><br /><br />.data?<br />hInstance HINSTANCE ?<br />CommandLine LPSTR ?<br />hMenu HMENU ?<br />hwndEdit HWND ?<br /><br />.const<br />IDM_EXIT equ 1<br />IDM_ABOUT equ 2<br /><br />.code<br />start&#58;<br />	invoke GetModuleHandle, NULL<br />	mov    hInstance,eax<br />	invoke GetCommandLine<br />	mov    CommandLine,eax<br />	invoke WinMain, hInstance,NULL,CommandLine, SW_SHOWDEFAULT<br />	invoke ExitProcess,eax<br /><br />WinMain proc hInst&#58;HINSTANCE,hPrevInst&#58;HINSTANCE,CmdLine&#58;LPSTR,CmdShow&#58;DWORD<br />	LOCAL wc&#58;WNDCLASSEX<br />	LOCAL msg&#58;MSG<br />	LOCAL hwnd&#58;HWND<br />	mov   wc.cbSize,SIZEOF WNDCLASSEX<br />	mov   wc.style, CS_HREDRAW or CS_VREDRAW<br />	mov   wc.lpfnWndProc, OFFSET WndProc<br />	mov   wc.cbClsExtra,NULL<br />	mov   wc.cbWndExtra,NULL<br />	push  hInstance<br />	pop   wc.hInstance<br />	mov   wc.hbrBackground,COLOR_BTNFACE+1<br />	mov   wc.lpszMenuName,NULL<br />	mov   wc.lpszClassName,OFFSET ClassName<br />	invoke LoadIcon,NULL,IDI_APPLICATION<br />	mov   wc.hIcon,eax<br />	mov   wc.hIconSm,eax<br />	invoke LoadCursor,NULL,IDC_ARROW<br />	mov   wc.hCursor,eax<br />	invoke RegisterClassEx, addr wc<br />      <br />	INVOKE CreateWindowEx,NULL,ADDR ClassName,ADDR AppName,\<br />           WS_SYSMENU or WS_MINIMIZEBOX ,360,\<br />           240,80,120,NULL,NULL,\<br />           hInst,NULL<br />	mov   hwnd,eax<br />	invoke ShowWindow, hwnd,SW_SHOWNORMAL<br />	invoke UpdateWindow, hwnd<br />           .WHILE TRUE<br />	        invoke GetMessage, ADDR msg,NULL,0,0<br />            .BREAK .IF &#40;!eax&#41;<br />                       invoke IsDialogMessage, hwnd, ADDR msg<br />           .IF !eax<br />	         invoke TranslateMessage, ADDR msg<br />	         invoke DispatchMessage, ADDR msg<br />           .ENDIF<br />           .ENDW<br />	mov     eax,msg.wParam<br />	ret<br />WinMain endp<br /><br />WndProc proc hWnd&#58;HWND, uMsg&#58;UINT, wParam&#58;WPARAM, lParam&#58;LPARAM<br />      LOCAL hEdit &#58;DWORD         <br />      .IF uMsg==WM_CREATE<br />                            <br />            invoke TopEditBox,0,hWnd,16,16,75,21,501<br />            invoke PushButton,ADDR szBtnText,hWnd,16,48,75,21,523<br />            <br />      .ELSEIF uMsg==WM_COMMAND<br />            mov eax,wParam<br />            .IF ax==IDM_EXIT<br />                    invoke SendMessage,hWnd,WM_CLOSE,0,0<br />            .ELSEIF ax==IDM_ABOUT<br />                    jmp @F<br />                        szAboutText    db &quot;BLAH&quot;,0<br />                        szAboutCaption db &quot;BLAH&quot;,0<br />                    @@&#58;<br />                    invoke MessageBox,hWnd,ADDR szAboutText,ADDR szAboutCaption,MB_OK or MB_ICONINFORMATION<br />            .ELSEIF ax==523<br />                    jmp @F<br />                        szMessage   db &quot;Hello, world!&quot;,0<br />                        szCaption   db &quot;Hi!&quot;,0<br />                    @@&#58;<br />                    invoke MessageBox,hWnd,ADDR szMessage,ADDR szCaption,MB_OK or MB_ICONEXCLAMATION<br />            .ENDIF<br />          .ELSEIF uMsg==WM_DESTROY<br />		invoke PostQuitMessage,NULL<br />	.ELSE<br />		invoke DefWindowProc,hWnd,uMsg,wParam,lParam		<br />		ret<br />	.ENDIF<br />       <br />	xor eax,eax<br />	ret<br />WndProc endp<br /><br />TopEditBox proc lpText&#58;DWORD,hParent&#58;DWORD,<br />                a&#58;DWORD,b&#58;DWORD,wd&#58;DWORD,ht&#58;DWORD,ID&#58;DWORD<br />    LOCAL hFont &#58;DWORD<br />    LOCAL hEdit  &#58;DWORD<br />    szText editClass,&quot;EDIT&quot;<br /><br />    invoke CreateWindowEx,WS_EX_CLIENTEDGE,<br />            ADDR editClass,lpText,<br />            WS_CHILD or WS_VISIBLE or WS_TABSTOP or ES_AUTOHSCROLL,<br />            a,b,wd,ht,hParent,ID,<br />            hInstance,NULL<br />    mov hEdit, eax<br />    invoke GetStockObject,DEFAULT_GUI_FONT      ; ANSI_FIXED_FONT<br />    mov hFont, eax<br />    invoke SendMessage,hEdit,WM_SETFONT,hFont, 0<br />    ret<br />    <br />TopEditBox endp<br /><br /><br /><br />PushButton proc lpText&#58;DWORD,hParent&#58;DWORD,a&#58;DWORD,b&#58;DWORD,wd&#58;DWORD,ht&#58;DWORD,ID&#58;DWORD<br />    LOCAL hFont &#58;DWORD<br />    LOCAL hBtn  &#58;DWORD<br />    szText btnClass,&quot;BUTTON&quot;<br /><br />    invoke CreateWindowEx,WS_EX_CLIENTEDGE,<br />            ADDR btnClass,lpText,<br />            WS_CHILD or WS_VISIBLE,<br />            a,b,wd,ht,hParent,ID,<br />            hInstance,NULL<br /><br />    mov hBtn, eax<br /><br />    invoke GetStockObject,DEFAULT_GUI_FONT<br />    mov hFont, eax<br />    invoke SendMessage,hBtn,WM_SETFONT,hFont,0<br /><br />    ret<br />PushButton endp<br /><br />end start<br /><br /></code></pre></div>
    <div class="meta">Posted on 2004-01-04 05:53:20 by bluffer</div>
   </div>
   <div class="post" id="post-129768">
    <div class="subject"><a href="#post-129768">different behaviour for same code</a></div>
    <div class="body">bluffer,<br />You probably won't get too many people looking over your code unless you change the way you present it.  You should use the <pre><code></code></pre> directives when posting, so the spacing and indentations of your source is preserved.  It is difficult to read code that is left justified on the margin.  Why don't you package up all the source statements needed for a build, including the resource statements into a ZIP file.  Then send it as an attachment along with a concise statement of what is wrong.  It will surely make thing a lot easier and faster.  Ratch</div>
    <div class="meta">Posted on 2004-01-04 14:49:17 by Ratch</div>
   </div>
   <div class="post" id="post-129773">
    <div class="subject"><a href="#post-129773">different behaviour for same code</a></div>
    <div class="body">I can't see anything obviously wrong with it and there appears to be no stack corruption in this case. Please post the complete source in a zip.<br />For future reference, here is the stackchecking macro I use during debugging - just include the file somewhere near the top of your source, then use the two lines &quot;startstack&quot; and &quot;endstack&quot; around the section of code to be checked. If you get a messagebox popup when you run the exe, it will tell you where the misalignment occured and how large it was (and the direction + or -), if nothing happens then the stack was not corrupted between the statements.<br /><br />Have a nice day :)</div>
    <div class="meta">Posted on 2004-01-04 16:47:41 by Homer</div>
   </div>
   <div class="post" id="post-129881">
    <div class="subject"><a href="#post-129881">different behaviour for same code</a></div>
    <div class="body">ratch i edited my above post as you said with code directives<br />thanks evil homer i dld yoursafestack.inc will try using it btw i have uploaded a new attachment along with source in my previous post<br /><br />hope now you or some one can tell why it is processing enter and escape</div>
    <div class="meta">Posted on 2004-01-06 00:57:21 by bluffer</div>
   </div>
   <div class="post" id="post-129936">
    <div class="subject"><a href="#post-129936">different behaviour for same code</a></div>
    <div class="body">bluffer,<br />     Good job on presenting the code so I could read and understand it.  Looks to me like you are creating a window and then creating two child control windows within it.   So far so good.  Then I have to ask; why is there a IsDialogMessage API in your message loop?  You don't have a dialog box in your program.  When I removed the IsDialogMessage, the program did not respond to ENTER and ESCAPE, and appeared to work OK to the limits that it was completed so far.<br /><br />I can rewrite that program using my methods for a demonstration and send it to you, but I will not do it unless you want me to.  It's up to you.  Ratch</div>
    <div class="meta">Posted on 2004-01-06 17:32:14 by Ratch</div>
   </div>
   <div class="post" id="post-129945">
    <div class="subject"><a href="#post-129945">different behaviour for same code</a></div>
    <div class="body">Yes I too noticed that call in the messagepump.. I wasn't familiar with it so I looked it up and its fine.. <br /><br /><div class="quote">Although the IsDialogMessage function is intended for modeless dialog boxes, you can use it with any window that contains controls, enabling the windows to provide the same keyboard selection as is used in a dialog box. <br /><br />When IsDialogMessage processes a message, it checks for keyboard messages and converts them into selection commands for the corresponding dialog box. For example, the TAB key, when pressed, selects the next control or group of controls, and the DOWN ARROW key, when pressed, selects the next control in a group. <br /></div></div>
    <div class="meta">Posted on 2004-01-06 20:32:09 by Homer</div>
   </div>
   <div class="post" id="post-129952">
    <div class="subject"><a href="#post-129952">different behaviour for same code</a></div>
    <div class="body">bluffer,<br />EvilHomer2k is correct about using IsDialogMessage in your main window to gain dialog box functionality.  If you do, however, you must be aware of the following:<br /><a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/winui/winui/windowsuserinterface/windowing/dialogboxes/dialogboxprogrammingconsiderations.asp">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/winui/winui/windowsuserinterface/windowing/dialogboxes/dialogboxprogrammingconsiderations.asp</a>  <br /><br /><u>Select Dialog Box Keyboard Interface.</u> As you can see in the table, a ENTER supplies a IDOK code in wParam, which is the same as the IDM_EXIT you have defined in your program.  ESCAPE supplies a IDCANCEL code, which is the same a the IDM_ABOUT code defined in your program.  What you should do is check the ID parameter in LOWORD(wParam) to make sure the WM_COMMAND is coming from your child windows instead of the keyboard.  Ratch</div>
    <div class="meta">Posted on 2004-01-06 22:16:03 by Ratch</div>
   </div>
   <div class="post" id="post-129978">
    <div class="subject"><a href="#post-129978">different behaviour for same code</a></div>
    <div class="body">Ratch and EvilHomer2 thanks to both of you for answering to my question<br /><br />so IsDialogMessage is processing my enter and escape and sending it to my dialog<br /><br />i know if i change IDM_EXIT and IDM_ABOUT to some other value i can eliminate the problem but that is kind of hack mechanic work <br /><br />i couldnt understand why if some one elses code worked with 1 and 2 <br />why not mine <br /><br /><div class="quote">What you should do is check the ID parameter in LOWORD(wParam) to make sure the WM_COMMAND is coming from your child windows instead of the keyboard. Ratch</div> <br /><br />thaks for that info ratch <br /><br />ill try it and if i face problems ill come back and thanks for your offer to code but let me try and fail first</div>
    <div class="meta">Posted on 2004-01-07 09:56:23 by bluffer</div>
   </div>
  </div>
 </body>
</html>