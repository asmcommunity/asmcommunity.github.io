<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Code knows out regedit for a while ? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=24419" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=24419">Code knows out regedit for a while ?</a></p>
   <div class="post" id="post-178321">
    <div class="subject"><a href="#post-178321">Code knows out regedit for a while ?</a></div>
    <div class="body"><br />Assembles OK, but regedit doesn&#39;t want to start after running this. Says regedit fails to initialize.<br /><br />Thanks.<br /><br />; creatsub.asm&nbsp; Create a subkey of an existing registry key<br />;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Help from AsmER,<br />.386<br />.MODEL FLAT, STDCALL<br />OPTION CASEMAP: NONE<br /><br />&nbsp; &nbsp; include \masm32\include\windows.inc<br />&nbsp; &nbsp; include \masm32\include\user32.inc<br />&nbsp; &nbsp; include \masm32\include\kernel32.inc<br />&nbsp; &nbsp; include \masm32\include\advapi32.inc<br /><br />&nbsp; &nbsp; include \masm32\macros\macros.asm<br /><br />&nbsp; &nbsp; includelib&nbsp; \masm32\lib\kernel32.lib<br />&nbsp; &nbsp; includelib&nbsp; \masm32\lib\user32.lib<br />&nbsp; &nbsp; includelib&nbsp; \masm32\lib\advapi32.lib<br /><br />.DATA<br /><br /><br /><br />APPKey&nbsp; &nbsp; &nbsp; &nbsp; BYTE &quot;Marzipan&quot;, 0<br />SecondKey&nbsp; &nbsp;  BYTE &quot;basement&quot;, 0<br /><br />.DATA?<br /><br />RegH&nbsp; &nbsp; &nbsp; &nbsp;  PHKEY&nbsp; &nbsp; &nbsp; ? ; Handle for registry key<br />SubRegKey&nbsp; &nbsp; PHKEY&nbsp; &nbsp; &nbsp; ?<br /><br />.CODE<br /><br />Start:<br /><br />invoke RegOpenKey, HKEY_CURRENT_USER, ADDR APPKey, ADDR RegH&nbsp;  ;to get handle of already created<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;reg. key. (marzipan)<br /><br />invoke RegCreateKey, RegH, ADDR SecondKey, SubRegKey&nbsp; ;to create (&gt;&gt;or open&nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;already exist&lt;&lt;) sub reg. key<br /><br />invoke RegCloseKey, ADDR RegH&nbsp; &nbsp; &nbsp; ; close handle for reg. key<br />invoke RegCloseKey, ADDR SubRegKey ; close handle for reg. key<br /><br /><br />invoke ExitProcess, 0<br /><br />END Start</div>
    <div class="meta">Posted on 2006-03-13 16:45:35 by skywalker</div>
   </div>
   <div class="post" id="post-178324">
    <div class="subject"><a href="#post-178324">Re: Code knows out regedit for a while ?</a></div>
    <div class="body">Well, there are a few problems with you code, first off you should not create a key that is a direct child of HKEY_CURRENT_USER, you should be using &quot;Software\Company\Package&quot; for your software keys. Second in the following line:<br /><br />invoke RegCreateKey, RegH, ADDR SecondKey, SubRegKey<br /><br />You should be passing the address of SubRegKey, not the value...<br /><br />invoke RegCreateKey, RegH, ADDR SecondKey, ADDR SubRegKey<br /><br />Third in the following lines:<br /><br />invoke RegCloseKey, ADDR RegH<br />invoke RegCloseKey, ADDR SubRegKey <br /><br />you should be passing the values not the addresses...<br /><br />invoke RegCloseKey, RegH<br />invoke RegCloseKey, SubRegKey<br /><br />The documentation at MSDN explains all of this, read it, there are now a large number of posts both here and at masmforum trying to explain this fairly simple API to you, as opposed to being spoonfed it ad infinitum, do a little research.<br /><br />For the simple read/write that you are doing, SHGetValue and SHSetValue are more than adequate and do not require opening or closing the keys. But if you insist on the long way for a single value...<br /><br /><pre><code>.data<br />hRegKey DD 0<br />SubKey DB &quot;Software\SkyWalker\MyApp&quot;,0<br />value DB &quot;valuename&quot;,0<br />data DB &quot;This is my data&quot;,0<br />Disposition DD 0<br />cbRead DD 0<br /><br />.code<br />invoke RegOpenKeyEx, HKEY_CURRENT_USER, ADDR SubKey, 0, KEY_WRITE, ADDR hRegKey<br />test eax,eax<br />jnz @F ; Open failed<br />invoke RegSetValueEx, , offset value, NULL, REG_SZ, ADDR data,SIZEOF data<br />invoke RegCloseKey,<br />@@:</code></pre><br /><br />To read it :<br /><br /><pre><code>invoke RegCreateKeyEx,HKEY_CURRENT_USER,OFFSET SubKey,NULL,NULL,\<br />&nbsp;  REG_OPTION_NON_VOLATILE,KEY_READ+KEY_WRITE,NULL,ADDR hRegKey,ADDR Disposition<br />test eax,eax<br />jnz @F<br />invoke RegQueryValueEx,,OFFSET value,0,NULL,OFFSET data,ADDR cbRead<br />invoke RegCloseKey,<br />@@:</code></pre></div>
    <div class="meta">Posted on 2006-03-13 18:58:45 by donkey</div>
   </div>
   <div class="post" id="post-178331">
    <div class="subject"><a href="#post-178331">Re: Code knows out regedit for a while ?</a></div>
    <div class="body"><div class="quote"><br />Well, there are a few problems with you code, first off you should not create a key that is a direct child of HKEY_CURRENT_USER, you should be using &quot;Software\Company\Package&quot; for your software keys. Second in the following line:<br /><br /><br />invoke RegCreateKey, RegH, ADDR SecondKey, SubRegKey<br /><br />You should be passing the address of SubRegKey, not the value...<br /><br />invoke RegCreateKey, RegH, ADDR SecondKey, ADDR SubRegKey<br /><br />Third in the following lines:<br /><br />invoke RegCloseKey, ADDR RegH<br />invoke RegCloseKey, ADDR SubRegKey <br /><br />you should be passing the values not the addresses...<br /><br />invoke RegCloseKey, RegH<br />invoke RegCloseKey, SubRegKey<br /><br />The documentation at MSDN explains all of this, read it, there are now a large number of posts both here and at masmforum trying to explain this fairly simple API to you, as opposed to being spoonfed it ad infinitum, do a little research.<br /><br />For the simple read/write that you are doing, SHGetValue and SHSetValue are more than adequate and do not require opening or closing the keys. But if you insist on the long way for a single value...<br /><br /><pre><code>.data<br />hRegKey DD 0<br />SubKey DB &quot;Software\SkyWalker\MyApp&quot;,0<br />value DB &quot;valuename&quot;,0<br />data DB &quot;This is my data&quot;,0<br />Disposition DD 0<br />cbRead DD 0<br /><br />.code<br />invoke RegOpenKeyEx, HKEY_CURRENT_USER, ADDR SubKey, 0, KEY_WRITE, ADDR hRegKey<br />test eax,eax<br />jnz @F ; Open failed<br />invoke RegSetValueEx, , offset value, NULL, REG_SZ, ADDR data,SIZEOF data<br />invoke RegCloseKey,<br />@@:</code></pre><br /><br />To read it :<br /><br /><pre><code>invoke RegCreateKeyEx,HKEY_CURRENT_USER,OFFSET SubKey,NULL,NULL,\<br />&nbsp;  REG_OPTION_NON_VOLATILE,KEY_READ+KEY_WRITE,NULL,ADDR hRegKey,ADDR Disposition<br />test eax,eax<br />jnz @F<br />invoke RegQueryValueEx,,OFFSET value,0,NULL,OFFSET data,ADDR cbRead<br />invoke RegCloseKey,<br />@@:</code></pre><br /></div><br /><br />Thanks, I&#39;ll put the positive of your post to good use.<br /><br /><br /><br /> <br /><br /></div>
    <div class="meta">Posted on 2006-03-13 21:53:24 by skywalker</div>
   </div>
   <div class="post" id="post-178356">
    <div class="subject"><a href="#post-178356">Re: Code knows out regedit for a while ?</a></div>
    <div class="body">Although I don&#39;t agree with how &quot;evlncrn8&quot; put it, I still agree with the fact that you do not need to quote an entire reply, it is a wasteful (and sometimes annoying) redundancy. These are not the old-obsolete inline-index style forums, let the scroll bar do its job :)</div>
    <div class="meta">Posted on 2006-03-14 04:37:27 by SpooK</div>
   </div>
  </div>
 </body>
</html>