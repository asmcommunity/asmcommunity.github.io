<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Calculating the size in bytes of a C function  - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=28791" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=113">Low Level Concepts</a> &raquo; <a href="../?id=28791">Calculating the size in bytes of a C function </a></p>
   <div class="post" id="post-203422">
    <div class="subject"><a href="#post-203422">Calculating the size in bytes of a C function </a></div>
    <div class="body">Hello,<br /><br />it there an efficient way to get the size of a C function from C code itself?<br />Wanting to inject code into a running process without using the DLL loading approach, I need to know how much space to allocate in the remote process. Obviously, how the compiler lays out the code inside the binary may play a role depending on how you try to calculate the size ...<br /><br />Anyhow, I seem to be able to calculate a size that is always greater than the real size ... so this would be enough for it to work but I was wondering if there is any nice trick C/C++ gurus may suggest.<br /><br />Obviously I could check how many bytes this function gets compiled into using a disassembler or a debugger ... but doing everything directly from the IDE editor and using C/C++ code would be so much better!!&nbsp; <br /><br />yaa<br /><br /></div>
    <div class="meta">Posted on 2007-11-03 11:30:03 by yaa</div>
   </div>
   <div class="post" id="post-203424">
    <div class="subject"><a href="#post-203424">Re: Calculating the size in bytes of a C function </a></div>
    <div class="body">Man, about 10 of your last topics are related to injecting the code into remote processes. And you&#039;re trying to get every possible info about a process which syggests that your code is supposed to be able to inject into ANY code and -possibly- patch it. What application are you trying to create, if I may ask? Don&#039;t take me wrongly - I&#039;m just stictly against helping people to gain malicious knowledge. That&#039;s all.<br /><br />(And of course I&#039;ll gladly help if you give me some legal purpose for such knowledge :) )</div>
    <div class="meta">Posted on 2007-11-03 12:13:58 by ti_mo_n</div>
   </div>
   <div class="post" id="post-203425">
    <div class="subject"><a href="#post-203425">Re: Calculating the size in bytes of a C function </a></div>
    <div class="body">Only my last 2 posts are about code injection and this is the very first time in my life that I play around with this topic! Trying to get every possible information about it??? Where??? There are plenty of articles (and source code too) around that deal with this topic (only on codeproject you may find at least 10 of them). How about relaxing a little? Why is people here so paranoic? How is your witch hunt going? Got any?<br /><br />yaa<br /><br /></div>
    <div class="meta">Posted on 2007-11-03 12:25:54 by yaa</div>
   </div>
   <div class="post" id="post-203428">
    <div class="subject"><a href="#post-203428">Re: Calculating the size in bytes of a C function </a></div>
    <div class="body">What I&#039;m doing can be clearly read at http://www.asmcommunity.net/board/index.php?topic=28782.0 ... and ti_mo_n, since you have read all my *last 10 topics* you should already known what I&#039;m doing.<br /><br />I already completed what I wanted to achieve using the remote DLL loading approach .. but I don&#039;t like the design (I hate the idea of an external DLL) so I&#039;m reworking my coding using a different approach (all the code is written directly from my injector to the target process). <br /><br />I have no real issue (rewriting IAT and eventually exports is no issue and even writing the code can be achieved easily enough). I was just wondering if from source code you can calculate the correct size of a C function. I can already do it .. but it is not precise. Enough to make it work ... not enough for my aesthetic pleasure.<br /><br />yaa<br /><br /></div>
    <div class="meta">Posted on 2007-11-03 12:54:33 by yaa</div>
   </div>
   <div class="post" id="post-203435">
    <div class="subject"><a href="#post-203435">Re: Calculating the size in bytes of a C function </a></div>
    <div class="body"><div class="quote"><br />Only my last 2 posts are about code injection and this is the very first time in my life that I play around with this topic! Trying to get every possible information about it??? Where??? There are plenty of articles (and source code too) around that deal with this topic (only on codeproject you may find at least 10 of them). How about relaxing a little? Why is people here so paranoic here? How is your witch hunt going? Got any?<br /></div><br /><br />I know we just unlocked your other thread, but I wouldn&#039;t get so cocky, yet ;)<br /><br />The reason we keep these topics on the down low is already mentioned in <a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=28788.0"><u>THIS</u></a> thread. Like it or hate it, that is the reality of it all.<br /><br /><div class="quote"><br />Man, about 10 of your last topics are related to injecting the code into remote processes. And you&#039;re trying to get every possible info about a process which syggests that your code is supposed to be able to inject into ANY code and -possibly- patch it. What application are you trying to create, if I may ask? Don&#039;t take me wrongly - I&#039;m just stictly against helping people to gain malicious knowledge. That&#039;s all.<br /><br />(And of course I&#039;ll gladly help if you give me some legal purpose for such knowledge :) )<br /></div><br /><br />The moderation team has determined that what he is trying to do is <strong>not</strong> malicious, as I think we have all been where he is. He might shoot himself in the foot since what he really wants is for XP drivers to work on 2K3 Server, but all the more power to him. We&#039;ll gladly help point that rifle at the most appropriate part of his foot and he can pull the trigger to see what happens :lol:</div>
    <div class="meta">Posted on 2007-11-03 14:45:10 by SpooK</div>
   </div>
   <div class="post" id="post-203436">
    <div class="subject"><a href="#post-203436">Re: Calculating the size in bytes of a C function </a></div>
    <div class="body"><div class="quote"><br />I know we just unlocked your other thread, but I wouldn&#039;t get so cocky, yet ;)<br /></div><br /><br />I&#039;ve been around forums for years, and I just could never not stand people that seem to be on forums only to say &quot;hey, you should not post here&quot;, &quot;hey, you are violating this and that&quot; .. if I were I had something to hide would I state my intent so openly?<br /><br />Anyhow, I do not want to make drivers run on W2K3 but simply be able to install user mode software on W2K3. Recently I have had problems with webcam drivers, photoshop cs3 and windows live writer .. their installer will tell you that they may run only on XP or Vista and yet I have an entire laptop running W2K3 that uses device drivers that were written for XP and everything works just fine!<br /><br />yaa<br /></div>
    <div class="meta">Posted on 2007-11-03 15:32:54 by yaa</div>
   </div>
   <div class="post" id="post-203437">
    <div class="subject"><a href="#post-203437">Re: Calculating the size in bytes of a C function </a></div>
    <div class="body"><div class="quote"><br />I&#039;ve been around forums for years, and I just could never not stand people that seem to be on forums only to say &quot;hey, you should not post here&quot;, &quot;hey, you are violating this and that&quot;<br /></div><br /><br />In those terms, I&#039;ve been around these forums for years+1 and I just could never stand people who think that this place is at their disposal.<br /><br />I take a look at your posts and I can tell you are a taker, you have offered very little help as compared to the amount of help you have asked for.<br /><br />On the other hand, you can take a good look at ti_mo_n&#039;s posting history and obviously see that he is more of a giver and has helped with many threads. He at least offered to help under the terms that what you were doing is not malicious/illegal. I think that is a fair trade, you just have to appeal to his morals.<br /><br />So, as you can see, you have very little ground to stand on with your petty complaints and I would suggest that you show a little more respect towards those who <strong>have</strong> been helping out around here ;)<br /><br /><div class="quote"><br />if I were I had something to hide would I state my intent so openly?<br /></div><br /><br />That&#039;s just it, you didn&#039;t state your intent... you only stated what you are trying to achieve. A moderator had to pull you to the side to ultimately determine your intent.<br /><br /><div class="quote"><br />Anyhow, I do not want to make drivers run on W2K3 but simply be able to install user mode software on W2K3. Recently I have had problems with webcam drivers, photoshop cs3 and windows live writer .. their installer will tell you that they may run only on XP or Vista and yet I have an entire laptop running W2K3 that uses device drivers that were written for XP and everything works just fine!<br /></div><br /><br />OK, well, forcing the driver installer to install is still forcing the driver to work on a system it was not intended for... no matter how you look at it.<br /><br />At any rate, good to hear that the process is going well for you :)</div>
    <div class="meta">Posted on 2007-11-03 16:11:21 by SpooK</div>
   </div>
   <div class="post" id="post-203438">
    <div class="subject"><a href="#post-203438">Re: Calculating the size in bytes of a C function </a></div>
    <div class="body">Well, first let me explain myself: I&#039;m not a paranoid witch hunter. I just code for living and the last thing I&#039;d like to do is to help someone write a crack for one of the apps/games I made. That&#039;s all. And you know: patching your own code is trivial, because you know the source. Patching someone&#039;s code (a patcher/crack) is more complex, but still quite easy. Now, writing a code wich is able to scan and patch ANY code is nontrivial and is required -for example- to write a self-replicating virus. That&#039;s why your questions alarmed me.<br /><br />But, OK - to the topic.<br />There are many, as always, methods to approach this problem. First, the most obvious, is to scan for empty spaces (NOPs or INT3s) within the code. When we talk about binary format, it&#039;s easy to distinguish where a particular function (or cluster of functions) start and end (ret folowed by nops). The next step is to look for references. If any given chunk of code is (1) after a ret or jump and (2) not referenced by any jump or call, then it&#039;s most likely outside of any function (because it won&#039;t be executed).<br /><br />These are the easiest (both to comprehend and to code) ways to approach the problem. Now, what precisely do you need to do? As they say: &quot;the more precisely you ask, the more precisely they answer&quot; (or something like that ^^&#039;).</div>
    <div class="meta">Posted on 2007-11-03 16:19:30 by ti_mo_n</div>
   </div>
   <div class="post" id="post-203440">
    <div class="subject"><a href="#post-203440">Re: Calculating the size in bytes of a C function </a></div>
    <div class="body">The reason for the applications that works even when cheated about the Windows version is because them actually want to prevent the <strong>I</strong>LLEGAL use of them. Where it is the illegality? Simple, home and/or workstation licences of a given product are normally a lot cheaper compared to its enterprise/server counterparts. So, depending on the context, convincing a program that the Windows version is different than what actually it is can be used for illegal proposes.<br /><br />Of course sometimes the problem is that the program is afraid about newer versions because it is unaware of them and just don&#039;t work as a safety measure, but, in which scenario we are now?<br /><br />Replaced &quot;why&quot; with &quot;we&quot;. Don&#039;t ask how I did such mispelling because I don&#039;t know...</div>
    <div class="meta">Posted on 2007-11-03 16:43:52 by LocoDelAssembly</div>
   </div>
   <div class="post" id="post-203441">
    <div class="subject"><a href="#post-203441">Re: Calculating the size in bytes of a C function </a></div>
    <div class="body"><strong>about topic:</strong><br />solution is very simple:<br />static xxxxx myFunction(....)<br />{<br />}<br />static void EndOfMyFunction(...){}<br /><br />size = myFunction - EndOfMyFunction;<br /><br />beware of the static keyword.<br /><br /><div class="quote"><br />Anyhow, I do not want to make drivers run on W2K3 but simply be able to install user mode software on W2K3. Recently I have had problems with webcam drivers, photoshop cs3 and windows live writer .. their installer will tell you that they may run only on XP or Vista and yet I have an entire laptop running W2K3 that uses device drivers that were written for XP and everything works just fine!<br /></div><br />Oh, please do not insult. Just left click on the application and check comp. mode. So, the all os version api just work like xp/9x (or what ever you select)</div>
    <div class="meta">Posted on 2007-11-03 17:06:34 by Dite</div>
   </div>
   <div class="post" id="post-203442">
    <div class="subject"><a href="#post-203442">Re: Calculating the size in bytes of a C function </a></div>
    <div class="body">Dite,<br /><br />I suppose you meant size = EndOfMyFunction - myFunction;<br /><br />That is what I was doing already. And I said in my initial post, it works, apart the fact that you often end up considering padding bytes between functions as part of the size count. But I suppose at this point that this is as good as one can get.<br /><br />As for the compatibility mode, well, I tried it and, alas, it did not allow what I hoped for.<br /><br />LocoDelAssembly, I believe support effort is the reason for restricting supported OS as much as possible. Why should I support my product on more OS if I know that one given OS has a small user base and support issues deriving from that single OS may be numerous? It&#039;s easier to just state that you don&#039;t support it.<br /><br />yaa<br /><br /></div>
    <div class="meta">Posted on 2007-11-03 18:12:04 by yaa</div>
   </div>
   <div class="post" id="post-203443">
    <div class="subject"><a href="#post-203443">Re: Calculating the size in bytes of a C function </a></div>
    <div class="body"><div class="quote"><br />Now, what precisely do you need to do? As they say: &quot;the more precisely you ask, the more precisely they answer&quot; (or something like that ^^&#039;).<br /></div><br /><br />Based on what I&#039;ve seen, code injection usually takes 2 forms: windows hooks and remote loading of DLLs. The last I&#039;ve already done. Easy enough. What I don&#039;t like is the presence of this external DLL. Simply ugly. Another approach I&#039;m trying is writing code to the remote process and redirecting the interested APIs (at the moment GetVersion, GetVersionExA, GetVerionExW and VerifyVersionInfo) to my code.<br /><br />With the remotely loaded DLL everything is simplified, you can place any call in the DLL<br />(local call or API call) and everything will work fine (offsets are ok already and the DLL has it&#039;s on IAT so you can call anything you need).<br /><br />With the code injected inside the remote process there are tricky areas to consider:<br /><br />1) local function calls - either you maintain the same *distance* between functions/procedures inside the binary as there is in your injecting application or offsets will have to be edited<br /><br />2) Windows APIs: IAT entry dwords will probably differ between you injecting application and the target process<br /><br /><pre><code>CALL DWORD PTR DS:&nbsp; &nbsp; &nbsp; &nbsp; ; xxxxxxxx will probably be different in the target process</code></pre><br /><br />3) static/global data: space will have to be allocated in the remote process and references to this data will have to be edited<br /><br />I may still be missing other areas of attention ....<br /><br />I suppose there is no other approach apart having the byte stream to inject (the functions that will handle the redirected API calls) and know which address bytes to edit inside the byte stream. I honestly don&#039;t like this approach because any change required to the functions requires editing the byte stream and changing the code responsible for patching the addresses (offset or absolute) inside the byte stream.<br /><br />My questions are two at this point:<br /><br />a) is there any other area of attention to consider when writing code that will be relocated (as the one that I will inject)?<br /><br />b) is there any other more manageable solution apart the byte stream + address patching code approach?<br /><br /><br />yaa<br /><br /><br /></div>
    <div class="meta">Posted on 2007-11-03 19:13:38 by yaa</div>
   </div>
   <div class="post" id="post-203444">
    <div class="subject"><a href="#post-203444">Re: Calculating the size in bytes of a C function </a></div>
    <div class="body">What I don&#039;t understand is that if you&#039;re trying to patch some specific, well known (at least for you) application, then why not simply scan it (manually with an editor), find its references to the aforementioned functions, find its relocations, etc, etc, and then change the jumps/calls appropriately. It&#039;s as easy as writing relocatable code which calls (real) functions, finding some place for it inside the exe, writing it there, and patching all references to real functions inside that exe.<br /><br />So I either still don&#039;t understand what you&#039;re trying to say, or you&#039;re trying to do your work the hard way ^^&#039;</div>
    <div class="meta">Posted on 2007-11-03 20:28:00 by ti_mo_n</div>
   </div>
   <div class="post" id="post-203445">
    <div class="subject"><a href="#post-203445">Re: Calculating the size in bytes of a C function </a></div>
    <div class="body">Well, the applications are those I mentioned. But I want to pull out a tool that will do the job the next time I encounter another application.<br />You asked for the details and I believe I&#039;ve been as clear as I could be ... I do not see what it is that you still do not understand at this point.<br /><br />yaa<br /></div>
    <div class="meta">Posted on 2007-11-03 20:34:48 by yaa</div>
   </div>
   <div class="post" id="post-203446">
    <div class="subject"><a href="#post-203446">Re: Calculating the size in bytes of a C function </a></div>
    <div class="body"><div class="quote"><br />LocoDelAssembly, I believe support effort is the reason for restricting supported OS as much as possible. Why should I support my product on more OS if I know that one given OS has a small user base and support issues deriving from that single OS may be numerous? It&#039;s easier to just state that you don&#039;t support it.</div><br /><br />I agree with that, but I mean the case in which the software producer sells another version that works in a Windows Server and it is more expensive. For example, Norton Anti-Virus don&#039;t allow you to install a home version of its product on a Windows Server, even though the binary is fully capable to run on it. So, by changing the result of GetVersion to WinXP Home or Professional you could save some bucks by purchasing a home license of the anti-virus, but such thing is illegal.<br /><br />That is the example I&#039;m talking about, but I think it is OK in the case that the program complains just because it is an unsupported OS to change GetVersion behaviour. (Even Windows itself allows something around this by the right-click on executable-&gt;compatibility mode as Dite said).</div>
    <div class="meta">Posted on 2007-11-03 20:57:30 by LocoDelAssembly</div>
   </div>
   <div class="post" id="post-203465">
    <div class="subject"><a href="#post-203465">Re: Calculating the size in bytes of a C function </a></div>
    <div class="body"><div class="quote"><br />The reason for the applications that works even when cheated about the Windows version is because them actually want to prevent the ILLEGAL use of them. Where it is the illegality? Simple, home and/or workstation licences of a given product are normally a lot cheaper compared to its enterprise/server counterparts. So, depending on the context, convincing a program that the Windows version is different than what actually it is can be used for illegal proposes.<br /></div><br />Yes, some of the free antivirus programs, for instance, requires a license for server use - I sure hope this isn&#039;t what <strong>yaa</strong> is trying to circumvent (although you could argue that a Server OS used for a workstation, as I know many people are doing with win2k3, isn&#039;t really &quot;server use&quot; - still, it&#039;s a violation of license).<br /><br />There&#039;s enough badly-written software that doesn&#039;t do it&#039;s version-checking right, though, and &quot;compatibility mode&quot; for some reason doesn&#039;t always get it right. So I guess this topic is okay, even if a bit &quot;edgy&quot;.<br /><br /><strong>yaa</strong>: get used to an external DLL when doing code injection, it is <strong>not</strong> ugly - the various workarounds people try to avoid it are far uglier. With the DLL method you don&#039;t have to jump through any hoops or write code specially, no delta-relativeness, manual fixups, etc etc etc. And anything you can try doing in C/C++ will eventually explode in your face if you change compiler, optimization settings, or the phase of the moon.<br /><br />The only reason I can think of for not wanting an external DLL or calling it &quot;ugly&quot; is if you&#039;re writing malware and want a one-click-infector.exe that doesn&#039;t dump any temporary DLL files... for legitimate purposes, DLL injection is by far the cleanest and easiest way to go.<br /><br />And legitimate purposes are what we&#039;re dealing with here, right?<br /></div>
    <div class="meta">Posted on 2007-11-04 14:50:58 by f0dder</div>
   </div>
  </div>
 </body>
</html>