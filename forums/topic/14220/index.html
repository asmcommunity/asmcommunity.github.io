<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>More OOP crazyness - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=14220" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=38">Object Oriented Programming</a> &raquo; <a href="../?id=14220">More OOP crazyness</a></p>
   <div class="post" id="post-110055">
    <div class="subject"><a href="#post-110055">More OOP crazyness</a></div>
    <div class="body">Well I have to say im very impressed with something that &quot;happened&quot; out of the blue today.<br /><br />I origionally was writting some source to help RadioSys handle his MaskedEdit box custom control question, when I hit the wall wishing i has a good robust String class for OOP.  This led me to designing an OOP class for such, but then hit the wall due to the length (there is about 20 or so methods).  With the current NaN &amp; Thomas OOP model, you would have alot of redundat memory allocations as each instance would get a copy of the function pointers.<br /><br />And it was here it hit me how to actually implement Vtables :grin: for our OOP model.  Im 80% finished after one night, and its about 1/3 the macro source as well!  It appears full Inheritance will also be supported, and i might be able to do something towards Overloading methods as well. <br /><br />I will finish it up very soon.  Im upset i have to stop, to sleep for work tomorrow ;) !  Im really getting into this, watching it come together so well....  As well this String class has OLE functions to convert to BSTR and back (which will be very usefull in COM ).  Just gotta finish the OOP engine that will drive this class via. VTables.<br /><br />:NaN:`</div>
    <div class="meta">Posted on 2003-07-11 00:17:03 by NaN</div>
   </div>
   <div class="post" id="post-110086">
    <div class="subject"><a href="#post-110086">More OOP crazyness</a></div>
    <div class="body">It's not difficult to implement VTable by using macros(how powerful the assembly macro is :) ).<br />How ever, VTable macros will generate too much symbols and take too much assembly time.<br />MASM doesn't support internal VTable, so maybe such macros are necessary for MASM.</div>
    <div class="meta">Posted on 2003-07-11 05:26:04 by KomsBomb</div>
   </div>
   <div class="post" id="post-110138">
    <div class="subject"><a href="#post-110138">More OOP crazyness</a></div>
    <div class="body">Macros are quite powerfull... and there is not a noticable overhead in using them (im not concerned here personally).<br /><br /><br />I have to say tho, im nearly finished, and it works 50x better than the previous version.  The thing is im amazed at how fast it is to develope this time around.  The old model took Thomas and I weeks to hack out.  But this time I got a stronger model together in just under 12 hours!!<br /><br />I guess experience has alot to say for it self.  A good portion of the previous development time went into MASM R&amp;D, to sorta find its limits with macros... I dont have to do that this time around....<br /><br />Anywho, I have full inheritance working at this point.  The objects are static vtables of function pointers, and no longer than their 'stand alown' size.  That is the size of the object as uninherited.  When you inherit to make a new object, its vtable size is only the addtional methods above and beyond the inherited object class. (which also saves memory space).  Data is totaly private and called from the heap.  Each heap data block constitutes the ENTIRE instance memory.  Only one pointer extra is included (for the vtable pointer) ~ which is a definite bonus for memory savings!<br /><br />I have also cleaned up the coding requirements to 'define' classes.  There is alot less work needed (class formatting etc) than the previous version.  Only downside i can see at the moment is i abandoned initializing the data on creation.  If you want to initialize an instance's data, you will have to spell it out in the constructor.  (This is not a big deal tho.  It was a trade off to have this feature and a great deal more complexity, or give it up for simplicity... I took the latter.... ;)<br /><br />Method calling is done via a recursive method macro, which will retrace through as many vtables as it needs to call methods... (this was the hardest part ~ its all done at compile time, so there is only 2 or 3 lines of run time assembly).<br /><br />My only remaining problem that i see is Polymorphism.  I think it can be done too, but it will be more of a manual step than a macro automated one.  Im still pondering on this...  WHen inheritance happens, the highest level vtable is pointed to by the instance object (heap memory).  This vtable has all the methods for it, and also points to an inherited vtable (if used), etc. etc.  So the object vtable is a linked list of vtables.  As more object classes are defined more than one vtable can point the a common other.  So if i modify the 'other' for polymorphism, all other inherited vtables would also recieve this (which may not be desired).<br /><br />The alternate is to &quot;copy&quot; the vtable, make polymorphic rerouting to alternate function pointers, and the change the vtble links to route through the altered copy on a specific class...  this will most definitely need to be a run-time proceedure in the constructor of the class that offers a polymorphic function(s)...<br /><br />Anywho here is a small taste of what it looks like at the moment:<pre><code>A_Init   PROTO &#58;DWORD<br /><br />DEF_CLASS_METHODS A<br />   CMETHOD  data1, input_data&#58;DWORD<br />   CMETHOD  data3<br />END_CLASS_METHODS<br /><br />DEF_CLASS_DATA A<br />   A1 dw ?<br />   A2 dw ?<br />END_CLASS_DATA<br /><br />BUILD_VTABLE A,NULL<br />   dd    offset   Function1<br />   dd    offset   Function3</code></pre><br /><br />This is all the 'overhead' required, asside from the functions for the class.  This class is called 'A' and has two methods &quot;data1&quot; and &quot;data2&quot; with params as needed.  It has two WORD size private data, and the Vtable for it (with the function offsets following is).<br /><br />I hope your impressed by the size ;) .  I am :alright:<br />:NaN:</div>
    <div class="meta">Posted on 2003-07-11 17:48:23 by NaN</div>
   </div>
   <div class="post" id="post-110160">
    <div class="subject"><a href="#post-110160">More OOP crazyness</a></div>
    <div class="body">LOL..<br /><br />Man, you know your on the right track when it just falls together...<br /><br />Turns out i dont need to make any run-time processing for polymorphism/interfaces...  It only took one more 4 line macro and 3 extra lines of code in the recursive METHOD macro... lol!<br /><br />Its working pretty sweet at the moment... Last thing to do is see if i can get method overloading working...  last step.  I know how to do it, just not sure how it will weigh in with the rest of the macro systems...<br /><br />Couple more hours and i will release the source...<br />:alright:<br />:NaN:</div>
    <div class="meta">Posted on 2003-07-11 21:26:40 by NaN</div>
   </div>
   <div class="post" id="post-110170">
    <div class="subject"><a href="#post-110170">More OOP crazyness</a></div>
    <div class="body">LOL, NaN got a <a target="_blank" href="http://catb.org/~esr/jargon/html/G/geekasm.html"><u>geekasm</u></a>.</div>
    <div class="meta">Posted on 2003-07-12 01:32:04 by Paulicles the Philosopher</div>
   </div>
   <div class="post" id="post-110204">
    <div class="subject"><a href="#post-110204">More OOP crazyness</a></div>
    <div class="body">Ya i guess so &lt;lol&gt;...<br /><br />Down side is I discovered my solution to polymorphism is only half correct... i have a bit of a snag on my hands at the moment.<br /><br />Example: I have three classes, IDraw (draw interface), CLine, CSquare<br /><br />Cline inherits IDraw<br />CSquare inherits CLine<br /><br />If i go CSquare:Draw, i get a &quot;Draw Square&quot;<br />If i go CLine:Draw, i get a &quot;Draw Line&quot;<br />If i go CLine:Draw on the CSquare handle, i get &quot;Draw Line&quot; &lt;&lt;&lt; Problem here<br /><br />So in essence i have OVERRIDING inherited methods working, but polymorphic calling is not..  I have to somehow identify at compile time what the handle points to (type of class), or like I said above, custom vtables... either way its not looking like a quick solution....<br /><br />:NaN:</div>
    <div class="meta">Posted on 2003-07-12 12:05:22 by NaN</div>
   </div>
   <div class="post" id="post-110323">
    <div class="subject"><a href="#post-110323">More OOP crazyness</a></div>
    <div class="body">I see this thread is getting alot of views, so I decided to explain more about what the model is.<br /><br />Below is an image of how its memory is organized.  I have two examples shown on it.  A Class call Line, and a Class called Square.  The line class has its own methods, A, B, C, D.  The Square Class INHERITS the Line class and adds four more additional methods, E, F, G, H. <br /><br />Instance data is private to each instance, and is not broken apart.  Line has 4 data members, and (not shown correctly) square would have these four and an additional 4 in one complete heap memory object.  (( To save space, the picture still shows 4 instance data members for the square )).<br /><br />Inheritance is done by pointing back to the vtable that a class inherits from.  Through some macro magic and a couple of text equates, I have managed the decision process as to weather or not a method is nested further back down the inheritance list or not. <br /><br />This scheme works very efficiently, since different instance objects overlap and reuse vtables for different classes.  This greatly saves .data memory if you have alot of object classes included in your program.  However, this efficiency is also the thorn in my side, since it doesnt work very well with polymorphism.  If i take the Square intance object, and say &quot;call Line.Method_C&quot;, the MACROS at compile time will follow the lower route just as if the Square Instance was actually a Line Instance.  After all the computer has no clue what is what, it just works off the info you give it.  This is why you have to say &quot;Square.method name&quot; or &quot;Line.method name&quot;.  The program uses the first param &quot;square&quot; or &quot;line&quot; to know what STRUCTURE template to apply on the instance object.<br /><br />Inheritance &quot;wraps&quot; around the inherited class, so the alignment of the inherited methods are the same location as the base class itself.  So in essence the closes to the begining of a class structure, the more likely the method was inherited.  Again, for strait inheritance with no need for polymorphism, this is the idea situation!</div>
    <div class="meta">Posted on 2003-07-13 17:31:07 by NaN</div>
   </div>
   <div class="post" id="post-110327">
    <div class="subject"><a href="#post-110327">More OOP crazyness</a></div>
    <div class="body">Now the question im still fighting over is *how* to I work with this structure and allow for polymorphism as well?  My only working answer I can come up with is to make a uniquely new vtble for classes that want to override inherited methods for polymorphism. <br /><br />This would mean the class would be one VTBLE deep, and its inheritance ptr would point to null automatically.  It also means that if there is many layers of inheritance, it would have to copy all the vtble layers recursively into a separate vtble just for this *special* class.  This will work, becuase to allow for polymorphism, it basically nullifys the ability to tansverse back down the inheritance tree to the method pointer its looking for, and instead provide a complete list at the top level vtble, in order as dictated by the class method structure.<br /><br />Now the problem with this:  Destructors, and Constructors.  Destructors are called automatically, and do not have method arguments that is defined by the programmer.  They are called in order from the highest level, back to the base level, in an inheritance scheme.   This ensures the &quot;wapped&quot; layers can free and close down memory, utilizing inherited methods, before this layer is negatted. etc.<br /><br />I can not do this if i have compiled the layers into one!  There will be only ONE destructor pointer, because there is only one vtble layer.  As well Constructors work in the reverse.  They start from the base level, and allocate resources as needed, before running the inherited constructor, which may require the presence of inherited methods (and resources).  Again, im not sure how i would handle this if i compiled this into one construtor layer.<br /><br />I hope you see my problem here with polymorphism.  If you have suggestions, or questions to my explainations, please offer/ask them!  This model is far better than the previous OOP model, IMHO.  Its coding requirments are far simpler, and there is less macro overhead as well.  I just need to figure this out to make it a good strong OOP model for use by MASM users.<br /><br />Regards,<br />:NaN:</div>
    <div class="meta">Posted on 2003-07-13 17:41:19 by NaN</div>
   </div>
   <div class="post" id="post-110378">
    <div class="subject"><a href="#post-110378">Classy work</a></div>
    <div class="body">Negative pointer offsets? That's really classy*, like how they make BSTRs hold their own length at [-4] bytes from the pointer.<br /><br />I bet you could figure out <em>MULTIPLE INHERITANCE</em> (Ta ta ta!) by creating as table of inheritance pointers, or a pointer to table, or something.<br /><br />I have always wished for a compiler or assembler that would have monstrously powerful preprocessor features, like lists and variables that would hold information. If I ever write a compiler, I will do something like that.<br /><br />* No pun intended</div>
    <div class="meta">Posted on 2003-07-14 00:56:11 by Paulicles the Philosopher</div>
   </div>
   <div class="post" id="post-110475">
    <div class="subject"><a href="#post-110475">More OOP crazyness</a></div>
    <div class="body">Ya, the negative offsets came out of necessity.  I want to use a structure at compile time to organize the methods into a class,  but i DONT want to have vtables any longer than they need, and link them as shown above.<br /><br />Problem was having the destructor on each class, you cant simply chain them together, or else you get repeated destructors in the middle of a class structure.  So thats when i caught on to the fact that Struct.StructValue == is always positive.  If i make the destructor and other stuff negative from a base point, i *can* chain vtables together ;) .  ANd this is how it works now.  And works very well i might add!<br /><br />Still thinking on what to do with polymorphism tho.  (Took the weekend off)...<br />:NaN:</div>
    <div class="meta">Posted on 2003-07-14 16:59:36 by NaN</div>
   </div>
   <div class="post" id="post-110504">
    <div class="subject"><a href="#post-110504">More OOP crazyness</a></div>
    <div class="body">What about multiple inheritance?<br /><br />How does class cDOG inherate from both cPAWS and cNOSE?<br /><br /><br /><br />Remineds me: My dog has no nose.<br /><br />Passer by: Oh dear, how does he smell?<br /><br />me: AWEFUL!!!</div>
    <div class="meta">Posted on 2003-07-14 22:45:49 by Ernie</div>
   </div>
   <div class="post" id="post-110510">
    <div class="subject"><a href="#post-110510">More OOP crazyness</a></div>
    <div class="body">this type of stuff is why i use c with classes A.K.A c++. :alright:</div>
    <div class="meta">Posted on 2003-07-15 00:03:10 by Qages</div>
   </div>
   <div class="post" id="post-110511">
    <div class="subject"><a href="#post-110511">More OOP crazyness</a></div>
    <div class="body">Its designed to inherit (single) back as far as MASM can recurse.  It will not inherit two interfaces/classes at once however.  I will leave that stuf up to Java ;)<br /><br />I now have polymorphism working. ( big wide-eye grin )<br /><br />It was probably the hardest part.  If you know your class needs to be used polymorphically with other such classes that inherit a common base/interface, you have to specify in the class layout.  It builds an alternate vtable with no linking (as shown above).  Instead it parses what *would* have been the vtable list above, and copies out all the function pointers into a flat, single level vtable.  With this done, you can OVERRIDE methods with alternate methods.<br /><br />Here is my example source:<pre><code>;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;<br />CLine_Init   PROTO &#58;DWORD<br /><br />DEF_CLASS_METHODS CLine          ; Define class methods<br />   CMETHOD  Draw, A&#58;DWORD<br />   CMETHOD  Dar2, A&#58;DWORD<br />   CMETHOD  Dar3, A&#58;DWORD<br />   CMETHOD  Dar4, A&#58;DWORD<br />END_CLASS_METHODS<br /><br />DEF_CLASS_DATA CLine             ; Define Class data members<br />   A1 dd ?<br />END_CLASS_DATA<br /><br />BUILD_VTABLE CLine               ; Define Class method functions<br />   @PROC CLine.Draw, Function1<br />   @PROC CLine.Dar2, Function1<br />   @PROC CLine.Dar3, Function1<br />   @PROC CLine.Dar4, Function1<br />   <br />;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;   <br />CCircle_Init   PROTO &#58;DWORD<br /><br />DEF_CLASS_METHODS CCircle, CLine    ; Circle Methods Inherits Line<br />   CMETHOD  Draw2<br />END_CLASS_METHODS<br /><br />DEF_CLASS_DATA CCircle, CLine       ; Circle Data inherits Line<br />   A2 dd ?<br />END_CLASS_DATA<br /><br />BUILD_SINGLE_VTABLE CCircle, CLine  ; Polymorphic VTABLE, &amp; additional method<br />   @PROC CCircle.Draw2, Function4<br />   <br />;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;   <br />CSquare_Init   PROTO &#58;DWORD         <br /><br />DEF_CLASS_METHODS CSquare, CCircle  ; Square Methods Inherits Circle<br />   CMETHOD  Draw3<br />END_CLASS_METHODS<br /><br />DEF_CLASS_DATA CSquare, CCircle     ; Square Data Inherits Circle<br />   A3 dd ?<br />END_CLASS_DATA<br /><br />BUILD_SINGLE_VTABLE CSquare, CCircle   ; Polymorphic VTABLE &amp; additional method<br />   @PROC CSquare.Draw3, Function4<br />   <br />;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;%&amp;</code></pre><br /><br />If your confused, the three class method structures would look like:<pre><code>CLINE STRUC<br />   Draw<br />   Dar2<br />   Dar3<br />   Dar4<br />CLINE ENDS<br /><br />CCIRCLE STRUC<br />   Draw<br />   Dar2<br />   Dar3<br />   Dar4<br />   Draw2<br />CCIRCLE ENDS<br /><br />CSQUARE STRUC<br />   Draw<br />   Dar2<br />   Dar3<br />   Dar4<br />   Draw2<br />   Draw3<br />CSQUARE ENDS</code></pre><br /><br />The source used to test these classes is:<pre><code>   OVERRIDE CCircle, Draw, Function2<br />   OVERRIDE CSquare, Draw, Function3<br /><br />   NEWOBJECT CLine<br />   mov hObj, eax<br />   METHOD hObj, CLine.Draw, 1<br />   DESTROY hObj<br /><br />   PrintText &quot;=========================&quot;<br /><br />   NEWOBJECT CCircle<br />   mov hObj, eax<br />   METHOD hObj, CLine.Draw, 1<br />   DESTROY hObj<br /><br />   PrintText &quot;=========================&quot;<br /><br />   NEWOBJECT CSquare<br />   mov hObj, eax<br />   METHOD hObj, CLine.Draw, 1<br />   DESTROY hObj</code></pre><br /><br />The resulting outputs:<pre><code>Line Constructor<br />Draw a Line<br />Line Destructor<br />=========================<br />Circle Constructor<br />Draw a Circle<br />Circle Destructor<br />=========================<br />CSquare Constructor<br />Draw a CSquare<br />CSquare Destructor</code></pre><br /><br />The think to see here is in all cases the object was called with the &quot;CLine.Draw&quot; indication.  Since i have made *special* vtables for polymorphism, the OVERRIDE macro is used to redirect the function pointer to a more suitable function for the particular class method.  This is how you end up with &quot;Draw a Square&quot; and &quot;Draw a Circle&quot; for outputs.<br /><br />If i didnt want to use polymorphism, memeory would be better utilized as outlined above, and internal vtable linking would take place, from square to circle, to line.  The downside (as discussed above) is that Callin CLine.Draw on the square hObj handle, will result in the CLine.Draw method &quot;Draw a Line&quot;, since that is what was explicitly asked for.<br /><br />I will clean up the macro file tomorrow and release it for those interested.  For now this is about all i want to provide... Im tired, and happy ;)<br /><br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-07-15 00:05:40 by NaN</div>
   </div>
   <div class="post" id="post-110514">
    <div class="subject"><a href="#post-110514">More OOP crazyness</a></div>
    <div class="body">BTW, the OVERRIDE statements must be in the code segment, but doesnt need to be outside of the class's.  I only put it there for simplicity in testing.  The best place to override a class's methods is in its constructor.  That way its out of your face, and you dont need to think about it.<br /><br />:NaN:</div>
    <div class="meta">Posted on 2003-07-15 00:19:53 by NaN</div>
   </div>
   <div class="post" id="post-110518">
    <div class="subject"><a href="#post-110518">More OOP crazyness</a></div>
    <div class="body">NaN, I am taowen. I am receiving military training, so I do not have much time to see what new things you have discovered. I am very happy to see you pick up OOP again.<br />I have done a lot of work around it, and I have published it. And now, I have some new idea about it, and after I think it over, I will post it, too.<br />I don't know you have got what version of my MOOP. I can give you a newest version. And I recently tend to using a external exe file to do coverting that is a preprocessor. I have thought the difficult and trade-off in my design, and the problem of porting, using a preprocessor just let the IDE to do one more step but provide more flexible and powerful ability.<br />8.4, I will be free. Then, I can use MACRO to complete a final version. You can see the syntax of asm will be changed greatly. After such final version, I will do some experiment on preprocessor or even a new assembler. <br /><br />Can you explain the TYPE system of your oop model which is very important to OOP. typed assembly language is somewhat hard to design. And how to invoke the method of object using a ptr, where a register is a must, use which register and how to use is a big problem.<br /><br />Thank you for your help when I was designing my work, and if you need, I can help you when you designing your model.</div>
    <div class="meta">Posted on 2003-07-15 00:51:47 by taowen2002</div>
   </div>
  </div>
 </body>
</html>