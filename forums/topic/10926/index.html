<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Converting MASM lines to FASM - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=10926" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=10926">Converting MASM lines to FASM</a></p>
   <div class="post" id="post-82380">
    <div class="subject"><a href="#post-82380">Converting MASM lines to FASM</a></div>
    <div class="body">How can I convert this lines from MASM to FASM <br />Can some body please tell me how to convert this lines from MASM to FASM and can some body explain me what do they mean?<br /><br />mov eax, pPicture<br />push eax<br />mov eax, <br />call .IPicture.Render<br /><br />Thanks alot for your help I'm new on Assembly :rolleyes:</div>
    <div class="meta">Posted on 2003-02-17 22:12:47 by alonso</div>
   </div>
   <div class="post" id="post-82385">
    <div class="subject"><a href="#post-82385">Converting MASM lines to FASM</a></div>
    <div class="body">This is a COM call to a virtual function.<br /><br />Its not Masm specific.  It is M$ OLE specific.<br /><br />Your source is<ul><br />[*]Taking a pointer of an interface structure (in memory).<br />[*]Pushing the 'this interface' object parameter so the render method will operate on the object/interface that called in the first place.<br />[*]Then exctracting the virtual function table pointer from the interface structure.  Its always the first DWORD of any Interface.<br />[*]Then calling the 'Render' function pointer located in the virtual function table.  All the functions have lables such as 'Render' cause they are actualy a stucture of DWORD function pointers.  One function pointer to one structure name.  So effectively the call is doing something like &quot;call &quot; where 12 (hypothetically) could be the third function pointer called &quot;Render&quot; (3 * 4bytes = 12).  I dont know what the *real* offset is for Render in this interface. But you get the idea.<br /><br />Well there you go.  I dont use FASM, never have, so i cant help you much more than this. (However, i would be surprised if FASM can't handly what you have posted.  Its pretty simple operations).<br /><br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-02-17 22:51:04 by NaN</div>
   </div>
   <div class="post" id="post-82595">
    <div class="subject"><a href="#post-82595">Thanks for your help</a></div>
    <div class="body">Thanks for your help NaN<br /><br />Let me see if I got this right!<br /><br />You say that you can Use an API call to get a group of pointers to certain function and this function have subfunctions, so you when you use Call .IPicture.Render your calling a subrutine which IPicture.Render has the address where that subroutine starts, if that is the case why don't just use IPicture.Render not <br /> <br />Sincerely:<br />              Alonso Murillo<br /><br /><div class="quote"><br />This is a COM call to a virtual function.<br /><br />Its not Masm specific.  It is M$ OLE specific.<br /><br />Your source is<ul><br />[*]Taking a pointer of an interface structure (in memory).<br />[*]Pushing the 'this interface' object parameter so the render method will operate on the object/interface that called in the first place.<br />[*]Then exctracting the virtual function table pointer from the interface structure.  Its always the first DWORD of any Interface.<br />[*]Then calling the 'Render' function pointer located in the virtual function table.  All the functions have lables such as 'Render' cause they are actualy a stucture of DWORD function pointers.  One function pointer to one structure name.  So effectively the call is doing something like &quot;call &quot; where 12 (hypothetically) could be the third function pointer called &quot;Render&quot; (3 * 4bytes = 12).  I dont know what the *real* offset is for Render in this interface. But you get the idea.<br /><br />Well there you go.  I dont use FASM, never have, so i cant help you much more than this. (However, i would be surprised if FASM can't handly what you have posted.  Its pretty simple operations).<br /><br />:alright:<br />NaN </div></div>
    <div class="meta">Posted on 2003-02-19 07:23:12 by alonso</div>
   </div>
   <div class="post" id="post-82719">
    <div class="subject"><a href="#post-82719">Converting MASM lines to FASM</a></div>
    <div class="body">no, there is no API's in this picture.. only memory, memory pointers, and function pointers.  Here is another stab at putting the picture together.  I made up fake memory addresses and function pointers, but the intent is how it actually works<pre><code>&#40;hypothetical picture here&#41;<br /><br />Interface in memory&#58; pIPicture == 0062A2F4h<br />-----------------------------------------<br />0062A2F4h &#58; 0077E304h &#40;vtable pointer&#41;<br />          &#58; and<br />          &#58; other<br />          &#58; Interface<br />          &#58; specific<br />          &#58; memory<br />          &#58; Variables<br />          <br />Virtual Function pointer table for all<br />interface methods/property functions == 0077E304h<br />-------------------------------------------------<br /><br />0077E304h &#58; 00123456h &#40;function #1 pointer&#41;<br />          &#58; 00234567h &#40;function #2 pointer&#41;<br />          &#58; 00345678h &#40;Render function pointer&#41;<br />          &#58; 00456789h &#40;function #4 pointer&#41;<br />          &#58; etc. <br />          &#58; etc.<br />          <br /><br />The IPicture Interface structure could be&#58;<br /><br />IPicture STRUC<br />   fucntion#1  dd ?<br />   fucntion#2  dd ?<br />   Render      dd ?<br />   function#3  dd ?<br />   etc.<br />   etc.<br />IPicture ENDS<br /><br />So by getting an interface pointer &#40;0062A2F4h&#41;,<br /><br />     mov eax, 0062A2F4h<br /><br />And then getting the vtable pointer,<br /><br />     mov eax, &#91;eax&#93; ; &#40;eax == 0077E304h&#41;<br /><br />And then applying a structure to look up the<br />&quot;Render function pointer&quot;<br /><br />     mov edx, &#91;eax&#93;.IPicture.Render <br />     ;; Edx now has 00345678h<br />     <br />Always push the interface pointer, so the function<br />will operate on interface specific memory &#40;as <br />indicated above in the interface memory map&#41;.<br /><br />     push 0062A2F4h<br />     <br />Now call the fucntion that was looked up to do<br />the render operation on the interface that<br />called it.<br /><br />     call edx</code></pre><br /><br />:NaN:</div>
    <div class="meta">Posted on 2003-02-20 00:35:08 by NaN</div>
   </div>
   <div class="post" id="post-82733">
    <div class="subject"><a href="#post-82733">Converting MASM lines to FASM</a></div>
    <div class="body">wouldnt it look something like this<br /><br /><pre><code><br />mov eax, &#91;pPicture&#93;<br />push eax<br />mov eax, &#91;eax&#93;<br /><br />virtual at eax<br />eax IPicture<br />end virtual<br /><br />call &#91;eax.Render&#93;<br /><br /></code></pre><br /><br />i've never used this but this mite work.</div>
    <div class="meta">Posted on 2003-02-20 03:51:14 by keyoke</div>
   </div>
   <div class="post" id="post-82768">
    <div class="subject"><a href="#post-82768">Yes, there is API Call</a></div>
    <div class="body">Thanks,<br /><br />           Nan for your patience and help, sorry to Contradict you but there is an API call involve on this.<pre><code><br />IPicture STRUCT<br />    ; IUnknown methods<br />    QueryInterface          DWORD   ?<br />    AddRef                  DWORD   ?<br />    Release                 DWORD   ?<br />    ; IPicture methods<br />    get_Handle              DWORD   ?<br />    get_hPal                DWORD   ?<br />    get_Type                DWORD   ?<br />    get_Width               DWORD   ?<br />    get_Height              DWORD   ?<br />    Render                  DWORD   ?<br />    set_hPal                DWORD   ?<br />    get_CurDC               DWORD   ?<br />    SelectPicture           DWORD   ?<br />    get_KeepOriginalFormat  DWORD   ?<br />    put_KeepOriginalFormat  DWORD   ?<br />    PictureChanged          DWORD   ?<br />    SaveAsFile              DWORD   ?<br />    get_Attributes          DWORD   ?<br />IPicture ENDS <br /><br />   invoke OleLoadPicture, pStream, NULL, TRUE, ADDR IID_IPicture, ADDR pPicture   <br /><br />  ; ok, now we have our bitmap mounted onto our temporary DC, let's blit to it<br />    ; &#40;IPicture&#41;pPicture&#58;&#58;Render&#40;hdc, x, y, cx, cy,                            \<br />    ;                            xpos_himetric, ypos_himetric,                 \<br />    ;                            xsize_himetric, ysize_himetric, *rectBounds&#41;<br />    push NULL   ; *rectBounds<br />    push neghmHeight<br />    push hmWidth<br />    push hmHeight<br />    push 0<br />    push dwHeight<br />    push dwWidth<br />    push 0<br />    push 0<br />    push tempDC<br />    mov eax, pPicture<br />    push eax<br />    mov eax, &#91;eax&#93;<br />    call &#91;eax&#93;.IPicture.Render</code></pre><br /><br />What I'm asking is why can we use <strong>mov eax,IPicture.Render</strong>  instead of mov eax, pPicture, because IPicture.Render should have a pointer to the sub that we want to call.<br /><br />Thanks alot again.<br /><br />Sincerely, Alonso Murillo.<br /><br />.:EDIT:. <em>Added code blocks for readablility</em></div>
    <div class="meta">Posted on 2003-02-20 08:43:54 by alonso</div>
   </div>
   <div class="post" id="post-82853">
    <div class="subject"><a href="#post-82853">Converting MASM lines to FASM</a></div>
    <div class="body">Because IPicture is not data.  It is a data <strong>format</strong> or <strong>layout</strong>.<br />It is also a data type.<br />You must allocate (define) data of type IPicture, or use a pointer of type IPicture.<br />MASM allows you to force the type of a register-based address with the <strong>.IPicture</strong> notation.</div>
    <div class="meta">Posted on 2003-02-20 21:20:29 by tenkey</div>
   </div>
   <div class="post" id="post-82896">
    <div class="subject"><a href="#post-82896">Re: Yes, there is API Call</a></div>
    <div class="body"><div class="quote"><em>Originally posted by alonso </em><br /><br />What I'm asking is why can we use <strong>mov eax,IPicture.Render</strong>  instead of mov eax, pPicture, because IPicture.Render should have a pointer to the sub that we want to call.</div><br /><br />Sure, if i only passed pPicture technically the computer would have all it needs.  But the computer is not a mind-reader.  I still has not IDEA what your intending when you throw an interface at it. <br /><br />Its like saying.. &quot;Call some function, and get it right&quot;.  You have to TELL it what function you want to call from the interface. You say &quot;here is my interface, with specific data stored in it&quot;, and then you look up the function you want to use on your data and say &quot;Now call this 'Render' function you happend to have in your interface, you will notice i pushed on the stack all the parameters you will need for this function, Mr. CPU&quot;.<br /><br />I cant explain this anymore.  I've done so from a memory map side, software side, and now an &quot;Im talking to my computer&quot; side.  If your still having problems with this concept you should re-read this thread a couple of times.<br /><br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-02-21 03:25:26 by NaN</div>
   </div>
   <div class="post" id="post-82897">
    <div class="subject"><a href="#post-82897">Converting MASM lines to FASM</a></div>
    <div class="body">Furthermore,<br /><br />Consider this.  What if the 'Render' function also needs to use the 'get_CurDC' function as part of its operation.  I need to give it the interface itself as the first param of any COM call, so that it is standardized and every COM function will know this fact.  If it needs to call something specific to itself, it will know the first param is the &quot;THIS&quot; interface pointer, and can look up other fucntions it needs from its vtable.<br /><br />The next two lines &quot;Mov eax, &quot; and &quot;Call .IPicture.Render&quot; is telling the CPU to call the specific Render function as i mentioned above.<br /><br />:NaN:</div>
    <div class="meta">Posted on 2003-02-21 03:32:21 by NaN</div>
   </div>
   <div class="post" id="post-82898">
    <div class="subject"><a href="#post-82898">Converting MASM lines to FASM</a></div>
    <div class="body">I also noticed your using the C++ definition as a guide:<br /><pre><code>; &#40;IPicture&#41;pPicture&#58;&#58;Render&#40;hdc, x, y, cx, cy,                            \<br />    ;                            xpos_himetric, ypos_himetric,                 \<br />    ;                            xsize_himetric, ysize_himetric, *rectBounds&#41;</code></pre><br /><br />This is correct for C++, as the C++ compiler does 'extra' work your not seing here.  There is *ALWYAS* a &quot;THIS INTERFACE&quot; pointer as the first param to any method call from a COM interface.  Since the guys who wrote C++ know this, they decided to hide this extra param from you.  After all it it would be extra typing that can be easily automated.<br /><br />In assembly this is not true.  MASM assumes NOTHING.   You need to fit the formate exactly and do the extra that C++ would have done for you.  In this case the MASM equivalent would be:<pre><code><br />; &#40;IPicture&#41;pPicture&#58;&#58;Render&#40; &#91;color=red&#93;IPicture * pPicture,&#91;/color&#93; hdc, x, y, cx, cy,                            \<br />    ;                            xpos_himetric, ypos_himetric,                 \<br />    ;                            xsize_himetric, ysize_himetric, *rectBounds&#41;</code></pre><pre><code>    push NULL<br />    push neghmHeight<br />    push hmWidth<br />    push hmHeight<br />    push 0<br />    push dwHeight<br />    push dwWidth<br />    push 0<br />    push 0<br />    push tempDC<br />&#91;color=red&#93;    mov eax, pPicture<br />    push eax&#91;/color&#93;</code></pre>And the C++ call:<pre><code>    &#91;color=red&#93;pPicture-&gt;Render &#91;/color&#93;&#40; hdc, x, y, cx, cy, xp, yp, xs, ys, NULL &#41; </code></pre><br /><br />Would become:<pre><code><br />&#91;color=red&#93;  mov eax, pPicture<br />  mov eax, &#91;eax&#93;<br />  call &#91;eax + 32&#93;&#91;/color&#93;  ; Since the &quot;Render&quot; method is after the 8th dword</code></pre><br /><br />If your lost why the +32 thing, i refer you to <a target="_blank" href="http://www.asmcommunity.net/board/showthread.php?s=&amp;postid=71094.msg71094">Here...</a><br /><br />There you go.  All the pieces are before you.  I leave it to you to consume and understand.<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-02-21 03:47:23 by NaN</div>
   </div>
   <div class="post" id="post-82929">
    <div class="subject"><a href="#post-82929">Converting MASM lines to FASM</a></div>
    <div class="body">You can use the &quot;comcall&quot; macro for it, it's included in the DDraw example in the FASMW package:<br /><pre><code><br />macro comcall object,proc,&#91;arg&#93;<br /> &#123; common<br />    if ~ arg eq<br />   reverse<br />     pushd arg<br />   common<br />    end if<br />    mov eax,&#91;object#.#handle&#93;<br />    push eax<br />    mov eax,&#91;eax&#93;<br />    call &#91;eax+object#.#proc&#93; &#125;<br /></code></pre><br />You need also the following definitions:<br /><pre><code><br />struc IPicture<br /> &#123;<br />    .handle                  dd  ?<br />   virtual at 0<br />    .QueryInterface          dd  ?<br />    .AddRef                  dd  ?<br />    .Release                 dd  ?<br />    .get_Handle              dd  ?<br />    .get_hPal                dd  ?<br />    .get_Type                dd  ?<br />    .get_Width               dd  ?<br />    .get_Height              dd  ?<br />    .Render                  dd  ?<br />    .set_hPal                dd  ?<br />    .get_CurDC               dd  ?<br />    .SelectPicture           dd  ?<br />    .get_KeepOriginalFormat  dd  ?<br />    .put_KeepOriginalFormat  dd  ?<br />    .PictureChanged          dd  ?<br />    .SaveAsFile              dd  ?<br />    .get_Attributes          dd  ?<br />   end virtual<br /> &#125;<br /><br />pPicture IPicture<br /></code></pre><br />and so your code can become:<br /><pre><code><br />comcall pPicture,Render<br /></code></pre></div>
    <div class="meta">Posted on 2003-02-21 07:43:03 by Tomasz Grysztar</div>
   </div>
   <div class="post" id="post-82959">
    <div class="subject"><a href="#post-82959">Thanks Alot</a></div>
    <div class="body">Thank you very much Privalov for your help, that's what just needed!</div>
    <div class="meta">Posted on 2003-02-21 10:16:46 by alonso</div>
   </div>
   <div class="post" id="post-83002">
    <div class="subject"><a href="#post-83002">Converting MASM lines to FASM</a></div>
    <div class="body">Well you can't say i didnt try to teach a man to fish ;P<br /><br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-02-21 16:56:25 by NaN</div>
   </div>
   <div class="post" id="post-83042">
    <div class="subject"><a href="#post-83042">Converting MASM lines to FASM</a></div>
    <div class="body">BTW: How would you use this calling convention if the pPicture interface was dynamically returned into EAX?<br /><br />How would FASM know that the value in eax is actually a pPicture pointer with out telling it at compile time?<br /><br />:NaN:</div>
    <div class="meta">Posted on 2003-02-21 22:04:27 by NaN</div>
   </div>
  </div>
 </body>
</html>