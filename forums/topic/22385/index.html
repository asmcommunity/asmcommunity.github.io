<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>how to make this code os/hardware independent? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=22385" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=22385">how to make this code os/hardware independent?</a></p>
   <div class="post" id="post-168011">
    <div class="subject"><a href="#post-168011">how to make this code os/hardware independent?</a></div>
    <div class="body">hi,<br />i want to map the videomemory of my gfx card into the address space of my device driver.so i go to the device manager and show the properties of my gfx card (NVIDIA GeForce 6600 GT) it has the following memory areas:<br />D7000000-D7FFFFFF<br />C0000000-CFFFFFFF<br />D8000000-D8FFFFFF<br /><br />C0000000 is the right physical address for the videomemory (i tried all 3 and it seems to be the correct one) so my asm code looks like this:<br /><br />invoke MmMapIoSpace, 0C0000000h, 0, 1024*768*4, 2 ;resolution 1024x768x32<br />mov vidmem, eax<br /><br />everything works fine and i can read/write to the videomemory but the problem is that i cant use a hardcoded physical address for the videomemory because it will change for every gfx card/os i suppose.so my question is how can i find out which physical address is the right one for the videomemory ?<br /><br />thanks in advance!</div>
    <div class="meta">Posted on 2005-11-18 17:56:52 by sHice</div>
   </div>
   <div class="post" id="post-168017">
    <div class="subject"><a href="#post-168017">Re: how to make this code os/hardware independent?</a></div>
    <div class="body">Good question - making your code OS independent would be a tough one (although it should be possible to target at least win2k and XP with the same code :)).<br /><br />I looked into this stuff some years ago, but gave up. Even with querying adapters, finding the video adapter, and querying it&#39;s memory ranges, I couldn&#39;t find a way of detecting which range was the framebuffer.<br /><br />Then there were the additional problems of detecting/setting video mode.<br /><br />I think the proper approach to this would be hooking into the low-level DirectX support routines, called &quot;DDI&quot; if I&#39;m not mistaken.</div>
    <div class="meta">Posted on 2005-11-19 00:40:16 by f0dder</div>
   </div>
   <div class="post" id="post-168021">
    <div class="subject"><a href="#post-168021">Re: how to make this code os/hardware independent?</a></div>
    <div class="body">heres something else i found out.when i enter pci in softice it gives me the following information for my display controller:<br /><br />Bus 03&nbsp; Device 00&nbsp; Function 00&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; Vendor: 10DE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; Device: 00F1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; Revision: A2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; Device class:&nbsp; &nbsp; 03 Display controller&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; Device subclass: 00 VGA-compatible controller&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; Device sub-subclass: 00&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; Base address 0: D7000000&nbsp; 16MB&nbsp; Memory&nbsp; 32-bit&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; Base address 1: C0000000&nbsp; 256MB&nbsp; Memory&nbsp; 32-bit&nbsp; Prefetchable&nbsp; <br />&nbsp; &nbsp; &nbsp; Base address 2: D8000000&nbsp; 16MB&nbsp; Memory&nbsp; 32-bit&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; ROM base: 00000000&nbsp; 128K&nbsp; Disabled&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; Interrupt line:&nbsp; 13&nbsp; Interrupt pin: 01&nbsp; Min_Gnt: 05&nbsp; &nbsp; &nbsp; MaxLat: 01&nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; Cache line size: 00&nbsp; Latency timer: 20&nbsp; Header type: 00&nbsp; BIST: 00&nbsp; &nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; Command Register:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; I/O:1&nbsp; &nbsp;  Mem:1&nbsp;  BusMast:1&nbsp; Special:0&nbsp; &nbsp; MemInv:0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Parity:0&nbsp; Wait:0&nbsp; SERR:0&nbsp; &nbsp;  Back2Back:0&nbsp; Snoop:0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br />&nbsp; &nbsp; &nbsp; Status Register:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Caps:1&nbsp; &nbsp; 66MHz Cap:1&nbsp; UDF:0&nbsp; FB2B Cap:1&nbsp; DevSel: Medium&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PERRDet:0 PERRRcvd:0 TASgnld:0&nbsp; TARcvd:0&nbsp; MARcvd:0&nbsp;  SERRSgnld:0&nbsp;  <br /><br />i dont know if it is a coincidence but softice says the memory at C0000000 is prefetchable (what does that mean?) could this be a method to detect the right physical address for the vidmem? another idea would be to map all 3 possible physical address ranges and write a message or sth into the mapped memory and if it appears on the screen the user could tell me for which range he sees the message.<br />thx for your help so far f0dder!</div>
    <div class="meta">Posted on 2005-11-19 06:27:15 by sHice</div>
   </div>
   <div class="post" id="post-168022">
    <div class="subject"><a href="#post-168022">Re: how to make this code os/hardware independent?</a></div>
    <div class="body"><div class="quote"><br />i dont know if it is a coincidence but softice says the memory at C0000000 is prefetchable (what does that mean?) could this be a method to detect the right physical address for the vidmem? another idea would be to map all 3 possible physical address ranges and write a message or sth into the mapped memory and if it appears on the screen the user could tell me for which range he sees the<br /></div><br />Dunno what the prefetchable means, but trying all three ranges is NOT a good idea - those ranges could be used for other stuff, like GPU commands or whatever. Dunno if writing wrong commands could crash your system, but it might set the card in a weird state requiring a reboot to fix...<br /><br />I guess it would take some video card device drivers to give a bit of info... I think (but this is a complete guess!) that finding out which range is the framebuffer would be queried from the card, device-specific.<br /></div>
    <div class="meta">Posted on 2005-11-19 06:33:50 by f0dder</div>
   </div>
   <div class="post" id="post-168025">
    <div class="subject"><a href="#post-168025">Re: how to make this code os/hardware independent?</a></div>
    <div class="body">The first region (region 0) is almost certainly the cards control space registers. The second &amp; third are up to the device manufacturer. In this case I&#39;m guessing region 1 is the frame buffer, and 2 is possibly the byteswapped CSRs.<br /><br />Mirno</div>
    <div class="meta">Posted on 2005-11-19 10:09:33 by Mirno</div>
   </div>
   <div class="post" id="post-168034">
    <div class="subject"><a href="#post-168034">Re: how to make this code os/hardware independent?</a></div>
    <div class="body">Might help a bit:<br />Sapphire Radeon 9200SE 128MB, latest drivers from ATi<br /><br />MR = Memory Range<br />IO = Input/Output range<br /><br />MR: D8000000 - DFFFFFFF<br />IO: 9000 - 90FF<br />MR: E9000000 - E900FFFF<br />IO: 03B0 - 03BB<br />IO: 03C0 - 03DF<br />MR: 000A0000 - 000BFFFF<br /><br />IRQ = 11</div>
    <div class="meta">Posted on 2005-11-19 15:57:43 by Ultrano</div>
   </div>
   <div class="post" id="post-168036">
    <div class="subject"><a href="#post-168036">Re: how to make this code os/hardware independent?</a></div>
    <div class="body">I have<br /><br />memory: D6000000 - D6FFFFFF<br />memory: D8000000 - DFFFFFFF<br />IRQ:&nbsp; 16<br />IO: 03B0-03BB<br />IO: 03C0-03DF<br />memory: 000A0000 - 000BFFFF<br /><br />So maybe the &quot;IO&quot; thing will tell you something somehow (don&#39;t ask me :P )?</div>
    <div class="meta">Posted on 2005-11-19 20:15:13 by ti_mo_n</div>
   </div>
   <div class="post" id="post-168044">
    <div class="subject"><a href="#post-168044">Re: how to make this code os/hardware independent?</a></div>
    <div class="body"><div class="quote"><br />Dunno what the prefetchable means, but trying all three ranges is NOT a good idea - those ranges could be used for other stuff, like GPU commands or whatever. Dunno if writing wrong commands could crash your system, but it might set the card in a weird state requiring a reboot to fix...<br /></div><br />hmm yeah you are right thats not a good idea.but i have another one :) if i map 000A0000 i also get the videomemory but only the first 64kb of it but thats enough! i could then write sth to the mapped memory and it will be displayed on the screen then i map all the other possible memory ranges that could be the vidmem and compare the first 64kb with the mapped memory of address 000A0000 and if they are equal i have the right videomemory :) the only assumption i have to make is that 000A0000 is the physical address of the first 64kb of the vidmem independent of the gfx card/os but i think that assumption is correct ?!<br />thx for posting all your card specs and your help!</div>
    <div class="meta">Posted on 2005-11-20 07:31:43 by sHice</div>
   </div>
  </div>
 </body>
</html>