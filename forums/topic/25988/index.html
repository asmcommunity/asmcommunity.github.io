<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Anti tracing ? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=25988" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=12">The Heap</a> &raquo; <a href="../?id=25988">Anti tracing ?</a></p>
   <div class="post" id="post-189401">
    <div class="subject"><a href="#post-189401">Anti tracing ?</a></div>
    <div class="body">What is the BD flag that this is referring to ? I didn&#39;t find it in the literature.<br /><br /><br />; dro.asm&nbsp; COM File This code goes resident when run !!<br />;<br />;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Old anti-debugging code<br />;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Never beeps when traced, why is that ?<br />;<br />; Will lock up window if debug or grdb.exe &quot;proceeds&quot; through the program !!<br />;<br />; This program may not work because from the comments it uses global debug settings, <br />; and XP needs local ones at least in native windows. I think it needs local settings<br />; in a DOS shell too, but am not sure on that.<br />;<br />; Another problem is if you use any debugger to step through code that hooks<br />; int 1 or int 3, the debugger is likely to tromp any settings you make to the interrupt table<br />; for those interrupts.&nbsp; That may not be an issue with this code as it seems to go TSR instead <br />; of issuing the int13 directly.<br />; <br />; Another problem is that int 13h is not supported in the XP dos shell - I&#39;m not sure off-hand<br />; if the breakpoint will ever be reached, e.g. does XP run the interrupt in real mode and then<br />; abort the shell, or does it detect the access in PMODE and abort the shell before the breakpoint<br />; is reached in the vm?&nbsp; I don&#39;t know the answer off-hand.<br />; <br />; Thanks for your comments; as a result I updated GRDB to have an option for turning its <br />; hardware breakpoint functionality off :)<br />; <br /><br />.MODEL TINY<br />.386p<br />.CODE<br /> ORG 100h<br /> START:<br />;--------------------<br />&nbsp; &nbsp; &nbsp; Copyright:<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; mov ah,09<br />&nbsp; &nbsp; &nbsp; &nbsp; mov dx,offset CMsg<br />&nbsp; &nbsp; &nbsp; &nbsp; int 21h<br />&nbsp; &nbsp; &nbsp; &nbsp; jmp short OverCop<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; CMsg db 0dh,0ah,&#39;80386 DEBUG REGISTERS.&#39;,0dh,0ah<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  db &#39;Written 1995&#39;,0dh,0ah<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  db &#39;Beeps when Int 13 entry point reached&#39;,&#39;$&#39;<br />&nbsp; &nbsp; &nbsp; OverCop:<br />;--------------------<br />&nbsp; &nbsp; &nbsp; &nbsp; mov ax,3513h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; Get INT 13 address<br />&nbsp; &nbsp; &nbsp; &nbsp; int 21h<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; Converting ES:BX to a physical address<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; ES*10h+BX, store it to EAX<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; IDA Pro doesn&#39;t disassemble the rest of this code<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; on it&#39;s first analysis<br />&nbsp; &nbsp; &nbsp; &nbsp; xor eax,eax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; mov ax,es<br />&nbsp; &nbsp; &nbsp; &nbsp; mov cl,4<br />&nbsp; &nbsp; &nbsp; &nbsp; shl eax,cl<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; and ebx,0000FFFFh<br />&nbsp; &nbsp; &nbsp; &nbsp; add eax,ebx<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; mov dr0,eax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; DR0 contains address of breakpoint<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; xor eax,eax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; DR6 - status register<br />&nbsp; &nbsp; &nbsp; &nbsp; mov dr6,eax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; Clear it<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; DR7 - control register<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; xor eax,eax&nbsp; &nbsp; &nbsp; &nbsp;  ; Disabling all Debug Breakpoints, and<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; clearing LEN0 and RW0 (our Breakpoint is<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; a Code Breakpoint)<br />&nbsp; &nbsp; &nbsp; &nbsp; or&nbsp; al,2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; G0 - it&#39;s global breakpoint<br />&nbsp; &nbsp; &nbsp; &nbsp; mov dr7,eax<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; pushf&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; Clear TraceFlag<br />&nbsp; &nbsp; &nbsp; &nbsp; pop ax<br />&nbsp; &nbsp; &nbsp; &nbsp; and ah,0FEh<br />&nbsp; &nbsp; &nbsp; &nbsp; push ax<br />&nbsp; &nbsp; &nbsp; &nbsp; popf<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; mov dx,offset Tracer&nbsp; &nbsp; ; Set our Exception handler<br />&nbsp; &nbsp; &nbsp; &nbsp; mov ax,2501h<br />&nbsp; &nbsp; &nbsp; &nbsp; int 21h<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; mov dx,offset theend&nbsp; &nbsp; ; TSR<br />&nbsp; &nbsp; &nbsp; &nbsp; int 27h<br /><br />TRACER:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; Exception handler<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; push bp eax<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; mov bp,sp<br />&nbsp; &nbsp; &nbsp; &nbsp; mov eax,dr6&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; status register<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; ;* here you can include test of BD flag<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; int 3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; debug and grdb never see this instruction ?<br />&nbsp; &nbsp; &nbsp; &nbsp; test eax,00004000h&nbsp; &nbsp; &nbsp; ; single step tracing ?<br />&nbsp; &nbsp; &nbsp; &nbsp; ;int&nbsp; &nbsp;  3<br />&nbsp; &nbsp; &nbsp; &nbsp; jz&nbsp; HardBreak&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; single step tracing occured, it was used by us to<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; restore our hardware breakpoint (see further)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; DR0 is a Hardware breakpoint again<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; xor eax,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; mov dr6,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; or&nbsp; eax, 00000002h&nbsp; &nbsp; &nbsp; ; Setting Exception by DR0<br />&nbsp; &nbsp; &nbsp; &nbsp; and eax,0FFF0FFFFh&nbsp; &nbsp; &nbsp; ; Code Exception<br />&nbsp; &nbsp; &nbsp; &nbsp; mov dr7,eax<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; and word ptr ,0FEFFh&nbsp; &nbsp; ; Clearing trace flag in stack<br />&nbsp; &nbsp; &nbsp; &nbsp; jmp short exitrace<br /><br />HardBreak:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; DR0 Exception handler<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; mov eax,dr6&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; Clear status register<br />&nbsp; &nbsp; &nbsp; &nbsp; xor eax,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; mov dr6,eax<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; mov eax,dr7<br />&nbsp; &nbsp; &nbsp; &nbsp; and eax,0FFFFFFFDh<br />&nbsp; &nbsp; &nbsp; &nbsp; mov dr7,eax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; Disable DR0 Hardware Breakpont, or else<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; recycling when return (ResumeFlag doesn&#39;t<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; resumes... making it by the handle)<br /><br /><br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; The purpose of our hardware breakpoint<br />&nbsp; &nbsp; &nbsp; &nbsp; ;mov ax,0E07h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; Sound a beep This doesn&#39;t work, try next 3 lines<br />&nbsp; &nbsp; &nbsp; &nbsp; ;int 10h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov dl,07h<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  mov ah,02h<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  int 21h<br /><br /><br />; Insert everything you need.<br /><br />&nbsp; SetTF:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; Setting usual tracing for further<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; DR0 resuming<br />&nbsp; &nbsp; &nbsp; &nbsp; or word ptr ,0100h&nbsp; &nbsp;  ; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; <br />&nbsp; ExiTrace:<br />&nbsp; &nbsp; &nbsp; &nbsp; pop eax bp<br />&nbsp; &nbsp; &nbsp; &nbsp; iret<br /><br /> TheEnd:<br /><br /> End Start<br /><br /><br /><br /></div>
    <div class="meta">Posted on 2007-05-28 11:28:00 by skywalker</div>
   </div>
   <div class="post" id="post-189402">
    <div class="subject"><a href="#post-189402">Re: Anti tracing ?</a></div>
    <div class="body">Bad code... modifies DRx before setting exception handler etc... for an explanation of the BD flag, grab a copy of the intel manuals, &quot;systems programming guide&quot;.<br /><br />I&#39;m not particularly fond of this snippet of code, nor the way you recently have been posting code snippets with dubious content.<br /></div>
    <div class="meta">Posted on 2007-05-28 11:44:34 by f0dder</div>
   </div>
   <div class="post" id="post-189403">
    <div class="subject"><a href="#post-189403">Re: Anti tracing ?</a></div>
    <div class="body"><div class="quote"><br />Bad code... modifies DRx before setting exception handler etc... for an explanation of the BD flag, grab a copy of the intel manuals, &quot;systems programming guide&quot;.<br /><br />Good luck.<br /><br /></div><br /><br />Thanks, I just found the file and am downloading it. Little large, may take me a while<br />to read it.<br />:-)<br /><br /></div>
    <div class="meta">Posted on 2007-05-28 13:35:43 by skywalker</div>
   </div>
   <div class="post" id="post-189415">
    <div class="subject"><a href="#post-189415">Re: Anti tracing ?</a></div>
    <div class="body">also most likely will not run on windows, its dos based crap<br />and dubious content for sure<br />as for ida not disassembling it, most likely you didnt set ida to disassemble it as 16 bit...<br />this stuff can be done in windows, infact some protections do it already<br />but SAFELY...<br /><br />rerouting interrupts (especially int 13h) IS perilous to say the least<br /><br />next time put warnings in your posts.....</div>
    <div class="meta">Posted on 2007-05-30 06:58:10 by evlncrn8</div>
   </div>
   <div class="post" id="post-189416">
    <div class="subject"><a href="#post-189416">Re: Anti tracing ?</a></div>
    <div class="body"><div class="quote"><br />also most likely will not run on windows, its dos based crap<br />and dubious content for sure<br />as for ida not disassembling it, most likely you didnt set ida to disassemble it as 16 bit...<br />this stuff can be done in windows, infact some protections do it already<br />but SAFELY...<br /><br />rerouting interrupts (especially int 13h) IS perilous to say the least<br /><br />next time put warnings in your posts.....<br /></div><br /><br />; dro.asm&nbsp; COM File This code goes resident when run !!<br />;<br />;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Old anti-debugging code<br />;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Never beeps when traced, why is that ?<br />;<br />; Will lock up window if debug or grdb.exe &quot;proceeds&quot; through the program !!</div>
    <div class="meta">Posted on 2007-05-30 09:37:03 by skywalker</div>
   </div>
   <div class="post" id="post-189422">
    <div class="subject"><a href="#post-189422">Re: Anti tracing ?</a></div>
    <div class="body">Speaking of dos, is this relic still supported in Vista?<br />sorry for off-topic...<br /></div>
    <div class="meta">Posted on 2007-05-30 15:56:01 by arafel</div>
   </div>
   <div class="post" id="post-189423">
    <div class="subject"><a href="#post-189423">Re: Anti tracing ?</a></div>
    <div class="body">nope, afaik it isnt<br />isnt at all on xp64, so i&#39;d presume vista 32/64 went the same way<br /><br />i also dont see <br /><br /><div class="quote"><br />; dro.asm&nbsp; COM File This code goes resident when run !!<br />;<br />;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Old anti-debugging code<br />;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Never beeps when traced, why is that ?<br />;<br />; Will lock up window if debug or grdb.exe &quot;proceeds&quot; through the program !!<br /></div><br /><br />as a warning, thats more like coders notes..<br /><br />i was thinking something like this...<br /><br /><strong><span style="font-family:Verdana">One line of vitriol suppressed by management.</span></strong><br /></div>
    <div class="meta">Posted on 2007-05-30 16:35:11 by evlncrn8</div>
   </div>
  </div>
 </body>
</html>