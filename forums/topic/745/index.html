<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>CreateDIBSection help - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=745" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=745">CreateDIBSection help</a></p>
   <div class="post" id="post-4470">
    <div class="subject"><a href="#post-4470">CreateDIBSection help</a></div>
    <div class="body">i'm trying to capture the entire desktop bmp image:<br /><br /><br /><br /><br /><br />call    GetDC,0<br />                mov     hdc,eax<br /><br />                ; let's capturing the desktop<br />                mov     bmpinfo.bmiHeader.biSize, SIZE bmiHeader<br />                mov     bmpinfo.bmiHeader.biWidth, 1024<br />                mov     bmpinfo.bmiHeader.biHeight, 768<br />                mov     bmpinfo.bmiHeader.biPlanes, 1<br />                mov     bmpinfo.bmiHeader.biBitCount, 32<br />                mov     bmpinfo.bmiHeader.biCompression, BI_RGB<br />                mov     bmpinfo.bmiHeader.biSizeImage, 0<br />                mov     bmpinfo.bmiHeader.biClrUsed, 0<br />                mov     bmpinfo.bmiHeader.biClrImportant, 0<br /><br />                mov     bmpinfo.bmiColors.rgbBlue, 0FFh<br />                mov     bmpinfo.bmiColors.rgbGreen, 0FFh<br />                mov     bmpinfo.bmiColors.rgbRed, 0FFh<br />                               <br />                call    CreateDIBSection,\<br />                         hdc,\               ; // handle to device context<br />                         offset bmpinfo,\       ; // pointer to structure containing bitmap size, format, and color data<br />                         DIB_RGB_COLORS,\       ; // color data type indicator: RGB values or palette indices<br />                         offset bmpPointer,\    ; // pointer to variable to receive a pointer to the bitmap's bit values<br />                         NULL,\                 ; // optional handle to a file mapping object<br />                         NULL<br /><br /><br /><br /><br />function return a valid handle to bmp but when i go to see the bitmap loaded in memory all the byte of the bitmap colors are set to 00h and i can't understand why. So i can't capturing desktop colors. <br /><br />Could someone help ?<br />thanx</div>
    <div class="meta">Posted on 2001-08-22 14:01:15 by Bit7</div>
   </div>
   <div class="post" id="post-4561">
    <div class="subject"><a href="#post-4561">Is this what you need ...</a></div>
    <div class="body">Try this <br />The CreateCompatibleBitmap function creates a bitmap compatible with the device that is associated with the specified device context. <br /><br />HBITMAP CreateCompatibleBitmap(<br /><br />    HDC  hdc,	// handle of device context <br />    int  nWidth,	// width of bitmap, in pixels  <br />    int  nHeight 	// height of bitmap, in pixels  <br />   );	<br />Parameters<br /><br />hdc<br /><br />Identifies a device context. <br /><br />nWidth<br /><br />Specifies the bitmap width, in pixels. <br /><br />nHeight<br /><br />Specifies the bitmap height, in pixels. <br /><br />Return Value<br /><br />If the function succeeds, the return value is a handle of the bitmap.</div>
    <div class="meta">Posted on 2001-08-23 00:03:12 by Nguga</div>
   </div>
   <div class="post" id="post-4572">
    <div class="subject"><a href="#post-4572">CreateDIBSection help</a></div>
    <div class="body">Nguga,<br /><br />thanks, i've try but again nothing.<br /><br />now i'm doing:<br /><br /><pre><code><br /><br />                call    GetDC,0<br />                mov     hdcScreen,eax<br />                call    CreateCompatibleDC, hdcScreen<br />                mov     Deskdc,eax<br />                call    CreateCompatibleBitmap, hdcScreen, 1024, 768<br />                call    SelectObject, Deskdc, eax<br /><br />                mov     bmpinfo.bmiHeader.biSize, SIZE bmiHeader<br />                mov     bmpinfo.bmiHeader.biWidth, 1024<br />                mov     bmpinfo.bmiHeader.biHeight, 768<br />                mov     bmpinfo.bmiHeader.biPlanes, 1<br />                mov     bmpinfo.bmiHeader.biBitCount, 32<br />                mov     bmpinfo.bmiHeader.biCompression, BI_RGB<br />                mov     bmpinfo.bmiHeader.biSizeImage, 0<br />                mov     bmpinfo.bmiHeader.biClrUsed, 0<br />                mov     bmpinfo.bmiHeader.biClrImportant, 0<br /><br />                call    CreateDIBSection,\<br />                         Deskdc,\               ; // handle to device context<br />                         offset bmpinfo,\       ; // pointer to structure <br />                         DIB_RGB_COLORS,\       ; // color data type <br />                         offset bmpPointer,\    ; // pointer to variable s<br />                         NULL,\                 ; // optional handle <br />                         NULL      <br /></code></pre><br /><br />CreateDIBSection create the correct space ion memory but all fill with 00 (black).<br /><br />I'm doing somthing wrong. If some help,   thanks</div>
    <div class="meta">Posted on 2001-08-23 03:37:02 by Bit7</div>
   </div>
   <div class="post" id="post-4603">
    <div class="subject"><a href="#post-4603">CreateDIBSection help</a></div>
    <div class="body">This is the code I use<br /><br /><pre><code><br />.data?<br />hDc dd ?<br />bDc dd ?<br />pBb dd ?<br />hBm dd ?<br /><br />.code<br />InitDoubleBuffer Proc<br />LOCAL bih&#58;BITMAPINFOHEADER<br /><br />	invoke GetDC,hWindow<br />	mov hDc, eax<br />	invoke GetClientRect,hWindow,addr rect<br /><br />	invoke CreateCompatibleDC, hDc<br />	mov bDc, eax<br />	<br />	lea edx, bih<br />	mov &#40;BITMAPINFOHEADER ptr &#91;edx&#93;&#41;.biSize, sizeof&#40;BITMAPINFOHEADER&#41;<br />	mov eax, rect.right ; You'll want to change these I assume<br />	mov &#40;BITMAPINFOHEADER ptr &#91;edx&#93;&#41;.biWidth, eax<br />	mov eax, rect.bottom<br />	mov &#40;BITMAPINFOHEADER ptr &#91;edx&#93;&#41;.biHeight, eax<br />	mov &#40;BITMAPINFOHEADER ptr &#91;edx&#93;&#41;.biPlanes, 1<br />	mov &#40;BITMAPINFOHEADER ptr &#91;edx&#93;&#41;.biBitCount, 32<br />	mov &#40;BITMAPINFOHEADER ptr &#91;edx&#93;&#41;.biCompression, BI_RGB<br />	mov &#40;BITMAPINFOHEADER ptr &#91;edx&#93;&#41;.biSizeImage, 0<br />	mov &#40;BITMAPINFOHEADER ptr &#91;edx&#93;&#41;.biXPelsPerMeter, 0<br />	mov &#40;BITMAPINFOHEADER ptr &#91;edx&#93;&#41;.biYPelsPerMeter, 0<br />	mov &#40;BITMAPINFOHEADER ptr &#91;edx&#93;&#41;.biClrUsed, 0<br />	mov &#40;BITMAPINFOHEADER ptr &#91;edx&#93;&#41;.biClrImportant, 0<br /><br />	invoke CreateDIBSection, bDc, edx, DIB_RGB_COLORS, addr pBb, 0, 0<br />	mov hBm, eax<br />	<br />	invoke SelectObject, bDc, eax<br /><br />ret<br />InitDoubleBuffer EndP</code></pre> <br /><br />I assume if you change the hWindow to 0 in the GetDC call you'd get the Desktop DC. However I don't think you'll achieve what you want with this alone. Can I assume that you're using a DIBSection is because you want to be able to acess the pixel info directly, other wise you might as well use a compatable Bitmap and stick to GDI.<br /><br />Also you'll need to BitBlt the Desktop DC to the one you create with the above code. This is very simple, lets assume the desktop dc is still in hDc then:<br /><pre><code>	invoke BitBlt, bDc, 0, 0, rect.right, rect.bottom,\<br />	hDc, 0, 0, SRCCOPY	</code></pre></div>
    <div class="meta">Posted on 2001-08-23 12:15:48 by EÃ³in</div>
   </div>
   <div class="post" id="post-4605">
    <div class="subject"><a href="#post-4605">CreateDIBSection help</a></div>
    <div class="body">If it may help, this is the way i do it for definig the Screen Table in DirectDrawing:<br /><br /><br /><br /><br /><br />BuildScreenBitMap:<br /><br />  ; Ask Win to create a BitMap for the whole screen (this BitMap belongs to Win).<br />  ; (This is to ease computation of values if you want another screen Mode).<br /> <br />    call 'GDI32.CreateDCA' Display 0 0 0 | mov D?ScreenDcHandle eax<br />    <br />    call 'USER32.GetSystemMetrics' &amp;SM_CXSCREEN | mov D?ScreenDim.x eax<br />    call 'USER32.GetSystemMetrics' &amp;SM_CYSCREEN | mov D?ScreenDim.y eax<br /><br />    call 'GDI32.CreateCompatibleBitmap' D?ScreenDcHandle D?ScreenDim.x D?ScreenDim.y<br />    mov D?ScreenBitMapHandle eax<br /><br />    ; Ask Win to give us required info for what is this BitMap:<br />    call 'GDI32.GetObjectA' D?ScreenBitMapHandle D?BITMAPlen BITMAP<br />    mov eax D?bmWidthBytes | mul D?bmHeight | mov D?VirtualScreenLen eax<br />    <br />    call 'GDI32.DeleteObject' D?ScreenBitMapHandle<br />    call 'GDI32.DeleteDC' D?ScreenDcHandle<br />ret<br /><br /><br />Betov.</div>
    <div class="meta">Posted on 2001-08-23 12:39:29 by Betov</div>
   </div>
   <div class="post" id="post-4693">
    <div class="subject"><a href="#post-4693">CreateDIBSection help</a></div>
    <div class="body">all,<br />many thanks, i'm goin to try now.</div>
    <div class="meta">Posted on 2001-08-24 04:22:36 by Bit7</div>
   </div>
   <div class="post" id="post-4706">
    <div class="subject"><a href="#post-4706">CreateDIBSection help</a></div>
    <div class="body">i've try your kind suggestions,<br /><br />again no way to capture this desktop image in memory  :(<br /><br />Zadkiel,<br />i've try your way but nothing. Space in memory remain blak (all 00h) in anyway.<br /><br />Betov,<br />i can get valid info with GetObject but then ? How can i get the bitmap in memory ?<br /><br />If you will, i hope for some other help.   thanks.</div>
    <div class="meta">Posted on 2001-08-24 07:11:36 by Bit7</div>
   </div>
   <div class="post" id="post-4715">
    <div class="subject"><a href="#post-4715">CreateDIBSection help</a></div>
    <div class="body">excuse me for all this mess,<br /><br />i've done it !<br /><br />the code is:<br /><br /><pre><code><br />call    GetDesktopWindow<br />             <br />                call    GetDC, eax<br />                mov     hdcScreen,eax<br /><br />                call    CreateCompatibleDC, hdcScreen<br />                mov     Deskdc, eax    <br /><br />                call    CreateCompatibleBitmap, hdcScreen, 1024, 768<br />                <br />                call    SelectObject, Deskdc, eax      <br />                <br />                ; let's capturing the desktop<br />                mov     bmpinfo.bmiHeader.biSize, SIZE bmiHeader<br />                mov     bmpinfo.bmiHeader.biWidth, 1024<br />                mov     bmpinfo.bmiHeader.biHeight, 768<br />                mov     bmpinfo.bmiHeader.biPlanes, 1<br />                mov     bmpinfo.bmiHeader.biBitCount, 32<br />                mov     bmpinfo.bmiHeader.biCompression, BI_RGB<br />                mov     bmpinfo.bmiHeader.biSizeImage, 0<br />                mov     bmpinfo.bmiHeader.biXPelsPerMeter, 0<br />                mov     bmpinfo.bmiHeader.biYPelsPerMeter, 0<br />                mov     bmpinfo.bmiHeader.biClrUsed, 0<br />                mov     bmpinfo.bmiHeader.biClrImportant, 0<br /><br />                               <br />                call    CreateDIBSection, Deskdc, offset bmpinfo, DIB_RGB_COLORS, offset bmpPointer,\<br />                         NULL, NULL      <br /><br />                call    SelectObject, Deskdc, eax<br />                <br /><br />                call    BitBlt, Deskdc, 0, 0, 1024, 768, hdcScreen, 0, 0, SRCCOPY<br /></code></pre><br /><br />thanks again !!</div>
    <div class="meta">Posted on 2001-08-24 07:44:51 by Bit7</div>
   </div>
  </div>
 </body>
</html>