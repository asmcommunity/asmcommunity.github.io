<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>RST flag? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=14248" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=8">Networking</a> &raquo; <a href="../?id=14248">RST flag?</a></p>
   <div class="post" id="post-110234">
    <div class="subject"><a href="#post-110234">RST flag?</a></div>
    <div class="body">I'm having a problem. I have a program that connects to a server. In my program, I have a function that sends command to the server. This works fine,  but when I try to adapt it so it can be use different string buffer, it crashes on me. As a matter of fact,  from my packet sniffing, it shows a RST flag and from my research, it means reset, but why does it do that?<br /><br />This is the function header that works:<br />SendMainCommand PROTO<br /><br />but when I change it to: SendMainCommand PROTO :DWORD<br />and change the proc to: SendMainCommand proc gamecommand:DWORD<br />where I would call it with: invoke SendMainCommand,addr command, or Invoke SendMainCommand, addr gamebuffer<br />This works fine: The bulk of the code within the middle is just the algorithm that properly forms the packet, as to follow the custom protocol of the server.<br /><pre><code><br />SendMainCommand proc<br /><br />	invoke RtlZeroMemory, addr packet_command,1024<br />	lea esi, user_id	<br />	lea edi, packet_userid_begin<br />	xor ecx,ecx<br />_add_user_id&#58;<br />	mov al, &#91;esi+ecx&#93;<br />	cmp al,0<br />	jz _add_packet_id<br />	mov &#91;edi+ecx&#93;,al<br />	inc ecx<br />	jmp _add_user_id<br />_add_packet_id&#58;<br /><br />;;	increment packet id	<br />;;	load packet_id into packet<br />;;	do everytime<br />	inc packet_id<br />	mov ax, packet_id<br />	lea edi, packet_id_begin	<br />	mov &#91;edi&#93;,ah<br />	mov &#91;edi+1h&#93;,al<br /><br />	&#91;b&#93;lea esi, command&#91;/b&#93;<br />	lea edi, packet_command<br />	xor ecx, ecx<br />_add_command&#58;<br />	mov al, &#91;esi+ecx&#93;	<br />	cmp al, 0<br />	jz _start_byte_algo<br />	mov &#91;edi+ecx&#93;,al<br />	inc ecx<br />	jmp _add_command<br />	<br />_start_byte_algo&#58;<br /><br />	&#91;b&#93;invoke lstrlen,addr command&#91;/b&#93;<br />	push eax<br />	add eax,23<br />	mov packet_length, eax<br />	pop eax<br />	add eax, 09h<br />	lea edi, packet_length_start<br />	mov &#91;edi&#93;,eax<br />	add eax, 0Ah<br />	mov esi, eax<br />	mov ecx, 0000007Eh<br />	mov edx, 0000007Eh<br />	xor eax,eax<br />	lea edi, packet_algo_start<br />_loop_byte_algo&#58;<br />	add cl, byte ptr &#91;eax+edi&#93;<br />	add dl, cl<br />	inc eax<br />	cmp eax, esi<br />	jl _loop_byte_algo<br />	<br />	lea edi, packet_begin<br />	xor ax,ax<br />	movzx cx,cl<br />	mov al, dl<br />	add ecx, eax<br />	shl ecx, 8<br />	sub eax, ecx<br /><br />	lea ebp, packet_begin<br />	add ebp, packet_length<br />	sub ebp, 2<br />	<br />	mov &#91;ebp&#93;,ax<br /><br />	mov cl,ah<br />	and eax,0FFFFh<br />	and eax,800000FFh<br />	mov &#91;ebp&#93;,cl<br />	<br />	xor edx, edx<br />	mov &#91;ebp+1&#93;,al<br />	invoke send,&#91;hSocket1&#93;,addr packet_begin, packet_length,0<br /><br />	ret<br /><br />SendMainCommand endp<br /></code></pre><br /><br />Heres the current proc, that keeps crashing and sending some reset flag:<br /><br /><pre><code><br />SendMainCommand proc &#91;b&#93;gamecommand&#58;DWORD&#91;/b&#93;<br /><br />	invoke RtlZeroMemory, addr packet_command,1024<br />	lea esi, user_id	<br />	lea edi, packet_userid_begin<br />	xor ecx,ecx<br />_add_user_id&#58;<br />	mov al, &#91;esi+ecx&#93;<br />	cmp al,0<br />	jz _add_packet_id<br />	mov &#91;edi+ecx&#93;,al<br />	inc ecx<br />	jmp _add_user_id<br />_add_packet_id&#58;<br /><br />;;	increment packet id	<br />;;	load packet_id into packet<br />;;	do everytime<br />	inc packet_id<br />	mov ax, packet_id<br />	lea edi, packet_id_begin	<br />	mov &#91;edi&#93;,ah<br />	mov &#91;edi+1h&#93;,al<br /><br />	&#91;b&#93;mov esi, gamecommand              ;; update in new function&#91;/b&#93;<br />	lea edi, packet_command<br />	xor ecx, ecx<br />_add_command&#58;<br />	mov al, &#91;esi+ecx&#93;	<br />	cmp al, 0<br />	jz _start_byte_algo<br />	mov &#91;edi+ecx&#93;,al<br />	inc ecx<br />	jmp _add_command<br />	<br />_start_byte_algo&#58;<br /><br />	&#91;b&#93;invoke lstrlen,gamecommand        ;; updated in new function&#91;/b&#93;<br />	push eax<br />	add eax,23<br />	mov packet_length, eax<br />	pop eax<br />	add eax, 09h<br />	lea edi, packet_length_start<br />	mov &#91;edi&#93;,eax<br />	add eax, 0Ah<br />	mov esi, eax<br />	mov ecx, 0000007Eh<br />	mov edx, 0000007Eh<br />	xor eax,eax<br />	lea edi, packet_algo_start<br />_loop_byte_algo&#58;<br />	add cl, byte ptr &#91;eax+edi&#93;<br />	add dl, cl<br />	inc eax<br />	cmp eax, esi<br />	jl _loop_byte_algo<br />		<br />	lea edi, packet_begin<br />	xor ax,ax<br />	movzx cx,cl<br />	mov al, dl<br />	add ecx, eax<br />	shl ecx, 8<br />	sub eax, ecx<br /><br />	lea ebp, packet_begin<br />	add ebp, packet_length<br />	sub ebp, 2<br />	<br />	mov &#91;ebp&#93;,ax<br /><br />	mov cl,ah<br />	and eax,0FFFFh<br />	and eax,800000FFh<br />	mov &#91;ebp&#93;,cl<br />	<br />	xor edx, edx<br />	mov &#91;ebp+1&#93;,al<br />	invoke send,&#91;hSocket1&#93;,addr packet_begin, packet_length,0<br /><br />	ret<br /><br />SendMainCommand endp<br /></code></pre><br /><br />As you can see, I just changed the header. Updated the <strong>lea esi, command</strong> with <strong>mov esi, game command</strong>, and <strong>invoke lstrlen,addr command</strong> with <strong>invoke lstrlen,gamecommand</strong>.<br /><br />I know this to be the problem because it doesn't execute anything else when returning from the function. :\<br /><br />I can provide the total source on request. Contact me at dfcslave on AIM for a username/password that works. Thanks. :)</div>
    <div class="meta">Posted on 2003-07-12 17:39:02 by xkardisx</div>
   </div>
   <div class="post" id="post-110279">
    <div class="subject"><a href="#post-110279">RST flag?</a></div>
    <div class="body">Well I found out what was causing the crashes. Apparently the function needs a pushad at beginning, and popad at the end. Kind of odd, but it works now. Reason it was working with the original one, was because in that particular instance I actually had a pushad, and popad, before I actually called the function.</div>
    <div class="meta">Posted on 2003-07-13 05:55:08 by xkardisx</div>
   </div>
  </div>
 </body>
</html>