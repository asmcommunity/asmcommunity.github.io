<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Iczelion's tutorial 3 in nasm syntax - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=20188" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=17">Iczelion's Tutorials</a> &raquo; <a href="../?id=20188">Iczelion's tutorial 3 in nasm syntax</a></p>
   <div class="post" id="post-154643">
    <div class="subject"><a href="#post-154643">Iczelion's tutorial 3 in nasm syntax</a></div>
    <div class="body">I don't know much about nasm and win32 programming, I think that masm is far easier, because of all the macros. But I want to know how the code in this tutorial will look like in nasm syntax. Can somebody please help me with this?<br />http://spiff.tripnet.se/~iczelion/tut3.html</div>
    <div class="meta">Posted on 2004-12-23 08:41:23 by dev_zero</div>
   </div>
   <div class="post" id="post-154653">
    <div class="subject"><a href="#post-154653">Iczelion's tutorial 3 in nasm syntax</a></div>
    <div class="body">The more easy way to do, is to use nagoa package (there are some examples there) and in some way can look a little like masm :shock: <br /><br />If you use another alternative, should be a little more dificult (specially for the include files), you can use -fwin32 for link the object file with lcc or link (yes the one that comes with masm32 package) also check this site out http://alink.sourceforge.net<br /><br />This little example work for both of them:<br /><br /><div class="quote"><br />extern _MessageBoxA@16<br />extern _ExitProcess@4<br /><br />global _WinMain@16<br />segment .data use32 class=data<br />hola db &quot;hola mundo&quot;, 0<br /><br />segment .text USE32 class=code<br />_WinMain@16:<br />push dword 0<br />push dword hola<br />push dword hola<br />push dword 0<br />call _MessageBoxA@16<br />push dword 0<br />call _ExitProcess@4<br /><br />nasm -fwin32 name.asm<br />lcclnk -s -subsystem windows name.obj<br />or<br />link /entry:WinMain /subsystem:windows /libpath:c:\masm32\lib user32.lib kernel32.lib name.obj<br /><br /></div><br /><br />But the output is diferent ;), lcc insert a initialization code, for example in the examples showed by icz, there is a entry point named start, then he do the setup of the command line, the module handle, this code and a little more is inserted by lcclnk (I guess there is a option for not do that, but havent watched the help ;)), with link, there is no insertion of startup code, then you can make the setup like is done in the icz examples.<br /><br /><br />The main problem, is that aparently the include files out there are not completely compatible (I guess they insert some extra things that garbage the output :)).<br /><br />In that way, the nagoa package is more usable and stable, by the way you can plug it to radasm ;), in that package there are some examples how is used that include file.<br /><br /><br />There is a group for help in yahoo win32-nasm-users, altought I dont like the interface and the publicity I will prefer a board :P.</div>
    <div class="meta">Posted on 2004-12-23 14:41:09 by rea</div>
   </div>
   <div class="post" id="post-154656">
    <div class="subject"><a href="#post-154656">Iczelion's tutorial 3 in nasm syntax</a></div>
    <div class="body">The thing is, that I wanted to see and learn how the WinMain and WndProc procedure without the macros would look like in nasm syntax. And how I can initialize the WNDCLASSEX structure in nasm sytax..</div>
    <div class="meta">Posted on 2004-12-23 15:11:06 by dev_zero</div>
   </div>
   <div class="post" id="post-154669">
    <div class="subject"><a href="#post-154669">Iczelion's tutorial 3 in nasm syntax</a></div>
    <div class="body">This example will work with: nasmw -fwin32 <em>name</em>.asm and then: link /entry:<strong>Entry</strong> /subsystem:windows /libpath:c:\masm32\lib user32.lib kernel32.lib <em>name</em>.obj<br /><br />There is a problem if you try include directly nagoa.inc :), I supose that is related to some macros added there (pheraphs the problem is to include pemac when in some way is something diferent), is for that I include the definitions of the structs, equates used and because you only have whanted (whas the most dificult part.. lol), because you only whanted to know how to setup a function, I add also a macro apicall for let me type more easy all the push dword :), the first callings are done manually, that is pushing in reverse order and then calling the function like is defined in the library _<em>name</em>@<em>sizeInBytesOfArguments</em><br /><br /><br />This structures are extracted from nagoa.inc (I should see what is the problem and correct it.. ;))<br /><pre><code>STRUC WNDCLASSEX<br />.cbSize RESD 1<br />.style RESD 1<br />.lpfnWndProc RESD 1<br />.cbClsExtra RESD 1<br />.cbWndExtra RESD 1<br />.hInstance RESD 1<br />.hIcon RESD 1<br />.hCursor RESD 1<br />.hbrBackground RESD 1<br />.lpszMenuName RESD 1<br />.lpszClassName RESD 1<br />.hIconSm RESD 1<br />ENDSTRUC<br /><br />STRUC POINT<br />.x RESD 1<br />.y RESD 1<br />ENDSTRUC<br /><br />STRUC MSG<br />.hwnd RESD 1<br />.message RESD 1<br />.wParam RESD 1<br />.lParam RESD 1<br />.time RESD 1<br />.pt RESB POINT_size<br />ENDSTRUC<br /><br />%define SW_SHOWDEFAULT      10<br />%define CS_VREDRAW          0x0001<br />%define CS_HREDRAW          0x0002<br />%define COLOR_WINDOW 5<br />%define IDI_APPLICATION     32512<br />%define IDC_ARROW 32512<br />%define CW_USEDEFAULT 80000000h<br /><br />%define WS_OVERLAPPED       0x00000000<br />%define WS_CAPTION          0x00C00000<br />%define WS_SYSMENU          0x00080000<br />%define WS_THICKFRAME       0x00040000<br />%define WS_MINIMIZEBOX      0x00020000<br />%define WS_MAXIMIZEBOX      0x00010000<br />%define WS_OVERLAPPEDWINDOW &#40;WS_OVERLAPPED     | \<br />                             WS_CAPTION        | \<br />                             WS_SYSMENU        | \<br />                             WS_THICKFRAME     | \<br />                             WS_MINIMIZEBOX    | \<br />                             WS_MAXIMIZEBOX&#41;<br />%define WM_DESTROY 2h<br /></code></pre><br /><br />A simple macro that will let me type less (a little lazy), push the n-1 arguments to the macro in reverse order and call the decored function that contain apart from the name a &quot;_&quot; prefix and a @sizeOfbytesOfArguments also declare the name like extern (defined somewhere else.. a mark for the linker)<br /><pre><code><br />%macro apicall2 2<br />	extern _%1@%2<br />	call _%1@%2<br />%endmacro<br /><br />%macro apicall 1-*<br />	%assign %%n %0-1<br />	%rep %%n<br />		%rotate -1<br />		push dword %1<br />	%endrep<br />	%rotate -1<br />	%assign %%n %%n*4<br />	apicall2 %1, %%n<br />%endmacro<br /></code></pre><br /><br />I will do some manual calling (the more easy functions ;)) then I declare them also manually like extern with the decorated name.<br /><pre><code><br />extern _GetModuleHandleA@4<br />extern _GetCommandLineA@0<br />extern _ExitProcess@4<br /></code></pre><br /><br /><br />definition of segments (code, data, bss) see that you use resX (reserve X n times: resX n) instead of dd (declare double)<br /><pre><code><br />segment .data use32 class=data<br />ClassName db &quot;SimpleWindClass&quot;, 0<br />AppName db &quot;Our first Window? &#58;P&quot;, 0<br /><br />segment .bss use32 class=bss<br />hInstance resd 1<br />CommandLine resd 1<br /><br /><br />segment .text USE32 class=code<br /></code></pre><br /><br />Here I make the name more explicit, because we will use link that dosent insert automatically initialization like lcclnk do. <br /><br /><pre><code><br />global _Entry<br />_Entry&#58;<br /></code></pre><br />The initialization part (this one is the inserted be lcclnk), also you can see how you push and call decorated names (they are previously declared as externs)<br /><pre><code><br />	push dword 0<br />	call _GetModuleHandleA@4<br />	mov &#91;hInstance&#93;, eax<br />	call _GetCommandLineA@0<br />	mov &#91;CommandLine&#93;, eax<br />	push dword SW_SHOWDEFAULT<br />	push CommandLine<br />	push dword 0<br />	push dword&#91;hInstance&#93;<br />	call WinMain<br />	push eax<br />	call _ExitProcess@4<br /></code></pre><br /><br />Here we setup a stack frame, if yu see the defines, you see that I put them after push ebp and mov ebp, esp because after that  point is where they have the meaning that Im giving. For example, if you dont do the stack frame (the secuence of push and mov over ebp and esp) then, you will be refering to the arguments of the anterior call...<br /><br />Also you can see how is allocated some space in the stack for the local vars, also the definitions of the names are I put them after sub esp, nBytes, because is after that point they obtain the real meaning that Im giving to them.<br /><pre><code><br />WinMain&#58;<br />	push ebp<br />	mov ebp, esp<br />	%define SavedEBP ebp<br />	%define SavedRetAddress ebp+4<br />	%define hInst ebp+8<br />	%define hPrevInst ebp+12<br />	%define CmdLine ebp+16<br />	%define CmdShow ebp+20<br />	sub esp, WNDCLASSEX_size+MSG_size+4<br />	%define hwnd ebp- &#40;WNDCLASSEX_size+MSG_size+4&#41;<br />	%define msg ebp- &#40;WNDCLASSEX_size+MSG_size&#41;<br />	%define wnd ebp- &#40;WNDCLASSEX_size&#41;<br /></code></pre><br /><br />Here is how you fill a structure in memory, you see, you need specify the size of the movement only if there is no a precense of a register, because the register give the size of the movement or push...., by the way, nasm dosent suport structs, They are used with a macro (struc) and in some way, the work is define names that are composed by the name of the struct point member of the struct, is for that you use wnd+WNDCLASSEX.cbSize, let analyze a little example:<br /><br />STRUC POINT<br />.x RESD 1<br />.y RESD 1<br />ENDSTRUC<br />Here are defined some things:<br />POINT equ 0<br />POINT_size contain the size of the struct<br />POINT.x equ 0<br />POINT.y equ 4<br /><br />Altough they are not equates, but make sense ;)...<br />Then if you have a label (a addres in memory) and then you sum a x number, you are accesing a offset from than start address, dont know if I explain well, but that is what the structs are models for access memory and be the way provide a meaning... then mov eax,  will be translated to diferent things, depending of what is p a address in the data section or in the stack section....<br /><pre><code><br />	mov dword&#91;wnd+WNDCLASSEX.cbSize&#93;, WNDCLASSEX_size<br />	mov dword&#91;wnd+WNDCLASSEX.style&#93;, CS_VREDRAW|CS_HREDRAW<br />	mov dword&#91;wnd+WNDCLASSEX.lpfnWndProc&#93;, WndProc<br />	mov dword&#91;wnd+WNDCLASSEX.cbClsExtra&#93;, 0<br />	mov dword&#91;wnd+WNDCLASSEX.cbWndExtra&#93;, 0<br />	mov eax, &#91;hInst&#93;<br />	mov &#91;wnd+WNDCLASSEX.hInstance&#93;, eax<br />	mov dword&#91;wnd+WNDCLASSEX.hbrBackground&#93;, COLOR_WINDOW+1<br />	mov dword&#91;wnd+WNDCLASSEX.lpszMenuName&#93;, 0<br />	mov dword&#91;wnd+WNDCLASSEX.lpszClassName&#93;, ClassName<br />	apicall LoadIconA, 0, IDI_APPLICATION<br />	mov &#91;wnd+WNDCLASSEX.hIcon&#93;, eax<br />	mov &#91;wnd+WNDCLASSEX.hIconSm&#93;, eax<br />	apicall LoadCursorA, 0, IDC_ARROW<br />	mov dword&#91;wnd+WNDCLASSEX.hCursor&#93;, eax<br />	lea eax, &#91;wnd&#93;<br />	apicall RegisterClassExA, eax<br />	apicall CreateWindowExA, 0, ClassName, AppName, WS_OVERLAPPEDWINDOW,\<br />		CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT,\<br />		0, 0, &#91;hInstance&#93;, 0<br />	mov &#91;hwnd&#93;, eax<br />	apicall ShowWindow, &#91;hwnd&#93;, &#91;CmdShow&#93;<br />	apicall UpdateWindow, &#91;hwnd&#93;<br />	.again&#58;<br />		lea eax, &#91;msg&#93;<br />		apicall GetMessageA, eax, 0, 0, 0<br />		cmp eax, 0<br />		je .end<br />		lea eax, &#91;msg&#93;<br />		apicall TranslateMessage, eax<br />		lea eax, &#91;msg&#93;<br />		apicall DispatchMessageA, eax<br />		jmp .again<br />	.end&#58;<br />	mov eax, &#91;msg+MSG.wParam&#93;<br />	mov esp, ebp<br />	pop ebp<br />	ret 16<br /><br /></code></pre><br />Here the same setup, the stack frame, the definitions.... by the way, I have named SavedEBP for show what is the place of the saved EBP, the ret Address also have a definition, you can delete the definitions (because make look a little ugly the code :)...., by the way, here I dont use the definition and use directly ebp-n for access the arguments....<br /><pre><code><br />WndProc&#58;<br />	push ebp<br />	mov ebp, esp<br />	%define SavedEBP ebp<br />	%define SavedRetAddress ebp+4<br />	%define hWnd ebp+8<br />	%define uMsg ebp+12<br />	%define wParam ebp+16<br />	%define lParam ebp+20<br />	mov eax, &#91;uMsg&#93;<br />	cmp eax, WM_DESTROY<br />	je .WM_DESTROY<br />		apicall DefWindowProcA, &#91;ebp+8&#93;, &#91;ebp+12&#93;, &#91;ebp+16&#93;, &#91;ebp+20&#93;<br />		mov esp, ebp<br />		pop ebp<br />		ret 16<br />	.WM_DESTROY&#58;<br />		apicall PostQuitMessage, 0<br />		xor eax, eax<br />		mov esp, ebp<br />		pop ebp<br />		ret 16<br /></code></pre><br /><br /><br />Copy each part of code if you whant to assemble it.</div>
    <div class="meta">Posted on 2004-12-23 21:06:10 by rea</div>
   </div>
   <div class="post" id="post-154704">
    <div class="subject"><a href="#post-154704">Iczelion's tutorial 3 in nasm syntax</a></div>
    <div class="body">Thanks you very much for your help. :D That's exactly what I was looking for..</div>
    <div class="meta">Posted on 2004-12-24 09:17:54 by dev_zero</div>
   </div>
   <div class="post" id="post-154707">
    <div class="subject"><a href="#post-154707">Iczelion's tutorial 3 in nasm syntax</a></div>
    <div class="body">I was missing  to say taht you can read this one: http://194.65.3.199/win32asm/tutorial/stack_apj.txt<br /><br />Also, you can find some more info here: http://rs1.szif.hu/~tomcat/win32/<br /><br /><br />If you whant more about http://www.win32asmcommunity.net/board/viewtopic.php?t=11425</div>
    <div class="meta">Posted on 2004-12-24 10:45:36 by rea</div>
   </div>
  </div>
 </body>
</html>