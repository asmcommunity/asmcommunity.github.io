<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>determining which mdi is getting activated - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=5525" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=5525">determining which mdi is getting activated</a></p>
   <div class="post" id="post-39250">
    <div class="subject"><a href="#post-39250">determining which mdi is getting activated</a></div>
    <div class="body">hello me again. well im trying to determine what mdi child is being activated when clicked on by the mouse. the problem is that im recieving a whole bunch of messages when responding to the WM_MDIACTIVATE message. is there another approach i can use besides the what i have in the follow code? if you test the code you will notice that my message handler seems to reveive about 30 messages per activation. just open a few mdi child windows and then activate the nonactivated window and you will see what i mean.<br /><pre><code>.586<br />.model flat, stdcall<br /> option casemap &#58;none<br />      <br />   include      /masm32/include/windows.inc<br />   include      /masm32/include/kernel32.inc<br />   include      /masm32/include/user32.inc<br />   include      /masm32/include/comctl32.inc<br />   include      /masm32/include/Gdi32.inc<br />   <br />   includelib   /masm32/lib/kernel32.lib<br />   includelib   /masm32/lib/user32.lib<br />   includelib   /masm32/lib/comctl32.lib<br />   includelib   /masm32/lib/Gdi32.lib<br />      <br />   WinMain      PROTO &#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD<br />   WndProc      PROTO &#58;DWORD,&#58;DWORD,&#58;DWORD,&#58;DWORD<br />   TopXY        PROTO &#58;DWORD,&#58;DWORD<br />   MakeMDIchild PROTO<br />   MDIclass     PROTO<br />      <br />.data<br />   ClassName      db &quot;Starting Template&quot;,0<br />   CaptionText    db &quot;MDI TEST&quot;,0<br />   tMenu          db &quot;Press Me to Create a MDI Child&quot;,0<br />   mdiCl          db &quot;MDICLIENT&quot;,0<br />   MDIchildClass  db &quot;mdi_child&quot;,0<br />   tText          db &quot;MDI Child&quot;,0<br />   tTest          db &quot;You Can Only Make 3&quot;,13,10,<br />                     &quot;MDI Child Windows&quot;,0<br />   counter        dd 0<br />   tChild1        db &quot;Child 1 Activated&quot;,0<br />   tChild2        db &quot;Child 2 Activated&quot;,0<br />   tChild3        db &quot;Child 3 Activated&quot;,0<br />       <br />.data?<br />   hWnd         HANDLE ?<br />   hInstance    HANDLE ?<br />   hEdit1       HANDLE ?<br />   hMenu        HANDLE ?<br />   hClient      HANDLE ?<br />   hChild0      HANDLE ?<br />   hChild1      HANDLE ?<br />   hChild2      HANDLE ?<br />   cc           CLIENTCREATESTRUCT &lt;?&gt;<br />   mdi          WNDCLASSEX &lt;?&gt;<br /><br />.code<br /> start&#58;<br />   invoke GetModuleHandle, NULL<br />   mov    hInstance, eax<br />   invoke WinMain,hInstance,NULL,NULL,SW_SHOWDEFAULT<br />   invoke ExitProcess,eax<br /><br />; ##############################<br /><br />WinMain proc hInst&#58;DWORD, hPrevIns&#58;DWORD, CmdLine&#58;DWORD, CmdShow&#58;DWORD<br /><br />   LOCAL  wc   &#58;WNDCLASSEX<br />   LOCAL  msg  &#58;MSG<br />   LOCAL  Wwd  &#58;DWORD<br />   LOCAL  Wht  &#58;DWORD<br />   LOCAL  Wtx  &#58;DWORD<br />   LOCAL  Wty  &#58;DWORD<br />   <br />   mov    wc.cbSize,       SIZEOF WNDCLASSEX<br />   mov    wc.style,        CS_BYTEALIGNWINDOW<br />   mov    wc.lpfnWndProc,  OFFSET WndProc<br />   mov    wc.cbClsExtra,   NULL<br />   mov    wc.cbWndExtra,   NULL<br />   mov    eax,             hInstance<br />   mov    wc.hInstance,    eax<br />   invoke LoadIcon,        NULL,IDI_APPLICATION<br />   mov    wc.hIcon,        eax<br />   mov    wc.hIconSm,      eax<br />   invoke LoadCursor,      NULL,IDC_ARROW<br />   mov    wc.hCursor,      eax<br />   mov    wc.hbrBackground,COLOR_BTNFACE+1<br />   mov    wc.lpszMenuName, NULL<br />   mov    wc.lpszClassName,OFFSET ClassName<br />   invoke RegisterClassEx, addr wc<br />   <br />   mov    Wwd, 500<br />   mov    Wht, 350<br />   <br />   invoke GetSystemMetrics,SM_CXSCREEN<br />   invoke TopXY,Wwd,eax<br />   mov    Wtx, eax<br />   <br />   invoke GetSystemMetrics,SM_CYSCREEN<br />   invoke TopXY,Wht,eax<br />   mov    Wty, eax<br />   <br />   invoke CreateWindowEx, NULL,<br />                          ADDR ClassName,<br />                          ADDR CaptionText,<br />                          WS_OVERLAPPEDWINDOW,<br />                          Wtx,Wty,Wwd,Wht,<br />                          NULL,<br />                          NULL,<br />                          hInst,<br />                          NULL<br />   mov    hWnd,eax<br />   invoke ShowWindow,hWnd,SW_SHOWNORMAL<br />   invoke UpdateWindow,hWnd<br />   <br />   StartLoop&#58;<br />      invoke GetMessage,ADDR msg,NULL,0,0<br />      cmp eax, 0<br />      je ExitLoop<br />      invoke TranslateMessage, ADDR msg<br />      invoke DispatchMessage,  ADDR msg<br />      jmp StartLoop<br />   ExitLoop&#58;<br /><br />      mov eax,msg.wParam<br />      ret<br /><br />WinMain endp<br /><br />; ###############################<br /><br />WndProc proc hWin&#58;HWND, uMsg&#58;UINT, wParam&#58;WPARAM, lParam&#58;LPARAM<br /><br />   .IF uMsg == WM_CREATE<br />      invoke InitCommonControls<br />      invoke CreateMenu<br />      mov hMenu,eax<br />      invoke AppendMenu,hMenu,MF_POPUP + MF_STRING,8000,addr tMenu<br />      invoke SetMenu,hWin,hMenu     <br />      invoke MDIclass<br />           <br />      invoke GetSubMenu,hMenu,1<br />      mov cc.hWindowMenu,eax<br />      mov cc.idFirstChild,100<br />      invoke CreateWindowEx, WS_EX_CLIENTEDGE,<br />                             addr mdiCl,<br />                             0,<br />                             WS_CHILD + WS_VISIBLE,<br />                             0,0,0,0,<br />                             hWin,<br />                             0,<br />                             hInstance,<br />                             ADDR cc<br />      mov hClient, eax<br />    <br />   .ELSEIF uMsg == WM_COMMAND<br />      .if wParam == 8000<br />         invoke MakeMDIchild<br />      .endif<br />              <br />   .ELSEIF uMsg == WM_DESTROY<br />      invoke PostQuitMessage,NULL<br />      ret<br />   .ENDIF<br />   <br />      invoke DefFrameProc,hWin,hClient,uMsg,wParam,lParam		<br />      ret<br /><br />WndProc endp<br /><br />; ##########################<br /><br />MDIproc proc hwnd&#58;DWORD, uMsg&#58;DWORD, wParam&#58;DWORD, lParam&#58;DWORD<br /><br />   .IF uMsg == WM_MDIACTIVATE   ;handle the window that gets activated here<br />      mov eax,lParam<br />         .if eax == hChild0<br />            invoke MessageBox,0,addr tChild1,0,0<br />         .elseif eax == hChild1<br />            invoke MessageBox,0,addr tChild2,0,0<br />         .elseif eax == hChild2<br />            invoke MessageBox,0,addr tChild3,0,0<br />         .endif<br />   .ENDIF<br />         <br />   invoke DefMDIChildProc,hwnd,uMsg,wParam,lParam<br />ret<br />MDIproc endp<br /><br />; ######################<br /><br />MDIclass proc<br />       <br />   mov    mdi.cbSize,       SIZEOF WNDCLASSEX<br />   mov    mdi.style,        CS_BYTEALIGNWINDOW<br />   mov    mdi.lpfnWndProc,  OFFSET MDIproc<br />   mov    mdi.cbClsExtra,   NULL<br />   mov    mdi.cbWndExtra,   NULL<br />   mov    eax,              hInstance<br />   mov    mdi.hInstance,    eax<br />   mov    mdi.hbrBackground,COLOR_WINDOW+1<br />   invoke LoadCursor,       NULL,IDC_ARROW<br />   mov    mdi.hCursor,      eax<br />   mov    mdi.lpszClassName,OFFSET MDIchildClass<br />   invoke RegisterClassEx,  addr mdi<br />   <br />ret<br /><br />MDIclass endp<br /><br />; ###########################<br /><br />MakeMDIchild proc<br />    .if counter == 3       ;we dont support more than 3 mdi childs in this example so dont make more<br />       invoke MessageBox,0,addr tTest,0,MB_OK<br />       jmp @F<br />    .endif<br />    invoke SendMessage,hClient,WM_MDICASCADE,0,0<br />    invoke CreateWindowEx,WS_EX_MDICHILD,<br />                          ADDR MDIchildClass,<br />                          addr tText,<br />                          0,<br />                          0,0,200,200,<br />                          hClient,<br />                          100,<br />                          hInstance,<br />                          0<br />    .if counter == 0         ;this just assigns unique handles to each child<br />       mov hChild0,eax<br />    .elseif counter == 1<br />       mov hChild1,eax<br />    .elseif counter == 2<br />       mov hChild2,eax<br />    .endif    <br />    inc counter<br />    <br />  @@&#58;<br />ret<br />MakeMDIchild endp<br /><br /><br />; ###########################<br /><br />TopXY proc wDim&#58;DWORD, sDim&#58;DWORD<br /><br />    shr sDim, 1<br />    shr wDim, 1<br />    mov eax, wDim<br />    sub sDim, eax<br />    mov eax,sDim<br />    ret<br /><br />TopXY endp<br /><br />; ###########################<br /><br />end start</code></pre></div>
    <div class="meta">Posted on 2002-05-21 14:14:39 by smurf</div>
   </div>
   <div class="post" id="post-39270">
    <div class="subject"><a href="#post-39270">Heh</a></div>
    <div class="body">Thats because your handling it in the child proc.  Whats going on is that each child gets a message in the form of:<br /><br />// Message received by MDI child <br />hwndChildDeact = (HWND) wParam;        // child being deactivated <br />hwndChildAct = (HWND) lParam;          // child being activated <br /><br /><br />You want to handle this (in this case) in the parent:<br /><br />WM_MDIACTIVATE <br /><br />// Message sent to MDI client <br />wParam = (WPARAM) (HWND) hwndChildAct; // child to activate <br />lParam = 0;                            // not used; must be zero <br /><br />:alright:<br /><br />Ahh actually just two get sent out, one for the child deactivating and one for the one becoming active.  The multiples might have something to do with the message boxes stealing the focus right after they got it...</div>
    <div class="meta">Posted on 2002-05-21 16:31:44 by Graebel</div>
   </div>
   <div class="post" id="post-39276">
    <div class="subject"><a href="#post-39276">determining which mdi is get activated</a></div>
    <div class="body">hi Graebel,<br /><br />did you test what you posted? ive already tryed that but my WndProc doesnt receive that message at all.<br /><br />also i was able to limit the amount of messages i received by the method im using. i use a counter but its very strange because if i increment my counter right after i invoke the messagebox it doesnt work right because i still get a whole bunch of messages. it like a whole bunch of messages are coming through in one shot. here is the updated method and with this i was able to filter all but 2 messages coming through at one time:<br /><br /><pre><code>   .IF uMsg == WM_MDIACTIVATE   ;handle the window that gets activated here<br />      mov eax,lParam<br />         .if eax == hChild0<br />            .if count == 0        ;just using a counter here<br />               inc count<br />               invoke MessageBox,0,addr tChild1,0,0<br />               mov count,0<br />            .endif<br />         .endif<br />   .ENDIF</code></pre></div>
    <div class="meta">Posted on 2002-05-21 17:14:46 by smurf</div>
   </div>
   <div class="post" id="post-39366">
    <div class="subject"><a href="#post-39366">determining which mdi is get activated</a></div>
    <div class="body">Ahh Smurf.  No I did not.  I took those two blurps directly from my Win32 reference.  I have found it be accurate 95% of the time.  I rarely if ever find an error in what it says.  Usually it is not about what it says rather it is something they left out.  As that was spelled out rather clearly I did not feel testing was warrented and just posted the info.  I will bat it around however.</div>
    <div class="meta">Posted on 2002-05-22 09:08:49 by Graebel</div>
   </div>
   <div class="post" id="post-39370">
    <div class="subject"><a href="#post-39370">determining which mdi is get activated</a></div>
    <div class="body">Ok I think I am done with my testing.  I ran the program as posted and of course I was spammed to death with pop up windows.<br /><br />I then modified it slightly to use DbgWin as follows<br /><pre><code><br />   include     \masm32\include\masm32.inc<br />   include     \masm32\include\debug.inc<br /><br />   includelib  \masm32\lib\debug.lib<br />   includelib  \masm32\lib\masm32.lib<br /><br /></code></pre><br /><pre><code><br />   .IF uMsg == WM_MDIACTIVATE   ;handle the window that gets activated here<br />   mov eax,lParam<br />      .if eax == hChild0<br />         PrintDec 1<br />      .elseif eax == hChild1<br />         PrintDec 2<br />      .elseif eax == hChild2<br />         PrintDec 3<br />      .endif<br /></code></pre><br /><br />And the problem of the never ending message boxes disappeared.  Which leads me to what I think was happening.<br /><br />If you click on Child1 on the original program<br /><br />1) MDI child1 gets message for focus which creates pop-up<br />2) MDI child which had focus gets same message creating pop-up<br />3) pop-ups are causing MDI child to lose focus <br />4) When you close a pop-up <br /><br />Its just a big recursive focus loop.  I am still unsure of how after about 30 or 40 pop-ups the program breaks the cycle but it does.  DbgWin is a seperate window and when shifting between different windows the WM_MDIACTIVATE message is not sent again so this fixes the problem.  Basically its working just fine, just take out the message boxes.  Or if you need a visual clue, add a status bar and post the messages to it.<br /><br />:alright:</div>
    <div class="meta">Posted on 2002-05-22 09:51:30 by Graebel</div>
   </div>
   <div class="post" id="post-39372">
    <div class="subject"><a href="#post-39372">determining which mdi is get activated</a></div>
    <div class="body">thanks graebel,<br /><br />its very clear to me now what was going on. im going to have to learn how to use the debuging macros instead of using message boxes all the time.:alright:<br /><br /><strong></strong> one thing troubles me though. i still get two messages coming through when a mdi is being activated. this is a quote from the MSDN:<br /><div class="quote">As the client window processes this message, it sends WM_MDIACTIVATE to the child window being deactivated and to the child window being activated. The message parameters received by an MDI child window are as follows: <br /><br />wParam <br />Handle to the MDI child window being deactivated. <br />lParam <br />Handle to the MDI child window being activated. </div><br /><br />to me it appears that im reveiving both the activated and deactivated messages. but i should be only receiving the activated one because im using the lParm value. to test this i opened up a single mdi child which has focus and then clicked on the close button. when the mdi closed i received a message in my handler. any ideas?</div>
    <div class="meta">Posted on 2002-05-22 10:25:13 by smurf</div>
   </div>
   <div class="post" id="post-39390">
    <div class="subject"><a href="#post-39390">determining which mdi is get activated</a></div>
    <div class="body">Hey Smurf =) not true<br /><br />To steal part of your quote<br /><div class="quote"><br />wParam <br />Handle to the MDI child window being deactivated. <br />lParam <br />Handle to the MDI child window being activated. <br /></div><br /><br />Look closely at the wParam and lParam from the quote.  It does not matter if the MDI child is being actived or being deactivated.  They both recieve the exact same message so filtering it from the lParam does little good.</div>
    <div class="meta">Posted on 2002-05-22 13:30:03 by Graebel</div>
   </div>
  </div>
 </body>
</html>