<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Optimizing request - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=11642" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=11642">Optimizing request</a></p>
   <div class="post" id="post-88260">
    <div class="subject"><a href="#post-88260">Optimizing request</a></div>
    <div class="body">I would like to know if this can be optimized. (I am sure it can with you folk), I am still working on it but it does the following:<br />Formats a regpath and writes to file<br />Opens a parent reg key<br />enumerates the parent key<br />writes current key to file<br />enumerates values in current key<br />and will current values to file<br /><br />just wanted to know how you would go about it....  any changes, explain so I can benifit... (have half a bottle of wine in me so speak slowly :-p)<br /><br />yes I modified hutches HexDump :-)<br /><br /><pre><code><br />BackupZones proc uses ebx esi edi<br />LOCAL	TempFile&#91;30&#93;&#58;BYTE<br />LOCAL	hRegFile&#58;DWORD<br />LOCAL	lpcbData&#58;DWORD<br />LOCAL	KeyToWrite&#91;95&#93;&#58;BYTE<br /><br />LOCAL	hSourceKey&#58;DWORD<br />LOCAL	hSubKey&#58;DWORD<br /><br />LOCAL	lpZoneKey&#91;80&#93;&#58;BYTE<br /><br />LOCAL	lpValueName &#91;60&#93;&#58;BYTE<br />LOCAL	ft&#58;FILETIME<br />LOCAL	lpcName&#58;DWORD<br />LOCAL	lpName&#91;5&#93;&#58;BYTE<br />LOCAL	lpType&#58;DWORD<br />LOCAL	lpcValueName&#58;DWORD<br />LOCAL	DwordValue&#58;DWORD<br /><br />LOCAL	ValueToWrite&#58;DWORD<br /><br /><br />	push	0			; <br />	push	offset sBackupPath	;<br />	call	CreateDirectoryA	; Create Backup directory<br />	<br />	push	0			;<br />	push	30			;<br />	lea	edi, TempFile		;<br />	push	edi			; edi = pointer to TempFile				<br />	call	memfill			;<br />	<br />	push	edi			;<br />	call	CreateFileName		; Create backup filename<br />	<br />	lea	eax, sBackupPath	;<br />	push	eax			;<br />	call	StrLen			;<br />	inc	eax			;<br />	mov	esi, eax		;<br />					;<br />	push	edi			;<br />	call	StrLen			;<br />	add	eax, 5			;<br />	add	eax, esi		; Get string sizes<br />	<br />	push	eax			;<br />	push	HEAP_ZERO_MEMORY	;<br />	push	hHeap			;<br />	call	HeapAlloc		; Allocate memory for filename<br />	mov	esi, eax		; esi = pointer to filename<br />	<br />	push	offset szExtReg		;<br />	push	edi			;<br />	push	offset sBackupPath	;<br />	push	esi			;<br />	push	3			;<br />	call	szMultiCat		; Create file path<br />	<br />	push	0			;<br />	push	FILE_ATTRIBUTE_NORMAL	;<br />	push	CREATE_NEW		;<br />	push	0			;<br />	push	0			;<br />	push	GENERIC_WRITE		;<br />	push	esi			; <br />	call	CreateFileA		; Create reg file<br />	mov	hRegFile, eax		;<br />	<br />	push	esi			;<br />	push	0			;<br />	push	hHeap			;<br />	call	HeapFree		; Free filepath + filename buffer<br /><br />	push	0			;<br />	lea	eax, lpcbData		;<br />	push	eax			;<br />	push	sizeof szRegEdit	;<br />	push	offset szRegEdit	;<br />	push	hRegFile		;<br />	call	WriteFile		; Write regedit header<br /><br />	push	0			;<br />	push	95			;<br />	lea	edi, KeyToWrite		;<br />	push	edi			; edi = pointer to KeyToWrite<br />	call	memfill			; clear buffer<br />	<br />	push	offset NewLine		;<br />	push	offset szRightBracket	;<br />	push	offset RegKeyZone	;<br />	push	offset RegKeyBase	;<br />	push	offset RegKeyPrefix	;<br />	push	edi			;<br />	push	5			;<br />	call	szMultiCat		; Format zone path to write<br /><br />	push	edi			;<br />	call	StrLen			; Get length of zonepath<br />	mov	esi, eax		; save length<br />	<br />	push	0			;<br />	lea	eax, lpcbData		;<br />	push	eax			;<br />	push	esi			;<br />	push	edi			;<br />	push	hRegFile		;<br />	call	WriteFile		; Write zone path to file<br /><br />	push	0			;<br />	lea	eax, lpcbData		;<br />	push	eax			;<br />	push	sizeof szDefault3	;<br />	lea	eax, szDefault3		;<br />	push	eax			;<br />	push	hRegFile		;<br />	call	WriteFile		; Write default value to file<br />	<br />	push	0			;<br />	push	80			;<br />	lea	esi, lpZoneKey		;<br />	push	esi			;<br />	call	memfill			;<br />	<br />	push	offset RegKeyZone	;<br />	push	offset RegKeyBase	;<br />	push	esi			;<br />	push	2			;<br />	call	szMultiCat		; Create zone path to open<br />	<br />	lea	eax, hSourceKey		;<br />	push	eax			;<br />	push	KEY_ENUMERATE_SUB_KEYS	;<br />	push	0			;<br />	push	esi			;<br />	push	HKEY_CURRENT_USER	;<br />	call	RegOpenKeyExA		; Open zone key for enumeration<br /><br />	xor	ebx, ebx<br />GetNextZone&#58;<br />	lea	eax, ft			;<br />	push	eax			;<br />	push	0			;<br />	push	0			;<br />	push	0			;<br />	mov	lpcName, 5		;<br />	lea	ecx, lpcName		;<br />	push	ecx			;<br />	lea	esi, lpName		;<br />	push	esi			;<br />	push	ebx			;<br />	push	hSourceKey		;<br />	call	RegEnumKeyExA		; Get next zone key<br />	cmp	eax, ERROR_NO_MORE_ITEMS; Anymore keys?<br />	je	Done			; no, leave<br />	<br />	push	0			;<br />	push	95			;<br />	lea	edi, KeyToWrite		;<br />	push	edi			;<br />	call	memfill			;<br />	<br />	push	offset NewLine		;<br />	push	offset szRightBracket	;<br />	push	esi			;<br />	push	offset szSlash		;<br />	push	offset RegKeyZone	;<br />	push	offset RegKeyBase	;<br />	push	offset RegKeyPrefix	;<br />	push	edi			;<br />	push	7			;<br />	call	szMultiCat		; Format current zone to write<br /><br />	push	edi			;<br />	call	StrLen			;<br />	<br />	push	0			;<br />	lea	ecx, lpcbData		;<br />	push	ecx			;<br />	push	eax			;<br />	push	edi			;<br />	push	hRegFile		;<br />	call	WriteFile		; Write current zone to file<br /><br />	lea	eax, hSubKey		;<br />	push	eax			;<br />	push	KEY_QUERY_VALUE 	;<br />	push	0			;<br />	push	esi			;<br />	push	hSourceKey		;<br />	call	RegOpenKeyExA		; Opent current zone key<br /><br />	push	ebx<br />	xor	ebx, ebx<br />GetNextValue&#58;<br />	lea	eax, lpcbData<br />	push	eax<br />	push	0<br />	lea	ecx, lpType <br />	push	ecx<br />	push	0<br />	mov	lpcValueName, 60<br />	lea	eax, lpcValueName<br />	push	eax<br />	lea	ecx, lpValueName<br />	push	ecx<br />	push	ebx<br />	push	hSubKey<br />	call	RegEnumValueA<br />	cmp	eax, ERROR_NO_MORE_ITEMS<br />	je	NoMoreValues<br />	<br />	.if lpType == REG_DWORD<br />		mov	lpcbData, 4<br />		lea	ecx, lpcbData<br />		push	ecx<br />		lea	eax, DwordValue<br />		push	eax<br />		push	0<br />		push	0<br />		lea	edx, lpValueName<br />		push	edx<br />		push	hSubKey<br />		call	RegQueryValueExA<br />		; convert to hex, format and write to file here<br />		<br />	.elseif lpType == REG_SZ<br />		invoke	HeapAlloc, hHeap, HEAP_ZERO_MEMORY, lpcbData<br />		mov	esi, eax		<br />		lea	ecx, lpcbData<br />		push	ecx<br />		push	esi<br />		push	0<br />		push	0<br />		lea	edx, lpValueName<br />		push	edx<br />		push	hSubKey<br />		call	RegQueryValueExA<br />		; format and write to file here<br />		push	esi<br />		push	0<br />		push	hHeap<br />		call	HeapFree<br />	.else<br />		invoke	HeapAlloc, hHeap, HEAP_ZERO_MEMORY, lpcbData<br />		mov	esi, eax		<br />		lea	ecx, lpcbData<br />		push	ecx<br />		push	esi<br />		push	0<br />		push	0<br />		lea	edx, lpValueName<br />		push	edx<br />		push	hSubKey<br />		call	RegQueryValueExA<br />		<br />		mov	eax, lpcbData<br />		add	eax, eax<br />		add	eax, eax<br />		push	eax<br />		push	HEAP_ZERO_MEMORY<br />		push	hHeap<br />		call	HeapAlloc<br />		mov	edi, eax<br /><br />		push	edi		; Convert buffer to hex<br />		push	lpcbData<br />		push	esi<br />		call	HexDump<br />		<br />		; Append and write to file here<br />		<br />		push	edi<br />		push	0<br />		push	hHeap<br />		call	HeapFree<br />		<br />		push	esi<br />		push	0<br />		push	hHeap<br />		call	HeapFree<br />		<br />	.endif<br /><br />	inc	ebx<br />	jmp	GetNextValue<br />	<br />NoMoreValues&#58;<br /><br />	push	hSubKey<br />	call	RegCloseKey<br />	<br />	pop	ebx<br />	inc	ebx<br />	jmp	GetNextZone<br />	<br />Done&#58;	<br />	push	hRegFile<br />	call	CloseHandle<br />	<br />	push	hSourceKey<br />	call	RegCloseKey <br /><br />	ret<br />BackupZones endp<br /><br />HexDump proc lpString&#58;DWORD,lnString&#58;DWORD,lpbuffer&#58;DWORD<br />LOCAL lcnt&#58;DWORD<br />LOCAL	Temp&#58;DWORD<br />    push ebx<br />    push esi<br />    push edi<br />jmp over_table<br />  hex_table&#58;<br />    db &quot;00&quot;,&quot;01&quot;,&quot;02&quot;,&quot;03&quot;,&quot;04&quot;,&quot;05&quot;,&quot;06&quot;,&quot;07&quot;,&quot;08&quot;,&quot;09&quot;,&quot;0A&quot;,&quot;0B&quot;,&quot;0C&quot;,&quot;0D&quot;,&quot;0E&quot;,&quot;0F&quot;<br />    db &quot;10&quot;,&quot;11&quot;,&quot;12&quot;,&quot;13&quot;,&quot;14&quot;,&quot;15&quot;,&quot;16&quot;,&quot;17&quot;,&quot;18&quot;,&quot;19&quot;,&quot;1A&quot;,&quot;1B&quot;,&quot;1C&quot;,&quot;1D&quot;,&quot;1E&quot;,&quot;1F&quot;<br />    db &quot;20&quot;,&quot;21&quot;,&quot;22&quot;,&quot;23&quot;,&quot;24&quot;,&quot;25&quot;,&quot;26&quot;,&quot;27&quot;,&quot;28&quot;,&quot;29&quot;,&quot;2A&quot;,&quot;2B&quot;,&quot;2C&quot;,&quot;2D&quot;,&quot;2E&quot;,&quot;2F&quot;<br />    db &quot;30&quot;,&quot;31&quot;,&quot;32&quot;,&quot;33&quot;,&quot;34&quot;,&quot;35&quot;,&quot;36&quot;,&quot;37&quot;,&quot;38&quot;,&quot;39&quot;,&quot;3A&quot;,&quot;3B&quot;,&quot;3C&quot;,&quot;3D&quot;,&quot;3E&quot;,&quot;3F&quot;<br />    db &quot;40&quot;,&quot;41&quot;,&quot;42&quot;,&quot;43&quot;,&quot;44&quot;,&quot;45&quot;,&quot;46&quot;,&quot;47&quot;,&quot;48&quot;,&quot;49&quot;,&quot;4A&quot;,&quot;4B&quot;,&quot;4C&quot;,&quot;4D&quot;,&quot;4E&quot;,&quot;4F&quot;<br />    db &quot;50&quot;,&quot;51&quot;,&quot;52&quot;,&quot;53&quot;,&quot;54&quot;,&quot;55&quot;,&quot;56&quot;,&quot;57&quot;,&quot;58&quot;,&quot;59&quot;,&quot;5A&quot;,&quot;5B&quot;,&quot;5C&quot;,&quot;5D&quot;,&quot;5E&quot;,&quot;5F&quot;<br />    db &quot;60&quot;,&quot;61&quot;,&quot;62&quot;,&quot;63&quot;,&quot;64&quot;,&quot;65&quot;,&quot;66&quot;,&quot;67&quot;,&quot;68&quot;,&quot;69&quot;,&quot;6A&quot;,&quot;6B&quot;,&quot;6C&quot;,&quot;6D&quot;,&quot;6E&quot;,&quot;6F&quot;<br />    db &quot;70&quot;,&quot;71&quot;,&quot;72&quot;,&quot;73&quot;,&quot;74&quot;,&quot;75&quot;,&quot;76&quot;,&quot;77&quot;,&quot;78&quot;,&quot;79&quot;,&quot;7A&quot;,&quot;7B&quot;,&quot;7C&quot;,&quot;7D&quot;,&quot;7E&quot;,&quot;7F&quot;<br />    db &quot;80&quot;,&quot;81&quot;,&quot;82&quot;,&quot;83&quot;,&quot;84&quot;,&quot;85&quot;,&quot;86&quot;,&quot;87&quot;,&quot;88&quot;,&quot;89&quot;,&quot;8A&quot;,&quot;8B&quot;,&quot;8C&quot;,&quot;8D&quot;,&quot;8E&quot;,&quot;8F&quot;<br />    db &quot;90&quot;,&quot;91&quot;,&quot;92&quot;,&quot;93&quot;,&quot;94&quot;,&quot;95&quot;,&quot;96&quot;,&quot;97&quot;,&quot;98&quot;,&quot;99&quot;,&quot;9A&quot;,&quot;9B&quot;,&quot;9C&quot;,&quot;9D&quot;,&quot;9E&quot;,&quot;9F&quot;<br />    db &quot;A0&quot;,&quot;A1&quot;,&quot;A2&quot;,&quot;A3&quot;,&quot;A4&quot;,&quot;A5&quot;,&quot;A6&quot;,&quot;A7&quot;,&quot;A8&quot;,&quot;A9&quot;,&quot;AA&quot;,&quot;AB&quot;,&quot;AC&quot;,&quot;AD&quot;,&quot;AE&quot;,&quot;AF&quot;<br />    db &quot;B0&quot;,&quot;B1&quot;,&quot;B2&quot;,&quot;B3&quot;,&quot;B4&quot;,&quot;B5&quot;,&quot;B6&quot;,&quot;B7&quot;,&quot;B8&quot;,&quot;B9&quot;,&quot;BA&quot;,&quot;BB&quot;,&quot;BC&quot;,&quot;BD&quot;,&quot;BE&quot;,&quot;BF&quot;<br />    db &quot;C0&quot;,&quot;C1&quot;,&quot;C2&quot;,&quot;C3&quot;,&quot;C4&quot;,&quot;C5&quot;,&quot;C6&quot;,&quot;C7&quot;,&quot;C8&quot;,&quot;C9&quot;,&quot;CA&quot;,&quot;CB&quot;,&quot;CC&quot;,&quot;CD&quot;,&quot;CE&quot;,&quot;CF&quot;<br />    db &quot;D0&quot;,&quot;D1&quot;,&quot;D2&quot;,&quot;D3&quot;,&quot;D4&quot;,&quot;D5&quot;,&quot;D6&quot;,&quot;D7&quot;,&quot;D8&quot;,&quot;D9&quot;,&quot;DA&quot;,&quot;DB&quot;,&quot;DC&quot;,&quot;DD&quot;,&quot;DE&quot;,&quot;DF&quot;<br />    db &quot;E0&quot;,&quot;E1&quot;,&quot;E2&quot;,&quot;E3&quot;,&quot;E4&quot;,&quot;E5&quot;,&quot;E6&quot;,&quot;E7&quot;,&quot;E8&quot;,&quot;E9&quot;,&quot;EA&quot;,&quot;EB&quot;,&quot;EC&quot;,&quot;ED&quot;,&quot;EE&quot;,&quot;EF&quot;<br />    db &quot;F0&quot;,&quot;F1&quot;,&quot;F2&quot;,&quot;F3&quot;,&quot;F4&quot;,&quot;F5&quot;,&quot;F6&quot;,&quot;F7&quot;,&quot;F8&quot;,&quot;F9&quot;,&quot;FA&quot;,&quot;FB&quot;,&quot;FC&quot;,&quot;FD&quot;,&quot;FE&quot;,&quot;FF&quot;<br />  over_table&#58;<br />    lea ebx, hex_table        ; get base address of table<br />    mov esi, lpString         ; address of source string<br />    mov edi, lpbuffer         ; address of output buffer<br />    mov eax, esi<br />    add eax, lnString<br />    mov ecx, eax              ; exit condition for byte read<br />    mov lcnt, 0<br />mov	Temp, 0<br />    xor eax, eax              ; prevent stall<br /><br />  ; %%%%%%%%%%%%%%%%%%%%%%% loop code %%%%%%%%%%%%%%%%%%%%%%%%%%%%%<br /><br />ConvertNextChar&#58;<br />    mov al, &#91;esi&#93;             ; get BYTE<br />    inc esi<br />    inc lcnt<br />    mov dx, &#91;ebx+eax*2&#93;       ; put WORD from table into DX<br />    mov &#91;edi&#93;, dx             ; write 2 byte string to buffer<br />    add edi, 2<br />    mov BYTE PTR &#91;edi&#93;, 2CH ; add comma ;32    ; add space<br />    inc edi<br /><br />cmp Temp, 10<br />jne No<br /><br />    mov BYTE PTR &#91;edi&#93;, 5CH<br />    inc edi<br />    mov BYTE PTR &#91;edi&#93;, 0AH<br />    mov BYTE PTR &#91;edi&#93;, 0Dh ; write CRLF to buffer<br />    inc edi<br />    ;add edi, 3;2<br />    mov lcnt, 0<br />    jmp @F<br />No&#58;<br />    cmp lcnt, 25 ;16              ; break line at 16 characters<br />    jne @F<br /><br />   ; dec edi                   ; overwrite last space<br />    mov BYTE PTR &#91;edi&#93;, 5CH<br />    inc edi<br />    mov BYTE PTR &#91;edi&#93;, 0AH<br />    mov BYTE PTR &#91;edi&#93;, 0Dh ; write CRLF to buffer<br />    inc edi<br />    ;add edi, 3;2<br />    mov lcnt, 0<br />    <br />  @@&#58;<br />  inc	Temp<br />    cmp esi, ecx              ; test exit condition<br />    jl ConvertNextChar<br /><br />  ; %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<br /><br />    dec edi ;inc edi<br />    mov BYTE PTR &#91;edi&#93;, 0     ; append terminator<br /><br />    pop edi<br />    pop esi<br />    pop ebx<br /><br />    ret<br /><br />HexDump endp<br /></code></pre></div>
    <div class="meta">Posted on 2003-03-19 20:29:02 by Gunner</div>
   </div>
   <div class="post" id="post-88347">
    <div class="subject"><a href="#post-88347">Optimizing request</a></div>
    <div class="body">Rob,<br /><br />A couple of things with the modified version of hexDump, put the &quot;align 16&quot; back at the label at the beginning of the table, it saves you from unaligned reads from the table.<br /><br />Replace the 2 seperate byte writes for the CRLF with,<br /><pre><code><br />    mov WORD PTR &#91;edi&#93;, 0A0Dh ; write CRLF to buffer<br /></code></pre><br />One memory access less per iteration.<br /><br />These are the two I could see in a hurry.<br /><br />Regards and keep up the good work.<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2003-03-20 03:05:57 by hutch--</div>
   </div>
   <div class="post" id="post-88542">
    <div class="subject"><a href="#post-88542">Optimizing request</a></div>
    <div class="body">I removed the Align 16 cause it wouldn't assemble... changed .386 to .486 and it assembles now...<br /><br />Will change the crlf stuff... <br /><br />Thanks</div>
    <div class="meta">Posted on 2003-03-20 16:51:45 by Gunner</div>
   </div>
  </div>
 </body>
</html>