<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>How to read Unicode text to richedit control? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=4499" />
    <link rel="next" href="../?id=4499&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=4499">How to read Unicode text to richedit control?</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=4499&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=4499&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="4499" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=4499&amp;page=2">&gt;</a><a href="../?id=4499&amp;page=2">&raquo;</a></form>   <div class="post" id="post-31425">
    <div class="subject"><a href="#post-31425">How to read Unicode text to richedit control?</a></div>
    <div class="body">Now I'm learning richedit control programming, write my own editor. Through learning Iczelion's win32asm tutor, I can read ANSI text file to richedit control, but in this way reading Unicode text, I got unreadable character, I know I must change the code compatible with Unicode text, can someone give me a snippet code that demostrate how to read Unicode text in richedit control.<br /><br />  Thx!<br /><br />dREAMtHEATER</div>
    <div class="meta">Posted on 2002-03-29 05:23:36 by dREAMtHEATER</div>
   </div>
   <div class="post" id="post-31483">
    <div class="subject"><a href="#post-31483">How to read Unicode text to richedit control?</a></div>
    <div class="body">Just a friendly reminder that this board has a very good search feature...<br /><br />IE) I found an old post almost exactly worded the same as your title..<br /><br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=627&amp;highlight=MultiByteToWideChar">How to work in richedit using Unicode?</a> <br /><br />This has all the API's you would need to get the conversions done.<br /><br />Enjoy..<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-03-29 13:12:09 by NaN</div>
   </div>
   <div class="post" id="post-31559">
    <div class="subject"><a href="#post-31559">How to read Unicode text to richedit control?</a></div>
    <div class="body">Hi NaN:<br />   Before I posted this thread, I'v searched the whole forum for Unicode subject, and read carefully the post you mentioned, but I still have no idea how to code, can u give me a sample code to demostrate it?</div>
    <div class="meta">Posted on 2002-03-29 21:48:08 by dREAMtHEATER</div>
   </div>
   <div class="post" id="post-31586">
    <div class="subject"><a href="#post-31586">How to read Unicode text to richedit control?</a></div>
    <div class="body">Sure, i will try, but first cut more clearly what you need to happen for me:<br /><br /> A)  Want normal Text to be converted to Unicode and then placed to the REdit?<br /><br /> B) Want Unicode text to be converted to normal text for REdit?<br /><br /> C) Normal Text shown as Unicode in REdit ( Dunno why? )<br /><br /> D) something else? :)<br /><br />Im not too sure exactly which API you want me to help you out with (essentially, i know one of em will help you :)  )<br /><br /><br />PS: Thanx for using the search!  <br /><br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-03-30 02:52:05 by NaN</div>
   </div>
   <div class="post" id="post-31607">
    <div class="subject"><a href="#post-31607">How to read Unicode text to richedit control?</a></div>
    <div class="body">Hi! NaN:<br />     Thanks for ur help. if u write some code I wish got  the way just like notepad do under 2000/XP,  when user select a text file, u should give him a chance which text coding type he wanna use, just deal with GetOpenFilename API, you should add option that user can select the text coding  type, such as ANSI, Unicode, UTF-8, I don't how to add this option in the OPENFILENAME structure. when user save file, he can also do same thing. <br />     According to user selection, u should <br /><br /> A)  read file as normal Text when it's ANSI format<br /> B)  show Unicode text as normal text for REdit when it's Unicode format(it's the core question, I don't know how to do it, maybe Want Unicode text to be converted to normal text for REdit?<br /><br />  I will wait ur good news.<br />  Sorry for my bad English!<br /><br />dREAMtHEATER<br /><br /><div class="quote"><br />Sure, i will try, but first cut more clearly what you need to happen for me:<br /><br /> A)  Want normal Text to be converted to Unicode and then placed to the REdit?<br /><br /> B) Want Unicode text to be converted to normal text for REdit?<br /><br /> C) Normal Text shown as Unicode in REdit ( Dunno why? )<br /><br /> D) something else? :)<br /><br />Im not too sure exactly which API you want me to help you out with (essentially, i know one of em will help you :)  )<br /><br /><br />PS: Thanx for using the search!  <br /><br />:alright:<br />NaN </div></div>
    <div class="meta">Posted on 2002-03-30 05:28:55 by dREAMtHEATER</div>
   </div>
   <div class="post" id="post-31639">
    <div class="subject"><a href="#post-31639">How to read Unicode text to richedit control?</a></div>
    <div class="body">Ok i will be honest, and say I have used unicode strings in the past, but not to the extent of detecting them from a file...<br /><br />I briefly looked throught the OPENFILENAME struct and dont see anything that would get you an indication of whether the chosen file is ASCII .txt or Unicode .txt ???  So this i will leave to you to decided when its &quot;time&quot; to use the following conversion routine:<br /><br />To convert a string of Unicode to standard ASCII use: <strong>WideCharToMultiByte </strong>.  ( words -&gt; bytes )<br /><br />Ernie has made some simple little macro's to get this done simpler:<pre><code>Ascii2Unicode 	MACRO pwszReturnBuf&#58;REQ, pszSourceBuf&#58;REQ, SizeOfSourceBuf&#58;REQ<br />	invoke MultiByteToWideChar, CP_ACP, 0, pszSourceBuf, -1, pwszReturnBuf, SizeOfSourceBuf<br />ENDM<br />;-------------------------------------------------------------------------------<br />Unicode2Ascii 	MACRO pszReturnBuf&#58;REQ, pwszSourceBuf&#58;REQ, SizeOfSourceBuf&#58;REQ<br />	invoke WideCharToMultiByte, CP_ACP, 0, pwszSourceBuf, -1, pszReturnBuf, SizeOfSourceBuf, NULL, NULL<br />ENDM</code></pre><br /><br /><ul>So the steps i would do in your case is:<br />[*] - Get the file size that will be loaded ( nFileSize )<br />[*] - load the file (probabaly thru file mapping - get a pointer pSrcData)<br />[*] - Decided if you need to convert Unicode-&gt;Bytes (uncertian at this point how)<br />[*] - Have some global memory for a buffer to decoded into.  Can make a swap file in a temp Dir,  can allocate a large piece of global memory, or use RichEdit's buffer (all should work).<br />[*] - Once you have a buffer to work with, use &quot;Unicode2Ascii pSrcData, pGlobalData, nFileSize&quot;  for full translation at once.  Or for partial translations, have the source adjust to point to the beginning, and alter the nFilesize to amount to the # of bytes needed to be translated..  (this would typically be the 'viewing' range of text in the Rich edit).<br /><br /><br />I hope this is some help to you, i didnt what to get into code directly as i pretty well hate using RichEdit and try to avoid it myself.  Lemme know if you still need help at something, and if you want me to 'code' a bit, post or email mesome source to start with (save me the headaches of RichEdit ;P )<br /><br />Best of luck.<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-03-30 12:13:19 by NaN</div>
   </div>
   <div class="post" id="post-31640">
    <div class="subject"><a href="#post-31640">How to read Unicode text to richedit control?</a></div>
    <div class="body">After re-reading your reply I starting to realize you *do* need help with the detecton of when its time... <br /><br />I dont have a NT system, so im not familiar with the Notpad your talking about, but my only sugestion is to use the open file name dialog box, and provide a custom dialog template, and callback routine to provide a checkbox to the user to 'open as Unicode' or something.  At least then you would know its intended as unicode.  But this is a bit of work on its own to do... ??<br /><br />This is just a sugestion/idea.  I dont know how well (if at all possible) it will be.  Most of the time you'll get headers with the file being opended (in the file) and can decided what to do with it by this, or by its extension type.  But for txt files there is neither, so i can see the delema here... <br /><br />Perhaps someone else has some usefull sugestions here?<br /><br />:NaN:</div>
    <div class="meta">Posted on 2002-03-30 12:20:24 by NaN</div>
   </div>
   <div class="post" id="post-31644">
    <div class="subject"><a href="#post-31644">How to read Unicode text to richedit control?</a></div>
    <div class="body">well once you select the file you want you dont have to process the info into the richedit right away. all you have to do is have a window popup on whether you would like to have it processed as ANSI or Unicode format. then once the user has made his/her selection you then process an ansi or unicode procedure depending on the choice.</div>
    <div class="meta">Posted on 2002-03-30 12:58:22 by smurf</div>
   </div>
   <div class="post" id="post-31652">
    <div class="subject"><a href="#post-31652">How to read Unicode text to richedit control?</a></div>
    <div class="body">Hi! NaN:<br />    With ur suggest, I change my code when reading file to richedit control, I use standard technique that send message to richedit with EM_STREAMIN, so I must  code EditStreamCallback<br /><br /><div class="quote">EditStreamCallback proc IsOpen:DWORD, pBuffer:DWORD, NumBytes:DWORD, pBytesTransferred:DWORD<br />	LOCAL hGlobal, pSrcData:DWORD<br />	.IF IsOpen == TRUE<br />		invoke GlobalAlloc, GMEM_ZEROINIT or GMEM_FIXED, NumBytes<br />		mov hGlobal, eax<br />		invoke GlobalLock, hGlobal<br />		mov pSrcData, eax<br />		invoke  ReadFile, hFile, pSrcData, NumBytes, pBytesTransferred, 0<br />		Unicode2Ascii pBuffer, pSrcData, NumBytes<br />		invoke GlobalUnlock, hGlobal<br />		invoke GlobalFree, hGlobal	<br />	.ELSE	<br />	    invoke  WriteFile, hFile, pBuffer, NumBytes, pBytesTransferred, 0<br />	.ENDIF	<br />	xor eax,1<br />	ret	<br />EditStreamCallback endp</div> <br /><br />   I just change openfile function, but it doesn't work, before I change, it run happily, NaA, can u figure out  what's wrong in my snippet code, thanx for ur help!</div>
    <div class="meta">Posted on 2002-03-30 14:00:41 by dREAMtHEATER</div>
   </div>
   <div class="post" id="post-31711">
    <div class="subject"><a href="#post-31711">How to read Unicode text to richedit control?</a></div>
    <div class="body">I dont have an RichEdit example on hand to test this with, but try this out: <pre><code>EditStreamCallback proc IsOpen&#58;DWORD, pBuffer&#58;DWORD, NumBytes&#58;DWORD, pBytesTransferred&#58;DWORD <br /><br />LOCAL hGlobal, pSrcData&#58;DWORD <br />LOCAL ErrorFlag &#58;DWORD<br /><br />mov ErrorFlag, FLASE<br /><br />.IF IsOpen == TRUE <br />     invoke GlobalAlloc, GMEM_ZEROINIT or GMEM_FIXED, NumBytes <br />     mov hGlobal, eax <br />     invoke GlobalLock, hGlobal <br />     mov pSrcData, eax <br />     invoke ReadFile, hFile, pSrcData, NumBytes, pBytesTransferred, 0 <br />     .if&#40; eax == 0&#41;<br />         mov ErrorFlag, TRUE<br />         jmp @F<br />     .endif<br />     mov edx, pBytesTransferred<br />     mov eax, &#91;edx&#93;<br />     Unicode2Ascii pBuffer, pSrcData, eax         ; Actual number loaded<br />     invoke GlobalUnlock, hGlobal <br />     invoke GlobalFree, hGlobal         ; If the function succeeds, the return value is NULL.<br />.ELSE <br />     invoke WriteFile, hFile, pBuffer, NumBytes, pBytesTransferred, 0 <br />     ; If the function succeeds, the return value is TRUE.<br />     .if &#40; eax == 0 &#41;<br />         mov ErrorFlag, TRUE<br />      .endif<br />.ENDIF <br />@@&#58;<br />;The callback function returns zero to indicate success<br />;  If no errors, EAX == FLASE &#40;0&#41; <br />;  If error       , EAX == TRUE &#40;1&#41;<br />mov eax, ErrorFlag<br />ret <br />EditStreamCallback endp</code></pre><br /><br />There was two things i noted in you callback:<br /><br />1) your return indicating the callback success was flawed.  XOR EAX,1  would return 1 if the Read File operations finished up properly.  This is because the last API (GlobalFree) would set eax == 0, and then it gets toggled to 1 before exiting ( indicating a false error ).   However, the else condition would work properly as a sucessful write will return TRUE and then get toggled to ZERO before exiting.<br /><br />I scrapped this system and suggest a simple flag system to return properly (as shown).<br /><br />2) The number of bytes being 'suggested' to the Unicode-&gt;Ascii may not be the correct amount.  There is no garentee that it will read all of what was asked for, and thus you should use the number of bytes you actually have.<br /><br />I made a simple fix here.<br /><br /><br />Last area of Caution.   Reading up on the way EM_STREAMIN sounds like it works.  The callback will be called continously untill an error occours (saying some unsuccess in the callback proceedure).  <br /><br />There is no &quot;real&quot; handling for this in the above example, as even an EOF will return a successful *read* repeatedly.   Its possible your callback will never stop getting called.  But i doubt this will actually happed.  This is because one of the conditions of stopping the callback loop is having the returned number of bytes read == 0.  This *should* happen on the second EOF read atempt (where EOF was detrmined in mid load of the previous run).  Since this has been properly set in the callback, it should exit when finished based on this value.<br /><br />Anywho, there is a surface analysis for you...<br />Hope it helps..<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-03-30 23:50:38 by NaN</div>
   </div>
   <div class="post" id="post-31812">
    <div class="subject"><a href="#post-31812">How to read Unicode text to richedit control?</a></div>
    <div class="body">Hi NaN:<br />    Today I look through the EM_STREAMIN message explained in the MSDN, and found new knowledge, maybe I am stupid, the richedit control can deal with Unicode, so a lot of code we discussed can omit, before I call EM_STREAMIN, I must check the file I wanna open whether include Unicode text, if include, the first two byte is *FFFE*(UCS2 little endian) or *FEFF*(UCS2 big endian), then set wParam of EM_STREAMIN thu including SF_UNICODE, other housekeeping chores will be done by richedit control .<br /><br />below is the snippet code:<br /><br /><pre><code>OpenFiles proc<br />	LOCAL editStream:EDITSTREAM<br />	LOCAL buffer:DWORD<br />	LOCAL BytesRead:DWORD<br />	LOCAL UniTest:DWORD<br />	invoke CreateFile,OFFSET PathNameBuff, GENERIC_READ , FILE_SHARE_READ ,\<br />                          NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL<br />	.IF eax == INVALID_HANDLE_VALUE<br />		dsText szCreateFile, &quot;CreateFile&quot;<br />		invoke HandleError, ADDR szCreateFile<br />		mov eax, FALSE<br />	.ELSE<br />		mov 	hFile, eax<br />		mov buffer, 0<br />		invoke ReadFile, hFile, addr buffer, 2, addr BytesRead, NULL<br />		<br />		mov UniTest, IS_TEXT_UNICODE_SIGNATURE or IS_TEXT_UNICODE_REVERSE_MASK<br />		invoke IsTextUnicode, addr buffer, 4, addr UniTest<br />		.if eax == 0<br />			invoke SetFilePointer, hFile, NULL, NULL, FILE_BEGIN<br />			mov ecx, SF_TEXT<br />		.else<br />			mov ecx, SF_TEXT or SF_UNICODE<br />		.endif		<br />		;<br />		; stream the text into the richedit control<br />		;			<br />		mov     editStream.dwCookie, Open<br />		mov     editStream.pfnCallback, OFFSET EditStreamCallback<br />		invoke 	SendMessage, hEdit, EM_STREAMIN, ecx, ADDR editStream<br />		<br />		invoke  CloseHandle, hFile<br />		invoke 	SendMessage, hEdit, EM_SETMODIFY, FALSE, 0<br />	.ENDIF<br />	ret<br />OpenFiles endp<br /><br />&#91;code&#93; EditStreamCallback proc IsOpen:DWORD, pBuffer:DWORD, NumBytes:DWORD, pBytesTransferred:DWORD<br />	LOCAL ErrorFlag :DWORD	<br />	mov ErrorFlag, FALSE	<br />	.IF IsOpen == TRUE <br />	     invoke ReadFile, hFile, pBuffer, NumBytes, pBytesTransferred, 0 <br />	     .if eax == 0<br />	         mov ErrorFlag, TRUE<br />	     .endif<br />	.ELSE <br />	     invoke WriteFile, hFile, pBuffer, NumBytes, pBytesTransferred, 0 <br />	     .if eax == 0<br />	         mov ErrorFlag, TRUE<br />	     .endif<br />	.ENDIF <br />	;The callback function returns zero to indicate success<br />	;  If no errors, EAX == FLASE (0) <br />	;  If error       , EAX == TRUE (1)<br />	mov eax, ErrorFlag<br />	ret	<br />EditStreamCallback endp&#91;/code&#93;<br /><br />     But I found a limitation to richedit control, it  can only deal with Unicode little endian, if the text file is Unicode big endian, it will do wrong thing, so U must do it urself, I don't konw how to do it.<br />     <br />     U r a warmhearted man, I greatly appreciate your timely help.<br /><br />dREAMtHEATER</div>
    <div class="meta">Posted on 2002-03-31 11:19:19 by dREAMtHEATER</div>
   </div>
   <div class="post" id="post-31818">
    <div class="subject"><a href="#post-31818">How to read Unicode text to richedit control?</a></div>
    <div class="body">Hey you figured it out, i just gave you a push :)<br /><br />Glad its now working...<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-03-31 12:37:20 by NaN</div>
   </div>
   <div class="post" id="post-31915">
    <div class="subject"><a href="#post-31915">the finial code for Unicode text</a></div>
    <div class="body">Hi NaN:<br />     now I resolved the bug when Unicode text that is detected as big endian but richedit control can not deal with it. I add code to EditStreamCallback  when program  readfile, if the Unicode text is <br />big endian format, I reverse every doublebye to the format of little endian, it will run happily.<br />     In the attachment, I post the text editor that code myself with richedit control,  hope u can take some time to test it, thanx.<br /><br /><pre><code>	.IF IsOpen == TRUE <br />	    invoke ReadFile, hFile, pBuffer, NumBytes, pBytesTransferred, 0 <br />		.if eax == 0<br />		 mov ErrorFlag, TRUE<br />		.endif<br />		mov eax, UniTest<br />		test eax, IS_TEXT_UNICODE_REVERSE_SIGNATURE<br />		.IF !ZERO?<br />			mov eax, NumBytes<br />			sar eax, 1<br />			mov ecx, pBuffer<br />			mov edi, eax<br />			@@&#58;<br />			mov dl, byte ptr &#91;ecx+01&#93;<br />			mov al, byte ptr &#91;ecx&#93;<br />			mov byte ptr &#91;ecx&#93;, dl<br />			mov byte ptr &#91;ecx+01&#93;, al<br />			add ecx, 00000002<br />			dec edi<br />			jne @B				<br />		.endif <br />	.ELSE <br />	    invoke WriteFile, hFile, pBuffer, NumBytes, pBytesTransferred, 0 <br />	    .if eax == 0<br />	         mov ErrorFlag, TRUE<br />	    .endif<br />	.ENDIF <br />	;The callback function returns zero to indicate success<br />	;  If no errors, EAX == FLASE &#40;0&#41; <br />	;  If error       , EAX == TRUE &#40;1&#41;<br />	mov eax, ErrorFlag<br />	ret	<br />EditStreamCallback endp</code></pre> <br /><br />dREAMtHEATER</div>
    <div class="meta">Posted on 2002-04-01 00:08:16 by dREAMtHEATER</div>
   </div>
   <div class="post" id="post-31942">
    <div class="subject"><a href="#post-31942">How to read Unicode text to richedit control?</a></div>
    <div class="body">Im a bit lost... Did you get it all figured out?  Cause when i try and load an asm file i get a stream of oriental symbols on one line?? :confused: <br /><br />:NaN:</div>
    <div class="meta">Posted on 2002-04-01 03:37:07 by NaN</div>
   </div>
   <div class="post" id="post-31977">
    <div class="subject"><a href="#post-31977">How to read Unicode text to richedit control?</a></div>
    <div class="body">Hi NaN<br />    U must set wordwarp on thu checking menu--&gt;edit--&gt;wordwarp.<br />    Thanx for ur testing, I hope u give me a deep test.<br /><br />dREAMtHEATER<br /><br /><div class="quote"><br />Im a bit lost... Did you get it all figured out?  Cause when i try and load an asm file i get a stream of oriental symbols on one line?? :confused: <br /><br />:NaN: </div></div>
    <div class="meta">Posted on 2002-04-01 09:38:39 by dREAMtHEATER</div>
   </div>
   <div class="post" id="post-32010">
    <div class="subject"><a href="#post-32010">How to read Unicode text to richedit control?</a></div>
    <div class="body">I think your missing the point here... New Times Roman looks like this:</div>
    <div class="meta">Posted on 2002-04-01 13:14:06 by NaN</div>
   </div>
   <div class="post" id="post-32041">
    <div class="subject"><a href="#post-32041">How to read Unicode text to richedit control?</a></div>
    <div class="body">Maybe the program only works with Unicode files (16-bit characters). Your normal ASM file is ANSI/ASCII, not Unicode.</div>
    <div class="meta">Posted on 2002-04-01 16:50:13 by tenkey</div>
   </div>
   <div class="post" id="post-32086">
    <div class="subject"><a href="#post-32086">How to read Unicode text to richedit control?</a></div>
    <div class="body">Hi NaN:<br />     Can u send me or attach the file that generate error in my Minipad? So I can figure it out.  and can u tell me the language version of ur  Windows? Thanx!<br /><br />dREAMtHEATER<br /><br /><div class="quote"><br />I think your missing the point here... New Times Roman looks like this: </div></div>
    <div class="meta">Posted on 2002-04-02 00:36:11 by dREAMtHEATER</div>
   </div>
   <div class="post" id="post-32087">
    <div class="subject"><a href="#post-32087">How to read Unicode text to richedit control?</a></div>
    <div class="body">The file is in the title line of the picture and is part of the masm package produced by hutch (i assume you already have it). <br /><br />My language is U.S. English, on Win98 SE.<br /><br />Hope it helps.<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2002-04-02 00:57:38 by NaN</div>
   </div>
   <div class="post" id="post-32089">
    <div class="subject"><a href="#post-32089">How to read Unicode text to richedit control?</a></div>
    <div class="body">Hi NaN:<br />     MASM in my hand is v7.0, u'd better exactly tell me which file in this tool kit, Thanx!<br /><br />dREAMtHEATER<br /> <br /><div class="quote"><br />The file is in the title line of the picture and is part of the masm package produced by hutch (i assume you already have it). <br /><br />My language is U.S. English, on Win98 SE.<br /><br />Hope it helps.<br />:alright:<br />NaN </div></div>
    <div class="meta">Posted on 2002-04-02 01:03:05 by dREAMtHEATER</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=4499&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=4499&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="4499" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=4499&amp;page=2">&gt;</a><a href="../?id=4499&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>