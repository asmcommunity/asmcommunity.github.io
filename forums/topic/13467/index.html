<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>measuring execution time for protection reasons - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=13467" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=13467">measuring execution time for protection reasons</a></p>
   <div class="post" id="post-104369">
    <div class="subject"><a href="#post-104369">measuring execution time for protection reasons</a></div>
    <div class="body">Hi,<br />I recently got interested in software protection and I have one question<br />we know that when cra*ker wants to deprotect program it uses debugger such is softice, it sets breakpoints<br />and steps through the code instruction by instruction. Now is it somehow possible<br />to measure time between two instructions, and if that time is bigger than say 0.01 second then <br />we know that someone is debugging program and do somthing appropriate (err.. like crash system :grin: )<br />What are your thoughts about this</div>
    <div class="meta">Posted on 2003-05-22 19:27:17 by Mikky</div>
   </div>
   <div class="post" id="post-104371">
    <div class="subject"><a href="#post-104371">measuring execution time for protection reasons</a></div>
    <div class="body">measuring the time needed to execute a piece of code is a bad idea, especially in multi-tasking environments, or when running your program on different processors ;)<br />you could try to use the RDTSC opcode, though. this method could also cause some false alarms if not implemented properly.</div>
    <div class="meta">Posted on 2003-05-22 19:40:49 by Tola</div>
   </div>
   <div class="post" id="post-104382">
    <div class="subject"><a href="#post-104382">measuring execution time for protection reasons</a></div>
    <div class="body">In my opinion, a half-decent hacker will spot rapidly the presence of a timer and circumvent the whole thing by running the timed code at normal speed and then continue his hacking.<br /><br />Good hackers can probably break any software protection you could ever think of.<br /><br />Raymond</div>
    <div class="meta">Posted on 2003-05-22 22:15:26 by Raymond</div>
   </div>
   <div class="post" id="post-104384">
    <div class="subject"><a href="#post-104384">measuring execution time for protection reasons</a></div>
    <div class="body">If you were to do something inappropriate like a deliberate system crash would you be prepared as well to pay out the lawsuits for lost data? Ofcourse in a multitasking environment yours is not the only software running and there will be data lost. If you deliberately initiated a sequence that would guarantee that data would be lost you are liable for that lost data and the cost to replace or recover it.</div>
    <div class="meta">Posted on 2003-05-22 22:26:17 by donkey</div>
   </div>
   <div class="post" id="post-104387">
    <div class="subject"><a href="#post-104387">measuring execution time for protection reasons</a></div>
    <div class="body">Donkey, who cares about lost data? If someone is trying to crack the program it is already illegal and how do you supose someone to report the lost data, since he  already committed crime and will suffer also....<br />The guy is just trying to find some way to protect his software, however I agree that the system crash would be inapropriate and evil solution.</div>
    <div class="meta">Posted on 2003-05-22 22:43:05 by masnick[CCCP]</div>
   </div>
   <div class="post" id="post-104388">
    <div class="subject"><a href="#post-104388">measuring execution time for protection reasons</a></div>
    <div class="body">A better way is to put your program in a mode where it half-works when the protection is removed, so that some features work, but for the really important stuff gives some error that implies that the installation process was not done properly, like put some kind of 'Cannot find foobar.dll' message.<br /><br />Like if it's a game, let him go halfway through a multi-player game or campaign, then suddenly abort with a 'Cannot find foobar.dll' message, that'll suck real bad for him...<br /><br />That way, the hacker thinks he has finished cracking, then starts going around in circles looking for foobar.dll somewhere in the installation disk.</div>
    <div class="meta">Posted on 2003-05-22 22:53:15 by AmkG</div>
   </div>
   <div class="post" id="post-104389">
    <div class="subject"><a href="#post-104389">measuring execution time for protection reasons</a></div>
    <div class="body">Your idea is just another little gimick that a cracker will easily find a way around.</div>
    <div class="meta">Posted on 2003-05-22 22:56:34 by comrade</div>
   </div>
   <div class="post" id="post-104393">
    <div class="subject"><a href="#post-104393">measuring execution time for protection reasons</a></div>
    <div class="body">Yes, IF he knows that that form of protection is there.  Keep it carefully, then it will spring in the middle of the campaign, most likely he will have sold copies of the thing already to pirates.  Then when the end-users use it, they won't be able to get further than that and hopefully won't buy anything from the same pirate/hacker again.<br /><br />Okay maybe it won't work as well for business software.<br /><br />And yeah it's been done before, so maybe it won't work anymore.</div>
    <div class="meta">Posted on 2003-05-22 23:03:18 by AmkG</div>
   </div>
   <div class="post" id="post-104395">
    <div class="subject"><a href="#post-104395">measuring execution time for protection reasons</a></div>
    <div class="body">develop your own exe protection. it would have to be in memory, not just on disk/file. and vxd, some thing system ring 0 to perhaps decode the instruction. it would have to be timed precice. an absolute PAIN to a cracker.</div>
    <div class="meta">Posted on 2003-05-22 23:14:51 by Qages</div>
   </div>
   <div class="post" id="post-104400">
    <div class="subject"><a href="#post-104400">measuring execution time for protection reasons</a></div>
    <div class="body"><div class="quote">&quot;]<br />Donkey, who cares about lost data? If someone is trying to crack the program it is already illegal and how do you supose someone to report the lost data, since he  already committed crime and will suffer also....<br />The guy is just trying to find some way to protect his software, however I agree that the system crash would be inapropriate and evil solution. </div><br />In alot of countries it is perfectly legal to dissasemble software. This route has been gone down before by other companies only to led to lawsuits. I am all in favour of software protection and anything to screw the pirates but I was just pointing out that there are reprecussions to crashing the machine. The law in most western countries would still hold him liable even if the crash was the result of tampering, after all it was the coder not the hacker who caused the crash.</div>
    <div class="meta">Posted on 2003-05-22 23:49:35 by donkey</div>
   </div>
   <div class="post" id="post-104413">
    <div class="subject"><a href="#post-104413">measuring execution time for protection reasons</a></div>
    <div class="body">Try detecting SoftIce and make it crash by (all esp or call ebp or jmp 0, basically just screwing the eip. Maybe you even want to change the eip to your data section.<br />And do not call the api direct try getting edi be the base and you add the offset to get different api(I have seen code like that).  All these add up to wading code in the dark. <br />And try avoiding cmp then jxx cause they can be easily patched. Instead try call eax (whereby you somehow make eax where you want to jump to). I have many ideas of protection scheme but seriously they just make the code more complicated and software still liable to being c**cked. You can try encryption too. It would be fun for the c**cker to jump to the correct place but find himself wading through encrypted code. :)</div>
    <div class="meta">Posted on 2003-05-23 01:51:10 by roticv</div>
   </div>
   <div class="post" id="post-104427">
    <div class="subject"><a href="#post-104427">measuring execution time for protection reasons</a></div>
    <div class="body">You'll give the cracker a lot of 'fun' with encrypted run-time conditionally compiled code. That's many words, but basically you compile or assemble some code at run-time, then execute it. If the cracker spots the code it has to modify, he still has to figure out how it was generated. It's like having Java bytecodes without knowing the encoding rules.<br /><br />Of course they're not dumb and they'll try to work around it. Instead of letting the code be generated, they'll just replace that directly with the code. Your way to detect this is check-summing. Place dozens of checks all around your code. And to make it even more 'fun', have a few run-time generated check-sums. :grin: And to make it all complete add some encryption to the code you're compiling...<br /><br />This is going to stop most crackers, but we're not done yet. If they remove all the check-sums, they can again start replacing run-time generated code with static code. What you can do to make this harder is to generate different code for every situation. That's the &quot;conditional&quot; part. For example, if you're writing code to create different styles of window, don't check the style flags in the generated code, but in the generator. So for every style of window you have it's own run-time generated function. Now they have to figure out how to add these conditions to the generated code. It's a lot harder than placing a few cmp/jmp's. Now do this in a few places and they'll quickly get discouraged.<br /><br />The possibilities are endless. Probably very interesting would be a run-time generated function that generates run-time generated code that generates run-time generated code that...</div>
    <div class="meta">Posted on 2003-05-23 03:10:33 by C0D1F1ED</div>
   </div>
   <div class="post" id="post-104428">
    <div class="subject"><a href="#post-104428">measuring execution time for protection reasons</a></div>
    <div class="body">On the subject:<br /><br />Why you all think timeout periods are by all means bad? If I set timeout period 100ms for code piece normally running for 100us (micro seconds), there is big probability that if timeout period elapses - there is something wrong with the program. and if I put some diferent checks again with timeout period, all will be OK. And to make things complex - we may use not system timers but TSC counter of the processor. AFAIK it's not forbidden in Windows.</div>
    <div class="meta">Posted on 2003-05-23 03:33:34 by JohnFound</div>
   </div>
   <div class="post" id="post-104432">
    <div class="subject"><a href="#post-104432">measuring execution time for protection reasons</a></div>
    <div class="body">instead of loosing time making a protection it is much wiser to spend time on implementing new features and/or optimizing the code.<br /><br />you must not forget their motto: &quot;if it works, we cand break it&quot;. all protections, IMHO, are useless for a good cracker that wants to remove the protection.<br /><br />remember the dongle protection, it was supposed to make the life harder or &quot;be unhackable&quot;. it can be removed in no time :)<br /><br />better make your program smaller/faster than spend time in a useless protection.<br /><br />my 0.02?</div>
    <div class="meta">Posted on 2003-05-23 04:08:45 by TBD</div>
   </div>
   <div class="post" id="post-104440">
    <div class="subject"><a href="#post-104440">measuring execution time for protection reasons</a></div>
    <div class="body">The protection is simple: code an app that people want to buy.<br /><br /><div class="quote">Why you all think timeout periods are by all means bad? If I set timeout period 100ms for code piece normally running for 100us (micro seconds), there is big probability that if timeout period elapses - there is something wrong with the program.</div>&lt;yawn&gt; Sounds good in theory, let's see you make it work for real. I will run your app, then i will start my AV software on deep scan, or i will start a compile of my .Net app, or i will start some other processor intensive activity, that will cause your timing check to fail every time. Did you forget that you were operating under a pre-emptive multi-tasking OS?? &lt;/yawn&gt;</div>
    <div class="meta">Posted on 2003-05-23 05:58:57 by sluggy</div>
   </div>
   <div class="post" id="post-104458">
    <div class="subject"><a href="#post-104458">measuring execution time for protection reasons</a></div>
    <div class="body">sluggy: your point is good, but I am not sure that starting few high-load programs will slow down say 20 instructions for about 100 times than I set.<br />Also when I said system crash, I dont really meant to implement that.<br /><br />I think that developers have advantage in race with crackers. Crackers need to figure out what was going on in our head if they want to break our protection. Weirder thoughts we have - harder job for them :)<br /><br />Main problem is to know where to protect. For example in a lot of &quot;protect  your software tutorials&quot; I saw that they are suggesting API IsDebuggerPresnet<br /><pre><code><br />invoke IsDebuggerPresnet<br />cmp eax,0<br />jne debuger_present                       ; &lt;--------- instruction to attack<br />jmp continue<br /><br />debuger_present&#58;<br /> ; process is debugged.... do somthing bad but not that bad as crashing system &#58;&#41;<br /><br />continue&#58;<br />; program codee<br /><br /></code></pre><br /><br />this is nice but there is no point in using it since cracker can always find cmp/test instructions and patch jmps after them.. Instead of IsDebuggerPresent can be the best uncrackable protection procedure in the world but it will fail since we are not protecting the right place in code - conditions</div>
    <div class="meta">Posted on 2003-05-23 07:37:00 by Mikky</div>
   </div>
   <div class="post" id="post-104466">
    <div class="subject"><a href="#post-104466">measuring execution time for protection reasons</a></div>
    <div class="body"><div class="quote">this is nice but there is no point in using it since cracker can always find cmp/test instructions and patch jmps after them.. Instead of IsDebuggerPresent can be the best uncrackable protection procedure in the world but it will fail since we are not protecting the right place in code - conditions<br /></div><br />Like I say, hide calls to the api. Do something like<br /><pre><code><br />call @F<br />@@&#58; <br />pop ebx ;ebx store theoffset<br />..<br />call &#91;ebx+offset&#93;; call Isdebuggerpresent<br />or eax,eax<br />cmovnz eax,ecx ; ecx = Isdebuggerpresent?<br />...<br />sub eax,ecx<br />jz @F<br />popad<br />popad<br />popad<br />ret ; crash code<br />@@&#58;<br />...<br /></code></pre><br />For this I think they need a debugger and not a disassembler to find the api.<br /><br />Try dumping anti-debug codes into some common routine. Encrypt the .code section. Decrypt it only if no presence of debugger. Anyway I still think the above code is weak. I will give it a thought and come back to you as soon as possible.</div>
    <div class="meta">Posted on 2003-05-23 08:20:18 by roticv</div>
   </div>
   <div class="post" id="post-104469">
    <div class="subject"><a href="#post-104469">measuring execution time for protection reasons</a></div>
    <div class="body"><div class="quote"><br />Yes, IF he knows that that form of protection is there.  Keep it carefully, then it will spring in the middle of the campaign, most likely he will have sold copies of the thing already to pirates.  Then when the end-users use it, they won't be able to get further than that and hopefully won't buy anything from the same pirate/hacker again.<br /><br />Okay maybe it won't work as well for business software.<br /><br />And yeah it's been done before, so maybe it won't work anymore. </div><br />You really have little clue about cracking-scene I see... People don't crack software to sell it dofus, they do it for the challenge and race with other groups. The instant someone encounters a secondary check in a crack you can bet your ass that a fix is out the same day.</div>
    <div class="meta">Posted on 2003-05-23 08:55:20 by SFP</div>
   </div>
   <div class="post" id="post-104472">
    <div class="subject"><a href="#post-104472">measuring execution time for protection reasons</a></div>
    <div class="body"><div class="quote"><br /><br />Like I say, hide calls to the api. Do something like<br /><pre><code><br />call @F<br />@@&#58; <br />pop ebx ;ebx store theoffset<br />..<br />call &#91;ebx+offset&#93;; call Isdebuggerpresent<br />or eax,eax<br />cmovnz eax,ecx ; ecx = Isdebuggerpresent?<br />...<br />sub eax,ecx<br />jz @F<br />popad<br />popad<br />popad<br />ret ; crash code<br />@@&#58;<br />...<br /></code></pre><br />For this I think they need a debugger and not a disassembler to find the api.<br /><br />Try dumping anti-debug codes into some common routine. Encrypt the .code section. Decrypt it only if no presence of debugger. Anyway I still think the above code is weak. I will give it a thought and come back to you as soon as possible. </div><br />Resolved by simple apihooking....?<br /><br />Whatever API you hook you can use an MS intrinsic called _ReturnAddress() which if you place it in ie lets say a hooked API call will give you the address where it returns AFTER the call to your hook so you will know exactly from where it was called and how and with what info.</div>
    <div class="meta">Posted on 2003-05-23 08:59:01 by SFP</div>
   </div>
   <div class="post" id="post-104965">
    <div class="subject"><a href="#post-104965">measuring execution time for protection reasons</a></div>
    <div class="body">Well you could always try<br /><pre><code><br />call delta<br />delta&#58;<br />pop ebx<br />...<br />call finddebugger<br /><br /><br />finddebugger&#58;<br />add ebx,offset;offset to Isdebuggerpresent<br />lea edi,callfunction<br />mov al,0ffh<br />stosb<br />mov al,0d3h<br />stosb<br />mov al,0C3h<br />stosb<br />callfunction&#58;<br />nop<br />nop<br />nop<br />popad<br />popad<br />popad<br />ret<br /></code></pre></div>
    <div class="meta">Posted on 2003-05-27 06:51:11 by roticv</div>
   </div>
  </div>
 </body>
</html>