<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Can you help me do better than this... - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=10069" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=10069">Can you help me do better than this...</a></p>
   <div class="post" id="post-75338">
    <div class="subject"><a href="#post-75338">Can you help me do better than this...</a></div>
    <div class="body">I was looking for string parsing code and extracted something from the board that I modified to suit my needs.  (what do you call this? a byte scanner?  I think so, because it checks every byte for what you want.)  Anyway, can anyone make this faster?  And if you do, tell me how you did it and what it is doing so I can learn from it?  I am not worried about size cause I am converting a VB program and no matter what I do, this code will still be smaller :)<br /><br />Here is what I have:<br />I have a file in which I save &quot;config&quot; info into.  each line holds a structure of MRUInfo:<br /><pre><code><br />MRUInfo    STRUCT<br />	DisplayName    BYTE    50 dup &#40;?&#41;<br />	MRUPath        BYTE    MAX_PATH dup &#40;?&#41;<br />	ParseType      BYTE    4 dup &#40;?&#41;<br />	SectionName    BYTE    20 dup &#40;?&#41;<br />	ValueName      BYTE    20 dup &#40;?&#41;<br />	ValueBase      BYTE    5 dup &#40;?&#41; <br />	Count          BYTE    20 dup &#40;?&#41;<br />	DataType       BYTE    4 dup &#40;?&#41;<br />	ExeName        BYTE    20 dup &#40;?&#41;<br />MRUInfo    ends<br /></code></pre><br /><br />each line looks like:<br />Wordpad?Microsoft\Windows\CurrentVersion\Applets\Wordpad\Recent File List?0???File?1??????<br />XML NotePad (Files)?Microsoft\XML Notepad\Recent File List?0???File?1??????<br />XML NotePad (URL)?Microsoft\XML Notepad\Recent URL List?2???URL?1??????<br />XMLWriter (Files)?Wattle Software\XMLwriter 1.0\Recent File List?0???File?1??????<br />XMLWriter (Projects)?Wattle Software\XMLwriter 1.0\Recent Project List?0???project?1??????<br /><br />the last line above is EOF so it has a NULL char at the end of it.<br /><br />I am using the following to parse this file into a listview, can we speed or shrink this?<br /><pre><code><br />LoadListView proc uses esi ebx edi DataFile&#58;DWORD<br />LOCAL   lvi         &#58;LVITEM<br />LOCAL   hFileBuf    &#58;DWORD<br />LOCAL   BytesRead   &#58;DWORD<br /><br />    push    0                           ; Open data file for reading<br />    push    FILE_ATTRIBUTE_NORMAL or\   ;<br />            FILE_FLAG_SEQUENTIAL_SCAN   ;<br />    push    OPEN_EXISTING               ;<br />    push    0                           ;<br />    push    0                           ;<br />    push    GENERIC_READ                ;<br />    push    DataFile                    ;<br />    call    CreateFile                  ;<br />    test    eax, eax                    ; do we have a handle?<br />    js      Finished                    ; nope<br />    <br />    mov    esi, eax                     ; Save handle<br />    <br />    push    0                           ; Get file size for buffer<br />    push    eax                         ; file handle<br />    call    GetFileSize                 ;<br />    inc     eax                         ;<br />    mov     ebx, eax                    ; save file size<br />    cmp     eax, 1                      ; is it an empty file?<br />    jne     GoodFile                    ; no, parse it<br />    <br />    push    esi                         ; empty file, close it<br />    call    CloseHandle                 ;<br />    jmp     Finished                    ; done here<br /><br />GoodFile&#58;       <br />                                        ; Allocate a temporary buffer for file<br />    push    ebx                         ; file size<br />    push    HEAP_ZERO_MEMORY            ;<br />    push    hHeap                       ;<br />    call    HeapAlloc                   ;<br />    mov     hFileBuf, eax               ; save pointer to allocated memory block<br />    <br />                                        ; Read whole file into buffer then close file<br />    invoke  ReadFile, esi, hFileBuf, ebx, addr BytesRead, NULL<br />    <br />    push    esi                         ; File handle<br />    call    CloseHandle                 ; Close it<br />    <br />    mov     ecx, 0                      ; LVITEM index<br />    mov     esi, hFileBuf<br />                                        <br />                                        ; Parse file in memory and add info to LVITEM<br />DisplayName&#58;<br />    push    ecx                         ; save our counter to current LVITEM<br />    <br />    push    sizeof MRUInfo              ; Allocate memory block for LVITEM info<br />    push    HEAP_ZERO_MEMORY            ;<br />    push    hHeap                       ;<br />    call    HeapAlloc                   ;<br />    mov     ebx, eax                    ; save pointer to memory block    <br />    lea     edi, &#91;ebx&#93;.MRUInfo.DisplayName <br />    <br />    pop     ecx                         ; restore our counter<br />@@&#58;<br />    mov     al, byte ptr &#91;esi&#93;<br />    inc     esi<br />    cmp     al, '?'<br />    je      MRUPath     <br />    mov     byte ptr &#91;edi&#93;, al<br />    inc     edi<br />    jmp     @B<br /><br />MRUPath&#58;<br />    lea     edi, &#91;ebx&#93;.MRUInfo.MRUPath<br />@@&#58;            <br />    mov     al, byte ptr &#91;esi&#93;<br />    inc     esi<br />    cmp     al, '?'<br />    je      ParseType<br />    mov     byte ptr &#91;edi&#93;, al<br />    inc     edi<br />    jmp     @B<br /><br />ParseType&#58;<br />    lea     edi, &#91;ebx&#93;.MRUInfo.ParseType<br />@@&#58;<br />    mov     al, byte ptr &#91;esi&#93;<br />    inc     esi<br />    cmp     al, '?'<br />    je      SectionName<br />    mov     byte ptr &#91;edi&#93;, al<br />    inc     edi<br />    jmp     @B<br />    <br />SectionName&#58;<br />    lea     edi, &#91;ebx&#93;.MRUInfo.SectionName<br />@@&#58;<br />    mov     al, byte ptr &#91;esi&#93;<br />    inc     esi<br />    cmp     al, '?'<br />    je      ValueName<br />    mov     byte ptr &#91;edi&#93;, al<br />    inc     edi<br />    jmp     @B<br /><br />ValueName&#58;<br />    lea     edi, &#91;ebx&#93;.MRUInfo.ValueName<br />@@&#58;<br />    mov     al, byte ptr &#91;esi&#93;<br />    inc     esi<br />    cmp     al, '?'<br />    je      ValueBase<br />    mov     byte ptr &#91;edi&#93;, al<br />    inc     edi<br />    jmp     @B<br /><br />ValueBase&#58;<br />    lea     edi, &#91;ebx&#93;.MRUInfo.ValueBase<br />@@&#58;<br />    mov     al, byte ptr &#91;esi&#93;<br />    inc     esi<br />    cmp     al, '?'<br />    je      Count<br />    mov     byte ptr &#91;edi&#93;, al<br />    inc     edi<br />    jmp     @B<br /><br />Count&#58;<br />    lea     edi, &#91;ebx&#93;.MRUInfo.Count<br />@@&#58;<br />    mov     al, byte ptr &#91;esi&#93;<br />    inc     esi<br />    cmp     al, '?'<br />    je      DataType<br />    mov     byte ptr &#91;edi&#93;, al<br />    inc     edi<br />    jmp     @B<br /><br />DataType&#58;<br />    lea     edi, &#91;ebx&#93;.MRUInfo.DataType<br />@@&#58;<br />    mov     al, byte ptr &#91;esi&#93;<br />    inc     esi<br />    cmp     al, '?'<br />    je      ExeName<br />    mov     byte ptr &#91;edi&#93;, al<br />    inc     edi<br />    jmp     @B<br /><br />ExeName&#58;<br />    lea     edi, &#91;ebx&#93;.MRUInfo.ExeName<br />@@&#58;<br />    mov     al, byte ptr &#91;esi&#93;<br />    inc     esi<br />    cmp     al, 0DH                     ; do we have a carrage return?<br />    je      NewLine                     ; yes, add to listview<br />    test    al, al                      ; do we have a null?<br />    jz      Done                        ; yes, we are at last line in file, add to listview and leave<br />    mov     byte ptr &#91;edi&#93;, al<br />    inc     edi<br />    jmp     @B<br />    <br />NewLine&#58;<br />    mov     lvi.imask, LVIF_PARAM or LVIF_TEXT<br />    mov     lvi.iItem, ecx<br />    mov     lvi.iSubItem, 0<br />    lea     eax, &#91;ebx&#93;.MRUInfo.DisplayName<br />    mov     lvi.pszText, eax<br />    mov     lvi.lParam, ebx<br />    <br />    push    ecx<br />    invoke  SendMessage, hListView2, LVM_INSERTITEM, 0, addr lvi<br />    pop     ecx<br />    inc     ecx<br />    inc     esi<br />    jmp     DisplayName<br />    <br />Done&#58;      <br />    mov     lvi.imask, LVIF_PARAM or LVIF_TEXT<br />    mov     lvi.iItem, ecx<br />    mov     lvi.iSubItem, 0<br />    lea     eax, &#91;ebx&#93;.MRUInfo.DisplayName<br />    mov     lvi.pszText, eax<br />    mov     lvi.lParam, ebx  <br />    invoke  SendMessage, hListView2, LVM_INSERTITEM, 0, addr lvi<br />    <br />    push    hFileBuf                    ; free memory block of file buffer<br />    push    0                           ;<br />    push    hHeap                       ;<br />    call    HeapFree                    ;<br /><br />    push    LVSCW_AUTOSIZE              ; Autosize listview headers<br />    push    0                           ;<br />    push    LVM_SETCOLUMNWIDTH          ;<br />    push    hListView2                  ;<br />    call    SendMessage                 ;<br />    <br />Finished&#58;<br />   ret<br />LoadListView endp<br /></code></pre><br /><br />Please explain any changes so I am learn from it! :grin:</div>
    <div class="meta">Posted on 2003-01-09 18:15:27 by Gunner</div>
   </div>
   <div class="post" id="post-75447">
    <div class="subject"><a href="#post-75447">Can you help me do better than this...</a></div>
    <div class="body">So you want some optimization? well im defintly not the best optimizer<br />around(esp. since i still consider myself a newbie). Anyhow, I have tried my <br />best to optimize it. I removed alot of redundant code and tried to make<br />it faster. Im not shure its faster? but atleast it's smaller. I hope someone<br />will tell me if the optimizations I tried to implement were wrong or?<br /><br />I have tried my best to optimize and make comments. So chew on it and<br />lettme know if its faster/slower/buggy etc.(all the good things) ( ;) )<br /><br />I might have forgotten to comment on somethings. Maybe even made<br />bad comments. ( :tongue: ) Just ask me when youre confuzed ok? :alright:<br /><pre><code>&#91;color=sienna&#93;...<br />...    <br />    call    GetFileSize<br />;    inc     eax		;any specific reason for increasing it?<br />;    mov     ebx, eax	;moved to &quot;GoodFile&#58;&quot; only needed when file is not empty<br />;    cmp     eax, 1		;this is slightly bigger then TEST<br />    test 	eax,eax		                ; is it an empty file?<br />    jne     GoodFile                    ; no, parse it<br />    <br />    push    esi                         ; empty file, close it<br />    call    CloseHandle                 ;<br />    jmp     Finished                    ; done here<br /><br />GoodFile&#58;                               ; Allocate a temporary buffer for file<br />    mov     ebx, eax                    ; save file size&#40;&lt;--HERE&#41;<br />    push    ebx                         ; file size<br />    push    HEAP_ZERO_MEMORY            ;<br />    push    hHeap                       ;<br />    call    HeapAlloc                   ;<br />    mov     hFileBuf, eax               ; save pointer to allocated memory block<br />                                        ; Read whole file into buffer then close file<br />    invoke  ReadFile, esi, hFileBuf, ebx, addr BytesRead, NULL<br />    push    esi                         ; File handle<br />    call    CloseHandle                 ; Close it<br /><br />;    mov     ecx, 0                      ; LVITEM index    <br />	xor 	ecx,ecx	                    ; smaller/faster&#40;+/-&#41;<br />    mov     esi, hFileBuf<br /><br />;I don think that the structure gets changed while looping.<br />;so instead of defining it each time you loop, we define it<br />;once here instead.<br />    mov     lvi.imask, LVIF_PARAM or LVIF_TEXT<br />    mov     lvi.iSubItem, ecx			;ECX = 0 saves a few bytes<br /><br />DisplayName&#58;							; Parse file in memory and add info to LVITEM<br />    push    ecx                         ; save our counter to current LVITEM<br /> <br />    push    sizeof MRUInfo              ; Allocate memory block for LVITEM info<br />    push    HEAP_ZERO_MEMORY            ;<br />    push    hHeap                       ;<br />    call    HeapAlloc                   ;<br /><br />    pop     ecx                         ; restore our counter<br />    mov     ebx, eax                    ; save pointer to memory block    <br /><br />;What is this little toy? this is just something I <br />;cooked up. Dont know if its the best solution, <br />;but it saves alot of code. This is a compare table<br />;&#40;if we need to name it&#41;. We save all of the pointers <br />;on stack! so that we can use them later when we parse the<br />;lines from the file. The &quot;-1&quot; is used to determine when we <br />;have reached the end of the table.<br />    lea  edi, &#91;ebx&#93;.MRUInfo.ExeName<br />	push edi<br />	push -1<br /> 	sub edi,4h ;lea  edi, &#91;ebx&#93;.MRUInfo.DataType<br /> 	push edi<br /> 	sub edi,14h ;lea     edi, &#91;ebx&#93;.MRUInfo.Count<br /> 	push edi<br /> 	sub edi,5h  ;lea     edi, &#91;ebx&#93;.MRUInfo.ValueBase<br /> 	push edi<br /> 	sub edi,14h ;lea     edi, &#91;ebx&#93;.MRUInfo.ValueName<br /> 	push edi<br /> 	sub edi,14h ;lea     edi, &#91;ebx&#93;.MRUInfo.SectionName<br /> 	push edi<br /> 	sub edi,4h  ;lea     edi, &#91;ebx&#93;.MRUInfo.ParseType<br /> 	push edi<br /> 	sub edi,104h;lea     edi, &#91;ebx&#93;.MRUInfo.MRUPath<br /> 	push edi<br />  	sub edi,32h ;lea 	 edi, &#91;ebx&#93;.MRUInfo.DisplayName<br />  	push edi<br /> <br />  _&#58;pop edi		;restore pointer<br />  	inc edi		;check for -1<br />	je ExeName	;end of table<br />	dec edi		;restore edi<br /> @@&#58;lodsb		;lodsb is smaller/faster then mov/inc esi<br />    cmp al, '?'<br />    je short _<br />    stosb		;stosb is smaller/faster then mov/inc edi<br />    jmp short @B<br /><br />ExeName&#58;<br />	pop edi<br />@@&#58; lodsb<br />    cmp 	al, 0dh                     ; do we have a carrage return?<br />    je 		NewLine                     ; yes, add to listview<br />    test 	al, al                      ; do we have a null?<br />    jz 		NewLine                     ; yes, we are at last line in file, add to listview and leave<br />	stosb<br />    jmp 	short @B<br />    <br />NewLine&#58;<br />	push    eax<br />    lea     eax, &#91;ebx&#93;.MRUInfo.DisplayName<br />    mov     lvi.pszText, eax<br />    mov     lvi.iItem, ecx<br />    mov     lvi.lParam, ebx<br />    <br />    push    ecx<br />    invoke  SendMessage, hListView2, LVM_INSERTITEM, 0, addr lvi<br />    pop     ecx<br />    pop 	eax<br />    inc     ecx<br />    inc     esi<br />    test 	al,al<br />    jne     short DisplayName<br />    <br />Done&#58;      <br />    push    hFileBuf                    ; free memory block of file buffer<br />    push    0                           ;<br />    push    hHeap                       ;<br />    call    HeapFree                    ;<br />...<br />...&#91;/color&#93;</code></pre></div>
    <div class="meta">Posted on 2003-01-10 08:36:36 by natas</div>
   </div>
   <div class="post" id="post-75517">
    <div class="subject"><a href="#post-75517">Can you help me do better than this...</a></div>
    <div class="body">Hmmm, thanks natas....  I will look this over and try this out.<br />Thanks!</div>
    <div class="meta">Posted on 2003-01-10 16:51:08 by Gunner</div>
   </div>
   <div class="post" id="post-75592">
    <div class="subject"><a href="#post-75592">Can you help me do better than this...</a></div>
    <div class="body">Since I got bored with my current project. I decided to really go through <br />the code. I removed some unneded code and did some rethinkinking here <br />and there( ;) ). <br /><br />I tested this code with the original code and the results was pretty<br />much the same. However, this is much smaller in code size. You wont <br />see alot of comments from me in this source tho. I usually dont comment <br />that much. Especially since I changed alot it wouldnt do any good using<br />comments anyway. <br /><br />But just point out the code you dont understand and ill try my best to<br />explain. :alright:<br /><pre><code>&#91;color=sienna&#93;LoadListView proc uses esi ebx edi DataFile&#58;DWORD<br />LOCAL   lvi         &#58;LVITEM<br />LOCAL   hFileBuf    &#58;DWORD<br />LOCAL   BytesRead   &#58;DWORD<br />&#91;color=green&#93;;The register ebx is preserved all the way. So its much better<br />;to use it for our counting purposes. EQU's are  just good for readability.&#91;/color&#93;<br />    xor 	ebx,ebx	                    ; LVITEM index    <br />    ZERO$   equ ebx<br />	<br />    push    ZERO$                       ; Open data file for reading<br />    push    FILE_ATTRIBUTE_NORMAL or\   ;<br />                FILE_FLAG_SEQUENTIAL_SCAN<br />    push    OPEN_EXISTING               ;<br />    push    ZERO$                       ;<br />    push    ZERO$                       ;<br />    push    GENERIC_READ                ;<br />    push    DataFile                    ;<br />    call    CreateFile                  ;<br />    test    eax, eax                    ; do we have a handle?<br />    js      Finished                    ; nope<br />    <br />    mov    esi, eax                     ; Save handle<br />    <br />    push    ZERO$                       ; Get file size for buffer<br />    push    eax                         ; file handle<br />    call    GetFileSize                 ;<br />    test 	eax,eax		                ; is it an empty file?<br />    jne     GoodFile                    ; no, parse it<br />    <br />    push    esi                         ; empty file, close it<br />    call    CloseHandle                 ;<br />    jmp     Finished                    ; done here<br /><br />GoodFile&#58;                               ; Allocate a temporary buffer for file<br />    mov     edi, eax                    ; save file size&#40;&lt;--HERE&#41;<br />    push    edi                         ; file size<br />    push    HEAP_ZERO_MEMORY            ;<br />    push    hHeap                       ;<br />    call    HeapAlloc                   ;<br />    mov     hFileBuf, eax               ; save pointer to allocated memory block<br />                                        ; Read whole file into buffer then close file<br />    invoke  ReadFile, esi, hFileBuf, edi, addr BytesRead, NULL<br />    push    esi                         ; File handle<br />    call    CloseHandle                 ; Close it<br /><br />    mov     esi, hFileBuf<br /><br />    mov     lvi.imask, LVIF_PARAM or LVIF_TEXT<br />    mov     lvi.iSubItem, ZERO$<br /><br />DisplayName&#58;							<br />    CMPTABLE$ equ edx<br />    LVINDEX$ equ ebx<br />    MEMBUF$  equ ecx<br />    FILEBUF$ equ esi<br />										; Parse file in memory and add info to LVITEM<br />    push    sizeof MRUInfo              ; Allocate memory block for LVITEM info<br />    push    HEAP_ZERO_MEMORY            ;<br />    push    hHeap                       ;<br />    call    HeapAlloc                   ;<br />    mov     MEMBUF$, eax                ; save pointer to memory block    <br /><br />;&#91;color=green&#93;This is just a little comparison table. Maybe you think I made some<br />;calculations because of the numbers? There was no calculation whatsoever.<br />;These values are taken from the structure were dealing with.<br />;DisplayName BYTE 50 = 32h<br />;MRUPath     BYTE MAX_PATH = 104h<br />;ParseType   BYTE 4 =4h<br />;SectionName BYTE 20 =14h<br />;ValueName   BYTE 20 = 14h<br />;ValueBase   BYTE 5 =5h<br />;Count       BYTE 20 =14h<br />;DataType    BYTE 4 = 4h<br />;ExeName     BYTE 20 =14h<br />;This table is used to increase the pointer starting from &quot;DisplayName&quot;.<br />;So that we fill each item in the structure correct. When you define a variable<br />;and call a label like below. The variable gets pushed onto the stack.<br />;Thats why we pop it in EDX right after.&#91;/color&#93;<br />    call _cmp_table<br />    dd 0,32h,104h,4h,14h,14h,5h,14h,-1<br />    _cmp_table&#58;pop edx<br /><br />    lea  edi, &#91;MEMBUF$&#93;.MRUInfo.DisplayName<br />    push MEMBUF$<br /><br />;&#91;color=green&#93; This is the place we get our values from CS&#58;&#91;CMPTABLE$&#93;.<br />;We are checking for -1 wich defines the end of the variable above.<br />;The ADD CMPTABLE$,4 increases the table by 4&#40;DWORD&#41;. The other<br />;stuff should be pretty basic. If you wonder why I dont use stosb, its<br />;because I cant increase the EDI! otherwise the table wont work.&#91;/color&#93;<br />  _&#58;cmp dword ptr cs&#58;&#91;CMPTABLE$&#93;,-1<br />    je ExeName<br />    add edi,cs&#58;&#91;CMPTABLE$&#93;<br />     add CMPTABLE$,4<br />     xor ecx,ecx<br />@@&#58; lodsb<br />    cmp al,'?'<br />    je short _<br />    mov byte ptr &#91;edi+ecx&#93;, al<br />    inc ecx<br />    jmp short @B<br />    <br />ExeName&#58;<br />    pop ecx<br />    add edi,4h		; MRUInfo.ExeName<br />@@&#58; lodsb<br />    cmp 	al, 0Dh                     ; do we have a carrage return?<br />    je 		NewLine                     ; yes, add to listview<br />    test 	al, al                      ; do we have a null?<br />    jz 		NewLine                     ; yes, we are at last line in file, add to listview and leave<br />    stosb<br />    jmp 	short @B<br />    <br />NewLine&#58;<br />    lea     edx, &#91;MEMBUF$&#93;.MRUInfo.DisplayName<br />    mov     lvi.pszText, edx<br />    mov     lvi.iItem, LVINDEX$ <br />    mov     lvi.lParam, MEMBUF$<br />    push    eax<br />    invoke  SendMessage, hListView2, LVM_INSERTITEM, 0, addr lvi<br />    pop 	eax<br />    inc     LVINDEX$ <br />    inc     FILEBUF$<br />    test 	al,al<br />    jne     DisplayName<br />    <br />Done&#58;      <br />    push    hFileBuf                    ; free memory block of file buffer<br />    push    0                           ;<br />    push    hHeap                       ;<br />    call    HeapFree                    ;<br /><br />    push    LVSCW_AUTOSIZE              ; Autosize listview headers<br />    push    0                           ;<br />    push    LVM_SETCOLUMNWIDTH          ;<br />    push    hListView2                  ;<br />    call    SendMessage                 ;<br />    <br />Finished&#58;<br />   ret<br />LoadListView endp&#91;/color&#93;</code></pre><br /><br /><strong>EDIT:</strong> Added some comments! Is there still something you dont <br />understand? Then dont hesitate to pop the question! :alright:</div>
    <div class="meta">Posted on 2003-01-11 00:53:35 by natas</div>
   </div>
  </div>
 </body>
</html>