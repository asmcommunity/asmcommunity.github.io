<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Increment counter using aaa - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=12926" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=12926">Increment counter using aaa</a></p>
   <div class="post" id="post-100419">
    <div class="subject"><a href="#post-100419">Increment counter using aaa</a></div>
    <div class="body">Here is a program to increment a 10 byte counter using aaa. Sorry it is in HLA, but I hope it can be easily converted.<br /><br />The heart of the routine is the loop at a_id. Can anyone make an MMX optimization for that loop?<br /><br />The program counts to 100 million. Because I am using aaa, and stepping backwards with ecx until there is no carry in the addition, after the loop, the value of ecx says how far I stepped back:<br /><br />Initial value 9,<br />If ecx=8, then no carry to 2nd least significant digit<br />If ecx=7, then carry to 2nd least<br />If ecx=6, then carry to 3rd least<br />If ecx=2, then carry to 7rd least; ie to the millions digit...<br />This is used to only print the entire number in counts of millions...<br /><br /><br /><pre><code><br />// Increment Check Program<br />// Increments a 10 byte unpacked BCD counter using aaa<br /><br /><br />program IncCheck;<br />#include&#40; &quot;stdlib.hhf&quot; &#41;;<br /><br />static &#40;4&#41;<br />     numdig&#58;  tbyte;<br />     t&#58;time.timerec;<br /><br /><br />begin IncCheck;<br /><br />     console.cls&#40;&#41;;<br />     console.gotoxy&#40;4, 15&#41;;<br />     stdout.put &#40; &quot;Increment Check program.&quot;, nl nl&#41;;<br /><br />// increment numdig &#40;BCD&#41;<br /><br />incr_dig&#58;<br />          mov &#40;&amp;numdig,ebx&#41;;<br />          mov &#40;9, ecx&#41;;<br />          stc;<br />a_id&#58;<br />          mov &#40;&#91;ebx+ecx&#93;, al&#41;;<br />          adc &#40;0, al&#41;;<br />          aaa;<br />          mov &#40;al, &#91;ebx+ecx&#93;&#41;;<br />          dec &#40;ecx&#41;;<br />          js check;<br />          jc a_id;<br /><br />check&#58;<br />          // cmp &#40;ecx,0&#41;;<br />                    //use -1 to count 10 times as much<br />          je finisht;<br /><br />          cmp &#40;ecx,2&#41;;<br />          ja  incr_dig;<br /><br />          stdout.put &#40; &quot;Done &quot;&#41;;<br />          xor &#40;ecx,ecx&#41;;<br /><br />llll&#58;<br />          mov &#40;&amp;numdig,ebx&#41;;<br />          mov &#40;&#91;ebx+ecx&#93;, al&#41;;<br />          stdout.putu8&#40;al&#41;;<br />          inc &#40;ecx&#41;;<br />          cmp &#40;ecx,9&#41;;<br />          jbe llll;<br /><br />          stdout.put &#40; &quot; increments so far&quot;, nl &#41;;<br />          <br />          jmp incr_dig;<br /><br />finisht&#58;<br />          stdout.put &#40; nl, &quot;Finished performing &quot;&#41;;<br />          xor &#40;ecx,ecx&#41;;<br /><br />llm&#58;<br />          mov &#40;&amp;numdig,ebx&#41;;<br />          mov &#40;&#91;ebx+ecx&#93;, al&#41;;<br />          stdout.putu8&#40;al&#41;;<br />          inc &#40;ecx&#41;;<br />          cmp &#40;ecx,9&#41;;<br />          jbe llm;<br /><br />          stdout.put &#40; &quot; increments.&quot;, nl &#41;;<br /><br />end IncCheck;<br /></code></pre></div>
    <div class="meta">Posted on 2003-04-30 21:26:07 by V Coder</div>
   </div>
   <div class="post" id="post-100421">
    <div class="subject"><a href="#post-100421">Increment counter using aaa</a></div>
    <div class="body">Here is another version (sorry, HLA again) which simply increments a 32 bit value at incr_dig.<br /><br />Question: How to check if you have reached x million? Divide the 32 bit number by 1000000, and check for remainder. If zero, then print counter...<br /><br /><pre><code><br />// Increment Check Program<br />// <br /><br /><br />program IncCheck;<br />#include&#40; &quot;stdlib.hhf&quot; &#41;;<br /><br />static &#40;4&#41;<br />     numdig&#58;  int32;<br />     t&#58;time.timerec;<br /><br /><br />begin IncCheck;<br /><br />     console.cls&#40;&#41;;<br />     console.gotoxy&#40;4, 15&#41;;<br />     stdout.put &#40; &quot;Increment Check program.&quot;, nl nl&#41;;<br /><br />incr_dig&#58;<br />          inc &#40;numdig&#41;;<br /><br />check&#58;<br />          mov &#40;numdig, eax&#41;;<br />          cmp &#40;eax, 100_000_000&#41;;<br />          je finisht;<br /><br />          xor &#40;edx, edx&#41;;<br />          div &#40;1000000, edx&#58;eax&#41;;<br />          cmp &#40;edx, 0&#41;;<br />          jne incr_dig;<br /><br />          stdout.put &#40; &quot;Done &quot;, numdig, &quot; increments so far&quot;, nl &#41;;<br />          <br />          jmp incr_dig;<br /><br />finisht&#58;<br />          stdout.put &#40; nl, &quot;Finished performing &quot;, numdig, &quot; increments.&quot;, nl &#41;;<br /><br />end IncCheck;<br /></code></pre></div>
    <div class="meta">Posted on 2003-04-30 21:31:13 by V Coder</div>
   </div>
   <div class="post" id="post-100424">
    <div class="subject"><a href="#post-100424">Increment counter using aaa</a></div>
    <div class="body">Well, since 64 bit division using EDX:EAX is so slow, is there another way to check whether you have reached x million?<br /><br />Yes. Check for first million. When you reach 1 million, print it, and add 1 million to the check figure, so that next comparison will be 2 million. And so on. Termination, as with the previous example is at 100 million.<br /><br />A 32 bit number can hold up to over 4 billion. That's plenty counting!!!!<br /><br /><pre><code><br />// Increment Check Program<br />// <br /><br /><br />program IncCheck;<br />#include&#40; &quot;stdlib.hhf&quot; &#41;;<br /><br />static &#40;4&#41;<br />     numdig&#58;  int32;<br />     nextn&#58; int32&#58;=1000000;<br />     addt&#58; int32&#58;=1000000;<br />     t&#58;time.timerec;<br /><br /><br />begin IncCheck;<br /><br />     console.cls&#40;&#41;;<br />     console.gotoxy&#40;4, 15&#41;;<br />     stdout.put &#40; &quot;Increment Check program.&quot;, nl nl&#41;;<br /><br />// increment numdig &#40;BCD&#41;<br /><br />incr_dig&#58;<br />          inc &#40;numdig&#41;;<br /><br />check&#58;<br />          mov &#40;numdig, eax&#41;;<br />          cmp &#40;eax, 100_000_000&#41;;<br />          je finisht;<br /><br />          cmp &#40;nextn, eax&#41;;<br />          jne incr_dig;<br />          add &#40;addt, eax&#41;;<br />          mov &#40;eax, nextn&#41;;<br />          stdout.put &#40; &quot;Done &quot;, numdig, &quot; increments so far&quot;, nl &#41;;<br />          <br />          jmp incr_dig;<br /><br />finisht&#58;<br />          stdout.put &#40; nl, &quot;Finished performing &quot;, numdig, &quot; increments.&quot;, nl &#41;;<br /><br />end IncCheck;<br /></code></pre></div>
    <div class="meta">Posted on 2003-04-30 21:36:22 by V Coder</div>
   </div>
   <div class="post" id="post-100426">
    <div class="subject"><a href="#post-100426">Increment counter using aaa</a></div>
    <div class="body">Here is a zip with the source and executable for all three routines.<br /><br />Execution times on a 166 MHz Pentium MMX are:<br /><br />countt {using aaa}, 11secs<br />countt2 {using inc and div}, 36 secs<br />countt3 {using inc &amp; add/comp}, 6 secs<br /><br /><strong>{edit}</strong><br /><br />I'd love to hear your times and comments.</div>
    <div class="meta">Posted on 2003-04-30 21:43:08 by V Coder</div>
   </div>
  </div>
 </body>
</html>