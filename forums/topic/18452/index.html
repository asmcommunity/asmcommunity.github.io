<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Emulating unsupported instructions - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=18452" />
    <link rel="next" href="../?id=18452&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=12">The Heap</a> &raquo; <a href="../?id=18452">Emulating unsupported instructions</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=18452&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=18452&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="18452" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=18452&amp;page=2">&gt;</a><a href="../?id=18452&amp;page=2">&raquo;</a></form>   <div class="post" id="post-142870">
    <div class="subject"><a href="#post-142870">Emulating unsupported instructions</a></div>
    <div class="body">I was wondering if it was possible to catch 'illegal instruction' exceptions, emulate the instruction, and return to normal program flow. :notsure: That way, I would be able to execute SSE1/2/3 on processors that don't support it.<br /><br />Any ideas? Thanks!</div>
    <div class="meta">Posted on 2004-06-04 14:27:44 by C0D1F1ED</div>
   </div>
   <div class="post" id="post-142874">
    <div class="subject"><a href="#post-142874">Emulating unsupported instructions</a></div>
    <div class="body"><a target="_blank" href="http://groups.google.com/groups?hl=en&amp;lr=&amp;ie=UTF-8&amp;threadm=Sj7aa.22689%24lW3.276961%40twister.tampabay.rr.com&amp;rnum=7&amp;prev=/groups%3Fq%3Dillegal%2Binstruction%2Bexception%2Bgroup:comp.lang.asm.x86%26hl%3Den%26lr%3D%26ie%3DUTF-8%26group%3Dcomp.lang.asm.x86%26selm%3DSj7aa.22689%2524lW3.276961%2540twister.tampabay.rr.com%26rnum%3D7">http://groups.google.com/groups?hl=en&amp;lr=&amp;ie=UTF-8&amp;threadm=Sj7aa.22689%24lW3.276961%40twister.tampabay.rr.com&amp;rnum=7&amp;prev=/groups%3Fq%3Dillegal%2Binstruction%2Bexception%2Bgroup:comp.lang.asm.x86%26hl%3Den%26lr%3D%26ie%3DUTF-8%26group%3Dcomp.lang.asm.x86%26selm%3DSj7aa.22689%2524lW3.276961%2540twister.tampabay.rr.com%26rnum%3D7</a></div>
    <div class="meta">Posted on 2004-06-04 16:28:24 by ThoughtCriminal</div>
   </div>
   <div class="post" id="post-142875">
    <div class="subject"><a href="#post-142875">Emulating unsupported instructions</a></div>
    <div class="body">...and it will be extremely slow :)</div>
    <div class="meta">Posted on 2004-06-04 17:55:02 by f0dder</div>
   </div>
   <div class="post" id="post-142876">
    <div class="subject"><a href="#post-142876">Emulating unsupported instructions</a></div>
    <div class="body"><div class="quote"><br />...and it will be extremely slow :) </div><br />haha, you telling me? I disabled my hardware FPU on Win98 on my P133, after that I quickly scrambled to turn it back on!</div>
    <div class="meta">Posted on 2004-06-04 18:06:59 by x86asm</div>
   </div>
   <div class="post" id="post-142877">
    <div class="subject"><a href="#post-142877">Emulating unsupported instructions</a></div>
    <div class="body">on a tangent, have you ever tried disabling your cache? a pentium-mmx-200 is suddenly unable to play MP3s... or pretty much do anything at all ;)</div>
    <div class="meta">Posted on 2004-06-04 18:10:40 by f0dder</div>
   </div>
   <div class="post" id="post-142878">
    <div class="subject"><a href="#post-142878">Emulating unsupported instructions</a></div>
    <div class="body"><div class="quote"><br />on a tangent, have you ever tried disabling your cache? a pentium-mmx-200 is suddenly unable to play MP3s... or pretty much do anything at all ;) </div><br />lol, ya I did that as well, I did it to make Zone66 playable on my 133( that mini 3D scene in the credits ran a lot slower too!), ah it was quite funny to watch your hi-end PC at the time become a useless piece of crap, ahh the good ol' days!</div>
    <div class="meta">Posted on 2004-06-04 18:12:05 by x86asm</div>
   </div>
   <div class="post" id="post-142890">
    <div class="subject"><a href="#post-142890">Emulating unsupported instructions</a></div>
    <div class="body"><div class="quote"><br /><a target="_blank" href="http://groups.google.com/groups?hl=en&amp;lr=&amp;ie=UTF-8&amp;threadm=Sj7aa.22689%24lW3.276961%40twister.tampabay.rr.com&amp;rnum=7&amp;prev=/groups%3Fq%3Dillegal%2Binstruction%2Bexception%2Bgroup:comp.lang.asm.x86%26hl%3Den%26lr%3D%26ie%3DUTF-8%26group%3Dcomp.lang.asm.x86%26selm%3DSj7aa.22689%2524lW3.276961%2540twister.tampabay.rr.com%26rnum%3D7">http://groups.google.com/groups?hl=en&amp;lr=&amp;ie=UTF-8&amp;threadm=Sj7aa.22689%24lW3.276961%40twister.tampabay.rr.com&amp;rnum=7&amp;prev=/groups%3Fq%3Dillegal%2Binstruction%2Bexception%2Bgroup:comp.lang.asm.x86%26hl%3Den%26lr%3D%26ie%3DUTF-8%26group%3Dcomp.lang.asm.x86%26selm%3DSj7aa.22689%2524lW3.276961%2540twister.tampabay.rr.com%26rnum%3D7</a> </div><br />Thanks! But...<br /><br />Do you have any technical information on how to do it? I mean, is it possible to write the exception handler in C++, or does it have to be an interrupt handler at ring0 level or something? When the exception is caught, how do I get a pointer to the invalid instruction?</div>
    <div class="meta">Posted on 2004-06-05 03:09:19 by C0D1F1ED</div>
   </div>
   <div class="post" id="post-142891">
    <div class="subject"><a href="#post-142891">Emulating unsupported instructions</a></div>
    <div class="body"><div class="quote"><br /><br />haha, you telling me? I disabled my hardware FPU on Win98 on my P133, after that I quickly scrambled to turn it back on! </div><br />In my case, I still assume the presence of an FPU. I've emulated SSE instructions using the FPU before. Actually it's an automatic feature of <a target="_blank" href="http://softwire.sourceforge.net">SoftWire</a>. It's slow, but still workable.<br /><br />The only reason I can see why it would be slow is because of the exception handling mechanism. But I don't care too much...</div>
    <div class="meta">Posted on 2004-06-05 03:13:46 by C0D1F1ED</div>
   </div>
   <div class="post" id="post-142893">
    <div class="subject"><a href="#post-142893">Emulating unsupported instructions</a></div>
    <div class="body">As far as I know, the Windows SEH should be able to handle it. So you cannot use C++'s try/catch, but you can use the __try/__except extensions in C/C++.<br />But yes, prepare to take a hit of many cycles (1000ish?) per instruction. You do NOT, I repeat NOT want to do this.<br />For high performance you want to recompile the code, which should be reasonably straightforward with Softwire.</div>
    <div class="meta">Posted on 2004-06-05 05:54:58 by Scali</div>
   </div>
   <div class="post" id="post-142894">
    <div class="subject"><a href="#post-142894">Emulating unsupported instructions</a></div>
    <div class="body">It should definitely be possible with SEH - dunno how to do this with the MSVC __try/__except extensions, but setting up a SEH frame in assembly is trivial.<br /><br />I guess it would be interesting to see what kind of speed you get... one thing is the emulation of the instructions themselves, that _could_ be reasonably acceptable I guess, but the overhead of exception handling should be pretty awful - at least if you don't implement some sort of dynamic code recompilation... x86-&gt;x86 JIT'ing, ick ;)</div>
    <div class="meta">Posted on 2004-06-05 06:09:16 by f0dder</div>
   </div>
   <div class="post" id="post-142897">
    <div class="subject"><a href="#post-142897">Emulating unsupported instructions</a></div>
    <div class="body"><div class="quote"><br />As far as I know, the Windows SEH should be able to handle it. So you cannot use C++'s try/catch, but you can use the __try/__except extensions in C/C++.<br />But yes, prepare to take a hit of many cycles (1000ish?) per instruction. You do NOT, I repeat NOT want to do this.<br />For high performance you want to recompile the code, which should be reasonably straightforward with Softwire. </div><br />Thanks for the information!<br /><br />High performance is not the priority now. It's compatibility, even with the oldest processors.</div>
    <div class="meta">Posted on 2004-06-05 06:40:05 by C0D1F1ED</div>
   </div>
   <div class="post" id="post-142898">
    <div class="subject"><a href="#post-142898">Emulating unsupported instructions</a></div>
    <div class="body">Obviously C/C++ is even more trivial than asm :)<br />It's documented well in MSDN.<br /><br />Here's my tip: Tell people who don't have SSE support to upgrade asap and don't care :P<br />SSE is at least 5 years old? About time they supported it :)<br />And why would you want to emulate SSE2 or SSE3?<br />SSE2 is more of an x87 emulator than the other way around. Write x87 code?<br />As for SSE3, it's not like there's a lot of support for that yet. Ignore it completely for the time being? :P</div>
    <div class="meta">Posted on 2004-06-05 06:41:22 by Scali</div>
   </div>
   <div class="post" id="post-142900">
    <div class="subject"><a href="#post-142900">Emulating unsupported instructions</a></div>
    <div class="body"><div class="quote"><br />- at least if you don't implement some sort of dynamic code recompilation... x86-&gt;x86 JIT'ing, ick ;) </div><br />That's a very cool idea!<br /><br />But how could I <em>insert</em> new code in a running executable? The shortest SSE instruction is three bytes or so, so I can't place anything useful in between. Unless... I also 'erase' some of the instructions that follow below it, and replace the SSE instruction plus these instructions with a call to a function that performs the same actions.<br /><br />Would that work or am I overlooking some nasty problems? Replacing jumps would be pretty hard I think...</div>
    <div class="meta">Posted on 2004-06-05 06:45:47 by C0D1F1ED</div>
   </div>
   <div class="post" id="post-142901">
    <div class="subject"><a href="#post-142901">Emulating unsupported instructions</a></div>
    <div class="body">Well, if it's for softwire, couldn't you make it output the x86/x87 code sequences to handle the SSE/2 instructions, rather than depending on #UD ?</div>
    <div class="meta">Posted on 2004-06-05 06:48:11 by f0dder</div>
   </div>
   <div class="post" id="post-142902">
    <div class="subject"><a href="#post-142902">Emulating unsupported instructions</a></div>
    <div class="body"><div class="quote">But how could I insert new code in a running executable?</div><br /><br />You should do it the way any JIT compiler does it... Work on a per-function basis. First you analyze the code so you know where every function starts and ends, and where each one is called.<br />Then when you get an exception, you figure out from the EIP value what function that must have been. Then you recompile the function as a whole, in a new part of memory, and update all references to that function in the code.</div>
    <div class="meta">Posted on 2004-06-05 06:56:24 by Scali</div>
   </div>
   <div class="post" id="post-142904">
    <div class="subject"><a href="#post-142904">Emulating unsupported instructions</a></div>
    <div class="body">You could combine a run-trace (ie, catching #UD and emulating, taking note of faulting addresses) with static code translation - something along the lines of z0mbie's mistfall (ie, disassemble the entire executable, translate the offending instructions, fix references, reassemble).<br /><br />Or you could go with the more traditional approach, as scali described. Remember to cache information on disk, to speed up next run of the executable.<br /><br />Have a look at how They did x86-&gt;Alpha JIT'ing... can't remember where I found it, but google might help :)</div>
    <div class="meta">Posted on 2004-06-05 07:13:46 by f0dder</div>
   </div>
   <div class="post" id="post-142906">
    <div class="subject"><a href="#post-142906">Emulating unsupported instructions</a></div>
    <div class="body"><div class="quote"><br />As far as I know, the Windows SEH should be able to handle it. So you cannot use C++'s try/catch, but you can use the __try/__except extensions in C/C++.<br />But yes, prepare to take a hit of many cycles (1000ish?) per instruction. You do NOT, I repeat NOT want to do this.<br />For high performance you want to recompile the code, which should be reasonably straightforward with Softwire. </div><br /><br />Doesn't SSE code usually appear in blocks?<br /><br />Is there a way for you to know the start and the end of the block?<br /><br />If so you could trip the exception only once when the first instruction is reached, then use other means to process the rest of the block.</div>
    <div class="meta">Posted on 2004-06-05 09:31:34 by ThoughtCriminal</div>
   </div>
   <div class="post" id="post-142908">
    <div class="subject"><a href="#post-142908">Emulating unsupported instructions</a></div>
    <div class="body">I think it's pointless discussing this anyway, since you will make slower systems slower.<br />I would rather create optimized x87 code that all CPUs can run, than convert fast code for already fast CPUs to extremely slow code on slow CPUs.<br />And if the x87 code cannot be made fast enough on even the fastest CPUs, so SSE+ is actually required, then I wouldn't bother supporting other CPUs anyway. It's like porting a DVD player back to a 486... It will never work anyway, so who cares if the 486 can actually run the code or not?</div>
    <div class="meta">Posted on 2004-06-05 10:13:20 by Scali</div>
   </div>
   <div class="post" id="post-143009">
    <div class="subject"><a href="#post-143009">Emulating unsupported instructions</a></div>
    <div class="body"><div class="quote"><br />I think it's pointless discussing this anyway, since you will make slower systems slower.</div><br />But compatible.<br /><br />Besides, I'm currently mostly concerned about SSE2 and SSE3. Both can be emulated fairly efficiently on a Pentium III. But anyway, making them run is far more important now that making them run fast. I want to use the instructions, not their speed. I don't want to buy a Prescott to be able to write Prescott code.</div>
    <div class="meta">Posted on 2004-06-06 08:52:07 by C0D1F1ED</div>
   </div>
   <div class="post" id="post-143010">
    <div class="subject"><a href="#post-143010">Emulating unsupported instructions</a></div>
    <div class="body">Use assemble/code-generation-time macros, preprocessing, whatever? It should be easier to write than an emulation system, and the speed should definitely be better, too.</div>
    <div class="meta">Posted on 2004-06-06 09:01:02 by f0dder</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=18452&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=18452&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="18452" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=18452&amp;page=2">&gt;</a><a href="../?id=18452&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>