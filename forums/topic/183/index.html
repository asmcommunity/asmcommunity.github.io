<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>asm version of DrawTransparentBitmap - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=183" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=183">asm version of DrawTransparentBitmap</a></p>
   <div class="post" id="post-138545">
    <div class="subject"><a href="#post-138545">asm version of DrawTransparentBitmap</a></div>
    <div class="body">Hi,<br /><br />   I have just had to convert DrawTransparentBitmap to Assembler, so i thought i would share and save others the trouble...<br /><br /><pre><code><br /><br />DrawTransparentBitmap PROC	hdc&#58;DWORD,hBitmap&#58;DWORD,<br />				xStart&#58;DWORD,yStart&#58;DWORD,<br />				cTransparentColor&#58;DWORD<br /><br />LOCAL	bm&#58;BITMAP<br />LOCAL	cColor&#58;COLORREF<br />LOCAL	bmAndBack&#58;HBITMAP,bmAndObject&#58;HBITMAP<br />LOCAL	bmAndMem&#58;HBITMAP,bmSave&#58;HBITMAP<br />LOCAL	bmBackOld&#58;HBITMAP,bmObjectOld&#58;HBITMAP<br />LOCAL	bmMemOld&#58;HBITMAP,bmSaveOld&#58;HBITMAP<br />LOCAL	hdcMem&#58;HDC,hdcBack&#58;HDC,hdcObject&#58;HDC<br />LOCAL	hdcTemp&#58;HDC,hdcSave&#58;HDC<br />LOCAL	ptSize&#58;POINT<br /><br />	INVOKE	CreateCompatibleDC,hdc<br />	mov	hdcTemp,eax<br /><br />	INVOKE	SelectObject,hdcTemp,hBitmap<br /><br />	INVOKE	GetObject,hBitmap,SIZEOF BITMAP,ADDR bm<br /><br />;Get width of bitmap<br />	push	bm.bmWidth<br />	pop	ptSize.x<br />;Get height of bitmap<br />	push	bm.bmHeight<br />	pop	ptSize.y<br /><br />;Convert from device to logical points<br />	INVOKE	DPtoLP,hdcTemp,ADDR ptSize,1<br /><br />;Create some DCs to hold temporary data<br />	INVOKE	CreateCompatibleDC,hdc<br />	mov	hdcBack,eax<br />	INVOKE	CreateCompatibleDC,hdc<br />	mov	hdcObject,eax<br />	INVOKE	CreateCompatibleDC,hdc<br />	mov	hdcMem,eax<br />	INVOKE	CreateCompatibleDC,hdc<br />	mov	hdcSave,eax<br /><br />;Create a bitmap for each DC<br />	INVOKE	CreateBitmap,ptSize.x,ptSize.y,1,1,NULL	;Monochrome DC<br />	mov	bmAndBack,eax<br />	INVOKE	CreateBitmap,ptSize.x,ptSize.y,1,1,NULL	;Monochrome DC<br />	mov	bmAndObject,eax<br />	INVOKE	CreateCompatibleBitmap,hdc,ptSize.x,ptSize.y<br />	mov	bmAndMem,eax<br />	INVOKE	CreateCompatibleBitmap,hdc,ptSize.x,ptSize.y<br />	mov	bmSave,eax<br /><br />;Each DC must select a bitmap object to store pixel data<br />	INVOKE	SelectObject,hdcBack,bmAndBack<br />	mov	bmBackOld,eax<br />	INVOKE	SelectObject,hdcObject,bmAndObject<br />	mov	bmObjectOld,eax<br />	INVOKE	SelectObject,hdcMem,bmAndMem<br />	mov	bmMemOld,eax<br />	INVOKE	SelectObject,hdcSave,bmSave<br />	mov	bmSaveOld,eax<br /><br />;Set proper mapping mode<br />	INVOKE	GetMapMode,hdc<br />	INVOKE	SetMapMode,hdcTemp,eax<br /><br />;Save the bitmap sent here, because it will be overwritten<br />	INVOKE	BitBlt,hdcSave,0,0,ptSize.x,ptSize.y,hdcTemp,0,0,SRCCOPY<br /><br />;Set the background color of the source DC to the color<br />;contained in the parts of the bitmap that should be transparent<br />	INVOKE	SetBkColor,hdcTemp,cTransparentColor<br />	mov	cColor,eax<br /><br />;Create the object mask for the bitmap by performing a BitBlt<br />;from the source bitmap to a monochrome bitmap<br />	INVOKE	BitBlt,hdcObject,0,0,ptSize.x,ptSize.y,hdcTemp,0,0,SRCCOPY<br /><br />;Set the background color of the source DC back to the original color<br />	INVOKE	SetBkColor,hdcTemp,cColor<br /><br />;Create the inverse of the object mask<br />	INVOKE	BitBlt,hdcBack,0,0,ptSize.x,ptSize.y,hdcObject,0,0,NOTSRCCOPY<br /><br />;Copy the background of the main DC to the destination<br />	INVOKE	BitBlt,hdcMem,0,0,ptSize.x,ptSize.y,hdc,xStart,yStart,SRCCOPY<br /><br />;Mask out the places where the bitmap will be placed<br />	INVOKE	BitBlt,hdcMem,0,0,ptSize.x,ptSize.y,hdcObject,0,0,SRCAND<br /><br />;Mask out the transparent colored pixels on the bitmap<br />	INVOKE	BitBlt,hdcTemp,0,0,ptSize.x,ptSize.y,hdcBack,0,0,SRCAND<br /><br />;XOR the bitmap with the background on the destination DC<br />	INVOKE	BitBlt,hdcMem,0,0,ptSize.x,ptSize.y,hdcTemp,0,0,SRCPAINT<br /><br />;Copy the destination to the screen<br />	INVOKE	BitBlt,hdc,xStart,yStart,ptSize.x,ptSize.y,hdcMem,0,0,SRCCOPY<br /><br />;Place the original bitmap back into the bitmap sent here<br />	INVOKE	BitBlt,hdcTemp,0,0,ptSize.x,ptSize.y,hdcSave,0,0,SRCCOPY<br /><br />;Delete the memory bitmaps<br />	INVOKE	SelectObject,hdcBack,bmBackOld<br />	INVOKE	DeleteObject,eax<br />	INVOKE	SelectObject,hdcObject,bmObjectOld<br />	INVOKE	DeleteObject,eax<br />	INVOKE	SelectObject,hdcMem,bmMemOld<br />	INVOKE	DeleteObject,eax<br />	INVOKE	SelectObject,hdcSave,bmSaveOld<br />	INVOKE	DeleteObject,eax<br /><br />;Delete the memory DCs<br />	INVOKE	DeleteDC,hdcMem<br />	INVOKE	DeleteDC,hdcBack<br />	INVOKE	DeleteDC,hdcObject<br />	INVOKE	DeleteDC,hdcSave<br />	INVOKE	DeleteDC,hdcTemp<br />	ret<br /><br />DrawTransparentBitmap	ENDP<br /><br /></code></pre></div>
    <div class="meta">Posted on 2004-04-10 15:06:54 by Lennon</div>
   </div>
  </div>
 </body>
</html>