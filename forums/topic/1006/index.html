<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Free yourself of all the includes...(macro) - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=1006" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=1006">Free yourself of all the includes...(macro)</a></p>
   <div class="post" id="post-6526">
    <div class="subject"><a href="#post-6526">Free yourself of all the includes...(macro)</a></div>
    <div class="body"><strong>Disease 2000</strong>, emailed me with a macro idea, which is close to what <strong>f0dder</strong> has been asking for.  Here is the first product of those suggestions:<br /><br /><strong>WARNING:</strong> This macro makes <strong>Elicz</strong>'s includes and <strong>hutch--</strong>'s includes superfluous. :)  All with a little macro.<br /><br />Please take a look. :alright:<br /><br /><strong>f0dder</strong>, I think you'll like this. ;)<br /><br />Oh, did I forget that it supports Unicode? :)<br /><br />------<br />Edit: New version with less bugs below. :)</div>
    <div class="meta">Posted on 2001-09-07 21:02:35 by bitRAKE</div>
   </div>
   <div class="post" id="post-6546">
    <div class="subject"><a href="#post-6546">Free yourself of all the includes...(macro)</a></div>
    <div class="body">If you've downloaded previous versions of this macro, they are no good in general use.  Here is a demostration of using the macro - it is a RadASM project.</div>
    <div class="meta">Posted on 2001-09-08 01:14:33 by bitRAKE</div>
   </div>
   <div class="post" id="post-6553">
    <div class="subject"><a href="#post-6553">Free yourself of all the includes...(macro)</a></div>
    <div class="body">Hm, haven't looked closely at it yet, BUT... firts of all, do you macros<br />handle type checking like invoke? And second, because of the way<br />imports are done, I assume that &quot;parameter checking&quot; will be done<br />at link time (ie, importing a wrong symbol), which means it will be<br />harder to catch the source line with the problem. As I said, I haven't<br />looked closely at it yet, but this is just my first thoughts.<br /><br />I like include files. Less things for the assembler to do at build-time,<br />and nice error checking.</div>
    <div class="meta">Posted on 2001-09-08 03:52:00 by f0dder</div>
   </div>
   <div class="post" id="post-6561">
    <div class="subject"><a href="#post-6561">Free yourself of all the includes...(macro)</a></div>
    <div class="body">BitRake,<br /><br />sorry, this is not a new idea. In fact, i've posted a similar macro some month ago, but the idea wasn't new then either (purpose was to avoid the linker generated jump table, the superflouosity of the include files was an UNWANTED side effect!).  Main disadvantage of this approach is that you &quot;fool&quot; the assembler but instead get linker errors which are probably more difficult to understand/find.<br /><br />japheth</div>
    <div class="meta">Posted on 2001-09-08 05:43:41 by japheth</div>
   </div>
   <div class="post" id="post-6580">
    <div class="subject"><a href="#post-6580">Free yourself of all the includes...(macro)</a></div>
    <div class="body"><strong>f0dder</strong>, all the APIs take dword size parameters, so the type checking is just in the number of parameters, and this is based on the first use of a function.  The includes offer only a template to insure that the the number of parameters are correct - for they are all dwords?<br /><br /><strong>japheth</strong>, didn't see your macro - could you point me to it?  I know the idea isn't new - this is just a fancy/condensed way to accomplish the same this, and it demostrates the power of macros. :)<br /><br />Yes, it is true that the external function name is based on the number of parameters passed to the macro on the first use.  Well, at least you can't have multiple wrong external functions names being referenced - this is not for the newbie. :)<br /><br />Okay, in all reality the macro should be named something like '.invoke' and then after you've finished debugging switch to this macro.  The functionality that it provides is something that should be used late in the development process.  Therefor it is <strong>not</strong> a complete replacement for the includes, unless your an WinAPI God - haven't seem one. :)</div>
    <div class="meta">Posted on 2001-09-08 08:40:13 by bitRAKE</div>
   </div>
   <div class="post" id="post-6601">
    <div class="subject"><a href="#post-6601">Free yourself of all the includes...(macro)</a></div>
    <div class="body">bitRake, heres the link (old messageboard)<br /><br /><a target="_blank" href="http://www.hiroshimator.com/asmcommunity/messageboard/ShowMsg.asp?ThreadID=2757&amp;ForumID=6&amp;PDays=100">click here</a> <br /><br />just read it again. Seems you have posted to it several times. So you possibly remember  :) .<br /><br />japheth</div>
    <div class="meta">Posted on 2001-09-08 11:31:14 by japheth</div>
   </div>
   <div class="post" id="post-6609">
    <div class="subject"><a href="#post-6609">Free yourself of all the includes...(macro)</a></div>
    <div class="body"><strong>japheth</strong>, I sure did it the hard way. :)  MASM doesn't care about the multiple externdef's or the leading comma.  Silly me.  Yes, I remember now.  Thank you.</div>
    <div class="meta">Posted on 2001-09-08 12:28:37 by bitRAKE</div>
   </div>
   <div class="post" id="post-8526">
    <div class="subject"><a href="#post-8526">Yet Another invoke-like MACRO</a></div>
    <div class="body">Hi fellows,<br /><br />I scanned through bitRAKE .DLL macro once more <br />last week,<br />I came up with idea that everything you need to define<br />in PROTO statement is a <em>Number of </em> <span style="font-size:18px>DWORDs</span> <br />to push onto the stack.<br />So, all PROTO statements look the same, but with different names, and different num. of same DWORD-type args.<br />This is useless, just in order to use MASM 'invoke' statement,<br />you have to define these PROTOs again anyway. (But this time <br />they are hidden with use of .DLL macro).<br /><br />My thought was that you can construct the list of args yourself.<br />that's one MACRO. I called it 'BUILD_ARGLIST'.<br />This macro attempts to do some args parsing, incl. detection of <br /><em>'addr'</em> statement presence and <em>eax</em> presence in the list of args.<br />Then it pushes args accordingly to their type.<br />( in reverse order, I used @ArgRev macro for this )<br /><br />;======================================== <br /><br />BUILD_ARGLIST MACRO args:VARARG<br /> IFNB &lt;args&gt;<br />    wasAddr = 0	;; Initialize locals<br />    pos = 0		;;<br />    pargs   CATSTR  &lt;!&lt;&gt;, &lt;args&gt;, &lt;!&gt;&gt;	;;Global var =args list<br />          %FOR arg, @ArgRev(pargs)<br />          ParmCount = ParmCount + 4<br />          pos = @InStr( 1, arg, &lt;addr&gt;) ;;lower Case only ;-( <br />              IF pos NE 0<br />	wasAddr = ParmCount<br />	lea eax, @SubStr(arg,pos+4) <br />                ;;'addr'    statement  takes  exactly 4 symbols<br />                ;; then oes space symbol				push eax<br />              ELSE<br />                     IFIDN &lt;arg&gt;, &lt;eax&gt;<br />                          IF (wasAddr LT ParmCount) AND (wasAddr NE 0) <br />		.err &lt;address of local argument overwritten by eax&gt;<br />                          ELSE<br />                                push arg<br />                          ENDIF<br />                    ELSE<br />                          push arg<br />                    ENDIF<br />              ENDIF<br />          ENDM<br />   ENDIF<br />ENDM<br /><br />;======================================== <br /><br />This stdcall args-pusher-thingy can be prepended to any form of API call, e.c. (EliCZ's EliASM-type LIBs call):<br /><br />;======================================== <br />iWin32 MACRO Win32API,args:VARARG<br />	LOCAL wasAddr, wasEAX, pos<br /><br />	EXTERNDEF  C _imp__&amp;Win32API:DWORD<br />	ParmCount = 0<br /><br />	BUILD_ARGLIST args<br />	call _imp__&amp;Win32API<br />ENDM<br /><br />(Yes, it doesn't use invoke  keyword).<br /><br /><br />or, (standard MS-type LIB call, i.e. invoke  identical):<br />;======================================== <br />iWin32@ MACRO Win32API,args:VARARG<br />	LOCAL dargs<br />	<br />	ParmCount = 0<br /><br />	BUILD_ARGLIST args<br />	dargs CATSTR &lt;EXTERNDEF C _imp__&gt;,&lt;Win32API&gt;,&lt;@&gt;,%ParmCount, &lt;:DWORD&gt;<br />	dargs<br />	dargs CATSTR &lt;_imp__&gt;,&lt;Win32API&gt;,&lt;@&gt;,%ParmCount<br />	call dargs<br />ENDM<br />;======================================== <br /><br />Etc...<br />I appended file which is called APImacros.mac, it contains<br />all forms of these calls. I maintained stanard EliASM call names for those who use this dialect.</div>
    <div class="meta">Posted on 2001-10-02 20:32:33 by Andycar</div>
   </div>
   <div class="post" id="post-8585">
    <div class="subject"><a href="#post-8585">Free yourself of all the includes...(macro)</a></div>
    <div class="body">I'll quote myself:<br /><div class="quote">or, (standard MS-type LIB call, i.e. invoke identical): </div> <br />It is not identical (addr is lowercase only now), plus,<br />generates jumptable-free call.</div>
    <div class="meta">Posted on 2001-10-03 12:21:24 by Andycar</div>
   </div>
   <div class="post" id="post-8622">
    <div class="subject"><a href="#post-8622">Free yourself of all the includes...(macro)</a></div>
    <div class="body">Good idea, thanks for sharing.</div>
    <div class="meta">Posted on 2001-10-03 22:48:48 by bitRAKE</div>
   </div>
   <div class="post" id="post-18653">
    <div class="subject"><a href="#post-18653">Free yourself of all the includes...(macro)</a></div>
    <div class="body">Where can I get this macro and an example how to use?<br /><br /><br /><br /><br />Thanks,<br />_Shawn</div>
    <div class="meta">Posted on 2002-01-11 05:15:37 by _Shawn</div>
   </div>
   <div class="post" id="post-18758">
    <div class="subject"><a href="#post-18758">Free yourself of all the includes...(macro)</a></div>
    <div class="body">In hind-sight this macro does more than is needed, but it is complete IMO.<br />EliCZ also posted this on his web-site - cool guy.<br />Use is no different then invoke.<br /><pre><code>.DLL MACRO api,args&#58;VARARG<br />	LOCAL dargs,dtype<br /><br />	IFNDEF _PROTO_&amp;api<br />		dargs TEXTEQU &lt;&gt;<br />		_PROTO_&amp;api = 0<br />		IFNB &lt;args&gt;<br />			FOR arg, &lt;args&gt;<br />				dargs CATSTR dargs,&lt;,&#58;DWORD&gt;<br />				_PROTO_&amp;api = _PROTO_&amp;api + 4<br />			ENDM<br />			dargs SUBSTR dargs,2 ;; Strip the first comma<br />		ENDIF<br />		dtype CATSTR &lt;_PTYPE_&gt;,%_PROTO_&amp;api<br />		IFNDEF %dtype<br />			dtype TYPEDEF PROTO dargs<br />		ENDIF<br />		dargs CATSTR &lt;EXTERNDEF _imp__&gt;,&lt;api&gt;,&lt;@&gt;,%_PROTO_&amp;api,&lt;&#58;PTR &gt;,dtype<br />		dargs<br />	ENDIF<br />	dargs CATSTR &lt;_imp__&gt;,&lt;api&gt;,&lt;@&gt;,%_PROTO_&amp;api<br />	IFB &lt;args&gt;<br />		invoke dargs<br />	ELSE<br />		invoke &amp;dargs,args<br />	ENDIF<br />ENDM<br /><br /><br />;; UNICODE version for above ;&#41;<br />.uDLL MACRO api,args&#58;VARARG<br />	IFDEF _UNICODE_<br />		.DLL api&amp;W,args<br />	ELSE<br />		.DLL api&amp;A,args<br />	ENDIF<br />ENDM<br /><br /><br />;; C Calling convention<br />.cDLL MACRO api,args&#58;VARARG<br />	.DLL api,args<br />	add esp,_PROTO_&amp;api<br />ENDM<br /><br /><br />;; UNICODE C Calling convention<br />.ucDLL MACRO api,args&#58;VARARG<br />	IFDEF _UNICODE_<br />		.cDLL api&amp;W,args<br />	ELSE<br />		.cDLL api&amp;A,args<br />	ENDIF<br />ENDM</code></pre></div>
    <div class="meta">Posted on 2002-01-11 20:27:48 by bitRAKE</div>
   </div>
   <div class="post" id="post-18764">
    <div class="subject"><a href="#post-18764">APImacro.mac</a></div>
    <div class="body">OK, I'm posting my own modified version of EliCZ's APImacro.mac.<br /><br />Actually, form of the calls i used has almost nothing in common with the form of macro used in his code. <br />Now supports 'ADDR' and 'addr' statements as well.<br /><br />&quot;iWin32@&quot; - standart for usual 'invoke' MASM equivalent<br />(will link to MS link format LIBs., i.e. to import _imp__Win32API@N<br /><br />Examples should be easy.</div>
    <div class="meta">Posted on 2002-01-11 20:59:06 by Andycar</div>
   </div>
  </div>
 </body>
</html>