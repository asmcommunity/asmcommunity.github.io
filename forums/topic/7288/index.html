<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>optimize this cool replace string function! - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=7288" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=7288">optimize this cool replace string function!</a></p>
   <div class="post" id="post-52777">
    <div class="subject"><a href="#post-52777">optimize this cool replace string function!</a></div>
    <div class="body">ok i have posted a version of his already. but this is modified, k heres its fetures. you can replace any string of any length with a any string of any length in the replace string expression u supply. it isnt a dinky replace one letter with a nother 1 letter. it will replace 1 letter with 6 or replace 7 letters with 2! it uses lots of memory access. so thats why its slow in replaceing. i want opinions about it, and any sugggestions on how to optimizie it.!<br /><pre><code><br />;---------------------------;---------------------------;---------------------------<br />;String replace 2<br />;---------------------------;---------------------------;---------------------------<br />.data<br />lpheap dd 0<br />.code<br /><br />;=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|;for string replace<br />PStrMultiMove Proc,PTRDEST &#58;DWORD ,PTRFIND &#58;DWORD,PTRSRC &#58;DWORD<br /><br /><br />Local pdest &#58;DWORD<br />Local pfind &#58;DWORD<br />Local psrc &#58;DWORD<br />pushad<br />mov ecx,PTRDEST<br />Invoke StringLen,ecx<br />cmp eax,0<br />je PStrMultiMoveEND<br />mov pdest,eax<br /><br />mov ebx,PTRSRC<br />Invoke StringLen,ebx<br />cmp eax,0<br />je PStrMultiMoveEND<br />mov psrc,eax<br /><br />Invoke StringLen,PTRFIND<br />cmp eax,0<br />je PStrMultiMoveEND<br />mov pfind,eax<br />add ecx,eax<br />pushad<br />mov edx,pdest<br />add edx,1000<br />;13+1000 for 5l4xx0r<br />Invoke GetProcessHeap<br />Invoke HeapAlloc,eax, 0 ,edx<br />mov lpheap,eax<br />popad<br />Invoke PStrCpy,lpheap,ecx,0;copy restof string into memory w/o find string<br />sub ecx,pfind<br />Invoke PStrCpy,ecx,ebx,1; add the replace string<br />add ecx,psrc<br />Invoke PStrCpy,ecx,lpheap,0; append the rest of string onto it<br /><br /><br /><br /><br />PStrMultiMoveENDHEAP&#58;<br />Invoke GetProcessHeap<br />Invoke HeapFree, eax, 0, lpheap<br />PStrMultiMoveEND&#58;<br /><br />popad<br />ret<br />PStrMultiMove EndP<br />;=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|<br />PStrReplace Proc stdcall public,PTRstringrep &#58;DWORD,PTRstrrep &#58;DWORD,PTRSTRING2REPW &#58;DWORD,PTRbuffer &#58;DWORD<br />Local PTRstringrepLEN &#58;DWORD<br />Local PTRstrrepwLEN &#58;DWORD<br />Local fstrun &#58;DWORD;unused!<br />local dwReplacelen    &#58;DWORD<br />;int 3<br />pushad<br /><br /><br />Invoke PStrCpy,PTRbuffer,PTRstringrep,0; copy first string into buffer<br /><br />mov ecx,PTRbuffer ; ecx is the pointer to the buffer were going to put our data in<br />mov ebx,PTRstrrep ; ebx is the pointer of the string werere going to replace<br /><br />Invoke StringLen,ecx ; find the string lenght of ecx<br />mov PTRstringrepLEN,eax<br /><br />Invoke StringLen,ebx<br />mov PTRstrrepwLEN,eax<br /><br />cmp PTRstringrepLEN,eax<br />jb PStrReplace@endo<br />Invoke StringLen,PTRSTRING2REPW<br />mov dwReplacelen,eax<br /><br />mov edx,PTRstringrepLEN<br />sub edx,PTRstrrepwLEN<br />mov edi,edx<br />xor eax,eax<br />xor edx,eax<br />mov esi,-1<br />jmp @neloop<br />PStrReplace@not&#58;<br /><br /><br />dec ecx<br />Invoke PStrMultiMove,ecx,ebx,PTRSTRING2REPW<br /><br />push eax<br />push edx<br />Invoke StringLen,PTRbuffer<br />mov PTRstringrepLEN,eax<br />mov edx,PTRstringrepLEN<br />sub edx,PTRstrrepwLEN<br />mov edi,edx<br />pop edx<br />pop eax<br />inc ecx<br />sub ecx,PTRstrrepwLEN; avaoid loops eg replace e with 1e1, would have been endless without this!<br />add ecx,dwReplacelen<br /><br /><br /><br />@neloop&#58;<br />cmp esi,edi<br />je PStrReplace@endo<br />Invoke PStrCmp,ecx,ebx<br />inc ecx<br />inc esi<br />cmp eax,1<br />jne @neloop<br />je PStrReplace@not<br />PStrReplace@endo&#58;<br /><br /><br />popad<br />ret<br />PStrReplace EndP<br />;=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|=-|<br />PStrCmp Proc stdcall public, PTRstring&#58;DWORD,PTRstring2find&#58;DWORD<br />;Local strlenght1 &#58;DWORD<br />push ecx<br />push ebx<br />push edx<br />push esi<br />mov ecx,PTRstring<br />;Invoke StringLen,ecx<br />;cmp eax,0<br />;je @ret0attrrcmp<br />mov ebx,PTRstring2find<br />Invoke StringLen,ebx<br />;cmp eax,0<br />;je @ret0attrrcmp<br />mov esi,eax<br />dec esi<br />xor eax,eax<br />xor edx,eax<br />mov dl, BYTE PTR &#91;ebx+eax&#93;<br />cmp dl, BYTE PTR &#91;ecx+eax&#93;<br />jne @ret0attrrcmp<br />;inc eax<br />@@&#58;<br />cmp eax,esi<br />je @ret1attrrcmp<br />inc eax<br />mov dl, BYTE PTR &#91;ebx+eax&#93;<br />cmp dl, BYTE PTR &#91;ecx+eax&#93;<br />je @B<br />jne @ret0attrrcmp<br />@ret1attrrcmp&#58;<br />xor eax,eax<br />inc eax<br />@popptrecmp&#58;<br />pop esi<br />pop edx<br />pop ebx<br />pop ecx<br />ret<br />@ret0attrrcmp&#58;<br />xor eax,eax<br />pop esi<br />pop edx<br />pop ebx<br />pop ecx<br />ret<br />PStrCmp EndP<br />PStrCpy Proc uses eax ebx ecx edx  ,PTRDEST &#58;DWORD ,PTRSRC &#58;DWORD,DIFputnull &#58;DWORD;<br />mov ecx,PTRDEST<br />mov ebx,PTRSRC<br />Invoke StringLen,ebx<br />mov edi,eax<br />cmp eax,0<br />je @PStrCpyEND<br />dec edi<br />xor eax,eax<br />xor edx,edx<br />mov dl, BYTE PTR &#91;ebx+eax&#93;<br />mov BYTE PTR &#91;ecx+eax&#93;,dl<br />;inc eax<br />cmp eax,edi<br />je @PStrCpy@PUtnull<br />@@&#58;<br />inc eax<br />mov dl, BYTE PTR &#91;ebx+eax&#93;<br />mov BYTE PTR &#91;ecx+eax&#93;,dl<br />cmp eax,edi<br />jne @B<br />@PStrCpy@PUtnull&#58;<br />cmp DIFputnull,1<br />je @PStrCpyEND<br />inc eax<br />mov BYTE PTR &#91;ecx+eax&#93;,0<br />@PStrCpyEND&#58;<br />ret<br />PStrCpy EndP<br />StringLen Proc  stdcall public,ptrSTRING1&#58;DWORD;duh<br />push esi<br />push ebx<br />mov esi,ptrSTRING1<br />xor ebx,ebx<br />xor eax,eax<br />cmp BYTE PTR &#91;esi+eax&#93;,0<br />jne @F<br />ret<br />@@&#58;<br />;mov dl,BYTE PTR &#91;esi+eax&#93;<br />inc eax<br />;cmp dl,0<br />cmp BYTE PTR &#91;esi+eax&#93;,0<br />jne @B<br />;dec eax<br />pop ebx<br />pop esi<br />ret<br />StringLen EndP<br /></code></pre></div>
    <div class="meta">Posted on 2002-08-11 22:39:42 by Qages</div>
   </div>
   <div class="post" id="post-59760">
    <div class="subject"><a href="#post-59760">optimize this cool replace string function!</a></div>
    <div class="body">Nice code.<br /><br />5 minutes fast little optimizations <br />(maybe useful, maybe useless)<br /><br />cmp eax,0	-&gt; test eax,eax	<br />je label	   jz label<br /><br />mov esi,-1	-&gt; or esi,-1<br /><br />xor eax,eax<br />cmp BYTE PTR ,0 -&gt; cmp BYTE PTR ,0<br /><br />inc eax			-&gt; inc esi<br />;cmp dl,0<br />cmp BYTE PTR ,0 -&gt; cmp BYTE PTR ,0<br />jne @B<br /><br />pushad/popad are not the faster ones around<br />are are certaintly useless where they are placed<br /><br />also removing proc/endp might avoid prologues/epilogues generations <br />(in StringLen for example).<br /><br />I don't think the pushs/pops are necessary here<br />since edx/eax are not really used:<br />   push eax<br />   push edx<br />   Invoke StringLen,PTRbuffer<br />   mov PTRstringrepLEN,eax<br />   mov edx,PTRstringrepLEN<br />   sub edx,PTRstrrepwLEN<br />   mov edi,edx<br />   pop edx<br />   pop eax<br /><br /><br />h.</div>
    <div class="meta">Posted on 2002-09-27 07:10:55 by hitchhikr</div>
   </div>
   <div class="post" id="post-59820">
    <div class="subject"><a href="#post-59820">optimize this cool replace string function!</a></div>
    <div class="body">ooo this is a bit old, ive made quite number of optimizations to this after this post, its quite fast now, and verybig, i removed calls etc and is now way fast, but not the fastest. the vb string replace is the fastsst, but my only speed bump now is the allocate memory, i could just allocate one big block the max size needed and would be super fast.</div>
    <div class="meta">Posted on 2002-09-27 13:47:17 by Qages</div>
   </div>
  </div>
 </body>
</html>