<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Distinguish between 32-bit OS and 64-bit OS? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=24907" />
    <link rel="next" href="../?id=24907&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=24907">Distinguish between 32-bit OS and 64-bit OS?</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=24907&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=24907&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="24907" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=24907&amp;page=2">&gt;</a><a href="../?id=24907&amp;page=2">&raquo;</a></form>   <div class="post" id="post-182064">
    <div class="subject"><a href="#post-182064">Distinguish between 32-bit OS and 64-bit OS?</a></div>
    <div class="body">How can we use masm32 to distinguish between 32-bit OS and 64-bit OS?</div>
    <div class="meta">Posted on 2006-06-19 00:49:23 by jeffery</div>
   </div>
   <div class="post" id="post-182065">
    <div class="subject"><a href="#post-182065">Re: Distinguish between 32-bit OS and 64-bit OS?</a></div>
    <div class="body">In what manner?<br /><br />You can use CPUID instructions and/or API calls to determine the machine type. Native 32-bit programs can run in Long Mode (ideally)... so you couldn&#39;t really discern the difference AFAIK.<br /><br />Trying to hardcode some instruction (inserting the 64-bit opcode into the program manually), that is expected to reproducibly return a specific value might crash the program as well (#UD/GPF/Double Fault).</div>
    <div class="meta">Posted on 2006-06-19 01:03:44 by SpooK</div>
   </div>
   <div class="post" id="post-182066">
    <div class="subject"><a href="#post-182066">Re: Distinguish between 32-bit OS and 64-bit OS?</a></div>
    <div class="body">Has any masm32 API can invoke to distinguish? </div>
    <div class="meta">Posted on 2006-06-19 01:27:55 by jeffery</div>
   </div>
   <div class="post" id="post-182067">
    <div class="subject"><a href="#post-182067">Re: Distinguish between 32-bit OS and 64-bit OS?</a></div>
    <div class="body">MASM32 is nothing special. The actual m32.lib is just a bunch of non-standard code slapped together. MASM32 in its entirety has libs/incs to utilize the Win32API. Just look up any function on MSDN, and you should generally be able to use that appropriate function with MASM32.</div>
    <div class="meta">Posted on 2006-06-19 02:47:32 by SpooK</div>
   </div>
   <div class="post" id="post-182068">
    <div class="subject"><a href="#post-182068">Re: Distinguish between 32-bit OS and 64-bit OS?</a></div>
    <div class="body">This looks like a really good candidate for the &#39;seh trapping on illegal opcode&#39; technique described here not long ago..<br />You could write an exception handler designed to catch the fault generated by attempting to execute some carefully-chosen 64bit opcode on a 32bit machine.. if the opcode works, great, we&#39;re 64bit.. if it fails, the seh traps the fault, great, we&#39;re 32bit.<br /></div>
    <div class="meta">Posted on 2006-06-19 02:56:13 by Homer</div>
   </div>
   <div class="post" id="post-182077">
    <div class="subject"><a href="#post-182077">Re: Distinguish between 32-bit OS and 64-bit OS?</a></div>
    <div class="body">IsWow64Process (from kernel32.dll), i dont think a 32 bit os would have that api? :)<br /></div>
    <div class="meta">Posted on 2006-06-19 04:08:16 by evlncrn8</div>
   </div>
   <div class="post" id="post-182088">
    <div class="subject"><a href="#post-182088">Re: Distinguish between 32-bit OS and 64-bit OS?</a></div>
    <div class="body">OK, fair enough, GetProcAddr will fail for that api on a 32bit machine, and the technique requires no clever tricks.<br />If we ignore the fact that its a lot slower, then I&#39;d have to say it&#39;s a much better way of doing this, especially since it&#39;s easy for beginners to understand and implement this way.<br /><br /></div>
    <div class="meta">Posted on 2006-06-19 07:23:19 by Homer</div>
   </div>
   <div class="post" id="post-182089">
    <div class="subject"><a href="#post-182089">Re: Distinguish between 32-bit OS and 64-bit OS?</a></div>
    <div class="body">Also, wouldn&#39;t a 64bit instruction *always* fail in a win<strong>32</strong> app, regardless if it&#39;s running on XP64 or not?<br /></div>
    <div class="meta">Posted on 2006-06-19 07:26:24 by f0dder</div>
   </div>
   <div class="post" id="post-182090">
    <div class="subject"><a href="#post-182090">Re: Distinguish between 32-bit OS and 64-bit OS?</a></div>
    <div class="body">a lot slower? the seh will be slow too, and on a 64 bit pc, such timing hardly matters... whats a few milliseconds, considering kernel32 will most likely be loaded anyways... and if speed is so critical you could code your own export walker for kernel32 and not use getprocaddress..... <br /><br />getprocaddress - safer, requires no seh... and if you&#39;re going to use seh, then you also have to make sure the loadconfig stuff is setup right in the PE file... more overhead...</div>
    <div class="meta">Posted on 2006-06-19 07:49:12 by evlncrn8</div>
   </div>
   <div class="post" id="post-182091">
    <div class="subject"><a href="#post-182091">Re: Distinguish between 32-bit OS and 64-bit OS?</a></div>
    <div class="body"><div class="quote"><br />and if speed is so critical you could code your own export walker for kernel32 and not use getprocaddress..... <br /></div><br />Which will probably be slower, unless you do quite some effort (hint: handling bound imports, binary search of exports, ...)<br /><br /></div>
    <div class="meta">Posted on 2006-06-19 08:05:55 by f0dder</div>
   </div>
   <div class="post" id="post-182098">
    <div class="subject"><a href="#post-182098">Re: Distinguish between 32-bit OS and 64-bit OS?</a></div>
    <div class="body">GetProcAddr that handles bound imports and uses a binary search can be found here http://www.asmcommunity.net/board/index.php?topic=17130.msg133137#msg133137<br /><br />As for the original question: looking at MSDN it seems that using GetProcAddress for IsWow64Process (then calling it if is) is the done thing. There&#39;s an example on MSDN too (in C++) http://msdn.microsoft.com/library/en-us/dllproc/base/iswow64process.asp<br /><br />You can also use GetNativeSystemInfo for more detailed information.</div>
    <div class="meta">Posted on 2006-06-19 09:52:21 by stormix</div>
   </div>
   <div class="post" id="post-182105">
    <div class="subject"><a href="#post-182105">Re: Distinguish between 32-bit OS and 64-bit OS?</a></div>
    <div class="body">I would think that GetSystemInfo would work in this case, you can determine the processor type and addressing range, if the processor is a 64bit and the address range is over 4GB then it&#39;s a 64 bit OS. The API is compatible down to NT3.5 and all of the 9x flavours so it won&#39;t fail the application.</div>
    <div class="meta">Posted on 2006-06-19 12:36:06 by donkey</div>
   </div>
   <div class="post" id="post-182118">
    <div class="subject"><a href="#post-182118">Re: Distinguish between 32-bit OS and 64-bit OS?</a></div>
    <div class="body">Ah, seems like the best bet is GetSystemInfo(), check if the <em>wProcessorArchitecture</em> field is equal to <strong>PROCESSOR_ARCHITECTURE_IA32_ON_WIN64</strong>.<br /></div>
    <div class="meta">Posted on 2006-06-19 16:39:33 by f0dder</div>
   </div>
   <div class="post" id="post-182604">
    <div class="subject"><a href="#post-182604">Re: Distinguish between 32-bit OS and 64-bit OS?</a></div>
    <div class="body"><div class="quote"><br />Ah, seems like the best bet is GetSystemInfo(), check if the <em>wProcessorArchitecture</em> field is equal to <strong>PROCESSOR_ARCHITECTURE_IA32_ON_WIN64</strong>.<br /><br /></div><br /><br />Apparently not...<br /><br /><a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/sysinfo/base/getsysteminfo.asp">MSDN says</a> &quot;To retrieve accurate information for an application running on WOW64, call the GetNativeSystemInfo function.&quot;<br /><br />And I did some tests on WinXP x64 of the wProcessorArchitecure value:<br /><br />GetSystemInfo from 32-bit app -&gt; PROCESSOR_ARCHITECTURE_INTEL<br />GetSystemInfo from 64-bit app -&gt; PROCESSOR_ARCHITECTURE_AMD64<br />GetNativeSystemInfo from 32-bit app -&gt; PROCESSOR_ARCHITECTURE_AMD64<br />GetNativeSystemInfo from 64-bit app -&gt; PROCESSOR_ARCHITECTURE_AMD64<br /><br />This is strange though, when would it actually give you PROCESSOR_ARCHITECTURE_IA32_ON_WIN64 then?<br /><br /></div>
    <div class="meta">Posted on 2006-06-28 18:14:36 by stormix</div>
   </div>
   <div class="post" id="post-182841">
    <div class="subject"><a href="#post-182841">Re: Distinguish between 32-bit OS and 64-bit OS?</a></div>
    <div class="body"><div class="quote"><br />This is strange though, when would it actually give you PROCESSOR_ARCHITECTURE_IA32_ON_WIN64 then?<br /></div><br />Pretty good question - in my mind, this would be the perfect return value from a 32bit app on win64. Perhaps it&#39;s for x86/win32 apps running on itanium/win64?<br /></div>
    <div class="meta">Posted on 2006-07-03 12:08:07 by f0dder</div>
   </div>
   <div class="post" id="post-182876">
    <div class="subject"><a href="#post-182876">Re: Distinguish between 32-bit OS and 64-bit OS?</a></div>
    <div class="body">Maybe it&#39;s kind of backwards compatibility, where you have to -somehow- &#39;tell&#39; the system, that your file is &#39;new&#39;, so it&#39;ll start returning you the true values - not the backward-compatible ones?</div>
    <div class="meta">Posted on 2006-07-03 20:42:14 by ti_mo_n</div>
   </div>
   <div class="post" id="post-208032">
    <div class="subject"><a href="#post-208032">Re: Distinguish between 32-bit OS and 64-bit OS?</a></div>
    <div class="body">I realize this is an old topic, but it seems there never really was a definitive answer (some posts are in the proper direction, but it still remains a tad vague).<br />Since I recently developed a 32-bit/64-bit launcher myself, I&#039;ll just briefly describe the way I go about it.<br /><br />First, some things about Wow64:<br />1) Wow64 is Microsoft&#039;s name for the subsystem that runs a 32-bit application under a 64-bit OS.<br />2) Wow64 can run not only on x86-based processors, but also on Itanium (and perhaps others in the future).<br />3) GetSystemInfo() returns the information within the Wow64 environment, not the actual 64-bit OS environment.<br />4) An extra GetNativeSystemInfo() has been added to the API, which reports the actual 64-bit OS environment, even from a 32-bit application.<br />5) Wow64 can be detected by the IsWow64Process() function.<br />6) Both GetNativeSystemInfo() and IsWow64Process() have only recently been added to the kernel (around XP SP2 I believe), and as such may not be available.<br /><br />Okay, with that background info, here&#039;s what I do (from a 32-bit process, obviously):<br />1) Use GetProcAddress() to load IsWow64Process().<br />1a) IsWow64Process() does not exist, assume we have a 32-bit OS. Done.<br /><br />1b) IsWow64Process() exists, call IsWow64Process().<br />2a) IsWow64Process() returns false, we have a 32-bit OS. Done.<br /><br />2b) IsWow64Process() returns true, we have a 64-bit OS.<br />3) Use GetProcAddress() to load GetNativeSystemInfo().<br />4) Call GetNativeSystemInfo and examine the architecture member. This tells us if we are running on Itanium or AMD64 (or maybe something else in the future...).<br /><br />This should be a robust way to check for 32-bit x86, 64-bit x86 or 64-bit Itanium. I then use CreateProcess() to launch the most suitable binary for the platform.<br />(The GetProcAddress() calls are done because these functions do not exist in all versions of Windows. If you link to the functions directly, your executable wouldn&#039;t load on an older version of Windows. The functions are in kernel32.dll).<br /><br />In theory it&#039;s not entirely 100%. Namely, you only know that 32-bit x86 processes run. In theory it could be that you are NOT using Wow64, but some other kind of emulation, rather than an actual x86 processor. I think that could be the case with Windows NT on an Alpha processor. However, I don&#039;t think it matters all that much. It just means in practice that you&#039;ll default to running the 32-bit x86 code when you don&#039;t know what architecture you&#039;re running on exactly (at least you know it&#039;s not IA64 or AMD64). The code will run, because you were checking from a 32-bit x86 process anyway.<br />I think at this point the only realistic options are x86, x64 and IA64 anyway. And for most intents and purposes, IA64 can be ignored. You&#039;ll rarely encounter them outside the server world.</div>
    <div class="meta">Posted on 2009-07-07 03:39:12 by Scali</div>
   </div>
   <div class="post" id="post-208035">
    <div class="subject"><a href="#post-208035">Re: Distinguish between 32-bit OS and 64-bit OS?</a></div>
    <div class="body">Thank you for writing this. Very clear explanation of the step by step checks for doing this. I won&#039;t be needing this right now for my projects but I&#039;ll keep it as a useful bookmark.<br /><br />On another note, it doesn&#039;t matter to you that doing this delays the launch of the executable (and makes it bigger) ?</div>
    <div class="meta">Posted on 2009-07-07 07:49:06 by ChaperonNoir</div>
   </div>
   <div class="post" id="post-208036">
    <div class="subject"><a href="#post-208036">Re: Distinguish between 32-bit OS and 64-bit OS?</a></div>
    <div class="body">Well no, it doesn&#039;t really bother me :)<br />Not sure if you tried the files I posted in the other thread... but on a modern PC it loads so quickly that it seems instant. So the delay isn&#039;t an issue for me, it&#039;s in the order of milliseconds, not something you&#039;d actually notice.<br />The size isn&#039;t either, because as you can see, the current version of the loader is 40 kb, becasue I just wrote it with C++, without bothering much about size. It was just a proof of concept. Since I already need to include both a 32-bit and 64-bit executable, and then a total of 6 DLLs for all the different combinations with D3D, an extra 40 kb doesn&#039;t really matter.<br /><br />I suppose if I really wanted, I could get the loader down to maybe 1 kb in size, by writing my own string functions rather than using a C-lib, and with a bit of tweaking of the linker options.<br /><br />I&#039;ll put the loader into the CPUInfo project on Sourceforge, as it&#039;s more or less related.</div>
    <div class="meta">Posted on 2009-07-07 07:59:50 by Scali</div>
   </div>
   <div class="post" id="post-208099">
    <div class="subject"><a href="#post-208099">Re: Distinguish between 32-bit OS and 64-bit OS?</a></div>
    <div class="body">The &quot;loader&quot; can be made as small as 4 kB (and use <strong>only</strong> kernel32.dll) if someone really needs it small and fast. So I don&#039;t think it&#039;s a big problem and it&#039;s&nbsp;nice to see that the app actually utilizes your hardware capabilities. Not that it really matters spped-wise but it&#039;s somewhat pleasing to know that those electrons are actually flowing through the higher 32-bits of those 64-bit registers ;p</div>
    <div class="meta">Posted on 2009-07-10 19:10:24 by ti_mo_n</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=24907&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=24907&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="24907" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=24907&amp;page=2">&gt;</a><a href="../?id=24907&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>