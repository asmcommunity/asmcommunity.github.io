<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Bloated DLL Masm WinXP - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=17711" />
    <link rel="next" href="../?id=17711&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=17711">Bloated DLL Masm WinXP</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=17711&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=17711&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="17711" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=17711&amp;page=2">&gt;</a><a href="../?id=17711&amp;page=2">&raquo;</a></form>   <div class="post" id="post-136781">
    <div class="subject"><a href="#post-136781">Bloated DLL Masm WinXP</a></div>
    <div class="body">I've been watching this place on and off from a distance for quite a while now and I must say that I'm very impressed with the knowledge here. You guys are very good at what you do!<br /><br />Now, my first question here. It's probably something simple, I just can't seem to figure it out. I have created a DLL for use in another language just to play around and see if I could get it to work. I got it to work, but the DLL seems too large for something so simple. I'll try to give as much info as I can here.<br /><br />Here is the code in the DLL:<br /><pre><code>.586<br />.model flat, stdcall<br />option casemap&#58;none<br /><br />include \masm32\include\windows.inc<br />include \masm32\include\user32.inc<br />include \masm32\include\kernel32.inc<br />includelib \masm32\lib\user32.lib<br />includelib \masm32\lib\kernel32.lib<br /><br />.data<br />DLLName   db &quot;ASM-DLL&quot;, 0<br />hInstance dd 0<br /><br />.code<br />DllEntry proc hInst&#58;HINSTANCE, dwReason&#58;DWORD, reserved1&#58;DWORD<br />    push hInst<br />    pop hInstance<br /><br />    mov eax, TRUE<br />    ret<br />DllEntry Endp<br /><br />TestProc proc<br />    invoke MessageBox, NULL, addr DLLName, addr DLLName, MB_OK<br />    ret<br />TestProc endp<br /><br />End DllEntry</code></pre><br />And here is the DEF file:<br /><pre><code>LIBRARY ASM<br />EXPORTS TestProc</code></pre><br />This DLL will assemble fine with no errors and when called form the other language it works exactly as expected. The problem though is that the DLL is 20k when assembled. <br /><br />I'm using:<br />Masm 6.15.8803<br />Link 6.00.8447<br /><br />The DLL is being assembled with the following in a batch file:<br /><pre><code>@echo off<br />\masm32\bin\ml /c /coff /Cp ASM.asm<br />\masm32\bin\link /DLL /DEF&#58;ASM.def /SUBSYSTEM&#58;WINDOWS /LIBPATH&#58;\masm32\lib ASM.obj<br />pause</code></pre><br /><br />Any ideas why this DLL is so large when it hardly does anything?</div>
    <div class="meta">Posted on 2004-03-23 10:06:40 by mastermind</div>
   </div>
   <div class="post" id="post-136784">
    <div class="subject"><a href="#post-136784">Bloated DLL Masm WinXP</a></div>
    <div class="body">I don't know what's wrong with your system, but on my system I get a 3.072 byte DLL with copy&amp;paste of your code. Different masm+link versions (7.10.3077), but it shouldn't really matter that much I guess.<br /><br />Perhaps the older version of masm does something funky, perhaps you got a virus. Please zip up the generated .obj and .dll, and post here.<br /><br />Tested with ml 6.15.8803 and link 5.12.8078 , still 3072 byte dll.</div>
    <div class="meta">Posted on 2004-03-23 10:38:33 by f0dder</div>
   </div>
   <div class="post" id="post-136787">
    <div class="subject"><a href="#post-136787">Bloated DLL Masm WinXP</a></div>
    <div class="body">Ok, here they are.<br /><br />Thanks!</div>
    <div class="meta">Posted on 2004-03-23 10:46:24 by mastermind</div>
   </div>
   <div class="post" id="post-136790">
    <div class="subject"><a href="#post-136790">Bloated DLL Masm WinXP</a></div>
    <div class="body">Ah, simple and harmless. Your DLL is linked with 4096-byte file section alignment (which should make things a bit more efficient, and generally don't matter too much (cluster size etc), especially not when your DLL grows a bit and has some actual functionality).<br /><br />If you insist on have a smaaaaaaaaaall DLL, add /filealign:512 to the linker commandline.</div>
    <div class="meta">Posted on 2004-03-23 10:55:48 by f0dder</div>
   </div>
   <div class="post" id="post-136791">
    <div class="subject"><a href="#post-136791">Bloated DLL Masm WinXP</a></div>
    <div class="body">Down to 3k now. Thanks very much.<br /><br />It isn't so much that I absolutely have to have the smallest possible dll, I just din't understand why it was so big when using ASM and very little actual code.<br /><br />It's nice to know why this was happening. Thanks again! :alright:</div>
    <div class="meta">Posted on 2004-03-23 10:59:26 by mastermind</div>
   </div>
   <div class="post" id="post-136844">
    <div class="subject"><a href="#post-136844">Bloated DLL Masm WinXP</a></div>
    <div class="body">A beer an hour huh ? :tongue: <br /><br />f0dder is right here, if you are using one of the VC linkers, you will need to set the file alignment but if you use the linker from MASM32 that is from the WIN98DDK, it was set up for device drivers where size matters and it has the 512 byte alignment as default.</div>
    <div class="meta">Posted on 2004-03-23 19:47:33 by hutch--</div>
   </div>
   <div class="post" id="post-136889">
    <div class="subject"><a href="#post-136889">Bloated DLL Masm WinXP</a></div>
    <div class="body"><div class="quote"><br />from the WIN98DDK, it was set up for device drivers where size matters and it has the 512 byte alignment as default.<br /></div><br />This is somewhat wrong :). The linker settings /OPT:WIN98 and /OPT:NOWIN98 translates directly to /FILEALIGN:4096 and /FILEALIGN:512 - this in no way changes the memory requirements of the loaded PE file, FILEALIGN:4096 is just (allegedly) a bit faster wrt. mapping of the executable - haven't ever felt much of a difference, though.<br /><br />/MEMALIGN, on the other hand, would change the runtime loaded size of the PE. I don't think it's a good idea to set it below 4096 though, as this would mean section flags can't be enforced directly by hardware (at least for adjacent sections with different protection), besides memalign&lt;4096 causes a lot of trouble for relocation items (which drivers ought to have).<br /><br />Besides, 4k of memory alignment isn't really a problem for NT Kernel-mode drivers. I don't think it was a problem even for the win9x VXD's in LE format, but it was probably a genuine problem with win3.x (what did 3.x use for drivers? LE? NE?)</div>
    <div class="meta">Posted on 2004-03-24 13:19:47 by f0dder</div>
   </div>
   <div class="post" id="post-136926">
    <div class="subject"><a href="#post-136926">Bloated DLL Masm WinXP</a></div>
    <div class="body">Yes,<br /><br />The WIN98DDK linker can handle other file alignments but its default is 512. The setting that does need to be turned off is the /OPT:REF set by default as it produces a warning if one of the syatem DLLs in not called. /OPT:NOREF solves this problem.<br /><br />VXDs were generally written to keep the size down and this is why it uses the lookup table at the end rather than the direct calls usually done in VC. You can do the direct calls using a different prototype that uses TYPEDEF which allows you the alternate use.<br /><br />If you write very large files, the 4k alignment is supposed to improve the loading speed of the program but if you are buildng files of a meg or less, its very hard to justify the alignment in load terms where 512 byte alignment certainly produces smaller files which load faster anyway.</div>
    <div class="meta">Posted on 2004-03-24 23:45:46 by hutch--</div>
   </div>
   <div class="post" id="post-136928">
    <div class="subject"><a href="#post-136928">Bloated DLL Masm WinXP</a></div>
    <div class="body"><div class="quote"><br />The WIN98DDK linker can handle other file alignments but its default is 512. The setting that does need to be turned off is the /OPT:REF set by default as it produces a warning if one of the syatem DLLs in not called. /OPT:NOREF solves this problem.<br /></div><br />I dunno which was the first linker to support the /FILEALIGN setting, but every MS linker I've tried (which means 98DDK and upwards) have supported it, just with different defaults.<br /><br />/OPT:REF shouldn't turned off, it's not an error, but a &quot;I suppose you know what you're doing, so I'm just letting you know I disabled references to this DLL because you didn't actually use it&quot; kind of helpful message. If anything needs to be &quot;fixed&quot;, it's not adding /OPT:NOREF, it's to fix up your includelib statements.<br /><br />The whole deal with 4k section alignment, I guess, is that (FILEALIGN=MEMALIGN)&gt;=4096 will allow the PE loader to use a single filemapping with a single section view mapped in, because there's a 1:1 correspondence between file and memory layout. With FILEALIGN&lt;MEMALIGN, the PE loader will have a slightly more complicated job. Whether the speed difference is noticable I do not know, but I'd prefer any dealings done in ring0 code, and especially with something as crucial as drivers, to happen as fast as possible.<br /><br />As for the file 'bloat', it will be next to unnoticable once you have real functionality in your driver, whether you write it in assembly or not. And with the filemapping approach that windows uses, only needed parts of the PE will be pulled into memory (no, the PE loader doesn't FileRead the entire file to memory, it uses file mapping which uses demand-loading).</div>
    <div class="meta">Posted on 2004-03-25 00:47:10 by f0dder</div>
   </div>
   <div class="post" id="post-136945">
    <div class="subject"><a href="#post-136945">Bloated DLL Masm WinXP</a></div>
    <div class="body">Maybe I have missed something here.<br /><div class="quote"><br />it's to fix up your includelib statements<br /></div><br />MASM only has one format to load libraries in code and that is the INCLUDELIB statement.<br /><br />Obviously the linker was set up for the tasks in writing device drivers but unless you need particular libraries treated differently to others, the /OPT:REF delivers an error for no reason so using the /OPT:NOREF is the best way to deal with it so you don't get an error that has no content.<br /><br />Regards,<br />http://www.asmcommunity.net/board/cryptmail.php?tauntspiders=in.your.face@nomail.for.you&amp;id=2f46ed9f24413347f14439b64bdc03fd</div>
    <div class="meta">Posted on 2004-03-25 07:40:03 by hutch--</div>
   </div>
   <div class="post" id="post-136967">
    <div class="subject"><a href="#post-136967">Bloated DLL Masm WinXP</a></div>
    <div class="body"><div class="quote"><br />MASM only has one format to load libraries in code and that is the INCLUDELIB statement.<br /></div><br />Yes, using INCLUDELIB or passing library names on the linker commandline.<br /><br /><div class="quote"><br />Obviously the linker was set up for the tasks in writing device drivers but unless you need particular libraries treated differently to others, the /OPT:REF delivers an error for no reason so using the /OPT:NOREF is the best way to deal with it so you don't get an error that has no content.<br /></div><br />It's not an error, it's a warning.<br />The reason it pops up, is because you have used includelib for some DLL, but aren't referencing anything from the DLL. Thus, you are importing the DLL for no reason. /OPT:REF makes the linker skip importing from the unused DLLs, but (friendly as it is) will inform you that it's doing this.<br /><br />/OPT:NOREF is not the solution to get rid of this <strong>warning</strong> message, the fix is to remove the includelib statement for the unused DLLs.</div>
    <div class="meta">Posted on 2004-03-25 10:56:18 by f0dder</div>
   </div>
   <div class="post" id="post-136999">
    <div class="subject"><a href="#post-136999">Bloated DLL Masm WinXP</a></div>
    <div class="body">What you look for in programming is consistency and the use of /OPT:REF outside of device driver development is inconsistent in that it only delivers the warning for one or two system libraries, not all of them.<br /><br />To use the linker for general purpose programming means using a whole range of different libraries so when you have warnings for one and not the other, the loss is consistency. /OPT:NOREF fixes that consistency problem in that it treats the system libraries in the same way as it treats the rest.<br /><div class="quote"><br />Yes, using INCLUDELIB or passing library names on the linker commandline.<br /></div><br />You must not have used MASM for a while, the includelib statement is used in code and is processed by ML first.  MASM normally build by using ML seperately from link with the /c option and then you link it seperately after the object module is created.<br /><br />Now of course link reads the data from the object module but it has nothing to do with passed command lines.</div>
    <div class="meta">Posted on 2004-03-25 17:33:05 by hutch--</div>
   </div>
   <div class="post" id="post-137078">
    <div class="subject"><a href="#post-137078">Bloated DLL Masm WinXP</a></div>
    <div class="body"><div class="quote"><br />What you look for in programming is consistency and the use of /OPT:REF outside of device driver development is inconsistent in that it only delivers the warning for one or two system libraries, not all of them.<br /></div><br /><br />There isn't any inconsistency on the linker side. When it sees &quot;includelib&quot; records (which get translated into the commandline-argument /DEFAULTLIB, have a look at the .drectve section in an assembled object file), all the linker does is to add this .lib file to it's &quot;search these libraries to resolve extern references&quot; list.<br /><br />Being added to this list doesn't, by itself, cause a library to be included in the executable in any way - it only means the exports of the library will be scanned when resolving external references (if you have a really really slow machine, there might be some sense in not specifying too many libraries as this would slow things down. Then again, searches are done with hash tables, so it's rather fast).<br /><br />Why do you get the unreferenced warnings with *some* libraries when doing masm projects, then? Because of generated EXTERN records. You have probably only seen it on user32.dll, because of _wsprintfA. However, have a look at the attached example asm file. It's a *very* constructed example, but it shows what is happening - EXTERN causes an EXTERN record to be generated even if the symbol isn't referenced.<br /><br />With /OPT:REF, the linker will refrain from linking in the library, because it can see the EXTERN symbol isn't referenced at all. With /OPT:NOREF it assumes that just because it got a EXTERN record, it should include the symbol, whether used or not, and will pull in the library. There might be a few times when somebody wants this to happen, but I can't really think of any examples. Using EXTERNDEF instead of EXTERN also solves this - haven't looked into how EXTERNDEF works, but I assume it tells masm to only emit the EXTERN record if the symbol is referenced.<br /><br />Now, why does this happen with wsprintfA, then? It's not defined with EXTERN but rather a PROTO, and all the other PROTOs from the masm32 includes doesn't cause this? I don't know exactly what is happening with masm, but the cause is that wsprintf is declared both in windows.inc and user32.inc. If you remove the definition from windows.inc, you don't get the warning.<br /><br />Adding /OPT:NOREF is symptom- rather than problem-fixing. And it's a plain silly thing to do just to make harmless warning messages go away. While it won't matter too much for simplistic little assembly projects, it can mean a lot when linking to &quot;real world&quot; static libraries - you can end up with including a lot more code than necessary. I wouldn't expect an assembly coder to turn off an optimization, especially when it's almost free and has no side effects.<br /><br />Anything else about masm &amp; link that you don't understand? :tongue:</div>
    <div class="meta">Posted on 2004-03-26 14:03:42 by f0dder</div>
   </div>
   <div class="post" id="post-137106">
    <div class="subject"><a href="#post-137106">Bloated DLL Masm WinXP</a></div>
    <div class="body">Hi f0dder,<br /><br /><div class="quote"><br />With /OPT:REF, the linker will refrain from linking in the library, because it can see the EXTERN symbol isn't referenced at all. With /OPT:NOREF it assumes that just because it got a EXTERN record, it should include the symbol, whether used or not, and will pull in the library. There might be a few times when somebody wants this to happen, but I can't really think of any examples. Using EXTERNDEF instead of EXTERN also solves this - haven't looked into how EXTERNDEF works, but I assume it tells masm to only emit the EXTERN record if the symbol is referenced<br /></div><br /><br />One example for EXTERN was line:<br /><br />extern _acrtused:ABS<br /><br />in many versions of VC, which forced the c runtime startup code to be included in the executable.<br />A similiar switch exist(ed) forcing the linker to include the floating point support.</div>
    <div class="meta">Posted on 2004-03-27 01:13:58 by japheth</div>
   </div>
   <div class="post" id="post-137107">
    <div class="subject"><a href="#post-137107">Bloated DLL Masm WinXP</a></div>
    <div class="body"><div class="quote">With /OPT:NOREF it assumes that just because it got a EXTERN record, it should include the symbol, whether used or not, and will pull in the library. There might be a few times when somebody wants this to happen, but I can't really think of any examples</div><br /><br />Could be useful for rich edit controls where you have to load the DLL but don't really call any functions in your app, just use the class and send messages to the control.</div>
    <div class="meta">Posted on 2004-03-27 01:19:07 by donkey</div>
   </div>
   <div class="post" id="post-137112">
    <div class="subject"><a href="#post-137112">Bloated DLL Masm WinXP</a></div>
    <div class="body"><div class="quote"><br />A similiar switch exist(ed) forcing the linker to include the floating point support.<br /></div><br />_fltused, iirc. And I think that symbol reference only gets generated when floating-point code is used?<br /><br /><div class="quote"><br />Could be useful for rich edit controls where you have to load the DLL but don't really call any functions in your app, just use the class and send messages to the control.<br /></div><br />Ah yes, that's one of the few examples, and this would probably be optimized away with /OPT:REF. The soultion here would be either to /OPT:NOREF, or something like putting a &quot;dummy dd offset IID_ITextHost&quot; somewhere in your program. It might seem stupid to add a dword to your app instead of just /OPT:NOREF, but if you use static libraries that use COMDAT function-level splitting, well... then it certainly isn't stupid :)</div>
    <div class="meta">Posted on 2004-03-27 02:52:34 by f0dder</div>
   </div>
   <div class="post" id="post-137113">
    <div class="subject"><a href="#post-137113">Bloated DLL Masm WinXP</a></div>
    <div class="body">It seems that a little knowledge is dangerous. Microsoft linker handle benign redefinitions with no problems and no errors so even though there is a redefinition of wsprintfA in 2 seperate include files, there is no error that occurs because there is no change that could be called a redefinition.<br /><br />It is a tolerance based on the method of storing the data in either a hash table or a dynamic tree where if there is no change, there is no error. All you have to do is error check the the data stored for the name and if its the same, ignore it, if its not, drop a redefinition error.<br /><br />Here is how you test it in MASM. The prototype is directly from kernel32.inc from MASM32.<br /><pre><code><br />AddAtomA PROTO &#58;DWORD<br />AddAtom equ &lt;AddAtomA&gt;<br />AddAtomA PROTO &#58;DWORD<br />AddAtom equ &lt;AddAtomA&gt;<br />AddAtomA PROTO &#58;DWORD<br />AddAtom equ &lt;AddAtomA&gt;<br />AddAtomA PROTO &#58;DWORD<br />AddAtom equ &lt;AddAtomA&gt;<br />AddAtomA PROTO &#58;DWORD<br />AddAtom equ &lt;AddAtomA&gt;<br />AddAtomA PROTO &#58;DWORD<br />AddAtom equ &lt;AddAtomA&gt;<br />AddAtomA PROTO &#58;DWORD<br />AddAtom equ &lt;AddAtomA&gt;<br />AddAtomA PROTO &#58;DWORD<br />AddAtom equ &lt;AddAtomA&gt;<br />AddAtomA PROTO &#58;DWORD<br />AddAtom equ &lt;AddAtomA&gt;<br />AddAtomA PROTO &#58;DWORD<br />AddAtom equ &lt;AddAtomA&gt;<br /></code></pre><br />The exe that I tested it with builds with no errors.<br /><br />Pull the other leg. :tongue: <br /><br />Regards,<br />http://www.asmcommunity.net/board/cryptmail.php?tauntspiders=in.your.face@nomail.for.you&amp;id=2f46ed9f24413347f14439b64bdc03fd</div>
    <div class="meta">Posted on 2004-03-27 02:53:50 by hutch--</div>
   </div>
   <div class="post" id="post-137115">
    <div class="subject"><a href="#post-137115">Bloated DLL Masm WinXP</a></div>
    <div class="body">It's a thing with masm, not the linker. Appearantly the symbol redefinition (or perhaps some other thing) causes the EXTERN record to be generated. My guess is that masm doesn't emit a EXTERN record for PROTOs unless the symbol is used, and that a symbol lookup (causes by symbol redefinition) is enough that the symbol is considered 'used'.<br /><br />So there's no difference to the linker with this, except whether it sees an EXTERN or not. What you might be thinking about is if multiple symbols with the same name are found in different compilation modules, this will be handled by COMDAT folding.<br /><br />Again, the &quot;all references discarded&quot; is a warning, not an error. The attached sample builds fine, and demonstrates the thing pretty well.<br /><br />I suggest you remove the wsprintf definition from windows.inc as it should really only be in user32.inc, and that you don't propose using /OPT:NOREF to &quot;fix things&quot; if you don't really know what's going on.<br /><br />PS<br />Microsoft (R) Macro Assembler Version 7.10.3077<br />Microsoft (R) Incremental Linker Version 7.10.3077<br />but the behaviour should be the same for older versions as well, including:<br />Microsoft (R) Macro Assembler Version 6.15.8803<br />Microsoft (R) Incremental Linker Version 5.12.8078<br /><br /><br />Try doing the redefinition thing, but without issuing any &quot;includelib&quot; statements and not passing any lib names on the linker commandline...</div>
    <div class="meta">Posted on 2004-03-27 03:15:54 by f0dder</div>
   </div>
   <div class="post" id="post-137119">
    <div class="subject"><a href="#post-137119">Bloated DLL Masm WinXP</a></div>
    <div class="body"><div class="quote"><br />The exe that I tested it with builds with no errors.<br /></div><br />It build with no warnings either, various version of Microsoft LINK.EXE from the XP DDK versions you have mentioned down to the version from the win98ddk all handle benign redefinitions without either warnings or errors.<br /><br />The /OPT:REF was for a special purpose in the win98ddk which is no use in general purpose programming. Its something like having you warning level set to 4 on release code, no point in general purpose programming.<br /><br />It is an option that was preset to ON rather than a default OFF so unless you need that specific characteristic, using the /OPT:NOREF just resets it to default.<br /><br />Regards,<br />http://www.asmcommunity.net/board/cryptmail.php?tauntspiders=in.your.face@nomail.for.you&amp;id=2f46ed9f24413347f14439b64bdc03fd</div>
    <div class="meta">Posted on 2004-03-27 04:45:43 by hutch--</div>
   </div>
   <div class="post" id="post-137123">
    <div class="subject"><a href="#post-137123">Bloated DLL Masm WinXP</a></div>
    <div class="body"><div class="quote"><br />It build with no warnings either<br /></div><br />Have a look at the test.asm I posted, and use the same commandline arguments.<br /><br /><div class="quote"><br />The /OPT:REF was for a special purpose in the win98ddk which is no use in general purpose programming. Its something like having you warning level set to 4 on release code, no point in general purpose programming.<br /></div><br />Erm, that's plain wrong. /OPT:REF was introduced to remove unused (unreferenced) code and data, which is very important with the COMDAT method of handling &quot;function-level linking&quot;. It's preset to ON because it's an optimization (almost) without any side effects. Setting it to OFF means you will get an unused DLL reference in your code, which is silly.<br /><br />Also, do go ahead and remove the wsprintf definition from windows.inc, otherwise you're forcing everybody using masm32 to link with user32.dll even if they don't use any functions from it (well, when combined with /OPT:NOREF. /OPT:REF will give the innocent warning and discard user32.dll).</div>
    <div class="meta">Posted on 2004-03-27 05:00:36 by f0dder</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=17711&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=17711&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="17711" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=17711&amp;page=2">&gt;</a><a href="../?id=17711&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>