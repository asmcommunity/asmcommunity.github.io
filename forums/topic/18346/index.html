<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>SetWindowsHookEx - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=18346" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=18346">SetWindowsHookEx</a></p>
   <div class="post" id="post-142157">
    <div class="subject"><a href="#post-142157">SetWindowsHookEx</a></div>
    <div class="body">Actually i had a simple question releated to Setting Hooks In Windows<br /><br />Why does the code have to be resident in a dll (i am using system-wide hooks)<br /><br />Is it because my dll code is injected in all processes or any other reason?<br /><br />Also will the processes(applications) running before my process is executed also be hooked?<br />:stupid: <br /><br />Thankyou for reading :grin:</div>
    <div class="meta">Posted on 2004-05-26 04:45:04 by telophase</div>
   </div>
   <div class="post" id="post-142163">
    <div class="subject"><a href="#post-142163">SetWindowsHookEx</a></div>
    <div class="body">Hi telophase !<br /><br />You are very curious about windows internals :grin: <br />But this is good.<br /><br />There are actualy 2 great projects called Wine and Reactos.<br />Wine is a OpenSource implementation of the Windows API<br />and Reactos is a OpenSource implementation of the Windows<br />NT Kernel.<br /><br />Take a look into the source codes, there are a complete<br />implementation of the hook functions in there.<br />I believe that the original Windows source code is very<br />closer to this implementation, IMO.<br />Remember that the important code of the hook procedures<br />are implemented in the win32k.sys of windows 2000 and XP.<br /><br />But, answer to your question:<br />Yes, your dll are mapped to all processes.<br /><br /><a target="_blank" href="http://www.reactos.com/">http://www.reactos.com/</a> <br /><a target="_blank" href="http://www.winehq.com/">http://www.winehq.com/</a> <br /><br />Use the source,  Luke :tongue:</div>
    <div class="meta">Posted on 2004-05-26 06:26:24 by Opcode</div>
   </div>
   <div class="post" id="post-142165">
    <div class="subject"><a href="#post-142165">Hmm...</a></div>
    <div class="body">But if i have a hook installed on WH_GETMESSAGE then only those applications <br /><br />which message post messages to a message queue will have the shared copy of my DLL :confused: <br /><br />So all processes will not contain my dll's shared copy :rolleyes: <br /><br />But i want to know what will happen if i install hook on WH_MOUSE then wil all the processes will be injected<br /><br />with my dll code :confused: <br /><br />Thankx for replying back :alright:</div>
    <div class="meta">Posted on 2004-05-26 07:36:34 by telophase</div>
   </div>
   <div class="post" id="post-142166">
    <div class="subject"><a href="#post-142166">SetWindowsHookEx</a></div>
    <div class="body">One more thing:<br /><br />Suppose i have installed a mouse hook and cursor is on a window. Now i can retrive the handle of the<br /><br />window easily but the problem is that i dont know how tio find out the program which created the <br /><br />window:confused: <br /><br />I want to get the name of the program(.exe) which had created the window. Which API's should be used?<br />:stupid:</div>
    <div class="meta">Posted on 2004-05-26 07:49:13 by telophase</div>
   </div>
   <div class="post" id="post-142167">
    <div class="subject"><a href="#post-142167">SetWindowsHookEx</a></div>
    <div class="body">Appears that you are trying to copy the<br />mouse messages of a specific program.<br /><br />And I don't see any good reason to do this.<br /><br />Please tell us the <strong>true reason</strong> to make this.</div>
    <div class="meta">Posted on 2004-05-26 08:20:45 by Opcode</div>
   </div>
   <div class="post" id="post-142168">
    <div class="subject"><a href="#post-142168">SetWindowsHookEx</a></div>
    <div class="body">hi telophase<br />not sure if this is what your looking for but anyway,<br />try getting the process id of the window with GetWindowThreadProcessId()<br />and then getting the info of the process which should contain the filename or filepath (depending on OS) i think you use these apis:<br />CreateToolhelp32Snapshot()<br />Process32First()<br />Process32Next()</div>
    <div class="meta">Posted on 2004-05-26 08:38:11 by someone</div>
   </div>
   <div class="post" id="post-142173">
    <div class="subject"><a href="#post-142173">Chat spying program</a></div>
    <div class="body">Actually i was trying to create a modified version of MouseHook tutorial which also shows in which processes<br /><br />window the mouse cursor is present :grin:</div>
    <div class="meta">Posted on 2004-05-26 11:19:37 by telophase</div>
   </div>
   <div class="post" id="post-142175">
    <div class="subject"><a href="#post-142175">SetWindowsHookEx</a></div>
    <div class="body">Also found a API in the MSDN but dont know whether it will support win9x <br />Need more help on this one :confused: <br /><strong><br />GetWindowModuleFileName<br /> <br /><br />Retrieves the full path and file name of the module associated with the given window handle. <br /><br />UINT WINAPI GetWindowModuleFileName(<br />  HWND hwnd,<br />  LPTSTR lpszFileName,<br />  UINT cchFileNameMax<br />);<br /> <br />Parameters<br />hwnd <br />Handle to the window whose module file name will be retrieved. <br />lpszFileName <br />Address of a string variable that will contain the executable file's path and file name. <br />cchFileNameMax <br />Value specifying the maximum number of characters to copy into the buffer at lpszFileName. <br />Return Values<br />Returns a value representing the total number of characters copied into the buffer.</strong></div>
    <div class="meta">Posted on 2004-05-26 11:53:12 by telophase</div>
   </div>
   <div class="post" id="post-142190">
    <div class="subject"><a href="#post-142190">Re: SetWindowsHookEx</a></div>
    <div class="body"><div class="quote"><br />Actually i had a simple question releated to Setting Hooks In Windows<br /><br />Why does the code have to be resident in a dll (i am using system-wide hooks)<br /><br />Is it because my dll code is injected in all processes or any other reason?<br /><br />Also will the processes(applications) running before my process is executed also be hooked?<br />:stupid: <br /><br />Thankyou for reading :grin: </div><br />Hi :) I'll try to answer your questions:<br /><br />1 &amp; 2) For system-wide hooks (and in general any hook to a process other than your own) works by injecting the dll in the target process space.<br /><br />It's the only way to do it for most hooks except the low level mouse and keyboard ones (that AFAIK only work on NT and 2K). The latter don't need a hook library because they work using a context switch instead, so the hook code executes in the context of your process (it's more secure that way).<br /><br />Hooks on your own process don't need a dll at all, they can be located anywhere.<br /><br />3) Yes. Actually when you call SetWindowsHookEx to set up a global hook the system will look for existing processes with at least one thread that has created a message queue (hooks can't work without one). Also while the hook is installed, as new processes create message queues they will be hooked as well. A process whose threads don't have any message queues can't be hooked at all.<br /><br />As for GetModuleFilename, it simply won't work for foreign processes. Only for the current process, and DLL libraries. That behaviour is by design, some kind of security feature I guess.<br /><br />MSDN should say (usually at the bottom of the document) which OSs support that function. (I'm too lazy to check it out right now, do it yourself :grin: ). MSDN is your friend, things are so well documented there you don't need to browse through some emulator's source code... :rolleyes: <br /><br />Hope that helps. :)</div>
    <div class="meta">Posted on 2004-05-26 17:24:11 by QvasiModo</div>
   </div>
   <div class="post" id="post-142199">
    <div class="subject"><a href="#post-142199">SetWindowsHookEx</a></div>
    <div class="body">Thankx a lot for the help</div>
    <div class="meta">Posted on 2004-05-26 22:19:47 by telophase</div>
   </div>
   <div class="post" id="post-142624">
    <div class="subject"><a href="#post-142624">Another Hook Problem</a></div>
    <div class="body">I was installing a global keyboard hook is there anyway to check which window is the keyboard<br /><br />request coming from or which window is the keyboard data going to ?:confused:</div>
    <div class="meta">Posted on 2004-06-01 08:58:56 by telophase</div>
   </div>
   <div class="post" id="post-142850">
    <div class="subject"><a href="#post-142850">SetWindowsHookEx</a></div>
    <div class="body">Maybe GetFocus or GetForegroundWindow? Doesn't seem to be very accurate though...</div>
    <div class="meta">Posted on 2004-06-04 09:34:52 by QvasiModo</div>
   </div>
  </div>
 </body>
</html>