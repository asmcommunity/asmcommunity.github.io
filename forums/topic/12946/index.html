<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>MASM Object Preprocessor - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=12946" />
    <link rel="next" href="../?id=12946&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=116">Windows</a> &raquo; <a href="../?id=12946">MASM Object Preprocessor</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=12946&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=12946&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="12946" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=12946&amp;page=2">&gt;</a><a href="../?id=12946&amp;page=2">&raquo;</a></form>   <div class="post" id="post-100631">
    <div class="subject"><a href="#post-100631">MASM Object Preprocessor</a></div>
    <div class="body">Hey guys<br /><br /><strong>Please read the preprocessor section at the bottom if you don't want to lose your code</strong><br /><br />Well it's finally here, and probably still has bugs in it but give it a go and tell me what you think.<br /><br /><strong>Defining our object</strong><br /><br />The class definition is fairly straight forward but must be enclosed with CLASS/ENDC keywords.<br /><br /><pre><code><br />	CLASSNAME class<br /><br />		_blah dd &#91;default value&#93;	; data<br />		_blah CLASSNAME &lt;&gt;		; embedded object<br /><br />		Blah proto &#58;DWORD		; static method<br />		Blah* proto &#58;DWORD		; virtual method<br />		Blah proto &#58;DWORD = 0		; abstract method<br /><br />		protected<br /><br />		; protected stuff here<br /><br />		private<br /><br />		; private stuff here<br /><br />	CLASSNAME endc<br /></code></pre><br /><br />Class data MUST start with an underscore, the underscore is used by the preprocessor and DOESN'T become part of the name. If you want to prefix your data with an underscore you need to use two underscores. You can also give data members a default value which is used to initialize new objects.<br /><br />Member functions must have at least 1 argument for the THIS ptr and the C calling convention is supported.<br /><br />Members can have 1 of 3 forms of access control :-<br /><em>public</em> (default, not a keyword ) - members can be accessed by anyone from anywhere.<br /><em>protected</em> - members can only be accessed from inside the class that defined them or a class derived from the defining class.<br /><em>private</em> - members can only be accessed from inside the class that defined them.<br /><br />Every base class must have a virtual destructor method, but they are optional for derived classes. Constructors are completely optional.<br /><br /><strong>Defining our methods</strong><br /><br />Defining methods is extremely simple with the only requirement being that the methods be enclosed in a class segment.<br /><br /><pre><code><br />	CLASSNAME segment<br /><br />		Blah proc USES ebx edi esi _this<br /><br />			ret<br /><br />		Blah endp<br /><br />	CLASSNAME ends<br /></code></pre><br /><br />The preprocessor will automatically prefixes the class name to the method name, but YOU must manually define the THIS ptr argument.<br /><br />It's also YOUR responsibility to call the base class constructor/destructor methods and initialize/destroy embedded objects. ( see below )<br /><br /><strong>Accessing our object</strong><br /><br />I've tried to make the preprocessor syntax as unobtrusive as possible while extending the existing MASM syntax.<br /><br /><pre><code><br />	CBLAH segment<br /><br />		Blah proc USES ebx edi esi _this<br /><br />			mov ebx, _this &lt;@CurClass&#58;&#58;blah&gt;<br /><br />			mov blah.data, eax		; access data<br />			invoke blah.method, &#91;args&#93;	; access functions<br /><br />			mov blah.embeddedObject.data, eax<br />			inboke blah.embeddedObject.method, &#91;args&#93;<br /><br />			ret<br /><br />		Blah endp<br /><br />	CBLAH ends<br /></code></pre><br /><br />As you can see you simply define a symbol telling the preprocessor what type of object the register addresses and the name you wish to use to access the object. The only restriction to defining symbols is the second word in the line MUST be the register ( I'll see if I can improve this later :rolleyes: ). The @CurClass keyword tells the preprocessor to use the name of the class whose segment you are currently in. Obviously if you aren't in a class segment then this won't work and you need to specify the actual class name.<br /><br />Once you've defined your symbol it's simply a case of using it like a structure.<br /><br />If you have embedded objects in your class then you can access them directly.<br /><br />I said earlier that YOU where responsible for initializing the object, here's how<br /><br /><pre><code><br />	CBLAH segment<br /><br />		Constructor proc USES ebx edi esi _this<br /><br />			mov ebx, _this &lt;@CurClass&#58;&#58;blah&gt;<br /><br />			; init base class<br /><br />			.superclass blah.Constructor, &#91;args&#93;<br /><br />			; init embedded objects<br /><br />			invoke blah.embeddedObject.Constructor, &#91;args&#93;<br /><br />			...<br />			...<br />			...<br /><br />			ret<br /><br />		Constructor endp<br /><br />		Destructor proc USES ebx edi esi _this<br /><br />			mov ebx, _this &lt;@CurClass&#58;&#58;blah&gt;<br /><br />			...<br />			...<br />			...<br /><br />			; destroy embedded objects<br /><br />			invoke blah.embbededObject.Destructor<br /><br />			; destroy base class<br /><br />			.superclass blah.Destructor<br /><br />			ret<br /><br />		Destructor endp<br /><br />	CBLAH ends<br /></code></pre><br /><br />Calling the base is required but you could initialize and destroy embedded objects whenever you like.<br /><br /><strong>Creating an object</strong><br /><br />The preprocessor currently only supports dynamic creation of objects.<br /><br /><pre><code><br />	.new reg, class&#58;&#58;symbol, &#91;args&#93;<br /><br />	.delete symbol<br /></code></pre><br /><br /><em>reg</em> - MUST be a register ( required )<br /><em>class</em> - class name ( required )<br /><em>symbol</em> - register alias ( required, I'll look into making this optional later )<br /><em>args</em> - arguments passed to the constructor<br /><br />The symbol is simply an alias for the register but allows you to access the object using a name. Symbols are only valid inside the PROC that defined them and if you define a symbol that already exists, the existing symbol is overwritten with the new one.<br /><br />The .new and .delete keywords are converted into macro calls. The macros are defined in the preprocessor.inc file and can be customized to your hearts content. If modifying the new macro there are 2 things you MUST do :-<br />1. copy the class template into the newly allocated memory, the class template contains the default data values and virtual method pointers.<br />2. move the memory pointer into the specified register before returning.<br /><br />The preprocessor will allow you to create objects with abstract methods, but if you intend to call them you need to either derive a new class or manually overload the virtual method entry. Check the processed output to get the method name.<br /><br /><strong>Preprocessing</strong><br /><br />You must include preprocessor.inc in your source.<br /><br /><em>mo -i:\includeDir -o:\outputDir *.asm</em><br /><br />The preprocessor requires some strict usage at the moment, but I hope to improve that soon.<br /><br />You must run the preprocessor from the directory that contains the files you want to process.<br />You must supply an include directory so it can find include files not in the current directory. Only one include directory supported at the moment.<br /><strong>You must supply an output directory, it MUST be a different directory than the source as the preprocessor uses the original file name when creating the processed file in the output directory.</strong><br /><br />The preprocessor hasen't been optimized yet at all so there's a lot of room for speed improvement. The preprocessor will search all include files specified in the source and will write ALL of these to the output directory.<br /><br />A quick note on the error reporting, it's not good :rolleyes:<br /><br />Also the preprocessor only opens its dialog if an error occurs so if you don't see anything, then everything worked or it hung your system ( something else to improve :rolleyes: ).<br /><br /><strong>Final thoughts</strong><br /><br />There are a number of things to improve but I'm tossing around a few ideas...<br /><br />- .clone keyword for cloning objects<br />- .overload keyword for manual overloading of abstract methods<br />- do we need inline methods?<br /><br />Tell me what you think.<br /><br />Maelstrom</div>
    <div class="meta">Posted on 2003-05-01 18:15:28 by Maelstrom</div>
   </div>
   <div class="post" id="post-100634">
    <div class="subject"><a href="#post-100634">MASM Object Preprocessor</a></div>
    <div class="body">Ok here's a quick example<br /><br /><pre><code><br />CFILE class<br /><br />	Close proto &#58;DWORD<br />	Create proto &#58;DWORD, &#58;DWORD<br />	Destructor* proto &#58;DWORD<br />	GetSize proto &#58;DWORD<br />	Open proto &#58;DWORD, &#58;DWORD<br />	Read proto &#58;DWORD, &#58;DWORD, &#58;DWORD<br />	Seek proto &#58;DWORD, &#58;DWORD, &#58;DWORD<br />	Write proto &#58;DWORD, &#58;DWORD, &#58;DWORD<br />	<br />	private<br />	<br />	_handle dd 0<br />		<br />CFILE endc<br />	<br />CFILE segment<br /><br />	Close proc USES ebx edi esi _this<br />		<br />		mov ebx, _this &lt;@CurClass&#58;&#58;file&gt;<br />		.if file.handle<br />			invoke CloseHandle, file.handle<br />			test eax, eax<br />			jz _1<br />			mov file.handle, 0<br />		.endif<br />		.ret<br />		<br />	_1&#58;	; do error stuff<br /><br />	Close endp<br />	<br />	Create proc USES ebx edi esi _this, _fileName<br />		<br />		mov ebx, _this &lt;@CurClass&#58;&#58;file&gt;<br />		invoke CreateFile, _fileName, GENERIC_READ + GENERIC_WRITE,<br />			FILE_SHARE_READ + FILE_SHARE_WRITE, 0, CREATE_ALWAYS,<br />			FILE_ATTRIBUTE_ARCHIVE, 0<br />		cmp eax, INVALID_HANDLE_VALUE<br />		je _1<br />		mov file.handle, eax<br />		.ret<br />		<br />	_1&#58;	; do error stuff<br /><br />	Create endp<br />	<br />	Destructor proc USES ebx edi esi _this<br />		<br />		mov ebx, _this &lt;@CurClass&#58;&#58;file&gt;<br />;--------------------------------------------------------------------------------<br />		.superclass file.Destructor<br />;--------------------------------------------------------------------------------<br />		.ret<br /><br />	Destructor endp<br />	<br />	GetSize proc USES ebx edi esi _this<br />		<br />		mov ebx, _this &lt;@CurClass&#58;&#58;file&gt;<br />		xor eax, eax<br />		.if file.handle<br />			invoke GetFileSize, file.handle, 0<br />			cmp eax, INVALID_HANDLE_VALUE<br />			je _1<br />		.endif<br />		.ret eax<br />		<br />	_1&#58;	; do error stuff<br /><br />	GetSize endp<br />	<br />	Open proc USES ebx edi esi _this, _fileName<br />		<br />		mov ebx, _this &lt;@CurClass&#58;&#58;file&gt;<br />		invoke CreateFile, _fileName, GENERIC_READ + GENERIC_WRITE,<br />			FILE_SHARE_READ + FILE_SHARE_WRITE, 0, OPEN_EXISTING,<br />			FILE_ATTRIBUTE_ARCHIVE, 0<br />		cmp eax, INVALID_HANDLE_VALUE<br />		je _1<br />		mov file.handle, eax<br />		.ret<br />		<br />	_1&#58;	; do error stuff<br /><br />	Open endp<br />	<br />	Read proc USES ebx edi esi _this, _buf, _size<br />		<br />		LOCAL _count&#58;DWORD<br />		<br />		mov ebx, _this &lt;@CurClass&#58;&#58;file&gt;<br />		xor eax, eax<br />		.if file.handle<br />			invoke ReadFile, file.handle, _buf, _size, addr _count, 0<br />			test eax, eax<br />			jz _1<br />			mov eax, _count<br />		.endif<br />		.ret eax<br />		<br />	_1&#58;	; do error stuff<br /><br />	Read endp<br />	<br />	Seek proc USES ebx edi esi _this, _distance, _origin<br />		<br />		mov ebx, _this &lt;@CurClass&#58;&#58;file&gt;<br />		xor eax, eax<br />		.if file.handle<br />			invoke SetFilePointer, file.handle, _distance, 0, _origin<br />			cmp eax, INVALID_SET_FILE_POINTER<br />			je _1<br />		.endif<br />		.ret eax<br />		<br />	_1&#58;	; do error stuff<br /><br />	Seek endp<br />	<br />	Write proc USES ebx edi esi _this, _buf, _size<br />		<br />		LOCAL _count&#58;DWORD<br />		<br />		mov ebx, _this &lt;@CurClass&#58;&#58;file&gt;<br />		xor eax, eax<br />		.if file.handle<br />			invoke WriteFile, file.handle, _buf, _size, addr _count, 0<br />			test eax, eax<br />			jz _1<br />			mov eax, _count<br />		.endif<br />		.ret eax<br />		<br />	_1&#58;	; do error stuff<br /><br />	Write endp<br /><br />CFILE ends<br /></code></pre><br /><br />Maelstrom</div>
    <div class="meta">Posted on 2003-05-01 18:29:56 by Maelstrom</div>
   </div>
   <div class="post" id="post-100661">
    <div class="subject"><a href="#post-100661">MASM Object Preprocessor</a></div>
    <div class="body">Glad to see you finished it up!  Great work!<br /><br />I will give it a solid once over tonight and give you any critical feedback i can.  But for now take a pat on the back!  To do stuff like this takes alot of work!<br /><br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-05-01 23:20:40 by NaN</div>
   </div>
   <div class="post" id="post-100693">
    <div class="subject"><a href="#post-100693">MASM Object Preprocessor</a></div>
    <div class="body">Preprocessor is a good way to achieve the goal. I noticed you used the MACRO in the previous version, if you have lost the confidence of MACRO's power? <br />Great idea to do this, I will check your design carefully.<br />Thank you</div>
    <div class="meta">Posted on 2003-05-02 02:57:55 by taowen2002</div>
   </div>
   <div class="post" id="post-100727">
    <div class="subject"><a href="#post-100727">MASM Object Preprocessor</a></div>
    <div class="body"><strong>NaN</strong><br /><br />Thanks for the encouragement, feedback would be great :alright:<br /><br />I'm currently using the preprocessor to improve the preprocessor, primarily the error reporting as it currently sucks :grin:<br /><br /><strong>taowen2002</strong><br /><br />No I haven't lost confidence in MASM macros, actually until I wrote the macro OOP framework I didn't realize how powerful they can be.<br />The decision to do a preprocessor was mainly because there's no limit to what I can do with it.<br /><br />Maelstrom</div>
    <div class="meta">Posted on 2003-05-02 05:50:25 by Maelstrom</div>
   </div>
   <div class="post" id="post-100799">
    <div class="subject"><a href="#post-100799">MASM Object Preprocessor</a></div>
    <div class="body">Can you explain the power of your preprocessor for me? <br />Why I need a preprocessor as we already have so powerful macro?<br />I am more concern about how simple the usage can be than how powerful the tool can be. It is my principle of designing OOP model</div>
    <div class="meta">Posted on 2003-05-02 12:13:51 by taowen2002</div>
   </div>
   <div class="post" id="post-100833">
    <div class="subject"><a href="#post-100833">MASM Object Preprocessor</a></div>
    <div class="body">Pre-processing allows your to make the &quot;simplest&quot; commands.  You have the ability to program complex routines to take a simple idea and forge a complex result.<br /><br />Macro's can do this as well.  In essence they *are* a pre-processor.  However you are restricted to the limitations of this &quot;macro language&quot; that was conceived from ASM to begin with.  To skip over macro's and use ASM purely gives your the largest amount of pre-processor flexibility and options when defining your OOP statements.<br /><br />:NaN:</div>
    <div class="meta">Posted on 2003-05-02 17:38:12 by NaN</div>
   </div>
   <div class="post" id="post-101080">
    <div class="subject"><a href="#post-101080">MASM Object Preprocessor</a></div>
    <div class="body">I am trying a simple example, but have a couple questions:<br /><br />1) What is the proper way to call a class function from within the class.<br /><br />2) Am I correct in assuming my 'IF DEBUG's will break the class?<br /><br />3) Please point out any errors, supply more examples, etc...<br /><br /><br />The <strong>.ret</strong> macro from the other thread isn't in the distribution.<br /><br /><pre><code><br />; First In First Out Queue<br /><br />CQUEUE class<br /><br />	Create proto &#58;DWORD, &#58;DWORD<br />	Destructor* proto &#58;DWORD<br /><br />	Count proto &#58;DWORD		; return number of items in queue<br />	Clear proto &#58;DWORD<br /><br />	Enqueue proto &#58;DWORD, &#58;DWORD	; push an item in back of queue<br />	Dequeue proto &#58;DWORD		; pop an item from front of queue<br /><br />	Front proto &#58;DWORD		; return front item<br />	Back proto &#58;DWORD		; return back item<br /><br />	IF DEBUG<br />	Debug_Print proto &#58;DWORD<br />	ENDIF<br /><br />	private<br /><br />	__count		DWORD 0<br />	__front		DWORD NULL<br />	__back		DWORD NULL<br />	_granularity	DWORD 0<br /><br />	_handle		DWORD NULL<br />	_blocks		DWORD 0<br /><br />CQUEUE endc<br /><br /><br /><br />CQUEUE segment<br /><br />	Create proc USES ebx esi _this, _granularity<br />		mov	ebx, _this &lt;@CurClass&#58;&#58;queue&gt;<br />		mov	esi, _granularity<br /><br />		cmp	queue.count, 0<br />		jne	_x<br /><br />		mov	queue.granularity, esi<br /><br />		test	esi, esi<br />		je	_x<br /><br />		invoke GetProcessHeap<br />		invoke HeapAlloc, eax, NULL, esi<br /><br />		test	eax, eax<br />		je	_x<br /><br />		mov	queue.handle, eax<br />; ### How?<br />		invoke Clear, ebx<br /><br />		mov	eax, ebx<br />		.ret<br />	_x&#58;<br />		xor	eax, eax<br />		.ret<br />	Create endp<br /><br /><br />	Count PROC _this<br />		mov	edx, _this &lt;@CurClass&#58;&#58;queue&gt;<br />		.ret	queue._count<br />	Count ENDP<br /><br />	Clear PROC _this<br />		mov	edx, _this &lt;@CurClass&#58;&#58;queue&gt;<br />		xor	eax, eax<br />		mov	ecx, queue.handle<br />		mov	queue._count, eax<br />		mov	queue._front, ecx<br />		mov	queue._back, ecx<br />		.ret<br />	Clear ENDP<br /><br /><br />	Enqueue PROC item, _this<br />		mov	edx, _this &lt;@CurClass&#58;&#58;queue&gt;<br />		inc	queue._count<br /><br />		.ret<br />	Enqueue ENDP<br /><br />	Dequeue PROC _this<br />		mov	edx, _this &lt;@CurClass&#58;&#58;queue&gt;<br />		dec	queue._count<br /><br />		.ret<br />	Dequeue ENDP<br /><br /><br />	Front PROC _this<br />		mov	edx, _this &lt;@CurClass&#58;&#58;queue&gt;<br />		mov	ecx, queue._front<br />		.ret	DWORD PTR &#91;ecx&#93;<br />	Front ENDP<br /><br />	Back PROC _this<br />		mov	edx, _this &lt;@CurClass&#58;&#58;queue&gt;<br />		mov	ecx, queue._back<br />		.ret	DWORD PTR &#91;ecx&#93;<br />	Back ENDP<br /><br /><br />	IF DEBUG<br />	Debug_Print PROC uses ebx esi edi, _this<br />		mov	edx, _this &lt;@CurClass&#58;&#58;queue&gt;<br />		; Output hex DWORDs from front of queue to back<br />		<br />		.ret<br />	Debug_Print ENDP<br />	ENDIF<br /><br />CQUEUE ends</code></pre></div>
    <div class="meta">Posted on 2003-05-04 09:57:56 by bitRAKE</div>
   </div>
   <div class="post" id="post-101144">
    <div class="subject"><a href="#post-101144">MASM Object Preprocessor</a></div>
    <div class="body">Hey bitRAKE<br /><br /><em>What is the proper way to call a class function from within the class.</em><br /><br />All class members are accessed thru the class symbol.<br />The preprocessor determines the member type and generates the appropriate output.<br /><br /><pre><code><br />	mov queue.granularity, esi	; access data<br /><br />	invoke queue.Clear		; access method<br /></code></pre><br /><br /><em>Am I correct in assuming my 'IF DEBUG's will break the class?</em><br /><br />Well yes and no.<br />The preprocessor will find the debug method inside the ( IF DEBUG ) block and will add it to the class definition.<br />If you invoke the debug method from inside an ( IF DEBUG ) block, which I assume will be the case, everything works fine since MASM handles these.<br />If you invoke the debug method outside an ( IF DEBUG ) block then MASM will spit the dummy.<br />If the debug method is virtual or abstract, the class structure will contain a method pointer regardless of the DEBUG state.<br /><br /><pre><code><br />	invoke queue.Debug_Print	; MASM won't be able to find the proc<br /><br />	IF DEBUG<br />	invoke queue.Debug_Print	; works fine<br />	ENDIF<br /></code></pre><br /><br /><em>Please point out any errors, supply more examples, etc...</em><br /><br />No syntax errors, but there's a error in the Create method.<br />Since you also have a Count method the preprocessor was treating it as a method call, I'll add some code to trap this later.<br />I'm currently OOPing the preprocessor so I'll post some of the classes I create.<br /><br /><pre><code><br />	cmp queue.count, 0<br /><br />	; should be<br /><br />	cmp queue._count, 0<br /></code></pre><br /><br /><em>The .ret macro from the other thread isn't in the distribution.</em><br /><br />The <strong>.ret</strong> macro isn't a requirement for the preprocessor, but I'll add it to the next release.<br /><br />Maelstrom</div>
    <div class="meta">Posted on 2003-05-04 18:08:12 by Maelstrom</div>
   </div>
   <div class="post" id="post-101203">
    <div class="subject"><a href="#post-101203">MASM Object Preprocessor</a></div>
    <div class="body">Im trying to preprocess you CFILE example as a starting point, but im not getting to far.. i keep getting your dlg box pop-up.<br /><br />Can you expand on the command line requirements again?  Im lost with the include bit... <br /><br />Do i need to provide the path to the oop files? (current directroy, ie.  run mo.exe from the current directroy and also provide the path in the -i:\D:\masm32\acitve\oop as well?<br /><br />I have made a sub directory &quot;out&quot; for output.  I dont think this is the fault..<br /><br />The architecture looks good, im eager to get going on it.. but for now this is a stumping point.  <br /><br />:NaN:<br />:stupid:</div>
    <div class="meta">Posted on 2003-05-04 22:01:09 by NaN</div>
   </div>
   <div class="post" id="post-101205">
    <div class="subject"><a href="#post-101205">MASM Object Preprocessor</a></div>
    <div class="body">Whoo hooo!<br /><br />I got an output.. but i have a bunch of .ret that are no good ;)<br /><br /><br />Now im getting somewhere....</div>
    <div class="meta">Posted on 2003-05-04 22:08:33 by NaN</div>
   </div>
   <div class="post" id="post-101207">
    <div class="subject"><a href="#post-101207">MASM Object Preprocessor</a></div>
    <div class="body">I put <strong>mo.exe</strong> in a directory, then created two directories: one called <strong>.\samples</strong> and another <strong>.\out</strong>.  With <strong>mo.exe</strong> is a batch file called <strong>samples.bat</strong>:<pre><code>mo -i\samples -o\out *.asm</code></pre>I've been creating some test and just throw 'em in the samples directory and double click the bat.  Might want to do something like this for the distribution?  I want to build a little test/debug shell for every class.</div>
    <div class="meta">Posted on 2003-05-04 22:31:23 by bitRAKE</div>
   </div>
   <div class="post" id="post-101210">
    <div class="subject"><a href="#post-101210">MASM Object Preprocessor</a></div>
    <div class="body"><strong>bitRAKE</strong><br /><br />Just noticed on the Enqueue method, the THIS ptr must be first, probably just a typo tho ;)<br /><br /><strong>NaN</strong><br /><br />Sorry about the lack of docs.<br /><br /><pre><code><br />mo -i&#58;&#91;include dir&#93; -o&#58;&#91;output dir&#93; filespec<br /></code></pre><br /><br />You must run the preprocessor from the directory that contains the source you want to process.<br /><br />The include directory is the directory where your includes are, the same directory you supply to ML for windows.inc, kernel32.inc, etc<br />I only have a single include directory but I'll add support for multiple directories later.<br />The preprocessor checks this directory if it can't locate an included file in the current directory<br /><br />The output directory will recieve the processed files.<br /><br />This is the commandline I use with relative paths. I call it using a shortcut to a batch file.<br /><br /><pre><code><br />mo -i&#58;\RADASM\MASM\INC -o&#58;\RADASM\OUT *.asm<br /></code></pre><br /><br />Just change the <strong>.ret</strong> to a normal <strong>ret</strong>, I think all the return values in the file example are already in EAX.<br /><br />Maelstrom</div>
    <div class="meta">Posted on 2003-05-04 22:42:01 by Maelstrom</div>
   </div>
   <div class="post" id="post-101211">
    <div class="subject"><a href="#post-101211">MASM Object Preprocessor</a></div>
    <div class="body"><div class="quote"><em>Originally posted by Maelstrom </em><br />Just noticed on the Enqueue method, the THIS ptr must be first, probably just a typo tho ;)<br /></div>Hey, just seeing if you were paying attention - or rather the preprocessor. :)<br /><br />Thanks, for coming through with a slick tool!</div>
    <div class="meta">Posted on 2003-05-04 22:51:41 by bitRAKE</div>
   </div>
   <div class="post" id="post-101213">
    <div class="subject"><a href="#post-101213">MASM Object Preprocessor</a></div>
    <div class="body">I seriously need a working example to see how it is intended to work...  I getting pre-processed output, but im haveing a hell of a time using it.  Its probably my only style of coding that is to blame, but i dont have much to work on here.<br /><br />I finally got it to parse and build multiple outputs:<br />My framework:<pre><code>	DataClass class<br /><br />		Data1 dd 0     ; Data value 1<br />		Data2 dd 20    ; Data value 2<br />		<br />		Destructor*    proto lpThis&#58;DWORD<br />		GetData1       PROTO lpThis&#58;DWORD<br />		GetData2       PROTO lpThis&#58;DWORD<br />		SetData1       PROTO lpThis&#58;DWORD, mydata&#58;DWORD<br />		SetData2       PROTO lpThis&#58;DWORD, mydata&#58;DWORD<br />		<br />      private<br />      <br />      AddData        PROTO lpThis&#58;DWORD<br />      Data3    dd 0<br /><br />	DataClass endc<br /><br />;--------------------------------------------------------------------------------<br />DataClass segment<br /><br />   GetData1 proc USES ebx edi esi _this&#58;DWORD<br />      <br />      mov ebx, _this &lt;@CurClass&#58;&#58;Data&gt;<br />   <br />   	ret<br />   GetData1 endp<br />   <br />   <br />   <br />   <br />   GetData2 proc USES ebx edi esi _this&#58;DWORD<br />      <br />      mov ebx, _this &lt;@CurClass&#58;&#58;Data&gt;<br />   <br />   	ret<br />   GetData2 endp<br />   <br />   <br />   <br />   <br />   SetData1 proc USES ebx edi esi _this&#58;DWORD, mydata&#58;DWORD<br />      <br />      mov ebx, _this &lt;@CurClass&#58;&#58;Data&gt;<br />   <br />   	ret<br />   SetData1 endp<br />   <br />   <br />   <br />   <br />   SetData2 proc USES ebx edi esi _this&#58;DWORD, mydata&#58;DWORD<br />      <br />      mov ebx, _this &lt;@CurClass&#58;&#58;Data&gt;<br />   <br />   	ret<br />   SetData2 endp<br /><br />   <br />   <br />   <br />   AddData proc USES ebx edi esi _this&#58;DWORD<br />      <br />      mov ebx, _this &lt;@CurClass&#58;&#58;Data&gt;<br />      <br />   	ret<br />   AddData endp<br />   <br />	<br />	<br />	Destructor proc USES ebx edi esi _this&#58;DWORD<br />		<br />		mov ebx, _this &lt;@CurClass&#58;&#58;Data&gt;<br /><br />		ret<br />	Destructor endp   <br /><br />DataClass ends</code></pre><br /><br />Seing this is only a &quot;class&quot; i still have to use it.   I discovered the &quot;include&quot; directive is funny in that it has two roles (for pre-processing its only to include other files to be preprocessed), alternately in MASM its to, well, include ;)<br /><br />To beat back the error i keep getting from this, i decided to make a oop code file (OCode.asm):<pre><code>.data<br />   include OOP.inc<br /><br />.code<br />.new  ebx, DataClass&#58;&#58;Obj<br /><br /><br />.delete Obj</code></pre><br /><br />I can cleanly preprocess this file with the command line &quot;mo -i:.\in -o:.\out ocode.asm&quot;, which generates an OOP.inc file and a OCode.asm file in my out directory.  <br /><br />Lastly i have a test file to wrap it all into a windows exe: <pre><code>.386<br />.model flat,stdcall<br />option casemap&#58;none<br /><br />   include D&#58;\masm32\include\_Macros_.inc<br />   INCPATH D&#58;\masm32<br />   INCHDR  windows, kernel32, user32, masm32, shell32, gdi32, debug<br />   INCLIB  kernel32, user32, masm32, shell32, gdi32, debug<br /><br />   include preprocessor.inc <br /><br />.data<br /><br /><br />.code<br />start&#58;<br />push ebx<br /><br />include ocode.asm<br /><br /><br /><br />pop ebx<br />invoke ExitProcess, NULL<br /><br />end start<br />end</code></pre><br /><br />Im including my OOP code hopin it will insert the translated code, but its not.  Im getting alot of errors from this<pre><code>Microsoft &#40;R&#41; Macro Assembler Version 6.14.8444<br />Copyright &#40;C&#41; Microsoft Corp 1981-1997.  All rights reserved.<br /><br /> Assembling&#58; D&#58;\masm32\_ACTIVE\oop\Mo100\Test.asm<br />D&#58;\masm32\_ACTIVE\oop\Mo100\OOP.inc&#40;1&#41; &#58; error A2008&#58; syntax error &#58; DataClass<br />D&#58;\masm32\_ACTIVE\oop\Mo100\OOP.inc&#40;6&#41; &#58; error A2008&#58; syntax error &#58; *<br />D&#58;\masm32\_ACTIVE\oop\Mo100\OOP.inc&#40;12&#41; &#58; error A2008&#58; syntax error &#58; private<br />D&#58;\masm32\_ACTIVE\oop\Mo100\OOP.inc&#40;17&#41; &#58; error A2008&#58; syntax error &#58; DataClass<br />D&#58;\masm32\_ACTIVE\oop\Mo100\ocode.asm&#40;5&#41; &#58; error A2008&#58; syntax error &#58; ebx<br />D&#58;\masm32\_ACTIVE\oop\Mo100\ocode.asm&#40;8&#41; &#58; error A2008&#58; syntax error &#58; .delete<br />D&#58;\masm32\_ACTIVE\oop\Mo100\OOP.inc&#40;24&#41; &#58; error A2020&#58; identifier not a record &#58; _this<br />D&#58;\masm32\_ACTIVE\oop\Mo100\OOP.inc&#40;34&#41; &#58; error A2020&#58; identifier not a record &#58; _this<br />D&#58;\masm32\_ACTIVE\oop\Mo100\OOP.inc&#40;44&#41; &#58; error A2020&#58; identifier not a record &#58; _this<br />D&#58;\masm32\_ACTIVE\oop\Mo100\OOP.inc&#40;54&#41; &#58; error A2020&#58; identifier not a record &#58; _this<br />D&#58;\masm32\_ACTIVE\oop\Mo100\OOP.inc&#40;64&#41; &#58; error A2020&#58; identifier not a record &#58; _this<br />D&#58;\masm32\_ACTIVE\oop\Mo100\OOP.inc&#40;73&#41; &#58; error A2020&#58; identifier not a record &#58; _this<br />_<br />Assembly Error</code></pre><br /><br />If you have a simple, start to finish, example it would be appreciated.  Thanx.<br /><br />PS: Oh by the way i altered your preprocessor.inc slightly to add:<pre><code>ifndef PREPROCESSOR_INC<br />Option DOTNAME<br />.data</code></pre><br /><br />At the beginning.  As well im not sure your &quot;sizeof Class/4&quot; at the init macro will work in all cases.  If for any reason your class is not integer multiples of 4 in length it will not copy the last of the init data.  (This can easily be done by adding a word or byte data member).<br /><br />:NaN:</div>
    <div class="meta">Posted on 2003-05-04 22:56:51 by NaN</div>
   </div>
   <div class="post" id="post-101216">
    <div class="subject"><a href="#post-101216">MASM Object Preprocessor</a></div>
    <div class="body">Finally figured it out and got it to compile with masm!<br /><br />But i discovered a bug along the way.<br /><br />The &quot;include&quot; directive parsing.  What is happening is im including a standard set of macros i use, one of which is the INCHRD macro that takes variable arguments and includes them one at a time.  The macro is defined:<pre><code>INCHDR MACRO arg1&#58;REQ, arg2&#58;=&lt;&gt;, arg3&#58;=&lt;&gt;, arg4&#58;=&lt;&gt;, arg5&#58;=&lt;&gt;, arg6&#58;=&lt;&gt;, arg7&#58;=&lt;&gt;, arg8&#58;=&lt;&gt;, arg9&#58;=&lt;&gt;, arg0&#58;=&lt;&gt;<br />   @CatStr&#40; &lt;include &gt;,%MASM_Inc_Path,&lt;\include\&gt;,&lt;&amp;arg1&gt;,&lt;.inc&gt; &#41;<br />   ifnb &lt;arg2&gt;<br />      @CatStr&#40; &lt;include &gt;,%MASM_Inc_Path,&lt;\include\&gt;,&lt;&amp;arg2&gt;,&lt;.inc&gt; &#41;<br />   endif<br />   ifnb &lt;arg3&gt;<br />      @CatStr&#40; &lt;include &gt;,%MASM_Inc_Path,&lt;\include\&gt;,&lt;&amp;arg3&gt;,&lt;.inc&gt; &#41;<br />   endif<br />   ifnb &lt;arg4&gt;<br />      @CatStr&#40; &lt;include &gt;,%MASM_Inc_Path,&lt;\include\&gt;,&lt;&amp;arg4&gt;,&lt;.inc&gt; &#41;<br />   endif<br />   ifnb &lt;arg5&gt;<br />      @CatStr&#40; &lt;include &gt;,%MASM_Inc_Path,&lt;\include\&gt;,&lt;&amp;arg5&gt;,&lt;.inc&gt; &#41;<br />   endif<br />   ifnb &lt;arg6&gt;<br />      @CatStr&#40; &lt;include &gt;,%MASM_Inc_Path,&lt;\include\&gt;,&lt;&amp;arg6&gt;,&lt;.inc&gt; &#41;<br />   endif<br />   ifnb &lt;arg7&gt;<br />      @CatStr&#40; &lt;include &gt;,%MASM_Inc_Path,&lt;\include\&gt;,&lt;&amp;arg7&gt;,&lt;.inc&gt; &#41;<br />   endif<br />   ifnb &lt;arg8&gt;<br />      @CatStr&#40; &lt;include &gt;,%MASM_Inc_Path,&lt;\include\&gt;,&lt;&amp;arg8&gt;,&lt;.inc&gt; &#41;<br />   endif<br />   ifnb &lt;arg9&gt;<br />      @CatStr&#40; &lt;include &gt;,%MASM_Inc_Path,&lt;\include\&gt;,&lt;&amp;arg9&gt;,&lt;.inc&gt; &#41;<br />   endif<br />   ifnb &lt;arg0&gt;<br />      @CatStr&#40; &lt;include &gt;,%MASM_Inc_Path,&lt;\include\&gt;,&lt;&amp;arg0&gt;,&lt;.inc&gt; &#41;<br />   endif<br />ENDM</code></pre><br /><br />This itself has the key word &quot;include&quot; within it!  The pre-processor is getting hung up on this trying to include these and giving me errors.  I tried simply commenting it out and uncommenting after pre-processsing.  This works, except the preprocessor ignors all comments.  So to get around this, I've been placeing an &quot;A&quot; infront of the work &quot;include&quot; to fool the preprocessor.<br /><br />As well, it would be nice to see the outputs code with comments, as well as their origional line spacing (asthetics i realize ~ but feedback none the less ;)  )<br /><br />PS: I have since realized my mistake with the &quot;-i:&quot; param field, and have totaly abandoned the OCode.asm file and inserted the .new and .destroy directly into the test.asm file (posted previously).<br /><br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-05-04 23:18:18 by NaN</div>
   </div>
   <div class="post" id="post-101228">
    <div class="subject"><a href="#post-101228">MASM Object Preprocessor</a></div>
    <div class="body"><strong>NaN</strong><br /><br />Well it's official, I stink at explaining things :grin:<br /><br />OK let's take this one step at a time shall we, assume the following<br /><br />- include directory is \MASM\INC<br />- output directory is \MASM\OUT<br />- source directory is \MASM\SRC<br /><br />Starting in the <strong>source</strong> directory we call the preprocessor to process our code using the following commandline<br /><br /><pre><code><br />mo -i&#58;\MASM\INC -o&#58;\MASM\OUT *.asm<br /></code></pre><br /><br />Now, if all goes well our code has been processed and ALL processed files are in the <strong>output</strong> directory.<br />Now we compile the code in the <strong>output</strong> directory and if murphy isn't looking we should have an EXE/DLL/LIB whatever.<br />The preprocessor will process ALL files defined on the commandline and in the code ( includes ). You don't have to process only the files that contain OOP code, process EVERYTHING.<br />I hope thats clarified things, but if it doesn't email me and I'll send you a test proggy.<br /><br />With reference to the new macro, I agree, but you're free to modify this macro and I only wanted to supply something simple to start with. Currently I have mine calling custom AllocateObject/FreeObject functions which tell me if I've forgotten to release any objects. Leaving comments in the output can be done easily, but I'll have to change some code to allow the formatting, I'll see what I can do.<br /><br /><em>i discovered a bug along the way. The &quot;include&quot; directive parsing</em><br /><br />Ah, keywords inside macros, didn't think of that. Should be able to fix that fairly easily if I watch for the MACRO/ENDM keywords.<br />Do you think this might also be a probem with EQUs?<br /><br />I also found a bug, the following will not work<br /><br /><pre><code><br />CBLAH class<br /><br />	Destructor* proto _this&#58;DWORD<br /><br />CBLAH endc<br /></code></pre><br /><br />The underscore in _this makes the preprocessor spit the dummy on any method proto.<br /><br />Now I've noticed that both you and bitRAKE are naming the THIS ptr ( _this ), you can name it anything you like.<br /><br />Maelstrom</div>
    <div class="meta">Posted on 2003-05-05 00:48:54 by Maelstrom</div>
   </div>
   <div class="post" id="post-101347">
    <div class="subject"><a href="#post-101347">MASM Object Preprocessor</a></div>
    <div class="body">Thanks, im sorry to be badgering you on this.  I did figure that out last night from your previous posts (but is nice to see it clearly now ;) )<br /><br /><strong>My problem is im getting this error:</strong><br /><br />warning - oop.inc ( line 25 ) member not found<br /><br /><strong>From a command line preprocess:</strong><br /><br />mo -i:\masm32\include -o:.\out test.asm<br /><br /><strong>Here is the Test.asm</strong><pre><code>.386<br />.model flat,stdcall<br />option casemap&#58;none<br /><br />   ainclude D&#58;\masm32\include\_Macros_.inc<br />   INCPATH D&#58;\masm32<br />   INCHDR  windows, kernel32, user32, masm32, shell32, gdi32, debug<br />   INCLIB  kernel32, user32, masm32, shell32, gdi32, debug<br /><br />   include preprocessor.inc <br />   include oop.inc<br /><br />.code<br />start&#58;<br />push ebx<br /><br />.new  ebx, DataClass&#58;&#58;Obj<br /><br />.delete Obj<br /><br />pop ebx<br />invoke ExitProcess, NULL<br /><br />end start<br />end</code></pre>And here is the OOP.INC<pre><code>	DataClass class<br /><br />		Data1 dd 0     ; Data value 1<br />		Data2 dd 20    ; Data value 2<br />		<br />		Destructor*    proto lpThis&#58;DWORD<br />		GetData1       PROTO lpThis&#58;DWORD<br />		GetData2       PROTO lpThis&#58;DWORD<br />		SetData1       PROTO lpThis&#58;DWORD, mydata&#58;DWORD<br />		SetData2       PROTO lpThis&#58;DWORD, mydata&#58;DWORD<br />		<br />      private<br />      <br />      AddData        PROTO lpThis&#58;DWORD<br />      Data3    dd 0<br /><br />	DataClass endc<br /><br />DataClass segment<br /><br />   GetData1 proc USES ebx edi esi _this&#58;DWORD<br />      <br />      mov ebx, _this &lt;@CurClass&#58;&#58;Da&gt;<br />&#91;color=red&#93;&#91;size=18&#93;&#91;b&#93;      mov eax, Da.Data1&#91;/b&#93;&#91;/size&#93;&#91;/color&#93;<br />   <br />   	ret<br />   GetData1 endp<br />   <br />   <br />   <br />   <br />   GetData2 proc USES ebx edi esi _this&#58;DWORD<br />      <br />      mov ebx, _this &lt;@CurClass&#58;&#58;Da&gt;<br />      mov eax, Da.Data2<br />   	ret<br />   GetData2 endp<br />   <br />   <br />   <br />   <br />   SetData1 proc USES ebx edi esi _this&#58;DWORD, mydata&#58;DWORD<br />      <br />      mov ebx, _this &lt;@CurClass&#58;&#58;Da&gt;<br />      mov eax, mydata<br />      mov Da.Data1, eax<br />   	ret<br />   SetData1 endp<br />   <br />   <br />   <br />   <br />   SetData2 proc USES ebx edi esi _this&#58;DWORD, mydata&#58;DWORD<br />      <br />      mov ebx, _this &lt;@CurClass&#58;&#58;Da&gt;<br />      mov eax, mydata<br />      mov Da.Data2, eax<br />   	ret<br />   SetData2 endp<br /><br />   <br />   <br />   <br />   AddData proc USES ebx edi esi _this&#58;DWORD<br />      <br />      mov ebx, _this &lt;@CurClass&#58;&#58;Data&gt;<br />      <br />   	ret<br />   AddData endp<br />   <br />	<br />	<br />	Destructor proc USES ebx edi esi _this&#58;DWORD<br />		<br />		mov ebx, _this &lt;@CurClass&#58;&#58;Data&gt;<br /><br />		ret<br />	Destructor endp   <br /><br />DataClass ends</code></pre>I have BOLDED line 25 for you above.  Its not recognizing the label I have assigned.  Or im misunderstanding how to use this assignment scheme... can you correct me here??<br /><br />PS: I think i found another bug.  You can not do this:<br /><strong>SetData1 proc USES ebx edi esi _this:DWORD,  <em>data</em>:DWORD</strong>.<br />It will replace it with:<br /><strong>SetData1 proc USES ebx edi esi _this:DWORD,  <em>ebx</em>:DWORD</strong>. This generates a compile error (obviously) ;) .<br /><br /><br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-05-05 16:53:19 by NaN</div>
   </div>
   <div class="post" id="post-101354">
    <div class="subject"><a href="#post-101354">MASM Object Preprocessor</a></div>
    <div class="body"><strong>NaN</strong><br /><br />Badger away, I don't mind at all :)<br /><br />I should have picked this up earlier but when defining data inside the CLASS/ENDC block you must prefix the data names with an underscore.<br />The preprocessor uses the underscore to tell the difference between data and methods.<br />The underscore does not become part of the data name but if you do want to start your data names with an underscore, simply prefix two underscores.<br /><br /><pre><code><br />	Data1 dd 0     ; Data value 1<br />	Data2 dd 20    ; Data value 2<br /><br />	; should be<br /><br />	_Data1 dd 0<br />	_Data2 dd 20<br /><br />	; use two underscores to add an underscore to the data name<br /><br />	__Data1 dd 0<br />	__Data2 dd 20<br /></code></pre><br /><br /><em>PS: I think i found another bug.</em><br /><br />Nuts, it's processing the line before I flush the symbols from the previous method, I'll look into it :alright:<br /><br />Maelstrom</div>
    <div class="meta">Posted on 2003-05-05 17:56:38 by Maelstrom</div>
   </div>
   <div class="post" id="post-101370">
    <div class="subject"><a href="#post-101370">MASM Object Preprocessor</a></div>
    <div class="body">Nice! Now im getting somewhere ;)<br /><br />Thanx!  I remember reading about the underscore but i thought it applied for special protected modes... i didnt realize it was for all cases!  Thanx!<br /><br />I look forward to playing around with inheritance now ;)<br /><br />I wonder if my stupidity will find another bug :tongue: .  Now that i its OOP'n i have to say its pretty cool!  Will have more to say shortly ;)<br /><br />Thanx for the assistance..<br />:alright:<br />NaN</div>
    <div class="meta">Posted on 2003-05-05 19:26:57 by NaN</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=12946&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=12946&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="12946" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=12946&amp;page=2">&gt;</a><a href="../?id=12946&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>