<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Iczelion' tutorials convertion problems - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=13289" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=13289">Iczelion' tutorials convertion problems</a></p>
   <div class="post" id="post-103066">
    <div class="subject"><a href="#post-103066">Iczelion' tutorials convertion problems</a></div>
    <div class="body">Hi All,<br /><br />I need your help. I stuck with Icz tutorial #31 Listview Control:<br /><br /><pre><code><br />//Iczelion's tutorial #31&#58; Listview Control<br />program aListView;<br /><br />#include&#40;&quot;w.hhf&quot;&#41;<br />#include&#40;&quot;comctl32.hhf&quot;&#41;<br /><br />readonly<br />	ClassName &#58; string &#58;= &quot;ListViewWinClass&quot;;<br />	AppName &#58; string &#58;= &quot;Testing a ListView Control&quot;;<br />	ListViewClassName &#58; string &#58;= &quot;SysListView32&quot;;<br />	FileNamePattern &#58; string &#58;= &quot;*.*&quot;;<br />	template &#58; string &#58;= &quot;%lu&quot;;<br />	Heading1 &#58; string &#58;= &quot;Filename&quot;;<br />	Heading2 &#58; string &#58;= &quot;Size&quot;;<br />	<br />static<br />	hInstance &#58; dword;<br />	FileNameSortOrder &#58; dword &#58;= 0;<br />	SizeSortOrder &#58; dword &#58;= 0;<br />	hMenu &#58; dword;<br />	hList &#58; dword;<br />	wsprintf &#58; procedure&#40;p0&#58;dword;p1&#58;dword;p2&#58;dword&#41;;<br />			   @cdecl;<br />			   external&#40;&quot;__imp__wsprintfA&quot;&#41;;<br /><br />procedure InsertColumn;<br />static<br />		lvc &#58; w.LV_COLUMN;<br /><br />begin InsertColumn;<br />	mov&#40; w.LVCF_TEXT | w.LVCF_WIDTH, lvc.imask &#41;;<br />	mov&#40; Heading1, lvc.pszText &#41;;<br />	mov&#40; 150, lvc.lx&#41;;<br />	w.SendMessage&#40;hList, w.LVM_INSERTCOLUMN,0,&amp;lvc&#41;;<br />	or&#40; w.LVCF_FMT, lvc.imask&#41;;<br />	mov&#40; w.LVCFMT_RIGHT, lvc.fmt&#41;;<br />	mov&#40; Heading2, lvc.pszText &#41;;<br />	mov&#40; 100, lvc.lx&#41;;<br />	w.SendMessage&#40;hList, w.LVM_INSERTCOLUMN, 1 ,&amp;lvc	&#41;;<br />end InsertColumn;<br /><br /><br />procedure ShowFileInfo&#40;row&#58;DWORD; lpFind&#58;DWORD&#41;; //uses edi<br />static<br />	lvi &#58; w.LV_ITEM;<br />	buffer &#58; BYTE&#91;20&#93;;<br />			 <br />begin ShowFileInfo;<br />push&#40;edi&#41;;<br />	mov&#40; lpFind,edi&#41;;<br />	mov&#40; w.LVIF_TEXT | w.LVIF_PARAM, lvi.imask&#41;;<br />	mov&#40;row, lvi.iItem&#41;;<br />	mov&#40; 0, lvi.iSubItem&#41;;<br />	lea&#40; eax,&#40;type w.WIN32_FIND_DATA &#91;edi&#93;&#41;.cFileName&#41;;<br />	mov&#40; eax, lvi.pszText&#41;;<br />	mov&#40;row, lvi.lParam&#41;;<br />	w.SendMessage&#40;hList, w.LVM_INSERTITEM,0, &amp;lvi&#41;;<br />	mov&#40; w.LVIF_TEXT, lvi.imask&#41;;<br />	inc&#40; lvi.iSubItem&#41;;<br />	wsprintf&#40;&amp;buffer, template,&#40;type w.WIN32_FIND_DATA &#91;edi&#93;&#41;.nFileSizeLow&#41;;<br />	lea&#40; eax,buffer&#41;;<br />	mov&#40; eax, lvi.pszText&#41;;<br />	w.SendMessage&#40;hList,w.LVM_SETITEM, 0,&amp;lvi&#41;;<br />pop&#40;edi&#41;;<br />end ShowFileInfo;<br /><br />procedure FillFileInfo; //uses edi<br />static<br />	finddata&#58; w.WIN32_FIND_DATA;<br />	FHandle &#58; DWORD;<br /><br />begin FillFileInfo;<br />push&#40;edi&#41;;<br />	w.FindFirstFile&#40;FileNamePattern,&amp;finddata&#41;;<br />	if&#40; eax &lt;&gt; w.INVALID_HANDLE_VALUE&#41; then;<br />		mov&#40; eax, FHandle&#41;;<br />		xor&#40; edi,edi&#41;;<br />		while&#40; eax &lt;&gt; 0&#41; do;<br />			test&#40; w.FILE_ATTRIBUTE_DIRECTORY, finddata.dwFileAttributes &#41;;<br />			if&#40; @z &#41; then;<br />				 ShowFileInfo&#40;edi, &amp;finddata&#41;;<br />				inc&#40; edi&#41;;<br />			endif;<br />			w.FindNextFile&#40;FHandle, &amp;finddata&#41;;<br />		endwhile;<br />		w.FindClose&#40; FHandle&#41;;<br />	endif;<br />	pop&#40;edi&#41;;<br />end FillFileInfo;<br /><br />procedure WndProc&#40;hWnd&#58;dword; uMsg&#58;uns32; wParam&#58;dword; lParam&#58;dword&#41;;@nodisplay;@stdcall; <br />	<br />begin WndProc;<br /><br />	if&#40; uMsg = w.WM_CREATE&#41;then;<br />		w.CreateWindowEx&#40; NULL,  ListViewClassName, NULL, <br />								w.LVS_REPORT | w.WS_CHILD | w.WS_VISIBLE, 0,0,0,0,hWnd, <br />								NULL, hInstance, NULL&#41;;<br />		mov&#40; eax, hList &#41;;<br />		InsertColumn&#40;&#41;;<br />		FillFileInfo&#40;&#41;;<br />	elseif&#40; uMsg = w.WM_SIZE&#41; then;<br />		mov&#40; lParam, eax &#41;;<br />		mov&#40; eax, edx &#41;;<br />		and&#40; $ffff, eax &#41;;<br />		shr&#40; 16, edx &#41;;<br />		w.MoveWindow&#40;hList, 0, 0, eax,edx,true&#41;;<br />	elseif&#40; uMsg = w.WM_DESTROY&#41; then;<br />		w.PostQuitMessage&#40;NULL&#41;;<br />	else<br />		w.DefWindowProc&#40;hWnd,uMsg,wParam,lParam	&#41;;	<br />		exit WndProc;<br />	endif;<br />	xor&#40; eax,eax&#41;;<br />end WndProc;<br />	<br /><br />procedure WinMain &#40; hInst &#58; dword; hPrevInst &#58; dword; CmdLine &#58; dword; CmdShow &#58; dword &#41;;<br />                               @nodisplay;<br /><br />var<br />	wc &#58; w.WNDCLASSEX;<br />	msg &#58; w.MSG;<br />	hwnd &#58; dword;<br /><br />begin WinMain; 	<br /> 	<br />	mov &#40; @size&#40; w.WNDCLASSEX &#41;, wc.cbSize &#41;; <br />	mov &#40; w.CS_HREDRAW | w.CS_VREDRAW , wc.style &#41;; <br />	mov &#40; &amp;WndProc, wc.lpfnWndProc &#41;; <br />	mov &#40; NULL, wc.cbClsExtra &#41;; <br />	mov &#40; NULL, wc.cbWndExtra &#41;; <br />	mov &#40; hInst, wc.hInstance &#41;; <br />	w.LoadIcon &#40; NULL, w.IDI_APPLICATION &#41;; <br />	mov &#40; eax, wc.hIconSm &#41;; <br />	mov &#40; eax, wc.hIcon &#41;; <br />	w.LoadCursor &#40; NULL, w.IDC_ARROW &#41;; <br />	mov &#40; eax, wc.hCursor &#41;; <br />	mov &#40; w.COLOR_WINDOW + 1  , wc.hbrBackground &#41;; <br />	mov &#40; ClassName, wc.lpszClassName &#41;; <br />	mov &#40; NULL, wc.lpszMenuName &#41;; <br />	<br />	w.RegisterClassEx &#40; wc&#41;; <br />	<br />	w.CreateWindowEx&#40;NULL, ClassName, AppName, w.WS_OVERLAPPEDWINDOW, <br />	w.CW_USEDEFAULT, w.CW_USEDEFAULT,w.CW_USEDEFAULT,w.CW_USEDEFAULT,<br />	NULL,NULL,hInstance, NULL&#41;; 			<br />	mov &#40; eax, hwnd &#41;; <br />	w.ShowWindow &#40; hwnd, CmdShow &#41;;<br />	w.UpdateWindow &#40; hwnd &#41;; <br />	<br />	while &#40; w.GetMessage &#40; msg , NULL, 0, 0 &#41; &lt;&gt; 0 &#41; do <br />		w.TranslateMessage &#40; msg &#41; ; <br />		w.DispatchMessage &#40; msg &#41;; <br />	endwhile; 			<br />	<br />	mov &#40; msg.wParam, eax &#41;; <br />end WinMain;<br />	<br />begin aListView;<br />	InitCommonControls&#40;&#41;;<br />	w.GetModuleHandle&#40;NULL&#41;;<br />		mov&#40;eax,hInstance&#41;;<br />    WinMain&#40; hInstance, NULL, NULL, w.SW_SHOWDEFAULT &#41;;<br />	w.ExitProcess&#40;eax&#41;;<br />end aListView;<br /><br /></code></pre><br /><br />It is only part of original code. I stripped it from much its functionality to make it look straightfoward. <br />This code creates Listview Control with two columns(Filename and Size), then it populates Filename column, <br />well, with filenames from directory where the exe resides, then it supposed to fill Size column <br />with files sizes in bytes. But it shows the size for the first file in a list only.<br /><br />If I use <a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=13157">macro wrapper </a>  for wsprintf function things go worst: program just crashes on the start. <br /><br />In attachment full code of tutorial.<br /><br />Regards, GJ</div>
    <div class="meta">Posted on 2003-05-14 14:36:21 by Green Joe</div>
   </div>
   <div class="post" id="post-104068">
    <div class="subject"><a href="#post-104068">ICZ Problem</a></div>
    <div class="body">I'm at work and don't have time to study this carefully,<br />but one quick suggestion I might make, even though it<br />means you won't do a &quot;straight-across&quot; conversion of this<br />tutorial is to look into the use of the HLA Standard Library<br />str.put function rather than using wsprintf.<br /><br />e.g.,<br /><br /><pre><code><br />static<br />    s:str.strvar(256);<br />      .<br />      .<br />      .<br />  str.put( s, &quot;i's value is&quot;, i:4, &quot; j's value is &quot;, j );<br /><br />Now the HLA string &quot;s&quot; contains something like<br />&quot;i's value is     5 j's value is 2&quot;<br /><br />Because HLA strings are zero terminated (and the string<br />variable contains the first character of the string) they are<br />generally upwards compatible to the zero-terminated strings<br />that Windows uses, so you can pass them to most Win32 API<br />functions.<br /><br />Cheers,<br />Randy Hyde</div>
    <div class="meta">Posted on 2003-05-20 12:37:54 by rhyde</div>
   </div>
   <div class="post" id="post-104099">
    <div class="subject"><a href="#post-104099">Iczelion' tutorials convertion problems</a></div>
    <div class="body">One more deadlock...<br />This time tutorial #29 &quot;Win32 Debug API part 2&quot; (Example 1).<br /><br /><pre><code><br />// Iczelion's tutorial #29&#58; &quot;Win32 Debug API Part II&quot; &#40;Example 1&#41;<br />program aDebugAPI2_1;<br /><br />#include&#40;&quot;w.hhf&quot;&#41;<br /><br />readonly<br />	AppName &#58; string &#58;= &quot;Win32 Debug Example no.2&quot;;<br />	ClassName &#58; string &#58;= &quot;SimpleWinClass&quot;;<br />	SearchFail &#58; string &#58;= &quot;Cannot find the target process&quot;;<br />	TargetPatched &#58; string &#58;= &quot;Target patched!&quot;;<br /><br />static<br />	buffer &#58; word  &#58;= $9090;<br />	DBEvent &#58; w.DEBUG_EVENT;<br />	ProcessId &#58; dword;<br />	ThreadId &#58; dword;<br />	context &#58; w.CONTEXT;<br />	<br />begin aDebugAPI2_1;<br />	w.FindWindow&#40; ClassName, NULL&#41;;<br />	if&#40; eax!= NULL&#41; then;<br />		w.GetWindowThreadProcessId&#40; eax, ProcessId&#41;;<br />		mov&#40; eax, ThreadId &#41;;<br />		w.DebugActiveProcess&#40; ProcessId&#41;;<br />		<br />	forever<br />	w.WaitForDebugEvent&#40;&amp;DBEvent, w.INFINITE&#41;;<br />	breakif&#40; DBEvent.dwDebugEventCode = w.EXIT_PROCESS_DEBUG_EVENT&#41;;<br />	if&#40; DBEvent.dwDebugEventCode = w.CREATE_PROCESS_DEBUG_EVENT&#41; then;<br />	    mov&#40; w.CONTEXT_CONTROL, context.ContextFlags &#41;;<br />	    w.GetThreadContext&#40;DBEvent.u.CreateProcessInfo.hThread, &amp;context&#41;;<br />&#91;COLOR=red&#93; w.WriteProcessMemory&#40;  DBEvent.u.CreateProcessInfo.hProcess, context.regEip , &amp;buffer, 2,  NULL &#41;;&#91;/color&#93;<br />	    w.MessageBox&#40;0, TargetPatched, AppName, w.MB_OK | w.MB_ICONINFORMATION&#41;;<br />	elseif&#40; DBEvent.dwDebugEventCode = w.EXCEPTION_DEBUG_EVENT&#41; then;<br />	    if&#40; DBEvent.u.theException.pExceptionRecord.ExceptionCode = w.EXCEPTION_BREAKPOINT&#41; then;<br />		w.ContinueDebugEvent&#40; DBEvent.dwProcessId,DBEvent.dwThreadId,w.DBG_CONTINUE &#41;;<br />		continue;<br />	    endif;<br />	endif;			<br />	w.ContinueDebugEvent&#40; DBEvent.dwProcessId,DBEvent.dwThreadId,w.DBG_EXCEPTION_NOT_HANDLED &#41;;<br />	endfor;<br />    else<br />	w.MessageBox&#40; 0, SearchFail, AppName,w.MB_OK | w.MB_ICONERROR&#41;;<br />    endif;<br />	w.ExitProcess&#40;0&#41;;<br />end aDebugAPI2_1;<br /></code></pre><br /><br />This code practically identical with Example 2 except  hilighted line. That is why I have strong feelling the promblem lies in this line.</div>
    <div class="meta">Posted on 2003-05-20 18:08:48 by Green Joe</div>
   </div>
   <div class="post" id="post-104238">
    <div class="subject"><a href="#post-104238">Iczelion' tutorials convertion problems</a></div>
    <div class="body">Hi Randy,<br /><div class="quote"><strong> quick suggestion I might make, even though it<br />means you won't do a &quot;straight-across&quot; conversion of this<br />tutorial is to look into the use of the HLA Standard Library<br />str.put function rather than using wsprintf.<br /></div> <br /><br />str.put works fine. It helped me localize an error. Problem was in macro wsprintf. <br />It popped too much bytes from stack.<br /><br />Regards,GJ</div>
    <div class="meta">Posted on 2003-05-21 15:58:01 by Green Joe</div>
   </div>
  </div>
 </body>
</html>