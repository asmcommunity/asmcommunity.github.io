<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>What boot loader that.... - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=13660" />
    <link rel="next" href="../?id=13660&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=34">OS Development</a> &raquo; <a href="../?id=13660">What boot loader that....</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=13660&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=13660&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="13660" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=13660&amp;page=2">&gt;</a><a href="../?id=13660&amp;page=2">&raquo;</a></form>   <div class="post" id="post-105827">
    <div class="subject"><a href="#post-105827">What boot loader that....</a></div>
    <div class="body">meet this criteria ?<br />1. On bynary plain ( its not the source ).<br />2. Free.<br />3. Auto Switch to Pmode.<br />4. Auto read sector 2 ( after Pmode switch ).<br /><br />So I can easyly made a kernel and place it to sector 2 on my disket.<br />:alright:</div>
    <div class="meta">Posted on 2003-06-03 03:29:09 by realvampire</div>
   </div>
   <div class="post" id="post-105895">
    <div class="subject"><a href="#post-105895">What boot loader that....</a></div>
    <div class="body">Use a little tweaked SOLAR OS boot.bin file ?<br /><br />i actually read more that one sector starting from sector 2 upwards<br /><br />check the sourcecode of boot.asm and learn where to place your kernel, aka replace system32.bin with your own kerner or even replace system16.bin...<br /><br />or i could write one for you in a few hours, eh ....minutes  but i am lazy :P</div>
    <div class="meta">Posted on 2003-06-03 15:57:42 by BogdanOntanu</div>
   </div>
   <div class="post" id="post-105896">
    <div class="subject"><a href="#post-105896">hi</a></div>
    <div class="body">Please write it for me. Im failed to studied it. My system now 1.7 Ghz Prosesor. Is it all the same ?<br />Im just woke from sleep, it still morning here.</div>
    <div class="meta">Posted on 2003-06-03 16:01:26 by realvampire</div>
   </div>
   <div class="post" id="post-105901">
    <div class="subject"><a href="#post-105901">What boot loader that....</a></div>
    <div class="body">Afternoon, realvampire.<br /><br />Have a look at:<br /><a target="_blank" href="http://osdev.neopages.net/tutorials/brunmar/tutorial_01.php">http://osdev.neopages.net/tutorials/brunmar/tutorial_01.php</a> <br /><a target="_blank" href="http://osdev.neopages.net/tutorials/brunmar/tutorial_02.php">http://osdev.neopages.net/tutorials/brunmar/tutorial_02.php</a> <br /><br />Reading those pages, as well as having a look at SolarOS, will be all you need for what you want.<br /><br />When you decide to expand on your code, then take a look at the other tuts on:<br /><a target="_blank" href="http://osdev.neopages.net/tutorials.php">http://osdev.neopages.net/tutorials.php</a> <br /><br />Also:<br />Which assembler are you coding this in?<br />Bogdans code is in Tasm.<br />It's illegal to use Masm for coding anything non-Windows.<br />I'm using Fasm.<br /><br />Are you going to build the kernal in C or assembly?<br /><br />Plus:<br />If you wish to use VESA vid modes in PMode, then you've really got to grab the info *before* switching to PMode (i.e. call int 10h inside 16-bit code).<br /><br />If you just want to muck about with the default text-mode, then the first two links I gave are all you need.<br /><br />Cheers,<br />Scronty</div>
    <div class="meta">Posted on 2003-06-03 18:03:46 by Scronty</div>
   </div>
   <div class="post" id="post-106070">
    <div class="subject"><a href="#post-106070">What boot loader that....</a></div>
    <div class="body">Thanks for the link. I found Bosch Emulator here. Im gonna try it.</div>
    <div class="meta">Posted on 2003-06-05 06:59:16 by realvampire</div>
   </div>
   <div class="post" id="post-106119">
    <div class="subject"><a href="#post-106119">What boot loader that....</a></div>
    <div class="body">Afternoon, realvampire.<br /><br />Regarding Bochs:<br /><br />It's great for when you're mucking about with a text-based or VGA-based OS, however it falls down when mucking about with VESA2 stuff (i.e. using 800*600*24bit vid mode).<br /><br />For testing your basic bootloader code, it's ideal:alright: .<br /><br />Cheers,<br />Scronty</div>
    <div class="meta">Posted on 2003-06-05 16:59:37 by Scronty</div>
   </div>
   <div class="post" id="post-106129">
    <div class="subject"><a href="#post-106129">Hi, Scronty</a></div>
    <div class="body">How to use it ? to which directory I must copy my Boot loader ? And how to tell the emulator to load it. Thanks<br /><br />My GDT is located at Mem 0000:8000. My Gdt info are <br /><pre><code><br /><br />GDTr&#58;<br />   dw 1Fh     ; Limit are 0x20 - 1. So there are 4 Ent.<br />   dd 8000   ; Located at Linier address 00008000<br /> <br /> and load GDT like This&#58;<br /> xor ax,ax<br /> mov ds,ax<br /> mov ax,8000<br /> lgdt ds&#58;&#91;ax&#93;<br /> <br /> <br /></code></pre><br /> <br /> <br />Is it Right ?</div>
    <div class="meta">Posted on 2003-06-05 18:44:55 by realvampire</div>
   </div>
   <div class="post" id="post-106188">
    <div class="subject"><a href="#post-106188">What boot loader that....</a></div>
    <div class="body">personally i think its not nessecary to switch to pm in the bootloader. furthermore you'll have very little space for your gdt. in my system i have just the copying from disk in my bootloader and the jumping to the code.<br />i think you've aleady asked for your problem somewhen else. you tell the cpu that the gdt is located at 0000:8000 - but do you know what there's in the memory? you just load the gdtr with an address. you must have at least a complete gdt in your code containing a null-selector, a code-selector, a data-selector and a stack-selector. before you load the gdtr you have to copy this gdt to 0000:8000 (-&gt;rep movsd), <strong>then</strong> you load the gdtr.<br />hope this helps</div>
    <div class="meta">Posted on 2003-06-06 13:29:59 by hartyl</div>
   </div>
   <div class="post" id="post-106269">
    <div class="subject"><a href="#post-106269">Hi hartyl</a></div>
    <div class="body">Yes I have it<br /><br /><br /><pre><code><br /><br /> jmp start   ; Skip GDT data loaded at 0000&#58;7c00<br /><br />GDTinfo&#58;     ; Jmp instruction need 2 bytes. It at 0000&#58;7c02<br />  dw 001f<br />  dd 7c08<br /><br />GDTnull &#58;    ; It at 0000&#58;7c08<br />  dd 0<br />  dd 0<br />GDTlin &#58;<br /> dw FFFF<br /> dw 0<br /> dw 9a00<br /> dw cf<br />GDTdat&#58;<br /> dw FFFF<br /> dw 0<br /> dw 9200<br /> dw cf<br /> <br />start&#58;<br /> lgdt &#91;GDTinfo&#93;<br /><br /></code></pre><br /><br />I think it was right. But it still Restarted. I upload the bin file.</div>
    <div class="meta">Posted on 2003-06-07 06:31:54 by realvampire</div>
   </div>
   <div class="post" id="post-106287">
    <div class="subject"><a href="#post-106287">What boot loader that....</a></div>
    <div class="body">weired code here... i don't get it.<br />after the lmsw-command the cpu executes the instructions in 32bit mode. also after this you should make a far intersegmented jump - to set cs:eip at once - the nop-s are not enough! (jmp 0008:00dac0de where 0008 is the code-selector). btw, i coudn't find a code-selector in your gdt.</div>
    <div class="meta">Posted on 2003-06-07 12:05:20 by hartyl</div>
   </div>
   <div class="post" id="post-106315">
    <div class="subject"><a href="#post-106315">Hi hartyl</a></div>
    <div class="body">Thank you for answering. So my GDT dont have a code selector? I dont understand it. can you explain the solution. I have read a lot of tutorial about it, but never could to do it. :alright:<br /><br />Null selector are  at CS:IP + Fh. <br />Code selector are at CS:IP + 17h.<br />Data Selector are at CS+IP + 1Fh.<br /><br />GDTdesc are at CS:IP + 9h. 001f:FFFFFF and will be modified to linear address of program, where it loaded.<br /><br />Jmp far code need 5 bytes at Real mode and 7 bytes at Pmode. the 5 nop will be changed to EA xx xx xx xx 08 00. A function at CS:IP +61d  will modified it.</div>
    <div class="meta">Posted on 2003-06-07 16:41:07 by realvampire</div>
   </div>
   <div class="post" id="post-106341">
    <div class="subject"><a href="#post-106341">What boot loader that....</a></div>
    <div class="body">heh, i've just noticed that you don't even have an idt (interrupt descriptor table), you'll need it. i also have to tell you that an idt is very big - you won't have enough space for it in your 512-bytes-bootloader, that's why i think it's not nessecary to switch to pm in bootloader.<br /><br />there are several things i don't understand in your code:<br /><pre><code><br />&#58;0001.005C E8FAFF                 call 0059 ;here you get the ip<br />&#58;0001.005F 8BD8                   mov bx, ax<br />&#58;0001.0061 0F01E0                 smsw ax<br />&#58;0001.0064 A801                   test al, 01 ;check for pm<br />&#58;0001.0066 7401                   je 0069<br />&#58;0001.0068 C3                     ret<br /><br /><br /><br />* Referenced by a &#40;U&#41;nconditional or &#40;C&#41;onditional Jump at Address&#58;<br />|&#58;0001.0066&#40;C&#41;<br />|<br />&#58;0001.0069 8BC3                   mov ax, bx ;but here... you move the ip to ax<br />&#58;0001.006B 81E300FF               and bx, FF00 ;and mask out the lower byte?<br />&#58;0001.006F 8BEB                   mov bp, bx ;save it in bp?<br />&#58;0001.0071 8CD8                   mov ax, ds <br />&#58;0001.0073 66C1E004               shl eax, 04 ;then you seem to calculate a linear address...<br />&#58;0001.0077 6603C5                 add eax, ebp ;of you gdt?<br />&#58;0001.007A 6683C00F               add eax, 0000000F<br />&#58;0001.007E 8BF5                   mov si, bp<br />&#58;0001.0080 83C60B                 add si, 000B<br />&#58;0001.0083 668904                 mov &#91;si&#93;, eax<br /></code></pre><br />then after reading from disk:<br /><pre><code><br />&#58;0001.00C0 8BC5                   mov ax, bp<br />&#58;0001.00C2 83C02F                 add ax, 002F<br />&#58;0001.00C5 FFD0                   call ax ;where do you call to?!<br />&#58;0001.00C7 8BF5                   mov si, bp ;you get this calculated address again<br />&#58;0001.00C9 83C603                 add si, 0003<br />&#58;0001.00CC 83C606                 add si, 0006<br />&#58;0001.00CF 0F0114                 lgdt &#91;si&#93; ;and load the gdtr from there?<br /></code></pre><br />i don't think that you get the correct gdtr in the end. since you have no idt you'll have a triple fault and that's why the computer resets. if you really want me to help you, please post the sourcecode, it's hard work digging in the binary.</div>
    <div class="meta">Posted on 2003-06-08 04:57:17 by hartyl</div>
   </div>
   <div class="post" id="post-106344">
    <div class="subject"><a href="#post-106344">Hi hartyl</a></div>
    <div class="body">Im happy you willing to help me help me. Yes, IP are saved to BP. it called a Function at 7c2f, that function are check key function. GDT are located at offset 9. So by put IP and then add it with 9 we are get the GDT. Function after read the Disk are used to Wait Key. <br /><br /><br />Also, I take A20 Enable Bit from your code.<br /><br /><pre><code><br />about&#58;<br />mov ax bp<br /><br />Yes, it was a useless instruction. <br />I forgot to remove it. Compile it with my compiler. <br />It gonna be painfull checking my source code.<br /></code></pre><br /><br />I dont know, the tutorial said IDT was not too important, it was optional.<br />But IDT descriptor are located after next instruction. If you compiled the source code, it will not work. I have fix my compiler and have not upload it. So, compile it with DDEB.exe</div>
    <div class="meta">Posted on 2003-06-08 05:27:32 by realvampire</div>
   </div>
   <div class="post" id="post-106388">
    <div class="subject"><a href="#post-106388">What boot loader that....</a></div>
    <div class="body">one thing i noticed: you <strong>know</strong> that your code will be loaded at 0000:7c00, so you even know at assemblertime the address of your gdt. you know where you will load your code to (0000:8000) and therefore you can use fixed values in the gdt:<br /><br /><pre><code><br />jmp 59 ;2 bytes<br />gdtr&#58;<br />dw 20 ;the gdtr, limit&#58; 20, address 7c08 &#40;physical address of gdt&#41;<br />dd 00007c08<br /><br />;null descriptor &#40;0000&#41;<br />  dw 0<br />  dw 0<br />  db 0<br />  db 0<br />  db 0<br />  db 0<br /><br />;code descriptor &#40;0008&#41;<br />  dw 0xffff ; limit 4gb limit<br />  dw 8000 ;base&#58; 00008000<br />  db 00<br />  db PRESENT or TYPE_DATA_CODE or RING0 or CODE_SEGMENT or EXECUTE_READ ;attributes, look up the equivalent bits<br />  db 0x0f or PAGE_GRANULARITY or BIG_BIT<br />  db 00<br /><br />;data descriptor &#40;0010&#41;<br />  dw 0xffff ; limit 4gb limit<br />  dw 8000 ;base&#58; 00008000<br />  db 00<br />  db PRESENT or TYPE_DATA_CODE or RING0 or DATA_SEGMENT or READ_WRITE<br />  db 0x0f or PAGE_GRANULARITY or BIG_BIT<br />  db 00<br /><br />;--==please check the values==--<br /></code></pre><br /><br />for loading the gdtr you can:<br /><pre><code><br />  mov si,gdtr<br />  lgdt &#91;si&#93;<br /></code></pre><br /><br />after<br /><pre><code><br /> smsw ax          ; Machine status Word<br /> or al,1          ;<br /> lmsw ax          ;<br /></code></pre><br />you <strong>have</strong> to load all registers with descriptor values. set cs:eip with the far jump i mentioned. then load ds, ss, gs, es with the data-descriptor (remember to set esp correctly, not that you mess the thing up).</div>
    <div class="meta">Posted on 2003-06-08 13:03:13 by hartyl</div>
   </div>
   <div class="post" id="post-106390">
    <div class="subject"><a href="#post-106390">What boot loader that....</a></div>
    <div class="body">Here is a nice boot sector:<br /><a target="_blank" href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/uuu/uuu/src/boot/eks_boot/boot.asm?rev=1.1&amp;content-type=text/vnd.viewcvs-markup">http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/uuu/uuu/src/boot/eks_boot/boot.asm?rev=1.1&amp;content-type=text/vnd.viewcvs-markup</a><br /><br />Null descriptor is never used - bytes can be filled with something else.</div>
    <div class="meta">Posted on 2003-06-08 13:23:37 by bitRAKE</div>
   </div>
   <div class="post" id="post-106409">
    <div class="subject"><a href="#post-106409">Hi hartyl</a></div>
    <div class="body">Im so sorry, but it still rebooting.<br />I passing the GDT address from register.<br /><br />My GDT are base zero, but it was loaded at base 7c08. Is it the mistake. PAGE_GRANULITY or BIG_BIT are c0h right? so the value are CFh. About the far Jump, Im jumping to 8000h with this opcode, EA 00 80 00 00 08 00 ( jmp far 0008:00008000 ), it update the EIP and CS.<br /><br />example:<br />bp=IP and the value is 7c00.<br /><br /><pre><code><br /><br />mov ax,bp  = ax are 7c00 now.<br />add ax,8    = ax are 7c08 now.<br />lgdt &#91;ax&#93;    = its same with lgdt &#91;7c08&#93;<br /><br /></code></pre><br /><br />Sorry, my compiler does not support label. Fix value are not allowwed yet. Still developing it. I need this boot for my example.</div>
    <div class="meta">Posted on 2003-06-08 17:24:09 by realvampire</div>
   </div>
   <div class="post" id="post-106446">
    <div class="subject"><a href="#post-106446">Hi, Hartyl.</a></div>
    <div class="body">Thank you, It does not rebooting again. I forgot to disable the interupt before switch. Here is the program, you can running it from DOS real mode. Im still improving it. Also, is it realy working? If It so, im gonna rebuild my compiler and make it portable on every OS.<br /><br /><br />:alright:  Thanks for your patience and kind.</div>
    <div class="meta">Posted on 2003-06-08 21:41:02 by realvampire</div>
   </div>
   <div class="post" id="post-106447">
    <div class="subject"><a href="#post-106447">hi</a></div>
    <div class="body">I forgot to atach it.<br /><br />:stupid:</div>
    <div class="meta">Posted on 2003-06-08 21:43:20 by realvampire</div>
   </div>
   <div class="post" id="post-106463">
    <div class="subject"><a href="#post-106463">hi</a></div>
    <div class="body">:confused:  Another problem occur, I cannot set ES and DS also SS and else. How to do it? I jump to a miss selector, it is 0800:00dac0de, why it valid? it does not rebooting, just hang. But when I use<br /><br /><pre><code><br /><br />mov ax,cs<br />mov ds,ax<br />mov es,ax<br /><br /></code></pre><br /><br />It does reboot?:confused: .</div>
    <div class="meta">Posted on 2003-06-09 02:33:30 by realvampire</div>
   </div>
   <div class="post" id="post-106532">
    <div class="subject"><a href="#post-106532">What boot loader that....</a></div>
    <div class="body">when i disassemble your code (result.com). at the end i get the following listing:<br /><pre><code><br />&#58;<br />&#58;<br />&#58;000001F9 0F01E0                  smsw ax<br />&#58;000001FC 0C01                    or al, 01<br />&#58;000001FE 0F01F0                  lmsw ax<br />&#58;00000201 90                      nop<br />&#58;00000202 90                      nop<br />&#58;00000203 90                      nop<br />&#58;00000204 90                      nop<br />&#58;00000205 90                      nop<br />&#58;00000206 0800                    or byte ptr &#91;eax&#93;, al ; &lt;---<br />&#58;00000208 90                      nop<br />&#58;00000209 EBFD                    jmp 00000208<br />&#58;0000020B C3                      ret<br /></code></pre><br /><br />i can't believe that the marked code is what you intended.<br />here's the code i'd use (assembled with fasm):<br /><pre><code><br />&#58;<br />&#58;<br />&#58;0001.01F9 0F01E0                 smsw ax<br />&#58;0001.01FC 0C01                   or al, 01<br />&#58;0001.01FE 0F01F0                 lmsw ax<br />&#58;0001.0201 EA08020800             jmp 0008&#58;0208 ;no NOPs before jmp, still 16bits<br /><br />;from now on use32!!<br />;NOW set the remaining selectors to es,ds,gs<br /><br />&#58;0001.0206 90                     nop<br />&#58;0001.0207 EBFD                   jmp 0205<br />&#58;<br />&#58;<br /></code></pre></div>
    <div class="meta">Posted on 2003-06-09 13:10:30 by hartyl</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=13660&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=13660&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="13660" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=13660&amp;page=2">&gt;</a><a href="../?id=13660&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>