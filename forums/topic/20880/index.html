<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Tutorial 15: Multithreading Programming - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=20880" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=17">Iczelion's Tutorials</a> &raquo; <a href="../?id=20880">Tutorial 15: Multithreading Programming</a></p>
   <div class="post" id="post-158660">
    <div class="subject"><a href="#post-158660">Tutorial 15: Multithreading Programming</a></div>
    <div class="body">Hey, All.<br />why the KillThread can&#39;t exit the ThreadProc?<br /><br />regards.<br /><br /><pre><code><br />.386<br />.model flat,stdcall<br />option casemap:none<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />WinMain proto :DWORd,:DWORD,:DWORD,:DWORD<br />KillThread proto <br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />include \masm32\include\windows.inc<br />include \masm32\include\user32.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\masm32.inc <br /><br />includelib \masm32\lib\user32.lib<br />includelib \masm32\lib\kernel32.lib<br />includelib \masm32\lib\masm32.lib<br />include \masm32\Macros\macros.asm<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.const<br />IDM_CREATE_THREAD	 equ 1<br />IDM_KILL_THREAD	 equ 3<br />IDM_EXIT		 equ 2<br />WM_FINISH	equ WM_USER+100h<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.data<br />ClassName	db &quot;Win32ASMThreadClass&quot;,0<br />AppName	db &quot;Win32 ASM MultiThreading Example&quot;,0<br />MenuName	db &quot;FirstMenu&quot;,0<br />ok	db &quot;Reset ECX, Continue running!&quot;<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.data?<br />hInstance	HINSTANCE ?<br />CommandLine	LPSTR ?<br />hMenu		HANDLE ?<br />ExitCode	DWORD ?<br />hwnd		HANDLE ?<br />ThreadID	DWORD ?<br />THandle1	DWORD ?<br />dwExitCode	DWORD ?<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.code<br />start:<br />	invoke GetModuleHandle, NULL<br />	mov? ? hInstance,eax<br />	invoke GetCommandLine<br />	mov CommandLine,eax<br />	invoke WinMain, hInstance,NULL,CommandLine, SW_SHOWDEFAULT<br />	invoke ExitProcess,eax<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />WinMain proc hInst:HINSTANCE,hPrevInst:HINSTANCE,CmdLine:LPSTR,CmdShow:DWORD<br />	LOCAL wc:WNDCLASSEX<br />	LOCAL msg:MSG<br />	mov? ?wc.cbSize,SIZEOF WNDCLASSEX<br />	mov? ?wc.style, CS_HREDRAW or CS_VREDRAW<br />	mov? ?wc.lpfnWndProc, OFFSET WndProc<br />	mov? ?wc.cbClsExtra,NULL<br />	mov? ?wc.cbWndExtra,NULL<br />	push? hInst<br />	pop? ?wc.hInstance<br />	mov? ?wc.hbrBackground,COLOR_WINDOW+1<br />	mov? ?wc.lpszMenuName,OFFSET MenuName<br />	mov? ?wc.lpszClassName,OFFSET ClassName<br />	invoke LoadIcon,NULL,IDI_APPLICATION<br />	mov? ?wc.hIcon,eax<br />	mov? ?wc.hIconSm,eax<br />	invoke LoadCursor,NULL,IDC_ARROW<br />	mov? ?wc.hCursor,eax<br />	invoke RegisterClassEx, addr wc<br />	invoke CreateWindowEx,WS_EX_CLIENTEDGE,ADDR ClassName,ADDR AppName,\<br />? ? ? ? ? ?WS_OVERLAPPEDWINDOW,CW_USEDEFAULT,\<br />? ? ? ? ? ?CW_USEDEFAULT,300,200,NULL,NULL,\<br />? ? ? ? ? ?hInst,NULL<br />	mov? ?hwnd,eax<br />	invoke ShowWindow, hwnd,SW_SHOWNORMAL<br />	invoke UpdateWindow, hwnd<br />	invoke GetMenu,hwnd<br />	mov? hMenu,eax<br />	.WHILE TRUE<br />? ? ? ? ? ? ? ? invoke GetMessage, ADDR msg,NULL,0,0<br />? ? ? ? ? ? ? ? .BREAK .IF (!eax)<br />? ? ? ? ? ? ? ? invoke TranslateMessage, ADDR msg<br />? ? ? ? ? ? ? ? invoke DispatchMessage, ADDR msg<br />	.ENDW<br />	mov? ? ?eax,msg.wParam<br />	ret<br />WinMain endp<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />WndProc proc hWnd:HWND, uMsg:UINT, wParam:WPARAM, lParam:LPARAM<br />	.IF uMsg==WM_DESTROY<br />		invoke PostQuitMessage,NULL<br />	.ELSEIF uMsg==WM_COMMAND<br />		mov eax,wParam<br />		.if lParam==0<br />			.if ax==IDM_CREATE_THREAD<br />				mov? eax,OFFSET ThreadProc<br />				invoke CreateThread,NULL,NULL,eax,\<br />? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? NULL,NORMAL_PRIORITY_CLASS,\<br />? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ADDR ThreadID<br />				mov THandle1,eax<br />			.elseif ax==IDM_KILL_THREAD<br />				invoke CreateThread,NULL,NULL,addr KillThread,\<br />? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? NULL,NORMAL_PRIORITY_CLASS,\<br />? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ADDR ThreadID<br />				invoke CloseHandle,eax<br />			.else<br />				invoke DestroyWindow,hWnd<br />			.endif<br />		.endif<br />	.ELSEIF uMsg==WM_FINISH<br />		invoke MessageBox,NULL,ADDR AppName,ADDR AppName,MB_OK<br />	.ELSE<br />		invoke DefWindowProc,hWnd,uMsg,wParam,lParam<br />		ret<br />	.ENDIF<br />	xor? ? eax,eax<br />	ret<br />WndProc endp<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />ThreadProc PROC USES ecx Param:DWORD<br />Loop2:<br />	mov? ecx,300000000<br />Loop1:	<br />	inc? eax<br />	dec? ecx<br />	.if ecx == 0<br />		invoke MessageBox,NULL,addr ok,ADDR AppName,MB_OK<br />		invoke Sleep, 2000<br />		jmp? Loop2<br />	.endif<br />	jmp Loop1<br />? ? ? ? invoke SendMessage,hwnd,WM_FINISH,NULL,NULL<br />? ? ? ? ret<br />ThreadProc ENDP<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />KillThread PROC <br />	invoke GetExitCodeThread,THandle1,addr dwExitCode<br />	invoke ExitThread,dwExitCode <br />? ? ? ? ;invoke SendMessage,hwnd,WM_FINISH,NULL,NULL<br />? ? ? ? ret<br />KillThread ENDP<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br /><br />end start<br /><br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br /></code></pre></div>
    <div class="meta">Posted on 2005-04-02 08:55:04 by dcskm4200</div>
   </div>
   <div class="post" id="post-158665">
    <div class="subject"><a href="#post-158665">Re: Tutorial 15: Multithreading Programming</a></div>
    <div class="body">Why would you want to go to such trouble to kill a thread??? :shock:<br /><br />Simply declare a global variable indicating if the thread is ON or OFF. Before you create the thread, you first check if it is already ON and do nothing to re-enter it (or turn it OFF before you would re-enter it with new parameters). If it&#39;s OFF you turn the variable ON and create the thread. When you want to kill it, you simply set that variable to OFF.<br /><br />The ThreadProc should look at that variable at interval and simply return (i.e. kill itself) whenever it would see that variable turned OFF.<br /><br />Raymond<br /></div>
    <div class="meta">Posted on 2005-04-02 11:07:31 by Raymond</div>
   </div>
   <div class="post" id="post-158677">
    <div class="subject"><a href="#post-158677">Re: Tutorial 15: Multithreading Programming</a></div>
    <div class="body">hey,Raymond.<br /><br />thanks you for help.<br /><br />I want to try another method for exiting a thread.<br /><br />regards.</div>
    <div class="meta">Posted on 2005-04-02 18:49:58 by dcskm4200</div>
   </div>
  </div>
 </body>
</html>