<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Erasm++ - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=30847" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=30847">Erasm++</a></p>
   <div class="post" id="post-215732">
    <div class="subject"><a href="#post-215732">Erasm++</a></div>
    <div class="body">Hi all, <br /><br />I&#039;ve released a C++ library for runtime code generation on x86/x64<br />processors which I dubbed Erasm++ (for Embedded Runtime Assembler in<br />C++). The code looks like this:<br /><br /><pre><code><br />p += add&nbsp; &nbsp;  (p, al , byte_ptr );<br />p += cmps&nbsp; &nbsp; (p, byte_ptr.ds , byte_ptr.es);<br />p += movaps&nbsp; (p, xmm0 , xmmword_ptr[ _5* rax ]);<br /></code></pre><br /><br />Although similar runtime code generator libraries already exist, <br />I believe my library has the following strengths:<br /><ul><br /><li> It is easier to use because the syntax is more natural.<br /></li><br /><li> It is safer to use because the syntactically invalid expressions<br />cause compilation errors, rather than runtime errors or exceptions.<br /></li><br /><li> It is faster because most of the encoding (and the error<br />checking) is done at compile-time, rather than at runtime.&nbsp; <br /></li><br /></ul><br /><br />It&#039;s fast -- indeed, with recent compilers, each generator function<br />is translated into a series of MOV instructions that contain no<br />external references (except possibly the stack and the argument).<br /><br />For example, the following code<br /><pre><code><br />extern &quot;C&quot; int&nbsp; code_test(code_ptr p,int32_t n)<br />{<br />&nbsp; &nbsp; return adc(p ,cl,byte_ptr );<br />}<br /></code></pre><br /><br />is compiled to:<br /><br /><pre><code><br />_code_test:<br />	sub	esp, 32<br />	mov	eax, DWORD PTR <br />	mov	BYTE PTR , -88<br />	mov	edx, DWORD PTR <br />	mov	DWORD PTR , edx<br />	mov	BYTE PTR , -116<br />	mov	BYTE PTR , 103<br />	mov	BYTE PTR , 18<br />	mov	edx, DWORD PTR <br />	mov	DWORD PTR , edx<br />	mov	edx, DWORD PTR <br />	mov	WORD PTR , dx<br />	mov	eax, 8<br />	add	esp, 32<br />	ret<br /></code></pre><br /><br />On the other hand, the downside is that the compilation is noticeably<br />slower than other systems. Also, compilation errors can lead to<br />somewhat cryptic error messages (although I have made some effort to<br />mitigate this.)<br /><br />The distribution also includes a very fast instruction decoder library<br />called GenericDSM, and a Haskell-like lazy metaprogramming library<br />called MetaPrelude which greatly helps implementing EDSLs in C++.<br /><br />If you are interested, here are my project pages at freecode and GitHub:<br /><a target="_blank" href="http://freecode.com/projects/erasm">http://freecode.com/projects/erasm</a><br /><a target="_blank" href="https://github.com/nishiuramakoto/erasm-plusplus">https://github.com/nishiuramakoto/erasm-plusplus</a><br /><br />I hope you enjoy it, and if you&#039;ve found bugs in the code,or in my<br />English, have a feature request, or whatever, please contact me at<br /><a href="mailto:nishiuramakoto@gmail.com">nishiuramakoto@gmail.com</a>!<br /><br />Also, I would like to ask a few questions to assembly programmers here:<br /><br /><ul><br /><br /><li> How do you optimize the above code? What would be the smallest,<br />or the fastest, assembly code that does the same thing and has the same<br />properties (no branches,no external references)?&nbsp; <br /></li><br /><br /><li> I feel the increased compilation time due to heavy<br />metaprogramming can be justified if the runtime performance is<br />good. Would you agree in this particular case? (I will consider<br />implementing a debug version for fast compilation if users really<br />need it.)&nbsp; </li><br /><br /><li> I&#039;m not a western guy, but a quick googling suggested to me that<br />the library name might sound a bit pompous. What do you think?&nbsp; Should<br />I rename it?&nbsp; <br /></li><br /></ul><br /><br />Thank you very much!<br /></div>
    <div class="meta">Posted on 2012-02-01 06:12:02 by mnish</div>
   </div>
  </div>
 </body>
</html>