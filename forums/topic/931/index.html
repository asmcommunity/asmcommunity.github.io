<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Pssst: Ernie... - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=931" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=116">Windows</a> &raquo; <a href="../?id=931">Pssst: Ernie...</a></p>
   <div class="post" id="post-5991">
    <div class="subject"><a href="#post-5991">Pssst: Ernie...</a></div>
    <div class="body">Hey Ernie,<br /><br />I was surfin your web page looking for why my Colib is giving me this error:<br /><pre><code><br />Microsoft &#40;R&#41; Macro Assembler Version 6.14.8444<br />Copyright &#40;C&#41; Microsoft Corp 1981-1997.  All rights reserved.<br /><br /> Assembling&#58; D&#58;\masm32\JProject2\CGmem\Loadpic\LoadPic.asm<br />Microsoft &#40;R&#41; Incremental Linker Version 5.12.8078<br />Copyright &#40;C&#41; Microsoft Corp 1992-1998. All rights reserved.<br /><br />colib.lib&#40;DllGetClassObject.obj&#41; &#58; error LNK2001&#58; unresolved external symbol _ClassMap<br />LoadPic.exe &#58; fatal error LNK1120&#58; 1 unresolved externals<br />_<br />Link error<br /></code></pre><br /><br />When i try to compile your COM Graphic example. (Still dont know why, (( I have SP2 from Hutch's Page )) )<br /><br /><br />I was hoping somewhere on your page you'd list your latest version of CoLib.  When i click on the link: <div class="quote">Trying to make a shortcut icon?  Go down to the COM section and read the Accessing COM Objects from Assembly tutorial. </div><br /><br />I got A Norton Antivirus warning that the .doc file downloaded has the <strong>W97M.Thus.A</strong> Virus!<br /><br />Thought you should know..   And ah.. if you know what the above error is eluding towards, I would also be greatfull...<br /><br />Thanx a ton..<br />NaN</div>
    <div class="meta">Posted on 2001-09-03 18:57:22 by NaN</div>
   </div>
   <div class="post" id="post-5992">
    <div class="subject"><a href="#post-5992">Pssst: Ernie...</a></div>
    <div class="body">Ok.. this is very quickly becoming annoying...  I've Downloaded the SP2 again, (just incase).. and replaced everything.. still nothing..<br /><br />I recompiled the Colib.lib, first commenting out the 'externdef' for classmap..   The build produces an error (no surprises), then i put it back and rebuild the lib, and presto all is well!.  But I go back to the example file and try to build it, i still get the same error.<br /><br />Im completely lost on this...<br /><br />NaN</div>
    <div class="meta">Posted on 2001-09-03 19:37:04 by NaN</div>
   </div>
   <div class="post" id="post-5995">
    <div class="subject"><a href="#post-5995">Pssst: Ernie...</a></div>
    <div class="body">Well Persistance rules...  <br /><br />I still dont understand the problem here.... as The COM model is crazy to fully follow (ole, oaidl, colib, etc)...  But from experiment i found that i <strong>DONT</strong> even need the colib.inc and colib.lib at all in Ernie's example file..<br /><br />by removing the include's,  Uncommenting the IID_IPicture definition, and placing a &quot;.data&quot; before it, Commenting out the Macro &quot;;DeclareGuid     IID_IPicture&quot;, the program builds and runs perfectly!<br /><br />Im no com expert.. but things sound fishy to me. The DeclareGuid Macro works fine, its just that by including CoLib to use this macro, i get this annoying problem that comes with it!<br /><br />Anyways, Ernie, I would be very happy to hear your take on this,<br /><br />NaN</div>
    <div class="meta">Posted on 2001-09-03 20:11:07 by NaN</div>
   </div>
   <div class="post" id="post-6005">
    <div class="subject"><a href="#post-6005">Pssst: Ernie...</a></div>
    <div class="body">I had a very simmilar problem when I was using DX8 in masm... I now use in FASM, so my problems are a little different... I just don't get some of MS stuff.<br /><br />In the Icz example for a window, I made all the data global by putting it in the .data section instead of using the LOCAL thing. The window crashed every time. I tried putting a .data section in the middle of WinMain PROC and every thing worked fine...<br /><br />I don't get it...</div>
    <div class="meta">Posted on 2001-09-03 22:16:19 by Kenny</div>
   </div>
   <div class="post" id="post-6011">
    <div class="subject"><a href="#post-6011">Pssst: Ernie...</a></div>
    <div class="body">I just found out about the virus on my site. It seems to be just that one file, but I have to check how far it's spread.<br /><br />That's what I get for working on my gf's conmputer. It's her second virus infection.<br /><br />Anyway, Norton says nothing nasty will happen until Dec 13th, and only that day. And since I've not had 2 spare minuits in weeks...<br /><br /><br />Re ClassMap errors, that's somthing CoLib 1.1 fixed. CoLib 1.0 DEMANDED it be there, 1.1 is much more relaved about it. And yes, all I'm using is the GUID macro.<br /><br />Somehow you must be pointing to the orgional lib.</div>
    <div class="meta">Posted on 2001-09-03 23:43:03 by Ernie</div>
   </div>
   <div class="post" id="post-6136">
    <div class="subject"><a href="#post-6136">Pssst: Ernie...</a></div>
    <div class="body">Ok... Here is the facts.<br /><ul><br />[*]I complelely erased every reference to COM off my computer.<br />[*]I downloaded SP2 from hutch's page<br />[*]I Unpack and the Unzip CoLib 1.1, and copy it into \masm32<br />[*]Now i have a DIR: D:\masm32\com<br />[*]Recompile your test progie<br />[*]I Get THE SAME ERROR!! :rolleyes:<br /><br /><br />Need more proof: (this is the file, pointed by the path of colib.inc)<br /><pre><code><br />;-------------------------------------------------------------------------------<br />; CoLib.inc   Common data, structures, functions and macros<br />;              to be used as a template for in-process com server objects<br />;<br />;  version 1.1<br />;<br />; Copyright &#40;c&#41; 9/28/00  Ernest Murphy<br />;<br />; revised 3/3/01 to simplify object creation and remove ObjectData.m_pEntry0 <br />; revised 3/1/01 to add DeclareVariant and remove m_ObjectSize from ObjectData<br />;					&#40;now just requires SIZEOF ObjectData&#41;<br />; revised 1/8/01 to include AggItem STRUCT &#40;formerly in DllGetclassObject.asm&#41;<br />;<br />; For educational use only. Any commercial re-use only by written license<br />;<br />;<br />;-------------------------------------------------------------------------------<br /></code></pre><br /><br />As well the includelib path points to the colib.lib in its proper location.<br /><br />I personally DONT think its in here specifically.  I think the proplem resided in this file:<br /><pre><code><br />;-------------------------------------------------------------------------------<br />;  colibrary procedure DllGetClassObject<br />; <br />; -------------------------------------------------------<br />; This procedure was written by Ernest Murphy    9/27/00<br />;<br />;  revised 1/8/01 to reposition .data structs to other libs<br />;		<br />; Copyright &#40;c&#41; 9/28/00  Ernest Murphy<br />; For educational use only. Any commercial re-use only by written license<br />;<br />; -------------------------------------------------------<br />.NOLIST<br />.386<br />.model flat, stdcall  ; 32 bit memory model<br />option casemap &#58;none  ; case sensitive<br /><br />include     mini_win.inc	; 'just enough' of windows.inc &#40;speeds build&#41;<br />include     \masm32\include\kernel32.inc<br />include     \masm32\include\oleaut32.inc<br />include     \masm32\include\ole32.inc<br />include     \masm32\include\masm32.inc<br />include     \masm32\COM\include\oaidl.inc<br /><br />include     colib.inc<br /><br />externdef   ClassMap&#58;DWORD<br />externdef	IID_IClassFactory&#58;DWORD<br /><br />;PUBLIC vtIClassFact<br />PUBLIC Pos          <br />PUBLIC pResEnd      <br /><br />.data<br /><br />ClassFactoryClassMap	EQU    CFClassMap<br /><br />CFClassMap          ClassItem     &#123; pIID_IClassFactory, NULL, NULL, \<br />                                    OFFSET CFIMap, NULL, NULL, \<br />                                    NULL, SIZEOF CFmembers &#125;<br />                    END_CLASS_MAP        <br /><br />CFIMap                  EQU      CFInterfaceItem1   <br /> <br />CFInterfaceItem1    InterfaceItem &#123; pIID_IClassFactory, OFFSET vtIClassFact &#125;<br />                    END_INTERFACE_MAP<br /><br />vtIClassFact            IClassFactory \<br />     &#123; NDQueryInterface,<br />       NDAddRef,<br />       NDRelease,<br />       CreateInstance,<br />       LockServer &#125;<br /><br />CFmembers   STRUCT  DWORD<br />    m_pClassItem   DWORD       NULL<br />CFmembers   ENDS<br /><br />; declare the ClassFactory object structure<br />; this is only run-time instanced<br />ClassFactObject STRUCT  DWORD<br />    ObjectData0     ObjectData  &#123; &#125;     ; base values<br />    CFMembers       CFmembers   &#123; &#125;     ; info on the object to impliment<br />    ObjectEntry0    ObjectEntry &#123; &#125;     ; non-delegating Unknown<br />    ObjectEntry1    ObjectEntry &#123; &#125;     ; IClassFactory   <br />ClassFactObject ENDS<br /><br />Pos                     DWORD           0<br />pResEnd                 DWORD           0<br /><br /><br />.LISTALL<br />.code<br />;-------------------------------------------------------------------------------<br /><br />DllGetClassObject PROC PUBLIC rclsid&#58;DWORD, riid&#58;DWORD, ppv&#58;DWORD<br />             <br />;-------------------------------------------------------------------------------<br />; COM server dll main export<br />;   Creates a Class Factory object to create a requested coclass<br />;   <br />;<br />; EXAMPLE&#58;<br />;   invoke DllGetClassObject, ADDR clsid, ADDR iid&#58;DWORD, ADDR pv<br />;<br />; Uses&#58; eax, ecx, edx<br />;<br />;<br />;-------------------------------------------------------------------------------<br />    LOCAL pFactory&#58;DWORD, pClassItem&#58;DWORD, retval&#58;DWORD<br /><br />    ; compare the CLSID given us to the ones we can build<br />    ; we can ONLY build a Class Factory object to build the objects<br />    ; in our Class Map. All others get rejected<br /><br />    mov pFactory, NULL      ; define our pointers<br />    ; walk the class map and see if we make this class object <br />    mov ecx, OFFSET ClassMap<br />    mov pClassItem, ecx<br />    mov eax, &#40;ClassItem PTR &#91;ecx&#93;&#41;.m_clsid       ; get first class clsid<br />    .WHILE eax	; check if Classitem.m_riid != NULL = END_OF_MAP signal<br />        invoke  IsEqualGUID, rclsid, eax<br />        .IF !eax<br />            add pClassItem, SIZEOF ClassItem    <br />            mov ecx, pClassItem<br />            mov eax, &#40;ClassItem PTR &#91;ecx&#93;&#41;.m_clsid<br />        .ELSE<br />            ; found a supported class<br />            ; make a new Class Factory object<br />            ; create a Class Factory<br />            invoke AllocObject, ADDR pFactory, ADDR CFClassMap, NULL, NULL <br />            .IF_FAILED<br />                mov eax, E_OUTOFMEMORY<br />                ret<br />            .ENDIF<br />            ;now set the custom data  &#40;the reference <br />			; to the Class Item we can create&#41;<br />			mov eax, pFactory<br />            mov eax, &#40;ObjectEntry PTR &#91;eax&#93;&#41;.m_pBase<br />            mov ecx, pClassItem <br />            mov &#40;ClassFactObject PTR &#91;eax&#93;&#41;.CFMembers.m_pClassItem, ecx<br />            coinvoke pFactory, IUnknown, QueryInterface, riid, ppv<br />            ; use the QI hresult to determine the success of this procedure<br />            mov retval, eax<br />            ; and release our helper pointer<br />            invoke NDRelease, pFactory<br />            mov eax, retval<br />            ret<br />        .ENDIF<br />    .ENDW<br />    ; if we got here we didn't find a matching CLSID<br />    mov eax, CLASS_E_CLASSNOTAVAILABLE<br />    ret<br />DllGetClassObject ENDP<br />;-------------------------------------------------------------------------------<br /><br />end<br /></code></pre><br /><br />Where a more up-to-date version exists on you machine, but is not bundled to Hutch's web site...  Because this file definitely makes reference to some <strong>externdef   ClassMap:DWORD</strong>.<br /><br />To make this more concrete, i even got the old MS Find going, and searched the entire hard drive for any TEXT STRING &quot;ClassMap&quot; (not case sensitive).<br /><br />I found out that :<br /><br /><strong>ScriptTxt.asm</strong> (wont compile for the same reason)<br /><em>The documentation sugest a change made, but not clear. And the old &quot;classmap&quot; public def is commented out.</em><pre><code> ; as of CoLib 1.1, ClassMap is no longer required<br /> ; PUBLIC ClassMap     ; thanks to Maurice MONTGENIE for pointing out this ommision<br /> ;                     ; &#40;Resolves a LINK problem in that DllGetClassObject IS linked,<br /> ;                     ; but not called. That object needs this definition&#41;<br /> ;                     ; &#40;When colib2 is released and we can delete this again&#41;<br />;-------------------------------------------------------------------------------<br />.data<br /> ; ClassMap        DWORD       NULL        ; also needed with the PUBLIC up there</code></pre><br /><br /><strong>AsmCtrl.asm</strong> (will compile!)<br /><em>It has a ClassMap public definition, but its different in appearance, building a DWORD definition think...</em><pre><code>PUBLIC      ClassMap<br /><br />;--------------------------------------------------------------------------<br />.LISTALL ; NOW let's list everything<br /><br />;--------------------------------------------------------------------------<br />.data<br /><br />; describe the objects inside the DLL<br />ClassMap    ClassItem \ ; class map instance  <br />     &#123; pCLSID_AsmCtrl,              DISPINTERFACE + SUPPLY_TYPE_INFO,   \<br />       OFFSET AsmCtrlTypeLibInfo,   OFFSET AsmCtrlIMap,     \<br />       OFFSET CreateAsmCtrl,        OFFSET DestroyAsmCtrl,  \<br />       OFFSET  AsmCtrlInitData,     SIZEOF AsmCtrlObject &#125;<br />       END_CLASS_MAP</code></pre><br /><br /><strong>MyCom2.asm</strong> (Will Compile)<br /><em>Again for the same reasons mentioned above..</em><pre><code>PUBLIC ClassMap                             ; need to export ONLY the ClassMap<br /><br />;-------------------------------------------------------------------------------<br />.LISTALL<br />.data<br /><br />; describe the classes inside the DLL<br />ClassMap    ClassItem   &#123; pCLSID_MyCom2, DISPINTERFACE + SUPPLY_TYPE_INFO, \<br />                          OFFSET MyCom2TypeLibInfo, OFFSET MyCom2IMap,     \<br />                          CreateMyCom2, NULL, NULL, SIZEOF MyCom2Object &#125;<br />            END_CLASS_MAP</code></pre><br /><br /><br />At this point, im pretty sure im not pointing to the origional lib.  It apprears the fixes you and Maurice MONTGENIE have not fully been updated, as some of your examples feel they need it, and some dont.  And on the SP2, the Dont's - dont compile!<br /><br /><br /><img src="http://www.angelfire.com/scifi/win32asm/helptitle2.gif" /> <br /><br />NaN</div>
    <div class="meta">Posted on 2001-09-04 14:07:39 by NaN</div>
   </div>
   <div class="post" id="post-6183">
    <div class="subject"><a href="#post-6183">Pssst: Ernie...</a></div>
    <div class="body">Sorry to say I don't have some super secret perfect copy of CoLib on my drive. I just downloaded SP2 off hutch's site and compiled  LoadPic.asm just fine.<br /><br />How about trying to mess up the folder name where you think CoLib is, and recompile. If it finds the lib, you have it in another place too (most likely on your path).</div>
    <div class="meta">Posted on 2001-09-04 18:15:27 by Ernie</div>
   </div>
   <div class="post" id="post-6190">
    <div class="subject"><a href="#post-6190">Pssst: Ernie...</a></div>
    <div class="body"><span style="font-size:24px>Finally!</span><br /><br />Now I know the source of all this non-sence!!!! Windows.inc!!!...  I've been using 1.25 for the last year or so, and yours compiles fine on 1.18.  <br /><br />As well Hutch's sevice pack 2 provides Windows.inc v1.25!!  So it wayyy to ez to get trapped trusting this.  (( This is Sooo Very uncool! ))<br /><br />Q.  How would an updated version of windows go so wrong, that i have to fall back on previous versions in order to make newer COM technologies work??<br /><br /> :stupid: :rolleyes: :stupid:</div>
    <div class="meta">Posted on 2001-09-04 19:58:45 by NaN</div>
   </div>
   <div class="post" id="post-6192">
    <div class="subject"><a href="#post-6192">Pssst: Ernie...</a></div>
    <div class="body">As far as I know, it's hutch and icz maintaining windows.inc, not<br />microsoft. Thus, it's not a newer version of windows that breaks<br />stuff, it's something that was wrong (or has gone wrong) in windows.inc :).</div>
    <div class="meta">Posted on 2001-09-04 20:08:04 by f0dder</div>
   </div>
  </div>
 </body>
</html>