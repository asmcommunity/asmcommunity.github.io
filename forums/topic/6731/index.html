<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Console Applications::How to write Console Application - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=6731" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=6731">Console Applications::How to write Console Application</a></p>
   <div class="post" id="post-48651">
    <div class="subject"><a href="#post-48651">Need help with DOS-box</a></div>
    <div class="body">Hey folks,<br /><br />i need some help with the DOS-box.<br />I'm using a normal win32 app, based on a dialogbox.<br />the progi is now supposed to open a DOS-box<br />write for example the line: C:\help needed<br />read the line:                      unknown file or command<br />and close the dos box again<br />How do i do that ?<br /><br />regards</div>
    <div class="meta">Posted on 2001-08-19 10:06:07 by Olli</div>
   </div>
   <div class="post" id="post-48650">
    <div class="subject"><a href="#post-48650">Console Applications::How to write Console Application</a></div>
    <div class="body">Here's the Source of my unfinished (and I think, I'd never finish it)<br />command.com replacement. Hope this helps!<br /><br /><pre><code><br />; #########################################################################<br /><br />        .386<br />        .model flat, stdcall<br />        option casemap &#58;none<br /><br />; #########################################################################<br /><br />        include \masm32\include\windows.inc<br />        include \masm32\include\user32.inc<br />        include \masm32\include\kernel32.inc<br />        include \masm32\include\shell32.inc<br /><br />        includelib \masm32\lib\user32.lib<br />        includelib \masm32\lib\kernel32.lib<br />        includelib \masm32\lib\shell32.lib<br /><br />; #########################################################################<br /><br />        CPut PROTO &#58;DWORD<br />        CPutErr PROTO &#58;DWORD<br />        CGet PROTO<br />        GetCmd PROTO<br />        ListLong PROTO<br />        ChangeDir PROTO<br />        Execute PROTO<br /><br />; #########################################################################<br /><br />    .data<br />        ; ############################################## console strings<br />        szConTitle      db &quot;WinShell Konsole v0.10&quot;, 0<br />        szConAbout      db &quot;Copyright 2001 by bAZiK&quot;, 13,10, 0<br />        szNewLine       db 13, 10, 0<br />        szError         db &quot;Error&#58; Command or File not found!&quot;, 13,10,13,10, 0<br />        szTimeFormat    db &quot;HH&#58;mm&#58;ss&quot;, 0<br />        szDateFormat    db &quot;dd.MM.yyyy&quot;, 0<br />        szChgError      db &quot;Error&#58; Directory not found!&quot;, 13,10, 0<br />        szShellError    db &quot;Error&#58; File not found!&quot;, 13,10, 0<br /><br />        ; ############################################## console commands<br />        szExit          db &quot;exit&quot;, 0<br />        szll            db &quot;ll&quot;, 0<br />        szcd            db &quot;cd&quot;, 0<br />        szx             db &quot;x&quot;, 0<br /><br />        ; ############################################## wsprintf templates<br />        szConPrompt     db &quot;%s &gt; &quot;, 0<br />        szListFormat    db &quot;%s  %s  %s  %35s  %13lu&quot;, 0<br />        szTotalFormat   db &quot;Total Size&#58; %lu Byte&#40;s&#41;&quot;, 13,10, 0<br /><br />         ; ############################################## structures<br />        wfd             WIN32_FIND_DATA &lt;&gt;<br />        syst            SYSTEMTIME &lt;&gt;<br />        ft              FILETIME &lt;&gt;<br /><br />; #########################################################################<br /><br />    .data?<br />        szOutputBuffer  db 512 dup &#40;?&#41;<br />        szInputBuffer   db 512 dup &#40;?&#41;<br />        szCmdBuffer     db 512 dup &#40;?&#41;<br />        szDirBuffer     db 512 dup &#40;?&#41;<br />        szListBuffer    db 512 dup &#40;?&#41;<br />        szAttribBuffer  db 20 dup &#40;?&#41;<br />        szTimeBuffer    db 20 dup &#40;?&#41;<br />        szDateBuffer    db 20 dup &#40;?&#41;<br />        szTotalBuffer   db 512 dup &#40;?&#41;<br />        szChgBuffer     db 512 dup &#40;?&#41;<br />        szShellBuffer   db 512 dup &#40;?&#41;<br />        hFind           dd ?<br />        hInput          dd ?<br />        hOutput         dd ?<br />        hWritten        dd ?<br />        hRead           dd ?<br />        hMenu           dd ?<br />        hConWin         dd ?<br />        lpTotalSize     dd ?<br /><br />; #########################################################################<br /><br />    .code<br /><br />start&#58;<br />    invoke GetStdHandle, STD_INPUT_HANDLE<br />    mov hInput, eax<br />    invoke GetStdHandle, STD_OUTPUT_HANDLE<br />    mov hOutput, eax<br />    invoke SetConsoleTitle, addr szConTitle<br /><br />    invoke SetConsoleTextAttribute, hOutput, FOREGROUND_RED or \<br />                                    FOREGROUND_GREEN or \<br />                                    FOREGROUND_BLUE or \<br />                                    FOREGROUND_INTENSITY or \<br />                                    BACKGROUND_BLUE<br />    invoke CPut, addr szConTitle<br />    invoke CPut, addr szNewLine<br />    invoke CPut, addr szConAbout<br />    invoke SetConsoleTextAttribute, hOutput, FOREGROUND_RED or \<br />                                    FOREGROUND_GREEN or \<br />                                    FOREGROUND_BLUE or \<br />                                    FOREGROUND_INTENSITY<br />    invoke CPut, addr szNewLine<br /><br /> @@&#58;<br />    call CGet<br />    call GetCmd<br />    cmp byte ptr &#91;szCmdBuffer&#93;, 0 ; return gedr?ckt<br />    je  @B<br /><br />    invoke lstrcmp, addr szCmdBuffer, addr szExit<br />    .if eax == 0<br />        jmp @F<br />    .endif<br /><br />    invoke lstrcmp, addr szCmdBuffer, addr szll<br />    .if eax == 0<br />        call ListLong<br />        jmp @B<br />    .endif<br /><br />    invoke lstrcmp, addr szCmdBuffer, addr szcd<br />    .if eax == 0<br />        call ChangeDir<br />        invoke CPut, addr szNewLine<br />        jmp @B<br />    .endif<br /><br />    invoke lstrcmp, addr szCmdBuffer, addr szx<br />    .if eax == 0<br />        call Execute<br />        invoke CPut, addr szNewLine<br />        jmp @B<br />    .endif<br /><br />    invoke CPutErr, addr szError<br />    jmp @B<br /> @@&#58;<br /><br />    invoke ExitProcess, 0<br /><br />; #########################################################################<br /><br />Execute proc<br />    invoke RtlZeroMemory, addr szShellBuffer, 512<br />    lea edi, szInputBuffer<br />    lea esi, szShellBuffer<br />    add edi, 2 ; 'x '<br /> @@&#58;<br />    mov al, byte ptr &#91;edi&#93;<br />    cmp al, 13<br />    je @F<br />    mov byte ptr &#91;esi&#93;, al<br />    inc edi<br />    inc esi<br />    or al, al<br />    jnz @B<br /> @@&#58;<br />    invoke ShellExecute, 0, 0, addr szShellBuffer, 0, \<br />                         addr szDirBuffer, SW_SHOWNORMAL<br />    cmp eax, ERROR_FILE_NOT_FOUND<br />    jne @F<br /><br />    invoke CPutErr, addr szShellError<br /> @@&#58;<br />    ret<br /><br />Execute endp<br /><br />; #########################################################################<br /><br />ChangeDir proc<br />    invoke RtlZeroMemory, addr szChgBuffer, 512<br />    lea edi, szInputBuffer<br />    lea esi, szChgBuffer<br />    add edi, 3 ; 'cd '<br /> @@&#58;<br />    mov al, byte ptr &#91;edi&#93;<br />    cmp al, 13<br />    je @F<br />    mov byte ptr &#91;esi&#93;, al<br />    inc edi<br />    inc esi<br />    or al, al<br />    jnz @B<br /> @@&#58;<br />    invoke SetCurrentDirectory, addr szChgBuffer<br />    cmp eax, 0<br />    jne @F<br /><br />    invoke CPutErr, addr szChgError<br /> @@&#58;<br />    ret<br />ChangeDir endp<br /><br />; #########################################################################<br /><br />ListLong proc<br />    mov eax, 0<br />    mov lpTotalSize, eax<br /><br />    invoke CPut, addr szNewLine<br />    invoke lstrlen, addr szDirBuffer<br />    lea edi, szDirBuffer<br />    add edi, eax<br />    mov byte ptr &#91;edi&#93;, 42 ; *<br /><br />    invoke FindFirstFile, addr szDirBuffer, addr wfd<br />    mov hFind, eax<br /><br /> @@&#58;<br />    lea edi, szAttribBuffer<br />    mov eax, wfd.dwFileAttributes<br /><br />    .if &#40;eax &amp; FILE_ATTRIBUTE_DIRECTORY&#41;<br />        mov byte ptr &#91;edi&#93;, 100 ; d<br />    .else<br />        mov byte ptr &#91;edi&#93;, 45 ; -<br />    .endif<br /><br />    inc edi<br /><br />    .if &#40;eax &amp; FILE_ATTRIBUTE_ARCHIVE&#41;<br />        mov byte ptr &#91;edi&#93;, 97 ; a<br />    .else<br />        mov byte ptr &#91;edi&#93;, 45 ; -<br />    .endif<br /><br />    inc edi<br /><br />    .if &#40;eax &amp; FILE_ATTRIBUTE_SYSTEM&#41;<br />        mov byte ptr &#91;edi&#93;, 115 ; s<br />    .else<br />        mov byte ptr &#91;edi&#93;, 45 ; -<br />    .endif<br /><br />    inc edi<br /><br />    .if &#40;eax &amp; FILE_ATTRIBUTE_HIDDEN&#41;<br />        mov byte ptr &#91;edi&#93;, 104 ; h<br />    .else<br />        mov byte ptr &#91;edi&#93;, 45 ; -<br />    .endif<br /><br />    inc edi<br /><br />    .if &#40;eax &amp; FILE_ATTRIBUTE_READONLY&#41;<br />        mov byte ptr &#91;edi&#93;, 114 ; r<br />    .else<br />        mov byte ptr &#91;edi&#93;, 45 ; -<br />    .endif<br /><br />    invoke FileTimeToLocalFileTime, addr wfd.ftLastWriteTime, addr ft<br />    invoke FileTimeToSystemTime, addr ft, addr syst<br />    invoke GetTimeFormat, 0, 0, addr syst, \<br />                          addr szTimeFormat, addr szTimeBuffer, 20<br />    invoke GetDateFormat, 0, 0, addr syst, addr szDateFormat, \<br />                          addr szDateBuffer, 20<br /><br />    mov eax, MAXDWORD<br />    mov ebx, wfd.nFileSizeHigh<br />    imul ebx<br />    add eax, wfd.nFileSizeLow<br />    mov edx, eax<br /><br />    add lpTotalSize, edx<br /><br />    invoke wsprintf, addr szListBuffer, addr szListFormat, \<br />                     addr szAttribBuffer, addr szDateBuffer, \<br />                     addr szTimeBuffer, addr wfd.cFileName, edx<br /><br />    invoke CPut, addr szListBuffer<br />    invoke CPut, addr szNewLine<br /><br />    invoke RtlZeroMemory, addr szListBuffer, 512 ; clear buffer<br />    invoke FindNextFile, hFind, addr wfd<br />    invoke GetLastError<br />    cmp eax, ERROR_NO_MORE_FILES<br />    jne @B<br /><br />    invoke CPut, addr szNewLine<br /><br />    invoke wsprintf, addr szTotalBuffer, addr szTotalFormat, lpTotalSize<br />    invoke CPut, addr szTotalBuffer<br /><br />    invoke CPut, addr szNewLine<br />    invoke CloseHandle, hFind<br /><br />    ret<br />ListLong endp<br /><br />; #########################################################################<br /><br />CPutErr proc lpText&#58;DWORD<br />    invoke SetConsoleTextAttribute, hOutput, FOREGROUND_RED or \<br />                                    FOREGROUND_INTENSITY<br />    invoke CPut, lpText<br />    invoke SetConsoleTextAttribute, hOutput, FOREGROUND_RED or \<br />                                    FOREGROUND_GREEN or \<br />                                    FOREGROUND_BLUE or \<br />                                    FOREGROUND_INTENSITY<br />    ret<br />CPutErr endp<br /><br />; #########################################################################<br /><br />CPut proc lpText&#58;DWORD<br />    invoke lstrlen, lpText<br />    invoke WriteFile, hOutput, lpText, eax, addr hWritten, 0<br />    mov eax, hWritten<br />    ret<br />CPut endp<br /><br />; #########################################################################<br /><br />CGet proc<br />    invoke RtlZeroMemory, addr szDirBuffer, 512<br />    invoke GetCurrentDirectory, 512, addr szDirBuffer<br />    lea edi, szDirBuffer<br />    add edi, eax<br />    cmp byte ptr &#91;edi-1&#93;, &quot;\&quot;<br />    je @F<br />    mov byte ptr &#91;edi&#93;, &quot;\&quot;<br /> @@&#58;<br />    invoke wsprintf, addr szOutputBuffer, addr szConPrompt, addr szDirBuffer<br />    invoke CPut, addr szOutputBuffer<br />    invoke RtlZeroMemory, addr szInputBuffer, 512<br />    invoke ReadFile, hInput, addr szInputBuffer, 512, addr hRead, 0<br />    mov eax, hRead<br />    ret<br />CGet endp<br /><br />; #########################################################################<br /><br />GetCmd proc<br />    invoke RtlZeroMemory, addr szCmdBuffer, 512<br />    lea edi, szInputBuffer<br />    lea esi, szCmdBuffer<br /> @@&#58;<br />    mov al, byte ptr &#91;edi&#93;<br />    cmp al, 32<br />    je @F<br />    cmp al, 13<br />    je @F<br />    mov byte ptr &#91;esi&#93;, al<br />    inc edi<br />    inc esi<br />    or al, al<br />    jnz @B<br /> @@&#58;<br />    ret<br />GetCmd endp<br /><br />; #########################################################################<br /><br />end start<br /><br />; #########################################################################<br /></code></pre></div>
    <div class="meta">Posted on 2001-08-19 11:10:16 by bazik</div>
   </div>
   <div class="post" id="post-48652">
    <div class="subject"><a href="#post-48652">Console Applications::How to write Console Application</a></div>
    <div class="body">Well, i figured out how to start<br />My console opens, but the windows closes right away again<br />and it doesn't write the line it is supposed to write...<br />Here's the code<br /><br /><pre><code><br />;#########################################################################<br /><br />      .386<br />      .model flat, stdcall<br />      option casemap &#58;none   ; case sensitive<br /><br />;#########################################################################<br /><br />      include \masm32\include\windows.inc<br />      include \masm32\include\user32.inc<br />      include \masm32\include\kernel32.inc<br /><br />      includelib \masm32\lib\user32.lib<br />      includelib \masm32\lib\kernel32.lib<br /><br />;#########################################################################<br />      <br />      .data<br />      <br />      text db &quot;dir /p/w&quot;,0<br /><br />;#########################################################################<br />      <br />      .data?<br />      <br />      hInput        dd ?<br />      hOutput       dd ?<br />      written       dd ?<br />      <br /><br />;#########################################################################<br />      <br />      .code<br /><br />start&#58;<br />        <br />        invoke AllocConsole  ; create console<br />        <br />        invoke GetStdHandle,STD_INPUT_HANDLE  ; get the handles<br />        mov hInput,eax<br />        <br />        invoke GetStdHandle,STD_OUTPUT_HANDLE<br />        mov hOutput,eax  <br />        <br />        invoke WriteConsole,addr hOutput,addr text,4,addr written,NULL      <br /><br /><br /><br />end start<br /><br /></code></pre> <br />What i actually wanna do is make my progi work like a batchfile<br />would it work this way ?<br />as soon as a line is written to the console, is it like somebody presses enter ?<br /><br />regards Olli</div>
    <div class="meta">Posted on 2001-08-20 11:00:45 by Olli</div>
   </div>
   <div class="post" id="post-48649">
    <div class="subject"><a href="#post-48649">Console Applications::How to write Console Application</a></div>
    <div class="body">Olli,<br /><br />you told us how to start a &quot;DOS-Box&quot;, but actually you just wanted to start a console window. Ok, to write to you newly created console,  your last line should look like:<br /><br /><pre><code><br />        invoke WriteConsole,hOutput,addr text,8,addr written,NULL      <br /></code></pre><br /><br />JAPHETH</div>
    <div class="meta">Posted on 2001-08-20 11:41:36 by japheth</div>
   </div>
   <div class="post" id="post-48653">
    <div class="subject"><a href="#post-48653">Console Applications::How to write Console Application</a></div>
    <div class="body">sorry you guys,<br /><br />that still doesn't solve it.<br />it's just the number of characters to be written,<br />I'm sure I'll get the problem with writing to the console.<br /><br />But what i can't solve is when i start my program the console appears, and disappears after a sec again.<br />if i try it again the program crashes<br /><br />any ideas how to solve that ?<br />PS: My program is suposed to work like a batch file<br /><br />I appreciate every single post<br /><br />regards Olli</div>
    <div class="meta">Posted on 2001-08-20 14:49:41 by Olli</div>
   </div>
  </div>
 </body>
</html>