<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>fileio.getw at the EOF - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=10544" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=10544">fileio.getw at the EOF</a></p>
   <div class="post" id="post-79292">
    <div class="subject"><a href="#post-79292">fileio.getw at the EOF</a></div>
    <div class="body">I have a file, which ends with 3 (exactly) hexadecimal digits.<br />The following code:<pre><code>mov&#40; file_size, eax &#41;;<br />sub&#40; 3, eax &#41;;<br />fileio.seek&#40; my_file, eax &#41;;<br />fileio.getw&#40; my_file &#41;;</code></pre>raises an exception (12) &quot;End of file error&quot;.<br />The manual says &quot;...a string of one or more hexadecimal digits....must end with a valid delimiter character or the end of the file.&quot;<br /><br />clone-d.</div>
    <div class="meta">Posted on 2003-01-31 03:21:02 by clone-d</div>
   </div>
   <div class="post" id="post-79395">
    <div class="subject"><a href="#post-79395">Re: fileio.getw at the EOF</a></div>
    <div class="body"><div class="quote"><br />I have a file, which ends with 3 (exactly) hexadecimal digits.<br />The following code:<pre><code>mov&#40; file_size, eax &#41;;<br />sub&#40; 3, eax &#41;;<br />fileio.seek&#40; my_file, eax &#41;;<br />fileio.getw&#40; my_file &#41;;</code></pre>raises an exception (12) &quot;End of file error&quot;.<br />The manual says &quot;...a string of one or more hexadecimal digits....must end with a valid delimiter character or the end of the file.&quot;<br /><br />clone-d. </div><br /><br />Yes, that appears to be the case.<br />Looking at the getq source code (getw calls getd, which calls getq, which does the actual I/O and conversion) there is absolutely no check for EOF at all.  To correct this problem,<br />inset the lines I've marked with &quot;//***&quot; into the fgetq.hla source file, do a clean on the HLA Standard Library, and rebuild it (if you don't have MASM, LINK, and LIB, just recompile the fgetq file and link it with your code).<br /><br />Note: I'd expect this same problem to exist elsewhere in the standard library.<br />The solution will generally be the same.<br />I'll try to get all this fixed up by the v1.43 release.<br />Randy Hyde<br /><br /><br /><pre><code><br />unit FileIOUnit;<br />        <br /><br /><br /><br />#include&#40; &quot;fileiounit.hhf&quot; &#41;<br /><br /><br />/*********************************************/<br />/*                                           */<br />/* fgetq-                                    */<br />/*                                           */<br />/* Reads a 64-bit hexadecimal value from the */<br />/* specified file.  Returns the value in     */<br />/* EDX&#58;EAX.                                  */<br />/*                                           */<br />/*********************************************/<br /><br /><br /><br />procedure fgetq&#40; Handle&#58;dword &#41;; @nodisplay; @noalignstack;<br /><br />var<br />    Delimiters&#58; cset;<br />    <br />begin fgetq;<br /><br />    push&#40; ecx &#41;;<br />    <br />    conv.getDelimiters&#40; Delimiters &#41;;<br />    <br />    xor&#40; eax, eax &#41;;<br />    xor&#40; edx, edx &#41;;<br />    xor&#40; ecx, ecx &#41;;<br />    begin EncounteredEOF; //****<br />    <br />        // Skip over any leading delimiters&#58;<br />        <br />        repeat<br />        <br />            exitif&#40; feof&#40; Handle &#41;&#41; EncounteredEOF; //****<br />            fgetc&#40; Handle &#41;;<br />        <br />        until&#40;#&#123; bt&#40; eax, &#40;type dword Delimiters &#41;&#41;; jc false; &#125;#&#41;;<br />        <br />        // Okay, input the digits and convert to a number&#58;<br />        <br />        repeat<br />        <br />            // The character must be a numeric digit.<br />            // The following code converts the character in<br />            // al to the range $FA..$FF, $00..$09 if it is<br />            // a hexadecimal character.<br />            <br />            sub&#40; '0', al &#41;;<br />            if&#40; al &gt;= 10 &#41; then<br /><br />                sub&#40; $17, al &#41;;<br />                if&#40; al &lt; $FA &#41; then<br />                        <br />                    raise&#40; ex.ConversionError &#41;;<br />                    <br />                endif;<br />                <br />            endif;<br /><br /><br />            shl&#40; 1, ecx &#41;;  // Multiply edx&#58;ecx by 16.<br />            rcl&#40; 1, edx &#41;;<br />            jc Overflow;<br />            shl&#40; 1, ecx &#41;;  // This is *4.<br />            rcl&#40; 1, edx &#41;;<br />            jc Overflow;<br />            shl&#40; 1, ecx &#41;;  // This is *8.<br />            rcl&#40; 1, edx &#41;;<br />            jc Overflow;<br />            shl&#40; 1, ecx &#41;;  // This is *16.<br />            rcl&#40; 1, edx &#41;;<br />            jc Overflow;<br />            <br />            // Add in the current character&#58;<br />            <br />            add&#40; eax, ecx &#41;;<br />            adc&#40; 0, edx &#41;;<br />            jnc NoOverflow;<br />            <br />            Overflow&#58;<br />            <br />                raise&#40; ex.ValueOutOfRange &#41;;<br />                <br />            NoOverflow&#58;<br />            <br />            // Skip any underscores in the middle of the number.<br />            <br />            repeat<br />            <br />                exitif&#40; feof&#40; Handle &#41;&#41; EncounteredEOF; //****<br />                fgetc&#40; Handle &#41;;<br />                <br />            until&#40; al &lt;&gt; '_' &#41;;<br />            movzx&#40; al, eax &#41;;<br />            <br />        until&#40;#&#123; bt&#40; eax, &#40;type dword Delimiters &#41;&#41;; jnc false; &#125;#&#41;;<br />    <br />    end EncounteredEOF; //****<br />    mov&#40; ecx, eax &#41;;<br />    pop&#40; ecx &#41;;<br />        <br />end fgetq;<br />    <br />end FileIOUnit;<br /><br /><br /></code></pre></div>
    <div class="meta">Posted on 2003-02-01 01:33:39 by rhyde</div>
   </div>
  </div>
 </body>
</html>