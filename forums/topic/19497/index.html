<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>ActiveX - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=19497" />
    <link rel="next" href="../?id=19497&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=42">RadASM</a> &raquo; <a href="../?id=19497">ActiveX</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=19497&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=19497&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="19497" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=19497&amp;page=2">&gt;</a><a href="../?id=19497&amp;page=2">&raquo;</a></form>   <div class="post" id="post-150194">
    <div class="subject"><a href="#post-150194">ActiveX</a></div>
    <div class="body">Hi!<br /><br />I have written a tool to help coding Activex project. First I wrote it in VB. A while ago I opened a thread in the COM section with a tutorial and a demo. Now I can't find the thread so I suppose it has been deleted.<br /><br />With help from the VB tool I have rewritten the tool in assembler as an addin for RadAsm.<br /><br />For those who are interested I attach the dll, an Excel automation demo (ComDemo.zip) and a skeleton project for Excel automation coding (ComTut.zip). You only have to complete the skeleton with coding from the tool. Unzip ComTool.dll, Com.mdb, TLBINF32.DLL and ComTut.chm int RadAsm/Addins folder.</div>
    <div class="meta">Posted on 2004-09-22 12:13:28 by minor28</div>
   </div>
   <div class="post" id="post-150203">
    <div class="subject"><a href="#post-150203">ActiveX</a></div>
    <div class="body">Hi minor28<br /><br />Interesting tool.<br /><br />Bugs:<br />1. Looks for the com.mdb in C:\projects\.......<br />2. GPF's immediatly on Win98SE<br /><br />KetilO</div>
    <div class="meta">Posted on 2004-09-22 15:22:04 by KetilO</div>
   </div>
   <div class="post" id="post-150263">
    <div class="subject"><a href="#post-150263">ActiveX</a></div>
    <div class="body">Sorry for the hardcoded path. Forgot to change.<br /><br />About GPF's immediatly on Win98SE. I don't have SE. But it works on my Win98 4.10.1998<br /><br />I also tested on a Win2K machine. There I got a fault. Only buttons and the statusbar was shown. The buttons did work though.<br /><br />Attach a new dll.</div>
    <div class="meta">Posted on 2004-09-23 10:17:48 by minor28</div>
   </div>
   <div class="post" id="post-150264">
    <div class="subject"><a href="#post-150264">ActiveX</a></div>
    <div class="body">If the quick search menu items don't work list all components and rightclick on the component you want to access directly.</div>
    <div class="meta">Posted on 2004-09-23 10:24:35 by minor28</div>
   </div>
   <div class="post" id="post-150275">
    <div class="subject"><a href="#post-150275">ActiveX</a></div>
    <div class="body">Hi minor28<br /><br />Still GPF's on Win98SE<br /><br />Maybe this will help:<br /><br />RADASM for?rsaket en ugyldig sidefeil i <br />modul COMTOOL.DLL ved 0177:0130552d.<br />Registre:<br />EAX=00000000 CS=0177 EIP=0130552d EFLGS=00010203<br />EBX=006ccece SS=017f ESP=006cac4c EBP=006cce7c<br />ECX=00000000 DS=017f ESI=00008ef2 FS=1a87<br />EDX=00008f0e ES=017f EDI=006cce84 GS=2117<br />Byte ved CS:EIP:<br />52 57 56 68 57 65 30 01 55 54 68 fa 16 30 01 64 <br /><br />KetilO</div>
    <div class="meta">Posted on 2004-09-23 13:54:13 by KetilO</div>
   </div>
   <div class="post" id="post-150278">
    <div class="subject"><a href="#post-150278">ActiveX</a></div>
    <div class="body">Hi KetilO<br /><br />I can't find the eip. It doesn't mach to my win98.<br /><br />I have SEH in every process but DLLEntry, InstallDLL and DLLProc. In the attached version I have competed with SEH in those too. It will tell me which process it is.</div>
    <div class="meta">Posted on 2004-09-23 15:11:23 by minor28</div>
   </div>
   <div class="post" id="post-150282">
    <div class="subject"><a href="#post-150282">ActiveX</a></div>
    <div class="body">Hi<br /><br />The SEH does not work, also the jit debugger does not catch this GPF.<br /><br />I have made comtool the only addin in RadASM 2.1.0.0 and EIP is now:<br /><br />RADASM for?rsaket en ugyldig sidefeil i <br />modul COMTOOL.DLL ved 0177:00c1557d.<br />Registre:<br />EAX=00000000 CS=0177 EIP=00c1557d EFLGS=00010203<br />EBX=006cce8a SS=017f ESP=006cac08 EBP=006cce38<br />ECX=00000000 DS=017f ESI=00008eae FS=2987<br />EDX=00008eca ES=017f EDI=006cce40 GS=3bbf<br />Byte ved CS:EIP:<br />52 57 56 68 a7 65 c1 00 55 54 68 48 17 c1 00 64 <br /><br />KetilO</div>
    <div class="meta">Posted on 2004-09-23 15:46:33 by KetilO</div>
   </div>
   <div class="post" id="post-150287">
    <div class="subject"><a href="#post-150287">ActiveX</a></div>
    <div class="body">Hi<br /><br />OllyDbg shows:</div>
    <div class="meta">Posted on 2004-09-23 16:03:16 by KetilO</div>
   </div>
   <div class="post" id="post-150288">
    <div class="subject"><a href="#post-150288">ActiveX</a></div>
    <div class="body">Hi<br /><br />That is the preservation of edx, edi and esi in the main dlg process. That's why the SEH didn't work. I removed the edx.</div>
    <div class="meta">Posted on 2004-09-23 16:22:06 by minor28</div>
   </div>
   <div class="post" id="post-150291">
    <div class="subject"><a href="#post-150291">ActiveX</a></div>
    <div class="body">Did not help, crashes on XP SP2 too.<br />Seem like you are allocating a lot of stack space in that proc.<br /><br />KetilO</div>
    <div class="meta">Posted on 2004-09-23 16:34:52 by KetilO</div>
   </div>
   <div class="post" id="post-150292">
    <div class="subject"><a href="#post-150292">ActiveX</a></div>
    <div class="body">That's strange.<br /><br />It works on my XP SP1 and my win98. I will try on another machine tomorrow. This is the code.<pre><code>.if ecx==IDComTool<br />	.if hMainDlg==0<br />        mov osi.dwOSVersionInfoSize,sizeof osi<br />        mov osi.szCSDVersion,128<br />        invoke GetVersionEx,addr osi<br />        .if eax==TRUE <br />            .if osi.dwPlatformId==VER_PLATFORM_WIN32_WINDOWS	;=1 win95/98<br />            	;osi.szCSDVersion = &#40;A=Windows 98 SE,C=Windows 95 OSR2&#41;<br />            	mov colref,00C0C0C0h ;win98<br />            	<br />            .elseif osi.dwPlatformId==VER_PLATFORM_WIN32_NT ;=2 winNT<br />            	mov colref,00C8D0D4h ;win2K<br />            	<br />            .endif<br />        .endif<br />		invoke DialogBoxParam,hInstance,IDD_DIALOG1,0,addr MainDlgProc,NULL<br />	.else<br />		invoke SetWindowPos,hMainDlg,HWND_TOP,0,0,0,0,SWP_NOSIZE or SWP_NOMOVE<br />	.endif<br />.endif<br />mov eax,FALSE <br />jmp lbl_finally<br /></code></pre><br /><pre><code>MainDlgProc proc uses  edx edi esi hWin&#58;HWND,uMsg&#58;UINT,wParam&#58;WPARAM,lParam&#58;LPARAM<br />	LOCAL buffer&#91;4096&#93;&#58;byte<br />	LOCAL buffer2&#91;256&#93;&#58;byte<br />	LOCAL buffer3&#91;256&#93;&#58;byte<br />	LOCAL printout&#91;4096&#93;&#58;byte<br />	LOCAL pos&#58;dword<br />	LOCAL hdi&#58;HD_ITEM<br />	<br />	;_try<br />	push lbl_finally ;address of safe place after guarded code<br />	push ebp ;stack frame<br />	push esp<br />	assume fs&#58;nothing<br />	push offset ED_31 ;address of frame-based exception director<br />	push fs&#58;&#91;0&#93;;address of next error structure<br />	mov fs&#58;&#91;0&#93;, esp ;save the error address<br /><br />	.if uMsg==WM_INITDIALOG<br />		push hWin<br />		pop hMainDlg<br />		invoke CoInitializeEx,0,0<br /></code></pre><br /><br />I will be back tomorrow. Good Night.</div>
    <div class="meta">Posted on 2004-09-23 16:44:02 by minor28</div>
   </div>
   <div class="post" id="post-150315">
    <div class="subject"><a href="#post-150315">ActiveX</a></div>
    <div class="body">Hi minor28<br /><br />Allocating large buffers on stack is not a good idea.<br />Remember that memory under windows is virtual and must be allocated.<br />Allocate some stringspace instead.<br /><br />KetilO</div>
    <div class="meta">Posted on 2004-09-24 04:17:04 by KetilO</div>
   </div>
   <div class="post" id="post-150361">
    <div class="subject"><a href="#post-150361">ActiveX</a></div>
    <div class="body">Hi KetilO,<br /><br />Locals are only 9k. Default stack size is 1 MB. It shouldn't have an critical effect, but it looks like it as the GPF occurs when the edx is pushed on the stack. To change the local buffers to globals will be quite a job. <br /><br />The dll works on my XP and win98. It also works on another XP. <br /><br />On my win2k the main dialog only shows the buttons and the statusbar. Neither the dialog itself nor the listview nor menu is visible. The close button works.<br /><br />The standalone exe works on all machines. I attach the exe if you want to test.</div>
    <div class="meta">Posted on 2004-09-24 11:16:11 by minor28</div>
   </div>
   <div class="post" id="post-150432">
    <div class="subject"><a href="#post-150432">ActiveX</a></div>
    <div class="body">Check the post for a possible solution.<br /><br />http://www.asmcommunity.net/board/viewtopic.php?t=13525&amp;highlight=touch+stack<br /><br />I ran into this using an early version of Ketilo's very fine Spreadsheet Control.<br /><br />hth<br /><br />farrier</div>
    <div class="meta">Posted on 2004-09-25 09:04:10 by farrier</div>
   </div>
   <div class="post" id="post-150521">
    <div class="subject"><a href="#post-150521">ActiveX</a></div>
    <div class="body">I have tested with link option STACK but I couldn't see any change.<br /><br />When I removed the exception handling from the MainDlgProc the main dialog worked on the win2k machine. The other dialog window still don't show up just the controls. So I suppose there must be somethin wrong with the exception handling in the dialog processes.<br /><br />Are there anyone else who have tested the dll and  experienced the same problem as KetilO?<br /><br />I attache the dll without the exception handling in the main dialog process.</div>
    <div class="meta">Posted on 2004-09-26 12:00:21 by minor28</div>
   </div>
   <div class="post" id="post-150523">
    <div class="subject"><a href="#post-150523">ActiveX</a></div>
    <div class="body">minor28,<br /><br />If you look at the last post in the article I referenced, you'll notice that the problem was due to a large LOCAL variable size.  You can use the method I described--stolen from Jeremy Gordon, JORGON--to &quot;touch&quot; the stack gradually, so as not to violate the &quot;guard pages&quot; of the stack.<br /><br />Nothing I could do with the link or assemble STACK commands could avoid this problem, only touching.  So touch your stack, and watch it grow :lol: <br /><br />hth<br /><br />farrier</div>
    <div class="meta">Posted on 2004-09-26 12:40:15 by farrier</div>
   </div>
   <div class="post" id="post-150528">
    <div class="subject"><a href="#post-150528">ActiveX</a></div>
    <div class="body">Hi farrier,<br /><br />I don't understand. Do you mean this code <pre><code>   MOV   ECX,10 <br />L0&#58; <br />   SUB   ESP,1000h <br />   MOV   D&#91;ESP&#93;,0         ;MOV   DWORD ptr ESP, 0 <br />   LOOP   L0 <br /><br />And adding&#58; <br />   ADD   ESP, 0a000h</code></pre> will &quot;touch&quot; the stack and commit more stack memory? I don't know how to use it.<br /><br />The strange thing is why I don't get the GPF and the addin works without any problems.</div>
    <div class="meta">Posted on 2004-09-26 13:41:16 by minor28</div>
   </div>
   <div class="post" id="post-150539">
    <div class="subject"><a href="#post-150539">ActiveX</a></div>
    <div class="body">minor28,<br /><br />The problem is not having reserved stack or committed stack, the problem is when you try to cross a boundary &quot;guard page&quot; which WINDOWS sets up to prevent applications from accessing memory they shouldn't.  The OS sets a boundary of 4096 bytes away from previously &quot;touched&quot; or used or accessed stack memory, and if you try to jump over the boundary without first using or touching or accessing the memory in between, on some systems you will generate a GPF.<br /><br />When I first experienced this problem, I was using a WIN95 system and used a new version of KetilO's spreadsheet program.  Obviously, it worked on KetilO's machine, but on mine: GPF!<br /><br />The code you quoted from my post did just what I've decribed:<br />Added -1000h (-4096) to the stack (ESP),<br />mov'd a 0 to that stack location<br />and looped 10 times to touch 40960 bytes worth of stack.<br />Then I added a000h (40960) to the stack (ESP) to go back to the original value.<br /><br />In you program you allocate:<br /><br /><pre><code><br />   LOCAL buffer&#91;4096&#93;&#58;byte <br />   LOCAL buffer2&#91;256&#93;&#58;byte <br />   LOCAL buffer3&#91;256&#93;&#58;byte <br />   LOCAL printout&#91;4096&#93;&#58;byte <br />   LOCAL pos&#58;dword <br />   LOCAL hdi&#58;HD_ITEM <br /></code></pre><br /><br />Add up the number of bytes in all these LOCAL's and touch just that many bytes worth of stack, and &quot;maybe&quot;  :?: the problem will go away.<br /><br />All I can tell you is that your problem looks just like the one I had.<br /><br />hth<br /><br />farrier</div>
    <div class="meta">Posted on 2004-09-26 18:34:33 by farrier</div>
   </div>
   <div class="post" id="post-150583">
    <div class="subject"><a href="#post-150583">ActiveX</a></div>
    <div class="body">minor28,<br /><br />Another explaination of why your program crashed at the:<br /><pre><code>	push edx<br /></code></pre><br /><br />command.  Considering the LOCAL's you declared:<br /><br /><pre><code>   LOCAL buffer&#91;4096&#93;&#58;byte<br />   LOCAL buffer2&#91;256&#93;&#58;byte<br />   LOCAL buffer3&#91;256&#93;&#58;byte<br />   LOCAL printout&#91;4096&#93;&#58;byte<br />   LOCAL pos&#58;dword<br />   LOCAL hdi&#58;HD_ITEM<br /></code></pre><br /><br />Something similar to the following code would be generated<br />as the first instructions of your procedure, assuming the<br />standard PROLOGUE code:<br /><br /><pre><code>push	ebp<br />mov	ebp, esp<br />add	esp, -size_of_locals<br /></code></pre><br /><br />Where size_of_locals is the total number of bytes of all<br />your LOCAL's.  Since size_of_locals is greater than 2 X 4096,<br />when you push edx, you are gauranteed to cross the gaurd<br />page boundary the OS sets up.<br /><br />There is probably a macro or some other clever way to<br />determine the size_of_locals.<br /><br />At this point, you need to &quot;touch&quot; memory every 4096 bytes<br />from the original ESP when we entered the proc, to the <br />current esp.  To do this, maybe you could:<br /><br /><pre><code>	mov	eax, esp		;manipulate this value in eax<br />	add	eax, size_of_locals	;to restore value of orig. ESP<br />touch&#58;	mov	dword ptr &#91;eax&#93;, 0<br />	sub	eax, 4096<br />	cmp	esp, eax<br />	jle	touch<br /></code></pre><br /><br />This would only corrupt eax, and touch the pages of memory<br />used by the LOCAL's.  Unless I've made a mistake.<br /><br />See attached file!<br /><br />hth<br /><br />farrier</div>
    <div class="meta">Posted on 2004-09-27 21:32:18 by farrier</div>
   </div>
   <div class="post" id="post-150587">
    <div class="subject"><a href="#post-150587">ActiveX</a></div>
    <div class="body">Thanks for you efforts to help me but the problem is that my program don't crash on my computer. As far as I know nobody else but KetilO has reported a crash.<br /><br />KetilO. I suggest that you delete my thread. I will follow your advice and open a new thread when I have revised the dll.<br /><br />Best regards</div>
    <div class="meta">Posted on 2004-09-28 00:38:08 by minor28</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=19497&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=19497&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="19497" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=19497&amp;page=2">&gt;</a><a href="../?id=19497&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>