<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Owner-drawn listbox doesn't get WM_CTLCOLORLISTBOX - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=14164" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=14164">Owner-drawn listbox doesn't get WM_CTLCOLORLISTBOX</a></p>
   <div class="post" id="post-109466">
    <div class="subject"><a href="#post-109466">Owner-drawn listbox doesn't get WM_CTLCOLORLISTBOX</a></div>
    <div class="body">I want to subclass a generic LISTBOX to apply different colours to listbox contents.<br />The listbox doesn't respond to WM_CTLCOLORLISTBOX message. :(<br />I guess I have to use SetWindowLONG with GW_STYLE.<br /><br />.code<br /><br />PROGRAM_IMAGE_BASE	EQU	400000h<br /><br />start:<br /><br />Main proc <br />        LOCAL msg  :MSG<br /><br />        invoke CreateWindowExW,WS_EX_TOOLWINDOW,<br />                              ADDR wsClassName, ADDR wsDisplayName,WS_OVERLAPPEDWINDOW or \<br />                              LBS_HASSTRINGS or LBS_WANTKEYBOARDINPUT  or \<br />                              LBS_DISABLENOSCROLL,\<br />                              0,0,350,770,<br />                              0,0,PROGRAM_IMAGE_BASE,0<br />                              <br /><br />        mov   hWnd,eax<br />        invoke SetWindowLong,eax,GWL_WNDPROC,ADDR WndProc<br />        mov lpfnWndProc,eax<br />        invoke  SendMessage, hWnd,WM_SETREDRAW, 0, NULL<br />    	invoke  CreateFontIndirectW, ADDR fnt<br />	mov	hFont, eax<br />	invoke SendMessageW, hWnd, WM_SETFONT, eax, NULL<br />        invoke  OpenSCManager, NULL, NULL, SC_MANAGER_ENUMERATE_SERVICE<br />        test    eax, eax<br />        jnz     @f<br />               invoke  SendMessage, hWnd, LB_ADDSTRING, NULL, OFFSET scMngrErr1<br />        @@:<br />                mov     g_hSCMngr, eax<br /><br />        mov     enumResumeHndl, 0<br />        invoke  EnumServicesStatus, eax, SERVICE_WIN32, SERVICE_ACTIVE, 0, 0, \<br />                                    OFFSET enumSRVneeded, OFFSET enumSRVret, OFFSET enumResumeHndl<br />        mov     ebx, enumSRVneeded<br />        push    ebx<br />        push    HEAP_ZERO_MEMORY<br />        invoke  GetProcessHeap<br />        push    eax<br />        call    HeapAlloc<br />        mov     g_hMem, eax<br /><br />        mov     enumResumeHndl, 0<br />        invoke  EnumServicesStatus, g_hSCMngr, SERVICE_WIN32, SERVICE_ACTIVE, eax, ebx, \<br />                                    OFFSET enumSRVneeded, OFFSET enumSRVret, OFFSET enumResumeHndl<br /><br />        test    eax, eax<br />        jnz     @f<br />                invoke  SendMessage, hWnd, LB_ADDSTRING, 0, OFFSET enumSrvErr1<br />        @@:<br /><br />        mov     ebx, g_hMem<br />        mov     edi, enumSRVret<br />        xor     esi, esi<br /><br />        @@:<br />            ;mov     edx, (ENUM_SERVICE_STATUS ptr ).lpServiceName<br />            mov     edx, (ENUM_SERVICE_STATUS ptr ).lpDisplayName<br />            invoke  lstrcpy, ADDR buffer, edx<br />            invoke lnstr,ADDR buffer<br />            cmp eax,dwMaxLen<br />            jb ok            ;if smaller<br />                mov dwMaxLen,eax       ;maximum length<br />            ok:<br />            inc dwCount<br />            invoke  SendMessage, hWnd, LB_ADDSTRING, 0, OFFSET buffer<br />            invoke  lstrcmp, OFFSET buffer, OFFSET serviceSS<br />            test    eax, eax<br />            jnz     __next<br />            invoke  OpenService, g_hSCMngr, OFFSET serviceSS, SERVICE_ALL_ACCESS<br />            mov     g_hOpenSrv, eax<br />            invoke  StartService, eax, 0, NULL<br />            test    eax, eax<br />            jnz     __clean<br />            invoke  GetLastError<br />            cmp     eax, ERROR_SERVICE_ALREADY_RUNNING<br />            jne     __clean<br />            invoke  ControlService, g_hOpenSrv, SERVICE_CONTROL_STOP, OFFSET srvStat<br />            __clean:<br />            invoke  CloseServiceHandle, g_hOpenSrv<br />            __next:<br />            add     ebx, SIZEOF ENUM_SERVICE_STATUS<br />            inc     esi<br />            cmp     esi, edi<br />            jb      @b<br /><br />        push    g_hMem<br />        push    0<br />        invoke  GetProcessHeap<br />        push    eax<br />        call  HeapFree<br />        invoke  CloseServiceHandle, g_hSCMngr<br />        ;invoke  SendMessage, hWnd, LB_GETCOUNT, 0, 0<br />        ;invoke dwtoa,dwCount,ADDR buffer<br />        ;invoke GetErrDescription,eax <br /><br />        ;invoke dwtoa,eax,ADDR buffer<br />        ;invoke  SendMessage, hWnd, LB_ADDSTRING, 0, OFFSET buffer<br />        mov eax,dwCount<br />        lea ebx,[+140]   ;listbox width<br />        ;invoke dwtoa,eax,ADDR buffer<br />        ;invoke  SendMessage, hWnd, LB_ADDSTRING, 0, OFFSET buffer<br />        mov eax, dwMaxLen<br />        lea eax,[+67]   ;listbox width<br />        invoke SetWindowPos,hWnd,HWND_TOP,0,0,eax,ebx,SWP_SHOWWINDOW<br />        invoke  SendMessage, hWnd,WM_SETREDRAW, 1, NULL<br />        invoke ShowWindow,hWnd,SW_SHOWNORMAL<br />        invoke UpdateWindow,hWnd<br />    StartLoop:<br />      invoke GetMessageW,ADDR msg,NULL,NULL,NULL<br />      cmp eax, NULL<br />      je ExitLoop<br />      invoke TranslateMessage, ADDR msg<br />      invoke DispatchMessageW,  ADDR msg<br />      jmp StartLoop<br />    ExitLoop:<br />      mov eax, msg.wParam<br />      invoke DeleteObject, hFont<br />      ret<br />Main endp<br /><br />WndProc proc hWin   :DWORD,<br />             uMsg   :DWORD,<br />             wParam :DWORD,<br />             lParam :DWORD<br />     <br />    .if uMsg == WM_MOUSEMOVE<br />            invoke  SendMessage, hWnd, LB_GETCURSEL,NULL,NULL<br />            mov ebx,eax<br />            invoke  SendMessage, hWnd, LB_ITEMFROMPOINT, 0,lParam<br />            LOWORD eax<br />            cmp eax, ebx<br />            je skip<br />            invoke  SendMessage, hWnd, LB_SETCURSEL,eax,NULL<br />            skip:<br />    .elseif uMsg == WM_DESTROY<br />            invoke PostQuitMessage,NULL<br />            xor eax,eax <br />    .elseif uMsg ==WM_KEYDOWN<br />    .elseif uMsg ==WM_SYSCOLORCHANGE<br />            invoke GetErrDescription,eax <br />    <br /><br />    .endif<br />    invoke CallWindowProcW,lpfnWndProc,hWin,uMsg,wParam,lParam<br />    ret<br />WndProc endp<br /><br />end start</div>
    <div class="meta">Posted on 2003-07-06 16:28:01 by Prahogi</div>
   </div>
   <div class="post" id="post-109477">
    <div class="subject"><a href="#post-109477">Owner-drawn listbox doesn't get WM_CTLCOLORLISTBOX</a></div>
    <div class="body">The WM_CTLCLRxxxx messages are sent to the parent of the control not the control itself. Put your color routine in the dilaogs procedure and try it.<br /><br />i.e.<br /><pre><code>.ELSEIF uMsg == WM_CTLCOLORLISTBOX<br />	mov eax,wParam<br />	mov hDC,eax<br />	invoke SetTextColor,hDC,0<br />	invoke SetBkMode,hDC,TRANSPARENT<br />	mov eax,hBrush<br />	ret</code></pre></div>
    <div class="meta">Posted on 2003-07-06 17:59:09 by donkey</div>
   </div>
   <div class="post" id="post-109847">
    <div class="subject"><a href="#post-109847">Thank you, Donkey</a></div>
    <div class="body">I realize that it was really a lame question.<br />I should have figured this while reading MSDN</div>
    <div class="meta">Posted on 2003-07-09 15:17:31 by Prahogi</div>
   </div>
   <div class="post" id="post-109865">
    <div class="subject"><a href="#post-109865">Re: Thank you, Donkey</a></div>
    <div class="body"><div class="quote"><br />I realize that it was really a lame question.<br />I should have figured this while reading MSDN </div><br /><br />dont worry donkey used to it becouse of my questions :tongue:</div>
    <div class="meta">Posted on 2003-07-09 17:44:20 by AceEmbler</div>
   </div>
  </div>
 </body>
</html>