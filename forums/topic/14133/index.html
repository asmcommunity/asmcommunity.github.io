<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Recursive file search with mask - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=14133" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=14133">Recursive file search with mask</a></p>
   <div class="post" id="post-109201">
    <div class="subject"><a href="#post-109201">Recursive file search with mask</a></div>
    <div class="body">I've been searching the board for a recursive file search algo. I have found several, but all of them fail when I change the file mask from *.* to something else. When changing it to *.txt for example, it won't find any directories, only files, something that precludes the algo from being recursive. Does anyone have a solution to this problem?<br /><br />edit:<br />Here is an example of a recursive search that don't work with another file mask:<br /><a target="_blank" href="http://www.asmcommunity.net/board/showthread.php?threadid=8879">http://www.asmcommunity.net/board/showthread.php?threadid=8879</a><br /><br />/Delight</div>
    <div class="meta">Posted on 2003-07-03 16:22:23 by Delight</div>
   </div>
   <div class="post" id="post-109202">
    <div class="subject"><a href="#post-109202">Recursive file search with mask</a></div>
    <div class="body">Hi Delight,<br /><br />This isn't very elegant but it's what I wrote to do that. GoAsm syntax:<br /><pre><code>;########################<br />; FindFile by Donkey v g0.6<br />; Syntax&#58;<br />; invoke FindFile,pszRootDir,pszFileName,Recurse,CallBack<br />;<br />; pszRootDir = The directory to start the search in example &quot;C&#58;\WinNT&quot;,0<br />; pszFileName = The filename to search for &#40;wildcards allowed&#41; example &quot;*.exe&quot;,0<br />; Recurse = Recurse directories &#40;TRUE or FALSE&#41;<br />; CallBack = The address of a callback routine to process the filenames&#58;<br />;<br />; FindFileCallBack FRAME pszFileName<br />; Return TRUE to continue to next file<br />; Return FALSE to exit routine<br />; FindFile will exit when there are no more files meeting the file spec<br />;##############################<br /><br />FindFile FRAME pszRootDir, pszFileName, Recurse, CallBack<br />	LOCAL hRead			&#58;D<br />	LOCAL hWrite			&#58;D<br />	LOCAL bytesRead			&#58;D<br />	LOCAL hHeap			&#58;D<br />	LOCAL pOutput			&#58;D<br />	LOCAL pCommand			&#58;D<br />	LOCAL pSysDir			&#58;D<br />	LOCAL sui			&#58;STARTUPINFO<br />	LOCAL pi			&#58;PROCESS_INFORMATION<br />	LOCAL sa			&#58;SECURITY_ATTRIBUTES<br /><br />	invoke GetProcessHeap<br />	mov &#91;hHeap&#93;,eax<br />	invoke HeapAlloc, &#91;hHeap&#93;, HEAP_ZERO_MEMORY, 1024<br />	mov &#91;pOutput&#93;,eax<br />	invoke HeapAlloc, &#91;hHeap&#93;, HEAP_ZERO_MEMORY, 1024<br />	mov &#91;pCommand&#93;,eax<br />	invoke HeapAlloc, &#91;hHeap&#93;, HEAP_ZERO_MEMORY, 1024<br />	mov &#91;pSysDir&#93;,eax<br /><br />	invoke GetVersion<br /><br />	cmp al,5<br />	jge &gt;XP<br />	invoke GetWindowsDirectoryA,&#91;pSysDir&#93;,MAX_PATH<br />	cmp D&#91;Recurse&#93;,TRUE<br />	jne &gt;.Recurse1<br />		push &lt;&quot;/s/b&quot;,0&gt;<br />		push &#91;pszFileName&#93;<br />		push &#91;pszRootDir&#93;<br />		push &#91;pSysDir&#93;<br />		push &lt;&quot;%s\Command.com /C DIR &quot;,22H,&quot;%s\%s&quot;,22H,&quot; %s&quot;,0&gt;<br />		push &#91;pCommand&#93;<br />		call wsprintfA<br />	jmp &gt;done<br />	.Recurse1<br />		push &lt;&quot;/b&quot;,0&gt;<br />		push &#91;pszFileName&#93;<br />		push &#91;pszRootDir&#93;<br />		push &#91;pSysDir&#93;<br />		push &lt;&quot;%s\Command.com /C DIR &quot;,22H,&quot;%s\%s&quot;,22H,&quot; %s&quot;,0&gt;<br />		push &#91;pCommand&#93;<br />		call wsprintfA<br />	jmp &gt;done<br />	XP&#58;<br />	invoke GetSystemDirectoryA,&#91;pSysDir&#93;,MAX_PATH<br />	cmp D&#91;Recurse&#93;,TRUE<br />	jne &gt;.Recurse2<br />		push &lt;&quot;/s/b&quot;,0&gt;<br />		push &#91;pszFileName&#93;<br />		push &#91;pszRootDir&#93;<br />		push &#91;pSysDir&#93;<br />		push &lt;&quot;%s\CMD.EXE /C DIR &quot;,22H,&quot;%s\%s&quot;,22H,&quot; %s&quot;,0&gt;<br />		push &#91;pCommand&#93;<br />		call wsprintfA<br />	jmp &gt;done<br />	.Recurse2<br />		push &lt;&quot;/b&quot;,0&gt;<br />		push &#91;pszFileName&#93;<br />		push &#91;pszRootDir&#93;<br />		push &#91;pSysDir&#93;<br />		push &lt;&quot;%s\CMD.EXE /C DIR &quot;,22H,&quot;%s\%s&quot;,22H,&quot; %s&quot;,0&gt;<br />		push &#91;pCommand&#93;<br />		call wsprintfA<br />	done&#58;<br />	add esp,24 ; wsprintfA is a C call so take care of the stack<br /><br />	mov D&#91;sa.nLength&#93;,sizeof SECURITY_ATTRIBUTES<br />	mov D&#91;sa.lpSecurityDescriptor&#93;,NULL<br />	mov D&#91;sa.bInheritHandle&#93;,TRUE<br /><br />	push NULL<br />	lea eax,sa<br />	push eax<br />	lea eax,hWrite<br />	push eax<br />	lea eax,hRead<br />	push eax<br />	call CreatePipe<br />	cmp eax,NULL<br />	jne &gt;.PipeGood<br />		mov edi,-1<br />		jmp &gt;EXITNOPIPE<br />	.PipeGood<br /><br />	mov D&#91;sui.cb&#93;,sizeof STARTUPINFO<br />	lea eax,sui<br />	push eax<br />	call GetStartupInfoA<br />	mov eax,&#91;hWrite&#93;<br />	mov D&#91;sui.hStdOutput&#93;,eax<br />	mov D&#91;sui.hStdError&#93;,eax<br />	mov D&#91;sui.dwFlags&#93;,STARTF_USESHOWWINDOW+STARTF_USESTDHANDLES<br />	mov W&#91;sui.wShowWindow&#93;,SW_HIDE<br /><br />	lea eax,pi<br />	push eax<br />	lea eax,sui<br />	push eax<br />	push NULL<br />	push NULL<br />	push NULL<br />	push TRUE<br />	push NULL<br />	push NULL<br />	push &#91;pCommand&#93;<br />	push NULL<br />	call CreateProcessA<br />	cmp eax,NULL<br />	jne &gt;.ProcessGood<br />		invoke CloseHandle, &#91;hWrite&#93;<br />		mov edi,-1<br />		jmp &gt;EXITNOPROC<br />	.ProcessGood<br />	invoke CloseHandle,&#91;hWrite&#93;<br /><br />	mov eax,1<br />	.while<br />		mov ecx,256<br />		mov eax,0<br />		mov edi,&#91;pOutput&#93;<br />		rep stosd<br />		push NULL<br />		lea eax,bytesRead<br />		push eax<br />		push 1023<br />		push &#91;pOutput&#93;<br />		push &#91;hRead&#93;<br />		call ReadFile<br />		cmp eax,NULL<br />		jne &gt;.else<br />			jmp &gt;EXITALL<br />		.else<br />			mov edi,&#91;pOutput&#93;<br />			mov al,&#91;edi&#93;<br />			cmp al,&quot;0&quot;<br />			jb &gt;.NoFile<br />				push &#91;pOutput&#93;<br />				call &#91;CallBack&#93;<br />			.NoFile<br />	cmp eax,FALSE<br />	jne .while<br /><br />	EXITALL&#58;<br />		mov edi,0<br />		invoke CloseHandle,&#91;pi.hProcess&#93;<br />		invoke CloseHandle,&#91;pi.hThread&#93;<br />	EXITNOPROC&#58;<br />		invoke CloseHandle,&#91;hRead&#93;<br />		invoke CloseHandle, &#91;hHeap&#93;<br />	EXITNOPIPE&#58;<br />		invoke HeapFree, &#91;hHeap&#93;, NULL, &#91;pOutput&#93;<br />		invoke HeapFree, &#91;hHeap&#93;, NULL, &#91;pCommand&#93;<br />		invoke HeapFree, &#91;hHeap&#93;, NULL, &#91;pSysDir&#93;<br /><br />	mov eax,edi<br />	ret<br />FindFile endf</code></pre></div>
    <div class="meta">Posted on 2003-07-03 16:43:31 by donkey</div>
   </div>
   <div class="post" id="post-109206">
    <div class="subject"><a href="#post-109206">Recursive file search with mask</a></div>
    <div class="body">Hi Delight<br /><br />Here is one that filters asm &amp; inc files.<br /><br />KetilO</div>
    <div class="meta">Posted on 2003-07-03 17:59:06 by KetilO</div>
   </div>
   <div class="post" id="post-109217">
    <div class="subject"><a href="#post-109217">Recursive file search with mask</a></div>
    <div class="body">This is the MASM translation of the FindFile routine, it works the same as the GoAsm version:<pre><code>FindFile Proc pszRootDir&#58;DWORD, pszFileName&#58;DWORD, Recurse&#58;DWORD, CallBack&#58;DWORD<br />	LOCAL hRead				&#58;DWORD<br />	LOCAL hWrite				&#58;DWORD<br />	LOCAL bytesRead				&#58;DWORD<br />	LOCAL hHeap				&#58;DWORD<br />	LOCAL pOutput				&#58;DWORD<br />	LOCAL pCommand				&#58;DWORD<br />	LOCAL pSysDir				&#58;DWORD<br />	LOCAL Recursion				&#58;DWORD<br />	LOCAL CommandLine			&#58;DWORD<br />	LOCAL startupinfo			&#58;STARTUPINFO<br />	LOCAL pi				&#58;PROCESS_INFORMATION<br />	LOCAL sa				&#58;SECURITY_ATTRIBUTES<br /><br />	.data<br />		szCmdNT			BYTE	&quot;%s\CMD.EXE /C DIR &quot;,22H,&quot;%s\%s&quot;,22H,&quot; %s&quot;,0<br />		szCmd9x			BYTE	&quot;%s\Command.com /C DIR &quot;,22H,&quot;%s\%s&quot;,22H,&quot; %s&quot;,0<br />		szRecurse		BYTE	&quot;/s/b&quot;,0<br />		szNoRecurse		BYTE	&quot;/b&quot;,0<br />	.code<br /><br />	invoke GetProcessHeap<br />	mov hHeap,eax<br />	invoke HeapAlloc, hHeap, HEAP_ZERO_MEMORY, 2048<br />	mov pOutput,eax<br />	add eax,1024<br />	mov pCommand,eax<br />	add eax,512<br />	mov pSysDir,eax<br /><br />	invoke GetVersion<br />	and eax,080000000h<br />	.IF eax<br />		invoke GetWindowsDirectory,pSysDir,MAX_PATH<br />		mov CommandLine,OFFSET szCmd9x<br />	.ELSE<br />		invoke GetSystemDirectory,pSysDir,MAX_PATH<br />		mov CommandLine,OFFSET szCmdNT<br />	.ENDIF<br /><br />	.IF Recurse==TRUE<br />		mov Recursion,OFFSET szRecurse<br />	.ELSE<br />		mov Recursion,OFFSET szNoRecurse<br />	.ENDIF<br /><br />	invoke wsprintf, pCommand, CommandLine, pSysDir, pszRootDir, pszFileName, Recursion<br /><br />	mov sa.nLength,sizeof SECURITY_ATTRIBUTES<br />	mov sa.lpSecurityDescriptor,NULL<br />	mov sa.bInheritHandle,TRUE<br /><br />	invoke CreatePipe, addr hRead, addr hWrite, addr sa, NULL<br />	.IF eax==NULL<br />		jmp EXITNOPIPE<br />	.ENDIF<br /><br />	mov startupinfo.cb,sizeof STARTUPINFO<br />	invoke GetStartupInfo,addr startupinfo<br />	mov eax,hWrite<br />	mov startupinfo.hStdOutput,eax<br />	mov startupinfo.hStdError,eax<br />	mov startupinfo.dwFlags,STARTF_USESHOWWINDOW+STARTF_USESTDHANDLES<br />	mov startupinfo.wShowWindow,SW_HIDE<br /><br />	invoke CreateProcess, NULL, pCommand, NULL, NULL, TRUE, NULL, NULL, NULL, addr startupinfo, addr pi<br />	.IF eax==NULL<br />		invoke CloseHandle,hWrite<br />		jmp EXITNOPROC<br />	.ENDIF<br />	invoke CloseHandle,hWrite<br /><br />	mov eax,1<br />	.WHILE eax<br />		mov ecx,256<br />		mov eax,0<br />		mov edi,pOutput<br />		rep stosd<br />		invoke ReadFile, hRead, pOutput, 1023, addr bytesRead, NULL<br />		.IF eax==NULL<br />			.break<br />		.ELSE<br />			mov edi,pOutput<br />			mov al,&#91;edi&#93;<br /><br />			.IF al &gt;= &quot;0&quot;<br />				push pOutput<br />				call CallBack<br />			.ENDIF<br />		.ENDIF<br />	.ENDW<br /><br />	EXITALL&#58;<br />		invoke CloseHandle,pi.hProcess<br />		invoke CloseHandle,pi.hThread<br />	EXITNOPROC&#58;<br />		invoke CloseHandle,hRead<br />	EXITNOPIPE&#58;<br />		invoke HeapFree, hHeap, NULL, pOutput<br />		invoke HeapFree, hHeap, NULL, pCommand<br />		invoke HeapFree, hHeap, NULL, pSysDir<br />		invoke CloseHandle, hHeap<br />	ret<br />FindFile endp</code></pre></div>
    <div class="meta">Posted on 2003-07-03 23:09:28 by donkey</div>
   </div>
   <div class="post" id="post-109237">
    <div class="subject"><a href="#post-109237">Recursive file search with mask</a></div>
    <div class="body">Donkey: Thanks, very interesting code but it feels a little too &quot;dirty&quot; to use in my program.<br />KetilO:  What i'm looking for is an algorithm that can handle more advanced file masks like &quot;ma*.htm*&quot;. Thanks anyway.<br /><br />I have almost solved it, but I have found a really strange bug:<br /><br /><pre><code><br />SearchFilesWithMask proc  Path&#58;DWORD,Msk&#58;DWORD,Recur&#58;DWORD<br /><br />;For the directory search&#58;<br />LOCAL wc&#58;WIN32_FIND_DATA<br />LOCAL hFind&#58;DWORD<br />LOCAL tBuff&#91;MAX_PATH&#93;&#58;BYTE<br />LOCAL tBuff2&#91;MAX_PATH&#93;&#58;BYTE<br /><br />;For the file search&#58;<br />LOCAL Fwc&#58;WIN32_FIND_DATA<br />LOCAL FhFind&#58;DWORD<br />LOCAL FtBuff2&#91;MAX_PATH&#93;&#58;BYTE<br /><br /><br />      invoke lstrcpy,addr tBuff,Path<br />      invoke lstrcat,addr tBuff, offset MskAll<br />      invoke FindFirstFile,addr tBuff, addr wc<br />      <br />      .if eax!=INVALID_HANDLE_VALUE<br />       mov hFind,eax<br />      <br />        .while eax !=0<br />		.if byte ptr wc.cFileName != '.'<br />			.if wc.dwFileAttributes &amp; FILE_ATTRIBUTE_DIRECTORY<br />					invoke lstrcpy,addr tBuff2,Path<br />					invoke lstrcat,addr tBuff2,addr wc.cFileName<br />					invoke lstrcat,addr tBuff2,addr sls<br />					Call SearchFiles<br />	<br />				.if Recur<br />				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;	<br />				;REMOVE THIS LINE AND IT WILL HANG &#40;???&#41;;;;;<br />				PrintText &quot;Recursive start&quot; ;;;;;;;;;;;;;;;;<br />				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br />				<br />				<br />				invoke SearchFilesWithMask,addr tBuff2,Msk,Recur<br /><br /><br />				.endif<br />			.endif<br />		.endif<br />     	    <br />         invoke FindNextFile,hFind,addr wc<br />        .endw<br />     <br />     .endif<br />     invoke FindClose,hFind<br />    ret<br />      <br />  SearchFiles&#58;<br /> <br />      invoke lstrcpy,addr FtBuff2,addr tBuff2<br />	  invoke lstrcat,addr FtBuff2, Msk ;sk?t detta snyggare<br />      invoke FindFirstFile,addr FtBuff2, addr Fwc<br />   <br />      .if eax!=INVALID_HANDLE_VALUE<br />      	mov FhFind,eax<br />        .while eax !=0<br />		.if byte ptr Fwc.cFileName != '.'<br />		.if !&#40;Fwc.dwFileAttributes &amp; FILE_ATTRIBUTE_DIRECTORY&#41;<br />			;----------+<br />			;FILE HERE |<br />			;----------+------------------ - -   -     -         -<br />			invoke SendDlgItemMessage,hWnd,1002,LB_ADDSTRING,0,addr &#91;Fwc&#93;.cFileName<br />			;----------------------------- - -   -     -         -<br /><br />		.endif<br />		.endif<br />		invoke FindNextFile,FhFind,addr Fwc<br />        .endw<br />    .endif<br /> 	invoke FindClose, FhFind <br />     RETN<br />SearchFilesWithMask endp<br /></code></pre><br /><br /><br /><br /><br />The thing is that it works quite OK as long as I have the start directory set to the root of a drive. When changing it to a subfolder, the program freeze. The strange thing is that if I add a PrintText &quot;anything&quot; just before the recursion, it works perfectly. I can't figure out why, so I have attached a small RadASM projects if someone have the time to play with it and perhaps find a solution.</div>
    <div class="meta">Posted on 2003-07-04 05:24:53 by Delight</div>
   </div>
   <div class="post" id="post-109348">
    <div class="subject"><a href="#post-109348">Recursive file search with mask</a></div>
    <div class="body">Delight,<br />I coded similar example and here is the algo:<pre><code><br />Find_First&#58;                       <br />          push offset W32FD                <br />          push offset szFullPathwithMask  ; lp to curr full path string with \ and mask * at the end<br />          call FindFirstFile              ; call API<br />          mov  esi, eax                   ; esi-&gt;hFindFirstFile<br />          inc  eax                        ;<br />          jz   NtRet                      ; <br />FileOrDir&#58;                                   <br />          test W32FD.dwFileAttributes, FILE_ATTRIBUTE_DIRECTORY <br />          jz   ProcessFile                ; it is file -&gt;process it and jump to Find_Next<br />          cmp  W32FD.cFileName, &quot;.&quot;       ;<br />          jz   Find_Next                  ; skip it<br />          push esi                        ; save esi-&gt; current hFindFirstFile<br />          push offset RestoreH            ; return address<br />          jmp  ProcessDirectory           ; it is dir -&gt;process it and jump to Find_First<br />RestoreH&#58;         <br />          pop  esi                        ; restore previous esi&gt;hFindFirstFile<br />Find_Next&#58;      <br />          push offset W32FD<br />          push esi                        ; esi-&gt; hFindFirstFile<br />          call FindNextFile            <br />          test eax, eax    <br />          jnz  FileOrDir        <br />          push esi                        ; esi-&gt; current hFindFirstFile<br />          call FindClose <br />NtRet&#58;       <br />          ret                             ; return to RestoreH&#58; or to caller<br /><br />ProcessDirectory&#58;<br /> ; Update szFullPathwithMask  ; lp to curr full path string with \ and mask * at the end<br />                              ; Example&#58;<br />                              ; before  c&#58;\windows\help\*  ; always &quot; * &quot; !!!<br />                              ; after  c&#58;\windows\help\tour\*<br />                              ; or<br />                              ; before  c&#58;\windows\help\tour\*<br />                              ; after  c&#58;\windows\help\*<br />&#91;B&#93;Note&#58;&#91;/B&#93; We don't use SetCurrentDirectory&#40;&#41; API because of that!!!<br /><br />       ; call CheckMatchDirFilter   <br />       ; test eax, eax    <br />       ; jz   SkipDir      <br />       ; Print it or what you want     <br />SkipDir&#58;<br />         jmp  Find_First  <br /><br />ProcessFile&#58;<br />       ; call CheckMatchFileFilter   <br />       ; test eax, eax    <br />       ; jz   SkipFile      <br />       ; Print it or what you want    <br />SkipFile&#58;<br />         jmp  Find_Next<br /> <br />We don't use second and/or third FindFirstFile API and<br />it is pro because it is much faster and we have additional<br />functionality <br /> <br />We use one general filter &quot; * &quot; &#40;don't touch it&#41;  and two<br />user defined filters, for file name and/or dir name<br /><br />CheckMatchDirFilter and CheckMatchFileFilter <br />are cons &#40;the price of speed&#41; and something like that&#58;<br /><br />FilterDirectory   db &quot;pro*de?re&quot;,0         ; stupid user defined dir filter<br />Directory         db  &quot;Program Files&quot;, 0   ; current dir name<br /><br />FilterFile   db &quot;Le*a?re&quot;,0                ; stupid user defined file filter<br />FileName  db &quot;Levantare&quot; ,0                ; current file name<br />       <br />       mov eax, offset FilterFile<br />       mov edx, offset FileName<br />L_1&#58;<br />       mov  cl, &#91;eax&#93;<br />       inc  eax<br />       test cl, cl<br />       jz   Match <br />       cmp  cl, &quot;*&quot;<br />       je   L_3<br />       cmp  cl, &quot;?&quot;<br />       je   L_2<br />       cmp  cl, &#91;edx&#93;<br />       jne  NotMatch<br />L_2&#58;<br />       inc  edx<br />       cmp  byte ptr &#91;edx&#93;,0<br />       jne  L_1<br />Match&#58;<br />       mov  eax, 1<br />       ret<br />;StarFound<br />L_3&#58;<br />       mov  cl, &#91;eax&#93;<br />       inc  eax<br />       test cl, cl<br />       jz   Match <br />       cmp  cl, &quot;?&quot;<br />       je   L_3<br />       cmp  cl, &quot;*&quot;<br />       je   L_3<br />L_4&#58;<br />       cmp  cl, &#91;edx&#93;<br />       je   L_2        ; Continue<br />       inc  edx<br />       cmp  byte ptr &#91;edx&#93;,0<br />       jne  L_4<br />NotMatch&#58;<br />       xor  eax, eax<br />       ret</code></pre><br />As you see not a big deal ...<br /><br />Regards,<br />Lingo</div>
    <div class="meta">Posted on 2003-07-05 16:27:19 by lingo12</div>
   </div>
   <div class="post" id="post-109436">
    <div class="subject"><a href="#post-109436">Recursive file search with mask</a></div>
    <div class="body">Thank you lingo12 :) Nice code!</div>
    <div class="meta">Posted on 2003-07-06 10:58:38 by Delight</div>
   </div>
   <div class="post" id="post-109438">
    <div class="subject"><a href="#post-109438">Recursive file search with mask</a></div>
    <div class="body">Thanks Delight,<br /><br />Here is an example (without filters)<br /><br />Regards,<br />Lingo</div>
    <div class="meta">Posted on 2003-07-06 11:41:29 by lingo12</div>
   </div>
   <div class="post" id="post-109443">
    <div class="subject"><a href="#post-109443">Recursive file search with mask</a></div>
    <div class="body">Great example :alright: . Thanks again :)</div>
    <div class="meta">Posted on 2003-07-06 13:31:18 by Delight</div>
   </div>
   <div class="post" id="post-109495">
    <div class="subject"><a href="#post-109495">Recursive file search with mask</a></div>
    <div class="body"><strong>lingo12</strong><br />Your code contains the wrong suggestion<br />the name of the directory can begin with points<br />necessary to compare to {'.',0} and {'..',0}</div>
    <div class="meta">Posted on 2003-07-06 22:17:30 by P2M</div>
   </div>
   <div class="post" id="post-109499">
    <div class="subject"><a href="#post-109499">Recursive file search with mask</a></div>
    <div class="body">Thanks P2M,<br />imho, it is not wrong<br />{'.'} is the first byte of {..} and<br />I compare 1st byte '.' only<br />and it is enough<br />We have no other stuff in the directory<br />begining with &quot;.&quot;, just &quot;.&quot; and &quot;..&quot;<br />Can you create file or dir with name &quot;.P2M&quot;?<br />or &quot;...P2M&quot;?<br /><br />As you saw I don't use strcmp()<br />and don't  need  zeroes because of that <br /><br />Regards,<br />Lingo</div>
    <div class="meta">Posted on 2003-07-06 23:09:25 by lingo12</div>
   </div>
   <div class="post" id="post-109507">
    <div class="subject"><a href="#post-109507">Recursive file search with mask</a></div>
    <div class="body"><strong>lingo12</strong> <br /><em>Can you create file or dir with name &quot;.P2M&quot;? or &quot;...P2M&quot;?</em><br />I have done this on w2k and w98se.</div>
    <div class="meta">Posted on 2003-07-07 00:14:50 by P2M</div>
   </div>
   <div class="post" id="post-109546">
    <div class="subject"><a href="#post-109546">Recursive file search with mask</a></div>
    <div class="body">Ok, I'll correct  it<br /><br />Thanks <br /><br />Lingo</div>
    <div class="meta">Posted on 2003-07-07 07:29:12 by lingo12</div>
   </div>
   <div class="post" id="post-109616">
    <div class="subject"><a href="#post-109616">Recursive file search with mask</a></div>
    <div class="body">P2M,<br />Here is updated version<br /><br />Thanks<br />Lingo</div>
    <div class="meta">Posted on 2003-07-07 18:12:53 by lingo12</div>
   </div>
   <div class="post" id="post-110027">
    <div class="subject"><a href="#post-110027">My try</a></div>
    <div class="body">I have tried to make recursive file search with anymask you want.I have tested on Win98 SE and it worked.I dont know if it works for you anyway hope you like it.<br /><br /><pre><code><br />.data<br />gMask db &quot;*&quot;,0<br />sls db &quot;\&quot;,0<br />;usage invoke SearchFiles,CTEXT&#40;&quot;C&#58;\NCDTREE\&quot;&#41;,CTEXT&#40;&quot;*.zip&quot;&#41;,0,1<br /><br />SearchFiles PROC szPath&#58;DWORD,szMask&#58;DWORD,pFunc&#58;DWORD,bRec&#58;DWORD<br />LOCAL wc&#58;WIN32_FIND_DATA<br />LOCAL hFind&#58;DWORD<br />LOCAL tBuff&#91;2*MAX_PATH&#93;&#58;BYTE<br />LOCAL tBuff2&#91;2*MAX_PATH&#93;&#58;BYTE<br /><br /><br />	invoke lstrcpy,addr tBuff,szPath <br />	invoke lstrcat,addr tBuff,addr gMsk ;X&#58;\dir\*.*<br />	invoke FindFirstFile,addr tBuff, addr wc<br />	cmp eax,INVALID_HANDLE_VALUE<br />	jz @nofile<br />	mov hFind,eax<br />	test eax,eax<br />	jz @endsearch<br /><br />@search&#58;<br />	cmp byte ptr wc.dwFileAttributes,FILE_ATTRIBUTE_DIRECTORY<br />	jnz @next  ;@passed<br />	cmp byte ptr wc.cFileName,'.'<br />	jz @next<br />	<br />	invoke lstrcpy,addr tBuff2, szPath<br />	invoke lstrcat,addr tBuff2,addr wc.cFileName<br />	invoke lstrcat,addr tBuff2,addr sls<br />;-- --------------------------&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />;callback for directory if you want	<br />;		invoke MessageBox,0,addr tBuff2,0,MB_OK<br />		<br />;----------------------------&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;		<br />	cmp bRec,0<br />	jz @next<br />	invoke SearchFiles,addr tBuff2,szMask,pFunc,bRec<br /><br />@next&#58;<br />	invoke FindNextFile,hFind,addr wc<br />	or eax,eax<br />	jne @search<br />	invoke FindClose,hFind ;finished searching subdirs<br />		<br />;---------------------------------------------------------<br />	invoke lstrcpy,addr tBuff,szPath<br />	invoke lstrcat,addr tBuff, szMask <br />	invoke FindFirstFile,addr tBuff, addr wc	<br />	cmp eax,INVALID_HANDLE_VALUE<br />	jz @nomaskedfile<br />	mov hFind,eax<br />	test eax,eax<br />	jz @maskend<br /><br />@searchmask&#58;<br />	invoke lstrcpy,addr tBuff2, szPath<br />	invoke lstrcat,addr tBuff2,addr wc.cFileName<br />	cmp byte ptr wc.dwFileAttributes,FILE_ATTRIBUTE_DIRECTORY<br />	jz @nope  ;we can have some dirs with mask<br />;---------------------------------------	<br />;callback function for file<br />	invoke MessageBox,0,addr tBuff2,0,MB_OK	<br />;---------------------------------------<br /><br />@nope&#58;	<br />	invoke FindNextFile,hFind,addr wc<br />	or eax,eax<br />	jne @searchmask<br />	invoke FindClose,hFind ;finished searching subdirs	<br />	jmp @endsearch<br />	<br />@nomaskedfile&#58;<br />@nofile&#58;<br />	xor eax,eax	<br />	dec eax<br />@maskend&#58;<br />@endsearch&#58;<br />	ret<br />SearchFiles	ENDP<br /></code></pre></div>
    <div class="meta">Posted on 2003-07-10 18:27:22 by LaptoniC</div>
   </div>
   <div class="post" id="post-110096">
    <div class="subject"><a href="#post-110096">Another version</a></div>
    <div class="body">I have also coded little fast and small version of this proc but it needs shlwapi.dll <br /><br /><pre><code><br />SearchFiles PROC szPath&#58;DWORD,szMask&#58;DWORD,pFunc&#58;DWORD,bRec&#58;DWORD<br />LOCAL wc&#58;WIN32_FIND_DATA<br />LOCAL hFind&#58;DWORD<br />LOCAL tBuff&#91;2*MAX_PATH&#93;&#58;BYTE<br />LOCAL tBuff2&#91;2*MAX_PATH&#93;&#58;BYTE<br /><br />	invoke lstrcpy,addr tBuff,szPath<br />	invoke lstrcat,addr tBuff, addr gMsk ;--------------&gt;<br />	invoke FindFirstFile,addr tBuff, addr wc<br />	cmp eax,INVALID_HANDLE_VALUE<br />	jz @nofile<br />	mov hFind,eax<br />	test eax,eax<br />	jz @endsearch<br /><br />@search&#58;	<br />	invoke lstrcpy,addr tBuff2, szPath<br />	invoke lstrcat,addr tBuff2,addr wc.cFileName<br />	cmp byte ptr wc.dwFileAttributes,FILE_ATTRIBUTE_DIRECTORY<br />	jnz @itisfile  ;@passed<br />	cmp byte ptr wc.cFileName,'.'<br />	jz @next<br />	invoke lstrcat,addr tBuff2,addr sls		<br /><br />;------------------------------callback for directory-----------------	<br />	invoke MessageBox,0,addr tBuff2,0,MB_OK		<br />;------------------------------callback for directory-----------------	<br /><br />	cmp bRec,0<br />	jz @next<br />	invoke	SearchFiles,addr tBuff2,szMask,0,bRec <br />	jmp @next<br /><br />@itisfile&#58;<br />	invoke PathMatchSpec,addr wc.cFileName,szMask ;requires shlwapi.dll <br />	test eax,eax<br />	jz @next<br /><br />;------------------------------callback for file-----------------	<br />	invoke MessageBox,0,addr tBuff2,0,MB_OK		<br />;------------------------------callback for file-----------------	-	<br /><br />@next&#58;<br />	invoke FindNextFile,hFind,addr wc<br />	test eax,eax<br />	jnz	 @search<br />	invoke FindClose,hFind<br /><br />@endsearch&#58;<br />;	xor eax,eax<br />@nofile&#58;<br />	ret<br />SearchFiles ENDP<br /></code></pre></div>
    <div class="meta">Posted on 2003-07-11 08:34:47 by LaptoniC</div>
   </div>
   <div class="post" id="post-110146">
    <div class="subject"><a href="#post-110146">Recursive file search with mask</a></div>
    <div class="body"><div class="quote"><br /><strong>lingo12</strong> <br /><em>Can you create file or dir with name &quot;.P2M&quot;? or &quot;...P2M&quot;?</em><br />I have done this on w2k and w98se. </div><br /><span style="font-size:18px>HOW?</span> :eek:</div>
    <div class="meta">Posted on 2003-07-11 19:07:20 by QvasiModo</div>
   </div>
   <div class="post" id="post-110165">
    <div class="subject"><a href="#post-110165">Recursive file search with mask</a></div>
    <div class="body"><strong>LaptoniC,</strong><br /><br />Thank you  for sharing your code<br />It will be better to have an example with it<br />just to test the speed.<br /><br />As I stated above it is faster to use FindFirstFile<br />and FindNextFile ONLY.<br />Here is my updated example with filters<br /><br /><br /><br /><strong>QvasiModo</strong><br />from dos <br /><br />Regards,<br />Lingo</div>
    <div class="meta">Posted on 2003-07-11 22:02:27 by lingo12</div>
   </div>
   <div class="post" id="post-110194">
    <div class="subject"><a href="#post-110194">Recursive file search with mask</a></div>
    <div class="body">explorer doesn't seem to want to rename files to something starting with . (&quot;enter a filename&quot;).<br />Then again, there's always a shell:<br />07/12/2003  03:26p                   0 .test<br /><br />Need to look at 3 chars (4 compares) instead of one. Oh well :)</div>
    <div class="meta">Posted on 2003-07-12 08:31:55 by Jan Wassenberg</div>
   </div>
   <div class="post" id="post-110195">
    <div class="subject"><a href="#post-110195">Recursive file search with mask</a></div>
    <div class="body">lingo12 I didnt said it is faster than yours just faster than my previous version :) I am not good on speed issues :tongue:  Sorry for my bad english.I posted this two because your first proc covers just all files and directories.For example if I change mask to *.exe in your first proc it will find only exe files in the C:\ and it stops.Frankly,I prefer codes that I understand at first glance, and which I can pass arguments to it.I am connected to net with GPRS phone and these days it is very bad.So I cant upload anything it just resets after some time.It is my second try for this post.However I really want to see how I can optimize it and what score it gets.Best regards<br /><br />EDIT:I have looked your new proc and saw that you are using your own filter function for file (CheckFilter:).I guess it doesnt handle multiple filters ie <em>*.asm;*.inc</em><br /><br />Please if you update your source,could you make more understanble for newbies like me.I dont like to play with stack :)</div>
    <div class="meta">Posted on 2003-07-12 08:34:54 by LaptoniC</div>
   </div>
  </div>
 </body>
</html>