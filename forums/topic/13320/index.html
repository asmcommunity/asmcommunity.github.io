<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>How would I go about not using a &quot;proc&quot;? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=13320" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=13320">How would I go about not using a &quot;proc&quot;?</a></p>
   <div class="post" id="post-103217">
    <div class="subject"><a href="#post-103217">How would I go about not using a &quot;proc&quot;?</a></div>
    <div class="body">In m quest to learn assembly, I want to find out and try all I can.  I don't use invoke anymore, and in my next step I would like to know how I would code not using procs.<br /><br />I have the following:<br /><pre><code><br />Draw3DLine proc uses esi edi ebx hDc&#58;DWORD, LineBegin&#58;DWORD, LineEnd&#58;DWORD, LineTop&#58;DWORD<br />LOCAL	MyPen&#58;DWORD<br />LOCAL	OldPen&#58;DWORD<br /><br />	mov	edi, &#91;hDc&#93;<br />	mov	esi, &#91;LineTop&#93;<br />	mov	ebx, &#91;LineBegin&#93;<br />	<br />	push	COLOR_BTNSHADOW<br />	call	GetSysColor<br />	<br />	push	eax<br />	push	1<br />	push	PS_SOLID<br />	call	CreatePen<br />	mov	&#91;MyPen&#93;, eax<br /><br />	push	eax<br />	push	edi<br />	call	SelectObject<br />	mov	&#91;OldPen&#93;, eax<br /><br />	push	0<br />	push	esi<br />	push	ebx<br />	push	edi<br />	call	MoveToEx<br /><br />	push	esi<br />	push	&#91;LineEnd&#93;<br />	push	edi<br />	call	LineTo<br /><br />	push	&#91;OldPen&#93;<br />	push	edi<br />	call	SelectObject<br />	<br />	push	&#91;MyPen&#93;<br />	call	DeleteObject<br /><br />; Line 2<br />	inc	esi<br />	push	COLOR_BTNHIGHLIGHT<br />	call	GetSysColor<br />	<br />	push	eax<br />	push	1<br />	push	PS_SOLID<br />	call	CreatePen<br />	mov	&#91;MyPen&#93;, eax<br /><br />	push	eax<br />	push	edi<br />	call	SelectObject<br />	mov	&#91;OldPen&#93;, eax<br /><br />	push	0<br />	push	esi<br />	push	ebx<br />	push	edi<br />	call	MoveToEx<br /><br />	push	esi<br />	push	&#91;LineEnd&#93;<br />	push	edi<br />	call	LineTo<br /><br />	push	&#91;OldPen&#93;<br />	push	edi<br />	call	SelectObject<br />	<br />	push	&#91;MyPen&#93;<br />	call	DeleteObject<br /><br />	ret<br />Draw3DLine endp<br /></code></pre><br />and I call it with:<br /><pre><code><br />	push	35<br />	push	5<br />	push	435<br />	push	&#91;ps.hdc&#93;<br />	call	Draw3DLine<br /></code></pre><br />and masm fixes the stack for me on return.<br /><br />so would something like the following be correct?<br />move MyPen and OldPen to the .data? section.<br /><br />create a label named Draw3DLine and execute like:<br /><pre><code><br />	push	35<br />	push	5<br />	push	435<br />	push	&#91;ps.hdc&#93;<br />	jmp	Draw3DLine<br /><br />and somewhere in the source&#58;<br /><br />Draw3DLine&#58;<br />	push	edi<br />	push	esi<br />	push	ebx<br />	<br />	push	ebp<br />	mov	ebp, esp<br /><br />	mov	edi, &#91;ebp + 20&#93;<br />	mov	esi, &#91;ebp + 32&#93;<br />	mov	ebx, &#91;ebp + 24&#93;<br />	<br />	push	COLOR_BTNSHADOW<br />	call	GetSysColor<br />	<br />	push	eax<br />	push	1<br />	push	PS_SOLID<br />	call	CreatePen<br />	mov	&#91;MyPen&#93;, eax<br /><br />	push	eax<br />	push	edi<br />	call	SelectObject<br />	mov	&#91;OldPen&#93;, eax<br /><br />	push	0<br />	push	esi<br />	push	ebx<br />	push	edi<br />	call	MoveToEx<br /><br />	push	esi<br />	push	&#91;ebp + 28&#93;<br />	push	edi<br />	call	LineTo<br /><br />	push	&#91;OldPen&#93;<br />	push	edi<br />	call	SelectObject<br />	<br />	push	&#91;MyPen&#93;<br />	call	DeleteObject<br /><br />	pop	ebp<br />	pop	ebx<br />	pop	esi<br />	pop	edi<br />	<br />	add	esp, 16<br />	ret<br /></code></pre><br />Can it be that simple?  No, it feels like I am missing something or doing something wrong in the example...<br /><br />Teach me!</div>
    <div class="meta">Posted on 2003-05-15 12:22:16 by Gunner</div>
   </div>
   <div class="post" id="post-103229">
    <div class="subject"><a href="#post-103229">How would I go about not using a &quot;proc&quot;?</a></div>
    <div class="body">I think first in your case access args at offsets EBP+14h to EBP+20h and seconds to exit properly use (the arglist is released after the return address)<br /><br />	pop	ebp<br />	pop	ebx<br />	pop	esi<br />	pop	edi<br /><br />	add	esp, 20<br />	jmps </div>
    <div class="meta">Posted on 2003-05-15 14:15:38 by _Servil_</div>
   </div>
   <div class="post" id="post-103230">
    <div class="subject"><a href="#post-103230">How would I go about not using a &quot;proc&quot;?</a></div>
    <div class="body">ret 16</div>
    <div class="meta">Posted on 2003-05-15 14:32:10 by iblis</div>
   </div>
   <div class="post" id="post-103244">
    <div class="subject"><a href="#post-103244">How would I go about not using a &quot;proc&quot;?</a></div>
    <div class="body">It's more convenient to establish the stack frame first, so that the first parameter on the stack is always at the same offset.<br /><pre><code>proc1&#58;<br />    push  ebp<br />    mov   ebp,esp<br />    ; first parameter &#40;last stacked value&#41; is at &#91;ebp+8&#93;<br /><br />    ; first local DWORD is at &#91;ebp-4&#93;<br />    sub   esp,number_of_local_bytes    ; allocate local variables<br /><br />    ; if EBX, ESI, or EDI are used in this proc, save them here<br />    ; ...<br />    ; restore EBX, ESI, or EDI if they were saved<br /><br />    mov   esp,ebp    ; this will deallocate local variables<br />    pop   ebp<br />    ret   number_of_argument_bytes<br /></code></pre>You still need to use<br /><br />call proc1<br /><br /><strong>call</strong> is not a macro, it is a real x86 instruction.<br /><br />If you pass values only in registers and don't create local variables, you only need a simple <strong>ret</strong>. The rest of the code wouldn't be needed. If this proc is never called directly from Windows, you can dictate what registers will or will not be saved.</div>
    <div class="meta">Posted on 2003-05-15 15:59:41 by tenkey</div>
   </div>
   <div class="post" id="post-103277">
    <div class="subject"><a href="#post-103277">How would I go about not using a &quot;proc&quot;?</a></div>
    <div class="body">Procs are usefull when you think its code could be reused without modification. If you dont think it could have any future value, use global variables or registers (or EQUates) to feed the &quot;routine&quot; as they used to be called. <br /><br />Using the stack is prone to errors and just makes your code less readable for yourself when debugging. And you dont have to build stack frames, its cleanup, and everything associated with it. You know: the KISS principle!!!<br /><br />Raymond</div>
    <div class="meta">Posted on 2003-05-15 22:52:41 by Raymond</div>
   </div>
   <div class="post" id="post-103282">
    <div class="subject"><a href="#post-103282">How would I go about not using a &quot;proc&quot;?</a></div>
    <div class="body">tenkey, I think is better to say<br />ret number_of_arguments*4<br />insead of<br /> ret   number_of_argument_bytes<br />since<br />We can simply say that everything in win32 thats being pushed to the stack becomes a dword (else the stack might very soon be dis-aligned, NT is said to generate an exception if not aliged).<br /><br />(btw, KISS = Keep It Simple and Safe, (am I right about the &quot;safe&quot;?))</div>
    <div class="meta">Posted on 2003-05-15 23:26:39 by scientica</div>
   </div>
   <div class="post" id="post-103288">
    <div class="subject"><a href="#post-103288">How would I go about not using a &quot;proc&quot;?</a></div>
    <div class="body">Wow, lots o' info here... have to take it all in.<br /><br />Thanks</div>
    <div class="meta">Posted on 2003-05-15 23:48:16 by Gunner</div>
   </div>
   <div class="post" id="post-103312">
    <div class="subject"><a href="#post-103312">How would I go about not using a &quot;proc&quot;?</a></div>
    <div class="body">I think you do not need call labels unless you want to remove the stack frame. Of course you can also use pops in your proc like<br /><br /><pre><code><br />func&#58;<br />pop eax<br />pop ecx;first parameter<br />push eax<br />...<br />ret <br /></code></pre></div>
    <div class="meta">Posted on 2003-05-16 01:13:01 by roticv</div>
   </div>
   <div class="post" id="post-103359">
    <div class="subject"><a href="#post-103359">How would I go about not using a &quot;proc&quot;?</a></div>
    <div class="body">scientica<br /><br />KISS used to be an acronym for <strong>Keep It Simple Stupid</strong>. I would guess this was invented to refer to people complicating things just to give the impression of being smarter (such as some civil servants for example). <br /><br />This has nothing to do with Gunner though.:stupid: <br /><br />Nowadays, the &quot;KISS principle&quot; means to keep things as simple as you can, avoiding any complicated or superfluous detail.<br /><br />Raymond</div>
    <div class="meta">Posted on 2003-05-16 08:06:25 by Raymond</div>
   </div>
   <div class="post" id="post-103782">
    <div class="subject"><a href="#post-103782">How would I go about not using a &quot;proc&quot;?</a></div>
    <div class="body"><div class="quote"><br />segment code class=code  use32<br /><br />..start:<br />	push	dword 4	;ebp+28 or four argument<br />	push	dword 3	;ebp+24 or third argument<br />	push	dword 2	;ebp+20 or second argument<br />	push	dword 1	;ebp+16 or first argument<br />	jmp	Draw3DLine<br /><br /><br />Draw3DLine:<br />	push	edi		;ebp+12<br />	push	esi		;ebp+8<br />	push	ebx		;ebp+4<br />	<br />	push	ebp		;&lt;--here is where stack frame is created, ebp+0 or only ebp <br />	mov	ebp, esp	     ;and here<br />	<br />	;first param<br />	mov	dword, 11<br />	;second<br />	mov	dword, 21<br />	;third<br />	mov	dword, 31<br />	;four<br />	mov dword, 41<br />	pop	ebp<br />	pop	ebx<br />	pop	esi<br />	pop	edi<br />	<br />	add	esp, 16<br />	ret<br /></div> <br /><br />you are trying use a combination of stack frame and the other technique only with the use of esp without stack frame, i recomend this post <a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=11425">Locals without stack frame</a> i think is really complete ;) aned i learn a lot there, but here you are triying to mix both techniques.<br /><br />the first technique with stack frame: use the pair enter/leave in the start/end of the function and if you allocate space for local bars it dosent matter, only keep the track of push/pop pairs<br /><br />the second technique is a little short (normally two instructions less ), here you only use a reference from esp and dont lost time in pushing ebp and mov ebp, esp<br /><br />i check the code above and is the correct, with the olly, but i sugest that try first like tenkey say, try first establish the stack frame<br /><div class="quote"><br /><br />segment code class=code  use32<br /><br />..start:<br />	push	dword 4	;ebp+16<br />	push	dword 3	;ebp+12<br />	push	dword 2	;ebp+8<br />	push	dword 1	;ebp+4<br />	jmp	Draw3DLine<br /><br /><br />Draw3DLine:	<br />	push	ebp		;&lt;--here is where stack frame is created, ebp+0 or only ebp <br />	mov	ebp, esp	;and here<br />	push	edi		;ebp-4<br />	push	esi		;ebp-8<br />	push	ebx		;ebp-12<br />	;here you can  allocate space for local vars with sub esp, size<br />	;first param<br />	mov	dword, 11<br />	;second<br />	mov	dword, 21<br />	;third<br />	mov	dword, 31<br />	;four<br />	mov dword, 41<br />	pop	ebx<br />	pop	esi<br />	pop	edi<br />	pop	ebp<br />	add	esp, 16 ;+size here you can liberate the space of the posible local vars<br />	ret<br /></div><br /><br />But the first idea is correct, like you see, the stack frame let you reference arguments and local vars from it place<br /><br />I think only is maybe or maybe not more readable the last one.</div>
    <div class="meta">Posted on 2003-05-18 17:02:53 by rea</div>
   </div>
   <div class="post" id="post-103924">
    <div class="subject"><a href="#post-103924">How would I go about not using a &quot;proc&quot;?</a></div>
    <div class="body">I'm on holiday at the moment, but I just noticed your message about not using PROC.<br /><br />I wrote a tutorial on this (&quot;Understand the Stack - Part 2&quot;) which you can get from <a target="_blank" href="http://www.GoDevTool.com">GoDevTool.com</a> and there is also some sample code in my demo program TestBug.<br /><br />My assembler GoAsm uses the word FRAME instead of PROC, to emphasise the fact that you are making a stack frame when you use this assembler directive, something which I believe is not always understood.<br /><br />In normal use (no local data required) you would not need to make a stack frame, although it is convenient to do this to get parameters (arguments).</div>
    <div class="meta">Posted on 2003-05-19 20:41:21 by jorgon</div>
   </div>
   <div class="post" id="post-103934">
    <div class="subject"><a href="#post-103934">How would I go about not using a &quot;proc&quot;?</a></div>
    <div class="body">hgb,<br /><br />I think you should replace the jmp Draw3DLine with call Draw3DLine, since ret expects the return address to be push onto the stack.</div>
    <div class="meta">Posted on 2003-05-19 21:15:18 by roticv</div>
   </div>
   <div class="post" id="post-103948">
    <div class="subject"><a href="#post-103948">thx</a></div>
    <div class="body">thx for remember me that.. that a call is like two instruction push the next addres ( i miss this, sorry), and jmp to the proc/funct, also i correct now that...<br /><br />in the first form (Gunner original) is <br /><pre><code><br />segment code class=code  use32<br /><br />..start&#58;<br />	push	dword 4	;ebp+32<br />	push	dword 3	;ebp+28<br />	push	dword 2	;ebp+24<br />	push	dword 1	;ebp+20<br />	push dword $+10 ;ebp+16<br />	jmp Draw3DLine<br />	add	esp, 16<br />	push dword 0<br />	extern ExitProcess<br />	call &#91;ExitProcess&#93;<br /><br />Draw3DLine&#58;<br />	push	edi		;ebp+12<br />	push	esi		;ebp+8<br />	push	ebx		;ebp+4<br />	<br />	push	ebp		;&lt;--here is where stack frame is created<br />	mov	ebp, esp	;and here<br />	<br />	;first param<br />	mov	dword&#91;ebp + 20&#93;, 11<br />	;second<br />	mov	dword&#91;ebp + 24&#93;, 21<br />	;third<br />	mov	dword&#91;ebp + 28&#93;, 31<br />	;four<br />	mov dword&#91;ebp + 32&#93;, 41<br />	pop	ebp<br />	pop	ebx<br />	pop	esi<br />	pop	edi<br />	ret<br /></code></pre><br /><br />and in the &quot;form&quot; i sugest is<br /><pre><code><br />	push	dword 4	;ebp+32<br />	push	dword 3	;ebp+28<br />	push	dword 2	;ebp+24<br />	push	dword 1	;ebp+20<br />	push dword $+10 ;ebp+16<br />	jmp Draw3DLine<br />	add	esp, 16<br />	push dword 0<br />	extern ExitProcess<br />	call &#91;ExitProcess&#93;<br /><br />Draw3DLine&#58;<br />	push	edi		;ebp+12<br />	push	esi		;ebp+8<br />	push	ebx		;ebp+4<br />	<br />	push	ebp		;&lt;--here is where stack frame is created<br />	mov	ebp, esp	;and here<br />	<br />	;first param<br />	mov	dword&#91;ebp + 20&#93;, 11<br />	;second<br />	mov	dword&#91;ebp + 24&#93;, 21<br />	;third<br />	mov	dword&#91;ebp + 28&#93;, 31<br />	;four<br />	mov dword&#91;ebp + 32&#93;, 41<br />	pop	ebp<br />	pop	ebx<br />	pop	esi<br />	pop	edi<br />	ret<br /></code></pre><br /><br />like you see, i &quot;balance&quot; the stack after the call, in the next instruction and not inside, this is only if you want use ret, but remember that balance the stack, and push pop dont destroy the values, only if you move data there directly, or make another push over a pop... ok.. what i am saying.,.. is that you dont need balance the stack after the call, you can do inside of your function.. and instead of using ret instruction, you can use some like  _Servil_  say, is correct use a jump in this case... is like this...<br /><br /><pre><code><br />segment code class=code  use32<br /><br />..start&#58;<br />	push	dword 4	;ebp+20<br />	push	dword 3	;ebp+16<br />	push	dword 2	;ebp+12<br />	push	dword 1	;ebp+8<br />	push dword $+10 ;ebp+4<br />	jmp Draw3DLine<br />	push dword 0<br />	extern ExitProcess<br />	call &#91;ExitProcess&#93;<br /><br />Draw3DLine&#58;<br />	push	ebp		;&lt;--here is where stack frame is created<br />	mov	ebp, esp	;and here<br />	push	edi		;ebp-4<br />	push	esi		;ebp-8<br />	push	ebx		;ebp-12<br /><br />	<br />	;first param<br />	mov	dword&#91;ebp + 8&#93;, 11<br />	;second<br />	mov	dword&#91;ebp + 12&#93;, 21<br />	;third<br />	mov	dword&#91;ebp + 16&#93;, 31<br />	;four<br />	mov dword&#91;ebp + 20&#93;, 41<br />	pop	ebp<br />	pop	ebx<br />	pop	esi<br />	pop	edi<br />	;here balance the stack inside<br />	;and not use ret instruction<br />;edit.. and remember the values still there in memory you can overwrite this value only if you move data there directly or push a value  there<br />	add	esp, 16<br />	jmp &#91;esp-16&#93;<br /></code></pre><br /><br />thank all rotvic for correct me... amm i canot sa. i saw texting the knowledge.. i was wrong from the start... thx  _ervil_ for the idea of the jump, the starter Gunner and thx for all the other people, this let me remember what is a call, understand and learn a little more :D<br /><br /><br /><br />I check now all the trhee examples, works ok... with the olly.. the thing what append that i assume in my other examples.. was ok.. is tha t the return address.. waas exactly the call to terminateThread.. or some like that :S lol<br /><br /><br />Have nice day.:alright:</div>
    <div class="meta">Posted on 2003-05-19 22:36:21 by rea</div>
   </div>
   <div class="post" id="post-103960">
    <div class="subject"><a href="#post-103960">How would I go about not using a &quot;proc&quot;?</a></div>
    <div class="body">Remove stack frame and do not use ebx, esi, edi (Thus no need to preserve them)<br /><pre><code><br />push ..<br />push ..<br />push ..<br />push ..<br />call Draw3DLine<br />..<br /><br />Draw3DLine&#58;<br />sub esp,8<br />invoke GetSysColor, COLOR_BTNSHADOW<br />invoke CreatePen, PS_SOLID,1,eax<br />mov &#91;esp&#93;,eax<br />push eax<br />push &#91;esp+8+4&#93;<br />call SelectObject<br />mov &#91;esp+4&#93;,eax<br />push 0<br />push &#91;esp+8+16&#93;<br />push &#91;esp+8+8&#93;<br />push &#91;esp+8+4&#93;<br />call MoveToEx<br />push &#91;esp+8+16&#93;<br />push &#91;esp+8+12&#93;<br />push &#91;esp+8+4&#93;<br />call LineTo<br />push &#91;esp+4&#93;<br />push &#91;esp+8+4&#93;<br />call SelectObject<br />push &#91;esp&#93;<br />call DeleteObject<br />invoke GetSysColor, COLOR_BTNHIGHLIGHT<br />invoke CreatePen, PS_SOLID, 1 ,eax<br />mov &#91;esp&#93;,eax<br />push eax<br />push &#91;esp+8+4&#93;<br />call SelectObject<br />mov &#91;esp+8&#93;,eax<br />push 0<br />inc dword ptr&#91;esp+8+16&#93;<br />push &#91;esp+8+16&#93;<br />push &#91;esp+8+8&#93;<br />push &#91;esp+8+4&#93;<br />call MoveToEx<br />push &#91;esp+8+16&#93;<br />push &#91;esp+8+12&#93;<br />push &#91;esp+8+4&#93;<br />call LineTo<br />push &#91;esp+4&#93;<br />push &#91;esp+8+4&#93;<br />call SelectObject<br />push &#91;esp&#93;<br />call DeleteObject<br />add esp,8<br />ret 16<br /></code></pre><br />*Note: Untested<br />Anyway It would be easier to work with invoke and stuffs like that for gdi. <br />hehe... seems like my code is longer and more confusing (Kids do not try this at home :) )</div>
    <div class="meta">Posted on 2003-05-20 00:31:46 by roticv</div>
   </div>
  </div>
 </body>
</html>