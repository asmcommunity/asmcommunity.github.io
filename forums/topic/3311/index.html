<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Crash detection - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=3311" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=3311">Crash detection</a></p>
   <div class="post" id="post-21881">
    <div class="subject"><a href="#post-21881">Crash detection</a></div>
    <div class="body">Hey guys, have a question a little off topic for ASM and more towards C++/MFC. (I think)<br /><br />When an application crashes abnormally. Something you don't assert, just a plain run of the mill &quot;crash&quot;. Is there a way to perform some final actions before the application terminates.<br /><br />The application I am working on for work has the odd crash. I want to safeguard the data by performing a save of the data to a temp recovery file before it dies so that the work of the end user is not lost. Then the app can reload this recovery file with their work.<br /><br />How would you do this? If possible, any MFC/C++ programmers can indicate the MFC/C++ way of doing this that would be great.<br /><br />thanx</div>
    <div class="meta">Posted on 2002-01-29 18:24:21 by Rockinronstar</div>
   </div>
   <div class="post" id="post-21893">
    <div class="subject"><a href="#post-21893">Crash detection</a></div>
    <div class="body">You can use below proc for detection<br /><br /><pre><code><br />.data?<br />exceptbuff	db 207 dup&#40;?&#41;<br />.code<br />invoke SetUnhandledExceptionFilter,offset MydumyProc<br /><br />int 3 ;lets make and exception<br /><br /><br /><br />MydumyProc PROC uses ebx esi edi exp&#58;DWORD<br />mov eax, &#40;EXCEPTION_POINTERS ptr &#91;exp&#93;&#41;.pExceptionRecord<br />mov ebx, &#40;EXCEPTION_POINTERS  ptr&#91;eax&#93;&#41;.ContextRecord<br />mov eax, &#40;EXCEPTION_RECORD  ptr&#91;eax&#93;&#41;.ExceptionCode<br />push &#40;EXCEPTION_RECORD  ptr&#91;eax&#93;&#41;.ExceptionAddress<br />push &#40;EXCEPTION_RECORD  ptr&#91;eax&#93;&#41;.ExceptionCode<br />push CTEXT&#40;'Program caused %.8lXh exception at %.8lXh!',0dh,0ah&#41;<br />push offset exceptbuff<br />call wsprintf<br />add     esp, 10h<br />add eax,offset exceptbuff<br />assume ebx&#58;PTR CONTEXT<br /><br />push &#91;ebx&#93;.regEax<br />push &#91;ebx&#93;.regEbx<br />push &#91;ebx&#93;.regEcx<br />push &#91;ebx&#93;.regEdx<br />push &#91;ebx&#93;.regEsi<br />push &#91;ebx&#93;.regEdi<br />push &#91;ebx&#93;.regEsp<br />push &#91;ebx&#93;.regEbp<br />push &#91;ebx&#93;.regEip<br />push offset regcont<br />push eax<br />call wsprintf<br />add     esp, 2Ch<br /><br />invoke MessageBox,0,addr exceptbuff,0,MB_OK<br />invoke MessageBox,0,CTEXT&#40;'Do you want to continue ?'&#41;,0,MB_YESNO<br />xor eax,IDYES<br />jz @exit<br />ret<br />@exit&#58;<br />;We can only pass int3 exception other exceptions<br />will keep asking you to contiue or not.<br /><br />dec eax<br />ret<br />MydumyProc ENDP<br /></code></pre><br /><br />It will show you the exception EIP registers.You can do whatever you want at this point.Hope it helps.</div>
    <div class="meta">Posted on 2002-01-29 19:35:54 by LaptoniC</div>
   </div>
   <div class="post" id="post-21896">
    <div class="subject"><a href="#post-21896">Crash detection</a></div>
    <div class="body">If you want more fine-grained control, look up Structured Exception Handling<br />aka SEH. Quite nice stuff really :). But if SetUnhandledExceptionFilter<br />does it for you, stay with that - it's a bit simpler.</div>
    <div class="meta">Posted on 2002-01-29 20:20:30 by f0dder</div>
   </div>
   <div class="post" id="post-21915">
    <div class="subject"><a href="#post-21915">Crash detection</a></div>
    <div class="body">that worked great. <br /><br />What I did was use my own Function to handle the exception and then set the old global exception handling back to default and let it spit up the messagebox and close the app<br /><br />sound like the proper way to do it?<br /><br />I also noticed you can even prevent Windows from closing the app and try and keep working. I ran into a problem with that right away!! tried resuming after a write to &quot;bad RAM&quot; and the whole computer almost blew up, haha<br /><br />seems best to do what you need, in my case save all data to a recovery file and then let Windows do its stuff and close the app like it wants to</div>
    <div class="meta">Posted on 2002-01-29 22:07:43 by Rockinronstar</div>
   </div>
   <div class="post" id="post-21972">
    <div class="subject"><a href="#post-21972">Crash detection</a></div>
    <div class="body"><div class="quote">seems best to do what you need, in my case save all data to a recovery file and then let Windows do its stuff and close the app like it wants to</div> <br /><br />Phew, I wish the big software developers (like Adobe, Corel, Microsoft, Lotus,..) would care about crashes like you do.<br /><br />Just my opinion.<br />YaWNS aka Stefan K</div>
    <div class="meta">Posted on 2002-01-30 07:05:03 by YaWNS</div>
   </div>
   <div class="post" id="post-21996">
    <div class="subject"><a href="#post-21996">Crash detection</a></div>
    <div class="body">me too, haha. The only big app I know of that saves a recovery file on crash is 3D Studio Max. I don't think they don't care, i think they don't know how to do it.<br /><br />I have safeguarded my entire app and have already gained some applause at work for it. It makes people feel more at ease knowing the safeguard exists</div>
    <div class="meta">Posted on 2002-01-30 11:07:40 by Rockinronstar</div>
   </div>
   <div class="post" id="post-21998">
    <div class="subject"><a href="#post-21998">sweet  :)</a></div>
    <div class="body">Nice code laptonic!</div>
    <div class="meta">Posted on 2002-01-30 11:37:07 by Will</div>
   </div>
   <div class="post" id="post-22005">
    <div class="subject"><a href="#post-22005">Crash detection</a></div>
    <div class="body"><div class="quote">Rockinstar wrote: ...I don't think they don't care, i think they don't know how to do it. </div> <br /><br />II've never came across a developer who wants their source to crash and keep returning for defect management.  I have, however, met management who doesn't want to allow the developers to plan and code properly versus get it out the door now, not tomarrow... and then treat each defect as a source of revenue for the next update/release...<br /><br />I, personally, when I wrote software for the police depts., took the time to design the product and then write extensive error handling and such, and let them do the testing pretty much... in three years, I've never had a single bug complaint on 4 different products...  and it only took me about 2 weeks or so the get the design finalized... so, large corporations can do it too... just a matter of whether management sees the value in waiting for a spec when they would rather see &quot;tangeable progress&quot; and if they can't see it or interact with it, it's not being progressed in their point-of-view.  It's a shame.    Beacuse we get blamed, not the managers... they think they're correct by doing this...<br /><br />the by product of this is that software is not stable.  I make it a habbit to design it whether they like it or not.  I'm always late on deadlines but they can't argue with customer satisfaction (when I'm employed doing it)... because nothing I work on returns for defects... no complaints is good news... (or bad, if you're hoping for revenue on defect correction)... as a result, they changed theyr pricing strategy to include subscriptions for updates/upgrades if any... rather than a per-update payment.<br /><br /><br /><br />Thanks,<br />_Shawn</div>
    <div class="meta">Posted on 2002-01-30 12:30:16 by _Shawn</div>
   </div>
   <div class="post" id="post-22022">
    <div class="subject"><a href="#post-22022">Crash detection</a></div>
    <div class="body">_Shawn, that is what I strive for as well<br /><br />Still nice to have a safeguard saving system in case the inevitable happens. But always best to never have to use it.</div>
    <div class="meta">Posted on 2002-01-30 14:57:47 by Rockinronstar</div>
   </div>
   <div class="post" id="post-22135">
    <div class="subject"><a href="#post-22135">Crash detection</a></div>
    <div class="body">try to play around with REAL seh like f0dder pointed out...<br /><br /><pre><code><br />        ASSUME  FS&#58;NOTHING<br /><br />        PUSHAD                             <br />        LEA EAX, EXCEPTIONHANDLER          <br />        PUSH EAX                           <br />        PUSH FS&#58;&#91;0&#93;                        <br />        MOV FS&#58;&#91;0&#93;, ESP                    <br />                                           <br />        ;PASTE YOUR CODE THAT COULD CAUSE<br />        ;AN ERROR... IF EVERYTHING WORKED<br />        ;FINE YOU HAVE TO RESTORE YOUR SEH!<br />                                           <br />        JMP RESTORESEH                                                                <br /><br /> EXCEPTIONHANDLER&#58;                         <br /><br />        MOV ESP, &#91;ESP+8&#93;            <br />        <br />        ;SOME ERROR OCCURED, DO WHAT YOU <br />        ;WANT TO DO NOW... BUT DON'T <br />        ;FORGET TO RESTORE YOUR SEH...<br />                                           <br /> RESTORESEH&#58;                               <br /><br />        POP FS&#58;&#91;0&#93;                         <br />        ADD ESP, 4                         <br />        POPAD       <br /></code></pre><br /><br />that's a very basic SEH frame, i wouldn't mess with the<br />stack or you could produce a gpf *after* the frame :)</div>
    <div class="meta">Posted on 2002-01-31 06:26:42 by mob</div>
   </div>
   <div class="post" id="post-22137">
    <div class="subject"><a href="#post-22137">Crash detection</a></div>
    <div class="body">I have done quite a bit of research and code writing with them already. I have fully safeguarded any possibility of errors destroying the end users data. Haven't had a crash on it yet but the thing about crashes is, you never know when they will happen. <br /><br />You can write as much error trapping as you want but if the problem is with other programs causing instability in the OS then your up the creek. This seems like the best way to safeguard data. Ever crash for any reason save the users data to a recovery file.<br /><br />It works quite well. I simulated a crash with int 3 and popped up a message indicating there was a crash and before I terminated the app I saved the data at its current state to a temp recovery file and then updated the .ini file indicating there was a crash recovery file made so next time they open the app I pop up an option to restore pre-crash project data<br /><br /><br />looks very professional, and if it ever needs to be called , I am sure someone will be thankful it exists</div>
    <div class="meta">Posted on 2002-01-31 06:58:24 by Rockinronstar</div>
   </div>
   <div class="post" id="post-22140">
    <div class="subject"><a href="#post-22140">Crash detection</a></div>
    <div class="body">if the problem is not caused by your prog you can't do<br />ANYTHING to avoid what will happen to your app... but<br />you can secure YOUR programm with seh-handlers and<br />somthing likea autosave feature... if you really need<br />this security add one or more seh handlers to your code<br />and save whatever needs to be saved every... say 10<br />minutes in a backup-file... you can also use flags to <br />indicate that your app was forced to close due to a <br />system-exception... (flag on prog-start, flag on prog<br />-end; if end-flag is missing something stange happened)<br />a couple of texteditors use similar features... i don't<br />use seh very often... i mean why? if you write clean <br />code there is no reason... autosave is far more <br />important then seh i think...</div>
    <div class="meta">Posted on 2002-01-31 07:14:11 by mob</div>
   </div>
   <div class="post" id="post-22163">
    <div class="subject"><a href="#post-22163">Crash detection</a></div>
    <div class="body">the instabilities some apps cause when they go bad can easily disrupt your own application. Take this case: it starts gobbling up memory very quickly, or even DC's very quickly. Then your app requests some RAM or a DC and there isn't any available. I am sure that every function in a persons app has exception handlers around themselves. In order for this to be effective you would need an try..catch system around every function. But this is rare, the system will probably never get to this point, maybe on Win95/98. I have had apps that have gone nuts and done the exact thing I mentioned which crashed everything open.<br /><br />I like the idea of a last resort handler in case the worst happens.<br /><br />And it eliminates the overhead of having exception handling in numerous places in your code.</div>
    <div class="meta">Posted on 2002-01-31 12:07:01 by Rockinronstar</div>
   </div>
   <div class="post" id="post-22223">
    <div class="subject"><a href="#post-22223">Hello Rockinronstar</a></div>
    <div class="body">I am trying to make your SetUnhandledExceptionFilter...I get ( syntax error : ,) I comment out CTEXT because I don't think i set it up right.... Could you tell me what i am doing wrong...<br /><br />.386<br />.model flat,stdcall<br />option casemap:none<br />WinMain proto :DWORD,:DWORD,:DWORD,:SWORD<br /><br />      include \MASM32\INCLUDE\windows.inc<br />      include \MASM32\INCLUDE\user32.inc<br />      include \MASM32\INCLUDE\kernel32.inc<br /><br />      includelib \MASM32\LIB\user32.lib<br />      includelib \MASM32\LIB\kernel32.lib<br /> <br />MessageBoxA PROTO :DWORD,:DWORD,:DWORD,:DWORD<br />MydumyProc PROTO :DWORD<br /><br />wsprintfA PROTO C :DWORD,:VARARG<br />wsprintf equ &lt;wsprintfA&gt;<br /><br />.data<br /><br />MyText            db   &quot;Message Box Only&quot;,0<br /><br />exceptbuff	db 207 dup(?)<br />regcont dd ?<br />CTEXT dd ?<br /><br />.data? <br /><br />.code<br />Main: <br />; ..................................................................................................<br /><br />invoke SetUnhandledExceptionFilter,offset MydumyProc<br /><br />;;;;;;;;;;;;;;int 3 ;lets make and exception<br /><br />invoke    MessageBoxA, NULL, ADDR MyText, NULL, NULL       <br />invoke    ExitProcess,0<br />;  ..................................................................................................<br /><br />MydumyProc PROC uses ebx esi edi exp:DWORD<br />mov eax, (EXCEPTION_POINTERS ptr ).pExceptionRecord<br />mov ebx, (EXCEPTION_POINTERS  ptr).ContextRecord<br />mov eax, (EXCEPTION_RECORD  ptr).ExceptionCode<br />push (EXCEPTION_RECORD  ptr).ExceptionAddress<br />push (EXCEPTION_RECORD  ptr).ExceptionCode<br />;;;;;;;;;;;;;;push CTEXT, ('Program caused %.8lXh exception at %.8lXh!',0dh,0ah)<br />push offset exceptbuff<br />call wsprintf<br />add     esp, 10h<br />add eax,offset exceptbuff<br />assume ebx:PTR CONTEXT<br /><br />push .regEax<br />push .regEbx<br />push .regEcx<br />push .regEdx<br />push .regEsi<br />push .regEdi<br />push .regEsp<br />push .regEbp<br />push .regEip<br />push offset regcont<br />push eax<br />call wsprintf<br />add     esp, 2Ch<br /><br />invoke MessageBox,0,addr exceptbuff,0,MB_OK<br />;;;;;;;;;;;;;;invoke MessageBox,0,CTEXT('Do you want to continue ?'),0,MB_YESNO<br /><br />xor eax,IDYES<br />jz @exit<br />ret<br />@exit:<br /><br />dec eax<br />ret<br />MydumyProc ENDP<br />                end     Main</div>
    <div class="meta">Posted on 2002-01-31 19:59:55 by cmax</div>
   </div>
   <div class="post" id="post-22237">
    <div class="subject"><a href="#post-22237">Crash detection</a></div>
    <div class="body">Most probably you dont have definitions of structures I use.They are in windows.inc maybe your is outdate.Define this structures<br /><br /><pre><code><br />EXCEPTION_MAXIMUM_PARAMETERS         equ 15<br />SIZE_OF_80387_REGISTERS   equ 80<br />MAXIMUM_SUPPORTED_EXTENSION          equ 512<br /><br />FLOATING_SAVE_AREA STRUCT<br />  ControlWord   DWORD      ?<br />  StatusWord    DWORD      ?<br />  TagWord       DWORD      ?<br />  ErrorOffset   DWORD      ?<br />  ErrorSelector DWORD      ?<br />  DataOffset    DWORD      ?<br />  DataSelector  DWORD      ?<br />  RegisterArea  BYTE  SIZE_OF_80387_REGISTERS dup&#40;?&#41;<br />  Cr0NpxState   DWORD      ?<br />FLOATING_SAVE_AREA ENDS<br /><br />CONTEXT STRUCT<br />  ContextFlags  DWORD      ?<br />  iDr0          DWORD      ?<br />  iDr1          DWORD      ?<br />  iDr2          DWORD      ?<br />  iDr3          DWORD      ?<br />  iDr6          DWORD      ?<br />  iDr7          DWORD      ?<br />  FloatSave     FLOATING_SAVE_AREA &lt;&gt;<br />  regGs         DWORD      ?<br />  regFs         DWORD      ?<br />  regEs         DWORD      ?<br />  regDs         DWORD      ?<br />  regEdi        DWORD      ?<br />  regEsi        DWORD      ?<br />  regEbx        DWORD      ?<br />  regEdx        DWORD      ?<br />  regEcx        DWORD      ?<br />  regEax        DWORD      ?<br />  regEbp        DWORD      ?<br />  regEip        DWORD      ?<br />  regCs         DWORD      ?<br />  regFlag       DWORD      ?<br />  regEsp        DWORD      ?<br />  regSs         DWORD      ?<br />  ExtendedRegisters db MAXIMUM_SUPPORTED_EXTENSION dup&#40;?&#41;<br />CONTEXT ENDS<br /><br />EXCEPTION_POINTERS STRUCT<br />  pExceptionRecord  DWORD      ?<br />  ContextRecord     DWORD      ?<br />EXCEPTION_POINTERS ENDS<br /><br />EXCEPTION_RECORD STRUCT<br />  ExceptionCode         DWORD      ?<br />  ExceptionFlags        DWORD      ?<br />  pExceptionRecord      DWORD      ?<br />  ExceptionAddress      DWORD      ?<br />  NumberParameters      DWORD      ?<br />  ExceptionInformation  DWORD EXCEPTION_MAXIMUM_PARAMETERS dup&#40;?&#41;<br />EXCEPTION_RECORD ENDS<br /></code></pre></div>
    <div class="meta">Posted on 2002-01-31 21:21:34 by LaptoniC</div>
   </div>
  </div>
 </body>
</html>