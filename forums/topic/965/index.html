<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>UrlDecode - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=965" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=965">UrlDecode</a></p>
   <div class="post" id="post-6246">
    <div class="subject"><a href="#post-6246">UrlDecode</a></div>
    <div class="body">Hi, <br />I'm very new to this and after reading a few tutorials (thanks a lot for the exagone-tuts!) I now wanted to get a little practical. <br />So this is the first task I gave me. Writing an UrlDecode-DLL. <br />It took me a while but now it works ! <br />But to me it looks very unstructured. <br />As you may see, I know very little opcodes and know very little about them. I'd really like to get to know better Assembler than that. Please teach me how to! <br />There are a few question: <br /><ul><br />[*]Is there an easyer way to convert 2 HexCars to a number? <br />[*]Does that &quot;cld&quot; have any relevance in this context? <br />[*]Is there a good way to take advantage of the &quot;rep&quot; command <br />[*]I feel very limited with creating a string of fixed length; Is there any other way but using the SysAllocStringByteLen?<br />[*]Is it better to do the HexConversion like this or with more jumping?<br /><br /><br />Thanks<br /><br /><pre><code><br />UrlDecode proc uses ecx , text&#58;DWORD<br />	LOCAL ReturnString$	&#58;DWORD<br />	LOCAL ln		&#58;DWORD<br />	LOCAL Occurencys	&#58;DWORD<br /><br />	push esi				;save esi and edi<br />	push edi<br /><br />	mov ecx, text<br />	xor eax, eax<br /><br />StartLengthLoop&#58;<br />	mov dl, &#91;ecx&#93;<br />	inc ecx					;GetStringLength<br />	cmp dl, &quot;%&quot;<br />	jne CharNotFound<br />	inc eax					;Count Occurency of &quot;%&quot;<br />CharNotFound&#58;<br />	cmp dl, 0<br />	jne StartLengthLoop<br /><br />	mov Occurencys, eax			;save &quot;%&quot;-Count as Occurencys<br />	sub ecx, text				;correct StringLength<br />	dec ecx<br />	shl eax, 1				;calculate NewStringLength<br />	sub ecx, eax<br /><br />	jns DontZeroEcx				;end if negative<br />	mov ecx, 0<br />DontZeroEcx&#58;<br /><br />	mov ln, ecx<br />	invoke SysAllocStringByteLen,0,ln	;Allocate Space for the resultString<br />	mov ReturnString$, eax<br />	<br />	cmp ln, 0				;End if Length is 0<br />	je TheEnd<br /><br />	mov esi, text				;Set Pointers to StringVars<br />	mov edi, ReturnString$<br />	mov ecx, ln				;set ecx to StringLength<br />	cld<br /><br />	add ln, edi<br />	cmp Occurencys, 0			;Check whether there need to be made any replacements<br />	je NoHex<br /><br />StartLoop&#58;					;Start of the ReplacmentLoop<br />	mov al, &#91;esi&#93;				;copy current char<br />	cmp al, &quot;%&quot;				;compare to &quot;%&quot;<br />	jne CharNotFound2<br /><br />	xor eax, eax<br />	inc esi<br />	mov ax, &#91;esi&#93;				;Get the 2 HexChars<br /><br />	mov dx,  ax				;Convert To Hex<br />	and dx,  16448				;01000000 01000000<br />	shr dx,  3<br />	add ax,  dx<br />	shr dx,  3<br />	add ax,  dx<br />	and eax, 3855				;00001111 00001111<br />	shl al,  4<br />	add al,  ah<br /><br />	mov &#91;edi&#93;, al<br />	inc esi<br />	jmp EndLoop<br />CharNotFound2&#58;<br />	cmp al, &quot;+&quot;				;if regular Char<br />	je ReplacePlus<br />	mov &#91;edi&#93;, al<br />	jmp EndLoop<br />ReplacePlus&#58;					;replace &quot;+&quot; with space<br />	mov al, 32<br />	mov &#91;edi&#93;, al<br />EndLoop&#58;<br />	inc esi					;StringPointer erh?hen<br />	inc edi<br />	cmp ln, edi				;end if OutputStringLength reached<br />	jg StartLoop<br />	jmp TheEnd<br />NoHex&#58;						;No &quot;%&quot; replaceing necessary<br />	;rep movsb<br />	mov al, &#91;esi&#93;<br />	cmp al, &quot;+&quot;				;Replacing of &quot;+&quot;s only<br />	je ReplacePlus2<br />	mov &#91;edi&#93;, al<br />	jmp NoPlus<br />ReplacePlus2&#58;<br />	mov al, 32<br />	mov &#91;edi&#93;, al<br />NoPlus&#58;<br />	inc esi<br />	inc edi<br />	cmp ln, edi<br />	jg NoHex<br />	jmp TheEnd<br />TheEnd&#58;<br />	mov al, 0				;terminate String<br />	mov &#91;edi&#93;, al<br /><br />	mov eax, ReturnString$			;return String<br /><br />	pop edi<br />	pop esi<br />	ret <br />UrlDecode endp<br /></code></pre><br /><br /><span style="font-size:9px>You need to excuse my bad english</span></div>
    <div class="meta">Posted on 2001-09-05 07:24:26 by Butch77</div>
   </div>
   <div class="post" id="post-6354">
    <div class="subject"><a href="#post-6354">UrlDecode</a></div>
    <div class="body">1) Is there a better way to convert to ascii characters representing a hex value to that char? No, this is a very good way of doing it!<br /><br />2) cld is the mnemonic to clear the direction flag in the processor.<br />This usually determines whether to increment, or decrement esi and/or edi when using certain commands (see lods, stos, movs as examples). In this context it performs no function.<br />When using lods/stos/movs it is desireable to move forwards, as it is faster due to caching reasons.<br /><br />3) rep not really suitable, as it will repeatedly apply the certain instructions it applys to, and can only be used in conjunction with one instruction at a time. You need to analyse your results after each fetch from memory.<br /><br />4) For programming flexibility I would advise that the caller of your function provides the output buffer, this makes your code more usable, and makes things easier for you to program!<br /><br />5) As a general rule, jumping is bad! Jumps can cause the processor to stall, which will impact on performance. For a better description of the problems with jumps read the agner fog help file provided with MASM32, reading the sections on branch prediction.<br /><br />Here is my attempt at the problem, it takes as input two arguments, the second being a pointer to the return buffer.<br /><br /><pre><code><br />URLDecode PROC USES esi edi text&#58;DWORD, output&#58;DWORD<br /><br />  mov esi, text<br />  mov edi, output<br /><br />loop_start&#58;<br />  mov al, BYTE PTR &#91;esi&#93;<br />  inc esi<br />  cmp al, '%'<br />  je ascii_convert<br /><br />  cmp al, '+'<br />  jne @F<br />  mov al, ' '<br />  ;You could replace this with a cmov instruction if you<br />  ;target a 686, this would remove the conditional jump<br />@@&#58;<br /><br />  mov BYTE PTR &#91;edi&#93;, al<br />  inc edi<br /><br />  cmp al, 0<br />  jne loop_start<br /><br />  ret<br /><br />ascii_convert&#58;<br />  mov ax, WORD PTR &#91;esi&#93;<br />  add esi, 2<br />  mov cx, ax<br />  and ax, 4040h<br />  and cx, 0F0Fh<br />  shr ax, 3<br />  add ax, cx<br />  shr ax, 3<br />  add ax, cx<br />  shl al, 4<br />  or  al, ah<br />  mov &#91;edi&#93;, al<br />  inc edi<br />  jmp loop_start<br /><br />URLDecode endp<br /></code></pre><br /><br />Mirno</div>
    <div class="meta">Posted on 2001-09-06 11:22:15 by Mirno</div>
   </div>
   <div class="post" id="post-6431">
    <div class="subject"><a href="#post-6431">UrlDecode</a></div>
    <div class="body">Hey Thanks a lot! That looks much better...<br /><br />The intention of programming this function was to use it in ASP later. That's why I tried to use the decoded string as returnvalue.<br />To use it like that:<br /><pre><code>response.write UrlDecode&#40;strEncoded&#41;</code></pre><br />Do you have any idea on how to solve this problem?<br /><br />Thanks :)</div>
    <div class="meta">Posted on 2001-09-07 04:01:18 by Butch77</div>
   </div>
   <div class="post" id="post-6440">
    <div class="subject"><a href="#post-6440">UrlDecode</a></div>
    <div class="body">If you don't mind passing the function the address of the buffer, you could have it return a pointer to that function too!<br /><br />Keeping with the code that I wrote above, simply add this line before the <strong>ret</strong> command.<br /><pre><code>  mov eax, output </code></pre><br /><br />It is more versatile to deal with the output this way, and can help avoid problems. You cannot manage the memory as easily if the function allocates the space, as details on how that memory is allocated (and how much) is potentially unknown to the caller.<br /><br />Mirno</div>
    <div class="meta">Posted on 2001-09-07 06:57:11 by Mirno</div>
   </div>
   <div class="post" id="post-6451">
    <div class="subject"><a href="#post-6451">UrlDecode</a></div>
    <div class="body">But there is no 'easy' way to create a function like this without using an 'output' parameter!?</div>
    <div class="meta">Posted on 2001-09-07 08:53:53 by Butch77</div>
   </div>
   <div class="post" id="post-6453">
    <div class="subject"><a href="#post-6453">UrlDecode</a></div>
    <div class="body">You can do as you are doing, ie work out how much space you will need, and then get the function to allocate the space.<br />The problem with this is that the code external to the function has no control over the allocation. This means it cannot de-allocate it when it has finished with it, nor can it re-use the buffer once it has finished with the data contained within it. Also if you call the function enough times, eventually you will run out of memory because all the other instances of the data are still floating around.<br /><br />If you truely want to allocate the memory on the fly within the function, then the way that you did it is probably the best.<br /><br />You can always look at alternative memory allocation methods, but the result is pretty much the same!<br />Use an Win32 API referance and look up GlobalAlloc, &amp; HeapAlloc.<br /><br />I've never used asp, so I don't really understand how your exact problem lies. I would assume you could create some buffer, as it is a staple of most languages!<br />How do you create the &quot;strEncoded&quot; variable? Could you not copy it, and overwrite the copy with the new results?<br /><br />Mirno</div>
    <div class="meta">Posted on 2001-09-07 09:12:24 by Mirno</div>
   </div>
  </div>
 </body>
</html>