<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Need help with INCREDIBLY Simple Encryption program - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=25879" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=25879">Need help with INCREDIBLY Simple Encryption program</a></p>
   <div class="post" id="post-188724">
    <div class="subject"><a href="#post-188724">Need help with INCREDIBLY Simple Encryption program</a></div>
    <div class="body">I&#39;ve got a text file: 1.txt in c:\ that contains the word This<br />I want the following code to open the file, get the handle ( which I assume gives the starting position for the bytes of the file), directly access the 4 bytes and just add 3 to them.<br />This is what I&#39;ve got so far but, it isn&#39;t changing the text in the file. <br /><br />You would have to create the text file yourself to test the code.<br /><br />Could someone please give me hint?<br /><br />Thanks!<br />&nbsp; &nbsp;  -ASM NEWB<br /><br /><pre><code><br />.model small<br />.486				<br />.data<br />HANDLE word ?<br />FILENAME db &quot;C:\1.txt&quot;, 0<br /><br />.stack<br />.code<br /><br />main proc far<br />	mov ax, @data	<br />	mov ds, ax			<br /><br />;-----OPEN FILE<br />	<br />	mov dx, offset FILENAME	; put filename in dx<br />	mov al, 2				; access mode - read and write<br />	mov ah, 3Dh				; open the file<br />	int 21h<br />	<br />;-----SAVE FILE HANDLE<br />	<br />	<br />	mov HANDLE, ax			; save value of handle		<br />	mov bx, offset HANDLE	; bx contains the file handle<br />		<br />	mov cx, 5				; bytes to be accessed, used in loop<br />	mov si, 0				; used to move pointer<br />	<br />	<br />L1:<br />;-----change bytes<br />	mov al, byte ptr 	;get data at mem location <br />	add al, 3<br />	mov byte ptr , al<br /><br />	inc si					<br />	add bx, si				;move pointer to next byte<br />	dec cx					<br />	cmp cx, 0<br />	jg L1<br /><br />	mov bx, HANDLE<br />	mov ah, 3Eh				; close file<br />	int 21h<br />					<br />	mov&nbsp; ah, 4ch<br />&nbsp; &nbsp; int&nbsp; 21h<br /><br /><br />main endp<br /><br />end main</code></pre></div>
    <div class="meta">Posted on 2007-04-03 22:50:43 by Alklun</div>
   </div>
   <div class="post" id="post-188727">
    <div class="subject"><a href="#post-188727">Re: Need help with INCREDIBLY Simple Encryption program</a></div>
    <div class="body">When you are working with the DOS trap, the handle of the file returned by function 0x3D is <strong>not</strong> the pointer to the physical memory location of the content of the file. What you have to do after obtaining the handle of the file is to issue the DOS trap again with function 0x3F in order to read from the file.<br /><br />In your code, when you do this:<br /><br /><pre><code>mov bx, offset HANDLE	; bx contains the file handle</code></pre><br /><br />You are not moving the value of the HANDLE variable into the base index. You are moving the memory location of that variable into BX so be aware of that too.<br /><br />I was really frustrated with these DOS calls and other stuff which is why I coded OASML 2.0. You can read about it <a target="_blank" href="http://&quot;http://www.asmcommunity.net/board/index.php?topic=25693.0&quot;">in this thread</a>. It will save you some time and frustration. Below is the  procedure that I&#39;ve written for OASML. I think this might help you:<br /><br /><pre><code>; ------------------------------<br />FileRead PROC<br />&nbsp; COMMENT *<br />&nbsp; &nbsp; Description : Reads the total amount of AX bytes from an open file. See note(s).<br /><br />&nbsp; &nbsp; Calling Convention : Push from left to right.<br /><br />&nbsp; &nbsp; Parameter(s) :<br />&nbsp; &nbsp; &nbsp; WORD Param1 = Source file handle offset<br />&nbsp; &nbsp; &nbsp; WORD Param2 = Buffer to read onto<br />&nbsp; &nbsp; &nbsp; WORD Param3 = Total bytes read<br /><br />&nbsp; &nbsp; Stack Usage: 8 Bytes.<br /><br />&nbsp; &nbsp; Note : 1) The AX register will be set to zero (0000h) if no errors have occurred and<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; will contain one of the below values if an error has occurred:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AX = 0005h (Access denied)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AX = 0006h (Invalid Handle)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  2) The Param3 will contain the actual bytes read from the file if the AX register<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; is set to zero by the FileRead procedure.<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  3) The total number of bytes to read from the file should be specified by the<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AX register before invoking the FileRead procedure.<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  4) The Param3&#39;s value when the procedure is through will be less than the value<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; you pass onto the AX register (Total bytes to read) if you have reached the EOF.<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  5) If the AX is not equal to zero (An error has occurred), the value of Param2 and<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Param3 will remain unchanged.<br /><br />&nbsp; &nbsp; Example : Read 10 bytes from the file with its handle in a variable called FileHandle<br /><br />&nbsp; &nbsp; .DATA?<br />&nbsp; &nbsp; &nbsp; FileHandle&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DW&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br />&nbsp; &nbsp; &nbsp; ReadBytes&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  DW&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?<br />&nbsp; &nbsp; &nbsp; Buffer&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DB&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11 DUP(?)<br />&nbsp; &nbsp; .CODE<br />&nbsp; &nbsp; &nbsp; PUSH&nbsp; &nbsp; OFFSET FileHandle ; The file handle offset<br />&nbsp; &nbsp; &nbsp; PUSH&nbsp; &nbsp; OFFSET Buffer&nbsp; &nbsp;  ; The buffer to read onto<br />&nbsp; &nbsp; &nbsp; PUSH&nbsp; &nbsp; OFFSET ReadBytes&nbsp; ; Total bytes read (Will be filled by the procedure)<br />&nbsp; &nbsp; &nbsp; MOV&nbsp; &nbsp;  AX , 000Ah&nbsp; &nbsp; &nbsp; &nbsp; ; Read 10 bytes<br />&nbsp; &nbsp; &nbsp; CALL&nbsp; &nbsp; FileRead&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; Read from the file<br />&nbsp; &nbsp; &nbsp; ADD&nbsp; &nbsp;  SP , 0006h&nbsp; &nbsp; &nbsp; &nbsp; ; Remove three parameters<br />&nbsp; &nbsp; &nbsp; TEST&nbsp; &nbsp; AX , AX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; See if AX == 0 (Success)<br />&nbsp; &nbsp; &nbsp; JNE&nbsp; &nbsp;  @@Failed&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; Jump to ... if not<br />&nbsp; &nbsp; &nbsp; &nbsp; ; Success<br />&nbsp; &nbsp; &nbsp; @@Failed:<br />&nbsp; &nbsp; &nbsp; &nbsp; ; Failure<br />&nbsp; *<br />&nbsp; PUSH&nbsp; &nbsp; BX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; Push the base index onto the stack<br />&nbsp; PUSH&nbsp; &nbsp; CX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; Push the count register onto the stack<br />&nbsp; PUSH&nbsp; &nbsp; DX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; Push the data register onto the stack<br />&nbsp; PUSH&nbsp; &nbsp; BP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; Push the base pointer onto the stack<br />&nbsp; MOV&nbsp; &nbsp;  BP , SP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; Move the stack pointer to the base pointer<br />&nbsp; MOV&nbsp; &nbsp;  CX , AX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; Total bytes to read<br />&nbsp; MOV&nbsp; &nbsp;  DX , WORD PTR &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; Buffer to read the byte(s) onto<br />&nbsp; MOV&nbsp; &nbsp;  BX , WORD PTR &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; The file handle pointer<br />&nbsp; MOV&nbsp; &nbsp;  BX , WORD PTR &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; The file handle<br />&nbsp; MOV&nbsp; &nbsp;  AH , 03Fh&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; Read from file function<br />&nbsp; DW&nbsp; &nbsp; &nbsp; 21CDh&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; Issue the DOS interrupt<br />&nbsp; JC&nbsp; &nbsp; &nbsp; @@__FileReadEP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; Jump to ... if an error has occurred<br />&nbsp; MOV&nbsp; &nbsp;  BX , WORD PTR &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; BX = Pointer to Param3 (Read Bytes)<br />&nbsp; MOV&nbsp; &nbsp;  WORD PTR  , AX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; Param3 = Bytes Read<br />&nbsp; XOR&nbsp; &nbsp;  AX , AX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; AX = 0000h (Success)<br />&nbsp; @@__FileReadEP:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; End of the procedure routine<br />&nbsp; &nbsp; POP&nbsp; &nbsp;  BP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; Restore the base pointer<br />&nbsp; &nbsp; POP&nbsp; &nbsp;  DX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; Restore the destination index<br />&nbsp; &nbsp; POP&nbsp; &nbsp;  CX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; Restore the count register<br />&nbsp; &nbsp; POP&nbsp; &nbsp;  BX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; Restore the base index<br />&nbsp; RET&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ; Return to the calling procedure<br />FileRead ENDP<br />; ------------------------------</code></pre></div>
    <div class="meta">Posted on 2007-04-04 01:39:29 by XCHG</div>
   </div>
  </div>
 </body>
</html>