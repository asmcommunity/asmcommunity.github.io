<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>A couple more cool macros... - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=6552" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=6552">A couple more cool macros...</a></p>
   <div class="post" id="post-47290">
    <div class="subject"><a href="#post-47290">A couple more cool macros...</a></div>
    <div class="body">These two macros go well together and simplify things alot.<br /><pre><code>.end macro _start, _args&#58;vararg<br />;; When creating a top-level window &#40;hparent = 0&#41;, store the hwnd in g_hwnd<br />;; Store the haccel &#40;if any&#41; in g_haccel.  Multi window pgms can process the<br />;; WM_SETFOCUS/WM_ACTIVATE message&#40;s&#41; to keep these values updated!<br />;; ** the next macro 'waitquitmsg' requires these values to be set!<br /><br />;; Do the same for modeless dialogs but store the hwnd in g_hdlg!<br /><br />.data?<br />cmdlin      dd ?            ; ptr to coomand tail - NO path/name<br />exename     dd ?            ; ptr to full name of exec file<br />g_haccel    dd ?            ; HACCEL    of active window<br />g_hdlg      dd ?            ; HDLG      of active modeless dialog<br />g_hinst     dd ?            ; HINSTANCE of module<br />g_hwnd      dd ?            ; HWND      of active window<br /><br />includelib shlwapi<br /><br />.code<br />_start0&#58;<br />    invoke GetModuleHandle, 0<br />    mov g_hinst, eax<br />    invoke GetCommandLine<br />    mov exename, eax<br />    push eax<br />    call PathGetArgs<br />    mov cmdlin, eax<br />    push exename<br />    call PathRemoveArgs<br /><br />    $start equ _start<br />    ifb &lt;_start&gt;<br />        ifdef WinMain<br />            $start equ &lt;WinMain&gt;    ;; gui<br />        elseifdef main<br />            $start equ &lt;main&gt;       ;; console<br />        else<br />            .err &quot;Must define main or WinMain&quot;<br />        endif<br />    endif<br /><br />    ifb &lt;_args&gt;<br />        call $start<br />    else<br />        invoke $start, _args<br />    endif<br />    <br />    invok ExitProcess, eax<br />    end _start0<br />endm<br /><br /><br />waitquitmsg macro<br />.data?<br />msg0 MSG &#123;&#125;<br />.code<br />    .while 1<br />        invoke GetMessage, @ msg0, 0, 0, 0<br />        .break .if eax == 0<br />        invoke IsDialogMessage, g_hdlg, @ msg0<br />        .cont .if eax<br />        invoke TranslateAccelerator, msg0.hwnd, g_haccel, @ msg0<br />        .cont .if eax<br />        invoke TranslateMessage, @ msg0<br />        switch msg0.wParam<br />            case VK_SHIFT, VK_CTRL<br />                .if msg0.message == WM_KEYDOWN<br />                    or KEY_SHFT&#91;eax - VK_SHIFT&#93;, 1<br />                .elseif msg0.message == WM_KEYUP<br />                    and KEY_SHFT&#91;eax - VK_SHIFT&#93;, 0<br />                .endif<br />        endsw<br />        invoke DispatchMessage, @ msg0<br />    .endw<br />    return msg0.wParam<br />endm<br /><br />Usage&#58;<br /><br />WinMain&#58;<br />;   do you're initialization ...<br />;   create windows whatever ...<br />    waitquitmsg<br />;   'waitquitmsg' has a built in return<br /><br />.end<br /></code></pre><br /><br />Greg,<br /><br />Just fixed a spelling mistake in the title.</div>
    <div class="meta">Posted on 2002-07-12 15:06:26 by gfalen</div>
   </div>
   <div class="post" id="post-47302">
    <div class="subject"><a href="#post-47302">A couple more cool macros...</a></div>
    <div class="body">Update:  <br />Moved msg0 to the .end macro.  Added default struct - wc0:WNDCLASSEX<br />Deleted some legacy code copied by mistake<br />Added public declarations to be added to masm32.inc.  <br /><br /><pre><code><br />; macro to make public declarations easier.<br />global macro _typ, _lst&#58;vararg  ;; global type, var1, var2...<br />    irp $v, &lt;_lst&gt;<br />        externdef $v&#58;_typ<br />    endm<br />endm<br /><br />; ** These 2 lines should go in masm32.inc.<br />; Note&#58;  This will make them visible to library modules too!<br />global dword, cmdlin, exename, g_haccel, g_hdlg, g_hinst, g_hwnd<br />externdef msg0&#58;MSG&#58; wc0&#58;WNDCLASSEX<br /><br /><br />; When creating a top-level window &#40;hparent = 0&#41;, store the hwnd in g_hwnd<br />; Store the haccel &#40;if any&#41; in g_haccel.  Multi window pgms can process the<br />; WM_SETFOCUS/WM_ACTIVATE message&#40;s&#41; to keep these values updated!<br /><br />; Do the same for modeless dialogs but store the hwnd in g_hdlg!<br /><br />.end macro _start, _args&#58;vararg<br />.data?<br />cmdlin      dd ?            ; ptr to coomand tail - NO path/name<br />exename     dd ?            ; ptr to full name of exec file<br />g_haccel    dd ?            ; HACCEL    of active window<br />g_hdlg      dd ?            ; HDLG      of active modeless dialog<br />g_hinst     dd ?            ; HINSTANCE of module<br />g_hwnd      dd ?            ; HWND      of active window<br />; 2 new globals - handy to have<br />msg0        MSG &#123;&#125;          ; used by 'waitquitmsg' macro<br />wc0         WNDCLASSEX&#123;&#125;    ; used by 'regclass' macro<br /><br />includelib shlwapi<br /><br />.code<br />_start0&#58;<br />    invoke GetModuleHandle, 0<br />    mov g_hinst, eax<br />    invoke GetCommandLine<br />    mov exename, eax<br />    push eax<br />    call PathGetArgs<br />    mov cmdlin, eax<br />    push exename<br />    call PathRemoveArgs<br /><br />    call _startup<br />    ifdef WndProc<br />        mov wc0.lpfnWndProc, o WndProc<br />    endif<br /><br />    $start equ _start<br />    ifb &lt;_start&gt;<br />        ifdef WinMain<br />            $start equ &lt;WinMain&gt;    ;; gui<br />        elseifdef main<br />            $start equ &lt;main&gt;       ;; console<br />        else<br />            .err &quot;Must define main or WinMain&quot;<br />        endif<br />    endif<br /><br />    ifb &lt;_args&gt;<br />        call $start<br />    else<br />        invoke $start, _args<br />    endif<br /><br />    invok ExitProcess, eax<br />    end _start0<br />endm<br /><br /><br />waitquitmsg macro<br />.code<br />    .while 1<br />        invoke GetMessage, @ msg0, 0, 0, 0<br />        .break .if eax == 0<br />        invoke IsDialogMessage, g_hdlg, @ msg0<br />        .cont .if eax<br />        invoke TranslateAccelerator, msg0.hwnd, g_haccel, @ msg0<br />        .cont .if eax<br />        invoke TranslateMessage, @ msg0<br />        switch msg0.wParam<br />            case VK_SHIFT, VK_CTRL<br />                .if msg0.message == WM_KEYDOWN<br />                    or KEY_SHFT&#91;eax - VK_SHIFT&#93;, 1<br />                .elseif msg0.message == WM_KEYUP<br />                    and KEY_SHFT&#91;eax - VK_SHIFT&#93;, 0<br />                .endif<br />        endsw<br />        invoke DispatchMessage, @ msg0<br />    .endw<br />    return msg0.wParam<br />endm<br /><br /><br />; Usage&#58;<br /><br />WinMain&#58; ; no need for args - they're already defined by .end macro<br /><br />;   do you're initialization ...<br />;   create main window &#40;store result in g_hwnd&#41;<br />;    whatever ...<br /><br />    waitquitmsg ; has a built in return<br /><br />.end<br /></code></pre></div>
    <div class="meta">Posted on 2002-07-12 17:47:51 by gfalen</div>
   </div>
   <div class="post" id="post-47494">
    <div class="subject"><a href="#post-47494">A couple more cool macros...</a></div>
    <div class="body">Has anyone tried these?  How about some feedback?</div>
    <div class="meta">Posted on 2002-07-14 08:54:35 by gfalen</div>
   </div>
  </div>
 </body>
</html>