<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>What is the data between the DOS-stub-code and the PE-header - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=11182" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=11182">What is the data between the DOS-stub-code and the PE-header</a></p>
   <div class="post" id="post-84326">
    <div class="subject"><a href="#post-84326">What is the data between the DOS-stub-code and the PE-header</a></div>
    <div class="body">I'm experimenting with building my own exe-files and dll-files, and the only bytes in an exe-file that I cannot find any info about is the data that the MASM linker always seems to put between the DOS stub code and the PE-header. I know that this data is not part of the exe-format itself (in files produced by other linkers, e.g. Delphi, this area is zeroed) but it would still be really interesting to know what kind of data MASM stores here?<br /><br />I have noticed that the data is practically identical between different exe-files produced with MASM (only one byte in it has been observed to change) and it also always seems to include the string &quot;Rich&quot;.<br /><br />MASM outputs different data (and even different size of this data) when producing a dll file and when producing an exe file though.<br /><br /><br />This is a normal MASM DOS-stub code:<br /><br /><pre><code><br />push    cs<br />pop     ds<br />mov     dx, 0Eh<br />mov     ah, 9<br />int     21h             ; DOS - PRINT STRING<br />                        ; DS &#58; DX -&gt; string terminated by &quot;$&quot;<br />mov     ax, 4C01h<br />int     21h             ; DOS - 2+ - QUIT WITH EXIT CODE &#40;EXIT&#41;<br /><br />000E_string&#58;<br />    &quot;This program cannot be run in DOS mode.&quot;, 2Eh, 0Dh, 0Dh, 0Ah, &quot;$&quot;<br /></code></pre><br /><br />Directly after it comes this data I'm talking about, before the PE-header.<br /><br /><br /><br />In my MASM exe-files it is the following:<br /><pre><code><br />00000070   &lt;end of stub string here&gt;   00 00 00 00 00 00 00            .......<br />00000080   5D 17 1D DB 19 76 73 88  19 76 73 88 19 76 73 88   &#93;..?.vs?.vs?.vs?<br />00000090   19 76 73 88 0D 76 73 88  E5 56 61 88 18 76 73 88   .vs?.vs??Va?.vs?<br />000000A0   52 69 63 68 19 76 73 88  00 00 00 00 00 00 00 00   Rich.vs?........<br />000000B0   &lt;PE-header begins here&gt;<br /></code></pre><br /><br />In my MASM dll-files it is the following:<br /><pre><code><br />00000070   &lt;end of stub string here&gt;   00 00 00 00 00 00 00            .......<br />00000080   71 D4 F7 DB 35 B5 99 88  35 B5 99 88 35 B5 99 88   q???5???5???5???<br />00000090   C9 95 8B 88 34 B5 99 88  BB AA 8A 88 34 B5 99 88   ???4???????4???<br />000000A0   52 69 63 68 35 B5 99 88  00 00 00 00 00 00 00 00   Rich5???........<br />000000B0   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ................<br />000000C0   &lt;PE-header begins here&gt;<br /></code></pre><br /><br />It would be really interesting to know what kind of info that MASM &quot;hides&quot; in this data. Does anyone have any idea whatsoever?<br /><br />Thanks!</div>
    <div class="meta">Posted on 2003-03-01 08:40:32 by dELTA</div>
   </div>
   <div class="post" id="post-84335">
    <div class="subject"><a href="#post-84335">What is the data between the DOS-stub-code and the PE-header</a></div>
    <div class="body">Seems more to come from the linker than masm. With older linkers these bytes arent included.</div>
    <div class="meta">Posted on 2003-03-01 11:17:55 by japheth</div>
   </div>
   <div class="post" id="post-84337">
    <div class="subject"><a href="#post-84337">What is the data between the DOS-stub-code and the PE-header</a></div>
    <div class="body">Yep, it most likely comes from the linker, but isn't the linker part of the masm package too? :confused: It still would be very interesting to know what it is anyway.</div>
    <div class="meta">Posted on 2003-03-01 11:55:27 by dELTA</div>
   </div>
   <div class="post" id="post-84697">
    <div class="subject"><a href="#post-84697">Hey</a></div>
    <div class="body">I did not Found CD 19 bytes. Where is it?. <br />Im a bit courious too, MZ what is it? Memory Zero? <br /><pre><code><br />4C 5A CD 19 ......<br /><br /></code></pre></div>
    <div class="meta">Posted on 2003-03-03 09:38:47 by realvampire</div>
   </div>
   <div class="post" id="post-84785">
    <div class="subject"><a href="#post-84785">What is the data between the DOS-stub-code and the PE-header</a></div>
    <div class="body">realvampire,<br /><br />&quot;MZ&quot; is a signature sequence that is always the first two bytes in any executable module of exe or dll format (not in com-files). It is part of the DOS executable header. Windows executables need quite a lot more info, and this is stored in the PE-header (in 32 bits executables anyway, otherwise in the NE-header), which is located after the MZ header (you will find the exact offset as a dword at offset 60 in all Windows executables).<br /><br />The data I'm talking about it located right before the PE-header (after the DOS-stub), and I'm sure that the contents of it may vary some, depending on linker version and possibly lots of other factors. That's why I'd like to know more about what it is.<br /><br />Doesn't really anybody have the slightest idea? I'm sure there are at least some Microsoft MASM developers hanging around here occasionally, come on now guys, spill it. ;)</div>
    <div class="meta">Posted on 2003-03-03 16:30:11 by dELTA</div>
   </div>
   <div class="post" id="post-84819">
    <div class="subject"><a href="#post-84819">What is the data between the DOS-stub-code and the PE-header</a></div>
    <div class="body">The real-mode stub program is an actual program run by MS-DOS when the executable is loaded. For an actual MS-DOS executable image file, the application begins executing here. For successive operating systems, including Windows, OS/2?, and Windows NT, an MS-DOS stub program is placed here that runs instead of the actual application. The programs typically do no more than output a line of text, such as: &quot;This program requires Microsoft Windows v3.1 or greater.&quot; Of course, whoever creates the application is able to place any stub they like here, meaning you may often see such things as: &quot;You can't run a Windows NT application on OS/2, it's simply not possible.&quot;<br /><br />When building an application for Windows version 3.1, the linker links a default stub program called WINSTUB.EXE into your executable. You can override the default linker behavior by substituting your own valid MS-DOS-based program in place of WINSTUB and indicating this to the linker with the STUB module definition statement. Applications developed for Windows NT can do the same thing by using the -STUB: linker option when linking the executable file.</div>
    <div class="meta">Posted on 2003-03-03 17:22:04 by wizzra</div>
   </div>
   <div class="post" id="post-84925">
    <div class="subject"><a href="#post-84925">What is the data between the DOS-stub-code and the PE-header</a></div>
    <div class="body">Yes, I know that, you can even see my disassembly of this stub in my first post above. But MASM inserts additional data (which is not referenced from the stub code) between the stub and the PE-header, and that's what I'd like to know what it is.</div>
    <div class="meta">Posted on 2003-03-04 05:57:29 by dELTA</div>
   </div>
   <div class="post" id="post-84928">
    <div class="subject"><a href="#post-84928">HI</a></div>
    <div class="body">Try to see it with QuickViewer. Hope it help you.</div>
    <div class="meta">Posted on 2003-03-04 06:38:16 by realvampire</div>
   </div>
   <div class="post" id="post-136084">
    <div class="subject"><a href="#post-136084">Re: Hey</a></div>
    <div class="body">MZ stands by the name of the programmer Mark Zbikowski.</div>
    <div class="meta">Posted on 2004-03-16 05:17:13 by Opcode</div>
   </div>
   <div class="post" id="post-136347">
    <div class="subject"><a href="#post-136347">What is the data between the DOS-stub-code and the PE-header</a></div>
    <div class="body">dELTA,<br /><br />Its usually junk, the space between the end of the MZ header and the start address of the PE header is undefined so you can use it for anything, store settings there or just zero it out if you want.</div>
    <div class="meta">Posted on 2004-03-19 01:31:38 by hutch--</div>
   </div>
   <div class="post" id="post-136348">
    <div class="subject"><a href="#post-136348">Re: Re: Hey</a></div>
    <div class="body"><div class="quote"><br />MZ stands by the name of the programmer Mark Zbikowski. </div><br />Was it really necessary to kick a thread of more than a year old just to post this? :)<br /><br />Thomas</div>
    <div class="meta">Posted on 2004-03-19 01:58:48 by Thomas</div>
   </div>
   <div class="post" id="post-136373">
    <div class="subject"><a href="#post-136373">What is the data between the DOS-stub-code and the PE-header</a></div>
    <div class="body">Following program is I used to  test the usage of stub.<br />This program can  run under MS DOS and WINDOWS, and Reports current operation system type.<br /><br /><br />the stub code:<br /><pre><code><br />;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@<br />; FileName&#58; os_type.asm<br />; Function&#58; Reports current operation system type<br />; Author  &#58; Purple Endurer<br />; Version &#58; 0.1<br />;<br />; OS Name      Offset of INT 08h    Offset of INT 43h<br />; -------------------------------------------------------<br />; MS DOS 7.00  001Fh                5710h<br />; MS DOS 7.10  18DEh                6EE5h<br />; UCDOS        1AF3h<br />; UCDOS98      1AEBh                6E20h<br />; MSDOS mode   0000h<br />; PDOS95       0A50h                6E20h<br />;<br />; Date         Summary<br />; -------------------------------------------------------<br />; 2002.04.07   Created from software paper 95P125<br />; 2002.06.11   Show version if os is MS-DOS<br />; 2002.08.07   Convert it to DOS EXE format to be stub<br />;              program in PE format execute file <br />; 2004.02.09   Added the condition  asm var 'UseStack'<br /><br />UseStack        equ 0<br />data    segment<br />        strMSDOS   db &quot;MS DOS &quot;<br />        cMajorVer  db ' '<br />                   db '.'<br />        cMinorVer  db &quot;    $&quot;<br /><br />        strUCDOS   db &quot;UCDOS&quot;<br />        cUCDOSVer  db &quot; 98?????$&quot;<br /><br />        strPDOS95  db &quot;Windows95????DOS???PDOS95$&quot;<br />data  ends<br /><br />if UseStack<br />        sseg segment stack<br />                db 10 dup&#40;?&#41;<br />        sseg ends<br />endif<br />code   segment<br />;--------------------------------------<br />if UseStack<br />       assume cs&#58; code, ds&#58; data, ss&#58; sseg<br />else<br />       assume cs&#58; code, ds&#58; data<br />endif<br /><br /> main  proc<br /> start&#58;<br />       mov  ax, data<br />       mov  ds, ax<br /><br />if UseStack<br />       mov ax, sseg<br />       mov ss, ax<br />endif<br /><br />       mov  ah, 30h  ; Get Version<br />       int  21h<br />       add  al, '0'<br />       mov  cMajorVer, al<br />       mov  bx, offset cMinorVer<br />       call bin2dec<br /><br />       mov  ax, 3508h<br />       int  21h<br /><br />       mov  dx, offset strMSDOS<br />       mov  ah, 09h<br />       int  21h<br /><br />       cmp  bx, 1fh<br />       je   @end  ;Here is DOS 7.00 only<br />       cmp  bx, 18deh<br />       je   @End  ;Here is DOS 7.10 only<br /><br />       mov  dx, offset strUCDOS<br />       cmp  bx, 1aebh<br />       je   @Report<br /><br />       cmp  bx, 1af3h<br />       jne  @next2<br />       mov  cUCDOSVer, '$'<br />       jmp  @report<br /><br /> @next2&#58;<br /><br />       mov  dx, offset strPDOS95<br />       cmp  bx, 0a50h<br />       jne   @End<br /> @Report&#58;<br />       ;mov ah, 09h<br />       int  21h<br /> @End&#58;<br />       mov  ax, 4c00h<br />       int  21h<br /> main  endp<br /><br />;=================================================<br />; Input &#58;  AH = the Binary will be translated&#41;<br />;          BX = First offset of memory us to store the result<br />; Output&#58;  BX = First offset of memory stored the result<br />; --------------------------------------------------------<br /> bin2dec proc<br />      push dx<br />      mov  dl, 10<br /> @LoopDiv&#58;<br />      mov  al, ah<br />      xor  ah, ah<br />      div  dl      ; &#40;AL&#41; &lt;- &#40;AX&#41; / &#40;DL&#41;    &#40;AH&#41; &lt;- &#40;AX&#41; % &#40;DL&#41;<br />      add  al, '0'<br />      mov  &#91;bx&#93;, al<br />      inc  bx<br />      cmp  ah, 10<br />      jg  @LoopDiv<br /><br />      add  ah, '0'<br />      mov  &#91;bx&#93;, ah<br />      pop  dx<br />      ret<br /> bin2dec endp<br />;=========================================<br />code  ends<br />      end  main<br /></code></pre><br /><br /><br />PE code:<br /><pre><code><br />;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;<br />;FileName&#58; StubDemo.asm<br />; Fuction&#58; Demo how to use the custome stub of PE exe files.<br />;  Author&#58; Purple Endurer<br />;The command line refered cursom STUB program&#58;<br />;\masm32\bin\link /stub&#58;&lt;filename.exe&gt; /subsystem&#58;windows &lt;objectname.obj&gt;<br />;<br />;Example&#58;<br />;D&#58;\masm32v6\WORKS\my_stub&gt;\masm32\bin\link /stub&#58;os_type.exe /subsystem&#58;windows stubdemo.obj<br />;Microsoft &#40;R&#41; Incremental Linker Version 5.12.8078<br />;Copyright &#40;C&#41; Microsoft Corp 1992-1998. All rights reserved.<br /><br />;os_type.exe &#58; warning LNK4060&#58; stub file missing full MS-DOS header; rebuild stub with /KNOWEAS 16-bit LINK option<br /><br />; Date         Summary<br />; -------------------------------------------------------<br />; 2002.04.07   Created!<br />;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;<br /><br />.386<br />.model flat, stdcall<br />option casemap&#58;none<br />include \masm32\include\windows.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\user32.inc<br />includelib \masm32\lib\user32.lib<br />includelib \masm32\lib\kernel32.lib<br /><br />bDetailInfo         equ 0<br /><br />.data<br />szMsgBoxTitle       db &quot;?????????&quot;,0<br /><br /><br />if   bDetailInfo     ;?????? bDetailInfo<br />    szWin31             db &quot;Win32s on Windows 3.1 &quot;, 0<br />    szWin9x             db &quot;Win32 on Windows 95 &quot;, 0<br />else<br />    szWin31             db &quot;Windows 3.1 &quot;, 0<br />    szWin9x             db &quot;Windows 95 &quot;, 0<br />endif                   ;?????? bDetailInfo<br /><br />szWinNT             db &quot;Windows NT &quot;, 0<br /><br />szFormat4OsVer      db &quot;%lu.%lu.%lu&quot;, 0<br />szGetOsInfoFail     db &quot;?????????????!&quot;, 0<br /><br />.data?<br />OsVer               OSVERSIONINFO &lt;&gt;<br />szOsVerInfo         db   255 dup &#40;?&#41;<br />szOsVerInfoTmp      db   255 dup &#40;?&#41;<br /><br />.code<br />start&#58;<br />            mov    OsVer.dwOSVersionInfoSize, SIZEOF OSVERSIONINFO<br />            invoke GetVersionEx, ADDR OsVer<br />      <br />            .if    eax<br />                   mov eax, OsVer.dwPlatformId<br />             <br />                   ;Identifies the build number of the operating<br />                   ;system in the low-order word For Win9X<br /><br />                   .if eax == VER_PLATFORM_WIN32s<br />                       mov esi, OFFSET szWin31<br />                       and OsVer.dwBuildNumber, 0FFFFh<br />                       <br />                   .elseif eax == VER_PLATFORM_WIN32_WINDOWS<br />                       mov esi, OFFSET szWin9x<br />                       and OsVer.dwBuildNumber, 0FFFFh<br /><br />                   .else ; eax ==VER_PLATFORM_WIN32_NT<br />                       mov esi, OFFSET szWinNT<br />                   .endif<br /><br />                   invoke lstrcpy, ADDR szOsVerInfo, esi<br /><br />                   invoke wsprintf, ADDR szOsVerInfoTmp,\<br />                          ADDR szFormat4OsVer, OsVer.dwMajorVersion,\<br />                          OsVer.dwMinorVersion, OsVer.dwBuildNumber<br /><br />                   invoke lstrcat, ADDR szOsVerInfo, ADDR szOsVerInfoTmp<br />                   invoke lstrcat, ADDR szOsVerInfo, ADDR OsVer.szCSDVersion<br />                   mov    edi, OFFSET szOsVerInfo<br />                   mov    esi, MB_OK OR MB_ICONINFORMATION	<br />            .else<br />                   mov    edi, OFFSET szGetOsInfoFail<br />                   mov    esi, MB_OK OR MB_ICONWARNING<br />            .endif<br /><br />        	invoke MessageBox, NULL, edi, addr szMsgBoxTitle, esi<br />        <br />        invoke ExitProcess,NULL<br /> <br />end start<br /></code></pre></div>
    <div class="meta">Posted on 2004-03-19 06:38:09 by purpleendurer</div>
   </div>
   <div class="post" id="post-136382">
    <div class="subject"><a href="#post-136382">What is the data between the DOS-stub-code and the PE-header</a></div>
    <div class="body"><div class="quote">Its usually junk, the space between the end of the MZ header and the start address of the PE header is undefined so you can use it for anything, store settings there or just zero it out if you want.</div><br />hutch--,<br /><br />No, as was discussed and analyzed in <a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=14699">this thread</a> , that data is encrypted information added by Microsoft. Of course it can be deleted though, like you say, it has no function for the execution of the program, but it is still not &quot;junk&quot;.<br /><br />Sadly, this interesting info about what was encrypted into that data (and how to decode it) was edited out from that thread by &quot;Lingo&quot; a few days ago for some reason (see the edit date on his post in that thread). I have tried to contact him to ask why, and to get that information, but received no reply. :(<br /><br />Does anyone have an archive of this board which is older than 2 weeks, from which you can retreive this info? That would be <strong>really</strong> great!<br /><br /><br />dELTA</div>
    <div class="meta">Posted on 2004-03-19 07:38:31 by dELTA</div>
   </div>
   <div class="post" id="post-136441">
    <div class="subject"><a href="#post-136441">What is the data between the DOS-stub-code and the PE-header</a></div>
    <div class="body">Hmmmm,<br /><br />This sounds like conspiracy theory, MS store the password to their repository of code at the beginning of every exe file made with ml/link even though its not used in the data.<br /><br />We all know that the start address for the PE header is in the last member of the MZ header. I have seen different start addresses on many different PE files ranging from 80h to well over 100h and I have at times used the space between the MZ and PE headers to write information that I recover at runtime with the exe file.<br /><br />If you use compressed exe files, the headers at the beginning are one of the few places where you can store settings in the disk file which can be changed after the exe is finished.</div>
    <div class="meta">Posted on 2004-03-19 17:38:54 by hutch--</div>
   </div>
   <div class="post" id="post-136444">
    <div class="subject"><a href="#post-136444">What is the data between the DOS-stub-code and the PE-header</a></div>
    <div class="body">There was a couple of lengthy posts about it, and it seemed real enough, A bit interesting, actually. The data stored there wasn't really anything major, but it's still a bit creepy that it's stored there - especially since it was XOR'ed (according to the original posts).</div>
    <div class="meta">Posted on 2004-03-19 17:42:12 by f0dder</div>
   </div>
   <div class="post" id="post-204928">
    <div class="subject"><a href="#post-204928">Re: What is the data between the DOS-stub-code and the PE-header</a></div>
    <div class="body">The mystery is solved at last! (by Daniel Pistelli)&nbsp; :)<br /><br />http://www.woodmann.com/forum/showthread.php?t=11367</div>
    <div class="meta">Posted on 2008-03-05 04:30:50 by dELTA</div>
   </div>
   <div class="post" id="post-204930">
    <div class="subject"><a href="#post-204930">Re: What is the data between the DOS-stub-code and the PE-header</a></div>
    <div class="body">Wow! Hat off to Mr. Pistelli.</div>
    <div class="meta">Posted on 2008-03-05 07:34:23 by JimmyClif</div>
   </div>
   <div class="post" id="post-204934">
    <div class="subject"><a href="#post-204934">Re: What is the data between the DOS-stub-code and the PE-header</a></div>
    <div class="body">It was documented even before that, the topic appeared on DonationCoder and a guy posted a .txt file about it from around the same time period as lingo&#039;s postings, iirc. Unfortunately DonationCoder has been hacked and is down for scrutinizing, so I can&#039;t find the post right now... but I think Pistelli&#039;s is a bit more in-depth :)<br /><br />Anyway dELTA, to remove suspicion about &quot;evil asmcommunity moderators&quot;, can you please post at woodmann&#039;s that lingo actually removed the information himself? Dunno why he did it.</div>
    <div class="meta">Posted on 2008-03-05 09:11:28 by f0dder</div>
   </div>
   <div class="post" id="post-204938">
    <div class="subject"><a href="#post-204938">Re: What is the data between the DOS-stub-code and the PE-header</a></div>
    <div class="body"><div class="quote"><br />The mystery is solved at last! (by Daniel Pistelli)&nbsp; :)</div><br />Hasn&#039;t the mystery already been solved?<br />http://www.woodmann.net/forum/attachment.php?attachmentid=1050<br /><br />thread: http://www.woodmann.com/forum/showthread.php?t=5925</div>
    <div class="meta">Posted on 2008-03-05 19:29:50 by drizz</div>
   </div>
   <div class="post" id="post-204939">
    <div class="subject"><a href="#post-204939">Re: What is the data between the DOS-stub-code and the PE-header</a></div>
    <div class="body"><div class="quote"><br /><div class="quote"><br />The mystery is solved at last! (by Daniel Pistelli)&nbsp; :)</div><br />Hasn&#039;t the mystery already been solved?<br />http://www.woodmann.net/forum/attachment.php?attachmentid=1050<br /></div><br />That&#039;s the .txt file <a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=11182.msg204934#msg204934">I was thinking about</a> :), you might want to link to the topic where that file was attached? And, again, to be fair: the new article is more in-depth.</div>
    <div class="meta">Posted on 2008-03-05 19:31:50 by f0dder</div>
   </div>
  </div>
 </body>
</html>