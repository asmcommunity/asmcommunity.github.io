<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>About  Mutex.... - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=14228" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=14228">About  Mutex....</a></p>
   <div class="post" id="post-110111">
    <div class="subject"><a href="#post-110111">About  Mutex....</a></div>
    <div class="body">I have a lttle a problem....i.e I have made a multi-downloader of file...<br /><br />and use a <strong>Mutex</strong> ....and of course also API<br /><br /><em>WaitForSingleObject</em> ....<br /><br />and sometime, from time to time, the second thread doesn't want to stop...i.e properties of Mutex don't want<br /><br />to re-pass to the principal thread...<br /><br />To find that...try several files to download...and generally big-one above 5 Mbytes...you'll see<br />my problem...<br /><br />If some-one of you find my error, please send me a answer...<br /><br />Gerard<br /><br />**************<br />Here is the file:  <a target="_blank" href="http://pageperso.aol.fr/GerardChap/Thread.zip"></a></div>
    <div class="meta">Posted on 2003-07-11 11:06:46 by gerard</div>
   </div>
   <div class="post" id="post-110113">
    <div class="subject"><a href="#post-110113">About  Mutex....</a></div>
    <div class="body">I'm not quite sure of the problem (and I'm not downloading a 5 megs file just to test it, sorry :grin: )...<br />What do you mean &quot;the thread won't stop&quot;? Exactly what are you using the mutex for? It seems to be used only in the proc that updates the progress control... :confused:</div>
    <div class="meta">Posted on 2003-07-11 11:29:52 by QvasiModo</div>
   </div>
   <div class="post" id="post-110114">
    <div class="subject"><a href="#post-110114">response....</a></div>
    <div class="body">Yes <strong>Mutex</strong>  is in a procedure which serves only to the <em>ProgressBar</em> ...<br /><br />it serves to let passed thread the ones behind the others....i.e to limit interferences...<br /><br />The problem is ...and I repeat me...in <em>WaitForSingleObject</em>  because it transferts properties of Mutex to an another thread...<br /><br />Please try to download several file and you'll see...and what I wanted is to find a stratagem <br />to palliate at this problem...<br /><br /><br />Gerard</div>
    <div class="meta">Posted on 2003-07-11 11:46:19 by gerard</div>
   </div>
   <div class="post" id="post-110118">
    <div class="subject"><a href="#post-110118">About  Mutex....</a></div>
    <div class="body">I don't have experience with mutex, and I would really hate such. Whenever possible, I always use code that I know by heart, and you can replace mutex stuff with XCHG. <br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=8796&amp;highlight=mutex">http://www.asmcommunity.net/board/index.php?topic=8796&amp;highlight=mutex</a><br /><br />I have been using XCHG for 1 year, and it absolutely never let me down. My program never crashed or misbehaved for object locking thanks to using my own mutex, even though it has 4 threads that have high priority and each of the threads gets its timeslice every 10ms.</div>
    <div class="meta">Posted on 2003-07-11 12:36:34 by Ultrano</div>
   </div>
   <div class="post" id="post-110133">
    <div class="subject"><a href="#post-110133">About  Mutex....</a></div>
    <div class="body">Sorry, still not following you...<br /><br />I don't understand many things about your code:<br /><br />1) Why using a mutex? I'm not sure exactly what you're trying to synchronize, and your code is not commented...<br /><br />2) Why opening the mutex with OpenMutex when you already have the handle?<br /><br />3) Why not sending a message to increase the progress bar position, instead of setting it's absoulte value? I think there's a message for that, PBM_SETPIT if I remember correctly.<br /><br />4) Why do you use the same global variable hMutex for all threads at the same time? Doesn't that cause the threads to overwrite each other's values?</div>
    <div class="meta">Posted on 2003-07-11 15:56:11 by QvasiModo</div>
   </div>
   <div class="post" id="post-110171">
    <div class="subject"><a href="#post-110171">response2....</a></div>
    <div class="body">It took me a long time to answer because I live in France...there is a gap of 6 hours between both...<br /><br />It is a good advice...and,of course, I followed it...I removed, therefore, the use of a   <strong>Mutex</strong>......Normally, all is well which finishes well... but prog doesn't always work correctly again...<br /> <br /><br />But I thought a lot about the problem I had... However the problem was not here and was in another place...a problem <br />of algorithm....i.e in the second thread...when buffer loads the last (remainder) of bytes (under 4096 bytes)....<br /><br />I am going to explain how works a <strong>Mutex</strong>...<br /><br />Nobody is the owner of a <strong>Mutex</strong>...when this-one is signaled...and a <strong>Mutex</strong>...have only one owner at each time...<br />but can change of owner...In my program, principal thread gets the <strong>Mutex</strong>......then after <strong>Mutex</strong> goes to thread1 and thread2 in an uncertain way...<br />and at last returns to principal thread....<br />Nothing more simple...<br /><br />If somobody finds my error....perhaps calculus of<br /><br />nSize1----&gt; 0FFFFF000 and nSize...<br /><br /><br />----<br />Gerard</div>
    <div class="meta">Posted on 2003-07-12 01:40:04 by gerard</div>
   </div>
   <div class="post" id="post-110201">
    <div class="subject"><a href="#post-110201">Some clues about Mutex</a></div>
    <div class="body">Yes I have forgotten to give you more informations, the more serious, from the site of <strong>Microsoft</strong> .<br /><br />You have to click on this link to access   <a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dllproc/base/mutex_objects.asp">Mutex_Objects</a> ...<br /><br /><br />I shall be happy if  you'll find this clue very interresting...<br /><br />-----<br /><br />Gerard<br /><br />?The two great and pricipal actions of the mind which are most frequently considered...are these two:Perception or thinking; and volition or willing. The power of thinking is called Understanding and the power of volition is called the Will; and these two powers or abilities in the mind  are denominated Faculties.? <strong>(Locke, Essay Livre I, ? VI.).</strong></div>
    <div class="meta">Posted on 2003-07-12 10:58:50 by gerard</div>
   </div>
   <div class="post" id="post-110560">
    <div class="subject"><a href="#post-110560">I understand now</a></div>
    <div class="body">Ok, I know now how your algo works:<br /><br />- Get the file size<br />- If it is small, download in one chunk with DownloadProc<br />- If it is big, split in two slices, and download in separate temp files in \Temp (create the folder if necessary)<br />- After downloading the two slices, merge them in one file.<br /><br />I had trouble understanding because I had never used a Mutex before, except for single instance application code. I prefer using events and messages, so I never tried mutexes and semaphores.<br /><br />I've been googling a while, and found out how to improve this algo, based on how GetRight, DAP, KaZaA and other programs work. It involves passing parameters to a thread, using event objects, file mapping (Iczelion's tutorial 13), and growing a file size without writing to it.<br /><br />First, the threads:<br />Well, you currently have 2 different procs for each thread. This could be inconvenient if you want to use more that this two threads in the future (imagine trying to use 10 threads :( ). The best way to solve this is using a single DownloadProc for all cases.<br /><pre><code><br />DAP_PARAMS struct<br />  hEvent  dd ?  ;will use to pass params<br />  hMap    dd ?  ;use for file mapping &#40;see below&#41;<br />  dwBegin dd ?  ;beginning of slice to download<br />  dwEnd   dd ?  ;end of slice to download<br />  ;etc... any other params you might want to pass<br />DAP_PARAMS ends<br /><br />.data<br />dap_params DAP_PARAMS &lt;&gt;<br /></code></pre><br />To call your threads:<br /><pre><code><br />; First we create the event object and set some params<br />invoke CreateEvent,0,0,0,0<br />mov dap_params.hEvent,eax<br />mov eax,hMap    ;this is your map handle<br />mov dap_params.hMap,eax<br />; so on, for all the params that are the same for all threads<br /><br />; Then, a loop&#58;<br />mov ecx,number_of_threads<br />.repeat<br />    push ecx<br /><br />    ; set all the other params here, that are different for every thread<br />    mov dap_params.dwBegin,beginning_of_slice<br />    mov dap_params.dwEnd,end_of_slice<br /><br />    ; create the thread<br />    invoke CreateThread,0,0,offset DownloadProc,offset dap_params,0,offset threadID<br /><br />    ; wait until it has copied the params to stack<br />    invoke WaitForSingleObject,dap_params.hEvent,INFINITE<br /><br />    pop ecx<br />.untilcxz<br /><br />; Now, close the event object, since we're not using it anymore.<br />invoke CloseHandle,dap_params.hEvent<br /><br />; In your download proc&#58;<br />DownloadProc proc lParam&#58;dword<br />    local myparams&#58;DAP_PARAMS   ;this is where we copy the params in stack<br /><br />    ; copy the params to stack<br />    mov eax,lParam<br />    lea edx,myparams<br />    mov ecx,sizeof DAP_PARAMS / 4   ;DWORD aligned! if not, you'll have to use bytes<br />    .repeat<br />        push dword ptr &#91;eax&#93;<br />        pop dword ptr &#91;edx&#93;<br />        add eax,4<br />        add edx,4<br />    .untilcxz<br /><br />    ;now that we have the data, set the event<br />    invoke SetEvent,&#40;DAP_PARAMS ptr &#91;eax&#93;&#41;.hEvent<br /><br />    ;... the rest of your code<br /><br />    ret                 ;it is not necessary to end in ExitThread, just return will do<br />DownloadProc endp<br /></code></pre><br /><br />So, now with the file mapping strategy:<br />The basic idea is this: once you know how long the file is (FileSize), and how many slices you want (number_of_slices), you divide FileSize by number_of_slices to get how long a slice is (SliceBytes).<br />The you create number_of_slices-1 threads that download SliceBytes bytes, and a last thread that downloads the rest of the file (FileSize - (SliceBytes * (number_of_slices - 1))).<br /><br />To write to file, you don't use WriteFile, instead open a file mapping (<strong>CreateFileMapping</strong>), and then each thread can map a view of the file corresponding to it's slice (<strong>MapViewOfFile</strong>). To do this, you need the destination file to be already FileSize bytes long, or you can't map. To do this, you have to allocate disk space without writing to disk (so it's faster).<br /><br />You have to:<br />- create the destination file (it will be 0 bytes for now)<br />- move the file pointer past the end of file (<strong>SetFilePointer</strong>), and set the end of the file (<strong>SetEndOfFile</strong>):<br />- then you can map the file.<br /><br />To extend the file size:<br /><pre><code><br />        invoke SetFilePointer,hFile,FileSize,0,FILE_BEGIN<br />        invoke SetEndOfFile,hFile<br />        invoke SetFilePointer,hFile,0,0,FILE_BEGIN    ;reset the file pointer before mapping<br /></code></pre><br /><br />You file will contain garbage at first (whatever was on the disk before you allocated that space). That's why when you take a partial download from KaZaA and try to open it with WinAMP, you might listen fragments of your deleted MP3 files... :) <br /><br />You can create a temp file first, but you should do it in the same drive and directory as your destination file. This way, the user will not try to open the file before it's finished downloading. When you're done downloading, just close the file and rename it (much faster than rebuilding the target file from several temp files).<br /><br />Another advantage of using this method is that you will know if there is enough disk space for your file, because SetEndOfFile will return error if there is not enough free space.<br /><br />As a final suggestion, you could use window messages to synchronize your threads... so if the user presses a &quot;Cancel&quot; button, you can signal the threads to stop. But it's a lot of work, I have never done it (yet).<br /><br />Now try it, and tell me how you're doing... and I think we'll all like to see your download accelerator posted when it's finished :alright: <br /><br />Well that was my longest post on this board... :cool:</div>
    <div class="meta">Posted on 2003-07-15 09:02:30 by QvasiModo</div>
   </div>
   <div class="post" id="post-111576">
    <div class="subject"><a href="#post-111576">response....</a></div>
    <div class="body"><strong> Moi Dorogoi </strong>   (Russian language) means Darling ----my dear is <strong> Dorogoi Moi</strong> ....it's for the &quot;flush&quot;....<br />stop here my little joke....and enter in the subject...<br /><br />Yes in the folder (with extension zip) you'll find a big stuff very interesting....and two tutorials than I &quot;bissed&quot;....<br /><br />About the mapping I signal to you, that it is very interresting with <strong> Process</strong>...and I already <br />(it's true: not finished) did one program in <strong> Visual Basic</strong>, you could find it here:<br /><a target="_blank" href="http://pageperso.aol.fr/GerardChap/VBasic.zip">Visual Basic</a> <br /><br />I think, you will be happy to see your e-mail below the tutorials, the two...<br /><br />If you have some comments to tell me...don't bother  you...e-mail me...or Fax me..(it is also a joke...<br />but this time french...when two boys live together ...we call that (the Law) a packs...).<br /><br />Like Madonna, I think I do my best....<br /><br />---<br />gerard<br />Where to find the folder:<br /><a target="_blank" href="http://pageperso.aol.fr/GerardChap/multi-threads.zip">Folder to download.</a> <br /><br />-------------------------------------------------<br />( Where two or more ideas have been often repeated together and the association has become very strong, they sometimes spring up in such close a combination as not to be distinguishable.)<br />                             &gt; James MILL &lt;</div>
    <div class="meta">Posted on 2003-07-23 05:32:27 by gerard</div>
   </div>
   <div class="post" id="post-111703">
    <div class="subject"><a href="#post-111703">About  Mutex....</a></div>
    <div class="body">Hey, glad I helped :) <br />By the way, I've been browsing your webpage... Great tutorials and code! :alright: <br />And thanks for including my mail address...</div>
    <div class="meta">Posted on 2003-07-24 08:03:41 by QvasiModo</div>
   </div>
  </div>
 </body>
</html>