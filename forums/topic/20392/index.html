<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>serv problem - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=20392" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=8">Networking</a> &raquo; <a href="../?id=20392">serv problem</a></p>
   <div class="post" id="post-156033">
    <div class="subject"><a href="#post-156033">serv problem</a></div>
    <div class="body">It looks like in my XP is something intercepting all socket function calls and change all the created sockets to nonblocking mode.<br /><br />what can i do with accept when it is in nonblocking mode?<br /><br />how can I check the queue with all hosts which are waiting for connection?<br /><br />I tryed to test Client.sin_addr i test it with 0 but it does not work...<br /><br />Please help me in my trouble:<br />fasm syntax:<br /><pre><code><br />include '%fasminc%/win32ax.inc'<br />sleep   fix invoke Sleep,200<br />printf  fix cinvoke pf<br />system  fix invoke sys<br />INVALID_SOCKET = 0<br /><br />.data<br /><br />;strin variable<br />ServName                rb      20h<br />ServIp                  rb      10h<br />ClientName              rb      20h<br />ClientIp                rb      10h<br />RemoteServName          rb      20h<br />RemoteServIp            rb      10h<br />ClientAsServName        rb      20h<br />ClientAsServIp          rb      10h<br />;structures data<br />wsa         WSADATA<br />Serv                    sockaddr_in<br />Client                  sockaddr_in<br />RemoteServ              sockaddr_in<br />ClientAsServ            sockaddr_in<br />;digital network data<br />sServ                   dd      ?               ;socket<br />sClientAsServ           dd      ?               ;socket<br />sClient                 dd      ?               ;socket<br />IPServ                  dd      ?               ;IP<br />IPClient                dd      ?               ;IP<br />IPRemoteServ            dd      ?               ;IP<br />ServPort                dd      80              ;port<br />RemoteServPort          dd      80              ;port<br />LocaClientPort          dd      ?               ;port<br />RemoteClientPort        dd      ?               ;port<br />;suppor data<br />hTHR                    dd      ?<br />E                       db      13,10,0<br />hSCR                    dd      ?               ; handle to console<br />pf                      dd      ?               ; printf<br />sys                     dd      ?               ; system<br />crtdll                  dd      ?               ; handle to crtdll.dll<br />bufor                   rb      40h<br />lllll                   db      &quot;programista.org&quot;,0<br />.code<br /><br />start&#58;<br />invoke  lstrcat,RemoteServName,lllll<br /><br />CONSOLE_INIT&#58;<br /><br />invoke  AllocConsole<br />invoke  GetStdHandle,STD_OUTPUT_HANDLE<br />        mov &#91;hSCR&#93;,eax<br /><br />LOAD_FUNC_CRT&#58;<br /><br />invoke  LoadLibrary,&quot;crtdll&quot;<br />        mov &#91;crtdll&#93;,eax<br />invoke  GetProcAddress,eax,&quot;printf&quot;<br />        mov &#91;pf&#93;,eax<br />invoke  GetProcAddress,&#91;crtdll&#93;,&quot;system&quot;<br />        mov &#91;sys&#93;,eax<br />        system, &quot;color 2a&quot;<br />        printf,&quot;Tunelling Server v0.1 AGP%s&quot;,E<br />        sleep<br />WSA_INIT&#58;<br />invoke  WSAStartup,202h,wsa<br />        cmp eax,0<br />        jne blad<br />        printf,&quot;network interface activated  . . .%s&quot;,E<br />        sleep<br />invoke  gethostname,ServName,20h<br />        printf,&quot;Server name is&#58; %s%s&quot;,ServName,E<br />        sleep<br />invoke  gethostbyname,ServName<br />virtual at eax<br />h  hostent<br />end virtual<br />        mov ebx,&#91;h.h_addr_list&#93;<br />        mov ebx,&#91;ebx&#93;<br />        mov ebx,&#91;ebx&#93;<br />        mov &#91;IPServ&#93;,ebx<br />invoke  inet_ntoa,ebx<br />invoke  lstrcat,ServIp,eax<br />        printf,&quot;IP&#58; %s%s&quot;,ServIp,E<br />        system,&quot;ipconfig&quot;<br />        printf,&quot;remote host named %s testing . . .%s&quot;,RemoteServName,E<br />        sleep<br />invoke gethostbyname,RemoteServName<br /><br />        mov ebx,&#91;h.h_addr_list&#93;<br />        mov ebx,&#91;ebx&#93;<br />        mov ebx,&#91;ebx&#93;<br />        mov &#91;IPRemoteServ&#93;,ebx<br />invoke  inet_ntoa,ebx<br />invoke  lstrcat,RemoteServIp,eax<br />        printf,&quot;%s&#58;IP %s%s&quot;,RemoteServName,RemoteServIp,E<br />        sleep<br />invoke  lstrcat,bufor,&quot;ping &quot;<br />invoke  lstrcat,bufor,lllll<br />        ;system,bufor<br />        mov eax,2<br />        mov&#91;Serv.sin_family&#93;,ax<br />        mov&#91;Client.sin_family&#93;,ax<br />        mov&#91;ClientAsServ.sin_family&#93;,ax<br />        mov&#91;RemoteServ.sin_family&#93;,ax<br />invoke  htons,&#91;ServPort&#93;<br />        mov &#91;Serv.sin_port&#93;,ax<br /><br />TUNELING&#58;<br />invoke  socket,2,1,0<br />        mov &#91;sServ&#93;,eax<br />        cmp eax,INVALID_SOCKET<br />        je blad<br />        printf,&quot;soket opened at&#58;0x%x%s&quot;,&#91;sServ&#93;,E<br />        sleep<br />invoke  bind,&#91;sServ&#93;,Serv,16<br />        cmp eax,0<br />        jne blad<br />invoke  listen,&#91;sServ&#93;,8<br />        cmp eax,0<br />        jne blad<br />ACCEPT&#58;<br />invoke ioctlsocket,&#91;sServ&#93;,'f',0<br />invoke closesocket,&#91;sClient&#93;<br />invoke accept,&#91;sServ&#93;,Client,16<br />       cmp eax,INVALID_SOCKET<br />       je ACCEPT<br />       mov &#91;sClient&#93;,eax<br />      ; mov eax,&#91;Client.sin_addr&#93;            &lt;-----this place i tryed to solve the problem<br />      ; cmp eax,0<br />      ; je ACCEPT<br />invoke MessageBox,0,0,0,0<br /><br />invoke CreateThread,0,0,NewClient,0,0,0<br />       mov &#91;hTHR&#93;,eax<br />invoke closesocket,&#91;sClient&#93;<br />invoke CloseHandle,&#91;hTHR&#93;<br /><br /><br />FREE_ALL&#58;<br /><br />invoke WSACleanup<br />       system,&quot;pause&quot;<br />invoke ExitProcess,0<br />blad&#58;<br />invoke  WSAGetLastError<br />        printf,&quot;IA ERROR&#58; %d !!!&quot;,eax<br />        system,&quot;color 4c&quot;<br />        call FREE_ALL<br />        system,&quot;pause&quot;<br />invoke ExitProcess,0<br /><br />NewClient&#58;<br />invoke  inet_ntoa,&#91;Client.sin_addr&#93;<br />        movzx ebx,&#91;Client.sin_port&#93;<br />        printf,&quot;succesful connected !!! %s%&#58;x%s&quot;,eax,ebx,E<br />invoke  ExitThread,0<br /><br /><br />.end start<br /></code></pre></div>
    <div class="meta">Posted on 2005-01-20 08:11:28 by etn</div>
   </div>
   <div class="post" id="post-156036">
    <div class="subject"><a href="#post-156036">serv problem</a></div>
    <div class="body">Either change the socket to Blocking by using Select(), or keep it as NonBlocking and use Event notification via WSAEventSelect (and then WSAWaitForMultipleEvents and WSAEnumNetworkEvents inside a loop).<br /><br />Second way is much nicer especially for a threaded application as you can put all your Server stuff inside one Thread, and maybe use other threads for other stuff. Especially nice to not have any Window Messages, and suits you because you have no Window :D<br /><br />Happy coding :)</div>
    <div class="meta">Posted on 2005-01-20 08:28:50 by Homer</div>
   </div>
   <div class="post" id="post-156040">
    <div class="subject"><a href="#post-156040">serv problem</a></div>
    <div class="body">the best 4 U! works fine:) thank You.</div>
    <div class="meta">Posted on 2005-01-20 09:00:40 by etn</div>
   </div>
   <div class="post" id="post-156267">
    <div class="subject"><a href="#post-156267">serv problem</a></div>
    <div class="body"><pre><code><br />include '%fasminc%/win32ax.inc'<br />sleep   fix invoke Sleep,200<br />printf  fix cinvoke pf<br />system  fix invoke sys<br />INVALID_SOCKET = 0<br /><br />.data<br /><br />;strin variable<br />ServName                rb      20h<br />ServIp                  rb      10h<br />ClientName              rb      20h<br />ClientIp                rb      10h<br />RemoteServName          rb      20h<br />RemoteServIp            rb      10h<br />ClientAsServName        rb      20h<br />ClientAsServIp          rb      10h<br />;structures data<br />wsa         WSADATA<br />Serv                    sockaddr_in<br />Client                  sockaddr_in<br />RemoteServ              sockaddr_in<br />ClientAsServ            sockaddr_in<br />;digital network data<br />sServ                   dd      ?               ;socket<br />sClientAsServ           dd      ?               ;socket<br />sClient                 dd      ?               ;socket<br />IPServ                  dd      ?               ;IP<br />IPClient                dd      ?               ;IP<br />IPRemoteServ            dd      ?               ;IP<br />ServPort                dd      80              ;port<br />RemoteServPort          dd      80              ;port<br />LocaClientPort          dd      ?               ;port<br />RemoteClientPort        dd      ?               ;port<br />;suppor data<br />fd_s    rd 68<br />hTHR                    dd      ?<br />E                       db      13,10,0<br />hSCR                    dd      ?               ; handle to console<br />pf                      dd      ?               ; printf<br />sys                     dd      ?               ; system<br />crtdll                  dd      ?               ; handle to crtdll.dll<br />bufor                   rb      400h<br />lllll                   db      &quot;programista.org&quot;,0<br />dlug_cl                 dd      ?<br />.code<br /><br />start&#58;<br />invoke  lstrcat,RemoteServName,lllll<br /><br />CONSOLE_INIT&#58;<br /><br />invoke  AllocConsole<br />invoke  GetStdHandle,STD_OUTPUT_HANDLE<br />        mov &#91;hSCR&#93;,eax<br /><br />LOAD_FUNC_CRT&#58;<br /><br />invoke  LoadLibrary,&quot;crtdll&quot;<br />        mov &#91;crtdll&#93;,eax<br />invoke  GetProcAddress,eax,&quot;printf&quot;<br />        mov &#91;pf&#93;,eax<br />invoke  GetProcAddress,&#91;crtdll&#93;,&quot;system&quot;<br />        mov &#91;sys&#93;,eax<br />        system, &quot;color 2a&quot;<br />        printf,&quot;Tunelling Server v0.1 AGP%s&quot;,E<br />        sleep<br />WSA_INIT&#58;<br />invoke  WSAStartup,101h,wsa<br />        cmp eax,0<br />        jne blad<br />        printf,&quot;network interface activated  . . .%s&quot;,E<br />        sleep<br />invoke  gethostname,ServName,20h<br />        printf,&quot;Server name is&#58; %s%s&quot;,ServName,E<br />        sleep<br />invoke  gethostbyname,ServName<br />virtual at eax<br />h  hostent<br />end virtual<br />        mov ebx,&#91;h.h_addr_list&#93;<br />        mov ebx,&#91;ebx&#93;<br />        mov ebx,&#91;ebx&#93;<br />        mov &#91;IPServ&#93;,ebx<br />invoke  inet_ntoa,ebx<br />invoke  lstrcat,ServIp,eax<br />        printf,&quot;IP&#58; %s%s&quot;,ServIp,E<br />        system,&quot;ipconfig&quot;<br />        printf,&quot;remote host named %s testing . . .%s&quot;,RemoteServName,E<br />        sleep<br />invoke  gethostbyname,RemoteServName<br /><br />        mov ebx,&#91;h.h_addr_list&#93;<br />        mov ebx,&#91;ebx&#93;<br />        mov ebx,&#91;ebx&#93;<br />        mov &#91;IPRemoteServ&#93;,ebx<br />invoke  inet_ntoa,ebx<br />invoke  lstrcat,RemoteServIp,eax<br />        printf,&quot;%s&#58;IP %s%s&quot;,RemoteServName,RemoteServIp,E<br />        sleep<br />invoke  lstrcat,bufor,&quot;ping &quot;<br />invoke  lstrcat,bufor,lllll<br />        ;system,bufor<br />        mov eax,2<br />        mov&#91;Serv.sin_family&#93;,ax<br />        mov&#91;Client.sin_family&#93;,ax<br />        mov&#91;ClientAsServ.sin_family&#93;,ax<br />        mov&#91;RemoteServ.sin_family&#93;,ax<br />invoke  htons,&#91;ServPort&#93;<br />        mov &#91;Serv.sin_port&#93;,ax<br /><br />TUNELING&#58;<br /><br />invoke  socket,2,1,6<br />        mov &#91;sServ&#93;,eax<br />        cmp eax,INVALID_SOCKET<br />        je blad<br />invoke  ioctlsocket,&#91;sServ&#93;,<br />        printf,&quot;soket opened at&#58;0x%x%s&quot;,&#91;sServ&#93;,E<br />        sleep<br />invoke  bind,&#91;sServ&#93;,Serv,16<br />        cmp eax,0<br />        jne blad<br />invoke  listen,&#91;sServ&#93;,8<br />        cmp eax,0<br />        jne blad<br />ACCEPT&#58;<br />        mov &#91;fd_s&#93;,1<br />        mov eax,&#91;sServ&#93;<br />        mov &#91;fd_s+4&#93;,eax<br />invoke select,1,fd_s,NULL,NULL,0<br /><br />invoke accept,&#91;sServ&#93;,Client,0<br />       cmp eax,INVALID_SOCKET<br />       je blad<br />       mov &#91;sClient&#93;,eax<br />       printf,&quot;connected!!!%s&quot;,E<br /><br />;invoke getpeername,&#91;sClient&#93;,Client,dlug_cl   ;-&gt; gives me the BUG 10014<br />;       cmp eax,0                              ; without those 3 lines it works almost fine<br />;       jne blad                               ;*******************************************<br />       movzx eax,&#91;Client.sin_port&#93;<br />invoke htons,eax<br />       push eax<br />       mov eax,&#91;Client.sin_addr&#93;<br />invoke inet_ntoa,eax<br />       pop ebx<br />       printf,&quot;adres&#58;%s%sport&#58;%S%S&quot;,eax,E,ebx,E<br />       mov &#91;fd_s&#93;,1<br />        mov eax,&#91;sClient&#93;<br />        mov &#91;fd_s+4&#93;,eax<br />goahead&#58;<br />invoke select,1,fd_s,NULL,NULL,0<br />invoke recv,&#91;sClient&#93;,bufor,3ffh,0<br />       cmp eax,-1<br />       je blad<br />       cmp eax,0<br />       jne skip<br /><br />       printf,&quot;this is the end my only friend-The End%s&quot;,E<br />       jmp blad<br />skip&#58;<br />       invoke _lwrite,&#91;hSCR&#93;,bufor,eax<br />       ;printf,&quot;%s&quot;,E<br /><br />jmp goahead<br /><br /><br /><br /><br /><br />invoke closesocket,&#91;sClient&#93;<br />invoke CloseHandle,&#91;hTHR&#93;<br /><br />;invoke Sleep,200000<br />FREE_ALL&#58;<br /><br />invoke WSACleanup<br />       system,&quot;pause&quot;<br />invoke ExitProcess,0<br />blad&#58;<br />invoke  WSAGetLastError<br />        printf,&quot;IA ERROR&#58; %d !!!&quot;,eax<br />        system,&quot;color 4c&quot;<br />        call FREE_ALL<br />        system,&quot;pause&quot;<br />invoke ExitProcess,0<br /><br /><br />.end start<br /></code></pre><br /><br />another broblema...<br />what should i do?<br />I can not retrive IP and port number connected to peer socket...</div>
    <div class="meta">Posted on 2005-01-25 07:58:15 by etn</div>
   </div>
   <div class="post" id="post-156326">
    <div class="subject"><a href="#post-156326">serv problem</a></div>
    <div class="body">#1 - getpeername doesn't get the peer's domain name string, it gets the peer's sockaddr_in structure which you already get during &quot;accept&quot; (see #3)<br /><br />#2 -  the last param of &quot;getpeername&quot; is the sizeof the second parameter, ie, sizeof sockaddr_in<br /><br />#3 - after calling &quot;accept&quot;, the remote peer's ip address is in the sockaddr_in structure given in the call to &quot;accept&quot; which in your case is called &quot;Client&quot;, so the call to &quot;getpeername&quot; becomes unnecessary.<br /><br />#4 - having retrieved the peer's ip address, resolve it to a name string if that's what you want by calling &quot;gethostbyaddr&quot;</div>
    <div class="meta">Posted on 2005-01-26 22:29:54 by Homer</div>
   </div>
   <div class="post" id="post-156335">
    <div class="subject"><a href="#post-156335">serv problem</a></div>
    <div class="body">In my situation accept sucks,<br />it did not fill in the sockaddr_in...<br />why? <br />I don't know why....<br />so I tryed to get the structure by getpeername.<br /><br />I do know nothin about a Client so gethostbyname is unuseful too.<br /><br />how this is possible that the getpeername gives me error 10014 ?<br /><br />Take care EvilHommer2k!<br />I'm waiting for news from You.<br /><br />etn</div>
    <div class="meta">Posted on 2005-01-27 04:27:57 by etn</div>
   </div>
   <div class="post" id="post-156421">
    <div class="subject"><a href="#post-156421">serv problem</a></div>
    <div class="body">10014 : The system detected an invalid pointer address in attempting to use a pointer argument of a call. This error occurs if an application passes an invalid pointer value, or if the length of the buffer is too small. For instance, if the length of an argument which is a struct sockaddr is smaller than sizeof(struct sockaddr). <br /><br />Look closer at the params for getpeername.<br /><br />Also, after calling accept, you should find the remote users ip in Client.sin_addr as a DWORD :)</div>
    <div class="meta">Posted on 2005-01-29 02:18:30 by Homer</div>
   </div>
  </div>
 </body>
</html>