<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Locals - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=6254" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=6254">Locals</a></p>
   <div class="post" id="post-44953">
    <div class="subject"><a href="#post-44953">Locals</a></div>
    <div class="body">3 questions:<br /><br />1. Is it possible to make MASM generate  reference for locals instead of ?<br /><br />2. How to turn off _temporary_ generation of epilogue code<br />for or how to turn it back without suppling macro.<br /><br />a1 proc<br />OPTION EPILOGUE:NONE ; <br /><br />ret<br />..<br />...<br />ret<br /><br /><br />;<br />OPTION EPILOGUE :  __? ; now I need to turn it on<br /><br />ret; exit<br />endp<br /><br />3. How to make MASM use pop instead of 'bad' instruction &quot;leave&quot;<br />in the epilogue code.</div>
    <div class="meta">Posted on 2002-06-24 13:32:45 by Sergo</div>
   </div>
   <div class="post" id="post-44957">
    <div class="subject"><a href="#post-44957">Locals</a></div>
    <div class="body"><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=2153&amp;highlight=EPILOGUE">HERE</a> is a more advanced demonstration that answers most of your questions.  It is not possible to have MASM automatically use  instead of creating the stack frame.  Chapter 9 of the MASM manual (towards the end) is a good read.</div>
    <div class="meta">Posted on 2002-06-24 13:52:52 by bitRAKE</div>
   </div>
   <div class="post" id="post-44962">
    <div class="subject"><a href="#post-44962">Locals</a></div>
    <div class="body">Here's a sample code on using locals without frames:<pre><code>myfunc PROC<br />    sub     esp, 20                     ;Allocate 20 bytes for our variable<br />    mov     DWORD PTR &#91;esp&#93;, &quot;lleH&quot;<br />    mov     DWORD PTR &#91;esp+4&#93;, &quot;rC o&quot;<br />    mov     DWORD PTR &#91;esp+8&#93;, &quot; leu&quot;<br />    mov     DWORD PTR &#91;esp+12&#93;, &quot;lroW&quot;<br />    mov     BYTE PTR &#91;esp+16&#93;, &quot;d&quot;<br />    mov     BYTE PTR &#91;esp+17&#93;, 0<br />    lea     eax, &#91;esp&#93;                  ;Load the address of the variable<br />    invoke  MessageBox, NULL, eax, NULL, MB_OK<br />    add     esp, 20<br />    retn<br />myfunc ENDP</code></pre>Here's a screenshot from a disasm view, to prove that there are no frames.</div>
    <div class="meta">Posted on 2002-06-24 14:16:08 by stryker</div>
   </div>
   <div class="post" id="post-44989">
    <div class="subject"><a href="#post-44989">Locals</a></div>
    <div class="body">I don't know why you have to make things so hard, <strong>stryker</strong>. :grin:<pre><code>proto9 typedef proto &#58;DWORD, &#58;DWORD, &#58;DWORD, &#58;DWORD, &#58;DWORD, &#58;DWORD, &#58;DWORD, &#58;DWORD, &#58;DWORD<br />invoke proto9 PTR &#91;MessageBox&#93;, 0, ADDR &#91;esp+8&#93;, 0, 0, 6C6C6548h, 7243206Fh, 206C6575h, 6C726F57h, 2E64h<br />add esp,20</code></pre></div>
    <div class="meta">Posted on 2002-06-24 17:02:09 by bitRAKE</div>
   </div>
   <div class="post" id="post-44991">
    <div class="subject"><a href="#post-44991">Locals</a></div>
    <div class="body">lol!!! :grin: I like it this way!<br /><br />I like that code above too. Never tried that yet!!! :)</div>
    <div class="meta">Posted on 2002-06-24 17:36:59 by stryker</div>
   </div>
   <div class="post" id="post-45369">
    <div class="subject"><a href="#post-45369">Locals</a></div>
    <div class="body">Can't you make macros for push and pop which keeps track of the offset to the locals. But that would mean that you couldn't push and pop as you want.</div>
    <div class="meta">Posted on 2002-06-27 06:25:12 by gliptic</div>
   </div>
   <div class="post" id="post-45380">
    <div class="subject"><a href="#post-45380">Locals</a></div>
    <div class="body"><strong>gliptic</strong>, yes and it works except for loops that push/pop.</div>
    <div class="meta">Posted on 2002-06-27 06:48:21 by bitRAKE</div>
   </div>
   <div class="post" id="post-45719">
    <div class="subject"><a href="#post-45719">MASM macros</a></div>
    <div class="body">What are the internal names for default prologue epilogue macros?<br />For example<br />OPTION EPILOGUE: default.<br /><br />BTW can anybody suggest a link to MASM Programmer's Guide in one downoadable file.<br />BTW, Intel recommend use  for leaf procedures ( ebp only for debug purposes )and avoid using complex instructions like 'leave' (also mov ,  const <br />comparing to  push ). So comparing to the code generated by compilers in optimized mode (I checked cl.exe /O2 ) , code produced by ASSEMBLER ( MASM) using default macros doesn't look very good. :(</div>
    <div class="meta">Posted on 2002-06-29 11:04:40 by Sergo</div>
   </div>
   <div class="post" id="post-45767">
    <div class="subject"><a href="#post-45767">About LEAVE</a></div>
    <div class="body">AMD recommends using LEAVE instruction... Now what? :confused:</div>
    <div class="meta">Posted on 2002-06-29 17:31:09 by minimoog</div>
   </div>
   <div class="post" id="post-45779">
    <div class="subject"><a href="#post-45779">&quot;( ebp only for debug purposes )&quot; if that's the ca</a></div>
    <div class="body">Can ebp be zero out.  Can i kill it sometime or change it.  I think someone said he did something like that but did not explain how... i'm not sure...</div>
    <div class="meta">Posted on 2002-06-29 20:57:22 by cmax</div>
   </div>
   <div class="post" id="post-47464">
    <div class="subject"><a href="#post-47464">Re: Locals</a></div>
    <div class="body"><div class="quote"><br />3 questions:<br /><br />1. Is it possible to make MASM generate  reference for locals instead of ?<br /><br />2. How to turn off _temporary_ generation of epilogue code<br />for or how to turn it back without suppling macro.<br /><br />3. How to make MASM use pop instead of 'bad' instruction &quot;leave&quot;<br />in the epilogue code. </div>1. No<br /><br />2. The defaults are turned on with:<br />	OPTION PROLOGUE:PROLOGUEDEF<br />	OPTION EPILOGUE:EPILOGUEDEF<br /><br />3. You have to write a custom epilogue macro for this.<br /><div class="quote"><br />What are the internal names for default prologue epilogue macros?<br /><br />BTW, Intel recommend use  for leaf procedures ( ebp only for debug purposes )and avoid using complex instructions like 'leave' (also mov ,  const comparing to  push ). So comparing to the code generated by compilers in optimized mode (I checked cl.exe /O2 ) , code produced by ASSEMBLER ( MASM) using default macros doesn't look very good. :( </div><strong>Sergo</strong>, I missed answering question two directly, but the fact that you asked the same question again indicates you did not look at my code.  It is not complete, but there is still something to learn from it.  Please take note of the fact prologue / epilogue examples for MASM are <em>very</em> rare.<br /><br />MASM is old compared to VC++ and is updated less frequently.  It is left up to the programmer to create more optimal code than the outdated code produced by the HL syntax.  It still does well on an Athlon CPU.  A replacement for MASM is long overdue, but it is not an easy task - MASM is very complex.</div>
    <div class="meta">Posted on 2002-07-14 03:07:37 by bitRAKE</div>
   </div>
   <div class="post" id="post-47486">
    <div class="subject"><a href="#post-47486">Locals</a></div>
    <div class="body">Here are a couple of simple macros that solve the problem of stack entry and exit. The assigned variable in one holds its value in the next so the value for the byte count in the first used on esp can be used again in the next one to correct the stack.<br /><pre><code><br />; #########################################################################<br /><br />    .486<br />    .model flat, stdcall<br />    option casemap &#58;none   ; case sensitive<br /><br />; #########################################################################<br /><br />    proc_entry MACRO bytes&#58;REQ<br />      LOCAL start<br />      start equ &lt;sub esp, &gt;<br />      var = bytes               ;; assignment works across different macros<br />      start CATSTR start,%var   ;; use it here locally<br />      start<br />    ENDM<br /><br />    proc_exit MACRO<br />      LOCAL end<br />      end equ &lt;add esp, &gt;<br />      end CATSTR end,%var       ;; use it again in next macro<br />      end<br />    ENDM<br /><br />; #########################################################################<br /><br />    .code<br /><br />start&#58;<br /><br />proc_entry 20<br /><br />    xor eax, eax<br /><br />proc_exit<br /><br />; #########################################################################<br /><br />end start<br /></code></pre><br />This generates the code,<br /><pre><code><br />00401000                    start&#58;<br />00401000 83EC14                 sub     esp,14h<br />00401003 33C0                   xor     eax,eax<br />00401005 83C414                 add     esp,14h<br /></code></pre><br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-07-14 07:55:51 by hutch--</div>
   </div>
   <div class="post" id="post-47488">
    <div class="subject"><a href="#post-47488">Locals</a></div>
    <div class="body"><u>Condensed Version</u>:<pre><code>proc_entry MACRO bytes&#58;REQ<br />	;; assignment works across different macros<br />	var = bytes<br />	sub esp, bytes<br />ENDM<br /><br />proc_exit MACRO<br />	% add esp, var<br />ENDM</code></pre>Nesting would be nice. :)<br /><br /><br /><u>Super Condensed Version</u>:<pre><code>proc_entry MACRO bytes&#58;REQ<br />	sub esp, bytes<br /><br />	;; assignment works across different macros ;&#41;<br />	proc_exit MACRO<br />		add esp, bytes<br />	ENDM<br />ENDM</code></pre>:grin: :grin:</div>
    <div class="meta">Posted on 2002-07-14 08:08:04 by bitRAKE</div>
   </div>
   <div class="post" id="post-47489">
    <div class="subject"><a href="#post-47489">Nesting ?</a></div>
    <div class="body"><pre><code><br />; #########################################################################<br /><br />    proc_entry MACRO name,bytes&#58;REQ<br />      LOCAL start<br />      name&#58;<br />      start equ &lt;sub esp, &gt;<br />      var = bytes               ;; assignment works across different macros<br />      start CATSTR start,%var   ;; use it here locally<br />      start<br />    ENDM<br /><br />    proc_exit MACRO<br />      LOCAL end<br />      end equ &lt;add esp, &gt;<br />      end CATSTR end,%var       ;; use it again in next macro<br />      end<br />      retn<br />    ENDM<br /><br />; ###################################<br /><br />    .code<br /><br />start&#58;<br /><br />call proc1<br /><br />proc_entry proc1, 20<br />    call proc2<br />proc_exit<br /><br />proc_entry proc2, 20<br />    mov eax, 1<br />proc_exit<br /></code></pre><br />Generates the code,<br /><pre><code><br />00401000                    start&#58;<br />00401000 E800000000             call    fn_00401005<br />00401005                    fn_00401005&#58;<br />00401005 83EC14                 sub     esp,14h<br />00401008 E804000000             call    fn_00401011<br />0040100D 83C414                 add     esp,14h<br />00401010 C3                     ret<br />00401011                    fn_00401011&#58;<br />00401011 83EC14                 sub     esp,14h<br />00401014 B801000000             mov     eax,1<br />00401019 83C414                 add     esp,14h<br />0040101C C3                     ret<br /></code></pre><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-07-14 08:17:49 by hutch--</div>
   </div>
   <div class="post" id="post-47490">
    <div class="subject"><a href="#post-47490">Locals</a></div>
    <div class="body">Well, I mean - nesting:<pre><code>proc_entry 20<br /><br />    xor eax, eax<br /><br />    proc_entry 20<br />        xor eax, eax<br />    proc_exit<br />proc_exit</code></pre>With no CALL overhead.</div>
    <div class="meta">Posted on 2002-07-14 08:20:25 by bitRAKE</div>
   </div>
   <div class="post" id="post-47492">
    <div class="subject"><a href="#post-47492">Locals</a></div>
    <div class="body">Yes,<br /><br />you are right, the two macros must be symetrical but this is not really a problem as MASM requires this anyway in its own PROC syntax.<br /><br />I would imagine that a proc nested in the way your example is done would need to be written differently. A jump to a label and a following RETN within the scope of an existing proc is common use so its a matter of whether the stack needs to be preserved within an existing proc anyway.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-07-14 08:41:29 by hutch--</div>
   </div>
   <div class="post" id="post-47795">
    <div class="subject"><a href="#post-47795">Re: About LEAVE</a></div>
    <div class="body"><div class="quote"><br />AMD recommends using LEAVE instruction... Now what? :confused: </div><br /><br />Not just AMD.  Intel recommends it for P6, too.  (I do not have Intel's optimization guide for P5, so I don' know about P5.)  In fact, <strong>leave</strong> is a 3 micro-op instruction and we don't need to worry about decoding bottleneck on P6.  Moreover, it is only one byte long and it is logically plausible that using <strong>leave</strong> is better than <strong>mov esp,ebp / pop ebp</strong> combination.   I don't know if it is actually better, but I don't care, because <strong>leave</strong> is usually followed by <strong>ret</strong> and I don't think I would enjoy any big speed gain by not using <strong>leave</strong>.  :)</div>
    <div class="meta">Posted on 2002-07-15 17:08:52 by Starless</div>
   </div>
   <div class="post" id="post-47821">
    <div class="subject"><a href="#post-47821">Locals</a></div>
    <div class="body">I agree with Starless here, if a block of code is small enough and speed critical enough, you write it inline and forget about using the call/ret syntax or the stack. Its when you want block code that can be accessed from a range of different places that you use a procedure.<br /><br />I have yet to see any blazing speed differences in stack entry and exit and LEAVE does generate small code that seems to work fine.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-07-15 20:54:46 by hutch--</div>
   </div>
  </div>
 </body>
</html>