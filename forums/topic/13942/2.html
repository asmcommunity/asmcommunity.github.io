<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Problems using COM methods - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=13942" />
  <link rel="prev" href="../?id=13942&amp;page=1" />   </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=116">Windows</a> &raquo; <a href="../?id=13942">Problems using COM methods</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=13942&amp;page=1" style="">&laquo;</a><a href="../?id=13942&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="13942" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>   <div class="post" id="post-117477">
    <div class="subject"><a href="#post-117477">Problems using COM methods</a></div>
    <div class="body">Now i have another little issue, still with the same DLL. <br /><br />The idea of this component is to help read and write .ifc files, which contain information about buildings. The .ifc files are actually just ascii files, but it's complicated to extract the needed information from them.<br /><br />The BSPro.IfcServer works with only one .ifc file at a time. Most often one file contains the data of just one building storey. In my project, i want to deal with the whole building, therefore i need to open multiple .ifc files. <br /><br />So i thought that i'll just create as many ifcserver objects as there are .ifc files. The code below does that.<br /><br /><pre><code><br />invoke CLSIDFromProgID, CStrW&#40;L&#40;BSPro.IfcServer&#41;&#41;, addr clsidApp<br /><br />mov IFCofn.lStructSize,SIZEOF IFCofn<br />push hwndMain<br />pop  IFCofn.hWndOwner<br />push hInstance<br />pop  IFCofn.hInstance<br />mov  IFCofn.lpstrFilter, OFFSET IFCFilterString<br />mov  IFCofn.lpstrFile, OFFSET IFCbuffer<br />mov  IFCofn.nMaxFile,&#40;MAXSIZE*MAXIFCCOUNT&#41;<br />mov IFCofn.lpstrTitle,CStr &#40;&quot;Open IFC file&#40;s&#41;&quot;&#41; <br />mov  IFCofn.Flags, OFN_FILEMUSTEXIST or \<br />OFN_PATHMUSTEXIST or OFN_LONGNAMES or\<br />OFN_EXPLORER or OFN_HIDEREADONLY or OFN_ALLOWMULTISELECT<br />invoke GetOpenFileName, ADDR IFCofn  <br /><br />invoke HowManyFileNames,addr IFCbuffer<br />mov IFCFileCount,eax<br />mov eax,4<br />mul IFCFileCount<br />invoke HeapAlloc,hHeap,HEAP_ZERO_MEMORY,eax<br />mov pIfcServers,eax <br /><br /><br />xor edi,edi<br />xor esi,esi<br />NextServer&#58;<br />.while esi&lt;IFCFileCount<br />	inc edi<br />	invoke MakeSingleFileStr,addr IFCbuffer,edi,addr IFCSinglebuffer<br />	lea ebx,pIfcServers&#91;esi*4&#93;<br />	invoke CoCreateInstance, ADDR clsidApp, NULL, CLSCTX_ALL,\<br />	addr IID_IIfcServer, ebx<br />	invoke MultiByteToWideChar,CP_ACP,MB_PRECOMPOSED, addr IFCSinglebuffer,-1,addr IFCWbuffer,SIZEOF IFCWbuffer<br />	invoke SysAllocString, addr IFCWbuffer<br />	mov bstrString,eax<br />	invoke dm&#40;pIfcServers&#91;esi*4&#93;,IIfcServer,ReadIfcFile&#41;,bstrString, addr retval<br />	invoke SysFreeString,bstrString<br />	inc esi<br />.endw	<br /></code></pre><br /><br />I thought that after this i can access any of the opened files with the appropriate pointer, for example<br /><br /><pre><code><br />xor esi,esi<br />mov ebx,IFCFileCount<br />.while ebx&gt;0<br />	invoke dm&#40;pIfcServers&#91;esi*4&#93;,IIfcServer,get_FileName&#41;,addr IFCWbuffer<br />	PrintDec eax<br />	invoke  WideCharToMultiByte,CP_ACP,WC_COMPOSITECHECK,addr IFCWbuffer,-1,addr buffer,256,NULL,NULL<br />	dec ebx<br />	inc esi<br />	PrintString buffer<br />.endw<br /></code></pre><br /><br />This is where the problem arises. No matter which object instance i use, it returns information from the LAST file opened. <br /><br />I can think of a few options here<br /><br />- put every instance of ifcserver in separate process, maybe that way they wont overwrite each 	others stuff<br /><br />- merge all the opened .ifc files together, use only one ifcserver<br /><br />I have a feeling that both of the above could get complicated, so i'd appreciate any ideas.</div>
    <div class="meta">Posted on 2003-09-08 13:38:42 by Janne</div>
   </div>
   <div class="post" id="post-117536">
    <div class="subject"><a href="#post-117536">Problems using COM methods</a></div>
    <div class="body">Pardon the phun...<br /><br />But the problem your describing is a <em>property</em> that is easily noticed when a class is defined with direct access to its variable instead of throught a method (as Japheth pointed out earlier ).<br /><br />It sounds to me that due to the developers short-cuts it would have also been intended for single server uses only.<br /><br />:NaN:</div>
    <div class="meta">Posted on 2003-09-08 20:42:17 by NaN</div>
   </div>
   <div class="post" id="post-117569">
    <div class="subject"><a href="#post-117569">Problems using COM methods</a></div>
    <div class="body">My example was'nt too good because it gets a property. But with this problem, it doens'nt matter whether it's a property or method. A new file opened will replace the old. I guess this is only natural when the server objects are in the same address space, if the author of the DLL has'nt specially<br />handled the multiple file situation.<br /><br />I was just hoping that maybe there is some simple solution to this problem, that i can't see.</div>
    <div class="meta">Posted on 2003-09-09 01:17:47 by Janne</div>
   </div>
   <div class="post" id="post-117618">
    <div class="subject"><a href="#post-117618">Problems using COM methods</a></div>
    <div class="body">Ya.. i wasnt very clear (after rereading the above)..<br /><br />Its more than likely the author used global values and a global vtable for interfaces.  Thus in effect they have made a class for class objects, rather than a class for class instances.   To do the latter, the com object should have allocated unique instance memory and copied in the vtable and data onto this memory.  Doing so would then give you the behaviour your looking for...<br /><br />I guess a good check for this is to print out the hex value for the pVtable that is returned every time you create an instance.  If they all come back the same, its a safe bet my above assumption is true....  if not, then maybe im overlooking something...<br /><br />:NaN:</div>
    <div class="meta">Posted on 2003-09-09 20:56:46 by NaN</div>
   </div>
   <div class="post" id="post-117625">
    <div class="subject"><a href="#post-117625">Problems using COM methods</a></div>
    <div class="body">I did PrintHex the ppv:s the CoCreateInstance gives, it is different every time.<br /><br />MSDN says:<br /><br /><div class="quote"><br />Call CoCreateInstance when you want to create only one object on the local system. To create a single object on a remote system, call CoCreateInstanceEx. To create multiple objects based on a single CLSID, refer to the CoGetClassObject function. <br /></div><br /><br />Did'nt have the time to test CoGetClassObject yet, but my guess is it wont make any difference.</div>
    <div class="meta">Posted on 2003-09-09 22:59:02 by Janne</div>
   </div>
   <div class="post" id="post-117636">
    <div class="subject"><a href="#post-117636">Problems using COM methods</a></div>
    <div class="body">Hi guys,<br /><br />I doubt that its a good idea to make any conclusions from values in the vtable. Remember that in many cases you will see a vtable of the proxy only. Thats true for out-of-process servers in any case.<br /><br />Japheth</div>
    <div class="meta">Posted on 2003-09-10 02:03:48 by japheth</div>
   </div>
   <div class="post" id="post-117639">
    <div class="subject"><a href="#post-117639">Problems using COM methods</a></div>
    <div class="body">Another thing what strikes me is this<br /><br /><pre><code><br />             invoke HeapAlloc,hHeap,HEAP_ZERO_MEMORY,eax<br />             mov pIfcServers,eax <br /></code></pre><br /><br />So pIfcServers is a pointer. But<br /><br /><pre><code><br />	lea ebx,pIfcServers&#91;esi*4&#93;<br />	invoke CoCreateInstance, ADDR clsidApp, NULL, CLSCTX_ALL,\<br /></code></pre><br /><br />Ths code doesnt do what it is expected to do. It would only work ok if pIfcServers is an array. So I wonder why your app doesnt crash.<br /><br />Corect code would be<br /><br /><pre><code><br />	mov ebx,pIfcServers<br />                    lea ebx, &#91;ebx + esi*4&#93;<br />	invoke CoCreateInstance, ADDR clsidApp, NULL, CLSCTX_ALL,\<br /></code></pre><br /><br />the other parts need such a correction as well.<br /><br />Thats an severe error, but im afraid it wont change your problem.<br /><br />Japheth</div>
    <div class="meta">Posted on 2003-09-10 02:29:00 by japheth</div>
   </div>
   <div class="post" id="post-117696">
    <div class="subject"><a href="#post-117696">Problems using COM methods</a></div>
    <div class="body">Japheth, thanks for pointing out those nasty bugs. <br /><br />As you guessed, the original problem still remains. However, now i've noticed that some of the functions work as i expected, some have the problem described above. For example, with 3 files opened<br /><br /><pre><code><br />xor esi,esi<br />mov ebx,IFCFileCount<br />.while ebx&gt;0<br />	mov edx,pIfcServers<br />	invoke dm&#40;&#91;edx+esi*4&#93;,IIfcServer,GetIfcSchema&#41;,addr BString;get the file &quot;format&quot;<br />	mov edx,BString<br />	invoke  WideCharToMultiByte,CP_ACP,WC_COMPOSITECHECK,edx,-1,addr buffer,256,NULL,NULL<br />	dec ebx<br />	inc esi<br />	PrintString buffer<br />.endw	<br /></code></pre><br /><br />works fine, i get to the output window<br /><br /><pre><code><br />buffer = IFC20_LONGFORM <br />buffer = IFC2X_FINAL <br />buffer = IFC151 <br /></code></pre><br /><br />but this<br /><br /><pre><code><br />xor esi,esi<br />mov ebx,IFCFileCount<br />.while ebx&gt;0<br />	mov edx,pIfcServers<br />	invoke dm&#40;&#91;edx+esi*4&#93;,IIfcServer,GetSpaces&#41;,addr pSpaces<br />	invoke dm&#40;pSpaces,IIfcCollection,GetSpace&#41;,0,addr pSpace;get the first space in file<br />	invoke dm&#40;pSpace,IIfcSpace,GetGUID&#41;,addr BString;get space's unique identifier		<br />	mov edx,BString<br />	invoke  WideCharToMultiByte,CP_ACP,WC_COMPOSITECHECK,edx,-1,addr buffer,256,NULL,NULL<br />	dec ebx<br />	inc esi<br />	PrintString buffer<br />.endw<br /></code></pre><br /><br />produces<br /><br /><pre><code><br />buffer = 3C1762A6FCF504DB0049 <br />buffer = 3C1762A6FCF504DB0049 <br />buffer = 3C1762A6FCF504DB0049<br /></code></pre><br /><br />this string comes only from the file whose server was the last one created.</div>
    <div class="meta">Posted on 2003-09-10 15:24:58 by Janne</div>
   </div>
   <div class="post" id="post-117745">
    <div class="subject"><a href="#post-117745">Problems using COM methods</a></div>
    <div class="body">Janne,<br /><br />most likely you have done it already but I would suggest some error checking:<br /><br /><pre><code><br />xor esi,esi<br />mov ebx,IFCFileCount<br />.while ebx&gt;0<br />	mov edx,pIfcServers<br />	invoke dm&#40;&#91;edx+esi*4&#93;,IIfcServer,GetSpaces&#41;,addr pSpaces<br />	.if &#40;eax == S_OK&#41;<br />		invoke dm&#40;pSpaces,IIfcCollection,GetSpace&#41;,0,addr pSpace;get the first space in file<br />		.if &#40;eax == S_OK&#41;<br />			invoke dm&#40;pSpace,IIfcSpace,GetGUID&#41;,addr BString;get space's unique identifier		<br />			mov edx,BString<br />			invoke  WideCharToMultiByte,CP_ACP,WC_COMPOSITECHECK,edx,-1,addr buffer,256,NULL,NULL<br />		.else<br />			invoke MessageBox, ...<br />			mov buffer, 0<br />		.endif<br />	.else<br />		invoke MessageBox, ...<br />		mov buffer, 0<br />	.endif<br />	dec ebx<br />	inc esi<br />	PrintString buffer<br />.endw<br /></code></pre><br /><br />And remember that the caller must free BSTRs returned by a method.<br /><br />Japheth</div>
    <div class="meta">Posted on 2003-09-11 07:51:09 by japheth</div>
   </div>
   <div class="post" id="post-118106">
    <div class="subject"><a href="#post-118106">Problems using COM methods</a></div>
    <div class="body"><div class="quote"><br />And remember that the caller must free BSTRs returned by a method.<br /></div><br />Did'nt &quot;remember&quot; that one either.<br />But still cant make it work with multiple files. Now i have some kind of theory though, why it does'nt work.<br /><br />The current .ifc files have two parts, the header and the data. The header is usually under 10 lines of ascii text, the data is a lot more, avarage is maybe 100 000 lines or so.<br /><br />The function above that works, deals with the header, the non-working with the data. So i think that the DLL uses different memory handling routines for the header end the data. So the bottom line is that i think there is no cure for this problem as long as the DLL runs in-process.<br /><br />I have a pretty strong feeling that if all instances of the ifcserver were in different processes, it would just have to work. But i don't have much of a clue how to make that happen, so next i'll just try to merge all the opened files together and give the one file to the ifcserver.</div>
    <div class="meta">Posted on 2003-09-14 13:14:49 by Janne</div>
   </div>
   <div class="post" id="post-118290">
    <div class="subject"><a href="#post-118290">Problems using COM methods</a></div>
    <div class="body">apparently, loading a DLL server in a different process than the client is simple with a <a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/com/htm/dllsurgt_68j7.asp">DLL surrogate.</a><br /><br />But is there a way to force a new instance of the surrogate for every instance of the server object? I guess it is not done by default, because (from MSDN)<br /><br /><div class="quote"><br />DLL servers will share a surrogate if they have matching security identities and share the same AppID value.<br /><br /></div></div>
    <div class="meta">Posted on 2003-09-15 23:00:11 by Janne</div>
   </div>
   <div class="post" id="post-118296">
    <div class="subject"><a href="#post-118296">Problems using COM methods</a></div>
    <div class="body">Hi Janne,<br /><br />you can write a custom surrogate (implements ISurrogate). The class factory's CreateInstance method then will have to launch another process if count is &gt; 0.<br /><br />Possibly this job isnt too hard, but I doubt it is worth the efforts.<br /><br />Japheth</div>
    <div class="meta">Posted on 2003-09-16 00:15:44 by japheth</div>
   </div>
   <div class="post" id="post-118361">
    <div class="subject"><a href="#post-118361">Problems using COM methods</a></div>
    <div class="body">I tested the system supplied surrogate, CoCreateInstance fails. Is the flag to be used CLSCTX_LOCAL_SERVER? With that bit only, the call takes about 30 seconds and returns with 80080005 (Server execution failed). The registry should have the required entries:</div>
    <div class="meta">Posted on 2003-09-16 16:09:57 by Janne</div>
   </div>
   <div class="post" id="post-118430">
    <div class="subject"><a href="#post-118430">Problems using COM methods</a></div>
    <div class="body">Hi Janne<br /><br /><div class="quote"><br />Is the flag to be used CLSCTX_LOCAL_SERVER?<br /></div><br /><br />Yes, AFAIK. And the CLSCTX_INPROC must not be set. This works with my SimpleServer dll at least<br /><br />Your server is possibly incapable to execute out-of-process. This may be the case because marshalling <br />isnt available for any interface the server exposes. The &quot;universal&quot;, typelib-driven marshaller shoud be able<br />to handle all dispinterfaces and dual interfaces. custom interfaces must be marked with attribute .<br /><br />I just tried with comview to create 2 objects with &quot;DllSurrogate&quot;, changing the AppId after creating the first. As expected, each server runs it its own process now. Not very elegant, but it works.<br /><br />Japheth</div>
    <div class="meta">Posted on 2003-09-17 03:17:00 by japheth</div>
   </div>
   <div class="post" id="post-118515">
    <div class="subject"><a href="#post-118515">Problems using COM methods</a></div>
    <div class="body">Tested the system surrogate with a totally different DLL, got exactly the same result (80080005). This time i tried to create the instance with Comview.So looks that i have a general, system-wide problem using DLL surrogates. The OS is an old one (win98, not even SE), but it should support using DLL surrogates, i guess.</div>
    <div class="meta">Posted on 2003-09-17 22:54:53 by Janne</div>
   </div>
   <div class="post" id="post-118523">
    <div class="subject"><a href="#post-118523">Problems using COM methods</a></div>
    <div class="body">Tested SimpleServer on a Win98 system (should be first edition, files dated may 1998). Has no problem with DllSurrogate. Dll runs in a process with executable DllHost.exe.<br /><br />MS Office 2000 and IE 6 is installed on that computer, thou. Most likely installation changed some system dlls.</div>
    <div class="meta">Posted on 2003-09-18 01:00:12 by japheth</div>
   </div>
   <div class="post" id="post-118623">
    <div class="subject"><a href="#post-118623">Problems using COM methods</a></div>
    <div class="body">In Control Panel / Networks there is by default &quot;Client For Microsoft Networks&quot;. I had removed that because it was a security recommendation of my cable modem connection provider. <br /><br />If i re-install the above, dllhost.exe seems to be doing it's job just fine.</div>
    <div class="meta">Posted on 2003-09-18 22:32:15 by Janne</div>
   </div>
   <div class="post" id="post-119739">
    <div class="subject"><a href="#post-119739">Problems using COM methods</a></div>
    <div class="body">Hi Japheth<br /><br /><div class="quote"><br />I just tried with comview to create 2 objects with &quot;DllSurrogate&quot;, changing the AppId <br />after creating the first. As expected, each server runs it its own process now.<br />Not very elegant, but it works.<br /></div><br /><br />I tested the same thing, with the ifcserver and also with your simpleserver.dll<br />(after adding the DllSurrogate entry to registry). <br /><br />But there is still only one instance of dllhost.exe, after modifying the AppID.<br /><br />Also, i added in my program code to change the AppID for every ifcserver instance. <br />But again, only one instance of dllhost.exe and the multiple .ifc file handling works <br />no better than when using inproc server.<br /><br /><pre><code><br />mov NullByte,0<br />mov APPID_EXISTED,FALSE;the default is, no AppID under CLSID<br />mov RegBuffSize,256<br />mov AppIDSize,40<br />invoke CLSIDFromProgID, CStrW&#40;L&#40;BSPro.IfcServer&#41;&#41;, addr clsidApp<br />invoke StringFromCLSID,addr clsidApp,addr pCLSIDstrw<br />invoke WideCharToMultiByte,CP_ACP, 0 ,pCLSIDstrw,\<br />-1, addr RegBuffer, MAX_PATH, NULL, NULL<br />invoke lstrcpy,addr MsgBuff,CStr&#40;&quot;CLSID\&quot;&#41;<br />invoke lstrcat,addr MsgBuff,addr RegBuffer<br />invoke RegOpenKeyEx,HKEY_CLASSES_ROOT,addr MsgBuff,0,KEY_ALL_ACCESS,\<br />addr hkBspro<br /><br />;get the value of appid &#40;GUID&#41; and save it<br />;if appid is not found it needs to be created so that surrogate will execute<br />;in both situations, restore registry as it was, after the ifcservers are created<br /><br />invoke RegQueryValueEx,hkBspro,CStr&#40;&quot;AppID&quot;&#41;,NULL,addr AppIDType,addr OrigAppID,<br />addr AppIDSize	<br />.IF eax==ERROR_SUCCESS<br />	mov APPID_EXISTED,TRUE<br />.endif	<br />invoke RegCloseKey,hkBspro<br />		<br /><br />;fill the ifc OPENFILENAME struct<br />mov IFCofn.lStructSize,SIZEOF IFCofn<br />push hwndMain<br />pop  IFCofn.hWndOwner<br />push hInstance<br />pop  IFCofn.hInstance<br />mov  IFCofn.lpstrFilter, OFFSET IFCFilterString<br />mov  IFCofn.lpstrFile, OFFSET IFCbuffer<br />mov  IFCofn.nMaxFile,&#40;MAXSIZE*MAXIFCCOUNT&#41;;100 ifc files per building must be enough	<br />mov IFCofn.lpstrTitle,CStr &#40;&quot;Open IFC file&#40;s&#41;&quot;&#41; <br />mov  IFCofn.Flags, OFN_FILEMUSTEXIST or \     <br />OFN_PATHMUSTEXIST or OFN_LONGNAMES or\<br />OFN_EXPLORER or OFN_HIDEREADONLY or OFN_ALLOWMULTISELECT<br />invoke GetOpenFileName, ADDR IFCofn<br /><br />invoke HowManyFileNames,addr IFCbuffer<br />mov IFCFileCount,eax<br />mov eax,4<br />mul IFCFileCount<br /><br />;allocate space for array of pIfcservers<br />invoke HeapAlloc,hHeap,HEAP_ZERO_MEMORY,eax<br />mov pIfcServers,eax<br />mov eax,4<br />mul IFCFileCount<br /><br />xor edi,edi<br />xor esi,esi<br /><br />.while esi&lt;IFCFileCount<br />        ;create new AppID string     <br />        invoke CoCreateGuid,addr pTempGUID <br />	invoke StringFromCLSID,addr pTempGUID,addr pCLSIDstrw<br />	invoke WideCharToMultiByte,CP_ACP, 0 ,pCLSIDstrw,\<br />	-1, addr RegBuffer, MAX_PATH, NULL, NULL<br />	invoke lstrcpy,addr AppIDBuff,CStr&#40;&quot;AppID\&quot;&#41;<br />	invoke lstrcat,addr AppIDBuff,addr RegBuffer<br />			<br />;	set the value just created to \CLSID\AppID<br />        invoke RegOpenKeyEx,HKEY_CLASSES_ROOT,addr MsgBuff,0,KEY_ALL_ACCESS,\<br />	addr hkBspro<br />	invoke RegSetValueEx,hkBspro,CStr&#40;&quot;AppID&quot;&#41;,NULL,AppIDType,addr RegBuffer,AppIDSize<br />	invoke RegFlushKey,hkBspro<br />	invoke RegCloseKey,hkBspro<br />			<br />			<br />;	create new key in HKEY_CLASSES_ROOT\AppID 					<br />        invoke RegCreateKeyEx,HKEY_CLASSES_ROOT,addr AppIDBuff,NULL,NULL,\<br />	REG_OPTION_NON_VOLATILE,KEY_ALL_ACCESS,NULL,addr hkAppID,NULL<br /><br />;	create &quot;DllSurrogate&quot; named value under just created AppID			<br /> 	invoke RegSetValueEx,hkAppID,CStr&#40;&quot;DllSurrogate&quot;&#41;,NULL,REG_SZ,addr NullByte,1<br />	invoke RegFlushKey,hkAppID<br />	invoke RegCloseKey,hkAppID<br />			<br />	inc edi<br />	invoke MakeSingleFileStr,addr IFCbuffer,edi,addr IFCSinglebuffer<br /><br />	<br />	mov ebx,pIfcServers<br />	lea ebx, &#91;ebx + esi*4&#93;<br /><br />	invoke CoCreateInstance, ADDR clsidApp, NULL, CLSCTX_LOCAL_SERVER,\; CLSCTX_ALL,\<br />	addr IID_IIfcServer, ebx<br /><br />	invoke MultiByteToWideChar,CP_ACP,MB_PRECOMPOSED,addr IFCSinglebuffer,-1,<br />                addr IFCWbuffer,SIZEOF IFCWbuffer	<br /><br />	invoke SysAllocString, addr IFCWbuffer<br />	mov bstrString,eax<br />	mov edx,pIfcServers			<br />	invoke dm&#40;&#91;edx+esi*4&#93;,IIfcServer,ReadIfcFile&#41;,bstrString, addr retval	<br />			<br />;	delete the created AppID key			<br />	invoke RegDeleteKey,HKEY_CLASSES_ROOT,addr AppIDBuff<br />	invoke SysFreeString,bstrString<br />	inc esi<br />.endw<br />		<br />.if APPID_EXISTED;if AppId already existed, restore it<br />	invoke RegOpenKeyEx,HKEY_CLASSES_ROOT,addr MsgBuff,0,KEY_ALL_ACCESS,\<br />	addr hkBspro<br />	invoke RegSetValueEx,hkBspro,CStr&#40;&quot;AppID&quot;&#41;,NULL,AppIDType,addr OrigAppID,AppIDSize<br />	invoke RegCloseKey,hkBspro<br />.else<br />;	if appid did not exist already, remove the appid value under clsid	 <br />	invoke RegOpenKeyEx,HKEY_CLASSES_ROOT,addr MsgBuff,0,KEY_ALL_ACCESS,\<br />	addr hkBspro<br />	invoke RegDeleteValue,hkBspro,CStr&#40;&quot;AppID&quot;&#41;<br />	invoke RegCloseKey,hkBspro<br />.endif<br />		<br />invoke CoTaskMemFree,pCLSIDstrw<br /><br /></code></pre></div>
    <div class="meta">Posted on 2003-09-27 13:56:12 by Janne</div>
   </div>
   <div class="post" id="post-119778">
    <div class="subject"><a href="#post-119778">Problems using COM methods</a></div>
    <div class="body">Janne,<br /><br />I tested the multiple instance problem on a XP system. After you mentioned your OS I checked if surrogates work at all with win98, but missed to scrutinize  the instance problem on that system. Sorry.<br /><br />Japheth</div>
    <div class="meta">Posted on 2003-09-28 01:14:54 by japheth</div>
   </div>
   <div class="post" id="post-120193">
    <div class="subject"><a href="#post-120193">Problems using COM methods</a></div>
    <div class="body">Seems that under Win2000, the multiple instances of dllhost.exe (and the server dll) work as i wished. Had to fix one bug in the above code though, changed<br /><br /><pre><code><br />invoke RegSetValueEx,hkBspro,CStr&#40;&quot;AppID&quot;&#41;,NULL,AppIDType,addr RegBuffer,AppIDSize<br /></code></pre><br /><br />to<br /><br /><pre><code><br />invoke RegSetValueEx,hkBspro,CStr&#40;&quot;AppID&quot;&#41;,NULL,REG_SZ,addr RegBuffer,AppIDSize<br /></code></pre></div>
    <div class="meta">Posted on 2003-10-01 05:46:26 by Janne</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=13942&amp;page=1" style="">&laquo;</a><a href="../?id=13942&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="13942" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>  </div>
 </body>
</html>