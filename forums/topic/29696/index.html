<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Small challenge - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=29696" />
    <link rel="next" href="../?id=29696&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=29696">Small challenge</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=29696&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=29696&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="29696" /><input type="number" name="page" min="1" max="4" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=29696&amp;page=2">&gt;</a><a href="../?id=29696&amp;page=4">&raquo;</a></form>   <div class="post" id="post-209658">
    <div class="subject"><a href="#post-209658">Small challenge</a></div>
    <div class="body">You are given a 32 bit value where the Most Significant Bit in each byte (Bit 7) must be ignored, thus encoding a 28 bit value. Write an optimal function to decode the value (strip the ignored bits).<br /><br /><br /><br /></div>
    <div class="meta">Posted on 2009-11-20 19:19:19 by Homer</div>
   </div>
   <div class="post" id="post-209660">
    <div class="subject"><a href="#post-209660">Re: Small challenge</a></div>
    <div class="body">Well, I guess I can start this off with the obvious approach (assuming the value to convert is in eax):<br />I wouldn&#039;t say it&#039;s optimized though.<br /><pre><code>	movzx edx,ax<br />	shr eax,15<br />	shl dx,1<br />	shr ah,1<br />	shr dh,1<br />	shr ax,1<br />	shr dx,1<br />	cwde<br />	shl eax,14<br />	add eax,edx</code></pre></div>
    <div class="meta">Posted on 2009-11-21 08:47:01 by sysfce2</div>
   </div>
   <div class="post" id="post-209661">
    <div class="subject"><a href="#post-209661">Re: Small challenge</a></div>
    <div class="body">First attempt:<br /><pre><code><br />main proc<br />	local time1,time2<br />	local var1<br />	<br />	<br />	<br />	mov var1,455445454<br />	<br />	<br />	<br />	START_TEST time1<br />	mov eax,var1<br />	movzx edx,ax<br />	shr eax,15<br />	shl dx,1<br />	shr ah,1<br />	shr dh,1<br />	shr ax,1<br />	shr dx,1<br />	cwde<br />	shl eax,14<br />	add eax,edx<br />	END_TEST<br />	<br />	<br />	START_TEST time2<br />	mov eax,var1<br />	mov edx,eax<br />	mov esi,eax<br />	mov edi,eax<br />	and eax,7fh<br />	and edx,7f00h<br />	and esi,7f0000h<br />	and edi,7f000000h<br />	shr edx,1<br />	shr esi,2<br />	shr edi,3<br />	or eax,edx<br />	or esi,edi<br />	or eax,esi<br />	<br />	<br />	END_TEST<br />	<br />	<br />	<br />	<br />	<br />	PrintLine<br />	<br />	ret<br />main endp<br /></code></pre><br /><br />Bench output (in cycles) : <br /><br />time1 = 12.67311<br />time2 = 5.459498<br />----------------------------------------</div>
    <div class="meta">Posted on 2009-11-21 10:05:23 by Ultrano</div>
   </div>
   <div class="post" id="post-209662">
    <div class="subject"><a href="#post-209662">Re: Small challenge</a></div>
    <div class="body">Ultrano&#039;s method using MMX:<br /><pre><code><br />align 4<br />param2 &nbsp;dq &nbsp;1b258bce1b258bceh ;+0 &nbsp;&lt;-- decimal: 455445454; 455445454;<br />mask1 &nbsp; dq &nbsp;0000007f0000007fh ;+8<br />mask2 &nbsp; dq &nbsp;00007f0000007f00h ;+16<br />mask3 &nbsp; dq &nbsp;007f0000007f0000h ;+24<br />mask4 &nbsp; dq &nbsp;7f0000007f000000h ;+32<br /><br /><br />align 4<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov &nbsp; &nbsp; eax, offset param2<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movq &nbsp; &nbsp;mm0, <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movq &nbsp; &nbsp;mm1, mm0<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movq &nbsp; &nbsp;mm2, mm0<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movq &nbsp; &nbsp;mm3, mm0<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pand &nbsp; &nbsp;mm0, <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pand &nbsp; &nbsp;mm1, <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pand &nbsp; &nbsp;mm2, <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pand &nbsp; &nbsp;mm3, <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;psrld &nbsp; mm1, 1<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;psrld &nbsp; mm2, 2<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;por &nbsp; &nbsp; mm0, mm1<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;psrld &nbsp; mm3, 3<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;por &nbsp; &nbsp; mm0, mm2<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;por &nbsp; &nbsp; mm0, mm3</code></pre><br /><br />Takes about 10% more time to execute (on Core 2 Duo E6750), but processes 2 numbers simultaneously in 1 iteration (can be easily extended to process 4 numbers). Result in mm0.</div>
    <div class="meta">Posted on 2009-11-21 10:44:10 by ti_mo_n</div>
   </div>
   <div class="post" id="post-209663">
    <div class="subject"><a href="#post-209663">Re: Small challenge</a></div>
    <div class="body">Maybe something like this:<br /><pre><code>mov eax, num<br />mov edx, eax<br />and edx, 0x7FFFFF<br />add eax, edx<br />mov edx, eax<br />and edx, (0x7FFF SHL 1)<br />add eax, edx<br />mov edx, eax<br />and edx, (0x7F SHL 2)<br />add eax, edx<br />shr eax, 3</code></pre><br /><br />I suppose it might be possible to make it more efficient by using more registers, and preparing some of the sums in parallel. I&#039;ll leave that for someone else, I just wanted to present this algorithm.<br /><br />Edit: Just realized that I assume that the MSB is 0 in the highest byte. If not, add an extra and at the bottom :) Or rather, an and 7F7F7F7F at the top, even better.<br /><br />Edit: Okay, I lied... I couldn&#039;t leave it for someone else, too much fun... here&#039;s one with more efficient use of registers:<br /><pre><code>mov eax, num<br />mov edx, num<br /><br />and eax, 0x7F7F7F7F<br />and edx, 0x7F7F7F<br /><br />add eax, edx<br />add edx, edx<br /><br />and edx, (0x7F7F SHL 1)<br /><br />add eax, edx<br />add edx, edx<br /><br />and edx, (0x7F SHL 2)<br /><br />add eax, edx<br /><br />shr eax, 3</code></pre><br /><br />Or what about this freaky one:<br /><pre><code>mov eax, num<br />mov ecx, num<br />mov edx, num<br />mov ebx, num<br /><br />and eax, 0x7F7F7F7F<br />and edx, 0x7F7F7F<br />and ecx, 0x7F7F<br />and ebx, 0x7F<br /><br />add eax, edx<br />add ecx, ecx<br />add ebx, ebx<br /><br />add eax, ecx<br />add ebx, ebx<br /><br />add eax, ebx<br /><br />shr eax, 3</code></pre></div>
    <div class="meta">Posted on 2009-11-21 12:54:44 by Scali</div>
   </div>
   <div class="post" id="post-209664">
    <div class="subject"><a href="#post-209664">Re: Small challenge</a></div>
    <div class="body">Timing results are as follows:<br />Scali1: ~14% slower than Ultrano&#039;s (and incorrect result due to assumption that the MSB = 0)<br />Scali2: about 0.1% faster than Scali1, correct result<br />Scali3: about 5% faster than Scali2 (9% slower than Ultrano&#039;s), correct result<br /><br /><br />BTW, what are the prizes? ^^</div>
    <div class="meta">Posted on 2009-11-21 15:46:47 by ti_mo_n</div>
   </div>
   <div class="post" id="post-209665">
    <div class="subject"><a href="#post-209665">Re: Small challenge</a></div>
    <div class="body"><div class="quote"><br />Timing results are as follows:<br />Scali1: ~14% slower than Ultrano&#039;s (and incorrect result due to assumption that the MSB = 0)<br />Scali2: about 0.1% faster than Scali1, correct result<br />Scali3: about 5% faster than Scali2 (9% slower than Ultrano&#039;s), correct result<br /><br /><br />BTW, what are the prizes? ^^<br /></div><br /><br />If you want to compare speed, I think the architecture is important aswell.<br />If I were to hazard a guess, I&#039;d say Ultrano&#039;s code mostly runs well on CPUs with fast shifting and 3 or 4 ALUs (eg K7, K8, K10, Core2/Nehalem), while my code probably works better on CPUs with shift bottlenecks and less superscalar abilities (eg Pentium, P6, P4). I could have told you beforehand that Ultrano&#039;s code would be faster on Core2.<br /><br />Homer never specified what &#039;optimal&#039; meant... Are we talking speed, number of instructions, number of bytes...? And what target architecture?</div>
    <div class="meta">Posted on 2009-11-21 16:38:45 by Scali</div>
   </div>
   <div class="post" id="post-209666">
    <div class="subject"><a href="#post-209666">Re: Small challenge</a></div>
    <div class="body">Easy, I was just comparing speeds on my machine ^^ No offense intended. Every attempt is a good one - not only lets you pick the one that best suts your needs, but also it&#039;s fun to actually take the &quot;challenge&quot;. And, actually, if you have time then please time all posted functions. It will let everyone interested see how they perform on different machines.</div>
    <div class="meta">Posted on 2009-11-21 16:57:17 by ti_mo_n</div>
   </div>
   <div class="post" id="post-209667">
    <div class="subject"><a href="#post-209667">Re: Small challenge</a></div>
    <div class="body">If someone provides a nice testing framework (f0dder?), we could all perform the same tests on our machines, with universal results.<br />I have a Pentium 4 myself, and an Athlon XP.<br />I&#039;d like to test my theory of my code being reasonably favourable to Pentium 4.</div>
    <div class="meta">Posted on 2009-11-21 17:24:10 by Scali</div>
   </div>
   <div class="post" id="post-209668">
    <div class="subject"><a href="#post-209668">Re: Small challenge</a></div>
    <div class="body"><br />Some interesting solutions&nbsp; :thumbsup:<br />By optimal, I meant fastest execution (not necessarily shortest code).<br /><br />Just to mention that this algorithm is used a lot in compressed audio streams to mark framesizes.<br />They tend to use &#039;255&#039; to denote a SYNC marker, and this encoding ensures that all bytes of the FrameSize tag are less than &#039;128&#039; (80h) which means that an application can handle a &#039;broken/damaged&#039; mpeg file by scanning for the next available SYNC marker (&#039;resynchronize&#039;) with less chance of finding false positives.<br /><br /><br /></div>
    <div class="meta">Posted on 2009-11-21 19:57:41 by Homer</div>
   </div>
   <div class="post" id="post-209671">
    <div class="subject"><a href="#post-209671">Re: Small challenge</a></div>
    <div class="body">While my code takes &nbsp;5.5 cycles, on the same PC Scali&#039;s 3rd version takes 4.7 cycles. I really like the idea of mask-adding to shift left in groups :D. <br />c2d E8500 @3.8GHz. </div>
    <div class="meta">Posted on 2009-11-21 23:44:48 by Ultrano</div>
   </div>
   <div class="post" id="post-209672">
    <div class="subject"><a href="#post-209672">Re: Small challenge</a></div>
    <div class="body">These are my benching macros:<br /><pre><code><br />;=====[[ Benchmarking macros START_TEST/END_TEST &gt;&gt;===\<br />;--[ configuration ]---[<br />TEST_ITERS equ 10000000<br />TEST_SUBCYCLE = 1 ; 0 or 1, whether to show FP result<br />;----------------------/<br /><br />TEST_ID = 0 ; internal thingie<br />START_TEST macro where:REQ<br />	local where2<br />	@START_TEST_VAR textequ &lt;where&gt;<br />	mov where,-1<br />	<br />	<br />	invoke GetModuleHandle,0<br />	invoke SetPriorityClass,eax,HIGH_PRIORITY_CLASS<br />	invoke GetCurrentThread<br />	invoke SetThreadAffinityMask,eax,1<br />	<br />	invoke SwitchToThread<br />	<br />	TEST_ID = TEST_ID + 1<br />	rdtsc<br />	push eax<br />	push edx<br />	mov ecx,TEST_ITERS<br />	align 16<br />	@CatStr(&lt;testlabl&gt;,%TEST_ID,&lt;:&gt;)<br />endm<br />END_TEST macro<br />	dec ecx<br />	jnz @CatStr(&lt;testlabl&gt;,%TEST_ID)<br />	nop<br />	nop<br />	nop<br />	nop<br />	<br />	rdtsc<br />	sub eax,<br />	sbb edx,<br /> &nbsp;if TEST_SUBCYCLE EQ 0<br />	add esp,8<br />	mov ecx,TEST_ITERS<br />	div ecx<br />	.if eax&lt;@START_TEST_VAR<br />		mov @START_TEST_VAR,eax<br />	.endif<br />	<br />	invoke GetModuleHandle,0<br />	invoke SetPriorityClass,eax,NORMAL_PRIORITY_CLASS<br />	<br />	%@CatStr(&lt;print &gt;,@START_TEST_VAR)<br /> else<br />	mov ,edx<br />	mov ,eax<br />	fild qword ptr<br />	mov dword ptr,TEST_ITERS<br />	fidiv dword ptr<br />	fstp @START_TEST_VAR<br />	add esp,8<br />	<br />	invoke GetModuleHandle,0<br />	invoke SetPriorityClass,eax,NORMAL_PRIORITY_CLASS<br />	<br />	%@CatStr(&lt;PrintFloat &gt;,@START_TEST_VAR)<br />endif<br />endm<br /><br />;=======/<br /></code></pre><br /><br />Of course, testing code with lots of cache-misses this way will lead to possibly bad decisions on which version to take. There I plug-in other RDTSC-based macros/calls around code in a complete big app, and measure min/max/avg/avg2/last/count . </div>
    <div class="meta">Posted on 2009-11-21 23:48:21 by Ultrano</div>
   </div>
   <div class="post" id="post-209673">
    <div class="subject"><a href="#post-209673">Re: Small challenge</a></div>
    <div class="body">Thanks for all the replies - when I have to invent problems to solve, the world is in a good state !!<br />I&#039;ll try to make some effort to post more of these simple problems, and I hope to next time hear from some more beginners as well :) (not that I mind the regulars showing everyone how its done, but its much more rewarding for me to know that someone pushed their envelope a little bit, or that someone gained something from the exercise).<br /><br /><br /><br /></div>
    <div class="meta">Posted on 2009-11-22 00:11:38 by Homer</div>
   </div>
   <div class="post" id="post-209674">
    <div class="subject"><a href="#post-209674">Re: Small challenge</a></div>
    <div class="body">A bit fixup and completion. In my previous post I meant Scali&#039;s 2nd version not 3rd. Too many post-edits there :) . <br />I added &quot;add var2,eax&quot; to verify calculations don&#039;t get skipped and skewed by the out-of-order exec. <br /><pre><code><br />main proc<br />	local time1,time2,time3,time4,time5<br />	local num,var2<br />	local tmp<br />	<br />	mov num,455445454<br />	<br />	START_TEST time1<br />	mov eax,num<br />	mov var2,eax<br />	END_TEST<br />	<br />	<br />	<br />	START_TEST time1<br />	mov eax,num<br />	movzx edx,ax<br />	shr eax,15<br />	shl dx,1<br />	shr ah,1<br />	shr dh,1<br />	shr ax,1<br />	shr dx,1<br />	cwde<br />	shl eax,14<br />	add eax,edx<br />	add var2,eax<br />	END_TEST<br />	<br />	<br />	<br />	START_TEST time2<br />	mov eax,num<br />	mov edx,eax<br />	mov esi,eax<br />	mov edi,eax<br />	and eax,7fh<br />	and edx,7f00h<br />	and esi,7f0000h<br />	and edi,7f000000h<br />	shr edx,1<br />	shr esi,2<br />	shr edi,3<br />	or eax,edx<br />	or esi,edi<br />	or eax,esi<br />	<br />	add var2,eax<br />	<br />	END_TEST<br />	<br />	<br />	START_TEST time3<br />	mov eax, num<br />	mov edx, eax<br />	and edx, 7FFFFFh<br />	add eax, edx<br />	mov edx, eax	<br />	and edx, (7FFFh SHL 1)<br />	add eax, edx<br />	mov edx, eax<br />	and edx, (7Fh SHL 2)<br />	add eax, edx<br />	shr eax, 3<br />	add var2,eax<br />	END_TEST<br />	<br />	<br />	START_TEST time4<br />	mov eax, num<br />	mov edx, num<br />	<br />	and eax, 7F7F7F7Fh<br />	and edx, 7F7F7Fh<br />	<br />	add eax, edx<br />	add edx, edx<br />	<br />	and edx, (7F7Fh SHL 1)<br />	<br />	add eax, edx<br />	add edx, edx<br />	<br />	and edx, (7Fh SHL 2)<br />	<br />	add eax, edx<br />	<br />	shr eax, 3<br />	add var2,eax<br />	END_TEST<br />	<br />	<br />	<br />	START_TEST time5<br />	mov eax, num<br />	mov esi, num<br />	mov edx, num<br />	mov ebx, num<br /><br />	and eax, 7F7F7F7Fh<br />	and edx, 7F7F7Fh<br />	and esi, 7F7Fh<br />	and ebx, 7Fh<br /><br />	add eax, edx<br />	add esi, esi<br />	add ebx, ebx<br /><br />	add eax, esi<br />	add ebx, ebx<br /><br />	add eax, ebx<br /><br />	shr eax, 3<br />	add var2,eax<br />	<br />	END_TEST<br />	<br />		<br />	<br />	<br />	<br />	PrintLine<br />	<br />	ret<br />main endp<br /></code></pre><br /><br />c2d E8500 @3.8GHz, DDR3@1.6GHz (clk7) : <br /><br />time1 = 2.861777 ; &lt;null,warmup&gt;<br />time1 = 13.15349 ; sysfce2<br />time2 = 6.553432 ; ultrano<br />time3 = 6.410781 ; scali1<br />time4 = 6.218256 ; scali2<br />time5 = 7.705081 ; scali3<br />----------------------------------------<br /><br /></div>
    <div class="meta">Posted on 2009-11-22 01:03:03 by Ultrano</div>
   </div>
   <div class="post" id="post-209675">
    <div class="subject"><a href="#post-209675">Re: Small challenge</a></div>
    <div class="body"><div class="quote"><br />By optimal, I meant fastest execution (not necessarily shortest code).</div><br /><br />But on which architecture?</div>
    <div class="meta">Posted on 2009-11-22 03:35:09 by Scali</div>
   </div>
   <div class="post" id="post-209676">
    <div class="subject"><a href="#post-209676">Re: Small challenge</a></div>
    <div class="body"><div class="quote"><br />These are my benching macros:</div><br /><br />I tried to build a test app from your macros, but it seems I&#039;m missing the PrintLine and PrintFloat stuff?</div>
    <div class="meta">Posted on 2009-11-22 03:48:40 by Scali</div>
   </div>
   <div class="post" id="post-209678">
    <div class="subject"><a href="#post-209678">Re: Small challenge</a></div>
    <div class="body">It&#039;s modified VKDebug stuff. I use MASM, and some libs that come with the masm32 package. The two macros are:<br /><pre><code><br />PrintFloat macro Var:REQ<br />	local szDN,float1<br />	.data<br />	szDN byte 24 dup(0)<br />	float1 real8 ?<br />	.code<br />	pushfd<br />	pushad<br />	push Var<br />	fld real4 ptr<br />	pop eax<br />	fstp float1<br />	invoke FloatToStr,float1,addr szDN ; &lt;------ need to implement this<br />	invoke strlen,addr szDN<br />	add eax,@SizeStr(&amp;Input)+4<br />	invoke GlobalAlloc, GMEM_FIXED+GMEM_ZEROINIT, eax ; yuck<br />	mov ebx,eax<br />	FillMem ebx,&amp;Var<br />	mov dword ptr , 203D20h<br />	invoke lstrcat,eax,addr szDN<br />	invoke DebugPrint,ebx<br />	invoke GlobalFree,ebx<br />	popad	<br />	popfd<br />endm<br /><br />PrintLine macro<br />prints &quot;--------------&quot;<br />endm	<br /></code></pre></div>
    <div class="meta">Posted on 2009-11-22 06:06:47 by Ultrano</div>
   </div>
   <div class="post" id="post-209679">
    <div class="subject"><a href="#post-209679">Re: Small challenge</a></div>
    <div class="body">With f0dder&#039;s old &#039;yodel&#039; framework slightly reworked to suit this test, I got this from a P4:<br />test01-Scali1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...000547 ticks (effective 20.775 clk/iteration)<br />test02-Scali2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...000515 ticks (effective 19.560 clk/iteration)<br />test03-Scali3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...000625 ticks (effective 23.737 clk/iteration)<br />test04-sysfce2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...000578 ticks (effective 21.952 clk/iteration)<br />test05-Ultrano&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...000610 ticks (effective 23.168 clk/iteration)<br /><br />And this from a Core2 Duo:<br />test01-Scali1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...000375 ticks (effective 11.250 clk/iteration)<br />test02-Scali2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...000344 ticks (effective 10.320 clk/iteration)<br />test03-Scali3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...000406 ticks (effective 12.180 clk/iteration)<br />test04-sysfce2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...000608 ticks (effective 18.240 clk/iteration)<br />test05-Ultrano&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...000452 ticks (effective 13.560 clk/iteration)<br /><br />It&#039;s not entirely fair towards my third routine and Ultrano&#039;s routine, since they both use non-volatile registers, which have to be pushed and popped.</div>
    <div class="meta">Posted on 2009-11-22 09:32:46 by Scali</div>
   </div>
   <div class="post" id="post-209681">
    <div class="subject"><a href="#post-209681">Re: Small challenge</a></div>
    <div class="body">I&#039;ve added the following two C versions, compiled with VS2008 with /Ox flag:<br /><br /><pre><code>extern &quot;C&quot; unsigned int __stdcall time6(unsigned int num)<br />{<br />	return (num &amp; 0x7F) | ((num &amp; 0x7F00) &gt;&gt; 1) | ((num &amp; 0x7F0000) &gt;&gt; 2) | ((num &amp; 0x7F000000) &gt;&gt; 3);<br />}</code></pre><br /><pre><code>extern &quot;C&quot; unsigned int __stdcall time7(unsigned int num)<br />{<br />	unsigned int result = num &amp; 0x7F7F7F7F;<br />	unsigned int tmp&nbsp; &nbsp; = num &amp; 0x7F7F7F;<br />	<br />	result += tmp;<br />	tmp += tmp;<br />	tmp &amp;= (0x7F7F &lt;&lt; 1);<br />	result += tmp;<br />	tmp += tmp;<br />	tmp &amp;= (0x7F &lt;&lt; 2);<br />	result += tmp;<br />	<br />	return result &gt;&gt; 3;<br />}</code></pre><br /><br />test01-Scali1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...000374 ticks (effective 11.220 clk/iteration)<br />test02-Scali2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...000359 ticks (effective 10.770 clk/iteration)<br />test03-Scali3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...000421 ticks (effective 12.630 clk/iteration)<br />test04-sysfce2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...000624 ticks (effective 18.720 clk/iteration)<br />test05-Ultrano&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...000468 ticks (effective 14.040 clk/iteration)<br />test06-ANSI C 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...000312 ticks (effective 9.360 clk/iteration)<br />test07-ANSI C 2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...000343 ticks (effective 10.290 clk/iteration)<br /><br />First version appears to be this:<br /><pre><code>_text:00000000&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  mov&nbsp; &nbsp;  ecx, <br />_text:00000004&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  mov&nbsp; &nbsp;  eax, ecx<br />_text:00000006&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  shr&nbsp; &nbsp;  eax, 1<br />_text:00000008&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  and&nbsp; &nbsp;  eax, 3F800000h<br />_text:0000000D&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  mov&nbsp; &nbsp;  edx, ecx<br />_text:0000000F&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  and&nbsp; &nbsp;  edx, 7F0000h<br />_text:00000015&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  or&nbsp; &nbsp; &nbsp; eax, edx<br />_text:00000017&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  mov&nbsp; &nbsp;  edx, ecx<br />_text:00000019&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  shr&nbsp; &nbsp;  eax, 1<br />_text:0000001B&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  and&nbsp; &nbsp;  edx, 7F00h<br />_text:00000021&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  or&nbsp; &nbsp; &nbsp; eax, edx<br />_text:00000023&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  shr&nbsp; &nbsp;  eax, 1<br />_text:00000025&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  and&nbsp; &nbsp;  ecx, 7Fh<br />_text:00000028&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  or&nbsp; &nbsp; &nbsp; eax, ecx</code></pre><br /><br />Second one is this:<br /><pre><code>_text:00000000&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  mov&nbsp; &nbsp;  eax, <br />_text:00000004&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  mov&nbsp; &nbsp;  ecx, eax<br />_text:00000006&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  and&nbsp; &nbsp;  eax, 7F7F7F7Fh<br />_text:0000000B&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  and&nbsp; &nbsp;  ecx, 7F7F7Fh<br />_text:00000011&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  add&nbsp; &nbsp;  eax, ecx<br />_text:00000013&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  mov&nbsp; &nbsp;  edx, eax<br />_text:00000015&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  lea&nbsp; &nbsp;  eax, <br />_text:00000018&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  and&nbsp; &nbsp;  eax, 0FEFEh<br />_text:0000001D&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  add&nbsp; &nbsp;  edx, eax<br />_text:0000001F&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  add&nbsp; &nbsp;  eax, eax<br />_text:00000021&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  and&nbsp; &nbsp;  eax, 1FCh<br />_text:00000026&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  add&nbsp; &nbsp;  eax, edx<br />_text:00000028&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  shr&nbsp; &nbsp;  eax, 3</code></pre></div>
    <div class="meta">Posted on 2009-11-22 14:39:53 by Scali</div>
   </div>
   <div class="post" id="post-209682">
    <div class="subject"><a href="#post-209682">Re: Small challenge</a></div>
    <div class="body">Looking at that code reminded me that I forgot to disable MASM&#039;s prologue/epilogue code, so I got some gratuitous esp/ebp stuff.<br />Removed that, the results now sorta look like this on Core2 Duo:<br />test01-Scali1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...000343 ticks (effective 10.290 clk/iteration)<br />test02-Scali2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...000297 ticks (effective 8.910 clk/iteration)<br />test03-Scali3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...000374 ticks (effective 11.220 clk/iteration)<br />test04-sysfce2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...000562 ticks (effective 16.860 clk/iteration)<br />test05-Ultrano&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...000374 ticks (effective 11.220 clk/iteration)<br />test06-ANSI C 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...000312 ticks (effective 9.360 clk/iteration)<br />test07-ANSI C 2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...000343 ticks (effective 10.290 clk/iteration)<br /><br />And like this on Pentium 4:<br />test01-Scali1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...000453 ticks (effective 17.205 clk/iteration)<br />test02-Scali2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...000438 ticks (effective 16.635 clk/iteration)<br />test03-Scali3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...000500 ticks (effective 18.990 clk/iteration)<br />test04-sysfce2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...000422 ticks (effective 16.028 clk/iteration)<br />test05-Ultrano&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...000515 ticks (effective 19.560 clk/iteration)<br />test06-ANSI C 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...000438 ticks (effective 16.635 clk/iteration)<br />test07-ANSI C 2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...000437 ticks (effective 16.597 clk/iteration)<br /><br />I suppose sysfce2&#039;s code clearly demonstrates why architecture matters. His code is the fastest on Pentium 4, but the slowest on Core2 Duo.<br />I wonder what causes that exactly... perhaps cwde is slow on Core2... or it could be the partial registers that P4 handles better (partial register stalls have been a problem ever since the first Pentium Pro).<br />I seem to have misjudged Ultrano&#039;s code a bit. I would have expected it to be faster on Core2 Duo, but it seems like his code has the same problem as my third version: You can try to take advantage of 3 or 4 ALUs in parallel, but you are limited by the decoder, so it doesn&#039;t really work unless the reorder buffer is already full... that won&#039;t happen here because we don&#039;t have any weird branches or memory accesses.<br />So despite my efforts of trying to take advantage of the 4 ALUs in the Core2 Duo in my 3rd variation, the 2nd variation remains the fastest for Core2 Duo.<br />At least I was right about my algorithm favouring the Pentium 4 though. Pentium 4 has trouble handling shifts, that is probably what makes Ultrano&#039;s version slower on the P4. My code performs more &#039;consistently&#039; between Core2 Duo and Pentium 4.</div>
    <div class="meta">Posted on 2009-11-22 14:52:38 by Scali</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=29696&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=29696&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="29696" /><input type="number" name="page" min="1" max="4" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=29696&amp;page=2">&gt;</a><a href="../?id=29696&amp;page=4">&raquo;</a></form>  </div>
 </body>
</html>