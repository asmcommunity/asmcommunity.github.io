<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Internet download - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=18712" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=18712">Internet download</a></p>
   <div class="post" id="post-144944">
    <div class="subject"><a href="#post-144944">Internet download</a></div>
    <div class="body">Hello,<br /><br />I would like to download a file from the internet. As the file is really great, I want to have a progressbar showing the status. For that, I have to know the size of the file.<br /><br />That is my plan. But actually, my computer crashes if I use the HttpQueryInfo-API.<br />I know this is a really great question, but maybe someone here has used that API before.<br /><br /><pre><code><br />.data<br />	szUrl		DB		&quot;www.cvdb.de&quot;, 0<br />	szA			DB		&quot;blablabla&quot;, 0<br />	szHead		DB		&quot;HEAD&quot;, 0<br />	szHttp		DB		&quot;HTTP/1.1&quot;, 0<br />	szInfoSite	DB		&quot;/avb/avbm/info.dat&quot;, 0<br />	szBuffer	DB		128 DUP&#40;&quot; &quot;&#41;, 0<br />	szUserAgent	DB		&quot;Download&quot;, 0<br />	szQueryInfo	DB		1025 DUP&#40;0&#41;<br />	szHttpOK	DB		&quot;200&quot;, 0<br />	szContent	DB		&quot;Content-Length&#58;&quot;, 0<br /><br />.data?<br />	hOpen		DD		?<br />	hInternet	DD		?<br />	hHttpOpen	DD		?<br />	hReturn		DD		?<br /><br />.code<br /><br />; .....<br /><br />GetFilesThread	PROC<br />		<br />		invoke	InternetOpen,<br />				ADDR szUserAgent, <br />				INTERNET_OPEN_TYPE_PRECONFIG, <br />				NULL, <br />				NULL, <br />				0<br />		<br />		mov		hOpen, eax<br />		<br />		invoke	InternetConnect,<br />				hOpen, <br />				ADDR szUrl, <br />				INTERNET_DEFAULT_HTTP_PORT,<br />				NULL,<br />				NULL, <br />                INTERNET_SERVICE_HTTP, <br />                0, <br />                0<br />        <br />        mov		hInternet, eax<br />        <br />		cmp		hInternet, 0		<br />		je		ConnectionFailed<br />        <br />        invoke	HttpOpenRequestA, <br />				hInternet,<br />				ADDR szHead,<br />				ADDR szInfoSite,<br />				ADDR szHttp,<br />				NULL,<br />				0,<br />				INTERNET_FLAG_RELOAD, <br />				0<br />        <br />		mov		hHttpOpen, eax<br />		<br />		cmp		hHttpOpen, 0		<br />		je		ConnectionFailed<br />				<br />		invoke	HttpSendRequestA,<br />				hHttpOpen,<br />				NULL,<br />				0,<br />				0,<br />				0<br />				<br />		mov		hReturn, eax<br />		<br />		cmp		hReturn, 0<br />		je		ConnectionFailed<br />		<br />		invoke	RtlZeroMemory,<br />				OFFSET szQueryInfo,<br />				1024<br />				<br />		invoke	HttpQueryInfoA,					;here, it crashes!! &lt;&lt;<br />				hHttpOpen,<br />				HTTP_QUERY_STATUS_CODE,<br />				ADDR szQueryInfo,<br />				1024,<br />				0<br />				<br />		invoke	StrComp,<br />				OFFSET szQueryInfo,<br />				OFFSET szHttpOK<br />				<br />		cmp		eax, TRUE<br />		jne		ConnectionFailed<br />		<br />		invoke	RtlZeroMemory,<br />				OFFSET szQueryInfo,<br />				1024<br />				<br />		invoke	HttpQueryInfoA,<br />				hHttpOpen,<br />				HTTP_QUERY_RAW_HEADERS,<br />				ADDR szQueryInfo,<br />				1024,<br />				0	<br />		<br />		invoke	InString,<br />				1,<br />				OFFSET szBuffer,<br />				OFFSET szContent<br />        <br />        .if		eax &gt;= 0<br />				<br />				invoke	SetWindowText,<br />						hLabel,<br />						OFFSET szA<br />		.endif<br />		<br />		invoke	EnableWindow,<br />				hButton2,<br />				TRUE<br />		<br />		jmp		Done<br />		<br />ConnectionFailed&#58;<br />		invoke	SetWindowText,<br />						hLabel,<br />						OFFSET szNoInternet<br />	<br />Done&#58;<br />				<br />		invoke	InternetCloseHandle,<br />				hOpen<br />    <br />		invoke	InternetCloseHandle,<br />				hHttpOpen<br /><br />		invoke	InternetCloseHandle,<br />				hInternet<br />		<br />		ret	<br /><br /><br />		ret<br />		<br />GetFilesThread	ENDP<br /><br />StrComp			PROC	String1&#58;DWORD, <br />						String2&#58;DWORD<br /><br />			mov		eax, String1<br />			mov		ecx, String2<br />		<br />			dec		eax<br />			dec		ecx<br />		<br />StrComp1&#58;	inc		eax<br />			inc		ecx<br />			<br />			mov		dl, &#91;eax&#93;<br />			mov		dh, &#91;ecx&#93;<br />			<br />			cmp		dh, dl<br />			jne		NotEqual<br />			<br />			cmp		dh, 0<br />			je		Equal<br />			<br />			jmp		StrComp1<br />			<br />NotEqual&#58;	mov		eax, FALSE<br />			ret<br />		<br />Equal&#58;		mov		eax, TRUE<br />			ret<br /><br />StrComp			ENDP<br /></code></pre> <br /><br />I am looking forward to any answers!<br /><br />Regards,<br />Claus</div>
    <div class="meta">Posted on 2004-06-27 10:49:10 by ndn4u</div>
   </div>
   <div class="post" id="post-144946">
    <div class="subject"><a href="#post-144946">Internet download</a></div>
    <div class="body">OK,<br /><br />I think I got the error.<br /><br />HttpQueryInfoA wants a memory address where there is a pointer to the buffer size, so it can put in how many bytes were needed.<br /><br />Regards,<br />Claus</div>
    <div class="meta">Posted on 2004-06-27 11:48:27 by ndn4u</div>
   </div>
  </div>
 </body>
</html>