<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>String Parsing Procedure - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=3690" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=3690">String Parsing Procedure</a></p>
   <div class="post" id="post-24720">
    <div class="subject"><a href="#post-24720">String Parsing Procedure</a></div>
    <div class="body">GetStr proc szSource:dword, szDestination:dword, szParameter:dword, szDelimiter:byte<br />   push esi<br />   push edi<br />   push ebx<br /><br />   mov esi, szSource<br />   mov edi, szDestination<br />   xor ebx, ebx<br /><br />   @@Retrieve:<br />      mov al, <br />      inc esi<br />      test al, al<br />      jz @@Retrieved<br />      mov , al<br />      inc edi<br />      cmp al, szDelimiter<br />      jnz @@Retrieve<br /><br />   @@Retrieved:<br />      inc ebx<br />      cmp ebx, szParameter<br />      jz @@Retrieved2<br />      mov edi, szDestination<br />      mov ecx, 1024<br />      mov al, 0<br />      rep stosb<br />      mov edi, szDestination<br />      jmp @@Retrieve<br /><br />   @@Retrieved2:<br />      mov byte ptr , 0<br />      pop esi<br />      pop edi<br />      pop ebx<br />      ret<br />GetStr endp<br /><br />As always, optimizations are welcome :)</div>
    <div class="meta">Posted on 2002-02-17 15:43:11 by m00p</div>
   </div>
   <div class="post" id="post-24721">
    <div class="subject"><a href="#post-24721">String Parsing Procedure</a></div>
    <div class="body">You are poping wrong values.You should do in this way<br /><br />pop ebx<br />pop edi<br />pop esi<br /><br />or better use <strong>use</strong>  keyword like<br />GetStr proc uses edi esi ebx  szSource:dword, szDestination:dword, szParameter:dword, szDelimiter:byte <br />..<br />ret<br />GetStr endp<br /><br />if you use <strong>use</strong>  keyword you dont need to push and pop values to save registers.</div>
    <div class="meta">Posted on 2002-02-17 15:53:12 by LaptoniC</div>
   </div>
   <div class="post" id="post-24724">
    <div class="subject"><a href="#post-24724">String Parsing Procedure</a></div>
    <div class="body">Could you explain please what you code is doing?<br />Especially what is in parameter, and what this magic<br />code is doing?<br />inc ebx <br />cmp ebx, szParameter <br />jz @@Retrieved2 <br />mov edi, szDestination  <br />mov ecx, 1024 		;why 1024 ?<br />mov al, 0 		;why did you zero part that you just filled?<br />rep stosb <br />mov edi, szDestination <br />jmp @@Retrieve <br /><br />You want to retrive string after delemeter specified in Parameter?<br />Then find address of needed delemeter first and only then copy part<br />untill nexe delemetor or zero. Why those needless copy - zeroing?<br />The code can be optimized of course but before it the subject of the task<br />needed to be clear. Most powerfull optimization is optimization made in<br />our heads while we researching subject of task in depth before first<br />carachter typed in code source.</div>
    <div class="meta">Posted on 2002-02-17 16:15:14 by The Svin</div>
   </div>
   <div class="post" id="post-24739">
    <div class="subject"><a href="#post-24739">String Parsing Procedure</a></div>
    <div class="body">LaptoniC, thanks for pointing that out, i coded this a few days ago at 3 in the morning heh, anyway Svin, 1024 was the size of the buffer i had....so just change that to sizeof szDestination as for the mov al, 0 im not quite sure what you mean, but all it does if its the correct parameter to get, it puts null's in the buffer to get rid of the stuff already placed there.</div>
    <div class="meta">Posted on 2002-02-17 17:35:03 by m00p</div>
   </div>
   <div class="post" id="post-24741">
    <div class="subject"><a href="#post-24741">String Parsing Procedure</a></div>
    <div class="body"><strong>Svin</strong>, what I think the code is doing is this:<br />There is some string in <em>Source</em> which is null <strong>or</strong> &quot;<em>Delimiter</em>&quot; delimited (say &quot;,&quot; or such).<br />The proc seems to copy the <strong>n</strong>th section (as determined by nulls &amp; delimiters) to the destination parameter (which seems to be a 1k buffer).<br /><br />Source - is some null terminated string with a delimiter in it....<br />Destination - is a 1k buffer.<br />Parameter - is some count to select the 'n'th delimited item from source.<br />Delimiter - is the single byte character used as the delimiter.<br /><br />The current code copys then determines whether or not it has reached the appropriate delimter to terminate... This is slow, as you will be memory to memory copying data that will ultimately be overwritten. Instead we can only do the copy at the appropriate time by decrementing the parameter count at the start, and addind in a little jump at the begining.<br />As an optimisation it is more speed related than code size :)<br /><br />Also I shuffled registers to avoid using <strong>ebx</strong>, <strong>esi</strong>, and <strong>edi</strong>!<br /><br />I think this should do the same job...<br /><pre><code><br />  dec Parameter           ; For compatability reasons<br /><br />  mov edx, Source<br />  xor ecx, ecx<br /><br />  cmp ecx, Parameter      ; Do we want the first thing?....<br />  je The_Copy<br /><br />  mov ah, Delimiter<br /><br />Delimter_Search&#58;<br />  mov al, &#91;edx&#93;<br />  inc edx<br />  test al, al             ; Test for the null terminator<br />  jz The_Copy<br />  cmp al, ah              ; Test for the delimiter<br />  jne Delimiter_Search<br /><br />The_Copy&#58;<br />  inc ecx<br />  cmp ecx, Parameter      ; Is this the correct &quot;item&quot; ?<br />  jne Delimiter_Search<br /><br />  mov ecx, Destination    ; Count is no longer needed<br />  mov al, &#91;edx&#93;<br />  mov &#91;ecx&#93;, al<br />  inc edx<br />  inc ecx<br /><br />  test al, al<br />  jz The_End<br /><br />  cmp al, ah<br />  jne The_Copy<br /><br />The_End&#58;<br />  mov &#91;ecx - 1&#93;, 0        ; It could be &quot;delimiter&quot;, so<br />                          ; lets be sure!<br />  ret<br /></code></pre><br /><br />Of course you could probably neaten things up a bit, this was a quick glance at the problem.<br /><br />Mirno</div>
    <div class="meta">Posted on 2002-02-17 17:43:12 by Mirno</div>
   </div>
   <div class="post" id="post-24742">
    <div class="subject"><a href="#post-24742">String Parsing Procedure</a></div>
    <div class="body">1. If your proc format output in ASCIIZ then why you need to get read of anything?<br />2. Why first put it into destination and only then check if you put<br />the right thing? I'm asking it for the second time -<br />why can't you find address of right parameter and only then<br />copy to destination?</div>
    <div class="meta">Posted on 2002-02-17 17:44:26 by The Svin</div>
   </div>
   <div class="post" id="post-24800">
    <div class="subject"><a href="#post-24800">String Parsing Procedure</a></div>
    <div class="body">The original code is definitely sub-optimal, my first attempt did what the Svin suggested, and only starts the copy to <em>Destination</em> when it is appropriate.<br /><br />I did however realise that I had made a little mistake in my parameter selection (a mistake, and a missed optimisation)!<br /><br />Here is some new code:<br /><pre><code><br />  mov ah, Delimiter<br />  mov edx, Source<br />  mov ecx, Parameter<br /><br />  jmp The_Copy            ; Do we want the first thing?....<br /><br />Delimter_Search&#58;<br />  mov al, &#91;edx&#93;<br />  inc edx<br />  test al, al             ; Test for the null terminator<br />  jz The_Copy<br />  cmp al, ah              ; Test for the delimiter<br />  jne Delimiter_Search<br /><br />The_Copy&#58;<br />  dec ecx                 ; Is this the correct &quot;item&quot; ?<br />  jne Delimiter_Search<br /><br />  mov ecx, Destination    ; Count is no longer needed<br />  mov al, &#91;edx&#93;<br />  mov &#91;ecx&#93;, al<br />  inc edx<br />  inc ecx<br /><br />  test al, al<br />  jz The_End<br /><br />  cmp al, ah<br />  jne The_Copy<br /><br />The_End&#58;<br />  mov &#91;ecx - 1&#93;, 0        ; It could be &quot;delimiter&quot;, so<br />                          ; lets be sure!<br />  ret<br /></code></pre><br /><br />That should work better, in cases where Parameter was 1 it would most likely crash as it would be selecting the 4294967296th item from the list rather than the first! The rest should have been OK though.<br /><br />Mirno</div>
    <div class="meta">Posted on 2002-02-18 03:29:15 by Mirno</div>
   </div>
   <div class="post" id="post-24812">
    <div class="subject"><a href="#post-24812">String Parsing Procedure</a></div>
    <div class="body">Thank, Mirno.<br />I finally get it.<br />High level logic must be this then:<br /><br />1. Source = Source start<br />Check if Param = 1<br />Yes - Go to 3.<br />2. Search for delemeter # = Param-1<br />not found - Go to 4<br />Source = addr of delemetr # = Param-1<br />3. Copy string from source to dest untill next byte is delemeter or zero<br />    ret<br />4. Return Error</div>
    <div class="meta">Posted on 2002-02-18 05:17:44 by The Svin</div>
   </div>
   <div class="post" id="post-24825">
    <div class="subject"><a href="#post-24825">String Parsing Procedure</a></div>
    <div class="body">This is attempt to rather not solution but show process how<br />algos and procs are created.<br />I need to know if anybody need such kind of post, or I'd better stop.<br />-----------------------------------------------------------------------------------------------------------<br />When Hutch was working on BM algo he wrote noticable words:<br />&quot;Now I have all nessesary data to write BM algo&quot;<br />This phrase is sign of real programmer, not just asm programmer but any real programmer.<br />Code just symbols we put our thoughts and knowlige in.<br />Before it the knowlige must be aquered and thoghts must come.<br />There is simple example how one can think step by step about subj proc:<br />First we create logic algos (as we would do for alien computer that <br />would can understand our words):<br /><br />1. Source = Source start<br />Check if Param = 1<br />Yes - Go to 3.<br />2. Search for delemeter # = Param-1<br />not found - Go to 4<br />Source = addr of delemetr # = Param-1<br />3. Copy string from source to dest untill next byte is delemeter or zero<br />    ret<br />4. Return Error<br /><br />[1]. Finding the right place to copy from.<br />In the stage we can't know yet that:<br />- If there is param part in Source we searching for<br />- Delemeter show us only end of previous part.<br />This last condition is usual thing in programming and can be solved using<br />math logic<br />if n delemeter is end of part X_n and start of part X_n+1<br />then n-1 delemeter is start of part X_n<br />So should set counter for delemeter as Param-1.<br />The setting itselft give us greate opportunity not only set delemeter to right value<br />but also check condition in step 1. and possibility<br />that thecaller by mistake send 0 as Param:<br /><br />	mov ecx,Param<br />	dec ecx ;ecx = Param-1 and if Param = 1 ecx = 0 elseif Param = 0 ecx &lt; 0<br />	je @copy	;Param is 1 - we can copy right now	<br />	js @error ;Param is zero - jump to @error<br /><br />The other thing to keep in mind that delemeters in ASCIIZ is actually show start on next part<br />and if there is no &quot;next part&quot; 0 becomes a delemeter or terminator.<br />Because for us end of string should be either start the next part or end of the string<br />we treat both delemeter and zero as terminators.<br /><br />Delemetors usually has less ASCII code then most of contents of string that means <br />that we can filter out 9x% of &quot;not zero&quot; byte by just one cmp both for delemeter and<br />zero, yet we need to do additional check if &quot;zero probability&quot; found<br />	cmp byte,delemeter<br />	je @delemeterfound<br />	jnc @again ;not zero<br />	cmp byte,1 ;yet may be byte just less then delemeter? set cary if zero<br />		  ;this code will run very rare by mistake<br />	jc @error<br /><br />	....<br />@error:	sbb eax,eax ; -1 return if error<br /><br />now 'cause if a = b then a-b = 0 we can substruct 1 from the counter each time we <br />found a delemeter untill it 0 cause counter set to Param-1 we'll find Delemetor<br />wich is start of Part<br />@again:	mov al,<br />	inc esi<br />	cmp al,delemeter<br />	je @delemeterfound ;less prob <br />	jnc @again ;high prob taken<br />	cmp al,1<br />	jnc @again ; lowest prob guessed as not taken<br />@error:	sub eax,eax<br />	ret<br />@delemetorfound:<br />	dec ecx<br />	jne @again ;esi pointed to next byte.<br />;send bytes to edi until esi &lt;&gt; 0 and &lt;&gt; delemeter<br />@copy:<br /><br />I thought it was important to show process how some proc is created, while<br />doing research on subject of task and analyzing possible solutions.<br /><br />I can not be 100% sure that anybody need such kind of work, so let me<br />know please - shall I continue with this analyze, or it's worthless?</div>
    <div class="meta">Posted on 2002-02-18 07:02:15 by The Svin</div>
   </div>
   <div class="post" id="post-24852">
    <div class="subject"><a href="#post-24852">String Parsing Procedure</a></div>
    <div class="body">Here is my crappy version (didn't check it written in paper)<br />should be faster is there are not many spaces:<br /><pre><code><br />ret Value&#58; Success    eax = 0<br />	Error	 eax =-1<br /><br />GetArg proc uses esi lpSource,lpDest,Param,delim<br />	mov esi,lpSource<br />	mov ecx,Param<br />	mov edx,lpDest<br />	sub ecx,1<br />	mov ah,delim<br />	je @Copy<br />	jc @Error<br />@@&#58;	mov al,&#91;esi&#93;<br />	inc esi<br />	cmp al,ah<br />	je @found<br />	jns @B<br />	cmp al,1<br />	jnc @B<br />	jmp @Error<br />	dec ecx<br />@found&#58;	jne @B<br />@Copy&#58;	mov al,&#91;esi&#93;&#91;ecx&#93;<br />	inc ecx<br />	mov &#91;edx&#93;&#91;ecx-1&#93;,al<br />	cmp al,ah ;delimiter ?<br />	je @putzero<br />	jnc @Copy<br />	test al,al<br />	je @Error<br />	jmp @Copy<br />@putzero&#58;<br />	mov byte ptr &#91;edx&#93;&#91;ecx-1&#93;,0<br />@Error&#58;	sbb eax,eax<br />	ret<br />GetArg endp<br /></code></pre></div>
    <div class="meta">Posted on 2002-02-18 10:31:26 by The Svin</div>
   </div>
   <div class="post" id="post-24853">
    <div class="subject"><a href="#post-24853">String Parsing Procedure</a></div>
    <div class="body">Necessity of such procedure doubtfully. The procedure will reduce productivity of operation of the program which uses this procedure. I offer to consider the following units:<br />1. Usage for linear search of parameters.<br />More successful organization will be as two procedures: &quot;GetFirstParameter&quot;, &quot;GetNextParameter&quot;. Here there is no repeated scanning string.<br />2. Usage of a random access to parameters. Single scanning of string with fixing the beginning of strings in array (&quot;ScanParameters&quot;). &quot;GetParameter&quot; extracts the necessary string under number from the array of the beginnings of strings.<br />3. What for to duplicate parameters? I use methods of variation of string of parameters.<br />&quot;param1,&quot;<br />&quot;param2,&quot;<br />&quot;param3&quot;, 0<br />  vvv<br />&quot;param1&quot;, 0<br />&quot;param2&quot;, 0<br />&quot;param3&quot;, 0<br />Changeover of a separator by null is fulfilled. Procedures &quot;Get???Parameter&quot; transmits the pointer by the beginning of the parameter to the initial string.<br /><br />Combination of these units considerably will boost rate of machining and common productivity of the program.</div>
    <div class="meta">Posted on 2002-02-18 10:40:19 by Nexo</div>
   </div>
   <div class="post" id="post-24867">
    <div class="subject"><a href="#post-24867">String Parsing Procedure</a></div>
    <div class="body">You are right, Nexo. But it is another topic.<br />Here I want to help the boy to achive what he wants by more<br />effective way.<br />As to parsing I think some programmers here use those parsings not for params in it's usual hence but for kinda database tasks<br />(why did he need such a long buffer for example?).<br />Which of course not good way to design, but as I said - it's another topic.<br />-----------------<br />To the proc - a little changes with assumed probability.<br /><pre><code><br />;ret Value&#58; Success - eax = 0<br />;	Error	 eax =-1<br />	invoke GetArg,offset Source,offset dest,2,&quot;,&quot;<br />	invoke MessageBox,0,offset dest,0,0<br />	call ExitProcess<br />GetArg proc uses esi lpSource,lpDest,Param,delim&#58;BYTE<br />	mov esi,lpSource<br />	mov ecx,Param<br />	mov edx,lpDest<br />	sub ecx,1<br />	mov ah,delim<br />	je @Copy<br />	jc @Error<br />@@&#58;	mov al,&#91;esi&#93;<br />	inc esi<br />	cmp al,ah<br />	ja @B	;high prob<br />	je @found ;rare prob<br />	cmp al,1<br />	jnc @B	 ;low prob<br />	jmp @Error ;50\50<br />@found&#58;	dec ecx<br />	jne @B<br />@Copy&#58;	mov al,&#91;esi&#93;&#91;ecx&#93;<br />	inc ecx<br />	mov &#91;edx&#93;&#91;ecx-1&#93;,al<br />	cmp al,ah ;delimiter ?<br />	ja @Copy	 ;high proc<br />	je @putzero ;only once<br />	cmp al,1<br />	jnc @Copy  ;low proc<br />	jmp @Error ;only once<br />@putzero&#58;<br />	mov byte ptr &#91;edx&#93;&#91;ecx-1&#93;,0<br />@Error&#58;	sbb eax,eax<br />	ret<br />GetArg endp<br /></code></pre></div>
    <div class="meta">Posted on 2002-02-18 11:38:00 by The Svin</div>
   </div>
   <div class="post" id="post-24895">
    <div class="subject"><a href="#post-24895">String Parsing Procedure</a></div>
    <div class="body"><strong>Maybe someone do it faster</strong><br /><br />Here is my optimized method<br /><pre><code><br />.data<br />	mess db &quot;This is a string parsing test&quot;,0<br />.data?<br />	bufout 	db 1024 dup&#40;?&#41;<br />.code<br /><br />start&#58;<br />	mov edi, offset mess<br />	mov edx, 32	;delimiter<br />	mov ebx, 7	;number of string<br />	call strlen<br />	call GetStr<br />	invoke MessageBox, 0, addr bufout, addr bufout, MB_OK<br />	invoke ExitProcess,0<br /><br />GetStr proc uses edx esi edi ebx<br />	mov eax, edx<br />	test ebx, ebx<br />	jz @@first<br /><br />@@next&#58;<br />	repne scasb<br />	dec ebx<br />	test ebx, ebx<br />	jnz @@next<br /><br />@@first&#58;<br />	push edi<br />	mov edx, ecx<br />	repne scasb<br />	sub edx, ecx<br />	mov ecx, edx<br />	pop esi<br />	mov edi, offset bufout<br />	rep movsb<br />	ret<br />GetStr endp<br /><br />strlen proc uses edi<br />	xor al, al<br />	xor ecx, ecx<br />	dec ecx<br />	repnz scasb<br />	not ecx<br />	dec ecx<br />	ret<br />strlen endp<br /><br />end start<br /></code></pre><br />BTW, there is no checking of bufout overflow</div>
    <div class="meta">Posted on 2002-02-18 14:45:38 by masquer</div>
   </div>
   <div class="post" id="post-24905">
    <div class="subject"><a href="#post-24905">String Parsing Procedure</a></div>
    <div class="body">Optimized for size? :)</div>
    <div class="meta">Posted on 2002-02-18 16:25:48 by The Svin</div>
   </div>
   <div class="post" id="post-24920">
    <div class="subject"><a href="#post-24920">String Parsing Procedure</a></div>
    <div class="body">'Cause it was obviously not speed but size optimization,<br />I didn't change anything that increasing speed would increase<br />size also.<br />One more thing - you code works only 'cause in a start there are<br />usualy zeros in .data? section - you need to add zero termination<br />otherwize problems could arise.<br /><pre><code><br />.data<br />	mess db &quot;This is a string parsing test&quot;,0<br />.data?<br />	bufout 	db 1024 dup&#40;?&#41;<br />.code<br />start&#58;	mov edi, offset mess<br />;	mov edx, 32	;delimiter<br />	mov ebx, 0	;number of string<br />	call strlen<br />	mov al,32<br />	call GetStr<br />	invoke MessageBox, 0, addr bufout, addr bufout, MB_OK<br />	invoke ExitProcess,0<br />GetStr proc uses edx esi edi ebx<br />;	mov eax, edx<br />	test ebx, ebx<br />	jz @@first<br />@@next&#58;<br />	repne scasb<br />	dec ebx<br />;	test ebx, ebx - you don't need it dec already sets ZF<br />	jnz @@next<br />@@first&#58;	push edi<br />	mov edx, ecx<br />	repne scasb<br />;	sub edx, ecx<br />;	mov ecx, edx<br />	sub ecx,edx ;the same but paralelled<br />	pop esi<br />	neg ecx<br />	mov edi, offset bufout<br />	rep movsb<br />	ret<br />GetStr endp<br />strlen proc uses edi<br />	xor eax, eax<br />	lea ecx,&#91;eax-1&#93;  ;the same 3 bytes<br />;	xor ecx, ecx<br />;	dec ecx		;? mov ecx,-1	<br />	repnz scasb<br />	not ecx<br />	dec ecx<br />	ret<br />strlen endp<br /></code></pre></div>
    <div class="meta">Posted on 2002-02-18 18:44:44 by The Svin</div>
   </div>
   <div class="post" id="post-24968">
    <div class="subject"><a href="#post-24968">String Parsing Procedure</a></div>
    <div class="body">OK, I'm agree with almost all your claims, Svin. Not with all, for example:<br /><pre><code><br />mov al, 32<br /></code></pre><br />I think following code will be faster on proc higher than 386<br /><pre><code><br />mov eax, 32<br /></code></pre><br />And about speed and size. As I see your algo is operating with 16-bit registers, I dont think it is a fast way.<br /><br />BTW, interesting problem arise if delimiter contain more than one byte</div>
    <div class="meta">Posted on 2002-02-19 01:37:22 by masquer</div>
   </div>
   <div class="post" id="post-24996">
    <div class="subject"><a href="#post-24996">String Parsing Procedure</a></div>
    <div class="body">There is no 16 bit regs in my algo. Only 32 and 8 bit.<br />8 bit regs is OK both for 16 and 32 bit mode (no additional prefix<br />no additional clock)<br />As to speed -<br />Test!</div>
    <div class="meta">Posted on 2002-02-19 07:53:38 by The Svin</div>
   </div>
  </div>
 </body>
</html>