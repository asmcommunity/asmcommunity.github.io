<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Unicode or ANSI-APIs - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=19729" />
  <link rel="prev" href="../?id=19729&amp;page=1" />   </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=19729">Unicode or ANSI-APIs</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=19729&amp;page=1" style="">&laquo;</a><a href="../?id=19729&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="19729" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>   <div class="post" id="post-151894">
    <div class="subject"><a href="#post-151894">Unicode or ANSI-APIs</a></div>
    <div class="body">&gt; Hi, this does not work out, as _imp_CreateWindowExW@48 does not exist<br />&gt; (I am using MASM32)<br /><br />Well, you must declare it as external of course, for example:<br /><br />externdef stdcall _imp_CreateWindowExW@48:dword</div>
    <div class="meta">Posted on 2004-10-27 02:55:58 by japheth</div>
   </div>
   <div class="post" id="post-151897">
    <div class="subject"><a href="#post-151897">Unicode or ANSI-APIs</a></div>
    <div class="body">I'm actually working on a switched ANSI/Unicode application at the moment (it needs to be able to use and display non-Roman characters under XP, but use Roman characters only under 9x and ME).<br /><br />So I put together some parts of the code to demonstrate the sort of thing required:-<br /><br /><pre><code>;By Jeremy Gordon 27th October 2004<br />;<br />;This code demonstrates how to used switched calls to the APIs to write<br />;an application which will work under Windows 9x/ME and also under NT/2000/XP.<br />;There are two reasons for using switched calls here.  Firstly, an application<br />;which calls an API which does not exist in the system will not load.  So<br />;here you are making sure that when running under Windows 9x/ME the calls to <br />;the Unicode APIs are not called directly.  Secondly this is an easy way to <br />;call the correct API at run-time.<br />;<br />;Using switching in this way is only necessary if you want to use non-Roman<br />;characters in the application.<br />;<br />;If you are using Roman characters throughout, for example English, you can<br />;either use the ANSI APIs throughout &#40;they work equally well on NT/2000/XP&#41;<br />;or you can use the Microsoft Layer for Unicode &#40;MSLU&#41;.  This can easily <br />;be achieved using GoLink, which has its own MSLU loader.  See my article<br />;&quot;Writing Unicode Programs&quot; one of the tutorials on the GoAsm web site.<br />;<br />;A third alternative is to use different versions of your program, one<br />;for 9x/ME and one for NT/2000/XP.<br />;<br />;This code is in GoAsm format. See http&#58;//www.GoDevTool.com<br />;<br />DATA<br />;<br />;Here we concentrate on the APIs in User32.dll only.  This must be done<br />;for each of the DLLs we will be using.<br />;<br />USERNAME_ASSTRINGS DB 'GetClassLongA',0          ;USERSCALLS+0h<br />               DB 'GetWindowLongA',0             ;USERSCALLS+4h<br />               DB 'SendMessageA',0               ;USERSCALLS+8h<br />               DB 'RegisterClassA',0             ;USERSCALLS+Ch<br />               DB 'SendDlgItemMessageA',0        ;USERSCALLS+10h<br />               DB 'CallWindowProcA',0            ;USERSCALLS+14h<br />               DB 'CreateWindowExA',0            ;USERSCALLS+18h<br />               DB 'UnregisterClassA',0           ;USERSCALLS+1Ch<br />               DB 'SetWindowTextA',0             ;USERSCALLS+20h<br />               DB 'DefWindowProcA',0             ;USERSCALLS+24h<br />               DB 'CreateDialogParamA',0         ;USERSCALLS+28h<br />               DB 'GetClassInfoA',0              ;USERSCALLS+2Ch<br />               DB 'DialogBoxParamA',0            ;USERSCALLS+30h<br />               DB 'MessageBoxA',0                ;USERSCALLS+34h<br />               DB 'LoadMenuA',0                  ;USERSCALLS+38h<br />               DB 'InsertMenuItemA',0            ;USERSCALLS+3Ch               <br />               DB 'DrawTextExA',0                ;USERSCALLS+40h               <br />               DB ' ',0		                    ;spare entry	<br />               DB 0FFh			              	 ;end stop<br />USERNAME_WSSTRINGS DB 'GetClassLongW',0          ;USERSCALLS+0h<br />               DB 'GetWindowLongW',0             ;USERSCALLS+4h<br />               DB 'SendMessageW',0               ;USERSCALLS+8h<br />               DB 'RegisterClassW',0             ;USERSCALLS+Ch<br />               DB 'SendDlgItemMessageW',0        ;USERSCALLS+10h<br />               DB 'CallWindowProcW',0            ;USERSCALLS+14h<br />               DB 'CreateWindowExW',0            ;USERSCALLS+18h<br />               DB 'UnregisterClassW',0           ;USERSCALLS+1Ch<br />               DB 'SetWindowTextW',0             ;USERSCALLS+20h<br />               DB 'DefWindowProcW',0             ;USERSCALLS+24h<br />               DB 'CreateDialogParamW',0         ;USERSCALLS+28h<br />               DB 'GetClassInfoW',0              ;USERSCALLS+2Ch<br />               DB 'DialogBoxParamW',0            ;USERSCALLS+30h<br />               DB 'MessageBoxW',0                ;USERSCALLS+34h<br />               DB 'LoadMenuW',0                  ;USERSCALLS+38h<br />               DB 'InsertMenuItemW',0            ;USERSCALLS+3Ch               <br />               DB 'DrawTextExW',0                ;USERSCALLS+40h               <br />               DB ' ',0		                    ;spare entry	<br />               DB 0FFh			              	 ;end stop<br />ALIGN 4<br />;<br />USERSCALLS DD 18 DUP 0	;to hold calls to APIs in User32.dll<br />PLATFORM_ID  DD  0 		;to hold the system we are running on<br />BUFFER DB DUP 1000h	   ;general 4K buffer<br />;<br />CODE<br />;<br />START&#58;<br />;<br />;***************** first find out what system we are running on<br />MOV ESI,ADDR BUFFER<br />MOV D&#91;ESI&#93;,148          ;OSVERSIONINFO structure size<br />PUSH ESI<br />CALL GetVersionExA	   ;this API works on both platforms<br />MOV EAX,&#91;ESI+10h&#93;       ;get platform id<br />MOV &#91;PLATFORM_ID&#93;,EAX   ;keep that<br />;<br />;***************** next get the APIs from User32.dll<br />PUSH 'User32.dll'<br />CALL LoadLibraryA       ;get handle of User32.dll<br />OR EAX,EAX	           ;check for eax=0<br />JZ &gt;L50		           ;error exit<br />MOV EBX,EAX             ;keep handle in ebx<br />MOV EDI,ADDR USERSCALLS ;get place to put API addresses<br />MOV ESI,ADDR USERNAME_ASSTRINGS   ;get list of API names &#40;ANSI&#41;<br />CMP D&#91;PLATFORM_ID&#93;,1    ;see if NT,2000,XP and above<br />JNA &gt;L18                ;no, use ANSI APIs<br />MOV ESI,ADDR USERNAME_WSSTRINGS   ;get list of API names &#40;Unicode&#41;<br />L18&#58;<br />CALL GET_CALLS		    ;see this procedure further down this source<br />JC &gt;L50			        ;error exit &#40;to somewhere not shown here&#41;<br />;<br />;****************** now make a message box<br />;****************** note that if you are writing to the message box in<br />;****************** &quot;Roman&quot; characters you might as well just use<br />;****************** CALL MessageBoxA which works both under 9x and NT\XP.  <br />;****************** However if you want to write to the message box <br />;****************** in non-Roman characters eg. Chinese. Cyrillic etc<br />;****************** then you would use this switched version<br />;<br />;****************** The following supposes that the string for the <br />;****************** message box is already in BUFFER<br />;<br />PUSH 40h                ;information + ok button<br />CMP D&#91;PLATFORM_ID&#93;,1    ;see if NT,2000,XP and above<br />JNA &gt;L244               ;no<br />PUSH L'Hello in Unicode';push pointer to Unicode string using L override<br />JMP &gt;L246<br />L244&#58;<br />PUSH 'Hello in ANSI'	 ;push pointer to ANSI string<br />L246&#58;<br />PUSH ADDR BUFFER,0	   ;push message, followed by message box owner<br />CALL &#91;USERSCALLS+34h&#93;   ;CALL either MessageBoxA or MessageBoxW<br />;<br />;<br />;	rest of the code goes here<br />;<br />;**********************************************************************<br />;<br />GET_CALLS&#58;<br />L1&#58;<br />CMP B&#91;ESI&#93;,20h          ;see if spare entry<br />JZ &gt;L2                  ;yes, jump over this one<br />PUSH ESI,EBX<br />CALL GetProcAddress<br />OR EAX,EAX              ;see if successful<br />JZ &gt;L4                  ;no, drop out<br />L2&#58;<br />STOSD                   ;insert API address into call destination<br />L3&#58;<br />LODSB                   ;get to end of this API name<br />OR AL,AL                ;see if end of last string yet<br />JNZ L3                  ;no<br />CMP B&#91;ESI&#93;,0FFh         ;see if finished function list<br />JNZ L1                  ;no, so use this string<br />RET<br />L4&#58;<br />STC                     ;return c if failed, nc if succeeded<br />RET</code></pre></div>
    <div class="meta">Posted on 2004-10-27 03:30:15 by jorgon</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=19729&amp;page=1" style="">&laquo;</a><a href="../?id=19729&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="19729" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>  </div>
 </body>
</html>