<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>MD5 implementation questions - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=9136" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=9136">MD5 implementation questions</a></p>
   <div class="post" id="post-67212">
    <div class="subject"><a href="#post-67212">MD5 implementation questions</a></div>
    <div class="body">i've got a MD5 Hasher (roy|fleur one)<br /><br />so it produce 4 dwords for the hash of a buffer<br /><br />1st question:<br /><br />with the hash dwords can i reteive the buffer (a string or something longer as a file)<br /><br />2nd question:<br />in the smtp auth post from Djizeus on networking forum<br /><br />it talk about a MD5 key (the smtp server send to the client hash dwords and the client use it as key to hash the password and send it to the server to auth)<br /><br />how does it work where i put the key in the algo<br /><br /><br />here's his code:<br /><pre><code><br />;____________________________________________________________________________________________________________________________<br />; MD5hash &#58; hashes a string using the md5 algorithm<br />;????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????<br />; input  &#58;<br />;  ptBuffer&#58; pointer to the string buffer &#40;doesn' t have to be zero-terminated, must be at least 64bytes large&#41;<br />;  dtBufferLength&#58; length of the buffer<br />;  ptMD5Result&#58; pointer to a MD5RESULT structure<br />; output &#58;<br />;  ptMD5Result&#58; contains the hash dwords in dtA, dtB, dtC, dtD<br />;____________________________________________________________________________________________________________________________<br />; roy|fleur<br />;????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????<br /><br />MD5hash			proto	&#58;dword,&#58;dword,&#58;dword<br /><br />MD5RESULT		STRUCT<br />	dtA		dd	?<br />	dtB		dd	?<br />	dtC		dd	?<br />	dtD		dd	?<br />MD5RESULT		ENDS<br /><br />FF			MACRO	dta,dtb,dtc,dtd,x,s,t				; a = b + &#40;&#40;a + F&#40;b,c,d&#41; + x + t&#41; &lt;&lt; s &#41;<br /><br />			mov	eax,dtb<br />			mov	ebx,dtc<br />			mov	ecx,dtd<br /><br />			; F&#40;x,y,z&#41; = &#40;x and y&#41; or &#40;&#40;not x&#41; and z&#41;<br />			and	ebx,eax<br />			not	eax<br />			and	eax,ecx<br />			or	eax,ebx<br /><br />			add	eax,dta<br />			add	eax,x<br />			add	eax,t<br /><br />			mov	cl,s<br />			rol	eax,cl<br /><br />			add	eax,dtb<br /><br />			mov	dta,eax<br /><br />ENDM<br /><br />GG			MACRO	dta,dtb,dtc,dtd,x,s,t				; a = b + &#40;&#40;a + G&#40;b,c,d&#41; + x + t&#41; &lt;&lt; s&#41;<br /><br />			mov	eax,dtb<br />			mov	ebx,dtc<br />			mov	ecx,dtd<br /><br />			; G&#40;x,y,z&#41; = &#40;x and z&#41; or &#40;y and &#40;not z&#41;&#41;<br />			and	eax,ecx<br />			not	ecx<br />			and	ecx,ebx<br />			or	eax,ecx<br /><br />			add	eax,dta<br />			add	eax,x<br />			add	eax,t<br /><br />			mov	cl,s<br />			rol	eax,cl<br /><br />			add	eax,dtb<br /><br />			mov	dta,eax<br /><br />ENDM<br /><br />HH			MACRO	dta,dtb,dtc,dtd,x,s,t				; a = b + &#40;&#40;a + H&#40;b,c,d&#41; + x + t&#41; &lt;&lt; s&#41;<br /><br />			mov	eax,dtb<br />			mov	ebx,dtc<br />			mov	ecx,dtd<br /><br />			; H&#40;x,y,z&#41; = x xor y xor z<br />			xor	eax,ebx<br />			xor	eax,ecx<br /><br />			add	eax,dta<br />			add	eax,x<br />			add	eax,t<br /><br />			mov	cl,s<br />			rol	eax,cl<br /><br />			add	eax,dtb<br /><br />			mov	dta,eax<br /><br />ENDM<br /><br />II			MACRO	dta,dtb,dtc,dtd,x,s,t				; a = b + &#40;&#40;a + I&#40;b,c,d&#41; + x + t&#41; &lt;&lt; s&#41;<br /><br />			mov	eax,dtb<br />			mov	ebx,dtc<br />			mov	ecx,dtd<br /><br />			; I&#40;x,y,z&#41; = y xor &#40;x or &#40;not z&#41;&#41;<br />			not	ecx<br />			or	eax,ecx<br />			xor	eax,ebx<br /><br />			add	eax,dta<br />			add	eax,x<br />			add	eax,t<br /><br />			mov	cl,s<br />			rol	eax,cl<br /><br />			add	eax,dtb<br /><br />			mov	dta,eax<br /><br />ENDM<br /><br />.code<br /><br />MD5hash			proc	uses eax ebx ecx edx edi esi,ptBuffer&#58;dword,dtBufferLength&#58;dword,ptMD5Result&#58;dword<br />			local	dta&#58;dword,dtb&#58;dword,dtc&#58;dword,dtd&#58;dword<br /><br />			; phase I ? padding<br />			mov	edi,ptBuffer<br />			mov	eax,dtBufferLength<br /><br />			inc	eax<br />			add	edi,eax<br />			mov	byte ptr &#91;edi-1&#93;,080h<br /><br />			xor	edx,edx<br /><br />			mov	ebx,64<br />			div	ebx<br /><br />			neg	edx<br />			add	edx,64<br /><br />			cmp	edx,8<br />			jae	@f<br /><br />			add	edx,64<br /><br />@@&#58;			mov	ecx,edx<br />			xor	al,al<br />			rep	stosb<br /><br />			mov	eax,dtBufferLength<br /><br />			inc	edx<br />			add	dtBufferLength,edx<br /><br />			xor	edx,edx<br /><br />			mov	ebx,8<br />			mul	ebx<br /><br />			mov	dword ptr &#91;edi-8&#93;,eax<br />			mov	dword ptr &#91;edi-4&#93;,edx<br /><br />			mov	edx,dtBufferLength<br /><br />			mov	edi,ptBuffer<br /><br />			; phase II ? chaining variables initialization<br />			mov	esi,ptMD5Result<br />			assume	esi&#58;ptr MD5RESULT<br /><br />			mov	&#91;esi&#93;.dtA,067452301h<br />			mov	&#91;esi&#93;.dtB,0efcdab89h<br />			mov	&#91;esi&#93;.dtC,098badcfeh<br />			mov	&#91;esi&#93;.dtD,010325476h<br /><br />			; phase III ? hashing<br />hashloop&#58;		mov	eax,&#91;esi&#93;.dtA<br />			mov	dta,eax<br />			mov	eax,&#91;esi&#93;.dtB<br />			mov	dtb,eax<br />			mov	eax,&#91;esi&#93;.dtC<br />			mov	dtc,eax<br />			mov	eax,&#91;esi&#93;.dtD<br />			mov	dtd,eax<br /><br />			; round 1<br />			FF	dta,dtb,dtc,dtd,dword ptr &#91;edi+00*4&#93;,07,0d76aa478h<br />			FF	dtd,dta,dtb,dtc,dword ptr &#91;edi+01*4&#93;,12,0e8c7b756h<br />			FF	dtc,dtd,dta,dtb,dword ptr &#91;edi+02*4&#93;,17,0242070dbh<br />			FF	dtb,dtc,dtd,dta,dword ptr &#91;edi+03*4&#93;,22,0c1bdceeeh<br />			FF	dta,dtb,dtc,dtd,dword ptr &#91;edi+04*4&#93;,07,0f57c0fafh<br />			FF	dtd,dta,dtb,dtc,dword ptr &#91;edi+05*4&#93;,12,04787c62ah<br />			FF	dtc,dtd,dta,dtb,dword ptr &#91;edi+06*4&#93;,17,0a8304613h<br />			FF	dtb,dtc,dtd,dta,dword ptr &#91;edi+07*4&#93;,22,0fd469501h<br />			FF	dta,dtb,dtc,dtd,dword ptr &#91;edi+08*4&#93;,07,0698098d8h<br />			FF	dtd,dta,dtb,dtc,dword ptr &#91;edi+09*4&#93;,12,08b44f7afh<br />			FF	dtc,dtd,dta,dtb,dword ptr &#91;edi+10*4&#93;,17,0ffff5bb1h<br />			FF	dtb,dtc,dtd,dta,dword ptr &#91;edi+11*4&#93;,22,0895cd7beh<br />			FF	dta,dtb,dtc,dtd,dword ptr &#91;edi+12*4&#93;,07,06b901122h<br />			FF	dtd,dta,dtb,dtc,dword ptr &#91;edi+13*4&#93;,12,0fd987193h<br />			FF	dtc,dtd,dta,dtb,dword ptr &#91;edi+14*4&#93;,17,0a679438eh<br />			FF	dtb,dtc,dtd,dta,dword ptr &#91;edi+15*4&#93;,22,049b40821h<br /><br />			; round 2<br />			GG	dta,dtb,dtc,dtd,dword ptr &#91;edi+01*4&#93;,05,0f61e2562h<br />			GG	dtd,dta,dtb,dtc,dword ptr &#91;edi+06*4&#93;,09,0c040b340h<br />			GG	dtc,dtd,dta,dtb,dword ptr &#91;edi+11*4&#93;,14,0265e5a51h<br />			GG	dtb,dtc,dtd,dta,dword ptr &#91;edi+00*4&#93;,20,0e9b6c7aah<br />			GG	dta,dtb,dtc,dtd,dword ptr &#91;edi+05*4&#93;,05,0d62f105dh<br />			GG	dtd,dta,dtb,dtc,dword ptr &#91;edi+10*4&#93;,09,002441453h<br />			GG	dtc,dtd,dta,dtb,dword ptr &#91;edi+15*4&#93;,14,0d8a1e681h<br />			GG	dtb,dtc,dtd,dta,dword ptr &#91;edi+04*4&#93;,20,0e7d3fbc8h<br />			GG	dta,dtb,dtc,dtd,dword ptr &#91;edi+09*4&#93;,05,021e1cde6h<br />			GG	dtd,dta,dtb,dtc,dword ptr &#91;edi+14*4&#93;,09,0c33707d6h<br />			GG	dtc,dtd,dta,dtb,dword ptr &#91;edi+03*4&#93;,14,0f4d50d87h<br />			GG	dtb,dtc,dtd,dta,dword ptr &#91;edi+08*4&#93;,20,0455a14edh<br />			GG	dta,dtb,dtc,dtd,dword ptr &#91;edi+13*4&#93;,05,0a9e3e905h<br />			GG	dtd,dta,dtb,dtc,dword ptr &#91;edi+02*4&#93;,09,0fcefa3f8h<br />			GG	dtc,dtd,dta,dtb,dword ptr &#91;edi+07*4&#93;,14,0676f02d9h<br />			GG	dtb,dtc,dtd,dta,dword ptr &#91;edi+12*4&#93;,20,08d2a4c8ah<br /><br />			; round 3<br />			HH	dta,dtb,dtc,dtd,dword ptr &#91;edi+05*4&#93;,04,0fffa3942h<br />			HH	dtd,dta,dtb,dtc,dword ptr &#91;edi+08*4&#93;,11,08771f681h<br />			HH	dtc,dtd,dta,dtb,dword ptr &#91;edi+11*4&#93;,16,06d9d6122h<br />			HH	dtb,dtc,dtd,dta,dword ptr &#91;edi+14*4&#93;,23,0fde5380ch<br />			HH	dta,dtb,dtc,dtd,dword ptr &#91;edi+01*4&#93;,04,0a4beea44h<br />			HH	dtd,dta,dtb,dtc,dword ptr &#91;edi+04*4&#93;,11,04bdecfa9h<br />			HH	dtc,dtd,dta,dtb,dword ptr &#91;edi+07*4&#93;,16,0f6bb4b60h<br />			HH	dtb,dtc,dtd,dta,dword ptr &#91;edi+10*4&#93;,23,0bebfbc70h<br />			HH	dta,dtb,dtc,dtd,dword ptr &#91;edi+13*4&#93;,04,0289b7ec6h<br />			HH	dtd,dta,dtb,dtc,dword ptr &#91;edi+00*4&#93;,11,0eaa127fah<br />			HH	dtc,dtd,dta,dtb,dword ptr &#91;edi+03*4&#93;,16,0d4ef3085h<br />			HH	dtb,dtc,dtd,dta,dword ptr &#91;edi+06*4&#93;,23,004881d05h<br />			HH	dta,dtb,dtc,dtd,dword ptr &#91;edi+09*4&#93;,04,0d9d4d039h<br />			HH	dtd,dta,dtb,dtc,dword ptr &#91;edi+12*4&#93;,11,0e6db99e5h<br />			HH	dtc,dtd,dta,dtb,dword ptr &#91;edi+15*4&#93;,16,01fa27cf8h<br />			HH	dtb,dtc,dtd,dta,dword ptr &#91;edi+02*4&#93;,23,0c4ac5665h<br /><br />			; round 4<br />			II	dta,dtb,dtc,dtd,dword ptr &#91;edi+00*4&#93;,06,0f4292244h<br />			II	dtd,dta,dtb,dtc,dword ptr &#91;edi+07*4&#93;,10,0432aff97h<br />			II	dtc,dtd,dta,dtb,dword ptr &#91;edi+14*4&#93;,15,0ab9423a7h<br />			II	dtb,dtc,dtd,dta,dword ptr &#91;edi+05*4&#93;,21,0fc93a039h<br />			II	dta,dtb,dtc,dtd,dword ptr &#91;edi+12*4&#93;,06,0655b59c3h<br />			II	dtd,dta,dtb,dtc,dword ptr &#91;edi+03*4&#93;,10,08f0ccc92h<br />			II	dtc,dtd,dta,dtb,dword ptr &#91;edi+10*4&#93;,15,0ffeff47dh<br />			II	dtb,dtc,dtd,dta,dword ptr &#91;edi+01*4&#93;,21,085845dd1h<br />			II	dta,dtb,dtc,dtd,dword ptr &#91;edi+08*4&#93;,06,06fa87e4fh<br />			II	dtd,dta,dtb,dtc,dword ptr &#91;edi+15*4&#93;,10,0fe2ce6e0h<br />			II	dtc,dtd,dta,dtb,dword ptr &#91;edi+06*4&#93;,15,0a3014314h<br />			II	dtb,dtc,dtd,dta,dword ptr &#91;edi+13*4&#93;,21,04e0811a1h<br />			II	dta,dtb,dtc,dtd,dword ptr &#91;edi+04*4&#93;,06,0f7537e82h<br />			II	dtd,dta,dtb,dtc,dword ptr &#91;edi+11*4&#93;,10,0bd3af235h<br />			II	dtc,dtd,dta,dtb,dword ptr &#91;edi+02*4&#93;,15,02ad7d2bbh<br />			II	dtb,dtc,dtd,dta,dword ptr &#91;edi+09*4&#93;,21,0eb86d391h<br /><br />			mov	eax,dta<br />			add	&#91;esi&#93;.dtA,eax<br />			mov	eax,dtb<br />			add	&#91;esi&#93;.dtB,eax<br />			mov	eax,dtc<br />			add	&#91;esi&#93;.dtC,eax<br />			mov	eax,dtd<br />			add	&#91;esi&#93;.dtD,eax<br /><br />			add	edi,64<br /><br />			sub	edx,64<br />			jnz	hashloop<br /><br />			; phase IV ? results<br /><br />			mov	ecx,4<br /><br />@@&#58;			mov	eax,dword ptr &#91;esi&#93;<br />			xchg	al,ah<br />			rol	eax,16<br />			xchg	al,ah<br />			mov	dword ptr &#91;esi&#93;,eax<br /><br />			add	esi,4<br /><br />			loop	@b<br /><br />			ret<br /><br />MD5hash			endp<br /></code></pre><br /><br />thanks to help me<br /><br /><br /><br /><span style="font-size:9px><em>[ code ] tags added - bazik</em></span></div>
    <div class="meta">Posted on 2002-11-24 13:27:04 by Thor0Asgard</div>
   </div>
   <div class="post" id="post-67223">
    <div class="subject"><a href="#post-67223">MD5 implementation questions</a></div>
    <div class="body">Thor0Asgard,<br />Did you download the <a target="_blank" href="http://spiff.tripnet.se/~iczelion/files/md5asm.zip">full zip-file from Iczelion's homepage?</a><br />If so have you checked out the full example file included inside? ?<br />When you open the md5asm.zip there is another zip-file inside<br />called md5hasher.zip. Wich contains a good example with .exe file.<br /><br />However, if you have already checked out that example then I cannot<br />help you. Since I have never used MD5 at this moment.<br /><br /><strong>EDIT:</strong><br />But if you want to get the 'hash' of all the contents in a file I would<br />recommend doing it line by line. F.ex. Read oneline from the file, and <br />output a new hashed line to a new file. Until the end is reached.<br />I dont know if it handles big files therefore i recommend a 'line by line'<br />approch.</div>
    <div class="meta">Posted on 2002-11-24 14:13:20 by natas</div>
   </div>
   <div class="post" id="post-67248">
    <div class="subject"><a href="#post-67248">MD5 implementation questions</a></div>
    <div class="body">I recently did some playing around with MD5 hashing for a commercial product. The MD5 routines were in asm (of course), and they were being called from VB. As this particular code is no longer being used commercially, if you want i will see if i can dig it back out for you.<br /><br />Why are the asm MD5 routines no longer being used commercially? Because Windows also offers MD5 hashing through the Crypto API, and the windows functions are *highly* optimised, to the point where they were beating the straight asm MD5 routines (the asm routines were optimised at the .386 level, which keeps them reasonably generic). As code using the Windows API is far easier to maintain and support, we went with that code.<br /><br />So my suggestion is this: upon program load, check Windows for the presence of the MD5 functionality in the Crypto API, if it exists then use that, otherwise revert to using your asm function.<br /><br /><span style="font-size:9px>It pains me immensely to admit that (some) Windows functions are quicker than asm functions, but from my research it is obvious that MS has either put a lot of time and effort into the crypto functions, or they hired someone who could actually program.</span></div>
    <div class="meta">Posted on 2002-11-24 17:46:31 by sluggy</div>
   </div>
   <div class="post" id="post-67259">
    <div class="subject"><a href="#post-67259">send me the prog in vb or post it</a></div>
    <div class="body">ok thanks if you can giv it and explain how it works it will fine it'll help lots of people<br />and i'll see on SDK (XP One) for the CryptoMD5 Api<br /><br />but send me or post what you did</div>
    <div class="meta">Posted on 2002-11-24 18:44:45 by Thor0Asgard</div>
   </div>
   <div class="post" id="post-67263">
    <div class="subject"><a href="#post-67263">MD5 implementation questions</a></div>
    <div class="body">Well since we are on the subject. Ill post the api-calls refering to the windows<br />crypting routine. Goto the MSDN and search for them. And probably for some<br />visual basic code you could just visit <a target="_blank" href="http://www.planetsourcecode.com/vb/">http://www.planetsourcecode.com/vb/</a><br />and search for one of the api calls. Im shure you'll find it there. Good Luck!<br />Search keyword: Crypto Api <br /><br /><strong>CRYPTIC-API-CALLS:</strong><br />CryptAcquireContext, CryptCreateHash, CryptDeriveKey, CryptDestroyHash,<br />CryptDestroyKey, CryptEncrypt, CryptDecrypt, CryptExportKey, CryptGenKey,<br />CryptGetProvParam, CryptGetUserKey, CryptHashData, CryptReleaseContext<br />CryptSignHash, CryptVerifySignature</div>
    <div class="meta">Posted on 2002-11-24 18:51:47 by natas</div>
   </div>
   <div class="post" id="post-67336">
    <div class="subject"><a href="#post-67336">MD5 implementation questions</a></div>
    <div class="body">the rudeboy has such a lib. there's an example of using it with a file on this board.</div>
    <div class="meta">Posted on 2002-11-25 06:02:33 by Hiroshimator</div>
   </div>
   <div class="post" id="post-67337">
    <div class="subject"><a href="#post-67337">MD5 implementation questions</a></div>
    <div class="body">Just a comment about :<br /><br /><br /><pre><code><br />			<br />xchg	al,ah		<br />rol	eax,16			<br />xchg	al,ah<br /><br /></code></pre><br /><br />Why not using &quot;bswap eax&quot; ?</div>
    <div class="meta">Posted on 2002-11-25 06:15:17 by Axial</div>
   </div>
   <div class="post" id="post-67339">
    <div class="subject"><a href="#post-67339">nobody answered my 1st question</a></div>
    <div class="body">here's what i want to do:<br />1 Func Produce MD5 4 dwords hash from a buffer<br />1 Func with 4 dwords hash and specific key used to produce it reteive data into a buffer<br /><br />is it possible and if how can i do please help me</div>
    <div class="meta">Posted on 2002-11-25 06:57:08 by Thor0Asgard</div>
   </div>
   <div class="post" id="post-67340">
    <div class="subject"><a href="#post-67340">MD5 implementation questions</a></div>
    <div class="body"><a target="_blank" href="http://www.asmcommunity.net/board/showthread.php?threadid=4818&amp;highlight=rudeboy">http://www.asmcommunity.net/board/showthread.php?threadid=4818&amp;highlight=rudeboy</a></div>
    <div class="meta">Posted on 2002-11-25 07:02:46 by Hiroshimator</div>
   </div>
   <div class="post" id="post-67453">
    <div class="subject"><a href="#post-67453">MD5 implementation questions</a></div>
    <div class="body">Hiro,<br />the MD5 asm algo i was talking about above was Rudeboy's, with some extra code around it to load in the file to be hashed. I know it probably could have been optimised for the latest cpu's, but it was quite a shock when we found that the windows functions were just as quick (our timings were based on hashing roughly 5000 different files across a network).</div>
    <div class="meta">Posted on 2002-11-25 16:53:15 by sluggy</div>
   </div>
   <div class="post" id="post-67516">
    <div class="subject"><a href="#post-67516">MD5 implementation questions</a></div>
    <div class="body"><a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/security/security/example_c_program__creating_an_md-5_hash_from_file_content.asp">An example</a> <br /><br />But the <a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/security/security/cryptcreatehash.asp">CryptCreateHash</a> function compatility requires <strong>Windows 95 OSR2</strong> or <strong>Internet Explorer 3.02</strong> installed...<br /><br />It is a minimum requirement and most people meet it, but it won't probably work <em>everywhere</em>. :(</div>
    <div class="meta">Posted on 2002-11-26 01:08:50 by JCP</div>
   </div>
   <div class="post" id="post-67550">
    <div class="subject"><a href="#post-67550">MD5 implementation questions</a></div>
    <div class="body"><div class="quote"><em>requires Windows 95 OSR2 or Internet Explorer 3.02 installed... It is a minimum requirement and most people meet it, but it won't probably work everywhere </em></div>You will probably find that the only person on the planet who doesn't meet these requirements is Hutch ;)</div>
    <div class="meta">Posted on 2002-11-26 04:58:36 by sluggy</div>
   </div>
  </div>
 </body>
</html>