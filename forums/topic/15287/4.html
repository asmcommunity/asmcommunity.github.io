<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>D3D Animation Support Module - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=15287" />
  <link rel="prev" href="../?id=15287&amp;page=3" />  <link rel="next" href="../?id=15287&amp;page=5" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=10">Graphics &amp; Game Development</a> &raquo; <a href="../?id=15287">D3D Animation Support Module</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=15287&amp;page=1" style="">&laquo;</a><a href="../?id=15287&amp;page=3" style="">&lt;</a><input type="hidden" name="id" value="15287" /><input type="number" name="page" min="1" max="6" step="1" value="4" onchange="this.form.submit();" /><a href="../?id=15287&amp;page=5">&gt;</a><a href="../?id=15287&amp;page=6">&raquo;</a></form>   <div class="post" id="post-122449">
    <div class="subject"><a href="#post-122449">D3D Animation Support Module</a></div>
    <div class="body">;October 22- Decided to recode object manager functions (again) this time implementing Heap-based memory<br />;                 - Support Macros were added for creating, growing and destroying HEAPS.<br />;                 - SkinMesh Heap is being created and destroyed in Main procedure,<br />;                   created before the window is created, and destroyed when we return from the MessagePump loop.<br />;                 - We also create/destroy a heap for storing all Strings in Main procedure.<br />;                 - LinkedList functions &quot;SetName&quot;, &quot;KillName&quot; and &quot;SafeRelease_LL&quot; were modified for Heap memory<br />;October 23- LinkedList functions &quot;LinkedLists_Append&quot;, &quot;AppendSibling&quot;, &quot;FindEntryByName&quot; were modified for Heap memory<br />;                 - also &quot;SafeRelease_PlayerObject&quot; , &quot;Object_LoadMeshFromXFile&quot; , &quot;SafeRelease_TexObject&quot;<br />;                 - also &quot;SafeRelease_ObjectLL&quot;<br />;                 - also &quot;AnimationNode_Load , _Destroy , _FindBone , _SetTime&quot; and lots more (I'm tired!)<br />;October 26- Have now modified most every function in the project bar one or two. Compiles!!<br />;                 - Unfortunately, I had a hdd issue today, and had to overinstall my os, so I don't have dx8 installed atm and cannot test it lol</div>
    <div class="meta">Posted on 2003-10-25 11:48:01 by Homer</div>
   </div>
   <div class="post" id="post-122489">
    <div class="subject"><a href="#post-122489">D3D Animation Support Module</a></div>
    <div class="body">I have completed implementing Heap-based memory and am ready to share the project source complete as it stands. We are back were we were before. The source still requires some debugging in the final moments but is looking good.<br />Here we go :)<br />(multiple zips)</div>
    <div class="meta">Posted on 2003-10-26 04:29:40 by Homer</div>
   </div>
   <div class="post" id="post-122490">
    <div class="subject"><a href="#post-122490">D3D Animation Support Module</a></div>
    <div class="body">Debug module</div>
    <div class="meta">Posted on 2003-10-26 04:30:19 by Homer</div>
   </div>
   <div class="post" id="post-122491">
    <div class="subject"><a href="#post-122491">D3D Animation Support Module</a></div>
    <div class="body">file contents of Include folder (doesnt include subfolders)<br /><br />*note* this aint the masm Include folder, its the Project's own..</div>
    <div class="meta">Posted on 2003-10-26 04:31:28 by Homer</div>
   </div>
   <div class="post" id="post-122492">
    <div class="subject"><a href="#post-122492">D3D Animation Support Module</a></div>
    <div class="body">Object Management module</div>
    <div class="meta">Posted on 2003-10-26 04:32:01 by Homer</div>
   </div>
   <div class="post" id="post-122493">
    <div class="subject"><a href="#post-122493">D3D Animation Support Module</a></div>
    <div class="body">SkinMesh Module</div>
    <div class="meta">Posted on 2003-10-26 04:32:31 by Homer</div>
   </div>
   <div class="post" id="post-122494">
    <div class="subject"><a href="#post-122494">D3D Animation Support Module</a></div>
    <div class="body">Terrain Module (not implemented but nonetheless...)</div>
    <div class="meta">Posted on 2003-10-26 04:33:12 by Homer</div>
   </div>
   <div class="post" id="post-122495">
    <div class="subject"><a href="#post-122495">D3D Animation Support Module</a></div>
    <div class="body">Macros Module</div>
    <div class="meta">Posted on 2003-10-26 04:33:36 by Homer</div>
   </div>
   <div class="post" id="post-122496">
    <div class="subject"><a href="#post-122496">D3D Animation Support Module</a></div>
    <div class="body">AudioEngine Module (not implemented but anyways..)</div>
    <div class="meta">Posted on 2003-10-26 04:34:20 by Homer</div>
   </div>
   <div class="post" id="post-122497">
    <div class="subject"><a href="#post-122497">D3D Animation Support Module</a></div>
    <div class="body">Camera Module</div>
    <div class="meta">Posted on 2003-10-26 04:34:41 by Homer</div>
   </div>
   <div class="post" id="post-122498">
    <div class="subject"><a href="#post-122498">D3D Animation Support Module</a></div>
    <div class="body">Let me know if I forgot anything or if you find you have missing dependancies etc :)</div>
    <div class="meta">Posted on 2003-10-26 04:35:31 by Homer</div>
   </div>
   <div class="post" id="post-122510">
    <div class="subject"><a href="#post-122510">D3D Animation Support Module</a></div>
    <div class="body">Changes made to a couple of functions (AppendSibling and FindEntryByName I think were the only ones), and all is well.<br />Basically the Animations Loader is also 100% completed, I get a bugfree and complete load. The application crashes on exit, due to I haven't cleanup up the lower object destructors yet, but I'll do that shortly.<br />In the meantime, I'll try to implement a static SkinMesh_Render function and then I'll post a complete update.</div>
    <div class="meta">Posted on 2003-10-26 08:31:33 by Homer</div>
   </div>
   <div class="post" id="post-122572">
    <div class="subject"><a href="#post-122572">D3D Animation Support Module</a></div>
    <div class="body">In case you are wondering what all the non skinmesh-related implemented code is about, we are querying the display modes of the hardware and listing them, we have a cheap multi-tiered menu system, we have a &quot;Loading&quot; screen consisting of a colorkeyed textured quad being rotated around Z (I use an image of a cd with the background colorkeyed, all you see is the spinning cd), and Scronty's Fighter.x flying about, theres other stuff but its currently disabled to aid debugging.</div>
    <div class="meta">Posted on 2003-10-27 06:13:08 by Homer</div>
   </div>
   <div class="post" id="post-122667">
    <div class="subject"><a href="#post-122667">D3D Animation Support Module</a></div>
    <div class="body">Implemented the Update and Render functions for SkinMesh module...<br />As far as I can see atm Update is performing admirably - which is less than I can say for the Render function :tongue: My next move will be to add some single-instance debug code to Render so I can figure out what it's beef is...</div>
    <div class="meta">Posted on 2003-10-28 06:03:48 by Homer</div>
   </div>
   <div class="post" id="post-122758">
    <div class="subject"><a href="#post-122758">D3D Animation Support Module</a></div>
    <div class="body">Here is the CPP version of the MeshNode_Render function, and following it is my MASM version of the same, which is not behaving !!<br />Please find a moment to examine it for obvious errors - I've been staring at this source for far too long and am probably overlooking something simple.<br /><br />void CMeshNode::Render( LPDIRECT3DDEVICE8 pd3ddevice )<br />{<br />	UINT ipattr;<br /><br />	// check if we have a skin mesh or a normal mesh<br />	if (pD3DXSkinMesh)<br />	{<br />		// draw the skin mesh<br /><br />		// draw using non indexed blending<br />		// assuming that the hardware can support the number of matrices<br /><br />		// get the bone combinations<br />		LPD3DXBONECOMBINATION abonecombination;<br />		abonecombination = (LPD3DXBONECOMBINATION)pBoneCombinationBuf-&gt;GetBufferPointer();<br />		// enable vertex blending<br />		pd3ddevice-&gt;SetRenderState( D3DRS_VERTEXBLEND, dwMaxFaceInfl - 1 );<br />		for( ipattr = 0; ipattr &lt; dwAttrCount; ipattr++ )<br />		{<br />			// set the matrices for this attribute range<br />			for( DWORD i = 0; i &lt; dwMaxFaceInfl; ++i )<br />			{<br />				DWORD matid = abonecombination.BoneId<em>;<br />				if( matid != UINT_MAX &amp;&amp; (ipattr == 0 || matid != abonecombination.BoneId<em>))<br />				{<br />					pd3ddevice-&gt;SetTransform( D3DTS_WORLDMATRIX(i), apBoneMatrix );<br />					pd3ddevice-&gt;MultiplyTransform( D3DTS_WORLDMATRIX(i), &amp;aBoneOffsetMatrix);<br />				}<br />			}<br /><br />			// check if the material is different than that of the previous attribute<br />			if( ipattr == 0 || (abonecombination.AttribId != abonecombination.AttribId))<br />			{<br />				// set the new material<br />				pd3ddevice-&gt;SetMaterial( &amp;(aMaterial.AttribId]) );<br />				pd3ddevice-&gt;SetTexture( 0, apD3DTexture.AttribId] );<br />			}<br /><br />			// render<br />			pD3DXBlendedMesh-&gt;DrawSubset( ipattr );<br />		}<br />		// rendering is finished, set the vertex blending back to disabled mode<br />		pd3ddevice-&gt;SetRenderState( D3DRS_VERTEXBLEND, 0 );<br />	}<br />	else // pD3DSkinMesh<br />	{<br />		// we don't have a skin mesh, so draw the normal mesh<br />		for( ipattr = 0; ipattr &lt; dwAttrCount; ipattr++ )<br />		{<br />			pd3ddevice-&gt;SetMaterial( &amp;(aMaterial) );<br />			pd3ddevice-&gt;SetTexture( 0, apD3DTexture );<br />			pD3DXBlendedMesh-&gt;DrawSubset( ipattr );<br />		}<br />	}<br />}<br /><br /><br /><br />and my version...<br /><br />;=================================================================================<br />MeshNode_Render PROC pThis:LPMESHNODE<br />;=================================================================================<br />local NumAttributes:DWORD<br />local ipattr:DWORD                          ;Counter for &quot;current Attribute&quot;<br />local attrid:DWORD                          ;Holds &quot;Attribute ID&quot; for current Attribute<br />local matid:DWORD                         ;Holds &quot;Matrix ID&quot;    for current Attribute<br />local abonecombination:DWORD    ;Holds pointer to an array of BoneCombination structs<br />local pMaterials:DWORD                 ;Holds pointer to array of Materials (we allocated when we loaded the mesh)<br />local pTextures:DWORD                 ;Holds pointer to array of pTextures (we allocatde when we loaded the mesh)<br />local ErrBuf[256]:BYTE                   ;Not being used<br />;=================================================================================<br />assume esi:nothing<br />.if pThis==NULL<br />    mov OkToRender,FALSE<br />    Errr CTXT(&quot;MORON tried to Render NULL MeshNode&quot;)<br />.endif<br />push esi<br />mov esi,pThis<br />assume esi:LPMESHNODE<br />;=================================================================================<br />;Check if we have a skin mesh or a normal mesh, based on whether we Generated the mesh<br />;=================================================================================<br />.if .pD3DXBlendedMesh!=0 &amp;&amp; .pBoneCombinationBuf!=0<br />                        m2m NumAttributes,.dwAttrCount             ;Fetch some values into Locals<br />                        m2m pMaterials, .pMeshMaterials<br />                        m2m pTextures,  .pMeshTextures<br /><br />		mov abonecombination , $mcall (.pBoneCombinationBuf,ID3DXBuffer_GetBufferPointer)<br /><br />;		// enable vertex blending<br />                        mov eax,.dwMaxFaceInfluence<br />                        dec eax<br />		mcall ,IDirect3DDevice8_SetRenderState, D3DRS_VERTEXBLEND, eax <br /><br /><br /><br />;                       LOOP FOR ALL SUBSETS IN THE SKIN MESH<br />                        xor ecx,ecx<br />                        mov ipattr,ecx<br />                        .while ecx&lt;NumAttributes	; for ipattr = 0; ipattr &lt; dwAttrCount; ipattr++                           <br />;	                      Set the matrices for this attribute range			<br /><br />;                                   LOOP FOR ALL INFLUENCES<br />                                    xor ecx,ecx<br />                                    .while ecx&lt;.dwMaxFaceInfluence      ;for i = 0; i &lt; dwMaxFaceInfl; ++i <br />                                                push ecx<br />                                                assume ebx:nothing<br />                                                mov ebx,abonecombination<br />                                                mov eax,ipattr<br />                                                imul eax,sizeof D3DXBONECOMBINATION<br />                                                add ebx,eax                                                         ;pointing to BONECOMBINATION<br />                                                assume ebx:ptr D3DXBONECOMBINATION<br />                                                mov ebx,.BoneId       ;BoneId is a pointer to a dword array<br />                                                assume ebx:nothing<br />                                                shl ecx,2                                                               ;BoneID's are in an array of dwords<br />                                                add ebx,ecx                                                         ;which dword? THAT one :)<br />				m2m matid , dword ptr                                 ;copy it<br /><br />                                                mov ebx,abonecombination<br />                                                mov eax,ipattr<br />                                                dec eax<br />                                                .if eax==-1<br />                                                    mov eax,3<br />                                                .endif<br />                                                shl eax,2<br />                                                add ebx,eax                                                         ;pointing to BONECOMBINATION<br />                                                mov ebx,.D3DXBONECOMBINATION.BoneId       ;BoneId is a pointer to a dword array<br />                                                add ebx,ecx                                                         ;which dword? THAT one :)<br /><br />                                                mov eax,matid<br />				.if eax != 65535 &amp;&amp; (ipattr == 0 || eax != dword ptr )<br />                                                            mov ecx,matid                                                           <br />                                                            imul ecx,sizeof D3DMATRIX<br />                                                            add ecx,.pBoneMatrix<br />                                                            add ebx,256  ; D3DTS_WORLDMATRIX = transform index + 256<br />					mcall ,IDirect3DDevice8_SetTransform,ebx, ecx<br />                                                            mov ecx,matid<br />                                                            imul ecx,sizeof D3DMATRIX<br />					mcall ,IDirect3DDevice8_MultiplyTransform,ebx, addr .pBoneOffsetMatrix<br />				.endif<br />                                                pop ecx<br />                                                inc ecx<br />			.endw<br /><br />;			// check if the material is different than that of the previous attribute<br />;                                   AKA HAS THE MATERIAL CHANGED ???<br />                                    .if ipattr==0<br />                                        jmp @F<br />                                    .endif<br />                                    assume ecx:nothing<br />                                    mov ecx,ipattr                                                            ;ecx=current attribute (counter)<br />                                    imul ecx,sizeof D3DXBONECOMBINATION              ;skip to correct BoneCombination struct<br />                                    add ecx,abonecombination                                       ;ecx =ptr to current BoneCombination<br />                                    m2m attrid, .D3DXBONECOMBINATION.AttribId   ;fetch Attribute ID of current attribute<br />                                    mov ebx,ecx<br />                                    sub ebx,sizeof D3DXBONECOMBINATION              ;ebx=ptr to LAST attribute<br />                                    mov edx,.D3DXBONECOMBINATION.AttribId<br />			.if ( ipattr == 0) || (EAX !=EDX)    ;If this is the first attribute, or if attribute has changed...<br />@@:                                        push esi<br />                                                mov ebx, pMaterials<br />                                                mov ecx,attrid<br />                                                imul ecx,sizeof D3DMATERIAL8<br />                                                add ebx,ecx<br />				mcall ,IDirect3DDevice8_SetMaterial, ebx   ;SET MATERIAL !!!<br />                                                mov ebx, pTextures<br />                                                mov ecx,attrid<br />                                                shl ecx,2<br />                                                add ebx,ecx             ;ebx=ptr to nth pTexture<br />				mcall ,IDirect3DDevice8_SetTexture, 0, dword ptr <br />                                                pop esi<br />			.endif<br />			mcall .pD3DXBlendedMesh,ID3DXBaseMesh_DrawSubset ,ipattr                           ;render<br />                                    inc ipattr<br />                                    mov ecx,ipattr<br />		.endw<br />	;	// rendering is finished, set the vertex blending back to disabled mode<br />		mcall ,IDirect3DDevice8_SetRenderState, D3DRS_VERTEXBLEND, 0 <br /><br />;=================================================================================	<br />.else               ;CASE 2 of 2 - DRAWING A NORMAL UNSKINNED MESH<br />                       xor ecx,ecx<br />                       .while ecx&lt;.dwAttrCount<br /> ; 		      push ecx<br /> ;                               mov ebx,pMaterials<br /> ;                               imul ecx,sizeof D3DMATERIAL8<br /> ;                               add ebx,ecx<br /> ; 		       mcall ,IDirect3DDevice8_SetMaterial, ebx<br /> ;                                pop ecx<br /> ;                                push ecx<br /> ;                                mov ebx,pTextures<br /> ;                                shl ecx,2<br /> ;                                add ebx,ecx<br /> ; 		       mcall ,IDirect3DDevice8_SetTexture, 0, dword ptr<br /> ;                                pop ecx<br /> ;                                push ecx<br /> ; 		       mcall .pD3DXBlendedMesh,ID3DXBaseMesh_DrawSubset, ecx<br /> ;                                pop ecx<br /> ;                                inc <br />                       .endw<br />.endif<br />pop esi<br />return S_OK<br />MeshNode_Render ENDP<br />;=================================================================================<br /><br />(please ignore the fact that I have disabled the non skinmesh Render code in that.)</div>
    <div class="meta">Posted on 2003-10-29 00:50:06 by Homer</div>
   </div>
   <div class="post" id="post-122772">
    <div class="subject"><a href="#post-122772">D3D Animation Support Module</a></div>
    <div class="body">Some minor discrepancies found in the MeshNode module, here's an update of the MeshNode module..</div>
    <div class="meta">Posted on 2003-10-29 03:07:36 by Homer</div>
   </div>
   <div class="post" id="post-122773">
    <div class="subject"><a href="#post-122773">D3D Animation Support Module</a></div>
    <div class="body">Debug module was modified (below) and so was the ObjectManager module (attachment provided)<br /><br />.data<br />LogFileHandle dd 0<br />.code<br />Debug_CreateLogFile PROC pName:DWORD<br />mov LogFileHandle,$invoke (CreateFile,pName,GENERIC_WRITE,FILE_SHARE_READ,0,CREATE_ALWAYS,0,0)<br />ret<br />Debug_CreateLogFile ENDP<br /><br />Debug_CloseLogFile PROC<br />    invoke CloseHandle,LogFileHandle<br />    ret<br />Debug_CloseLogFile ENDP<br /><br />Debug_WriteLogFile PROC pOut:DWORD<br />local cbWritten:DWORD<br />push esi<br />mov ebx,$invoke (lstrlen, pOut)<br />invoke WriteFile, LogFileHandle, pOut, ebx, addr cbWritten, NULL<br />pop esi<br />ret<br />Debug_WriteLogFile ENDP<br /><br />Debug MACRO pOut:REQ<br />invoke Debug_WriteLogFile, pOut<br />ENDM<br /><br />DebugValue MACRO pOut:REQ,pIn:REQ,xVal:REQ<br />push xVal<br />push esi<br />invoke wsprintf,pOut,pIn,xVal<br />invoke Debug_WriteLogFile,pOut<br />pop esi<br />pop xVal<br />ENDM</div>
    <div class="meta">Posted on 2003-10-29 03:10:18 by Homer</div>
   </div>
   <div class="post" id="post-122774">
    <div class="subject"><a href="#post-122774">D3D Animation Support Module</a></div>
    <div class="body">MeshNode's functions were modified to take into account that the misnamed field &quot;pBoneMatrix&quot; is NOT pointing to a Matrix, OR to an array of Matrices, it's pointing to an array of LPMATRIX (array of dword pointers to matrices)<br /><br />So we really only needed a dword array of size = (#bones) for that...<br /><br />Explanation of naming convention:<br />The field has been renamed &quot;apBoneMatrices&quot; ... the &quot;a&quot; signifies that this is an array pointer, and the pBoneMatrices indicates that the array contains LPMATRIX pointers.</div>
    <div class="meta">Posted on 2003-10-29 03:12:36 by Homer</div>
   </div>
   <div class="post" id="post-122794">
    <div class="subject"><a href="#post-122794">D3D Animation Support Module</a></div>
    <div class="body">Oh MY !! I got it to Render something !!<br />It's not exactly right, but it's a darn good start !! <br />I'm a bit tired - I'll post later.</div>
    <div class="meta">Posted on 2003-10-29 08:02:58 by Homer</div>
   </div>
   <div class="post" id="post-122813">
    <div class="subject"><a href="#post-122813">D3D Animation Support Module</a></div>
    <div class="body">Congrats, it's always good to see something on screen, correct or not!<br /><br />Sorry I haven't been more active but I've got a project of my own that's being uncooperative!<br />Once I get this project out of the way I should be able to help more.<br /><br />Maelstrom</div>
    <div class="meta">Posted on 2003-10-29 13:08:10 by Maelstrom</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=15287&amp;page=1" style="">&laquo;</a><a href="../?id=15287&amp;page=3" style="">&lt;</a><input type="hidden" name="id" value="15287" /><input type="number" name="page" min="1" max="6" step="1" value="4" onchange="this.form.submit();" /><a href="../?id=15287&amp;page=5">&gt;</a><a href="../?id=15287&amp;page=6">&raquo;</a></form>  </div>
 </body>
</html>