<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Silly C vs. ASM comparison - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=18354" />
    <link rel="next" href="../?id=18354&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=18354">Silly C vs. ASM comparison</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=18354&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=18354&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="18354" /><input type="number" name="page" min="1" max="3" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=18354&amp;page=2">&gt;</a><a href="../?id=18354&amp;page=3">&raquo;</a></form>   <div class="post" id="post-142222">
    <div class="subject"><a href="#post-142222">Silly C vs. ASM comparison</a></div>
    <div class="body">As a matter of interest, I've been writing some corresponding C (VC6) and Assembler (MASM) functions. Basically trying to replicate my Assembler design in C. Along the way I've been comparing my code with C's code by disassembling it. To those interested, I just created and disassembled the 'center' function, the one used to center a form(main window) on the desktop. At some point, I stoped using 'unsigned int' and started using 'int' believing (incorrectly) that it kind of did the same thing. Of course I know int is signed, but 'everyone' uses int instead of 'unsigned int' and who wants to declare them anyway? Anyway, the code:<pre><code>C function&#58;<br /><br />int Center&#40;int wDim, int sDim&#41;<br />&#123;<br />	return &#40;sDim / 2&#41; - &#40;wDim / 2&#41;;<br />&#125;<br /><br />Disassembled&#58;<br /><br />mov      eax,dword ptr &#91;esp+0x4&#93;<br />cdq<br />sub      eax,edx<br />mov      ecx,eax<br />mov      eax,dword ptr &#91;esp+0x8&#93;<br />cdq<br />sub      eax,edx<br />sar      ecx,1<br />sar      eax,1<br />sub      eax,ecx<br />ret<br /><br />unsigned int version&#58;<br /><br />unsigned int Center&#40;unsigned int wDim, unsigned int sDim&#41;<br />&#123;<br />	return &#40;sDim / 2&#41; - &#40;wDim / 2&#41;;<br />&#125;<br /><br />Disassembled&#58;<br /><br />mov      eax,dword ptr &#91;esp+0x4&#93;<br />mov      ecx,dword ptr &#91;esp+0x8&#93;<br />shr      ecx,1<br />sub      ecx,eax<br />mov      eax,ecx<br />ret<br /><br />MASM32 version&#58;<br /><br />mov eax, dword ptr &#91;esp+8&#93;<br />mov ecx, dword ptr &#91;esp+4&#93;<br />sub eax, ecx<br />shr eax, 1<br />ret</code></pre><br />From this, I kind of deduce that at least 1 in every 5 instructions generated from C can be eliminated/optimized. VERY big generalization, but I like it :grin:</div>
    <div class="meta">Posted on 2004-05-27 07:21:27 by SubEvil</div>
   </div>
   <div class="post" id="post-142223">
    <div class="subject"><a href="#post-142223">Silly C vs. ASM comparison</a></div>
    <div class="body">VC6 is a compiler that is now 6 years old or so?<br />Try it with a newer compiler, I'm quite sure some of them figure out that they should switch the use of ecx and eax.<br />And some can probably even find this one:<br /><br /><pre><code><br />mov eax, dword ptr &#91;esp+8&#93;<br />sub eax, dword ptr &#91;esp+4&#93;<br />shr eax, 1<br />ret<br /></code></pre><br /><br />I deduce that at least 1 in every 4 instructions generated by SubEvil can be eliminated/optimized ;)</div>
    <div class="meta">Posted on 2004-05-27 07:42:07 by Scali</div>
   </div>
   <div class="post" id="post-142227">
    <div class="subject"><a href="#post-142227">Silly C vs. ASM comparison</a></div>
    <div class="body">Damn dude, I was so impressed because I thought you wrote that code :tongue: <br /><br /><pre><code>unsigned int Center&#40;unsigned int wDim, unsigned int sDim&#41;<br />&#123;<br />   return &#40;sDim - wDim&#41; / 2;<br />&#125;<br /><br />Disassembled&#58;<br /><br />mov   eax, DWORD PTR &#91;esp - 8&#93;<br />sub   eax, DWORD PTR &#91;esp - 4&#93;<br />shr   eax, 1<br />ret</code></pre><br />Bessides ... I'm REALLY not good at optimizing ... yet (still learning!) :stupid:</div>
    <div class="meta">Posted on 2004-05-27 08:47:43 by SubEvil</div>
   </div>
   <div class="post" id="post-142229">
    <div class="subject"><a href="#post-142229">Silly C vs. ASM comparison</a></div>
    <div class="body">I tried setting  sDim = 10 and wDim = 1, and from that I deduce that the 1 in 5 instructions assembler coders are better than C compilers are usually buggy :grin:</div>
    <div class="meta">Posted on 2004-05-27 08:58:39 by Jibz</div>
   </div>
   <div class="post" id="post-142231">
    <div class="subject"><a href="#post-142231">Silly C vs. ASM comparison</a></div>
    <div class="body">I was able to eliminate 5 of those 5 instructions in my programs. ;)  Concluding that software consists of mostly empty space.</div>
    <div class="meta">Posted on 2004-05-27 09:21:33 by bitRAKE</div>
   </div>
   <div class="post" id="post-142238">
    <div class="subject"><a href="#post-142238">Silly C vs. ASM comparison</a></div>
    <div class="body">Yep, NULL and VOID :tongue:</div>
    <div class="meta">Posted on 2004-05-27 10:03:00 by Homer</div>
   </div>
   <div class="post" id="post-142288">
    <div class="subject"><a href="#post-142288">Silly C vs. ASM comparison</a></div>
    <div class="body">Sometimes (actually it happens quite often) I feel my brain consists of the same empty space :rolleyes:  NULL and VOID!</div>
    <div class="meta">Posted on 2004-05-28 01:25:02 by SubEvil</div>
   </div>
   <div class="post" id="post-142301">
    <div class="subject"><a href="#post-142301">Silly C vs. ASM comparison</a></div>
    <div class="body">Yes, if the disassembly you show is correct, VC6 has a bug.<br /><br />VC7.1 outputs the following for the routine (divide both parameters by two then subtract):<br /><br /><pre><code><br />mov eax, DWORD PTR _w$&#91;esp-4&#93;<br />mov ecx, DWORD PTR _s$&#91;esp-4&#93;<br />shr eax, 1<br />shr ecx, 1<br />sub ecx, eax<br />mov eax, ecx<br />ret 0<br /></code></pre><br /><br />It still doesn't switch the registers.</div>
    <div class="meta">Posted on 2004-05-28 06:09:29 by death</div>
   </div>
   <div class="post" id="post-142303">
    <div class="subject"><a href="#post-142303">Silly C vs. ASM comparison</a></div>
    <div class="body">Death,<br /><br />What bug are you referring to?</div>
    <div class="meta">Posted on 2004-05-28 06:59:11 by SubEvil</div>
   </div>
   <div class="post" id="post-142305">
    <div class="subject"><a href="#post-142305">Silly C vs. ASM comparison</a></div>
    <div class="body">The rounding is off.<br />-(a/2) is not the same as (-a)/2;<br />or at least, not when you do an unsigned division/shift. Then it will round the wrong way.<br />Or at least, I suppose that's what Jibz and death mean.</div>
    <div class="meta">Posted on 2004-05-28 07:30:58 by Scali</div>
   </div>
   <div class="post" id="post-142306">
    <div class="subject"><a href="#post-142306">Silly C vs. ASM comparison</a></div>
    <div class="body">Thanks Scali, yes, it was the rounding error I was referring to. I posted a better reply on <em>the other forum</em>:<br /><br /><a target="_blank" href="http://www.masmforum.com/viewtopic.php?p=21763#21757">http://www.masmforum.com/viewtopic.php?p=21763#21757</a><br /><br />I think what death was referring to was that in his original post, SubEvil pasted<br /><pre><code>mov      eax,dword ptr &#91;esp+0x4&#93;<br />mov      ecx,dword ptr &#91;esp+0x8&#93;<br />shr      ecx,1<br />sub      ecx,eax<br />mov      eax,ecx<br />ret</code></pre><br />which is missing the line 'shr eax, 1' .. either it somehow got lost in cut-n-paste, or VC6 generates faulty code (my guess would be the first).</div>
    <div class="meta">Posted on 2004-05-28 07:53:21 by Jibz</div>
   </div>
   <div class="post" id="post-142309">
    <div class="subject"><a href="#post-142309">Silly C vs. ASM comparison</a></div>
    <div class="body">My appologies ... the disassembly was incorrect! Not sure why? Probably as Jibz said, copy/paste error, I did a bit of editing to make it more readable, probably edited the line completely out!  :stupid:</div>
    <div class="meta">Posted on 2004-05-28 08:24:03 by SubEvil</div>
   </div>
   <div class="post" id="post-142310">
    <div class="subject"><a href="#post-142310">Silly C vs. ASM comparison</a></div>
    <div class="body">Remember to fix your masm32 version too ;)</div>
    <div class="meta">Posted on 2004-05-28 08:31:26 by death</div>
   </div>
   <div class="post" id="post-142311">
    <div class="subject"><a href="#post-142311">Silly C vs. ASM comparison</a></div>
    <div class="body">The fact remains that the compiler, even on this small algo, could have reversed the registers and effectively eliminated 1 instruction!<pre><code>mov      ecx,&#91;esp+4&#93;<br />mov      eax,&#91;esp+8&#93;<br />shr      eax,1<br />shr      ecx,1<br />sub      eax,ecx<br />ret</code></pre></div>
    <div class="meta">Posted on 2004-05-28 08:36:06 by SubEvil</div>
   </div>
   <div class="post" id="post-142313">
    <div class="subject"><a href="#post-142313">Silly C vs. ASM comparison</a></div>
    <div class="body">That's right, but consider that this function is likely to be inlined anyway, so I think the MOV will disappear.</div>
    <div class="meta">Posted on 2004-05-28 08:44:33 by death</div>
   </div>
   <div class="post" id="post-142314">
    <div class="subject"><a href="#post-142314">Silly C vs. ASM comparison</a></div>
    <div class="body">I don't know if there could be any reason for doing it that way.  However if you reverse the order of the parameters for the function, Visual C++ generates the shorter code -- perhaps it loads the first parameter into eax by default?<br /><br />GCC on the other hand generates the shorter version regardles of parameter ordering:<br /><br /><pre><code>_foo&#58;<br />        mov     edx, DWORD PTR &#91;esp+4&#93;<br />        mov     eax, DWORD PTR &#91;esp+8&#93;<br />        shr     edx<br />        shr     eax<br />        sub     eax, edx<br />        ret</code></pre></div>
    <div class="meta">Posted on 2004-05-28 08:51:41 by Jibz</div>
   </div>
   <div class="post" id="post-142315">
    <div class="subject"><a href="#post-142315">Silly C vs. ASM comparison</a></div>
    <div class="body">Oh, and by the way, I don't like how you say it's &quot;C&quot; generating the instructions. It's the specific implementation you are using, namely VC6.</div>
    <div class="meta">Posted on 2004-05-28 09:24:26 by death</div>
   </div>
   <div class="post" id="post-142532">
    <div class="subject"><a href="#post-142532">Silly C vs. ASM comparison</a></div>
    <div class="body">death,<br /><br />Point taken and hope I'll remember it! I should say VC6 generated! My mindset should change! Since VC6 is basically the only c compiler I use, I never test output on another compiler (my fault) so my mindset generalizes that if it's true for VC6, it must be the same for all c compilers! Sorry!</div>
    <div class="meta">Posted on 2004-05-31 04:12:43 by SubEvil</div>
   </div>
   <div class="post" id="post-142535">
    <div class="subject"><a href="#post-142535">Silly C vs. ASM comparison</a></div>
    <div class="body">Well as I already said, VC6 is now about 6 years old, compilers have improved quite a bit since.<br />If you want to take a peek at the state of compilers today, you could download the evaluation version of Intel's compiler here: <a target="_blank" href="http://www.intel.com/software/products/compilers/cwin/eval.htm.">http://www.intel.com/software/products/compilers/cwin/eval.htm.</a><br />While VS.NET 2003 is no slouch, this compiler still manages to generate code that is 10% faster than VS.NET 2003 (and that is on my Athlon, ironically :)). I'm quite sure it is the fastest C/C++ compiler available for x86 today.</div>
    <div class="meta">Posted on 2004-05-31 04:58:00 by Scali</div>
   </div>
   <div class="post" id="post-142633">
    <div class="subject"><a href="#post-142633">Silly C vs. ASM comparison</a></div>
    <div class="body">VC2003 for free, <a target="_blank" href="http://msdn.microsoft.com/visualc/vctoolkit2003/">http://msdn.microsoft.com/visualc/vctoolkit2003/</a> - you should replace your vs6 right away.</div>
    <div class="meta">Posted on 2004-06-01 11:23:22 by f0dder</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=18354&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=18354&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="18354" /><input type="number" name="page" min="1" max="3" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=18354&amp;page=2">&gt;</a><a href="../?id=18354&amp;page=3">&raquo;</a></form>  </div>
 </body>
</html>