<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Bsp Class - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=16599" />
    <link rel="next" href="../?id=16599&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=10">Graphics &amp; Game Development</a> &raquo; <a href="../?id=16599">Bsp Class</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=16599&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=16599&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="16599" /><input type="number" name="page" min="1" max="3" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=16599&amp;page=2">&gt;</a><a href="../?id=16599&amp;page=3">&raquo;</a></form>   <div class="post" id="post-129031">
    <div class="subject"><a href="#post-129031">Bsp Class</a></div>
    <div class="body">Work was begun today on my most complex and ambitious oopasm class to date.<br />The BSP Class provides all the functionality required for the Indoors Engine of a real game. I expect to use a separate terrain engine for outdoors scenes similar to the Fusion Engine. <br />It's a full-blown BSP Loader and Renderer which makes full use of the BSP Tree for Visual Surface Determination, LightMapping, HintBrushes, the whole lot. Oh yeah, it's for DirectX :)<br />I just wanted to let you guys know what I've been up to. I'll post something more concrete just as soon as I feel I have made some decent progress.<br />Have a nice day :)</div>
    <div class="meta">Posted on 2003-12-27 03:06:55 by Homer</div>
   </div>
   <div class="post" id="post-129040">
    <div class="subject"><a href="#post-129040">Bsp Class</a></div>
    <div class="body">Homer, <br /><br />I look forward to see your oopasm class :grin:</div>
    <div class="meta">Posted on 2003-12-27 04:11:17 by roticv</div>
   </div>
   <div class="post" id="post-129053">
    <div class="subject"><a href="#post-129053">Bsp Class</a></div>
    <div class="body">Good :) It's huge, the translation work is not difficult, there's just a lot of it, I'll be looking for some help to ease to workload.<br />Very early days, here's the BSP Class barely began translation, obviously initially concentrating on the Loader, theres some smaller dependant classes that will need translating too, and one or two we can do without..</div>
    <div class="meta">Posted on 2003-12-27 07:41:00 by Homer</div>
   </div>
   <div class="post" id="post-129056">
    <div class="subject"><a href="#post-129056">Bsp Class</a></div>
    <div class="body">Well I already made a mistake, I should be using OVERLAPPED File Access so I ca set the FilePointer to the appropriate offset since the Loader does not use sequential file access to read the data :( I will fix that before I go any further :(<br />I don't think it's clever to just load the whole file and then parse it. I'll do it the right way :(</div>
    <div class="meta">Posted on 2003-12-27 08:26:55 by Homer</div>
   </div>
   <div class="post" id="post-129089">
    <div class="subject"><a href="#post-129089">Bsp Class</a></div>
    <div class="body">Following a suggestion by Ultrano, I changed away from using OVERLAPPED file access to use FileMapping instead. Progress was made in the Loader to the point where we can load the Vertex, Index, Surfaces and LightMaps, and enumerate the Texture FileNames but I stopped short of loading the Textures themself, or performing gamma correction on the LightMaps. I need to now stop and write the CTexture Class before I continue. At any rate, the current code is working to that point, and has been tested as such. Any progress is good progress :)</div>
    <div class="meta">Posted on 2003-12-27 14:28:29 by Homer</div>
   </div>
   <div class="post" id="post-129129">
    <div class="subject"><a href="#post-129129">Bsp Class</a></div>
    <div class="body">More progress was made - in fact, the Loader is virtually complete.<br />All the procedures called by BSP_LOAD have been translated, with the minor exceptions outlined in the previous post.<br />After loading the test.bsp which Zabnik provided in his OpenGL-based BSP offering, my Debug LogFile contains the following:<br /><br />Found 24 Vertices<br />Found 36 Indices<br />Found 6 Surfaces<br />Found 1 Textures<br />textures/gothic_floor/q1metal7_97<br />Found 1 LightMaps<br />Found 18 Nodes<br />Found 16 Leaves<br />Found 6 LeafSurface Indices<br />Found 18 LeafBrush Indices<br />Found 24 Planes<br />Found 0 Clusters<br />Found 6 Brushes<br />Found 36 BrushesSides<br />BSP File Maps\test.bsp Read OK<br /><br />I now need to write the dependant classes CPlane, CBoundingBox, CPrimitive  and CTexture, the last one I've almost completed, the others barely started, especially CPrimitive because its big - really, REALLY big ...<br />w00t !!<br /><br />Zabnik if you read this post, please confirm the accuracy of my results since my Loader is nothing like yours, I'm actually walking the Lump Directory.</div>
    <div class="meta">Posted on 2003-12-27 23:42:08 by Homer</div>
   </div>
   <div class="post" id="post-129153">
    <div class="subject"><a href="#post-129153">test.bsp? :p</a></div>
    <div class="body">it was level.bsp not test.bsp you probaly mistmatched?<br /><br /> eh :( if i could upload my new version which loads lightmap</div>
    <div class="meta">Posted on 2003-12-28 10:54:32 by zabnik</div>
   </div>
   <div class="post" id="post-129176">
    <div class="subject"><a href="#post-129176">Bsp Class</a></div>
    <div class="body">The 53kb file test.bsp was in your first upload, zabnik.. I may have renamed it but don't recall doing so.. anyways, did you sort out your issues with gamma? The source I posted contains gamma correction code but I haven't translated it yet because I'm still trying to decide how best to handle a particular issue in the CTexture class...</div>
    <div class="meta">Posted on 2003-12-28 16:32:58 by Homer</div>
   </div>
   <div class="post" id="post-129184">
    <div class="subject"><a href="#post-129184">Bsp Class</a></div>
    <div class="body">Heya :)<br />I think I've finally decided how to deal with the issue I was having with the CTexture Class.<br />The problem involved an ambiguous part of the c++ standard template library called &quot;Map&quot;. It was used to keep a LinkedList of sorts which prevented us from loading a named texture more than once, but didn't stop us creating multiple class object instances that refer to the same texture.<br /> The solution I have decided on is to use an external procedure to create instances of Ctexture, and keep the object pointers in a LinkedList which is referenced by name. Not only does this prevent us from reloading a loaded texture, but it prevents us from creating multiple instances of a class object that refer to the same loaded texture. w00t :D<br />In order to achieve this I've decided to use my OLD LINKEDLIST SUPPORT MODULE which Scronty helped me with very early in 2003.<br /><br />Here is the proposed code, with no comments sorry.<br />I haven't even tested it out yet.<br />Attached is the LinkedList support module itself.<br /><br /><br />.data<br />TextureCacheRoot dd NULL    ;ptr to the ROOT ENTRY of a LinkedList of TextureInfo structs<br />.code<br />include LinkedList.inc              ;&lt;--- This is the LinkedList Support Module I coded ages ago<br />CachedTexture struct<br />        LO LinkedObject &lt;&gt;      ;LinkedList header supports naming and linking<br />        pCTexture dd NULL      ;Pointer to instance of CTexture Class Object<br />        Count dd NULL<br />CachedTexture ends<br /><br /><br />;The following code is used to keep a LinkedList of &quot;CachedTexture&quot; structs<br />;which in turn is used to ensure we only create ONE INSTANCE<br />;of a CTexture Class Object for a given Texture FileName.<br />;We CAN try to load a named Texture more than once,<br />;but it will only return a reference to an already existing instance.<br />;The return value is always a ptr to a CTexture object instance,<br />;and NOT an actual DX texture ptr, thats kept inside the class object.<br /><br />NewTexture proc pName:DWORD, multipleLevel:DWORD, colorKey:DWORD<br />local pCachedTexture:DWORD<br />local pCTexture:DWORD<br />        .if TextureCacheRoot<br />                invoke FindEntryByName, TextureCacheRoot, pName<br />                .if eax==NULL<br />                        mov pCachedTexture, $invoke (AddChildEntry, TextureCacheRoot,sizeof CachedTexture)<br />                        invoke NewName, pCachedTexture, pName<br />                        mov pCTexture, new CTexture<br />                        icall pCTexture, CTexture, Load, pName, multipleLevel, colorKey<br />                        mov ebx,pCachedTexture<br />                        m2m .CachedTexture.pCTexture, pCTexture<br />                        inc .CachedTexture.Count<br />                        return pCTexture<br />                .else<br />                        inc .CachedTexture.Count<br />                        return .CachedTexture.pCTexture<br />                .endif<br />        .endif<br />        mov pCachedTexture, $invoke (AddChildEntry, NULL ,sizeof CachedTexture)<br />        mov TextureCacheRoot,eax<br />        invoke NewName, pCachedTexture, pName<br />        mov pCTexture, new CTexture<br />        icall pCTexture, CTexture, Load, pName, multipleLevel, colorKey<br />        mov ebx,pCachedTexture<br />        m2m .CachedTexture.pCTexture, pCTexture<br />        inc .CachedTexture.Count<br />        return pCTexture<br />NewTexture endp</div>
    <div class="meta">Posted on 2003-12-28 18:54:16 by Homer</div>
   </div>
   <div class="post" id="post-129186">
    <div class="subject"><a href="#post-129186">Bsp Class</a></div>
    <div class="body">What all that boils down to is this:<br />we end up with ONE instance of a class object per loaded texture.<br />Therefore the Class itself can assume an instance of the object is unique, and does not need to perform any internal checking for this.<br />Similarly, the reference count for a given texture is kept outside the Class, in the LinkedList structure, and therefore the Class doesn't need to worry about that either. Finally, it means we NEVER EVER create instances of CTexture ourself, we call our NewTexture procedure, which will either return a new class object instance, or an existing one. (Polite applause.)</div>
    <div class="meta">Posted on 2003-12-28 19:11:50 by Homer</div>
   </div>
   <div class="post" id="post-129199">
    <div class="subject"><a href="#post-129199">Bsp Class</a></div>
    <div class="body">Here's the &quot;mostly complete&quot; CTexture class :)<br />Oh look, it's beer o'clock already :grin:<br />Priorities are : cold beer, then CBoundingBox, then CPrimitive.<br />After that I can finish up the BSP Loader and start on the Render code.<br />w00t :alright:</div>
    <div class="meta">Posted on 2003-12-28 20:28:45 by Homer</div>
   </div>
   <div class="post" id="post-129230">
    <div class="subject"><a href="#post-129230">Bsp Class</a></div>
    <div class="body">The above method for managing the CTexture class object instances was implemented, and the base methods of CTexture were implemented.<br />BSP_ReadTextures was completed, and BSP_ReadLightMaps was completed, and is generating lightmaps based on the given Gamma factor. <br />w00t :grin:</div>
    <div class="meta">Posted on 2003-12-29 05:19:55 by Homer</div>
   </div>
   <div class="post" id="post-129247">
    <div class="subject"><a href="#post-129247">everything at once?</a></div>
    <div class="body">Well, converting C++ source at once and then compile didnt helpt me, when i tried to render simple vertex so im doing everything by BSP file specs, and almost no c++ source, I think you got more asm programming xp than I, and I think your Loader will be more successfull than my, Good Look!:alright:<br />Oh, and thanks for Gamma-Value-Correction snippet it works fine, my tiny version:<br /><pre><code><br />   mov esi,pImageBits<br />   mov ecx,128*128*3<br />   .while ecx<br />      xor eax,eax<br />      mov al,byte ptr &#91;esi&#93;<br />      &#91;b&#93;imul eax, r_gamma<br />      .if eax &gt; 255<br />         mov byte ptr &#91;esi&#93;, 255<br />      .else <br />         mov byte ptr &#91;esi&#93;, al<br />      .endif&#91;/b&#93;<br />      add esi,1<br />      dec ecx<br />   .endw<br /></code></pre></div>
    <div class="meta">Posted on 2003-12-29 07:45:22 by zabnik</div>
   </div>
   <div class="post" id="post-129248">
    <div class="subject"><a href="#post-129248">Bsp Class</a></div>
    <div class="body">Thanks for the feedback, happy to be of assistance in some small way :)<br />Theres nothing wrong with loading the way you did, it's just not as nice.<br />Whatever works I usually say, however I'm trying to keep this translation true to the c++ on which it is based before I go screwing with it.<br />I have many years experience as a machinecoder and lowlevel programmer, but I have only about 3 years on the x86. I still learn something every day or two.<br />It's not the Loader I'm concerned about as much as the render code, but keeping it modular should help me debug down the track should that become necessary. Also, I'm comfortable with modular code for a few other reasons. OOP in asm is something relatively new to me in terms of this kind of class based implementation, however I can see the benefits from a mile away, especially when it comes to things like inheritance and overloading. I hope to get the Loader half completed in the next few days but obviously tomorrow is out because I'm going to be so rolling drunk that I don't know which way my up vector is pointing :D</div>
    <div class="meta">Posted on 2003-12-29 09:39:38 by Homer</div>
   </div>
   <div class="post" id="post-129355">
    <div class="subject"><a href="#post-129355">Bsp Class</a></div>
    <div class="body">Work continues with CBoundingBox class which is about 50% completed.<br />I'll try to avoid CPrimitive altogether.<br />That means when CBoundingBox is completed, the Loader can be completed, and it will be time to start on the Render side of the code.<br />w00t :grin:</div>
    <div class="meta">Posted on 2003-12-30 07:57:54 by Homer</div>
   </div>
   <div class="post" id="post-129356">
    <div class="subject"><a href="#post-129356">PVSs</a></div>
    <div class="body">Great! But where did u get the C++ source I want to look at it and learn something<br /><br />I got a strange thing here, im doing PVS, and when i render LEAFS it draws only 31 faces my map has 38 faces but when I add <br />BoxInFrustum,.BSP_LEAF.min_x,.BSP_LEAF.min_y,.BSP_LEAF.min_z,.BSP_LEAF.max_x,.BSP_LEAF.max_y,.BSP_LEAF.max_z<br />I see one part of map which I dont see without it, hmm soo strange.<br />And for future:<br /><pre><code><br />if&#40;!m_clusters.pBitsets || current &lt; 0&#41; return 1;<br />// Use binary math to get the 8 bit visibility set for the current cluster<br />byte visSet = m_clusters.pBitsets&#91;&#40;current*m_clusters.bytesPerCluster&#41; + &#40;test / 8&#41;&#93;;<br />// Now that we have our vector &#40;bitset&#41;, do some bit shifting to find if<br />// the &quot;test&quot; cluster is visible from the &quot;current&quot; cluster, according to the bitset.<br />int result = &#91;b&#93;visSet &amp; &#40;1 &lt;&lt; &#40;&#40;test&#41; &amp; 7&#41;&#41;;&#91;/b&#93;<br />// Return the result &#40; either 1 &#40;visible&#41; or 0 &#40;not visible&#41; &#41;<br />return &#40; result &#41;;<br /></code></pre><br />Im stuck at this one, especialy at &quot;visSet &amp; (1 &lt;&lt; ((test) &amp; 7))&quot;, can u help, C++ tries to make me confused, for its easyer to know how the BSP works than converting C source, but these BSP-tree specs are English, not my Language that I speak.</div>
    <div class="meta">Posted on 2003-12-30 08:07:16 by zabnik</div>
   </div>
   <div class="post" id="post-129358">
    <div class="subject"><a href="#post-129358">Bsp Class</a></div>
    <div class="body">visSet &amp; (1 &lt;&lt; ((test) &amp; 7))<br /><br />=<br /><br /><pre><code><br />mov eax, _test<br />and eax, 7<br />xor ecx, ecx<br />bts ecx, eax<br />and visSet, ecx<br /></code></pre></div>
    <div class="meta">Posted on 2003-12-30 08:16:29 by roticv</div>
   </div>
   <div class="post" id="post-129362">
    <div class="subject"><a href="#post-129362">Bsp Class</a></div>
    <div class="body">You can find the c++ source on which I am basing this work <a target="_blank" href="http://dxframework.sourceforge.net/doxygen/doxygen-engine-0.9.2/index.html">here</a> :)</div>
    <div class="meta">Posted on 2003-12-30 11:39:30 by Homer</div>
   </div>
   <div class="post" id="post-129387">
    <div class="subject"><a href="#post-129387">Bsp Class</a></div>
    <div class="body">Here is 80% translated CBoundingBox class.<br />Be safe and see you all next year :)</div>
    <div class="meta">Posted on 2003-12-30 22:36:56 by Homer</div>
   </div>
   <div class="post" id="post-129488">
    <div class="subject"><a href="#post-129488">Bsp Class</a></div>
    <div class="body">Day One of 2004.<br />The first dependant function in CBoundingBox was implemented, and thus BSP_ReadNodes was completed. All tested and working. BoundingBoxes for Nodes are being calculated. Therefore I am posting the BSP class source and its dependant classes source as they stand.<br /><br />Have a nice day :)</div>
    <div class="meta">Posted on 2004-01-01 04:17:14 by Homer</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=16599&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=16599&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="16599" /><input type="number" name="page" min="1" max="3" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=16599&amp;page=2">&gt;</a><a href="../?id=16599&amp;page=3">&raquo;</a></form>  </div>
 </body>
</html>