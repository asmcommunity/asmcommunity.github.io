<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Quick D3D/COM Behaviour question - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=5619" />
  <link rel="prev" href="../?id=5619&amp;page=1" />   </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=10">Graphics &amp; Game Development</a> &raquo; <a href="../?id=5619">Quick D3D/COM Behaviour question</a></p>
   <div class="post" id="post-50026">
    <div class="subject"><a href="#post-50026">Quick D3D/COM Behaviour question</a></div>
    <div class="body">I finally tracked that bug, and can now load N x-file objects, parsing them into a set of arrays, no problemo :D<br />However, I am still having some difficulties with the implementation - specifically, the texturing is not working, so I start by posting my Render code , see if you can see anything wrong with what I am doing here (apart from the fact that I am not sorting my surfaces into per-texture groups before rendering them and thus causing some texture-thrashing)...<br />If I have coded my loader and parser correctly, does this look ok to you?<br /><br />Render2 PROC lpd3dDevice:DWORD<br />    LOCAL buffer[128]:byte<br />    LOCAL ptCursor:POINT<br />    LOCAL lpMesh,NumMaterials:DWORD          ;reusable per-object variables<br /><br />    mov eax, lpd3dDevice<br />    .if eax == NULL<br />        ret<br />    .endif<br /><br />;    // Set up the cursor<br />    invoke GetCursorPos, ADDR ptCursor<br />    invoke ScreenToClient, hWindow,  ADDR ptCursor<br />    mcall ,IDirect3DDevice8_SetCursorPosition, ptCursor.x, ptCursor.y, 0<br /><br />    mcall ,IDirect3DDevice8_Clear,0, NULL,    \<br />            (D3DCLEAR_TARGET OR D3DCLEAR_ZBUFFER), 000202020h, fp1pt0, 0<br /><br />;---------------------------------------------------------------------------------<br />;*** HERE IS THE BEGINSCENE/ENDSCENE CODE !!! ***<br />;---------------------------------------------------------------------------------<br /><br />     mcall ,IDirect3DDevice8_BeginScene<br />    invoke SetupLights<br />    invoke SetupMatrices<br /><br />    mcall ,IDirect3DDevice8_SetRenderState, D3DRS_CULLMODE, D3DCULL_CCW<br />    <br />;    // Meshes are divided into subsets, one for each material. Render them in<br />;    // a loop<br /><br />    mcall ,IDirect3DDevice8_SetTexture, 0, NULL<br /><br />    mcall ,IDirect3DDevice8_SetRenderState, D3DRS_FILLMODE, D3DFILL_SOLID<br />    mcall ,IDirect3DDevice8_SetRenderState, D3DRS_LIGHTING, TRUE<br />    mcall ,IDirect3DDevice8_SetVertexShader, D3DFVF_VERTEX<br /><br />    xor ecx,ecx                     ;Loop to draw all 3D Objects<br />    .while ecx&lt;NumLoadedObjects     ;Outer Loop - Per Object<br />        push ecx                                 ;Protect ecx during the Loop<br />        push edi<br />        mcall ,IDirect3DDevice8_SetTexture, 0, 0          <br />        mov eax,sizeof My3DObject<br />        mul ecx<br />        mov edi,lpMyObjectsArray<br />        add edi,eax<br />        mov eax,My3DObject.lpMesh           ;Retrieve MeshPointer for this object<br />        mov lpMesh,eax                           ;Set local variable<br />        mov eax,My3DObject.NumMaterials     ;Retrieve #Materials in this object<br />        mov NumMaterials,eax                     ;Set local variable<br />        xor ecx,ecx        <br />        .while ecx&lt;NumMaterials                     ;Inner Loop to draw all Materials        <br />            push esi<br />            push edi<br />            push ecx                                ;Protect ecx during the Loop<br />            mov eax,sizeof MyMaterial<br />            mul ecx<br />            mov esi,My3DObject.lpMyMaterials    ;Fetch pointer to Materials buffer<br />            add esi,eax<br />            mov eax,MyMaterial.TextureIndex    ;Fetch the Material's Texture index<br />            mov TextureIndex,eax<br />            .if TextureIndex!=0<br />                invoke MessageBox,0,addr szYAY,addr szYAY,MB_OK<br />            .endif<br />            mov ecx,sizeof MyTexture                ;Now look up the MyTexture in our<br />            mul ecx                                 ;indexed MyTextures array<br />            mov esi,lpMyTexturesArray               ;so that<br />            add esi,TextureIndex                             ;we can finally set the active Texture<br />            mcall ,IDirect3DDevice8_SetTexture, 0, MyTexture.lpTexture <br />            pop ecx                                 ;Draw all surfaces in a Material<br />            push ecx<br />            mcall	, ID3DXMesh_DrawSubset, ecx   ;This is cool<br />            pop ecx<br />            pop edi<br />            pop esi<br />            dec ecx<br />        .endw<br />        pop edi<br />        pop ecx<br />        inc ecx<br />   .endw<br /><br />    mcall ,IDirect3DDevice8_EndScene<br />    mcall ,IDirect3DDevice8_Present, NULL, NULL, NULL, NULL<br />    ret<br />Render2 ENDP<br /><br /><br /><br />Ok what  u think - why are all my 3d objects being drawn with the first texture that I select? If the problem isn't here, I can turn back to the multi-object loader code. When it's working I will publish the source and an example.</div>
    <div class="meta">Posted on 2002-07-25 07:36:19 by Homer</div>
   </div>
  </div>
 </body>
</html>