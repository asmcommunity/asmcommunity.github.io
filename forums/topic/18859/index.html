<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Clock cycles measure tool - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=18859" />
    <link rel="next" href="../?id=18859&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=18859">Clock cycles measure tool</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=18859&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=18859&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="18859" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=18859&amp;page=2">&gt;</a><a href="../?id=18859&amp;page=2">&raquo;</a></form>   <div class="post" id="post-145981">
    <div class="subject"><a href="#post-145981">Clock cycles measure tool</a></div>
    <div class="body">Hi,<br /><br />  Inspired by this <a target="_blank" href="http://www.masmforum.com/viewtopic.php?t=1762&amp;postdays=0&amp;postorder=asc&amp;start=0">thread in another forum</a> , I created<br />  a <strong>Windows 2000/XP/2k3</strong> device driver that will allow<br />  user-mode programs to execute the <strong>CLI and STI instructions.</strong><br /><br />  The device driver will create an entry in the IDT for the interrupt 0EDh.<br />  If a user-mode program execute:<br /><pre><code>int 0edh</code></pre><br />  the interrupt handler will <strong>change the IOPL flag</strong> of the<br />  user-mode program to be equal 3, allowing the program to<br />  execute the <strong>IO-sensitive instructions</strong> like CLI and STI.<br /><br />  Now you can profile your code without being interrupted!<br /><br />  Guidelines:<br />  01. Always load the driver by executing the load.bat in the bin folder.<br />  02. Never execute the int 0edh instruction after you have unloaded the driver<br />        by the unload.bat (you will need to run load.bat again). <br />        If you run with after the driver was loaded and unload, you will get <br />        a beautiful BSOD :grin: <br />  03. Don't forget to execute STI if you don't want your code to freeze.<br />  04. Take care with the IN/OUT instructions, I'm not responsible<br />        for any damage.<br /><br />  To compile the source, use the MASMv8 and <br />  the <a target="_blank" href="http://www.freewebs.com/four-f/">Four-F KMD Kit</a> <br /><br />  Just to fun, if you want to freeze your system:<br /><pre><code><br />             int 0edh<br />             cli<br />             jmp $</code></pre><br /><br />Report any bugs in to this thread, please.<br /><br />Regards,<br />Opcode</div>
    <div class="meta">Posted on 2004-07-13 07:22:14 by Opcode</div>
   </div>
   <div class="post" id="post-146004">
    <div class="subject"><a href="#post-146004">Clock cycles measure tool</a></div>
    <div class="body">Sorry,<br /><br />To the load.bat execute it will need the w2k_load.exe of Sven Schereiber.<br />But the package is uncomplete.<br />It need the currect dlls (w2k_lib.dll)<br />The whole package is attached.<br />Extract it in %WINDIR%System32.<br /><br />Regards,<br />Opcode</div>
    <div class="meta">Posted on 2004-07-13 10:31:42 by Opcode</div>
   </div>
   <div class="post" id="post-146028">
    <div class="subject"><a href="#post-146028">Clock cycles measure tool</a></div>
    <div class="body">Opcode, thank you.  I liked four-f's example in his tutorial (#2?) where he used IN/OUT privlaged instructions but this is much more &quot;intresting&quot; to say the least, lot easier to comprehend aswell.  Thanks for your work.</div>
    <div class="meta">Posted on 2004-07-13 16:54:43 by archphase</div>
   </div>
   <div class="post" id="post-146036">
    <div class="subject"><a href="#post-146036">Clock cycles measure tool</a></div>
    <div class="body"><div class="quote"><br />Opcode, thank you.  I liked four-f's example in his tutorial (#2?) where he used IN/OUT privlaged instructions but this is much more &quot;intresting&quot; to say the least, lot easier to comprehend aswell.  Thanks for your work. </div><br /><br /> yes thank you Opcode.</div>
    <div class="meta">Posted on 2004-07-13 20:09:15 by mark_larson</div>
   </div>
   <div class="post" id="post-146056">
    <div class="subject"><a href="#post-146056">Clock cycles measure tool</a></div>
    <div class="body">I'm glad to see that the device driver is useful to someone. :grin: <br /><br />Regards,<br />Opcode</div>
    <div class="meta">Posted on 2004-07-14 06:45:45 by Opcode</div>
   </div>
   <div class="post" id="post-148272">
    <div class="subject"><a href="#post-148272">Clock cycles measure tool</a></div>
    <div class="body">Great stuff!! But disabling interrupt in winnt/2k for a longer time is dangerous, isn't it?</div>
    <div class="meta">Posted on 2004-08-17 22:52:26 by optimus</div>
   </div>
   <div class="post" id="post-148280">
    <div class="subject"><a href="#post-148280">Clock cycles measure tool</a></div>
    <div class="body">I hope not :grin: <br /><br />But I avoid to call the interrupt when my box is connect to some network<br />or while is executing some important hard disk operation .<br /><br />If you find any bug or problem,  send  me a PM.<br /><br />Regards,<br />Opcode</div>
    <div class="meta">Posted on 2004-08-18 06:28:47 by Opcode</div>
   </div>
   <div class="post" id="post-150671">
    <div class="subject"><a href="#post-150671">Zip Corruption</a></div>
    <div class="body"><div class="quote">Sorry,<br /><br />To the load.bat execute it will need the w2k_load.exe of Sven Schereiber.<br />But the package is uncomplete.<br />It need the currect dlls (w2k_lib.dll)<br />The whole package is attached.<br />Extract it in %WINDIR%System32.<br /><br />Regards,<br />Opcode</div><br /><br />Howdy Opcode, your download zip is corrupt :(<br /><br />MATRIX</div>
    <div class="meta">Posted on 2004-09-29 19:08:27 by &gt;Matrix&lt;</div>
   </div>
   <div class="post" id="post-150738">
    <div class="subject"><a href="#post-150738">Clock cycles measure tool</a></div>
    <div class="body">Hi &gt;Matrix&lt; ,<br /><br />   This iopl_module.zip was fixed. Make sure the MD5sum of your zip is<br />   75d6a89eb25bd13ed31e5c6d272a81d0.<br /><br />   The w2k_internals.zip you can get the original at    http://www.orgon.com/w2k_internals/w2k_internals.zip<br /><br />   Please, notify me of any question.<br />   <br />   Regards,<br />   Opcode</div>
    <div class="meta">Posted on 2004-09-30 22:14:15 by Opcode</div>
   </div>
   <div class="post" id="post-150751">
    <div class="subject"><a href="#post-150751">ZIP files differ</a></div>
    <div class="body">Thnx,<br />but there are weird differences between the two files, you might wanna take a look.<br /><br />the first one is an inserted dash<br /><br />MATRIX</div>
    <div class="meta">Posted on 2004-10-01 05:44:46 by &gt;Matrix&lt;</div>
   </div>
   <div class="post" id="post-150793">
    <div class="subject"><a href="#post-150793">Clock cycles measure tool</a></div>
    <div class="body">The w2k_internals.zip attachment was updated.<br /><br />Regards,<br />Opcode</div>
    <div class="meta">Posted on 2004-10-01 23:55:16 by Opcode</div>
   </div>
   <div class="post" id="post-152922">
    <div class="subject"><a href="#post-152922">Clock cycles measure tool</a></div>
    <div class="body">its not loading on my windows xp.<br />anyways to fix this?</div>
    <div class="meta">Posted on 2004-11-14 15:40:05 by pwn</div>
   </div>
   <div class="post" id="post-152923">
    <div class="subject"><a href="#post-152923">Clock cycles measure tool</a></div>
    <div class="body">What is the error message after running the load.bat file ?</div>
    <div class="meta">Posted on 2004-11-14 15:48:49 by Opcode</div>
   </div>
   <div class="post" id="post-152930">
    <div class="subject"><a href="#post-152930">Clock cycles measure tool</a></div>
    <div class="body">Loading &quot;C:\masm32\code\w2k_internals&quot; ... ERROR<br />i used the w2k_load.exe from the complete package.<br /><br />but now i downloaded the iopl module too, and ran load.bat from there and it worked. so my bad. just thought it would be inside the w2k_internals package..</div>
    <div class="meta">Posted on 2004-11-14 19:16:59 by pwn</div>
   </div>
   <div class="post" id="post-152931">
    <div class="subject"><a href="#post-152931">Clock cycles measure tool</a></div>
    <div class="body">No problem  :alright: <br /><br />Regards,<br />Opcode</div>
    <div class="meta">Posted on 2004-11-14 19:28:19 by Opcode</div>
   </div>
   <div class="post" id="post-152961">
    <div class="subject"><a href="#post-152961">Clock cycles measure tool</a></div>
    <div class="body">ok im using the driver and getting bsod when i try to access memory.<br />this is very peculiar because when i push and pop it has no problems.<br />other then that it works good just for usual opcodes that dont access memory.<br />Im using Windows XP Pro + hotfixes (with no service packs)<br />I successfuly load the driver with load.bat and get it working.<br />crashes are quite nasty usually resulting in file corruption and somtimes total file loss.<br />the following program crashes on my box:<br /><br /><pre><code><br />.586<br />.model flat, stdcall<br />.data<br />temp dd 0<br /><br />.code<br />_start&#58;<br /><br />int 0edh<br />mov edx, offset temp<br />cli<br />mov &#91;edx&#93;, eax<br />sti<br />ret<br /><br />end _start<br /></code></pre></div>
    <div class="meta">Posted on 2004-11-15 03:43:50 by pwn</div>
   </div>
   <div class="post" id="post-152962">
    <div class="subject"><a href="#post-152962">Clock cycles measure tool</a></div>
    <div class="body">this version, without the cli and sti, will work fine.<br />im not a memory wiz, but im assuming it needs interrupts to map the offset address, to actual memory address where data is. because i know different process run under 401000 memory address, but the memory mapper maps data to actual process memory by the process context.<br />anyways that pretty much defeats the point of benchmarking with interrupts disabled (cli) if you cant access memory at all. its going to be a pretty hard task to do anything.<br /><br /><pre><code><br />int 0edh<br />mov edx, offset temp<br />mov &#91;edx&#93;, eax<br />ret</code></pre></div>
    <div class="meta">Posted on 2004-11-15 03:51:45 by pwn</div>
   </div>
   <div class="post" id="post-152986">
    <div class="subject"><a href="#post-152986">Clock cycles measure tool</a></div>
    <div class="body">Hi pwn,<br /><br />You are currect !<br />The data section is initially not present in the memory.<br />When your code try to access it, it will trigger a page fault exception<br />that is handled by the KiTrap0E function.<br /><br />The solution is simple, access your variables before the beggining<br />of the profile code.<br /><br />This code will FAIL:<br /><br /><pre><code><br /><br />;==========<br />;	DATA<br />;==========<br />.data<br /> resultstr	dd 0<br /> test1          dd 0aabbccddh<br /> test2          dd 0deadbeefh<br /><br />;==========<br />;	CODE<br />;==========<br />.code<br />start&#58;<br /><br />    int 0edh<br /><br />    nop<br />    cli<br />    rdtsc<br />    mov ebx, eax<br />    rdtsc<br /><br />    mov edx, test1        ; &lt;-- Page fault here<br />    mov edx, test2<br />    sub eax, ebx<br />    sti<br />    nop<br /><br />    invoke wsprintf, addr resultstr, $CTA0&#40;&quot;%08Xh clock cycles&quot;&#41;, eax<br />    invoke MessageBox, NULL, ecx, $CTA0&#40;&quot;Opcode IOPL hack&quot;&#41;, MB_OK<br /><br />    invoke ExitProcess, 0<br />end start</code></pre><br /><br />And this code will work without problems:<br /><pre><code><br />;==========<br />;	DATA<br />;==========<br />.data<br /> resultstr	dd 0<br /> test1          dd 0aabbccddh<br /> test2          dd 0deadbeefh<br /><br />;===========<br />;	CODE<br />;===========<br />.code<br />start&#58;<br /><br />    <br />    mov edx, test1  ; Accessing the data section before trying to use it<br />    mov edx, test2  ; This will make the memory present<br /><br />    int 0edh<br /><br />    nop<br />    cli<br />    rdtsc<br />    mov ebx, eax<br />    rdtsc<br />    mov edx, test1<br />    mov edx, test2<br />    sub eax, ebx<br />    sti<br />    nop<br /><br />    invoke wsprintf, addr resultstr, $CTA0&#40;&quot;%08Xh clock cycles&quot;&#41;, eax<br />    invoke MessageBox, NULL, ecx, $CTA0&#40;&quot;Opcode IOPL hack&quot;&#41;, MB_OK<br /><br />    invoke ExitProcess, 0<br />end start	</code></pre><br /><br />Thanks for pointing this problem.<br /><br />Regards,<br />Opcode</div>
    <div class="meta">Posted on 2004-11-15 09:44:44 by Opcode</div>
   </div>
   <div class="post" id="post-153838">
    <div class="subject"><a href="#post-153838">Clock cycles measure tool</a></div>
    <div class="body">The source and binary can be downloaded here:<br />http://www.bitrake.com/phpBB2/viewtopic.php?p=447#447<br /><br />Regards,<br />Opcode</div>
    <div class="meta">Posted on 2004-12-07 07:17:22 by Opcode</div>
   </div>
   <div class="post" id="post-153897">
    <div class="subject"><a href="#post-153897">Clock cycles measure tool</a></div>
    <div class="body">Is there a reason that you wrote a driver to do this rather than using the ProcessUserModeIOPL(16) PROCESSINFOCLASS with NtSetInformationProcess?  The primary difference would seem to be that the approach you are using does not require SeTcbPrivilege, though I may be missing something.</div>
    <div class="meta">Posted on 2004-12-08 08:32:34 by nohaven</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=18859&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=18859&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="18859" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=18859&amp;page=2">&gt;</a><a href="../?id=18859&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>