<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>GetDIBits under 9x and XP, i don't have a clue... - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=21603" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=21603">GetDIBits under 9x and XP, i don't have a clue...</a></p>
   <div class="post" id="post-163101">
    <div class="subject"><a href="#post-163101">GetDIBits under 9x and XP, i don't have a clue...</a></div>
    <div class="body">hi all,<br /><br />i&#39;m having some problems with the GetDIBits function.<br />i wrote this code that saves the pixels from a rectangle from my window as a bmp file, and this all works well under win98 and win98se but under xp professional when i open the bmp file it is full with black pixel a contrary under win9x i&#39;ve got the picture that i wanted to save. so there must be something that i didn&#39;t quiet set up that is needed under xp i just don&#39;t know what. here is the code:<br /><br /><pre><code><br />case IDM_SAVE: // Menu: File -&gt; Save as BMP<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HDC hdc;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD dwBytesWritten,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dwBmpWidth=dParams.sigRect.right-dParams.sigRect.left-3-1,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dwBmpHeight=dParams.sigRect.bottom-dParams.sigRect.top-3; // 3 pixels for the borders<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // the next 2 structures are composing together the header of a bmp file<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BITMAPFILEHEADER bf={(short)(&#39;B&#39;|(&#39;M&#39;&lt;&lt;8)),0,0,0,sizeof(BITMAPFILEHEADER)+sizeof(BITMAPINFOHEADER)};<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BITMAPINFOHEADER bh={sizeof(BITMAPINFOHEADER),dwBmpWidth,dwBmpHeight,1,24,0,0,0,0,0,0};<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BITMAPINFO bn;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RECT rc;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HBITMAP hbmp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BYTE* buffer;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HANDLE hFileBmp;<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // create a file and write the bmp header into it<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wsprintf(str,&quot;capture%d.bmp&quot;,dwBmpsCaptured++);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hFileBmp=CreateFile(str,GENERIC_WRITE,0,NULL,CREATE_ALWAYS,FILE_ATTRIBUTE_ARCHIVE,NULL);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WriteFile(hFileBmp,&amp;bf,sizeof(BITMAPFILEHEADER),&amp;dwBytesWritten,NULL);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WriteFile(hFileBmp,&amp;bh,sizeof(BITMAPINFOHEADER),&amp;dwBytesWritten,NULL);<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // prepare the bitmap for further operations<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GetClientRect(hwnd,&amp;rc);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hdc=GetDC(hwnd);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hbmp=CreateCompatibleBitmap(hdc,rc.right,rc.bottom);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buffer=(BYTE*)LocalAlloc(LMEM_FIXED,3*rc.right);<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // setup properties for the bitmap from we want to retrieve the scanlines<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ZeroMemory(&amp;bn,sizeof(BITMAPINFO));<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bn.bmiHeader.biSize=sizeof(BITMAPINFOHEADER);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bn.bmiHeader.biWidth=rc.right;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bn.bmiHeader.biHeight=rc.bottom;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bn.bmiHeader.biPlanes=1;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bn.bmiHeader.biBitCount=24;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bn.bmiHeader.biCompression=BI_RGB;<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // read the scanlines one by one into the buffer and write out the appropriate part of the buffer into the file<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for (i=rc.bottom-dParams.sigRect.bottom+2; i&lt;dwBmpHeight+rc.bottom-dParams.sigRect.bottom+2; i++)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  // read the pixels into the buffer where 3 bytes in the buffer represents 1 pixel (aka the picture is a 24bit bmp file)<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  GetDIBits(hdc,hbmp,i,1,buffer,&amp;bn,DIB_RGB_COLORS);<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  // write the part of the scanline (which actually represents the picture) to the file<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  WriteFile(hFileBmp,&amp;buffer[(dParams.sigRect.left+2)*3],dwBmpWidth*3,&amp;dwBytesWritten,NULL);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // better clean up this mess i&#39;ve just made :)<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CloseHandle(hFileBmp);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LocalFree(buffer);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DeleteObject(hbmp);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ReleaseDC(hwnd,hdc);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } break;</code></pre><br /><br />i know this is c, but i assume if someone knows win32asm then (s)he also must know c too.<br /><br />so i don&#39;t know what i could do wrong, first i thought that because of the source bitmap (that i create with CreateCompatibleBitmap) is 32bits (i checked this with GetObject) so i must convert it somehow to 24 bits, but then i learned that GetDIBits is doing that conversion for me. oh and just in case dParams.sigRect is the RECT that contains the co-ordinates of the rectangle that i want to save as a BMP file.<br /><br />so the thing is when i debug the code &amp; i execute the GetDIBits(hdc,hbmp,... line it returns 1 in eax, which means that the function is successfull by the win32 documentation, the only catch is that it doesn&#39;t fills my buffer with the color bits but rather fills it with zeros. and this is the problem. oh and this particular line under 9x works as i would expect, i checked that too.<br /><br />if anyone knows why is this please, reply, i would really appreciate it, thanx 4 listening,,, </div>
    <div class="meta">Posted on 2005-08-11 03:19:32 by berril</div>
   </div>
   <div class="post" id="post-163107">
    <div class="subject"><a href="#post-163107">Re: GetDIBits under 9x and XP, i don't have a clue...</a></div>
    <div class="body">yeah, had my troubles with that api, too.<br /><br /><div class="quote">the only catch is that it doesn&#39;t fills my buffer with the color bits but rather fills it with zeros. and this is the problem. </div><br /><br />the nice part about 24-bit bitmaps is that they do not require a color table as the raw bitmap data is directly interpreted as rgbs (3 bytes -&gt; 24 bit).<br /> :mad: unfortunately i&#39;m at work for some more hours, but i got a file called &quot;bmp.inc&quot; back at home that<br />might be interesting for you. lets see later on...<br />Dominik</div>
    <div class="meta">Posted on 2005-08-11 06:01:20 by Dom</div>
   </div>
  </div>
 </body>
</html>