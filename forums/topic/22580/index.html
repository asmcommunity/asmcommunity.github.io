<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Updated Frustum code - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=22580" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=10">Graphics &amp; Game Development</a> &raquo; <a href="../?id=22580">Updated Frustum code</a></p>
   <div class="post" id="post-169366">
    <div class="subject"><a href="#post-169366">Updated Frustum code</a></div>
    <div class="body">I reworked my old Frustum code for the terrain engine project.<br />This code is much faster than Microsoft&#39;s method.<br />They calculate the frustum vertices, then use them to obtain planes.<br />This version extracts planes directly from the combined view/proj matrix.<br />You can obtain planes AND/OR vertices with this version, depending apon your project&#39;s requirements.<br /><br />If you can see any way to further optimize this code please tell me !!<br /><br /><pre><code><br />;The following code is used to extract the &quot;view frustum&quot;<br />;from the current view and proj matrices<br />;<br />;UpdateFrustum is your common entrypoint procedure<br />;Its parameters are:<br />;bWantVertices - Want the frustum bounding vertices? True or False<br />;bWantPlanes - Want the frustum bounding planes? True or False<br />;pmatView - Pointer to the current View matrix<br />;pmatProj - Pointer to the current Projection matrix<br />;pOutputVertices - Pointer to 8 x Vec3 output<br />;pOutputPlanes - Pointer to 6 x Plane output (see Frustum struct)<br />;<br /><br /><br />;We describe a Plane with a Normal and Distance<br />Plane struct<br />   vNormal Vec3 &lt;&gt;<br />   fDistance REAL4 ?<br />Plane ends<br /><br />; We describe a Frustum as SIX PLANES<br />Frustum struct<br />	plLeft		Plane &lt;&gt;<br />	plRight		Plane &lt;&gt;<br />	plTop		Plane &lt;&gt;<br />	plBottom	Plane &lt;&gt;<br />	plNear		Plane &lt;&gt;<br />	plFar		Plane &lt;&gt;<br />Frustum ends<br /><br />;Just some helper macros for simple vector math<br />vecadd macro pvout:req, pv1in:req, pv2in:req<br />	fld  pv1in<br />	fadd pv2in<br />	fstp pvout<br />endm<br /><br />vecsub macro pvout:req, pv1in:req, pv2in:req<br />	fld  pv1in<br />	fsub pv2in<br />	fstp pvout<br />endm<br /><br />vecmul macro pvout:req, pv1in:req, pv2in:req<br />	fld  pv1in<br />	fmul pv2in<br />	fstp pvout<br />endm<br /><br /><br />.data<br />;This describes a UNIT CUBE which we will<br />;deform to calculate frustum corner vertices<br />	FrustumUn	Vec3 &lt;-1.0f, -1.0f,  0.0f&gt;<br />				Vec3 &lt; 1.0f, -1.0f,  0.0f&gt;<br />				Vec3 &lt;-1.0f,  1.0f,  0.0f&gt;<br />				Vec3 &lt; 1.0f,  1.0f,  0.0f&gt;<br />				Vec3 &lt;-1.0f, -1.0f,  1.0f&gt;<br />				Vec3 &lt; 1.0f, -1.0f,  1.0f&gt;<br />				Vec3 &lt;-1.0f,  1.0f,  1.0f&gt;<br />				Vec3 &lt; 1.0f,  1.0f,  1.0f&gt;<br /><br /><br />.code<br />Vec3Normalize proc uses esi,pVec<br />LOCAL fdenom<br />	mov esi,pVec<br />	assume esi:ptr Vec3<br />	<br />	;Calculate denominator<br />	fld1<br />	fld  .X<br />	fmul .X<br />	fld  .Y<br />	fmul .Y<br />	fld  .Z<br />	fmul .Z<br />	fadd<br />	fadd<br />	fdiv<br />	fstp fdenom<br />	;Multiply vector components by denom<br />	vecmul .X, .X, fdenom<br />	vecmul .Y, .Y, fdenom<br />	vecmul .Z, .Z, fdenom<br />	<br />	assume esi:nothing<br />	ret<br />Vec3Normalize endp<br /><br />;This procedure extracts the PLANES of the view frustum<br />;from the current Projection and View matrices<br />ExtractFrustumPlanesFromView proc uses edi esi, pmatComb, pFrustPlanes<br /><br />mov edi,pFrustPlanes<br />mov esi,pmatComb<br />assume edi:ptr Frustum<br />assume esi:ptr D3DXMATRIX<br /><br />;Get Left clipping plane<br />vecadd .plLeft.vNormal.X, .m03, .m00<br />vecadd .plLeft.vNormal.Y, .m13, .m10<br />vecadd .plLeft.vNormal.Z, .m23, .m20<br />vecadd .plLeft.fDistance, .m33, .m30<br /><br />;Get Right clipping plane <br />vecsub .plRight.vNormal.X, .m03, .m00<br />vecsub .plRight.vNormal.Y, .m13, .m10<br />vecsub .plRight.vNormal.Z, .m23, .m20<br />vecsub .plRight.fDistance, .m33, .m30<br /><br />;Get Top clipping plane <br />vecsub .plTop.vNormal.X, .m03, .m01<br />vecsub .plTop.vNormal.Y, .m13, .m11<br />vecsub .plTop.vNormal.Z, .m23, .m21<br />vecsub .plTop.fDistance, .m33, .m31<br /><br />;Get Bottom clipping plane <br />vecadd .plBottom.vNormal.X, .m03, .m01<br />vecadd .plBottom.vNormal.Y, .m13, .m11<br />vecadd .plBottom.vNormal.Z, .m23, .m21<br />vecadd .plBottom.fDistance, .m33, .m31<br /><br />;Get Near clipping plane <br />m2m .plNear.vNormal.X, .m02<br />m2m .plNear.vNormal.Y, .m12<br />m2m .plNear.vNormal.Z, .m22<br />m2m .plNear.fDistance, .m32<br /><br />;Get Far clipping plane <br />vecsub .plFar.vNormal.X, .m03, .m02<br />vecsub .plFar.vNormal.Y, .m13, .m12<br />vecsub .plFar.vNormal.Z, .m23, .m22<br />vecsub .plFar.fDistance, .m33, .m32<br /><br />;Normalize plane normals<br />invoke Vec3Normalize, addr .plLeft.vNormal<br />invoke Vec3Normalize, addr .plRight.vNormal<br />invoke Vec3Normalize, addr .plTop.vNormal<br />invoke Vec3Normalize, addr .plBottom.vNormal<br />invoke Vec3Normalize, addr .plNear.vNormal<br />invoke Vec3Normalize, addr .plFar.vNormal<br /><br />assume edi:nothing<br />assume esi:nothing<br />ret<br />ExtractFrustumPlanesFromView endp<br /><br />;This procedure extracts the BOUNDING VERTICES of the view frustrum<br />;by deforming a Unit Cube with the Inverse of the Combined View and Proj matrices<br />ExtractFrustumVerticesFromView proc uses esi edi ecx,pInverseComb,pOutputVertices<br />	;Transform the untransformed boundingbox of the Frustrum <br />	;by the inverse view/projection<br />	xor ecx,ecx<br />	lea esi,FrustumUn<br />	mov edi,pOutputVertices<br />	.while ecx&lt;8<br />		push ecx<br />		invoke D3DXVec3TransformCoord, edi,esi, pInverseComb<br />		add esi,sizeof Vec3<br />		add edi,sizeof Vec3<br />		pop ecx<br />		inc ecx<br />	.endw<br />	ret<br />ExtractFrustumVerticesFromView endp<br /><br />UpdateFrustum proc bWantVertices,bWantPlanes, pmatView,pmatProj,pOutputVertices, pOutputPlanes<br />LOCAL matComb:D3DXMATRIX<br />LOCAL imatComb:D3DXMATRIX<br /><br />	;Calculate the combined projection/view matrix<br />	invoke D3DXMatrixMultiply,addr matComb, pmatView, pmatProj<br />	.if bWantVertices==TRUE<br />		;In order to deform the unit cube for obtaining frustum vertices,<br />		;we need the INVERSE of the aforementioned combined matrix<br />		invoke D3DXMatrixInverse, addr imatComb,NULL, addr matComb<br />		invoke ExtractFrustumVerticesFromView,addr imatComb,pOutputVertices<br />	.endif<br />	.if bWantPlanes==TRUE<br />		invoke ExtractFrustumPlanesFromView,addr matComb, pOutputPlanes<br />	.endif<br />	<br />	ret<br /><br />UpdateFrustum endp<br /></code></pre><br /></div>
    <div class="meta">Posted on 2006-01-06 22:31:34 by Homer</div>
   </div>
   <div class="post" id="post-169367">
    <div class="subject"><a href="#post-169367">Re: Updated Frustum code</a></div>
    <div class="body">Nice code.<br />Using the FPU there&#39;s really no hope for optimization :D<br /><br />I rewrote one of the functions using SIMD instructions. I noticed that if you rotate the matrix data you can make the job extremely parallel.<br /><br /><pre><code><br />;;SSE2 then SSE3 for the normalize code<br />ExtractFrustumPlanesFromView:<br />;;ebp+16 = pmatComb<br />;;ebp+20 = pFrustPlanes<br />;;trash all xmm0-6 wOOt! for xmm7<br />;;ASSUMING edi&#39;s address is 16byte aligned<br />push ebp<br />push esi<br />push edi<br />mov ebp,esp<br />mov esi,<br />mov edi,<br />sub esp,16<br />and esp,0FFFFFFF0h ;; 16byte align the stack<br />;;make a copy of the matrix rotated 90degrees for sse<br />;;16 pushes<br />push  ;;col 0<br />push <br />push <br />push &nbsp; &nbsp; &nbsp; <br />push  ;;col 1<br />push <br />push <br />push <br />push  ;;col 2<br />push <br />push <br />push <br />push  ;;col 3<br />push <br />push <br />push <br />;;|esp col3 col2 col1 col0|<br />movdqa xmm3,;;col 3<br />movdqa xmm2,;;col 2<br />movdqa xmm1,;;col 1<br />movdqa xmm0,;;col 0<br />;;calc and store left and right clip planes<br />movdqa xmm4,xmm3<br />movdqa xmm5,xmm3<br />movdqa xmm6,xmm0<br />addps xmm4,xmm6<br />subps xmm5,xmm6<br />;;if edi is 16byte aligned use dqA instead<br />movdqa ,xmm4<br />movdqa ,xmm5<br />;;calc and store top and bottom<br />movdqa xmm4,xmm3<br />movdqa xmm5,xmm3<br />movdqa xmm6,xmm1<br />subps xmm4,xmm6<br />addps xmm4,xmm6<br />movdqa ,xmm4<br />movdqa ,xmm5<br />;;near and far<br />movdqa ,xmm2;;near<br />subps xmm3,xmm2<br />movdqa ,xmm3<br />;;;NORMALIZING time<br />;;;SSE3 haddps and movsldup will be used<br />movdqa xmm6,;;data to mask out dist<br />;;normals for right left and top<br />LABEL1: ;;for laziness<br />movdqa xmm0,<br />movdqa xmm1,<br />movdqa xmm2,<br />andps xmm0,xmm6 ;;no more dst<br />andps xmm1,xmm6<br />andps xmm2,xmm6<br />movdqa xmm3,xmm0 ;;copy<br />movdqa xmm4,xmm1<br />movdqa xmm5,xmm2<br />mulps xmm0,xmm0 ;;x^2 y^2 z^2<br />mulps xmm1,xmm1<br />mulps xmm2,xmm2<br />haddps xmm0,xmm0 ;;x^2+y^2+z^2<br />haddps xmm1,xmm1<br />haddps xmm2,xmm2<br />haddps xmm0,xmm0<br />haddps xmm1,xmm1<br />haddps xmm2,xmm2<br />rsqrtss xmm0,xmm0 ;;1/sqrt<br />rsqrtss xmm1,xmm1<br />rsqrtss xmm2,xmm2<br />movsldup xmm0,xmm0 ;;1/sqrt 1/sqrt 1/sqrt 1/sqrt<br />movsldup xmm1,xmm1<br />movsldup xmm2,xmm2<br />movlhps xmm0,xmm0<br />movlhps xmm1,xmm1<br />movlhps xmm2,xmm2<br />mulps xmm3,xmm0 ;;normalize<br />mulps xmm4,xmm1<br />mulps xmm5,xmm2<br />mov eax, ;; save dists<br />mov ecx,<br />mov edx,<br />movdqa ,xmm3<br />movdqa ,xmm4<br />movdqa ,xmm5<br />mov ,eax<br />mov ,ecx<br />mov ,edx<br />;;NORMALIZE bottom near and far planes<br />;;I&#39;m not redoing all these indexes into edi<br />;;Time for a hack job!<br />add esp,1 ;;I aligned it before<br />add edi,48<br />test esp,1<br />jnz LABEL1<br />mov esp,ebp<br />pop edi<br />pop esi<br />pop ebp<br />ret 8<br />;;data<br />align 16<br />NoDist dd -1,-1,-1,0<br /></code></pre><br /><br />sorry for the total lack of formating I wrote it in notepad (current time 4:47AM)<br />at least there&#39;s a few comments </div>
    <div class="meta">Posted on 2006-01-07 03:47:45 by r22</div>
   </div>
  </div>
 </body>
</html>