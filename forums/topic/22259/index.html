<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>How to generate a shorter code-----about SUB instruction - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=22259" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=22259">How to generate a shorter code-----about SUB instruction</a></p>
   <div class="post" id="post-167257">
    <div class="subject"><a href="#post-167257">How to generate a shorter code-----about SUB instruction</a></div>
    <div class="body">codes as follows:<br />------------------------------------------------------------------------------------<br />&nbsp;  Jmp CodeStart<br />CRITICALBEGIN:<br />&nbsp; &nbsp; HashData1&nbsp; &nbsp; dd&nbsp; &nbsp; 05d56345ch<br />&nbsp; &nbsp; HashData2&nbsp; &nbsp; dd&nbsp; &nbsp; ????<br />&nbsp; &nbsp; HashData3&nbsp; &nbsp; dd&nbsp; &nbsp; ????<br />&nbsp; &nbsp; ......<br />CRITICALEND:<br />&nbsp;  ......<br />CodeStart:<br />&nbsp; &nbsp; ;assume ESI has pointed to CRITICALEND and (CRITICALEND - CRITICALBEGIN) = 5d<br />&nbsp; &nbsp; ;--------------------------------------------------------------------------------<br />&nbsp; &nbsp; sub esi, (CRITICALEND - CRITICALBEGIN);&nbsp; &nbsp; &nbsp;  81 ee 5d 00 00 00<br />&nbsp; &nbsp; sub esi, low(CRITICALEND - CRITICALBEGIN);&nbsp; 81 ee 5d 00 00 00<br />&nbsp; &nbsp; sub esi, byte(CRITICALEND - CRITICALBEGIN); 81 ee 5e(?) 00 00 00<br />&nbsp; &nbsp; sub esi, 05dh;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 83 ee 5d<br />&nbsp; &nbsp; ;----------------------------------------------------------------------------------<br /><br />&nbsp; question1: only the codes generated by the fourth are what i want, but i don&#39;t want to sacrifice the advantage of auto-counting the length of CRITICAL data section by pre-compiler. how can i do it? ( to use &#39;add esi, (CRITICALBEGIN - CRITICALEND)&#39; also generates 6 bytes)<br /><br />&nbsp; question2: why the codes of &#39;sub esi, byte(CRITICALEND - CRITICALBEGIN)&#39;(the third sub instruction) include a 5e but 5d?<br /><br />thanks.<br /></div>
    <div class="meta">Posted on 2005-10-26 20:51:18 by Lava</div>
   </div>
   <div class="post" id="post-167258">
    <div class="subject"><a href="#post-167258">Re: How to generate a shorter code-----about SUB instruction</a></div>
    <div class="body">Just a question, what do you use to assemble your code?</div>
    <div class="meta">Posted on 2005-10-26 21:23:48 by roticv</div>
   </div>
   <div class="post" id="post-167259">
    <div class="subject"><a href="#post-167259">Re: How to generate a shorter code-----about SUB instruction</a></div>
    <div class="body">Something very old (or very bugged), I guess&nbsp; :shock:</div>
    <div class="meta">Posted on 2005-10-26 21:27:04 by ti_mo_n</div>
   </div>
   <div class="post" id="post-167262">
    <div class="subject"><a href="#post-167262">Re: How to generate a shorter code-----about SUB instruction</a></div>
    <div class="body">sorry for my negligence, the assembler is masm :<br />-------------------------------------------------------------------<br />D:\&gt;ml<br />Microsoft (R) Macro Assembler Version 6.14.8444<br />Copyright (C) Microsoft Corp 1981-1997.&nbsp; All rights reserved.<br /><br />usage: ML [ options ] filelist [ /link linkoptions]<br />Run &quot;ML /help&quot; or &quot;ML /?&quot; for more info<br /></div>
    <div class="meta">Posted on 2005-10-26 22:28:47 by Lava</div>
   </div>
   <div class="post" id="post-167265">
    <div class="subject"><a href="#post-167265">Re: How to generate a shorter code-----about SUB instruction</a></div>
    <div class="body">Lava,<br />&nbsp; &nbsp;  The answer to your prob is easy.&nbsp; You want MASM to generate the shorter 83 BYTE operand code right?&nbsp; Well, that 83 instruction sign extends the immediate BYTE operand.&nbsp; You don&#39;t want that to happen when your table length is greater than 7 bits, do you?&nbsp; So MASM has to use the 81 DWORD operand to avoid sign extension.&nbsp; Now if MASM were really smart, it would know if the byte operand was less than or equal 7 bits and use the 83 BYTE operand code.&nbsp; Ratch</div>
    <div class="meta">Posted on 2005-10-26 23:18:04 by Ratch</div>
   </div>
   <div class="post" id="post-167267">
    <div class="subject"><a href="#post-167267">Re: How to generate a shorter code-----about SUB instruction</a></div>
    <div class="body">The reason masm generates long opcodes in that particular cases is because you are subtracting pointers. At assembly stage, MASM is not quite sure what the difference would be, so it is not able to optimize for a shorter opcode. I imagine the actual difference is filled in by the linker.</div>
    <div class="meta">Posted on 2005-10-26 23:30:15 by comrade</div>
   </div>
   <div class="post" id="post-167269">
    <div class="subject"><a href="#post-167269">Re: How to generate a shorter code-----about SUB instruction</a></div>
    <div class="body"><div class="quote"><br />Lava,<br />     The answer to your prob is easy.  You want MASM to generate the shorter 83 BYTE operand code right?  Well, that 83 instruction sign extends the immediate BYTE operand.  You don&#39;t want that to happen when your table length is greater than 7 bits, do you?  So MASM has to use the 81 DWORD operand to avoid sign extension.  Now if MASM were really smart, it would know if the byte operand was less than or equal 7 bits and use the 83 BYTE operand code.  Ratch<br /></div><br /><br />------------------------------<br />thanks. <br /><br />yes, but what u posted is the reason, not the answer:)<br /><br />my question is &#39; is masm smart enough? or how to make it smarter?&#39;<br /><br />&#39;81 ee 5d 00 00 00&#39; may be executed faster than 83 because of avoiding&nbsp; sign extension(i guess), but how can i tell the masm: do not care the speed, make it shorter?<br /></div>
    <div class="meta">Posted on 2005-10-27 02:21:57 by Lava</div>
   </div>
   <div class="post" id="post-167270">
    <div class="subject"><a href="#post-167270">Re: How to generate a shorter code-----about SUB instruction</a></div>
    <div class="body">If you look at Comrade&#39;s explanation, then it would make a hell lot of sense why it is not possible to do so. Try FASM instead.</div>
    <div class="meta">Posted on 2005-10-27 03:58:15 by roticv</div>
   </div>
   <div class="post" id="post-167271">
    <div class="subject"><a href="#post-167271">Re: How to generate a shorter code-----about SUB instruction</a></div>
    <div class="body"><div class="quote"><br />If you look at Comrade&#39;s explanation, then it would make a hell lot of sense why it is not possible to do so. Try FASM instead.<br /></div><br /><br />yes, i got it . that&#39;s why i tried &#39;sub esi, low(CRITICALEND - CRITICALBEGIN), but i am not sure whether the mission is possible.<br /><br />if the answer is not, i&#39;ll try FASM, thank u:)<br /></div>
    <div class="meta">Posted on 2005-10-27 04:17:28 by Lava</div>
   </div>
   <div class="post" id="post-167274">
    <div class="subject"><a href="#post-167274">Re: How to generate a shorter code-----about SUB instruction</a></div>
    <div class="body">Try this.<br /><br /><span class="mono"><br />&nbsp; &nbsp; subesi MACRO value<br />&nbsp; &nbsp; &nbsp; db 83h,0EEh,value<br />&nbsp; &nbsp; ENDM<br />......<br />In code,<br /><br />&nbsp; &nbsp; subesi CRITICALEND - CRITICALBEGIN<br /></span></div>
    <div class="meta">Posted on 2005-10-27 06:19:34 by hutch--</div>
   </div>
   <div class="post" id="post-167275">
    <div class="subject"><a href="#post-167275">Re: How to generate a shorter code-----about SUB instruction</a></div>
    <div class="body">question1 answer:<br /><pre><code>sub esi,@CatStr(%(CRITICALEND-CRITICALBEGIN))</code></pre><br /><br />question2 answer:<br />&quot;byte&quot; by itself means no size cast, it means +1 in this case<br />to use size cast use &quot;type ptr&quot;<br />like for long push 0 :<br />&nbsp; push dword ptr 0<br /><br /><br /><br /><br /></div>
    <div class="meta">Posted on 2005-10-27 08:21:15 by drizz</div>
   </div>
   <div class="post" id="post-167278">
    <div class="subject"><a href="#post-167278">Re: How to generate a shorter code-----about SUB instruction</a></div>
    <div class="body">Lava,<br /><br /><div class="quote"><br />&#39;81 ee 5d 00 00 00&#39; may be executed faster than 83 because of avoiding  sign extension(i guess), but how can i tell the masm: do not care the speed, make it shorter?<br /></div><br /><br />     Faster or slower is irrelevant, correctness is not.  You don&#39;t want a sign extension to generate a negative number for a table length; which is what you get if the length is equal or greater than 080H.  The following snippet of code appears to work.  You can MACROtize it you choose.  It appears that MASM marks any expression that contains an address label as a 32-bit operand, no matter how hard you try to tell it otherwise.  While not incorrect, the code is not as small as it could be. Ratch<br /><br /><pre><code><br />DIFF = (CRITICALEND-CRITICALBEGIN)<br /><br /> .CODE<br />MAIN:<br />    IF DIFF LT 080H<br />     BYTE 081H,0EEH,DIFF<br />    ELSE<br />     SUB ESI,DIFF<br />    ENDIF<br /></code></pre></div>
    <div class="meta">Posted on 2005-10-27 10:04:33 by Ratch</div>
   </div>
   <div class="post" id="post-167284">
    <div class="subject"><a href="#post-167284">Re: How to generate a shorter code-----about SUB instruction</a></div>
    <div class="body">It works very well:<br />&nbsp; &nbsp; DIFF = (CRITICALEND - CRITICALBEGIN)<br />&nbsp; &nbsp; IF DIFF LT 080H<br />&nbsp; &nbsp; &nbsp; &nbsp; BYTE 083H, 0EEH, DIFF<br />&nbsp; &nbsp; ELSE<br />&nbsp; &nbsp; &nbsp; &nbsp; sub esi, DIFF<br />&nbsp; &nbsp; ENDIF<br />-----------------------------------------------------------<br />hutch, ratch and other guys, thanks.<br /><br />drizz:<br />&nbsp; &nbsp; sub esi, @CatStr(%(CRITICALEND - CRITICALBEGIN)<br />the result is weird: 83 ee 6d(not 5d). i also try this:<br />&nbsp; &nbsp; sub esi, @CatStr(%DIFF)<br />83 ee 6d appears again, why?<br /><br /></div>
    <div class="meta">Posted on 2005-10-27 20:02:34 by Lava</div>
   </div>
   <div class="post" id="post-167305">
    <div class="subject"><a href="#post-167305">Re: How to generate a shorter code-----about SUB instruction</a></div>
    <div class="body">Correct me if I am wrong, but I thing drizz&#39;s method can&#39;t work. The @CatStr directive forces evaluation of the difference too early, when not all of instructions are encoded, and thus the result can&#39;t be correct. MASM seems to be undeceivable in this case.</div>
    <div class="meta">Posted on 2005-10-28 10:07:00 by MazeGen</div>
   </div>
   <div class="post" id="post-167315">
    <div class="subject"><a href="#post-167315">Re: How to generate a shorter code-----about SUB instruction</a></div>
    <div class="body">yes, my mistake, i assumed it was data only (hashdata1..),<br />if you have relocatable labels(+instructions that use it) in between it wont work.<br /><pre><code>CRITICALBEGIN1:<br />	jmp @1<br />@1:	<br />CRITICALEND1:<br />%echo @CatStr(%(CRITICALEND1-CRITICALBEGIN1))<br /></code></pre><br /> if you use location counter $ it will work<br /><pre><code>CRITICALBEGIN2:<br />	jmp $+2<br />CRITICALEND2:<br />%echo @CatStr(%(CRITICALEND2-CRITICALBEGIN2))<br /></code></pre></div>
    <div class="meta">Posted on 2005-10-28 13:50:21 by drizz</div>
   </div>
   <div class="post" id="post-167353">
    <div class="subject"><a href="#post-167353">Re: How to generate a shorter code-----about SUB instruction</a></div>
    <div class="body">drizz,<br />  yes, it is data only and the length is 5d. but the code generated by your method is 6d. i have no idea about how masm process that instruction. i think that MASM also get confused.<br /><br /><div class="quote"><br />yes, my mistake, i assumed it was data only (hashdata1..),<br />if you have relocatable labels(+instructions that use it) in between it wont work.<br /><pre><code>CRITICALBEGIN1:<br />	jmp @1<br />@1:	<br />CRITICALEND1:<br />%echo @CatStr(%(CRITICALEND1-CRITICALBEGIN1))<br /></code></pre><br /> if you use location counter $ it will work<br /><pre><code>CRITICALBEGIN2:<br />	jmp $+2<br />CRITICALEND2:<br />%echo @CatStr(%(CRITICALEND2-CRITICALBEGIN2))<br /></code></pre><br /></div></div>
    <div class="meta">Posted on 2005-10-29 20:08:17 by Lava</div>
   </div>
   <div class="post" id="post-167360">
    <div class="subject"><a href="#post-167360">Re: How to generate a shorter code-----about SUB instruction</a></div>
    <div class="body">Lava,<br />that&#39;s interesting, could you post all code (data) between CRITICALEND and CRITICALBEGIN?</div>
    <div class="meta">Posted on 2005-10-30 01:59:47 by MazeGen</div>
   </div>
   <div class="post" id="post-167366">
    <div class="subject"><a href="#post-167366">Re: How to generate a shorter code-----about SUB instruction</a></div>
    <div class="body">drizz and MazeGen:<br />&nbsp; sorry, i made a mistake. the CRITICALDATA in the sample is only data, my working code is not. what i tried is the working code.<br />my working code is just like what drizz said:<br />&nbsp;  jmp start<br />&nbsp;  CRITICALBEGIN:<br />&nbsp; &nbsp; &nbsp; &nbsp; HashData1 dd ?????<br />&nbsp; &nbsp; &nbsp; &nbsp; ......<br />&nbsp; &nbsp; CRITICALEND:<br />&nbsp;  start:<br />&nbsp; &nbsp; &nbsp; &nbsp; jmp @F<br />&nbsp; &nbsp; &nbsp; &nbsp; ......<br />&nbsp;  @@:<br />&nbsp; &nbsp; &nbsp; &nbsp; .....<br />&nbsp;  ESIISHERE:<br />&nbsp; &nbsp; &nbsp; &nbsp; sub esi, (ESIISHERE - CRITICALBEGIN)<br /></div>
    <div class="meta">Posted on 2005-10-30 06:55:21 by Lava</div>
   </div>
  </div>
 </body>
</html>