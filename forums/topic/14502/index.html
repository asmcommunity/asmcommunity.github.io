<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Trying to define an array through macros - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=14502" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=14502">Trying to define an array through macros</a></p>
   <div class="post" id="post-112166">
    <div class="subject"><a href="#post-112166">Trying to define an array through macros</a></div>
    <div class="body">I needed an array of pointers to different procedures, hardcoded into the data section. Since they were only 14 or so I did it manually, but when I wanted more flexibility using macros I enountered some problems...<br /><br />My first attempt was to define an array of NULLs, and then overwriting the values I wanted, by using the ORG instruction. But, it seems, that only works for the good old A86, not in MASM :rolleyes:. I was only getting an array of NULLs followed by the values I wanted to change, no overwriting at all. It appears to be ORG only changes the way that addresses are calculated on assembly time, but not the position in the file where assembly is taking place. Is that right?<br /><br />So this was my second attempt:<br /><pre><code><br />; Sets the pointer to the hook handler procedure in &quot;apHookProc&quot; array,<br />;  defines it's prototype, and includes it's source.<br />DEFHOOK macro hook,procname<br />    local mycount<br />    ifndef HOOKPROCSPREPARED<br />        .err &lt;You must place the hook handler definitions AFTER the call to PREPAREDEFHOOKPROCS.&gt;<br />    endif<br />    ifdef HOOKPROCSDEFINED<br />        .err &lt;You must place the hook handler definitions BEFORE the apHookProc array is defined.&gt;<br />    endif<br />    &amp;procname&amp; proto &#58;dword,&#58;dword,&#58;dword<br />    include Mod\&amp;procname&amp;.inc<br />    mycount = &amp;hook + 1<br />    @CatStr &#40; &lt;ptrHookProc_&gt;, %mycount, &lt; = offset &amp;procname&amp;&gt; &#41;<br />endm<br /><br />; Used internally to prepare the definition of the &quot;apHookProc&quot; array.<br />;  It can only be called once, BEFORE the DEFHOOK calls.<br />PREPAREDEFHOOKPROCS macro<br />    local mycount<br />    ifdef HOOKPROCSPREPARED<br />        .err &lt;You can call PREPAREDEFHOOKPROCS only once.&gt;<br />    endif<br />    ifdef HOOKPROCSDEFINED<br />        .err &lt;You must call PREPAREDEFHOOKPROCS before DEFHOOK and DEFHOOKPROCS calls.&gt;<br />    endif<br />    HOOKPROCSPREPARED equ 1<br />    mycount = MIN_HOOK + 1<br />&#58;MyLoop<br />    @CatStr &#40; &lt;ptrHookProc_&gt;, %mycount, &lt; = NULL&gt; &#41;<br />    mycount = mycount + 1<br />    if mycount eq &#40;MAX_HOOK + 2&#41;<br />        exitm<br />    endif<br />    goto MyLoop<br />endm<br /><br />; Used internally to define the &quot;apHookProc&quot; array.<br />;  It can only be called once, AFTER the DEFHOOK calls.<br />DEFHOOKPROCS macro<br />    local mycount<br />    ifndef HOOKPROCSPREPARED<br />        .err &lt;You must call PREPAREDEFHOOKPROCS before DEFHOOK and DEFHOOKPROCS calls.&gt;<br />    endif<br />    ifdef HOOKPROCSDEFINED<br />        .err &lt;You can define the apHookProc array only once.&gt;<br />    endif<br />    HOOKPROCSDEFINED equ 1<br />    apHookProc label DWORD<br />    mycount = MIN_HOOK + 1<br />&#58;MyLoop<br />    dd @CatStr &#40; &lt;ptrHookProc_&gt;, %mycount &#41;<br />    mycount = mycount + 1<br />    if mycount eq &#40;MAX_HOOK + 2&#41;<br />        exitm<br />    endif<br />    goto MyLoop<br />endm<br /><br /><br />.const<br />; This prepares the assembly of the apHookProc array.<br />PREPAREDEFHOOKPROCS<br /><br />; This is where you define your hook handler procedures.<br />;  There is no need to define these in any particular order, nor to define them all.<br />;DEFHOOK     &lt;Hook type&gt;,        &lt;Handler procedure name&gt;<br />DEFHOOK     WH_MSGFILTER,       MessageProc<br />DEFHOOK     WH_JOURNALRECORD,   JournalRecordProc<br />DEFHOOK     WH_JOURNALPLAYBACK, JournalPlaybackProc<br />DEFHOOK     WH_KEYBOARD,        KeyboardProc<br />DEFHOOK     WH_GETMESSAGE,      GetMsgProc<br />DEFHOOK     WH_CALLWNDPROC,     CallWndProc<br />DEFHOOK     WH_CBT,             CBTProc<br />DEFHOOK     WH_SYSMSGFILTER,    SysMsgProc<br />DEFHOOK     WH_MOUSE,           MouseProc<br />DEFHOOK     WH_DEBUG,           DebugProc<br />DEFHOOK     WH_SHELL,           ShellProc<br />DEFHOOK     WH_FOREGROUNDIDLE,  ForegroundIdleProc<br />DEFHOOK     WH_CALLWNDPROCRET,  CallWndRetProc<br /><br />; This assembles the apHookProc array.<br />.const<br />DEFHOOKPROCS<br /></code></pre><br />The PREPAREDEFHOOKPROCS macro simply creates all the ptr_HookProc* &quot;variables&quot; and assings NULL to them. DEFHOOK changes some of those values as needed. Then DEFHOOKPROCS should assemble an array where each DWORD has the corresponding ptr_HookProc* value. That way, each value defaults to NULL, but is changed by DEFHOOK, and I don't need to worry about the actual size of the array, of the order in wich elements are defined, since all address calculations is performed by macros (I already have those, and they work, but I didn't post them here... I didn't wanted to make this thread even more bloated than it is already :grin: )<br /><br />Masm assembles it without complaints, but the linker returns this error message:<br /><div class="quote"><strong>HookLib.obj : fatal error LNK1190: invalid fixup found, type 0x0001</div><br /><br />And all that MELT can tell me is &quot;The object file is corrupt. Recompile.&quot; :P<br /><br />Any help? :(</div>
    <div class="meta">Posted on 2003-07-28 10:00:06 by QvasiModo</div>
   </div>
   <div class="post" id="post-112167">
    <div class="subject"><a href="#post-112167">Trying to define a jump table through macros</a></div>
    <div class="body">Try this:<br /><br />; Macro:         JumpOn<br />; Purpose:     Creates a jump table and executes a jump to a label according the content  of a register.<br />; Arguments: Arg1: case register.<br />;                    Arg2: Jump labels.<br />; Returns:     Nothing.<br />; Example:    JumpOn eax, @@10, @@20, @@30<br /><br />JumpOn macro RegName:req, Labels:vararg<br />                local JumpTable, Count, Arg, CaseElse<br />	<br />.data<br />                Count = 0<br />                for Arg, &lt;&amp;Labels&gt;<br />                  ife Count<br />JumpTable   dd       offset Arg<br />                  else<br />                    dd       offset Arg<br />                  endif<br />                  Count = Count + 1<br />                endm<br />.code<br />                cmp    RegName, &amp;Count<br />                jae     CaseElse<br />                jmp    <br />CaseElse:<br />endm</div>
    <div class="meta">Posted on 2003-07-28 10:15:21 by Biterider</div>
   </div>
   <div class="post" id="post-112170">
    <div class="subject"><a href="#post-112170">Trying to define a jump table through macros</a></div>
    <div class="body"><strong>Biterider</strong>, thanks anyway, but it wasn't exactly what I wanted to do... I see the title of my post was confusing. :(<br /><br />What I really want is just to define an array in the data section, where all values are hardcoded, and default to NULL. If I use the DEFHOOK macro, I set a value in a specific index. If I don't, the value in that index will remain NULL. I never intend to actually JUMP to it (that's why I say my title was confusing), the fact that the contents of the array are pointers is just a coincidence, it could be treated as data.<br /><br />What I also want is that the order in wich I call the DEFHOOK macro does not affect the index of the item in the array. That is, if I have several calls to DEFHOOK, altering the order in wich they are made assembles the same dwords, in the same order.<br /><br />I called it a jump table because it had pointers to procedures, but what I actually do with them is passing them to SetWindowsHookEx, for my HookLib library, so no jumps involved...</div>
    <div class="meta">Posted on 2003-07-28 10:22:06 by QvasiModo</div>
   </div>
   <div class="post" id="post-112177">
    <div class="subject"><a href="#post-112177">Trying to define a jump table through macros</a></div>
    <div class="body">If anyone was wondering, this was my first (failed) attempt... is there a way to make something like this work?<br /><pre><code><br />; Sets the pointer to the hook handler procedure in &quot;apHookProc&quot; array,<br />;  and defines it's prototype.<br />DEFHOOK macro hook,procname<br />    local mypos<br />    &amp;procname&amp; proto &#58;dword,&#58;dword,&#58;dword<br />    mypos = $<br />    org &#40;offset apHookProc + 4 + &#40;&#40;hook&#41; * 4&#41;&#41;<br />    dd offset &amp;procname&amp;<br />    org mypos<br />endm<br /><br />.const<br />apHookProc dd &#40;MAX_HOOK - MIN_HOOK&#41; dup &#40;NULL&#41;<br /><br />; This is where you define your hook handler procedures.<br />DEFHOOK     WH_MSGFILTER,       MessageProc<br />DEFHOOK     WH_JOURNALRECORD,   JournalRecordProc<br />DEFHOOK     WH_JOURNALPLAYBACK, JournalPlaybackProc<br />DEFHOOK     WH_KEYBOARD,        KeyboardProc<br />DEFHOOK     WH_GETMESSAGE,      GetMsgProc<br />DEFHOOK     WH_CALLWNDPROC,     CallWndProc<br />DEFHOOK     WH_CBT,             CBTProc<br />DEFHOOK     WH_SYSMSGFILTER,    SysMsgProc<br />DEFHOOK     WH_MOUSE,           MouseProc<br />DEFHOOK     WH_DEBUG,           DebugProc<br />DEFHOOK     WH_SHELL,           ShellProc<br />DEFHOOK     WH_FOREGROUNDIDLe,  ForegroundIdleProc<br />DEFHOOK     WH_CALLWNDPROCRET,  CallWndRetProc<br /></code></pre></div>
    <div class="meta">Posted on 2003-07-28 10:51:40 by QvasiModo</div>
   </div>
   <div class="post" id="post-112178">
    <div class="subject"><a href="#post-112178">Trying to define a jump table through macros</a></div>
    <div class="body">When I was coding ObsAsm32 macros, I also want to use the ORG instruction to override same data on the fly, but I failed.<br />I think it has something to do with the compiler passes...</div>
    <div class="meta">Posted on 2003-07-28 10:58:38 by Biterider</div>
   </div>
   <div class="post" id="post-112180">
    <div class="subject"><a href="#post-112180">Trying to define a jump table through macros</a></div>
    <div class="body">By the way, how does one control the number of passes that MASM makes? Maybe that could be the solution to my second attempt (the one I posted first, I mean)...</div>
    <div class="meta">Posted on 2003-07-28 11:04:32 by QvasiModo</div>
   </div>
   <div class="post" id="post-112214">
    <div class="subject"><a href="#post-112214">Trying to define a jump table through macros</a></div>
    <div class="body">I don't know how to control passes, but I use '/EP' option to check if my macros are expanded as I intended.  I guess that is the first pass (if preprocessing counts as a valid assembly pass).</div>
    <div class="meta">Posted on 2003-07-28 16:02:06 by Starless</div>
   </div>
   <div class="post" id="post-112220">
    <div class="subject"><a href="#post-112220">Trying to define a jump table through macros</a></div>
    <div class="body">QvasiModo,<br />     If I understand what you are trying to do, I think I have something that may help you.  I don't think that backing up the instruction counter and fooling around with multi/single passes are the way to go.<br /><br />     I have a MACRO set that takes in a Window message number and a handler address.  After calling a MACRO several times for things like WM_CREATE, WM_SIZE, WM_PAINT, etc.  The MACRO will output a DWORD data table of the Window message numbers, followed by another  table of handler address that can be used for a jump table.  I believe you can modify my macro set to do whatever you want to do.  Here is what the assembled MACRO calls look like.<pre><code> 				 WMTabBegin<br />				  WMTabEntry WM_SYSCOMMAND,SYSCOMMAND_WM         ;message table entry<br />				  WMTabEntry WM_CREATE,CREATE_WM<br />				  WMTabEntry WM_QUERYENDSESSION,QUERYENDSESSION_WM ;<br />				  WMTabEntry WM_DESTROY,DESTROY_WM               ;message table entry<br />				  WMTabEntry 0,MAINCBRET1                        ;message table entry<br />				 WMTabEnd WMNTAB1,WMATAB1,WMTENT1                ;msg num,proc adr,msg total entries<br /> 000000AC		     1	WMNTAB1 LABEL DWORD<br /> 000000AC  00000112	     2	  DD @CatStr&#40;WMTN$,%??0000&#41; <br /> 000000B0  00000001	     2	  DD @CatStr&#40;WMTN$,%??0000&#41; <br /> 000000B4  00000011	     2	  DD @CatStr&#40;WMTN$,%??0000&#41; <br /> 000000B8  00000002	     2	  DD @CatStr&#40;WMTN$,%??0000&#41; <br /> 000000BC		     1	WMATAB1 LABEL DWORD<br /> 000000BC  0000015C R	     2	  DD @CatStr&#40;WMTA$,%??0000&#41; <br /> 000000C0  00000172 R	     2	  DD @CatStr&#40;WMTA$,%??0000&#41; <br /> 000000C4  00000176 R	     2	  DD @CatStr&#40;WMTA$,%??0000&#41; <br /> 000000C8  0000018B R	     2	  DD @CatStr&#40;WMTA$,%??0000&#41; <br /> 000000CC  0000014E R	     2	  DD @CatStr&#40;WMTA$,%??0000&#41; <br /> = 00000005		     1	WMTENT1 EQU WMT$</code></pre>  For instance, CREATE_WM is the handler address for WM_CREATE message. I use this to search the first table for the message number, and then indirectly jump using the second table with the index from the first table.  If these MACROS are what you need, let me know.  Ratch</div>
    <div class="meta">Posted on 2003-07-28 16:41:01 by Ratch</div>
   </div>
   <div class="post" id="post-112343">
    <div class="subject"><a href="#post-112343">Trying to define a jump table through macros</a></div>
    <div class="body"><strong>Ratch:</strong><br />This is VERY close to what I want...<br /><br />What I have is an array of pointers only, and from the WH_* values (in your examples it would be the WM_* messages) I calculate the index of the array where to find the corresponding pointer. That's why it's important to put the pointers in the correct order, and leave some NULLs where needed. I did that by hand, but I want to know if there's a way to do it with macros, so I don't have to worry about the size of the array or the order I call the macros (otherwise there would be no advantage at all).<br /><br />In your case, the array is larger, and to obtain a pointer one must search for it sequentially... I wanted to calculate the index from the WH_* values because it's much more efficient, since it can be done with a macro, so no extra code is added. That's why I was trying to fool around with the ORG statement.<br /><br />The best soultion I found is to define a set of text equates, change their values with macros, and then building the array, putting each equate in it's corresponding index. It should be working... but for some reason the linker throws an error.<br /><br /><strong>Starless:</strong><br />I'll try your suggestion, let's see exactly how this macros are expanding, maybe that could give me some hints on where is the problem...</div>
    <div class="meta">Posted on 2003-07-29 09:56:16 by QvasiModo</div>
   </div>
   <div class="post" id="post-112344">
    <div class="subject"><a href="#post-112344">Trying to define a jump table through macros</a></div>
    <div class="body">That is the way an object definition is made in ObjAsm32. Check the Objects.inc file.<br /><br />At the end of an Object definition the EndObject macro constructs a structure that is allocated in the data segment.<br />You can follow this construct and then access the data in the way you want...<br /><br />Check the homepage http:\\biterider.tripod.com -&gt; Object repository</div>
    <div class="meta">Posted on 2003-07-29 10:03:38 by Biterider</div>
   </div>
   <div class="post" id="post-112346">
    <div class="subject"><a href="#post-112346">Trying to define a jump table through macros</a></div>
    <div class="body">Downloading. I'll take a look at it, compare with my macros, and see why mine does not work.<br />BTW, Cool page! :alright:</div>
    <div class="meta">Posted on 2003-07-29 10:15:05 by QvasiModo</div>
   </div>
   <div class="post" id="post-112348">
    <div class="subject"><a href="#post-112348">Trying to define a jump table through macros</a></div>
    <div class="body">QvasiModo,<br /><br />Let my try again to understand what you are trying to do.  You want use a MACRO to input a sequence of numbers like INORDER 6,3,8,0,0,7,1 , and then perhaps define a MACRO FUNCTION that gives the sequential number of their input order.  For instance, a MACRO FUNCTION called as POSORD(8) would return a positonal order of 2, or POSORD(7) would give a positional order of 5.  Is that what you want?  Ratch</div>
    <div class="meta">Posted on 2003-07-29 10:41:17 by Ratch</div>
   </div>
   <div class="post" id="post-112357">
    <div class="subject"><a href="#post-112357">Trying to define a jump table through macros</a></div>
    <div class="body">Never mind, I've solved it. :)<br /><br />This is what I was trying to do:<br /><pre><code><br />ptrHookProc_0 = offset SomeProc<br />ptrHookProc_1 = offset SomeOtherProc<br />&#40;...&#41;<br />ptrHookProc_15 = offset LastProc<br /><br />.data<br />dd ptrHookProc_0<br />dd ptrHookProc_1<br />&#40;...&#41;<br />dd ptrHookProc_15<br /></code></pre><br />Wich should be the equivalent of this:<br /><pre><code><br />ptrHookProc_0 TEXTEQU offset SomeProc<br />ptrHookProc_1 TEXTEQU  offset SomeOtherProc<br />&#40;...&#41;<br />ptrHookProc_15 TEXTEQU  offset LastProc<br /><br />.data<br />dd ptrHookProc_0<br />dd ptrHookProc_1<br />&#40;...&#41;<br />dd ptrHookProc_15<br /></code></pre><br />But IS NOT. Apparently MASM generates a corrupt .obj file when trying the first method :mad: . The second works fine. Since Bitrider's macros use the first method (but not with offsets to procedures) I suppose the bug happens when you use values that will be resolved at link time.<br />The second (working) method assembles this:<br /><pre><code><br />.data<br />dd offset SomeProc<br />dd offset SomeOtherProc<br />&#40;...&#41;<br />dd offset LastProc<br /></code></pre><br />The trick is that if I don't define one of the ptr_HookProc values, they default to NULL (thanks to PREPAREDEFHOOKPROCS macro). And the other advantage is that it does not matter in wich order I call the DEFHOOK macro, the offsets are stored in the array in the correct order.<br /><br />The full source is in this thread:<br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=14463">http://www.asmcommunity.net/board/index.php?topic=14463</a><br /><br />Anyway, Biterider, Ratch, thanks for your support! :alright:</div>
    <div class="meta">Posted on 2003-07-29 13:42:09 by QvasiModo</div>
   </div>
  </div>
 </body>
</html>