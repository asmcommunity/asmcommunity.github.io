<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Calling shell context menu from my program - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=17772" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=116">Windows</a> &raquo; <a href="../?id=17772">Calling shell context menu from my program</a></p>
   <div class="post" id="post-137207">
    <div class="subject"><a href="#post-137207">Calling shell context menu from my program</a></div>
    <div class="body">Hello COM people :)<br />My first post here, and I have no idea about how to use COM but I realised that it is very powerfull feature of Win32<br />Anyway I wanted to add menu to my program that will show explorer context menu for some file/folder, but due to my ignorance in this area I am not exacly sure how to do this.<br />I saw ernie's file manager source and found this code, but still I could not make it to work in my program. <br /><br /><pre><code><br />ContextMenu proc	public uses ebx edx hWnd&#58;DWORD, pshfParent&#58;LPSHELLFOLDER, pidl&#58;LPITEMIDLIST, ppoint&#58;DWORD<br />	LOCAL	pcm&#58;LPCONTEXTMENU<br />	LOCAL	hMenu&#58;DWORD<br />	LOCAL	iCmd&#58;DWORD<br />	LOCAL	cmi&#58;CMINVOKECOMMANDINFO<br />	<br />	mov		ebx, pshfParent<br />	mov		ebx,&#91;ebx&#93;<br />	invoke	&#40;IShellFolder ptr &#91;ebx&#93;&#41;.GetUIObjectOf, pshfParent,<br />			hWnd,<br />			1,<br />			addr pidl,<br />			addr IID_IContextMenu,<br />			0,<br />			addr pcm<br />	test	eax,eax<br />	js		ret_error<br />	<br />	invoke	CreatePopupMenu<br />	test	eax,eax<br />	jz		ret_error<br />	mov		hMenu, eax<br />	<br />	mov		ebx, pcm<br />	mov		ebx, &#91;ebx&#93;<br />	invoke	&#40;IContextMenu ptr &#91;ebx&#93;&#41;.QueryContextMenu, pcm,<br />			hMenu,<br />			0,<br />			1,<br />			7FFFh,<br />			CMF_EXPLORE<br />	test	eax,eax<br />	js		ret_error<br />	<br />	mov		edx, ppoint<br />	invoke	TrackPopupMenu,<br />			hMenu,<br />			TPM_LEFTALIGN or TPM_RIGHTBUTTON or 0100h, ;TPM_RETURNCMD<br />			&#40;POINT ptr &#91;edx&#93;&#41;.x,<br />			&#40;POINT ptr &#91;edx&#93;&#41;.y,<br />			0,<br />			hWnd,<br />			0<br />	test	eax,eax<br />	jz		ret_error<br />	mov		iCmd, eax	<br /><br />	mov		cmi.cbSize, sizeof CMINVOKECOMMANDINFO<br />	mov		cmi.fMask, 0<br />	mov		eax, hWnd<br />	mov		cmi.hwnd, eax<br />	<br />	mov		eax, iCmd<br />	dec		eax<br />	and		eax, 0000FFFFh<br />	mov		cmi.lpVerb, eax<br />	<br />	mov		cmi.lpParameters, 0<br />	mov		cmi.lpDirectory, 0<br />	mov		cmi.nShow, SW_SHOWNORMAL<br />	mov		cmi.dwHotKey, 0<br />	mov		cmi.hIcon, 0<br />	<br />	mov		ebx, pcm<br />	mov		ebx, &#91;ebx&#93;<br />	invoke	&#40;IContextMenu ptr &#91;ebx&#93;&#41;.InvokeCommand, pcm, addr cmi<br />	.IF		eax &lt; 0 ; failed<br />			;int 3<br />	.ENDIF<br />	invoke	DestroyMenu, hMenu<br />	invoke	&#40;IContextMenu ptr &#91;ebx&#93;&#41;.Release, pcm<br />	<br />ret_ok&#58;<br />	mov		eax,1<br />	ret<br />			<br />ret_error&#58;<br />	xor		eax,eax<br />	ret<br />ContextMenu endp<br /></code></pre><br /><br />I dont understand much this code, and also looks like I dont have all includes needed to compile COM stuff properly. Does someone maybe already has standalone example on how to show context menu from his own app?</div>
    <div class="meta">Posted on 2004-03-28 10:41:35 by Mikky</div>
   </div>
   <div class="post" id="post-137348">
    <div class="subject"><a href="#post-137348">Calling shell context menu from my program</a></div>
    <div class="body">I have no experience with this area as well, but i can help by explaining this function to you:<br /><br /><pre><code>	mov		ebx, pshfParent<br />	mov		ebx,&#91;ebx&#93;<br />	invoke	&#40;IShellFolder ptr &#91;ebx&#93;&#41;.GetUIObjectOf, pshfParent,<br />			hWnd,<br />			1,<br />			addr pidl,<br />			addr IID_IContextMenu,<br />			0,<br />			addr pcm<br />	test	eax,eax<br />	js		ret_error<br /></code></pre><br />This uses a provided COM object instance.  In this case its pshfParent (IShellFolder instance).  This is only generated via COM function calls, or specific API.  My guess is if its failing, it would be here as your probably not getting the right Object instance to satisfy this parameter.  If it does work, it will return in 'pcm' (pointer to context menu instance) a context menu.<br /><br /><pre><code>	invoke	CreatePopupMenu<br />	test	eax,eax<br />	jz		ret_error<br />	mov		hMenu, eax<br /></code></pre><br />This simply makes a Popup menu.  Nothing new.<br /><br /><pre><code>	mov		ebx, pcm<br />	mov		ebx, &#91;ebx&#93;<br />	invoke	&#40;IContextMenu ptr &#91;ebx&#93;&#41;.QueryContextMenu, pcm,<br />			hMenu,<br />			0,<br />			1,<br />			7FFFh,<br />			CMF_EXPLORE<br />	test	eax,eax<br />	js		ret_error<br /></code></pre><br />This uses the returned context menu pointer (another COM object instance) to query it and popuplate hMenu (the popup menu you just created).  This is my best guess from the parameters provided.<br /><br /><pre><code>	mov		edx, ppoint<br />	invoke	TrackPopupMenu,<br />			hMenu,<br />			TPM_LEFTALIGN or TPM_RIGHTBUTTON or 0100h, ;TPM_RETURNCMD<br />			&#40;POINT ptr &#91;edx&#93;&#41;.x,<br />			&#40;POINT ptr &#91;edx&#93;&#41;.y,<br />			0,<br />			hWnd,<br />			0<br />	test	eax,eax<br />	jz		ret_error<br /></code></pre><br />This simply displays the popup menu.  Again, nothing to new here.<br /><br /><pre><code>	mov		iCmd, eax	<br /><br />	mov		cmi.cbSize, sizeof CMINVOKECOMMANDINFO<br />	mov		cmi.fMask, 0<br />	mov		eax, hWnd<br />	mov		cmi.hwnd, eax<br />	<br />	mov		eax, iCmd<br />	dec		eax<br />	and		eax, 0000FFFFh<br />	mov		cmi.lpVerb, eax<br />	<br />	mov		cmi.lpParameters, 0<br />	mov		cmi.lpDirectory, 0<br />	mov		cmi.nShow, SW_SHOWNORMAL<br />	mov		cmi.dwHotKey, 0<br />	mov		cmi.hIcon, 0<br />	<br />	mov		ebx, pcm<br />	mov		ebx, &#91;ebx&#93;<br />	invoke	&#40;IContextMenu ptr &#91;ebx&#93;&#41;.InvokeCommand, pcm, addr cmi<br />	.IF		eax &lt; 0 ; failed<br />			;int 3<br />	.ENDIF<br /></code></pre><br />This section of code takes the chosen item from the popup menu and packs it into a CMINVOKECOMMANDINFO structure, so it can be passed back to the context menu object.  Once the context menu object has been notified of the selection chosen from the user, it is told to 'invoke' the desired action associated with the item number.  <br /><br /><pre><code>	invoke	DestroyMenu, hMenu<br />	invoke	&#40;IContextMenu ptr &#91;ebx&#93;&#41;.Release, pcm<br /></code></pre><br />This is clean up.  Free the menu resource used as well as Release the COM instance created, which was the returned Context Menu object.<br /><br /><br />I hope this helps.  Again from reviewing this, my guess is its not working because your probably do not have the right Object instance to get the entire train rolling.  Everything else in this function is tightly written by appearances.<br /><br />Best of luck.<br />:NaN:</div>
    <div class="meta">Posted on 2004-03-29 20:52:11 by NaN</div>
   </div>
   <div class="post" id="post-137349">
    <div class="subject"><a href="#post-137349">Calling shell context menu from my program</a></div>
    <div class="body">Check out this link as well for reference:<br /><br /><a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/shellcc/platform/shell/reference/ifaces/ishellfolder/ishellfolder.asp">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/shellcc/platform/shell/reference/ifaces/ishellfolder/ishellfolder.asp</a></div>
    <div class="meta">Posted on 2004-03-29 20:55:16 by NaN</div>
   </div>
   <div class="post" id="post-137350">
    <div class="subject"><a href="#post-137350">Calling shell context menu from my program</a></div>
    <div class="body">This link talks about ways of getting the IShellFolder interface (what you need for this function to work).<br /><br /><a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/shellcc/platform/shell/programmersguide/shell_basics/shell_basics_programming/folder_info.asp">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/shellcc/platform/shell/programmersguide/shell_basics/shell_basics_programming/folder_info.asp</a><br /><br />My guess is a simple test would be using the API: SHGetDesktopFolder <br /><br /><a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/shellcc/platform/shell/reference/functions/shgetdesktopfolder.asp">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/shellcc/platform/shell/reference/functions/shgetdesktopfolder.asp</a><br /><br />Using this interface you should *probably* be presented with the context menu that you would see when you goto &quot;my computer&quot; and right click. (My guess only here)<br /><br />Regards,<br />:NaN:</div>
    <div class="meta">Posted on 2004-03-29 21:02:23 by NaN</div>
   </div>
  </div>
 </body>
</html>