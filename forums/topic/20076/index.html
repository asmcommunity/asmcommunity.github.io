<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>HandleError - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=20076" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=20076">HandleError</a></p>
   <div class="post" id="post-153849">
    <div class="subject"><a href="#post-153849">HandleError</a></div>
    <div class="body">hello, everybody.<br /><br />here is a GetLastError Handling proc submitted by JimmClif.<br />if can't openport, it crashed.<br />how use the handleError proc ? please help.<br /><br />regards.<br /><pre><code>		.486 <br />		.model flat, stdcall <br />		option casemap&#58;none <br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />include	\masm32\include\windows.inc <br />include	\masm32\include\shell32.inc <br />include	\masm32\include\masm32.inc <br />include	\masm32\include\kernel32.inc <br />include	\masm32\include\comctl32.inc <br />include	\masm32\include\comdlg32.inc <br />include	\masm32\include\user32.inc <br />include	\masm32\include\gdi32.inc      <br />	<br />includelib	\masm32\lib\masm32.lib <br />includelib	\masm32\lib\kernel32.lib <br />includelib	\masm32\lib\user32.lib <br />includelib	\masm32\lib\gdi32.lib <br />includelib	\masm32\lib\comctl32.lib <br />includelib	\masm32\lib\comdlg32.lib <br />includelib	\masm32\lib\shell32.lib <br />	<br />include	\masm32\Macros\Macros.asm<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />my_OpenPort	proto <br />HandleError	PROTO &#58;DWORD <br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.data <br />	szPortName	db &quot;COM1&quot;,0<br />	parf		db &quot;COM1&#58; baud=9600 parity=N data=8 stop=1&quot;,0<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.data? <br />		hcomm		dd ? <br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;    <br />.code <br /><br />start&#58; <br />;-----------------------------------------------------------------------------<br />		invoke my_OpenPort<br />		.if eax==FALSE<br />			jmp @f<br />		.endif<br />			invoke MessageBox,NULL,chr$&#40;&quot;Passed&#58; open port.&quot;&#41;,chr$&#40;&quot;COMX_TEST.&quot;&#41;,MB_OK or MB_ICONEXCLAMATION ; <br /><br />@@&#58;<br />		invoke ExitProcess,NULL <br /><br />;------------------------------------------------------------------------------<br />my_OpenPort proc <br />		<br />		invoke CreateFile,addr szPortName,GENERIC_READ or GENERIC_WRITE,0,NULL,OPEN_EXISTING,\ <br />			     FILE_ATTRIBUTE_NORMAL,NULL <br />		invoke HandleError,eax<br /><br />		.if eax==INVALID_HANDLE_VALUE			<br />			invoke MessageBox, NULL, chr$&#40;&quot;Cannot open Communication Port.Please\nQuit the program and Re-start your PC. Com Port Error&quot;&#41;, chr$&#40;&quot;COMX_TEST.&quot;&#41;,MB_OK or MB_ICONERROR<br />			;invoke MessageBox, NULL, str$&#40;eax&#41;, chr$&#40;&quot;COMX_TEST.&quot;&#41;, MB_OK<br />			mov eax,FALSE<br />			jmp fret<br />		.endif						<br />			mov hcomm,eax<br />			mov eax,TRUE <br />fret&#58;			ret<br /><br />my_OpenPort		endp<br />;------------------------------------------------------------------------------<br />HandleError proc lpTitle&#58;DWORD <br />     <br />		LOCAL lpMsgBuffer     &#58; LPVOID ;dword<br />		; calculate language ID, asm version of MAKELANGID <br />		mov cx, SUBLANG_DEFAULT <br />		shl ecx, 10 <br />		;or  cx, LANG_NEUTRAL        ; LANG_NEUTRAL = 0, nothing necessary <br />		 <br />		; Setup parameters for FormatMessage, normal pushing to use some <br />		; params directly &#40;e.g. GetLastError returns the ID in eax, but I <br />		; can't use this register in &quot;invoke&quot;&#41; <br />		 <br />		push NULL                ; we don't need this <br />		push 0                   ; min. size of output buffer if we use <br />					 ; FORMAT_MESSAGE_ALLOCATE_BUFFER <br />		lea  eax,lpMsgBuffer     ; get address of our buffer <br />		push eax                 ; address of buffer <br />		push ecx                 ; our language ID, calculated above <br />		invoke GetLastError      ; get error number <br />		push eax                 ; push return value = error ID <br />		push NULL                ; can be used to format a string, we don't need it <br />		mov edx, FORMAT_MESSAGE_ALLOCATE_BUFFER or FORMAT_MESSAGE_FROM_SYSTEM <br />		push edx                 ; some flags, check your doc for more <br />		call FormatMessage       ; here we go <br />		 <br />		; Display error-message <br />		invoke MessageBox, NULL, lpMsgBuffer, lpTitle, MB_OK or MB_ICONSTOP <br />		 <br />		; free memory <br />		invoke LocalFree, lpMsgBuffer <br /><br />		ret <br />HandleError endp <br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br /><br />end start <br /><br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</code></pre></div>
    <div class="meta">Posted on 2004-12-07 08:43:20 by dcskm4200</div>
   </div>
   <div class="post" id="post-153863">
    <div class="subject"><a href="#post-153863">HandleError</a></div>
    <div class="body">That HandleError proc does not &quot;handle&quot; the error, it just displays the error message at human readable format.<br /><br />After error call HandleError as follows:<br /><br />invoke HandleError, ADDR TitleBarText</div>
    <div class="meta">Posted on 2004-12-07 11:24:07 by SamiP</div>
   </div>
   <div class="post" id="post-153881">
    <div class="subject"><a href="#post-153881">HandleError</a></div>
    <div class="body">Code Warrior SamiP:<br /><br />Thank you very much.<br />now, i understood .<br />here, &quot;lpMsgBuffer&quot; is the character address corresponding error id that provided by windows system;<br />&quot;lpTitle&quot; is the character address corresponding a Title provided by user.<br />HandleError proc not only handle api calling error, but also handle api calling succeed. <br /><br />regards.</div>
    <div class="meta">Posted on 2004-12-07 23:15:29 by dcskm4200</div>
   </div>
   <div class="post" id="post-153886">
    <div class="subject"><a href="#post-153886">HandleError</a></div>
    <div class="body">Yeah, it also &quot;handles&quot; success. but in normal cases you only wan't to call HandleError when error occurs.</div>
    <div class="meta">Posted on 2004-12-08 01:43:04 by SamiP</div>
   </div>
   <div class="post" id="post-153887">
    <div class="subject"><a href="#post-153887">HandleError</a></div>
    <div class="body">Hi dcskm4200,<br /><br />Maybe &quot;HandleError&quot; was a little mis-named. &quot;Handling&quot; an error generally indicates that you will correct the situation that caused the error or exit gracefully from the program. This is called &quot;Structured Exception Handling&quot; or SEH and can be used effectively to display errors or even recover from them. You might want to check out Jeremy Gordon's tutorial on SEH at the following URL:<br /><br />http://www.jorgon.freeserve.co.uk/ExceptFrame.htm</div>
    <div class="meta">Posted on 2004-12-08 02:00:37 by donkey</div>
   </div>
   <div class="post" id="post-153895">
    <div class="subject"><a href="#post-153895">HandleError</a></div>
    <div class="body">Code Warrior SamiP and ASS-embler donkey:<br />thanks your guidances.<br /><br />During code, I used  to check a proc running at API called before i found the HandleError proc. i think the HandleError proc is better.<br /><br />of course. on the name of the HandleError proc, I comprehended a mistake. if changed his name to &quot;DspErrorMsg&quot; , I easily understand. in most case, for avoiding to display any message when API called succeedly, i modified follow:<br /><br /><pre><code><br />		.486 <br />		.model flat, stdcall <br />		option casemap&#58;none <br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />include	\masm32\include\windows.inc <br />include	\masm32\include\shell32.inc <br />include	\masm32\include\masm32.inc <br />include	\masm32\include\kernel32.inc <br />include	\masm32\include\comctl32.inc <br />include	\masm32\include\comdlg32.inc <br />include	\masm32\include\user32.inc <br />include	\masm32\include\gdi32.inc      <br />	<br />includelib	\masm32\lib\masm32.lib <br />includelib	\masm32\lib\kernel32.lib <br />includelib	\masm32\lib\user32.lib <br />includelib	\masm32\lib\gdi32.lib <br />includelib	\masm32\lib\comctl32.lib <br />includelib	\masm32\lib\comdlg32.lib <br />includelib	\masm32\lib\shell32.lib <br />	<br />include	\masm32\Macros\Macros.asm<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />my_OpenPort		proto <br />HandleError		PROTO &#58;DWORD <br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.data <br />		pzCaption	db &quot;COMX_TEST.&quot;,0<br />		szPortName	db &quot;COM1&quot;,0<br />		parf		db &quot;COM1&#58; baud=9600 parity=N data=8 stop=1&quot;,0<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br />.data? <br />		hcomm		dd ?<br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;    <br />.code <br /><br />start&#58; <br />;-----------------------------------------------------------------------------<br />		invoke my_OpenPort<br />		.if eax==FALSE<br />			jmp @f<br />		.endif<br />			invoke MessageBox,NULL,chr$&#40;&quot;Passed&#58; open port.&quot;&#41;,chr$&#40;&quot;COMX_TEST.&quot;&#41;,MB_OK or MB_ICONEXCLAMATION ; <br />@@&#58;<br />		invoke ExitProcess,NULL <br /><br />;------------------------------------------------------------------------------<br />my_OpenPort proc <br />		<br />		invoke CreateFile,addr szPortName,GENERIC_READ or GENERIC_WRITE,0,NULL,OPEN_EXISTING,\ <br />			     FILE_ATTRIBUTE_NORMAL,NULL <br />		push eax<br />		invoke HandleError, addr pzCaption<br />		pop eax<br />		.if eax==INVALID_HANDLE_VALUE			<br />			mov eax,FALSE<br />			jmp fret<br />		.endif						<br />			mov hcomm,eax<br />			mov eax,TRUE <br />fret&#58;			ret<br /><br />my_OpenPort		endp<br />;------------------------------------------------------------------------------<br />HandleError proc lpTitle&#58;DWORD  <br />     <br />		LOCAL lpMsgBuffer&#58;LPVOID ;dword<br />		.if eax &lt;= 0<br />			; calculate language ID, asm version of MAKELANGID <br />			mov cx, SUBLANG_DEFAULT <br />			shl ecx, 10 <br />			;or  cx, LANG_NEUTRAL        ; LANG_NEUTRAL = 0, nothing necessary <br />		 <br />			; Setup parameters for FormatMessage, normal pushing to use some <br />			; params directly &#40;e.g. GetLastError returns the ID in eax, but I <br />			; can't use this register in &quot;invoke&quot;&#41; <br />		 <br />			push NULL                ; we don't need this <br />			push 0                   ; min. size of output buffer if we use <br />						 ; FORMAT_MESSAGE_ALLOCATE_BUFFER <br />			lea  eax,lpMsgBuffer     ; get address of our buffer <br />			push eax                 ; address of buffer <br />			push ecx                 ; our language ID, calculated above <br />			invoke GetLastError      ; get error number <br />			push eax                 ; push return value = error ID <br />			push NULL                ; can be used to format a string, we don't need it <br />			mov edx, FORMAT_MESSAGE_ALLOCATE_BUFFER or FORMAT_MESSAGE_FROM_SYSTEM <br />			push edx                 ; some flags, check your doc for more <br />			call FormatMessage       ; here we go <br />			 <br />			; Display error-message <br />			invoke MessageBox, NULL, lpMsgBuffer, lpTitle, MB_OK or MB_ICONINFORMATION <br />			 <br />			; free memory <br />			invoke LocalFree, lpMsgBuffer <br />		.endif<br />		ret <br />HandleError endp <br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br /><br />end start <br /><br />;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<br /></code></pre><br />but a problem happen, when a process opened &quot;com1&quot; port, my code can't display any message. if I don't modify it, my code display &quot;refuse access&quot; . at one time, if succeedly opened &quot;com1&quot; port, it also display &quot;succeed&quot; that I don't need.<br />;=====================================================================<br />although i have read Jeremy Gordon's tutorial on SEH twice, but i understand a little. when coding, Error or Exception may be happen. Error affected a proc running. Exception not only affected a proc running, but also affected system running. so must be handle by system .<br />my question is follow:<br />in the windows system, no matter what Error or Exception. system give a user nothing information besides Error or Exception id (it is only a number). why can't give a user more information?<br /> <br />best regards</div>
    <div class="meta">Posted on 2004-12-08 07:55:03 by dcskm4200</div>
   </div>
   <div class="post" id="post-153898">
    <div class="subject"><a href="#post-153898">HandleError</a></div>
    <div class="body">You should leave HandleError proc as it was and change  my_OpenPort proc.<br /><br />Firstly MSDN says CreateFiles returnvalues are:<br />Return Values<br />If the function succeeds, the return value is an open handle to the specified file. If the specified file exists before the function call and dwCreationDisposition is CREATE_ALWAYS or OPEN_ALWAYS, a call to GetLastError returns ERROR_ALREADY_EXISTS (even though the function has succeeded). If the file does not exist before the call, GetLastError returns zero.<br /><br />If the function fails, the return value is INVALID_HANDLE_VALUE. To get extended error information, call GetLastError.<br /><br />So my_OpenPort proc should be<br /><pre><code><br />my_OpenPort proc<br />      <br />      invoke CreateFile,addr szPortName,GENERIC_READ or GENERIC_WRITE,0,NULL,OPEN_EXISTING,\<br />              FILE_ATTRIBUTE_NORMAL,NULL<br />		.if eax == INVALID_HANDLE_VALUE<br />			invoke	HandleError<br />			mov		eax, FALSE<br />		.else<br />			mov		hcomm, eax<br />			mov		eax, TRUE<br />		.endif<br /><br />fret&#58;         ret<br /><br />my_OpenPort      endp <br /></code></pre></div>
    <div class="meta">Posted on 2004-12-08 09:07:07 by SamiP</div>
   </div>
   <div class="post" id="post-153904">
    <div class="subject"><a href="#post-153904">HandleError</a></div>
    <div class="body">Code Warrior SamiP: <br /><br />Thank you very much.</div>
    <div class="meta">Posted on 2004-12-08 10:31:42 by dcskm4200</div>
   </div>
  </div>
 </body>
</html>