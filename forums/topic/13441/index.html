<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>dierctdraw v4 windowed mode. problem - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=13441" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=10">Graphics &amp; Game Development</a> &raquo; <a href="../?id=13441">dierctdraw v4 windowed mode. problem</a></p>
   <div class="post" id="post-104136">
    <div class="subject"><a href="#post-104136">dierctdraw v4 windowed mode. problem</a></div>
    <div class="body">hello.<br />Does anyone know why this does not seem to work?<br />I'm trying to make this DirectDraw 4  example work in windowed mode<br />i d ont like when it is DDSCL_FULLSCREEN or DDSCL_EXCLUSIVE.<br />the fullscreen version was posted by SLIVER,<br />in this thread<br /><br /><a target="_blank" href="http://www.asmcommunity.net/board/showthread.php?threadid=1629&amp;highlight=directdraw">http://www.asmcommunity.net/board/showthread.php?threadid=1629&amp;highlight=directdraw</a><br /><br /><br />Thanks in advance.</div>
    <div class="meta">Posted on 2003-05-20 23:36:52 by vilik</div>
   </div>
   <div class="post" id="post-104465">
    <div class="subject"><a href="#post-104465">dierctdraw v4 windowed mode. problem</a></div>
    <div class="body">i must be stupid;</div>
    <div class="meta">Posted on 2003-05-23 08:18:00 by vilik</div>
   </div>
   <div class="post" id="post-104516">
    <div class="subject"><a href="#post-104516">dierctdraw v4 windowed mode. problem</a></div>
    <div class="body">Have not downloaded your example ....but ...<br /><br />Lately i have made HE map editor run ok in  windowed mode, <br /><br />I am also moving on to make HE run in windowed mode (for debugging reasons only) ... <br /><br />so where exactly is the problem in your code, have you narrowed its location a little conceptualy?</div>
    <div class="meta">Posted on 2003-05-23 12:29:00 by BogdanOntanu</div>
   </div>
   <div class="post" id="post-104519">
    <div class="subject"><a href="#post-104519">dierctdraw v4 windowed mode. problem</a></div>
    <div class="body">SOme of my assumptions w/o too much checking:<br /><br />1)Why do release the clipper ? -- you will need it for the rest of the application<br />2)Whay do not setup backbuffercount to zero for the primary surface<br />3)Why OFFSECREENPLAIN and SYSTEMMEMORY ? - use ONLY SYTEMMEMORY :P<br />4)You must deal with WM_PAINT and WM_SIZE<br />5)Both source and destination rectangles must be specifyed for the system to primary BLIT<br />6)you must convert Window coordinates from client coordinates to screen coordinates</div>
    <div class="meta">Posted on 2003-05-23 13:00:18 by BogdanOntanu</div>
   </div>
   <div class="post" id="post-104557">
    <div class="subject"><a href="#post-104557">dierctdraw v4 windowed mode. problem</a></div>
    <div class="body">ni paloutchitsa<br />***<br />Thank you for your sugestions<br />but ,that didn't help me actually.<br />this is what i have.<br />***<br /><br />.386<br />.model flat, stdcall <br />option casemap:none <br /><br />include \masm32\include\windows.inc <br />include \masm32\include\user32.inc <br />include \masm32\include\kernel32.inc <br />include \masm32\include\gdi32.inc <br />include \masm32\include\winmm.inc<br />include ddraw.inc<br /><br />includelib \masm32\lib\kernel32.lib <br />includelib \masm32\lib\user32.lib<br />includelib \masm32\lib\gdi32.lib<br />includelib \masm32\lib\winmm.lib<br />includelib \masm32\lib\ddraw.lib<br /><br />;******************************************************************************<br />;* Function prototypes<br />;******************************************************************************<br />RunGame               proto :HWND<br />CleanUp               proto<br />WinMain               proto :DWORD, :DWORD, :DWORD, :DWORD <br />DestroyDirectDraw     proto<br />TopXY PROTO   :DWORD,:DWORD<br /><br />;******************************************************************************<br />;* EQU's<br />;******************************************************************************<br />WINDOW_TOP          EQU CW_USEDEFAULT<br />WINDOW_LEFT         EQU CW_USEDEFAULT<br />WINDOW_WIDTH        EQU 640;800       ;600   ; must specify a value (not CW_USEDEFAULT)<br />WINDOW_HEIGHT       EQU 480;640;600   ;600   ; must specify a value (not CW_USEDEFAULT)<br /><br />; -----------------------------------------------------------------------------<br />; Create a RGB value and store it in EAX<br />; -----------------------------------------------------------------------------<br />RGB MACRO red, green, blue <br />    xor eax, eax <br />    mov ah, blue <br />    shl eax, 8 <br />    mov ah, green <br />    mov al, red <br />endm <br /><br />; -----------------------------------------------------------------------------<br />; Displays a message box with the text passed to the macro<br />; -----------------------------------------------------------------------------<br />FATAL MACRO msg<br />	LOCAL @@msg<br />	.DATA<br />	@@msg db msg, 0<br />	.CODE<br />	invoke MessageBox, MainHWnd, ADDR @@msg, ADDR szAppName, MB_OK<br />ENDM<br /><br />; -----------------------------------------------------------------------------<br />; Safely releases a DDraw surface from memory<br />; -----------------------------------------------------------------------------<br />SAFE_RELEASE_SURFACE MACRO lpDDSSurf<br />	.IF lpDDSSurf != NULL<br />		DDSINVOKE Release, lpDDSSurf<br />		mov lpDDSSurf, NULL<br />	.ENDIF<br />ENDM<br /><br />.DATA<br />szClassName         db &quot;MyWinClass&quot;, 0      <br />szAppName           db &quot;Generic FPS&quot;, 0  <br /><br />MainHWnd            HWND                 0  <br />lpDD                LPDIRECTDRAW         0  <br />lpDDSPrimary        LPDIRECTDRAWSURFACE  0  <br />lpDDSBack           LPDIRECTDRAWSURFACE  0  <br />lpClipper           LPDIRECTDRAWCLIPPER  0  <br />ddscaps             DDSCAPS             &lt;0&gt; <br />ddsd                DDSURFACEDESC       &lt;0&gt; <br />ddck                DDCOLORKEY          &lt;0&gt; <br />rcWindow            RECT                &lt;0&gt; <br />rcDest              RECT                &lt;0&gt; <br /><br />	dwFrameTime 			DWORD 	0			;  Time of the last frame.<br />	dwFrames 				DWORD  	0		;  The frame rate (frames/second).<br />	dwFrameCount 			DWORD 	0			;  Frames displayed.<br />	outputBuffer 	DB			64 DUP(42)<br />	formatString 	DB 			'%d fps',0		; takes a decimal &quot;input&quot; - %d<br />	dwLength		DWORD			0<br />	<br /><br />.DATA?<br />hInstance    HINSTANCE ?  <br />CommandLine  LPSTR     ?<br />hBitmap      HBITMAP   ?   <br />hdcImage     HDC       ?<br />hdc          HDC       ?<br />bm           BITMAP    &lt;?&gt;<br />hDC          HDC       ?<br /><br />.CODE<br /><br />start:<br /><br />invoke GetModuleHandle, NULL  <br />mov hInstance, eax          <br />invoke WinMain, hInstance, NULL, CommandLine, SW_SHOWDEFAULT<br />invoke ExitProcess, eax<br /><br />WinMain proc hInst     : HINSTANCE,<br />             hPrevInst : HINSTANCE,<br />			 CmdLine   : LPSTR,<br />			 CmdShow   : DWORD <br />    LOCAL wc   : WNDCLASSEX<br />    LOCAL msg  : MSG <br />    LOCAL hwnd : HWND <br /><br />    mov wc.cbSize, SIZEOF WNDCLASSEX                      <br />    mov wc.style, CS_HREDRAW or CS_VREDRAW or CS_DBLCLKS <br />    mov wc.lpfnWndProc, OFFSET WndProc                 <br />    mov wc.cbClsExtra, NULL                           <br />    mov wc.cbWndExtra, NULL                            <br />    mov eax, hInstance                                <br />    mov wc.hInstance, eax                               <br />    invoke GetStockObject,  BLACK_BRUSH;WHITE_BRUSH  <br />    mov wc.hbrBackground, eax                            <br />    mov wc.lpszMenuName, NULL                           <br />    mov wc.lpszClassName, OFFSET szClassName             <br />    invoke LoadIcon, NULL, IDI_APPLICATION               <br />    mov wc.hIcon, eax                                    <br />    mov wc.hIconSm, eax                                  <br />    invoke LoadCursor, NULL,IDC_ARROW                   <br />    mov wc.hCursor, eax <br />    <br />	invoke RegisterClassEx, ADDR wc <br />        ;===============<br />        ; Centre window <br />        ;===============<br /><br />        invoke GetSystemMetrics,SM_CXSCREEN <br />        invoke TopXY,WINDOW_WIDTH,eax<br />		push eax<br /><br />        invoke GetSystemMetrics,SM_CYSCREEN <br />        invoke TopXY,WINDOW_HEIGHT,eax<br /><br />        push eax<br />        pop edx<br />        pop ebx<br /> <br /> 	invoke CreateWindowEx,NULL,\ <br />		ADDR szClassName,\ <br />		ADDR szAppName,\ <br />		WS_OVERLAPPEDWINDOW,\ <br />		ebx,\;WINDOW_LEFT,\ <br />		edx,\;WINDOW_TOP,\ <br />		WINDOW_WIDTH,\ <br />		WINDOW_HEIGHT,\ <br />		NULL,\ <br />		NULL,\ <br />		hInst,\ <br />		NULL <br />    mov MainHWnd, eax                   <br />    <br />	invoke ShowWindow, MainHWnd, CmdShow <br />	invoke UpdateWindow, MainHWnd       <br /><br />	invoke DirectDrawCreate, NULL, ADDR lpDD, NULL<br />	.IF eax != DD_OK<br />		FATAL &quot;Couldn't init DirectDraw&quot;<br />		jmp cdd_Failed<br />	.ENDIF<br /><br />	DDINVOKE SetCooperativeLevel, lpDD, MainHWnd, DDSCL_NORMAL<br />	.IF eax != DD_OK<br />		FATAL &quot;Couldn't set DirectDraw cooperative level&quot;<br />		jmp cdd_Failed<br />	.ENDIF<br /><br />	mov , SIZEOF DDSURFACEDESC<br />	mov , DDSD_CAPS<br />	mov , DDSCAPS_PRIMARYSURFACE<br />	DDINVOKE CreateSurface, lpDD, ADDR ddsd, ADDR lpDDSPrimary, NULL<br />	.IF eax != DD_OK<br />		FATAL &quot;Couldn't create primary surface&quot;<br />		jmp cdd_Failed<br />	.ENDIF<br /><br />	mov ddsd.dwSize, SIZEOF DDSURFACEDESC<br />	mov ddsd.dwFlags, DDSD_CAPS or DDSD_WIDTH or DDSD_HEIGHT<br />	mov ddsd.ddsCaps.dwCaps, DDSCAPS_SYSTEMMEMORY;DDSCAPS_OFFSCREENPLAIN or <br />	mov eax, WINDOW_WIDTH;dwWidth<br />	mov ddsd.dwWidth, eax<br />	mov eax, WINDOW_HEIGHT;dwHeight<br />	mov ddsd.dwHeight, eax<br /><br />	; Create the surface<br />	DDINVOKE CreateSurface, lpDD, ADDR ddsd, ADDR lpDDSBack, NULL<br />;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br />	<br />	DDINVOKE CreateClipper, lpDD, 0, ADDR lpClipper, NULL<br />	.IF eax != DD_OK<br />		FATAL &quot;Couldn't create the clipper&quot;<br />		jmp cdd_Failed<br />	.ENDIF<br /><br />	DDCINVOKE SetHWnd, lpClipper, 0, MainHWnd<br />	.IF eax != DD_OK<br />		FATAL &quot;Couldn't set the hwnd for the clipper&quot;<br />		jmp cdd_Failed<br />	.ENDIF<br /><br />	DDSINVOKE SetClipper, lpDDSPrimary, lpClipper<br />	.IF eax != DD_OK<br />		FATAL &quot;Couldn't set the clipper for the primary surface&quot;<br />		jmp cdd_Failed<br />	.ENDIF<br />	<br />	.IF lpClipper != NULL<br />		DDCINVOKE Release, lpClipper<br />		mov lpClipper, NULL<br />	.ENDIF	<br /><br /><br />	.WHILE TRUE<br />                INVOKE GetMessage, ADDR msg,NULL,0,0<br />                .BREAK .IF (!eax)<br />                invoke RunGame, MainHWnd              ;run FPS**********-**************<br />                INVOKE TranslateMessage, ADDR msg<br />                INVOKE DispatchMessage, ADDR msg<br />	.ENDW<br />	mov     eax,msg.wParam<br />	ret<br /><br />cdd_Failed:<br />	invoke DestroyDirectDraw<br />	ret	<br />WinMain endp<br /><br /><br /><br />WndProc proc hwnd   : HWND,\<br />             uMsg   : UINT,\<br />			 wParam : WPARAM,\<br />			 lParam : LPARAM <br />LOCAL ps : PAINTSTRUCT<br />LOCAL ptWindow : POINT<br />    .IF uMsg == WM_DESTROY         <br />        invoke PostQuitMessage, NULL <br />        <br /> .ELSEIF uMsg==WM_CREATE<br /><br />	.ELSEIF uMsg == WM_QUIT<br />		invoke PostQuitMessage, NULL <br /><br />	.ELSEIF uMsg == WM_MOVE<br />;		invoke UpdateBounds, hwnd<br /><br />	.ELSEIF uMsg==WM_SIZE<br />		invoke GetClientRect, hwnd, addr ptWindow<br />	.ELSEIF uMsg == WM_PAINT<br />		invoke BeginPaint,hwnd,addr ps<br />;Invoke InvalidateRect, hwnd, NULL, TRUE			<br />		invoke EndPaint,hwnd,addr ps	<br />    .ELSE <br />	<br />		invoke DefWindowProc, hwnd, uMsg, wParam, lParam <br />        ret <br />    .ENDIF <br /><br />	xor eax,eax <br />    ret <br />WndProc endp<br /><br />DestroyDirectDraw proc<br />	.IF lpDD != NULL<br />		; Release all the surfaces<br />		SAFE_RELEASE_SURFACE lpDDSPrimary<br />		SAFE_RELEASE_SURFACE lpDDSBack<br /><br />		DDINVOKE Release, lpDD<br />		mov lpDD, NULL<br />	.ENDIF<br />	ret<br />DestroyDirectDraw endp<br /><br />TopXY proc wDim:DWORD, sDim:DWORD<br />    shr sDim, 1      ; divide screen dimension by 2<br />    shr wDim, 1      ; divide window dimension by 2<br />    mov eax, wDim    ; copy window dimension into eax<br />    sub sDim, eax    ; sub half win dimension from half screen dimension<br />    mov eax,sDim<br />    ret<br />TopXY endp<br /><br />; #################################<br />; #################################<br />RunGame proc  hwnd : HWND<br /><br />	; Get a handle to the device context<br />	lea ebx, hDC<br />	DDSINVOKE GetDC, lpDDSBack, ebx<br />	.if eax != DD_OK<br />		jmp	err<br />	.endif<br />	inc <br />	<br />	invoke timeGetTime<br />	sub eax, dwFrameTime<br />	mov ecx,eax<br />	.IF eax &gt;= 1000<br />		mov	eax, <br />		lea	edx, DWORD PTR <br />		lea	eax, DWORD PTR <br />		lea	edx, DWORD PTR <br />		lea	eax, DWORD PTR <br />		sub	edx, edx<br /> 	 	div	ecx<br />	  	mov ,eax	<br /><br />		invoke timeGetTime<br />		mov ,eax<br />		mov ,0<br />	.ENDIF<br /><br />	push  <br />	push offset formatString<br />	push offset outputBuffer<br /><br />	call wsprintfA <br /><br />	add esp,12<br />	<br />	invoke lstrlenA, offset outputBuffer		; API to get null terminated string length<br />	mov ,eax<br /><br />	RGB 255, 255, 255<br />	;------ use this to do some text manipulation/output<br />	invoke SetTextColor,hDC,eax<br />	invoke SetTextAlign,hDC,TA_CENTER<br />	invoke SetBkMode, hDC, TRANSPARENT<br />	invoke TextOutA,hDC,320,10,offset outputBuffer,   <br /><br />	DDSINVOKE ReleaseDC, lpDDSBack, hDC<br />		.if eax != DD_OK<br />		jmp	err<br />	.endif<br /><br /><br />	DDSINVOKE Blt, lpDDSPrimary, ADDR rcWindow, lpDDSBack, NULL, DDBLT_WAIT, NULL<br /><br />	<br />	mov eax, TRUE<br />	ret<br /><br /><br /><br />err:<br />	;===================<br />	; We didn't make it<br />	;===================<br />	mov eax, FALSE<br />	ret	<br />RunGame endp<br /><br /><br />end start</div>
    <div class="meta">Posted on 2003-05-23 20:19:58 by vilik</div>
   </div>
   <div class="post" id="post-104725">
    <div class="subject"><a href="#post-104725">dierctdraw v4 windowed mode. problem</a></div>
    <div class="body">Man once again i ask: <br />-have you narrowed the problem to a specific location? <br />-what works and what does not?</div>
    <div class="meta">Posted on 2003-05-25 11:12:48 by BogdanOntanu</div>
   </div>
   <div class="post" id="post-106025">
    <div class="subject"><a href="#post-106025">dierctdraw v4 windowed mode. problem</a></div>
    <div class="body">I have no idea, really...<br />JUST A BLACK WINDOWS</div>
    <div class="meta">Posted on 2003-06-04 21:47:18 by vilik</div>
   </div>
   <div class="post" id="post-106079">
    <div class="subject"><a href="#post-106079">dierctdraw v4 windowed mode. problem</a></div>
    <div class="body">Ok... there were several problems. The one which stopped anything being displayed was that the Blt was giving an error - it wasn't detected as there was no error checking here. The reason for the error was that the source and destination rects were not correctly set up. I don't know whats going on with the clipper, but i moved that around...<br /><br />Once it was displaying the text, i noted that it overwrote itself, so thats changed a bit. <br /><br />Heres what i edited it to... its still a bit of a mess, but i think it should work now<br /><br />Ossa</div>
    <div class="meta">Posted on 2003-06-05 07:54:21 by Ossa</div>
   </div>
   <div class="post" id="post-107082">
    <div class="subject"><a href="#post-107082">dierctdraw v4 windowed mode. problem</a></div>
    <div class="body">Hi ! <strong>Ossa</strong> :) <br /><br />Work very well :alright: <br /><br />Friendly...Gges</div>
    <div class="meta">Posted on 2003-06-14 08:00:24 by Asmgges</div>
   </div>
  </div>
 </body>
</html>