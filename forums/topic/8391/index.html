<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Regarding IMAGE_RESOURCE_DIRECTORY_ENTRY - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=8391" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=8391">Regarding IMAGE_RESOURCE_DIRECTORY_ENTRY</a></p>
   <div class="post" id="post-61309">
    <div class="subject"><a href="#post-61309">Regarding IMAGE_RESOURCE_DIRECTORY_ENTRY</a></div>
    <div class="body">Hi,<br /><br />I have been trying to read resources using the structs like IMAGE_RESOURCE_ENTRY etc. However I got stuck at one part, and was hoping that the forumers would be able to help me ;)<br /><br /><pre><code><br />ExtractResources proc uses edi ecx ebx edx esi<br />	mov 	edi, pMapping<br />	assume	edi&#58;PTR IMAGE_DOS_HEADER<br />	add	edi,&#91;edi&#93;.e_lfanew<br />	assume	edi&#58;PTR IMAGE_NT_HEADERS<br />	mov	eax,&#91;edi&#93;.OptionalHeader.DataDirectory&#91;SIZEOF IMAGE_DATA_DIRECTORY * 2&#93;.VirtualAddress<br />	cmp	eax,0<br />	jnz	Resource<br />NoResource&#58;<br />	invoke	MessageBox,0, ADDR NoRes, ADDR Error, MB_OK<br />	ret<br />Resource&#58;<br />	invoke	RVAToOffset,pMapping,eax<br />	add	eax,pMapping<br />	mov	edi,eax<br />	assume	edi&#58;PTR IMAGE_RESOURCE_DIRECTORY<br />	mov	cx, &#91;edi&#93;.NumberOfIdEntries<br />	movzx	ecx,cx	<br />	mov	IDEntries,ecx<br />	mov	bx,&#91;edi&#93;.NumberOfNamedEntries<br />	movzx	ebx,bx<br />	add	ecx,ebx ;Total number of Resource_directory<br />	add	edi,SIZEOF IMAGE_RESOURCE_DIRECTORY<br />	assume	edi&#58;PTR IMAGE_RESOURCE_DIRECTORY_ENTRY<br />mainloop&#58;<br />	push	ecx<br />	mov	tvs.hParent,TVI_ROOT<br />	cmp	DWORD PTR&#91;edi&#93;,1<br />	je		cursor<br />	cmp	DWORD PTR&#91;edi&#93;,2<br />	je		bitmap<br />	cmp	DWORD PTR&#91;edi&#93;,3<br />	je		icon<br />	cmp	DWORD PTR&#91;edi&#93;,4<br />	je		menu<br />	cmp	DWORD PTR&#91;edi&#93;,5<br />	je		dialog<br />	cmp	DWORD PTR&#91;edi&#93;,6<br />	je		stringtable<br />	cmp	DWORD PTR&#91;edi&#93;,11<br />	je		messagetable<br />	cmp	DWORD PTR&#91;edi&#93;,12<br />	je		groupcursor<br />	cmp	DWORD PTR&#91;edi&#93;,14<br />	je		groupicon<br />	cmp	DWORD PTR&#91;edi&#93;,16<br />	je		versioninfo<br />	jmp	mainloopcontinue<br />cursor&#58;<br />	mov	tvs.item.pszText, OFFSET szcursor<br />	invoke	SendMessage,hTreeView,TVM_INSERTITEM,0,ADDR tvs<br />	mov	hTree,eax<br />	lea	edx,&#91;edi+eax+0ch&#93;		;OffsetToData<br />	and	edx,0000ffffh<br />	xor	ebx,ebx<br />	xor	ecx,ecx<br />	mov	cx,WORD PTR&#91;edi+edx&#93;		;NamedEntries &lt;----the value i get here is incorrect. It is too large<br />cursorloop1&#58;<br />	test	ecx,ecx<br />	jz		cursorloop2<br />	lea	eax,&#91;edi+edx+4&#93;			;Address of Resource name<br />										;same as adding SIZEOF resource directory entry, just that to preserve register values<br />	push	ecx<br />	mov	ecx,ebx<br />	shl	ecx,3<br />	add	eax,ecx				;eax = Position of pointer in the resource directory entry<br />	pop	ecx<br />	push	WORD PTR&#91;eax&#93;<br />int 3<br />	add	eax,2<br />	push	eax<br />	lea	eax,buffer<br />	push	eax<br />	call	lstrcpyn<br />	invoke	MessageBox,0,ADDR buffer,0,0<br />	inc	ebx<br />	dec	ecx<br />	jnz	cursorloop1<br />	mov	cx,WORD PTR&#91;edi+edx+2&#93;	;ID Entries<br />	movzx	ecx,cx<br />cursorloop2&#58;<br />	jmp	mainloopcontinue<br />bitmap&#58;<br />	mov	tvs.item.pszText, OFFSET szbitmap<br />	invoke	SendMessage,hTreeView,TVM_INSERTITEM,0,ADDR tvs<br />	mov	&#91;hTree+4&#93;,eax<br />	jmp	mainloopcontinue<br />icon&#58;<br />	mov	tvs.item.pszText, OFFSET szicon<br />	invoke	SendMessage,hTreeView,TVM_INSERTITEM,0,ADDR tvs<br />	mov	&#91;hTree+8&#93;,eax<br />	jmp	mainloopcontinue<br />menu&#58;<br />	mov	tvs.item.pszText, OFFSET szmenu<br />	invoke	SendMessage,hTreeView,TVM_INSERTITEM,0,ADDR tvs<br />	mov	&#91;hTree+12&#93;,eax<br />	jmp	mainloopcontinue<br />dialog&#58;<br />	mov	tvs.item.pszText, OFFSET szdialog<br />	invoke	SendMessage,hTreeView,TVM_INSERTITEM,0,ADDR tvs<br />	mov	&#91;hTree+16&#93;,0<br />	jmp	mainloopcontinue<br />stringtable&#58;<br />	mov	tvs.item.pszText, OFFSET szstringtable<br />	invoke	SendMessage,hTreeView,TVM_INSERTITEM,0,ADDR tvs<br />	mov	&#91;hTree+20&#93;,0<br />	jmp	mainloopcontinue<br />messagetable&#58;<br />	mov	tvs.item.pszText, OFFSET szmessagetable<br />	invoke	SendMessage,hTreeView,TVM_INSERTITEM,0,ADDR tvs<br />	mov	&#91;hTree+24&#93;,0<br />	jmp	mainloopcontinue<br />groupcursor&#58;<br />	mov	tvs.item.pszText, OFFSET szgroupcursor<br />	invoke	SendMessage,hTreeView,TVM_INSERTITEM,0,ADDR tvs<br />	mov	&#91;hTree+28&#93;,0<br />	jmp	mainloopcontinue<br />groupicon&#58;<br />	mov	tvs.item.pszText, OFFSET szgroupicon<br />	invoke	SendMessage,hTreeView,TVM_INSERTITEM,0,ADDR tvs<br />	mov	&#91;hTree+32&#93;,0<br />	jmp	mainloopcontinue<br />versioninfo&#58;<br />	mov	tvs.item.pszText, OFFSET szversioninfo<br />	invoke	SendMessage,hTreeView,TVM_INSERTITEM,0,ADDR tvs<br />	mov	&#91;hTree+36&#93;,0<br />	jmp	mainloopcontinue<br />mainloopcontinue&#58;<br />	add	edi, SIZEOF IMAGE_RESOURCE_DIRECTORY_ENTRY<br />	pop	ecx<br />	dec	ecx<br />	jnz	mainloop<br />	ret<br />ExtractResources endp<br /></code></pre></div>
    <div class="meta">Posted on 2002-10-11 06:48:19 by roticv</div>
   </div>
   <div class="post" id="post-61884">
    <div class="subject"><a href="#post-61884">Regarding IMAGE_RESOURCE_DIRECTORY_ENTRY</a></div>
    <div class="body"><div class="quote">	lea	edx,		;OffsetToData<br />	and	edx,0000ffffh<br />	xor	ebx,ebx<br />	xor	ecx,ecx<br />	mov	cx,WORD PTR		;NamedEntries &lt;----the value i get here is incorrect. It is too large</div>this looks not bad, didn't you mix up &lt;lea edx, &gt; and &lt;mov edx, &gt;?</div>
    <div class="meta">Posted on 2002-10-15 12:55:20 by beaster</div>
   </div>
   <div class="post" id="post-61955">
    <div class="subject"><a href="#post-61955">Regarding IMAGE_RESOURCE_DIRECTORY_ENTRY</a></div>
    <div class="body">Yeah... i did mess it up there, i fixed that part. However i got stuck in another part.. haix.. this is so complicated.</div>
    <div class="meta">Posted on 2002-10-16 01:41:37 by roticv</div>
   </div>
  </div>
 </body>
</html>