<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Code for Using Animated Icons and Cursors - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=14166" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=14166">Code for Using Animated Icons and Cursors</a></p>
   <div class="post" id="post-109484">
    <div class="subject"><a href="#post-109484">Code for Using Animated Icons and Cursors</a></div>
    <div class="body">Lately I have been interested in the Resource section of the .EXE and .DLL<br />files and found only one reference to their use and creation on the web.<br /><br />The following code will allow the use of an RT_ANIICON or RT_CURSOR to<br />change the cursor or create an animated icon in a widow or dialog box.<br /><br />For the Dialog Box Template the control entries are:<br /><br />CONTROL  NULL, IDI_ICON, &quot;UserAniIcon32&quot;, NULL, Dx, Dy, NULL, NULL<br /><br />Where:<br /><br />IDI_ICON - Is the resourceID in this program of the Animated Icon or Cursor.<br />           Dx - Is the Horizontal position of the upper left corner in Dialog Units.<br />           Dy - Is the Vertical position of the upper left corner in Dialog Units.<br /><br />The WndProc for the class sets all other values.<br /><br />Note: The description above will handle internal reources in the module.<br /><br />To use an .ANI file with full path and filename include quotes in the text entry<br />and use the form:<br /><br />CONTROL  &quot;'C:\Test.ANI'&quot;, IDC_ICONX, &quot;UserAniIcon32&quot;, NULL, Dx, Dy, NULL, NULL<br /><br />Where:<br />&quot;'C:\Test.ANI'&quot; - Is a sample of the path and filename with 's added<br />     IDI_ICONX - Is the child window ID for the control.<br />                  Dx - Is the Horizontal position of the upper left corner in Dialog Units.<br />                  Dy - Is the Vertical position of the upper left corner in Dialog Units.<br /><br />The WndProc for the class sets all other values.<br /><br />The programmer must include the following line in WinMain if using the template controls:<br />                     invoke InitUserAniIcon<br /> <br />To set a Class Cursor use:<br /><br />                     invoke LoadAnimatedResource, hInstance, ADDR AniData, ADDR szAni<br />                     .IF   eax == TRUE<br />                            invoke SetClassLong, hWnd, GCL_HCURSOR, AniData.hRAnimated<br />                     .ENDIF<br />Where:<br /><br />hInstance - Is the module handle of the current program or a module handle of a<br />                   library loaded with LoadLibrary.<br />   AniData - Is a defined ANIRESOURCE_INFO structure.<br />       szAni - Is the ResourceID, ResourceName String, or full path and filename in<br />                  quotes. Note ADDR is not used with the ResourceID.<br /><br />To Create an Animated Icon as a Child Window use:<br /><br />For resources using ID#<br /> <br />                     invoke CreateAnimatedIcon, hWnd, x, y, ResourceID, NULL<br /><br />For Named Resources or Full path and filename<br /><br />                     invoke CreateAnimatedIcon, hWnd, x, y, IDI_ICONX, ADDR szAni<br /><br />The ResourceID and Named Resource types is limited to the current program.<br /><br />Where:<br /><br />x - Is the horizontal client position of the upper left corner in pixels.<br />y - Is the vertical client position of the upper left corner in pixels.<br />ResourceID - Numeric resource ID of the icon or cursor<br />IDI_ICONX - User supplied unique child ID<br />szAni - As described for the Named Resources and Full path and filename above.<br /><br />I have included all of my routines in the coding and used no macros for clarity.<br /><pre><code><br /><br />FillBuffer  proc lpBuffer&#58;DWORD,lenBuffer&#58;DWORD,TheChar&#58;DWORD<br />            push edi<br />            push ecx<br />            mov edi, lpBuffer   ; address of buffer<br />            mov ecx, lenBuffer  ; buffer length<br />            mov eax, TheChar    ; load al with character using eax<br />            rep stosb           ; write character to buffer until ecx = 0<br />            pop ecx<br />            pop edi<br />            ret<br />FillBuffer  endp<br /><br />;------------------------------------------------------------------------------------;<br />; Procedure&#58;  LoadAnimatedResource                                                ;<br />;                                                                                                         ;<br />;   Purpose&#58;  To retrieve a RT_ANICURSOR or RT_ANIICON from the  ;<br />;                   current program or a library module loaded with the     ;<br />;                   LoadLibrary function.                                                      ;<br />;                                                                                                          ;<br />; Protected&#58;  edi, esi, edx, ecx, ebx.                                                    ;<br />;                                                                                                          ;<br />; Arguments&#58;  hModule   DWORD  The instance handle of the            ;<br />;                                                    current program or the handle      ;<br />;                                                    returned by the LoadLibrary         ;<br />;                                                    function.                                        ;<br />;                                                                                                          ;<br />;             pAniInfo  DWORD  A pointer to a user                                  ;<br />;                                          created ANIRESOURCE_INFO                  ;<br />;                                         structure to contain the returned data.  ;<br />;                                                                                                        ;<br />;             ResID     DWORD  A valid resource ID or pointer to a         ;<br />;                                         resource name string. This is the same  ;<br />;                                         as defined for functions                          ;<br />;                              like LoadCursor. To allow for loading files the     ;<br />;                              resource name string can contain the full path and  ;<br />;                              name of a file with the .ANI extension.  To use a   ;<br />;                              filename place the path and name in quotation       ;<br />;                              marks&#40; either single or double&#41;.                    ;<br />;                                                                                  ;<br />;    Return&#58;  TRUE if the ANIRESOURCE_INFO structure has been filled.              ;<br />;                                                                                  ;<br />;             FALSE if the ANIRESOURCE_INFO pointer is invalid and data cannot     ;<br />;                   be passed.                                                     ;<br />;                                                                                  ;<br />;   Remarks&#58;  Animated icons and cursors have been allowed as resources since      ;<br />;             NT 4.0 however, the normal mechanisms for loading resources will     ;<br />;             only retrieve regular icons and cursors from a programs resources.   ;<br />;                                                                                  ;<br />;             The LoadCursorFromFile function and the superceeding LoadImage will  ;<br />;             only load RT_ANICURSOR types from files &#40;even LoadImage fails to     ;<br />;             load RT_ANIICON&#41; from .ANI type files.                               ;<br />;                                                                                  ;<br />;             This routine will retrieve the resource from a module copy the data  ;<br />;             to a temporary file and use LoadImage to retrieve the handle for a   ;<br />;             cursor which may be used as a cursor or through the use of DrawIcon  ;<br />;             or my CreateAminatedIcon use it as an icon.                          ;<br />;                                                                                  ;<br />;             Additional information for the number or frames and framerate are    ;<br />;             retrieved from the RIFF data during the process.                     ;<br />;                                                                                  ;<br />;             Memory used here cannot not released until the programs termination. ;<br />;                                                                                  ;<br />;----------------------------------------------------------------------------------;<br />;<br />.data<br />FAILED_MODULEHANDLE  equ   0001h<br />FAILED_ANIRESOURCEI  equ   0002h<br />FAILED_RESOURCETYPE  equ   0004h<br />FAILED_RESIURCEID    equ   0008h<br />FAILED_FINDRESOURCE  equ   0010h<br />FAILED_LOADRESOURCE  equ   0020h<br />FAILED_LOCKRESOURCE  equ   0040h<br />FAILED_FINDFRAMES    equ   0080h<br />FAILED_FINDRATE      equ   0100h<br />FAILED_CREATETEMP    equ   0200h<br />FAILED_WRITETEMP     equ   0400h<br />FAILED_LOADTEMP      equ   0800h<br />FAILED_OPENANI       equ   1000h<br />FAILED_CREATEICON    equ   2000h<br />ANIRESOURCE_INFO  Struct<br />                  ErrorCode   DWORD ?<br />                  hRAnimated  DWORD ?<br />                  cFrames     DWORD ?<br />                  cFrameRate  DWORD ?<br />ANIRESOURCE_INFO  Ends<br />ANIICON_INFO   Struct<br />               pResInfo    DWORD ?<br />               hWndIcon    DWORD ?<br />               hImage      DWORD ?<br />               TimerID     DWORD ?<br />               cFrames     DWORD ?<br />               cFrameRate  DWORD ?<br />               FrameNumber DWORD ?<br />               RateCount   DWORD ?<br />               FrameChange DWORD ?<br />ANIICON_INFO   Ends<br />hValueRiff  DD 46464952h   ;&quot;FFIR&quot;<br />hValueRate  DD 65746172h   ;&quot;etar&quot;<br />hValueAnih  DD 68696E61h   ;&quot;hina&quot;<br />szTempANI   db &quot;TempFile.ANI&quot;, 00h<br />TempBuffer  db MAX_PATH+1 dup   &#40;00h&#41;<br />.code<br />LoadResourceFile  Proc  USES edi esi edx ecx ebx, \<br />                        pAniInfo&#58;DWORD, ResID&#58;DWORD<br />                  LOCAL vRet&#58;DWORD, fDone&#58;DWORD<br />                  LOCAL hResFile&#58;DWORD<br />                  LOCAL hMap&#58;DWORD, pMap&#58;DWORD, pEndMap&#58;DWORD<br />                  LOCAL cbSizeOfMap&#58;DWORD<br />                  LOCAL vQuoteUsed&#58;BYTE<br />                  <br />                  mov   vRet, FALSE<br />                  mov   edi, pAniInfo<br />                  ASSUME edi&#58;PTR ANIRESOURCE_INFO<br /><br />                  mov   eax, ResID<br />                  and   eax, 0FFFF0000h         ;Check Numeric ID<br />                  jz    LoadResourceFile_Exit   ;Is Numeric Exit<br /><br />               ;<br />               ; Check first character ' or &quot;<br />               ;<br />                  mov   esi, ResID<br />                  mov   al, &#91;esi&#93;<br />                  .IF   &#40;&#40;al == '&quot;'&#41; || &#40;al == &quot;'&quot;&#41;&#41;<br />                        mov   vQuoteUsed, al<br />                        invoke FillBuffer, ADDR TempBuffer, MAX_PATH+1, NULL<br />                        push  edi<br />                        mov   edi, Offset TempBuffer<br />                        inc   esi<br />                        mov   fDone, NULL<br />                        .WHILE   fDone == NULL<br />                                 mov   al, &#91;esi&#93;<br />                                 .IF   al != vQuoteUsed<br />                                       mov   &#91;edi&#93;, al<br />                                       inc   esi<br />                                       inc   edi<br />                                 .ELSE<br />                                       mov   fDone, 1<br />                                 .ENDIF<br />                        .ENDW<br />                        pop   edi      <br />               ;<br />               ; We have a file so open it<br />               ;<br />                        mov   vRet, TRUE<br />                        invoke CreateFile, ADDR TempBuffer, GENERIC_READ, NULL, NULL, \<br />                                           OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL<br />                        mov   hResFile, eax<br />                        .IF   eax == NULL<br />                              or &#91;edi&#93;.ErrorCode, FAILED_OPENANI<br />                              jmp   LoadResourceFile_Exit<br />                        .ENDIF<br />               ;<br />               ; Now map the file<br />               ;<br />                        invoke CreateFileMapping, hResFile, NULL, PAGE_READONLY, \<br />                                                                   NULL,NULL, NULL<br />                        mov   hMap, eax<br />                        .IF   eax == NULL<br />                              or &#91;edi&#93;.ErrorCode, FAILED_OPENANI<br />                              jmp   LoadResourceFile_Exit<br />                        .ENDIF<br />                        invoke MapViewOfFile, hMap, FILE_MAP_READ, NULL, NULL, NULL<br />                        mov   pMap, eax<br />                        .IF   eax == NULL<br />                              or &#91;edi&#93;.ErrorCode, FAILED_OPENANI<br />                              jmp   LoadResourceFile_ExitMap<br />                        .ENDIF<br />               ;<br />               ; pMap points to a the start of the RIFF<br />               ;   Get the Size in bytes<br />               ;<br />                        mov   eax, pMap<br />                        mov   eax, &#91;eax&#93;<br />                        .IF   eax != hValueRiff<br />                              or &#91;edi&#93;.ErrorCode, FAILED_OPENANI<br />                              jmp   LoadResourceFile_ExitView<br />                        .ELSE<br />                              mov   eax, pMap<br />                              add   eax, 4<br />                              mov   eax, &#91;eax&#93;<br />                              mov   cbSizeOfMap, eax<br />                              add   eax, pMap<br />                              mov   pEndMap, eax<br />               ;<br />               ; Find Frames in the anih<br />               ;<br />                              and   fDone, NULL<br />                              mov   esi, pMap<br />                              .WHILE   &#40;esi &lt; pEndMap&#41; &amp;&amp; &#40;fDone == NULL&#41;<br />                                       mov   eax, &#91;esi&#93;<br />                                       .IF   eax == hValueAnih<br />                                             add   esi, 12<br />                                             mov   eax, &#91;esi&#93;<br />                                             mov   &#91;edi&#93;.cFrames, eax<br />                                             or    fDone, 1<br />                                       .ELSE<br />                                             inc   esi<br />                                       .ENDIF<br />                              .ENDW<br />                              .IF   fDone == NULL<br />                                    or &#91;edi&#93;.ErrorCode, FAILED_FINDFRAMES or FAILED_OPENANI<br />                                    jmp   LoadResourceFile_ExitView<br />                              .ENDIF<br />               ;<br />               ; Find Rate in the rate<br />               ;<br />                              and   fDone, NULL<br />                              mov   esi, pMap<br />                              .WHILE   &#40;esi &lt; pEndMap&#41; &amp;&amp; &#40;fDone == NULL&#41;<br />                                       mov   eax, &#91;esi&#93;<br />                                       .IF   eax == hValueRate<br />                                             add   esi, 4<br />                                             mov   eax, &#91;esi&#93;<br />                                             mov   &#91;edi&#93;.cFrameRate, eax<br />                                             or    fDone, 1<br />                                       .ELSE<br />                                             inc   esi<br />                                       .ENDIF<br />                              .ENDW<br />                              .IF   fDone == NULL<br />                                    or &#91;edi&#93;.ErrorCode, FAILED_FINDRATE or FAILED_OPENANI<br />                                    jmp   LoadResourceFile_ExitView<br />                              .ENDIF<br />               ;<br />               ; UnMap and Close the file<br />               ;<br />                              invoke UnmapViewOfFile, pMap<br />                              invoke CloseHandle, hMap<br />                              invoke CloseHandle, hResFile<br />               <br />               ;<br />               ; Load the Animated Cursor - Yes Animated Icons are Animated Cursors<br />               ;<br />                              invoke LoadImage, NULL, ADDR TempBuffer, IMAGE_CURSOR, \<br />                                                NULL, NULL, LR_LOADFROMFILE<br />                              .IF   eax == NULL<br />                                    or &#91;edi&#93;.ErrorCode, FAILED_OPENANI<br />                              .ENDIF<br />                                       <br />                              mov   &#91;edi&#93;.hRAnimated, eax<br />                        .ENDIF<br />                  .ENDIF<br />LoadResourceFile_ExitView&#58;<br />                  invoke UnmapViewOfFile, pMap<br />LoadResourceFile_ExitMap&#58;<br />                  invoke CloseHandle, hMap<br />                  invoke CloseHandle, hResFile<br />LoadResourceFile_Exit&#58;<br />                  ASSUME edi&#58;NOTHING<br />                  mov   eax, vRet<br />                  ret                  <br />LoadResourceFile  Endp<br />.code<br />LoadAnimatedResource Proc  USES edi esi edx ecx ebx, \<br />                           hModule&#58;DWORD, pAniInfo&#58;DWORD, ResID&#58;DWORD<br /><br />                     LOCAL vRet&#58;DWORD<br />                     LOCAL hResource&#58;HANDLE, hResMemory&#58;DWORD, pResMemory&#58;DWORD<br />                     LOCAL cbSizeOfResource&#58;DWORD, hTempFile&#58;DWORD<br />                     LOCAL cbBytesWritten&#58;DWORD, pEndResMemory&#58;DWORD, fDone&#58;DWORD<br /><br />                     mov   vRet, FALSE<br />                     mov   edi, pAniInfo<br />                     ASSUME edi&#58;PTR ANIRESOURCE_INFO<br />                     <br />                     .IF   pAniInfo == NULL<br />                           jmp   LoadAnimatedResource_Exit<br />                     .ENDIF<br />                     .IF   hModule == NULL<br />                           or &#91;edi&#93;.ErrorCode, FAILED_MODULEHANDLE<br />                           jmp   LoadAnimatedResource_Exit<br />                     .ENDIF<br />                     .IF   ResID == NULL<br />                           or &#91;edi&#93;.ErrorCode, FAILED_RESIURCEID<br />                           jmp   LoadAnimatedResource_Exit<br />                     .ENDIF<br /><br />                     mov   eax, NULL<br />                     mov   &#91;edi&#93;.ErrorCode, eax<br />               ;<br />               ; Check for a filename rather than a resource<br />               ;<br />                     invoke LoadResourceFile, pAniInfo, ResID<br />                     .IF   eax == TRUE<br />                           .IF   &#91;edi&#93;.ErrorCode == NULL<br />                                 mov   vRet, TRUE<br />                           .ELSE<br />                                 mov   vRet, FALSE<br />                           .ENDIF<br />                           jmp LoadAnimatedResource_Exit<br />                     .ENDIF<br />               ;<br />               ; Find the Resource from the Module RT_ANIICON or RT_ANICURSOR<br />               ;<br />                     Invoke FindResource, hModule, ResID, RT_ANIICON<br />                     mov   hResource, eax<br />                     .IF   eax == NULL<br />                           Invoke FindResource, hModule, ResID, RT_ANICURSOR<br />                           mov   hResource, eax<br />                           .IF   eax == NULL<br />                                 or &#91;edi&#93;.ErrorCode, FAILED_FINDRESOURCE<br />                                 jmp   LoadAnimatedResource_Exit<br />                           .ENDIF<br />                     .ENDIF<br />               ;<br />               ; Load it to Global Memory and get a pointer<br />               ;<br />                     invoke LoadResource, hInstance, hResource<br />                     mov   hResMemory, eax<br />                     .IF   eax == NULL<br />                           or &#91;edi&#93;.ErrorCode, FAILED_LOADRESOURCE<br />                           jmp   LoadAnimatedResource_Exit<br />                     .ENDIF<br />                     invoke LockResource, hResMemory<br />                     mov   pResMemory, eax<br />                     .IF   eax == NULL<br />                           or &#91;edi&#93;.ErrorCode, FAILED_LOCKRESOURCE<br />                           jmp   LoadAnimatedResource_Exit<br />                     .ENDIF<br />               ;<br />               ; hResource points to a Resource_Data_Entry<br />               ;   Get the Size in bytes<br />               ;<br />                     mov   eax, hResource<br />                     add   eax, 4<br />                     mov   eax, &#91;eax&#93;<br />                     mov   cbSizeOfResource, eax<br />                     add   eax, pResMemory<br />                     mov   pEndResMemory, eax<br />               ;<br />               ; Find Frames in the anih<br />               ;<br />                     and   fDone, NULL<br />                     mov   esi, pResMemory<br />                     .WHILE   &#40;esi &lt; pEndResMemory&#41; &amp;&amp; &#40;fDone == NULL&#41;<br />                              mov   eax, &#91;esi&#93;<br />                              .IF   eax == hValueAnih<br />                                    add   esi, 12<br />                                    mov   eax, &#91;esi&#93;<br />                                    mov   &#91;edi&#93;.cFrames, eax<br />                                    or    fDone, 1<br />                              .ELSE<br />                                    inc   esi<br />                              .ENDIF<br />                     .ENDW<br />                     .IF   fDone == NULL<br />                           or &#91;edi&#93;.ErrorCode, FAILED_FINDFRAMES<br />                           jmp   LoadAnimatedResource_Exit<br />                     .ENDIF<br />               ;<br />               ; Find Rate in the rate<br />               ;<br />                     and   fDone, NULL<br />                     mov   esi, pResMemory<br />                     .WHILE   &#40;esi &lt; pEndResMemory&#41; &amp;&amp; &#40;fDone == NULL&#41;<br />                              mov   eax, &#91;esi&#93;<br />                              .IF   eax == hValueRate<br />                                    add   esi, 4<br />                                    mov   eax, &#91;esi&#93;<br />                                    mov   &#91;edi&#93;.cFrameRate, eax<br />                                    or    fDone, 1<br />                              .ELSE<br />                                    inc   esi<br />                              .ENDIF<br />                     .ENDW<br />                     .IF   fDone == NULL<br />                           or &#91;edi&#93;.ErrorCode, FAILED_FINDRATE<br />                           jmp   LoadAnimatedResource_Exit<br />                     .ENDIF<br />               ;<br />               ; Create a temporary file in the program directory<br />               ;<br />                     invoke CreateFile, ADDR szTempANI, GENERIC_WRITE, NULL, NULL, \<br />                                        CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL<br />                     mov   hTempFile, eax<br />                     .IF   eax == INVALID_HANDLE_VALUE<br />                           or &#91;edi&#93;.ErrorCode, FAILED_CREATETEMP<br />                           jmp   LoadAnimatedResource_Exit<br />                     .ENDIF<br />               ;<br />               ; Write the Resource to the TempFile.ANI file<br />               ;<br />                     invoke WriteFile, hTempFile, pResMemory, \<br />                                       cbSizeOfResource, ADDR cbBytesWritten, NULL<br />                     .IF   eax == FALSE<br />                           or &#91;edi&#93;.ErrorCode, FAILED_WRITETEMP<br />                           jmp   LoadAnimatedResource_Exit<br />                     .ENDIF<br /><br /><br />               ;<br />               ; Close the TempFile.ANI file<br />               ;<br />                     invoke CloseHandle, hTempFile<br />               ;<br />               ; Load the Animated Cursor - Yes Animated Icons are Animated Cursors<br />               ;<br />                     invoke LoadImage, NULL, ADDR szTempANI, IMAGE_CURSOR, \<br />                                       NULL, NULL, LR_LOADFROMFILE<br />                     .IF   eax == NULL<br />                           or &#91;edi&#93;.ErrorCode, FAILED_LOADTEMP<br />                           jmp   LoadAnimatedResource_Exit<br />                     .ENDIF<br />                                       <br />                     mov   &#91;edi&#93;.hRAnimated, eax<br />                     mov   vRet, TRUE<br />LoadAnimatedResource_Exit&#58;<br />                     mov   eax, vRet<br />                     ASSUME edi&#58;NOTHING<br />                     ret<br />LoadAnimatedResource Endp<br />.data?<br />AniWndProcResID   DWORD ?<br />.data<br />AniTimerCount  DWORD 00h<br />.code<br />AniIconWndProc Proc hWnd&#58;HWND, uMsg&#58;UINT, wParam&#58;WPARAM, lParam&#58;LPARAM<br />               LOCAL pResInfo&#58;DWORD, pIconInfo&#58;DWORD<br />               LOCAL wWidth&#58;DWORD, wHeight&#58;DWORD, vBaseUnits&#58;DWORD<br />               LOCAL IRect&#58;RECT, IPoint&#58;POINT, hWndParent&#58;DWORD<br />               LOCAL ps&#58;PAINTSTRUCT, hDC&#58;HDC<br />               <br />               push  edi<br />               push  esi<br /><br />               .IF   uMsg == WM_NCCREATE<br />                     mov   eax, lParam<br />                     ASSUME eax&#58;PTR CREATESTRUCT<br />               ;<br />               ; Get the Resource ID or Name from the Title field<br />               ; Save it to a global variable and replace it with NULL<br />               ;<br />                     mov   ebx, &#91;eax&#93;.lpszName<br />                     .IF   ebx == NULL<br />                           invoke GetWindowLong, hWnd, GWL_ID<br />                           mov   AniWndProcResID, eax<br />                     .ELSE<br />                           mov   AniWndProcResID, ebx<br />                           mov   &#91;eax&#93;.lpszName, NULL<br />                     .ENDIF<br />                     ASSUME eax&#58;NOTHING<br />                     invoke SetWindowLong, hWnd, GWL_EXSTYLE, WS_EX_TRANSPARENT <br />                     invoke SetWindowLong, hWnd, GWL_STYLE, WS_CHILD or WS_BORDER <br />                     mov   eax, TRUE<br />                     ret<br /><br />               .ELSEIF  uMsg == WM_CLOSE<br />                              invoke DestroyWindow, hWnd<br />                              <br />               .ELSEIF  uMsg == WM_DESTROY<br />                        invoke GetWindowLong, hWnd, GWL_USERDATA<br />                        .IF   eax != NULL<br />                              mov   esi, eax<br />                              ASSUME esi&#58;PTR ANIICON_INFO<br />                              .IF   &#91;esi&#93;.hImage != NULL<br />                                    invoke DestroyCursor, &#91;esi&#93;.hImage<br />                              .ENDIF<br />                              .IF   &#91;esi&#93;.pResInfo != NULL<br />                                    invoke GlobalFree, &#91;esi&#93;.pResInfo<br />                              .ENDIF<br />                              .IF   &#91;esi&#93;.TimerID != NULL<br />                                    invoke KillTimer, &#91;esi&#93;.hWndIcon, &#91;esi&#93;.TimerID<br />                              .ENDIF<br />                              invoke GlobalFree, esi<br />                        .ENDIF<br />                        <br />               .ELSEIF  uMsg == WM_CREATE<br />                        invoke SetWindowLong, hWnd, GWL_USERDATA, NULL<br />                        invoke GlobalAlloc, GPTR, SIZEOF ANIICON_INFO<br />                        mov   pIconInfo, eax<br />                        .IF   eax == NULL<br />                              invoke SendMessage, hWnd, WM_CLOSE, NULL, NULL<br />                              jmp   AniIconWndProc_Exit<br />                        .ENDIF<br />                        invoke SetWindowLong, hWnd, GWL_USERDATA, pIconInfo<br />                        mov   esi, pIconInfo<br />                        ASSUME esi&#58;PTR ANIICON_INFO<br />                        invoke GlobalAlloc, GPTR, SIZEOF ANIRESOURCE_INFO<br />                        mov   pResInfo, eax<br />                        .IF   eax == NULL<br />                              invoke SendMessage, hWnd, WM_CLOSE, NULL, NULL<br />                              jmp   AniIconWndProc_Exit<br />                        .ENDIF<br />                        mov   &#91;esi&#93;.pResInfo, eax<br />                        mov   eax, hWnd<br />                        mov   &#91;esi&#93;.hWndIcon, eax<br />                  ;<br />                  ; Load as Cursor first and then Icon to allow for varied use<br />                  ;<br />                        mov   edi, pResInfo<br />                        ASSUME edi&#58;PTR ANIRESOURCE_INFO<br />                        invoke LoadAnimatedResource, hInstance, pResInfo, AniWndProcResID<br />                        .IF   eax == TRUE<br />                              mov   eax, &#91;edi&#93;.hRAnimated<br />                              mov   &#91;esi&#93;.hImage, eax<br />                              mov   eax, &#91;edi&#93;.cFrames<br />                              mov   &#91;esi&#93;.cFrames, eax<br />                              mov   eax, &#91;edi&#93;.cFrameRate<br />                              mov   &#91;esi&#93;.cFrameRate, eax<br />                              mov   &#91;esi&#93;.RateCount, eax<br />                              and   &#91;esi&#93;.FrameNumber, NULL<br />                              mov   &#91;esi&#93;.FrameChange, 1<br />                        .ELSE<br />                              and   &#91;esi&#93;.hImage, NULL<br />                              invoke SendMessage, hWnd, WM_CLOSE, NULL, NULL<br />                              jmp   AniIconWndProc_Exit<br />                        .ENDIF<br />                  ;<br />                  ; Now Create the Timer<br />                  ;<br />                        inc   AniTimerCount<br />                        invoke SetTimer, hWnd, AniTimerCount, 11h, NULL<br />                        mov   eax, AniTimerCount<br />                        mov   &#91;esi&#93;.TimerID, eax<br />                  ;<br />                  ; Mow resize the window to 20 dialog units square<br />                  ;<br />                        invoke GetWindowRect, hWnd, ADDR IRect<br />                        invoke GetDialogBaseUnits<br />                        mov   vBaseUnits, eax<br />                        and   eax, 0000FFFFh<br />                        push  edx<br />                        xor   edx, edx<br />                        push  ecx<br />                        mov   ecx, 18<br />                        mul   ecx<br />                        mov   ecx, 4<br />                        div   ecx<br />                        mov   wWidth, eax<br />                        xor   edx, edx<br />                        mov   eax, vBaseUnits<br />                        shr   eax, 10h<br />                        mov   ecx, 18<br />                        mul   ecx<br />                        mov   ecx, 8<br />                        div   ecx<br />                        mov   wHeight, eax<br />                        pop   ecx<br />                        pop   edx<br />                        mov   eax, IRect.left<br />                        mov   IPoint.x, eax<br />                        mov   eax, IRect.top<br />                        mov   IPoint.y, eax<br />                        invoke GetWindowLong, hWnd, GWL_HWNDPARENT<br />                        mov   hWndParent, eax<br />                        invoke ScreenToClient, hWndParent, ADDR IPoint<br />                        invoke MoveWindow, hWnd, IPoint.x, IPoint.y, wWidth, wHeight, TRUE<br /><br />               .ELSEIF  uMsg == WM_PAINT<br />                        invoke GetWindowLong, hWnd, GWL_USERDATA<br />                        mov   esi, eax<br />                        ASSUME esi&#58;PTR ANIICON_INFO<br />                        .IF   &#91;esi&#93;.FrameChange != NULL<br />                              invoke BeginPaint, hWnd, ADDR ps<br />                              mov   hDC, eax<br />                              invoke DrawIconEx, hDC, 0, 0, &#91;esi&#93;.hImage, NULL, NULL, \<br />                                                             &#91;esi&#93;.FrameNumber, NULL, DI_NORMAL<br />                              invoke EndPaint, hWnd, ADDR ps<br />                              mov   &#91;esi&#93;.FrameChange, NULL<br />                        .ENDIF<br />                        <br />               .ELSEIF  uMsg == WM_TIMER<br />                        invoke GetWindowLong, hWnd, GWL_USERDATA<br />                        mov   esi, eax<br />                        ASSUME esi&#58;PTR ANIICON_INFO<br />                        mov   eax, wParam<br />                        .IF   eax == &#91;esi&#93;.TimerID<br />                              dec   &#91;esi&#93;.RateCount<br />                              .IF   &#91;esi&#93;.RateCount == 0<br />                                    inc   &#91;esi&#93;.FrameNumber<br />                                    mov   eax, &#91;esi&#93;.FrameNumber<br />                                    .IF   eax == &#91;esi&#93;.cFrames<br />                                          mov   &#91;esi&#93;.FrameNumber, NULL<br />                                    .ENDIF<br />                                    mov   eax, &#91;esi&#93;.cFrameRate<br />                                    mov   &#91;esi&#93;.RateCount, eax<br />                                    mov   &#91;esi&#93;.FrameChange, 1<br />                                    invoke InvalidateRect, hWnd, NULL, TRUE<br />                              .ENDIF<br />                        .ENDIF                                       <br />               .ELSE<br />                     invoke DefWindowProc,hWnd,uMsg,wParam,lParam		<br />                     ret<br />               .ENDIF<br />AniIconWndProc_Exit&#58;<br />               ASSUME esi&#58;NOTHING<br />               ASSUME edi&#58;NOTHING<br />               pop   esi<br />               pop   edi<br />               xor eax,eax<br />               ret<br />AniIconWndProc Endp<br /><br />.data<br />szClassAnim db &quot;UserAniIcon32&quot;, 00h<br />;----------------------------------------------------------------------------------;<br />; Procedure&#58;  InitUserAniIcon                                                      ;<br />;                                                                                  ;<br />;   Purpose&#58;  Register the class &quot;UserAniIcon32&quot; used to create and animate icon   ;<br />;             controls &#40;Windows&#41;.                                                  ;<br />;                                                                                  ;<br />; Protected&#58;  None.                                                                ;<br />;                                                                                  ;<br />; Arguments&#58;  hInst   DWORD  The instance handle of the current program.           ;<br />;                                                                                  ;<br />;    Return&#58;  TRUE if the class was successfully registered.                       ;<br />;                                                                                  ;<br />;             FALSE if the class registration failed.                              ;<br />;                                                                                  ;<br />;   Remarks&#58;  This class creates a transparent window for the display of frames    ;<br />;             from the loaded .ANI image through the use of DrawIconEx.            ;<br />;                                                                                  ;<br />;             The double word reserved in cbWndExtra contains a pointer to the     ;<br />;             ANIICON_INFO structure build during creation to hold window data.    ;<br />;                                                                                  ;<br />;             A timer is initiated during creation for cycling frames every 1/60   ;<br />;             second as the rate is defined in these terms.                        ;<br />;                                                                                  ;<br />;             All data structures created for this class and the image used are    ;<br />;             destroyed for cleanup before closing the window.                     ;<br />;                                                                                  ;<br />;----------------------------------------------------------------------------------;<br />;<br />.code<br />InitUserAniIcon   Proc<br />                  LOCAL wc&#58;WNDCLASSEX<br />                  LOCAL vRet&#58;DWORD<br />                  LOCAL hInst&#58;DWORD<br />                  mov   eax, TRUE<br />                  mov   vRet, eax<br /><br />                  invoke GetModuleHandle, NULL<br />                  mov   hInst, eax<br />                  mov   wc.cbSize, SIZEOF WNDCLASSEX<br />                  mov   wc.style, CS_HREDRAW or CS_VREDRAW<br />                  mov   wc.lpfnWndProc, OFFSET AniIconWndProc<br />                  mov   wc.cbClsExtra, NULL<br />                  mov   wc.cbWndExtra, SIZEOF DWORD          ;Pointer to window data<br />                  push  hInst<br />                  pop   wc.hInstance<br />                  mov   wc.hbrBackground, COLOR_WINDOW+1<br />                  mov   wc.lpszMenuName, NULL<br />                  mov   wc.lpszClassName,OFFSET szClassAnim<br />                  mov   wc.hIcon, NULL<br />                  mov   wc.hIconSm, NULL<br />                  mov   wc.hCursor, NULL<br />                  invoke RegisterClassEx, addr wc<br />                  .IF   eax == NULL<br />                        mov   eax, FALSE<br />                        mov   vRet, eax<br />                  .ENDIF<br />                  ret<br />InitUserAniIcon   Endp<br />.code<br />CreateAnimatedIcon   Proc  hParent&#58;DWORD, Iconx&#58;DWORD, \<br />                                            Icony&#58;DWORD,IconID&#58;DWORD, ResID&#58;DWORD<br />                     LOCAL hInst&#58;DWORD<br />                     LOCAL hWndIcon&#58;DWORD<br /><br />                     invoke GetModuleHandle, NULL<br />                     mov   hInst, eax<br />                     invoke InitUserAniIcon<br />                     INVOKE CreateWindowEx,NULL,ADDR szClassAnim, ResID,\<br />                           WS_CHILD,Iconx,\<br />                           Icony,0,0,hParent,IconID,\<br />                           hInst,NULL<br />                     .IF   eax == NULL<br />                           mov   eax, FAILED_CREATEICON<br />                     .ELSE<br />                           mov   hWndIcon, eax<br />                           invoke UpdateWindow, hWndIcon<br />                           invoke ShowWindow, hWndIcon,SW_SHOW<br />                           mov   eax, NULL<br />                     .ENDIF<br />                     ret<br />CreateAnimatedIcon   Endp<br /></code></pre><br />I have tried to correct the coding to correctly read without wrap.<br />if you wish I can send you the Source. When you e-mail me use subject MASM32<br />so I can sort you from the JUNK.<br /><br />Enjoy<br />Norm</div>
    <div class="meta">Posted on 2003-07-06 19:32:08 by ngc2501ca</div>
   </div>
   <div class="post" id="post-109543">
    <div class="subject"><a href="#post-109543">Code for Using Animated Icons and Cursors</a></div>
    <div class="body">Nice stuff - I'm sure I'll use it sometime, somewhere :)</div>
    <div class="meta">Posted on 2003-07-07 07:02:49 by Homer</div>
   </div>
   <div class="post" id="post-109545">
    <div class="subject"><a href="#post-109545">Still have some work to do</a></div>
    <div class="body">The code posted is close to perfect but I still need to resolve the background<br />issue since WS_EX_TRANSPARENT has problems in Dialog Boxes and when moving<br />the window.<br /><br />I will post the update.<br /><br />Thanks, <br />Norm</div>
    <div class="meta">Posted on 2003-07-07 07:23:34 by ngc2501ca</div>
   </div>
  </div>
 </body>
</html>