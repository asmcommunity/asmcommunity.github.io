<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Include file to MASM import library converter - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=17018" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=17018">Include file to MASM import library converter</a></p>
   <div class="post" id="post-132096">
    <div class="subject"><a href="#post-132096">Include file to MASM import library converter</a></div>
    <div class="body">Hi friends, <br /><br />Finally, after solving some technical problems, here is my include file to MASM import library converter - inc2lib. This tools works like Hutch's inc2l tool, the difference is that inc2lib runs Polib / Pelle's librarian which creates considerably smaller import libraries. <br /><br />Other features: <br /><br />- Support of full pathname <br />- Wildcards like *.inc are O.K. <br /><br />Inc2lib accepts only filenames with the .inc extension: <br /><pre><code><br />inc2lib incfilename.inc<br /></code></pre> <br /><br />You need Polib located in c:\masm32\bin. This path pointing to the librarian can be modified, have a look at the source code. <br /><br />The librarian Polib: <br /><br /><a target="_blank" href="http://www.smorgasbordet.com/pellesc/polib.exe">http://www.smorgasbordet.com/pellesc/polib.exe</a> <br /><br />Polink / Pelle's MS COFF linker and MS link accepts the import libs created by inc2lib. <br /><br />The linker Polink : <br /><br /><a target="_blank" href="http://www.smorgasbordet.com/pellesc/polink.exe">http://www.smorgasbordet.com/pellesc/polink.exe</a> <br /><br />Many thanks to: <br /><br />Pelle who developped these nice coding tools. <br /><br />Hutch for encouraging me to work on this project.</div>
    <div class="meta">Posted on 2004-01-30 05:09:40 by Vortex</div>
   </div>
   <div class="post" id="post-132119">
    <div class="subject"><a href="#post-132119">Include file to MASM import library converter</a></div>
    <div class="body">polink c ant link obj or lib from <br />GCC gnu compiler.</div>
    <div class="meta">Posted on 2004-01-30 15:56:12 by vilik</div>
   </div>
   <div class="post" id="post-132121">
    <div class="subject"><a href="#post-132121">Include file to MASM import library converter</a></div>
    <div class="body">Doesn't the mingw32 version of GCC produce ms-coff objects, or does it still use the GNU relocation format? As for libraries... if there's a gcc version that does produce ms-coff relocations, it would be trivial to write a tool that extract gcc-libs and creates ms-libs from them.<br /><br />It shouldn't be too hard writing a tool that converts gcc-coff relocation data to ms-coff data btw. Iirc, the ms-coff format has NULL as the relocation data and depends on the linker to fixup the entire value, so you could just walk the COFF symbol table for the correct type of relocations, and zero out the data.</div>
    <div class="meta">Posted on 2004-01-30 16:13:10 by f0dder</div>
   </div>
   <div class="post" id="post-132161">
    <div class="subject"><a href="#post-132161">Include file to MASM import library converter</a></div>
    <div class="body">The gcc tool, does it produce import libs with decorated names? That's is important.</div>
    <div class="meta">Posted on 2004-01-31 02:31:55 by Vortex</div>
   </div>
   <div class="post" id="post-132203">
    <div class="subject"><a href="#post-132203">Include file to MASM import library converter</a></div>
    <div class="body"><a target="_blank" href="http://www.geocities.com/yongweiwu/stdcall.htm">http://www.geocities.com/yongweiwu/stdcall.htm</a><br /><br />Toni</div>
    <div class="meta">Posted on 2004-01-31 17:12:08 by minimoog</div>
   </div>
   <div class="post" id="post-132243">
    <div class="subject"><a href="#post-132243">Include file to MASM import library converter</a></div>
    <div class="body">Thanks for the article, I will read it.</div>
    <div class="meta">Posted on 2004-02-01 03:03:40 by Vortex</div>
   </div>
   <div class="post" id="post-135306">
    <div class="subject"><a href="#post-135306">Include file to MASM import library converter</a></div>
    <div class="body">Here is the version 1.01 of inc2lib.<br /><br />-Fixed bug with the include file parser code</div>
    <div class="meta">Posted on 2004-03-07 14:08:39 by Vortex</div>
   </div>
   <div class="post" id="post-163815">
    <div class="subject"><a href="#post-163815">Re: Include file to MASM import library converter</a></div>
    <div class="body">Version 1.2 offers an optional switch to emit module definition files with decorated names.<br /><br /><pre><code><br />inc2lib incfile.inc -d<br /></code></pre><br /><br />With this -d option, you get only a module definition file, not the library.<br /><br />http://www.vortex.masmcode.com/files/inc2lib12.zip</div>
    <div class="meta">Posted on 2005-08-27 07:12:08 by Vortex</div>
   </div>
   <div class="post" id="post-164236">
    <div class="subject"><a href="#post-164236">Re: Include file to MASM import library converter</a></div>
    <div class="body"><u>Version 1.21</u><br />- Fixed bug with include files not terminating with CR+LF<br /><br />http://vortex.masmcode.com/files/inc2lib121.zip</div>
    <div class="meta">Posted on 2005-09-05 12:54:12 by Vortex</div>
   </div>
   <div class="post" id="post-164343">
    <div class="subject"><a href="#post-164343">Re: Include file to MASM import library converter</a></div>
    <div class="body">Hi Vortex,<br /><br />You guys can also take a look on the LibScanner we developed for RosAsm. The goal is not to build Libraries, but it can be used as such if you want to.<br /><br />It dumps all 1st, 2nd and 3rd headers for all Coff lib files. (VC, LCC, Pelles, DevC,Intel Fortran X86/Itanium, Intel CPP x86/Itanium).<br /><br />The implementations of the Coff LibScanner are currently under strong development. On the actual stage you will be able to fully dump the strucured form of the Coff Lib files on a structured organization, meaning that you can assemble the full structure of the lib file on your apps, or only use it to analyse or study it´s  functionality. The goal is to reuse the results of the libscanner to improve the disassemblement results on a system we developed called DIS - Data Identification System, a sort of digital DNA of compiler identification.<br /><br />The actual development version of the LibScanner contains a full unmangled representation names of the used symbols inside a .lib file, and scanned about 1200 files without errors, and we are currently working on the parsing of the common Coff Object structures.<br /><br /><br />To Build the libraries for masm (With or without undecorated names) you may only have to do this:<br /><br />Example: Kernel32.lib<br /><br /><strong>a) Open Kerner32.lib on the menu Tools+LibScanner.</strong><br /><br />It will display the full contents of the 1st, 2nd and 3rd Image_Linker Headers (So, it will display the small names or long names, and will tel you either the library contains only ordinal values or not)<br /><br /><br />Note: To use the library you can do two things:<br /><br />1 - Copy it and paste on notepad to you simply analyse or document the results as you wish.<br />2 - Or copy and paste on RosAsm source editor, and place the command &quot;Main:&quot; to it be able to assemble the whole file as it is, or paste the result in any of your file. I mean, the results of the libscanner are assembled, not matter if they are assembled as they are, not matter if you insert it onto your projects.<br />3 - The generated result is under the form of The real structures of the Lib file, only adapting it to RosAsm style, and displaying the real values of some members, instead having to use the bswaped versino, like in the PublicSymbols amount, for example.<br /><br />The result is under the following form:<br /><br /><br />;;<br />________________________________________________<br /><br />    Tag Data. The Magic String<br />________________________________________________<br />________________________________________________<br />;;<br /><br /><br /><br />;;<br />________________________________________________<br /><br />    First Linker Header - Names Linker Member<br />________________________________________________<br />________________________________________________<br />;;<br /><br />; This is the IMAGE_ARCHIVE_MEMBER_HEADER Structure.<br /><br /><br /><br />; Amount of Members on the file.<br /><br /><br /><br />; Amount of Offsets of the Public Symbols.<br /><br /><br /><br /><br /><br /><br /><br />; RosAsm Interpretation: &#39;KERNEL32.lstrlenW&#39;<br /><br />; Full Undecorated Name: _lstrlenW@4<br /><br /><strong>b) Once you paste the code, locate the list of public symbls avaliable from the lib.</strong><br /><br />In case of kernel32.lib it contains only the 1st and 2nd Import Linker Headers, meaning that it don´t have any Objects with Long Names. So the exported functions are located at SymOffset and SymOffset2 structures arrays.<br /><br />SymOffset1 are the pointers of Public Symbols located in different Object files. So you will may find some duplicated pointers, meaning that 02 or more Publci functinos are located in the same Object File.<br /><br />Example:<br /><br /><br /><br />That means Object 745 contains 02 pointers on the same lib (__imp___lclose@4, __lclose@4). It also means that Obj745 is the one related to the exported function _lclose.<br /><br /><br />SymOffset2 are the pointers to the public function in each of the Object files. So you won´t find duplicatinos there. Like:<br /><br /><br /><br />To see the contents of the Object 745, all you have to do is right click on the string Obj_000746 and you will be pointed to where the Object is, like:<br /><br />; Coff File. Indice: 000745<br /><br /><br /><br /><br /><br /><br /><br />; RosAsm Interpretation: &#39;KERNEL32._lclose&#39;<br /><br />; Full Undecorated Name: __lclose@4<br /><br /><strong>c) Building the masm lib file.</strong><br /><br />To build the masm lib file you only need to copy the contents of SymOffset2 (because it is the list of objects and by consequence the public symbols existant), and clean it to fit the masm syntax .def file. Like:<br /><br /><br /><br />Cleaning to<br /><br /><br />LIBRARY KERNEL32<br />EXPORTS<br />_lclose<br />_lcreat<br />(...)<br /><br /><strong>d) Since you already have the amount of parameters of each functin all you have to do is build your asm file upon it. Like:</strong><br /><br />.386 <br />.model flat,stdcall <br />.code <br />_lclose proc param1:BYTE<br />_lclose endp <br /><br />_lcreat proc param1:BYTE, param2:BYTE<br />_lcreat endp <br /><br />end<br /><br /><br /><br /><strong>e) Building the masm lib file with undecorated names. This is similar to the above way. Take for example the Mfc42.lib.</strong><br /><br /><br /><br /><br /><br /><br /><br />; RosAsm Interpretation: &#39;MFC42.?classCCachedDataPathProperty@CCachedDataPathProperty@@2UCRuntimeClass@@B&#39;<br /><br />; Full Undecorated Name: public: static struct CRuntimeClass const  CCachedDataPathProperty::classCCachedDataPathProperty<br /><br />I don´t know how a .def file works nor how masm can deal with undecorated namings...but accordying to http://www.geocities.com/yongweiwu/stdcall.htm you can try forcing it, like:<br /><br />LIBRARY KERNEL32<br />EXPORTS<br />CCachedDataPathProperty_classCCachedDataPathProperty<br />= ?classCCachedDataPathProperty@CCachedDataPathProperty@@2UCRuntimeClass@@B<br />(....)<br /><br />Or something like it, that Masm can accepet. I don´t use masm for a long time, so i don´t remember exactly how to use those commands to build it under masm. But the above is a good direction.<br /><br /><br /><br />Best Regards,<br /><br />Guga<br /></div>
    <div class="meta">Posted on 2005-09-07 13:20:33 by Beyond2000!</div>
   </div>
   <div class="post" id="post-164345">
    <div class="subject"><a href="#post-164345">Re: Include file to MASM import library converter</a></div>
    <div class="body">Hi Guga,<br /><br />Thanks for your reply. Building undecorated libraries is easy, you have to use Pelle&#39;s librarian Polib :<br /><pre><code><br />polib /nound /out:kernel32.lib \windows\system32\kernel32.dll<br /></code></pre><br />The switch nound turns off the the leading underscore feature.<br />Building decorated libraries with Polib using a DEF file :<br /><pre><code><br />LIBRARY kernel32<br />EXPORTS<br />&quot;_AddAtomA@4&quot;<br />&quot;_AddAtomW@4&quot;<br />&quot;_AllocConsole@0&quot;<br />&quot;_AllocateUserPhysicalPages@12&quot;<br />.<br />.<br />etc<br /></code></pre><br /><pre><code><br />polib /machine:ix86 /out:kernel32.lib /def:kernel32.def<br /></code></pre></div>
    <div class="meta">Posted on 2005-09-07 13:47:56 by Vortex</div>
   </div>
   <div class="post" id="post-164346">
    <div class="subject"><a href="#post-164346">Re: Include file to MASM import library converter</a></div>
    <div class="body">One thing.<br /><br />Vortex, or anyone else...Someone have any documents of the decorated names of compilers?<br /><br />I mean, i´m trying to analyse how each compiler decorate the labels, insetad having to use the API.<br /><br />I already have some ideas on how VC is diferent from Borland, but i couldn´t find any document teaching how the decorated names are used for, neither which symbols are for what. (Except for the unique @XX ate the end that represents the amount of parameters, and only if this symbols is used alone)<br /><br />I just parsed all VC libraries displaying a full (and huge) list of decorated labels and theyr real meanings, but without the proper documentation, this work of identification whcih symbols is related to what will be really a pain to do.<br /><br /><br />The api undecorate the symbols, giving the C representation, what i´m trying to do is identify the way it works (Without an api), and build an asm representation to be used, specially when it concerns to classes, or OOP programming.<br /><br />Best Regards,<br /><br />Guga<br /><br /><br /></div>
    <div class="meta">Posted on 2005-09-07 13:49:24 by Beyond2000!</div>
   </div>
   <div class="post" id="post-164348">
    <div class="subject"><a href="#post-164348">Re: Include file to MASM import library converter</a></div>
    <div class="body">A very good document by Agner Fog :<br /><div class="quote"><br />Calling conventions<br />This is a report describing details about calling conventions, data representations, register usage and name mangling for many different C++ compilers for 16-bit, 32-bit and 64-bit x86-based systems, including DOS, Windows, Linux and FreeBSD. <br /></div><br /><br />http://www.agner.org/assem/calling_conventions.pdf</div>
    <div class="meta">Posted on 2005-09-07 14:15:17 by Vortex</div>
   </div>
   <div class="post" id="post-164356">
    <div class="subject"><a href="#post-164356">Re: Include file to MASM import library converter</a></div>
    <div class="body">Got it<br /><br />Tks Vortex :)<br /><br />Best Regards,<br /><br />Guga</div>
    <div class="meta">Posted on 2005-09-07 22:10:11 by Beyond2000!</div>
   </div>
   <div class="post" id="post-167329">
    <div class="subject"><a href="#post-167329">Re: Include file to MASM import library converter</a></div>
    <div class="body"><u>Version 1.3</u><br />- Fixed bug with function prototype parameters other than <span class="mono">DWORD</span> which was not recognized by the previous versions.<br /><br />Notice that the tool is still case-sensitive, all the PROTO statements should be uppercase.<br /><br />http://vortex.masmcode.com/files/inc2lib13.zip</div>
    <div class="meta">Posted on 2005-10-29 05:50:28 by Vortex</div>
   </div>
  </div>
 </body>
</html>