<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>GUI problem - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=18679" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=18679">GUI problem</a></p>
   <div class="post" id="post-144731">
    <div class="subject"><a href="#post-144731">GUI problem</a></div>
    <div class="body">Hi guys,<br /><br />I have this problem. When my dialog (modeless) is minimised then restored, it will end up looking like the attached image. When I forcely request for it to repaint, drag a window over the dialog etc, it look okay. So my question is what caused it?<br /><br />Here;s my code for the dialog. (Just 211 lines long) It's fasm btw.<br /><br /><pre><code><br />  proc MessageWindow,hwnddlg, msg, wparam, lparam<br />  .hList rd 1<br />  .h1011 rd 1<br />  .h1012 rd 1<br />  .h1013 rd 1<br />  .h1014 rd 1<br />  .h1015 rd 1<br />  .h1016 rd 1<br />        enter<br />        push    ebx<br />        push    edi<br />        mov     eax, &#91;msg&#93;<br />        cmp     eax, WM_INITDIALOG<br />        jz      .wminitdialog_msg<br />        cmp     eax, WM_COMMAND<br />        je      .wmcommand_msg<br />        cmp     eax, WM_CLOSE<br />        jz      .wmclose_msg<br />        cmp     eax, WM_SETCLASS<br />        jz      .wmsetclass_msg<br />        cmp     eax, WM_RECVMSG<br />        jz      .wmrecvmsg_msg<br />        cmp     eax, WM_SIZE<br />        je      .wmsize_msg<br />        cmp     eax, WM_NCACTIVATE<br />        je      .wmncactivate_msg<br />  .end_msg&#58;<br />        xor     eax, eax<br />        pop     edi<br />        pop     ebx<br />        return<br />  .wmclose_msg&#58;<br />        invoke  DestroyWindow,&#91;hwnddlg&#93;<br />        jmp     .end_msg<br />  .wmncactivate_msg&#58;<br />        mov     eax, &#91;hwnddlg&#93;<br />        mov     &#91;htemp&#93;,eax<br />        jmp     .end_msg<br />  .wminitdialog_msg&#58;<br />        mov     eax, &#91;hwnddlg&#93;<br />        mov     &#91;htemp&#93;,eax<br />        invoke  GetDlgItem, &#91;hwnddlg&#93;,1012<br />        invoke  SetWindowLong,eax,GWL_WNDPROC,EditProc<br />        mov     &#91;hDefEditProc&#93;,eax<br />        invoke  LoadIcon, hinstance, 16<br />        invoke  PostMessage, &#91;hwnddlg&#93;,WM_SETICON, ICON_SMALL, eax<br />        jmp     .end_msg<br />  .wmcommand_msg&#58;<br />        mov     eax, &#91;wparam&#93;<br />        cmp     eax,1014<br />        je      .wmclose_msg<br />        cmp     eax, 1013<br />        je      .wmsend_msg<br />        jmp     .end_msg<br />  .wmsetclass_msg&#58;<br />        mov     ebx, &#91;lparam&#93;<br />        invoke  SetWindowLong, &#91;hwnddlg&#93;, DWL_USER, ebx<br />        stdcall FindByUin, ebx<br />        cmp     eax, -1<br />        jnz     @F<br />        stdcall dwtoa, ebx, cookie<br />        jmp     .settext<br />    @@&#58;<br />        mov     &#91;lvi.mask&#93;, LVIF_TEXT<br />        mov     &#91;lvi.iItem&#93;, eax<br />        mov     &#91;lvi.pszText&#93;, cookie<br />        mov     &#91;lvi.cchTextMax&#93;, 30h<br />        invoke  SendMessage,&#91;hList&#93;,LVM_GETITEM,0,lvi<br />    .settext&#58;<br />        invoke  SendMessage,&#91;hwnddlg&#93;,WM_SETTEXT,0,cookie<br />        jmp     .end_msg<br />  .wmrecvmsg_msg&#58;<br />        invoke  GetWindowLong, &#91;hwnddlg&#93;, DWL_USER<br />        xchg    eax, ebx<br />        stdcall FindByUin, ebx<br />        cmp     eax, -1<br />        jnz     @F<br />        stdcall dwtoa, ebx, cookie<br />        jmp     .addmsg<br />    @@&#58;<br />        mov     &#91;lvi.mask&#93;, LVIF_TEXT+LVIF_PARAM<br />        mov     &#91;lvi.iItem&#93;, eax<br />        mov     &#91;lvi.pszText&#93;, cookie<br />        mov     &#91;lvi.cchTextMax&#93;, 30h<br />        invoke  SendMessage,&#91;hList&#93;,LVM_GETITEM,0,lvi<br />    .addmsg&#58;<br />        invoke  GetDlgItem,&#91;hwnddlg&#93;,1011<br />        xchg    eax, edi<br />        ;Add text into editbox<br />        push    -2<br />        push    -1<br />        invoke  SendMessage,edi, EM_EXSETSEL,0,esp<br />        add     esp, 8<br />        invoke  SendMessage,edi, EM_REPLACESEL,0,cookie<br />        invoke  SendMessage,edi, EM_REPLACESEL,0,formatting<br />        invoke  SendMessage,edi, EM_REPLACESEL,0,&#91;lparam&#93;<br />        invoke  SendMessage,edi, EM_REPLACESEL,0,formatting+1<br />        invoke  SendMessage,edi, WM_VSCROLL,SB_ENDSCROLL,0<br />        invoke  SetFocus,edi<br />        invoke  GetDlgItem,&#91;hwnddlg&#93;,1012<br />        invoke  SetFocus,eax<br />        invoke  FlashWindow, &#91;hwnddlg&#93;, 1<br />        jmp     .end_msg<br />    .wmsend_msg&#58;<br />        ;build snac 4,6 to send to server<br />        mov     edi, buffer2<br />        stdcall StringCopy2, edi, clientsendmsg1, sizeclientsendmsg1<br />        add     edi, sizeclientsendmsg1<br />        call    GetSequence<br />        mov     word&#91;buffer2+2&#93;, ax<br />        invoke  GetWindowLong, &#91;hwnddlg&#93;, DWL_USER<br />        stdcall dwtoa,eax,  buffer3<br />        stdcall StrLen, buffer3<br />        stosb<br />        stdcall StringCopy2, edi, buffer3, eax<br />        lea     edi, &#91;edi+eax&#93;<br />        stdcall StringCopy2, edi, clientsendmsg2, sizeclientsendmsg2<br />        add     edi, sizeclientsendmsg2<br />        invoke  GetDlgItemText, &#91;hwnddlg&#93;, 1012, buffer3, 200h<br />        or      eax, eax<br />        jz      .end_msg<br />        push    eax<br />        add     eax, 4<br />        xchg    al, ah<br />        stosw<br />        add     ah, 0dh - 4<br />        adc     al, 0<br />        mov     &#91;edi-11&#93;,ax<br />        xor     eax, eax<br />        stosd<br />        pop     eax<br />        stdcall StringCopy2, edi, buffer3, eax<br />        add     edi, eax<br />        stdcall StringCopy2, edi, clientsendmsg3, sizeclientsendmsg3<br />        mov     eax, edi<br />        sub     eax, buffer2-sizeclientsendmsg3<br />        lea     ecx, &#91;eax-6&#93;<br />        xchg    cl, ch<br />        mov     word&#91;buffer2+4&#93;, cx<br />        invoke  ws_send, &#91;hSock&#93;, buffer2, eax, 0<br />        invoke  SendDlgItemMessage,&#91;hwnddlg&#93;, 1012, WM_SETTEXT,0,0<br />        invoke  GetDlgItem,&#91;hwnddlg&#93;, 1011<br />        xchg    eax, edi<br />        ;Add text into editbox<br />        push    -2<br />        push    -1<br />        invoke  SendMessage,edi, EM_EXSETSEL,0,esp<br />        add     esp, 8<br />        invoke  SendMessage,edi, EM_REPLACESEL,0,nick<br />        invoke  SendMessage,edi, EM_REPLACESEL,0,formatting<br />        invoke  SendMessage,edi, EM_REPLACESEL,0,buffer3<br />        invoke  SendMessage,edi, EM_REPLACESEL,0,formatting+1<br />        invoke  SendMessage,edi, WM_VSCROLL,SB_ENDSCROLL,0<br />        invoke  SetFocus,edi<br />        invoke  GetDlgItem,&#91;hwnddlg&#93;,1012<br />        invoke  SetFocus,eax<br />        jmp     .end_msg<br />    .wmsize_msg&#58;<br />        ;begin - resize message dialog<br />        invoke  GetDlgItem,&#91;hmsg&#93;,1011<br />        mov     &#91;.h1011&#93;,eax<br />        invoke  GetDlgItem,&#91;hmsg&#93;,1012<br />        mov     &#91;.h1012&#93;,eax<br />        invoke  GetDlgItem,&#91;hmsg&#93;,1013<br />        mov     &#91;.h1013&#93;,eax<br />        invoke  GetDlgItem,&#91;hmsg&#93;,1014<br />        mov     &#91;.h1014&#93;,eax<br />        invoke  GetDlgItem,&#91;hmsg&#93;,1015<br />        mov     &#91;.h1015&#93;,eax<br />        invoke  GetDlgItem,&#91;hmsg&#93;,1016<br />        mov     &#91;.h1016&#93;,eax<br />        invoke  GetClientRect,&#91;hmsg&#93;,rect<br />        mov     eax,&#91;rect.right&#93;<br />        mov     ecx,&#91;rect.bottom&#93;<br />        sub     ecx,164<br />        sub     eax,22<br />        invoke  MoveWindow,&#91;.h1011&#93;,11,11,eax,ecx,0<br />        invoke  GetClientRect,&#91;hmsg&#93;,rect<br />        mov     ecx,&#91;rect.bottom&#93;<br />        sub     ecx,152<br />        invoke  MoveWindow,&#91;.h1016&#93;,11,ecx,50,14,1<br />        invoke  GetClientRect,&#91;hmsg&#93;,rect<br />        mov     eax,&#91;rect.right&#93;<br />        sub     eax,22<br />        mov     ecx,&#91;rect.bottom&#93;<br />        sub     ecx,138<br />        invoke  MoveWindow,&#91;.h1012&#93;,11,ecx,eax,94,0<br />        invoke  GetClientRect,&#91;hmsg&#93;,rect<br />        mov     eax,&#91;rect.left&#93;<br />        add     eax,12<br />        mov     ecx,&#91;rect.bottom&#93;<br />        sub     ecx,34<br />        invoke  MoveWindow,&#91;.h1015&#93;,eax,ecx,75,23,1<br />        invoke  GetClientRect,&#91;hmsg&#93;,rect<br />        mov     eax,&#91;rect.right&#93;<br />        sub     eax,85<br />        mov     ecx,&#91;rect.bottom&#93;<br />        sub     ecx,34<br />        invoke  MoveWindow,&#91;.h1013&#93;,eax,ecx,75,23,1<br />        invoke  GetClientRect,&#91;hmsg&#93;,rect<br />        mov     eax,&#91;rect.right&#93;<br />        sub     eax,163<br />        mov     ecx,&#91;rect.bottom&#93;<br />        sub     ecx,34<br />        invoke  MoveWindow,&#91;.h1014&#93;,eax,ecx,75,23,1<br />        invoke  GetDlgItem,&#91;hwnddlg&#93;, 1011<br />        xchg    eax, edi<br />        invoke  SendMessage,edi,WM_VSCROLL,SB_ENDSCROLL,0 ; does not seem to work<br />        ;end - resize msg dialog<br />        jmp     .end_msg<br />  endp           <br /></code></pre></div>
    <div class="meta">Posted on 2004-06-24 09:53:58 by roticv</div>
   </div>
   <div class="post" id="post-144732">
    <div class="subject"><a href="#post-144732">GUI problem</a></div>
    <div class="body">What I usually do is in the WM_SIZE message I move all my windows using MoveWindow and the repaint flag set to FALSE (you have some false, some true), then at the end of the wm_size handler I insert a InvalidateRect repainting the whole thing in one go.<br /><br />Hope that helps.</div>
    <div class="meta">Posted on 2004-06-24 10:07:11 by JimmyClif</div>
   </div>
   <div class="post" id="post-144733">
    <div class="subject"><a href="#post-144733">GUI problem</a></div>
    <div class="body">Thanks mate. You have pointed me in the correct direction. When I changed all to TRUE, it looks perfect now. Thanks!</div>
    <div class="meta">Posted on 2004-06-24 10:11:24 by roticv</div>
   </div>
  </div>
 </body>
</html>