<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>How to detect/allocate upper memory blocks (UMBs)? - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=30884" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=115">DOS &amp; BIOS</a> &raquo; <a href="../?id=30884">How to detect/allocate upper memory blocks (UMBs)?</a></p>
   <div class="post" id="post-216001">
    <div class="subject"><a href="#post-216001">How to detect/allocate upper memory blocks (UMBs)?</a></div>
    <div class="body">For one of my projects, I&#039;d like to be able to detect upper memory blocks and, if there&#039;s one of sufficient size available, relocate the main code into it and execute from there, freeing up the whole TPA for data. Problem is, there isn&#039;t a particularly good introduction to upper-memory programming available out there. Ralf Brown&#039;s Interrupt List has some documentation on the structures involved, and I&#039;ve found <a target="_blank" href="http://www.textfiles.com/virus/datut010.txt">one tutorial</a> by a virus hobbyist showing how to find blocks, but that involves a lot of poking around system data structures, and when I try it it winds up off in never-never-land - it seems to have gotten entirely the wrong start address for the beginning of the UMB chain, as none of the entries have the marker that indicates end-of-list set correctly.<br /><br />(Here&#039;s the code I&#039;m using at the moment. It prints one segment pointer and quits on Windows XP, without printing Z for end-of-list or M for no, and prints a few kilobytes of garbage on DOSBox. Haven&#039;t got a chance to try it on my actual DOS machine yet.)<br /><br /><pre><code>	; umb.asm - traverses the UMB chain<br />	org	0x100<br />	<br />start:<br />	mov	ax, 0x3306	; get true DOS version<br />	int	0x21<br />	inc	al	; will wrap from 0xFF -&gt; 0x00 if DOS version is less than 5.0<br />	jz	baddos<br />	mov	ah,	0x52	; get pointer to the List of Lists<br />	int	0x21<br />	<br />	; ES:BX now contains the pointer<br />	lds	si, 	; get pointer to disk buffer<br />	mov	ax, 		; get pointer to first MCB<br />	inc	ax	; will wrap from 0xFFFF -&gt; 0x0000 if no UMBs<br />	jz	noumb<br />	dec	ax<br />	<br />	xor	si, si<br />	; for now, simply traverse the list until the end<br />lp:	mov	ds, ax<br />	<br />	; DEBUG - prints a doggerel-hex (0123456789:;&lt;=&gt;?) version of the segment pointer<br />	push	ax<br />	mov	cx, ax<br />	mov	ah, 0x02<br />	<br />	mov	dl, ch<br />	shr	dl, 1<br />	shr	dl, 1<br />	shr	dl, 1<br />	shr	dl, 1<br />	add	dl, &#039;0&#039;<br />	int	0x21<br />	shl	cx, 1<br />	shl	cx, 1<br />	shl	cx, 1<br />	shl	cx, 1<br />	<br />	mov	dl, ch<br />	shr	dl, 1<br />	shr	dl, 1<br />	shr	dl, 1<br />	shr	dl, 1<br />	add	dl, &#039;0&#039;<br />	int	0x21<br />	shl	cx, 1<br />	shl	cx, 1<br />	shl	cx, 1<br />	shl	cx, 1<br />	<br />	mov	dl, ch<br />	shr	dl, 1<br />	shr	dl, 1<br />	shr	dl, 1<br />	shr	dl, 1<br />	add	dl, &#039;0&#039;<br />	int	0x21<br />	shl	cx, 1<br />	shl	cx, 1<br />	shl	cx, 1<br />	shl	cx, 1<br />	<br />	mov	dl, ch<br />	shr	dl, 1<br />	shr	dl, 1<br />	shr	dl, 1<br />	shr	dl, 1<br />	add	dl, &#039;0&#039;<br />	int	0x21<br />	shl	cx, 1<br />	shl	cx, 1<br />	shl	cx, 1<br />	shl	cx, 1<br />	<br />	pop	ax<br />	<br />	; /DEBUG<br />	<br />	mov	dl, <br />	mov	ah, 0x02<br />	int	0x21<br />	mov	dl, <br />	cmp	dl, &#039;Z&#039;<br />	jnz	el<br />	mov	ax, ds<br />	;inc	ax<br />	mov	bx, <br />	add	ax, bx<br />	jmp short	lp<br />el:	mov	ah, 0x4c<br />	int	0x21<br />	<br />baddos:<br />noumb:<br />	mov	dx, error<br />	mov	ah, 0x09<br />	int	0x21<br />	<br />	mov	ah, 0x4c<br />	int	0x21<br />	<br />error:	db	&#039;ERROR&#039;,0xd,&#039;$&#039;</code></pre><br /><br />Does anyone have a good tutorial on how to detect UMBs and allocate them? This would be handy, but I don&#039;t want to do something crash-prone just to save a few kilobytes.</div>
    <div class="meta">Posted on 2012-05-30 19:22:44 by commodorejohn</div>
   </div>
   <div class="post" id="post-216002">
    <div class="subject"><a href="#post-216002">Re: How to detect/allocate upper memory blocks (UMBs)?</a></div>
    <div class="body">Okay, well, silly me, I went and did some further research and it turns out the standard memory-allocation calls can be set to use upper memory when available. This code works on XP; DOSBox doesn&#039;t want to play along, but it doesn&#039;t spew gibberish. (Still haven&#039;t gotten to try it on my 386 box yet.)<br /><br /><pre><code>	; umb2.asm - attempts to use normal DOS memory allocation to get a 16KB UMB<br />	org	0x100<br />	<br />start:<br />	mov	ax, 0x3306	; get true DOS version<br />	int	0x21<br />	inc	al	; will wrap from 0xFF -&gt; 0x00 if DOS version is less than 5.0<br />	jz	baddos<br />	<br />	mov	ax, 0x5803	; set UMB link state<br />	mov	bx, 0x0001	; add UMBs to DOS memory chain<br />	int	0x21<br />	jc	nolink<br />	<br />	mov	ax, 0x5801	; set memory-allocation strategy<br />	mov	bx, 0x0041	; high memory only, best fit<br />	int	0x21<br />	jc	badstrategy<br />	<br />	mov	ah, 0x48	; allocate memory<br />	mov	bx, 0x0400	; 16KB?<br />	int	0x21<br />	jc	nomemory<br />	<br />	push	ax<br />	mov	ah, 0x09<br />	mov	dx, success1<br />	int	0x21<br />	pop	bx<br />	mov	es, bx<br />	call printhex<br />	mov	ah, 0x09<br />	mov	dx, success2<br />	int	0x21<br />	<br />	; set things back to the way they were<br />	mov	ah, 0x49<br />	int	0x21<br />	<br />	mov	ax, 0x5801	; set memory-allocation strategy<br />	mov	bx, 0x0000	; high memory (only?), best fit<br />	int	0x21<br />	<br />	mov	ax, 0x5803	; set UMB link state<br />	mov	bx, 0x0000	; add UMBs to DOS memory chain<br />	int	0x21<br />	<br />	mov	ah, 0x4c<br />	int	0x21<br />	<br />baddos:<br />	mov	ah, 0x09<br />	mov	dx, error1<br />	int	0x21<br />	mov	ah, 0x4c<br />	int	0x21<br />	<br />nolink:<br />	mov	ah, 0x09<br />	mov	dx, error2<br />	int	0x21<br />	mov	ah, 0x4c<br />	int	0x21<br />	<br />badstrategy:<br />	mov	ah, 0x09<br />	mov	dx, error3<br />	int	0x21<br />	<br />	; set things back to the way they were<br />	mov	ax, 0x5803	; set UMB link state<br />	mov	bx, 0x0000	; add UMBs to DOS memory chain<br />	int	0x21<br />	<br />	mov	ah, 0x4c<br />	int	0x21<br />	<br />nomemory:<br />	push	bx<br />	mov	ah, 0x09<br />	mov	dx, error4<br />	int	0x21<br />	pop	bx<br />	call printhex<br />	mov	ah, 0x09<br />	mov	dx, error5<br />	int	0x21<br />	<br />	; set things back to the way they were<br />	mov	ax, 0x5801	; set memory-allocation strategy<br />	mov	bx, 0x0000	; high memory (only?), best fit<br />	int	0x21<br />	<br />	mov	ax, 0x5803	; set UMB link state<br />	mov	bx, 0x0000	; add UMBs to DOS memory chain<br />	int	0x21<br />	<br />	mov	ah, 0x4c<br />	int	0x21<br />	<br />printhex:	; takes BX = 16-bit hexadecimal number<br />	mov	cx, bx<br />	mov	bx, hextable<br />	mov	ah, 0x02<br />	<br />	mov	al, ch<br />	shr	al, 1<br />	shr	al, 1<br />	shr	al, 1<br />	shr	al, 1<br />	xlatb<br />	mov	dl, al<br />	int	0x21<br />	shl	cx, 1<br />	shl	cx, 1<br />	shl	cx, 1<br />	shl	cx, 1<br />	<br />	mov	al, ch<br />	shr	al, 1<br />	shr	al, 1<br />	shr	al, 1<br />	shr	al, 1<br />	xlatb<br />	mov	dl, al<br />	int	0x21<br />	shl	cx, 1<br />	shl	cx, 1<br />	shl	cx, 1<br />	shl	cx, 1<br />	<br />	mov	al, ch<br />	shr	al, 1<br />	shr	al, 1<br />	shr	al, 1<br />	shr	al, 1<br />	xlatb<br />	mov	dl, al<br />	int	0x21<br />	shl	cx, 1<br />	shl	cx, 1<br />	shl	cx, 1<br />	shl	cx, 1<br />	<br />	mov	al, ch<br />	shr	al, 1<br />	shr	al, 1<br />	shr	al, 1<br />	shr	al, 1<br />	xlatb<br />	mov	dl, al<br />	int	0x21<br />	shl	cx, 1<br />	shl	cx, 1<br />	shl	cx, 1<br />	shl	cx, 1<br />	<br />	ret<br />	<br />success1:	db	&#039;Successfully allocated 0x4000 bytes at segment 0x$&#039;<br />success2:	db	&#039;.&#039;,0xd,&#039;$&#039;<br />error1:	db	&#039;DOS 4.0 and lower do not support UMB!&#039;,0xd,&#039;$&#039;<br />error2:	db	&#039;Could not link UMBs into DOS memory chain.&#039;,0xd,&#039;$&#039;<br />error3:	db	&#039;Could not set memory-allocation strategy.&#039;,0xd,&#039;$&#039;<br />error4:	db	&#039;Could not allocate memory. Largest block available is 0x$&#039;<br />error5:	db	&#039;0 bytes.&#039;,0xd,&#039;$&#039;<br />hextable:	db	&#039;0123456789ABCDEF&#039;</code></pre></div>
    <div class="meta">Posted on 2012-05-30 20:09:51 by commodorejohn</div>
   </div>
   <div class="post" id="post-216004">
    <div class="subject"><a href="#post-216004">Re: How to detect/allocate upper memory blocks (UMBs)?</a></div>
    <div class="body">Wow, upper memory blocks, yes, I was using them twenty years ago and I have published an ASM source, perhaps it might help you: <a target="_blank" href="http://vitsoft.info/tsrup.htm">http://vitsoft.info/tsrup.htm</a></div>
    <div class="meta">Posted on 2012-06-01 17:43:32 by vit$oft</div>
   </div>
  </div>
 </body>
</html>