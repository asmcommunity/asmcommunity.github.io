<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Advanced MASM macro programming question - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=10035" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=10035">Advanced MASM macro programming question</a></p>
   <div class="post" id="post-75060">
    <div class="subject"><a href="#post-75060">Advanced MASM macro programming question</a></div>
    <div class="body">I still haven't fully grasped the complete functionality and possibilities of macros in MASM (well, not many people have I guess :)), and I'm having trouble with getting around a limitation that feels like it might very well be possible. I'll now try to explain.<br /><br />The limitation that I am stuck on is that the execution of macros seem to be of a strictly linear nature. I.e. a macro that is called on line X in the listing cannot it any way affect the code that is generated at line Y, when Y &lt; X.<br /><br />Is this statement wrong, or is there really no way around this limitation?<br />It practically has the same limiting effect as if programs would be without any kind of jump or call instructions, simply forcing them to execute linearly like a simple static script, and it would indeed be very sad if that was the case. :(<br /><br /><br />Allow me to present a simple example to make the question a little more clear:<br /><br />Let's say I have a global struct in my program. Depending on which procedures are used in the program, different fields are needed in this struct. I would like to add any field to the struct as soon as the program includes code that uses this field, but I don't want to have any unused fields in the struct.<br /><br />Here is sample code for such a situation:<br /><br /><pre><code><br />    dynamic_field_1 TEXTEQU &lt;&gt;  ; Declaration of global macro var 1<br />    dynamic_field_2 TEXTEQU &lt;&gt;  ; Declaration of global macro var 2<br /><br />    ; This macro builds the dynamic struct<br />    BUILD_DYNAMIC_STRUCT MACRO <br />        .data<br />        dyn_struct_type STRUCT<br />            default_field     dword   ?<br />%           dynamic_field_1<br />%           dynamic_field_2<br />        dyn_struct_type ENDS<br />        .code<br />    ENDM<br /><br />    ; This macro defines and references a field<br />    ; in the global dynamic structure<br />    DEFINE_AND_USE_DYN_FIELD_1 MACRO <br />        dynamic_field_1 TEXTEQU &lt;dyn_field_1       dword   ?&gt;<br />        mov eax, dyn_struct.dyn_field_1<br />    ENDM<br /><br />    ; This macro defines and references another field<br />    ; in the global dynamic structure<br />    DEFINE_AND_USE_DYN_FIELD_2 MACRO <br />        dynamic_field_2 TEXTEQU &lt;dyn_field_2       dword   ?&gt;<br />        mov eax, dyn_struct.dyn_field_2<br />    ENDM<br /><br /><br />    ; ####### This is the code of the actual program #######<br /><br />.code<br />    BUILD_DYNAMIC_STRUCT<br />    DEFINE_AND_USE_DYN_FIELD_1<br />    DEFINE_AND_USE_DYN_FIELD_2<br /><br />.data<br />dyn_struct    dyn_struct_type    &#123;&#125;<br /></code></pre><br /><br /><br />When attempting to compile this, it will report an error, saying that &quot;dyn_field_1&quot; and &quot;dyn_field_2&quot; are undefined symbols. This is because the macros are executed linearly, so when the dynamic struct is built, the macro variables &quot;dynamic_field_1&quot; and &quot;dynamic_field_2&quot; are still empty, even though they are set later, before the actual reference. :(<br /><br /><br />And I know that in this specific example I could simply put the struct generation after the definitions, like this:<br /><br /><pre><code><br />    DEFINE_AND_USE_DYN_FIELD_1<br />    DEFINE_AND_USE_DYN_FIELD_2<br />    BUILD_DYNAMIC_STRUCT<br /></code></pre><br /><br />But this would not solve my problem or answer my question, it would only be a workaround for this simple example.<br /><br /><br />A more general example would be the following:<br /><br /><pre><code><br />    INIT_ALL_USED_RESOURCES    ; Macro initializing all used resources<br />    DEFINE_AND_USE_RESOURCE_1  ; Macro defining and using resource 1<br />    DEFINE_AND_USE_RESOURCE_2  ; Macro defining and using resource 2<br /></code></pre><br /><br /><br />Is there really no way to make macros affect code/data output that is located on a lower line-number in the listing? Not in <strong>any</strong> way? It feels like a relatively simple thing to implement, MASM being a multi-pass compiler and everything, and it would add <strong>so much</strong> more power to the macros, so I still haven't lost hope that it might actually be possible.<br /><br />If anyone would have the slightest idea or clue about how to do this, I would be eternally grateful. :)<br /><br />Thanks!</div>
    <div class="meta">Posted on 2003-01-08 08:55:47 by dELTA</div>
   </div>
   <div class="post" id="post-75071">
    <div class="subject"><a href="#post-75071">Advanced MASM macro programming question</a></div>
    <div class="body"><div class="quote">The limitation that I am stuck on is that the execution of macros seem to be of a strictly linear nature. I.e. a macro that is called on line X in the listing cannot it any way affect the code that is generated at line Y, when Y &lt; X.</div>Generally speaking this is a limitation of MASM due to the linear nature of the assembly passes.  Specific mechanisms can be devised to overcome this limitation.  For example, see my switch/case macro.<br /><br />The switch/case macro shows how to use a dynamic array of values.  Other basic data structures can be created and managed within TEXTEQU's to accomplish more complex features.<br /><br />Your example is flawed in that the structure in BUILD_DYNAMIC_STRUCT can't be redefined unless it has a different name.  To accomplish this you would have to abstract out the structure name into a TEXTEQU and change that to reflect the current structure being used.  Alternately, you could manage the structure with the macro.  We can quickly see how convoluted this will be.<br /><br />I must say I am quite impressed with your understanding and detailed questions. :alright:</div>
    <div class="meta">Posted on 2003-01-08 11:33:12 by bitRAKE</div>
   </div>
   <div class="post" id="post-75137">
    <div class="subject"><a href="#post-75137">Advanced MASM macro programming question</a></div>
    <div class="body">I don't think I've even seen any assembler that allows a macro &quot;backward reference&quot; like you're talking about. Even the macro processor in the IBM mainframe assembler, which is very powerful, is still top to bottom.<br /><br />:)</div>
    <div class="meta">Posted on 2003-01-08 17:00:21 by S/390</div>
   </div>
   <div class="post" id="post-75150">
    <div class="subject"><a href="#post-75150">Advanced MASM macro programming question</a></div>
    <div class="body">bitRAKE, I looked at your switch/case macros, but sadly I found it a bit hard to isolate the exact code you are referring to. :( Could you possibly post a short conceptual example here of what you mean? Would it be applicable to my example? Even the more generic example?<br /><br /><br />The best solution I can come up with for the generic example is the following:<br /><br /><pre><code><br />    call init_all_used_resources ; Calls a label in the INIT_ALL_USED_RESOURCES macro<br />    DEFINE_AND_USE_RESOURCE_1    ; Macro defining and using resource 1<br />    DEFINE_AND_USE_RESOURCE_2    ; Macro defining and using resource 2<br />    jmp exit_program<br />    INIT_ALL_USED_RESOURCES      ; Macro initializing all used resources,<br />                                 ; ending with a ret instruction<br /></code></pre><br />It adds one call-instruction and one ret-instruction to the code, and makes it a bit uglier just in general, but I guess I'll just have to live with that then. :)<br /><br />And for dynamic structures, the structure definition can simply be moved below the code, as in my suggested &quot;work-around solution&quot; for the example in my original post. This will add no extra size or complexity to the produced exe, only some uglyness to the source code. :)<br /><br />And yes, I know that the struct-code in my example is flawed, generally crappy and far from nice or optimal :), I just wanted to make it as simple as possible, to show the concept in the cleanest possible way, so that people wouldn't get tired of reading it after getting half-way through it. :)<br /><br /><br /><div class="quote">I must say I am quite impressed with your understanding and detailed questions</div><br />Just typical, here I am, getting complimented for my understanding and everything, and then I blow it all by not understanding some things that you write in the very same post. ;) Well, I try my best anyway. :rolleyes:<br /><br />Thanks!</div>
    <div class="meta">Posted on 2003-01-08 18:02:22 by dELTA</div>
   </div>
   <div class="post" id="post-75153">
    <div class="subject"><a href="#post-75153">Advanced MASM macro programming question</a></div>
    <div class="body">S/390, thanks for the info. I wonder why noone did this though? It would obviously increase the power of the macro language quite much, and at first glance it should not be very hard to implement either? At least not compared to some other things that are already present in most compilers already, it would seem to me.<br /><br />One might e.g. be allowed to assign an &quot;evaluation layer&quot; number to the macro calls, defining in which sweep the macro call in question should be executed/evaluated.<br /><br />In my example (from my original post in this thread) it might look like this:<br /><br /><br /><pre><code><br />    INIT_ALL_USED_RESOURCES&#123;2&#125;    ; Macro initializing all used resources<br />    DEFINE_AND_USE_RESOURCE_1&#123;1&#125;  ; Macro defining and using resource 1<br />    DEFINE_AND_USE_RESOURCE_2&#123;1&#125;  ; Macro defining and using resource 2<br /></code></pre><br /><br />Where the &quot;evaluation layer&quot; number is inside the curly braces for each macro call.<br /><br />On compile time, the compiler would then repeatedly sweep over the source listing, only evaluating macro statements, until all specified sweeps are done (macro statements without an &quot;evaluation layer&quot; number should be considered belonging to the first sweep), and after this the compiler would proceed with its normal business, checking the syntax of the complete listing, producing binary code and so on.<br /><br />I cannot foresee any possible problems or hardships implementing this? Have I missed to consider something, or did the compiler developers just underestimate the potentially huge usefulness of such a feature? What do you think?</div>
    <div class="meta">Posted on 2003-01-08 18:24:34 by dELTA</div>
   </div>
   <div class="post" id="post-75189">
    <div class="subject"><a href="#post-75189">Advanced MASM macro programming question</a></div>
    <div class="body"><strong>dELTA</strong>, why isn't a UNION effective?  I have not seen enough of what your trying to accomplish to code a working example.  The layering feature would be nice - I've had the same idea myself.  Usually, there are sufficient abstraction layers to linearize the code - usually easier to manage code, too. ;)</div>
    <div class="meta">Posted on 2003-01-08 23:14:02 by bitRAKE</div>
   </div>
   <div class="post" id="post-75229">
    <div class="subject"><a href="#post-75229">Advanced MASM macro programming question</a></div>
    <div class="body">bitRAKE, a UNION data structure is not the kind of solution I'm looking for. It would maybe work as a work-around solution in my stupid example (I already admitted that this example sucked, you don't have to rub it in :tongue: ), but as I said, that example is just a way to demonstrate the following, more general problem:<br /><br /><pre><code><br />    INIT_ALL_USED_RESOURCES    ; Macro initializing all used resources<br />    DEFINE_AND_USE_RESOURCE_1  ; Macro defining and using resource 1<br />    DEFINE_AND_USE_RESOURCE_2  ; Macro defining and using resource 2<br /></code></pre><br />In which I want the execution of &quot;DEFINE_AND_USE_RESOURCE_1&quot; and &quot;DEFINE_AND_USE_RESOURCE_2&quot; to affect the output of &quot;INIT_ALL_USED_RESOURCES&quot;.<br /><br />Without moving any of these three macros relative to each other in the code (like I did in my call/ret solution above), but with all other methods allowed, would your tricks be able to accomplish anything like that?<br /><br />If anyone else has any suggestions or tips too, they are of course just as welcome.<br /><br />Thanks!</div>
    <div class="meta">Posted on 2003-01-09 05:11:57 by dELTA</div>
   </div>
   <div class="post" id="post-75258">
    <div class="subject"><a href="#post-75258">Advanced MASM macro programming question</a></div>
    <div class="body"><strong>dELTA</strong>, I do not know of a general solution, but specific work arounds are possible.  Generally speaking though, you would create all the data in TEXTEQU's and finally do the code generation on the end - see the switch/case macro. :)</div>
    <div class="meta">Posted on 2003-01-09 08:38:11 by bitRAKE</div>
   </div>
   <div class="post" id="post-75274">
    <div class="subject"><a href="#post-75274">Advanced MASM macro programming question</a></div>
    <div class="body">Yes, but as long as the code-generating macro is positioned higher up in the listing than any of the macros that define the TEXTEQU:s, this is still not possible, right? Because it is impossible to communicate data with TEXTEQU:s &quot;upward&quot; in the listing, right? And then you'd still have to resort to my call/ret work-around solution to make sure that the generated code is located before the code in all of the other referencing macros in the control flow during execution of the program, and that is exactly what I'm trying to avoid. :(<br /><br />Hence, as far as I can see, in order to get your TEXTEQU-technique to work, the involved macros can be seen as a set, in which the code generation always occurs in the macro that is located last in this set (farthest down in the listing), as seems to be the case with your switch/case macros (?), and then we have again just made a work-around solution, not addressing the problem of affecting the execution of a macro higher up in the listing with another macro lower down in the listing, right? :(<br /><br />In my resource-init example this would not work (without using my earlier mentioned call/ret solution), since the resource initialization code will have to be executed before the first reference to a resource during the execution of the program. :(<br /><br />Please tell me if there's something that I still don't seem to understand, and in that case it would be really great if you could show how to communicate data with TEXTEQU:s upward in the listing, causing the code generation to occur in a macro that is not the last one in the set (with &quot;last one&quot; I mean the one that is called farthest down in the listing).<br /><br />Thanks!</div>
    <div class="meta">Posted on 2003-01-09 10:56:04 by dELTA</div>
   </div>
  </div>
 </body>
</html>