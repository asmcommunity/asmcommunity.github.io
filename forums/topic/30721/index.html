<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>GCD code help - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=30721" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=5">Algorithms &amp; Source Code</a> &raquo; <a href="../?id=30721">GCD code help</a></p>
   <div class="post" id="post-215284">
    <div class="subject"><a href="#post-215284">GCD code help</a></div>
    <div class="body">I have got this working to an extent. It finds the GCD for 5 and 20 fine and goes along its merry way&nbsp; :D. But when I run the second batch of number it kills the program&nbsp; :cry:. I have been over this and I just cant figure out what I am doing wrong here. It might be a registry or I am not pushing or poping a reg right and that is messing up the code or the pointer is not pointing in the right variable or I am not cleaning up the stack right I really dont know.<br />Thanks for any help or advice you can give. <br /><pre><code>TITLE MASM 	GCD					(GCD.asm)<br /><br /><br />INCLUDE Irvine32.inc<br />.data<br />myMessage BYTE &quot;GCD &quot;,0dh,0ah,0<br />myMess2&nbsp;  BYTE &quot;The GCD is = &quot; ,0dh,0ah,0<br /><br />;first set of nums<br />val1 DWORD&nbsp; 5<br />val2 DWORD&nbsp; 20<br /><br />;second set of nums<br />val3 DWORD&nbsp; 24<br />val4 DWORD&nbsp; 18<br /><br />.code<br />main PROC<br />	call Clrscr&nbsp; <br /><br />	mov	 edx,offset myMessage<br />	call WriteString		;write message<br />	call Crlf				;new line<br />	push val1				;push 1st set on the stack<br />	push val2<br />	call GCD<br />	pop val1<br />	pop val2<br />	mov	 edx,offset myMess2<br />	call WriteString<br />	call WriteInt&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Display GCD WriteInt uses EAX = qutent<br />	call Crlf				;new line<br />	<br />	;next set of values<br />	push val4				;push 1st set on the stack<br />	push val3<br />	call GCD<br />	pop val4<br />	pop val3<br />	mov	 edx,offset myMess2<br />	call WriteString<br />	call WriteInt&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;Display GCD WriteInt uses EAX = qutent<br /><br />	exit<br />main ENDP<br /><br />;------------------------------------------------<br />GCD PROC<br />; This finds GCD<br />; Gets values from stored values<br />;returns NA<br /><br />;------------------------------------------------<br />		<br />	<br />		<br />		mov&nbsp; edx,0					;zero out edx for remainder<br />		mov&nbsp; eax,dword ptr&nbsp; ;dividend<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; ebx,dword ptr&nbsp;  ;divisor<br />		div&nbsp; ebx&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;eax/ebx<br />		cmp&nbsp; edx,0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;remainder in edx<br />		<br />		je&nbsp;  L1		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;yes: quit<br />		call GCD		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;no: call GCD agian<br />	L1:<br />		mov eax,ebx			&nbsp; &nbsp; &nbsp; &nbsp; ;move the divisor into eax for printing i.e GCD	<br />	&nbsp; &nbsp; call DumpRegs				;show what is in the registry<br />	&nbsp; <br />&nbsp; &nbsp; 	ret 8&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;clean up the stack<br />GCD ENDP<br /><br />END main</code></pre><br /><br />now if I return 12 from the GCD proc it does not kill the program, but I does not return the right answer either so I am missing something here. I think its with the stack but not quit sure on what to do. </div>
    <div class="meta">Posted on 2011-10-26 09:37:54 by lordgus</div>
   </div>
   <div class="post" id="post-215285">
    <div class="subject"><a href="#post-215285">Re: GCD code help</a></div>
    <div class="body">You seem to be inventing your own calling convention with the first call you push arguments and then inside the proc you don&#039;t. I can&#039;t blame you though because Kip invented his own calling convention too.<br /><br /><pre><code>GCD_IR proc<br />	mov ecx,edx<br />	xor edx,edx<br />	div ecx<br />	or edx,edx<br />	jz L1<br />	mov eax,ecx<br />	call GCD_IR<br />	ret<br />L1:<br />	mov eax,ecx<br />	ret<br />GCD_IR endp	<br />	<br /><br />GCD_STD proc STDCALL A,B<br />	mov eax,A<br />	xor edx,edx<br />	div B<br />	or edx,edx<br />	jz L1<br />	invoke GCD_STD,B,edx<br />	ret<br />L1:<br />	mov eax,B<br />	ret<br />GCD_STD endp	<br /><br /><br />GCD_C proc C A,B<br />	mov eax,A<br />	xor edx,edx<br />	div B<br />	or edx,edx<br />	jz L1<br />	invoke GCD_C,B,edx<br />	ret<br />L1:<br />	mov eax,B<br />	ret<br />GCD_C endp<br /><br /><br />	;IRVINE-CALLING-CONVENTION <br />	mov eax,24<br />	mov edx,18<br />	call GCD_IR<br />	<br />	;STDCALL-CALLING-CONVENTION <br />	invoke GCD_STD,24,18<br />	<br />	;C-CALLING-CONVENTION <br />	invoke GCD_C,24,18<br />&nbsp; </code></pre><br /><br />As you can see GCD_STD and GCD_C are almost indentical but not if you look at the generated instructions either by disasm. debug or generating a listing.<br /><br />Note, GCD_IR is not a real Irvine-Calling-Convention&nbsp; proc as it doesn&#039;t preserve edx and ecx.<br /><br />Please read about calling conventions and decide what you want to use!<br /><br />Your errors are:<br />1)<br /><pre><code>ret 8&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ;clean up the stack</code></pre><br />and<br /><pre><code>	pop val1<br />	pop val2</code></pre><br />are mutually exclusive, either callee frees the stack or caller frees the stack, not both.<br /><br />2)<br /><pre><code>&nbsp; &nbsp; &nbsp;  mov&nbsp; eax,dword ptr&nbsp; ;dividend<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; ebx,dword ptr&nbsp;  ;divisor</code></pre><br />if stack pointer is not modified in the proc prologue then<br /> is the return address<br /> is the FIRST argument<br /> is the SECOND argument<br /><br />3)<br /><pre><code>je&nbsp;  L1		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;yes: quit<br />		call GCD		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;no: call GCD agian<br />	L1:</code></pre> No RET after call means this falls through, I guess this is ok when debugging.<br /></div>
    <div class="meta">Posted on 2011-10-26 12:37:39 by drizz</div>
   </div>
   <div class="post" id="post-215286">
    <div class="subject"><a href="#post-215286">Re: GCD code help</a></div>
    <div class="body">As drizz points out, first you&#039;ve got to figure out your calling convention. That&#039;s why it&#039;s crashing the second time. The reason it works the first time is that you picked some &quot;lucky&quot; values. There&#039;s been a lot written about GCD algorithms (some of which is more confusing than not reading it!). I recalled reading a very clever one someplace... ah, here it is!<br /><br />http://www.azillionmonkeys.com/qed/asmexample.html<br /><br />That might be too much of a clue. You&#039;re probably &quot;supposed&quot; to do it with a recursive algorithm. But you can take a look anyway...<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2011-10-26 13:35:28 by fbkotler</div>
   </div>
   <div class="post" id="post-215287">
    <div class="subject"><a href="#post-215287">Re: GCD code help</a></div>
    <div class="body">Thank you both very much that set me straight on a few things of why this program was not working and what I was doing wrong. I still just cant get the hang of assembly over java. But with practice come more practice.</div>
    <div class="meta">Posted on 2011-10-26 14:48:42 by lordgus</div>
   </div>
  </div>
 </body>
</html>