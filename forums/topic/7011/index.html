<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>A riddle. - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=7011" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=7011">A riddle.</a></p>
   <div class="post" id="post-50709">
    <div class="subject"><a href="#post-50709">A riddle.</a></div>
    <div class="body">Hi!<br />I was trying to figure out how SystemTime and LocalTime work, so I wrote this.<br />But as you already now, I'm sort of a sloppy coder, so as I couldn?t figure out how to make a procedure work, I wrote a whole series of repeating macros.<br /><br />So what I propose you is: give solutions of how you would solve it, and I will post my solution in 24-hours time.<br /><br />Fun, isn't it?<br /><pre><code><br />.386 <br />.model flat,stdcall <br />option casemap&#58;none <br />include \masm32\include\windows.inc <br />include \masm32\include\kernel32.inc <br />includelib \masm32\lib\kernel32.lib <br />include \masm32\include\user32.inc <br />includelib \masm32\lib\user32.lib <br /><br />TimeProcedure PROTO<br /><br />.data <br /> <br />Caption	DB &quot;Localtime and Systemtime&quot;,0<br />Text	DB &quot;             LOCAL        SYSTEM&quot;,0Dh,0Ah<br />	DB &quot;Year&#58;  &quot;<br />localyear DB 126,32,32,32,32<br />	DB 11 DUP&#40;32&#41;<br />systemyear DB 126,32,32,32,32<br />	DB 0Dh,0Ah,&quot;Mon&quot;<br />localmonth DB &quot;t&quot;,&quot;h&quot;,&quot;&#58;&quot;,32,32<br />	DB 15 DUP &#40;32&#41;<br />systemmonth DB 32,32,32,32,32<br />	DB 0Ah, 0Dh,&quot;Day of w&quot;<br />localdow DB &quot;e&quot;,&quot;e&quot;,&quot;k&quot;,&quot;&#58;&quot;,32<br />	DB 9 DUP &#40;32&#41;<br />systemdow DB 32,32,32,32,32<br />	DB 0Dh,0Ah,&quot;Day&#58;&quot;<br />localday DB 32,32,126,32,32<br />	DB 16 DUP &#40;32&#41;<br />systemday DB 32,32,126,32,32<br />	DB 0D,0Ah,&quot;Hour&#58;&quot;<br />localhour DB 32,32,32,32,32<br />	DB 17 DUP &#40;32&#41;<br />systemhour DB 32,32,32,32,32<br />	DB 0Dh,0Ah,&quot;Minute&#58;&quot;<br />localmin DB 32,32,32,32,32<br />	DB 15 DUP &#40;32&#41;<br />systemmin DB 32,32,32,32,32<br />	DB 0Dh,0Ah,&quot;Second&#58;&quot;<br />localsec DB 32,32,32,32,32<br />	DB 15 DUP &#40;32&#41;<br />systemsec DB 32,32,32,32,32<br />	DB 0Dh,0Ah,&quot;Milliseconds&#58;&quot;<br />localm DB 32,32,32,32,32<br />	DB 7 DUP &#40;32&#41;<br />systemm DB 32,32,32,32,32<br />	DW NULL<br /><br />m2m MACRO M1, M2<br />    push M2<br />    pop M1<br />    ENDM<br />    <br /><br />change MACRO TextParam, StrctParam<br />    LOCAL convert<br />    <br />    xor eax,eax<br />    mov ax,StrctParam<br />    lea edi, &#91;TextParam&#93;<br />    add edi,5<br />    mov cx,10<br />convert&#58;<br />    xor edx,edx<br />    div cx      ;Remainder in DL<br />    add dl,30h  ;To ASCII<br />    mov &#91;edi&#93;,dl<br />    dec edi<br />    cmp ax,0<br />    jne convert<br />     ENDM<br /><br /><br />S STRUCT WORD<br />    SYear DW ?<br />    SMonth DW ?<br />    SDayOfWeek DW ?<br />    SDay DW ?<br />    SHour DW ?<br />    SMinute DW ?<br />    SSecond DW ?<br />    SMilliseconds DW ?<br />S ENDS<br /><br />.code <br />start&#58; <br /><br />	invoke TimeProcedure<br />	invoke MessageBox, NULL, addr Text, addr Caption, MB_OK <br />	invoke ExitProcess, NULL<br /><br />TimeProcedure PROC<br /> 	LOCAL Loc &#58;S<br />      LOCAL Syst &#58;S<br />       invoke GetLocalTime, addr Loc<br />	invoke GetSystemTime, addr Syst<br />	<br />    pushfd<br />    push edi   <br />    <br />     change localyear, Loc.SYear<br />     change systemyear, Syst.SYear<br />     change localmonth,Loc.SMonth<br />     change systemmonth,Syst.SMonth<br />     change localdow,Loc.SDayOfWeek<br />     change systemdow,Syst.SDayOfWeek<br />     change localday, Loc.SDay     <br />     change systemday,Syst.SDay<br />     change localhour,Loc.SHour<br />     change systemhour,Syst.SHour<br />     change localmin,Loc.SMinute<br />     change systemmin,Syst.SMinute<br />     change localsec,Loc.SSecond<br />     change systemsec, Syst.SSecond<br />     change localm, Loc.SMilliseconds<br />     change systemm, Syst.SMilliseconds<br /><br />;We should use a procedure instead of all these macros, but it<br />; sometimes gives problems with run-time structs like Loc and Syst<br /><br />    pop edi<br />    popfd<br />    ret<br />TimeProcedure ENDP<br />end start<br /></code></pre></div>
    <div class="meta">Posted on 2002-07-29 10:58:33 by slop</div>
   </div>
   <div class="post" id="post-50716">
    <div class="subject"><a href="#post-50716">A riddle.</a></div>
    <div class="body"><div class="quote">So what I propose you is: give solutions of how you would solve it, and I will post my solution in 24-hours time.</div><br /><br />Solve what?  I don't understand.  :confused:</div>
    <div class="meta">Posted on 2002-07-29 11:26:24 by iblis</div>
   </div>
   <div class="post" id="post-50721">
    <div class="subject"><a href="#post-50721">A riddle.</a></div>
    <div class="body">Man , don?t you have sense of homour?<br /><br />You can:<br />1) play;<br />2) don?t play;<br />3) get a handkerchief and clean that slime from your face.<br /><br />It?s THAT easy ;)</div>
    <div class="meta">Posted on 2002-07-29 11:40:04 by slop</div>
   </div>
   <div class="post" id="post-50736">
    <div class="subject"><a href="#post-50736">A riddle.</a></div>
    <div class="body">Here's my solution<br /><br />--uses proc instead of macro<br />--STRUC definition is removed cause I can't see a use for it<br />--DATA section is cleaned up quite a bit<br />--values are right align under the columns (of course the message box font messes this up so it don't look so aligned)<br />--removed preservation of flags and edi since IntToStrBk preserves registers. I'm not sure why you're preserving flags, but you can put it back in if you like<br /><br /><br /><pre><code><br />.386 <br />.model flat,stdcall <br />option casemap&#58;none <br />include \masm32\include\windows.inc <br />include \masm32\include\kernel32.inc <br />includelib \masm32\lib\kernel32.lib <br />include \masm32\include\user32.inc <br />includelib \masm32\lib\user32.lib <br /><br />TimeProcedure PROTO<br />IntToStrBk PROTO &#58;DWORD,&#58;DWORD<br /><br />.data <br /> <br />Caption	DB &quot;Localtime and Systemtime&quot;,0<br /><br />;each string is 32 bytes, not including the CF-LF<br />;The last &quot;L&quot; in local is 18 bytes in, the &quot;M&quot; in system is<br />;32 bytes in. Hence the invoke IntToStrBk,addr &#91;YearText+17&#93;,<br />;etc. That way if you force a fixed with font, everything<br />;will be aligned to the right underneath their respective<br />;labels<br /><br />Text                DB &quot;             LOCAL        SYSTEM&quot;,0Dh,0Ah<br />YearText            DB &quot;Year&#58;                           &quot;,0Dh,0Ah<br />MonthText           DB &quot;Month&#58;                          &quot;,0Dh,0Ah<br />DoWText             DB &quot;Day of Week&#58;                    &quot;,0Dh,0Ah<br />DayText             DB &quot;Day&#58;                            &quot;,0Dh,0Ah<br />HourText            DB &quot;Hour&#58;                           &quot;,0Dh,0Ah<br />MinuteText          DB &quot;Minute&#58;                         &quot;,0Dh,0Ah<br />SecondText          DB &quot;Second&#58;                         &quot;,0Dh,0Ah<br />MillisecondText     DB &quot;Millisecond&#58;                    &quot;,0Dh,0Ah,0<br />                    <br />.code <br />start&#58; <br /><br />	invoke TimeProcedure<br />	invoke MessageBox, NULL, addr Text, addr Caption, MB_OK <br />	invoke ExitProcess, NULL<br /><br />TimeProcedure PROC<br />    LOCAL Loc &#58;SYSTEMTIME<br />    LOCAL Syst &#58;SYSTEMTIME<br />    <br />    invoke GetLocalTime, addr Loc<br />    invoke GetSystemTime, addr Syst<br />    invoke IntToStrBk,addr &#91;YearText+17&#93;,Loc.wYear<br />    invoke IntToStrBk,addr &#91;YearText+31&#93;,Syst.wYear<br />    invoke IntToStrBk,addr &#91;MonthText+17&#93;,Loc.wMonth<br />    invoke IntToStrBk,addr &#91;MonthText+31&#93;,Syst.wMonth<br />    invoke IntToStrBk,addr &#91;DoWText+17&#93;,Loc.wDayOfWeek<br />    invoke IntToStrBk,addr &#91;DoWText+31&#93;,Syst.wDayOfWeek<br />    invoke IntToStrBk,addr &#91;DayText+17&#93;,Loc.wDay<br />    invoke IntToStrBk,addr &#91;DayText+31&#93;,Syst.wDay<br />    invoke IntToStrBk,addr &#91;HourText+17&#93;,Loc.wHour<br />    invoke IntToStrBk,addr &#91;HourText+31&#93;,Syst.wHour<br />    invoke IntToStrBk,addr &#91;MinuteText+17&#93;,Loc.wMinute<br />    invoke IntToStrBk,addr &#91;MinuteText+31&#93;,Loc.wMinute<br />    invoke IntToStrBk,addr &#91;SecondText+17&#93;,Loc.wSecond<br />    invoke IntToStrBk,addr &#91;SecondText+31&#93;,Loc.wSecond<br />    invoke IntToStrBk,addr &#91;MillisecondText+17&#93;,Loc.wMilliseconds<br />    invoke IntToStrBk,addr &#91;MillisecondText+31&#93;,Loc.wMilliseconds<br />    ret<br />TimeProcedure ENDP<br /><br />;convert a dword to a string<br />;starting at lpDest and working backwards &#40;i.e., right align the<br />;string to the lpDest variable&#41;<br /><br />IntToStrBk              PROC uses ebx ecx edx lpDest,Value&#58;DWORD<br />                        mov eax,Value<br />                        mov ebx,lpDest<br />                        mov ecx,10<br />@@&#58;                     xor edx,edx<br />                        div ecx<br />                        add dl,30h<br />                        mov BYTE PTR &#91;ebx&#93;,dl<br />                        dec ebx<br />                        test eax,eax<br />                        jnz @B<br />                        ret<br />IntToStrBk              ENDP<br /><br />end start<br /><br /></code></pre><br /><br /><br />--Chorus</div>
    <div class="meta">Posted on 2002-07-29 13:35:00 by chorus</div>
   </div>
   <div class="post" id="post-50912">
    <div class="subject"><a href="#post-50912">A riddle.</a></div>
    <div class="body">Thank you chorus, you are the only one to answer, so you have won it ;)<br /><br />It has take me more than 24 hours, coz I couldn?t get it done... and it?s not finished yet. But im giving up I think.<br />My solution is the less obvious.<br /><br />I called this thread &quot;a riddle&quot; because it's sort of it, and the answer is probably one you wouldn't think of: I've changed assembler.<br />Yes, I've retyped the whole thing using fasm and a great help from Michael Pruitt, and this is the solution.<br />But I don?t seem to make it work properly, I think it could be solved by using some 'virtual at' in the macro, but maybe probably only Privalov, bAZiK or bitRAKE can help me solve this out ;)<br /><pre><code><br />;<br />; Sorry, I can?t make it work&#58; 'symbol already defined' while using macros<br />;<br /><br />format PE GUI 4.0<br />entry start<br /><br />include 'include\kernel.inc'<br />include 'include\user.inc'<br /><br />include 'include\macro\stdcall.inc'<br />include 'include\macro\import.inc'<br /><br />macro convert place,offset,number<br /> &#123; local number<br />   local offset<br />   local place<br />   mov edi,place + offset<br />   cmp &#91;number&#93;,2<br />   jz @f			;Anonymous labels are a new feature of v. 1.39 beta2<br />  sub edi,36			;This macro is dependent on this particular data structure<br />@@&#58; call .convert<br /> &#125;<br /><br /><br />section '.code' code readable executable<br />start&#58;<br />	invoke GetLocalTime, Time<br />	invoke Format_Time, Time,1<br /><br />	invoke GetSystemTime,Time<br />	invoke Format_Time, Time,2<br /><br />	invoke MessageBox,0,Text,Caption,MB_OK<br />	invoke ExitProcess,0<br /><br />proc	Format_Time, AnyTime,AnyNumber<br />	enter<br /><br />	mov	ax, &#91;AnyTime.wYear&#93;		;16-bit data<br />	convert Text.Date,9+36,AnyNumber	;Does conversion to printable format<br /><br />	mov	ax,&#91;AnyTime.wDay&#93;<br />	convert Text.Date,4+36,AnyNumber<br /><br />	mov	ax,&#91;AnyTime.wMonth&#93;<br />	convert Text.Date,1+36,AnyNumber<br /><br />	mov edi,Text.Day-36<br />	mov esi,ListDays<br />	repeat 2		;How will FASM translate this? Like a macro? Or will it make a counter 2 loop?<br />	add edi, 36<br />	xor eax,eax<br />	mov ax, &#91;AnyTime.wDayOfWeek&#93;<br />	add esi, eax<br />	add esi, eax<br />	add esi, eax		;Clever way to move in ListDays<br />	mov ecx, 3<br />	cld<br />	rep movsb<br />	end repeat<br /><br />	mov ax, &#91;AnyTime.wHour&#93;<br />	convert Text.Time,1+36,AnyNumber<br /><br />	mov ax,&#91;AnyTime.wMinute&#93;<br />	convert Text.Time,4+36,AnyNumber<br /><br />	mov ax,&#91;Anytime.wSecond&#93;<br />	convert Text.Time,7+36,AnyNumber<br /><br />	return<br /><br />.convert&#58;			;by Michael Pruitt, this gave me the idea to translate the first version<br />	std<br />	cmp ax,10<br />	jl .one<br /><br />	and ah,ah<br />	jz .two<br /><br />	mov bh,10<br />	div bh<br />	or ah,30h<br />	mov &#91;edi&#93;,ah<br />	dec edi<br />.two&#58;<br />	aam<br />	or al,30h<br />	stosb<br />	mov al,ah<br />	cmp ah,9<br />	jg .two<br />.one&#58;<br />	or al,30h<br />	stosb<br /><br />	cld<br />	ret<br /><br />section '.data' data readable writeable<br /><br />Caption db &quot;Tempus fugit...&quot;,0<br />Text&#58;	db &quot;LOCALTIME&#58;	&quot;<br />.Day	db &quot;WkD&quot;<br />.Date	db &quot; 0/00/0000&quot;<br />.Time	db &quot; 0&#58;00&#58;00&quot;, Cr, Lf<br />.More	db &quot;SYSTEMTIME&#58;  WkD 0/00/0000 0&#58;00&#58;00&quot;,0<br /><br />ListDays db &quot;SunMonTueWedThuFriSat&quot;<br /><br />Cr	= 0Dh<br />Lf	= 0Ah<br />Time	SYSTEMTIME<br /><br />section '.idata' import data readable writeable<br /><br />  library kernel, 'kernel32.dll',\<br />	  user,   'user32.dll'<br /><br />  kernel&#58;<br />  import GetLocalTime, 'GetLocalTime',\<br />	 GetSystemTime, 'GetSystemTime',\<br />	 ExitProcess, 'ExitProcess'<br /><br />  user&#58;<br />  import MessageBox, 'MessageBoxA'<br /><br /></code></pre><br /><br />Chorus, of course, after following your answers, see that it was easier than I did it, the best of all is that it works!.<br />I don?t know, maybe I?m sloppy because I don?t seem to make thinks work with modularity and good programming principles... so I switch to sloppines to get the job done.<br />I wish you could tell me how do you get it done, and at the same time looks clear, intelligent, and readable.<br /><br /><br />Thanx, chorus. (I?ll have to think what the prize for you is, any idea?)<br />sloopy.</div>
    <div class="meta">Posted on 2002-07-30 13:19:39 by slop</div>
   </div>
   <div class="post" id="post-50916">
    <div class="subject"><a href="#post-50916">A riddle.</a></div>
    <div class="body">I gave it a quick look and did a small corrections to make it work (quick and dirty):<br /><pre><code><br />format PE GUI 4.0<br />entry start<br /><br />include 'include\kernel.inc'<br />include 'include\user.inc'<br /><br />include 'include\macro\stdcall.inc'<br />include 'include\macro\import.inc'<br /><br />macro convert place,offset,number<br /> &#123;<br />   mov edi,place + offset<br />   cmp &#91;number&#93;,2<br />   jz @f<br />   sub edi,36<br />   @@&#58; call .convert<br /> &#125;<br /><br />section '.code' code readable executable<br />start&#58;<br />	invoke GetLocalTime, Time<br />	stdcall Format_Time, Time,1<br /><br />	invoke GetSystemTime,Time<br />	stdcall Format_Time, Time,2<br /><br />	invoke MessageBox,0,Text,Caption,MB_OK<br />	invoke ExitProcess,0<br /><br />proc	Format_Time, AnyTime,AnyNumber<br />	enter<br />	mov	ebx,&#91;AnyTime&#93;<br />	virtual at ebx<br />	 ATime SYSTEMTIME<br />	end virtual<br /><br />	mov	ax, &#91;ATime.wYear&#93;	      ;16-bit data<br />	convert Text.Date,9+36,AnyNumber	;Does conversion to printable format<br /><br />	mov	ax,&#91;ATime.wDay&#93;<br />	convert Text.Date,4+36,AnyNumber<br /><br />	mov	ax,&#91;ATime.wMonth&#93;<br />	convert Text.Date,1+36,AnyNumber<br /><br />	mov edi,Text.Day-36<br />	mov esi,ListDays<br />	repeat 2	<br />	add edi, 36<br />	xor eax,eax<br />	mov ax, &#91;ATime.wDayOfWeek&#93;<br />	add esi, eax<br />	add esi, eax<br />	add esi, eax		<br />	mov ecx, 3<br />	cld<br />	rep movsb<br />	end repeat<br /><br />	mov ax, &#91;ATime.wHour&#93;<br />	convert Text.Time,1+36,AnyNumber<br /><br />	mov ax,&#91;ATime.wMinute&#93;<br />	convert Text.Time,4+36,AnyNumber<br /><br />	mov ax,&#91;ATime.wSecond&#93;<br />	convert Text.Time,7+36,AnyNumber<br /><br />	return<br /><br />.convert&#58;			;by Michael Pruitt, this gave me the idea to translate the first version<br />	std<br />	cmp ax,10<br />	jl .one<br /><br />	and ah,ah<br />	jz .two<br /><br />	mov dh,10<br />	div dh<br />	or ah,30h<br />	mov &#91;edi&#93;,ah<br />	dec edi<br />.two&#58;<br />	aam<br />	or al,30h<br />	stosb<br />	mov al,ah<br />	cmp ah,9<br />	jg .two<br />.one&#58;<br />	or al,30h<br />	stosb<br /><br />	cld<br />	ret<br /><br />section '.data' data readable writeable<br /><br />Caption db &quot;Tempus fugit...&quot;,0<br />Text&#58;	db &quot;LOCALTIME&#58;	&quot;<br />.Day	db &quot;WkD&quot;<br />.Date	db &quot; 0/00/0000&quot;<br />.Time	db &quot; 0&#58;00&#58;00&quot;, Cr, Lf<br />.More	db &quot;SYSTEMTIME&#58;  WkD 0/00/0000 0&#58;00&#58;00&quot;,0<br /><br />ListDays db &quot;SunMonTueWedThuFriSat&quot;<br /><br />Cr	= 0Dh<br />Lf	= 0Ah<br />Time	SYSTEMTIME<br /><br />section '.idata' import data readable writeable<br /><br />  library kernel, 'kernel32.dll',\<br />	  user,   'user32.dll'<br /><br />  kernel&#58;<br />  import GetLocalTime, 'GetLocalTime',\<br />	 GetSystemTime, 'GetSystemTime',\<br />	 ExitProcess, 'ExitProcess'<br /><br />  user&#58;<br />  import MessageBox, 'MessageBoxA'<br /></code></pre><br /><br />EDIT: To assemble it with fasm version older than 1.40 beta 2, replace the convert macro with following (doesn't need anonymous labels):<br /><pre><code><br />macro convert place,offset,number<br /> &#123;<br />   local .cnv<br />   mov edi,place + offset<br />   cmp &#91;number&#93;,2<br />   jz .cnv<br />   sub edi,36<br />   .cnv&#58; call .convert<br /> &#125;<br /></code></pre></div>
    <div class="meta">Posted on 2002-07-30 13:48:47 by Tomasz Grysztar</div>
   </div>
   <div class="post" id="post-50948">
    <div class="subject"><a href="#post-50948">A formatted solution</a></div>
    <div class="body"><pre><code><br />.386 <br />.model flat,stdcall <br />option casemap&#58;none <br /><br />include \masm32\include\windows.inc <br />include \masm32\include\kernel32.inc <br />include \masm32\include\user32.inc <br /><br /><br />includelib \masm32\lib\kernel32.lib <br />includelib \masm32\lib\user32.lib <br /><br />TimeProcedure PROTO<br />IntToStr PROTO &#58;DWORD,&#58;DWORD<br />StringCopy PROTO &#58;DWORD,&#58;DWORD<br /><br />CR EQU 13<br />LF EQU 10<br /><br />DOW                     STRUC  <br />  NameOfDay             db 16 dup &#40;0&#41;<br />DOW                     ENDS   <br /><br />.data <br /> <br />Caption                 DB &quot;Localtime and Systemtime&quot;,0<br /><br /><br />LocalText               DB &quot;Local Time&#58;   &quot;,0<br />SystemText              DB &quot;System Time&#58;  &quot;,0<br />Buffer                  DB 128 dup &#40;0&#41;<br />WeekdayNames            DOW &lt;&quot;Sunday &quot;&gt;<br />                        DOW &lt;&quot;Monday &quot;&gt;<br />                        DOW &lt;&quot;Tuesday &quot;&gt;<br />                        DOW &lt;&quot;Wednesday &quot;&gt;<br />                        DOW &lt;&quot;Thursday &quot;&gt;<br />                        DOW &lt;&quot;Friday &quot;&gt;<br />                        DOW &lt;&quot;Saturday &quot;&gt;<br />                    <br /><br />.code <br />start&#58; <br />                        invoke TimeProcedure<br />                        invoke MessageBox, NULL, addr Buffer, addr Caption, MB_OK <br />                        invoke ExitProcess, NULL<br /><br />TimeProcedure           PROC<br />                        LOCAL Loc &#58;SYSTEMTIME<br />                        LOCAL Syst &#58;SYSTEMTIME<br />                        <br />                        invoke GetLocalTime, addr Loc<br />                        invoke GetSystemTime, addr Syst<br />                        invoke StringCopy,addr Buffer,addr LocalText<br />                        movzx edx,Loc.wDayOfWeek<br />                        shl edx,4<br />                        add edx,offset WeekdayNames<br />                        invoke StringCopy,eax,edx<br />                        <br />                        invoke IntToStr,eax,Loc.wDay<br />                        mov BYTE PTR &#91;eax&#93;,'/'<br />                        invoke IntToStr,addr &#91;eax+1&#93;,Loc.wMonth<br />                        mov BYTE PTR &#91;eax&#93;,'/'<br />                        invoke IntToStr,addr &#91;eax+1&#93;,Loc.wYear<br />                        mov DWORD PTR &#91;eax&#93;,'    '<br />                        invoke IntToStr,addr &#91;eax+4&#93;,Loc.wHour<br />                        mov DWORD PTR &#91;eax&#93;,'&#58;'<br />                        invoke IntToStr,addr &#91;eax+1&#93;,Loc.wMinute<br />                        mov DWORD PTR &#91;eax&#93;,'&#58;'<br />                        invoke IntToStr,addr &#91;eax+1&#93;,Loc.wSecond<br />                        mov DWORD PTR &#91;eax&#93;,'&#58;'<br />                        invoke IntToStr,addr &#91;eax+1&#93;,Loc.wMilliseconds<br />                        mov BYTE PTR &#91;eax&#93;,CR<br />                        mov BYTE PTR &#91;eax+1&#93;,LF<br />                        invoke StringCopy,addr &#91;eax+2&#93;,addr SystemText<br />                        movzx edx,Loc.wDayOfWeek<br />                        shl edx,4<br />                        add edx,offset WeekdayNames<br />                        invoke StringCopy,eax,edx<br />                        invoke IntToStr,eax,Syst.wDay<br />                        mov BYTE PTR &#91;eax&#93;,'/'<br />                        invoke IntToStr,addr &#91;eax+1&#93;,Syst.wMonth<br />                        mov BYTE PTR &#91;eax&#93;,'/'<br />                        invoke IntToStr,addr &#91;eax+1&#93;,Syst.wYear<br />                        mov DWORD PTR &#91;eax&#93;,'    '<br />                        invoke IntToStr,addr &#91;eax+4&#93;,Syst.wHour<br />                        mov DWORD PTR &#91;eax&#93;,'&#58;'<br />                        invoke IntToStr,addr &#91;eax+1&#93;,Syst.wMinute<br />                        mov DWORD PTR &#91;eax&#93;,'&#58;'<br />                        invoke IntToStr,addr &#91;eax+1&#93;,Syst.wSecond<br />                        mov DWORD PTR &#91;eax&#93;,'&#58;'<br />                        invoke IntToStr,addr &#91;eax+1&#93;,Syst.wMilliseconds<br />                        ret<br />TimeProcedure           ENDP<br /><br />IntToStr                PROC uses ebx ecx edx esi edi lpDest,value&#58;DWORD<br />                        LOCAL textbuffer&#91;10&#93;&#58;BYTE<br />                        mov eax,value<br />                        xor edi,edi<br />                        lea esi,textbuffer<br />                        mov ecx,10<br />@@&#58;                     xor edx,edx<br />                        div ecx<br />                        add dl,30h<br />                        mov BYTE PTR &#91;esi+edi&#93;,dl<br />                        inc edi<br />                        test eax,eax<br />                        jnz @B<br />                        mov ebx,lpDest<br />                        lea eax,&#91;ebx+edi&#93;<br />                        dec edi<br />@@&#58;                     mov dl, BYTE PTR &#91;esi&#93;<br />                        mov BYTE PTR &#91;ebx+edi&#93;,dl<br />                        inc esi<br />                        sub edi,1<br />                        jns @B<br />                        ret<br />IntToStr                ENDP<br /><br />StringCopy              PROC uses edi esi edx lpDest,lpSource&#58;DWORD<br />                        mov edi,lpDest<br />                        mov esi,lpSource<br />                        or eax,-1<br />                        xor edx,edx<br />@@&#58;                     inc eax<br />                        mov dl,BYTE PTR &#91;esi+eax&#93;<br />                        mov BYTE PTR &#91;edi+eax&#93;,dl<br />                        test dl,dl<br />                        jnz @B<br />                        add eax,edi<br />                        ret<br />StringCopy              ENDP<br /><br />end start<br /></code></pre></div>
    <div class="meta">Posted on 2002-07-30 17:24:26 by chorus</div>
   </div>
   <div class="post" id="post-50951">
    <div class="subject"><a href="#post-50951">A riddle.</a></div>
    <div class="body">Sloppy, haven't tried FASM yet, but I hear it's &quot;All the Rage&quot; ;)<br /><br />Since you asked, here's a few notes about my code:<br /><br />1st version<br />--pass on the macros if you can. In some instances they are useful but I find they often &quot;bloat&quot; the code. Some people on the board use em, but you have to be careful. Macros have several drawbacks. The two foremost I would say is increasing code size (when you could use a procedure and &quot;reuse&quot; the same bytes) and also you can't get as much control as you may want.<br /><br />Ex. m2m, uses push/pop's which can be slower than a mov eax,/mov ,eax. Plus, you can't schedule the instructions in a macro.<br /><br />--Cleaned up the data section so not only is it readable, it makes for easy coding.<br /><br />2nd version<br />--introduce two new procs StringCopy and IntToStr. StringCopy is a stripped down version of the string copy proc I usually use, but it has the one important property that I like in my own StringCopy: it returns the ptr to the end of the dest so it's easy to make multiple calls.<br /><br />Ex.<br />invoke StringCopy,addr Buffer,addr FirstName<br />invoke StringCopy,eax,addr LastName<br />invoke StringCopy,eax,addr Address<br />etc.<br /><br />This is also true of IntToStr; it returns a ptr to the byte past the ASCII number. Note that StringCopy is zero terminated whereas IntToStr isn't<br /><br />--Add formating bytes. Take advantage of the return value of IntToStr to move in backslashes and colons, etc to format the string. This way, we needn't worry about extra string in our data section. We also don't need to worry about the length of the integer.<br /><br />--Use the DOW STRUC. This struc automatically zeroterminates strings for me and keeps strings blocked into 16 bytes. When you store it in an array you can easily extract the name of the Day of the week from the SYSTEMTIME.wDayOfWeek value.<br /><br />--Couple of equates for CR and LF. Just to make the code more readable<br /><br />There's a couple things I think you can take from these examples:<br /><br />--If you're gonna write your own procs, return something useful. Thus your program is more data driven and more flexible<br />--Proper use of strucs can make your source clearer<br />--calling a proc 10 times is smaller code than using 10 macros that do what the proc does and it isn't any worse for readability<br />--Clearer code is faster to debug and to type<br /><br />--Chorus</div>
    <div class="meta">Posted on 2002-07-30 17:38:00 by chorus</div>
   </div>
   <div class="post" id="post-51917">
    <div class="subject"><a href="#post-51917">A riddle.</a></div>
    <div class="body">These two thanks arrive one week later, but, you can guess. don?t make me say it... I think only of sayng it I?ll have another.<br />Thanks a lot Privalov; thanks a lot  chorus. I already owed Tomasz a beer, so I see now it?s two ;)<br />I hope some day I?ll be as sharp as you, and won?t have that many krashes (you see,scientica, even more than you)  (I?ll change my nick then ;) )<br /><span style="font-size:9px>Maverick, if you see this, I agree, let?s better use the messageboard to communicate. Stami bene.</span></div>
    <div class="meta">Posted on 2002-08-06 10:44:42 by slop</div>
   </div>
  </div>
 </body>
</html>