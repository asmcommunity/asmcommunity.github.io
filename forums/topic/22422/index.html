<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Question on calling system context menu from my program(solved)  - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=22422" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=22422">Question on calling system context menu from my program(solved) </a></p>
   <div class="post" id="post-168256">
    <div class="subject"><a href="#post-168256">Question on calling system context menu from my program(solved) </a></div>
    <div class="body">I want to call system context menu from my program.<br /><br />I do it at first in VC6. It called the context menu of file c:\windows\explorer.exe. It works well. The code is:<br /><br /><pre><code><br />//Worked well in VC 6<br /><br />LPSHELLFOLDER lpDeskFolder;<br />    SHGetDesktopFolder(&amp;lpDeskFolder);<br />    if(!lpDeskFolder)<br />    {<br />        MessageBox(LPSTR(&quot;Fail to get desktop folder!&quot;),<br />            LPSTR(&quot;ccrun&#39;s App&quot;), MB_OK | MB_ICONWARNING);<br />        return;<br />    }<br />    <br /> char strFileName&#91;] = &quot;explorer.exe&quot;;<br /> char strFilePath&#91;] = &quot;c:\\windows&quot;;<br /> int nPathLen = sizeof(strFilePath);<br />    <br />    wchar_t wszPath;<br />    LPITEMIDLIST ParentPidl;<br />    DWORD dwEaten;<br />    MultiByteToWideChar(CP_ACP, MB_PRECOMPOSED, strFilePath, nPathLen, wszPath, MAX_PATH);<br /> <br /> DWORD dwResult =  lpDeskFolder-&gt;ParseDisplayName(GetSafeHwnd(),<br />            0, wszPath, &amp;dwEaten, &amp;ParentPidl, 0);<br />    if(dwResult != NOERROR)<br />    {<br />        MessageBox(LPSTR(&quot;Invalid file name!&quot;),<br />            LPSTR(&quot;ccrun&#39;s App&quot;), MB_OK | MB_ICONWARNING);<br />        return;<br />    }<br /><br />    // Get the info of IShellFolder<br />    LPSHELLFOLDER lpParentFolder;<br />    lpDeskFolder-&gt;BindToObject(ParentPidl, 0,<br />            IID_IShellFolder,(void **)&amp;lpParentFolder);<br />    if(!lpParentFolder)<br />    {<br />        MessageBox(LPSTR(&quot;Invalid file name!&quot;),<br />            LPSTR(&quot;ccrun&#39;s App&quot;), MB_OK | MB_ICONWARNING);<br />        lpDeskFolder-&gt;Release();<br />        lpParentFolder-&gt;Release();<br />        return;<br />    }<br />    LPITEMIDLIST lpItemIDList;<br /><br />    MultiByteToWideChar(CP_ACP, MB_PRECOMPOSED, strFileName, sizeof(strFileName), wszPath, MAX_PATH);<br />    lpParentFolder-&gt;ParseDisplayName(GetSafeHwnd(),<br />            0, wszPath, &amp;dwEaten, &amp;lpItemIDList, 0);<br /><br />    // Get the context menu of files<br />    LPCONTEXTMENU lpContextMenu;<br />    lpParentFolder-&gt;GetUIObjectOf(GetSafeHwnd(), 1,<br />           (LPCITEMIDLIST *)&amp;lpItemIDList, IID_IContextMenu,<br />           0, (void**)&amp;lpContextMenu);<br />    if(!lpContextMenu)<br />    {<br />        MessageBox(&quot;Fail to get the interface of context menu!&quot;,<br />            &quot;ccrun&#39;s App&quot;, MB_OK | MB_ICONWARNING);<br />        lpDeskFolder-&gt;Release();<br />        lpParentFolder-&gt;Release();<br />        return;<br />    }<br />  <br />    CMINVOKECOMMANDINFO ici;<br />    ZeroMemory(&amp;ici, sizeof(ici));<br />    ici.cbSize = sizeof(CMINVOKECOMMANDINFO);<br />    ici.hwnd = GetSafeHwnd();<br /><br />    // Create context menu<br />    HMENU hMenu = CreatePopupMenu();<br />    dwResult = CMF_EXPLORE;<br />    lpContextMenu-&gt;QueryContextMenu(hMenu, 0, 1, 0x7FFF, dwResult);<br /><br />    // Display the menu<br />    POINT pt;<br />    GetCursorPos(&amp;pt);<br />    int Cmd = TrackPopupMenu(hMenu, TPM_LEFTALIGN | TPM_LEFTBUTTON |<br />            TPM_RIGHTBUTTON | TPM_RETURNCMD,<br />            pt.x, pt.y, 0, GetSafeHwnd(), 0);<br />    ici.lpVerb = MAKEINTRESOURCE(Cmd - 1);<br />    ici.lpParameters = &quot;&quot;;<br />    ici.lpDirectory = &quot;&quot;;<br />    ici.nShow = SW_SHOWNORMAL;<br />    lpContextMenu-&gt;InvokeCommand(&amp;ici);<br /><br />    lpContextMenu-&gt;Release();<br />    lpParentFolder-&gt;Release();<br />    lpDeskFolder-&gt;Release();<br /></code></pre><br /><br />I translated the code to masm32,  but I get following error messages:<br /><div class="quote"> <br />  Assembling: D:\masm32\works\contextmenu\3.asm<br />D:\masm32\works\contextmenu\3.asm(48) : error A2006: undefined symbol : ParseDisplayName<br />D:\masm32\works\contextmenu\3.asm(63) : error A2006: undefined symbol : BindToObject<br />D:\masm32\works\contextmenu\3.asm(69) : error A2006: undefined symbol : ParseDisplayName<br />D:\masm32\works\contextmenu\3.asm(84) : error A2006: undefined symbol : ParseDisplayName<br />D:\masm32\works\contextmenu\3.asm(92) : error A2006: undefined symbol : GetUIObjectOf<br />D:\masm32\works\contextmenu\3.asm(110) : error A2006: undefined symbol : g_lpContextMenu<br />D:\masm32\works\contextmenu\3.asm(114) : error A2044: invalid character in file<br />D:\masm32\works\contextmenu\3.asm(116) : error A2008: syntax error : ax<br />D:\masm32\works\contextmenu\3.asm(121) : error A2006: undefined symbol : g_lpCon<br />textMenu<br />_<br />Assembly Error<br /></div><br /><br />My code in masm32 is:<br /><pre><code><br />.386<br />.model flat, stdcall<br />option casemap:none<br />include \masm32\include\windows.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\shell32.inc<br />include \masm32\com\include\shlobj.inc<br />include \masm32\include\user32.inc<br />includelib \masm32\lib\kernel32.lib<br />includelib \masm32\lib\shell32.lib<br />;includelib \masm32\com\colib\shlobj.lib<br />includelib \masm32\lib\user32.lib<br /><br />.data<br />g_szFailGetDesktopFolder db  &quot;Fail to get desktop folder!&quot;, 0<br />g_szInvalidFileName db &quot;Invalid filename!&quot;, 0<br />g_szFailToGetMenuInterface db &quot;Fail to get the interface of context menu!&quot;, 0<br />g_szFileName db &quot;explorer.exe&quot;, 0<br />g_dwPathLen dword sizeof g_szFileName<br />g_szFilePath db &quot;c:\\windows&quot;, 0<br />    <br />g_wszPath dw MAX_PATH dup (?)<br />g_dwEaten dword ?<br />g_lpDeskFolder LPSHELLFOLDER ? <br />g_lpParentFolder LPSHELLFOLDER ?<br />g_ParentPidl ITEMIDLIST &lt;&gt;<br />g_lpItemIDList dword ?<br />g_lpContextMenu LPCONTEXTMENU &lt;&gt;<br />g_ici CMINVOKECOMMANDINFO &lt;&gt;<br />g_hMenu HANDLE ?<br />g_wTmp word ?<br /><br />.code<br />start:<br />    invoke SHGetDesktopFolder, ADDR g_lpDeskFolder<br />    cmp eax, NOERROR<br />    je @F<br /><br />    invoke MessageBox, NULL, ADDR g_szFailGetDesktopFolder, ADDR g_szFailGetDesktopFolder, MB_OK + MB_ICONSTOP<br />    xor ecx, ecx<br />    jecxz @exit<br />@@:    <br />    invoke MultiByteToWideChar, CP_ACP, MB_PRECOMPOSED, ADDR g_szFilePath, ADDR g_dwPathLen, ADDR g_wszPath, MAX_PATH<br />	<br />    push ebx<br />    mov		ebx, offset g_lpDeskFolder<br />    mov		ebx, <br />    invoke	(IShellFolder ptr ).ParseDisplayName, NULL, 0, g_wszPath, ADDR g_dwEaten, ADDR g_ParentPidl, 0<br />    pop ebx<br /><br />    cmp eax, NOERROR<br />    je @F<br /><br />    invoke MessageBox, NULL, ADDR g_szInvalidFileName, ADDR g_szInvalidFileName, MB_OK + MB_ICONSTOP<br />    xor ecx, ecx<br />    jecxz @exit<br />@@: <br />    ; get info of IShellFolder<br />    ;-----------------------------<br />    push ebx<br />    mov		ebx, offset g_lpDeskFolder<br />    mov		ebx, <br />    invoke (IShellFolder ptr ).BindToObject, g_ParentPidl, 0, IID_IShellFolder, ADDR g_lpParentFolder<br />    pop ebx<br /><br />    push ebx<br />    mov		ebx, offset g_lpDeskFolder<br />    mov		ebx, <br />    invoke (IShellFolder ptr ).ParseDisplayName, NULL, 0, g_wszPath, ADDR g_dwEaten, ADDR g_ParentPidl, 0<br />    pop ebx<br /><br />    cmp eax, NOERROR<br />    je @F<br /><br />    invoke MessageBox, NULL, ADDR g_szInvalidFileName, ADDR g_szInvalidFileName, MB_OK + MB_ICONSTOP<br />    xor ecx, ecx<br />    jecxz @exit<br />@@:    <br />    invoke MultiByteToWideChar, CP_ACP, MB_PRECOMPOSED, ADDR g_szFileName, SIZEOF g_szFileName, ADDR g_wszPath, MAX_PATH<br /><br />    push ebx<br />    mov		ebx, offset g_lpDeskFolder<br />    mov		ebx, <br />    invoke (IShellFolder ptr ).ParseDisplayName, NULL, 0, ADDR g_wszPath, ADDR g_dwEaten, ADDR g_lpItemIDList, 0<br />    pop ebx<br /><br />    ; Get the context menu<br />    ;-----------------------<br />    push ebx<br />    mov		ebx, offset g_lpDeskFolder<br />    mov		ebx, <br />    invoke (IShellFolder ptr ).GetUIObjectOf, NULL, 1,  ADDR g_lpItemIDList, IID_IContextMenu, 0, ADDR g_lpContextMenu<br />    pop ebx<br /><br />    cmp eax, NOERROR; g_lpDeskFolder <br />    je @F<br /><br />    invoke MessageBox, NULL, ADDR g_szFailToGetMenuInterface, ADDR g_szFailToGetMenuInterface, MB_OK + MB_ICONSTOP<br />    xor ecx, ecx<br />    jecxz @exit<br />@@:    <br />    invoke RtlZeroMemory, ADDR g_ici, sizeof g_ici<br />    mov g_ici.cbSize, sizeof CMINVOKECOMMANDINFO<br />    ;mov g_ici.hwnd, hDlog<br /><br />    ;Create context menu<br />    ;---------------------<br />    invoke CreatePopupMenu<br />    mov g_hMenu, eax<br />    invoke g_lpContextMenu.QueryContextMenu, ghMenu, 0, 1, 0x7FFF, CMF_EXPLORE<br /><br />    ;Show the menu<br />    ;---------------------<br />    invoke TrackPopupMenu, g_hMenu, TPM_LEFTALIGN | TPM_LEFTBUTTON | TPM_RIGHTBUTTON | TPM_RETURNCMD, 5, 5, 0, NULL, 0<br />    dec eax<br />    MAKEINTRESOURCE ax<br />    mov g_ici.lpVerb, eax<br />    mov g_ici.lpParameters, NULL<br />    mov g_ici.lpDirectory, NULL<br />    mov g_ici.nShow, SW_SHOWNORMAL<br />    invoke g_lpContextMenu.InvokeCommand, ADDR g_ici<br />@exit:<br />    invoke ExitProcess,NULL<br /><br />end start<br /><br /></code></pre><br /><br />Why they do not recognize the method of IShellFolder?<br /><br />Thanks...</div>
    <div class="meta">Posted on 2005-11-26 03:23:53 by purpleendurer</div>
   </div>
   <div class="post" id="post-168270">
    <div class="subject"><a href="#post-168270">Re: Question on calingl system context menu from my program</a></div>
    <div class="body">mov ebx,g_lpDeskFolder<br />mov ebx,<br />invoke (IShellFolder ptr ).ParseDisplayName, NULL, 0, ADDR g_wszPath, ADDR g_dwEaten, ADDR g_lpItemIDList, 0<br /><br />should be<br />coinvoke g_lpDeskFolder,IShellFolder,ParseDisplayName,NULL,0,addr g_wsz...<br /><br /><br />or in a more direct approach<br />mov edx,g_lpDeskFolder<br />mov edx,<br />Scall dword ptr,g_lpDeskFolder,NULL,0,addr g_wsz.....<br /><br />or in your style<br />mov edx,g_lpDeskFolder<br />mov edx,<br />invoke (IShellFolder ptr ).IShellFolder_ParseDisplayName,g_lpDeskFolder,NULL, 0, ADDR g_wszPath, ADDR g_dwEaten, ADDR g_lpItemIDList, 0</div>
    <div class="meta">Posted on 2005-11-26 07:57:31 by Ultrano</div>
   </div>
   <div class="post" id="post-168298">
    <div class="subject"><a href="#post-168298">Re: Question on calling system context menu from my program</a></div>
    <div class="body">Ultrano, thank you...<br /><br />I tried:<br /><pre><code><br />&nbsp; &nbsp; mov		edx, g_lpDeskFolder<br />&nbsp; &nbsp; mov		edx, <br />&nbsp; &nbsp; invoke (IShellFolder ptr ).IShellFolder_ParseDisplayName, NULL, 0, g_wszPath, ADDR g_dwEaten, ADDR ParentPidl, 0<br /></code></pre><br /><br />It works now...<br /><br />May I not need to push and pop value of edx?<br /><br />Now I has a new question. That is:<br /><pre><code><br />.data<br />g_ParentPidl LPITEMIDLIST ?<br /><br />.code<br />....<br />&nbsp; &nbsp; mov		edx, g_lpDeskFolder<br />&nbsp; &nbsp; mov		edx, <br /><br />&nbsp; &nbsp; ;lpDeskFolder-&gt;BindToObject(g_ParentPidl, 0, IID_IShellFolder,(void **)&amp;lpParentFolder);<br /><br />&nbsp; &nbsp; invoke (IShellFolder ptr ).IShellFolder_BindToObject, g_ParentPidl, NULL, ADDR IID_IShellFolder, ADDR g_lpParentFolder<br /></code></pre><br /><br />I got some error messages when I Assemble &amp; Link it. They are:<br /><div class="quote"><br /> Assembling: D:\masm32\works\contextmenu\3.asm<br />D:\masm32\works\contextmenu\3.asm(26) : error A2008: syntax error : LPITEMIDLIST<br />D:\masm32\works\contextmenu\3.asm(67) : error A2137: too few arguments to INVOKE<br />D:\masm32\works\contextmenu\3.asm(67) : error A2006: undefined symbol : g_ParentPidl<br />D:\masm32\works\contextmenu\3.asm(67) : error A2114: INVOKE argument type mismatch : argument : 1<br /></div><br />How to define a variable of&nbsp; LPITEMIDLIST type?<br /><br />Regards,<br />purpleendurer<br /><br /><br /><br /><br /></div>
    <div class="meta">Posted on 2005-11-27 09:27:34 by purpleendurer</div>
   </div>
   <div class="post" id="post-168299">
    <div class="subject"><a href="#post-168299">Re: Question on calling system context menu from my program</a></div>
    <div class="body">Hello,<br /><br />You don&#39;t need to preserve the value in edx, since the call would probably destroy the value in it.</div>
    <div class="meta">Posted on 2005-11-27 09:33:42 by roticv</div>
   </div>
   <div class="post" id="post-168300">
    <div class="subject"><a href="#post-168300">Re: Question on calling system context menu from my program</a></div>
    <div class="body">Define the variable like this:<br />g_ParentPidl dd&nbsp; ? ; pointer to ITEMIDLIST <br /><br />In assembler, you needn&#39;t specify what type of pointer the variable is - it&#39;s always a 4-byte value. In order not to lose track of what this variable points to, I usually put a comment like the one above. <br /><br />roticv is right, you don&#39;t need to preserve EDX when you use &quot;coinvoke&quot;. But just remember that it has been filled with &quot;strange&quot; value :) . Also ECX will be filled with another &quot;strange&quot; value. (I mean, do not rely on them being preserved). <br /><br />Also, I should note that you must <strong>never use EDX as a parameter to a &quot;coinvoke&quot;</strong>. For instance:<br /><br />mov edx,1<br />coinvoke pObject,ISomeObject,SomeMethod,0,0,EDX<br /><br />This is because EDX&#39;s value will be overwritten by &quot;coinvoke&quot; . </div>
    <div class="meta">Posted on 2005-11-27 10:02:16 by Ultrano</div>
   </div>
   <div class="post" id="post-168313">
    <div class="subject"><a href="#post-168313">Re: Question on calling system context menu from my program</a></div>
    <div class="body">Thanks, Ultrano and&nbsp; roticv...<br /><br />I keeps your words in my mind..<br /><br />now I have some new questions.<br /><br />I modify my codes as:<br /><pre><code><br />.386<br />.model flat, stdcall<br />option casemap:none<br />include \masm32\include\windows.inc<br />include \masm32\include\kernel32.inc<br />include \masm32\include\shell32.inc<br />include \masm32\com\include\shlobj.inc<br />include \masm32\include\user32.inc<br />includelib \masm32\lib\kernel32.lib<br />includelib \masm32\lib\shell32.lib<br />;includelib \masm32\com\colib\shlobj.lib<br />includelib \masm32\lib\user32.lib<br /><br />.data<br />g_szFailGetDesktopFolder db&nbsp; &quot;Fail to get desktop folder!&quot;, 0<br />g_szInvalidFileName db &quot;Invalid filename!&quot;, 0<br />g_szFailToGetMenuInterface db &quot;Fail to get the interface of context menu!&quot;, 0<br />g_szFileName db &quot;explorer.exe&quot;, 0<br />g_dwPathLen dword sizeof g_szFileName<br />g_szFilePath db &quot;c:\\windows&quot;, 0<br />&nbsp; &nbsp; <br />g_wszPath dw MAX_PATH dup (?)<br />g_dwEaten dword ?<br />g_lpDeskFolder LPSHELLFOLDER ? <br />g_lpParentFolder LPSHELLFOLDER ?<br />g_ParentPidl dd ? ; Pointer to ITEMIDLIST<br />g_lpItemIDList dd ?<br />g_lpContextMenu dd ?; Pointer to LPCONTEXTMENU<br />g_ici CMINVOKECOMMANDINFO &lt;&gt;<br />g_hMenu HANDLE ?<br /><br />IID_IShellFolder GUID sIID_IShellFolder<br />IID_IContextMenu GUID sIID_IContextMenu<br /><br />.code<br />start:<br />&nbsp; &nbsp; invoke SHGetDesktopFolder, ADDR g_lpDeskFolder<br />&nbsp; &nbsp; cmp eax, NOERROR<br />&nbsp; &nbsp; je @F<br /><br />&nbsp; &nbsp; invoke MessageBox, NULL, ADDR g_szFailGetDesktopFolder, ADDR g_szFailGetDesktopFolder, MB_OK + MB_ICONSTOP<br />&nbsp; &nbsp; xor ecx, ecx<br />&nbsp; &nbsp; jecxz @exit<br />@@:&nbsp; &nbsp; <br />&nbsp; &nbsp; invoke MultiByteToWideChar, CP_ACP, MB_PRECOMPOSED, ADDR g_szFilePath, ADDR g_dwPathLen, ADDR g_wszPath, MAX_PATH<br />	<br />&nbsp; &nbsp; ;push edx<br />&nbsp; &nbsp; mov edx, g_lpDeskFolder<br />&nbsp; &nbsp; mov edx, <br />&nbsp; &nbsp; invoke (IShellFolder ptr ).IShellFolder_ParseDisplayName, g_lpDeskFolder, NULL, 0, ADDR g_wszPath, ADDR g_dwEaten, ADDR g_lpItemIDList, 0<br />&nbsp; &nbsp; ;pop edx<br /><br />&nbsp; &nbsp; cmp eax, NOERROR<br />&nbsp; &nbsp; je @F<br /><br />&nbsp; &nbsp; invoke MessageBox, NULL, ADDR g_szInvalidFileName, ADDR g_szInvalidFileName, MB_OK + MB_ICONSTOP<br />&nbsp; &nbsp; xor ecx, ecx<br />&nbsp; &nbsp; jecxz @exit<br />@@: <br />&nbsp; &nbsp; ; get info of IShellFolder<br />&nbsp; &nbsp; ;-----------------------------<br />&nbsp; &nbsp; mov edx, g_lpDeskFolder<br />&nbsp; &nbsp; mov edx, <br />&nbsp; &nbsp; ;lpDeskFolder-&gt;BindToObject(g_ParentPidl, 0, IID_IShellFolder,(void **)&amp;lpParentFolder)<br />&nbsp; &nbsp; invoke (IShellFolder ptr ).IShellFolder_BindToObject, g_ParentPidl, NULL, ADDR IID_IShellFolder, ADDR g_lpParentFolder<br /><br />&nbsp; &nbsp; mov edx, g_lpDeskFolder<br />&nbsp; &nbsp; mov edx, <br />&nbsp; &nbsp; invoke (IShellFolder ptr ).IShellFolder_ParseDisplayName, NULL, 0, ADDR g_wszPath, ADDR g_dwEaten, ADDR g_ParentPidl, 0<br /><br />&nbsp; &nbsp; cmp eax, NOERROR<br />&nbsp; &nbsp; je @F<br /><br />&nbsp; &nbsp; invoke MessageBox, NULL, ADDR g_szInvalidFileName, ADDR g_szInvalidFileName, MB_OK + MB_ICONSTOP<br />&nbsp; &nbsp; xor ecx, ecx<br />&nbsp; &nbsp; jecxz @exit<br />@@:&nbsp; &nbsp; <br />&nbsp; &nbsp; invoke MultiByteToWideChar, CP_ACP, MB_PRECOMPOSED, ADDR g_szFileName, SIZEOF g_szFileName, ADDR g_wszPath, MAX_PATH<br /><br />&nbsp; &nbsp; mov edx, g_lpDeskFolder<br />&nbsp; &nbsp; mov edx, <br />&nbsp; &nbsp; invoke (IShellFolder ptr ).IShellFolder_ParseDisplayName, NULL, 0, ADDR g_wszPath, ADDR g_dwEaten, ADDR g_lpItemIDList, 0<br /><br />&nbsp; &nbsp; ; Get the context menu<br />&nbsp; &nbsp; ;-----------------------<br />&nbsp; &nbsp; mov edx, g_lpDeskFolder<br />&nbsp; &nbsp; mov edx, <br />&nbsp; &nbsp; invoke (IShellFolder ptr ).IShellFolder_GetUIObjectOf, NULL, 1,&nbsp; ADDR g_lpItemIDList, IID_IContextMenu, 0, ADDR g_lpContextMenu<br /><br />&nbsp; &nbsp; cmp eax, NOERROR; g_lpDeskFolder <br />&nbsp; &nbsp; je @F<br /><br />&nbsp; &nbsp; invoke MessageBox, NULL, ADDR g_szFailToGetMenuInterface, ADDR g_szFailToGetMenuInterface, MB_OK + MB_ICONSTOP<br />&nbsp; &nbsp; xor ecx, ecx<br />&nbsp; &nbsp; jecxz @exit<br />@@:&nbsp; &nbsp; <br />&nbsp; &nbsp; invoke RtlZeroMemory, ADDR g_ici, sizeof g_ici<br />&nbsp; &nbsp; mov g_ici.cbSize, sizeof CMINVOKECOMMANDINFO<br />&nbsp; &nbsp; ;mov g_ici.hwnd, hDlog<br /><br />&nbsp; &nbsp; ; Create context menu<br />&nbsp; &nbsp; ;---------------------<br />&nbsp; &nbsp; invoke CreatePopupMenu<br />&nbsp; &nbsp; mov g_hMenu, eax<br />&nbsp; &nbsp; mov edx, g_lpContextMenu<br />&nbsp; &nbsp; mov edx, <br />&nbsp; &nbsp; ;invoke g_lpContextMenu.QueryContextMenu, g_hMenu, 0, 1, 0x7FFF, CMF_EXPLORE<br />&nbsp; &nbsp; invoke (IContextMenu ptr ).IContextMenu_QueryContextMenu, g_hMenu, 0, 1, 07FFFh, CMF_EXPLORE<br /><br /><br />&nbsp; &nbsp; ; Show the menu<br />&nbsp; &nbsp; ;---------------------<br />&nbsp; &nbsp; invoke TrackPopupMenu, g_hMenu, TPM_LEFTALIGN or TPM_LEFTBUTTON or TPM_RIGHTBUTTON or TPM_RETURNCMD, 5, 5, 0, NULL, 0<br />&nbsp; &nbsp; dec eax<br />&nbsp; &nbsp; MAKEINTRESOURCE ax<br />&nbsp; &nbsp; mov g_ici.lpVerb, eax<br />&nbsp; &nbsp; mov g_ici.lpParameters, NULL<br />&nbsp; &nbsp; mov g_ici.lpDirectory, NULL<br />&nbsp; &nbsp; mov g_ici.nShow, SW_SHOWNORMAL<br />&nbsp; &nbsp; mov edx, g_lpContextMenu<br />&nbsp; &nbsp; mov edx, <br />&nbsp; &nbsp; ;invoke g_lpContextMenu.InvokeCommand, ADDR g_ici<br />&nbsp; &nbsp; invoke (IContextMenu ptr ).IContextMenu_InvokeCommand, ADDR g_ici<br />@exit:<br />&nbsp; &nbsp; invoke ExitProcess,NULL<br /><br />end start<br /></code></pre><br /><br />I got some error messages when I Assemble &amp; Link it. They are:<br /><div class="quote"><br /> Assembling: D:\masm32\works\contextmenu\3.asm<br />D:\masm32\works\contextmenu\3.asm(66) : error A2137: too few arguments to INVOKE<br /><br />D:\masm32\works\contextmenu\3.asm(72) : error A2137: too few arguments to INVOKE<br /><br />D:\masm32\works\contextmenu\3.asm(87) : error A2137: too few arguments to INVOKE<br /><br />D:\masm32\works\contextmenu\3.asm(95) : error A2137: too few arguments to INVOKE<br /><br />D:\masm32\works\contextmenu\3.asm(95) : error A2114: INVOKE argument type mismatch : argument : 4<br />D:\masm32\works\contextmenu\3.asm(116) : error A2137: too few arguments to INVOKE<br />D:\masm32\works\contextmenu\3.asm(116) : error A2206: missing operator in expression<br />D:\masm32\works\contextmenu\3.asm(116) : error A2114: INVOKE argument type mismatch : argument : 4<br />D:\masm32\works\contextmenu\3.asm(123) : error A2008: syntax error : ax<br />D:\masm32\works\contextmenu\3.asm(131) : error A2137: too few arguments to INVOKE<br />_<br />Assembly Error<br /></div><br /><br />I give right argument numbers to invoke, but recieve &quot;rror A2137: too few arguments to INVOKE&quot;<br /><br />I donot understand it<br /><br /><br />Regards,<br />purpleendurer</div>
    <div class="meta">Posted on 2005-11-28 00:27:53 by purpleendurer</div>
   </div>
   <div class="post" id="post-168314">
    <div class="subject"><a href="#post-168314">Re: Question on calling system context menu from my program</a></div>
    <div class="body">Instead of <br /><pre><code>invoke (IShellFolder ptr ).IShellFolder_BindToObject, g_ParentPidl, NULL, ADDR IID_IShellFolder, ADDR g_lpParentFolder</code></pre><br /><br />it should be<br /><pre><code>invoke (IShellFolder ptr ).IShellFolder_BindToObject,g_lpDeskFolder, g_ParentPidl, NULL, ADDR IID_IShellFolder, ADDR g_lpParentFolder</code></pre><br /><br />If I am not wrong. Just modify every line that has this mistake.</div>
    <div class="meta">Posted on 2005-11-28 00:31:43 by roticv</div>
   </div>
   <div class="post" id="post-168319">
    <div class="subject"><a href="#post-168319">Re: Question on calling system context menu from my program</a></div>
    <div class="body">Just to explain why we need that 1 extra parameter in calling COM objects:<br />there is always 1 &quot;hidden&quot; parameter, called _this. In COM objects, it is passed as the first parameter on stack. Thus <br />void SomeCOM::DoIt(long X){}<br />is actually:<br /><br />void SomeCOM::DoIt(SomeCOM* _this, long X){}<br /><br /></div>
    <div class="meta">Posted on 2005-11-28 07:57:17 by Ultrano</div>
   </div>
   <div class="post" id="post-168377">
    <div class="subject"><a href="#post-168377">Re: Question on calling system context menu from my program</a></div>
    <div class="body">thanks roticv and Ultrano <br /><br />roticv is right..<br />I did not note the code Ultrano gived first<br /><br />I missed g_lpDeskFolder parameter at invoke the method of IShellFolder<br />and missed g_lpContextMenu parameter at invoke the method of IContextMenu<br /><br />Thank Ultrano for your explain....<br /><br /><br />I searched a early relative topic:<br /><br />Calling shell context menu from my program in COM<br />http://www.asmcommunity.net/board/index.php?topic=17772.0<br /><br />It is useful for me, I am studying it...<br /><br /><br />Regards,<br />purpleendurer</div>
    <div class="meta">Posted on 2005-11-30 00:26:20 by purpleendurer</div>
   </div>
   <div class="post" id="post-168445">
    <div class="subject"><a href="#post-168445">Re: Question on calling system context menu from my program</a></div>
    <div class="body">Hi, everybody...<br /><br />With the great help of Ultrano and roticv, now my program can masm.link and run successfully(the source files are in attach)<br /><br />But I have a new question...<br /><br />I has passed  the CMF_EXPLORE flag:<br /><pre><code><br />                        invoke (IContextMenu ptr ).IContextMenu_QueryContextMenu, g_lpContextMenu, g_hMenu, 0, 1, 07FFFh, CMF_EXPLORE<br /></code></pre><br /><br /><br />but the context menu of my program  called is not  CMF_EXPLORE (a context menu with CMF_EXPLORE flag&nbsp; includes the extend menu item by WinRAR and other programs),  it is  like CMF_DEFAULTONLY at all(a context menu with CMF_DEFAULTONLY flag does not include&nbsp; the extend menu item by WinRAR and other programs).<br /><br /><br />I can not find out the reason?Who can give me some directions?<br /><br />Regards,<br />purpleendurer</div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=1278" target="_blank">contextmenu.zip</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2005-12-01 09:38:50 by purpleendurer</div>
   </div>
   <div class="post" id="post-168487">
    <div class="subject"><a href="#post-168487">Re: Question on calling system context menu from my program</a></div>
    <div class="body">I try to find the reason in VC6 program.<br /><br />I ceated a new MFC win32 program in VC6, and used the calling context menu code  I listed above.<br /><br />and the context menu this program called is still with CMF_DEFAULTONLY flag, like the one I has attached asm program called.  It is:<br /><br /><img src="http://www.asmcommunity.net/board/index.php?action=dlattach;topic=22422.0;attach=1281;image" /><br /><br />But uses the same code in a VC MFC program using flash.ocx to play flash file, the context menu be called is with CMF_EXPLORE flag. It is:<br /><br /><img src="http://www.asmcommunity.net/board/index.php?action=dlattach;topic=22422.0;attach=1283;image" /><br /><br />So if I want to call a context menu  with CMF_EXPLORE flag, I must use a ActiveX/COM object in my program?<br /><br />Regards,<br />purpleendurer</div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=1281" target="_blank">1.jpg</a></li>
      <li><a href="../../attachments/?id=1283" target="_blank">2.jpg</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2005-12-02 23:00:52 by purpleendurer</div>
   </div>
   <div class="post" id="post-168580">
    <div class="subject"><a href="#post-168580">Re: Question on calling system context menu from my program</a></div>
    <div class="body">Hi, everybody....<br /><br />I think I found the way to call context menu with CMF_EXPLORE flag.<br /><br />That is invoke CoInitialize() before call context menu.....<br /><br />In my attached code,  need to  add 3 statements only, They are:<br /><br /><hr /><br />include \masm32\include\ole32.inc ; Add this inc file<br />.....<br />includelib \masm32\lib\ole32.lib       ;Add this lib file<br /><br /><br />DlgProc proc hDlg: HWND,  uMsg: UINT,  wParam: WPARAM,  lParam: LPARAM<br />      .IF uMsg == WM_INITDIALOG<br />            m_m2m g_hDlg, hDlg<br /><br />            invoke CoInitialize, NULL              ; add this instruction<br /><br />      .ELSEIF uMsg == WM_CLOSE<br /><hr /><br /><br />But there is a question, it is the &quot;send to&quot; item of context menu does not work.<br /><br />Regards,<br />purpleendurer</div>
    <div class="meta">Posted on 2005-12-06 00:10:19 by purpleendurer</div>
   </div>
   <div class="post" id="post-168582">
    <div class="subject"><a href="#post-168582">Re: Question on calling system context menu from my program</a></div>
    <div class="body">Those are things beyond my scope of knowledge and experience, that&#39;s why I&#39;m quiet ^^&quot;&nbsp; -just to let you know</div>
    <div class="meta">Posted on 2005-12-06 01:29:36 by Ultrano</div>
   </div>
   <div class="post" id="post-168919">
    <div class="subject"><a href="#post-168919">Re: Question on calling system context menu from my program(solved) </a></div>
    <div class="body">Ultrano, you are modest...<br /><br />You had given me great helps....<br /><br />Thank you...</div>
    <div class="meta">Posted on 2005-12-15 09:01:37 by purpleendurer</div>
   </div>
  </div>
 </body>
</html>