<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Here is a Fasm utility... - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=7790" />
  <link rel="prev" href="../?id=7790&amp;page=1" />   </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=7790">Here is a Fasm utility...</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=7790&amp;page=1" style="">&laquo;</a><a href="../?id=7790&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="7790" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>   <div class="post" id="post-60382">
    <div class="subject"><a href="#post-60382">Here is a Fasm utility...</a></div>
    <div class="body">Hi Delight,<br /><br />couldn?t answer you before.<br /><br />1)<div class="quote">perhaps we can use the BoyerMore search algorithm by hutch</div>Yes, I tought of that also, but for this I think it's overkill. The Boyer-Moore is great for things like huge databases (internet, ODBC, etc). So we can use the regular FindSentence, from the API.<br /><br />2)<br /><div class="quote">UsedAPIS db 'MessageBeep', 0, 'MessageBox', 0, 'GetDlgItemInt', 0,'AnotherInvokedApi',0,'OneMore'<br /><br />and<br /><br />ApiLengths db 11,10,13,17,7</div><br />Looks interesting, but please explain it a little bit more. I don?t finish to get it. If we could use a base pointer to compare it would be REALLY FAST.<br /><br />3) Since I've been looking at your code in delphi, I think this is a very good exercise: translating to fasm. I saw that the compiler really overbloats the source with all sort of stuff. But then it's a very good starting point. So we could also start making other things in delphi. I'm thinking mostly about a way to automatize the resource generation. It sort of similar to this one.<br />What do you think? You are the delphi expert here :)<br /><br />4) and last,<br />the skeleton has grown, and now it only remains the COMPARE procedure, and output to do.<br />There is a change, because, as the process runs from the dialogbox, there's no need to open a file, but to process it directly (to open it will use the regular File/open menu).<br />The compare is a sequential thing, and then the output is written every time it finds a match.<br />This is the new skeleton:<pre><code><br />IDR_DELIGHT_DIALOG =307<br />IDM_DELIGHT =502<br />IDD_PATH =306	;DelightDialog with SetDlgItemText<br />IDD_COPY =402<br />IDD_OPEN =403<br />IDD_EDIT = 306<br />delight_text 	db &quot;invoke&quot;<br />_notfound_delight  db 'No invokes found',0<br />IncludePath db &quot;C&#58;\FASM\INCLUDE\APIA&quot;,0<br />.<br />.<br /><br /> nochild&#58;<br />        invoke  EnableMenuItem,&#91;hmenu&#93;,IDM_DELIGHT,MF_BYCOMMAND+MF_GRAYED   <br /><br />.<br />   wmcommand&#58;<br />	cmp ebx,IDM_DELIGHT<br />	je delight<br />.<br />.<br />.<br />delight&#58;<br />         invoke     DialogBoxParam,&#91;hInstance&#93;, IDR_DELIGHT_DIALOG, &#91;hwnd&#93;, DelightDialog, 0<br />         jmp         finish<br />.<br />.<br />.<br />proc DelightDialog,hwnddlg,msg,wparam,lparam<br />	enter<br />	push ebx esi edi<br />	cmp 	&#91;msg&#93;,WM_INITDIALOG<br />	je 	.initdialog<br />	cmp 	&#91;msg&#93;,WM_COMMAND<br />	je 	.command<br />	cmp	&#91;msg&#93;,WM_CLOSE<br />	je .close<br />	xor	eax,eax<br />	jmp	.finish<br />   .initdialog&#58;<br />	invoke SetDlgItemText,&#91;hwnddlg&#93;,IDD_PATH, IncludePath<br />	jmp .processed<br />   .command&#58;<br />	cmp &#91;wparam&#93;,IDD_OPEN<br />	je .open<br />	cmp &#91;wparam&#93;,IDD_COPY		<br />	jne .processed<br />   .copy&#58;<br />	invoke GetWindowLong, &#91;hwnddlg&#93;,GWL_USERDATA<br />	invoke  SendMessage,eax,WM_COPY,0,0<br />	jmp     .finish                         <br />  .delight&#58;<br />	invoke GetWindowLong, &#91;hwnddlg&#93;,GWL_USERDATA<br />	mov edi,eax<br />	invoke  SendMessage,edi,AEM_FINDFIRST,AEFIND_WHOLEWORDS,delight_text<br />	or      eax,eax<br />	jz     not_found<br />          .delight_found&#58;<br />	;every time it finds an invoke, it gets copied to a buffer and continues <br />	;<br />	;Under construction<br />	;<br />	invoke  SendMessage,edi,AEM_FINDNEXT,0,0<br />	or      eax,eax<br />	jz      not_found<br />	;<br />	;Then when it has all the invokes, it compares with the APIs<br />	;<br />	jmp     .finish<br />         .not_found&#58;<br />	invoke  MessageBox,&#91;hwnd&#93;,_notfound_delight,_title,MB_ICONINFORMATION+MB_OK<br />	jmp     .finish<br />  .close&#58;<br />	invoke	EndDialog,&#91;hwnddlg&#93;,0<br />  .processed&#58;<br />	mov	eax,1<br />  .finish&#58;<br />	pop	edi esi ebx<br />	return<br />.<br />.<br />.<br />resource IDR_DELIGHT_DIALOG,LANG_ENGLISH+SUBLANG_DEFAULT,delight_dialog,\<br />.<br />menuitem '&amp;Options',0,MFR_POPUP<br />	menuitem '&amp;Appearance...',IDM_APPEARANCE,MFR_END<br />	menuitem '&amp;Delight...',IDM_DELIGHT,MFR_END<br />.<br />dialog delight_dialog,5,'Delight',50,50,220,320,WS_CAPTION+WS_POPUP+WS_SYSMENU+DS_MODALFRAME<br />    dialogitem 'STATIC','Fasm includes path&#58;',-1,18,8,128,40,WS_VISIBLE+SS_CENTER<br />    dialogitem 'EDIT','',IDD_PATH,20,20,180,10,WS_VISIBLE+WS_BORDER+WS_TABSTOP+ES_NUMBER<br />    dialogitem 'EDIT','',IDD_EDIT,20,40,180,250,WS_VISIBLE+WS_BORDER+WS_HSCROLL+WS_VSCROLL<br />    dialogitem 'BUTTON','&amp;Copy',IDD_COPY,30,300,42,14,WS_VISIBLE+WS_TABSTOP+BS_DEFPUSHBUTTON<br />    dialogitem 'BUTTON','&amp;Delight',IDD_CANCEL,130,300,42,14,WS_VISIBLE+WS_TABSTOP+BS_PUSHBUTTON<br /></code></pre><br />Now, I think AEFIND_FINDNEXT in SendMessage returns a pointer to the text found. Can you check it in the SDK?<br />If that's so, then we copy the whole invoke line to a buffer, and then do the rest.<br />We'll have it :)</div>
    <div class="meta">Posted on 2002-10-02 09:21:51 by slop</div>
   </div>
   <div class="post" id="post-60508">
    <div class="subject"><a href="#post-60508">Here is a Fasm utility...</a></div>
    <div class="body">Hi Delight,<br />since asmedit.dll is already there, we can use the find features of it instead of the regular API.<br />But for the Bayer-More, we could try to use it also, to see how to implement it in fasm.<br /><pre><code><br />delight_text DB 'invoke'<br /> .delight&#58;<br />	mov esi,delight_text<br />	mov edi,search_text<br />	mov ecx,6<br />	cld<br />	repe movsb		;Do you think this could be optimised?<br />	invoke  SendMessage,&#91;MDI_client_hwnd&#93;,WM_MDIGETACTIVE,0,0<br />	or eax,eax<br />	jz finish<br />	invoke GetWindowLong,eax,GWL_USERDATA<br />	mov ebx,eax<br />	invoke  SendMessage,ebx,AEM_FINDFIRST,AEFIND_WHOLEWORDS, search_text<br />	invoke  SendMessage,ebx,AEM_GETWORDATCARET,100h,string_buffer<br />		;I'm not too sure about these<br />		;But depending in what they return the string after 'invoke' is copied to a buffer, then all invokes<br />		are copied, then the final compare with the APIs</code></pre><br />	invoke SendMessage,ebx,AEM_FINDNEXT,0,0<br />	;Here loops until EOF<br />	jmp	.finish<br /></code></pre><br /><br /><br />I wonder how this would be made with the Bayer-More? Do you have ideas?<br />If we use the Bayer-More, then we use it again to compare with the list of APIS.<br />And another good point: if we implement it nicely, then we can use it for other search extensive things.</div>
    <div class="meta">Posted on 2002-10-03 12:56:44 by slop</div>
   </div>
   <div class="post" id="post-60842">
    <div class="subject"><a href="#post-60842">Here is a Fasm utility...</a></div>
    <div class="body"><pre><code>delight_text DB 'invoke'<br /> .delight&#58;<br /><br />	invoke  SendMessage,&#91;MDI_client_hwnd&#93;,WM_MDIGETACTIVE,0,0<br />	or eax,eax<br />	jz finish<br />	invoke GetWindowLong,eax,GWL_USERDATA<br />	mov ebx,eax<br />	invoke  SendMessage,ebx,AEM_FINDFIRST,AEFIND_WHOLEWORDS, delight_text<br />	invoke  SendMessage,ebx,AEM_GETWORDATCARET,100h,string_buffer<br />			;Now the line following 'invoke' is in string_buffer<br />	invoke  ExtractTokens string_buffer, token_buffer <br />;<br />;A modified version of Delight's tokenizer<br />;<br /><br />proc ExtractTokens ,_buffer,TokenBuffer<br />	LastTokenWasInvoke rw 1<br />	enter<br />	push ebx esi edi<br />	mov	esi, _buffer<br />	mov 	edi, TokenBuffer<br /><br />   .tokenize&#58;<br />	lodsb<br />	cmp al,09h	;TAB<br />	jz .tokenize<br />	cmp al,' '		;Space<br />	jz .tokenize	<br />  .APIfound&#58;<br />	stosb<br />	lodsb<br />	cmp al,','		;colon<br />	jne .APIfound<br />			;Now it's all in the buffer<br />			;And anything can be done<br />			;Either comparing if it's already done &#40;if it appears in the final list&#41;<br />			;Or checking to what .dll belongs<br />			;Even the parameters could be checked here to see if they are all there<br />			;And I think the Boyer-More would be great for this<br />			;What do you think?<br />	<br /><br />	pop edi esi ebx<br />	return</code></pre></div>
    <div class="meta">Posted on 2002-10-07 12:54:20 by slop</div>
   </div>
   <div class="post" id="post-61883">
    <div class="subject"><a href="#post-61883">Here is a Fasm utility...</a></div>
    <div class="body">Hi,<br /><br />Here's where we are Delight and myself,<br /><br />If anybody wants to give it a look and see what's going on.<br /><br />AS4.ASM contains the main routine outside the DialogProc<br />AS1.ASM the stuff is inside DialogProc<br /><br />We are using buliaNaza's BM algo.<br />Sorry about the sloppiness.<br /><br /><pre><code>IncludePathANSI db &quot;C&#58;\FASM\INCLUDE\ANSI&quot;,0<br />IncludePathUNICODE db &quot;C&#58;\FASM\INCLUDE\UNICODE&quot;,0<br />Unicode db 0	;Unicode flag</code></pre><br />The above are the required directories and the flag to tue UNICODE or ANSI APIs<br /><br />The format for the new .API files is a slight modification of pelaillo's.<br />AN example follows:<pre><code>kernel,'KERNEL32.DLL',\<br /><br />AddAtom,'AddAtomA',\<br />	AddConsoleAlias,'AddConsoleAliasA',\<br />	AllocConsole,'AllocConsole',\<br />	AreFileApisANSI,'AreFileApisANSI',\<br />	AssignProcessToJobObject,'AssignProcessToJobObject',\<br />	BackupRead,'BackupRead',\<br />	BackupSeek,'BackupSeek',\<br />	BackupWrite,'BackupWrite',\<br />	BaseAttachCompleteThunk,'BaseAttachCompleteThunk',\<br />	Beep,'Beep',\<br />	BeginUpdateResource,'BeginUpdateResourceA',\<br />	BuildCommDCB,'BuildCommDCBA',\<br />	BuildCommDCBAndTimeouts,'BuildCommDCBAndTimeoutsA',\<br />	CallNamedPipe....<br />	...<br />	EOF</code></pre></div>
    <div class="meta">Posted on 2002-10-15 12:48:24 by slop</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=7790&amp;page=1" style="">&laquo;</a><a href="../?id=7790&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="7790" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>  </div>
 </body>
</html>