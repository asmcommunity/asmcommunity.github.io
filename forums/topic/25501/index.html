<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>VESA LFB problem in MS VirtualPC - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=25501" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=25501">VESA LFB problem in MS VirtualPC</a></p>
   <div class="post" id="post-186356">
    <div class="subject"><a href="#post-186356">VESA LFB problem in MS VirtualPC</a></div>
    <div class="body"><br />This program changing video mode 1024*768 LFB (with VESA)<br />And filling screen area.<br /><br />In nativ msdos6.22 work correct.<br />In DOSBOX emulator in xp work correct.<br />In MS VirtualPC in xp not work. Changing mode but filling first 64k and HALT.<br /><br />VPC starting booting dos6.22 - univbe vbetest program&nbsp; correct all bankink and linear frama buffer mode.<br /><br /><br /><br /><br /><br /><br /><br /><pre><code><br /><br /><br />	.386p<br /><br />	assume	cs:x_code<br />	assume	ds:x_data<br />	assume	ss:x_stack<br /><br />&nbsp; &nbsp; &nbsp; 	.model small, stdcall<br />&nbsp; &nbsp; &nbsp; 	option casemap :none<br /><br /><br /><br />x_data segment para public &#39;DATA&#39; use16<br /><br />x_data	ends<br /><br /><br /><br /><br /><br /><br /><br />&nbsp; &nbsp; &nbsp; &nbsp; GDI_SetVideoMode&nbsp; &nbsp; &nbsp; &nbsp; PROTO&nbsp;  :DWORD<br /><br /><br /><br />GDI_VESA_640x400&nbsp; &nbsp; &nbsp; &nbsp; equ 4100h ; 640x400x256<br />GDI_VESA_640x480&nbsp; &nbsp; &nbsp; &nbsp; equ 4101h ; 640x480x256<br />GDI_VESA_800x600&nbsp; &nbsp; &nbsp; &nbsp; equ 4103h ; 800x600x256<br />GDI_VESA_1024x768&nbsp; &nbsp; &nbsp;  equ 4105h ; 1024x768x256<br />GDI_VESA_1280x1024&nbsp; &nbsp; &nbsp; equ 4107h ; 1280x1024x256<br /><br />ModeInfoBlock&nbsp;  struc<br /><br />&nbsp; &nbsp;  ; Mandatory information for all VBE revisions<br />&nbsp; &nbsp;  ModeAttributes&nbsp; &nbsp; &nbsp; dw ?&nbsp; &nbsp; &nbsp; ; mode attributes<br />&nbsp; &nbsp;  WinAAttributes&nbsp; &nbsp; &nbsp; db ?&nbsp; &nbsp; &nbsp; ; window A attributes<br />&nbsp; &nbsp;  WinBAttributes&nbsp; &nbsp; &nbsp; db ?&nbsp; &nbsp; &nbsp; ; window B attributes<br />&nbsp; &nbsp;  WinGranularity&nbsp; &nbsp; &nbsp; dw ?&nbsp; &nbsp; &nbsp; ; window granularity<br />&nbsp; &nbsp;  WinSize&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  dw ?&nbsp; &nbsp; &nbsp; ; window size<br />&nbsp; &nbsp;  WinASegment&nbsp; &nbsp; &nbsp; &nbsp;  dw ?&nbsp; &nbsp; &nbsp; ; window A start segment<br />&nbsp; &nbsp;  WinBSegment&nbsp; &nbsp; &nbsp; &nbsp;  dw ?&nbsp; &nbsp; &nbsp; ; window B start segment<br />&nbsp; &nbsp;  WinFuncPtr&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dd ?&nbsp; &nbsp; &nbsp; ; pointer to window function<br />&nbsp; &nbsp;  BytesPerScanLine&nbsp; &nbsp; dw ?&nbsp; &nbsp; &nbsp; ; bytes per scan line<br /><br />&nbsp; &nbsp;  ; Mandatory information for VBE 1.2 and above<br />&nbsp; &nbsp;  XResolution&nbsp; &nbsp; &nbsp; &nbsp;  dw ?&nbsp; &nbsp; &nbsp; ; horizontal resolution in pixels or chars<br />&nbsp; &nbsp;  YResolution&nbsp; &nbsp; &nbsp; &nbsp;  dw ?&nbsp; &nbsp; &nbsp; ; vertical resolution in pixels or chars<br />&nbsp; &nbsp;  XCharSize&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  db ?&nbsp; &nbsp; &nbsp; ; character cell width in pixels<br />&nbsp; &nbsp;  YCharSize&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  db ?&nbsp; &nbsp; &nbsp; ; character cell height in pixels<br />&nbsp; &nbsp;  NumberOfPlanes&nbsp; &nbsp; &nbsp; db ?&nbsp; &nbsp; &nbsp; ; number of memory planes<br />&nbsp; &nbsp;  BitsPerPixel&nbsp; &nbsp; &nbsp; &nbsp; db ?&nbsp; &nbsp; &nbsp; ; bits per pixel<br />&nbsp; &nbsp;  NumberOfBanks&nbsp; &nbsp; &nbsp;  db ?&nbsp; &nbsp; &nbsp; ; number of banks<br />&nbsp; &nbsp;  MemoryModel&nbsp; &nbsp; &nbsp; &nbsp;  db ?&nbsp; &nbsp; &nbsp; ; memory model type<br />&nbsp; &nbsp;  BankSize&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db ?&nbsp; &nbsp; &nbsp; ; bank size in KB<br />&nbsp; &nbsp;  NumberOfImagePages&nbsp; db ?&nbsp; &nbsp; &nbsp; ; number of images<br />&nbsp; &nbsp;  Reserved1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  db ?&nbsp; &nbsp; &nbsp; ; reserved for page function<br /><br />&nbsp; &nbsp;  ; Direct Color fields (required for direct/6 and YUV/7 memory models)<br />&nbsp; &nbsp;  RedMaskSize&nbsp; &nbsp; &nbsp; &nbsp;  db ?&nbsp; &nbsp; &nbsp; ; size of direct color red mask in bits<br />&nbsp; &nbsp;  RedFieldPosition&nbsp; &nbsp; db ?&nbsp; &nbsp; &nbsp; ; bit position of lsb of red mask<br />&nbsp; &nbsp;  GreenMaskSize&nbsp; &nbsp; &nbsp;  db ?&nbsp; &nbsp; &nbsp; ; size of direct color green mask in bits<br />&nbsp; &nbsp;  GreenFieldPosition&nbsp; db ?&nbsp; &nbsp; &nbsp; ; bit position of lsb of green mask<br />&nbsp; &nbsp;  BlueMaskSize&nbsp; &nbsp; &nbsp; &nbsp; db ?&nbsp; &nbsp; &nbsp; ; size of direct color blue mask in bits<br />&nbsp; &nbsp;  BlueFieldPosition&nbsp;  db ?&nbsp; &nbsp; &nbsp; ; bit position of lsb of blue mask<br />&nbsp; &nbsp;  RsvdMaskSize&nbsp; &nbsp; &nbsp; &nbsp; db ?&nbsp; &nbsp; &nbsp; ; size of direct color reserved mask in bits<br />&nbsp; &nbsp;  RsvdFieldPosition&nbsp;  db ?&nbsp; &nbsp; &nbsp; ; bit position of lsb of reserved mask<br />&nbsp; &nbsp;  DirectColorModeInfo db ?&nbsp; &nbsp; &nbsp; ; direct color mode attributes<br /><br />&nbsp; &nbsp;  ; Mandatory information for VBE 2.0 and above<br />&nbsp; &nbsp;  PhysBasePtr&nbsp; &nbsp; &nbsp; &nbsp;  dd ?&nbsp; &nbsp; &nbsp; ; physical address for flat frame buffer<br />&nbsp; &nbsp;  OffScreenMemOffset&nbsp; dd ?&nbsp; &nbsp; &nbsp; ; pointer to start of off screen memory<br />&nbsp; &nbsp;  OffScreenMemSize&nbsp; &nbsp; dw ?&nbsp; &nbsp; &nbsp; ; amount of off screen memory in 1k units<br />&nbsp; &nbsp;  Reserved2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db 206 dup (?)&nbsp; ; remainder of ModeInfoBlock<br />ModeInfoBlock ends<br /><br /><br /><br /><br />x_data segment para public &#39;DATA&#39; use16<br />gdi_seg_id&nbsp; &nbsp; &nbsp; db&nbsp; &nbsp; &nbsp; &#39;GDI&#39;<br /><br />vesabuf&nbsp; &nbsp; &nbsp; &nbsp;  db&nbsp; &nbsp; &nbsp; 1024 dup (0)<br />vesasign&nbsp; &nbsp; &nbsp; &nbsp; db&nbsp; &nbsp; &nbsp; &#39;VESA&#39;<br />		db 1024 dup (0)<br /><br /><br /><br />x_data ends<br /><br />x_code segment para public &#39;CODE&#39; use16<br />GDI_ScreenAddr&nbsp; dd&nbsp; &nbsp; &nbsp; 0<br />&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; ds:x_data<br /><br />GDI_SetVideoMode&nbsp; &nbsp; &nbsp; &nbsp; proc&nbsp; &nbsp; mode:DWORD<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  es,cs:<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  eax,4f02h<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ebx,<br />&nbsp; &nbsp; &nbsp; &nbsp; int&nbsp; &nbsp;  10h<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ax,4f01h<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ecx,<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  edi,offset vesabuf<br />&nbsp; &nbsp; &nbsp; &nbsp; int&nbsp; &nbsp;  10h<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ebx,ModeInfoBlock.PhysBasePtr<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  edi,offset vesabuf<br />&nbsp; &nbsp; &nbsp; &nbsp; add&nbsp; &nbsp;  edi,ebx<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  eax,<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  cs:,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; ret<br /><br />GDI_SetVideoMode&nbsp; &nbsp; &nbsp; &nbsp; endp<br /><br /><br /><br />x_code ends<br /><br /><br />x_code segment para public &#39;CODE&#39; use16<br /><br />x_data_seg	dw	seg x_data<br />x_stack_seg	dw	seg x_stack<br />d_memory_seg&nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; seg memory<br />d_psp_seg	dw	0<br /><br /><br /><br />start:<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  cs:,ds<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  bx,cs:<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ax,ds<br />&nbsp; &nbsp; &nbsp; &nbsp; sub&nbsp; &nbsp;  bx,ax<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ax,4a00h<br />&nbsp; &nbsp; &nbsp; &nbsp; int&nbsp; &nbsp;  21h<br /><br />	mov	ds,cs:<br /><br />	mov	ax,cs:<br />	cli<br />	mov	ss,ax<br />	mov	sp,50000<br />	sti<br /><br />	invoke	GDI_SetVideoMode,GDI_VESA_1024x768<br /><br /><br />	xor	eax,eax<br />	mov	es,ax<br />toci:<br />	mov	ecx,1024*768/4<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ebx,cs:<br /><br />xx:<br /> 	mov	es:,eax<br /> 	add	ebx,4<br /> 	dec	ecx<br /> 	jnz	xx<br />	add	eax,010101010h<br />	jmp	toci<br /><br /><br />x_code ends<br /><br /><br /><br />x_stack	segment public &#39;STACK&#39; use16<br /><br />	dw	25000 dup (?)<br /><br />stack_pointer	label word<br /><br />x_stack	ends<br /><br /><br />memory&nbsp; segment para memory &#39;memmory&#39; use16<br />memory&nbsp; ends<br /><br /><br />	end	start<br />	end<br /><br /><br /></code></pre></div>
    <div class="meta">Posted on 2006-11-05 12:13:07 by korte</div>
   </div>
   <div class="post" id="post-186357">
    <div class="subject"><a href="#post-186357">Re: VESA LFB problem in MS VirtualPC</a></div>
    <div class="body"><pre><code><br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ecx,<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  edi,offset vesabuf<br />&nbsp; &nbsp; &nbsp; &nbsp; int&nbsp; &nbsp;  10h<br /></code></pre><br /><br /><br /><pre><code><br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  ecx,<br />&nbsp; &nbsp; &nbsp; &nbsp; and ecx,1ffh ; mask LFB bit<br />&nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp;  edi,offset vesabuf<br />&nbsp; &nbsp; &nbsp; &nbsp; int&nbsp; &nbsp;  10h<br /></code></pre></div>
    <div class="meta">Posted on 2006-11-05 13:43:10 by kisj</div>
   </div>
   <div class="post" id="post-186358">
    <div class="subject"><a href="#post-186358">Re: VESA LFB problem in MS VirtualPC</a></div>
    <div class="body">If I don&#39;t get wrong, you are trying to access LFB in Real Mode<br />That&#39;s not always posible, check the PhyMem address, for instance; in VMWare I have got a address 0xE0000000 !!!!<br />This is even out of bounds of memory but that&#39;s valid !<br /><br />If I were you, I will check the address</div>
    <div class="meta">Posted on 2006-11-05 14:18:15 by Dite</div>
   </div>
   <div class="post" id="post-186361">
    <div class="subject"><a href="#post-186361">Re: VESA LFB problem in MS VirtualPC</a></div>
    <div class="body">YEEEEES KISJ<br /><br /><pre><code>and ecx,1ffh ; mask LFB bit</code></pre><br /><br />work.<br /><br />thx.</div>
    <div class="meta">Posted on 2006-11-05 16:11:22 by korte</div>
   </div>
  </div>
 </body>
</html>