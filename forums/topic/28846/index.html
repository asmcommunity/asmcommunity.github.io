<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>NASM Macros - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=28846" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=28846">NASM Macros</a></p>
   <div class="post" id="post-203832">
    <div class="subject"><a href="#post-203832">NASM Macros</a></div>
    <div class="body">I am writing an INVOKE macro that accepts the calling convention to be used, as the last parameter. The last parameter is optional actually. So the macro will be like<br /><br /><pre><code>%MACRO INVOKE 1-*</code></pre><br /><br />I am defining these also<br /><br /><pre><code>%DEFINE __STDCALL__</code></pre><br /><br />And other calling convention. The problem is that I can not compare a macro parameter with a %DEFINEd when I am not actually assigning a value to it.<br /><br />For example, in this case, if I set:<br /><br /><pre><code>%DEFINE __STDCALL__ 0xFFFFFFFF</code></pre><br /><br />For all I know, the user could pass 0xFFFFFFFF as a parameter and not the calling-convention specifier. Am I making sense here? I just need, inside the macro, to do a simple:<br /><br /><pre><code>%IF %1 = __STDCALL__</code></pre><br /><br />And then the rest of the code without having to assign a value to __STDCALL__. Is this possible in NASM?</div>
    <div class="meta">Posted on 2007-12-08 08:20:07 by XCHG</div>
   </div>
   <div class="post" id="post-203834">
    <div class="subject"><a href="#post-203834">Re: NASM Macros</a></div>
    <div class="body">Is the parameter count fixed or variable? If it is fixed, you can check the number of parameters that the function being called is expecting, see if there are any beyond the expected number and process accordingly.<br /><br />There is a slight problem with a variable number of parameters, as with some CDECL calls, since you can never assume that last parameter can be that optional specifier.<br /><br />Overall, such ambiguity simply needs to be avoided. In a well defined API, each function already has an expected calling convention that should be adhered to.<br /><br />What is it that you are trying to achieve with this system? Perhaps there is another solution that can be utilized.</div>
    <div class="meta">Posted on 2007-12-08 12:23:03 by SpooK</div>
   </div>
   <div class="post" id="post-203835">
    <div class="subject"><a href="#post-203835">Re: NASM Macros</a></div>
    <div class="body">I just need to do this:<br /><br /><pre><code>%DEFINE __STDCALL__<br />%DEFINE __CDECL__<br />%MACRO INVOKE 1-*<br />&nbsp; %ROTATE -1<br />&nbsp; %IF %1 = __STDCALL__<br />&nbsp; %ELIF %1 = __CDECL__<br />&nbsp; %ELIF %1 = ...<br />&nbsp; %ENDIF<br />%ENDIF</code></pre><br /><br /><pre>&nbsp; &nbsp; :shock:<br />&nbsp;  /XX\<br />&nbsp; &nbsp; ||<br />&nbsp;  _||_</pre></div>
    <div class="meta">Posted on 2007-12-08 13:14:50 by XCHG</div>
   </div>
   <div class="post" id="post-203854">
    <div class="subject"><a href="#post-203854">Re: NASM Macros</a></div>
    <div class="body">If you don&#039;t ever expect the person to enter in numeric values (as I assume you don&#039;t from your last example), the following would be much easier to implement.<br /><br /><pre><code><br />%MACRO INVOKE 1-*<br />&nbsp; &nbsp; %ROTATE -1<br />&nbsp; &nbsp; %IFIDN %1, __STDCALL__<br />&nbsp; &nbsp; &nbsp; &nbsp; ; standard calling convention code<br />&nbsp; &nbsp; %ELIFIDN %1, __CDECL__<br />&nbsp; &nbsp; &nbsp; &nbsp; ; c calling convention code<br />&nbsp; &nbsp; %ELIFIDN %1, ...<br />&nbsp; &nbsp; &nbsp; &nbsp; ; ... you get the point ...<br />&nbsp; &nbsp; %ENDIF<br />%ENDMACRO<br /></code></pre><br /><br />Sorry for a late response, I&#039;ve been a bit busy lately with finals for this quarter.<br /><br />Regards,<br />Bryant Keller</div>
    <div class="meta">Posted on 2007-12-09 22:01:44 by Synfire</div>
   </div>
   <div class="post" id="post-203855">
    <div class="subject"><a href="#post-203855">Re: NASM Macros</a></div>
    <div class="body">Hey thanks for the code but I think I didn&#039;t get how it works because it doesn&#039;t work for me :(<br /><br /><pre><code>&nbsp; %DEFINE&nbsp; &nbsp;  __STDCALL__<br />&nbsp; ; -------------------------------------- <br />&nbsp; %MACRO DUMMY 1<br />&nbsp; &nbsp; %IFIDN %1 , __STDCALL__<br />&nbsp; &nbsp; &nbsp; WRITE&nbsp;  &#039;It worked&#039;<br />&nbsp; &nbsp; %ELSE<br />&nbsp; &nbsp; &nbsp; WRITE&nbsp;  &#039;It does not work&#039;<br />&nbsp; &nbsp; %ENDIF<br />&nbsp; %ENDM<br />&nbsp; ; --------------------------------------<br />&nbsp; DUMMY __STDCALL__</code></pre><br /><br />This always prints &quot;It does not work&quot;</div>
    <div class="meta">Posted on 2007-12-10 00:37:47 by XCHG</div>
   </div>
   <div class="post" id="post-203864">
    <div class="subject"><a href="#post-203864">Re: NASM Macros</a></div>
    <div class="body">No %DEFINE&#039;s required when using %IFIDN. Below is a self-building source (MAIN.BAT) I wrote up real quick as a demo/proof-of-concept for you. It&#039;s not really commented but you look like you got a decent grasp you&#039;re just barely missing it.<br /><br /><pre><code>;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br />; @ECHO OFF<br />;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br />; SET PROJECT=DEMO<br />;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br />; SET DRV=C<br />; SET BIN=\NASM32\BIN<br />; SET LIB=\NASM32\LIB\WIN32<br />;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br />; SET AS=NASM.EXE<br />; SET LD=POLINK.EXE<br />; SET ASFLAGS=-f win32<br />; SET LDFLAGS=/SUBSYSTEM:WINDOWS /ENTRY:MAIN<br />;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br />; SET LIBS=KERNEL32.LIB<br />;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br />; GOTO BUILD<br />;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br />; MAIN.BAT - INVK Demo/POC for XCHG<br />;<br />; Written by : Bryant Keller<br />; Assembler&nbsp; : Netwide Assembler v2.00<br />; Date&nbsp; &nbsp; &nbsp; &nbsp;: 10-Dec-2007<br />;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br /><br />;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br />%MACRO INVK 1-*<br />%PUSH _INVK_<br />	%DEFINE %$PROC %1<br />	%ROTATE -1<br />	%IFIDN %1, __STDCALL__<br />		; standard calling convention code<br />		%ERROR %$PROC Invoked With Standard Calling Convention<br />	%ELIFIDN %1, __CDECL__<br />		; c calling convention code<br />		%ERROR %$PROC Invoked With C Calling Convention<br />	%ELIFIDN %1, __FASTCALL__<br />		; fast calling convention code<br />		%ERROR %$PROC Invoked With Fast Calling Convention<br />	%ELSE<br />		; ... unknown ...<br />		%ERROR %$PROC Invoked With An Unknown Calling Convention<br />	%ENDIF<br />%POP<br />%ENDMACRO<br /><br /><br />GLOBAL MAIN<br />MAIN:<br />	%ERROR INVK macro with __STDCALL__<br />	INVK MyProc, 1, 2, 3, 4, __STDCALL__<br />	%ERROR INVK macro with __CDECL__<br />	INVK MyProc, 1, 2, 3, 4, __CDECL__<br />	%ERROR INVK macro with __FASTCALL__<br />	INVK MyProc, 1, 2, 3, 4, __FASTCALL__<br />	%ERROR INVK macro with an unknown/undefined convention<br />	INVK MyProc, 1, 2, 3, 4<br />	XOR eax, eax<br />	PUSH eax<br />	EXTERN _ExitProcess@4<br />	CALL _ExitProcess@4<br />;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br />; :BUILD<br />;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::<br />; IF EXIST MAIN.OBJ DEL MAIN.OBJ<br />; IF EXIST %PROJECT%.EXE DEL %PROJECT%.EXE<br />; IF NOT EXIST MAIN.BAT GOTO ERRAS<br />; %DRV%:%BIN%\%AS% %ASFLAGS% MAIN.BAT -o MAIN.OBJ<br />; IF ERRORLEVEL 1 GOTO ERRAS<br />; %DRV%:%BIN%\%LD% %LDFLAGS% /LIBPATH:&quot;%DRV%:%LIB%&quot; MAIN.OBJ %LIBS%<br />; IF ERRORLEVEL 1 GOTO ERRLD<br />; IF EXIST MAIN.OBJ DEL MAIN.OBJ<br />; IF EXIST MAIN.EXE REN MAIN.EXE %PROJECT%.EXE<br />; DIR /B /A-D<br />; GOTO DONE<br />; :ERRAS<br />; ECHO.<br />; ECHO Assembly Error<br />; GOTO DONE<br />; :ERRLD<br />; ECHO.<br />; ECHO Linker Error<br />; GOTO DONE<br />; :DONE<br />; ECHO.<br />; PAUSE<br />;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::</code></pre><br /><br />This is pretty much just preprocessor code, only thing it generates is &#039;xor eax, eax&#039;;&#039;push eax&#039;;&#039;call _ExitProcess@4&#039;. Which can be ignored along with the batch code for building. Just save the file as MAIN.BAT then run it and view the output, you will notice that for each INVK line, depending on what the final argument is it takes a different path in the macro (displaying a different error message to the screen at that point because of the %ERROR directives). If you want to learn more about this stuff, check the NASM Manual pages for %IFIDN/%IFIDNI and the negative versions %IFNIDN/%IFNIDNI. One of the most common uses I&#039;ve seen for it is to overload PUSH/POP/MOV/etc. opcodes so they can &quot;directly&quot; access the EIP/IP register (or appear to anyways). Making code like &#039;MOV , EIP&#039; possible by overloading MOV and using &quot;%IFIDNI %2, EIP&quot; then handling appropriately. Not really wise as it&#039;ll lead to confusion if someone later tries to port that code over to another assembler, but it can cut down on typing and does make EIP seem more like a GPR... But yea, basically those are just doing a direct comparison of the symbol you are passing rather than the symbol&#039;s value, so there is no need to use %DEFINE or %ASSIGN before hand.<br /><br />Regards,<br />Bryant Keller</div>
    <div class="meta">Posted on 2007-12-10 19:40:58 by Synfire</div>
   </div>
   <div class="post" id="post-203879">
    <div class="subject"><a href="#post-203879">Re: NASM Macros</a></div>
    <div class="body">Jesus Christ. <a target="_blank" href="http://&quot;http://www.asmcommunity.net/board/index.php?topic=28851.0&quot;">Read this post</a> Bryant. It took me like 3 days to find what the problem was. Thanks for all the help by the way. It is working now.</div>
    <div class="meta">Posted on 2007-12-13 08:24:30 by XCHG</div>
   </div>
   <div class="post" id="post-203882">
    <div class="subject"><a href="#post-203882">Re: NASM Macros</a></div>
    <div class="body">Heh, no worries mate. Every once in a while you&#039;ll come across small quirks in NASM like that. I didn&#039;t check to see if that was causing your error because I figured when you %define&#039;d the symbol with no value and tried to pass it to the macro it was being translated before it reached the %IFIDN so the condition was failing since %1 would no longer equal &#039;__STDCALL__&#039; rather &#039;&#039;. I&#039;m glad you were able to work it out.</div>
    <div class="meta">Posted on 2007-12-13 11:04:44 by Synfire</div>
   </div>
  </div>
 </body>
</html>