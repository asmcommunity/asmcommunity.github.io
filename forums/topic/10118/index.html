<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>PIC support - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=10118" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=47">Assemblers</a> &raquo; <a href="../?id=10118">PIC support</a></p>
   <div class="post" id="post-75745">
    <div class="subject"><a href="#post-75745">PIC support</a></div>
    <div class="body">This discussion was initiated by Privalov at the end of the thread titled 'porting win32 masm code to AIX platform' in <strong>Main</strong> board.<br /><br />I personally appreciate Privalov's interst in supporting my primary platform.  ;)  As a matter of fact, I once post my wish about PIC support with my idea in a thread about ELF format.  Anyhow, I'll repeat that in this post.<br /><br />1.  PIC support:  why?<br />Privalov's example at the end of the above thread works because it is an application.  That still works if we consider only static libraries.  When it comes to dynamic libraries, PIC support becomes an issue.  So, if FASM is going to support shared libraries, read on.<br /><br />Unlike Win32 DLLs, Unix shared libraries really move around in the memory.  Therefore, within a dynamic library, one cannot know where is the function he/she wants to call, where is the global variable exported to applications, where are the local variables for the function's own use.  ELF documentation explains how to do that.  Privalov seems to be familiar with it, but, for others, I'll describe how asm code can be written.<br /><br />Everything should start with getting the address of the global offset table (GOT).<br /><pre><code><br />	push	ebx<br />	call	L0<br />L0&#58;	pop	ebx<br />	add	ebx,$-L0+_GLOBAL_OFFSET_TABLE_<br /></code></pre><br /><strong>ebx</strong> is conventionally reserved for this purpose.  (And, of course, in MASM syntax, L0 and  _GLOBLA_OFFSET_TABLE_ should be 'offset' values.)<br /><br />To access an exported global variable (say, x), one should<br /><pre><code><br />	mov	eax,x@GOT&#91;ebx&#93;<br /></code></pre><br />(Forget about the special operator '@'.  This should be developed<br />in FASM syntax.  Just think of it as getting address relative to<br />the beginnign of GOT.)<br /><br />To access an local variable (say, y) in data section, one should<br /><pre><code><br />	mov	y@GOTOFF&#91;ebx&#93;,eax<br /></code></pre><br />The difference between local and global variables comes from where those variables are located in the memory.  Global variables are allocated in the process address space, and local variables are allocated in the library address space.<br /><br />To access an external function (say, strlen(3) in libc), one should access it through procedure linkage table (PLT).<br /><br /><pre><code><br />	lea	eax,mystring@GOTOFF&#91;ebx&#93;<br />	push	eax<br />	call	strlen@PLT<br /></code></pre><br /><br />If you are familiar with AT&amp;T syntax, you can always read the relevant system header file for better explanation.  For example, it is /usr/include/machine/asm.h in FreeBSD (NetBSD and OpenBSD, too).<br /><br />Now, GOT, GOTOFF, and PLT are given to programmers.  An assembler or a HLL compiler needs to support it internally.  Otherwise, it cannot produce shared objects which works correctly.  The best case will result in incorrect results, and usually, SIGSEGV.  (Yeah, before<br />I learned how to do it properly, I had generated numerous seg faults.)<br /><br />2.  PIC:  how?<br />I propose to support PIC in the way that 16-bit DOS assembly code uses segment override.  For example, obtaining the address of GOT can be written as<br /><pre><code><br />	push	ebx<br />	call	L0<br />L0&#58;	pop	ebx<br />	add	ebx,$-L0+_GLOBAL_OFFSET_TABLE_<br /></code></pre><br />Then, calling an external function could be<br /><pre><code><br />	call	PLT&#58;strlen<br /></code></pre><br />To access a global variable,<br /><pre><code><br />	mov	eax,GOT&#40;ebx&#41;&#58;&#91;glbl_var&#93;<br /></code></pre><br />Yes, it is a bit klunky, because GOT has an argument.  But, it does not have to be <strong>ebx</strong> which holds the address of _GLOBAL_OFFSET_TABLE_.  Likewise, to access local variables,<br /><pre><code><br />	mov	eax,GOTOFF&#40;ebx&#41;&#58;&#91;local1&#93;<br />	mov	GOTOFF&#40;ebx&#41;&#58;&#91;local2&#93;,eax<br /></code></pre><br />Or, the following may look better:<br /><pre><code><br />	mov	eax,GOT&#58;&#91;ebx+glbl_var&#93;<br />	lea	edx,GOTOFF&#58;&#91;ebx+local1&#93;<br /></code></pre><br /><br />I hope others have better ideas about the syntax.<br /><br />3.  Minor issue<br />One minor issue raised by Privalov:  brandelf.<br />I have not tested the latest FASM under FreeBSD.  But, Privalov, did you mean that FASM can be run under FreeBSD (which I know for sure, becasue I did try out FASM 1.4x a while ago)?  If you meant that, then it is a non-issue.  If you mean that I still need the COFF emulator of linux ld(1) in order to link FASM-created object files, then it is a serious issue.  That means, I cannot create a native binary using FASM.  That was the other reason (than PIC issue) why I did not continue to use when FASM first supported ELF.</div>
    <div class="meta">Posted on 2003-01-11 23:25:41 by Starless</div>
   </div>
   <div class="post" id="post-75779">
    <div class="subject"><a href="#post-75779">PIC support</a></div>
    <div class="body"><div class="quote"><br />If you mean that I still need the COFF emulator of linux ld(1) in order to link FASM-created object files, then it is a serious issue. That means, I cannot create a native binary using FASM. That was the other reason (than PIC issue) why I did not continue to use when FASM first supported ELF.<br /></div><br />No, fasm now support ELF objects and ld doesn't complain anything about them. This is the latest version (1.43) which introduced this feature - you can find<br /><br />Back to the PIC implementation: what about:<br /><pre><code><br />mov	eax,&#91;ebx+GOT x&#93;<br />mov	&#91;ebx+GOTOFF y&#93;,ebx<br />call	PLT strlen<br /></code></pre><br />Just analoguous in use to the RVA operator in PE format.</div>
    <div class="meta">Posted on 2003-01-12 03:40:27 by Tomasz Grysztar</div>
   </div>
   <div class="post" id="post-75791">
    <div class="subject"><a href="#post-75791">PIC support</a></div>
    <div class="body"><pre><code><br />call PLT extrn_fn<br /></code></pre><br />looks nice.  It reminds me of 'far'/'near' in old days.  On the other hand, <br /><pre><code><br />mov eax,&#91;ebx+GOT x&#93;<br /></code></pre><br />reminds me of horrible NASM syntax.  Just in case you don't know, NASM does it like<br /><pre><code><br />mov eax,&#91;ebx+x wrt ..got&#93;<br /></code></pre><br /><br />I don't know if making it like RVA operator will help making FASM consistent internally.  If it does, then you probably want to go for it.<br />On the other hand, that leaves me wondering how to create a convenience macro (like PIC_GOT() in FreeBSD).</div>
    <div class="meta">Posted on 2003-01-12 06:24:52 by Starless</div>
   </div>
  </div>
 </body>
</html>