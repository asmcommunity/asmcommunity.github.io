<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>The next step - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=29571" />
  <link rel="prev" href="../?id=29571&amp;page=1" />  <link rel="next" href="../?id=29571&amp;page=3" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=29571">The next step</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=29571&amp;page=1" style="">&laquo;</a><a href="../?id=29571&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="29571" /><input type="number" name="page" min="1" max="3" step="1" value="2" onchange="this.form.submit();" /><a href="../?id=29571&amp;page=3">&gt;</a><a href="../?id=29571&amp;page=3">&raquo;</a></form>   <div class="post" id="post-208997">
    <div class="subject"><a href="#post-208997">Re: The next step</a></div>
    <div class="body">my error mate, I used define instead of idefine so it wasn&#039;t recognizing the change in case:<br /><br /><pre><code>%imacro ASSUME 2<br />&nbsp; &nbsp; &nbsp; &nbsp; %ifidni %2, NOTHING<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %undef %{1}.<br />&nbsp; &nbsp; &nbsp; &nbsp; %else<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %idefine %{1}.(_x_) %{1} + %{2} %+ . %+ _x_<br />&nbsp; &nbsp; &nbsp; &nbsp; %endif<br />%endm</code></pre><br /><br />This should fix the problem.</div>
    <div class="meta">Posted on 2009-10-02 02:12:45 by Synfire</div>
   </div>
   <div class="post" id="post-209006">
    <div class="subject"><a href="#post-209006">Re: The next step</a></div>
    <div class="body">Had to change Macro to:<br /><pre><code>%imacro ASSUME 2<br />	%ifidni %2, NOTHING<br />		%undef %{1}.<br />		%else<br />		%idefine %{1}.(x) %{1} + %{2}. %+ x<br />	%endif<br />%endm</code></pre><br /><br />Haven&#039;t fully tested the macro yet but so far it works ok.<br /><br />Thank you very much for all your help and suggestion<br /><br />Klod</div>
    <div class="meta">Posted on 2009-10-02 22:42:15 by Klod</div>
   </div>
   <div class="post" id="post-209012">
    <div class="subject"><a href="#post-209012">Re: The next step</a></div>
    <div class="body">To Synfire<br />I have spent a couple of hours playing around with the Assume macro and it is not working correctly.<br />The alteration I made to the macro in my previous post, worked only because I had an argument&nbsp; x. All successive invocations produced a valid result, the value of the .x&nbsp; argument. <br /><pre><code>mov&nbsp; &nbsp;  WORD , AX</code></pre><br />will throw the following error:<br /><pre><code>symbol `DOUBLEWORD._x_&#039; undefined</code></pre><br /><br />The preprocessor will define the following symbol:<br /><span class="mono">highlow + DOUBLEWORD._x_</span><br /><br />It appears theat the %idefine&nbsp; %{1}.(_x_)&nbsp; %{1} + %{2}. %+ _x_ treats the placeholder (_x_) as a string and not as a variable.<br /><br />Would you have any suggestions how this could be worked out?<br /><br />Regards<br />Klod<br /><br /><br /></div>
    <div class="meta">Posted on 2009-10-04 00:20:42 by Klod</div>
   </div>
   <div class="post" id="post-209014">
    <div class="subject"><a href="#post-209014">Re: The next step</a></div>
    <div class="body">Use the one I posted above. The original one I posted has a few errors because I just typed it out from memory, the last one I posted was actually from my macro.inc file. You&#039;ll notice a few differences, it does work, see below:<br /><br /><pre><code>	BITS 32<br /><br />%imacro ASSUME 2<br />&nbsp; &nbsp; &nbsp; &nbsp; %ifidni %2, NOTHING<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %undef %{1}.<br />&nbsp; &nbsp; &nbsp; &nbsp; %else<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %idefine %{1}.(_x_) %{1} + %{2} %+ . %+ _x_<br />&nbsp; &nbsp; &nbsp; &nbsp; %endif<br />%endm<br /><br />STRUC HighLow<br />.High	RESW 1<br />.Low	RESW 1<br />ENDSTRUC<br /><br />SECTION .data<br /><br />ddBlah	DD	123456789<br />strFmt	DB	`High Word: %d\nLow Word: %d\n`, 0<br /><br />SECTION .text<br /><br />Global	main<br />main:	Push Ebp<br />	Mov Ebp, Esp<br />	<br />		Xor Eax, Eax<br />		Xor Ebx, Ebx<br /><br />		ASSUME ddBlah, HighLow<br />		Mov Ax, <br />		Mov Bx, <br />		ASSUME ddBlah, NOTHING<br />	<br />		Push Eax<br />		Push Ebx<br />		Push DWORD strFmt<br />		Extern printf<br />		Call printf<br />		Add Esp, (3*4)<br />	Leave<br />	Ret<br /></code></pre><br /><br />built with &#039;nasm -f elf test.asm; gcc -o test test.o&#039; on linux.</div>
    <div class="meta">Posted on 2009-10-04 02:33:48 by Synfire</div>
   </div>
   <div class="post" id="post-209015">
    <div class="subject"><a href="#post-209015">Re: The next step</a></div>
    <div class="body">Thanks Synfire for your code example I could not get it to work as you posted it above. I was digging through the docs and found <br />4.1.3 Concatenating Single Line Macro Tokens: %+<br />I think this must have been your inspiration for your assume macro. I do not have linux installed on my machine, so I modified your program to produce a working program that works. Here is the code:<br /><pre><code>%define ddBlah(x)&nbsp; ddBlah+HighLow %+x<br />EXTERN wsprintfA<br />EXTERN ExitProcess<br />EXTERN MsgBox<br /><br />STRUC HighLow<br />.High	RESW 1<br />.Low	RESW 1<br />ENDSTRUC<br /><br />SECTION .data<br /><br />ddBlah	DD	123456789<br />strFmt	DB	`High Word: %d\nLow Word: %d\n`, 0<br />buffer	 TIMES 1024 db 0<br />caption db &#039;Testing&#039;,0<br />SECTION .text<br /><br />Global	Start<br />Start:	<br />		movzx eax,WORD	;access the structure with Nasm notation<br />		movzx ebx,WORD		; to prove out the program<br />		Mov Ax, ddBlah(Low)				;assembled -e option Mov Ax, ddBlah+HighLowLow <br />		Mov Bx, ddBlah(.High)			;assembled -e option Mov Bx, ddBlah+HighLow.High This is what I wanted<br />		<br />		Push Eax<br />		Push Ebx<br />		Push DWORD strFmt<br />		push dword buffer<br />		Call wsprintfA<br />		push caption<br />		push buffer<br />		call MsgBox<br />		push 0<br />		call ExitProcess<br />		<br />;Radasm IDE 3,O,$B\NASM -Ox -fwin32 ,2<br />;$.exe,O,$B\GoLink.EXE @$B\GFL.txt /debug coff /entry Start ,3</code></pre><br /><br />These are the two errors I get for above code sample<br />MacroTest.asm:24: error: symbol `HighLowLow&#039; undefined&nbsp; &nbsp; &nbsp; &nbsp; ;self explanatory <br />MacroTest.asm:25: error: COFF format does not support non-32-bit relocations&nbsp; ;see below<br /><br />As can be seen from the -e assembly Mov Bx, ddBlah(.High) assembled to&nbsp; Mov Bx, ddBlah+HighLow.High, what I wanted but I get MacroTest.asm:25: error: COFF format does not support non-32-bit relocations<br /><br />It appears there is an incompatibility between the docs and Windows version of NAsm. because clearly the above example should work.<br /><br />Klod<br /> <br /></div>
    <div class="meta">Posted on 2009-10-04 23:05:39 by Klod</div>
   </div>
   <div class="post" id="post-209016">
    <div class="subject"><a href="#post-209016">Re: The next step</a></div>
    <div class="body"><div class="quote"><br />As can be seen from the -e assembly Mov Bx, ddBlah(.High) assembled to &nbsp;Mov Bx, ddBlah+HighLow.High, what I wanted but I get MacroTest.asm:25: error: COFF format does not support non-32-bit relocations<br /></div><br /><br />It is indeed working, but the operation is being treated as a non-32-bit relocation, something which COFF doesn&#039;t like.<br /><br />Off-hand, I would have to say that it is because &quot;Mov Bx, ddBlah(.High)&quot; assembles to &quot;Mov Bx, ddBlah+HighLow.High&quot;, where ddBlah is an offset/address to a variable in the data section and HighLow.High ends up being an offset/address to an absolute (different) section... perhaps making an impossibly complex relocation.<br /><br />Are you sure you weren&#039;t intending to use <strong>%define ddBlah(x) &nbsp;</strong>?</div>
    <div class="meta">Posted on 2009-10-05 01:43:22 by SpooK</div>
   </div>
   <div class="post" id="post-209021">
    <div class="subject"><a href="#post-209021">Re: The next step</a></div>
    <div class="body"><div class="quote"><br />Off-hand, I would have to say that it is because &quot;Mov Bx, ddBlah(.High)&quot; assembles to &quot;Mov Bx, ddBlah+HighLow.High&quot;, where ddBlah is an offset/address to a variable in the data section and HighLow.High ends up being an offset/address to an absolute (different) section... perhaps making an impossibly complex relocation.<br /></div><br /><br />Over-thought that one last night... it is as simple as the fact that &quot;Mov Bx, ddBlah...&quot; is causing NASM to generate a 16-bit (2 byte) relocation entry.<br /><br />The resultant solution still stands as correct, though.</div>
    <div class="meta">Posted on 2009-10-05 09:31:44 by SpooK</div>
   </div>
   <div class="post" id="post-209029">
    <div class="subject"><a href="#post-209029">Re: The next step</a></div>
    <div class="body">Hi SooK<br />You were right in your assumption As soon as I read your first post it clicked. I cahnge the code to the example posted and it works. I wanted to leave the &#91;] out of the macro so I could <br />Mov Ax, word<br />Mov edx, ddBlah(.High)			;get the address<br />Here is my working example:<br /><div class="quote">EXTERN wsprintfA<br />EXTERN ExitProcess<br />EXTERN MsgBox<br /><br />STRUC HighLow<br />.High	RESW 1<br />.Low	RESW 1<br />ENDSTRUC<br /><br />SECTION .data<br /><br />ddBlah	DD	123456789<br />strFmt	DB	`High Word: %d\nLow Word: %d\nADDRESS ddBlah DWord: %d\n`, 0<br />buffer	 TIMES 1024 db 0<br />caption db &#039;Testing&#039;,0<br />SECTION .text<br /><br />Global	Start<br />Start:	<br />xor eax,eax<br />xor ebx,ebx<br />	%define ddBlah(x)&nbsp; ddBlah+HighLow %+x<br />		Mov Ax, word		<br />		Mov Bx, word		;This is what I wanted<br />		Mov edx, ddBlah(.High)			;get the address<br />	%undef ddBlah<br />		push edx<br />		Push Eax<br />		Push Ebx<br />		Push DWORD strFmt<br />		push dword buffer<br />		Call wsprintfA<br />		push caption<br />		push buffer<br />		call MsgBox<br />		push 0<br />		call ExitProcess<br />		<br />;Radasm IDE 3,O,$B\NASM -Ox -fwin32 ,2<br />;5,O,$B\GOLINK @$B\GFL.txt /entry Start ,3,4<br /></div><br />This compiles and runs, producing the right out put.<br /><br />This proves that Nasm works as expected. <br />In Regards to Synfires assume macro I cannot make it work If I substitute the learned lesson from the previous example then the following works:<br /><div class="quote"><br />%imacro ASSUME 2<br />&nbsp; &nbsp; &nbsp; &nbsp; %ifidni %2, NOTHING<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %undef %{1}.<br />&nbsp; &nbsp; &nbsp; &nbsp; %else<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %define ddBlah(x)&nbsp; ddBlah+HighLow %+x&nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; %endif<br />%endm<br /><br />		ASSUME ddBlah, HighLow<br />		Mov Ax,word <br />		Mov Bx,word <br />		ASSUME ddBlah, NOTHING<br /></div><br /><br />In this example all works as before. The problem starts if I replace <br />%define ddBlah(x)&nbsp; ddBlah+HighLow %+x&nbsp;  ;this works<br />%idefine %{1}.(x) %{1} + %{2}. %+ x&nbsp; &nbsp; ;error: parser: expecting ]<br /><br />This is what I have tried to solve in the first place. Regardless on how I arrange the parameters it will not work I think its in the combining of more than two symbols that (x) gets appended as a &quot;string&quot; instead as a parameter.<br /><br />All suggestions are welcome<br />Klod<br /><br /><br /><br /></div>
    <div class="meta">Posted on 2009-10-07 00:43:38 by Klod</div>
   </div>
   <div class="post" id="post-209032">
    <div class="subject"><a href="#post-209032">Re: The next step</a></div>
    <div class="body">You aren&#039;t seeing what I was saying in the first place. you can&#039;t use:<br /><pre><code>%idefine %{1}.(x) %{1} + %{2}. %+ x</code></pre><br /><br />because nasm doesn&#039;t catenate it properly. That&#039;s the typo I was talking about. Look closely at my example above:<br /><br /><pre><code>%idefine %{1}.(x) %{1} + %{2} %+ . %+ x</code></pre><br /><br />there is an extra %+ operation to push the calculation of the structure offset onto the second pass whereas the first version addresses %{2}. on the first pass then incorrectly attempts to fixup the resulting x. Basically we need to add the extra %+ to &quot;confuse&quot; NASM so it doesn&#039;t know what to do with it on the first pass and waits until it makes it&#039;s second pass through the source to attempt to generate the symbol we need. Also, I don&#039;t really find the -e option very useful in situations like this as we aren&#039;t wanting to see what the preprocessor generates, rather what the final pass is generating (hint hint to any dev team members out there for a possible new feature :p).</div>
    <div class="meta">Posted on 2009-10-07 07:46:47 by Synfire</div>
   </div>
   <div class="post" id="post-209036">
    <div class="subject"><a href="#post-209036">Re: The next step</a></div>
    <div class="body">Hi Synfire<br />Thanks for replying. Still negative, I had tried that before already<br />%idefine %{1}.(x) %{1} + %{2} %+ . %+ x,&nbsp; This produces error parser: expecting ]<br /><br />The ] error seems to suport your explanationtough<br />Klod<br /><br /><br /></div>
    <div class="meta">Posted on 2009-10-07 09:57:48 by Klod</div>
   </div>
   <div class="post" id="post-209037">
    <div class="subject"><a href="#post-209037">Re: The next step</a></div>
    <div class="body">I&#039;ll get on a win-box this afternoon and work it out then. It&#039;s working here, I&#039;m not sure whats wrong. </div>
    <div class="meta">Posted on 2009-10-07 10:39:15 by Synfire</div>
   </div>
   <div class="post" id="post-209042">
    <div class="subject"><a href="#post-209042">Re: The next step</a></div>
    <div class="body">Okay, I&#039;ve jumped onto this winbox and took my previous example and changed it slightly for Windows usage:<br /><br /><pre><code>	BITS 32<br /><br />%imacro ASSUME 2<br />&nbsp; &nbsp; &nbsp; &nbsp; %ifidni %2, NOTHING<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %undef %{1}.<br />&nbsp; &nbsp; &nbsp; &nbsp; %else<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %idefine %{1}.(_x_) %{1} + %{2} %+ . %+ _x_<br />&nbsp; &nbsp; &nbsp; &nbsp; %endif<br />%endm<br /><br />STRUC HighLow<br />.High	RESW 1<br />.Low	RESW 1<br />ENDSTRUC<br /><br />SECTION .data<br /><br />ddBlah	DD	123456789<br />strFmt	DB	`High Word: %d\nLow Word: %d\nAddress of High Word: 0x%08X\nAddress of Low Word: 0x%08X`, 0<br />strBuf	TIMES 1025 DB 0<br /><br />SECTION .text<br /><br />Global	start<br />start:	<br />	Xor Eax, Eax<br />	Xor Ebx, Ebx<br /><br />	ASSUME ddBlah, HighLow<br />		Mov Ax, <br />		Mov Bx, <br />		Lea Edx, <br />		Lea Ecx, <br />	ASSUME ddBlah, NOTHING<br /><br />	Push Edx<br />	Push Ecx<br />	Push Eax<br />	Push Ebx<br />	Push DWORD strFmt<br />	Push DWORD strBuf<br />	Extern wsprintfA<br />	Call wsprintfA<br />	Add Esp, (3*4)<br /><br />	Push DWORD 0<br />	Push DWORD 0<br />	Push DWORD strBuf<br />	Push DWORD 0<br />	Extern _MessageBoxA@16<br />	Call _MessageBoxA@16<br /><br />	Push DWORD 0<br />	Extern _ExitProcess@4<br />	Call _ExitProcess@4</code></pre><br /><br />However, the assume macro itself is unchanged as you can see above. This code worked fine. Built using &#039;nasm -f win32 test.asm&#039; and linked with &#039;golink test.obj kernel32.dll user32.dll&#039;. Looking closer at your code, the problem is in how you are trying to address the high-word of ddBlah. You need to use Lea like above.</div>
    <div class="meta">Posted on 2009-10-07 15:01:51 by Synfire</div>
   </div>
   <div class="post" id="post-209046">
    <div class="subject"><a href="#post-209046">Re: The next step</a></div>
    <div class="body">%imacro ASSUME 2<br />&nbsp; &nbsp; &nbsp; &nbsp; %ifidni %2, NOTHING<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %undef %{1}.<br />&nbsp; &nbsp; &nbsp; &nbsp; %else<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %idefine %{1}.(_x_) %{1} + %{2} %+ . %+ _x_<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %warning %{1}.(_x_)<br />&nbsp; &nbsp; &nbsp; &nbsp; %endif<br />%endm<br /><br />Test.asm:32: (ASSUME:7) %warning: ddBlah + HighLow._x_<br />Test.asm:33: error: symbol `HighLow._x_&#039; undefined<br />Test.asm:34: error: symbol `HighLow._x_&#039; undefined<br />Test.asm:35: error: symbol `HighLow._x_&#039; undefined<br />Test.asm:36: error: symbol `HighLow._x_&#039; undefined<br /><br />These are the errors I started out with.<br />You mentioned a better -e as being a poor debug tool but I do not know of a better one, except warnings<br />I have attached a zip file of your program with make file.You can try it on your xbox.<br /><br />I thought I may have a problem with my machine. I have tried the program on two other machines, 1 XP pro and one XP home and the errors are the same.<br /><br />Being stumped<br /><br />Klod</div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=2882" target="_blank">AssumeMacroTest.zip</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2009-10-07 23:11:33 by Klod</div>
   </div>
   <div class="post" id="post-209073">
    <div class="subject"><a href="#post-209073">Re: The next step</a></div>
    <div class="body">Sorry it&#039;s taken a while but I don&#039;t regularly have access to the Windows operating system. Running your Make.bat file I immediately noticed two problems; you used &#039;Start&#039; instead of &#039;start&#039; and you have defined test.obj twice in your Make.bat file&#039;s Linking option. This makes two instances of each symbol causing a failure to build. Also, I didn&#039;t say to use %warn as a debugging method over -e, I was just saying that -e doesn&#039;t really work in a manner in which would be most useful in diagnosing macros. Attached below is a repaired version of your attachment. I&#039;ve built and ran it without errors.</div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=2886" target="_blank">AssumeMacroTest.zip</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2009-10-10 00:05:41 by Synfire</div>
   </div>
   <div class="post" id="post-209076">
    <div class="subject"><a href="#post-209076">Re: The next step</a></div>
    <div class="body">Okay, okay, okay, I&#039;ll join your club... hadda do it to get the .zip file(s). :)<br /><br />Hi SpooK, Hi Synfire, Hi Klod,<br /><br />I know I said (elsewhere) that I was going to give this thread a rest, but... just a couple observations...<br /><br />In Klod&#039;s version of the file, if I replace &quot;%warning %{1}.(_x_)&quot; (which shows &quot;_x_&quot;) with &quot;%warning %{1}.(Low)&quot;, I get the &quot;intended&quot; warning. Either way, the actual expansion of the macro seems to work (as shown by the &quot;-e&quot; switch... and by not getting any &quot;undefined&quot; errors).<br /><br />However, if I replace &quot;%idefine&quot; (in the meat of Synfire&#039;s macro) with &quot;%ixdefine&quot;, I get &quot;symbol &#039;HighLow._x_&#039; undefined&quot; (4 times) - just like Klod is describing! So my advice (elsewhere) that &quot;%xdefine&quot; might help is 180 degrees wrong!<br /><br />(all results under Linux, but assembling to &quot;-f win32&quot;)<br /><br />I don&#039;t know if any of that will help anybody figure out what&#039;s going wrong...<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2009-10-10 02:09:48 by fbkotler</div>
   </div>
   <div class="post" id="post-209079">
    <div class="subject"><a href="#post-209079">Re: The next step</a></div>
    <div class="body">Hi Frank,<br /><br />First, welcome to the board. :)<br /><br />Klods version assembled fine for me with the exception of duplicate errors which could be fixed by removing the &#039;test.obj&#039; from the end of his golink definition. However I did receive a few linking errors regarding &#039;Start&#039; as golink expects to see &#039;start&#039; as the entry point unless explicitly defined on the command line. What I was commenting on the &#039;-e&#039; option is that, when checking the output it would be nice to be able to choose what pass gets dumped to the output. When I was testing this and tried the &#039;-e&#039; option it would display the macro itself instead of what the macro was translating into.<br /><br /><pre><code>Mov Ax, </code></pre><br /><br />instead of<br /><br /><pre><code>Mov Ax, </code></pre><br /><br />Which is what I was really trying to see, what it was translating into.<br /><br />As far as I can tell, the attachment I posted has built and ran on Windows XP SP3, Windows 2000 Professional SP2 and it built (wouldn&#039;t link) under GNU/Linux. I tried to link it using golink and wine on Gnu/Linux but apparently golink doesn&#039;t like Wine&#039;s DLLs :)<br /></div>
    <div class="meta">Posted on 2009-10-10 04:18:12 by Synfire</div>
   </div>
   <div class="post" id="post-209084">
    <div class="subject"><a href="#post-209084">Re: The next step</a></div>
    <div class="body">First, thanks for having me!<br /><br />I agree that it might be nice to have the &quot;-e&quot; switch dump the last (or next to last) pass instead of the first one. Forward references might come out better (Nasm really doesn&#039;t do forward references at all in &quot;-e&quot; mode...).<br /><br />But I don&#039;t see what you mean about seeing &quot;the macro itself&quot;. What I see is only the expansion of the macro... plus a bunch of &quot;%line&quot; macros (I don&#039;t know anything about &#039;em)... &quot;nasm -f win32 test.asm -e &gt; test.pre&quot;<br /><br />;; first we expand &quot;bits 32&quot; to its &quot;raw&quot; form (does nothing in &quot;-f win32&quot;)<br />%line 1+1 test.asm<br /><br /><br />%line 13+1 test.asm<br /><br />;; expansion of the &quot;struc&quot; macro<br /><br />%line 14+0 test.asm<br />HighLow:<br />%line 15+1 test.asm<br />.High RESW 1<br />.Low RESW 1<br />HighLow_size equ ($-HighLow)<br />%line 17+0 test.asm<br /><br />;; expansion of &quot;section .text&quot;<br /><br />%line 18+1 test.asm<br /><br />;; expansion of &quot;section .data&quot;<br /><br /><br />ddBlah DD 123456789<br />strFmt DB `High Word: %d\nLow Word: %d\nAddress of High Word: 0x%08X\nAddress of Low Word: 0x%08X`, 0<br />strBuf TIMES 1025 DB 0<br /><br /><br /><br /><br />Start:<br /> Xor Eax, Eax<br /> Xor Ebx, Ebx<br /><br />;; the ASSUME macro doesn&#039;t show<br />;; but here&#039;s the expansion of its contents<br /> Mov Ax, <br /> Mov Bx, <br /> Lea Edx, <br /> Lea Ecx, <br />;; the &quot;ASSUME nothing&quot; macro is gone, too<br />;; this is the section that isn&#039;t working for Klod!<br /><br />;; note &quot;mov ecx ddBlah + HighLow.High&quot; works too,<br />;; but &quot;lea&quot; is &quot;safer&quot; in that it&#039;ll handle &quot;ddBlah&quot; being on the stack<br /><br /> Push Edx<br /> Push Ecx<br /> Push Eax<br /> Push Ebx<br /> Push DWORD strFmt<br /> Push DWORD strBuf<br /><br />;; &quot;extern&quot;s a macro, too...<br /><br /> Call wsprintfA<br /> Add Esp, (3*4)<br /><br /> Push DWORD 0<br /> Push DWORD 0<br /> Push DWORD strBuf<br /> Push DWORD 0<br /><br /> Call _MessageBoxA@16<br /><br /> Push DWORD 0<br /><br /> Call _ExitProcess@4<br /><br />Pretty much what I&#039;d expect. I don&#039;t know why it isn&#039;t working for Klod. I suggested, in another forum, that different compilers sometimes produce slightly different code, but that&#039;s far-fetched (I hope). Maybe eight hours sleep and a bowl of Wheaties will fix it. :)<br /><br />Best,<br />Frank<br /><br /></div>
    <div class="meta">Posted on 2009-10-10 07:48:13 by fbkotler</div>
   </div>
   <div class="post" id="post-209086">
    <div class="subject"><a href="#post-209086">Re: The next step</a></div>
    <div class="body">hrm, okay this must have been an old issue... the remark came from a test build I did on windows, here is a copy of the results file:<br /><br /><pre><code>%line 1+1 Test.Asm<br /><br /><br />%line 10+1 Test.Asm<br /><br /><br />%line 11+0 Test.Asm<br />HighLow:<br />%line 12+1 Test.Asm<br />.High RESW 1<br />.Low RESW 1<br />HighLow_size:<br />%line 14+0 Test.Asm<br /><br />%line 15+1 Test.Asm<br /><br /><br /><br />ddBlah DD 123456789<br />strFmt DB `High Word: %d\nLow Word: %d\nAddress of High Word: 0x%08X\nAddress of Low Word: 0x%08X`, 0<br />strBuf TIMES 1025 DB 0<br /><br /><br /><br /><br />start:<br /> Xor Eax, Eax<br /> Xor Ebx, Ebx<br /><br /><br /> Mov Ax, <br /> Mov Bx, <br /> Lea Edx, <br /> Lea Ecx, <br /><br /><br /> Push Edx<br /> Push Ecx<br /> Push Eax<br /> Push Ebx<br /> Push DWORD strFmt<br /> Push DWORD strBuf<br /><br /> Call wsprintfA<br /> Add Esp, (3*4)<br /><br /> Push DWORD 0<br /> Push DWORD 0<br /> Push DWORD strBuf<br /> Push DWORD 0<br /><br /> Call _MessageBoxA@16<br /><br /> Push DWORD 0<br /><br /> Call _ExitProcess@4</code></pre><br /><br />however, I know I hadn&#039;t used that computer in a while and pending your recent post I updated my copy and received the same output you got. In the older version it would expand the original macro but not the nested single-line macros (as seen above). I like it much better the way it is now. As for anything else I can continue using the -l option. :) </div>
    <div class="meta">Posted on 2009-10-10 08:31:02 by Synfire</div>
   </div>
   <div class="post" id="post-209094">
    <div class="subject"><a href="#post-209094">Re: The next step</a></div>
    <div class="body">Hi Synfire, Hi Frank<br />With interest have I followed your postings. I was assuming that the the out put from the -e option would be from the last pass and not from any other. So I was convinced the whole time the problem was a preprocessor one.<br />I have to admit that I got a bit sloppy with my make file. I use Radasm and do not usually use make files. <br /><pre><code>you used &#039;Start&#039; instead of &#039;start&#039; and you have defined test.obj twice in your Make.bat</code></pre><br />I also never used Global start but used /entry Start on the command line for golink.<br />I run the corrected version of the test program and it works as intended. I copied it to my usb stick (I have a copy of nasm and radasm on it, and tried it on my home computer and it fails with the same error codes as I had before. The version of Nasm on my usb stick was nasm-2.06rc10 which I had installed via installer. the version on my Laptop is nasm-2.07 which I manually installed from zip File. I changed the files on my usb stick to nasm-2.07 and it works like a charm.<br /><br />Sanity has once again returned to me even if its for a short while<br /><br />Thanks for all your help<br />Klod<br /></div>
    <div class="meta">Posted on 2009-10-10 20:56:53 by Klod</div>
   </div>
   <div class="post" id="post-209110">
    <div class="subject"><a href="#post-209110">Re: The next step</a></div>
    <div class="body"><div class="quote"><br />Okay, okay, okay, I&#039;ll join your club... hadda do it to get the .zip file(s). :)<br /><br />Hi SpooK, Hi Synfire, Hi Klod,<br /><br />I know I said (elsewhere) that I was going to give this thread a rest, but... just a couple observations...<br /><br /><br />Best,<br />Frank<br /><br /></div><br /><br />Welcome to the board.<br />Thanks for all the help you have given me in the past.<br /><br />Andy</div>
    <div class="meta">Posted on 2009-10-11 08:07:28 by skywalker</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=29571&amp;page=1" style="">&laquo;</a><a href="../?id=29571&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="29571" /><input type="number" name="page" min="1" max="3" step="1" value="2" onchange="this.form.submit();" /><a href="../?id=29571&amp;page=3">&gt;</a><a href="../?id=29571&amp;page=3">&raquo;</a></form>  </div>
 </body>
</html>