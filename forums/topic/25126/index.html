<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>DLL calling converntiosn - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=25126" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=25126">DLL calling converntiosn</a></p>
   <div class="post" id="post-184004">
    <div class="subject"><a href="#post-184004">DLL calling converntiosn</a></div>
    <div class="body">Hi,<br /><br />warning - a newbie question - <br /><br />I am coding an asm winlogon notification package as per&nbsp; (url wrapped)<br />http://msdn.microsoft.com/library/default.asp?url=/library/en-us/<br />secauthn/security/creating_a_winlogon_notification_package.asp<br /><br />All the examples are in C++/C# etc..&nbsp; I started coding using MASM<br />since I do not know C and know (at least something about MASM). I<br />have 3 questions re the following:<br /><br />There seems to be a requirement for a &quot;LibMain&quot; funtion for a DLL<br />to work ok.&nbsp; I copied the code below from a small assembler DLL that<br />works fine - and the code is straight forward -no problems understanding<br />what it does:<br /><br />push 0<br />pop eax<br />LibMain PROC h:DWORD,r:DWORD,u:DWORD<br />mov eax,1<br />ret<br />LibMain ENDP<br /><br />Question # 1 - Windows must require this - anyone know why ?<br /><br />The C structure I am being passed looks like this:<br /><br />void Event_Handler_Function_Name(<br />&nbsp; PWLX_NOTIFICATION_INFO pInfo<br />);<br /><br />typedef struct _WLX_NOTIFICATION_INFO {<br />&nbsp; ULONG Size;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ulong =&nbsp; &nbsp; &nbsp; 4 bytes<br />&nbsp; ULONG Flags;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  same <br />&nbsp; PWSTR UserName;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pwstr&nbsp; =&nbsp; &nbsp; 4 bytes&nbsp;  unicode<br />&nbsp; PWSTR Domain;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; same&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; same <br />&nbsp; PWSTR WindowStation;&nbsp;  same&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; same <br />&nbsp; HANDLE hToken;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  same <br />&nbsp; HDESK hDesktop;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ??&nbsp; HDESK = 4 bytes <br />&nbsp; PFNMSGECALLBACK pStatusCallback;&nbsp; &nbsp;  ??&nbsp;  4 bytes<br />} WLX_NOTIFICATION_INFO,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  is this another&nbsp; 4 bytes ?<br /> *PWLX_NOTIFICATION_INFO;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  4 byte ppointer reference<br /><br />Ok -&nbsp; since I only want to use the first 6 items I will take a chance that<br />the first 6 items have 4 byte pointers to them and simply allocate <br />more storage than I think I require (say 256 extra bytes)<br /><br />Question # 2 - I am assuming 4 bytes for all the pointers above, but<br />what about the last 2 items (outside the &quot;}&quot;&nbsp; - are these also <br />4 byte pointers - or ??<br /><br />Finally&nbsp; - assuming that the LibMain code above runs first&nbsp; and my code is <br />called next -<br /><br />Mycode PROC&nbsp; h:DWORD,r:DWORD,u:DWORD<br />	push	ebp<br />	mov	ebp, esp<br />	sub	esp, 64					<br />	push	ebx<br />	push	esi<br />	push	edi<br /><br />Question # 3 <br />At this point - Where in hell is the 4 byte &quot;pInfo&quot; that is supposed to be <br />passed to me ?&nbsp; Since this routine is called at logon time I have not found<br />a way to run this in Ollydbg or Windbg. I dont&#39; seem to be getting the pInfo pointer in the stack - can it be passed in a register ???<br />My reading seems to indicate that typical Windows calling convention uses the stack.&nbsp; I would think that the single&nbsp; 4 byte pInfo passed to me would be on the stack at&nbsp; ebp&nbsp; or ebp+4 or ebp+8 or ebp+12..&nbsp; My code is definiitely called - I get my event log written with garbage data.<br /><br />Obviously I need to learn more about how Windows/C compilers work and<br />the resulting programs are used in Windows.<br /><br />thanks for any help<br /><br />.<br />&nbsp;  </div>
    <div class="meta">Posted on 2006-07-25 16:30:45 by deros68</div>
   </div>
   <div class="post" id="post-184008">
    <div class="subject"><a href="#post-184008">Re: DLL calling converntiosn</a></div>
    <div class="body">I don&#39;t know if I can help much but here goes.&nbsp; Since you are trying to create a DLL have a look at Iczelion&#39;s tutorial number 17.&nbsp; You can find it easily enough with a google search for &#39;Iczelion.&#39;&nbsp; Follow the steps in the tutorial to make a barebones functional DLL and go from there.&nbsp; Thats about all I can say with my limited knowledge.</div>
    <div class="meta">Posted on 2006-07-26 00:28:03 by Desp</div>
   </div>
   <div class="post" id="post-184012">
    <div class="subject"><a href="#post-184012">Re: DLL calling converntiosn</a></div>
    <div class="body">Hm, the DllMain routine you posted is a bit foo. Here&#39;s the MSDN link that describes how DllMain works: http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dllproc/base/dllmain.asp .<br /><br />You really ought to convert the C struct to a MASM struct, will make things easier for you - have a look at windows.inc to get an idea of how to do it. And indeed yes, all items are 32bit/4byte size since you&#39;re on win32. Note that the strings (PWSTR) are unicode.<br /><br /><strong>WLX_NOTIFICATION_INFO</strong> and <strong>*PWLX_NOTIFICATION_INFO</strong> are just names for the structure - the one starting with P is a typename for pointer-to-the-structure.<br /><br />Your code should look something like...<br /><br /><pre><code><br />MyNotificationRoutine&nbsp;  PROC STDCALL USES EBX ESI EDI, pInfo:PTR WLX_NOTIFICATION_INFO<br />&nbsp; &nbsp; ; do some stuff here<br />&nbsp; &nbsp; ret<br />MyNotificationRoutine&nbsp;  ENDP<br /></code></pre><br /><br />Note: the MSDN article doesn&#39;t specify what calling convention is used, so *perhaps* it&#39;s C and not STDCALL.<br /><br />Now, what is this logon notify routine to be used for?<br /></div>
    <div class="meta">Posted on 2006-07-26 02:33:54 by f0dder</div>
   </div>
   <div class="post" id="post-184859">
    <div class="subject"><a href="#post-184859">Re: DLL calling converntiosn</a></div>
    <div class="body">Thanks to Desp &amp; f0dder<br /><br />Found the tute from Iczelion &amp; read the msdn article.&nbsp; fixed up my dllmain &amp; dissasembled a symantec routine to get a concrete example of how a dll uses the dllmain code.&nbsp; STDcall - 12 bytes right to left <br /><br />Yep - all that now fixed.<br /><br />I have finished coding and testing a simple winlogon notify routine that simply writes out to the event log whenever any user uses their smart card.&nbsp; I volunteered to write this routine to be called since our MSGINA is from a commercial vendor and we had to make sure that we did not impact their very complex logon/logoff/change password&nbsp; routine. It works fine. If someone wants a copy of this code (I am sure someone like f0dder or others could do a better job writing it) - I will see if I can send it to their private email address.<br /><br />thanks - I plan to learn more by writing code - the assembler language is easy - the mysteries of WINAPIs are a little less foggy now.&nbsp; <br /><br />deros68&nbsp; </div>
    <div class="meta">Posted on 2006-08-28 18:10:50 by deros68</div>
   </div>
   <div class="post" id="post-184872">
    <div class="subject"><a href="#post-184872">Re: DLL calling converntiosn</a></div>
    <div class="body">Why not post the results here? I&#39;d like a copy if you don&#39;t feel like posting it in public anyway :)<br /></div>
    <div class="meta">Posted on 2006-08-29 01:08:01 by f0dder</div>
   </div>
  </div>
 </body>
</html>