<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>PE Header Problems(win2k) - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=14972" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=12">The Heap</a> &raquo; <a href="../?id=14972">PE Header Problems(win2k)</a></p>
   <div class="post" id="post-116197">
    <div class="subject"><a href="#post-116197">PE Header Problems(win2k)</a></div>
    <div class="body">When a section is added to PE HEader in that way, it works in win 9x but not in win2k. why is that so?<br /><pre><code><br />//=================================================================================<br />HANDLE		hFile;<br />DWORD		dwFSize,dwTmp;<br />HANDLE		hMap;<br />char*		cMap;<br />//=================================================================================<br />PIMAGE_DOS_HEADER		pDos;<br />PIMAGE_NT_HEADERS		pPE;<br />PIMAGE_SECTION_HEADER	pSec,pNewSec;<br />//=================================================================================<br />DWORD	PEAlign&#40;DWORD dwTarNum,DWORD dwAlignTo&#41;<br />&#123;<br />	DWORD	dwRes=dwTarNum%dwAlignTo;<br />	DWORD	dwSol=dwTarNum/dwAlignTo;<br />	if&#40;dwRes==0&#41;<br />	&#123;<br />		return dwTarNum;<br />	&#125;else&#123;<br />		return &#40;dwSol+1&#41;*dwAlignTo;<br />	&#125;<br />&#125;<br />//=================================================================================<br />int APIENTRY WinMain&#40;HINSTANCE hInstance,HINSTANCE hPrevInstance,LPSTR lpCmdLine,int nCmdShow&#41;<br />&#123;<br />	DWORD	dwHeaderS= 0xFFFFFFFF;<br />	//Dosyam?z? A?al?m &#58;&#41;&#41;&#41;<br />	hFile=CreateFile&#40;&quot;calc.exe&quot;,GENERIC_READ|GENERIC_WRITE,0,0,OPEN_EXISTING,FILE_ATTRIBUTE_NORMAL,0&#41;;<br />	if&#40;&#40;DWORD&#41;hFile==0xFFFFFFFF&#41;<br />	&#123;<br />		MessageBox&#40;0,&quot;Calc.exe Not Found!!!&quot;,&quot;XXX&quot;,MB_ICONERROR&#41;;<br />		return 1;<br />	&#125;<br />	dwFSize=GetFileSize&#40;hFile,0&#41;;<br />	dwFSize=dwFSize+0x1500;<br />	hMap=CreateFileMapping&#40;hFile,0,PAGE_READWRITE	,0,dwFSize,0&#41;;<br />	cMap=&#40;char*&#41;MapViewOfFile&#40;hMap,FILE_MAP_ALL_ACCESS,0,0,dwFSize&#41;;<br /><br /><br />	pDos=&#40;PIMAGE_DOS_HEADER&#41;cMap;<br />	pPE=&#40;PIMAGE_NT_HEADERS&#41;&#40;&#40;DWORD&#41;cMap+pDos-&gt;e_lfanew&#41;;<br />	pSec=&#40;PIMAGE_SECTION_HEADER&#41;&#40;&#40;DWORD&#41;pPE+sizeof&#40;IMAGE_NT_HEADERS&#41;&#41;;<br /><br />	for&#40;int i=1;i&lt;pPE-&gt;FileHeader.NumberOfSections;i++&#41;<br />	&#123;<br />		++pSec;<br />		if&#40;strcmpi&#40;&#40;char*&#41;pSec-&gt;Name,&quot;TestSec&quot;&#41;==0&#41;<br />		&#123;<br />			MessageBox&#40;0,&quot;Opppsss&quot;,&quot;XXX&quot;,MB_ICONERROR&#41;;<br />			goto extsys;<br />		&#125;<br />	&#125;<br /><br />	pNewSec=pSec;<br />	++pNewSec;<br />	ZeroMemory&#40;pNewSec,sizeof&#40;IMAGE_SECTION_HEADER&#41;&#41;;<br />	pNewSec-&gt;VirtualAddress=PEAlign&#40;pSec-&gt;VirtualAddress+pSec-&gt;Misc.VirtualSize,pPE-&gt;OptionalHeader.SectionAlignment&#41;;<br />	pNewSec-&gt;Misc.VirtualSize=0x2000;<br />	pNewSec-&gt;Characteristics=0xE00000E0;<br />	pNewSec-&gt;PointerToRawData=PEAlign&#40;pSec-&gt;SizeOfRawData +pSec-&gt;PointerToRawData,pPE-&gt;OptionalHeader.FileAlignment&#41;;<br />	pNewSec-&gt;SizeOfRawData=0xA46;<br />	memcpy&#40;pNewSec-&gt;Name,&quot;TestSec&quot;,7&#41;;<br />	ZeroMemory&#40;&#40;void*&#41;&#40;&#40;DWORD&#41;cMap+pNewSec-&gt;PointerToRawData&#41;,0xA46&#41;;<br /><br />	//PE Headerdaki de?i?iklikler yap?l?yor.<br />	pPE-&gt;FileHeader.NumberOfSections=pPE-&gt;FileHeader.NumberOfSections+1;<br />	pPE-&gt;OptionalHeader.SizeOfImage=pNewSec-&gt;VirtualAddress+pNewSec-&gt;Misc.VirtualSize;<br />	pSec=&#40;PIMAGE_SECTION_HEADER&#41;&#40;&#40;DWORD&#41;pPE+sizeof&#40;IMAGE_NT_HEADERS&#41;&#41;;<br /><br />	FlushViewOfFile&#40;&#40;void*&#41;cMap,dwFSize&#41;;<br />	SetFilePointer&#40;hFile,pNewSec-&gt;PointerToRawData+0xA46,0,FILE_BEGIN&#41;;<br />	SetEndOfFile&#40;hFile&#41;;<br />	MessageBox&#40;0,&quot;All Done&quot;,&quot;XXX&quot;,0&#41;;<br />extsys&#58;<br />	UnmapViewOfFile&#40;&#40;void*&#41;cMap&#41;;<br />	CloseHandle&#40;hMap&#41;;<br />	CloseHandle&#40;hFile&#41;;<br />	return 0;<br /><br />&#125;<br /></code></pre><br /><strong>Bulunam?yor=Not Found</strong></div>
    <div class="meta">Posted on 2003-08-29 19:30:44 by Criminal2</div>
   </div>
  </div>
 </body>
</html>