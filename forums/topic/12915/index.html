<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>socket and memory problem - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=12915" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=8">Networking</a> &raquo; <a href="../?id=12915">socket and memory problem</a></p>
   <div class="post" id="post-100320">
    <div class="subject"><a href="#post-100320">socket and memory problem</a></div>
    <div class="body">Hi all,<br />I wrote a little program to check if netmeeting is running. This is a client/server program. The client request the server for the answer. the server has no visible window. The first problem is that, for each client connexion, the memory size of the program in the process list is growing up :confused: <br />Is there any mistake in the code ? The second problem is to know if I can do the same program without WinMain and WndProc ?<br /><br />This the code:<br /><pre><code><br />.386<br />.model flat,stdcall<br />option casemap&#58;none<br /><br />include     \masm32\include\windows.inc<br />include     \masm32\include\user32.inc<br />include     \masm32\include\kernel32.inc<br />include     \masm32\include\wsock32.inc<br /><br />includelib  \masm32\lib\user32.lib<br />includelib  \masm32\lib\kernel32.lib<br />includelib  \masm32\lib\wsock32.lib<br /><br />.data<br />ClassName     	db &quot;DLGCLASS&quot;,0<br />DlgName       	db &quot;Form1&quot;,0<br />Request		db &quot;GET&quot;,0<br /><br />hSock1        	dd 0<br /><br />.data?<br />hInstance     	HINSTANCE ?<br />CommandLine   	LPSTR     ?<br /><br />hDlg         	dd ?     <br />hMem		dd ?          <br />Received      	dd ?		<br />hSnapshot	dd ?<br />RSBuf         	db 4 dup&#40;?&#41;     <br /><br />wc            	WNDCLASSEX      &lt;&gt;<br />wsadata       	WSADATA         &lt;&gt;<br />msg           	MSG             &lt;&gt;<br />SA            	sockaddr_in     &lt;&gt;<br />uProcess	PROCESSENTRY32	&lt;&gt;<br /><br />.const<br />WM_SOCKET     	equ 		WM_USER+16<br />Netmeeting	db		&quot;conf.exe&quot;,0<br />Msg_OK		db		&quot;Netmeeting is RUNNING&quot;,0<br />Msg_NOK		db		&quot;Netmeeting is  NOT RUNNING&quot;,0<br /><br />.code<br /><br />;######################################################## <br />start&#58;<br />;######################################################## <br /> push   NULL<br /> call   GetModuleHandle<br /> mov    hInstance,eax<br /><br /> call   GetCommandLine<br /> mov    CommandLine,eax<br /><br /> push   NULL<br /> push   CommandLine<br /> push   NULL<br /> push   hInstance<br /> call   WinMain<br /><br /> push   eax<br /> call   ExitProcess<br /> <br />;######################################################## <br />WinMain proc hInst&#58;HINSTANCE,hPrevInst&#58;HINSTANCE,CmdLine&#58;LPSTR,CmdShow&#58;dword<br />;######################################################## <br /> mov    wc.cbSize,sizeof WNDCLASSEX<br /> mov    wc.style,CS_HREDRAW or CS_VREDRAW<br /> mov    wc.lpfnWndProc,offset WndProc<br /> mov    wc.cbClsExtra,NULL<br /> mov    wc.cbWndExtra,DLGWINDOWEXTRA<br /> push   hInst<br /> pop    wc.hInstance<br /> mov    wc.hbrBackground,COLOR_BTNFACE+1<br /> mov    wc.lpszClassName,offset ClassName<br /> mov    wc.lpszMenuName,NULL<br /><br /> invoke	WSAStartup,101h,offset wsadata<br /><br /> invoke	RegisterClassEx,offset wc<br /><br /> invoke	CreateDialogParam,hInstance,offset DlgName,NULL,NULL,NULL<br /> mov    hDlg,eax<br /> <br />.while TRUE<br /> 	invoke	GetMessage,offset msg,NULL,NULL,NULL<br /><br />	.break .if &#40;!eax&#41;<br /> 	push   offset msg<br /> 	call   TranslateMessage<br /> 	push   offset msg<br /> 	call   DispatchMessage<br /><br />.endw<br /> call   WSACleanup                       <br /> mov    eax,msg.wParam<br /> ret<br /><br />WinMain endp<br /><br />;######################################################## <br />WndProc proc hWnd&#58;HWND,uMsg&#58;UINT,wParam&#58;WPARAM,lParam&#58;LPARAM<br />;######################################################## <br /> invoke	socket,AF_INET,SOCK_STREAM,IPPROTO_TCP<br /> <br /> mov    hSock1,eax              <br /> mov    SA.sin_family,AF_INET<br /> mov    SA.sin_addr.S_un.S_addr,INADDR_ANY<br /><br /> invoke	htons,7777<br /> <br /> mov    SA.sin_port,ax<br /><br /> invoke	WSAAsyncSelect,hSock1,hWnd,WM_SOCKET,FD_ACCEPT<br /><br /> invoke	bind,hSock1,offset SA,sizeof SA<br /><br /> invoke	listen,hSock1,100<br />.if uMsg==WM_DESTROY <br />        invoke PostQuitMessage,NULL<br />.elseif uMsg==WM_SOCKET<br /> 	mov    eax,lParam<br /> 	and    eax,0FFFFh<br /><br />	.if     ax==FD_ACCEPT<br /> 		invoke	accept,wParam,NULL,NULL<br />		invoke	WSAAsyncSelect,eax,hWnd,WM_SOCKET,FD_READ or FD_CLOSE<br /><br />	.elseif ax==FD_READ<br /> 		invoke	recv,wParam,offset RSBuf,sizeof RSBuf,NULL<br /> <br />	;######################################################## <br /> 		invoke lstrcmp,addr Request, offset RSBuf<br /> 			.if eax==0<br />				mov	&#91;uProcess.dwSize&#93;, sizeof uProcess<br />				invoke	CreateToolhelp32Snapshot, TH32CS_SNAPPROCESS, 0<br />				mov	&#91;hSnapshot&#93;, eax<br />				invoke	Process32First, eax, addr uProcess<br />				.while eax<br />					invoke lstrcmp,addr uProcess.szExeFile, addr Netmeeting<br />					.if eax==0<br />						invoke 	send,wParam,offset Msg_OK,sizeof Msg_OK,0<br />						ret<br />					.endif<br />					invoke	Process32Next, &#91;hSnapshot&#93;, addr uProcess<br />				.endw<br />				invoke	CloseHandle, &#91;hSnapshot&#93;<br />				invoke 	send,wParam,offset Msg_NOK,sizeof Msg_NOK,0<br />			.endif<br /> 	;########################################################<br /><br /> 	.elseif ax==FD_CLOSE<br /> 	invoke	closesocket,wParam<br />	<br />	.endif<br />.else<br /> 	invoke	DefWindowProc,hWnd,uMsg,wParam,lParam<br /> 	ret<br /><br />.endif<br /> xor    eax,eax<br /> ret<br /><br />WndProc endp<br /><br />;######################################################## <br />end start<br />;######################################################## <br />;######################################################## <br /></code></pre><br /><br />Many thx for your help :grin:</div>
    <div class="meta">Posted on 2003-04-30 09:00:53 by mrpougne</div>
   </div>
   <div class="post" id="post-100324">
    <div class="subject"><a href="#post-100324">socket and memory problem</a></div>
    <div class="body">WinMain is just a convention - you don't really need it. Nothing stops you from skipping the &quot;wndmain&quot; proc and doing everything in your &quot;start&quot; label.<br /><br />If you don't need a GUI (and don't need to receive messages), you don't need a wndproc - this does also mean you can use WSAAsyncSelect, since you have no hwnd.<br /><br />About the memory use... is this a one-time hit when a client connects, or does it keep growing and growing and growing when clients connect? Does it return to normal when a client exits (or perhaps after some time)? Try making your app connect a couple of thousand times and see how the memory usage is affected.<br /><br />I wouldn't be surprised if there's a - perhaps even substantial - one-time hit (for various technical reasons I wont write here, unless you ask me to). Also, there ought to be some per-client overhead... however, if per-client overhead doesn't disappear when clients disconnect, something's wrong.</div>
    <div class="meta">Posted on 2003-04-30 09:19:03 by f0dder</div>
   </div>
   <div class="post" id="post-100326">
    <div class="subject"><a href="#post-100326">socket and memory problem</a></div>
    <div class="body">Here is the client code:<br /><pre><code><br />.386<br />.model	flat,stdcall<br />option	casemap&#58;none<br /><br />include	\masm32\include\windows.inc<br />include	\masm32\include\user32.inc<br />include	\masm32\include\kernel32.inc<br />include	\masm32\include\ws2_32.inc<br /><br />includelib  \masm32\lib\user32.lib<br />includelib  \masm32\lib\kernel32.lib<br />includelib  \masm32\lib\ws2_32.lib<br /><br />.data<br />AddrIP		db		&quot;xxx.xxx.xxx.xxx&quot;,0<br />Request		db		&quot;GET&quot;,0<br /><br />wsadata		WSADATA		&lt;&gt;<br />sin		sockaddr_in	&lt;&gt;<br /><br />.data?<br />sock		dd  ?<br />buffer		db  255 dup &#40;?&#41;<br /><br />.code<br /><br />start&#58;<br />invoke	WSAStartup,0002h,offset wsadata<br />invoke 	socket,AF_INET,SOCK_STREAM,IPPROTO_IP<br />mov	sock,eax<br />mov	sin.sin_family,AF_INET<br />invoke	htons,7777<br />mov	sin.sin_port,ax<br />invoke 	inet_addr,offset AddrIP<br />mov	sin.sin_addr,eax<br />invoke	connect,sock,addr sin,sizeof sin<br />invoke 	send,sock,offset Request,sizeof Request,0<br />invoke	recv,sock,offset buffer,sizeof buffer,0<br />invoke MessageBox, NULL, addr buffer, NULL, MB_OK<br /> <br />invoke 	closesocket,sock<br />call	WSACleanup<br />invoke	ExitProcess,eax<br /><br />end start<br /></code></pre><br /><br />I don't need WSAAsynchSelect if there is no WndProc ?</div>
    <div class="meta">Posted on 2003-04-30 09:25:58 by mrpougne</div>
   </div>
   <div class="post" id="post-100330">
    <div class="subject"><a href="#post-100330">socket and memory problem</a></div>
    <div class="body">You <strong>cannot use</strong> WSAAsynchSelect if there's no wndproc :)<br />You never <strong>need</strong> WSAAsynchSelect, wndproc or not - it's just one method of doing socket programming (and inefficient, says the resident MadWizard). There's plenty of different models, see <a target="_blank" href="www.madwizard.org">www.madwizard.org</a> .</div>
    <div class="meta">Posted on 2003-04-30 09:46:40 by f0dder</div>
   </div>
   <div class="post" id="post-100331">
    <div class="subject"><a href="#post-100331">socket and memory problem</a></div>
    <div class="body">Ok, thx, I will try to rewrite the server without WSAAsyncSelect ;) <br />And I will see if the memory problem appears again.....<br />Thx, <br />Eric</div>
    <div class="meta">Posted on 2003-04-30 09:49:43 by mrpougne</div>
   </div>
   <div class="post" id="post-100334">
    <div class="subject"><a href="#post-100334">socket and memory problem</a></div>
    <div class="body">Ah, I misunderstood your question - I thought you were connecting to a netmeeting server.<br /><br />By a quick skim of your code, things seem to look okay. You closehandle the toolhelp snapshot, and you closesocket the socket. no other dynamic memory going on. I might have missed something, but it appears ok.<br /><br />Doesn't netmeeting have some window, though? Something you could check instead of using toolhelp32? Matter of taste, I guess.<br /><br />Memory problem shouldn't be because of asyncselect, so you shouldn't rewrite just because of that.<br /><br />I will have a look at the memory usage of the server app and see if it's something that should be done something about. Oh, when posting code snippets, use the {code} and {/code} tags (replace {} with [])</div>
    <div class="meta">Posted on 2003-04-30 09:59:12 by f0dder</div>
   </div>
   <div class="post" id="post-100337">
    <div class="subject"><a href="#post-100337">socket and memory problem</a></div>
    <div class="body">Ok, but I would like to do the same thing without any GUI, just a running process. Have any sample code of a server without GUI ? So, if I understood well, without WSAAsyncSelect.... ? :)</div>
    <div class="meta">Posted on 2003-04-30 10:17:00 by mrpougne</div>
   </div>
   <div class="post" id="post-100339">
    <div class="subject"><a href="#post-100339">socket and memory problem</a></div>
    <div class="body">Well, for the &quot;FindWindow&quot; thing I meant instead of toolhelp looking for conf.exe, perhaps you could look for a window - but again, it shouldn't really matter, it's more of a personal preference of staying away from toolhelp/psapi unless I have to use them :).<br /><br />Humm, your program doesn't immediately work on my machine... seems like the client app either gets an empty string back, or perhaps fails connecting. Also, you don't do much error checking, and your socket code isn't 100% correct - go read <a target="_blank" href="www.madwizard.org">www.madwizard.org</a> winsock programming stuff, async socket handling requires a bit more than your current code :)</div>
    <div class="meta">Posted on 2003-04-30 10:26:00 by f0dder</div>
   </div>
   <div class="post" id="post-100763">
    <div class="subject"><a href="#post-100763">socket and memory problem</a></div>
    <div class="body">Ok, but have you a sample code of a listenning server without GUI and without WSAAsyncSelect ? To make a hide process..... please :grin:</div>
    <div class="meta">Posted on 2003-05-02 08:55:15 by mrpougne</div>
   </div>
   <div class="post" id="post-100818">
    <div class="subject"><a href="#post-100818">socket and memory problem</a></div>
    <div class="body">Please read <a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=12659">http://www.asmcommunity.net/board/index.php?topic=12659</a><br /><br />This makes it easier on all of us<br /><br />Thanks,</div>
    <div class="meta">Posted on 2003-05-02 16:20:04 by gorshing</div>
   </div>
  </div>
 </body>
</html>