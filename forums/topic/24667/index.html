<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Please BetaTest - VOIP Thingy - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=24667" />
    <link rel="next" href="../?id=24667&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=24667">Please BetaTest - VOIP Thingy</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=24667&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=24667&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="24667" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=24667&amp;page=2">&gt;</a><a href="../?id=24667&amp;page=2">&raquo;</a></form>   <div class="post" id="post-180230">
    <div class="subject"><a href="#post-180230">Please BetaTest - VOIP Thingy</a></div>
    <div class="body">Heya :)<br />Please test the attached application and let me know if its stable.<br />It&#39;s a UDP based VOIP (voice over ip) thingy, with kinda crap RLE compression which works great when you&#39;re compressing silence, lol.. anyways, its set up for 8khz, 8 bit audio.. it Sends, but it doesn&#39;t Recv yet, this is just a Send test ok guys :)<br />Those of you who have DebugCenter installed will see runtime debug spew..<br /><br />I&#39;m thinking about expanding it to compress the &quot;uncompressible data&quot; to around 50% by encoding delta value bytes as nybbles, when the waveform delta is 4 bits or less.<br />This should give me a reasonably fast lossless compression algo that yields reasonably decent compression rations for WAVE input data.<br /><br />Make sure to Set the Host before you Talk :) (you can change it again if you like)<br />If you have problems, please tell me what your audio hardware is.<br /><br />Note : you can Lock the Talk button by &#39;left clicking it, then sliding off it before releasing the mousebutton&quot;<br /><br /><br /></div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=1610" target="_blank">DXAudio.zip</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2006-04-29 10:47:03 by Homer</div>
   </div>
   <div class="post" id="post-180231">
    <div class="subject"><a href="#post-180231">Re: Please BetaTest - VOIP Thingy</a></div>
    <div class="body">gives me something like &quot;masm32 path not found&quot; and &quot;debug center not found&quot; and then crashes.<br /><br />About the compression: Use The <a target="_blank" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/multimed/htm/_win32_audio_compression_manager.asp">audio compression manager</a> and let the user chose his/her favorite compression method. ...Or choose yourself. I suggest using GSM6.1 or CiTT u/a-law.<br /><br />The attached file is a little demo app showing how to (de)compress a wave using MS ACM. the source is quite unclean, but you can get the idea of how things work. Afetr every compression the app shows some messageboxes. They&#39;re for testing purposes, so just ignore them.</div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=1593" target="_blank">acm_test_04.zip</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2006-04-29 10:59:53 by ti_mo_n</div>
   </div>
   <div class="post" id="post-180233">
    <div class="subject"><a href="#post-180233">Re: Please BetaTest - VOIP Thingy</a></div>
    <div class="body">Thanks - I&#39;ll read that source tomorrow and implement the ACM stuff.. I don&#39;t have fileheaders, I&#39;m dealing with raw wav data in a known format.. a stream sample would have been more appropriate, but I&#39;ll figure it out :)<br /><br />In regards to the crash - I can&#39;t say what went wrong because DebugCenter is not installed :)<br />DebugCenter is an executable which my beta demos interact with, basically it&#39;s just a window to capture debug messages in a separate process.<br />You can obtain the DebugCenter component of OA32 as a separate download from Biterider&#39;s site : http://objasm32.tripod.com<br />Just put the small executable someplace safe and execute it (from there) ONCE to self-register it.<br />After that, it will be launched automatically by any beta apps that have debug spew..<br /><br /><br /><br /></div>
    <div class="meta">Posted on 2006-04-29 11:28:03 by Homer</div>
   </div>
   <div class="post" id="post-180240">
    <div class="subject"><a href="#post-180240">Re: Please BetaTest - VOIP Thingy</a></div>
    <div class="body">I have debug center, but it crashes saying that it can&#39;t find masm&#39;s path :P<br /><br />The attached file is acm.inc with all the stuff regarding MSACM in it. It&#39;s in TASM syntax, but it&#39;s quite straightforward, so it shoudn&#39;t be difficult to translaate.</div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=1594" target="_blank">ACM.zip</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2006-04-29 12:08:59 by ti_mo_n</div>
   </div>
   <div class="post" id="post-180250">
    <div class="subject"><a href="#post-180250">Re: Please BetaTest - VOIP Thingy</a></div>
    <div class="body">Hi ti_mo_n<br />It is possible that you are using an old DebugCenter release? Try this one... If you still have problems, write down the text in the messagebox please.<br /><br />Biterider</div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=1597" target="_blank">DebugCenter.zip</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2006-04-29 13:20:55 by Biterider</div>
   </div>
   <div class="post" id="post-180251">
    <div class="subject"><a href="#post-180251">Re: Please BetaTest - VOIP Thingy</a></div>
    <div class="body">Thank you - it works now. Homer&#39;s app displays some text about buffers being &#39;good to go&#39;. It also displays some info when I press &quot;talk&quot;. Trying to connect anywhere fails with either &quot;bad host&quot; or &quot;failed bind&quot; (probably becuase there is no host for this app?).</div>
    <div class="meta">Posted on 2006-04-29 13:25:20 by ti_mo_n</div>
   </div>
   <div class="post" id="post-180263">
    <div class="subject"><a href="#post-180263">Re: Please BetaTest - VOIP Thingy</a></div>
    <div class="body">That&#39;s right - ignore the &quot;failed Bind&quot; message.<br />Binding is not at all necessary for SENDING packets..<br />( you should have no issue Binding to local addresses such as loopback ;) )<br /><br />The other one, &quot;Bad Host&quot;, indicates a DNS lookup failure (ie, failed to resolve hostname to ip).. this is kinda bad.<br /><br />Either way, pressing that button (re)creates and initializes the Socket for udp, so nothing will be sent until you do this first (you will see &quot;transmission error&quot; in the debug spew)<br /><br />Currently the application does not handle partially incomplete sends well at all - it does detect them, but does nothing to correct this situation.<br />Similarly, packets are not being marked with a Counter value to deal with out-of-order reception, although the existing custom RLE compression algorithm does allow us to identify incomplete packets.. the protocol will likely be defined within the context of a tutorial aimed at beginners in network programming (theres no protocol yet per se) <br /><br />I was mostly interested in the stability of the application - ie, does the application crash under load? (How long can you send packets before it falls down? DOES it fall down?)<br /><br />I&#39;ll be looking into the ACM stuff shortly, it&#39;s been a busy day.. perhaps I will repost today, perhaps not..<br /></div>
    <div class="meta">Posted on 2006-04-30 02:59:27 by Homer</div>
   </div>
   <div class="post" id="post-180269">
    <div class="subject"><a href="#post-180269">Re: Please BetaTest - VOIP Thingy</a></div>
    <div class="body"><br />Heya - I&#39;ve updated the previously attached zipfile.<br />The new version will search through the installed codecs looking for TrueSpeech support.<br />I&#39;m led to believe that TrueSpeech shipped with everything from win95 onwards, so I am expecting no problems... let me know if there are !!<br /><br />(note : I haven&#39;t implemented the compression yet, just a search for a particular codec..)</div>
    <div class="meta">Posted on 2006-04-30 11:48:12 by Homer</div>
   </div>
   <div class="post" id="post-180270">
    <div class="subject"><a href="#post-180270">Re: Please BetaTest - VOIP Thingy</a></div>
    <div class="body">It prints a lot of text and ends with &quot;codec not available&quot;. There is a TrueSpeech in this &#39;log&#39;. Please see the attached output.</div>
    <div class="attachments">Attachments:
     <ul>
      <li><a href="../../attachments/?id=1600" target="_blank">aa.zip</a></li>
     </ul>
    </div>
    <div class="meta">Posted on 2006-04-30 13:16:59 by ti_mo_n</div>
   </div>
   <div class="post" id="post-180274">
    <div class="subject"><a href="#post-180274">Re: Please BetaTest - VOIP Thingy</a></div>
    <div class="body">I see.. I was searching for the codec by the Long Name.<br />My log says &quot;Long name:&nbsp; DSP Group TrueSpeech(TM) Software CODEC&quot;<br /><br />I changed the code to search for the first codec that supports FormatTag 34 (TrueSpeech).<br />Also, I changed the Capture audio format from 8bit, 8khz to 16bit, 8khz.<br />This means our one second recording buffer is now 16000 bytes.<br />There&#39;s still 16 notification positions distributed across the buffer.<br /><br />Having made that change to the capture format, I was then able to create two ConversionStreams (one to compress wav--&gt;truespeech, the other to decompress truespeech--&gt;wav).<br /><br />I&#39;ve updated the zip again for the changes outlined above.<br />Other changes include the removal of the custom compression code, and the disabling of the SendTo code .. you can ignore the &#39;Set Host&#39; button, because pressing &#39;Talk&#39; will simply show the accessing of &quot;chunks of 1/16 of the capture buffer&quot; (via the notifications mentioned previously).<br /><br />All that remains now is to add some calls to perform the streaming conversion of the accessed portions of the buffer, and then write the &quot;playback&quot; side (create playback buffer, access portions of it, etc)<br /></div>
    <div class="meta">Posted on 2006-05-01 04:33:21 by Homer</div>
   </div>
   <div class="post" id="post-180282">
    <div class="subject"><a href="#post-180282">Re: Please BetaTest - VOIP Thingy</a></div>
    <div class="body"><br />Added code for Playback.<br />We no longer Start and Stop Capture with the button - it toggles a flag var instead.<br />The reason is that we can&#39;t set up Notifications on a Playback buffer.<br /><br />The capture and playback buffers are created together, of the same format (pcm-wave), and of the same size.. then they are both started running, and then they basically never stop. I had hoped that I would be able to get them close to synchronized, and that they&#39;d move together, but the reality turned out to be otherwise.. more work.<br /><br />The periodic notifications are our queue to grab the current hardware offsets in both buffers and access the buffers &#39;safely&#39; (ie, avoiding the region that the hardware is using in each).<br /><br />The new boolean flag, bIsRecording, allows the notification processing loop to &#39;ignore the capturebuffer for the period of the current notification&#39;.<br /><br />Updated the zip again :)<br /><br /></div>
    <div class="meta">Posted on 2006-05-01 12:00:53 by Homer</div>
   </div>
   <div class="post" id="post-180283">
    <div class="subject"><a href="#post-180283">Re: Please BetaTest - VOIP Thingy</a></div>
    <div class="body">To set notification positions on playback buffers, the buffers must be created with DSBCAPS_CTRLPOSITIONNOTIFY.<br /><br />&gt; <a target="_blank" href="http://msdn.microsoft.com/library/en-us/directx9_c/dsbufferdesc.asp?frame=true">DSBUFFERDESC</a></div>
    <div class="meta">Posted on 2006-05-01 12:11:40 by ti_mo_n</div>
   </div>
   <div class="post" id="post-180285">
    <div class="subject"><a href="#post-180285">Re: Please BetaTest - VOIP Thingy</a></div>
    <div class="body">Ok, cool :) ... but it&#39;s not actually worth doing - we just need periodic servicing of the buffers, the Capture notifications can serve both buffers .. either way, we still should check the current hardware positions within the notification handler(s), so I&#39;m not seeing any benefit from having two sets of notifications at all.. unless you wanted playback and capture to be managed by separate threads, which in my mind is even worse, ie, extra overhead and complexity for no logical reason.. agree?<br /></div>
    <div class="meta">Posted on 2006-05-01 12:56:19 by Homer</div>
   </div>
   <div class="post" id="post-180286">
    <div class="subject"><a href="#post-180286">Re: Please BetaTest - VOIP Thingy</a></div>
    <div class="body">The play buffer can lag in some situations. You can&#39;t assume that both buffers are in the same play position just because they were started at the same time. The main reason for the lag is the &#39;start lag&#39; - it&#39;s a few miliseconds from one &#39;play&#39; command to another. The other lag comes from refilling the buffers - the memory must be copied from 1 place to another. Third lag occasion is during mixing: software mixing may mix 1 sound and then procees to mix the other one (while the first one is already playing). It&#39;s not the case on modern systems, because they&#39;re very fast, but if you want to me &quot;mr. proper, clean &amp; clear&quot; then you should give every buffer its own notification positions and act on them separately (threads strongly recommended).</div>
    <div class="meta">Posted on 2006-05-01 13:24:14 by ti_mo_n</div>
   </div>
   <div class="post" id="post-180287">
    <div class="subject"><a href="#post-180287">Re: Please BetaTest - VOIP Thingy</a></div>
    <div class="body">I&#39;ve succeeded in implementing what I described - ie, sharing the notifications, thinking of them only as a periodic firing mechanism for the code which services BOTH buffers.<br />The updated demo shows the locking and unlocking of the Play buffer all the time, and the locking and unlocking of the Capture buffer as well , should you press Talk.<br /><br />The memory accesses are sequential, in equal divisions of time regardless of their lag... but the size of the accesses depends on the lag, for we access all the memory &quot;from our last access address to the current hardware pointer&quot;, always working behind the region that the hardware is accessing in both buffers.<br /> <br />We can play and record at the same time under a single thread.<br />It is less complex, it uses less resources, and it performs exactly the same tasks.<br /></div>
    <div class="meta">Posted on 2006-05-01 13:40:05 by Homer</div>
   </div>
   <div class="post" id="post-180289">
    <div class="subject"><a href="#post-180289">Re: Please BetaTest - VOIP Thingy</a></div>
    <div class="body">OK. I didn&#39;t know you do it THIS way ;)</div>
    <div class="meta">Posted on 2006-05-01 13:44:05 by ti_mo_n</div>
   </div>
   <div class="post" id="post-180294">
    <div class="subject"><a href="#post-180294">Re: Please BetaTest - VOIP Thingy</a></div>
    <div class="body">Nice little idea you have here...<br />I will test it out for you i am running Microsoft Windows Xp Professional, 98 , 2000 .and some others on my home pc&#39;s</div>
    <div class="meta">Posted on 2006-05-01 19:09:38 by COREY</div>
   </div>
   <div class="post" id="post-180301">
    <div class="subject"><a href="#post-180301">Re: Please BetaTest - VOIP Thingy</a></div>
    <div class="body">Thanks, I appreciate it.. you&#39;ll need DebugCenter installed to see what&#39;s happening at runtime.<br />I&#39;m not expecting any platform-specific problems, but you never know..</div>
    <div class="meta">Posted on 2006-05-02 00:41:24 by Homer</div>
   </div>
   <div class="post" id="post-180313">
    <div class="subject"><a href="#post-180313">Re: Please BetaTest - VOIP Thingy</a></div>
    <div class="body">I&#39;ve posted another update.<br />This version compresses the Captured audio data.<br />If you study the debug spew, you will see stuff like :<br /><div class="quote">dwSize1 = 2428t, Actual #Bytes Locked<br />pCaptured = 008DD556h<br />ashc.cbDstLengthUsed = 160t</div><br /><br />Here we can see that a chunk of input wave data of 2428 bytes was compressed to 160 bytes :)<br /><br />In this version, I had to deal with a new special case.. TrueSpeech was refusing to compress the input data if there was less than several hundred bytes..<br /><br />This happens regularly when the Capture hardware pointer wraps past the end of the buffer, leaving us to read &quot;from wherever we were last time to the end of the buffer&quot;.<br />My solution was to handle insufficient data as follows:<br />If theres less than 512 bytes available, copy it to a temp buffer, and force our &quot;last read offset&quot; to zero (the start of the buffer)... then, in the next iteration, append any further available data to the tempbuffer, and compress the tempbuffer.<br /><br />It seems to work just fine :)<br /><br />I&#39;m now ready to start Sending my compressed data again, but before I do that, I&#39;ll start setting up the RX (receive) networking code (for the playback side of the app).<br />As soon as I&#39;m ready to both Send and Receive, I&#39;ll tidy up the source and post it complete in the Networking section in a new thread entitled something like &quot;Voice Protocol Design&quot; :D<br /><br /></div>
    <div class="meta">Posted on 2006-05-02 05:02:40 by Homer</div>
   </div>
   <div class="post" id="post-180334">
    <div class="subject"><a href="#post-180334">Re: Please BetaTest - VOIP Thingy</a></div>
    <div class="body">OK, I&#39;m now loopback testing .. Sending and Receiving the compressed data, and compressing and decompressing it and stuff like that...<br /><br />I had problems with storing decompressed data in the PlayBuffer, but I&#39;ve come up with a solution to the problem which involves marking the Sent packets with the buffer offset at which they were recorded.<br />When we receive and decompress some data, we write it to the playbuffer at the offset indicated in the packet if it &quot;safe to do so&quot;.. otherwise we cache the packet until the next Notification occurs, by which time it should be safe to store the packet.<br />There is a &#39;danger zone&#39; that we should avoid accessing in the buffer space.<br />It begins at the current position of the buffer&#39;s Hardware cursor.<br />Where it ends depends on the audio card you are using.. I&#39;m going to define a &quot;danger zone size&quot; of one and a half Notification timedivisions so as&nbsp; to be &#39;extra safe&#39; :)<br />If the Offset indicated within a received packet lays within the &#39;danger zone&#39;, we&#39;ll cache the data by adding it to a DataCollection ;)<br />Each packet is being received into a heap-allocated memory object that is perfectly suitable for storing in a DataCollection.<br />Each time a Notification fires, we&#39;ll just try to empty the DataCollection.<br />Basically all this means that:<br />- packets arriving out of order are irrelevant since we reconstruct the buffer with what is effectively a time-marker.<br />- we can handle more than one packet at a time if we need to, and this is important because we can expect weirdness and handle it.. I&#39;m thinking ahead a little toward sinking multiple sources and mixing them locally, but anyways.. mixing is something I&#39;m yet to look into.<br /><br />I haven&#39;t sent a new update yet because I want to try implementing what I just described first..<br /><br />Something I noticed which is interesting is that the size of a chunk of data gets smaller when it is compressed, then decompressed.. this worries me, since this is going to create some &#39;gaps&#39; in the playbuffer :( I was under the impression that I might lose some quality, but it seems unacceptable to me that I should lose Size, where in a pcm-wave, the size is critical since it is so strongly associated with Time.. I am predicting a &#39;machinegun&#39; kind of audio artifact created because there&#39;s &#39;16 gaps per second&#39; :(<br /><br />Anyone care to comment?<br /><br /></div>
    <div class="meta">Posted on 2006-05-02 13:36:36 by Homer</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=24667&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=24667&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="24667" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=24667&amp;page=2">&gt;</a><a href="../?id=24667&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>