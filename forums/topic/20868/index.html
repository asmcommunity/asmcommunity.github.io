<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>MD2 Loader - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=20868" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=10">Graphics &amp; Game Development</a> &raquo; <a href="../?id=20868">MD2 Loader</a></p>
   <div class="post" id="post-158610">
    <div class="subject"><a href="#post-158610">MD2 Loader</a></div>
    <div class="body">I&#39;ve started writing an MD2 Loader (used in quake2) as the basis of an upcoming tutorial.<br />It&#39;s coming along really nicely. It&#39;s written for masm and with atc oop support, which makes stuff like file io much cleaner.<br /><br />So far it loads all the data from the MD2 file into structures allocated on demand, and as it does so, displays the names of the animation frames.<br /><br />They have names which are followed by numbers which indicate a sequence, for example, Walk01 thru Walk40, and there&#39;s a bunch of them.<br /><br />Next I have to convert the data I loaded into something more friendly since some of the data in an MD2 is stored in funky ways to save space.<br /><br />After that, I can put together a delay-based frame renderer and make sure everything is cool before implementing linear interpolation between frames.<br /><br />Once all that&#39;s done, all that remains is the wrap the model struct as an oop object class and I&#39;m ready to write my tute.<br /><br />http://homer.ultrano.com/Upload/MD2Animation.zip</div>
    <div class="meta">Posted on 2005-03-31 10:09:41 by Homer</div>
   </div>
   <div class="post" id="post-158691">
    <div class="subject"><a href="#post-158691">Re: MD2 Loader</a></div>
    <div class="body">Nice one, but you should have used VKDebug in it - or anything else , other than msgbox - after the 4th msgbox the loader has already proven it gets the offsets alright - but clicking OK or holding Enter to get rid of them caused 10 instances of the loader to run on the university machine I ran it on :lol: . For me it&#39;s a shame .md2 stores vertex normals instead of face normals , I don&#39;t want gourad/phong shading in my software engine - so I&#39;ll have to make my own format again :lol: - for animated 3D. I&#39;m looking at md3 these days since <strong>gmax</strong> exports it ;)<br /><br />Btw, here&#39;s something that looks a lot like the game I want to make in x86 asm this summer:<br />http://www.mossjp.co.jp/raiden/raiden.htm<br />There are movies for each level too(5MB 320x240 each) : http://www.mossjp.co.jp/raiden/l_b_1.html<br />:) <br />The technology used there is what I&#39;m currently concentrating on in the 3D gamedev world ^^&quot;</div>
    <div class="meta">Posted on 2005-04-03 10:11:05 by Ultrano</div>
   </div>
   <div class="post" id="post-158703">
    <div class="subject"><a href="#post-158703">Re: MD2 Loader</a></div>
    <div class="body">I do intend to go to MD3 and beyond, but for several reasons I want to write a nice and solid MD2 demo.<br />I want to keep the code simple and readable for a tutorial, and I want to show up any potential problems that might arise in more complex code.<br />The transition from MD2 to MD3 can be made without much pain, but is even easier with hindsight and a fistful of proven code.<br /><br />Ultrano: Ah yes, I remember this one :)</div>
    <div class="meta">Posted on 2005-04-03 22:10:24 by Homer</div>
   </div>
   <div class="post" id="post-158706">
    <div class="subject"><a href="#post-158706">Re: MD2 Loader</a></div>
    <div class="body">I&#39;ve added the code for converting the raw data from the MD2 file into more friendly data structures, parsing the animation frames and enlisting the start and end frames of each named animation, etc.<br />Reuploaded to the same URL as previously.</div>
    <div class="meta">Posted on 2005-04-04 01:43:27 by Homer</div>
   </div>
   <div class="post" id="post-158714">
    <div class="subject"><a href="#post-158714">Re: MD2 Loader</a></div>
    <div class="body">Uhm does it save to a file, and if yes - what is its name? I can&#39;t see such a file though I expected it :| . And with that UPX packing, I can&#39;t see the (dis)asm&nbsp; :sad:</div>
    <div class="meta">Posted on 2005-04-04 07:50:18 by Ultrano</div>
   </div>
   <div class="post" id="post-158716">
    <div class="subject"><a href="#post-158716">Re: MD2 Loader</a></div>
    <div class="body">At the moment, I don&#39;t save the data to a custom file format - I am not loading it into my special optimising arrays, so I&#39;m not bothering with a custom format to duplicate MD2.<br />The legal aspect: ID Games don&#39;t mind what we do with their file format, provided we use our own code to do it.<br /><br />I&#39;m still using MessageBox (sorry! I&#39;ll change soon).<br />I&#39;m currently adding the code for calculating the current frame in &quot;animation time&quot; and also code for rendering the model with linear interpolation applied to the vertices in software.<br />I&#39;ve recently come across notes about a little-used section of MD2 files which is called GLCommands. It describes the model geometry in terms of trianglestrips and fans, and can be used to render more quickly if the MD2 file contains this section.<br />I&#39;ll get back to that one later.<br /><br />I implemented code to test the current frame calculation over time and its working.<br />Guess I&#39;ll have to put the OpenGL and Windows code back in soon so I can test the Render stuff out :) Not far away then :)<br /><br />Ultrano - Sorry about the upx, I&#39;ve added it to my BLDALL.BAT since I use it a lot.<br />You can use upx to decompress the executable if you like, and I&#39;ll happily ftp the source on request.<br /></div>
    <div class="meta">Posted on 2005-04-04 08:56:48 by Homer</div>
   </div>
   <div class="post" id="post-158718">
    <div class="subject"><a href="#post-158718">Re: MD2 Loader</a></div>
    <div class="body">exe packing - foo! ;)</div>
    <div class="meta">Posted on 2005-04-04 10:24:20 by f0dder</div>
   </div>
   <div class="post" id="post-158741">
    <div class="subject"><a href="#post-158741">Re: MD2 Loader</a></div>
    <div class="body">Yes, please ftp the source :)</div>
    <div class="meta">Posted on 2005-04-05 14:24:44 by Ultrano</div>
   </div>
   <div class="post" id="post-158745">
    <div class="subject"><a href="#post-158745">Re: MD2 Loader</a></div>
    <div class="body">Ultrano - I&#39;ve uploaded source as MD2Animation.zip in my ftp root.<br />If I missed any files, let me know.<br />Most of the files in the OOP folder are not used in this project, I just included the whole lot regardless.<br /><br />The current version is still buggy, but happy days, most of the messageboxes are gone, and a logfile is employed. However, due to there being debug lines in the Render/Animate procs, the logfile will grow very large, very fast... don&#39;t leave the app rendering for long !!<br /><br />Currently I can&#39;t see anything being rendered :(<br />I am yet to investigate the problem, it could be as simple as my camera view not pointing at the model. According to the logfile, the animation frames are being rendered correctly and incrementing over time correctly...<br /><br /><br /></div>
    <div class="meta">Posted on 2005-04-05 21:13:09 by Homer</div>
   </div>
   <div class="post" id="post-158753">
    <div class="subject"><a href="#post-158753">Re: MD2 Loader</a></div>
    <div class="body">I found and fixed one problem in CLoadMD2 class today.<br />The tMd2AliasTriangle structure was using word-sized vertex indices.<br />They should be BYTE indicies, and the ConvertDataStructures method should reference them as such, instead of Words.<br /><br /></div>
    <div class="meta">Posted on 2005-04-06 06:48:16 by Homer</div>
   </div>
   <div class="post" id="post-158754">
    <div class="subject"><a href="#post-158754">Re: MD2 Loader</a></div>
    <div class="body">After I run it in window mode, the window just stays black until I mouse-click on it. After the click I just see random lines at around 100fps flick out from the center to infinity, clicking again hides them. Pressing ESC, and I get a GPF: the EIP is 0x00000000 .. you&#39;ve pushed somewhere too much I guess. The last line of the 40MB-200MB log is:<br />Returned from MainLoop procedure : April, Wednesday&nbsp; 06 2005&nbsp;  - 03:32:26 PM&lt;190767338&gt;<br />Could by any chance these problems be because of the logging? The logging seems too detail to me - in similar cases I just log the first one or two iterations only :)</div>
    <div class="meta">Posted on 2005-04-06 07:43:52 by Ultrano</div>
   </div>
   <div class="post" id="post-158774">
    <div class="subject"><a href="#post-158774">Re: MD2 Loader</a></div>
    <div class="body">My logging macros are not totally register-safe, but they don&#39;t mess up the Stack.<br /><br />The crash on shutdown is during the Cleanup phase, I&#39;m releasing a resource somewhere twice, it&#39;s in the Animations resources since that&#39;s what&#39;s been added recently.<br /><br />The logging is well and truly overkill, and should certainly take a minimalist approach within the render loop. <br />At first I was crashing during rendering , inside the AnimateModel proc.<br />I added some debug lines to it and got it to run without crashing, but still couldn&#39;t see anything onscreen so I went a little crazy there, adding more and more debug detail, trying to spot the issue...<br /><br />One major issue I discovered within the CLoadMD2 class in the tMd2AliasTriangle struct and in the ConvertDataStructures method, I mentioned it in a previous post, the change is small and ineffctual - I still can&#39;t see my model.<br />This source is a straightforward translation of a proven C++ source.<br /></div>
    <div class="meta">Posted on 2005-04-06 23:21:14 by Homer</div>
   </div>
   <div class="post" id="post-158783">
    <div class="subject"><a href="#post-158783">Re: MD2 Loader</a></div>
    <div class="body">Hello dudes<br /><br />I encoutered the same thing some time ago with Quake models, nothing on the screen.<br /><br />If I&#39;m not mistaken the format of the texture and vertex data is not in floating point format but in 16 bit short<br />Vertex data -&gt;? change short to float and divide by 64 (keep it in a normal range)<br />Texture data -&gt; change short to float and divide by 256 (so texturecoords are between 0.0 and 1.0)<br /><br />Greetings Siekmanski</div>
    <div class="meta">Posted on 2005-04-07 04:32:29 by Siekmanski</div>
   </div>
   <div class="post" id="post-158784">
    <div class="subject"><a href="#post-158784">Re: MD2 Loader</a></div>
    <div class="body">He does that already:<br /><pre><code><br />(from file CLoadMD2_ClassDef.inc)<br />&nbsp; &nbsp; .while eax &lt; .t3DObject.numTexVertex<br />;&nbsp; &nbsp; &nbsp; &nbsp; currentFrame.pTexVerts.x = m_pTexCoords.u / float(m_Header.skinWidth);<br />;&nbsp; &nbsp; &nbsp; &nbsp; currentFrame.pTexVerts.y = 1 - m_pTexCoords.v / float(m_Header.skinHeight);<br />&nbsp; &nbsp; &nbsp; &nbsp; mov edi,pcurrentFrame<br />&nbsp; &nbsp; &nbsp; &nbsp; mov edi,.t3DObject.pTexVerts<br />&nbsp; &nbsp; &nbsp; &nbsp; mov eax,sizeof Vec2<br />&nbsp; &nbsp; &nbsp; &nbsp; mul j<br />&nbsp; &nbsp; &nbsp; &nbsp; add edi,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; mov esi,.CLoadMD2.m_pTexCoords<br />&nbsp; &nbsp; &nbsp; &nbsp; mov eax,sizeof tMd2TexCoord<br />&nbsp; &nbsp; &nbsp; &nbsp; mul j<br />&nbsp; &nbsp; &nbsp; &nbsp; add esi,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; xor eax, eax<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; mov ax, .tMd2TexCoord.tu<br />&nbsp; &nbsp; &nbsp; &nbsp; mov dwtemp,eax<br />&nbsp; &nbsp; &nbsp; &nbsp; fild dwtemp<br />&nbsp; &nbsp; &nbsp; &nbsp; fdiv .CLoadMD2.m_Header.skinWidth<br />&nbsp; &nbsp; &nbsp; &nbsp; fstp .Vec2.U<br /></code></pre><br /><br />But shouldn&#39;t <br />fdiv .CLoadMD2.m_Header.skinWidth<br />be <br /><strong>fidiv</strong> .CLoadMD2.m_Header.skinWidth&nbsp; <br />?<br /></div>
    <div class="meta">Posted on 2005-04-07 05:11:48 by Ultrano</div>
   </div>
   <div class="post" id="post-158788">
    <div class="subject"><a href="#post-158788">Re: MD2 Loader</a></div>
    <div class="body">I think you are right about that, Ultrano.<br />I&#39;m currently working on animated MD3 and messing with an MD3 exporter for Maya 4.0 , and learning the rules for modelling and animating with regards to the exporter. I&#39;ll implement that change in the MD2 code and re-upload it.<br /><br />With regards to modelling for MD3:<br />Ultimately, I don&#39;t need to make Quake-ready models, I can make whatever models I like and animate them how I like.<br />The main thing that irks me is that I haven&#39;t come across any example of MD3 animation which really uses the bone information properly.<br />In Quake-style MD3 animation, the body consists of only several segments, being the legs, torso and head meshes, and they are strung together as a simple skeleton. Each mesh represents a Bone, and so each vertex is affected by only one Bone.<br />In real bone animation, the vertices are affected by more than one bone using a weighting system.<br />That means that the body can be totally seamless ie a single mesh, or alternatively that the &quot;Seams&quot; between the body segments can be hidden by &quot;painting their weights&quot; so the model looks nicer &quot;when it bends&quot;.<br />The Quake-style MD3 is vertex animation of several objects, not real bone animation. The texture artists do a lot to hide the visual artifacts at seams.<br /><br /></div>
    <div class="meta">Posted on 2005-04-07 09:16:40 by Homer</div>
   </div>
  </div>
 </body>
</html>