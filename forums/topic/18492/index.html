<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Macro type safety, code optimization with OPATTR - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=18492" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=18492">Macro type safety, code optimization with OPATTR</a></p>
   <div class="post" id="post-143138">
    <div class="subject"><a href="#post-143138">Macro type safety, code optimization with OPATTR</a></div>
    <div class="body">I'm slowly learning this macro stuff.   This snipet from the MASM manual confuses me:<br /><pre><code><br />        IF CONST<br />        mov     bx, CONST    ; If CONST &gt; 0, move into BX<br />        ELSE<br />        sub     bx, bx       ; More efficient if CONST = 0<br />        ENDIF<br /></code></pre> <br />IF CONST(nothing)???<br /><br />Where is it specify to test IF CONST&gt;0?  To me it looks like IF CONST=true, or something like that.<br /><br />This make sense to me:<br /><pre><code><br />oad    MACRO reg&#58;REQ, adr&#58;REQ<br />    IF &#40;OPATTR &#40;adr&#41;&#41; AND 00010000y    ;; Register<br />        IFDIFI reg, adr                ;; Don??t load register<br />            mov     reg, adr           ;;   onto itself<br />        ENDIF<br />    ELSEIF &#40;OPATTR &#40;adr&#41;&#41; AND 00000100y<br />        mov     reg, adr               ;; Constant<br />    ELSEIF &#40;TYPE &#40;adr&#41; EQ BYTE&#41; OR &#40;TYPE &#40;adr&#41; EQ SBYTE&#41;<br />        mov    reg, OFFSET adr         ;; Bytes<br />    ELSEIF &#40;SIZE &#40;TYPE &#40;adr&#41;&#41; EQ 2<br />        mov    reg, adr                ;; Near pointer<br />    ELSEIF &#40;SIZE &#40;TYPE &#40;adr&#41;&#41; EQ 4<br />        mov    reg, WORD PTR adr&#91;0&#93;    ;; Far pointer<br />        mov    ds,  WORD PTR adr&#91;2&#93;<br />    ELSE<br />        .ERR &lt;Illegal argument&gt;<br />    ENDIF<br />ENDM<br /></code></pre> <br /><br />Thanks.</div>
    <div class="meta">Posted on 2004-06-07 14:53:49 by ThoughtCriminal</div>
   </div>
   <div class="post" id="post-143143">
    <div class="subject"><a href="#post-143143">Macro type safety, code optimization with OPATTR</a></div>
    <div class="body">&quot;IF CONST&quot; returns false when CONST is false, i.e. zero, and true when CONST is true, i.e. nonzero, what means greater than zero: if CONST &gt; 0 ;)<br />In other words, CONST is interpreted as boolean, even though is it symbolic constant. Someone says it is bad coding practice, other says it's nothing wrong. As you can see, it can confuses you. Better would be<br /><pre><code>IF CONST GT 0</code></pre> <br />Hope it helps.</div>
    <div class="meta">Posted on 2004-06-07 15:51:57 by MazeGen</div>
   </div>
   <div class="post" id="post-143242">
    <div class="subject"><a href="#post-143242">Macro type safety, code optimization with OPATTR</a></div>
    <div class="body">Test for dword ptr and error if offset?<br /><br />The meaning of the bits are not all clear to me:<br /><pre><code><br />Bit<br /><br /> Set If expression<br /> <br />0 References a code label<br /><br />1 Is a memory variable or has a relocatable data label<br /><br />2 Is an immediate value<br /><br />3 Uses direct memory addressing<br /><br />4 Is a register value<br /><br />5 References no undefined symbols and is without error<br /><br />6 Is relative to SS<br /><br />7 References an external label<br /><br />8 ? 10<br /><br /> Has the following language type&#58;<br /><br />   000 ? No language type<br /><br />   001 ? C<br /><br />   010 ? SYSCALL<br /><br />   011 ? STDCALL<br /><br />   100 ? Pascal<br /><br />   101 ? FORTRAN<br /><br />   110 ? Basic<br /> </code></pre> <br />My silly test code: I want i:REQ to always be an offset and j:REQ to be a reg,imm,or dword ptr<br /><br />foo and bar are both structures<br /><br /><pre><code><br />	_test MACRO  i&#58;REQ, j&#58;REQ<br />		mov eax,dword ptr&#91;i&#93;												<br />		push eax													<br />		mov eax,dword ptr&#91;eax&#93;												<br />	IF &#40;&#40;OPATTR &#40;j&#41;&#41; AND 00010000y&#41; OR &#40;&#40;OPATTR &#40;j&#41;&#41; AND 00000100y&#41;<br />		add eax,j<br />	ELSEIF &#40;OPATTR &#40;j&#41;&#41; AND 00001000y<br /><br />		add eax,dword ptr&#91;j&#93;												<br />	ELSE<br />		.ERR &lt;error&gt;<br />	ENDIF<br />		pop edx														<br />		pushfd														<br />		mov dword ptr&#91;edx&#93;,eax												<br />		pop dword ptr&#91;edx+8&#93;												<br />	ENDM		<br /></code></pre> <br /><br />I'm trying to get any valid call to look like:<br /><br />_test offset foo, dword ptr bar<br /><br />_test offset foo, (reg)<br /><br />_test offset foo, (imm)<br /><br />So far the only thing I made error is:<br /><br />_test offset foo, bar<br /><br />Is it even possible to test if the macro parameter is an offset or a pointer?<br /><br />Thanks.</div>
    <div class="meta">Posted on 2004-06-08 16:18:46 by ThoughtCriminal</div>
   </div>
   <div class="post" id="post-143329">
    <div class="subject"><a href="#post-143329">Macro type safety, code optimization with OPATTR</a></div>
    <div class="body">I had the same problem with addr. The only solution I've found...<br /><br /><pre><code>$IsAddr MACRO Operand&#58;REQ<br />    IF @SizeStr&#40;&lt;Operand&gt;&#41; GT 5     <br />        IFIDNI &lt;addr &gt;, @SubStr&#40;&lt;Operand&gt;, 1 , 5&#41;<br />            EXITM &lt;-1&gt;<br />        ENDIF<br />    ENDIF<br />    EXITM &lt;0&gt;<br />ENDM<br /><br />InitializeListHead MACRO ListHead&#58;REQ<br />local a<br />    IF $IsAddr&#40;ListHead&#41;<br />        a SUBSTR &lt;ListHead&gt;, 6<br />        IF &#40;OPATTR &#40;a&#41;&#41; AND 01000000y     ;; Is relative to SS<br />            lea eax, a<br />        ELSE<br />            mov eax, offset a<br />        ENDIF<br />    . . .<br />ENDM</code></pre><br /><br /><br />You can't recognize the type of &lt;offset something&gt; or &lt;dword ptr something&gt; using OPATTR because &lt;offset something&gt; or &lt;dword ptr something&gt; have no type! You can use OPATTR for something not for &lt;offset something&gt;.<br /><br />Try this (untested):<br /><br /><pre><code>$IsOffset MACRO Operand&#58;REQ<br />    IF @SizeStr&#40;&lt;Operand&gt;&#41; GT 7 <br />        IFIDNI &lt;offset &gt;, @SubStr&#40;&lt;Operand&gt;, 1 , 7&#41;<br />            EXITM &lt;-1&gt;<br />        ENDIF<br />    ENDIF<br />    EXITM &lt;0&gt;<br />ENDM<br /><br />$IsDwordPtr MACRO Operand&#58;REQ<br />    IF @SizeStr&#40;&lt;Operand&gt;&#41; GT 10    <br />        IFIDNI &lt;dword ptr &gt;, @SubStr&#40;&lt;Operand&gt;, 1 , 10&#41;<br />            EXITM &lt;-1&gt;<br />        ENDIF<br />    ENDIF<br />    EXITM &lt;0&gt;<br />ENDM<br /><br />_test MACRO  i&#58;REQ<br />    IF $IsOffset&#40;i&#41;<br />        ;; offset<br />    ELSEIF $IsDwordPtr&#40;i&#41;<br />        ;; dword ptr<br />    ELSE<br />        .ERR    <br />    ENDIF<br />ENDM</code></pre></div>
    <div class="meta">Posted on 2004-06-09 17:35:37 by Four-F</div>
   </div>
   <div class="post" id="post-143347">
    <div class="subject"><a href="#post-143347">Macro type safety, code optimization with OPATTR</a></div>
    <div class="body">Thanks.  In another post I made a small mcro to look at the output of OPATTR with different types etc:<br /><a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=18513">http://www.asmcommunity.net/board/index.php?topic=18513</a> <br /><pre><code><br />look MACRO i&#58;REQ<br />	local temp<br />	temp TEXTEQU %OPATTR &#40;i&#41;<br />	%ECHO temp<br />ENDM<br /></code></pre> <br /><pre><code><br />note foo and bar are STRUCTs&#58;<br /><br />look  dword ptr foo ----&gt; 42 or 101010b ;bit 0 References a code label<br />                                       ;bit 3 Uses direct memory addressing<br />                                       ;bit 5 References no undefined symbols and is without error<br /><br />look  offset bar ----&gt; 38 or 100110 ;bit 1 Is a memory variable or has a relocatable data label<br />                                    ;bit 2  Is an immediate value&lt;----This looks strange.<br />                                    ;bit 5 References no undefined symbols and is without error<br /><br /><br />look  bar    ----&gt; 42 ; same as dword ptr foo<br />look  bar.i   ----&gt; 42 ; same as dword ptr foo<br /></code></pre> <br />I tried it in some code and it seems there is a difference.</div>
    <div class="meta">Posted on 2004-06-09 23:34:59 by ThoughtCriminal</div>
   </div>
   <div class="post" id="post-143387">
    <div class="subject"><a href="#post-143387">Macro type safety, code optimization with OPATTR</a></div>
    <div class="body">I'm following this thread with interest, this will be good improvement to many existing macros :)<br /><br /><div class="quote"><br />;bit 2  Is an immediate value&lt;----This looks strange.</div><br />IMHO it's correct, an OFFSET is calculated at assembly time, and is also an immediate value. For example:<br /><br />add eax,offset foobar    ;here &quot;offset foobar&quot; is an immediate like any other numeric value</div>
    <div class="meta">Posted on 2004-06-10 12:19:35 by QvasiModo</div>
   </div>
   <div class="post" id="post-143399">
    <div class="subject"><a href="#post-143399">Macro type safety, code optimization with OPATTR</a></div>
    <div class="body">Yes I had to think about for a bit then I realized why an offest was also marked as immediate.<br /><br />Its an immediate offset :grin:</div>
    <div class="meta">Posted on 2004-06-10 13:11:27 by ThoughtCriminal</div>
   </div>
   <div class="post" id="post-143407">
    <div class="subject"><a href="#post-143407">Macro type safety, code optimization with OPATTR</a></div>
    <div class="body">Heres my test code using what I have learned:<br /><pre><code><br />	_test MACRO  i&#58;REQ, j&#58;REQ<br />	local err_val<br /><br />	IF  &#40;OPATTR &#40;i&#41;&#41; EQ 38<br />		mov eax,&#91;&#40;i&#41;&#93;	<br />	ELSE<br />		err_val TEXTEQU %OPATTR &#40;i&#41;<br />		%ECHO err_val<br />		.ERR &lt;First parameter is not an offset&gt;<br />	ENDIF<br /><br />		push eax			<br />		mov eax,dword ptr&#91;eax&#93;<br />	<br />	IF &#40;&#40;OPATTR &#40;j&#41;&#41; EQ 36&#41; OR &#40;&#40;OPATTR &#40;j&#41;&#41; EQ 48&#41;<br />		add eax,j<br />	ELSEIF &#40;&#40;OPATTR &#40;j&#41;&#41; EQ 42&#41;<br />		add eax,dword ptr&#91;j&#93;<br />	ELSE<br />		err_val TEXTEQU %OPATTR &#40;i&#41;<br />		%ECHO err_val<br />		.ERR &lt;Second parameter is not pointer, register or immediate&gt;<br />                ENDIF<br />		pop edx				<br />		pushfd					<br />		mov dword ptr&#91;edx&#93;,eax			<br />		pop dword ptr&#91;edx+8&#93;			<br />	ENDM<br /></code></pre> <br />The first if block test if it is an offset type. If it is not, print what error type was entered,<br /> and give an informative error.<br /><br />The second block tests first if it is a register or immediate type, <br />if not test if it is a pointer type, if not print what  error type was entered, and give <br />an informative error.<br /><br />Even better might be to make some equates:<br /><br />IMMEDIATE_TYPE = 36<br /><br />REGISTER_TYPE = 48<br /><br />GENERAL_TYPE = 42    ;data, structs,declared labels, and dword ptr are all same type.<br /><br />So you cant test if it is a structure or just dword data in your data section with OPATTR .<br /><br />Another problem is you cannot test which reg is used with OPATTR.  If eax is used in the above,<br /> you wont get what you expect.<br /><br />Thanks.<br /><br />Oops, forgot to post macro in this thred that I used to get type values from:<br /><pre><code><br />look MACRO i&#58;REQ<br />	local temp<br />	temp TEXTEQU %OPATTR &#40;i&#41;<br />	%ECHO temp<br />ENDM<br /></code></pre> <br />Just use like:<br /><br />look eax<br /><br />look offset foobar</div>
    <div class="meta">Posted on 2004-06-10 14:18:40 by ThoughtCriminal</div>
   </div>
  </div>
 </body>
</html>