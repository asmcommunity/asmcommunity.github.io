<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>TimedateStamp Question - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=18369" />
     </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=24">IDE usage &amp; development</a> &raquo; <a href="../?id=18369">TimedateStamp Question</a></p>
   <div class="post" id="post-142323">
    <div class="subject"><a href="#post-142323">TimedateStamp Question</a></div>
    <div class="body">Hi Guys,<br /><br />I?m trying to convert the value found on the TimeDateStamp member of the header....but iut?s not working.<br /><br />Anyone knows a way to convert the timedatestamp to string ?<br /><br />The format should contains the year, month day, hour, minutes and seconds...<br /><br />I?m pointing the file to the FileHeader.TimeDateStamp and when the data is found, i have his result (0989868, for example), the problem is i can?t convert it to string.<br /><br />The data is being outputed on a edit box.<br /><br />This is part of the code;<br /><br /><br /><br /><pre><code><br />&#91;My_Fmt&#58; B$ &quot;%08lX&quot; 0&#93;<br />&#91;My_Buffer&#58; B$ 0 #256&#93;<br /><br /><br />&#91;Sz_Year&#58; B$ &quot;yyyy/MM/dd ddd &quot;,0&#93; ; This format should be joined together with the one below<br />&#91;Sz_Hour&#58; B$ &quot;HH&#58;mm&#58;ss UTC&quot;,0&#93;   ; So, both will be displayed in the edit box.<br /><br /><br />    ; Time Date Stamp<br />    C_call 'USER32.wsprintfA' My_Buffer My_Fmt D$edi+FileHeader.TimeDateStampDis ; This is the same as the assume instruction in masm.<br />    call 'USER32.SendDlgItemMessageA' D@hWnd IDC_TIMESTAMP &amp;WM_SETTEXT 0 My_Buffer<br /><br />        ; Time date stamp signature string<br />        ;mov edx D$edi+FileHeader.TimeDateStampDis<br /><br />        call GetTime D$My_Buffer ; This is the function that needs to be implemented.<br /><br />        call 'USER32.SendDlgItemMessageA' D@hWnd IDC_TIMESTAMPSTRING &amp;WM_SETTEXT 0 datebuff;My_Buffer<br /><br /><br />        <br />    ; Symbol Table Pointer<br />    C_call 'USER32.wsprintfA' My_Buffer My_Fmt D$edi+FileHeader.PointerToSymbolTableDis<br />    call 'USER32.SendDlgItemMessageA' D@hWnd IDC_SYMTBLPTR &amp;WM_SETTEXT 0 My_Buffer<br /></code></pre><br /><br /><br />The converted string needs to take into account all the possible things on a regular calendar, i mean, like the months containing 31 days, or 28 (or 29 in bisixth years - february)<br /><br />I tried several different ways and nothing is working...can someone write a functioning function that can translate the timedata to string ?<br /><br />Best Regards,<br /><br />Guga</div>
    <div class="meta">Posted on 2004-05-28 12:47:17 by Beyond2000!</div>
   </div>
   <div class="post" id="post-142324">
    <div class="subject"><a href="#post-142324">TimedateStamp Question</a></div>
    <div class="body">You would generally convert a filetime to systemtime then use the GetDateFormat and GetTimeFormat functions to convert that to readable text...<br /><br /><pre><code>ftCreate FILETIME &lt;&gt;<br />ftAccess FILETIME &lt;&gt;<br />ftWrite FILETIME &lt;&gt;<br />stUTC SYSTEMTIME &lt;&gt;<br />stLocal SYSTEMTIME &lt;&gt;<br /><br />szDateString db 64 DUP &#40;?&#41;<br />szTimeString db 64 DUP &#40;?&#41;<br /><br />.code<br /><br />invoke GetFileTime,&#91;hFile&#93;, offset ftCreate, offset ftAccess, offset ftWrite<br />invoke FileTimeToSystemTime, offset ftCreate, offset stUTC<br />; convert UTC file time to local timezone ...<br />invoke SystemTimeToTzSpecificLocalTime, NULL, offset stUTC, offset stLocal<br /><br />invoke GetDateFormat,LOCALE_SYSTEM_DEFAULT,NULL,\<br />		OFFSET stLocal,&quot;dd MMM yyyy&quot;,OFFSET szDateString,64<br /><br />invoke GetTimeFormat,LOCALE_SYSTEM_DEFAULT,NULL,\<br />		OFFSET stLocal,&quot;hh&#58;mm tt&quot;,OFFSET szTimeString,64</code></pre></div>
    <div class="meta">Posted on 2004-05-28 13:11:39 by donkey</div>
   </div>
   <div class="post" id="post-142473">
    <div class="subject"><a href="#post-142473">TimedateStamp Question</a></div>
    <div class="body">Tks  Egdar :)<br /><br />But it is not working...i tried the way you told, but the result is zero.<br /><br />Not sure what i?m doing wrong yet.<br /><br />You told to insert the hFile data, and then i modified it to hold the data grabbed from the header. I mean, like in peView (From Wayne Bradbury)....loading 3dframes, results in 03836401D as the data fro Time Stamp.<br /><br />I used this value as the handle (hFile), since i found nowhere else to insert it on your code...But the result was zero.<br /><br />On My coide, &quot;My_Buffer&quot; hold this value....So, i have to use the &quot;hFile&quot; as the &quot;hWnd&quot; (in my code) ? I mean, using the handle found in the parameters in the beginning of the functino ?<br /><br />If yes, why ? Hoe the gettime function will now how and what is the data to be translated ? (I mean, how he will get the value of 03836401D ?)<br /><br /><br />Best Regards,<br /><br />Guga</div>
    <div class="meta">Posted on 2004-05-29 23:41:57 by Beyond2000!</div>
   </div>
   <div class="post" id="post-142476">
    <div class="subject"><a href="#post-142476">TimedateStamp Question</a></div>
    <div class="body">Hi Guga,<br /><br />Where exactly is the date stamp coming from ? Is it from inside the PE file ? If so what is the FileHeader structure you are talking about, all PE structures begin with IMAGE_xxx. If you could explain where it comes from I could look up the reference material and do somthing for you. The code I posted is to get the file time from the Windows Shell, you open the file with CreateFile and pass the resulting handle (hFile) to the function.</div>
    <div class="meta">Posted on 2004-05-30 00:26:36 by donkey</div>
   </div>
   <div class="post" id="post-142477">
    <div class="subject"><a href="#post-142477">TimedateStamp Question</a></div>
    <div class="body"><pre><code>ftCreate FILETIME &lt;&gt;<br />ftAccess FILETIME &lt;&gt;<br />ftWrite FILETIME &lt;&gt;<br />stUTC SYSTEMTIME &lt;&gt;<br />stLocal SYSTEMTIME &lt;&gt;<br /><br />szDateString db 64 DUP &#40;?&#41;<br />szTimeString db 64 DUP &#40;?&#41;<br /><br />hFile DD ?<br /><br />.code<br /><br />invoke CreateFile, offset FileName, GENERIC_READ, 0, 0, OPEN_EXISTING, 0, 0<br />mov &#91;hFile&#93;,eax<br /><br />invoke GetFileTime,&#91;hFile&#93;, offset ftCreate, offset ftAccess, offset ftWrite<br /><br />invoke CloseHandle, &#91;hFile&#93;<br /><br />invoke FileTimeToSystemTime, offset ftCreate, offset stUTC<br />; convert UTC file time to local timezone ...<br />invoke SystemTimeToTzSpecificLocalTime, NULL, offset stUTC, offset stLocal<br /><br />invoke GetDateFormat,LOCALE_SYSTEM_DEFAULT,NULL,\<br />		OFFSET stLocal,&quot;dd MMM yyyy&quot;,OFFSET szDateString,64<br /><br />invoke GetTimeFormat,LOCALE_SYSTEM_DEFAULT,NULL,\<br />		OFFSET stLocal,&quot;hh&#58;mm tt&quot;,OFFSET szTimeString,64</code></pre></div>
    <div class="meta">Posted on 2004-05-30 00:29:16 by donkey</div>
   </div>
   <div class="post" id="post-142481">
    <div class="subject"><a href="#post-142481">TimedateStamp Question</a></div>
    <div class="body">Hi Edgar,<br /><br />it comes from inside the PE...It belongs to IMAGE_FILE_HANDER.<br /><br />The structure is like this:<br /><br /><br /><br />Basically the part of the code that get the value is from here:<br /><br /><pre><code><br /><br />Proc DlgProc&#58;<br />    Arguments @hWin, @uMsg, @wParam, @lParam<br /><br />    <br />    ...If D@uMsg = &amp;WM_COMMAND<br /><br />        ..If D@wParam = IDB_OPEN<br /><br />            call 'comdlg32.GetOpenFileNameA' ofn<br /><br />            .If eax = &amp;TRUE<br /><br />                call 'USER32.SendDlgItemMessageA' D@hWin IDC_OPENPEFILE &amp;WM_SETTEXT 0 filename<br /><br />                call 'USER32.SendDlgItemMessageA' D@hWin IDC_OPENPEFILE &amp;WM_GETTEXT 256 filename ; GET THE FILENAME<br />                call OpenPEFile D@hWin filename ; ----&gt; Opens the file<br /><br />            .End_If<br />        <br />        ..End_If<br /><br />&#40;..................&#41;<br /><br />Proc OpenPEFile&#58;<br />    Arguments @hWnd, @szTargetPEFile<br /><br />    pushad<br />    call 'KERNEL32.CreateFileA' D@szTargetPEFile &amp;GENERIC_READ+&amp;GENERIC_WRITE &amp;NULL 0 &amp;OPEN_EXISTING &amp;FILE_ATTRIBUTE_NORMAL &amp;NULL<br />    mov D$hFile eax<br /><br />    If eax = &amp;INVALID_HANDLE_VALUE<br /><br />       call Error D$Err_hWnd FileOpenError<br />       call CleanMem<br />       Exit<br /><br />    End_If<br /><br />    call 'KERNEL32.CreateFileMappingA' D$hFile 0 &amp;PAGE_READWRITE 0 0 0<br />    mov D$hMem eax<br /><br />    If eax = &amp;NULL<br /><br />       call Error D$Err_hWnd FileMapError<br />       call CleanMem<br />       Exit<br /><br />    End_If<br /><br />    call 'KERNEL32.MapViewOfFile' D$hMem &amp;FILE_MAP_WRITE 0 0 0<br />    mov D$pMem eax<br /><br />    If eax = &amp;NULL<br /><br />       call Error D$Err_hWnd FileMapError<br />       call CleanMem<br />       Exit<br /><br />    End_If<br /><br />    mov edi D$pMem<br /><br />    If W$edi &lt;&gt; 'MZ' ; CHECK FOR DOS SIGNATURE 'MZ'<br /><br />        call Error D$Err_hWnd PEError<br />        call CleanMem<br />        Exit<br /><br />    End_If<br /><br />    call ShowMZInfo D$hTabDlg1 D$pMem ; SHOW ALL MZ INFO in the 1st Tab dialog...<br /><br />    add edi D$edi+e_lfanewDis ; 3Ch IS WHERE THE ADDRESS OF THE PE HEADER IS SAVED<br /><br />    If W$edi &lt;&gt; 'PE' ; CHECK FOR WIN32 SIGNATURE 'PE'<br /><br />        call Error D$Err_hWnd PEError<br />        call CleanMem<br />        Exit<br /><br />    End_If<br /><br />    call ShowPEInfo D$hTabDlg2 D$pMem ; SHOW ALL PE INFO in the 2nd Tab dialog...<br />    popad<br /><br />EndP<br /><br /><br />&#40;....&#41;<br /><br /><br />Proc ShowPEInfo&#58;<br />    Arguments @hWnd, @PEFileMem<br /><br />    mov edi D@PEFileMem<br />    add edi D$edi+e_lfanewDis ; GET THE PE HEADER<br /><br />    ; PE Signature<br />    C_call 'USER32.wsprintfA' zoen_buf zoen_fmt D$edi+SignatureDis<br />    call 'USER32.SendDlgItemMessageA' D@hWnd IDC_PESIG &amp;WM_SETTEXT 0 zoen_buf<br /><br />    ; CPU TYPE<br />    movzx esi W$edi+FileHeader.MachineDis<br />    C_call 'USER32.wsprintfA' zoen_buf zoen_fmt esi<br />    call 'USER32.SendDlgItemMessageA' D@hWnd IDC_CPUTYPE &amp;WM_SETTEXT 0 zoen_buf<br /><br />    ; NUMBER OF SECTIONS<br />    movzx esi W$edi+FileHeader.NumberOfSectionsDis<br />    C_call 'USER32.wsprintfA' zoen_buf zoen_fmt esi<br />    call 'USER32.SendDlgItemMessageA' D@hWnd IDC_SECTION &amp;WM_SETTEXT 0 zoen_buf<br /><br />    ; Time Date Stamp<br />    C_call 'USER32.wsprintfA' zoen_buf zoen_fmt D$edi+FileHeader.TimeDateStampDis<br />    call 'USER32.SendDlgItemMessageA' D@hWnd IDC_TIMESTAMP &amp;WM_SETTEXT 0 zoen_buf<br /><br />        ; Time date stamp signature string<br />;        mov edx D$edi+FileHeader.TimeDateStampDis ?????????<br />        lea eax D$zoen_buf ???????<br />        call GetTime ???????????? How ?<br /><br />        call 'USER32.SendDlgItemMessageA' D@hWnd IDC_TIMESTAMPSTRING &amp;WM_SETTEXT 0 datebuff;zoen_buf<br /><br /></code></pre><br /><br />This file was origanlly coded by avl!s...The file below is where i got so far.<br />There are several things to be implemented.So, on the 3rd tab the directory entries names are not yet valid ...I?ll parse them as long i finish understanding and fixing the time stamp thing.<br /><br /><br />Best Regards,<br /><br />Guga</div>
    <div class="meta">Posted on 2004-05-30 01:45:31 by Beyond2000!</div>
   </div>
   <div class="post" id="post-142498">
    <div class="subject"><a href="#post-142498">TimedateStamp Question</a></div>
    <div class="body">Ah, OK that is completely different, <br /><br /><div class="quote">TimeDateStamp (DWORD)<br /><br />Time stamp of the image. This represents the date and time the image was created by the linker. The value is represented in the number of seconds elapsed since midnight (00:00:00), January 1, 1970, Universal Coordinated Time, according to the system clock. </div><br /><br />There is no time function that I know of to make the conversion but I will look for something. You will have to get it into a SYSTEMTIME structure eventually but how to do that is something I am not familiar with. I will have a look through MSDN.</div>
    <div class="meta">Posted on 2004-05-30 09:53:52 by donkey</div>
   </div>
   <div class="post" id="post-142510">
    <div class="subject"><a href="#post-142510">TimedateStamp Question</a></div>
    <div class="body">Hi Guga,<br /><br />This will do it.<br /><br /><pre><code>BaseTimeLow equ 0D53E8000h<br />BaseTimeHigh equ 19DB1DEh<br /><br />.data<br />ftTimeStamp FILETIME &lt;&gt;<br /><br />stUTC SYSTEMTIME &lt;&gt;<br />stLocal SYSTEMTIME &lt;&gt;<br /><br />szDateString db 64 DUP &#40;?&#41;<br />szTimeString db 64 DUP &#40;?&#41;<br /><br />.code<br /><br />mov eax,&#91;TimeStamp&#93;<br />mov edx,10000000<br />mul edx<br />add eax,BaseTimeLow<br />adc edx,BaseTimeHigh<br /><br />mov &#91;ftTimeStamp&#93;,eax<br />mov &#91;ftTimeStamp+4&#93;,edx<br /><br />invoke FileTimeToSystemTime, offset ftTimeStamp, offset stUTC<br />; convert UTC file time to local timezone &#40;NT only&#41; ...<br />invoke SystemTimeToTzSpecificLocalTime, NULL, offset stUTC, offset stLocal<br /><br />invoke GetDateFormat, LOCALE_SYSTEM_DEFAULT, NULL,\<br />		OFFSET stLocal, &quot;dd MMM yyyy&quot;, OFFSET szDateString, 64<br /><br />invoke GetTimeFormat, LOCALE_SYSTEM_DEFAULT, NULL,\<br />		OFFSET stLocal, &quot;hh&#58;mm tt&quot;, OFFSET szTimeString, 64</code></pre><br /><br />Edit forgot the data decalrations...</div>
    <div class="meta">Posted on 2004-05-30 11:46:10 by donkey</div>
   </div>
   <div class="post" id="post-142523">
    <div class="subject"><a href="#post-142523">TimedateStamp Question</a></div>
    <div class="body">BTW Guga,<br /><br />If you want to go from FileTime to DateStamp for any reason this will do it...<br /><br /><pre><code>FileTime2DateStamp FRAME pFileTime<br />	<br />	mov ecx,&#91;pFileTime&#93;<br />	mov eax,&#91;ecx&#93;<br />	mov edx,&#91;ecx+4&#93;<br />	sub eax, BaseTimeLow <br />	sbb edx, BaseTimeHigh<br /><br />	mov ecx,10000000<br />	div ecx<br /><br />	RET<br />ENDF</code></pre></div>
    <div class="meta">Posted on 2004-05-30 19:20:22 by donkey</div>
   </div>
   <div class="post" id="post-142525">
    <div class="subject"><a href="#post-142525">TimedateStamp Question</a></div>
    <div class="body">Hi Edgar,<br /><br />tks again :) But this function only works on windows NT or windows2000....and not to win95 or 98 etc...<br /><br /><br />I did some adaptations and now the file is fully working. I was pointing incorrectly to the data stamp.<br /><br />The changes are here:<br /><br /><pre><code><br />    ; Time Date Stamp<br />    <br />    C_call 'USER32.wsprintfA' zoen_buf zoen_fmt D$edi+FileHeader.TimeDateStampDis<br />    call 'USER32.SendDlgItemMessageA' D@hWnd IDC_TIMESTAMP &amp;WM_SETTEXT 0 zoen_buf<br /><br />      mov eax D$edi+FileHeader.TimeDateStampDis ; Wahooooo !!! BINGO!! 03836401D<br />      xor edx edx<br />      mov ecx 10000000<br />      mul ecx<br />                   <br />        add     eax 0D53E8000<br />        adc     edx 019DB1DE<br /><br />        mov D$ftTimeStamp.dwLowDateTime eax<br />        mov D$ftTimeStamp.dwHighDateTime edx<br />        <br />        call 'kernel32.FileTimeToSystemTime' ftTimeStamp stLocal<br />        call 'KERNEL32.GetDateFormatA' &amp;LOCALE_SYSTEM_DEFAULT &amp;NULL stLocal Sz_Year2 szDateString 64<br />        call 'KERNEL32.GetTimeFormatA' &amp;LOCALE_SYSTEM_DEFAULT &amp;NULL stLocal Sz_Hour2 szTimeString 64<br /><br />        C_call 'USER32.wsprintfA' zoen_buf zoen_fmt3 szDateString szTimeString        <br />        call 'USER32.SendDlgItemMessageA' D@hWnd IDC_TIMESTAMPSTRING &amp;WM_SETTEXT 0 zoen_buf<br />       <br />    ; Symbol Table Pointer<br />    C_call 'USER32.wsprintfA' zoen_buf zoen_fmt D$edi+FileHeader.PointerToSymbolTableDis<br />    call 'USER32.SendDlgItemMessageA' D@hWnd IDC_SYMTBLPTR &amp;WM_SETTEXT 0 zoen_buf<br /><br /></code></pre><br /><br />This versino should work on windows95, 98, ME NT, 2000.<br /><br />I?ll clean the code and build an functino for it (Instead an inner routine), and then i?ll try to tst the files which has the date stamp older then 1970....Liuke those weird ones from 1690 or something.<br /><br />Tks a LOT for the help Edgar.<br /><br />When i finish the 1st cleanintgs and tests i?ll post here the resutls....I guess it won?t be hard to find some errors on older timedate stamp (I hope so :) )<br /><br />Best Regards,<br /><br />Guga</div>
    <div class="meta">Posted on 2004-05-30 21:39:08 by Beyond2000!</div>
   </div>
   <div class="post" id="post-142527">
    <div class="subject"><a href="#post-142527">TimedateStamp Question</a></div>
    <div class="body">Hi Guga,<br /><br />As I said you have only to remove the conversion to local time...<br /><br /><pre><code>BaseTimeLow equ 0D53E8000h<br />BaseTimeHigh equ 19DB1DEh<br /><br />.data<br />ftTimeStamp FILETIME &lt;&gt;<br /><br />stUTC SYSTEMTIME &lt;&gt;<br />stLocal SYSTEMTIME &lt;&gt;<br /><br />szDateString db 64 DUP &#40;?&#41;<br />szTimeString db 64 DUP &#40;?&#41;<br /><br />.code<br /><br />mov eax,&#91;TimeStamp&#93;<br />mov edx,10000000<br />mul edx<br />add eax,BaseTimeLow<br />adc edx,BaseTimeHigh<br /><br />mov &#91;ftTimeStamp&#93;,eax<br />mov &#91;ftTimeStamp+4&#93;,edx<br /><br />invoke FileTimeToSystemTime, offset ftTimeStamp, offset stUTC<br /><br />invoke GetDateFormat, LOCALE_SYSTEM_DEFAULT, NULL,\<br />		OFFSET stUTC, &quot;dd MMM yyyy&quot;, OFFSET szDateString, 64<br /><br />invoke GetTimeFormat, LOCALE_SYSTEM_DEFAULT, NULL,\<br />		OFFSET stUTC, &quot;hh&#58;mm tt&quot;, OFFSET szTimeString, 64</code></pre><br /><br /><div class="quote">I?ll clean the code and build an functino for it (Instead an inner routine), and then i?ll try to tst the files which has the date stamp older then 1970....Liuke those weird ones from 1690 or something.</div><br /><br />It is not possible to have a datestamp prior to January 1, 1970, so there is no need to worry about them.</div>
    <div class="meta">Posted on 2004-05-30 22:21:32 by donkey</div>
   </div>
   <div class="post" id="post-142583">
    <div class="subject"><a href="#post-142583">TimedateStamp Question</a></div>
    <div class="body">Better to make a check for invalid entries. Who knows what some people save into it. ;)</div>
    <div class="meta">Posted on 2004-05-31 19:32:22 by JimmyClif</div>
   </div>
  </div>
 </body>
</html>