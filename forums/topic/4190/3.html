<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Self-Deleting Program - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=4190" />
  <link rel="prev" href="../?id=4190&amp;page=2" />   </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=4190">Self-Deleting Program</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=4190&amp;page=1" style="">&laquo;</a><a href="../?id=4190&amp;page=2" style="">&lt;</a><input type="hidden" name="id" value="4190" /><input type="number" name="page" min="1" max="3" step="1" value="3" onchange="this.form.submit();" /></form>   <div class="post" id="post-138400">
    <div class="subject"><a href="#post-138400">A note on self deleting BATfile under Win 9x</a></div>
    <div class="body">Hi Folks !<br />This is a comment after reading the sticky thread <a target="_blank" href="http://www.asmcommunity.net/board/index.php?topic=4190">http://www.asmcommunity.net/board/index.php?topic=4190</a> <br />in the FAQ - about self-deleting progs. Namely I will add something about <br />self deleting .BATs under Win 9x.<br /><br />In the above referenced thread it says like a simple batfile that deletes itself <br />will still leave its WinoldAp instance running after it exits. But there is a simple <br />way out which was maybe worth mentionning however ecvident (too evident ;=) <br /><br />Create a .PIF file along with the bat with the property &quot;close widow at exit&quot;.<br />From inside the BAT,  DELete the .PIF before self DELeting the  BAT !<br /><br />Then running either of BAT or associated PIF will delete both files and exit properly...<br /><br />I would easily believe there's a way to hack the &quot;close (winoldapp) window on exit&quot; property <br />without bothering to have a PIF setup, though there's no need to bother IMO.<br /><br />Good day ! <br /><br />-- <br />Czerno</div>
    <div class="meta">Posted on 2004-04-09 05:46:44 by Czerno</div>
   </div>
   <div class="post" id="post-209585">
    <div class="subject"><a href="#post-209585">Re: Self-Deleting Program</a></div>
    <div class="body">I found a self-deleting program.<br /><br /><pre><code><br />; uninstall.asm Possible use in an uninstaller - deletes itself when run<br />;<br />.386<br /><br />.model flat, stdcall<br /><br />option casemap:none<br /><br />include \masm32\include\windows.inc<br /> &nbsp; &nbsp;include \masm32\include\user32.inc<br /> &nbsp; &nbsp;include \masm32\include\kernel32.inc<br /> &nbsp; &nbsp;include \masm32\include\advapi32.inc<br /> &nbsp; &nbsp;include \masm32\include\shlwapi.inc<br /> &nbsp; &nbsp;include \masm32\include\shell32.inc<br /> &nbsp; &nbsp;include \masm32\macros\macros.asm<br /><br /> &nbsp; &nbsp;includelib &nbsp;\masm32\lib\shell32.lib<br /> &nbsp; &nbsp;includelib &nbsp;\masm32\lib\kernel32.lib<br /> &nbsp; &nbsp;includelib &nbsp;\masm32\lib\user32.lib<br /> &nbsp; &nbsp;includelib &nbsp;\masm32\lib\advapi32.lib<br /> &nbsp; &nbsp;includelib &nbsp;\masm32\lib\shlwapi<br /> &nbsp; &nbsp;<br />.data<br /><br />align 4<br />sinfo			STARTUPINFO	{sizeof STARTUPINFO,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}<br />szDelete		db			&quot;/c del &quot;,0<br />szNull		db			&quot; &gt;&gt; NUL&quot;,0<br />szComSpec		db			&quot;ComSpec&quot;,0<br />szPrefix		db			&quot;Cln&quot;,0<br />szCmdLine		db			&quot;%s %d %s&quot;,0<br /><br />.data?<br /><br />pinfo			PROCESS_INFORMATION		{?}<br />szExeName		db	 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 		MAX_PATH	dup (?)<br />szClone		db			 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MAX_PATH	dup (?)<br />szCmd			db			 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;512 dup (?)<br />hProcessOrig	HANDLE		 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;?<br /><br />.code<br /><br />start:<br /><br /> 	;---------------------------------------------------------------<br />	; Get the Commandline<br />	;---------------------------------------------------------------<br /><br />	Invoke	GetCommandLine<br />	push	esi<br />	mov		esi, eax<br /><br />	;---------------------------------------------------------------	<br />	; Load the application name<br />	;---------------------------------------------------------------<br />	<br />	; 22h = the &quot; character ie. We have a long pathname<br />	; that includes spaces<br />	cmp		byte ptr , 22h<br />	jne		BypassExeName<br />	inc		esi	; Bypass the &quot;<br />	lea		ecx, szExeName<br /><br />	; While the byte pointed to by eax isn&#039;t a &quot;...<br />BypassFullPath:<br />	cmp		byte ptr , 22h<br />	je		AddNullTerminator<br />	mov		dl, <br />	mov		byte ptr , dl<br />	inc		esi<br />	inc		ecx<br />	jmp		BypassFullPath<br />	<br />	AddNullTerminator:<br />	mov		byte ptr , 0<br />	jmp		BypassWhitespace<br /><br />	; short pathname that doesn&#039;t include spaces<br />BypassExeName:<br />	Invoke	GetModuleFileName, NULL, addr szExeName, MAX_PATH<br />	add		esi, 9 ; the commandline must be at least 9 chars long<br /><br />	BypassExeNameLoop:<br />	cmp		byte ptr , 20h ; space character<br />	je		BypassWhitespace<br />	cmp		byte ptr , 0<br />	je		firstTimeExeRun<br />	inc		esi<br />	jmp		BypassExeNameLoop<br /><br />BypassWhitespace:<br />	inc		esi<br />	cmp		byte ptr , 20h<br />	je		BypassWhitespace<br /><br />	; eax will point to the first argument (if there is one)<br />	cmp		byte ptr , 0<br />	je		firstTimeExeRun<br /><br /><br />	;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	<br />	; This is the cloned version - do the uninstall<br />	; and then delete self<br />	;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	<br /><br />	;---------------------------------------------------------------	<br />	; Convert the second commandline parameter to a number<br />	;---------------------------------------------------------------	<br /><br />	xor		eax, eax<br />	mov		ecx, 10<br />	<br />atoi:<br />	add		al, <br />	inc		esi<br />	sub		eax, 30h<br />	cmp		byte ptr , 20h ; space character<br />	je		MovProcessOrig<br />	mul		ecx<br />	jmp		atoi<br />	<br />MovProcessOrig:<br />	mov		hProcessOrig, eax<br />	<br />BypassWhitespace2:<br />	inc		esi<br />	cmp		byte ptr , 20h<br />	je		BypassWhitespace2<br />	<br />	; Wait for the first instance to finish running<br />	Invoke	WaitForSingleObject, eax, INFINITE<br />	Invoke	CloseHandle, hProcessOrig<br />	Invoke	DeleteFile, esi<br />	pop		esi<br /><br />	; Remove the application file(s)<br /><br />	; Remove data files<br /><br />	; Remove directory - directory must be empty or RemoveDirectory will fail<br /><br />	; Remove registry entries<br /><br />	; Remove start menu links<br /><br />	; Uninstall complete and successful(!)<br />	<br />	;---------------------------------------------------------------	<br />	; Attempt to quietly delete this file<br />	;---------------------------------------------------------------	<br /><br />	Invoke	GetShortPathName, addr szExeName, addr szExeName, MAX_PATH<br />	or		eax, eax<br />	jz		ExitProc<br />	Invoke	lstrcpy, addr szCmd, addr szDelete<br />	Invoke	lstrcat, addr szCmd, addr szExeName<br />	Invoke	lstrcat, addr szCmd, addr szNull;<br /><br />	Invoke	GetEnvironmentVariable, addr szComSpec, addr szExeName, MAX_PATH<br />	or		eax, eax<br />	jz		ExitProc<br />	Invoke	ShellExecute, 0, 0, addr szExeName, addr szCmd, 0, SW_HIDE<br />	jmp		ExitProc<br /><br /><br />	;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	<br />	; This is the first time the .exe has run - spawn the clone<br />	;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	<br /><br />firstTimeExeRun:<br />	Invoke	GetTempPath, MAX_PATH, addr szClone<br />	Invoke	GetTempFileName, addr szClone, addr szPrefix, 0, addr szClone<br />	Invoke	CopyFile, addr szExeName, addr szClone, FALSE<br /><br />	; Create the clone process<br />	Invoke	GetCurrentProcessId<br />	Invoke	OpenProcess, SYNCHRONIZE, TRUE, eax<br />	Invoke	wsprintf, addr szCmd, addr szCmdLine, addr szClone, eax, addr szExeName<br />	Invoke	CreateProcess, NULL, addr szCmd, NULL, NULL, TRUE, 0, NULL, NULL, addr sinfo, addr pinfo<br />	Invoke	CloseHandle, pinfo.hProcess<br />	Invoke	CloseHandle, pinfo.hThread<br />	; This original process can now terminate<br /><br />ExitProc:<br />	Invoke	ExitProcess, 0<br /><br />end start<br /></code></pre><br /><br />edit: added code tag</div>
    <div class="meta">Posted on 2009-11-11 19:48:06 by skywalker</div>
   </div>
   <div class="post" id="post-209592">
    <div class="subject"><a href="#post-209592">Re: Self-Deleting Program</a></div>
    <div class="body">system(&quot;killall APP_NAME; rm APP_PATH/APP_NAME&quot;);<br />Works on Linux.<br /><br />Not sure if the MSVCRT.system() lets you execute more than 1 command.<br /><br />In any case, you guys are trying too hard :D <br /><br />4 KB files and Temp directories; why not throw in CreateRemoteThread</div>
    <div class="meta">Posted on 2009-11-12 14:07:39 by r22</div>
   </div>
   <div class="post" id="post-209596">
    <div class="subject"><a href="#post-209596">Re: Self-Deleting Program</a></div>
    <div class="body"><div class="quote">In any case, you guys are trying too hard :D <br /><br />4 KB files and Temp directories;</div>Exactly - combined with a MoveFileEx() with MOVEFILE_DELAY_UNTIL_REBOOT set.<br /><br /><div class="quote">why not throw in CreateRemoteThread</div>Can&#039;t recommend that, as HIPS could very well see this as suspicious behavior.</div>
    <div class="meta">Posted on 2009-11-13 01:09:56 by f0dder</div>
   </div>
   <div class="post" id="post-209600">
    <div class="subject"><a href="#post-209600">Re: Self-Deleting Program</a></div>
    <div class="body"><div class="quote"><br />system(&quot;killall APP_NAME; rm APP_PATH/APP_NAME&quot;);<br />Works on Linux.</div><br /><br />Lol, it would even work without the killall :)<br />Linux doesn&#039;t really care if you pull the rug from under it :)<br />(or most other *nix flavours for that matter, including my own poison: FreeBSD).</div>
    <div class="meta">Posted on 2009-11-13 04:07:31 by Scali</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=4190&amp;page=1" style="">&laquo;</a><a href="../?id=4190&amp;page=2" style="">&lt;</a><input type="hidden" name="id" value="4190" /><input type="number" name="page" min="1" max="3" step="1" value="3" onchange="this.form.submit();" /></form>  </div>
 </body>
</html>