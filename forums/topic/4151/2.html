<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Vbasm - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=4151" />
  <link rel="prev" href="../?id=4151&amp;page=1" />   </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=4151">Vbasm</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=4151&amp;page=1" style="">&laquo;</a><a href="../?id=4151&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="4151" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>   <div class="post" id="post-28815">
    <div class="subject"><a href="#post-28815">Vbasm</a></div>
    <div class="body">It's interesting to know that Windows doesn't let you define the segment to set ZERO based tables. (Well yea, I guess you could say that VB is a Windows-based platform. Sorry, thanks for the tip.) You are already proving to me that WIN32 ASM requires some finesse that I did not just bring into this project.<br /><br />rcl BYTE PTR [ 1 + REGS +_R24], 1<br /><br />There is a simple convention I need to learn about regarding how to use mnemonics with this operand :<br /><br />BYTE PTR [ 1 + REGS +_R24]<br /><br />Once I am fluent with it then I'll be able to do some BYTE programming in WIN32.<br /><br />///<br /><br />I don't know if Windows forces me to code into the indexing method that selects the SBOX values, instructions that will add a carry bit to the higher order indexing value.<br /><br />The SBOX is 256 bytes and ideally could be SETUP in a zero based table in its own segment. Under Windows its not possible.<br /><br />The other 6 tables require 64 bytes each. Crossing segment boundaries in derived indexing better not be a problem. I am sure there is a CORRECT way to program these methods if I'm unable to define segments to ZERO-base the index value.<br /><br />In 32-bit mode I guess it is possible to just do:<br /><br />mov ax,  and Viola! a value from the table.<br /><br />If al holds a value 0 to 255<br /><br />mov al, BYTE PTR [ DECODE + al]<br /><br />al now holds the SBOX value?<br /><br />HEY!<br /><br />-AV-</div>
    <div class="meta">Posted on 2002-03-13 13:27:10 by avrster</div>
   </div>
   <div class="post" id="post-28819">
    <div class="subject"><a href="#post-28819">Vbasm</a></div>
    <div class="body">Typically you will set a register to the address of the table and then index from that address with another register.<br /><br />mov al, <br /><br />In this way ESI becomes the base, and the offset ECX is the dynamic zero based offset, and this allows a constant offset as well - very flexible.<br /><br />This would be more better under windows:<br /><br />; initialize EAX to zero<br />xor eax,eax ; and eax, 0 ; mov eax, 0<br /><br />mov al, <br /><br />mov al, eax</strong>]<br /><br />You want to use 32-bit addressing.<br /><br />I didn't want to assume you were using Windows. :tongue:</div>
    <div class="meta">Posted on 2002-03-13 13:45:47 by bitRAKE</div>
   </div>
   <div class="post" id="post-28826">
    <div class="subject"><a href="#post-28826">Carry Bit manipulation</a></div>
    <div class="body">In Win32 I might  as well setup the tables as BYTE values. I assume that memory will then hold consecutive values.  (?)<br /><br />.DATA  Use32 Byte Public 'SBOX'  ;256 bytes<br />.DATA  Use32 Byte Public 'MOD0101' ; 64 bytes <br />.DATA  Use32 Byte Public 'EXP0101' ; 64 bytes <br />.DATA  Use32 Byte Public 'MOD0102' ; 64 bytes <br />.DATA  Use32 Byte Public 'MOD0801' ; 64 bytes <br />.DATA  Use32 Byte Public 'EXP0801' ; 64 bytes <br />.DATA  Use32 Byte Public 'MOD0802' ; 64 bytes<br /><br /><br />Actually there is no point in multiple assembler directives. Just one will suffice and then the tables are defined as they were in the 16-bit source.<br /><br />.DATA  Use32 Byte Public 'TABLES'  ;256 bytes<br /><br />All tables require 256+(6*64) BYTES<br /><br />I can experiment with the MASM32 directives a little and use PE viewer to see if there is a way to order memory with concecutive 8-bit table values.<br /><br />Throwing the constant into the equation like you suggest, I could setup pointer values for each sub-table.<br /><br />Always do base as:<br /><br />mov esi, TABLE<br /><br />then set esx with sub-table offset:<br /><br />mov esx, <br /><br />then if INDEX is already the value in al,<br /><br />mov al, <br /><br />puts SBOX value into al.<br /><br />Its actually wasteful to create a table indexing method and just call it each time a new walue is wanted. Its very efficient to just set the esi and esx values and work through your method that derives the index value using<br /><br />mov al,  each time. There would be a call FETCH_TABLE instruction anyway so it actually requires MORE memory to code it.<br /><br />//<br /><br /><br />Using MASM32 then I also assume that it will be possible to create a register to index the BASE address of the table and:<br /><br />mov al, INDEX    ; 0 - 256<br /><br />mov esi, SBOX    ;SETS esi to index the SBOX table<br /><br />mov al,  ; al holds indexed SBOX value<br /><br /><br />// assuming I have this straight then its on to the next crisis<br /><br />crisi is plural form of crisis<br /><br />The processing manipulates a carry bit using 8-bit operations.<br /><br />In WIN32 I assume that al is then 16 bits.<br /><br />I can adjust the values adding 256 before processing to affect the bits with adc and rol<br /><br />Is it necessary? Does the MASM32 support the Pentium class processor in such a way that it has a native 8-bit register or register mode? I caught a glimpse of it with the BYTE PTR[ ] operand. Surely there is more ... (come on tease me)<br /><br />-AV-</div>
    <div class="meta">Posted on 2002-03-13 14:18:11 by avrster</div>
   </div>
   <div class="post" id="post-28837">
    <div class="subject"><a href="#post-28837">VB parameters</a></div>
    <div class="body">The header now includes this information:<br /><br />; 		##########################################<br />;<br />;		Montgomery 8-bit Processing for 16-bit x86 Windows platform<br />;<br />;		In a quest to create a Visual Basic DLL the processing has first been <br />;		coded for 16-bit x86 ASM. However, to meet the real needs for<br />;		Visual Basic 6 development, its thought that the processing should be<br />;		coded for 32-bit x86 ASM.<br />;<br />;		Compiler is MASM32<br />;		<br />; 		##############- LAST UPDATED -#################<br />;		AVRSTER on 3-13 4PM CST <br />;		##############- TARGET PLATFORM -##############<br />;		Win32 (Windows 9x, ME,  2000, XP)<br />; 		##############- APPLICATION -##################<br />;		Visual Basic 6  UNKNOWN (RSA encrypt-decrypt function)<br />;		##############- IMPLEMENTATION -###############<br />;		Private Declare Function ENCRYPT Lib &quot;MONTY.dll&quot; Alias &quot;ENCRYPT@1&quot; (ByVal R4 as Integer , ByVal R5 As Integer, ByVal R15 as Integer, ByVal KEYas String, ByVal DATA As String) As String<br />;		Private Declare Function DECRYPT Lib &quot;MONTY.dll&quot; Alias &quot;DECRYPT@2&quot; (ByVal R4 as Integer , ByVal R5 As Integer, ByVal R15 as Integer, ByVal KEYas String, ByVal DATA As String) As String<br />; 		##############-  NOTATIONS  -##################<br />;		3-13 AV<br />;		Passed parameters:<br /><br />;		Symbols		Visual Basic DataType				Description<br /><br />;		INPUT PARAMETERS<br /><br />;		R4,R5			integer				;Two 8-bit control values to articulate permutation<br /><br />;		R15			integer				;8-bit value to articulate rounds<br /><br />;		KEY			(byte array)*			;KEY values that VB has converted to ???* (option) <br /><br />;		DATA			(byte array)*			;(8 Values???) PAYLOAD that VB has converted to ???* (option)<br />;		<br />;				<br />;		OUTPUT PARAMETERS<br /><br />;		R4,R5			integer				;Two 8-bit control values used articulate permutation<br />									;Since they are alterred, it might be necessary to return<br />									;them in their new state to the application. It depends <br />									;on the processing. If they are over-written by new states <br />									;from the stream then its un-necessary to return them.<br /><br />;		R15			integer				;8-bit value to articulate rounds<br />									;SAME as for R4,R5 if processing warrants their return then<br />									;should be done. Otherwise not.<br /><br />;		RESULT		(byte array)*			;RESULT that VB will process as DATA  ??? (option)<br /><br />									;*option Whatever is deemed to be the most preferable way<br />									; to pass these values.<br />;<br />;		3-13 from SLUGGY&quot;<br />;		&quot;If you pass ByVal, VB copies the string to a temporary place on the heap. When it makes that copy, it changes the format of the string<br />;		from UniCode to ANSI, so your asm function will receive a pointer to an ANSI string stored in temporary space. That copy of the string<br />;		is destroyed when you return to the VB function, so if you need a copy of it then your asm function will have to copy it to a private <br />;		buffer.&quot;<br />;<br />;		3-13 AV 4PM CST <br /><br />;		Private Declare Function ENCRYPT Lib &quot;MONTY.dll&quot; Alias &quot;ENCRYPT@1&quot; (ByVal R4 as Integer , ByVal R5 As Integer, ByVal R15 as Integer, ByVal KEYas String, ByVal DATA As String) As String<br />;		Private Declare Function DECRYPT Lib &quot;MONTY.dll&quot; Alias &quot;DECRYPT@2&quot; (ByVal R4 as Integer , ByVal R5 As Integer, ByVal R15 as Integer, ByVal KEYas String, ByVal DATA As String) As String<br /><br />; 		R4 	:8		Permutation1 pointer<br />; 		R5 	:12		Permutation2 pointer	<br />; 		R15 	:16		Rounds pointer<br />;		KEY 	:20		KEY string pointer<br />;		DATA 	:24		DATA string pointer<br /><br />;		Returned result will be in the location pointed to by the DATA string pointer 24.<br />;		<br />;		Before processing input its standard practice to push affected registers onto the stack:<br />;		push ebp<br />;		mov ebp,esp<br />;		push edi<br />;		push esi<br />;		push ebx<br />;<br />;		mov edx,		;Get Permutation1 pointer<br />;		mox R4,<br />;		mov edx,	;Get Permutation2 pointer<br />;		mox R5,<br />;		mov edx,	;Get Rounds pointe<br />;		mox R15,<br />;		mov edx,	;Get Key pointer<br />;		mox ptrKEY,<br />;		mov edx,	;Get DATA pointer<br />;		mox ptrDATA,<br />;<br />;		*This is an example of accessing the passed parameters. <br />;		Putting the values into locations might be regarded as a good Win32 programming practice.<br />;		In that case a couple of simple methods to move the KEY and DATA buffers to program <br />;		locations is needed.<br />; 		The result in the DATa buffer would be deposited in the same buffer that passed it into the <br />;		method. On returning a value it will first be necessary to restore the pushed values, then the <br />;		final ret instruction also has an operand to pass the pointer to the data buffer.<br /><br />;		pop ebx <br />;		pop esi <br />;		pop edi <br />;		mov esp,ebp <br />;		pop ebp<br /> <br />;		ret 24	<br />;<br />;		Visual Basic receives a pointer to the processed DATA and resumes processing.<br />;</div>
    <div class="meta">Posted on 2002-03-13 15:08:45 by avrster</div>
   </div>
   <div class="post" id="post-28841">
    <div class="subject"><a href="#post-28841">Parameters</a></div>
    <div class="body">This post has a very useful example for passing and receiving the parameters.<br /><br /><br /><br />EXAMPLE:<br /><br />;HEX LONG BINARY CONVERSION by Robert Rayment<br /><br />;NB Assumes all 8 hex bytes filled with 48(&quot;0&quot;) to 70(&quot;F&quot;)<br />;   and all 32 bin bytes filled with 48(&quot;0&quot;) or 49(&quot;1&quot;)<br /><br />; VB<br /><br />;Select Case Index<br />;Case 0   'Hex Input<br />;   Hex2Long2Bin<br />;Case 1   'Long Input<br />;   Long2Bin2Hex<br />;Case 2   'Bin Input<br />;   Bin2Hex2Long<br />;End Select<br /><br />; For calling machine code<br />; res = CallWindowProc(lpMCode,InpDec, lpHex, lpBin,  OpType)<br />;			8		12	16	20							<br />; lpMCode    pointer to machine code<br />; InpDec     long decimal number input<br />; lpHex      pointer to HexBytes(1)  input &amp; output<br />; lpBin      pointer to BinBytes(1)  input &amp; output<br />; OpType     long number 1,2 or 4 for respec. Hex, Dec &amp; Bin input<br />; res        long decimal output (from reg EAX)<br /><br /><br />;<br /><br />.486p                                             <br />.MODEL FLAT,STDCALL<br />locals<br />jumps<br />UNICODE=0<br />;include Sample.inc<br /><br /> <br />.DATA<br /><br />.CODE<br /><br />START:<br /><br />	push ebp<br />	mov ebp,esp<br />	push edi<br />	push esi<br />	push ebx<br /><br /><br />	mov eax,	;Get OpType<br />	rcr eax,1<br />	jnc TestOp2<br />	<br />	;OPERATION 1  HEX INPUT<br /><br />	CALL Hex2Long		;Long result in eax &amp; edx<br />	push eax<br />	CALL Long2Bin		;In: Long in edx<br />	pop eax				;Long result in eax<br />	<br />	jmp GETOUT<br />;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br />TestOp2:<br /><br />	rcr eax,1<br />	jnc TestOp3<br /><br />	;OPERATION 2  LONG INTEGER INPUT<br /><br />	mov edx,		;Get decimal input<br />	<br />	CALL Long2Bin<br />	CALL Bin2Hex<br />	<br />	jmp GETOUT<br />;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br />TestOp3:<br /><br />	rcr eax,1<br />	jnc GETOUT			;Error? ignore<br />	<br />	;OPERATION 3  BINARY INPUT<br /><br />	CALL Bin2Hex	<br />	CALL Bin2Long		;Long result in eax<br />	<br />	;jmp GETOUT<br />;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br /><br />GETOUT:<br />pop ebx<br />pop esi<br />pop edi<br />mov esp,ebp<br />pop ebp<br />ret 16</div>
    <div class="meta">Posted on 2002-03-13 15:46:22 by avrster</div>
   </div>
   <div class="post" id="post-28850">
    <div class="subject"><a href="#post-28850">Parameter passing</a></div>
    <div class="body">Posted file has new header information regarding parmeter passing. V (Below)<br /><br />Its time to start writing code again!<br /><br />-AV-</div>
    <div class="meta">Posted on 2002-03-13 16:05:23 by avrster</div>
   </div>
   <div class="post" id="post-28886">
    <div class="subject"><a href="#post-28886">32-bit progress</a></div>
    <div class="body">Use of ebx, esi and edi is essential to 32-bit programming.<br /><br />The attached file has the changes to type definitions and uses 32-bit pointers in the short support functions.<br /><br />I'm coding 32-bit ASM for Win32. It should be routine to make the changes.<br /><br />Thanks for the help!<br /><br />I was actually starting to think about another project while driving today that would allow VB to emulate a smartcard in a development application. I have the encryption for both sides and an interface that connects to the computer. Its a matter of determining the features that would make it useful in prototyping x86 code running on WIN32.<br /><br />The biggest thing I can think of is the low startup cost, and the need for exporting the code to another taget processor that actually resides on a smartcard. You guys must know something about what is already available.<br /><br />-AV-</div>
    <div class="meta">Posted on 2002-03-13 21:46:09 by avrster</div>
   </div>
   <div class="post" id="post-28990">
    <div class="subject"><a href="#post-28990">MONTY32  (rev 0.1)</a></div>
    <div class="body">There is still some work to do on getting the methods to use the correct input buffers.<br /><br />The basic code is there, its a matter of going through the external processing to see exacly what is being passed into each public method and setting it up correctly. I just whipped it together.<br /><br />Also, while I'm at it I'll be looking to see if some of the external processing can be added to the DLL possibly to keep a few more of the methods private.<br /><br />-AV-</div>
    <div class="meta">Posted on 2002-03-14 11:52:45 by avrster</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=4151&amp;page=1" style="">&laquo;</a><a href="../?id=4151&amp;page=1" style="">&lt;</a><input type="hidden" name="id" value="4151" /><input type="number" name="page" min="1" max="2" step="1" value="2" onchange="this.form.submit();" /></form>  </div>
 </body>
</html>