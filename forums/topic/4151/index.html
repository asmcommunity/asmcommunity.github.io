<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>Vbasm - Forums - ASM Community</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css" />
  <link rel="canonical" href="../?id=4151" />
    <link rel="next" href="../?id=4151&amp;page=2" /> </head>
 <body>
  <div id="header">
   <h1><a href="../../../">ASM Community</a></h1>
  </div>
  <div id="content">
   <p class="breadcrumbs"><a href="../../../">Home</a> &raquo; <a href="../../">Forums</a> &raquo; <a href="../../board/?id=3">MAIN</a> &raquo; <a href="../?id=4151">Vbasm</a></p>
<form class="pagination" action="../" method="get"><a href="../?id=4151&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=4151&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="4151" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=4151&amp;page=2">&gt;</a><a href="../?id=4151&amp;page=2">&raquo;</a></form>   <div class="post" id="post-28384">
    <div class="subject"><a href="#post-28384">Vbasm</a></div>
    <div class="body">This thread is dedicated to developing a DLL for use in Visual Basic using MASM assembler methods to build the DLL. <br /><br /><br />I am new to ASM and am just discovering the needed work-arounds for 8-bit to 16- and 32-bit conversions. <br /><br />I'm using &quot;Assembly Develop Studio 1.0&quot; from <a target="_blank" href="http://www.linkedglobe.com">http://www.linkedglobe.com</a> configured for MASM32 and library support that I found at <a target="_blank" href="http://spiff.tripnet.se/~iczelion/">http://spiff.tripnet.se/~iczelion/</a> <br /><br />I have also installed IdeasM 1.0 for use with UEDIT, it is very useful and provided essential information for getting ADS 1.0 configured to work with MASM32 instead of TurboASM. Making direct use of the extensive support for MASM seemed like the way to go. <br /><br />Next post is the code I am compiling that will hopefully emulate AVR functions to VB.<br /><br />There is a possible advantage to using a segmented non-flat memory model. I think its possible to work with 8-bit values and addresses can be 16-bits. Then of course we are not working with WIN32. <br /><br />So its necessary to consider what the experts think about this part of the projects. A person who knows both platforms well would possibly have a preference. It depends allot on how much work is involved in converting 8-bit values and pointers.<br /><br />Contributions gladly accepted. <br /><br />-AV- :grin:</div>
    <div class="meta">Posted on 2002-03-11 14:16:59 by avrster</div>
   </div>
   <div class="post" id="post-28388">
    <div class="subject"><a href="#post-28388">VBASM</a></div>
    <div class="body">It compiles, with just a single error as I'm working out a conversion of 32 or 16 bit values in indexing. I'm not sure what the wanted value is. <br /><br />The main method is prototyped that tests the reason for calling the DLL. Also it willl be possible to export methods to Visual Basic using the needed _stdcall convention. <br /><br />I began with a simple skeleton and made sure I could include files and libraries. Then I made tables for the SBOX etc. and added a few simple functions that will move data, or bitflop it. <br /><br /><br />The main intent is to enhance my capabillities with VB as related to AVR emulation and other applications. <br /><br />Looking at a DLL with IDA, it was obvious there is tremendous overhead added by the development system. This obfuscates the code, which is possibly a good thing for some functions. However it cannot be made standard practice in development of AVR emulation methods. Win32 Assembler development is relatively new, but it is increasingly getting easier to learn and pull-off. <br /><br />Anyone serious about VB development should take a look at enriching their VB with MASM32 development for WIN32 DLL functions. <br /><br />The going is a little slow, but I expect it to get a little easier once I learn a few more fundamentals about ASM. <br /><br />With DEF file to define the EXPORTED methods I hope to begin testing some form of the DLL in VB soon.<br /><br />I need to get into the habit of using function prototypes. Also I think I'm almost ready to implement the DLL in a testing mode to get the VB side of things going, and to make sure the bases are covered. I want to explore the limitations on variable passing to see if its possible to pass strings and return them, or pointers to them.<br /><br />I'll appreciate input on whether to attempt emulation of AVR processing on a 32-bit platform, or if it will be an easier project to do it on a 16-bit platform.<br /><br /><br /><br /><br />3-10 10PM<br />I made some changes switching to model that defines segments allowed some of my instructions to work. This is new ground for me I'm going way out to get this up on my VB development. Some of the methods are looking OK.<br /><br />EDITED 3-12 4:45AM CST Revised Attachment<br /><br />Added CRYPT1 &amp; CRYPT5<br /><br />Reformatted: 3-12 8:15 CST<br /><br /><br />-AV-</div>
    <div class="meta">Posted on 2002-03-11 14:20:10 by avrster</div>
   </div>
   <div class="post" id="post-28495">
    <div class="subject"><a href="#post-28495">Vbasm</a></div>
    <div class="body"><div class="quote">Anyone serious about VB development should take a look at enriching their VB with MASM32 development for WIN32 DLL functions. </div> <br /><br />Thats an excellent idea, you wouldn't get any argument from me.<br /><br />However, just what are you trying to accomplish? It's hard ot get that from your code.</div>
    <div class="meta">Posted on 2002-03-11 22:34:17 by Ernie</div>
   </div>
   <div class="post" id="post-28510">
    <div class="subject"><a href="#post-28510">Vbasm</a></div>
    <div class="body">avrster,<br /><br />I actually cannot see the problem of writing DLLs for VB in MASM, the main problems will be knowing what is passed to the DLL and what is passed back to VB.<br /><br />MASM can handle both STDCALL and C calling conventions and with this you can handle the VB BYVAL or BYREF parameter passing with no problems, as long as you know which is which with your DLL.<br /><br />Addresses OR values are no problem to MASM at all.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-03-12 00:51:14 by hutch--</div>
   </div>
   <div class="post" id="post-28560">
    <div class="subject"><a href="#post-28560">VBASM</a></div>
    <div class="body">The problem I see with this particular processing is that ADDS affect the carry bit and the carry bit status is used to determine output. Everything starts with 8-bit values, but since the registers a 16-bit there will be no carry flag.<br /><br />Is there a mode that allows the carry to be set on 8-bit results rather than 16-bit?<br /><br />A work-around is-going to take up time.<br /><br />I Reformatted the code above.<br /><br />It occurred to me that <br /><br />adc al,al<br /><br />will affect the carry bit.<br /><br />Also putting an an 8-bit value into the high byte before doing<br /><br />adc ax,ax will also affect the carry bit if the result requires 17 bits.<br /><br />I much prefer trying to emulate or implement something that writing it from scratch. So far, so good. I'll be looking at passing parameters aafter implementing the basic methods. Just a few more to go! They are smaller.<br /><br />THX.<br /><br />-AV-</div>
    <div class="meta">Posted on 2002-03-12 08:13:44 by avrster</div>
   </div>
   <div class="post" id="post-28575">
    <div class="subject"><a href="#post-28575">Vbasm</a></div>
    <div class="body">avrster,<br /><br />The bits of code that you have posted so far look like 16 bit code so I am not sure if you are writing 16 or 32 bit code for your MASM dll for VB.<br /><br />The problem is you have not posted enough info for anyone to help you. Are you using 16 or 32 bit VB. Are you trying to use 16 or 32 but assembler.<br /><br />What form is the data you want to pass, how do you want to return it to VB etc ....<br /><br />If you can tell us more, someone may be able to help you.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-03-12 09:13:18 by hutch--</div>
   </div>
   <div class="post" id="post-28584">
    <div class="subject"><a href="#post-28584">Vbasm</a></div>
    <div class="body">Hutch:<br /><br />Great compiler. You guys DU are up un your computing.  Defending yourselves pretty well against the Viri too. I've been checking the chart at Trend Micro for Pc_Housecall stats.<br /><br />Presntly I'm in a phase of just doing whatever it takes to get the AVR Montgomery functions to compile. It worked out better to use the 16-bit mode for indexing and because I'm really working with lots of 8-bit values I works out well. I'm grasping a few of the potential problems before they occur in debugging. This carry flag problem was easy to solve. One function works better if you put the data into the high byte of AX, another works out if you drop them into the low byte and use ADC, AL,AL to set the carry bit.<br /><br /><br />All I need at this point is to hear it from the experts that I can pass strings to &amp; from VB. I was thinking about it and realize with at the exposed methods in the VB6runtime.dll or whatever its called, there has to be a way to put values into a buffer and let VB know it is ready. After getting a few more methods into the DLL, I can focus in to the parameter passing.<br /><br />This is great stuff. I like the tools.<br /><br />That Assembly Developer Studio is simple and easy to pickup. I configured it for your latest MASM32 compiler. Seems like when everything is formatted nicely it parses faster.<br /><br />I think I can learn to leverage VB with MASM. You have something going there Hutch... its big.<br /><br />-AV-</div>
    <div class="meta">Posted on 2002-03-12 09:40:10 by avrster</div>
   </div>
   <div class="post" id="post-28586">
    <div class="subject"><a href="#post-28586">Vbasm</a></div>
    <div class="body"><div class="quote"><br /><br />All I need at this point is to hear it from the experts that I can pass strings to &amp; from VB. I was thinking about it and realize with at the exposed methods in the VB6runtime.dll or whatever its called, there has to be a way to put values into a buffer and let VB know it is ready. After getting a few more methods into the DLL, I can focus in to the parameter passing.<br /></div><br /><br />Hi avrster, <br />well imo the best way to interface with VB even with asm is to use COM technology <br />Anyway if u wanna use the dll way u should deal with BSTR <br />the strings under VB <br />U should use WideCharToMultiByte() to deal with them <br />The exports of VB runtime r quite clear as names on what they do but if u need some help with some specific api u can ask <br /><br />See ya <br />NikDH</div>
    <div class="meta">Posted on 2002-03-12 10:00:45 by NikDH</div>
   </div>
   <div class="post" id="post-28659">
    <div class="subject"><a href="#post-28659">Vbasm</a></div>
    <div class="body">avrster,<br />Hmmm, i almost burst out laughing when i saw your previous post. You are heading down the wrong track fast, it would be interesting to see where you end up :)<br /><br />Yes, you <strong>can</strong> pass strings to and from VB, but let me get something else straight first: if you are programming in 32 bit VB, then your dll will have to be written in 32 bit asm. 32 bit VB cannot call a 16 bit dll without going through a &quot;thunking&quot; process. You should not <em>need</em> to call a 16 bit dll. If the asm code you are working with is 16 bit, then port it to 32 bit. There are plenty of people in this forum well qualified to assist you.<br /><br />Back to the strings:<br />you <strong>DO NOT and SHOULD NOT</strong> use the VB runtimes directly for string handling. The functionality that is exposed is undocumented and unsupported by MS, and <em>can change at any time at MS's discretion</em>, usually by a service pack being applied. It is also an extremely torturous way of doing what you want to do.<br /> <br />There are two straight-foward ways to pass a string from VB: <strong>ByRef</strong> or <strong>ByVal</strong>. Under normal circumstances, i would advise not to use ByRef. Your asm functions should use the stdcall calling mechanism, and normally you should pass your strings from VB ByVal.<br /><br />If you pass the strings ByRef, your asm function will receive a pointer to a BSTR. If you pass ByVal, VB copies the string to a temporary place on the heap. When it makes that copy, it changes the format of the string from UniCode to ANSI, so your asm function will receive a pointer to an ANSI string stored in temporary space. That copy of the string is destroyed when you return to the VB function, so if you need a copy of it then your asm function will have to copy it to a private buffer.<br /><br />The third way to pass a string to an asm function is to first copy the string to a byte buffer using CopyMemory(), then pass the first  element of the byte array, which means that your asm function will receive a pointer to the first element in the array (just like in C). You can then operate on this byte buffer, then when you return to VB you use CopyMemory to copy the byte buffer back into the original string. This method is not needed often, should only be used for fixed-length strings, and should only be used if you know what you are doing (it leads to GPFs if you get it wrong).<br /><br /><span style="font-size:9px><strong>Damn, so many people are asking this question that i need to write a tutorial on this</strong> :rolleyes: </span></div>
    <div class="meta">Posted on 2002-03-12 16:42:51 by sluggy</div>
   </div>
   <div class="post" id="post-28661">
    <div class="subject"><a href="#post-28661">MONTY</a></div>
    <div class="body">Yes sir,, I thank you for the facts.<br /><br />The attachment here is a 16-bit collection of methods converted from AVR 8-bit code.<br /><br />I had trouble figuring out how to index in 32-bit mode because my data sizes were not matching. If someone wnats to take a look at what it will take to convert these methods to 32-bit I will be more than interested in their suggestions. So far I have not got 32-bit indexing and data types figured out. The conversion to 16-bit might just be a stepping stone.<br /><br />I have read a little about THUNKING and would prefer to steer clear.<br /><br />I need to read you post more closely.<br /><br />THX<br /><br />-AV-</div>
    <div class="meta">Posted on 2002-03-12 17:16:35 by avrster</div>
   </div>
   <div class="post" id="post-28662">
    <div class="subject"><a href="#post-28662">Vbasm</a></div>
    <div class="body">avrster,<br /><br />You can do byte level processing in 32 bit with no problems at all, it just means that you have to learn the coding techniques, indexing is not a problem, increment the index by 1 to handle BYTE data, 2 for WORD data, 4 for DWORD data.<br /><br />When you settle on the parameter passing method from VB to the DLL and how you want the data to return to VB, the rest is simple. You can simply afford to ditch 16 bit assembler, you can do all of this stuff in 32 bit better.<br /><br />There is still no descripton of &quot;AVR&quot; emulation and stuff like the &quot;ADDS&quot; effect so there is little to work on at the moment.<br /><br />See if you can make a little more info available as its not making much sense at the moment.<br /><br />Regards,<br /><br /><a href="mailto:hutch@movsd.com">hutch@movsd.com</a></div>
    <div class="meta">Posted on 2002-03-12 17:38:29 by hutch--</div>
   </div>
   <div class="post" id="post-28664">
    <div class="subject"><a href="#post-28664">Vbasm</a></div>
    <div class="body"><strong>avrster</strong>, 32-bit addressing is the same as 16-bit, but with<br />32-bit registers.  The code would greatly benefit from it's use.<pre><code>mov al, &#91;EBX + 13&#93;<br />mov al, &#91;EBX + ECX * 8 + 13&#93;</code></pre>I will convert a PROC or two when I get home to help you.  I like your coding style of using EQUates to make the code more readable - I do the same thing. :)</div>
    <div class="meta">Posted on 2002-03-12 17:45:04 by bitRAKE</div>
   </div>
   <div class="post" id="post-28686">
    <div class="subject"><a href="#post-28686">VBASM -MONTY 32 DLL</a></div>
    <div class="body">I just knocked myself out for a couple days to dive into this after researching it. Creating the DLL is the thing to do to spawn further development. It gets very interesting.<br /><br />I got a taste of converting AVR code to 16-bit. I could grasp the code needed to do it without any MASM experience. Honestly I think it takes a little programmers intuition about 32-bit coding to do a really good job of it. Migrating from an 8-bit world to a 32-bit is a big step. You don't just absorb it. It comes with honest work. I have respect for that.<br /><br />On your side its got to be a little interesting to see someone come along and attempt to put it together.<br /><br />The AVR is a register-intensive RISC processor. The x86 has a very powerful and flexible instruction set. You start coding and for each mnemonic there has GOT to be a mode that applies to your particular instance. The x86 is like a TANK and the AVR is like a sports car. What's interesting is seeing the simple over and over techniques the TANK can use to implement the straight-forward AVR.<br /><br />Yep,, once I get a handle on how the 32-bit mode adapts to the processing in this Montgomery DLL I'll be openning a new chapter in my programming conquests. Life is grand!<br /><br />There is allot of potential in combining VB and MASM32. I have a full-blown VB E-mail application that can benefit as well, but for now the Montgomery processing is to get another project off to the races.<br /><br />Thi parameter passing thing is something that needs to be done properly the very first time. Then it won't be necessary to relearn the correct method. Allot of people probably wish they had THUNK just a little harder before they implemented. (Of course with Microsoft out there mucking up everything just when its seems that everyone is getting a little too robust for their ambitions...)<br /><br />-AV-</div>
    <div class="meta">Posted on 2002-03-12 21:14:21 by avrster</div>
   </div>
   <div class="post" id="post-28741">
    <div class="subject"><a href="#post-28741">Re: VBASM -MONTY 32 DLL</a></div>
    <div class="body"><div class="quote"><em>Migrating from an 8-bit world to a 32-bit is a big step</em></div>No its not. It is easier for new people to do 32 bit stuff, because they do not have to deal with the complexities of segmented addressing.<br /><br /><br /><div class="quote"><em>What's interesting is seeing the simple over and over techniques the TANK can use to implement the straight-forward AVR.</em></div>I am not familiar with the algorithm that you are porting, but this is what i would suggest: first, just get it going using the normal opcodes. Then read some tutorials on MMX and SSE instructions, evaluate how they may help with the optimisation of the algo, then introduce them into the code if appropriate.</div>
    <div class="meta">Posted on 2002-03-13 04:27:13 by sluggy</div>
   </div>
   <div class="post" id="post-28762">
    <div class="subject"><a href="#post-28762">Carry bit processing</a></div>
    <div class="body">This processing affects the carry bit when the lower order bits are added. I think it will correctly emulate the processing done on the AVR. I added the    adc al,al    instruction and dropped the result back into the location for each manipulation.<br /><br />mov ax,<br />adc al,al<br />mov ,ax<br />    					<br />mov ax,<br />adc al,al<br />mov ,ax<br />mov ax,<br />adc al,al<br />mov ,ax<br /><br />mov ax,<br />adc al,al<br />mov ,ax	<br />mov ax,<br />adc al,al<br />mov ,ax<br />mov ax,<br />adc al,al<br />mov,ax<br /><br /><br />ETC.<br /><br />Fixed it in this file.  V (Below) Also added main encrypt and decrypt methods.<br /><br />Yep, the experts have concurred that conversion to 32-bit processing makes for an all-around easier time of it in VB. This is essentially the advice I was hoping for. So,, its now become a matter of marvelling at the code and figuring out how to whip it into a 32-bit emulation. Just the simple methods are called for. Advanced optimizations if possible are really an advanced topic that is reserved for the experts who might be pondering some of it right now actually.<br /><br />To the most recent edited attachment I have made headliner notations about parameters to be passed.<br /><br />-AV-</div>
    <div class="meta">Posted on 2002-03-13 07:45:40 by avrster</div>
   </div>
   <div class="post" id="post-28784">
    <div class="subject"><a href="#post-28784">Vbasm</a></div>
    <div class="body">Could you state the algo mathematically?  The above posted code could be realized with just shifts or rolls, but I am not certain of what the larger goal is.  Does the attached code work for your application as it is?</div>
    <div class="meta">Posted on 2002-03-13 10:00:36 by bitRAKE</div>
   </div>
   <div class="post" id="post-28786">
    <div class="subject"><a href="#post-28786">FILE</a></div>
    <div class="body">The attached file is actual AVR code that I took from source that compiled on the AVR for the Montgomery DES processing.<br /><br />I broke that AVR application source into components hoping to simplify the analysis. When complete high-level functions assembled, then I had the pieces together in a module.<br /><br />Advancing development of a simulation in VB requires this processing. Analysis will reveal that there is more processing that has not been implemented in the module as no use of the EXPONENTS and MODULUS has been shown. That processing is at this point external, but I am looking to see what is involved and what would need to be added.<br /><br />Its just a few methods that index the tables and chain processing that uses the ENCRYPT-DECRYPT methods. The DLL can probably be done keep all other methods internal, exporting only the ENCRYPT and DECRYPT methods. This will be dtermined soon.<br /><br />I have no description of the ALGO. Its industry-standard processing called &quot;Montgomery&quot; that does exponential multiplication to define keys from stream data.<br /><br />-AV-</div>
    <div class="meta">Posted on 2002-03-13 10:16:55 by avrster</div>
   </div>
   <div class="post" id="post-28788">
    <div class="subject"><a href="#post-28788">Vbasm</a></div>
    <div class="body">This code is accomplishes the same thing as what you posted:<pre><code>;mov ax,&#91;REGS +_R24&#93; <br />;adc al,al <br />;mov &#91;REGS +_R24&#93;,ax <br /><br />rcl BYTE PTR &#91; 1 + REGS +_R24&#93;, 1<br /><br />;mov ax,&#91;REGS +_R24&#93; <br />;adc al,al <br />;mov &#91;REGS +_R24&#93;,ax <br /><br />rcl BYTE PTR &#91; 1 + REGS +_R24&#93;, 1<br /><br />;mov ax,&#91;REGS +_R23&#93; <br />;adc al,al <br />;mov &#91;REGS +_R23&#93;,ax <br /><br />rcl BYTE PTR &#91; 1 + REGS +_R23&#93;, 1<br /><br />;mov ax,&#91;REGS +_R24&#93; <br />;adc al,al <br />;mov &#91;REGS +_R24&#93;,ax <br /><br />rcl BYTE PTR &#91; 1 + REGS +_R24&#93;, 1<br /><br />;mov ax,&#91;REGS +_R23&#93; <br />;adc al,al <br />;mov &#91;REGS +_R23&#93;,ax <br /><br />rcl BYTE PTR &#91; 1 + REGS +_R23&#93;, 1<br /><br />;mov ax,&#91;REGS +_R22&#93; <br />;adc al,al <br />;mov&#91;REGS +_R22&#93;,ax<br /><br />rcl BYTE PTR &#91; 1 + REGS +_R22&#93;, 1</code></pre>I do not believe that this is anywhere near optimal though.  As <strong>Sluggy</strong> suggests, a couple orders of magnitude could be achieved with MMX, without much effort.</div>
    <div class="meta">Posted on 2002-03-13 10:34:30 by bitRAKE</div>
   </div>
   <div class="post" id="post-28789">
    <div class="subject"><a href="#post-28789">Assertion needed for tables</a></div>
    <div class="body">Code 		Segment 		Use32 Dword Public 'CODE'<br /><br />Assume 		Cs:Code<br /><br />		DECODE 		integer 247,226,60,191,4,91,170,236,155,135,6,89,173,244,224,10<br />					integer 98,08,149,99,95,54,74,101,56,209,115,174,145,173,142,240<br /><br />ETC.<br /><br />I need to learn to make proper assertions for table locations so as to be able to access them from base locations starting at zero for simpler indexing.<br /><br />Manipulation of the compiler commands to define the segment (within the data segment preferably) is required.<br /><br />Using the most desireable option to define my table data structure &quot;Use32 Dword&quot;  is also required.<br /><br />This is a simple thing to fixup before diving into the 32-bit coding.<br /><br />-AV-</div>
    <div class="meta">Posted on 2002-03-13 10:36:32 by avrster</div>
   </div>
   <div class="post" id="post-28793">
    <div class="subject"><a href="#post-28793">Vbasm</a></div>
    <div class="body">Setting the segment registers to access the data with a zero offset is not possible in windows.  Windows manages the segment registers, and gives each application a 32-bit address space (not all is accessible).  Are you programming for windows?<br /><br />; under windows<br />assume CS:FLAT<br /><br /><br />;under your own operating system... :)<br />ORG 0<br /><br />CODE SEGMENT<br /><br />assume CS:CODE</div>
    <div class="meta">Posted on 2002-03-13 10:57:09 by bitRAKE</div>
   </div>
<form class="pagination" action="../" method="get"><a href="../?id=4151&amp;page=1" style="visibility:hidden;">&laquo;</a><a href="../?id=4151&amp;page=0" style="visibility:hidden;">&lt;</a><input type="hidden" name="id" value="4151" /><input type="number" name="page" min="1" max="2" step="1" value="1" onchange="this.form.submit();" /><a href="../?id=4151&amp;page=2">&gt;</a><a href="../?id=4151&amp;page=2">&raquo;</a></form>  </div>
 </body>
</html>