<HTML>
<HEAD>
   <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1250">
   <META NAME="Author" CONTENT="Iczelion">
   <META NAME="GENERATOR" CONTENT="Mozilla/4.04 [en] (WinNT; I) [Netscape]">
   <TITLE>Iczelionùv Win32asm tutorial èást 1: ZÁKLADY</TITLE>
</HEAD>
<BODY TEXT="#FFFFFF" BGCOLOR="#000000" LINK="#FF0000" VLINK="#800080" ALINK="#0000FF">
<CENTER>
  <H1> <font color="#3333FF" face="verdana">Tutorial 1: Základy</font></H1>
</CENTER>
<font color="#CCCCCC" face="verdana" size="2">Tento tutorial pøedpokládá, e ètenáø ví jako pouívat MASM.
Pokud nejste obeznámeni s MASM, stáhnìte si balíèek <a href="files/win32asm.exe">win32asm.exe</a> 
a prostudujte si texty uvnitø balíèku pøedtím, ne se vrhnete na tento tutorial.<br> Dobøe. 
Nyní jste pøipraveni. Pojïme na to! :)</font> 
<H3> <font color="#CC0000" face="verdana">Teorie:</font></H3>
<p><font color="#CCCCCC" face="verdana" size="2">Win32 programy bìí v protected 
  módu, kterı je podporován od 80286. Ale 80286 je ji nyní dávná historie a my se mùeme v klidu soustøedit
  na 80386 a jeho nástupce. Windows spouští kadı Win32 program v oddìleném virtuálním prostoru.
  To znamená, e kadı Win32 program bude mít svùj vlastní 4 GB adresovací prostor.
  To všek neznamená, e kadı win32 program má 4GB fyzické pamìti, ale jen to, e kadı program mùe adresovat adresu v tomto rozsahu.
  Windows uèiní vše potøebné proto, aby jednotlivé odkazy do pamìti byly funkèní.
  Program samozøejmì musí pøistoupit na pravidla daná Windows, jinak zpùsobí onu oblíbenou chybu ochrany.
  Kadı program je sám o sobì ve vlastním adresovém prostoru.
  To je podstatná zmìna od dob Win16. Všechny Win16 aplikace se mohly navzájem vidìt.
  Né tak pod Win32. Tenhle rys pomáhá redukovat šanci, e jeden program pøepíše druhému kód nebo data.
  </font> <font face="verdana" size="2" color="#CCCCCC"><BR>
  Pamìovı model je také drasticky odlišnı od starého 16-bit svìta.
  Pod Win32 se ji vùbec nemusíme zabıvat pamìovım modelem nebo segmenty.
  Existuje pouze jedinı model: Flat memory model. Ji ádné 64K segmenty. 
  Pamì je velikı kontinuální prostor o velikosti 4GB. To také znamená, e si ji nemusíte
  hrát se segment registry. Mùete vyuít libovolnı segment registr k adresování jakéhokoliv
  místa v pamìovém prostoru. To je VELIKÁ pomoc programátorùm a je to právì toto, co dìlá
  Win32 programování v assembleru tak snadné jako C.<br>
  Kdy programujete pod Win32, musíte znát nìkterá pravidla. Jedno takové pravidlo je,
  e Windows pouívá esi, edi, ebp a ebx registry vnitønì a neèeká,
  e se hodnoty v tìchto registrech zmìní. Take si zapamatujte pravidlo první:
  Jestlie pouijete jakıkoliv z tìchto registrù ve své callback funkci, nezapomeòte
  ho obnovit pøedtím, ne vrátíte kontrolu Windows. Callback funkce je vaše vlastní funkce,
  která je volána operaèním systémem. Bìnım pøíkladem je Windows procedura.
  To ale neznamená, e nemùete pouívat bezpeènì tyto ètyøi registry, jen je skuteènì musíte 
  obnovit pøed pøedáním kontroly zpìt systému.</font></p>
<H3> <font color="#CC0000" face="verdana">Content:</font></H3>
<p><font color="#999999" face="verdana" size="2">Zde je základní kostra programu.
  Jestlie nerozumíte nìèemu z kodu, nedìste se. Vysvìtlím pozdìji.
  </font></p>
<p><font color="#669999" face="verdana" size="2"><b>.386</b></font> <font color="#669999" size="2" face="verdana"><b><BR>
  .MODEL Flat, STDCALL <BR>
  .DATA <BR>
  &nbsp;&nbsp;&nbsp; &lt;vaše inicializovaná data> <BR>
  &nbsp;&nbsp;&nbsp; ...... <BR>
  .DATA? <BR>
  &nbsp;&nbsp; &lt;vaše neinicializovaná data> <BR>
  &nbsp;&nbsp; ...... <BR>
  .CONST <BR>
  &nbsp;&nbsp; &lt;vaše konstanty> <BR>
  &nbsp;&nbsp; ...... <BR>
  .CODE <BR>
  &nbsp;&nbsp; &lt;label><BR>
  &nbsp;&nbsp;&nbsp; &lt;váš kód> <BR>
  &nbsp;&nbsp; ..... <BR>
  &nbsp;&nbsp;&nbsp; end &lt;label> </b></font></p>
<p><font face="verdana"><BR>
  <font color="#CCCCCC" size="2">To vše! Pojïme kostru zanalyzovat :).</font></font> 
</p>
<P><font face="verdana"><B><FONT COLOR="#CC33CC" size="3">.386</FONT></B> <BR>
  <B><font color="#808000" size="2">Toto je direktiva assembleru øíkající, e budeme uívat
  80386 instrukèní sadu. Mùete také pouít .486, .586, ale nejbezpeènìjší je zùstat u .386.
  Ve skuteènosti existují dvì témìø identické formy pro kadı model CPU.
  .386/.386p, .486/.486p. Tyto verze &quot;p&quot; jsou nutné
  pouze kdy váš program pouívá privilegované instrukce, co jsou instrukce
  rezervované CPU/operaèním systémem v protected módu, které mùe uívat pouze privilegovanı kód
  jako jsou ovladaèe. Vìtšinu èasu váš program takto pracovat nebude, take je bezpeèné pouít non-p verze.
  </font></B></font>
<P><font face="verdana"><B><FONT COLOR="#CC33CC" size="3">.MODEL FLAT, STDCALL</FONT></B> 
  <BR>
  <B><font color="#CC33CC" size="2">.MODEL</font><font color="#808000" size="2"> 
  je direktiva, která specifikuje pamìovı model vašeho programu. Pod
  Win32 je pouze jedinı: </font><font color="#3333FF" size="2"> </font><font color="#CC33CC" size="2">FLAT</font><font color="#808000" size="2"> 
  model.</font></B> <font size="2"><BR>
  <B><FONT COLOR="#CC33CC">STDCALL</FONT><font color="#808000"> øíká MASM o zpùsobu pøedání parametrù (konvenci). 
  Konvence urèuje poøadí pøedávanıch parametrù,
  zleva do prava nebo zprava doleva, a také urèuje kdo bude balancovat zásobník
  po zavolání funkce.</font></B> <BR>
  <B><FONT COLOR="#CC6600">Pod Win16 jsou dva druhy konvence,
  </FONT><FONT COLOR="#CC33CC">C</FONT><FONT COLOR="#CC6600"> a </FONT><FONT COLOR="#CC33CC">PASCAL</FONT></B> 
  <BR>
  <B><FONT COLOR="#CC33CC">C </FONT><font color="#808000"> konvence pøedává 
  parametry zprava doleva, tj. parametr nejvíce vpravo je do zásobníku vloen jako první.
  Volající je zodpovìdnı za vybalancování zásobníku po zavolání. Napø.
  pro zavolání funkce pojmenované foo(int prvni_param, int druhy_param, 
  int treti_param) v C konvenci bude asm kód vypadat takto:</font></B></font> 
  </font>
<BLOCKQUOTE><font face="verdana"><B><font color="#FFFF66" size="2">push&nbsp; 
  [treti_param]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
  ; Vloz (Push) treti parameter</font></B> <font color="#FFFF66" size="2"><BR>
  <B>push&nbsp; [druhy_param]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
  ; nasleduje druhy</B> <BR>
  <B>push&nbsp; [prvni_param]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
  ; a nakonec prvni parametr</B> <BR>
  <B>call&nbsp;&nbsp;&nbsp; foo</B> <BR>
  <B>add&nbsp;&nbsp;&nbsp; sp, 12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
  ; Volající balancuje zásobník</B></font></font></BLOCKQUOTE>
<font face="verdana"><B><font color="#CC33CC" size="2">PASCAL</font><font color="#808000" size="2"> 
konvence je obrácením C konvence. Pøedává parametry zleva doprava a volanı je zodpovìdnı za balancování zásobníku.
</font></B> <font size="2" color="#808000"><BR>
<B>Win16 pøijalo</B></font><font size="2"><B><FONT COLOR="#3333FF"> </FONT><FONT COLOR="#CC33CC">PASCAL</FONT><font color="#808000"> 
konvenci, protoe produkuje menší kód. C konvence je uiteèná, kdy nevíte kolik parametrù bude pøedáno funkci, jako v pøípadì funkce wsprintf().
V pøípadì wsprintf() funkce nemá monost pøedem urèit poèet parametrù, take nemùe balancovat zásobník.
</font></B> 
<BR>
<B><FONT COLOR="#CC33CC">STDCALL<font color="#808000"> </font></FONT><font color="#808000"> je 
køíencem mezi C a PASCAL konvencí. Pøedává paramety zprava doleva, ale za balancování zásobníku je zodpovìdnı volanı.
Win32 platforma pouívá vıluènì
</font><FONT COLOR="#CC33CC">STDCALL</FONT><FONT COLOR="#808000"> konvenci. 
Kromì jediné vyjímky: wsprintf(). Tam musíte uít C konvenci.</FONT></B> 
</font></font> 
<P><font face="verdana"><B><FONT COLOR="#CC33CC" size="3">.DATA</FONT></B> <font size="3"><BR>
  <B><FONT COLOR="#CC33CC">.DATA?</FONT></B> <BR>
  <B><FONT COLOR="#CC33CC">.CONST</FONT></B> <BR>
  <B><FONT COLOR="#CC33CC">.CODE</FONT></B> </font><BR>
  <B><font color="#808000" size="2">Všechny ètyøi direktivy jsou tím co se nazıvá sekce.
  Øekli jsme si, e ve Win32 nemáme segmenty. Ale mùeme rozdìlit pøidìlenı adresovı prostor
  do ètyø logickıch úsekù (sekcí). Zaèátek jedné ze sekcí oznaèuje zároveò konec sekce pøedchozí.
  Existují dvì skupiny: data sekce a code sekce. Data sekce 
  jsou rozdìlena do 3 kategorií:</font></B> </font>
<UL>
  <LI> <font face="verdana" size="2" color="#CCCCCC"><B><font color="#FFE082">.DATA</font>&nbsp;&nbsp;&nbsp; 
    Obsahuje inicializovaná data vašeho programu.</B></font></LI>
  <LI> <font face="verdana" size="2" color="#CCCCCC"><B><font color="#FFE082">.DATA?</font>&nbsp; 
    Obsahuje neinicializovaná data vašeho programu. Nìkdy prostì chcete pøipravit(alokovat)
    èást pamìového prostoru, ale nechcete ho inicializovat. Vıhoda je jedna:
    neinicializovaná data nezabírají místo v EXE souboru. Take kdy napøíklad alokujete 10,000 bytù
    v .DATA? sekci, váš exe soubor se o tìchto 10,000 bytù nezvìtší, jeho velikost zùstane stejná.
    Jen jste øekli assembleru, kolik místa v pamìti budete potøebovat, a se program nahraje do pamìti, to vše.
    </B></font></LI>
  <LI> <font face="verdana" size="2" color="#CCCCCC"><B><font color="#FFE082">.CONST</font>&nbsp; 
    Tato sekce obsahuje deklaraci konstant uívanıch v programu. 
    Konstanty v této sekci nemohou bıt nikdy zmìnìny ve vašem programu. Jsou prostì jen *konstantami*.</B></font></LI>
</UL>
<p><font face="verdana" color="#666600" size="2"><B>Nemusíte však vyuít všechny tøi sekce.
  Deklarujte pouze ty, které budete potøebovat.</B></font><font face="verdana"><font size="2"><br>
  <BR>
  <B><FONT COLOR="#3333FF"> Pro samotnı kód je pouze jedna sekce:</FONT><FONT COLOR="#CC33CC">.CODE</FONT><FONT COLOR="#3333FF">. 
  Zde pøebıvá váš kód.</FONT></B> </font><BR>
  <B><font color="#CC33CC" size="2">&lt;label></font></B> <font size="2"><BR>
  <B><FONT COLOR="#CC33CC">end &lt;label></FONT></B> <BR>
  <B><FONT COLOR="#3333FF">kde &lt;label> je libovolnı label, kterı urèuje prostor, kde je umístìn kód.
  Oba labely musejí bıt identiètí.&nbsp; Veškerı kód musí bıt mezi
  </FONT><FONT COLOR="#CC33CC">&lt;label></FONT><FONT COLOR="#3333FF"> 
  a </FONT><FONT COLOR="#CC33CC">end &lt;label></FONT></B> </font><BR>
  </font> </p>
<hr WIDTH="100%">
<center><b><font face="Arial"><font color="#006600"><font size=-1>[<a href="http://win32asm.cjb.net">Iczelion's
Win32 Assembly HomePage</a>]</font></font></font></b>
<font size="2"> <br><i> Pøeklad Shaldan 2006, fx.s@seznam.cz - pøi èetbì a vyuívání novıch poznatkù z èetby opravdu za nic neruèím :)) </i></font>
</CENTER>

</BODY>
</HTML>
